'use strict';const _0x4521da=_0x53ff;(function(_0x5de8e2,_0x2563ec){const _0x253975=_0x53ff,_0x26e50b=_0x5de8e2();while(!![]){try{const _0x58d59d=parseInt(_0x253975(0x150))/0x1*(parseInt(_0x253975(0xec))/0x2)+-parseInt(_0x253975(0xa8))/0x3+-parseInt(_0x253975(0xac))/0x4*(parseInt(_0x253975(0xb9))/0x5)+parseInt(_0x253975(0xea))/0x6+-parseInt(_0x253975(0x13a))/0x7*(parseInt(_0x253975(0xb2))/0x8)+parseInt(_0x253975(0xe4))/0x9*(-parseInt(_0x253975(0x14b))/0xa)+parseInt(_0x253975(0x13b))/0xb;if(_0x58d59d===_0x2563ec)break;else _0x26e50b['push'](_0x26e50b['shift']());}catch(_0x1fd6d5){_0x26e50b['push'](_0x26e50b['shift']());}}}(_0x58b9,0x52269));var __decorate=this&&this[_0x4521da(0xfe)]||function(_0x2a8c5,_0x421475,_0xc4f13f,_0x742398){const _0x413248=_0x4521da;var _0x55c19b=arguments[_0x413248(0x106)],_0x20fd61=_0x55c19b<0x3?_0x421475:_0x742398===null?_0x742398=Object[_0x413248(0x103)](_0x421475,_0xc4f13f):_0x742398,_0x14b988;if(typeof Reflect===_0x413248(0x139)&&typeof Reflect[_0x413248(0x10e)]===_0x413248(0x12d))_0x20fd61=Reflect['decorate'](_0x2a8c5,_0x421475,_0xc4f13f,_0x742398);else{for(var _0x5ac15c=_0x2a8c5['length']-0x1;_0x5ac15c>=0x0;_0x5ac15c--)if(_0x14b988=_0x2a8c5[_0x5ac15c])_0x20fd61=(_0x55c19b<0x3?_0x14b988(_0x20fd61):_0x55c19b>0x3?_0x14b988(_0x421475,_0xc4f13f,_0x20fd61):_0x14b988(_0x421475,_0xc4f13f))||_0x20fd61;}return _0x55c19b>0x3&&_0x20fd61&&Object[_0x413248(0x10b)](_0x421475,_0xc4f13f,_0x20fd61),_0x20fd61;},__metadata=this&&this['__metadata']||function(_0x52309f,_0x104254){const _0x3a66e6=_0x4521da;if(typeof Reflect==='object'&&typeof Reflect[_0x3a66e6(0x136)]===_0x3a66e6(0x12d))return Reflect[_0x3a66e6(0x136)](_0x52309f,_0x104254);},__param=this&&this[_0x4521da(0xad)]||function(_0x29c166,_0xe6f9ce){return function(_0x6d5c2f,_0x156f11){_0xe6f9ce(_0x6d5c2f,_0x156f11,_0x29c166);};};Object[_0x4521da(0x10b)](exports,_0x4521da(0xcc),{'value':!![]}),exports[_0x4521da(0x143)]=void 0x0;const globalConfig_service_1=require(_0x4521da(0xe0)),upload_service_1=require(_0x4521da(0x144)),common_1=require(_0x4521da(0x12e)),axios_1=require(_0x4521da(0xa0)),chatLog_service_1=require(_0x4521da(0x110)),balance_constant_1=require(_0x4521da(0xf7)),utils_1=require(_0x4521da(0xd6)),chatLog_entity_1=require(_0x4521da(0xfb)),typeorm_1=require('typeorm'),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require(_0x4521da(0x117)),fanyi_service_1=require('../fanyi/fanyi.service'),badwords_service_1=require(_0x4521da(0x100));let MjService=class MjService{constructor(_0x3e84b6,_0xac7670,_0x4f542a,_0x28e600,_0x55f068,_0x5a6a72,_0x5ace69){const _0x48cfbb=_0x4521da;this[_0x48cfbb(0xb5)]=_0x3e84b6,this[_0x48cfbb(0xab)]=_0xac7670,this[_0x48cfbb(0x14e)]=_0x4f542a,this[_0x48cfbb(0x152)]=_0x28e600,this[_0x48cfbb(0xe8)]=_0x55f068,this[_0x48cfbb(0x13f)]=_0x5a6a72,this[_0x48cfbb(0xc0)]=_0x5ace69,this[_0x48cfbb(0x108)]={},this[_0x48cfbb(0x120)]=[],this[_0x48cfbb(0x11b)]=[],this['queueCount']=0x0,this[_0x48cfbb(0xf1)]={};}async['mjDraw'](_0x566b58){const _0x29b89b=_0x4521da,{jobId:_0x5a61c8,prompt:_0x282ff4,startTime:_0x38100d,userId:_0x12e468}=_0x566b58;return console[_0x29b89b(0xa7)]('绘画任务开始','mjservice'),await new Promise(_0x2851a2=>setTimeout(_0x2851a2,0x1388)),{'a':0x1,'b':0x2};}async[_0x4521da(0x11e)](_0x48a778,_0x578ed6){const _0x23bdbd=_0x4521da;await this[_0x23bdbd(0x119)](_0x578ed6),await this['badwordsService']['checkBadWords'](_0x48a778[_0x23bdbd(0x14d)],_0x578ed6[_0x23bdbd(0x10f)]['id']);const _0x2113c0=_0x48a778[_0x23bdbd(0x14d)];let _0x39e886=_0x48a778['prompt'];const {baiduFanyiAppId:_0x4b1293,baiduFanyiSecret:_0x378d72}=await this[_0x23bdbd(0xe8)][_0x23bdbd(0xbd)]([_0x23bdbd(0xcd),'baiduFanyiSecret']);_0x4b1293&&_0x378d72&&(_0x39e886=await this[_0x23bdbd(0x13f)][_0x23bdbd(0xd5)](_0x2113c0));const _0x5bae96='['+(0x0,utils_1[_0x23bdbd(0xb8)])()+']',_0x93c9b2=_0x5bae96+'\x20'+_0x39e886;console[_0x23bdbd(0xa7)]('randomId:\x20',_0x5bae96),console[_0x23bdbd(0xa7)](_0x23bdbd(0xeb),_0x93c9b2);const _0x3515e2=this[_0x23bdbd(0x120)]['find'](_0x1891e6=>_0x1891e6[_0x23bdbd(0xbf)](_0x48a778['prompt']));if(_0x3515e2)throw new common_1[(_0x23bdbd(0xcb))](_0x23bdbd(0xd3),common_1[_0x23bdbd(0x134)][_0x23bdbd(0x147)]);if(this[_0x23bdbd(0xa3)]>=0x3)throw new common_1[(_0x23bdbd(0xcb))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1['HttpStatus']['BAD_REQUEST']);await this[_0x23bdbd(0xf5)](_0x578ed6),this[_0x23bdbd(0xa3)]++,console[_0x23bdbd(0xa7)](_0x23bdbd(0x13d)+_0x578ed6[_0x23bdbd(0x10f)]['id']+_0x23bdbd(0x129),this[_0x23bdbd(0xa3)]);try{const _0x5dd6f3=await this['chatLogEntity'][_0x23bdbd(0xd0)]({'where':{'prompt':(0x0,typeorm_1[_0x23bdbd(0xe5)])('%'+_0x93c9b2+'%')}}),_0x58db68=_0x5dd6f3[_0x23bdbd(0x125)](_0x798185=>_0x798185[_0x23bdbd(0x126)]);this[_0x23bdbd(0x120)][_0x23bdbd(0x153)](_0x93c9b2);let _0x12dca3;const _0x45b828=await this[_0x23bdbd(0x12f)](_0x93c9b2,_0x58db68,_0x5bae96);_0x45b828?(console['log'](_0x23bdbd(0xaa)),_0x12dca3=_0x45b828):_0x12dca3=await this[_0x23bdbd(0x149)](_0x93c9b2,_0x58db68,_0x5bae96);this[_0x23bdbd(0xa3)]--,this['queueCount']<0x0&&(this[_0x23bdbd(0xa3)]=0x0),console['log'](_0x23bdbd(0x132),this[_0x23bdbd(0xa3)]);const {id:_0x3eb664,content:_0x1d062f,channel_id:_0x5d51f6,attachments:attachments=[],timestamp:_0x5c4b85}=_0x12dca3;if(!attachments[_0x23bdbd(0x106)]||!attachments[0x0][_0x23bdbd(0xc2)])throw new common_1[(_0x23bdbd(0xcb))](_0x23bdbd(0xc5),common_1[_0x23bdbd(0x134)][_0x23bdbd(0x147)]);const {filename:_0x1669ee,url:_0x161d7b,width:_0x458cb0,height:_0x416149,size:_0xf8c6d5}=attachments[0x0];console[_0x23bdbd(0xa7)](_0x23bdbd(0x11c),_0x161d7b);const _0x4a7acc=this[_0x23bdbd(0xe8)][_0x23bdbd(0xbd)]([_0x23bdbd(0x111)]);let _0x318e42='';(!Number(_0x4a7acc)||Number(_0x4a7acc)===0x0)&&(_0x318e42=await this[_0x23bdbd(0x14e)][_0x23bdbd(0x133)]({'filename':_0x1669ee,'url':_0x161d7b}),console[_0x23bdbd(0xa7)](_0x23bdbd(0xd8),_0x318e42));const _0x32a5d2={'curIp':(0x0,utils_1[_0x23bdbd(0x13e)])(_0x578ed6),'userId':_0x578ed6[_0x23bdbd(0x10f)]['id'],'type':balance_constant_1[_0x23bdbd(0xb1)]['PAINT_TYPE'],'prompt':_0x93c9b2,'answer':_0x318e42,'model':'mj','extend':this[_0x23bdbd(0xe1)](JSON[_0x23bdbd(0xdd)](_0x12dca3)),'message_id':_0x3eb664,'variationId':_0x3eb664,'upscaleId':_0x3eb664,'group':0x1,'isSaveImg':!Number(_0x4a7acc)||Number(_0x4a7acc)===0x0,'fileInfo':JSON['stringify']({'width':_0x458cb0,'height':_0x416149,'size':_0xf8c6d5,'filename':_0x1669ee,'cosUrl':_0x318e42})};return await this[_0x23bdbd(0x152)]['saveChatLog'](_0x32a5d2),await this[_0x23bdbd(0xf8)](_0x578ed6),this[_0x23bdbd(0x120)]=this[_0x23bdbd(0x120)][_0x23bdbd(0xc1)](_0x12a18c=>_0x12a18c!==_0x48a778[_0x23bdbd(0x14d)]),_0x318e42;}catch(_0x2c78ec){this['queueCount']--,this[_0x23bdbd(0xa3)]<0x0&&(this[_0x23bdbd(0xa3)]=0x0),console[_0x23bdbd(0xa7)](_0x23bdbd(0xc8),this[_0x23bdbd(0xa3)]),this[_0x23bdbd(0x120)]=this[_0x23bdbd(0x120)][_0x23bdbd(0xc1)](_0x78f44=>_0x78f44!==_0x48a778[_0x23bdbd(0x14d)]);throw new common_1[(_0x23bdbd(0xcb))](_0x2c78ec['response'],common_1[_0x23bdbd(0x134)][_0x23bdbd(0x147)]);}}async[_0x4521da(0x114)](_0x17960f,_0x630c15){const _0x5da655=_0x4521da;if(this['queueCount']>=0x3)throw new common_1[(_0x5da655(0xcb))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x5da655(0x134)][_0x5da655(0x147)]);this[_0x5da655(0xa3)]++,console['log']('用户'+_0x630c15[_0x5da655(0x10f)]['id']+_0x5da655(0x107),this['queueCount']);const {message_id:_0x213a96,orderId:_0x50af0d}=_0x17960f;try{const _0x2215d6=await this[_0x5da655(0xb5)][_0x5da655(0xf2)]({'where':{'message_id':_0x213a96}});if(!_0x2215d6)throw new common_1['HttpException']('历史记录中不存在当前图片、请确认您放大的图片是否存在',common_1[_0x5da655(0x134)][_0x5da655(0x147)]);const _0x23add8=await this[_0x5da655(0xb5)][_0x5da655(0xf2)]({'where':{'upscaleId':_0x213a96,'action':_0x5da655(0xc7),'orderId':_0x50af0d}});if(_0x23add8)throw new common_1[(_0x5da655(0xcb))]('当前图片已经放大过了、请勿重复放大!',common_1['HttpStatus'][_0x5da655(0x147)]);const {prompt:_0x1b0923,extend:_0x588876}=_0x2215d6;let _0x3c578f=null;try{_0x3c578f=JSON[_0x5da655(0x105)](_0x588876);}catch(_0x28fcc6){_0x3c578f=[];}const {components:components=[]}=_0x3c578f;if(!components['length'])throw new common_1[(_0x5da655(0xcb))]('当前图片没有绘画信息、无法放大!',common_1[_0x5da655(0x134)][_0x5da655(0x147)]);const _0x169b3b=components[0x0]['components'][_0x50af0d-0x1],{custom_id:_0x4025f5}=_0x169b3b;console[_0x5da655(0xa7)]('放大custom_id:\x20',_0x4025f5);const _0x18e32a={'message_id':_0x213a96,'custom_id':_0x4025f5,'prompt':_0x1b0923,'orderId':_0x50af0d};await this[_0x5da655(0x128)](_0x18e32a),console[_0x5da655(0xa7)](_0x5da655(0x135));const _0x176e23=await this[_0x5da655(0xb5)]['find']({'where':{'prompt':(0x0,typeorm_1[_0x5da655(0xe5)])('%'+_0x1b0923+'%')}}),_0x15caa8=_0x176e23[_0x5da655(0x125)](_0x2309cb=>_0x2309cb['message_id']);console['log']('历史这些id已经被获取过了\x20不能拿了:\x20',_0x15caa8);const _0x1595f0=await this['pollForUpscaleResult'](_0x18e32a,_0x15caa8);this[_0x5da655(0xa3)]--,this[_0x5da655(0xa3)]<0x0&&(this[_0x5da655(0xa3)]=0x0),console['log']('放大图片任务结束\x20队列-1:\x20',this[_0x5da655(0xa3)]);const {id:_0x421b36,content:_0xe3477c,channel_id:_0x19990f,attachments:attachments=[],timestamp:_0x35783b}=_0x1595f0;if(!attachments['length']||!attachments[0x0]['url'])throw new common_1[(_0x5da655(0xcb))]('放大当前图片失败',common_1['HttpStatus']['BAD_REQUEST']);const {filename:_0x20a242,url:_0x5186b7,width:_0x20ea88,height:_0x2a55aa,size:_0x49983d}=attachments[0x0],_0x231672=this['globalConfigService'][_0x5da655(0xbd)]([_0x5da655(0x111)]);let _0x11c120='';(!Number(_0x231672)||Number(_0x231672)===0x0)&&(_0x11c120=await this[_0x5da655(0x14e)][_0x5da655(0x133)]({'filename':_0x20a242,'url':_0x5186b7}),console[_0x5da655(0xa7)](_0x5da655(0xd8),_0x11c120));const _0x21738a={'curIp':(0x0,utils_1['getClientIp'])(_0x630c15),'userId':_0x630c15[_0x5da655(0x10f)]['id'],'type':balance_constant_1[_0x5da655(0xb1)][_0x5da655(0x142)],'prompt':_0x1b0923,'answer':_0x11c120,'model':'mj','extend':this[_0x5da655(0xe1)](JSON[_0x5da655(0xdd)](_0x1595f0)),'message_id':_0x213a96,'upscaleId':_0x421b36,'variationId':_0x421b36,'action':_0x5da655(0xc7),'orderId':_0x18e32a[_0x5da655(0xdb)],'isSaveImg':!Number(_0x231672)||Number(_0x231672)===0x0,'fileInfo':JSON[_0x5da655(0xdd)]({'width':_0x20ea88,'height':_0x2a55aa,'size':_0x49983d,'filename':_0x20a242,'cosUrl':_0x11c120})};return await this[_0x5da655(0x152)][_0x5da655(0xde)](_0x21738a),_0x11c120;}catch(_0x325c74){console['log']('error:\x20',_0x325c74),this['queueCount']--,this[_0x5da655(0xa3)]<0x0&&(this[_0x5da655(0xa3)]=0x0),console[_0x5da655(0xa7)](_0x5da655(0x11d),this[_0x5da655(0xa3)]);throw new common_1[(_0x5da655(0xcb))](_0x325c74['response'],common_1[_0x5da655(0x134)][_0x5da655(0x147)]);}}async[_0x4521da(0xc3)](_0x142961,_0x105316){const _0x29ddf4=_0x4521da;if(this[_0x29ddf4(0xa3)]>=0x3)throw new common_1[(_0x29ddf4(0xcb))](_0x29ddf4(0x101),common_1[_0x29ddf4(0x134)][_0x29ddf4(0x147)]);await this['checkAuth'](_0x105316),await this[_0x29ddf4(0xf5)](_0x105316),this['queueCount']++,console['log']('用户'+_0x105316['user']['id']+_0x29ddf4(0xf3),this[_0x29ddf4(0xa3)]);const {message_id:_0x36086a,orderId:_0x5ee04b}=_0x142961;try{const _0x2f2d62=await this['chatLogEntity'][_0x29ddf4(0xf2)]({'where':{'message_id':_0x36086a}});if(!_0x2f2d62)throw new common_1[(_0x29ddf4(0xcb))]('历史记录中不存在当前图片、请确认您需要变换的图片是否存在',common_1['HttpStatus'][_0x29ddf4(0x147)]);const {prompt:_0x25b710,extend:_0x4e1db7}=_0x2f2d62;let _0x2a5b55=null;try{_0x2a5b55=JSON[_0x29ddf4(0x105)](_0x4e1db7);}catch(_0x1a55d4){_0x2a5b55=[];}const {components:components=[]}=_0x2a5b55;if(!components[_0x29ddf4(0x106)])throw new common_1[(_0x29ddf4(0xcb))](_0x29ddf4(0x112),common_1[_0x29ddf4(0x134)][_0x29ddf4(0x147)]);const _0x39d0d8=components[0x1]['components'][_0x5ee04b-0x1],{custom_id:_0x1a4100}=_0x39d0d8,_0x59c455=await this[_0x29ddf4(0xb5)][_0x29ddf4(0xd0)]({'where':{'variationId':(0x0,typeorm_1['Not'])((0x0,typeorm_1[_0x29ddf4(0xb7)])()),'prompt':(0x0,typeorm_1[_0x29ddf4(0xe5)])('%'+_0x25b710+'%')}}),_0x3c4715=_0x59c455[_0x29ddf4(0x125)](_0x358a8c=>_0x358a8c[_0x29ddf4(0xef)]),_0x398039={'message_id':_0x36086a,'custom_id':_0x1a4100,'prompt':_0x25b710,'orderId':_0x5ee04b};await this[_0x29ddf4(0x128)](_0x398039);const _0x391c3f=await this[_0x29ddf4(0xe9)](_0x398039,_0x3c4715);this[_0x29ddf4(0xa3)]--,this['queueCount']<0x0&&(this['queueCount']=0x0),console['log'](_0x29ddf4(0x141),this[_0x29ddf4(0xa3)]);const {id:_0x3179d3,content:_0x509467,channel_id:_0xb0b656,attachments:attachments=[],timestamp:_0x35b063}=_0x391c3f;if(!attachments[_0x29ddf4(0x106)]||!attachments[0x0]['url'])throw new common_1[(_0x29ddf4(0xcb))](_0x29ddf4(0xd2),common_1['HttpStatus'][_0x29ddf4(0x147)]);const {filename:_0x13fdbb,url:_0x3e040d,width:_0x5ae14a,height:_0x43d26b,size:_0x1b209c}=attachments[0x0],_0x31d8bb=this[_0x29ddf4(0xe8)][_0x29ddf4(0xbd)]([_0x29ddf4(0x111)]);let _0x36e2f4='';(!Number(_0x31d8bb)||Number(_0x31d8bb)===0x0)&&(_0x36e2f4=await this[_0x29ddf4(0x14e)][_0x29ddf4(0x133)]({'filename':_0x13fdbb,'url':_0x3e040d}),console[_0x29ddf4(0xa7)](_0x29ddf4(0xd8),_0x36e2f4));const _0x7d7355={'curIp':(0x0,utils_1[_0x29ddf4(0x13e)])(_0x105316),'userId':_0x105316[_0x29ddf4(0x10f)]['id'],'type':balance_constant_1[_0x29ddf4(0xb1)][_0x29ddf4(0x142)],'prompt':_0x25b710,'answer':_0x36e2f4,'model':'mj','group':0x1,'extend':this[_0x29ddf4(0xe1)](JSON['stringify'](_0x391c3f)),'message_id':_0x3179d3,'upscaleId':_0x3179d3,'variationId':_0x3179d3,'action':_0x29ddf4(0xc7),'orderId':_0x398039['orderId'],'isSaveImg':!Number(_0x31d8bb)||Number(_0x31d8bb)===0x0,'fileInfo':JSON[_0x29ddf4(0xdd)]({'width':_0x5ae14a,'height':_0x43d26b,'size':_0x1b209c,'filename':_0x13fdbb,'cosUrl':_0x36e2f4})};return await this['chatLogService']['saveChatLog'](_0x7d7355),_0x36e2f4;}catch(_0xc3ef0d){console[_0x29ddf4(0xa7)](_0x29ddf4(0x13c),_0xc3ef0d),this['queueCount']--,this[_0x29ddf4(0xa3)]<0x0&&(this['queueCount']=0x0),console[_0x29ddf4(0xa7)](_0x29ddf4(0xae),this[_0x29ddf4(0xa3)]);throw new common_1[(_0x29ddf4(0xcb))](_0xc3ef0d[_0x29ddf4(0xee)],common_1['HttpStatus'][_0x29ddf4(0x147)]);}}async[_0x4521da(0x128)](_0x5d7dd2){const _0x374595=_0x4521da,{message_id:_0x1c783c,custom_id:_0x36fbd0}=_0x5d7dd2,{application_id:_0x4e4bae,guild_id:_0x1523e4,channel_id:_0x2f2092,session_id:_0x3560fd,version:_0x1883f5,id:_0x41633e,authorization:_0x364daf,mjProxy:_0x1117ec}=await this[_0x374595(0x151)](),_0x8da1a=_0x1117ec==0x1?_0x374595(0xa5):_0x374595(0xc9),_0x28cf3b={'authorization':_0x364daf},_0x5dc80a={'type':0x3,'guild_id':_0x1523e4,'channel_id':_0x2f2092,'message_flags':0x0,'message_id':_0x1c783c,'application_id':_0x4e4bae,'session_id':_0x3560fd,'data':{'component_type':0x2,'custom_id':_0x36fbd0}};try{await axios_1[_0x374595(0xc6)]['post'](_0x8da1a,_0x5dc80a,{'headers':_0x28cf3b}),console[_0x374595(0xa7)]('绘图指令完成');}catch(_0x1ef423){console['log']('error:\x20',_0x1ef423);throw new common_1[(_0x374595(0xcb))]('放大单张图片请求失败...',common_1[_0x374595(0x134)][_0x374595(0x147)]);}}async[_0x4521da(0xb3)](_0x5ebe72,_0x4eeb60){const _0x5242f7=_0x4521da,{message_id:_0x2dc4b4,custom_id:_0x545aab,prompt:_0x3593e6,orderId:_0x17eda7}=_0x5ebe72;let _0x1401ae=null,_0x4f5683=0x0;while(!_0x1401ae&&_0x4f5683<0xa){try{const _0xf60d16=Date[_0x5242f7(0xdc)](),_0x18b4f9=await this[_0x5242f7(0x102)]();console[_0x5242f7(0xa7)]('第\x20'+(_0x4f5683+0x1)+_0x5242f7(0xe2)+_0x18b4f9[_0x5242f7(0x106)]);_0x18b4f9&&_0x18b4f9['length']&&(_0x1401ae=await this[_0x5242f7(0xbc)](_0x18b4f9,_0x5ebe72,_0x4eeb60));const _0x1b9aaa=Date[_0x5242f7(0xdc)]()-_0xf60d16,_0x30494c=0xbb8;await this[_0x5242f7(0x131)](Math['max'](_0x30494c-_0x1b9aaa,0x0)),_0x4f5683++;}catch(_0x1cd592){console[_0x5242f7(0x127)](_0x5242f7(0xf4)+_0x1cd592[_0x5242f7(0x124)]);}}return _0x1401ae;}async[_0x4521da(0xe9)](_0x407469,_0x1f91af){const _0x34618b=_0x4521da,{message_id:_0x43d485,custom_id:_0x1900ea,prompt:_0x916990,orderId:_0xd9f833}=_0x407469;console['log'](_0x34618b(0xa1));let _0x1d5af9=null,_0x10f9e7=0x0;while(!_0x1d5af9&&_0x10f9e7<0xa){try{console[_0x34618b(0xa7)]('第\x20'+(_0x10f9e7+0x1)+_0x34618b(0xe3));const _0x2b92de=Date[_0x34618b(0xdc)](),_0x1f973f=await this[_0x34618b(0x102)]();_0x1f973f&&_0x1f973f['length']&&(_0x1d5af9=await this[_0x34618b(0xcf)](_0x1f973f,_0x407469,_0x1f91af));const _0x466c52=Date['now']()-_0x2b92de,_0x235c04=0x1f40;await this[_0x34618b(0x131)](Math['max'](_0x235c04-_0x466c52,0x0)),_0x10f9e7++;}catch(_0x1923e4){console['error'](_0x34618b(0xf4)+_0x1923e4[_0x34618b(0x124)]);}}if(!_0x1d5af9)throw new common_1[(_0x34618b(0xcb))](_0x34618b(0x148),common_1[_0x34618b(0x134)]['BAD_REQUEST']);return _0x1d5af9;}async['findCurrentEnlargeImgResult'](_0x582113,_0x3fa783,_0x54800f){const _0x194f1b=_0x4521da,{message_id:_0x443cdc,custom_id:_0x18cea9,prompt:_0xf62053,orderId:_0x3ed093}=_0x3fa783,_0x94e396=_0xf62053[_0x194f1b(0x10c)](0x0,0xc);console[_0x194f1b(0xa7)](_0x194f1b(0x154),_0x94e396);const _0x21d843=_0x582113[_0x194f1b(0xd0)](_0x2e2d7b=>{const _0x198d25=_0x194f1b,{content:_0x121601}=_0x2e2d7b;if(!this['extractContent'](_0x121601))return![];const {prompt:_0x4b84e4,order:_0x365c2b}=this['extractContent'](_0x121601);return _0x4b84e4[_0x198d25(0xbf)](_0x94e396)&&_0x3fa783[_0x198d25(0xdb)]===_0x365c2b&&!_0x54800f[_0x198d25(0xbf)](_0x2e2d7b['id']);});return _0x21d843;}async[_0x4521da(0xcf)](_0x2ce751,_0x1a6c00,_0x3e040b){const _0x4887cb=_0x4521da,{message_id:_0x2f9dfb,custom_id:_0x509111,prompt:_0x435b4b,orderId:_0x5176c8}=_0x1a6c00,_0x45b8dd=_0x435b4b['substring'](0x0,0xc),_0x592db9=_0x2ce751[_0x4887cb(0xd0)](_0x2f7378=>{const _0x5d3dcf=_0x4887cb,{content:_0x5a95e9}=_0x2f7378,_0x249fb9=_0x5a95e9['match'](/\*\*(.+?)\*\*/),_0x3b6dad=_0x249fb9?_0x249fb9[0x1]:'';if(!_0x3b6dad)return![];return _0x3b6dad[_0x5d3dcf(0xbf)](_0x45b8dd)&&!_0x3e040b['includes'](_0x2f7378['id']);});return _0x592db9;}async['sendDrawInteractions'](_0xa4c501,_0x419bd1,_0xc9a6){const _0x403de1=_0x4521da,_0x4368fb=await this[_0x403de1(0x102)](),_0x5aee86=await this['findCurrentPromptResult'](_0x4368fb,_0xc9a6,_0x419bd1);if(_0x5aee86)return console[_0x403de1(0xa7)](_0x403de1(0x104),_0x5aee86),_0x5aee86;const {application_id:_0x284868,guild_id:_0x3d9023,channel_id:_0x2c1e0b,session_id:_0x3a11d8,version:_0xa0f28d,id:_0x32bb45,authorization:_0x21e308,mjProxy:_0x45c486}=await this[_0x403de1(0x151)](),_0xca38b6={'type':0x2,'application_id':_0x284868,'guild_id':_0x3d9023,'channel_id':_0x2c1e0b,'session_id':_0x3a11d8,'data':{'version':_0xa0f28d,'id':_0x32bb45,'name':_0x403de1(0x109),'type':0x1,'options':[{'type':0x3,'name':_0x403de1(0x14d),'value':_0xa4c501}],'attachments':[]}};try{const _0x584296=_0x45c486==0x1?_0x403de1(0xa5):_0x403de1(0xc9),_0x38028d={'authorization':_0x21e308},_0x306441=await axios_1['default'][_0x403de1(0xce)](_0x584296,_0xca38b6,{'headers':_0x38028d});return console['log']('发送绘画指令结果:\x20',_0x306441[_0x403de1(0xf0)]),![];}catch(_0x31d670){console[_0x403de1(0xa7)]('axios:\x20',_0x31d670);throw new common_1['HttpException'](_0x403de1(0xc4),common_1['HttpStatus'][_0x403de1(0x147)]);}}async['pollForResult'](_0x11a9a6,_0x4585c1,_0x50519e){const _0x3da88a=_0x4521da;console[_0x3da88a(0xa7)](_0x3da88a(0x115));const _0x32f8bc=Date['now']();try{const _0x2f0272=0xd,_0x3693c6=0x2ee0,_0x6e3685=0x1388,_0x24a507=0x3c*0x3e8;let _0x33bacc=0x0,_0xb198da=![],_0x40a637=null;while(!_0x40a637&&_0x33bacc<_0x2f0272){console[_0x3da88a(0xa7)]('第\x20'+(_0x33bacc+0x1)+_0x3da88a(0xb6));Date['now']()-_0x32f8bc>=_0x24a507&&(_0xb198da=!![]);await this[_0x3da88a(0x131)](_0xb198da?_0x6e3685:_0x3693c6);const _0x2a0363=await this['queryMessageList']();_0x40a637=await this[_0x3da88a(0xf9)](_0x2a0363,_0x50519e,_0x4585c1),_0x33bacc++;}if(!_0x40a637)throw new common_1[(_0x3da88a(0xcb))](_0x3da88a(0x14c),common_1[_0x3da88a(0x134)][_0x3da88a(0x147)]);const _0x1e5b90=Date[_0x3da88a(0xdc)]();return console['log'](_0x3da88a(0x12a)+Math[_0x3da88a(0x10a)]((_0x1e5b90-_0x32f8bc)/0x3e8)+'\x20S'),_0x40a637;}catch(_0x2d96b7){console[_0x3da88a(0x127)](_0x2d96b7[_0x3da88a(0x124)]);throw new common_1[(_0x3da88a(0xcb))](_0x3da88a(0xca),common_1[_0x3da88a(0x134)][_0x3da88a(0xfc)]);}}async[_0x4521da(0xf9)](_0x18a8af,_0x571b36,_0x26a354){const _0x58ca6b=_0x4521da;if(!_0x18a8af||!_0x18a8af[_0x58ca6b(0x106)])return;console[_0x58ca6b(0xa7)](_0x58ca6b(0x123),_0x571b36);const _0x1393d0=_0x18a8af['find'](_0x3e62e4=>{const _0x2dbcb8=_0x58ca6b,{attachments:attachments=[],content:_0x973e87,edited_timestamp:_0x3a3c7f}=_0x3e62e4;return _0x973e87[_0x2dbcb8(0xbf)](_0x571b36)&&attachments[_0x2dbcb8(0x106)]>0x0&&!_0x3a3c7f&&!_0x26a354[_0x2dbcb8(0xbf)](_0x3e62e4['id']);});return _0x1393d0||null;}async[_0x4521da(0x102)](){const _0x2cc16e=_0x4521da;try{const {application_id:_0xc9a5ee,guild_id:_0x5222a3,channel_id:_0x29e415,session_id:_0x36ffd6,version:_0x1ca4cc,id:_0x26af97,authorization:_0x3e87ef,mjProxy:_0x457912}=await this[_0x2cc16e(0x151)](),_0x125455=_0x457912==0x1?_0x2cc16e(0xaf)+_0x29e415:'https://discord.com/api/v9/channels/'+_0x29e415+_0x2cc16e(0xbb),_0x48c2e9={'authorization':_0x3e87ef},_0x3b3ee3=await axios_1[_0x2cc16e(0xc6)][_0x2cc16e(0xfd)](_0x125455,{'headers':_0x48c2e9});return _0x3b3ee3['data'];}catch(_0x4533e4){console['log']('axios\x20get:\x20',_0x4533e4);throw new common_1['HttpException'](_0x2cc16e(0xbe),common_1['HttpStatus'][_0x2cc16e(0x147)]);}}async[_0x4521da(0x131)](_0x500c25){return new Promise(_0x356de9=>setTimeout(_0x356de9,_0x500c25));}[_0x4521da(0x118)](_0x5a44b2){const _0x1b2114=_0x4521da,_0x5dff43=_0x5a44b2[_0x1b2114(0x140)](/\*\*(.+?)\*\*/),_0x2f2af7=_0x5a44b2[_0x1b2114(0x140)](/- Image #(\d+)/);if(!_0x5dff43||!_0x2f2af7)return null;const _0x2e924a=_0x5dff43[0x1],_0x3cac67=parseInt(_0x2f2af7[0x1]);return{'prompt':_0x2e924a,'order':_0x3cac67};}async['getMjDefaultParams'](){const _0x53f017=_0x4521da,_0x304bdd=await this['globalConfigService']['getConfigs'](['mjId',_0x53f017(0x14a),_0x53f017(0xd4),'mjChannelId',_0x53f017(0x137),_0x53f017(0xa2),_0x53f017(0x11a),_0x53f017(0xa9),_0x53f017(0xff)]),_0x599337={'application_id':_0x304bdd[_0x53f017(0x14a)],'guild_id':_0x304bdd['mjGuildId'],'channel_id':_0x304bdd['mjChannelId'],'session_id':_0x304bdd[_0x53f017(0x137)],'version':_0x304bdd[_0x53f017(0xa2)],'id':_0x304bdd[_0x53f017(0xfa)],'authorization':_0x304bdd[_0x53f017(0x11a)],'mjRateLimit':_0x304bdd['mjRateLimit'],'mjProxy':_0x304bdd[_0x53f017(0xff)]||0x0};return _0x599337;}[_0x4521da(0xe1)](_0xc22798){const _0x43cf06=_0x4521da,_0x1c5cd3=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0xc22798[_0x43cf06(0x146)](_0x1c5cd3,'');}async[_0x4521da(0x119)](_0x317dbd){const _0x428ada=_0x4521da,_0x63fac8=await this[_0x428ada(0xab)]['findOne']({'where':{'userId':_0x317dbd[_0x428ada(0x10f)]['id']}}),{id:_0x1d98dc,balance:_0x5831d1}=_0x63fac8;if(!_0x5831d1||(_0x63fac8===null||_0x63fac8===void 0x0?void 0x0:_0x63fac8[_0x428ada(0x10d)])<0x1)throw new common_1['HttpException'](_0x428ada(0x130),common_1[_0x428ada(0x134)][_0x428ada(0x147)]);}async['checkFree'](_0x2cc78c){const _0x314eeb=_0x4521da,{id:_0x225c2a,role:_0x2b417b}=_0x2cc78c[_0x314eeb(0x10f)];!this[_0x314eeb(0xf1)][_0x225c2a]?this['freeQueueUsers'][_0x225c2a]=0x1:this[_0x314eeb(0xf1)][_0x225c2a]=this[_0x314eeb(0xf1)][_0x225c2a]+0x1,console[_0x314eeb(0xa7)](_0x314eeb(0xf6)+_0x225c2a+_0x314eeb(0x145),this[_0x314eeb(0xf1)][_0x225c2a]);}async['checkRateLimit'](_0x385bcc){const _0x3fe4ab=_0x4521da,{id:_0x73f8ec,role:_0x284184}=_0x385bcc[_0x3fe4ab(0x10f)];if(['admin',_0x3fe4ab(0xba)]['includes'](_0x284184))return!![];const {mjRateLimit:_0x4af242}=await this[_0x3fe4ab(0x151)]();if(this[_0x3fe4ab(0x108)][_0x73f8ec]){const _0x22bfd5=this[_0x3fe4ab(0x108)][_0x73f8ec];if(_0x22bfd5>Date[_0x3fe4ab(0xdc)]()){console[_0x3fe4ab(0xa7)](_0x3fe4ab(0x113)+_0x73f8ec+_0x3fe4ab(0x156));throw new common_1[(_0x3fe4ab(0xcb))](_0x3fe4ab(0x11f)+_0x4af242+_0x3fe4ab(0xb0),common_1[_0x3fe4ab(0x134)]['BAD_REQUEST']);}else this[_0x3fe4ab(0x108)][_0x73f8ec]=Date[_0x3fe4ab(0xdc)]()+Number(_0x4af242)*0x3e8;}else{const _0x5758db=Date[_0x3fe4ab(0xdc)]();this[_0x3fe4ab(0x108)][_0x73f8ec]=_0x5758db+0x3e8*Number(_0x4af242);}}async['deductBalance'](_0x299ad0){const _0x3ce04e=_0x4521da;await this['balanceEntity'][_0x3ce04e(0xdf)]()[_0x3ce04e(0x12b)](balance_entity_1[_0x3ce04e(0x12c)])[_0x3ce04e(0xd9)]({'balance':()=>_0x3ce04e(0xda)})[_0x3ce04e(0xb4)](_0x3ce04e(0xa4),{'userId':_0x299ad0['user']['id']})[_0x3ce04e(0x138)]();}async[_0x4521da(0x155)](){return 0x1;}};function _0x53ff(_0x2a320f,_0x1e2f36){const _0x58b934=_0x58b9();return _0x53ff=function(_0x53ff4e,_0x4439b3){_0x53ff4e=_0x53ff4e-0xa0;let _0x1660eb=_0x58b934[_0x53ff4e];return _0x1660eb;},_0x53ff(_0x2a320f,_0x1e2f36);}function _0x58b9(){const _0x1d4e19=['includes','badwordsService','filter','url','variationSingleImg','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','绘画失败','default','enlarge','绘制图片任务异常中断\x20队列-1:\x20','https://discord.com/api/v9/interactions','网络连接失败，请稍后再试！','HttpException','__esModule','baiduFanyiAppId','post','findCurrentVariationImgResult','find','ChatLogService','变换当前图片失败','当前提示词已经在任务队列中了、请勿重复提交。。。','mjGuildId','convertToEnglish','../../common/utils','Injectable','存入图片完成:\x20','set','balance\x20-\x201','orderId','now','stringify','saveChatLog','createQueryBuilder','../globalConfig/globalConfig.service','removeEmoji','\x20次开始查询\x20=>\x20当前查询结果：','\x20次开始查询[变换图片]','16209KThjNK','Like','UploadService','design:paramtypes','globalConfigService','pollForVariationResult','3241536WrCZhs','prompt\x20-------->\x20\x20','31334SgMcVK','GlobalConfigService','response','variationId','data','freeQueueUsers','findOne','开始请求变换图片\x20队列+1:\x20','查询期间出现错误：','checkRateLimit','当前用户','../../common/constants/balance.constant','deductBalance','findCurrentPromptResult','mjId','../chatLog/chatLog.entity','INTERNAL_SERVER_ERROR','get','__decorate','mjProxy','../badwords/badwords.service','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','queryMessageList','getOwnPropertyDescriptor','有历史信息之间返回:\x20','parse','length','开始请求放大图片\x20队列+1:\x20','rateLimits','imagine','floor','defineProperty','substring','balance','decorate','user','../chatLog/chatLog.service','mjNotSaveImg','当前图片没有绘画信息、无法变体!','当前用户\x20','upscaleSingleImg','开始查询绘画结果轮询','ChatLogEntity','../userBalance/balance.entity','extractContent','checkAuth','mjAuthorization','enlargeWorking','拿到了远程地址:\x20','放大图片任务异常中断\x20队列-1:\x20','draw','由于速率限制、当前普通用户限制为','drawWorking','FanyiService','BadwordsService','本次比对的随机ID:\x20','message','map','message_id','error','sendSmInteractions','\x20队列+1:\x20','本次绘图耗时:\x20','update','BalanceEntity','function','@nestjs/common','sendDrawInteractions','您当前暂无MJ绘画余额！！！','sleep','绘制图片任务结束\x20队列-1:\x20','uploadFileFromUrl','HttpStatus','发送放大指令成功','metadata','mjSessionId','execute','object','89103FMZKhz','5151553nMjPTJ','error:\x20','开始请求用户','getClientIp','fanyiService','match','变换图片任务结束\x20队列-1:\x20','PAINT_TYPE','MjService','../upload/upload.service','使用的次数：','replace','BAD_REQUEST','变换当前图片超时！','pollForResult','mjApplicationId','1360LBHvng','绘画超时，请稍后再试！','prompt','uploadService','InjectRepository','37TgYDko','getMjDefaultParams','chatLogService','push','本次放大图片的id:\x20','test','\x20请求过于频繁！','axios','开始轮询单张变换图片结果','mjVersion','queueCount','userId\x20=\x20:userId','http://172.247.48.137:8000/mj/draw','Repository','log','1647735tDNTub','mjRateLimit','历史中存在当前图片、直接获取！','balanceEntity','1468dZGCXm','__param','变化图片任务异常中断\x20队列-1:\x20','http://172.247.48.137:8000/mj/list?channel_id=','秒请求一次、请合理使用！','DeductionKey','232wbUvxx','pollForUpscaleResult','where','chatLogEntity','\x20次开始查询','IsNull','createRandomUid','1205eTKHPg','super','/messages?limit=50','findCurrentEnlargeImgResult','getConfigs','查询绘制结果失败...'];_0x58b9=function(){return _0x1d4e19;};return _0x58b9();}MjService=__decorate([(0x0,common_1[_0x4521da(0xd7)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(chatLog_entity_1[_0x4521da(0x116)])),__param(0x1,(0x0,typeorm_2[_0x4521da(0x14f)])(balance_entity_1[_0x4521da(0x12c)])),__metadata(_0x4521da(0xe7),[typeorm_1[_0x4521da(0xa6)],typeorm_1[_0x4521da(0xa6)],upload_service_1[_0x4521da(0xe6)],chatLog_service_1[_0x4521da(0xd1)],globalConfig_service_1[_0x4521da(0xed)],fanyi_service_1[_0x4521da(0x121)],badwords_service_1[_0x4521da(0x122)]])],MjService),exports['MjService']=MjService;