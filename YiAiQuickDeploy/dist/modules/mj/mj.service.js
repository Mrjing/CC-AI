'use strict';function _0x4cc8(_0x22dc55,_0x416a62){const _0x1e2e0d=_0x1e2e();return _0x4cc8=function(_0x4cc851,_0x5d49e9){_0x4cc851=_0x4cc851-0xff;let _0x9d6185=_0x1e2e0d[_0x4cc851];return _0x9d6185;},_0x4cc8(_0x22dc55,_0x416a62);}const _0x5e75f1=_0x4cc8;(function(_0x24e81d,_0x330d4f){const _0x228e9e=_0x4cc8,_0x206757=_0x24e81d();while(!![]){try{const _0x5548aa=-parseInt(_0x228e9e(0x178))/0x1+parseInt(_0x228e9e(0x12a))/0x2*(parseInt(_0x228e9e(0x11b))/0x3)+-parseInt(_0x228e9e(0x147))/0x4*(-parseInt(_0x228e9e(0x13f))/0x5)+parseInt(_0x228e9e(0x125))/0x6+parseInt(_0x228e9e(0x105))/0x7+parseInt(_0x228e9e(0x1ad))/0x8+parseInt(_0x228e9e(0x126))/0x9*(-parseInt(_0x228e9e(0x15e))/0xa);if(_0x5548aa===_0x330d4f)break;else _0x206757['push'](_0x206757['shift']());}catch(_0x2521e1){_0x206757['push'](_0x206757['shift']());}}}(_0x1e2e,0x611e9));function _0x1e2e(){const _0x4de0e0=['../../common/utils','放大custom_id:\x20','data','max','变换图片任务结束\x20队列-1:\x20','where','PAINT_TYPE','BalanceEntity','sendSmInteractions','uploadFileFromUrl','removeEmoji','length','filter','decorate','getClientIp','15973690HbkxCj','mjservice','now','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','axios','__metadata','BAD_REQUEST','defineProperty','pollForResult','../globalConfig/globalConfig.service','find','axios:\x20','__esModule','parse','../badwords/badwords.service','开始请求用户','findCurrentEnlargeImgResult','baiduFanyiAppId','UploadService','components','mjNotSaveImg','../userBalance/balance.entity','replace','message','历史中存在当前图片、直接获取！','getConfigs','755861gFrGrZ','当前提示词已经在任务队列中了、请勿重复提交。。。','开始轮询单张变换图片结果','MjService','pollForUpscaleResult','post','历史记录中不存在当前图片、请确认您放大的图片是否存在','userId\x20=\x20:userId','\x20队列+1:\x20','本次放大图片的id:\x20','enlarge','default','mjDraw','https://discord.com/api/v9/interactions','stringify','extractContent','../../common/constants/balance.constant','发送绘画指令结果:\x20','floor','function','mjChannelId','当前用户\x20','match','放大单张图片请求失败...','\x20次开始查询\x20=>\x20当前查询结果：','__param','balanceEntity','log','DeductionKey','get','当前图片没有绘画信息、无法放大!','http://172.247.48.137:8000/mj/draw','变换当前图片超时！','error','由于速率限制、当前普通用户限制为','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','update','HttpException','@nestjs/typeorm','substring','response','GlobalConfigService','__decorate','绘画任务开始','网络连接失败，请稍后再试！','globalConfigService','BadwordsService','mjAuthorization','drawWorking','message_id','findOne','sendDrawInteractions','有历史信息之间返回:\x20','3962672VIjsPD','开始查询绘画结果轮询','mjSessionId','variationSingleImg','rateLimits','test','../upload/upload.service','HttpStatus','放大图片任务结束\x20队列-1:\x20','metadata','InjectRepository','uploadService','pollForVariationResult','orderId','5060027osvRvS','url','enlargeWorking','使用的次数：','绘制图片任务结束\x20队列-1:\x20','绘制图片任务异常中断\x20队列-1:\x20','checkRateLimit','绘画失败','mjProxy','Repository','randomId:\x20','set','convertToEnglish','queueCount','../fanyi/fanyi.service','Like','http://172.247.48.137:8000/mj/list?channel_id=','mjVersion','绘图指令完成','super','includes','execute','67065fzSrRe','chatLogService','Not','mjRateLimit','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','getMjDefaultParams','user','push','发送放大指令成功','存入图片完成:\x20','4088556arHGAB','9xFKVfj','秒请求一次、请合理使用！','当前用户','/messages?limit=50','10MDpJiX','prompt\x20-------->\x20\x20','queryMessageList','draw','查询期间出现错误：','saveChatLog','prompt','findCurrentVariationImgResult','../chatLog/chatLog.entity','deductBalance','变化图片任务异常中断\x20队列-1:\x20','checkAuth','freeQueueUsers','mjApplicationId','createQueryBuilder','@nestjs/common','开始请求放大图片\x20队列+1:\x20','findCurrentPromptResult','object','chatLogEntity','baiduFanyiSecret','56895hbbNii','map','\x20次开始查询','sleep','您当前暂无MJ绘画余额！！！','error:\x20','mjGuildId','放大当前图片失败','260nYtAMR','ChatLogService','绘画超时，请稍后再试！','badwordsService','axios\x20get:\x20','fanyiService','../chatLog/chatLog.service','balance\x20-\x201'];_0x1e2e=function(){return _0x4de0e0;};return _0x1e2e();}var __decorate=this&&this[_0x5e75f1(0x1a2)]||function(_0x51b9ac,_0x98e4d2,_0x120c61,_0x317d34){const _0x3de5ce=_0x5e75f1;var _0x4ac790=arguments[_0x3de5ce(0x15a)],_0x5d27d0=_0x4ac790<0x3?_0x98e4d2:_0x317d34===null?_0x317d34=Object['getOwnPropertyDescriptor'](_0x98e4d2,_0x120c61):_0x317d34,_0x389e5d;if(typeof Reflect==='object'&&typeof Reflect[_0x3de5ce(0x15c)]===_0x3de5ce(0x18b))_0x5d27d0=Reflect['decorate'](_0x51b9ac,_0x98e4d2,_0x120c61,_0x317d34);else{for(var _0x276d8d=_0x51b9ac[_0x3de5ce(0x15a)]-0x1;_0x276d8d>=0x0;_0x276d8d--)if(_0x389e5d=_0x51b9ac[_0x276d8d])_0x5d27d0=(_0x4ac790<0x3?_0x389e5d(_0x5d27d0):_0x4ac790>0x3?_0x389e5d(_0x98e4d2,_0x120c61,_0x5d27d0):_0x389e5d(_0x98e4d2,_0x120c61))||_0x5d27d0;}return _0x4ac790>0x3&&_0x5d27d0&&Object[_0x3de5ce(0x165)](_0x98e4d2,_0x120c61,_0x5d27d0),_0x5d27d0;},__metadata=this&&this[_0x5e75f1(0x163)]||function(_0x3bc852,_0x232dc8){const _0xbe553c=_0x5e75f1;if(typeof Reflect===_0xbe553c(0x13c)&&typeof Reflect[_0xbe553c(0x100)]===_0xbe553c(0x18b))return Reflect[_0xbe553c(0x100)](_0x3bc852,_0x232dc8);},__param=this&&this[_0x5e75f1(0x191)]||function(_0x41ec66,_0xd7602b){return function(_0x5a6dee,_0x459907){_0xd7602b(_0x5a6dee,_0x459907,_0x41ec66);};};Object[_0x5e75f1(0x165)](exports,_0x5e75f1(0x16a),{'value':!![]}),exports[_0x5e75f1(0x17b)]=void 0x0;const globalConfig_service_1=require(_0x5e75f1(0x167)),upload_service_1=require(_0x5e75f1(0x1b3)),common_1=require(_0x5e75f1(0x139)),axios_1=require(_0x5e75f1(0x162)),chatLog_service_1=require(_0x5e75f1(0x14d)),balance_constant_1=require(_0x5e75f1(0x188)),utils_1=require(_0x5e75f1(0x14f)),chatLog_entity_1=require(_0x5e75f1(0x132)),typeorm_1=require('typeorm'),typeorm_2=require(_0x5e75f1(0x19e)),balance_entity_1=require(_0x5e75f1(0x173)),fanyi_service_1=require(_0x5e75f1(0x113)),badwords_service_1=require(_0x5e75f1(0x16c));let MjService=class MjService{constructor(_0x2516a8,_0x34e674,_0x5dad2d,_0x42abaa,_0x1b2ec9,_0x82842a,_0x192777){const _0x3d5c9e=_0x5e75f1;this[_0x3d5c9e(0x13d)]=_0x2516a8,this[_0x3d5c9e(0x192)]=_0x34e674,this['uploadService']=_0x5dad2d,this['chatLogService']=_0x42abaa,this[_0x3d5c9e(0x1a5)]=_0x1b2ec9,this[_0x3d5c9e(0x14c)]=_0x82842a,this[_0x3d5c9e(0x14a)]=_0x192777,this[_0x3d5c9e(0x1b1)]={},this[_0x3d5c9e(0x1a8)]=[],this[_0x3d5c9e(0x107)]=[],this['queueCount']=0x0,this['freeQueueUsers']={};}async[_0x5e75f1(0x184)](_0x5227cb){const _0x1e3483=_0x5e75f1,{jobId:_0xa46479,prompt:_0x524b7c,startTime:_0x28dde9,userId:_0x39baab}=_0x5227cb;return console[_0x1e3483(0x193)](_0x1e3483(0x1a3),_0x1e3483(0x15f)),await new Promise(_0x12b06a=>setTimeout(_0x12b06a,0x1388)),{'a':0x1,'b':0x2};}async[_0x5e75f1(0x12d)](_0x3ac085,_0x36dcab){const _0x5f41ec=_0x5e75f1;await this[_0x5f41ec(0x135)](_0x36dcab),await this['badwordsService']['checkBadWords'](_0x3ac085[_0x5f41ec(0x130)],_0x36dcab['user']['id']);const _0x31ccab=_0x3ac085[_0x5f41ec(0x130)];let _0xc16884=_0x3ac085[_0x5f41ec(0x130)];const {baiduFanyiAppId:_0x3add7a,baiduFanyiSecret:_0x521a84}=await this[_0x5f41ec(0x1a5)]['getConfigs']([_0x5f41ec(0x16f),_0x5f41ec(0x13e)]);_0x3add7a&&_0x521a84&&(_0xc16884=await this[_0x5f41ec(0x14c)][_0x5f41ec(0x111)](_0x31ccab));const _0x55ff4b='['+(0x0,utils_1['createRandomUid'])()+']',_0x5d9d06=_0x55ff4b+'\x20'+_0xc16884;console[_0x5f41ec(0x193)](_0x5f41ec(0x10f),_0x55ff4b),console['log'](_0x5f41ec(0x12b),_0x5d9d06);const _0x4f76d2=this[_0x5f41ec(0x1a8)]['find'](_0x2b52ad=>_0x2b52ad[_0x5f41ec(0x119)](_0x3ac085[_0x5f41ec(0x130)]));if(_0x4f76d2)throw new common_1[(_0x5f41ec(0x19d))](_0x5f41ec(0x179),common_1['HttpStatus'][_0x5f41ec(0x164)]);if(this[_0x5f41ec(0x112)]>=0x3)throw new common_1[(_0x5f41ec(0x19d))](_0x5f41ec(0x11f),common_1[_0x5f41ec(0x1b4)][_0x5f41ec(0x164)]);await this['checkRateLimit'](_0x36dcab),this[_0x5f41ec(0x112)]++,console[_0x5f41ec(0x193)](_0x5f41ec(0x16d)+_0x36dcab[_0x5f41ec(0x121)]['id']+_0x5f41ec(0x180),this[_0x5f41ec(0x112)]);try{const _0x10a9c0=await this[_0x5f41ec(0x13d)]['find']({'where':{'prompt':(0x0,typeorm_1[_0x5f41ec(0x114)])('%'+_0x5d9d06+'%')}}),_0x219a9c=_0x10a9c0[_0x5f41ec(0x140)](_0x4ef30d=>_0x4ef30d[_0x5f41ec(0x1a9)]);this[_0x5f41ec(0x1a8)][_0x5f41ec(0x122)](_0x5d9d06);let _0x6ecd79;const _0x362d74=await this['sendDrawInteractions'](_0x5d9d06,_0x219a9c,_0x55ff4b);_0x362d74?(console[_0x5f41ec(0x193)](_0x5f41ec(0x176)),_0x6ecd79=_0x362d74):_0x6ecd79=await this[_0x5f41ec(0x166)](_0x5d9d06,_0x219a9c,_0x55ff4b);this['queueCount']--,this[_0x5f41ec(0x112)]<0x0&&(this[_0x5f41ec(0x112)]=0x0),console['log'](_0x5f41ec(0x109),this['queueCount']);const {id:_0x26ed04,content:_0x303ffd,channel_id:_0x368f17,attachments:attachments=[],timestamp:_0x417a2c}=_0x6ecd79;if(!attachments['length']||!attachments[0x0][_0x5f41ec(0x106)])throw new common_1[(_0x5f41ec(0x19d))](_0x5f41ec(0x10c),common_1[_0x5f41ec(0x1b4)]['BAD_REQUEST']);const {filename:_0x1a96fb,url:_0x2ad3ca,width:_0x2a4810,height:_0x4125ce,size:_0x3ebffc}=attachments[0x0];console[_0x5f41ec(0x193)]('拿到了远程地址:\x20',_0x2ad3ca);const _0x11faa3=this[_0x5f41ec(0x1a5)][_0x5f41ec(0x177)](['mjNotSaveImg']);let _0x236d90='';(!Number(_0x11faa3)||Number(_0x11faa3)===0x0)&&(_0x236d90=await this[_0x5f41ec(0x102)][_0x5f41ec(0x158)]({'filename':_0x1a96fb,'url':_0x2ad3ca}),console['log'](_0x5f41ec(0x124),_0x236d90));const _0x17fa8b={'curIp':(0x0,utils_1['getClientIp'])(_0x36dcab),'userId':_0x36dcab[_0x5f41ec(0x121)]['id'],'type':balance_constant_1['DeductionKey'][_0x5f41ec(0x155)],'prompt':_0x5d9d06,'answer':_0x236d90,'model':'mj','extend':this[_0x5f41ec(0x159)](JSON[_0x5f41ec(0x186)](_0x6ecd79)),'message_id':_0x26ed04,'variationId':_0x26ed04,'upscaleId':_0x26ed04,'group':0x1,'isSaveImg':!Number(_0x11faa3)||Number(_0x11faa3)===0x0,'fileInfo':JSON[_0x5f41ec(0x186)]({'width':_0x2a4810,'height':_0x4125ce,'size':_0x3ebffc,'filename':_0x1a96fb,'cosUrl':_0x236d90})};return await this['chatLogService'][_0x5f41ec(0x12f)](_0x17fa8b),await this[_0x5f41ec(0x133)](_0x36dcab),this[_0x5f41ec(0x1a8)]=this['drawWorking'][_0x5f41ec(0x15b)](_0x117bf4=>_0x117bf4!==_0x3ac085[_0x5f41ec(0x130)]),_0x236d90;}catch(_0x2aa16e){this['queueCount']--,this[_0x5f41ec(0x112)]<0x0&&(this['queueCount']=0x0),console[_0x5f41ec(0x193)](_0x5f41ec(0x10a),this[_0x5f41ec(0x112)]),this[_0x5f41ec(0x1a8)]=this[_0x5f41ec(0x1a8)][_0x5f41ec(0x15b)](_0x50e196=>_0x50e196!==_0x3ac085[_0x5f41ec(0x130)]);throw new common_1[(_0x5f41ec(0x19d))](_0x2aa16e[_0x5f41ec(0x1a0)],common_1['HttpStatus'][_0x5f41ec(0x164)]);}}async['upscaleSingleImg'](_0x297189,_0x26afbd){const _0x1c7ffc=_0x5e75f1;if(this[_0x1c7ffc(0x112)]>=0x3)throw new common_1['HttpException'](_0x1c7ffc(0x11f),common_1[_0x1c7ffc(0x1b4)]['BAD_REQUEST']);this[_0x1c7ffc(0x112)]++,console['log']('用户'+_0x26afbd[_0x1c7ffc(0x121)]['id']+_0x1c7ffc(0x13a),this[_0x1c7ffc(0x112)]);const {message_id:_0x553571,orderId:_0x51543b}=_0x297189;try{const _0xc00d4f=await this[_0x1c7ffc(0x13d)][_0x1c7ffc(0x1aa)]({'where':{'message_id':_0x553571}});if(!_0xc00d4f)throw new common_1[(_0x1c7ffc(0x19d))](_0x1c7ffc(0x17e),common_1[_0x1c7ffc(0x1b4)]['BAD_REQUEST']);const _0x5bcfb9=await this['chatLogEntity'][_0x1c7ffc(0x1aa)]({'where':{'upscaleId':_0x553571,'action':_0x1c7ffc(0x182),'orderId':_0x51543b}});if(_0x5bcfb9)throw new common_1[(_0x1c7ffc(0x19d))]('当前图片已经放大过了、请勿重复放大!',common_1[_0x1c7ffc(0x1b4)][_0x1c7ffc(0x164)]);const {prompt:_0x51f843,extend:_0x547ade}=_0xc00d4f;let _0x3c59f9=null;try{_0x3c59f9=JSON[_0x1c7ffc(0x16b)](_0x547ade);}catch(_0x12b5a6){_0x3c59f9=[];}const {components:components=[]}=_0x3c59f9;if(!components['length'])throw new common_1[(_0x1c7ffc(0x19d))](_0x1c7ffc(0x196),common_1[_0x1c7ffc(0x1b4)][_0x1c7ffc(0x164)]);const _0x47ce30=components[0x0][_0x1c7ffc(0x171)][_0x51543b-0x1],{custom_id:_0x469fc5}=_0x47ce30;console['log'](_0x1c7ffc(0x150),_0x469fc5);const _0x378fe6={'message_id':_0x553571,'custom_id':_0x469fc5,'prompt':_0x51f843,'orderId':_0x51543b};await this[_0x1c7ffc(0x157)](_0x378fe6),console['log'](_0x1c7ffc(0x123));const _0xac4af0=await this['chatLogEntity'][_0x1c7ffc(0x168)]({'where':{'prompt':(0x0,typeorm_1[_0x1c7ffc(0x114)])('%'+_0x51f843+'%')}}),_0x142be0=_0xac4af0[_0x1c7ffc(0x140)](_0x586f3f=>_0x586f3f[_0x1c7ffc(0x1a9)]);console['log']('历史这些id已经被获取过了\x20不能拿了:\x20',_0x142be0);const _0x4456a8=await this['pollForUpscaleResult'](_0x378fe6,_0x142be0);this[_0x1c7ffc(0x112)]--,this[_0x1c7ffc(0x112)]<0x0&&(this[_0x1c7ffc(0x112)]=0x0),console[_0x1c7ffc(0x193)](_0x1c7ffc(0xff),this[_0x1c7ffc(0x112)]);const {id:_0x488583,content:_0x194702,channel_id:_0x2ee33a,attachments:attachments=[],timestamp:_0x396041}=_0x4456a8;if(!attachments['length']||!attachments[0x0][_0x1c7ffc(0x106)])throw new common_1[(_0x1c7ffc(0x19d))](_0x1c7ffc(0x146),common_1['HttpStatus']['BAD_REQUEST']);const {filename:_0xe4f936,url:_0x48a19d,width:_0x23550e,height:_0x46624f,size:_0x40702b}=attachments[0x0],_0x5e41b8=this[_0x1c7ffc(0x1a5)][_0x1c7ffc(0x177)]([_0x1c7ffc(0x172)]);let _0x1b8f05='';(!Number(_0x5e41b8)||Number(_0x5e41b8)===0x0)&&(_0x1b8f05=await this[_0x1c7ffc(0x102)]['uploadFileFromUrl']({'filename':_0xe4f936,'url':_0x48a19d}),console['log'](_0x1c7ffc(0x124),_0x1b8f05));const _0x1ddcd5={'curIp':(0x0,utils_1['getClientIp'])(_0x26afbd),'userId':_0x26afbd[_0x1c7ffc(0x121)]['id'],'type':balance_constant_1[_0x1c7ffc(0x194)]['PAINT_TYPE'],'prompt':_0x51f843,'answer':_0x1b8f05,'model':'mj','extend':this[_0x1c7ffc(0x159)](JSON[_0x1c7ffc(0x186)](_0x4456a8)),'message_id':_0x553571,'upscaleId':_0x488583,'variationId':_0x488583,'action':_0x1c7ffc(0x182),'orderId':_0x378fe6['orderId'],'isSaveImg':!Number(_0x5e41b8)||Number(_0x5e41b8)===0x0,'fileInfo':JSON[_0x1c7ffc(0x186)]({'width':_0x23550e,'height':_0x46624f,'size':_0x40702b,'filename':_0xe4f936,'cosUrl':_0x1b8f05})};return await this['chatLogService'][_0x1c7ffc(0x12f)](_0x1ddcd5),_0x1b8f05;}catch(_0x4849ec){console[_0x1c7ffc(0x193)](_0x1c7ffc(0x144),_0x4849ec),this['queueCount']--,this['queueCount']<0x0&&(this[_0x1c7ffc(0x112)]=0x0),console['log']('放大图片任务异常中断\x20队列-1:\x20',this['queueCount']);throw new common_1[(_0x1c7ffc(0x19d))](_0x4849ec[_0x1c7ffc(0x1a0)],common_1['HttpStatus'][_0x1c7ffc(0x164)]);}}async[_0x5e75f1(0x1b0)](_0x375b89,_0x2fd368){const _0x3d8188=_0x5e75f1;if(this[_0x3d8188(0x112)]>=0x3)throw new common_1[(_0x3d8188(0x19d))](_0x3d8188(0x11f),common_1[_0x3d8188(0x1b4)][_0x3d8188(0x164)]);await this[_0x3d8188(0x135)](_0x2fd368),await this[_0x3d8188(0x10b)](_0x2fd368),this[_0x3d8188(0x112)]++,console[_0x3d8188(0x193)]('用户'+_0x2fd368[_0x3d8188(0x121)]['id']+'开始请求变换图片\x20队列+1:\x20',this['queueCount']);const {message_id:_0x3032c4,orderId:_0x17e488}=_0x375b89;try{const _0xeec1de=await this[_0x3d8188(0x13d)][_0x3d8188(0x1aa)]({'where':{'message_id':_0x3032c4}});if(!_0xeec1de)throw new common_1[(_0x3d8188(0x19d))](_0x3d8188(0x19b),common_1[_0x3d8188(0x1b4)]['BAD_REQUEST']);const {prompt:_0x4e5022,extend:_0x51c81e}=_0xeec1de;let _0x1c4131=null;try{_0x1c4131=JSON[_0x3d8188(0x16b)](_0x51c81e);}catch(_0x4dcac1){_0x1c4131=[];}const {components:components=[]}=_0x1c4131;if(!components[_0x3d8188(0x15a)])throw new common_1[(_0x3d8188(0x19d))]('当前图片没有绘画信息、无法变体!',common_1['HttpStatus'][_0x3d8188(0x164)]);const _0x2db517=components[0x1]['components'][_0x17e488-0x1],{custom_id:_0x9d199e}=_0x2db517,_0x384560=await this[_0x3d8188(0x13d)][_0x3d8188(0x168)]({'where':{'variationId':(0x0,typeorm_1[_0x3d8188(0x11d)])((0x0,typeorm_1['IsNull'])()),'prompt':(0x0,typeorm_1['Like'])('%'+_0x4e5022+'%')}}),_0x393513=_0x384560[_0x3d8188(0x140)](_0xb6a7ae=>_0xb6a7ae['variationId']),_0x55a0fe={'message_id':_0x3032c4,'custom_id':_0x9d199e,'prompt':_0x4e5022,'orderId':_0x17e488};await this[_0x3d8188(0x157)](_0x55a0fe);const _0x5b9db2=await this[_0x3d8188(0x103)](_0x55a0fe,_0x393513);this['queueCount']--,this['queueCount']<0x0&&(this[_0x3d8188(0x112)]=0x0),console[_0x3d8188(0x193)](_0x3d8188(0x153),this[_0x3d8188(0x112)]);const {id:_0x294351,content:_0x3ee06b,channel_id:_0x39ea60,attachments:attachments=[],timestamp:_0x5ef575}=_0x5b9db2;if(!attachments['length']||!attachments[0x0][_0x3d8188(0x106)])throw new common_1[(_0x3d8188(0x19d))]('变换当前图片失败',common_1[_0x3d8188(0x1b4)][_0x3d8188(0x164)]);const {filename:_0x1cd93f,url:_0x1bcd25,width:_0x3bdb68,height:_0x53e337,size:_0x46c7bd}=attachments[0x0],_0x5e1bae=this['globalConfigService'][_0x3d8188(0x177)]([_0x3d8188(0x172)]);let _0x44d5b2='';(!Number(_0x5e1bae)||Number(_0x5e1bae)===0x0)&&(_0x44d5b2=await this[_0x3d8188(0x102)][_0x3d8188(0x158)]({'filename':_0x1cd93f,'url':_0x1bcd25}),console[_0x3d8188(0x193)]('存入图片完成:\x20',_0x44d5b2));const _0x7a34ad={'curIp':(0x0,utils_1[_0x3d8188(0x15d)])(_0x2fd368),'userId':_0x2fd368['user']['id'],'type':balance_constant_1['DeductionKey']['PAINT_TYPE'],'prompt':_0x4e5022,'answer':_0x44d5b2,'model':'mj','group':0x1,'extend':this[_0x3d8188(0x159)](JSON[_0x3d8188(0x186)](_0x5b9db2)),'message_id':_0x294351,'upscaleId':_0x294351,'variationId':_0x294351,'action':'enlarge','orderId':_0x55a0fe['orderId'],'isSaveImg':!Number(_0x5e1bae)||Number(_0x5e1bae)===0x0,'fileInfo':JSON[_0x3d8188(0x186)]({'width':_0x3bdb68,'height':_0x53e337,'size':_0x46c7bd,'filename':_0x1cd93f,'cosUrl':_0x44d5b2})};return await this[_0x3d8188(0x11c)][_0x3d8188(0x12f)](_0x7a34ad),_0x44d5b2;}catch(_0x1f69f2){console[_0x3d8188(0x193)]('error:\x20',_0x1f69f2),this[_0x3d8188(0x112)]--,this[_0x3d8188(0x112)]<0x0&&(this['queueCount']=0x0),console[_0x3d8188(0x193)](_0x3d8188(0x134),this[_0x3d8188(0x112)]);throw new common_1[(_0x3d8188(0x19d))](_0x1f69f2[_0x3d8188(0x1a0)],common_1[_0x3d8188(0x1b4)]['BAD_REQUEST']);}}async[_0x5e75f1(0x157)](_0x4c355a){const _0x7b5798=_0x5e75f1,{message_id:_0x49a71e,custom_id:_0xc2c651}=_0x4c355a,{application_id:_0x31af13,guild_id:_0x26a3fe,channel_id:_0x390b58,session_id:_0x2f5501,version:_0x312d38,id:_0x5857d8,authorization:_0x432077,mjProxy:_0x5d4a93}=await this[_0x7b5798(0x120)](),_0x25b1f7=_0x5d4a93==0x1?'http://172.247.48.137:8000/mj/draw':_0x7b5798(0x185),_0x3a8dea={'authorization':_0x432077},_0x5e1594={'type':0x3,'guild_id':_0x26a3fe,'channel_id':_0x390b58,'message_flags':0x0,'message_id':_0x49a71e,'application_id':_0x31af13,'session_id':_0x2f5501,'data':{'component_type':0x2,'custom_id':_0xc2c651}};try{await axios_1['default']['post'](_0x25b1f7,_0x5e1594,{'headers':_0x3a8dea}),console[_0x7b5798(0x193)](_0x7b5798(0x117));}catch(_0x2b129a){console[_0x7b5798(0x193)]('error:\x20',_0x2b129a);throw new common_1[(_0x7b5798(0x19d))](_0x7b5798(0x18f),common_1[_0x7b5798(0x1b4)][_0x7b5798(0x164)]);}}async[_0x5e75f1(0x17c)](_0x12f7b5,_0x3df7c1){const _0x5667c4=_0x5e75f1,{message_id:_0x2fcacb,custom_id:_0x1b831c,prompt:_0x2b2fda,orderId:_0x92ae9c}=_0x12f7b5;let _0x5c3e9d=null,_0x4375b0=0x0;while(!_0x5c3e9d&&_0x4375b0<0xa){try{const _0x2d3db5=Date['now'](),_0x2078dc=await this[_0x5667c4(0x12c)]();console[_0x5667c4(0x193)]('第\x20'+(_0x4375b0+0x1)+_0x5667c4(0x190)+_0x2078dc['length']);_0x2078dc&&_0x2078dc[_0x5667c4(0x15a)]&&(_0x5c3e9d=await this['findCurrentEnlargeImgResult'](_0x2078dc,_0x12f7b5,_0x3df7c1));const _0x5b25b2=Date[_0x5667c4(0x160)]()-_0x2d3db5,_0x25c2ec=0xbb8;await this[_0x5667c4(0x142)](Math[_0x5667c4(0x152)](_0x25c2ec-_0x5b25b2,0x0)),_0x4375b0++;}catch(_0x2abb5b){console['error'](_0x5667c4(0x12e)+_0x2abb5b[_0x5667c4(0x175)]);}}return _0x5c3e9d;}async[_0x5e75f1(0x103)](_0x82fc15,_0x28aeb2){const _0x8127cb=_0x5e75f1,{message_id:_0x2085f0,custom_id:_0x1695c6,prompt:_0x783af9,orderId:_0x438356}=_0x82fc15;console[_0x8127cb(0x193)](_0x8127cb(0x17a));let _0x1dd03a=null,_0x3d05d7=0x0;while(!_0x1dd03a&&_0x3d05d7<0xa){try{console[_0x8127cb(0x193)]('第\x20'+(_0x3d05d7+0x1)+'\x20次开始查询[变换图片]');const _0x52da00=Date['now'](),_0x3726a2=await this[_0x8127cb(0x12c)]();_0x3726a2&&_0x3726a2['length']&&(_0x1dd03a=await this[_0x8127cb(0x131)](_0x3726a2,_0x82fc15,_0x28aeb2));const _0x20f27f=Date[_0x8127cb(0x160)]()-_0x52da00,_0x2183dc=0x1f40;await this[_0x8127cb(0x142)](Math[_0x8127cb(0x152)](_0x2183dc-_0x20f27f,0x0)),_0x3d05d7++;}catch(_0x55c78){console['error'](_0x8127cb(0x12e)+_0x55c78[_0x8127cb(0x175)]);}}if(!_0x1dd03a)throw new common_1[(_0x8127cb(0x19d))](_0x8127cb(0x198),common_1[_0x8127cb(0x1b4)][_0x8127cb(0x164)]);return _0x1dd03a;}async[_0x5e75f1(0x16e)](_0x5e3aed,_0xc2a4cb,_0x169876){const _0x38081e=_0x5e75f1,{message_id:_0x1f8402,custom_id:_0xbfd87d,prompt:_0x21e3bb,orderId:_0x5b6d91}=_0xc2a4cb,_0x485f10=_0x21e3bb[_0x38081e(0x19f)](0x0,0xc);console['log'](_0x38081e(0x181),_0x485f10);const _0x3290c9=_0x5e3aed[_0x38081e(0x168)](_0x5250b7=>{const _0x2cbcaa=_0x38081e,{content:_0x3ee454}=_0x5250b7;if(!this[_0x2cbcaa(0x187)](_0x3ee454))return![];const {prompt:_0x9a4b39,order:_0x3984e2}=this[_0x2cbcaa(0x187)](_0x3ee454);return _0x9a4b39[_0x2cbcaa(0x119)](_0x485f10)&&_0xc2a4cb[_0x2cbcaa(0x104)]===_0x3984e2&&!_0x169876[_0x2cbcaa(0x119)](_0x5250b7['id']);});return _0x3290c9;}async['findCurrentVariationImgResult'](_0x517fe2,_0x2051f6,_0x19a0f5){const _0x24b1fe=_0x5e75f1,{message_id:_0x24a283,custom_id:_0x40121d,prompt:_0x1da41e,orderId:_0xb12407}=_0x2051f6,_0x4a70ba=_0x1da41e[_0x24b1fe(0x19f)](0x0,0xc),_0x1c40db=_0x517fe2[_0x24b1fe(0x168)](_0x41e468=>{const _0x3c4439=_0x24b1fe,{content:_0x349a6a}=_0x41e468,_0x5546ca=_0x349a6a[_0x3c4439(0x18e)](/\*\*(.+?)\*\*/),_0xb911d5=_0x5546ca?_0x5546ca[0x1]:'';if(!_0xb911d5)return![];return _0xb911d5['includes'](_0x4a70ba)&&!_0x19a0f5['includes'](_0x41e468['id']);});return _0x1c40db;}async[_0x5e75f1(0x1ab)](_0xbef454,_0x24abdc,_0x15c3d7){const _0x3b91f6=_0x5e75f1,_0xf96628=await this[_0x3b91f6(0x12c)](),_0x1055a7=await this[_0x3b91f6(0x13b)](_0xf96628,_0x15c3d7,_0x24abdc);if(_0x1055a7)return console['log'](_0x3b91f6(0x1ac),_0x1055a7),_0x1055a7;const {application_id:_0x502435,guild_id:_0x40d5cd,channel_id:_0xaeb86d,session_id:_0x5d9eaa,version:_0x54861c,id:_0x4536b7,authorization:_0x192b97,mjProxy:_0x42d568}=await this[_0x3b91f6(0x120)](),_0x38f3d5={'type':0x2,'application_id':_0x502435,'guild_id':_0x40d5cd,'channel_id':_0xaeb86d,'session_id':_0x5d9eaa,'data':{'version':_0x54861c,'id':_0x4536b7,'name':'imagine','type':0x1,'options':[{'type':0x3,'name':_0x3b91f6(0x130),'value':_0xbef454}],'attachments':[]}};try{const _0x3ab041=_0x42d568==0x1?_0x3b91f6(0x197):'https://discord.com/api/v9/interactions',_0x202fe2={'authorization':_0x192b97},_0x4de56c=await axios_1[_0x3b91f6(0x183)][_0x3b91f6(0x17d)](_0x3ab041,_0x38f3d5,{'headers':_0x202fe2});return console[_0x3b91f6(0x193)](_0x3b91f6(0x189),_0x4de56c['data']),![];}catch(_0xbc4e0a){console[_0x3b91f6(0x193)](_0x3b91f6(0x169),_0xbc4e0a);throw new common_1[(_0x3b91f6(0x19d))](_0x3b91f6(0x161),common_1[_0x3b91f6(0x1b4)][_0x3b91f6(0x164)]);}}async[_0x5e75f1(0x166)](_0xfd2e09,_0x15c79f,_0x4686fe){const _0x10a705=_0x5e75f1;console[_0x10a705(0x193)](_0x10a705(0x1ae));const _0x5e4222=Date['now']();try{const _0x18d6b1=0xd,_0x10905c=0x2ee0,_0x5dc50c=0x1388,_0x2b92ea=0x3c*0x3e8;let _0x4303ca=0x0,_0x3f7fde=![],_0x217728=null;while(!_0x217728&&_0x4303ca<_0x18d6b1){console[_0x10a705(0x193)]('第\x20'+(_0x4303ca+0x1)+_0x10a705(0x141));Date['now']()-_0x5e4222>=_0x2b92ea&&(_0x3f7fde=!![]);await this[_0x10a705(0x142)](_0x3f7fde?_0x5dc50c:_0x10905c);const _0x1dec08=await this[_0x10a705(0x12c)]();_0x217728=await this[_0x10a705(0x13b)](_0x1dec08,_0x4686fe,_0x15c79f),_0x4303ca++;}if(!_0x217728)throw new common_1[(_0x10a705(0x19d))](_0x10a705(0x149),common_1[_0x10a705(0x1b4)][_0x10a705(0x164)]);const _0x5bd53a=Date['now']();return console[_0x10a705(0x193)]('本次绘图耗时:\x20'+Math[_0x10a705(0x18a)]((_0x5bd53a-_0x5e4222)/0x3e8)+'\x20S'),_0x217728;}catch(_0x14b5a8){console[_0x10a705(0x199)](_0x14b5a8['message']);throw new common_1['HttpException'](_0x10a705(0x1a4),common_1[_0x10a705(0x1b4)]['INTERNAL_SERVER_ERROR']);}}async[_0x5e75f1(0x13b)](_0x4eee72,_0x59b87e,_0xcf4a16){const _0x52eb3c=_0x5e75f1;if(!_0x4eee72||!_0x4eee72[_0x52eb3c(0x15a)])return;console[_0x52eb3c(0x193)]('本次比对的随机ID:\x20',_0x59b87e);const _0x4e207b=_0x4eee72['find'](_0x2f5075=>{const _0x2133ab=_0x52eb3c,{attachments:attachments=[],content:_0x131ad0,edited_timestamp:_0x3b4da6}=_0x2f5075;return _0x131ad0[_0x2133ab(0x119)](_0x59b87e)&&attachments[_0x2133ab(0x15a)]>0x0&&!_0x3b4da6&&!_0xcf4a16['includes'](_0x2f5075['id']);});return _0x4e207b||null;}async[_0x5e75f1(0x12c)](){const _0x869ffb=_0x5e75f1;try{const {application_id:_0x36959e,guild_id:_0x438a29,channel_id:_0x476b2c,session_id:_0x43e7a6,version:_0x4e309e,id:_0x45a8e0,authorization:_0x507c69,mjProxy:_0x4838ad}=await this['getMjDefaultParams'](),_0x1f9927=_0x4838ad==0x1?_0x869ffb(0x115)+_0x476b2c:'https://discord.com/api/v9/channels/'+_0x476b2c+_0x869ffb(0x129),_0x3b9ae0={'authorization':_0x507c69},_0x44fbee=await axios_1[_0x869ffb(0x183)][_0x869ffb(0x195)](_0x1f9927,{'headers':_0x3b9ae0});return _0x44fbee[_0x869ffb(0x151)];}catch(_0x60ca5a){console[_0x869ffb(0x193)](_0x869ffb(0x14b),_0x60ca5a);throw new common_1[(_0x869ffb(0x19d))]('查询绘制结果失败...',common_1['HttpStatus'][_0x869ffb(0x164)]);}}async['sleep'](_0x4f4c13){return new Promise(_0x82c37e=>setTimeout(_0x82c37e,_0x4f4c13));}[_0x5e75f1(0x187)](_0x2a9f19){const _0x283283=_0x5e75f1,_0x5ad233=_0x2a9f19['match'](/\*\*(.+?)\*\*/),_0x26a929=_0x2a9f19[_0x283283(0x18e)](/- Image #(\d+)/);if(!_0x5ad233||!_0x26a929)return null;const _0x12d754=_0x5ad233[0x1],_0x247f1d=parseInt(_0x26a929[0x1]);return{'prompt':_0x12d754,'order':_0x247f1d};}async[_0x5e75f1(0x120)](){const _0x49be55=_0x5e75f1,_0x59af20=await this['globalConfigService'][_0x49be55(0x177)](['mjId','mjApplicationId',_0x49be55(0x145),_0x49be55(0x18c),_0x49be55(0x1af),_0x49be55(0x116),_0x49be55(0x1a7),_0x49be55(0x11e),_0x49be55(0x10d)]),_0x59577a={'application_id':_0x59af20[_0x49be55(0x137)],'guild_id':_0x59af20[_0x49be55(0x145)],'channel_id':_0x59af20[_0x49be55(0x18c)],'session_id':_0x59af20[_0x49be55(0x1af)],'version':_0x59af20[_0x49be55(0x116)],'id':_0x59af20['mjId'],'authorization':_0x59af20[_0x49be55(0x1a7)],'mjRateLimit':_0x59af20[_0x49be55(0x11e)],'mjProxy':_0x59af20['mjProxy']||0x0};return _0x59577a;}[_0x5e75f1(0x159)](_0x5b8a87){const _0x254802=_0x5e75f1,_0xf8b984=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x5b8a87[_0x254802(0x174)](_0xf8b984,'');}async['checkAuth'](_0x5bdd21){const _0x203ea9=_0x5e75f1,_0x1ca2ba=await this[_0x203ea9(0x192)][_0x203ea9(0x1aa)]({'where':{'userId':_0x5bdd21['user']['id']}}),{id:_0x368a06,balance:_0x122f76}=_0x1ca2ba;if(!_0x122f76||(_0x1ca2ba===null||_0x1ca2ba===void 0x0?void 0x0:_0x1ca2ba['balance'])<0x1)throw new common_1[(_0x203ea9(0x19d))](_0x203ea9(0x143),common_1[_0x203ea9(0x1b4)][_0x203ea9(0x164)]);}async['checkFree'](_0x242b88){const _0x2f88ad=_0x5e75f1,{id:_0x1d5c2c,role:_0x5c1bff}=_0x242b88[_0x2f88ad(0x121)];!this[_0x2f88ad(0x136)][_0x1d5c2c]?this[_0x2f88ad(0x136)][_0x1d5c2c]=0x1:this[_0x2f88ad(0x136)][_0x1d5c2c]=this[_0x2f88ad(0x136)][_0x1d5c2c]+0x1,console[_0x2f88ad(0x193)](_0x2f88ad(0x128)+_0x1d5c2c+_0x2f88ad(0x108),this[_0x2f88ad(0x136)][_0x1d5c2c]);}async[_0x5e75f1(0x10b)](_0x4f3225){const _0x5ab236=_0x5e75f1,{id:_0x24c9a1,role:_0xd406d7}=_0x4f3225[_0x5ab236(0x121)];if(['admin',_0x5ab236(0x118)][_0x5ab236(0x119)](_0xd406d7))return!![];const {mjRateLimit:_0x50af9d}=await this['getMjDefaultParams']();if(this[_0x5ab236(0x1b1)][_0x24c9a1]){const _0x4fd23f=this[_0x5ab236(0x1b1)][_0x24c9a1];if(_0x4fd23f>Date[_0x5ab236(0x160)]()){console[_0x5ab236(0x193)](_0x5ab236(0x18d)+_0x24c9a1+'\x20请求过于频繁！');throw new common_1[(_0x5ab236(0x19d))](_0x5ab236(0x19a)+_0x50af9d+_0x5ab236(0x127),common_1['HttpStatus'][_0x5ab236(0x164)]);}else this[_0x5ab236(0x1b1)][_0x24c9a1]=Date['now']()+Number(_0x50af9d)*0x3e8;}else{const _0x4fc947=Date['now']();this[_0x5ab236(0x1b1)][_0x24c9a1]=_0x4fc947+0x3e8*Number(_0x50af9d);}}async[_0x5e75f1(0x133)](_0x52d249){const _0x459a50=_0x5e75f1;await this['balanceEntity'][_0x459a50(0x138)]()[_0x459a50(0x19c)](balance_entity_1[_0x459a50(0x156)])[_0x459a50(0x110)]({'balance':()=>_0x459a50(0x14e)})[_0x459a50(0x154)](_0x459a50(0x17f),{'userId':_0x52d249[_0x459a50(0x121)]['id']})[_0x459a50(0x11a)]();}async[_0x5e75f1(0x1b2)](){return 0x1;}};MjService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x5e75f1(0x101)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_2[_0x5e75f1(0x101)])(balance_entity_1[_0x5e75f1(0x156)])),__metadata('design:paramtypes',[typeorm_1[_0x5e75f1(0x10e)],typeorm_1[_0x5e75f1(0x10e)],upload_service_1[_0x5e75f1(0x170)],chatLog_service_1[_0x5e75f1(0x148)],globalConfig_service_1[_0x5e75f1(0x1a1)],fanyi_service_1['FanyiService'],badwords_service_1[_0x5e75f1(0x1a6)]])],MjService),exports[_0x5e75f1(0x17b)]=MjService;