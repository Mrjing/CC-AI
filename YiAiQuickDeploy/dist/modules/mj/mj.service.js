'use strict';const _0x132145=_0x2f3a;(function(_0x37a920,_0x40a24c){const _0x4e8fde=_0x2f3a,_0x385e96=_0x37a920();while(!![]){try{const _0x52ca1a=parseInt(_0x4e8fde(0x1f4))/0x1+parseInt(_0x4e8fde(0x15a))/0x2+-parseInt(_0x4e8fde(0x1bf))/0x3+parseInt(_0x4e8fde(0x1c1))/0x4*(-parseInt(_0x4e8fde(0x1eb))/0x5)+-parseInt(_0x4e8fde(0x1f5))/0x6+parseInt(_0x4e8fde(0x164))/0x7+parseInt(_0x4e8fde(0x1b2))/0x8;if(_0x52ca1a===_0x40a24c)break;else _0x385e96['push'](_0x385e96['shift']());}catch(_0x266586){_0x385e96['push'](_0x385e96['shift']());}}}(_0x30f6,0xa65ef));function _0x30f6(){const _0x52e9e1=['parse','DeductionKey','balance\x20-\x201','您当前暂无MJ绘画余额！！！','freeQueueUsers','pollForUpscaleResult','createQueryBuilder','历史这些id已经被获取过了\x20不能拿了:\x20','rateLimits','post','replace','FanyiService','findCurrentPromptResult','https://discord.com/api/v9/interactions','decorate','pollForVariationResult','当前提示词已经在任务队列中了、请勿重复提交。。。','放大单张图片请求失败...','\x20次开始查询[变换图片]','enlarge','/messages?limit=50','__param','发送绘画指令结果:\x20','super','prompt\x20-------->\x20\x20','sendDrawInteractions','drawWorking','开始查询绘画结果轮询','秒请求一次、请合理使用！','ChatLogService','查询期间出现错误：','当前用户','error','user','绘画超时，请稍后再试！','findCurrentEnlargeImgResult','BAD_REQUEST','mjProxy','当前图片没有绘画信息、无法放大!','execute','mjSessionId','../globalConfig/globalConfig.service','map','convertToEnglish','checkBadWords','components','message_id','find','url','BadwordsService','uploadService','chatLogService','getMjDefaultParams','defineProperty','http://172.247.48.137:8000/mj/draw','metadata','findOne','chatLogEntity','queueCount','getOwnPropertyDescriptor','saveChatLog','uploadFileFromUrl','HttpStatus','InjectRepository','randomId:\x20','查询绘制结果失败...','绘制图片任务异常中断\x20队列-1:\x20','由于速率限制、当前普通用户限制为','存入图片完成:\x20','PAINT_TYPE','16170856voVnOt','HttpException','Repository','../../common/utils','放大图片任务异常中断\x20队列-1:\x20','变换当前图片超时！','mjRateLimit','https://discord.com/api/v9/channels/','mjApplicationId','当前图片已经放大过了、请勿重复放大!','balanceEntity','getConfigs','getClientIp','3772563RWxPxU','variationSingleImg','97288ImtwqL','deductBalance','放大图片任务结束\x20队列-1:\x20','checkAuth','object','../chatLog/chatLog.entity','log','BalanceEntity','variationId','includes','mjChannelId','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','mjDraw','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','当前用户\x20','baiduFanyiAppId','本次放大图片的id:\x20','fanyiService','放大custom_id:\x20','MjService','data','extractContent','网络连接失败，请稍后再试！','mjservice','now','function','\x20次开始查询\x20=>\x20当前查询结果：','balance','design:paramtypes','mjGuildId','match','Like','get','http://172.247.48.137:8000/mj/list?channel_id=','\x20队列+1:\x20','update','../userBalance/balance.entity','axios','mjNotSaveImg','sleep','message','../../common/constants/balance.constant','190DnwIwg','历史中存在当前图片、直接获取！','length','removeEmoji','绘图指令完成','IsNull','mjId','本次比对的随机ID:\x20','response','1033613ypztTu','7332462POmUYC','pollForResult','baiduFanyiSecret','Injectable','stringify','globalConfigService','当前图片没有绘画信息、无法变体!','findCurrentVariationImgResult','mjVersion','有历史信息之间返回:\x20','../badwords/badwords.service','queryMessageList','substring','admin','1947094oDvWAG','floor','badwordsService','filter','mjAuthorization','历史记录中不存在当前图片、请确认您放大的图片是否存在','使用的次数：','sendSmInteractions','__metadata','Not','397404sCIzFT','createRandomUid','UploadService','upscaleSingleImg','prompt','orderId','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','变化图片任务异常中断\x20队列-1:\x20'];_0x30f6=function(){return _0x52e9e1;};return _0x30f6();}var __decorate=this&&this['__decorate']||function(_0x59353c,_0x3c74d0,_0x1278c0,_0x399b44){const _0x5e41da=_0x2f3a;var _0x1fe609=arguments[_0x5e41da(0x1ed)],_0x33c85b=_0x1fe609<0x3?_0x3c74d0:_0x399b44===null?_0x399b44=Object[_0x5e41da(0x1a7)](_0x3c74d0,_0x1278c0):_0x399b44,_0x30d625;if(typeof Reflect===_0x5e41da(0x1c5)&&typeof Reflect[_0x5e41da(0x17a)]===_0x5e41da(0x1da))_0x33c85b=Reflect['decorate'](_0x59353c,_0x3c74d0,_0x1278c0,_0x399b44);else{for(var _0x3e90b5=_0x59353c[_0x5e41da(0x1ed)]-0x1;_0x3e90b5>=0x0;_0x3e90b5--)if(_0x30d625=_0x59353c[_0x3e90b5])_0x33c85b=(_0x1fe609<0x3?_0x30d625(_0x33c85b):_0x1fe609>0x3?_0x30d625(_0x3c74d0,_0x1278c0,_0x33c85b):_0x30d625(_0x3c74d0,_0x1278c0))||_0x33c85b;}return _0x1fe609>0x3&&_0x33c85b&&Object['defineProperty'](_0x3c74d0,_0x1278c0,_0x33c85b),_0x33c85b;},__metadata=this&&this[_0x132145(0x162)]||function(_0x2dd37e,_0x5d00f6){const _0x383717=_0x132145;if(typeof Reflect===_0x383717(0x1c5)&&typeof Reflect[_0x383717(0x1a3)]===_0x383717(0x1da))return Reflect[_0x383717(0x1a3)](_0x2dd37e,_0x5d00f6);},__param=this&&this[_0x132145(0x181)]||function(_0x3ab72b,_0x5b5342){return function(_0x5882a1,_0x253e39){_0x5b5342(_0x5882a1,_0x253e39,_0x3ab72b);};};Object[_0x132145(0x1a1)](exports,'__esModule',{'value':!![]}),exports[_0x132145(0x1d4)]=void 0x0;const globalConfig_service_1=require(_0x132145(0x195)),upload_service_1=require('../upload/upload.service'),common_1=require('@nestjs/common'),axios_1=require(_0x132145(0x1e6)),chatLog_service_1=require('../chatLog/chatLog.service'),balance_constant_1=require(_0x132145(0x1ea)),utils_1=require(_0x132145(0x1b5)),chatLog_entity_1=require(_0x132145(0x1c6)),typeorm_1=require('typeorm'),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require(_0x132145(0x1e5)),fanyi_service_1=require('../fanyi/fanyi.service'),badwords_service_1=require(_0x132145(0x156));let MjService=class MjService{constructor(_0x3088ee,_0x160df8,_0x5a5787,_0x49de17,_0x2c0533,_0x2eee21,_0x47d313){const _0x315082=_0x132145;this[_0x315082(0x1a5)]=_0x3088ee,this[_0x315082(0x1bc)]=_0x160df8,this['uploadService']=_0x5a5787,this[_0x315082(0x19f)]=_0x49de17,this[_0x315082(0x151)]=_0x2c0533,this[_0x315082(0x1d2)]=_0x2eee21,this[_0x315082(0x15c)]=_0x47d313,this[_0x315082(0x174)]={},this[_0x315082(0x186)]=[],this['enlargeWorking']=[],this['queueCount']=0x0,this[_0x315082(0x170)]={};}async[_0x132145(0x1cd)](_0xfeed91){const _0x4df4fe=_0x132145,{jobId:_0x5c7969,prompt:_0x4c42bf,startTime:_0x13c476,userId:_0x59e1e8}=_0xfeed91;return console['log']('绘画任务开始',_0x4df4fe(0x1d8)),await new Promise(_0x3b897e=>setTimeout(_0x3b897e,0x1388)),{'a':0x1,'b':0x2};}async['draw'](_0x502cac,_0x3d5f0d){const _0x50f3fd=_0x132145;await this['checkAuth'](_0x3d5f0d),await this[_0x50f3fd(0x15c)][_0x50f3fd(0x198)](_0x502cac['prompt'],_0x3d5f0d[_0x50f3fd(0x18d)]['id']);const _0x1def3=_0x502cac[_0x50f3fd(0x168)];let _0x4efd97=_0x502cac[_0x50f3fd(0x168)];const {baiduFanyiAppId:_0x50696f,baiduFanyiSecret:_0xbb1468}=await this[_0x50f3fd(0x151)][_0x50f3fd(0x1bd)]([_0x50f3fd(0x1d0),_0x50f3fd(0x14e)]);_0x50696f&&_0xbb1468&&(_0x4efd97=await this[_0x50f3fd(0x1d2)][_0x50f3fd(0x197)](_0x1def3));const _0x2017e0='['+(0x0,utils_1[_0x50f3fd(0x165)])()+']',_0x6b3397=_0x2017e0+'\x20'+_0x4efd97;console[_0x50f3fd(0x1c7)](_0x50f3fd(0x1ac),_0x2017e0),console[_0x50f3fd(0x1c7)](_0x50f3fd(0x184),_0x6b3397);const _0x15297d=this[_0x50f3fd(0x186)][_0x50f3fd(0x19b)](_0x48d75d=>_0x48d75d[_0x50f3fd(0x1ca)](_0x502cac[_0x50f3fd(0x168)]));if(_0x15297d)throw new common_1[(_0x50f3fd(0x1b3))](_0x50f3fd(0x17c),common_1[_0x50f3fd(0x1aa)][_0x50f3fd(0x190)]);if(this[_0x50f3fd(0x1a6)]>=0x3)throw new common_1[(_0x50f3fd(0x1b3))](_0x50f3fd(0x1ce),common_1['HttpStatus']['BAD_REQUEST']);await this['checkRateLimit'](_0x3d5f0d),this[_0x50f3fd(0x1a6)]++,console[_0x50f3fd(0x1c7)]('开始请求用户'+_0x3d5f0d[_0x50f3fd(0x18d)]['id']+_0x50f3fd(0x1e3),this['queueCount']);try{const _0x409445=await this['chatLogEntity'][_0x50f3fd(0x19b)]({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0x6b3397+'%')}}),_0x16c8b5=_0x409445[_0x50f3fd(0x196)](_0x22888a=>_0x22888a[_0x50f3fd(0x19a)]);this[_0x50f3fd(0x186)]['push'](_0x6b3397);let _0x422e89;const _0x558d75=await this[_0x50f3fd(0x185)](_0x6b3397,_0x16c8b5,_0x2017e0);_0x558d75?(console[_0x50f3fd(0x1c7)](_0x50f3fd(0x1ec)),_0x422e89=_0x558d75):_0x422e89=await this[_0x50f3fd(0x1f6)](_0x6b3397,_0x16c8b5,_0x2017e0);this['queueCount']--,this[_0x50f3fd(0x1a6)]<0x0&&(this['queueCount']=0x0),console[_0x50f3fd(0x1c7)]('绘制图片任务结束\x20队列-1:\x20',this['queueCount']);const {id:_0x313c5a,content:_0x2b0b6a,channel_id:_0x2ccb41,attachments:attachments=[],timestamp:_0x226b0d}=_0x422e89;if(!attachments[_0x50f3fd(0x1ed)]||!attachments[0x0][_0x50f3fd(0x19c)])throw new common_1[(_0x50f3fd(0x1b3))]('绘画失败',common_1[_0x50f3fd(0x1aa)][_0x50f3fd(0x190)]);const {filename:_0x18ea2b,url:_0x5050dc,width:_0x2f4f20,height:_0x45c85c,size:_0x1c7939}=attachments[0x0];console[_0x50f3fd(0x1c7)]('拿到了远程地址:\x20',_0x5050dc);const _0x1990d0=this[_0x50f3fd(0x151)][_0x50f3fd(0x1bd)]([_0x50f3fd(0x1e7)]);let _0x2b5fc4='';(!Number(_0x1990d0)||Number(_0x1990d0)===0x0)&&(_0x2b5fc4=await this[_0x50f3fd(0x19e)][_0x50f3fd(0x1a9)]({'filename':_0x18ea2b,'url':_0x5050dc}),console[_0x50f3fd(0x1c7)]('存入图片完成:\x20',_0x2b5fc4));const _0xb13720={'curIp':(0x0,utils_1['getClientIp'])(_0x3d5f0d),'userId':_0x3d5f0d['user']['id'],'type':balance_constant_1[_0x50f3fd(0x16d)]['PAINT_TYPE'],'prompt':_0x6b3397,'answer':_0x2b5fc4,'model':'mj','extend':this[_0x50f3fd(0x1ee)](JSON['stringify'](_0x422e89)),'message_id':_0x313c5a,'variationId':_0x313c5a,'upscaleId':_0x313c5a,'group':0x1,'isSaveImg':!Number(_0x1990d0)||Number(_0x1990d0)===0x0,'fileInfo':JSON['stringify']({'width':_0x2f4f20,'height':_0x45c85c,'size':_0x1c7939,'filename':_0x18ea2b,'cosUrl':_0x2b5fc4})};return await this['chatLogService'][_0x50f3fd(0x1a8)](_0xb13720),await this[_0x50f3fd(0x1c2)](_0x3d5f0d),this[_0x50f3fd(0x186)]=this[_0x50f3fd(0x186)][_0x50f3fd(0x15d)](_0x357f38=>_0x357f38!==_0x502cac[_0x50f3fd(0x168)]),_0x2b5fc4;}catch(_0x52baa9){this[_0x50f3fd(0x1a6)]--,this[_0x50f3fd(0x1a6)]<0x0&&(this[_0x50f3fd(0x1a6)]=0x0),console[_0x50f3fd(0x1c7)](_0x50f3fd(0x1ae),this['queueCount']),this['drawWorking']=this[_0x50f3fd(0x186)]['filter'](_0xe5e86d=>_0xe5e86d!==_0x502cac[_0x50f3fd(0x168)]);throw new common_1[(_0x50f3fd(0x1b3))](_0x52baa9[_0x50f3fd(0x1f3)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x132145(0x167)](_0x47ccf4,_0x2586e7){const _0xde31d2=_0x132145;if(this[_0xde31d2(0x1a6)]>=0x3)throw new common_1[(_0xde31d2(0x1b3))](_0xde31d2(0x1ce),common_1[_0xde31d2(0x1aa)]['BAD_REQUEST']);this[_0xde31d2(0x1a6)]++,console[_0xde31d2(0x1c7)]('用户'+_0x2586e7[_0xde31d2(0x18d)]['id']+'开始请求放大图片\x20队列+1:\x20',this['queueCount']);const {message_id:_0x3e4592,orderId:_0x4645ab}=_0x47ccf4;try{const _0x13156e=await this['chatLogEntity'][_0xde31d2(0x1a4)]({'where':{'message_id':_0x3e4592}});if(!_0x13156e)throw new common_1[(_0xde31d2(0x1b3))](_0xde31d2(0x15f),common_1[_0xde31d2(0x1aa)][_0xde31d2(0x190)]);const _0x2added=await this['chatLogEntity'][_0xde31d2(0x1a4)]({'where':{'upscaleId':_0x3e4592,'action':'enlarge','orderId':_0x4645ab}});if(_0x2added)throw new common_1[(_0xde31d2(0x1b3))](_0xde31d2(0x1bb),common_1['HttpStatus'][_0xde31d2(0x190)]);const {prompt:_0x146599,extend:_0x145b5b}=_0x13156e;let _0x21aa41=null;try{_0x21aa41=JSON[_0xde31d2(0x16c)](_0x145b5b);}catch(_0x76f27d){_0x21aa41=[];}const {components:components=[]}=_0x21aa41;if(!components[_0xde31d2(0x1ed)])throw new common_1[(_0xde31d2(0x1b3))](_0xde31d2(0x192),common_1['HttpStatus'][_0xde31d2(0x190)]);const _0x3b12d0=components[0x0]['components'][_0x4645ab-0x1],{custom_id:_0x360338}=_0x3b12d0;console[_0xde31d2(0x1c7)](_0xde31d2(0x1d3),_0x360338);const _0x5ed651={'message_id':_0x3e4592,'custom_id':_0x360338,'prompt':_0x146599,'orderId':_0x4645ab};await this[_0xde31d2(0x161)](_0x5ed651),console[_0xde31d2(0x1c7)]('发送放大指令成功');const _0x3c6969=await this[_0xde31d2(0x1a5)]['find']({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0x146599+'%')}}),_0x4a8b6f=_0x3c6969[_0xde31d2(0x196)](_0x1a8ddc=>_0x1a8ddc[_0xde31d2(0x19a)]);console['log'](_0xde31d2(0x173),_0x4a8b6f);const _0x1a992e=await this[_0xde31d2(0x171)](_0x5ed651,_0x4a8b6f);this[_0xde31d2(0x1a6)]--,this['queueCount']<0x0&&(this[_0xde31d2(0x1a6)]=0x0),console[_0xde31d2(0x1c7)](_0xde31d2(0x1c3),this[_0xde31d2(0x1a6)]);const {id:_0x2812a8,content:_0x23b846,channel_id:_0x121a4e,attachments:attachments=[],timestamp:_0x4a6788}=_0x1a992e;if(!attachments['length']||!attachments[0x0][_0xde31d2(0x19c)])throw new common_1[(_0xde31d2(0x1b3))]('放大当前图片失败',common_1[_0xde31d2(0x1aa)][_0xde31d2(0x190)]);const {filename:_0x1f51af,url:_0x1a50e3,width:_0x424cd7,height:_0x41bce7,size:_0x4e681b}=attachments[0x0],_0x514974=this['globalConfigService'][_0xde31d2(0x1bd)](['mjNotSaveImg']);let _0x3655fd='';(!Number(_0x514974)||Number(_0x514974)===0x0)&&(_0x3655fd=await this[_0xde31d2(0x19e)][_0xde31d2(0x1a9)]({'filename':_0x1f51af,'url':_0x1a50e3}),console[_0xde31d2(0x1c7)](_0xde31d2(0x1b0),_0x3655fd));const _0x4487c5={'curIp':(0x0,utils_1['getClientIp'])(_0x2586e7),'userId':_0x2586e7['user']['id'],'type':balance_constant_1['DeductionKey'][_0xde31d2(0x1b1)],'prompt':_0x146599,'answer':_0x3655fd,'model':'mj','extend':this[_0xde31d2(0x1ee)](JSON['stringify'](_0x1a992e)),'message_id':_0x3e4592,'upscaleId':_0x2812a8,'variationId':_0x2812a8,'action':_0xde31d2(0x17f),'orderId':_0x5ed651[_0xde31d2(0x169)],'isSaveImg':!Number(_0x514974)||Number(_0x514974)===0x0,'fileInfo':JSON[_0xde31d2(0x150)]({'width':_0x424cd7,'height':_0x41bce7,'size':_0x4e681b,'filename':_0x1f51af,'cosUrl':_0x3655fd})};return await this[_0xde31d2(0x19f)][_0xde31d2(0x1a8)](_0x4487c5),_0x3655fd;}catch(_0x12048e){console[_0xde31d2(0x1c7)]('error:\x20',_0x12048e),this[_0xde31d2(0x1a6)]--,this['queueCount']<0x0&&(this[_0xde31d2(0x1a6)]=0x0),console[_0xde31d2(0x1c7)](_0xde31d2(0x1b6),this[_0xde31d2(0x1a6)]);throw new common_1[(_0xde31d2(0x1b3))](_0x12048e[_0xde31d2(0x1f3)],common_1[_0xde31d2(0x1aa)][_0xde31d2(0x190)]);}}async[_0x132145(0x1c0)](_0x266c0a,_0x3b6668){const _0x42e727=_0x132145;if(this['queueCount']>=0x3)throw new common_1[(_0x42e727(0x1b3))](_0x42e727(0x1ce),common_1[_0x42e727(0x1aa)][_0x42e727(0x190)]);await this['checkAuth'](_0x3b6668),await this['checkRateLimit'](_0x3b6668),this['queueCount']++,console[_0x42e727(0x1c7)]('用户'+_0x3b6668[_0x42e727(0x18d)]['id']+'开始请求变换图片\x20队列+1:\x20',this[_0x42e727(0x1a6)]);const {message_id:_0x4cb2f4,orderId:_0xa3499c}=_0x266c0a;try{const _0x4fb029=await this['chatLogEntity'][_0x42e727(0x1a4)]({'where':{'message_id':_0x4cb2f4}});if(!_0x4fb029)throw new common_1[(_0x42e727(0x1b3))](_0x42e727(0x1cc),common_1[_0x42e727(0x1aa)]['BAD_REQUEST']);const {prompt:_0x5e71f7,extend:_0x28c609}=_0x4fb029;let _0x592def=null;try{_0x592def=JSON[_0x42e727(0x16c)](_0x28c609);}catch(_0x972e){_0x592def=[];}const {components:components=[]}=_0x592def;if(!components[_0x42e727(0x1ed)])throw new common_1[(_0x42e727(0x1b3))](_0x42e727(0x152),common_1['HttpStatus'][_0x42e727(0x190)]);const _0xa93484=components[0x1][_0x42e727(0x199)][_0xa3499c-0x1],{custom_id:_0x18921f}=_0xa93484,_0x229f25=await this[_0x42e727(0x1a5)][_0x42e727(0x19b)]({'where':{'variationId':(0x0,typeorm_1[_0x42e727(0x163)])((0x0,typeorm_1[_0x42e727(0x1f0)])()),'prompt':(0x0,typeorm_1[_0x42e727(0x1e0)])('%'+_0x5e71f7+'%')}}),_0x1f3efe=_0x229f25[_0x42e727(0x196)](_0x525b84=>_0x525b84[_0x42e727(0x1c9)]),_0x25f45a={'message_id':_0x4cb2f4,'custom_id':_0x18921f,'prompt':_0x5e71f7,'orderId':_0xa3499c};await this['sendSmInteractions'](_0x25f45a);const _0x85aba3=await this[_0x42e727(0x17b)](_0x25f45a,_0x1f3efe);this[_0x42e727(0x1a6)]--,this['queueCount']<0x0&&(this[_0x42e727(0x1a6)]=0x0),console[_0x42e727(0x1c7)]('变换图片任务结束\x20队列-1:\x20',this[_0x42e727(0x1a6)]);const {id:_0x46a91e,content:_0x125a24,channel_id:_0x4a0397,attachments:attachments=[],timestamp:_0x253175}=_0x85aba3;if(!attachments[_0x42e727(0x1ed)]||!attachments[0x0][_0x42e727(0x19c)])throw new common_1[(_0x42e727(0x1b3))]('变换当前图片失败',common_1[_0x42e727(0x1aa)][_0x42e727(0x190)]);const {filename:_0x2d77a9,url:_0x59d438,width:_0x119d6a,height:_0x39e683,size:_0x2efeea}=attachments[0x0],_0x9a460=this[_0x42e727(0x151)][_0x42e727(0x1bd)]([_0x42e727(0x1e7)]);let _0x140b95='';(!Number(_0x9a460)||Number(_0x9a460)===0x0)&&(_0x140b95=await this[_0x42e727(0x19e)]['uploadFileFromUrl']({'filename':_0x2d77a9,'url':_0x59d438}),console[_0x42e727(0x1c7)](_0x42e727(0x1b0),_0x140b95));const _0x47ec65={'curIp':(0x0,utils_1[_0x42e727(0x1be)])(_0x3b6668),'userId':_0x3b6668[_0x42e727(0x18d)]['id'],'type':balance_constant_1[_0x42e727(0x16d)][_0x42e727(0x1b1)],'prompt':_0x5e71f7,'answer':_0x140b95,'model':'mj','group':0x1,'extend':this[_0x42e727(0x1ee)](JSON['stringify'](_0x85aba3)),'message_id':_0x46a91e,'upscaleId':_0x46a91e,'variationId':_0x46a91e,'action':_0x42e727(0x17f),'orderId':_0x25f45a[_0x42e727(0x169)],'isSaveImg':!Number(_0x9a460)||Number(_0x9a460)===0x0,'fileInfo':JSON[_0x42e727(0x150)]({'width':_0x119d6a,'height':_0x39e683,'size':_0x2efeea,'filename':_0x2d77a9,'cosUrl':_0x140b95})};return await this[_0x42e727(0x19f)][_0x42e727(0x1a8)](_0x47ec65),_0x140b95;}catch(_0x23a69a){console[_0x42e727(0x1c7)]('error:\x20',_0x23a69a),this['queueCount']--,this[_0x42e727(0x1a6)]<0x0&&(this['queueCount']=0x0),console['log'](_0x42e727(0x16b),this[_0x42e727(0x1a6)]);throw new common_1[(_0x42e727(0x1b3))](_0x23a69a[_0x42e727(0x1f3)],common_1[_0x42e727(0x1aa)]['BAD_REQUEST']);}}async[_0x132145(0x161)](_0x1f12b4){const _0x47780b=_0x132145,{message_id:_0x16094e,custom_id:_0x2891ea}=_0x1f12b4,{application_id:_0x567d33,guild_id:_0x54baa0,channel_id:_0x7d97c9,session_id:_0xd57bd2,version:_0x1f31a7,id:_0x577f7a,authorization:_0x49ff3a,mjProxy:_0x59e4d1}=await this[_0x47780b(0x1a0)](),_0x2944b7=_0x59e4d1==0x1?_0x47780b(0x1a2):_0x47780b(0x179),_0x12efd5={'authorization':_0x49ff3a},_0x1f9e08={'type':0x3,'guild_id':_0x54baa0,'channel_id':_0x7d97c9,'message_flags':0x0,'message_id':_0x16094e,'application_id':_0x567d33,'session_id':_0xd57bd2,'data':{'component_type':0x2,'custom_id':_0x2891ea}};try{await axios_1['default'][_0x47780b(0x175)](_0x2944b7,_0x1f9e08,{'headers':_0x12efd5}),console[_0x47780b(0x1c7)](_0x47780b(0x1ef));}catch(_0x15f324){console[_0x47780b(0x1c7)]('error:\x20',_0x15f324);throw new common_1[(_0x47780b(0x1b3))](_0x47780b(0x17d),common_1[_0x47780b(0x1aa)]['BAD_REQUEST']);}}async[_0x132145(0x171)](_0x9b40ea,_0x4362d1){const _0x28f2f9=_0x132145,{message_id:_0x56a6e9,custom_id:_0x213133,prompt:_0x592bc6,orderId:_0x1dc890}=_0x9b40ea;let _0xb98512=null,_0x208eee=0x0;while(!_0xb98512&&_0x208eee<0xa){try{const _0x39753f=Date[_0x28f2f9(0x1d9)](),_0x454afa=await this[_0x28f2f9(0x157)]();console[_0x28f2f9(0x1c7)]('第\x20'+(_0x208eee+0x1)+_0x28f2f9(0x1db)+_0x454afa['length']);_0x454afa&&_0x454afa[_0x28f2f9(0x1ed)]&&(_0xb98512=await this[_0x28f2f9(0x18f)](_0x454afa,_0x9b40ea,_0x4362d1));const _0x196e6b=Date[_0x28f2f9(0x1d9)]()-_0x39753f,_0x63b32b=0xbb8;await this[_0x28f2f9(0x1e8)](Math['max'](_0x63b32b-_0x196e6b,0x0)),_0x208eee++;}catch(_0x5d5a00){console[_0x28f2f9(0x18c)](_0x28f2f9(0x18a)+_0x5d5a00[_0x28f2f9(0x1e9)]);}}return _0xb98512;}async[_0x132145(0x17b)](_0x50bccf,_0x9ea8ac){const _0x23ed5d=_0x132145,{message_id:_0x1a3da3,custom_id:_0xd60dc0,prompt:_0x325d31,orderId:_0x18361c}=_0x50bccf;console[_0x23ed5d(0x1c7)]('开始轮询单张变换图片结果');let _0x2fb68d=null,_0x24b84a=0x0;while(!_0x2fb68d&&_0x24b84a<0xa){try{console[_0x23ed5d(0x1c7)]('第\x20'+(_0x24b84a+0x1)+_0x23ed5d(0x17e));const _0x598365=Date[_0x23ed5d(0x1d9)](),_0x5a144b=await this[_0x23ed5d(0x157)]();_0x5a144b&&_0x5a144b[_0x23ed5d(0x1ed)]&&(_0x2fb68d=await this[_0x23ed5d(0x153)](_0x5a144b,_0x50bccf,_0x9ea8ac));const _0x3a38df=Date[_0x23ed5d(0x1d9)]()-_0x598365,_0x5a8103=0x1f40;await this[_0x23ed5d(0x1e8)](Math['max'](_0x5a8103-_0x3a38df,0x0)),_0x24b84a++;}catch(_0x458b8b){console[_0x23ed5d(0x18c)](_0x23ed5d(0x18a)+_0x458b8b[_0x23ed5d(0x1e9)]);}}if(!_0x2fb68d)throw new common_1[(_0x23ed5d(0x1b3))](_0x23ed5d(0x1b7),common_1[_0x23ed5d(0x1aa)][_0x23ed5d(0x190)]);return _0x2fb68d;}async['findCurrentEnlargeImgResult'](_0xe3535a,_0x3b6406,_0x56968d){const _0x1df4be=_0x132145,{message_id:_0x275256,custom_id:_0x23cf13,prompt:_0x42d74a,orderId:_0x1049a6}=_0x3b6406,_0x5f265e=_0x42d74a[_0x1df4be(0x158)](0x0,0xc);console[_0x1df4be(0x1c7)](_0x1df4be(0x1d1),_0x5f265e);const _0x28b366=_0xe3535a['find'](_0x36aa51=>{const _0x3a142b=_0x1df4be,{content:_0x31cd82}=_0x36aa51;if(!this[_0x3a142b(0x1d6)](_0x31cd82))return![];const {prompt:_0x134c8a,order:_0x2937ac}=this[_0x3a142b(0x1d6)](_0x31cd82);return _0x134c8a[_0x3a142b(0x1ca)](_0x5f265e)&&_0x3b6406[_0x3a142b(0x169)]===_0x2937ac&&!_0x56968d[_0x3a142b(0x1ca)](_0x36aa51['id']);});return _0x28b366;}async[_0x132145(0x153)](_0x2a3615,_0x184051,_0xc700b3){const _0x22422f=_0x132145,{message_id:_0x3a3df9,custom_id:_0x18e91f,prompt:_0x520d88,orderId:_0x3edcad}=_0x184051,_0x378f32=_0x520d88[_0x22422f(0x158)](0x0,0xc),_0x1ae1a8=_0x2a3615[_0x22422f(0x19b)](_0x2b33b0=>{const _0x1a8a96=_0x22422f,{content:_0x438c0f}=_0x2b33b0,_0x2a586f=_0x438c0f[_0x1a8a96(0x1df)](/\*\*(.+?)\*\*/),_0x5dfb63=_0x2a586f?_0x2a586f[0x1]:'';if(!_0x5dfb63)return![];return _0x5dfb63[_0x1a8a96(0x1ca)](_0x378f32)&&!_0xc700b3[_0x1a8a96(0x1ca)](_0x2b33b0['id']);});return _0x1ae1a8;}async[_0x132145(0x185)](_0x16dda3,_0x5b72f1,_0x35cf4e){const _0x4ae3c6=_0x132145,_0x465571=await this['queryMessageList'](),_0x2a4625=await this['findCurrentPromptResult'](_0x465571,_0x35cf4e,_0x5b72f1);if(_0x2a4625)return console[_0x4ae3c6(0x1c7)](_0x4ae3c6(0x155),_0x2a4625),_0x2a4625;const {application_id:_0x39bb71,guild_id:_0x3abf12,channel_id:_0x5d4fda,session_id:_0x7bbb81,version:_0x370084,id:_0xbf7a8b,authorization:_0x5992fc,mjProxy:_0x5532cd}=await this[_0x4ae3c6(0x1a0)](),_0x39e991={'type':0x2,'application_id':_0x39bb71,'guild_id':_0x3abf12,'channel_id':_0x5d4fda,'session_id':_0x7bbb81,'data':{'version':_0x370084,'id':_0xbf7a8b,'name':'imagine','type':0x1,'options':[{'type':0x3,'name':'prompt','value':_0x16dda3}],'attachments':[]}};try{const _0x2dbb51=_0x5532cd==0x1?_0x4ae3c6(0x1a2):_0x4ae3c6(0x179),_0x2f8e96={'authorization':_0x5992fc},_0x408912=await axios_1['default'][_0x4ae3c6(0x175)](_0x2dbb51,_0x39e991,{'headers':_0x2f8e96});return console[_0x4ae3c6(0x1c7)](_0x4ae3c6(0x182),_0x408912[_0x4ae3c6(0x1d5)]),![];}catch(_0x31afc4){console[_0x4ae3c6(0x1c7)]('axios:\x20',_0x31afc4);throw new common_1[(_0x4ae3c6(0x1b3))](_0x4ae3c6(0x16a),common_1[_0x4ae3c6(0x1aa)][_0x4ae3c6(0x190)]);}}async[_0x132145(0x1f6)](_0x4335f5,_0x7d0606,_0x5a4ac6){const _0x17cabc=_0x132145;console[_0x17cabc(0x1c7)](_0x17cabc(0x187));const _0x205762=Date[_0x17cabc(0x1d9)]();try{const _0x28a02f=0xd,_0x150d70=0x2ee0,_0x2216c9=0x1388,_0x289be1=0x3c*0x3e8;let _0x45f04b=0x0,_0xa88792=![],_0x143442=null;while(!_0x143442&&_0x45f04b<_0x28a02f){console['log']('第\x20'+(_0x45f04b+0x1)+'\x20次开始查询');Date[_0x17cabc(0x1d9)]()-_0x205762>=_0x289be1&&(_0xa88792=!![]);await this[_0x17cabc(0x1e8)](_0xa88792?_0x2216c9:_0x150d70);const _0x577ade=await this[_0x17cabc(0x157)]();_0x143442=await this['findCurrentPromptResult'](_0x577ade,_0x5a4ac6,_0x7d0606),_0x45f04b++;}if(!_0x143442)throw new common_1['HttpException'](_0x17cabc(0x18e),common_1[_0x17cabc(0x1aa)]['BAD_REQUEST']);const _0x11bdf8=Date['now']();return console[_0x17cabc(0x1c7)]('本次绘图耗时:\x20'+Math[_0x17cabc(0x15b)]((_0x11bdf8-_0x205762)/0x3e8)+'\x20S'),_0x143442;}catch(_0x57cd3d){console[_0x17cabc(0x18c)](_0x57cd3d['message']);throw new common_1[(_0x17cabc(0x1b3))](_0x17cabc(0x1d7),common_1['HttpStatus']['INTERNAL_SERVER_ERROR']);}}async[_0x132145(0x178)](_0x2d0495,_0x346e1b,_0x15ccf7){const _0x1003ee=_0x132145;if(!_0x2d0495||!_0x2d0495[_0x1003ee(0x1ed)])return;console[_0x1003ee(0x1c7)](_0x1003ee(0x1f2),_0x346e1b);const _0x1c27df=_0x2d0495['find'](_0x9f2c90=>{const _0xc2080b=_0x1003ee,{attachments:attachments=[],content:_0x5c7f44,edited_timestamp:_0x1b648f}=_0x9f2c90;return _0x5c7f44[_0xc2080b(0x1ca)](_0x346e1b)&&attachments[_0xc2080b(0x1ed)]>0x0&&!_0x1b648f&&!_0x15ccf7[_0xc2080b(0x1ca)](_0x9f2c90['id']);});return _0x1c27df||null;}async[_0x132145(0x157)](){const _0x4bcf30=_0x132145;try{const {application_id:_0x4f8472,guild_id:_0x27492a,channel_id:_0x3f3512,session_id:_0x2bb958,version:_0x31a4b0,id:_0xe0ffb6,authorization:_0x17565b,mjProxy:_0x3b8d26}=await this[_0x4bcf30(0x1a0)](),_0x18b210=_0x3b8d26==0x1?_0x4bcf30(0x1e2)+_0x3f3512:_0x4bcf30(0x1b9)+_0x3f3512+_0x4bcf30(0x180),_0x2248c6={'authorization':_0x17565b},_0x4e7560=await axios_1['default'][_0x4bcf30(0x1e1)](_0x18b210,{'headers':_0x2248c6});return _0x4e7560[_0x4bcf30(0x1d5)];}catch(_0x27c31e){console[_0x4bcf30(0x1c7)]('axios\x20get:\x20',_0x27c31e);throw new common_1[(_0x4bcf30(0x1b3))](_0x4bcf30(0x1ad),common_1['HttpStatus'][_0x4bcf30(0x190)]);}}async[_0x132145(0x1e8)](_0x20897c){return new Promise(_0x1eaf02=>setTimeout(_0x1eaf02,_0x20897c));}[_0x132145(0x1d6)](_0x4a213b){const _0x613828=_0x132145,_0x50cdad=_0x4a213b[_0x613828(0x1df)](/\*\*(.+?)\*\*/),_0x4ea655=_0x4a213b[_0x613828(0x1df)](/- Image #(\d+)/);if(!_0x50cdad||!_0x4ea655)return null;const _0x5e3aaf=_0x50cdad[0x1],_0x333835=parseInt(_0x4ea655[0x1]);return{'prompt':_0x5e3aaf,'order':_0x333835};}async[_0x132145(0x1a0)](){const _0x5b3a70=_0x132145,_0x5f3774=await this[_0x5b3a70(0x151)][_0x5b3a70(0x1bd)]([_0x5b3a70(0x1f1),_0x5b3a70(0x1ba),_0x5b3a70(0x1de),_0x5b3a70(0x1cb),_0x5b3a70(0x194),_0x5b3a70(0x154),_0x5b3a70(0x15e),_0x5b3a70(0x1b8),_0x5b3a70(0x191)]),_0xc0e4d4={'application_id':_0x5f3774[_0x5b3a70(0x1ba)],'guild_id':_0x5f3774[_0x5b3a70(0x1de)],'channel_id':_0x5f3774[_0x5b3a70(0x1cb)],'session_id':_0x5f3774[_0x5b3a70(0x194)],'version':_0x5f3774[_0x5b3a70(0x154)],'id':_0x5f3774[_0x5b3a70(0x1f1)],'authorization':_0x5f3774['mjAuthorization'],'mjRateLimit':_0x5f3774[_0x5b3a70(0x1b8)],'mjProxy':_0x5f3774[_0x5b3a70(0x191)]||0x0};return _0xc0e4d4;}['removeEmoji'](_0x3b6cba){const _0x23cc61=_0x132145,_0x579495=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x3b6cba[_0x23cc61(0x176)](_0x579495,'');}async[_0x132145(0x1c4)](_0x426e8d){const _0x572062=_0x132145,_0x13ead1=await this[_0x572062(0x1bc)][_0x572062(0x1a4)]({'where':{'userId':_0x426e8d[_0x572062(0x18d)]['id']}}),{id:_0x1cb00a,balance:_0x20ebbd}=_0x13ead1;if(!_0x20ebbd||(_0x13ead1===null||_0x13ead1===void 0x0?void 0x0:_0x13ead1[_0x572062(0x1dc)])<0x1)throw new common_1['HttpException'](_0x572062(0x16f),common_1[_0x572062(0x1aa)][_0x572062(0x190)]);}async['checkFree'](_0x451463){const _0x2285b6=_0x132145,{id:_0x11fd53,role:_0x2e9a14}=_0x451463['user'];!this['freeQueueUsers'][_0x11fd53]?this[_0x2285b6(0x170)][_0x11fd53]=0x1:this[_0x2285b6(0x170)][_0x11fd53]=this[_0x2285b6(0x170)][_0x11fd53]+0x1,console['log'](_0x2285b6(0x18b)+_0x11fd53+_0x2285b6(0x160),this[_0x2285b6(0x170)][_0x11fd53]);}async['checkRateLimit'](_0x523e4e){const _0x36680d=_0x132145,{id:_0x2ebe7b,role:_0x29f62b}=_0x523e4e[_0x36680d(0x18d)];if([_0x36680d(0x159),_0x36680d(0x183)][_0x36680d(0x1ca)](_0x29f62b))return!![];const {mjRateLimit:_0x3a4894}=await this[_0x36680d(0x1a0)]();if(this[_0x36680d(0x174)][_0x2ebe7b]){const _0x37b8d3=this['rateLimits'][_0x2ebe7b];if(_0x37b8d3>Date['now']()){console[_0x36680d(0x1c7)](_0x36680d(0x1cf)+_0x2ebe7b+'\x20请求过于频繁！');throw new common_1['HttpException'](_0x36680d(0x1af)+_0x3a4894+_0x36680d(0x188),common_1[_0x36680d(0x1aa)]['BAD_REQUEST']);}else this['rateLimits'][_0x2ebe7b]=Date[_0x36680d(0x1d9)]()+Number(_0x3a4894)*0x3e8;}else{const _0x4aa4d8=Date[_0x36680d(0x1d9)]();this['rateLimits'][_0x2ebe7b]=_0x4aa4d8+0x3e8*Number(_0x3a4894);}}async[_0x132145(0x1c2)](_0x21ca58){const _0x33a0dc=_0x132145;await this[_0x33a0dc(0x1bc)][_0x33a0dc(0x172)]()[_0x33a0dc(0x1e4)](balance_entity_1['BalanceEntity'])['set']({'balance':()=>_0x33a0dc(0x16e)})['where']('userId\x20=\x20:userId',{'userId':_0x21ca58[_0x33a0dc(0x18d)]['id']})[_0x33a0dc(0x193)]();}async['test'](){return 0x1;}};function _0x2f3a(_0x110853,_0x4ea1f3){const _0x30f6dc=_0x30f6();return _0x2f3a=function(_0x2f3a85,_0x1f355b){_0x2f3a85=_0x2f3a85-0x14e;let _0x33c96b=_0x30f6dc[_0x2f3a85];return _0x33c96b;},_0x2f3a(_0x110853,_0x4ea1f3);}MjService=__decorate([(0x0,common_1[_0x132145(0x14f)])(),__param(0x0,(0x0,typeorm_2[_0x132145(0x1ab)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_2[_0x132145(0x1ab)])(balance_entity_1[_0x132145(0x1c8)])),__metadata(_0x132145(0x1dd),[typeorm_1[_0x132145(0x1b4)],typeorm_1[_0x132145(0x1b4)],upload_service_1[_0x132145(0x166)],chatLog_service_1[_0x132145(0x189)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0x132145(0x177)],badwords_service_1[_0x132145(0x19d)]])],MjService),exports[_0x132145(0x1d4)]=MjService;