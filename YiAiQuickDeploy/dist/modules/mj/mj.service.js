'use strict';const _0x460739=_0x5ce2;(function(_0x403a46,_0x3c939e){const _0x491ff3=_0x5ce2,_0x445681=_0x403a46();while(!![]){try{const _0x55212a=parseInt(_0x491ff3(0x1a4))/0x1+-parseInt(_0x491ff3(0x201))/0x2*(-parseInt(_0x491ff3(0x233))/0x3)+-parseInt(_0x491ff3(0x21e))/0x4+parseInt(_0x491ff3(0x1a1))/0x5+parseInt(_0x491ff3(0x22c))/0x6+parseInt(_0x491ff3(0x1e9))/0x7+parseInt(_0x491ff3(0x1b0))/0x8;if(_0x55212a===_0x3c939e)break;else _0x445681['push'](_0x445681['shift']());}catch(_0x3be3af){_0x445681['push'](_0x445681['shift']());}}}(_0x5db0,0x7b4fe));var __decorate=this&&this[_0x460739(0x24f)]||function(_0x4c5845,_0x12cad7,_0x9ad58a,_0xf29ad9){const _0x34adee=_0x460739;var _0x5cd0c7=arguments[_0x34adee(0x238)],_0x231d65=_0x5cd0c7<0x3?_0x12cad7:_0xf29ad9===null?_0xf29ad9=Object['getOwnPropertyDescriptor'](_0x12cad7,_0x9ad58a):_0xf29ad9,_0x318fb7;if(typeof Reflect===_0x34adee(0x235)&&typeof Reflect[_0x34adee(0x21c)]===_0x34adee(0x1ab))_0x231d65=Reflect[_0x34adee(0x21c)](_0x4c5845,_0x12cad7,_0x9ad58a,_0xf29ad9);else{for(var _0x4c4aeb=_0x4c5845[_0x34adee(0x238)]-0x1;_0x4c4aeb>=0x0;_0x4c4aeb--)if(_0x318fb7=_0x4c5845[_0x4c4aeb])_0x231d65=(_0x5cd0c7<0x3?_0x318fb7(_0x231d65):_0x5cd0c7>0x3?_0x318fb7(_0x12cad7,_0x9ad58a,_0x231d65):_0x318fb7(_0x12cad7,_0x9ad58a))||_0x231d65;}return _0x5cd0c7>0x3&&_0x231d65&&Object[_0x34adee(0x1e6)](_0x12cad7,_0x9ad58a,_0x231d65),_0x231d65;},__metadata=this&&this[_0x460739(0x1cc)]||function(_0x47ff58,_0x3bcf65){const _0x473e01=_0x460739;if(typeof Reflect==='object'&&typeof Reflect[_0x473e01(0x1b2)]==='function')return Reflect[_0x473e01(0x1b2)](_0x47ff58,_0x3bcf65);},__param=this&&this[_0x460739(0x1d5)]||function(_0x4113ab,_0x55637a){return function(_0x32bb5e,_0xe3999){_0x55637a(_0x32bb5e,_0xe3999,_0x4113ab);};};function _0x5ce2(_0x1ed85e,_0x530c42){const _0x5db0fa=_0x5db0();return _0x5ce2=function(_0x5ce2b9,_0x42f8a8){_0x5ce2b9=_0x5ce2b9-0x1a1;let _0x555dd7=_0x5db0fa[_0x5ce2b9];return _0x555dd7;},_0x5ce2(_0x1ed85e,_0x530c42);}Object[_0x460739(0x1e6)](exports,_0x460739(0x1ac),{'value':!![]}),exports[_0x460739(0x1af)]=void 0x0;const globalConfig_service_1=require(_0x460739(0x1b9)),upload_service_1=require(_0x460739(0x211)),common_1=require('@nestjs/common'),axios_1=require(_0x460739(0x23d)),chatLog_service_1=require(_0x460739(0x1bf)),balance_constant_1=require(_0x460739(0x1aa)),utils_1=require('../../common/utils'),chatLog_entity_1=require(_0x460739(0x1d4)),typeorm_1=require(_0x460739(0x1ad)),typeorm_2=require(_0x460739(0x1e4)),balance_entity_1=require(_0x460739(0x20b)),fanyi_service_1=require(_0x460739(0x22b)),badwords_service_1=require(_0x460739(0x1ce));function _0x5db0(){const _0x3f1621=['../../common/constants/balance.constant','function','__esModule','typeorm','Repository','MjService','501032ltIAnw','/messages?limit=50','metadata','mjVersion','admin','url','mjDraw','pollForResult','存入图片完成:\x20','../globalConfig/globalConfig.service','fanyiService','ChatLogEntity','uploadFileFromUrl','saveChatLog','message_id','../chatLog/chatLog.service','mjChannelId','match','max','now','网络连接失败，请稍后再试！','getClientIp','enlarge','error','mjSessionId','DeductionKey','default','pollForUpscaleResult','__metadata','绘制图片任务结束\x20队列-1:\x20','../badwords/badwords.service','enlargeWorking','drawWorking','axios:\x20','放大图片任务结束\x20队列-1:\x20','HttpException','../chatLog/chatLog.entity','__param','orderId','includes','floor','本次比对的随机ID:\x20','sendSmInteractions','当前用户','checkAuth','秒请求一次、请合理使用！','super','GlobalConfigService','extractContent','mjAuthorization','变换当前图片超时！','uploadService','@nestjs/typeorm','rateLimits','defineProperty','badwordsService','checkRateLimit','988624RUxqgN','findCurrentVariationImgResult','历史这些id已经被获取过了\x20不能拿了:\x20','变化图片任务异常中断\x20队列-1:\x20','getConfigs','push','chatLogService','BalanceEntity','deductBalance','draw','find','set','变换图片任务结束\x20队列-1:\x20','https://discord.com/api/v9/interactions','error:\x20','放大当前图片失败','当前图片已经放大过了、请勿重复放大!','放大单张图片请求失败...','变换当前图片失败','prompt','历史记录中不存在当前图片、请确认您放大的图片是否存在','INTERNAL_SERVER_ERROR','execute','\x20次开始查询[变换图片]','22DTXHCL','绘画任务开始','getMjDefaultParams','BadwordsService','queueCount','ChatLogService','PAINT_TYPE','freeQueueUsers','mjservice','randomId:\x20','../userBalance/balance.entity','mjRateLimit','BAD_REQUEST','data','variationSingleImg','removeEmoji','../upload/upload.service','开始请求放大图片\x20队列+1:\x20','使用的次数：','mjApplicationId','当前用户\x20','mjGuildId','log','axios\x20get:\x20','InjectRepository','\x20请求过于频繁！','本次绘图耗时:\x20','decorate','filter','3419044OaUmDD','get','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','convertToEnglish','balanceEntity','\x20次开始查询\x20=>\x20当前查询结果：','拿到了远程地址:\x20','checkBadWords','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','https://discord.com/api/v9/channels/','where','imagine','开始请求变换图片\x20队列+1:\x20','../fanyi/fanyi.service','1674246IdeCNW','response','findOne','design:paramtypes','由于速率限制、当前普通用户限制为','createRandomUid','checkFree','57774Medoku','绘画超时，请稍后再试！','object','globalConfigService','message','length','replace','findCurrentPromptResult','http://172.247.48.137:8000/mj/list?channel_id=','HttpStatus','axios','查询期间出现错误：','Like','user','components','upscaleSingleImg','发送绘画指令结果:\x20','queryMessageList','stringify','post','chatLogEntity','当前图片没有绘画信息、无法变体!','pollForVariationResult','发送放大指令成功','IsNull','parse','map','mjProxy','__decorate','当前图片没有绘画信息、无法放大!','您当前暂无MJ绘画余额！！！','baiduFanyiSecret','baiduFanyiAppId','http://172.247.48.137:8000/mj/draw','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','mjNotSaveImg','test','791360ZyEZqQ','sendDrawInteractions','\x20队列+1:\x20','506835WuJQcI','variationId','UploadService','当前提示词已经在任务队列中了、请勿重复提交。。。','substring','sleep'];_0x5db0=function(){return _0x3f1621;};return _0x5db0();}let MjService=class MjService{constructor(_0x1c7e86,_0x35bdf4,_0x2364ff,_0x5b8e15,_0x176873,_0x330114,_0x43adef){const _0xcc053a=_0x460739;this['chatLogEntity']=_0x1c7e86,this[_0xcc053a(0x222)]=_0x35bdf4,this['uploadService']=_0x2364ff,this[_0xcc053a(0x1ef)]=_0x5b8e15,this[_0xcc053a(0x236)]=_0x176873,this['fanyiService']=_0x330114,this[_0xcc053a(0x1e7)]=_0x43adef,this[_0xcc053a(0x1e5)]={},this[_0xcc053a(0x1d0)]=[],this[_0xcc053a(0x1cf)]=[],this[_0xcc053a(0x205)]=0x0,this['freeQueueUsers']={};}async[_0x460739(0x1b6)](_0x186173){const _0x320e03=_0x460739,{jobId:_0x2c3260,prompt:_0x1713a2,startTime:_0x2dd4f0,userId:_0x379017}=_0x186173;return console[_0x320e03(0x217)](_0x320e03(0x202),_0x320e03(0x209)),await new Promise(_0x3ab093=>setTimeout(_0x3ab093,0x1388)),{'a':0x1,'b':0x2};}async[_0x460739(0x1f2)](_0x458fef,_0x2a088b){const _0x49a3d3=_0x460739;await this[_0x49a3d3(0x1dc)](_0x2a088b),await this[_0x49a3d3(0x1e7)][_0x49a3d3(0x225)](_0x458fef[_0x49a3d3(0x1fc)],_0x2a088b[_0x49a3d3(0x240)]['id']);const _0x27d34c=_0x458fef[_0x49a3d3(0x1fc)];let _0x81c342=_0x458fef[_0x49a3d3(0x1fc)];const {baiduFanyiAppId:_0xaef04,baiduFanyiSecret:_0x3fa5aa}=await this[_0x49a3d3(0x236)][_0x49a3d3(0x1ed)]([_0x49a3d3(0x253),_0x49a3d3(0x252)]);_0xaef04&&_0x3fa5aa&&(_0x81c342=await this[_0x49a3d3(0x1ba)][_0x49a3d3(0x221)](_0x27d34c));const _0x5122d8='['+(0x0,utils_1[_0x49a3d3(0x231)])()+']',_0x436bcf=_0x5122d8+'\x20'+_0x81c342;console['log'](_0x49a3d3(0x20a),_0x5122d8),console['log']('prompt\x20-------->\x20\x20',_0x436bcf);const _0x13027b=this[_0x49a3d3(0x1d0)]['find'](_0x18e251=>_0x18e251[_0x49a3d3(0x1d7)](_0x458fef[_0x49a3d3(0x1fc)]));if(_0x13027b)throw new common_1[(_0x49a3d3(0x1d3))](_0x49a3d3(0x1a7),common_1[_0x49a3d3(0x23c)][_0x49a3d3(0x20d)]);if(this[_0x49a3d3(0x205)]>=0x3)throw new common_1[(_0x49a3d3(0x1d3))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1['HttpStatus'][_0x49a3d3(0x20d)]);await this[_0x49a3d3(0x1e8)](_0x2a088b),this['queueCount']++,console[_0x49a3d3(0x217)]('开始请求用户'+_0x2a088b[_0x49a3d3(0x240)]['id']+_0x49a3d3(0x1a3),this[_0x49a3d3(0x205)]);try{const _0x35f40e=await this[_0x49a3d3(0x247)][_0x49a3d3(0x1f3)]({'where':{'prompt':(0x0,typeorm_1[_0x49a3d3(0x23f)])('%'+_0x436bcf+'%')}}),_0x30d1ec=_0x35f40e['map'](_0x414656=>_0x414656[_0x49a3d3(0x1be)]);this[_0x49a3d3(0x1d0)][_0x49a3d3(0x1ee)](_0x436bcf);let _0x451f8c;const _0x163f7f=await this['sendDrawInteractions'](_0x436bcf,_0x30d1ec,_0x5122d8);_0x163f7f?(console[_0x49a3d3(0x217)]('历史中存在当前图片、直接获取！'),_0x451f8c=_0x163f7f):_0x451f8c=await this[_0x49a3d3(0x1b7)](_0x436bcf,_0x30d1ec,_0x5122d8);this[_0x49a3d3(0x205)]--,this[_0x49a3d3(0x205)]<0x0&&(this[_0x49a3d3(0x205)]=0x0),console['log'](_0x49a3d3(0x1cd),this[_0x49a3d3(0x205)]);const {id:_0x3bf91f,content:_0x414639,channel_id:_0x156d38,attachments:attachments=[],timestamp:_0x5fae85}=_0x451f8c;if(!attachments[_0x49a3d3(0x238)]||!attachments[0x0][_0x49a3d3(0x1b5)])throw new common_1[(_0x49a3d3(0x1d3))]('绘画失败',common_1[_0x49a3d3(0x23c)]['BAD_REQUEST']);const {filename:_0x147436,url:_0x3d63e0,width:_0x3a937c,height:_0x45e802,size:_0x51279f}=attachments[0x0];console[_0x49a3d3(0x217)](_0x49a3d3(0x224),_0x3d63e0);const _0x527a8c=this['globalConfigService'][_0x49a3d3(0x1ed)]([_0x49a3d3(0x256)]);let _0x59b067='';(!Number(_0x527a8c)||Number(_0x527a8c)===0x0)&&(_0x59b067=await this[_0x49a3d3(0x1e3)][_0x49a3d3(0x1bc)]({'filename':_0x147436,'url':_0x3d63e0}),console[_0x49a3d3(0x217)]('存入图片完成:\x20',_0x59b067));const _0x1c2f98={'curIp':(0x0,utils_1['getClientIp'])(_0x2a088b),'userId':_0x2a088b[_0x49a3d3(0x240)]['id'],'type':balance_constant_1[_0x49a3d3(0x1c9)][_0x49a3d3(0x207)],'prompt':_0x436bcf,'answer':_0x59b067,'model':'mj','extend':this[_0x49a3d3(0x210)](JSON[_0x49a3d3(0x245)](_0x451f8c)),'message_id':_0x3bf91f,'variationId':_0x3bf91f,'upscaleId':_0x3bf91f,'group':0x1,'isSaveImg':!Number(_0x527a8c)||Number(_0x527a8c)===0x0,'fileInfo':JSON[_0x49a3d3(0x245)]({'width':_0x3a937c,'height':_0x45e802,'size':_0x51279f,'filename':_0x147436,'cosUrl':_0x59b067})};return await this[_0x49a3d3(0x1ef)][_0x49a3d3(0x1bd)](_0x1c2f98),await this[_0x49a3d3(0x1f1)](_0x2a088b),this[_0x49a3d3(0x1d0)]=this['drawWorking'][_0x49a3d3(0x21d)](_0x3c5bbf=>_0x3c5bbf!==_0x458fef[_0x49a3d3(0x1fc)]),_0x59b067;}catch(_0x372833){this[_0x49a3d3(0x205)]--,this[_0x49a3d3(0x205)]<0x0&&(this[_0x49a3d3(0x205)]=0x0),console[_0x49a3d3(0x217)]('绘制图片任务异常中断\x20队列-1:\x20',this['queueCount']),this[_0x49a3d3(0x1d0)]=this[_0x49a3d3(0x1d0)][_0x49a3d3(0x21d)](_0x29f693=>_0x29f693!==_0x458fef[_0x49a3d3(0x1fc)]);throw new common_1[(_0x49a3d3(0x1d3))](_0x372833['response'],common_1[_0x49a3d3(0x23c)][_0x49a3d3(0x20d)]);}}async[_0x460739(0x242)](_0x42cc08,_0x40ef2e){const _0x554fd1=_0x460739;if(this[_0x554fd1(0x205)]>=0x3)throw new common_1[(_0x554fd1(0x1d3))](_0x554fd1(0x255),common_1['HttpStatus'][_0x554fd1(0x20d)]);this[_0x554fd1(0x205)]++,console[_0x554fd1(0x217)]('用户'+_0x40ef2e['user']['id']+_0x554fd1(0x212),this['queueCount']);const {message_id:_0x262f41,orderId:_0x858543}=_0x42cc08;try{const _0x2597ac=await this[_0x554fd1(0x247)]['findOne']({'where':{'message_id':_0x262f41}});if(!_0x2597ac)throw new common_1['HttpException'](_0x554fd1(0x1fd),common_1[_0x554fd1(0x23c)]['BAD_REQUEST']);const _0x6796c7=await this['chatLogEntity'][_0x554fd1(0x22e)]({'where':{'upscaleId':_0x262f41,'action':_0x554fd1(0x1c6),'orderId':_0x858543}});if(_0x6796c7)throw new common_1['HttpException'](_0x554fd1(0x1f9),common_1[_0x554fd1(0x23c)][_0x554fd1(0x20d)]);const {prompt:_0x554d53,extend:_0x5c2e8b}=_0x2597ac;let _0x1d938f=null;try{_0x1d938f=JSON['parse'](_0x5c2e8b);}catch(_0x1a32af){_0x1d938f=[];}const {components:components=[]}=_0x1d938f;if(!components['length'])throw new common_1[(_0x554fd1(0x1d3))](_0x554fd1(0x250),common_1['HttpStatus'][_0x554fd1(0x20d)]);const _0x2e3aaa=components[0x0]['components'][_0x858543-0x1],{custom_id:_0x432ed6}=_0x2e3aaa;console[_0x554fd1(0x217)]('放大custom_id:\x20',_0x432ed6);const _0x2376b4={'message_id':_0x262f41,'custom_id':_0x432ed6,'prompt':_0x554d53,'orderId':_0x858543};await this[_0x554fd1(0x1da)](_0x2376b4),console[_0x554fd1(0x217)](_0x554fd1(0x24a));const _0x3f6983=await this[_0x554fd1(0x247)][_0x554fd1(0x1f3)]({'where':{'prompt':(0x0,typeorm_1[_0x554fd1(0x23f)])('%'+_0x554d53+'%')}}),_0xbdbd34=_0x3f6983[_0x554fd1(0x24d)](_0x427d81=>_0x427d81[_0x554fd1(0x1be)]);console[_0x554fd1(0x217)](_0x554fd1(0x1eb),_0xbdbd34);const _0x58f8e6=await this[_0x554fd1(0x1cb)](_0x2376b4,_0xbdbd34);this[_0x554fd1(0x205)]--,this[_0x554fd1(0x205)]<0x0&&(this['queueCount']=0x0),console[_0x554fd1(0x217)](_0x554fd1(0x1d2),this[_0x554fd1(0x205)]);const {id:_0x29de7e,content:_0x528e1d,channel_id:_0x43383b,attachments:attachments=[],timestamp:_0x56c122}=_0x58f8e6;if(!attachments[_0x554fd1(0x238)]||!attachments[0x0][_0x554fd1(0x1b5)])throw new common_1[(_0x554fd1(0x1d3))](_0x554fd1(0x1f8),common_1[_0x554fd1(0x23c)][_0x554fd1(0x20d)]);const {filename:_0xbe7e7b,url:_0x51063f,width:_0x51c45d,height:_0xc0b29d,size:_0x576e70}=attachments[0x0],_0x54cc65=this['globalConfigService'][_0x554fd1(0x1ed)](['mjNotSaveImg']);let _0x3aa08c='';(!Number(_0x54cc65)||Number(_0x54cc65)===0x0)&&(_0x3aa08c=await this[_0x554fd1(0x1e3)][_0x554fd1(0x1bc)]({'filename':_0xbe7e7b,'url':_0x51063f}),console[_0x554fd1(0x217)](_0x554fd1(0x1b8),_0x3aa08c));const _0x27c8d3={'curIp':(0x0,utils_1['getClientIp'])(_0x40ef2e),'userId':_0x40ef2e[_0x554fd1(0x240)]['id'],'type':balance_constant_1['DeductionKey'][_0x554fd1(0x207)],'prompt':_0x554d53,'answer':_0x3aa08c,'model':'mj','extend':this['removeEmoji'](JSON[_0x554fd1(0x245)](_0x58f8e6)),'message_id':_0x262f41,'upscaleId':_0x29de7e,'variationId':_0x29de7e,'action':_0x554fd1(0x1c6),'orderId':_0x2376b4[_0x554fd1(0x1d6)],'isSaveImg':!Number(_0x54cc65)||Number(_0x54cc65)===0x0,'fileInfo':JSON['stringify']({'width':_0x51c45d,'height':_0xc0b29d,'size':_0x576e70,'filename':_0xbe7e7b,'cosUrl':_0x3aa08c})};return await this[_0x554fd1(0x1ef)][_0x554fd1(0x1bd)](_0x27c8d3),_0x3aa08c;}catch(_0x39b0c6){console[_0x554fd1(0x217)]('error:\x20',_0x39b0c6),this[_0x554fd1(0x205)]--,this[_0x554fd1(0x205)]<0x0&&(this['queueCount']=0x0),console['log']('放大图片任务异常中断\x20队列-1:\x20',this[_0x554fd1(0x205)]);throw new common_1[(_0x554fd1(0x1d3))](_0x39b0c6[_0x554fd1(0x22d)],common_1['HttpStatus'][_0x554fd1(0x20d)]);}}async[_0x460739(0x20f)](_0x326077,_0x56bbdc){const _0x36abe7=_0x460739;if(this[_0x36abe7(0x205)]>=0x3)throw new common_1[(_0x36abe7(0x1d3))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x36abe7(0x23c)][_0x36abe7(0x20d)]);await this['checkAuth'](_0x56bbdc),await this[_0x36abe7(0x1e8)](_0x56bbdc),this['queueCount']++,console[_0x36abe7(0x217)]('用户'+_0x56bbdc[_0x36abe7(0x240)]['id']+_0x36abe7(0x22a),this[_0x36abe7(0x205)]);const {message_id:_0x1eaf2d,orderId:_0x150a6d}=_0x326077;try{const _0x55112e=await this[_0x36abe7(0x247)][_0x36abe7(0x22e)]({'where':{'message_id':_0x1eaf2d}});if(!_0x55112e)throw new common_1[(_0x36abe7(0x1d3))](_0x36abe7(0x220),common_1[_0x36abe7(0x23c)]['BAD_REQUEST']);const {prompt:_0x317914,extend:_0x467f40}=_0x55112e;let _0x559d1f=null;try{_0x559d1f=JSON[_0x36abe7(0x24c)](_0x467f40);}catch(_0x28df87){_0x559d1f=[];}const {components:components=[]}=_0x559d1f;if(!components['length'])throw new common_1['HttpException'](_0x36abe7(0x248),common_1[_0x36abe7(0x23c)][_0x36abe7(0x20d)]);const _0x22c806=components[0x1][_0x36abe7(0x241)][_0x150a6d-0x1],{custom_id:_0x43fd51}=_0x22c806,_0x11b78e=await this[_0x36abe7(0x247)]['find']({'where':{'variationId':(0x0,typeorm_1['Not'])((0x0,typeorm_1[_0x36abe7(0x24b)])()),'prompt':(0x0,typeorm_1[_0x36abe7(0x23f)])('%'+_0x317914+'%')}}),_0x3c18d8=_0x11b78e[_0x36abe7(0x24d)](_0x33391d=>_0x33391d[_0x36abe7(0x1a5)]),_0x44bc6a={'message_id':_0x1eaf2d,'custom_id':_0x43fd51,'prompt':_0x317914,'orderId':_0x150a6d};await this[_0x36abe7(0x1da)](_0x44bc6a);const _0x4ffcf8=await this[_0x36abe7(0x249)](_0x44bc6a,_0x3c18d8);this[_0x36abe7(0x205)]--,this[_0x36abe7(0x205)]<0x0&&(this[_0x36abe7(0x205)]=0x0),console[_0x36abe7(0x217)](_0x36abe7(0x1f5),this[_0x36abe7(0x205)]);const {id:_0x1a787e,content:_0x1b3a95,channel_id:_0x506cbc,attachments:attachments=[],timestamp:_0x548170}=_0x4ffcf8;if(!attachments['length']||!attachments[0x0]['url'])throw new common_1['HttpException'](_0x36abe7(0x1fb),common_1[_0x36abe7(0x23c)][_0x36abe7(0x20d)]);const {filename:_0x44f862,url:_0x47985e,width:_0x5aba9b,height:_0x2bf7af,size:_0x56878d}=attachments[0x0],_0x45ff8a=this[_0x36abe7(0x236)][_0x36abe7(0x1ed)]([_0x36abe7(0x256)]);let _0x399b1e='';(!Number(_0x45ff8a)||Number(_0x45ff8a)===0x0)&&(_0x399b1e=await this[_0x36abe7(0x1e3)][_0x36abe7(0x1bc)]({'filename':_0x44f862,'url':_0x47985e}),console['log']('存入图片完成:\x20',_0x399b1e));const _0xef126f={'curIp':(0x0,utils_1[_0x36abe7(0x1c5)])(_0x56bbdc),'userId':_0x56bbdc[_0x36abe7(0x240)]['id'],'type':balance_constant_1['DeductionKey'][_0x36abe7(0x207)],'prompt':_0x317914,'answer':_0x399b1e,'model':'mj','group':0x1,'extend':this[_0x36abe7(0x210)](JSON[_0x36abe7(0x245)](_0x4ffcf8)),'message_id':_0x1a787e,'upscaleId':_0x1a787e,'variationId':_0x1a787e,'action':_0x36abe7(0x1c6),'orderId':_0x44bc6a[_0x36abe7(0x1d6)],'isSaveImg':!Number(_0x45ff8a)||Number(_0x45ff8a)===0x0,'fileInfo':JSON['stringify']({'width':_0x5aba9b,'height':_0x2bf7af,'size':_0x56878d,'filename':_0x44f862,'cosUrl':_0x399b1e})};return await this[_0x36abe7(0x1ef)][_0x36abe7(0x1bd)](_0xef126f),_0x399b1e;}catch(_0x3aca64){console[_0x36abe7(0x217)]('error:\x20',_0x3aca64),this[_0x36abe7(0x205)]--,this['queueCount']<0x0&&(this[_0x36abe7(0x205)]=0x0),console[_0x36abe7(0x217)](_0x36abe7(0x1ec),this[_0x36abe7(0x205)]);throw new common_1['HttpException'](_0x3aca64[_0x36abe7(0x22d)],common_1[_0x36abe7(0x23c)]['BAD_REQUEST']);}}async[_0x460739(0x1da)](_0x2e96ed){const _0x8184c3=_0x460739,{message_id:_0x4aecbf,custom_id:_0x533e6f}=_0x2e96ed,{application_id:_0x34ce08,guild_id:_0xffbd24,channel_id:_0x5b44ae,session_id:_0x285918,version:_0x363e3e,id:_0x4844cf,authorization:_0x2c7339,mjProxy:_0xe6976c}=await this['getMjDefaultParams'](),_0x1ab566=_0xe6976c==0x1?'http://172.247.48.137:8000/mj/draw':_0x8184c3(0x1f6),_0x4bf619={'authorization':_0x2c7339},_0x354464={'type':0x3,'guild_id':_0xffbd24,'channel_id':_0x5b44ae,'message_flags':0x0,'message_id':_0x4aecbf,'application_id':_0x34ce08,'session_id':_0x285918,'data':{'component_type':0x2,'custom_id':_0x533e6f}};try{await axios_1[_0x8184c3(0x1ca)]['post'](_0x1ab566,_0x354464,{'headers':_0x4bf619}),console[_0x8184c3(0x217)]('绘图指令完成');}catch(_0x40dcc7){console['log'](_0x8184c3(0x1f7),_0x40dcc7);throw new common_1[(_0x8184c3(0x1d3))](_0x8184c3(0x1fa),common_1[_0x8184c3(0x23c)][_0x8184c3(0x20d)]);}}async['pollForUpscaleResult'](_0x2fd8e6,_0xfe1dc4){const _0x3d7472=_0x460739,{message_id:_0x3d4d4e,custom_id:_0x53b8ad,prompt:_0x4520d5,orderId:_0x29b640}=_0x2fd8e6;let _0x19e57a=null,_0x2c28f8=0x0;while(!_0x19e57a&&_0x2c28f8<0xa){try{const _0x53223d=Date[_0x3d7472(0x1c3)](),_0x1525f5=await this[_0x3d7472(0x244)]();console[_0x3d7472(0x217)]('第\x20'+(_0x2c28f8+0x1)+_0x3d7472(0x223)+_0x1525f5[_0x3d7472(0x238)]);_0x1525f5&&_0x1525f5['length']&&(_0x19e57a=await this['findCurrentEnlargeImgResult'](_0x1525f5,_0x2fd8e6,_0xfe1dc4));const _0x381fdf=Date['now']()-_0x53223d,_0x1d4fd2=0xbb8;await this[_0x3d7472(0x1a9)](Math[_0x3d7472(0x1c2)](_0x1d4fd2-_0x381fdf,0x0)),_0x2c28f8++;}catch(_0x511104){console[_0x3d7472(0x1c7)](_0x3d7472(0x23e)+_0x511104[_0x3d7472(0x237)]);}}return _0x19e57a;}async[_0x460739(0x249)](_0x46b7a3,_0x3937b6){const _0x396043=_0x460739,{message_id:_0x363bc4,custom_id:_0x3d8a67,prompt:_0x54bddf,orderId:_0x131c42}=_0x46b7a3;console[_0x396043(0x217)]('开始轮询单张变换图片结果');let _0x10346a=null,_0xe6e390=0x0;while(!_0x10346a&&_0xe6e390<0xa){try{console[_0x396043(0x217)]('第\x20'+(_0xe6e390+0x1)+_0x396043(0x200));const _0x410f47=Date[_0x396043(0x1c3)](),_0x1cb4f8=await this[_0x396043(0x244)]();_0x1cb4f8&&_0x1cb4f8[_0x396043(0x238)]&&(_0x10346a=await this[_0x396043(0x1ea)](_0x1cb4f8,_0x46b7a3,_0x3937b6));const _0x5816d1=Date[_0x396043(0x1c3)]()-_0x410f47,_0x22af3a=0x1f40;await this[_0x396043(0x1a9)](Math[_0x396043(0x1c2)](_0x22af3a-_0x5816d1,0x0)),_0xe6e390++;}catch(_0x476079){console[_0x396043(0x1c7)](_0x396043(0x23e)+_0x476079[_0x396043(0x237)]);}}if(!_0x10346a)throw new common_1[(_0x396043(0x1d3))](_0x396043(0x1e2),common_1[_0x396043(0x23c)][_0x396043(0x20d)]);return _0x10346a;}async['findCurrentEnlargeImgResult'](_0x2ba97e,_0x3bed9d,_0x221ea6){const _0x1db364=_0x460739,{message_id:_0x5027d6,custom_id:_0xe24f46,prompt:_0x26d012,orderId:_0x18a32d}=_0x3bed9d,_0x180269=_0x26d012[_0x1db364(0x1a8)](0x0,0xc);console[_0x1db364(0x217)]('本次放大图片的id:\x20',_0x180269);const _0x5e64b4=_0x2ba97e['find'](_0x53d75f=>{const _0x5261c7=_0x1db364,{content:_0x2ac2de}=_0x53d75f;if(!this[_0x5261c7(0x1e0)](_0x2ac2de))return![];const {prompt:_0x87ed4f,order:_0x3f1d4d}=this[_0x5261c7(0x1e0)](_0x2ac2de);return _0x87ed4f[_0x5261c7(0x1d7)](_0x180269)&&_0x3bed9d[_0x5261c7(0x1d6)]===_0x3f1d4d&&!_0x221ea6['includes'](_0x53d75f['id']);});return _0x5e64b4;}async[_0x460739(0x1ea)](_0x4aa75d,_0x18a3d2,_0x31fd47){const _0x135e39=_0x460739,{message_id:_0x588018,custom_id:_0x16cb56,prompt:_0x36b215,orderId:_0x12dc70}=_0x18a3d2,_0x15a2c9=_0x36b215[_0x135e39(0x1a8)](0x0,0xc),_0x4434f0=_0x4aa75d[_0x135e39(0x1f3)](_0x127057=>{const _0x5d3925=_0x135e39,{content:_0x34dbaf}=_0x127057,_0x423eee=_0x34dbaf[_0x5d3925(0x1c1)](/\*\*(.+?)\*\*/),_0x44a9d2=_0x423eee?_0x423eee[0x1]:'';if(!_0x44a9d2)return![];return _0x44a9d2[_0x5d3925(0x1d7)](_0x15a2c9)&&!_0x31fd47[_0x5d3925(0x1d7)](_0x127057['id']);});return _0x4434f0;}async[_0x460739(0x1a2)](_0x485817,_0x59777d,_0x5d7cbd){const _0x4ecbf0=_0x460739,_0x5b6d73=await this[_0x4ecbf0(0x244)](),_0x52b022=await this[_0x4ecbf0(0x23a)](_0x5b6d73,_0x5d7cbd,_0x59777d);if(_0x52b022)return console[_0x4ecbf0(0x217)]('有历史信息之间返回:\x20',_0x52b022),_0x52b022;const {application_id:_0x33a09a,guild_id:_0x52931f,channel_id:_0x2e30de,session_id:_0xad37ad,version:_0x440bab,id:_0x3ca625,authorization:_0x237fb2,mjProxy:_0x1df563}=await this[_0x4ecbf0(0x203)](),_0x4c4501={'type':0x2,'application_id':_0x33a09a,'guild_id':_0x52931f,'channel_id':_0x2e30de,'session_id':_0xad37ad,'data':{'version':_0x440bab,'id':_0x3ca625,'name':_0x4ecbf0(0x229),'type':0x1,'options':[{'type':0x3,'name':_0x4ecbf0(0x1fc),'value':_0x485817}],'attachments':[]}};try{const _0x453a5f=_0x1df563==0x1?_0x4ecbf0(0x254):_0x4ecbf0(0x1f6),_0x2db7ba={'authorization':_0x237fb2},_0x54d6ac=await axios_1[_0x4ecbf0(0x1ca)][_0x4ecbf0(0x246)](_0x453a5f,_0x4c4501,{'headers':_0x2db7ba});return console[_0x4ecbf0(0x217)](_0x4ecbf0(0x243),_0x54d6ac[_0x4ecbf0(0x20e)]),![];}catch(_0x2d7eda){console[_0x4ecbf0(0x217)](_0x4ecbf0(0x1d1),_0x2d7eda);throw new common_1[(_0x4ecbf0(0x1d3))](_0x4ecbf0(0x226),common_1[_0x4ecbf0(0x23c)][_0x4ecbf0(0x20d)]);}}async['pollForResult'](_0x5c9069,_0xfa290d,_0x17e080){const _0x36bea3=_0x460739;console[_0x36bea3(0x217)]('开始查询绘画结果轮询');const _0x5c1d38=Date[_0x36bea3(0x1c3)]();try{const _0x2ac020=0xd,_0x47ea12=0x2ee0,_0x386ae1=0x1388,_0x86a2bf=0x3c*0x3e8;let _0x1eb8ae=0x0,_0x4d647e=![],_0x539717=null;while(!_0x539717&&_0x1eb8ae<_0x2ac020){console[_0x36bea3(0x217)]('第\x20'+(_0x1eb8ae+0x1)+'\x20次开始查询');Date[_0x36bea3(0x1c3)]()-_0x5c1d38>=_0x86a2bf&&(_0x4d647e=!![]);await this['sleep'](_0x4d647e?_0x386ae1:_0x47ea12);const _0x1e49f2=await this[_0x36bea3(0x244)]();_0x539717=await this[_0x36bea3(0x23a)](_0x1e49f2,_0x17e080,_0xfa290d),_0x1eb8ae++;}if(!_0x539717)throw new common_1[(_0x36bea3(0x1d3))](_0x36bea3(0x234),common_1[_0x36bea3(0x23c)][_0x36bea3(0x20d)]);const _0x59b3ae=Date['now']();return console[_0x36bea3(0x217)](_0x36bea3(0x21b)+Math[_0x36bea3(0x1d8)]((_0x59b3ae-_0x5c1d38)/0x3e8)+'\x20S'),_0x539717;}catch(_0x21ac51){console[_0x36bea3(0x1c7)](_0x21ac51[_0x36bea3(0x237)]);throw new common_1[(_0x36bea3(0x1d3))](_0x36bea3(0x1c4),common_1[_0x36bea3(0x23c)][_0x36bea3(0x1fe)]);}}async['findCurrentPromptResult'](_0x3f3cbb,_0x52b2b3,_0x13e2c1){const _0xa75e84=_0x460739;if(!_0x3f3cbb||!_0x3f3cbb[_0xa75e84(0x238)])return;console[_0xa75e84(0x217)](_0xa75e84(0x1d9),_0x52b2b3);const _0x3f1b3e=_0x3f3cbb[_0xa75e84(0x1f3)](_0x141282=>{const _0x5cbd4c=_0xa75e84,{attachments:attachments=[],content:_0x565e01,edited_timestamp:_0x3ac6c0}=_0x141282;return _0x565e01[_0x5cbd4c(0x1d7)](_0x52b2b3)&&attachments[_0x5cbd4c(0x238)]>0x0&&!_0x3ac6c0&&!_0x13e2c1[_0x5cbd4c(0x1d7)](_0x141282['id']);});return _0x3f1b3e||null;}async[_0x460739(0x244)](){const _0x5ccd87=_0x460739;try{const {application_id:_0x4f7c3c,guild_id:_0x50500c,channel_id:_0xeee068,session_id:_0x4c0936,version:_0xa0deee,id:_0x3d0c23,authorization:_0x305b99,mjProxy:_0x436373}=await this['getMjDefaultParams'](),_0x21dc8c=_0x436373==0x1?_0x5ccd87(0x23b)+_0xeee068:_0x5ccd87(0x227)+_0xeee068+_0x5ccd87(0x1b1),_0x4f1cdf={'authorization':_0x305b99},_0x46d5ba=await axios_1['default'][_0x5ccd87(0x21f)](_0x21dc8c,{'headers':_0x4f1cdf});return _0x46d5ba['data'];}catch(_0xaef3ce){console[_0x5ccd87(0x217)](_0x5ccd87(0x218),_0xaef3ce);throw new common_1[(_0x5ccd87(0x1d3))]('查询绘制结果失败...',common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x460739(0x1a9)](_0x2f7038){return new Promise(_0x189305=>setTimeout(_0x189305,_0x2f7038));}['extractContent'](_0xa492e6){const _0x2d3103=_0x460739,_0x451611=_0xa492e6[_0x2d3103(0x1c1)](/\*\*(.+?)\*\*/),_0x25ea64=_0xa492e6[_0x2d3103(0x1c1)](/- Image #(\d+)/);if(!_0x451611||!_0x25ea64)return null;const _0x29bc58=_0x451611[0x1],_0x5b1816=parseInt(_0x25ea64[0x1]);return{'prompt':_0x29bc58,'order':_0x5b1816};}async[_0x460739(0x203)](){const _0x340b62=_0x460739,_0xcb129a=await this[_0x340b62(0x236)][_0x340b62(0x1ed)](['mjId',_0x340b62(0x214),_0x340b62(0x216),_0x340b62(0x1c0),_0x340b62(0x1c8),_0x340b62(0x1b3),_0x340b62(0x1e1),_0x340b62(0x20c),_0x340b62(0x24e)]),_0x4a8753={'application_id':_0xcb129a[_0x340b62(0x214)],'guild_id':_0xcb129a['mjGuildId'],'channel_id':_0xcb129a['mjChannelId'],'session_id':_0xcb129a[_0x340b62(0x1c8)],'version':_0xcb129a[_0x340b62(0x1b3)],'id':_0xcb129a['mjId'],'authorization':_0xcb129a[_0x340b62(0x1e1)],'mjRateLimit':_0xcb129a['mjRateLimit'],'mjProxy':_0xcb129a[_0x340b62(0x24e)]||0x0};return _0x4a8753;}[_0x460739(0x210)](_0x7ee50d){const _0x32f491=_0x460739,_0x261217=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x7ee50d[_0x32f491(0x239)](_0x261217,'');}async[_0x460739(0x1dc)](_0x5885e1){const _0x499f85=_0x460739,_0x548e8d=await this[_0x499f85(0x222)]['findOne']({'where':{'userId':_0x5885e1['user']['id']}}),{id:_0x4b4acc,balance:_0x545a1e}=_0x548e8d;if(!_0x545a1e||(_0x548e8d===null||_0x548e8d===void 0x0?void 0x0:_0x548e8d['balance'])<0x1)throw new common_1[(_0x499f85(0x1d3))](_0x499f85(0x251),common_1[_0x499f85(0x23c)][_0x499f85(0x20d)]);}async[_0x460739(0x232)](_0x4fa6c9){const _0x340abc=_0x460739,{id:_0x4f42fb,role:_0x4dad59}=_0x4fa6c9['user'];!this[_0x340abc(0x208)][_0x4f42fb]?this[_0x340abc(0x208)][_0x4f42fb]=0x1:this[_0x340abc(0x208)][_0x4f42fb]=this[_0x340abc(0x208)][_0x4f42fb]+0x1,console[_0x340abc(0x217)](_0x340abc(0x1db)+_0x4f42fb+_0x340abc(0x213),this[_0x340abc(0x208)][_0x4f42fb]);}async[_0x460739(0x1e8)](_0x4b2712){const _0x3fa657=_0x460739,{id:_0x3dc379,role:_0x48e80e}=_0x4b2712[_0x3fa657(0x240)];if([_0x3fa657(0x1b4),_0x3fa657(0x1de)]['includes'](_0x48e80e))return!![];const {mjRateLimit:_0x394b56}=await this[_0x3fa657(0x203)]();if(this[_0x3fa657(0x1e5)][_0x3dc379]){const _0x41fb3b=this[_0x3fa657(0x1e5)][_0x3dc379];if(_0x41fb3b>Date[_0x3fa657(0x1c3)]()){console['log'](_0x3fa657(0x215)+_0x3dc379+_0x3fa657(0x21a));throw new common_1[(_0x3fa657(0x1d3))](_0x3fa657(0x230)+_0x394b56+_0x3fa657(0x1dd),common_1['HttpStatus'][_0x3fa657(0x20d)]);}else this[_0x3fa657(0x1e5)][_0x3dc379]=Date[_0x3fa657(0x1c3)]()+Number(_0x394b56)*0x3e8;}else{const _0x15a55d=Date['now']();this[_0x3fa657(0x1e5)][_0x3dc379]=_0x15a55d+0x3e8*Number(_0x394b56);}}async[_0x460739(0x1f1)](_0x5ae06c){const _0x1a141c=_0x460739;await this['balanceEntity']['createQueryBuilder']()['update'](balance_entity_1[_0x1a141c(0x1f0)])[_0x1a141c(0x1f4)]({'balance':()=>'balance\x20-\x201'})[_0x1a141c(0x228)]('userId\x20=\x20:userId',{'userId':_0x5ae06c[_0x1a141c(0x240)]['id']})[_0x1a141c(0x1ff)]();}async[_0x460739(0x257)](){return 0x1;}};MjService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(chatLog_entity_1[_0x460739(0x1bb)])),__param(0x1,(0x0,typeorm_2[_0x460739(0x219)])(balance_entity_1[_0x460739(0x1f0)])),__metadata(_0x460739(0x22f),[typeorm_1[_0x460739(0x1ae)],typeorm_1[_0x460739(0x1ae)],upload_service_1[_0x460739(0x1a6)],chatLog_service_1[_0x460739(0x206)],globalConfig_service_1[_0x460739(0x1df)],fanyi_service_1['FanyiService'],badwords_service_1[_0x460739(0x204)]])],MjService),exports[_0x460739(0x1af)]=MjService;