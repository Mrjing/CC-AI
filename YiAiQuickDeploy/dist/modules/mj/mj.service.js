'use strict';const _0x4fdebf=_0x47e5;(function(_0x18f5e4,_0x52fc82){const _0xfb54f9=_0x47e5,_0x3d3bf8=_0x18f5e4();while(!![]){try{const _0x2c0991=-parseInt(_0xfb54f9(0xfc))/0x1*(-parseInt(_0xfb54f9(0x13d))/0x2)+-parseInt(_0xfb54f9(0xde))/0x3+parseInt(_0xfb54f9(0xb4))/0x4+-parseInt(_0xfb54f9(0x118))/0x5+-parseInt(_0xfb54f9(0xb3))/0x6+parseInt(_0xfb54f9(0xef))/0x7+-parseInt(_0xfb54f9(0x120))/0x8*(parseInt(_0xfb54f9(0xed))/0x9);if(_0x2c0991===_0x52fc82)break;else _0x3d3bf8['push'](_0x3d3bf8['shift']());}catch(_0x486afd){_0x3d3bf8['push'](_0x3d3bf8['shift']());}}}(_0x4bdb,0x326c3));function _0x4bdb(){const _0x450c11=['mjRateLimit','本次放大图片的id:\x20','includes','../globalConfig/globalConfig.service','DeductionKey','拿到了远程地址:\x20','2yIzeWm','当前提示词已经在任务队列中了、请勿重复提交。。。','filter','data','MjService','chatLogEntity','execute','createQueryBuilder','floor','badwordsService','变换当前图片失败','绘制图片任务结束\x20队列-1:\x20','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','log','\x20队列+1:\x20','../chatLog/chatLog.entity','axios','绘制图片任务异常中断\x20队列-1:\x20','pollForVariationResult','getClientIp','substring','createRandomUid','秒请求一次、请合理使用！','stringify','now','由于速率限制、当前普通用户限制为','历史这些id已经被获取过了\x20不能拿了:\x20','mjApplicationId','@nestjs/typeorm','fanyiService','变换当前图片超时！','metadata','typeorm','default','Injectable','../upload/upload.service','where','查询期间出现错误：','message_id','saveChatLog','HttpStatus','放大图片任务异常中断\x20队列-1:\x20','GlobalConfigService','findCurrentEnlargeImgResult','user','checkAuth','47154yYDeHW','1178624DNccVY','baiduFanyiAppId','checkRateLimit','sendSmInteractions','prompt','queryMessageList','变化图片任务异常中断\x20队列-1:\x20','../fanyi/fanyi.service','@nestjs/common','sleep','getMjDefaultParams','set','开始请求放大图片\x20队列+1:\x20','variationId','checkBadWords','deductBalance','开始请求用户','http://172.247.48.137:8000/mj/draw','ChatLogService','mjId','axios:\x20','mjservice','design:paramtypes','error:\x20','您当前暂无MJ绘画余额！！！','drawWorking','error','url','当前用户\x20','super','upscaleSingleImg','globalConfigService','balance\x20-\x201','prompt\x20-------->\x20\x20','绘画失败','放大custom_id:\x20','mjChannelId','userId\x20=\x20:userId','baiduFanyiSecret','response','balanceEntity','IsNull','494571DUydSx','enlarge','getConfigs','findCurrentVariationImgResult','HttpException','extractContent','发送放大指令成功','InjectRepository','mjNotSaveImg','chatLogService','https://discord.com/api/v9/channels/','orderId','开始查询绘画结果轮询','开始轮询单张变换图片结果','__metadata','30042pexbBN','历史中存在当前图片、直接获取！','731297qYfZgL','mjSessionId','放大当前图片失败','mjAuthorization','Like','variationSingleImg','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','PAINT_TYPE','rateLimits','balance','message','components','mjVersion','409642PpBjBq','length','pollForUpscaleResult','ChatLogEntity','freeQueueUsers','findCurrentPromptResult','当前图片已经放大过了、请勿重复放大!','imagine','Repository','\x20次开始查询[变换图片]','function','https://discord.com/api/v9/interactions','axios\x20get:\x20','发送绘画指令结果:\x20','放大单张图片请求失败...','getOwnPropertyDescriptor','mjDraw','max','../chatLog/chatLog.service','map','findOne','update','绘画任务开始','queueCount','decorate','../badwords/badwords.service','查询绘制结果失败...','mjProxy','128120RsGQof','__esModule','removeEmoji','\x20次开始查询','BadwordsService','uploadService','__decorate','使用的次数：','968YPADvQ','push','admin','当前图片没有绘画信息、无法变体!','parse','object','enlargeWorking','http://172.247.48.137:8000/mj/list?channel_id=','match','find','post','mjGuildId','uploadFileFromUrl','__param','BAD_REQUEST','放大图片任务结束\x20队列-1:\x20','pollForResult','\x20次开始查询\x20=>\x20当前查询结果：','FanyiService','存入图片完成:\x20','draw','Not','变换图片任务结束\x20队列-1:\x20'];_0x4bdb=function(){return _0x450c11;};return _0x4bdb();}var __decorate=this&&this[_0x4fdebf(0x11e)]||function(_0x13249e,_0x1a3ea6,_0x548ca1,_0x57a486){const _0x415c74=_0x4fdebf;var _0x3a783f=arguments[_0x415c74(0xfd)],_0x519bef=_0x3a783f<0x3?_0x1a3ea6:_0x57a486===null?_0x57a486=Object[_0x415c74(0x10b)](_0x1a3ea6,_0x548ca1):_0x57a486,_0x3b7215;if(typeof Reflect==='object'&&typeof Reflect[_0x415c74(0x114)]===_0x415c74(0x106))_0x519bef=Reflect['decorate'](_0x13249e,_0x1a3ea6,_0x548ca1,_0x57a486);else{for(var _0x535a47=_0x13249e[_0x415c74(0xfd)]-0x1;_0x535a47>=0x0;_0x535a47--)if(_0x3b7215=_0x13249e[_0x535a47])_0x519bef=(_0x3a783f<0x3?_0x3b7215(_0x519bef):_0x3a783f>0x3?_0x3b7215(_0x1a3ea6,_0x548ca1,_0x519bef):_0x3b7215(_0x1a3ea6,_0x548ca1))||_0x519bef;}return _0x3a783f>0x3&&_0x519bef&&Object['defineProperty'](_0x1a3ea6,_0x548ca1,_0x519bef),_0x519bef;},__metadata=this&&this[_0x4fdebf(0xec)]||function(_0x1e535e,_0x38f3bc){const _0x3603b6=_0x4fdebf;if(typeof Reflect===_0x3603b6(0x125)&&typeof Reflect[_0x3603b6(0xa4)]===_0x3603b6(0x106))return Reflect[_0x3603b6(0xa4)](_0x1e535e,_0x38f3bc);},__param=this&&this[_0x4fdebf(0x12d)]||function(_0x11acad,_0x4527c9){return function(_0x23a685,_0x13f2f7){_0x4527c9(_0x23a685,_0x13f2f7,_0x11acad);};};Object['defineProperty'](exports,_0x4fdebf(0x119),{'value':!![]}),exports['MjService']=void 0x0;const globalConfig_service_1=require(_0x4fdebf(0x13a)),upload_service_1=require(_0x4fdebf(0xa8)),common_1=require(_0x4fdebf(0xbc)),axios_1=require(_0x4fdebf(0x95)),chatLog_service_1=require(_0x4fdebf(0x10e)),balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require('../../common/utils'),chatLog_entity_1=require(_0x4fdebf(0x94)),typeorm_1=require(_0x4fdebf(0xa5)),typeorm_2=require(_0x4fdebf(0xa1)),balance_entity_1=require('../userBalance/balance.entity'),fanyi_service_1=require(_0x4fdebf(0xbb)),badwords_service_1=require(_0x4fdebf(0x115));let MjService=class MjService{constructor(_0x39bb88,_0x4c0a4f,_0x19efa8,_0x552f8f,_0x3fe29a,_0x53a5a0,_0x49798e){const _0x8de18a=_0x4fdebf;this[_0x8de18a(0x142)]=_0x39bb88,this['balanceEntity']=_0x4c0a4f,this[_0x8de18a(0x11d)]=_0x19efa8,this[_0x8de18a(0xe7)]=_0x552f8f,this[_0x8de18a(0xd3)]=_0x3fe29a,this[_0x8de18a(0xa2)]=_0x53a5a0,this[_0x8de18a(0x8e)]=_0x49798e,this[_0x8de18a(0xf7)]={},this[_0x8de18a(0xcd)]=[],this[_0x8de18a(0x126)]=[],this[_0x8de18a(0x113)]=0x0,this[_0x8de18a(0x100)]={};}async[_0x4fdebf(0x10c)](_0x47cf88){const _0x3163df=_0x4fdebf,{jobId:_0x26ad13,prompt:_0x1daadc,startTime:_0x36af85,userId:_0x1fb33c}=_0x47cf88;return console[_0x3163df(0x92)](_0x3163df(0x112),_0x3163df(0xc9)),await new Promise(_0x1c4263=>setTimeout(_0x1c4263,0x1388)),{'a':0x1,'b':0x2};}async[_0x4fdebf(0x134)](_0x7911aa,_0x4ac915){const _0x515ab1=_0x4fdebf;await this[_0x515ab1(0xb2)](_0x4ac915),await this[_0x515ab1(0x8e)][_0x515ab1(0xc2)](_0x7911aa[_0x515ab1(0xb8)],_0x4ac915[_0x515ab1(0xb1)]['id']);const _0x38e8ce=_0x7911aa[_0x515ab1(0xb8)];let _0x39a25e=_0x7911aa[_0x515ab1(0xb8)];const {baiduFanyiAppId:_0x47f1a5,baiduFanyiSecret:_0x318059}=await this[_0x515ab1(0xd3)][_0x515ab1(0xe0)]([_0x515ab1(0xb5),_0x515ab1(0xda)]);_0x47f1a5&&_0x318059&&(_0x39a25e=await this['fanyiService']['convertToEnglish'](_0x38e8ce));const _0x32029e='['+(0x0,utils_1[_0x515ab1(0x9a)])()+']',_0x3c405a=_0x32029e+'\x20'+_0x39a25e;console[_0x515ab1(0x92)]('randomId:\x20',_0x32029e),console[_0x515ab1(0x92)](_0x515ab1(0xd5),_0x3c405a);const _0x2cdbf6=this[_0x515ab1(0xcd)][_0x515ab1(0x129)](_0x4c3286=>_0x4c3286[_0x515ab1(0x139)](_0x7911aa['prompt']));if(_0x2cdbf6)throw new common_1['HttpException'](_0x515ab1(0x13e),common_1[_0x515ab1(0xad)]['BAD_REQUEST']);if(this['queueCount']>=0x3)throw new common_1[(_0x515ab1(0xe2))](_0x515ab1(0x91),common_1[_0x515ab1(0xad)][_0x515ab1(0x12e)]);await this[_0x515ab1(0xb6)](_0x4ac915),this[_0x515ab1(0x113)]++,console[_0x515ab1(0x92)](_0x515ab1(0xc4)+_0x4ac915[_0x515ab1(0xb1)]['id']+_0x515ab1(0x93),this[_0x515ab1(0x113)]);try{const _0x433063=await this[_0x515ab1(0x142)][_0x515ab1(0x129)]({'where':{'prompt':(0x0,typeorm_1[_0x515ab1(0xf3)])('%'+_0x3c405a+'%')}}),_0x58a8e7=_0x433063[_0x515ab1(0x10f)](_0x203e82=>_0x203e82['message_id']);this[_0x515ab1(0xcd)][_0x515ab1(0x121)](_0x3c405a);let _0x426f79;const _0x58fe30=await this['sendDrawInteractions'](_0x3c405a,_0x58a8e7,_0x32029e);_0x58fe30?(console['log'](_0x515ab1(0xee)),_0x426f79=_0x58fe30):_0x426f79=await this[_0x515ab1(0x130)](_0x3c405a,_0x58a8e7,_0x32029e);this[_0x515ab1(0x113)]--,this[_0x515ab1(0x113)]<0x0&&(this[_0x515ab1(0x113)]=0x0),console[_0x515ab1(0x92)](_0x515ab1(0x90),this[_0x515ab1(0x113)]);const {id:_0x2ab2dd,content:_0x97eb77,channel_id:_0x5c9184,attachments:attachments=[],timestamp:_0x3b3e93}=_0x426f79;if(!attachments[_0x515ab1(0xfd)]||!attachments[0x0][_0x515ab1(0xcf)])throw new common_1[(_0x515ab1(0xe2))](_0x515ab1(0xd6),common_1[_0x515ab1(0xad)][_0x515ab1(0x12e)]);const {filename:_0x33ebd2,url:_0x116331,width:_0x2096e7,height:_0x34e7ef,size:_0x5c95f9}=attachments[0x0];console['log'](_0x515ab1(0x13c),_0x116331);const _0x11f1df=this[_0x515ab1(0xd3)][_0x515ab1(0xe0)](['mjNotSaveImg']);let _0xf2ac85='';(!Number(_0x11f1df)||Number(_0x11f1df)===0x0)&&(_0xf2ac85=await this[_0x515ab1(0x11d)][_0x515ab1(0x12c)]({'filename':_0x33ebd2,'url':_0x116331}),console[_0x515ab1(0x92)](_0x515ab1(0x133),_0xf2ac85));const _0x2120dc={'curIp':(0x0,utils_1['getClientIp'])(_0x4ac915),'userId':_0x4ac915[_0x515ab1(0xb1)]['id'],'type':balance_constant_1[_0x515ab1(0x13b)][_0x515ab1(0xf6)],'prompt':_0x3c405a,'answer':_0xf2ac85,'model':'mj','extend':this['removeEmoji'](JSON[_0x515ab1(0x9c)](_0x426f79)),'message_id':_0x2ab2dd,'variationId':_0x2ab2dd,'upscaleId':_0x2ab2dd,'group':0x1,'isSaveImg':!Number(_0x11f1df)||Number(_0x11f1df)===0x0,'fileInfo':JSON['stringify']({'width':_0x2096e7,'height':_0x34e7ef,'size':_0x5c95f9,'filename':_0x33ebd2,'cosUrl':_0xf2ac85})};return await this[_0x515ab1(0xe7)]['saveChatLog'](_0x2120dc),await this[_0x515ab1(0xc3)](_0x4ac915),this[_0x515ab1(0xcd)]=this[_0x515ab1(0xcd)]['filter'](_0x4b2d49=>_0x4b2d49!==_0x7911aa[_0x515ab1(0xb8)]),_0xf2ac85;}catch(_0x1eacae){this[_0x515ab1(0x113)]--,this[_0x515ab1(0x113)]<0x0&&(this['queueCount']=0x0),console[_0x515ab1(0x92)](_0x515ab1(0x96),this[_0x515ab1(0x113)]),this[_0x515ab1(0xcd)]=this[_0x515ab1(0xcd)][_0x515ab1(0x13f)](_0x2cf78e=>_0x2cf78e!==_0x7911aa[_0x515ab1(0xb8)]);throw new common_1[(_0x515ab1(0xe2))](_0x1eacae[_0x515ab1(0xdb)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x4fdebf(0xd2)](_0x395bec,_0x21429c){const _0x10dfae=_0x4fdebf;if(this[_0x10dfae(0x113)]>=0x3)throw new common_1[(_0x10dfae(0xe2))](_0x10dfae(0x91),common_1[_0x10dfae(0xad)]['BAD_REQUEST']);this[_0x10dfae(0x113)]++,console[_0x10dfae(0x92)]('用户'+_0x21429c[_0x10dfae(0xb1)]['id']+_0x10dfae(0xc0),this[_0x10dfae(0x113)]);const {message_id:_0x3d94ee,orderId:_0x7173b7}=_0x395bec;try{const _0x10a9c1=await this[_0x10dfae(0x142)]['findOne']({'where':{'message_id':_0x3d94ee}});if(!_0x10a9c1)throw new common_1[(_0x10dfae(0xe2))]('历史记录中不存在当前图片、请确认您放大的图片是否存在',common_1[_0x10dfae(0xad)]['BAD_REQUEST']);const _0x13e196=await this[_0x10dfae(0x142)][_0x10dfae(0x110)]({'where':{'upscaleId':_0x3d94ee,'action':_0x10dfae(0xdf),'orderId':_0x7173b7}});if(_0x13e196)throw new common_1[(_0x10dfae(0xe2))](_0x10dfae(0x102),common_1[_0x10dfae(0xad)][_0x10dfae(0x12e)]);const {prompt:_0x37aa29,extend:_0x3ba4b4}=_0x10a9c1;let _0x294b27=null;try{_0x294b27=JSON['parse'](_0x3ba4b4);}catch(_0x2db45e){_0x294b27=[];}const {components:components=[]}=_0x294b27;if(!components[_0x10dfae(0xfd)])throw new common_1[(_0x10dfae(0xe2))]('当前图片没有绘画信息、无法放大!',common_1[_0x10dfae(0xad)]['BAD_REQUEST']);const _0x4a1560=components[0x0][_0x10dfae(0xfa)][_0x7173b7-0x1],{custom_id:_0x4c534a}=_0x4a1560;console['log'](_0x10dfae(0xd7),_0x4c534a);const _0x42a276={'message_id':_0x3d94ee,'custom_id':_0x4c534a,'prompt':_0x37aa29,'orderId':_0x7173b7};await this[_0x10dfae(0xb7)](_0x42a276),console[_0x10dfae(0x92)](_0x10dfae(0xe4));const _0xf327a6=await this[_0x10dfae(0x142)][_0x10dfae(0x129)]({'where':{'prompt':(0x0,typeorm_1[_0x10dfae(0xf3)])('%'+_0x37aa29+'%')}}),_0x17af79=_0xf327a6['map'](_0xed04db=>_0xed04db[_0x10dfae(0xab)]);console[_0x10dfae(0x92)](_0x10dfae(0x9f),_0x17af79);const _0x10ba31=await this[_0x10dfae(0xfe)](_0x42a276,_0x17af79);this[_0x10dfae(0x113)]--,this[_0x10dfae(0x113)]<0x0&&(this[_0x10dfae(0x113)]=0x0),console[_0x10dfae(0x92)](_0x10dfae(0x12f),this[_0x10dfae(0x113)]);const {id:_0x21ea0a,content:_0x3ba07e,channel_id:_0xfc5e42,attachments:attachments=[],timestamp:_0x492642}=_0x10ba31;if(!attachments[_0x10dfae(0xfd)]||!attachments[0x0][_0x10dfae(0xcf)])throw new common_1['HttpException'](_0x10dfae(0xf1),common_1[_0x10dfae(0xad)][_0x10dfae(0x12e)]);const {filename:_0x176893,url:_0x2feea0,width:_0x413ace,height:_0x225b63,size:_0x217475}=attachments[0x0],_0x3ed233=this[_0x10dfae(0xd3)][_0x10dfae(0xe0)]([_0x10dfae(0xe6)]);let _0x3c9f67='';(!Number(_0x3ed233)||Number(_0x3ed233)===0x0)&&(_0x3c9f67=await this[_0x10dfae(0x11d)][_0x10dfae(0x12c)]({'filename':_0x176893,'url':_0x2feea0}),console['log'](_0x10dfae(0x133),_0x3c9f67));const _0x442599={'curIp':(0x0,utils_1[_0x10dfae(0x98)])(_0x21429c),'userId':_0x21429c[_0x10dfae(0xb1)]['id'],'type':balance_constant_1[_0x10dfae(0x13b)][_0x10dfae(0xf6)],'prompt':_0x37aa29,'answer':_0x3c9f67,'model':'mj','extend':this[_0x10dfae(0x11a)](JSON[_0x10dfae(0x9c)](_0x10ba31)),'message_id':_0x3d94ee,'upscaleId':_0x21ea0a,'variationId':_0x21ea0a,'action':'enlarge','orderId':_0x42a276[_0x10dfae(0xe9)],'isSaveImg':!Number(_0x3ed233)||Number(_0x3ed233)===0x0,'fileInfo':JSON[_0x10dfae(0x9c)]({'width':_0x413ace,'height':_0x225b63,'size':_0x217475,'filename':_0x176893,'cosUrl':_0x3c9f67})};return await this[_0x10dfae(0xe7)][_0x10dfae(0xac)](_0x442599),_0x3c9f67;}catch(_0x227da4){console[_0x10dfae(0x92)](_0x10dfae(0xcb),_0x227da4),this[_0x10dfae(0x113)]--,this['queueCount']<0x0&&(this[_0x10dfae(0x113)]=0x0),console['log'](_0x10dfae(0xae),this[_0x10dfae(0x113)]);throw new common_1['HttpException'](_0x227da4[_0x10dfae(0xdb)],common_1[_0x10dfae(0xad)]['BAD_REQUEST']);}}async[_0x4fdebf(0xf4)](_0x1eeff4,_0x1ea7b0){const _0x38da94=_0x4fdebf;if(this[_0x38da94(0x113)]>=0x3)throw new common_1[(_0x38da94(0xe2))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1['HttpStatus'][_0x38da94(0x12e)]);await this[_0x38da94(0xb2)](_0x1ea7b0),await this['checkRateLimit'](_0x1ea7b0),this[_0x38da94(0x113)]++,console['log']('用户'+_0x1ea7b0['user']['id']+'开始请求变换图片\x20队列+1:\x20',this['queueCount']);const {message_id:_0x2d7a40,orderId:_0x3d68c1}=_0x1eeff4;try{const _0x37ea87=await this['chatLogEntity'][_0x38da94(0x110)]({'where':{'message_id':_0x2d7a40}});if(!_0x37ea87)throw new common_1[(_0x38da94(0xe2))](_0x38da94(0xf5),common_1[_0x38da94(0xad)][_0x38da94(0x12e)]);const {prompt:_0x415139,extend:_0x56a8aa}=_0x37ea87;let _0x10a82f=null;try{_0x10a82f=JSON[_0x38da94(0x124)](_0x56a8aa);}catch(_0x2702e4){_0x10a82f=[];}const {components:components=[]}=_0x10a82f;if(!components[_0x38da94(0xfd)])throw new common_1[(_0x38da94(0xe2))](_0x38da94(0x123),common_1[_0x38da94(0xad)][_0x38da94(0x12e)]);const _0xfd3bc0=components[0x1][_0x38da94(0xfa)][_0x3d68c1-0x1],{custom_id:_0x599cbb}=_0xfd3bc0,_0x274d20=await this[_0x38da94(0x142)][_0x38da94(0x129)]({'where':{'variationId':(0x0,typeorm_1[_0x38da94(0x135)])((0x0,typeorm_1[_0x38da94(0xdd)])()),'prompt':(0x0,typeorm_1[_0x38da94(0xf3)])('%'+_0x415139+'%')}}),_0x229276=_0x274d20[_0x38da94(0x10f)](_0x555507=>_0x555507[_0x38da94(0xc1)]),_0xd51176={'message_id':_0x2d7a40,'custom_id':_0x599cbb,'prompt':_0x415139,'orderId':_0x3d68c1};await this['sendSmInteractions'](_0xd51176);const _0x36d82f=await this[_0x38da94(0x97)](_0xd51176,_0x229276);this[_0x38da94(0x113)]--,this[_0x38da94(0x113)]<0x0&&(this[_0x38da94(0x113)]=0x0),console['log'](_0x38da94(0x136),this[_0x38da94(0x113)]);const {id:_0x4100cb,content:_0xcfa6a2,channel_id:_0x287060,attachments:attachments=[],timestamp:_0x23973a}=_0x36d82f;if(!attachments[_0x38da94(0xfd)]||!attachments[0x0]['url'])throw new common_1[(_0x38da94(0xe2))](_0x38da94(0x8f),common_1[_0x38da94(0xad)][_0x38da94(0x12e)]);const {filename:_0x1e8c0d,url:_0x5ed9d6,width:_0x449b8e,height:_0x3b24fa,size:_0x3b847c}=attachments[0x0],_0x49a7d1=this[_0x38da94(0xd3)][_0x38da94(0xe0)]([_0x38da94(0xe6)]);let _0xff0188='';(!Number(_0x49a7d1)||Number(_0x49a7d1)===0x0)&&(_0xff0188=await this['uploadService'][_0x38da94(0x12c)]({'filename':_0x1e8c0d,'url':_0x5ed9d6}),console[_0x38da94(0x92)](_0x38da94(0x133),_0xff0188));const _0x5e0f38={'curIp':(0x0,utils_1[_0x38da94(0x98)])(_0x1ea7b0),'userId':_0x1ea7b0['user']['id'],'type':balance_constant_1[_0x38da94(0x13b)]['PAINT_TYPE'],'prompt':_0x415139,'answer':_0xff0188,'model':'mj','group':0x1,'extend':this[_0x38da94(0x11a)](JSON[_0x38da94(0x9c)](_0x36d82f)),'message_id':_0x4100cb,'upscaleId':_0x4100cb,'variationId':_0x4100cb,'action':_0x38da94(0xdf),'orderId':_0xd51176['orderId'],'isSaveImg':!Number(_0x49a7d1)||Number(_0x49a7d1)===0x0,'fileInfo':JSON[_0x38da94(0x9c)]({'width':_0x449b8e,'height':_0x3b24fa,'size':_0x3b847c,'filename':_0x1e8c0d,'cosUrl':_0xff0188})};return await this[_0x38da94(0xe7)][_0x38da94(0xac)](_0x5e0f38),_0xff0188;}catch(_0x1eb2d3){console[_0x38da94(0x92)]('error:\x20',_0x1eb2d3),this[_0x38da94(0x113)]--,this[_0x38da94(0x113)]<0x0&&(this[_0x38da94(0x113)]=0x0),console[_0x38da94(0x92)](_0x38da94(0xba),this[_0x38da94(0x113)]);throw new common_1[(_0x38da94(0xe2))](_0x1eb2d3[_0x38da94(0xdb)],common_1[_0x38da94(0xad)][_0x38da94(0x12e)]);}}async['sendSmInteractions'](_0x5da201){const _0x4c89d6=_0x4fdebf,{message_id:_0x5a83c6,custom_id:_0x538493}=_0x5da201,{application_id:_0x4711cb,guild_id:_0x5adda4,channel_id:_0x200fdd,session_id:_0x82e164,version:_0x22d6c8,id:_0x18dea9,authorization:_0x5938c5,mjProxy:_0x23b9ca}=await this[_0x4c89d6(0xbe)](),_0x37163d=_0x23b9ca==0x1?_0x4c89d6(0xc5):_0x4c89d6(0x107),_0x4e6bfa={'authorization':_0x5938c5},_0x2cfde8={'type':0x3,'guild_id':_0x5adda4,'channel_id':_0x200fdd,'message_flags':0x0,'message_id':_0x5a83c6,'application_id':_0x4711cb,'session_id':_0x82e164,'data':{'component_type':0x2,'custom_id':_0x538493}};try{await axios_1['default'][_0x4c89d6(0x12a)](_0x37163d,_0x2cfde8,{'headers':_0x4e6bfa}),console[_0x4c89d6(0x92)]('绘图指令完成');}catch(_0x3194b1){console['log'](_0x4c89d6(0xcb),_0x3194b1);throw new common_1[(_0x4c89d6(0xe2))](_0x4c89d6(0x10a),common_1[_0x4c89d6(0xad)][_0x4c89d6(0x12e)]);}}async[_0x4fdebf(0xfe)](_0x44f833,_0x33f563){const _0x311d73=_0x4fdebf,{message_id:_0xb3b980,custom_id:_0x27b6c7,prompt:_0x2c852b,orderId:_0x3f523b}=_0x44f833;let _0x458e74=null,_0x2b726a=0x0;while(!_0x458e74&&_0x2b726a<0xa){try{const _0x2d6ca5=Date[_0x311d73(0x9d)](),_0x27177f=await this[_0x311d73(0xb9)]();console[_0x311d73(0x92)]('第\x20'+(_0x2b726a+0x1)+_0x311d73(0x131)+_0x27177f[_0x311d73(0xfd)]);_0x27177f&&_0x27177f[_0x311d73(0xfd)]&&(_0x458e74=await this[_0x311d73(0xb0)](_0x27177f,_0x44f833,_0x33f563));const _0x46fa91=Date[_0x311d73(0x9d)]()-_0x2d6ca5,_0x18a5bf=0xbb8;await this[_0x311d73(0xbd)](Math[_0x311d73(0x10d)](_0x18a5bf-_0x46fa91,0x0)),_0x2b726a++;}catch(_0x5733a5){console[_0x311d73(0xce)](_0x311d73(0xaa)+_0x5733a5[_0x311d73(0xf9)]);}}return _0x458e74;}async[_0x4fdebf(0x97)](_0x28a77,_0xae0f64){const _0x1b121f=_0x4fdebf,{message_id:_0x116703,custom_id:_0x2892d6,prompt:_0x45eb7f,orderId:_0x52fb97}=_0x28a77;console['log'](_0x1b121f(0xeb));let _0x48d475=null,_0x353c7f=0x0;while(!_0x48d475&&_0x353c7f<0xa){try{console[_0x1b121f(0x92)]('第\x20'+(_0x353c7f+0x1)+_0x1b121f(0x105));const _0x423dab=Date[_0x1b121f(0x9d)](),_0x53f8a4=await this['queryMessageList']();_0x53f8a4&&_0x53f8a4[_0x1b121f(0xfd)]&&(_0x48d475=await this[_0x1b121f(0xe1)](_0x53f8a4,_0x28a77,_0xae0f64));const _0x19e9e5=Date['now']()-_0x423dab,_0x1ca273=0x1f40;await this['sleep'](Math['max'](_0x1ca273-_0x19e9e5,0x0)),_0x353c7f++;}catch(_0x282f9a){console[_0x1b121f(0xce)](_0x1b121f(0xaa)+_0x282f9a[_0x1b121f(0xf9)]);}}if(!_0x48d475)throw new common_1[(_0x1b121f(0xe2))](_0x1b121f(0xa3),common_1[_0x1b121f(0xad)]['BAD_REQUEST']);return _0x48d475;}async[_0x4fdebf(0xb0)](_0x2371c2,_0x564bb8,_0x93d2b6){const _0x5bb028=_0x4fdebf,{message_id:_0x8cb1fb,custom_id:_0x59a1fb,prompt:_0x441e2e,orderId:_0x3c13e2}=_0x564bb8,_0x144bc6=_0x441e2e[_0x5bb028(0x99)](0x0,0xc);console[_0x5bb028(0x92)](_0x5bb028(0x138),_0x144bc6);const _0x326e67=_0x2371c2[_0x5bb028(0x129)](_0x575f04=>{const _0x3b102f=_0x5bb028,{content:_0x14e1d8}=_0x575f04;if(!this[_0x3b102f(0xe3)](_0x14e1d8))return![];const {prompt:_0x39f624,order:_0x5cab6b}=this[_0x3b102f(0xe3)](_0x14e1d8);return _0x39f624[_0x3b102f(0x139)](_0x144bc6)&&_0x564bb8[_0x3b102f(0xe9)]===_0x5cab6b&&!_0x93d2b6[_0x3b102f(0x139)](_0x575f04['id']);});return _0x326e67;}async['findCurrentVariationImgResult'](_0x4b5be,_0x44297a,_0x17a6c9){const _0x57bce4=_0x4fdebf,{message_id:_0x35c894,custom_id:_0x512540,prompt:_0x48faa2,orderId:_0x1588cc}=_0x44297a,_0x36529f=_0x48faa2[_0x57bce4(0x99)](0x0,0xc),_0x191450=_0x4b5be[_0x57bce4(0x129)](_0x1d129a=>{const _0x280525=_0x57bce4,{content:_0x4dec2f}=_0x1d129a,_0x4bf785=_0x4dec2f['match'](/\*\*(.+?)\*\*/),_0x417c92=_0x4bf785?_0x4bf785[0x1]:'';if(!_0x417c92)return![];return _0x417c92['includes'](_0x36529f)&&!_0x17a6c9[_0x280525(0x139)](_0x1d129a['id']);});return _0x191450;}async['sendDrawInteractions'](_0x4313e6,_0x1eb9a6,_0x36d448){const _0x1b6210=_0x4fdebf,_0x2c6614=await this[_0x1b6210(0xb9)](),_0x125c17=await this[_0x1b6210(0x101)](_0x2c6614,_0x36d448,_0x1eb9a6);if(_0x125c17)return console[_0x1b6210(0x92)]('有历史信息之间返回:\x20',_0x125c17),_0x125c17;const {application_id:_0x215fec,guild_id:_0x5e93ff,channel_id:_0x55c53d,session_id:_0x573680,version:_0x188fed,id:_0x4ac708,authorization:_0x105df4,mjProxy:_0x42cf41}=await this[_0x1b6210(0xbe)](),_0x3fd019={'type':0x2,'application_id':_0x215fec,'guild_id':_0x5e93ff,'channel_id':_0x55c53d,'session_id':_0x573680,'data':{'version':_0x188fed,'id':_0x4ac708,'name':_0x1b6210(0x103),'type':0x1,'options':[{'type':0x3,'name':_0x1b6210(0xb8),'value':_0x4313e6}],'attachments':[]}};try{const _0x4768c0=_0x42cf41==0x1?_0x1b6210(0xc5):_0x1b6210(0x107),_0x6b548b={'authorization':_0x105df4},_0x50ea45=await axios_1['default']['post'](_0x4768c0,_0x3fd019,{'headers':_0x6b548b});return console[_0x1b6210(0x92)](_0x1b6210(0x109),_0x50ea45[_0x1b6210(0x140)]),![];}catch(_0x1813f2){console[_0x1b6210(0x92)](_0x1b6210(0xc8),_0x1813f2);throw new common_1[(_0x1b6210(0xe2))]('绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...',common_1[_0x1b6210(0xad)]['BAD_REQUEST']);}}async[_0x4fdebf(0x130)](_0x3c5f47,_0x48922f,_0x419e0a){const _0x50058b=_0x4fdebf;console[_0x50058b(0x92)](_0x50058b(0xea));const _0x333329=Date[_0x50058b(0x9d)]();try{const _0x9742fb=0xd,_0x4b4593=0x2ee0,_0xd0b9e9=0x1388,_0x2e6f92=0x3c*0x3e8;let _0x326f3e=0x0,_0x26d576=![],_0x397faf=null;while(!_0x397faf&&_0x326f3e<_0x9742fb){console[_0x50058b(0x92)]('第\x20'+(_0x326f3e+0x1)+_0x50058b(0x11b));Date[_0x50058b(0x9d)]()-_0x333329>=_0x2e6f92&&(_0x26d576=!![]);await this[_0x50058b(0xbd)](_0x26d576?_0xd0b9e9:_0x4b4593);const _0x2c9945=await this[_0x50058b(0xb9)]();_0x397faf=await this[_0x50058b(0x101)](_0x2c9945,_0x419e0a,_0x48922f),_0x326f3e++;}if(!_0x397faf)throw new common_1[(_0x50058b(0xe2))]('绘画超时，请稍后再试！',common_1[_0x50058b(0xad)][_0x50058b(0x12e)]);const _0x448ced=Date[_0x50058b(0x9d)]();return console[_0x50058b(0x92)]('本次绘图耗时:\x20'+Math[_0x50058b(0x8d)]((_0x448ced-_0x333329)/0x3e8)+'\x20S'),_0x397faf;}catch(_0x41fe37){console['error'](_0x41fe37[_0x50058b(0xf9)]);throw new common_1['HttpException']('网络连接失败，请稍后再试！',common_1[_0x50058b(0xad)]['INTERNAL_SERVER_ERROR']);}}async[_0x4fdebf(0x101)](_0x5a91f,_0x25792e,_0x596394){const _0x50117b=_0x4fdebf;if(!_0x5a91f||!_0x5a91f[_0x50117b(0xfd)])return;console[_0x50117b(0x92)]('本次比对的随机ID:\x20',_0x25792e);const _0x21cd1f=_0x5a91f[_0x50117b(0x129)](_0x5cb2f3=>{const _0x43e802=_0x50117b,{attachments:attachments=[],content:_0x15c97d,edited_timestamp:_0x3ac3b0}=_0x5cb2f3;return _0x15c97d[_0x43e802(0x139)](_0x25792e)&&attachments[_0x43e802(0xfd)]>0x0&&!_0x3ac3b0&&!_0x596394[_0x43e802(0x139)](_0x5cb2f3['id']);});return _0x21cd1f||null;}async[_0x4fdebf(0xb9)](){const _0x590cd5=_0x4fdebf;try{const {application_id:_0x151972,guild_id:_0x2cf6c0,channel_id:_0x4198f8,session_id:_0x1e470b,version:_0x53cded,id:_0xd27ad8,authorization:_0xe64fd4,mjProxy:_0x155df9}=await this[_0x590cd5(0xbe)](),_0xe1e200=_0x155df9==0x1?_0x590cd5(0x127)+_0x4198f8:_0x590cd5(0xe8)+_0x4198f8+'/messages?limit=50',_0x20ba1a={'authorization':_0xe64fd4},_0x5268a=await axios_1[_0x590cd5(0xa6)]['get'](_0xe1e200,{'headers':_0x20ba1a});return _0x5268a['data'];}catch(_0x3a52ca){console[_0x590cd5(0x92)](_0x590cd5(0x108),_0x3a52ca);throw new common_1[(_0x590cd5(0xe2))](_0x590cd5(0x116),common_1[_0x590cd5(0xad)]['BAD_REQUEST']);}}async[_0x4fdebf(0xbd)](_0x4fc20e){return new Promise(_0x2d5cd8=>setTimeout(_0x2d5cd8,_0x4fc20e));}[_0x4fdebf(0xe3)](_0xc432d2){const _0x98b1e0=_0x4fdebf,_0x30b13f=_0xc432d2[_0x98b1e0(0x128)](/\*\*(.+?)\*\*/),_0xb16222=_0xc432d2[_0x98b1e0(0x128)](/- Image #(\d+)/);if(!_0x30b13f||!_0xb16222)return null;const _0x3c0912=_0x30b13f[0x1],_0x50ea76=parseInt(_0xb16222[0x1]);return{'prompt':_0x3c0912,'order':_0x50ea76};}async[_0x4fdebf(0xbe)](){const _0x1bdfd4=_0x4fdebf,_0x177468=await this[_0x1bdfd4(0xd3)][_0x1bdfd4(0xe0)](['mjId','mjApplicationId',_0x1bdfd4(0x12b),_0x1bdfd4(0xd8),_0x1bdfd4(0xf0),_0x1bdfd4(0xfb),'mjAuthorization',_0x1bdfd4(0x137),_0x1bdfd4(0x117)]),_0x46f211={'application_id':_0x177468[_0x1bdfd4(0xa0)],'guild_id':_0x177468[_0x1bdfd4(0x12b)],'channel_id':_0x177468[_0x1bdfd4(0xd8)],'session_id':_0x177468[_0x1bdfd4(0xf0)],'version':_0x177468[_0x1bdfd4(0xfb)],'id':_0x177468[_0x1bdfd4(0xc7)],'authorization':_0x177468[_0x1bdfd4(0xf2)],'mjRateLimit':_0x177468[_0x1bdfd4(0x137)],'mjProxy':_0x177468[_0x1bdfd4(0x117)]||0x0};return _0x46f211;}[_0x4fdebf(0x11a)](_0x5ca767){const _0x2c82a9=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x5ca767['replace'](_0x2c82a9,'');}async[_0x4fdebf(0xb2)](_0xfd59e3){const _0x36a2b0=_0x4fdebf,_0x32a00f=await this[_0x36a2b0(0xdc)][_0x36a2b0(0x110)]({'where':{'userId':_0xfd59e3[_0x36a2b0(0xb1)]['id']}}),{id:_0x23698c,balance:_0x3090ae}=_0x32a00f;if(!_0x3090ae||(_0x32a00f===null||_0x32a00f===void 0x0?void 0x0:_0x32a00f[_0x36a2b0(0xf8)])<0x1)throw new common_1[(_0x36a2b0(0xe2))](_0x36a2b0(0xcc),common_1[_0x36a2b0(0xad)][_0x36a2b0(0x12e)]);}async['checkFree'](_0x4cbea3){const _0x38d05d=_0x4fdebf,{id:_0x439774,role:_0x28d8d9}=_0x4cbea3[_0x38d05d(0xb1)];!this[_0x38d05d(0x100)][_0x439774]?this[_0x38d05d(0x100)][_0x439774]=0x1:this[_0x38d05d(0x100)][_0x439774]=this['freeQueueUsers'][_0x439774]+0x1,console['log']('当前用户'+_0x439774+_0x38d05d(0x11f),this[_0x38d05d(0x100)][_0x439774]);}async[_0x4fdebf(0xb6)](_0x4b1f64){const _0x2a9b2e=_0x4fdebf,{id:_0x501c6f,role:_0x191834}=_0x4b1f64[_0x2a9b2e(0xb1)];if([_0x2a9b2e(0x122),_0x2a9b2e(0xd1)][_0x2a9b2e(0x139)](_0x191834))return!![];const {mjRateLimit:_0x59a0c2}=await this['getMjDefaultParams']();if(this[_0x2a9b2e(0xf7)][_0x501c6f]){const _0x78c89c=this[_0x2a9b2e(0xf7)][_0x501c6f];if(_0x78c89c>Date[_0x2a9b2e(0x9d)]()){console[_0x2a9b2e(0x92)](_0x2a9b2e(0xd0)+_0x501c6f+'\x20请求过于频繁！');throw new common_1[(_0x2a9b2e(0xe2))](_0x2a9b2e(0x9e)+_0x59a0c2+_0x2a9b2e(0x9b),common_1[_0x2a9b2e(0xad)][_0x2a9b2e(0x12e)]);}else this[_0x2a9b2e(0xf7)][_0x501c6f]=Date[_0x2a9b2e(0x9d)]()+Number(_0x59a0c2)*0x3e8;}else{const _0x2a1edc=Date[_0x2a9b2e(0x9d)]();this['rateLimits'][_0x501c6f]=_0x2a1edc+0x3e8*Number(_0x59a0c2);}}async[_0x4fdebf(0xc3)](_0x59ef43){const _0x191b2f=_0x4fdebf;await this[_0x191b2f(0xdc)][_0x191b2f(0x8c)]()[_0x191b2f(0x111)](balance_entity_1['BalanceEntity'])[_0x191b2f(0xbf)]({'balance':()=>_0x191b2f(0xd4)})[_0x191b2f(0xa9)](_0x191b2f(0xd9),{'userId':_0x59ef43[_0x191b2f(0xb1)]['id']})[_0x191b2f(0x143)]();}async['test'](){return 0x1;}};function _0x47e5(_0x554b7c,_0x53a07c){const _0x4bdbcc=_0x4bdb();return _0x47e5=function(_0x47e58b,_0x1f7705){_0x47e58b=_0x47e58b-0x8c;let _0x4450de=_0x4bdbcc[_0x47e58b];return _0x4450de;},_0x47e5(_0x554b7c,_0x53a07c);}MjService=__decorate([(0x0,common_1[_0x4fdebf(0xa7)])(),__param(0x0,(0x0,typeorm_2[_0x4fdebf(0xe5)])(chatLog_entity_1[_0x4fdebf(0xff)])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(balance_entity_1['BalanceEntity'])),__metadata(_0x4fdebf(0xca),[typeorm_1[_0x4fdebf(0x104)],typeorm_1['Repository'],upload_service_1['UploadService'],chatLog_service_1[_0x4fdebf(0xc6)],globalConfig_service_1[_0x4fdebf(0xaf)],fanyi_service_1[_0x4fdebf(0x132)],badwords_service_1[_0x4fdebf(0x11c)]])],MjService),exports[_0x4fdebf(0x141)]=MjService;