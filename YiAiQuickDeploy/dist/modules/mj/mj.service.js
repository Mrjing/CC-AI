'use strict';const _0x5951e4=_0x5a0c;(function(_0x212ffa,_0x120131){const _0x214581=_0x5a0c,_0x275f30=_0x212ffa();while(!![]){try{const _0x4ff099=parseInt(_0x214581(0x1e0))/0x1+-parseInt(_0x214581(0x208))/0x2+parseInt(_0x214581(0x20f))/0x3*(-parseInt(_0x214581(0x221))/0x4)+-parseInt(_0x214581(0x243))/0x5+parseInt(_0x214581(0x1e6))/0x6*(-parseInt(_0x214581(0x22a))/0x7)+-parseInt(_0x214581(0x18c))/0x8*(-parseInt(_0x214581(0x1cb))/0x9)+parseInt(_0x214581(0x237))/0xa;if(_0x4ff099===_0x120131)break;else _0x275f30['push'](_0x275f30['shift']());}catch(_0x41b96c){_0x275f30['push'](_0x275f30['shift']());}}}(_0x2b4a,0xcd066));function _0x5a0c(_0xb942ba,_0x3d5db8){const _0x2b4a64=_0x2b4a();return _0x5a0c=function(_0x5a0cf1,_0x468d20){_0x5a0cf1=_0x5a0cf1-0x184;let _0x475a4f=_0x2b4a64[_0x5a0cf1];return _0x475a4f;},_0x5a0c(_0xb942ba,_0x3d5db8);}var __decorate=this&&this['__decorate']||function(_0x14bec7,_0x103f94,_0x3998ef,_0x103edb){const _0x322979=_0x5a0c;var _0x21d28a=arguments[_0x322979(0x1a5)],_0x4f0f4e=_0x21d28a<0x3?_0x103f94:_0x103edb===null?_0x103edb=Object[_0x322979(0x1e8)](_0x103f94,_0x3998ef):_0x103edb,_0x2ef2ee;if(typeof Reflect===_0x322979(0x1b6)&&typeof Reflect['decorate']===_0x322979(0x194))_0x4f0f4e=Reflect['decorate'](_0x14bec7,_0x103f94,_0x3998ef,_0x103edb);else{for(var _0x1efd30=_0x14bec7[_0x322979(0x1a5)]-0x1;_0x1efd30>=0x0;_0x1efd30--)if(_0x2ef2ee=_0x14bec7[_0x1efd30])_0x4f0f4e=(_0x21d28a<0x3?_0x2ef2ee(_0x4f0f4e):_0x21d28a>0x3?_0x2ef2ee(_0x103f94,_0x3998ef,_0x4f0f4e):_0x2ef2ee(_0x103f94,_0x3998ef))||_0x4f0f4e;}return _0x21d28a>0x3&&_0x4f0f4e&&Object[_0x322979(0x1f8)](_0x103f94,_0x3998ef,_0x4f0f4e),_0x4f0f4e;},__metadata=this&&this[_0x5951e4(0x20e)]||function(_0x39f72f,_0x5f2008){const _0x4ccefb=_0x5951e4;if(typeof Reflect===_0x4ccefb(0x1b6)&&typeof Reflect[_0x4ccefb(0x235)]===_0x4ccefb(0x194))return Reflect[_0x4ccefb(0x235)](_0x39f72f,_0x5f2008);},__param=this&&this[_0x5951e4(0x21a)]||function(_0x5adecb,_0xeab037){return function(_0x188db1,_0x1ed49f){_0xeab037(_0x188db1,_0x1ed49f,_0x5adecb);};};Object[_0x5951e4(0x1f8)](exports,'__esModule',{'value':!![]}),exports[_0x5951e4(0x223)]=void 0x0;function _0x2b4a(){const _0x867a63=['data','7254135iccrTn','mjservice','log','ChatLogEntity','default','../chatLog/chatLog.service','http://172.247.48.137:8000/mj/draw','checkRateLimit','push','8JhGfTO','mjVersion','UploadService','prompt\x20-------->\x20\x20','@nestjs/common','当前用户','当前图片已经放大过了、请勿重复放大!','../../common/constants/balance.constant','function','放大图片任务异常中断\x20队列-1:\x20','Like','find','使用的次数：','BAD_REQUEST','includes','createRandomUid','您当前暂无MJ绘画余额！！！','now','PAINT_TYPE','\x20次开始查询','变换当前图片超时！','HttpException','绘画超时，请稍后再试！','Injectable','由于速率限制、当前普通用户限制为','length','sleep','IsNull','mjChannelId','变换当前图片失败','balanceEntity','deductBalance','randomId:\x20','drawWorking','mjSessionId','存入图片完成:\x20','BalanceEntity','where','match','查询绘制结果失败...','enlarge','balance','object','floor','createQueryBuilder','../badwords/badwords.service','本次绘图耗时:\x20','substring','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','uploadService','../userBalance/balance.entity','super','BadwordsService','/messages?limit=50','test','getClientIp','baiduFanyiSecret','当前图片没有绘画信息、无法放大!','绘制图片任务结束\x20队列-1:\x20','发送绘画指令结果:\x20','prompt','imagine','\x20请求过于频繁！','3441987hLbCYr','HttpStatus','chatLogEntity','checkAuth','url','message_id','chatLogService','orderId','sendDrawInteractions','design:paramtypes','findOne','mjDraw','pollForVariationResult','拿到了远程地址:\x20','mjGuildId','globalConfigService','mjRateLimit','axios','error:\x20','放大单张图片请求失败...','有历史信息之间返回:\x20','682920JczdVm','http://172.247.48.137:8000/mj/list?channel_id=','变化图片任务异常中断\x20队列-1:\x20','放大当前图片失败','pollForUpscaleResult','当前提示词已经在任务队列中了、请勿重复提交。。。','6873180AVRBNJ','findCurrentPromptResult','getOwnPropertyDescriptor','本次比对的随机ID:\x20','parse','error','getMjDefaultParams','发送放大指令成功','查询期间出现错误：','INTERNAL_SERVER_ERROR','queueCount','variationSingleImg','ChatLogService','removeEmoji','历史这些id已经被获取过了\x20不能拿了:\x20','upscaleSingleImg','update','mjId','defineProperty','@nestjs/typeorm','stringify','Repository','enlargeWorking','getConfigs','get','开始轮询单张变换图片结果','freeQueueUsers','GlobalConfigService','\x20次开始查询[变换图片]','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','FanyiService','开始请求放大图片\x20队列+1:\x20','开始查询绘画结果轮询','https://discord.com/api/v9/channels/','1894820KwFZvn','../fanyi/fanyi.service','typeorm','绘图指令完成','../upload/upload.service','queryMessageList','__metadata','9cHLODF','rateLimits','https://discord.com/api/v9/interactions','开始请求用户','uploadFileFromUrl','本次放大图片的id:\x20','Not','\x20队列+1:\x20','开始请求变换图片\x20队列+1:\x20','绘画失败','extractContent','__param','findCurrentEnlargeImgResult','sendSmInteractions','max','saveChatLog','../chatLog/chatLog.entity','放大custom_id:\x20','1786012mKUaXs','findCurrentVariationImgResult','MjService','../../common/utils','mjApplicationId','DeductionKey','post','当前图片没有绘画信息、无法变体!','mjAuthorization','7iZLLTj','filter','mjNotSaveImg','pollForResult','秒请求一次、请合理使用！','axios:\x20','message','response','历史记录中不存在当前图片、请确认您放大的图片是否存在','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','baiduFanyiAppId','metadata','历史中存在当前图片、直接获取！','46576950cydByy','user','badwordsService','当前用户\x20','components','变换图片任务结束\x20队列-1:\x20','绘画任务开始','checkBadWords','mjProxy','map','axios\x20get:\x20'];_0x2b4a=function(){return _0x867a63;};return _0x2b4a();}const globalConfig_service_1=require('../globalConfig/globalConfig.service'),upload_service_1=require(_0x5951e4(0x20c)),common_1=require(_0x5951e4(0x190)),axios_1=require(_0x5951e4(0x1dc)),chatLog_service_1=require(_0x5951e4(0x188)),balance_constant_1=require(_0x5951e4(0x193)),utils_1=require(_0x5951e4(0x224)),chatLog_entity_1=require(_0x5951e4(0x21f)),typeorm_1=require(_0x5951e4(0x20a)),typeorm_2=require(_0x5951e4(0x1f9)),balance_entity_1=require(_0x5951e4(0x1be)),fanyi_service_1=require(_0x5951e4(0x209)),badwords_service_1=require(_0x5951e4(0x1b9));let MjService=class MjService{constructor(_0x5ee7c8,_0x42a845,_0x4f2c70,_0x32ea4b,_0x1a2954,_0x30b9ba,_0x383915){const _0x19b211=_0x5951e4;this['chatLogEntity']=_0x5ee7c8,this[_0x19b211(0x1aa)]=_0x42a845,this[_0x19b211(0x1bd)]=_0x4f2c70,this['chatLogService']=_0x32ea4b,this[_0x19b211(0x1da)]=_0x1a2954,this['fanyiService']=_0x30b9ba,this[_0x19b211(0x239)]=_0x383915,this[_0x19b211(0x210)]={},this['drawWorking']=[],this[_0x19b211(0x1fc)]=[],this['queueCount']=0x0,this[_0x19b211(0x200)]={};}async[_0x5951e4(0x1d6)](_0xb4f569){const _0x48263f=_0x5951e4,{jobId:_0x162881,prompt:_0x18e13a,startTime:_0x3b72cb,userId:_0xaa81d1}=_0xb4f569;return console[_0x48263f(0x185)](_0x48263f(0x23d),_0x48263f(0x184)),await new Promise(_0x54f9e0=>setTimeout(_0x54f9e0,0x1388)),{'a':0x1,'b':0x2};}async['draw'](_0x50e120,_0x237ad9){const _0x28bb4d=_0x5951e4;await this[_0x28bb4d(0x1ce)](_0x237ad9),await this[_0x28bb4d(0x239)][_0x28bb4d(0x23e)](_0x50e120[_0x28bb4d(0x1c8)],_0x237ad9['user']['id']);const _0x2b5db7=_0x50e120[_0x28bb4d(0x1c8)];let _0x2e4239=_0x50e120['prompt'];const {baiduFanyiAppId:_0x362dfb,baiduFanyiSecret:_0x1bf5b5}=await this['globalConfigService'][_0x28bb4d(0x1fd)]([_0x28bb4d(0x234),_0x28bb4d(0x1c4)]);_0x362dfb&&_0x1bf5b5&&(_0x2e4239=await this['fanyiService']['convertToEnglish'](_0x2b5db7));const _0x2f0e5e='['+(0x0,utils_1[_0x28bb4d(0x19b)])()+']',_0x31a641=_0x2f0e5e+'\x20'+_0x2e4239;console['log'](_0x28bb4d(0x1ac),_0x2f0e5e),console[_0x28bb4d(0x185)](_0x28bb4d(0x18f),_0x31a641);const _0x4e02c7=this['drawWorking'][_0x28bb4d(0x197)](_0x1f99c7=>_0x1f99c7[_0x28bb4d(0x19a)](_0x50e120[_0x28bb4d(0x1c8)]));if(_0x4e02c7)throw new common_1[(_0x28bb4d(0x1a1))](_0x28bb4d(0x1e5),common_1[_0x28bb4d(0x1cc)][_0x28bb4d(0x199)]);if(this[_0x28bb4d(0x1f0)]>=0x3)throw new common_1[(_0x28bb4d(0x1a1))](_0x28bb4d(0x1bc),common_1['HttpStatus']['BAD_REQUEST']);await this[_0x28bb4d(0x18a)](_0x237ad9),this[_0x28bb4d(0x1f0)]++,console[_0x28bb4d(0x185)](_0x28bb4d(0x212)+_0x237ad9[_0x28bb4d(0x238)]['id']+_0x28bb4d(0x216),this[_0x28bb4d(0x1f0)]);try{const _0x202a3d=await this[_0x28bb4d(0x1cd)][_0x28bb4d(0x197)]({'where':{'prompt':(0x0,typeorm_1[_0x28bb4d(0x196)])('%'+_0x31a641+'%')}}),_0x16d946=_0x202a3d[_0x28bb4d(0x240)](_0x523d01=>_0x523d01['message_id']);this[_0x28bb4d(0x1ad)][_0x28bb4d(0x18b)](_0x31a641);let _0x2bb7b0;const _0x248078=await this[_0x28bb4d(0x1d3)](_0x31a641,_0x16d946,_0x2f0e5e);_0x248078?(console[_0x28bb4d(0x185)](_0x28bb4d(0x236)),_0x2bb7b0=_0x248078):_0x2bb7b0=await this[_0x28bb4d(0x22d)](_0x31a641,_0x16d946,_0x2f0e5e);this[_0x28bb4d(0x1f0)]--,this[_0x28bb4d(0x1f0)]<0x0&&(this[_0x28bb4d(0x1f0)]=0x0),console[_0x28bb4d(0x185)](_0x28bb4d(0x1c6),this[_0x28bb4d(0x1f0)]);const {id:_0x1cc54a,content:_0x2ad6d8,channel_id:_0x178614,attachments:attachments=[],timestamp:_0x3d76a0}=_0x2bb7b0;if(!attachments['length']||!attachments[0x0][_0x28bb4d(0x1cf)])throw new common_1['HttpException'](_0x28bb4d(0x218),common_1[_0x28bb4d(0x1cc)][_0x28bb4d(0x199)]);const {filename:_0x4f7b6b,url:_0x2d1345,width:_0x6ebeee,height:_0x4c30af,size:_0x4f658f}=attachments[0x0];console[_0x28bb4d(0x185)](_0x28bb4d(0x1d8),_0x2d1345);const _0x2928ec=this[_0x28bb4d(0x1da)]['getConfigs']([_0x28bb4d(0x22c)]);let _0x29ea05='';(!Number(_0x2928ec)||Number(_0x2928ec)===0x0)&&(_0x29ea05=await this[_0x28bb4d(0x1bd)][_0x28bb4d(0x213)]({'filename':_0x4f7b6b,'url':_0x2d1345}),console['log']('存入图片完成:\x20',_0x29ea05));const _0x3a2d5c={'curIp':(0x0,utils_1[_0x28bb4d(0x1c3)])(_0x237ad9),'userId':_0x237ad9[_0x28bb4d(0x238)]['id'],'type':balance_constant_1[_0x28bb4d(0x226)][_0x28bb4d(0x19e)],'prompt':_0x31a641,'answer':_0x29ea05,'model':'mj','extend':this['removeEmoji'](JSON[_0x28bb4d(0x1fa)](_0x2bb7b0)),'message_id':_0x1cc54a,'variationId':_0x1cc54a,'upscaleId':_0x1cc54a,'group':0x1,'isSaveImg':!Number(_0x2928ec)||Number(_0x2928ec)===0x0,'fileInfo':JSON[_0x28bb4d(0x1fa)]({'width':_0x6ebeee,'height':_0x4c30af,'size':_0x4f658f,'filename':_0x4f7b6b,'cosUrl':_0x29ea05})};return await this['chatLogService'][_0x28bb4d(0x21e)](_0x3a2d5c),await this['deductBalance'](_0x237ad9),this[_0x28bb4d(0x1ad)]=this['drawWorking']['filter'](_0xae31e9=>_0xae31e9!==_0x50e120[_0x28bb4d(0x1c8)]),_0x29ea05;}catch(_0x23a87d){this[_0x28bb4d(0x1f0)]--,this[_0x28bb4d(0x1f0)]<0x0&&(this[_0x28bb4d(0x1f0)]=0x0),console[_0x28bb4d(0x185)]('绘制图片任务异常中断\x20队列-1:\x20',this[_0x28bb4d(0x1f0)]),this[_0x28bb4d(0x1ad)]=this[_0x28bb4d(0x1ad)][_0x28bb4d(0x22b)](_0x72c81d=>_0x72c81d!==_0x50e120[_0x28bb4d(0x1c8)]);throw new common_1[(_0x28bb4d(0x1a1))](_0x23a87d[_0x28bb4d(0x231)],common_1[_0x28bb4d(0x1cc)][_0x28bb4d(0x199)]);}}async[_0x5951e4(0x1f5)](_0x5463d8,_0x152a72){const _0x205521=_0x5951e4;if(this[_0x205521(0x1f0)]>=0x3)throw new common_1[(_0x205521(0x1a1))](_0x205521(0x1bc),common_1['HttpStatus'][_0x205521(0x199)]);this[_0x205521(0x1f0)]++,console[_0x205521(0x185)]('用户'+_0x152a72[_0x205521(0x238)]['id']+_0x205521(0x205),this[_0x205521(0x1f0)]);const {message_id:_0x3c8ac3,orderId:_0x3c780a}=_0x5463d8;try{const _0x745238=await this['chatLogEntity']['findOne']({'where':{'message_id':_0x3c8ac3}});if(!_0x745238)throw new common_1['HttpException'](_0x205521(0x232),common_1[_0x205521(0x1cc)][_0x205521(0x199)]);const _0x36e438=await this[_0x205521(0x1cd)]['findOne']({'where':{'upscaleId':_0x3c8ac3,'action':_0x205521(0x1b4),'orderId':_0x3c780a}});if(_0x36e438)throw new common_1[(_0x205521(0x1a1))](_0x205521(0x192),common_1[_0x205521(0x1cc)]['BAD_REQUEST']);const {prompt:_0x1a4905,extend:_0x122fca}=_0x745238;let _0x19cbed=null;try{_0x19cbed=JSON[_0x205521(0x1ea)](_0x122fca);}catch(_0xa7f9d2){_0x19cbed=[];}const {components:components=[]}=_0x19cbed;if(!components[_0x205521(0x1a5)])throw new common_1[(_0x205521(0x1a1))](_0x205521(0x1c5),common_1[_0x205521(0x1cc)][_0x205521(0x199)]);const _0x1e6ccf=components[0x0][_0x205521(0x23b)][_0x3c780a-0x1],{custom_id:_0x1845b1}=_0x1e6ccf;console[_0x205521(0x185)](_0x205521(0x220),_0x1845b1);const _0x231072={'message_id':_0x3c8ac3,'custom_id':_0x1845b1,'prompt':_0x1a4905,'orderId':_0x3c780a};await this['sendSmInteractions'](_0x231072),console[_0x205521(0x185)](_0x205521(0x1ed));const _0x1431b1=await this['chatLogEntity'][_0x205521(0x197)]({'where':{'prompt':(0x0,typeorm_1[_0x205521(0x196)])('%'+_0x1a4905+'%')}}),_0x37f4bb=_0x1431b1[_0x205521(0x240)](_0x202d00=>_0x202d00[_0x205521(0x1d0)]);console['log'](_0x205521(0x1f4),_0x37f4bb);const _0x26d568=await this[_0x205521(0x1e4)](_0x231072,_0x37f4bb);this[_0x205521(0x1f0)]--,this[_0x205521(0x1f0)]<0x0&&(this[_0x205521(0x1f0)]=0x0),console['log']('放大图片任务结束\x20队列-1:\x20',this[_0x205521(0x1f0)]);const {id:_0x19bc1b,content:_0x2edc67,channel_id:_0x2e90eb,attachments:attachments=[],timestamp:_0x294777}=_0x26d568;if(!attachments[_0x205521(0x1a5)]||!attachments[0x0][_0x205521(0x1cf)])throw new common_1[(_0x205521(0x1a1))](_0x205521(0x1e3),common_1[_0x205521(0x1cc)][_0x205521(0x199)]);const {filename:_0x45c036,url:_0x12dfc6,width:_0x43a6d9,height:_0x176426,size:_0x530c90}=attachments[0x0],_0x318c28=this[_0x205521(0x1da)][_0x205521(0x1fd)]([_0x205521(0x22c)]);let _0x46cbe9='';(!Number(_0x318c28)||Number(_0x318c28)===0x0)&&(_0x46cbe9=await this['uploadService'][_0x205521(0x213)]({'filename':_0x45c036,'url':_0x12dfc6}),console[_0x205521(0x185)]('存入图片完成:\x20',_0x46cbe9));const _0x18a6c0={'curIp':(0x0,utils_1[_0x205521(0x1c3)])(_0x152a72),'userId':_0x152a72['user']['id'],'type':balance_constant_1[_0x205521(0x226)][_0x205521(0x19e)],'prompt':_0x1a4905,'answer':_0x46cbe9,'model':'mj','extend':this[_0x205521(0x1f3)](JSON['stringify'](_0x26d568)),'message_id':_0x3c8ac3,'upscaleId':_0x19bc1b,'variationId':_0x19bc1b,'action':_0x205521(0x1b4),'orderId':_0x231072[_0x205521(0x1d2)],'isSaveImg':!Number(_0x318c28)||Number(_0x318c28)===0x0,'fileInfo':JSON[_0x205521(0x1fa)]({'width':_0x43a6d9,'height':_0x176426,'size':_0x530c90,'filename':_0x45c036,'cosUrl':_0x46cbe9})};return await this['chatLogService']['saveChatLog'](_0x18a6c0),_0x46cbe9;}catch(_0x2bda41){console['log'](_0x205521(0x1dd),_0x2bda41),this[_0x205521(0x1f0)]--,this[_0x205521(0x1f0)]<0x0&&(this['queueCount']=0x0),console[_0x205521(0x185)](_0x205521(0x195),this[_0x205521(0x1f0)]);throw new common_1[(_0x205521(0x1a1))](_0x2bda41[_0x205521(0x231)],common_1[_0x205521(0x1cc)][_0x205521(0x199)]);}}async[_0x5951e4(0x1f1)](_0x9d9a1,_0x44a396){const _0x39c849=_0x5951e4;if(this[_0x39c849(0x1f0)]>=0x3)throw new common_1[(_0x39c849(0x1a1))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x39c849(0x1cc)][_0x39c849(0x199)]);await this[_0x39c849(0x1ce)](_0x44a396),await this[_0x39c849(0x18a)](_0x44a396),this['queueCount']++,console[_0x39c849(0x185)]('用户'+_0x44a396[_0x39c849(0x238)]['id']+_0x39c849(0x217),this['queueCount']);const {message_id:_0x165871,orderId:_0x41fbb9}=_0x9d9a1;try{const _0x2d944f=await this['chatLogEntity'][_0x39c849(0x1d5)]({'where':{'message_id':_0x165871}});if(!_0x2d944f)throw new common_1[(_0x39c849(0x1a1))](_0x39c849(0x233),common_1['HttpStatus'][_0x39c849(0x199)]);const {prompt:_0x332671,extend:_0x59a65d}=_0x2d944f;let _0x13c96e=null;try{_0x13c96e=JSON['parse'](_0x59a65d);}catch(_0x4864b2){_0x13c96e=[];}const {components:components=[]}=_0x13c96e;if(!components['length'])throw new common_1[(_0x39c849(0x1a1))](_0x39c849(0x228),common_1[_0x39c849(0x1cc)][_0x39c849(0x199)]);const _0x1d3bf1=components[0x1]['components'][_0x41fbb9-0x1],{custom_id:_0x9130f7}=_0x1d3bf1,_0x30319f=await this[_0x39c849(0x1cd)][_0x39c849(0x197)]({'where':{'variationId':(0x0,typeorm_1[_0x39c849(0x215)])((0x0,typeorm_1[_0x39c849(0x1a7)])()),'prompt':(0x0,typeorm_1['Like'])('%'+_0x332671+'%')}}),_0x13534=_0x30319f[_0x39c849(0x240)](_0x591254=>_0x591254['variationId']),_0x3ce8c7={'message_id':_0x165871,'custom_id':_0x9130f7,'prompt':_0x332671,'orderId':_0x41fbb9};await this[_0x39c849(0x21c)](_0x3ce8c7);const _0x593c9f=await this[_0x39c849(0x1d7)](_0x3ce8c7,_0x13534);this[_0x39c849(0x1f0)]--,this['queueCount']<0x0&&(this[_0x39c849(0x1f0)]=0x0),console[_0x39c849(0x185)](_0x39c849(0x23c),this['queueCount']);const {id:_0x450996,content:_0x4c5a4f,channel_id:_0x48c7c3,attachments:attachments=[],timestamp:_0xb625}=_0x593c9f;if(!attachments[_0x39c849(0x1a5)]||!attachments[0x0][_0x39c849(0x1cf)])throw new common_1[(_0x39c849(0x1a1))](_0x39c849(0x1a9),common_1['HttpStatus'][_0x39c849(0x199)]);const {filename:_0x8dcc64,url:_0x5172dc,width:_0x12ced5,height:_0x465c38,size:_0x25e18c}=attachments[0x0],_0x2a9ccb=this[_0x39c849(0x1da)][_0x39c849(0x1fd)]([_0x39c849(0x22c)]);let _0x1622c2='';(!Number(_0x2a9ccb)||Number(_0x2a9ccb)===0x0)&&(_0x1622c2=await this['uploadService']['uploadFileFromUrl']({'filename':_0x8dcc64,'url':_0x5172dc}),console[_0x39c849(0x185)](_0x39c849(0x1af),_0x1622c2));const _0x1566e1={'curIp':(0x0,utils_1[_0x39c849(0x1c3)])(_0x44a396),'userId':_0x44a396[_0x39c849(0x238)]['id'],'type':balance_constant_1[_0x39c849(0x226)][_0x39c849(0x19e)],'prompt':_0x332671,'answer':_0x1622c2,'model':'mj','group':0x1,'extend':this[_0x39c849(0x1f3)](JSON[_0x39c849(0x1fa)](_0x593c9f)),'message_id':_0x450996,'upscaleId':_0x450996,'variationId':_0x450996,'action':_0x39c849(0x1b4),'orderId':_0x3ce8c7[_0x39c849(0x1d2)],'isSaveImg':!Number(_0x2a9ccb)||Number(_0x2a9ccb)===0x0,'fileInfo':JSON[_0x39c849(0x1fa)]({'width':_0x12ced5,'height':_0x465c38,'size':_0x25e18c,'filename':_0x8dcc64,'cosUrl':_0x1622c2})};return await this[_0x39c849(0x1d1)][_0x39c849(0x21e)](_0x1566e1),_0x1622c2;}catch(_0x15c717){console['log'](_0x39c849(0x1dd),_0x15c717),this[_0x39c849(0x1f0)]--,this[_0x39c849(0x1f0)]<0x0&&(this[_0x39c849(0x1f0)]=0x0),console[_0x39c849(0x185)](_0x39c849(0x1e2),this[_0x39c849(0x1f0)]);throw new common_1[(_0x39c849(0x1a1))](_0x15c717[_0x39c849(0x231)],common_1['HttpStatus'][_0x39c849(0x199)]);}}async[_0x5951e4(0x21c)](_0x3b0ec2){const _0x206a7c=_0x5951e4,{message_id:_0x19594b,custom_id:_0x382851}=_0x3b0ec2,{application_id:_0x192914,guild_id:_0x75a061,channel_id:_0x5b6d3c,session_id:_0x6e93ce,version:_0x58b5cc,id:_0x7f17f7,authorization:_0x281e40,mjProxy:_0x421867}=await this[_0x206a7c(0x1ec)](),_0x32d312=_0x421867==0x1?'http://172.247.48.137:8000/mj/draw':_0x206a7c(0x211),_0x5785ac={'authorization':_0x281e40},_0x424ef9={'type':0x3,'guild_id':_0x75a061,'channel_id':_0x5b6d3c,'message_flags':0x0,'message_id':_0x19594b,'application_id':_0x192914,'session_id':_0x6e93ce,'data':{'component_type':0x2,'custom_id':_0x382851}};try{await axios_1[_0x206a7c(0x187)][_0x206a7c(0x227)](_0x32d312,_0x424ef9,{'headers':_0x5785ac}),console[_0x206a7c(0x185)](_0x206a7c(0x20b));}catch(_0x15d067){console[_0x206a7c(0x185)](_0x206a7c(0x1dd),_0x15d067);throw new common_1[(_0x206a7c(0x1a1))](_0x206a7c(0x1de),common_1['HttpStatus'][_0x206a7c(0x199)]);}}async[_0x5951e4(0x1e4)](_0x2dff28,_0x4d7692){const _0x3b434a=_0x5951e4,{message_id:_0x5becae,custom_id:_0x1e3aa5,prompt:_0xeec73e,orderId:_0x4222e0}=_0x2dff28;let _0x1446f5=null,_0x59fc45=0x0;while(!_0x1446f5&&_0x59fc45<0xa){try{const _0x5e51c9=Date[_0x3b434a(0x19d)](),_0x542394=await this[_0x3b434a(0x20d)]();console[_0x3b434a(0x185)]('第\x20'+(_0x59fc45+0x1)+'\x20次开始查询\x20=>\x20当前查询结果：'+_0x542394[_0x3b434a(0x1a5)]);_0x542394&&_0x542394[_0x3b434a(0x1a5)]&&(_0x1446f5=await this[_0x3b434a(0x21b)](_0x542394,_0x2dff28,_0x4d7692));const _0x49e212=Date[_0x3b434a(0x19d)]()-_0x5e51c9,_0x54c5e1=0xbb8;await this[_0x3b434a(0x1a6)](Math['max'](_0x54c5e1-_0x49e212,0x0)),_0x59fc45++;}catch(_0x389d35){console[_0x3b434a(0x1eb)](_0x3b434a(0x1ee)+_0x389d35[_0x3b434a(0x230)]);}}return _0x1446f5;}async[_0x5951e4(0x1d7)](_0x37f469,_0x1e1d68){const _0x3e9eb4=_0x5951e4,{message_id:_0x1e86ac,custom_id:_0x2bcc85,prompt:_0x19e677,orderId:_0x2cbd16}=_0x37f469;console[_0x3e9eb4(0x185)](_0x3e9eb4(0x1ff));let _0x1d3d29=null,_0x4e61f1=0x0;while(!_0x1d3d29&&_0x4e61f1<0xa){try{console[_0x3e9eb4(0x185)]('第\x20'+(_0x4e61f1+0x1)+_0x3e9eb4(0x202));const _0xfc72a2=Date[_0x3e9eb4(0x19d)](),_0x563dae=await this[_0x3e9eb4(0x20d)]();_0x563dae&&_0x563dae['length']&&(_0x1d3d29=await this[_0x3e9eb4(0x222)](_0x563dae,_0x37f469,_0x1e1d68));const _0xb042ac=Date[_0x3e9eb4(0x19d)]()-_0xfc72a2,_0x400a36=0x1f40;await this[_0x3e9eb4(0x1a6)](Math[_0x3e9eb4(0x21d)](_0x400a36-_0xb042ac,0x0)),_0x4e61f1++;}catch(_0x544787){console[_0x3e9eb4(0x1eb)]('查询期间出现错误：'+_0x544787[_0x3e9eb4(0x230)]);}}if(!_0x1d3d29)throw new common_1[(_0x3e9eb4(0x1a1))](_0x3e9eb4(0x1a0),common_1[_0x3e9eb4(0x1cc)][_0x3e9eb4(0x199)]);return _0x1d3d29;}async[_0x5951e4(0x21b)](_0x259728,_0x44c3eb,_0x482015){const _0x259d9d=_0x5951e4,{message_id:_0x8b67a8,custom_id:_0x355009,prompt:_0x1b6797,orderId:_0x97639f}=_0x44c3eb,_0x4d82d0=_0x1b6797[_0x259d9d(0x1bb)](0x0,0xc);console[_0x259d9d(0x185)](_0x259d9d(0x214),_0x4d82d0);const _0x42b095=_0x259728[_0x259d9d(0x197)](_0x4c9742=>{const _0x3ab0ef=_0x259d9d,{content:_0x3f0e2a}=_0x4c9742;if(!this[_0x3ab0ef(0x219)](_0x3f0e2a))return![];const {prompt:_0x2b65c9,order:_0x18717f}=this['extractContent'](_0x3f0e2a);return _0x2b65c9[_0x3ab0ef(0x19a)](_0x4d82d0)&&_0x44c3eb[_0x3ab0ef(0x1d2)]===_0x18717f&&!_0x482015[_0x3ab0ef(0x19a)](_0x4c9742['id']);});return _0x42b095;}async[_0x5951e4(0x222)](_0x3ba22b,_0x11d561,_0x143f67){const _0x392d48=_0x5951e4,{message_id:_0x30c2d2,custom_id:_0x2f7999,prompt:_0x1a7951,orderId:_0x1636b0}=_0x11d561,_0x1ce367=_0x1a7951[_0x392d48(0x1bb)](0x0,0xc),_0x139e52=_0x3ba22b[_0x392d48(0x197)](_0x4834b1=>{const _0x433378=_0x392d48,{content:_0x267d3d}=_0x4834b1,_0x34e80e=_0x267d3d[_0x433378(0x1b2)](/\*\*(.+?)\*\*/),_0x164e7d=_0x34e80e?_0x34e80e[0x1]:'';if(!_0x164e7d)return![];return _0x164e7d[_0x433378(0x19a)](_0x1ce367)&&!_0x143f67[_0x433378(0x19a)](_0x4834b1['id']);});return _0x139e52;}async[_0x5951e4(0x1d3)](_0x181cbc,_0x47aec3,_0x29f733){const _0xf36194=_0x5951e4,_0x3d5b8b=await this[_0xf36194(0x20d)](),_0xa69053=await this[_0xf36194(0x1e7)](_0x3d5b8b,_0x29f733,_0x47aec3);if(_0xa69053)return console[_0xf36194(0x185)](_0xf36194(0x1df),_0xa69053),_0xa69053;const {application_id:_0x552033,guild_id:_0x4869e5,channel_id:_0x118f01,session_id:_0x39d70c,version:_0x15e129,id:_0x1ceac2,authorization:_0x20682c,mjProxy:_0x22732d}=await this[_0xf36194(0x1ec)](),_0x293ef9={'type':0x2,'application_id':_0x552033,'guild_id':_0x4869e5,'channel_id':_0x118f01,'session_id':_0x39d70c,'data':{'version':_0x15e129,'id':_0x1ceac2,'name':_0xf36194(0x1c9),'type':0x1,'options':[{'type':0x3,'name':_0xf36194(0x1c8),'value':_0x181cbc}],'attachments':[]}};try{const _0x1abf16=_0x22732d==0x1?_0xf36194(0x189):_0xf36194(0x211),_0x438473={'authorization':_0x20682c},_0x5267cd=await axios_1[_0xf36194(0x187)][_0xf36194(0x227)](_0x1abf16,_0x293ef9,{'headers':_0x438473});return console[_0xf36194(0x185)](_0xf36194(0x1c7),_0x5267cd[_0xf36194(0x242)]),![];}catch(_0x37152f){console[_0xf36194(0x185)](_0xf36194(0x22f),_0x37152f);throw new common_1[(_0xf36194(0x1a1))](_0xf36194(0x203),common_1[_0xf36194(0x1cc)][_0xf36194(0x199)]);}}async[_0x5951e4(0x22d)](_0x542230,_0x422742,_0x2679c9){const _0x25bb33=_0x5951e4;console[_0x25bb33(0x185)](_0x25bb33(0x206));const _0x3311b4=Date[_0x25bb33(0x19d)]();try{const _0x1799b1=0xd,_0x463413=0x2ee0,_0x425f42=0x1388,_0x1b790a=0x3c*0x3e8;let _0x1bb319=0x0,_0x4f3fbd=![],_0x5ae4f8=null;while(!_0x5ae4f8&&_0x1bb319<_0x1799b1){console[_0x25bb33(0x185)]('第\x20'+(_0x1bb319+0x1)+_0x25bb33(0x19f));Date[_0x25bb33(0x19d)]()-_0x3311b4>=_0x1b790a&&(_0x4f3fbd=!![]);await this[_0x25bb33(0x1a6)](_0x4f3fbd?_0x425f42:_0x463413);const _0xc6bed8=await this[_0x25bb33(0x20d)]();_0x5ae4f8=await this['findCurrentPromptResult'](_0xc6bed8,_0x2679c9,_0x422742),_0x1bb319++;}if(!_0x5ae4f8)throw new common_1[(_0x25bb33(0x1a1))](_0x25bb33(0x1a2),common_1['HttpStatus'][_0x25bb33(0x199)]);const _0x226366=Date[_0x25bb33(0x19d)]();return console['log'](_0x25bb33(0x1ba)+Math[_0x25bb33(0x1b7)]((_0x226366-_0x3311b4)/0x3e8)+'\x20S'),_0x5ae4f8;}catch(_0x4e0be5){console[_0x25bb33(0x1eb)](_0x4e0be5[_0x25bb33(0x230)]);throw new common_1[(_0x25bb33(0x1a1))]('网络连接失败，请稍后再试！',common_1['HttpStatus'][_0x25bb33(0x1ef)]);}}async[_0x5951e4(0x1e7)](_0x53bd8e,_0x47afdf,_0x388562){const _0x1ce922=_0x5951e4;if(!_0x53bd8e||!_0x53bd8e['length'])return;console['log'](_0x1ce922(0x1e9),_0x47afdf);const _0xdcbe86=_0x53bd8e[_0x1ce922(0x197)](_0x228cc6=>{const _0x8ab689=_0x1ce922,{attachments:attachments=[],content:_0x257a82,edited_timestamp:_0xc14d3e}=_0x228cc6;return _0x257a82[_0x8ab689(0x19a)](_0x47afdf)&&attachments[_0x8ab689(0x1a5)]>0x0&&!_0xc14d3e&&!_0x388562[_0x8ab689(0x19a)](_0x228cc6['id']);});return _0xdcbe86||null;}async[_0x5951e4(0x20d)](){const _0x1be3b1=_0x5951e4;try{const {application_id:_0x122645,guild_id:_0x31e836,channel_id:_0x18c469,session_id:_0x300e94,version:_0x4f3806,id:_0x5d315a,authorization:_0x2e5033,mjProxy:_0x5f05b0}=await this['getMjDefaultParams'](),_0x3bbb91=_0x5f05b0==0x1?_0x1be3b1(0x1e1)+_0x18c469:_0x1be3b1(0x207)+_0x18c469+_0x1be3b1(0x1c1),_0x19e734={'authorization':_0x2e5033},_0x19e8a9=await axios_1[_0x1be3b1(0x187)][_0x1be3b1(0x1fe)](_0x3bbb91,{'headers':_0x19e734});return _0x19e8a9[_0x1be3b1(0x242)];}catch(_0x3ea850){console[_0x1be3b1(0x185)](_0x1be3b1(0x241),_0x3ea850);throw new common_1['HttpException'](_0x1be3b1(0x1b3),common_1['HttpStatus'][_0x1be3b1(0x199)]);}}async[_0x5951e4(0x1a6)](_0x225253){return new Promise(_0x405c6c=>setTimeout(_0x405c6c,_0x225253));}[_0x5951e4(0x219)](_0x5b6448){const _0x24ab06=_0x5951e4,_0x1557f3=_0x5b6448[_0x24ab06(0x1b2)](/\*\*(.+?)\*\*/),_0x2aa0ad=_0x5b6448[_0x24ab06(0x1b2)](/- Image #(\d+)/);if(!_0x1557f3||!_0x2aa0ad)return null;const _0x592c1c=_0x1557f3[0x1],_0x4b994e=parseInt(_0x2aa0ad[0x1]);return{'prompt':_0x592c1c,'order':_0x4b994e};}async[_0x5951e4(0x1ec)](){const _0x3f3896=_0x5951e4,_0x4ce334=await this['globalConfigService'][_0x3f3896(0x1fd)]([_0x3f3896(0x1f7),'mjApplicationId','mjGuildId',_0x3f3896(0x1a8),_0x3f3896(0x1ae),'mjVersion',_0x3f3896(0x229),_0x3f3896(0x1db),_0x3f3896(0x23f)]),_0x539288={'application_id':_0x4ce334[_0x3f3896(0x225)],'guild_id':_0x4ce334[_0x3f3896(0x1d9)],'channel_id':_0x4ce334['mjChannelId'],'session_id':_0x4ce334[_0x3f3896(0x1ae)],'version':_0x4ce334[_0x3f3896(0x18d)],'id':_0x4ce334[_0x3f3896(0x1f7)],'authorization':_0x4ce334[_0x3f3896(0x229)],'mjRateLimit':_0x4ce334[_0x3f3896(0x1db)],'mjProxy':_0x4ce334['mjProxy']||0x0};return _0x539288;}[_0x5951e4(0x1f3)](_0x288833){const _0x450785=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x288833['replace'](_0x450785,'');}async[_0x5951e4(0x1ce)](_0x5bcd6e){const _0x4ad049=_0x5951e4,_0x3bd795=await this[_0x4ad049(0x1aa)][_0x4ad049(0x1d5)]({'where':{'userId':_0x5bcd6e['user']['id']}}),{id:_0x4320b8,balance:_0x434a88}=_0x3bd795;if(!_0x434a88||(_0x3bd795===null||_0x3bd795===void 0x0?void 0x0:_0x3bd795[_0x4ad049(0x1b5)])<0x1)throw new common_1[(_0x4ad049(0x1a1))](_0x4ad049(0x19c),common_1['HttpStatus'][_0x4ad049(0x199)]);}async['checkFree'](_0x2ab129){const _0x943b66=_0x5951e4,{id:_0x14d8f9,role:_0x3f6257}=_0x2ab129[_0x943b66(0x238)];!this[_0x943b66(0x200)][_0x14d8f9]?this[_0x943b66(0x200)][_0x14d8f9]=0x1:this['freeQueueUsers'][_0x14d8f9]=this['freeQueueUsers'][_0x14d8f9]+0x1,console['log'](_0x943b66(0x191)+_0x14d8f9+_0x943b66(0x198),this['freeQueueUsers'][_0x14d8f9]);}async[_0x5951e4(0x18a)](_0x2d90ee){const _0x58438e=_0x5951e4,{id:_0x4d2b5d,role:_0xebdc4a}=_0x2d90ee[_0x58438e(0x238)];if(['admin',_0x58438e(0x1bf)][_0x58438e(0x19a)](_0xebdc4a))return!![];const {mjRateLimit:_0x17b667}=await this[_0x58438e(0x1ec)]();if(this[_0x58438e(0x210)][_0x4d2b5d]){const _0xebded0=this[_0x58438e(0x210)][_0x4d2b5d];if(_0xebded0>Date[_0x58438e(0x19d)]()){console[_0x58438e(0x185)](_0x58438e(0x23a)+_0x4d2b5d+_0x58438e(0x1ca));throw new common_1[(_0x58438e(0x1a1))](_0x58438e(0x1a4)+_0x17b667+_0x58438e(0x22e),common_1[_0x58438e(0x1cc)][_0x58438e(0x199)]);}else this['rateLimits'][_0x4d2b5d]=Date[_0x58438e(0x19d)]()+Number(_0x17b667)*0x3e8;}else{const _0x5e5c42=Date[_0x58438e(0x19d)]();this[_0x58438e(0x210)][_0x4d2b5d]=_0x5e5c42+0x3e8*Number(_0x17b667);}}async[_0x5951e4(0x1ab)](_0x5bf261){const _0x3b2ad6=_0x5951e4;await this['balanceEntity'][_0x3b2ad6(0x1b8)]()[_0x3b2ad6(0x1f6)](balance_entity_1[_0x3b2ad6(0x1b0)])['set']({'balance':()=>'balance\x20-\x201'})[_0x3b2ad6(0x1b1)]('userId\x20=\x20:userId',{'userId':_0x5bf261['user']['id']})['execute']();}async[_0x5951e4(0x1c2)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x5951e4(0x1a3)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(chatLog_entity_1[_0x5951e4(0x186)])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(balance_entity_1[_0x5951e4(0x1b0)])),__metadata(_0x5951e4(0x1d4),[typeorm_1[_0x5951e4(0x1fb)],typeorm_1[_0x5951e4(0x1fb)],upload_service_1[_0x5951e4(0x18e)],chatLog_service_1[_0x5951e4(0x1f2)],globalConfig_service_1[_0x5951e4(0x201)],fanyi_service_1[_0x5951e4(0x204)],badwords_service_1[_0x5951e4(0x1c0)]])],MjService),exports[_0x5951e4(0x223)]=MjService;