'use strict';const _0xf4d3a4=_0x47b0;(function(_0x418148,_0x18ceff){const _0x3c7883=_0x47b0,_0x484de8=_0x418148();while(!![]){try{const _0xb5b9e8=parseInt(_0x3c7883(0x1cf))/0x1*(-parseInt(_0x3c7883(0x1b6))/0x2)+parseInt(_0x3c7883(0x1b3))/0x3*(parseInt(_0x3c7883(0x1ab))/0x4)+parseInt(_0x3c7883(0x1e5))/0x5*(-parseInt(_0x3c7883(0x184))/0x6)+-parseInt(_0x3c7883(0x182))/0x7+parseInt(_0x3c7883(0x212))/0x8+parseInt(_0x3c7883(0x213))/0x9*(-parseInt(_0x3c7883(0x1ce))/0xa)+-parseInt(_0x3c7883(0x1b1))/0xb*(-parseInt(_0x3c7883(0x1b2))/0xc);if(_0xb5b9e8===_0x18ceff)break;else _0x484de8['push'](_0x484de8['shift']());}catch(_0x44e107){_0x484de8['push'](_0x484de8['shift']());}}}(_0x14c3,0x40193));function _0x47b0(_0x2dd5bb,_0x1fe36c){const _0x14c381=_0x14c3();return _0x47b0=function(_0x47b094,_0xa15f64){_0x47b094=_0x47b094-0x180;let _0x3c2dff=_0x14c381[_0x47b094];return _0x3c2dff;},_0x47b0(_0x2dd5bb,_0x1fe36c);}var __decorate=this&&this[_0xf4d3a4(0x1c1)]||function(_0x36ebed,_0x2c7de3,_0x159835,_0x114a15){const _0x320ddb=_0xf4d3a4;var _0x4b8844=arguments['length'],_0xce223c=_0x4b8844<0x3?_0x2c7de3:_0x114a15===null?_0x114a15=Object['getOwnPropertyDescriptor'](_0x2c7de3,_0x159835):_0x114a15,_0x2769d5;if(typeof Reflect===_0x320ddb(0x221)&&typeof Reflect[_0x320ddb(0x1ca)]===_0x320ddb(0x22b))_0xce223c=Reflect[_0x320ddb(0x1ca)](_0x36ebed,_0x2c7de3,_0x159835,_0x114a15);else{for(var _0x5420ba=_0x36ebed[_0x320ddb(0x1b0)]-0x1;_0x5420ba>=0x0;_0x5420ba--)if(_0x2769d5=_0x36ebed[_0x5420ba])_0xce223c=(_0x4b8844<0x3?_0x2769d5(_0xce223c):_0x4b8844>0x3?_0x2769d5(_0x2c7de3,_0x159835,_0xce223c):_0x2769d5(_0x2c7de3,_0x159835))||_0xce223c;}return _0x4b8844>0x3&&_0xce223c&&Object[_0x320ddb(0x1bf)](_0x2c7de3,_0x159835,_0xce223c),_0xce223c;},__metadata=this&&this[_0xf4d3a4(0x1df)]||function(_0x32e155,_0x2c6144){const _0x2aa6cf=_0xf4d3a4;if(typeof Reflect===_0x2aa6cf(0x221)&&typeof Reflect['metadata']==='function')return Reflect[_0x2aa6cf(0x1d7)](_0x32e155,_0x2c6144);},__param=this&&this['__param']||function(_0x2885e2,_0x3f8357){return function(_0x1180c5,_0x7eea8){_0x3f8357(_0x1180c5,_0x7eea8,_0x2885e2);};};Object[_0xf4d3a4(0x1bf)](exports,_0xf4d3a4(0x1a7),{'value':!![]}),exports[_0xf4d3a4(0x21f)]=void 0x0;function _0x14c3(){const _0x54a1a7=['set','开始请求变换图片\x20队列+1:\x20','user','PAINT_TYPE','components','\x20队列+1:\x20','response','createQueryBuilder','chatLogService','IsNull','\x20次开始查询[变换图片]','substring','当前用户','存入图片完成:\x20','axios:\x20','balance\x20-\x201','checkAuth','filter','../userBalance/balance.entity','Not','历史记录中不存在当前图片、请确认您放大的图片是否存在','execute','getConfigs','mjSessionId','绘制图片任务结束\x20队列-1:\x20','HttpException','\x20请求过于频繁！','stringify','baiduFanyiAppId','fanyiService','prompt','max','variationSingleImg','parse','InjectRepository','INTERNAL_SERVER_ERROR','HttpStatus','FanyiService','https://discord.com/api/v9/channels/','findCurrentPromptResult','includes','match','../fanyi/fanyi.service','817824qYQqWC','45VXgCRH','map','sleep','freeQueueUsers','checkBadWords','deductBalance','randomId:\x20','../chatLog/chatLog.entity','mjservice','checkFree','error:\x20','pollForVariationResult','MjService','https://discord.com/api/v9/interactions','object','findOne','变换当前图片超时！','extractContent','find','findCurrentVariationImgResult','绘图指令完成','开始查询绘画结果轮询','开始请求放大图片\x20队列+1:\x20','globalConfigService','function','error','rateLimits','design:paramtypes','update','有历史信息之间返回:\x20','mjGuildId','Repository','enlarge','url','chatLogEntity','历史这些id已经被获取过了\x20不能拿了:\x20','now','../globalConfig/globalConfig.service','ChatLogService','3470887fUCGUc','本次绘图耗时:\x20','15282SGhQcY','绘画任务开始','http://172.247.48.137:8000/mj/draw','DeductionKey','userId\x20=\x20:userId','放大图片任务结束\x20队列-1:\x20','mjId','网络连接失败，请稍后再试！','放大custom_id:\x20','BAD_REQUEST','mjProxy','当前提示词已经在任务队列中了、请勿重复提交。。。','data','绘制图片任务异常中断\x20队列-1:\x20','mjVersion','../upload/upload.service','orderId','mjAuthorization','查询期间出现错误：','findCurrentEnlargeImgResult','post','BadwordsService','checkRateLimit','prompt\x20-------->\x20\x20','mjDraw','removeEmoji','绘画失败','查询绘制结果失败...','变换图片任务结束\x20队列-1:\x20','uploadService','message_id','typeorm','由于速率限制、当前普通用户限制为','放大单张图片请求失败...','../badwords/badwords.service','__esModule','default','axios','axios\x20get:\x20','189404hVhcYE','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','draw','发送绘画指令结果:\x20','length','44tGYXdj','3008904LNRSxN','33NKTyIQ','@nestjs/typeorm','当前图片没有绘画信息、无法放大!','197836qxKCeI','replace','saveChatLog','秒请求一次、请合理使用！','enlargeWorking','mjApplicationId','message','/messages?limit=50','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','defineProperty','../chatLog/chatLog.service','__decorate','sendSmInteractions','baiduFanyiSecret','绘画超时，请稍后再试！','push','getMjDefaultParams','Like','getClientIp','本次比对的随机ID:\x20','decorate','imagine','mjNotSaveImg','\x20次开始查询\x20=>\x20当前查询结果：','251210ZkzNOF','4eacnUe','queueCount','pollForResult','super','您当前暂无MJ绘画余额！！！','balanceEntity','badwordsService','variationId','metadata','floor','drawWorking','balance','放大图片任务异常中断\x20队列-1:\x20','convertToEnglish','当前用户\x20','queryMessageList','__metadata','放大当前图片失败','log','当前图片已经放大过了、请勿重复放大!','GlobalConfigService','http://172.247.48.137:8000/mj/list?channel_id=','680AaLfYd','pollForUpscaleResult'];_0x14c3=function(){return _0x54a1a7;};return _0x14c3();}const globalConfig_service_1=require(_0xf4d3a4(0x180)),upload_service_1=require(_0xf4d3a4(0x193)),common_1=require('@nestjs/common'),axios_1=require(_0xf4d3a4(0x1a9)),chatLog_service_1=require(_0xf4d3a4(0x1c0)),balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require('../../common/utils'),chatLog_entity_1=require(_0xf4d3a4(0x21a)),typeorm_1=require(_0xf4d3a4(0x1a3)),typeorm_2=require(_0xf4d3a4(0x1b4)),balance_entity_1=require(_0xf4d3a4(0x1f9)),fanyi_service_1=require(_0xf4d3a4(0x211)),badwords_service_1=require(_0xf4d3a4(0x1a6));let MjService=class MjService{constructor(_0xf141c5,_0x4d5dbd,_0x1b8117,_0x3a7a02,_0x6fc6a7,_0x52c062,_0x2b1732){const _0x483bdd=_0xf4d3a4;this[_0x483bdd(0x235)]=_0xf141c5,this[_0x483bdd(0x1d4)]=_0x4d5dbd,this[_0x483bdd(0x1a1)]=_0x1b8117,this[_0x483bdd(0x1ef)]=_0x3a7a02,this['globalConfigService']=_0x6fc6a7,this[_0x483bdd(0x204)]=_0x52c062,this[_0x483bdd(0x1d5)]=_0x2b1732,this['rateLimits']={},this['drawWorking']=[],this[_0x483bdd(0x1ba)]=[],this[_0x483bdd(0x1d0)]=0x0,this[_0x483bdd(0x216)]={};}async[_0xf4d3a4(0x19c)](_0x1bce92){const _0x287ead=_0xf4d3a4,{jobId:_0x3e6852,prompt:_0x3fbce3,startTime:_0x9c5510,userId:_0x39deca}=_0x1bce92;return console[_0x287ead(0x1e1)](_0x287ead(0x185),_0x287ead(0x21b)),await new Promise(_0x23c511=>setTimeout(_0x23c511,0x1388)),{'a':0x1,'b':0x2};}async[_0xf4d3a4(0x1ae)](_0x57b716,_0x3545d1){const _0x4a4ce4=_0xf4d3a4;await this[_0x4a4ce4(0x1f7)](_0x3545d1),await this[_0x4a4ce4(0x1d5)][_0x4a4ce4(0x217)](_0x57b716[_0x4a4ce4(0x205)],_0x3545d1[_0x4a4ce4(0x1e9)]['id']);const _0x138c08=_0x57b716[_0x4a4ce4(0x205)];let _0x174a72=_0x57b716[_0x4a4ce4(0x205)];const {baiduFanyiAppId:_0x2186bc,baiduFanyiSecret:_0x768dea}=await this[_0x4a4ce4(0x22a)]['getConfigs']([_0x4a4ce4(0x203),_0x4a4ce4(0x1c3)]);_0x2186bc&&_0x768dea&&(_0x174a72=await this[_0x4a4ce4(0x204)][_0x4a4ce4(0x1dc)](_0x138c08));const _0x24f8bf='['+(0x0,utils_1['createRandomUid'])()+']',_0x54788b=_0x24f8bf+'\x20'+_0x174a72;console[_0x4a4ce4(0x1e1)](_0x4a4ce4(0x219),_0x24f8bf),console[_0x4a4ce4(0x1e1)](_0x4a4ce4(0x19b),_0x54788b);const _0x164c59=this['drawWorking'][_0x4a4ce4(0x225)](_0x4b35a4=>_0x4b35a4[_0x4a4ce4(0x20f)](_0x57b716['prompt']));if(_0x164c59)throw new common_1['HttpException'](_0x4a4ce4(0x18f),common_1[_0x4a4ce4(0x20b)][_0x4a4ce4(0x18d)]);if(this['queueCount']>=0x3)throw new common_1[(_0x4a4ce4(0x200))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1['HttpStatus'][_0x4a4ce4(0x18d)]);await this[_0x4a4ce4(0x19a)](_0x3545d1),this[_0x4a4ce4(0x1d0)]++,console[_0x4a4ce4(0x1e1)]('开始请求用户'+_0x3545d1['user']['id']+_0x4a4ce4(0x1ec),this[_0x4a4ce4(0x1d0)]);try{const _0x59c78f=await this[_0x4a4ce4(0x235)][_0x4a4ce4(0x225)]({'where':{'prompt':(0x0,typeorm_1[_0x4a4ce4(0x1c7)])('%'+_0x54788b+'%')}}),_0x4b9ca7=_0x59c78f[_0x4a4ce4(0x214)](_0x4754e9=>_0x4754e9[_0x4a4ce4(0x1a2)]);this[_0x4a4ce4(0x1d9)][_0x4a4ce4(0x1c5)](_0x54788b);let _0x4d5f74;const _0x1e2658=await this['sendDrawInteractions'](_0x54788b,_0x4b9ca7,_0x24f8bf);_0x1e2658?(console[_0x4a4ce4(0x1e1)]('历史中存在当前图片、直接获取！'),_0x4d5f74=_0x1e2658):_0x4d5f74=await this[_0x4a4ce4(0x1d1)](_0x54788b,_0x4b9ca7,_0x24f8bf);this[_0x4a4ce4(0x1d0)]--,this[_0x4a4ce4(0x1d0)]<0x0&&(this[_0x4a4ce4(0x1d0)]=0x0),console[_0x4a4ce4(0x1e1)](_0x4a4ce4(0x1ff),this[_0x4a4ce4(0x1d0)]);const {id:_0x4ea834,content:_0x45b020,channel_id:_0x35235d,attachments:attachments=[],timestamp:_0xbc39c}=_0x4d5f74;if(!attachments['length']||!attachments[0x0][_0x4a4ce4(0x234)])throw new common_1[(_0x4a4ce4(0x200))](_0x4a4ce4(0x19e),common_1[_0x4a4ce4(0x20b)][_0x4a4ce4(0x18d)]);const {filename:_0x2f1743,url:_0x3c2cff,width:_0x480891,height:_0x10f4eb,size:_0x39f185}=attachments[0x0];console['log']('拿到了远程地址:\x20',_0x3c2cff);const _0x544472=this[_0x4a4ce4(0x22a)]['getConfigs']([_0x4a4ce4(0x1cc)]);let _0x5dd3dd='';(!Number(_0x544472)||Number(_0x544472)===0x0)&&(_0x5dd3dd=await this[_0x4a4ce4(0x1a1)]['uploadFileFromUrl']({'filename':_0x2f1743,'url':_0x3c2cff}),console[_0x4a4ce4(0x1e1)](_0x4a4ce4(0x1f4),_0x5dd3dd));const _0x4ae3ae={'curIp':(0x0,utils_1[_0x4a4ce4(0x1c8)])(_0x3545d1),'userId':_0x3545d1[_0x4a4ce4(0x1e9)]['id'],'type':balance_constant_1[_0x4a4ce4(0x187)][_0x4a4ce4(0x1ea)],'prompt':_0x54788b,'answer':_0x5dd3dd,'model':'mj','extend':this[_0x4a4ce4(0x19d)](JSON[_0x4a4ce4(0x202)](_0x4d5f74)),'message_id':_0x4ea834,'variationId':_0x4ea834,'upscaleId':_0x4ea834,'group':0x1,'isSaveImg':!Number(_0x544472)||Number(_0x544472)===0x0,'fileInfo':JSON[_0x4a4ce4(0x202)]({'width':_0x480891,'height':_0x10f4eb,'size':_0x39f185,'filename':_0x2f1743,'cosUrl':_0x5dd3dd})};return await this[_0x4a4ce4(0x1ef)][_0x4a4ce4(0x1b8)](_0x4ae3ae),await this['deductBalance'](_0x3545d1),this['drawWorking']=this[_0x4a4ce4(0x1d9)][_0x4a4ce4(0x1f8)](_0x14c9ad=>_0x14c9ad!==_0x57b716[_0x4a4ce4(0x205)]),_0x5dd3dd;}catch(_0xa251e6){this['queueCount']--,this['queueCount']<0x0&&(this[_0x4a4ce4(0x1d0)]=0x0),console[_0x4a4ce4(0x1e1)](_0x4a4ce4(0x191),this[_0x4a4ce4(0x1d0)]),this['drawWorking']=this[_0x4a4ce4(0x1d9)][_0x4a4ce4(0x1f8)](_0x1cc39f=>_0x1cc39f!==_0x57b716[_0x4a4ce4(0x205)]);throw new common_1[(_0x4a4ce4(0x200))](_0xa251e6['response'],common_1[_0x4a4ce4(0x20b)][_0x4a4ce4(0x18d)]);}}async['upscaleSingleImg'](_0x1bbedb,_0x2d5f17){const _0x28fda7=_0xf4d3a4;if(this[_0x28fda7(0x1d0)]>=0x3)throw new common_1[(_0x28fda7(0x200))](_0x28fda7(0x1ad),common_1['HttpStatus'][_0x28fda7(0x18d)]);this['queueCount']++,console[_0x28fda7(0x1e1)]('用户'+_0x2d5f17[_0x28fda7(0x1e9)]['id']+_0x28fda7(0x229),this[_0x28fda7(0x1d0)]);const {message_id:_0x46396a,orderId:_0x342792}=_0x1bbedb;try{const _0x59d3a8=await this['chatLogEntity'][_0x28fda7(0x222)]({'where':{'message_id':_0x46396a}});if(!_0x59d3a8)throw new common_1['HttpException'](_0x28fda7(0x1fb),common_1[_0x28fda7(0x20b)]['BAD_REQUEST']);const _0x42ed65=await this[_0x28fda7(0x235)][_0x28fda7(0x222)]({'where':{'upscaleId':_0x46396a,'action':_0x28fda7(0x233),'orderId':_0x342792}});if(_0x42ed65)throw new common_1['HttpException'](_0x28fda7(0x1e2),common_1[_0x28fda7(0x20b)]['BAD_REQUEST']);const {prompt:_0x479151,extend:_0x26c943}=_0x59d3a8;let _0x1d44e2=null;try{_0x1d44e2=JSON['parse'](_0x26c943);}catch(_0x3d3571){_0x1d44e2=[];}const {components:components=[]}=_0x1d44e2;if(!components[_0x28fda7(0x1b0)])throw new common_1[(_0x28fda7(0x200))](_0x28fda7(0x1b5),common_1[_0x28fda7(0x20b)][_0x28fda7(0x18d)]);const _0x48ea60=components[0x0][_0x28fda7(0x1eb)][_0x342792-0x1],{custom_id:_0x5aafdc}=_0x48ea60;console[_0x28fda7(0x1e1)](_0x28fda7(0x18c),_0x5aafdc);const _0x1a33da={'message_id':_0x46396a,'custom_id':_0x5aafdc,'prompt':_0x479151,'orderId':_0x342792};await this[_0x28fda7(0x1c2)](_0x1a33da),console[_0x28fda7(0x1e1)]('发送放大指令成功');const _0x61a235=await this[_0x28fda7(0x235)][_0x28fda7(0x225)]({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0x479151+'%')}}),_0x53678a=_0x61a235[_0x28fda7(0x214)](_0x477369=>_0x477369['message_id']);console[_0x28fda7(0x1e1)](_0x28fda7(0x236),_0x53678a);const _0x16c947=await this[_0x28fda7(0x1e6)](_0x1a33da,_0x53678a);this[_0x28fda7(0x1d0)]--,this[_0x28fda7(0x1d0)]<0x0&&(this[_0x28fda7(0x1d0)]=0x0),console[_0x28fda7(0x1e1)](_0x28fda7(0x189),this['queueCount']);const {id:_0x16c74d,content:_0x32b2ac,channel_id:_0x4bedc9,attachments:attachments=[],timestamp:_0x58330d}=_0x16c947;if(!attachments[_0x28fda7(0x1b0)]||!attachments[0x0][_0x28fda7(0x234)])throw new common_1[(_0x28fda7(0x200))](_0x28fda7(0x1e0),common_1[_0x28fda7(0x20b)]['BAD_REQUEST']);const {filename:_0x4818b7,url:_0x5d43ee,width:_0x3c5b8b,height:_0x38f5c9,size:_0x3e270f}=attachments[0x0],_0x1b6139=this['globalConfigService'][_0x28fda7(0x1fd)](['mjNotSaveImg']);let _0x27254f='';(!Number(_0x1b6139)||Number(_0x1b6139)===0x0)&&(_0x27254f=await this['uploadService']['uploadFileFromUrl']({'filename':_0x4818b7,'url':_0x5d43ee}),console[_0x28fda7(0x1e1)]('存入图片完成:\x20',_0x27254f));const _0x474835={'curIp':(0x0,utils_1[_0x28fda7(0x1c8)])(_0x2d5f17),'userId':_0x2d5f17['user']['id'],'type':balance_constant_1[_0x28fda7(0x187)][_0x28fda7(0x1ea)],'prompt':_0x479151,'answer':_0x27254f,'model':'mj','extend':this[_0x28fda7(0x19d)](JSON[_0x28fda7(0x202)](_0x16c947)),'message_id':_0x46396a,'upscaleId':_0x16c74d,'variationId':_0x16c74d,'action':_0x28fda7(0x233),'orderId':_0x1a33da[_0x28fda7(0x194)],'isSaveImg':!Number(_0x1b6139)||Number(_0x1b6139)===0x0,'fileInfo':JSON[_0x28fda7(0x202)]({'width':_0x3c5b8b,'height':_0x38f5c9,'size':_0x3e270f,'filename':_0x4818b7,'cosUrl':_0x27254f})};return await this['chatLogService']['saveChatLog'](_0x474835),_0x27254f;}catch(_0x51b476){console[_0x28fda7(0x1e1)](_0x28fda7(0x21d),_0x51b476),this[_0x28fda7(0x1d0)]--,this['queueCount']<0x0&&(this[_0x28fda7(0x1d0)]=0x0),console[_0x28fda7(0x1e1)](_0x28fda7(0x1db),this[_0x28fda7(0x1d0)]);throw new common_1['HttpException'](_0x51b476[_0x28fda7(0x1ed)],common_1['HttpStatus'][_0x28fda7(0x18d)]);}}async[_0xf4d3a4(0x207)](_0xb4d6bb,_0xcb1bda){const _0x2e60dd=_0xf4d3a4;if(this[_0x2e60dd(0x1d0)]>=0x3)throw new common_1['HttpException'](_0x2e60dd(0x1ad),common_1['HttpStatus'][_0x2e60dd(0x18d)]);await this[_0x2e60dd(0x1f7)](_0xcb1bda),await this[_0x2e60dd(0x19a)](_0xcb1bda),this[_0x2e60dd(0x1d0)]++,console['log']('用户'+_0xcb1bda[_0x2e60dd(0x1e9)]['id']+_0x2e60dd(0x1e8),this[_0x2e60dd(0x1d0)]);const {message_id:_0x224045,orderId:_0x9d0b5}=_0xb4d6bb;try{const _0x5765a3=await this[_0x2e60dd(0x235)][_0x2e60dd(0x222)]({'where':{'message_id':_0x224045}});if(!_0x5765a3)throw new common_1[(_0x2e60dd(0x200))](_0x2e60dd(0x1ac),common_1[_0x2e60dd(0x20b)][_0x2e60dd(0x18d)]);const {prompt:_0x33195d,extend:_0x3f15cc}=_0x5765a3;let _0x42e6e6=null;try{_0x42e6e6=JSON[_0x2e60dd(0x208)](_0x3f15cc);}catch(_0x2c6d23){_0x42e6e6=[];}const {components:components=[]}=_0x42e6e6;if(!components[_0x2e60dd(0x1b0)])throw new common_1[(_0x2e60dd(0x200))]('当前图片没有绘画信息、无法变体!',common_1[_0x2e60dd(0x20b)]['BAD_REQUEST']);const _0x56da83=components[0x1][_0x2e60dd(0x1eb)][_0x9d0b5-0x1],{custom_id:_0x4756cc}=_0x56da83,_0x230bc3=await this['chatLogEntity']['find']({'where':{'variationId':(0x0,typeorm_1[_0x2e60dd(0x1fa)])((0x0,typeorm_1[_0x2e60dd(0x1f0)])()),'prompt':(0x0,typeorm_1[_0x2e60dd(0x1c7)])('%'+_0x33195d+'%')}}),_0xce7262=_0x230bc3['map'](_0xb2093d=>_0xb2093d[_0x2e60dd(0x1d6)]),_0x16cbb7={'message_id':_0x224045,'custom_id':_0x4756cc,'prompt':_0x33195d,'orderId':_0x9d0b5};await this[_0x2e60dd(0x1c2)](_0x16cbb7);const _0x386fdc=await this[_0x2e60dd(0x21e)](_0x16cbb7,_0xce7262);this[_0x2e60dd(0x1d0)]--,this[_0x2e60dd(0x1d0)]<0x0&&(this[_0x2e60dd(0x1d0)]=0x0),console[_0x2e60dd(0x1e1)](_0x2e60dd(0x1a0),this[_0x2e60dd(0x1d0)]);const {id:_0x1cdb6c,content:_0x39fe35,channel_id:_0x32ad35,attachments:attachments=[],timestamp:_0x32240e}=_0x386fdc;if(!attachments['length']||!attachments[0x0]['url'])throw new common_1['HttpException']('变换当前图片失败',common_1['HttpStatus'][_0x2e60dd(0x18d)]);const {filename:_0x23260c,url:_0x2d9904,width:_0x46e931,height:_0x1c562c,size:_0x37374b}=attachments[0x0],_0x11de69=this[_0x2e60dd(0x22a)][_0x2e60dd(0x1fd)]([_0x2e60dd(0x1cc)]);let _0x39a9a5='';(!Number(_0x11de69)||Number(_0x11de69)===0x0)&&(_0x39a9a5=await this[_0x2e60dd(0x1a1)]['uploadFileFromUrl']({'filename':_0x23260c,'url':_0x2d9904}),console[_0x2e60dd(0x1e1)](_0x2e60dd(0x1f4),_0x39a9a5));const _0x3506f9={'curIp':(0x0,utils_1[_0x2e60dd(0x1c8)])(_0xcb1bda),'userId':_0xcb1bda[_0x2e60dd(0x1e9)]['id'],'type':balance_constant_1[_0x2e60dd(0x187)][_0x2e60dd(0x1ea)],'prompt':_0x33195d,'answer':_0x39a9a5,'model':'mj','group':0x1,'extend':this['removeEmoji'](JSON['stringify'](_0x386fdc)),'message_id':_0x1cdb6c,'upscaleId':_0x1cdb6c,'variationId':_0x1cdb6c,'action':_0x2e60dd(0x233),'orderId':_0x16cbb7[_0x2e60dd(0x194)],'isSaveImg':!Number(_0x11de69)||Number(_0x11de69)===0x0,'fileInfo':JSON['stringify']({'width':_0x46e931,'height':_0x1c562c,'size':_0x37374b,'filename':_0x23260c,'cosUrl':_0x39a9a5})};return await this[_0x2e60dd(0x1ef)]['saveChatLog'](_0x3506f9),_0x39a9a5;}catch(_0xc920fb){console['log'](_0x2e60dd(0x21d),_0xc920fb),this['queueCount']--,this['queueCount']<0x0&&(this[_0x2e60dd(0x1d0)]=0x0),console['log']('变化图片任务异常中断\x20队列-1:\x20',this[_0x2e60dd(0x1d0)]);throw new common_1[(_0x2e60dd(0x200))](_0xc920fb['response'],common_1['HttpStatus'][_0x2e60dd(0x18d)]);}}async[_0xf4d3a4(0x1c2)](_0x19a8c8){const _0x350562=_0xf4d3a4,{message_id:_0x2e6472,custom_id:_0x521247}=_0x19a8c8,{application_id:_0x222baa,guild_id:_0x4e6810,channel_id:_0x33bb32,session_id:_0xfd75d5,version:_0x514a81,id:_0x5f2782,authorization:_0x586f26,mjProxy:_0x4b15d0}=await this[_0x350562(0x1c6)](),_0x33e411=_0x4b15d0==0x1?'http://172.247.48.137:8000/mj/draw':_0x350562(0x220),_0x17bc7f={'authorization':_0x586f26},_0x4c25ff={'type':0x3,'guild_id':_0x4e6810,'channel_id':_0x33bb32,'message_flags':0x0,'message_id':_0x2e6472,'application_id':_0x222baa,'session_id':_0xfd75d5,'data':{'component_type':0x2,'custom_id':_0x521247}};try{await axios_1['default']['post'](_0x33e411,_0x4c25ff,{'headers':_0x17bc7f}),console[_0x350562(0x1e1)](_0x350562(0x227));}catch(_0x9e71e1){console[_0x350562(0x1e1)](_0x350562(0x21d),_0x9e71e1);throw new common_1['HttpException'](_0x350562(0x1a5),common_1['HttpStatus'][_0x350562(0x18d)]);}}async[_0xf4d3a4(0x1e6)](_0x1b5184,_0x4f4dc5){const _0x151c0d=_0xf4d3a4,{message_id:_0x4cd6e2,custom_id:_0x12ad8d,prompt:_0xb295b6,orderId:_0x4b79a0}=_0x1b5184;let _0x4ead99=null,_0x22052b=0x0;while(!_0x4ead99&&_0x22052b<0xa){try{const _0x281674=Date[_0x151c0d(0x237)](),_0x430e6c=await this[_0x151c0d(0x1de)]();console['log']('第\x20'+(_0x22052b+0x1)+_0x151c0d(0x1cd)+_0x430e6c[_0x151c0d(0x1b0)]);_0x430e6c&&_0x430e6c[_0x151c0d(0x1b0)]&&(_0x4ead99=await this[_0x151c0d(0x197)](_0x430e6c,_0x1b5184,_0x4f4dc5));const _0x1b3e89=Date[_0x151c0d(0x237)]()-_0x281674,_0x441fac=0xbb8;await this['sleep'](Math['max'](_0x441fac-_0x1b3e89,0x0)),_0x22052b++;}catch(_0x33beb0){console[_0x151c0d(0x22c)](_0x151c0d(0x196)+_0x33beb0['message']);}}return _0x4ead99;}async['pollForVariationResult'](_0x38d14b,_0x3d8ede){const _0x3dad77=_0xf4d3a4,{message_id:_0x2a6cf4,custom_id:_0x3e4900,prompt:_0x39c5e7,orderId:_0x550575}=_0x38d14b;console[_0x3dad77(0x1e1)]('开始轮询单张变换图片结果');let _0x3d75f3=null,_0x163873=0x0;while(!_0x3d75f3&&_0x163873<0xa){try{console[_0x3dad77(0x1e1)]('第\x20'+(_0x163873+0x1)+_0x3dad77(0x1f1));const _0x121d5e=Date[_0x3dad77(0x237)](),_0x2f079c=await this[_0x3dad77(0x1de)]();_0x2f079c&&_0x2f079c[_0x3dad77(0x1b0)]&&(_0x3d75f3=await this[_0x3dad77(0x226)](_0x2f079c,_0x38d14b,_0x3d8ede));const _0x559ddd=Date[_0x3dad77(0x237)]()-_0x121d5e,_0x220308=0x1f40;await this[_0x3dad77(0x215)](Math[_0x3dad77(0x206)](_0x220308-_0x559ddd,0x0)),_0x163873++;}catch(_0x448376){console[_0x3dad77(0x22c)](_0x3dad77(0x196)+_0x448376[_0x3dad77(0x1bc)]);}}if(!_0x3d75f3)throw new common_1['HttpException'](_0x3dad77(0x223),common_1['HttpStatus']['BAD_REQUEST']);return _0x3d75f3;}async[_0xf4d3a4(0x197)](_0x8e198f,_0x1dfba2,_0x5eba9c){const _0x82ba0c=_0xf4d3a4,{message_id:_0x53c388,custom_id:_0x2dd30a,prompt:_0x2a510e,orderId:_0x1b377d}=_0x1dfba2,_0x1554fc=_0x2a510e['substring'](0x0,0xc);console[_0x82ba0c(0x1e1)]('本次放大图片的id:\x20',_0x1554fc);const _0x3fbb5c=_0x8e198f[_0x82ba0c(0x225)](_0x182be1=>{const _0xeedf5b=_0x82ba0c,{content:_0x2426d0}=_0x182be1;if(!this[_0xeedf5b(0x224)](_0x2426d0))return![];const {prompt:_0x10e2dd,order:_0x5f12f9}=this[_0xeedf5b(0x224)](_0x2426d0);return _0x10e2dd['includes'](_0x1554fc)&&_0x1dfba2[_0xeedf5b(0x194)]===_0x5f12f9&&!_0x5eba9c[_0xeedf5b(0x20f)](_0x182be1['id']);});return _0x3fbb5c;}async[_0xf4d3a4(0x226)](_0x39d97e,_0x20387f,_0x166f14){const _0xcb5af9=_0xf4d3a4,{message_id:_0xa6c186,custom_id:_0x10ec41,prompt:_0x1eb3f8,orderId:_0x1af9c0}=_0x20387f,_0x1cc24b=_0x1eb3f8[_0xcb5af9(0x1f2)](0x0,0xc),_0x28f994=_0x39d97e['find'](_0x5a06cb=>{const _0x25dbf9=_0xcb5af9,{content:_0x362a51}=_0x5a06cb,_0x50a40d=_0x362a51[_0x25dbf9(0x210)](/\*\*(.+?)\*\*/),_0x39d32d=_0x50a40d?_0x50a40d[0x1]:'';if(!_0x39d32d)return![];return _0x39d32d[_0x25dbf9(0x20f)](_0x1cc24b)&&!_0x166f14[_0x25dbf9(0x20f)](_0x5a06cb['id']);});return _0x28f994;}async['sendDrawInteractions'](_0x10dd9e,_0x3fb8f3,_0x7c4fae){const _0x4feb9c=_0xf4d3a4,_0x3d6dfe=await this[_0x4feb9c(0x1de)](),_0x371083=await this[_0x4feb9c(0x20e)](_0x3d6dfe,_0x7c4fae,_0x3fb8f3);if(_0x371083)return console['log'](_0x4feb9c(0x230),_0x371083),_0x371083;const {application_id:_0x3450ff,guild_id:_0xe8c2f1,channel_id:_0x20e9a5,session_id:_0x3449ee,version:_0x3cb19b,id:_0x17e051,authorization:_0x1713c2,mjProxy:_0x150821}=await this[_0x4feb9c(0x1c6)](),_0x47cfb6={'type':0x2,'application_id':_0x3450ff,'guild_id':_0xe8c2f1,'channel_id':_0x20e9a5,'session_id':_0x3449ee,'data':{'version':_0x3cb19b,'id':_0x17e051,'name':_0x4feb9c(0x1cb),'type':0x1,'options':[{'type':0x3,'name':_0x4feb9c(0x205),'value':_0x10dd9e}],'attachments':[]}};try{const _0x2507fe=_0x150821==0x1?_0x4feb9c(0x186):'https://discord.com/api/v9/interactions',_0xf41611={'authorization':_0x1713c2},_0x499533=await axios_1[_0x4feb9c(0x1a8)][_0x4feb9c(0x198)](_0x2507fe,_0x47cfb6,{'headers':_0xf41611});return console[_0x4feb9c(0x1e1)](_0x4feb9c(0x1af),_0x499533['data']),![];}catch(_0x3ec9ad){console[_0x4feb9c(0x1e1)](_0x4feb9c(0x1f5),_0x3ec9ad);throw new common_1['HttpException'](_0x4feb9c(0x1be),common_1[_0x4feb9c(0x20b)]['BAD_REQUEST']);}}async['pollForResult'](_0x1a534f,_0x3b4905,_0x4a9f94){const _0x3c08f7=_0xf4d3a4;console['log'](_0x3c08f7(0x228));const _0x3da0bb=Date[_0x3c08f7(0x237)]();try{const _0x4e8527=0xd,_0x18ba26=0x2ee0,_0x519823=0x1388,_0x105c8b=0x3c*0x3e8;let _0x262e5c=0x0,_0x54a499=![],_0x33f71a=null;while(!_0x33f71a&&_0x262e5c<_0x4e8527){console['log']('第\x20'+(_0x262e5c+0x1)+'\x20次开始查询');Date['now']()-_0x3da0bb>=_0x105c8b&&(_0x54a499=!![]);await this['sleep'](_0x54a499?_0x519823:_0x18ba26);const _0x48918f=await this[_0x3c08f7(0x1de)]();_0x33f71a=await this[_0x3c08f7(0x20e)](_0x48918f,_0x4a9f94,_0x3b4905),_0x262e5c++;}if(!_0x33f71a)throw new common_1[(_0x3c08f7(0x200))](_0x3c08f7(0x1c4),common_1[_0x3c08f7(0x20b)][_0x3c08f7(0x18d)]);const _0x21e031=Date[_0x3c08f7(0x237)]();return console[_0x3c08f7(0x1e1)](_0x3c08f7(0x183)+Math[_0x3c08f7(0x1d8)]((_0x21e031-_0x3da0bb)/0x3e8)+'\x20S'),_0x33f71a;}catch(_0x3704bd){console[_0x3c08f7(0x22c)](_0x3704bd[_0x3c08f7(0x1bc)]);throw new common_1[(_0x3c08f7(0x200))](_0x3c08f7(0x18b),common_1[_0x3c08f7(0x20b)][_0x3c08f7(0x20a)]);}}async[_0xf4d3a4(0x20e)](_0x13c9fe,_0x1dfe58,_0x6ef9e5){const _0x3a51a5=_0xf4d3a4;if(!_0x13c9fe||!_0x13c9fe[_0x3a51a5(0x1b0)])return;console[_0x3a51a5(0x1e1)](_0x3a51a5(0x1c9),_0x1dfe58);const _0x4071bf=_0x13c9fe[_0x3a51a5(0x225)](_0x406e65=>{const _0x460b6b=_0x3a51a5,{attachments:attachments=[],content:_0x5cd513,edited_timestamp:_0x59722b}=_0x406e65;return _0x5cd513[_0x460b6b(0x20f)](_0x1dfe58)&&attachments['length']>0x0&&!_0x59722b&&!_0x6ef9e5[_0x460b6b(0x20f)](_0x406e65['id']);});return _0x4071bf||null;}async[_0xf4d3a4(0x1de)](){const _0x1c86c3=_0xf4d3a4;try{const {application_id:_0x378570,guild_id:_0x3ac1c8,channel_id:_0x254ddf,session_id:_0x5a7d8d,version:_0x4b15e7,id:_0x37925e,authorization:_0x3b47e4,mjProxy:_0x109926}=await this[_0x1c86c3(0x1c6)](),_0x408727=_0x109926==0x1?_0x1c86c3(0x1e4)+_0x254ddf:_0x1c86c3(0x20d)+_0x254ddf+_0x1c86c3(0x1bd),_0x3699bb={'authorization':_0x3b47e4},_0xc051d0=await axios_1[_0x1c86c3(0x1a8)]['get'](_0x408727,{'headers':_0x3699bb});return _0xc051d0[_0x1c86c3(0x190)];}catch(_0x43bc23){console['log'](_0x1c86c3(0x1aa),_0x43bc23);throw new common_1[(_0x1c86c3(0x200))](_0x1c86c3(0x19f),common_1[_0x1c86c3(0x20b)]['BAD_REQUEST']);}}async[_0xf4d3a4(0x215)](_0x3081b8){return new Promise(_0x332267=>setTimeout(_0x332267,_0x3081b8));}['extractContent'](_0xeaf30e){const _0x3dbd05=_0xf4d3a4,_0x3e9798=_0xeaf30e[_0x3dbd05(0x210)](/\*\*(.+?)\*\*/),_0x46adb0=_0xeaf30e['match'](/- Image #(\d+)/);if(!_0x3e9798||!_0x46adb0)return null;const _0x129ac0=_0x3e9798[0x1],_0x4421da=parseInt(_0x46adb0[0x1]);return{'prompt':_0x129ac0,'order':_0x4421da};}async[_0xf4d3a4(0x1c6)](){const _0x1153fc=_0xf4d3a4,_0x25ef3a=await this[_0x1153fc(0x22a)]['getConfigs']([_0x1153fc(0x18a),_0x1153fc(0x1bb),'mjGuildId','mjChannelId',_0x1153fc(0x1fe),_0x1153fc(0x192),_0x1153fc(0x195),'mjRateLimit','mjProxy']),_0x383f2f={'application_id':_0x25ef3a[_0x1153fc(0x1bb)],'guild_id':_0x25ef3a[_0x1153fc(0x231)],'channel_id':_0x25ef3a['mjChannelId'],'session_id':_0x25ef3a['mjSessionId'],'version':_0x25ef3a[_0x1153fc(0x192)],'id':_0x25ef3a[_0x1153fc(0x18a)],'authorization':_0x25ef3a[_0x1153fc(0x195)],'mjRateLimit':_0x25ef3a['mjRateLimit'],'mjProxy':_0x25ef3a[_0x1153fc(0x18e)]||0x0};return _0x383f2f;}[_0xf4d3a4(0x19d)](_0x1bc2aa){const _0x5245a0=_0xf4d3a4,_0x4b87b5=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x1bc2aa[_0x5245a0(0x1b7)](_0x4b87b5,'');}async['checkAuth'](_0x11958c){const _0x1ef422=_0xf4d3a4,_0xf5784c=await this[_0x1ef422(0x1d4)][_0x1ef422(0x222)]({'where':{'userId':_0x11958c[_0x1ef422(0x1e9)]['id']}}),{id:_0x195761,balance:_0x5ad6cb}=_0xf5784c;if(!_0x5ad6cb||(_0xf5784c===null||_0xf5784c===void 0x0?void 0x0:_0xf5784c[_0x1ef422(0x1da)])<0x1)throw new common_1[(_0x1ef422(0x200))](_0x1ef422(0x1d3),common_1[_0x1ef422(0x20b)][_0x1ef422(0x18d)]);}async[_0xf4d3a4(0x21c)](_0x2589d3){const _0x1649bf=_0xf4d3a4,{id:_0x3a9555,role:_0x155500}=_0x2589d3[_0x1649bf(0x1e9)];!this[_0x1649bf(0x216)][_0x3a9555]?this[_0x1649bf(0x216)][_0x3a9555]=0x1:this['freeQueueUsers'][_0x3a9555]=this[_0x1649bf(0x216)][_0x3a9555]+0x1,console['log'](_0x1649bf(0x1f3)+_0x3a9555+'使用的次数：',this['freeQueueUsers'][_0x3a9555]);}async[_0xf4d3a4(0x19a)](_0x2472e8){const _0x445245=_0xf4d3a4,{id:_0xd5deb0,role:_0x293ba4}=_0x2472e8['user'];if(['admin',_0x445245(0x1d2)][_0x445245(0x20f)](_0x293ba4))return!![];const {mjRateLimit:_0x460c5f}=await this[_0x445245(0x1c6)]();if(this[_0x445245(0x22d)][_0xd5deb0]){const _0x2175d0=this[_0x445245(0x22d)][_0xd5deb0];if(_0x2175d0>Date['now']()){console['log'](_0x445245(0x1dd)+_0xd5deb0+_0x445245(0x201));throw new common_1[(_0x445245(0x200))](_0x445245(0x1a4)+_0x460c5f+_0x445245(0x1b9),common_1[_0x445245(0x20b)]['BAD_REQUEST']);}else this[_0x445245(0x22d)][_0xd5deb0]=Date[_0x445245(0x237)]()+Number(_0x460c5f)*0x3e8;}else{const _0xc9e968=Date[_0x445245(0x237)]();this[_0x445245(0x22d)][_0xd5deb0]=_0xc9e968+0x3e8*Number(_0x460c5f);}}async[_0xf4d3a4(0x218)](_0x480aac){const _0x386dff=_0xf4d3a4;await this[_0x386dff(0x1d4)][_0x386dff(0x1ee)]()[_0x386dff(0x22f)](balance_entity_1['BalanceEntity'])[_0x386dff(0x1e7)]({'balance':()=>_0x386dff(0x1f6)})['where'](_0x386dff(0x188),{'userId':_0x480aac[_0x386dff(0x1e9)]['id']})[_0x386dff(0x1fc)]();}async['test'](){return 0x1;}};MjService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_2[_0xf4d3a4(0x209)])(balance_entity_1['BalanceEntity'])),__metadata(_0xf4d3a4(0x22e),[typeorm_1[_0xf4d3a4(0x232)],typeorm_1[_0xf4d3a4(0x232)],upload_service_1['UploadService'],chatLog_service_1[_0xf4d3a4(0x181)],globalConfig_service_1[_0xf4d3a4(0x1e3)],fanyi_service_1[_0xf4d3a4(0x20c)],badwords_service_1[_0xf4d3a4(0x199)]])],MjService),exports[_0xf4d3a4(0x21f)]=MjService;