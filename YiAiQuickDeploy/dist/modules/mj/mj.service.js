'use strict';const _0x4b7d50=_0x9374;(function(_0x53ba70,_0x2d03af){const _0x281cf6=_0x9374,_0x2b66dc=_0x53ba70();while(!![]){try{const _0x4ec2d4=parseInt(_0x281cf6(0x137))/0x1*(-parseInt(_0x281cf6(0xd8))/0x2)+-parseInt(_0x281cf6(0x134))/0x3*(-parseInt(_0x281cf6(0x168))/0x4)+-parseInt(_0x281cf6(0x165))/0x5+-parseInt(_0x281cf6(0xf7))/0x6+-parseInt(_0x281cf6(0x154))/0x7*(parseInt(_0x281cf6(0x15e))/0x8)+parseInt(_0x281cf6(0x13d))/0x9+parseInt(_0x281cf6(0xcf))/0xa;if(_0x4ec2d4===_0x2d03af)break;else _0x2b66dc['push'](_0x2b66dc['shift']());}catch(_0x54d141){_0x2b66dc['push'](_0x2b66dc['shift']());}}}(_0x5d14,0x75308));function _0x5d14(){const _0x539b61=['error:\x20','findOne','getClientIp','execute','BAD_REQUEST','uploadFileFromUrl','findCurrentVariationImgResult','FanyiService','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','match','getMjDefaultParams','变换当前图片失败','sendSmInteractions','查询期间出现错误：','42yrfmtp','stringify','url','3jUNjbS','../../common/utils','https://discord.com/api/v9/interactions','http://172.247.48.137:8000/mj/draw','绘制图片任务异常中断\x20队列-1:\x20','decorate','5344785svBiOO','checkBadWords','where','function','mjGuildId','INTERNAL_SERVER_ERROR','../fanyi/fanyi.service','本次放大图片的id:\x20','map','../globalConfig/globalConfig.service','IsNull','saveChatLog','typeorm','sleep','变化图片任务异常中断\x20队列-1:\x20','UploadService','ChatLogService','放大图片任务异常中断\x20队列-1:\x20','当前提示词已经在任务队列中了、请勿重复提交。。。','开始请求放大图片\x20队列+1:\x20','存入图片完成:\x20','chatLogEntity','sendDrawInteractions','1975911AMHtsS','design:paramtypes','now','max','enlargeWorking','object','mjVersion','绘制图片任务结束\x20队列-1:\x20','\x20次开始查询\x20=>\x20当前查询结果：','queueCount','8pMaNRV','orderId','mjId','mjChannelId','../upload/upload.service','update','axios','3529385HzERCk','放大当前图片失败','rateLimits','189612HNqYcb','发送绘画指令结果:\x20','globalConfigService','user','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','绘画任务开始','balance','绘画失败','放大单张图片请求失败...','DeductionKey','当前用户\x20','substring','freeQueueUsers','BadwordsService','badwordsService','当前图片没有绘画信息、无法放大!','发送放大指令成功','BalanceEntity','axios:\x20','Not','mjRateLimit','response','Like','@nestjs/typeorm','http://172.247.48.137:8000/mj/list?channel_id=','MjService','upscaleSingleImg','绘画超时，请稍后再试！','15860330zwhaOu','getConfigs','\x20队列+1:\x20','filter','网络连接失败，请稍后再试！','createRandomUid','drawWorking','length','getOwnPropertyDescriptor','290492WPSNue','本次比对的随机ID:\x20','绘图指令完成','ChatLogEntity','mjservice','metadata','checkAuth','__param','set','../badwords/badwords.service','../chatLog/chatLog.service','components','fanyiService','enlarge','get','data','prompt\x20-------->\x20\x20','本次绘图耗时:\x20','秒请求一次、请合理使用！','\x20次开始查询','removeEmoji','queryMessageList','checkFree','放大图片任务结束\x20队列-1:\x20','InjectRepository','pollForResult','历史记录中不存在当前图片、请确认您放大的图片是否存在','replace','由于速率限制、当前普通用户限制为','message','message_id','5637864RbRwDm','开始查询绘画结果轮询','findCurrentPromptResult','defineProperty','uploadService','当前用户','mjProxy','randomId:\x20','pollForUpscaleResult','HttpException','有历史信息之间返回:\x20','chatLogService','error','PAINT_TYPE','mjDraw','convertToEnglish','开始请求用户','baiduFanyiAppId','mjAuthorization','floor','extractContent','log','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','variationId','prompt','\x20请求过于频繁！','find','default','mjNotSaveImg','__decorate','createQueryBuilder','开始轮询单张变换图片结果','放大custom_id:\x20','includes','HttpStatus','imagine','__esModule','checkRateLimit','当前图片已经放大过了、请勿重复放大!','Repository','draw','super','axios\x20get:\x20','balance\x20-\x201','mjSessionId','拿到了远程地址:\x20','push'];_0x5d14=function(){return _0x539b61;};return _0x5d14();}var __decorate=this&&this[_0x4b7d50(0x114)]||function(_0x16cf56,_0x1e9083,_0x2ed167,_0x3261c0){const _0x2b9c74=_0x4b7d50;var _0x4fa4b8=arguments['length'],_0x42af9a=_0x4fa4b8<0x3?_0x1e9083:_0x3261c0===null?_0x3261c0=Object[_0x2b9c74(0xd7)](_0x1e9083,_0x2ed167):_0x3261c0,_0x57da6c;if(typeof Reflect===_0x2b9c74(0x159)&&typeof Reflect['decorate']===_0x2b9c74(0x140))_0x42af9a=Reflect[_0x2b9c74(0x13c)](_0x16cf56,_0x1e9083,_0x2ed167,_0x3261c0);else{for(var _0x306e5c=_0x16cf56[_0x2b9c74(0xd6)]-0x1;_0x306e5c>=0x0;_0x306e5c--)if(_0x57da6c=_0x16cf56[_0x306e5c])_0x42af9a=(_0x4fa4b8<0x3?_0x57da6c(_0x42af9a):_0x4fa4b8>0x3?_0x57da6c(_0x1e9083,_0x2ed167,_0x42af9a):_0x57da6c(_0x1e9083,_0x2ed167))||_0x42af9a;}return _0x4fa4b8>0x3&&_0x42af9a&&Object[_0x2b9c74(0xfa)](_0x1e9083,_0x2ed167,_0x42af9a),_0x42af9a;},__metadata=this&&this['__metadata']||function(_0x129dae,_0xada222){const _0x57eddc=_0x4b7d50;if(typeof Reflect==='object'&&typeof Reflect[_0x57eddc(0xdd)]===_0x57eddc(0x140))return Reflect[_0x57eddc(0xdd)](_0x129dae,_0xada222);},__param=this&&this[_0x4b7d50(0xdf)]||function(_0x13d290,_0x20218b){return function(_0x50ae6a,_0x302c6d){_0x20218b(_0x50ae6a,_0x302c6d,_0x13d290);};};Object[_0x4b7d50(0xfa)](exports,_0x4b7d50(0x11b),{'value':!![]}),exports[_0x4b7d50(0x181)]=void 0x0;const globalConfig_service_1=require(_0x4b7d50(0x146)),upload_service_1=require(_0x4b7d50(0x162)),common_1=require('@nestjs/common'),axios_1=require(_0x4b7d50(0x164)),chatLog_service_1=require(_0x4b7d50(0xe2)),balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require(_0x4b7d50(0x138)),chatLog_entity_1=require('../chatLog/chatLog.entity'),typeorm_1=require(_0x4b7d50(0x149)),typeorm_2=require(_0x4b7d50(0x17f)),balance_entity_1=require('../userBalance/balance.entity'),fanyi_service_1=require(_0x4b7d50(0x143)),badwords_service_1=require(_0x4b7d50(0xe1));let MjService=class MjService{constructor(_0xf324e6,_0x557a99,_0x2f9055,_0x3a8fdb,_0x418341,_0x27d79b,_0x5267d1){const _0x15b96b=_0x4b7d50;this[_0x15b96b(0x152)]=_0xf324e6,this['balanceEntity']=_0x557a99,this[_0x15b96b(0xfb)]=_0x2f9055,this['chatLogService']=_0x3a8fdb,this[_0x15b96b(0x16a)]=_0x418341,this[_0x15b96b(0xe4)]=_0x27d79b,this[_0x15b96b(0x176)]=_0x5267d1,this[_0x15b96b(0x167)]={},this['drawWorking']=[],this[_0x15b96b(0x158)]=[],this[_0x15b96b(0x15d)]=0x0,this[_0x15b96b(0x174)]={};}async[_0x4b7d50(0x105)](_0x511cde){const _0x44585c=_0x4b7d50,{jobId:_0x382781,prompt:_0x2a9761,startTime:_0x31199d,userId:_0x43b58a}=_0x511cde;return console['log'](_0x44585c(0x16d),_0x44585c(0xdc)),await new Promise(_0x383909=>setTimeout(_0x383909,0x1388)),{'a':0x1,'b':0x2};}async[_0x4b7d50(0x11f)](_0x4d362c,_0x4bd7ff){const _0x586cdb=_0x4b7d50;await this['checkAuth'](_0x4bd7ff),await this[_0x586cdb(0x176)][_0x586cdb(0x13e)](_0x4d362c[_0x586cdb(0x10f)],_0x4bd7ff[_0x586cdb(0x16b)]['id']);const _0x11f432=_0x4d362c[_0x586cdb(0x10f)];let _0x6fc313=_0x4d362c[_0x586cdb(0x10f)];const {baiduFanyiAppId:_0x38eb73,baiduFanyiSecret:_0x3e9b21}=await this['globalConfigService'][_0x586cdb(0xd0)]([_0x586cdb(0x108),'baiduFanyiSecret']);_0x38eb73&&_0x3e9b21&&(_0x6fc313=await this[_0x586cdb(0xe4)][_0x586cdb(0x106)](_0x11f432));const _0x5bcc34='['+(0x0,utils_1[_0x586cdb(0xd4)])()+']',_0x4d0f08=_0x5bcc34+'\x20'+_0x6fc313;console[_0x586cdb(0x10c)](_0x586cdb(0xfe),_0x5bcc34),console['log'](_0x586cdb(0xe8),_0x4d0f08);const _0x80b6df=this[_0x586cdb(0xd5)][_0x586cdb(0x111)](_0x367143=>_0x367143[_0x586cdb(0x118)](_0x4d362c[_0x586cdb(0x10f)]));if(_0x80b6df)throw new common_1[(_0x586cdb(0x100))](_0x586cdb(0x14f),common_1[_0x586cdb(0x119)][_0x586cdb(0x12a)]);if(this[_0x586cdb(0x15d)]>=0x3)throw new common_1[(_0x586cdb(0x100))](_0x586cdb(0x10d),common_1[_0x586cdb(0x119)]['BAD_REQUEST']);await this[_0x586cdb(0x11c)](_0x4bd7ff),this[_0x586cdb(0x15d)]++,console[_0x586cdb(0x10c)](_0x586cdb(0x107)+_0x4bd7ff['user']['id']+_0x586cdb(0xd1),this[_0x586cdb(0x15d)]);try{const _0x53c7b4=await this[_0x586cdb(0x152)]['find']({'where':{'prompt':(0x0,typeorm_1[_0x586cdb(0x17e)])('%'+_0x4d0f08+'%')}}),_0x2e6764=_0x53c7b4['map'](_0x48ccd2=>_0x48ccd2[_0x586cdb(0xf6)]);this[_0x586cdb(0xd5)][_0x586cdb(0x125)](_0x4d0f08);let _0x20f7d9;const _0x1fc8bf=await this[_0x586cdb(0x153)](_0x4d0f08,_0x2e6764,_0x5bcc34);_0x1fc8bf?(console[_0x586cdb(0x10c)]('历史中存在当前图片、直接获取！'),_0x20f7d9=_0x1fc8bf):_0x20f7d9=await this[_0x586cdb(0xf1)](_0x4d0f08,_0x2e6764,_0x5bcc34);this[_0x586cdb(0x15d)]--,this[_0x586cdb(0x15d)]<0x0&&(this[_0x586cdb(0x15d)]=0x0),console['log'](_0x586cdb(0x15b),this[_0x586cdb(0x15d)]);const {id:_0x1da548,content:_0x153266,channel_id:_0x1e65c0,attachments:attachments=[],timestamp:_0x4c0299}=_0x20f7d9;if(!attachments[_0x586cdb(0xd6)]||!attachments[0x0][_0x586cdb(0x136)])throw new common_1[(_0x586cdb(0x100))](_0x586cdb(0x16f),common_1['HttpStatus'][_0x586cdb(0x12a)]);const {filename:_0x12c4b9,url:_0x2c886a,width:_0x4a0991,height:_0x44ef2d,size:_0x24efb7}=attachments[0x0];console[_0x586cdb(0x10c)](_0x586cdb(0x124),_0x2c886a);const _0x1889b0=this[_0x586cdb(0x16a)][_0x586cdb(0xd0)]([_0x586cdb(0x113)]);let _0x12a9d1='';(!Number(_0x1889b0)||Number(_0x1889b0)===0x0)&&(_0x12a9d1=await this['uploadService']['uploadFileFromUrl']({'filename':_0x12c4b9,'url':_0x2c886a}),console['log'](_0x586cdb(0x151),_0x12a9d1));const _0x803796={'curIp':(0x0,utils_1['getClientIp'])(_0x4bd7ff),'userId':_0x4bd7ff[_0x586cdb(0x16b)]['id'],'type':balance_constant_1['DeductionKey']['PAINT_TYPE'],'prompt':_0x4d0f08,'answer':_0x12a9d1,'model':'mj','extend':this['removeEmoji'](JSON['stringify'](_0x20f7d9)),'message_id':_0x1da548,'variationId':_0x1da548,'upscaleId':_0x1da548,'group':0x1,'isSaveImg':!Number(_0x1889b0)||Number(_0x1889b0)===0x0,'fileInfo':JSON[_0x586cdb(0x135)]({'width':_0x4a0991,'height':_0x44ef2d,'size':_0x24efb7,'filename':_0x12c4b9,'cosUrl':_0x12a9d1})};return await this[_0x586cdb(0x102)][_0x586cdb(0x148)](_0x803796),await this['deductBalance'](_0x4bd7ff),this[_0x586cdb(0xd5)]=this[_0x586cdb(0xd5)]['filter'](_0x36982b=>_0x36982b!==_0x4d362c[_0x586cdb(0x10f)]),_0x12a9d1;}catch(_0x7b6c41){this[_0x586cdb(0x15d)]--,this[_0x586cdb(0x15d)]<0x0&&(this[_0x586cdb(0x15d)]=0x0),console['log'](_0x586cdb(0x13b),this[_0x586cdb(0x15d)]),this[_0x586cdb(0xd5)]=this[_0x586cdb(0xd5)][_0x586cdb(0xd2)](_0x2ed6ca=>_0x2ed6ca!==_0x4d362c[_0x586cdb(0x10f)]);throw new common_1['HttpException'](_0x7b6c41[_0x586cdb(0x17d)],common_1[_0x586cdb(0x119)]['BAD_REQUEST']);}}async[_0x4b7d50(0xcd)](_0xe8c0d4,_0x5c5faf){const _0x1ebdd8=_0x4b7d50;if(this[_0x1ebdd8(0x15d)]>=0x3)throw new common_1[(_0x1ebdd8(0x100))](_0x1ebdd8(0x10d),common_1['HttpStatus'][_0x1ebdd8(0x12a)]);this['queueCount']++,console['log']('用户'+_0x5c5faf[_0x1ebdd8(0x16b)]['id']+_0x1ebdd8(0x150),this['queueCount']);const {message_id:_0x15f806,orderId:_0x3fea1c}=_0xe8c0d4;try{const _0x1d82df=await this[_0x1ebdd8(0x152)]['findOne']({'where':{'message_id':_0x15f806}});if(!_0x1d82df)throw new common_1[(_0x1ebdd8(0x100))](_0x1ebdd8(0xf2),common_1[_0x1ebdd8(0x119)][_0x1ebdd8(0x12a)]);const _0x5aa77d=await this[_0x1ebdd8(0x152)]['findOne']({'where':{'upscaleId':_0x15f806,'action':_0x1ebdd8(0xe5),'orderId':_0x3fea1c}});if(_0x5aa77d)throw new common_1[(_0x1ebdd8(0x100))](_0x1ebdd8(0x11d),common_1[_0x1ebdd8(0x119)][_0x1ebdd8(0x12a)]);const {prompt:_0x180270,extend:_0x58e6f2}=_0x1d82df;let _0x35ff35=null;try{_0x35ff35=JSON['parse'](_0x58e6f2);}catch(_0x1f97df){_0x35ff35=[];}const {components:components=[]}=_0x35ff35;if(!components[_0x1ebdd8(0xd6)])throw new common_1[(_0x1ebdd8(0x100))](_0x1ebdd8(0x177),common_1[_0x1ebdd8(0x119)]['BAD_REQUEST']);const _0xdd7733=components[0x0][_0x1ebdd8(0xe3)][_0x3fea1c-0x1],{custom_id:_0x5678a2}=_0xdd7733;console[_0x1ebdd8(0x10c)](_0x1ebdd8(0x117),_0x5678a2);const _0x48bbc9={'message_id':_0x15f806,'custom_id':_0x5678a2,'prompt':_0x180270,'orderId':_0x3fea1c};await this['sendSmInteractions'](_0x48bbc9),console[_0x1ebdd8(0x10c)](_0x1ebdd8(0x178));const _0x28e61f=await this[_0x1ebdd8(0x152)][_0x1ebdd8(0x111)]({'where':{'prompt':(0x0,typeorm_1[_0x1ebdd8(0x17e)])('%'+_0x180270+'%')}}),_0xf88c07=_0x28e61f[_0x1ebdd8(0x145)](_0x228beb=>_0x228beb[_0x1ebdd8(0xf6)]);console[_0x1ebdd8(0x10c)]('历史这些id已经被获取过了\x20不能拿了:\x20',_0xf88c07);const _0x2c6d13=await this[_0x1ebdd8(0xff)](_0x48bbc9,_0xf88c07);this[_0x1ebdd8(0x15d)]--,this[_0x1ebdd8(0x15d)]<0x0&&(this[_0x1ebdd8(0x15d)]=0x0),console[_0x1ebdd8(0x10c)](_0x1ebdd8(0xef),this[_0x1ebdd8(0x15d)]);const {id:_0x5cbe89,content:_0x5bc607,channel_id:_0x1acbe1,attachments:attachments=[],timestamp:_0x16d260}=_0x2c6d13;if(!attachments[_0x1ebdd8(0xd6)]||!attachments[0x0][_0x1ebdd8(0x136)])throw new common_1[(_0x1ebdd8(0x100))](_0x1ebdd8(0x166),common_1['HttpStatus'][_0x1ebdd8(0x12a)]);const {filename:_0xcaf259,url:_0x367fb6,width:_0x1559aa,height:_0x395ebd,size:_0x5053d7}=attachments[0x0],_0x3a66b2=this[_0x1ebdd8(0x16a)]['getConfigs']([_0x1ebdd8(0x113)]);let _0x25300a='';(!Number(_0x3a66b2)||Number(_0x3a66b2)===0x0)&&(_0x25300a=await this[_0x1ebdd8(0xfb)][_0x1ebdd8(0x12b)]({'filename':_0xcaf259,'url':_0x367fb6}),console[_0x1ebdd8(0x10c)](_0x1ebdd8(0x151),_0x25300a));const _0x21c5fb={'curIp':(0x0,utils_1[_0x1ebdd8(0x128)])(_0x5c5faf),'userId':_0x5c5faf[_0x1ebdd8(0x16b)]['id'],'type':balance_constant_1[_0x1ebdd8(0x171)][_0x1ebdd8(0x104)],'prompt':_0x180270,'answer':_0x25300a,'model':'mj','extend':this['removeEmoji'](JSON['stringify'](_0x2c6d13)),'message_id':_0x15f806,'upscaleId':_0x5cbe89,'variationId':_0x5cbe89,'action':_0x1ebdd8(0xe5),'orderId':_0x48bbc9[_0x1ebdd8(0x15f)],'isSaveImg':!Number(_0x3a66b2)||Number(_0x3a66b2)===0x0,'fileInfo':JSON[_0x1ebdd8(0x135)]({'width':_0x1559aa,'height':_0x395ebd,'size':_0x5053d7,'filename':_0xcaf259,'cosUrl':_0x25300a})};return await this['chatLogService'][_0x1ebdd8(0x148)](_0x21c5fb),_0x25300a;}catch(_0x48911a){console[_0x1ebdd8(0x10c)](_0x1ebdd8(0x126),_0x48911a),this['queueCount']--,this[_0x1ebdd8(0x15d)]<0x0&&(this[_0x1ebdd8(0x15d)]=0x0),console[_0x1ebdd8(0x10c)](_0x1ebdd8(0x14e),this[_0x1ebdd8(0x15d)]);throw new common_1[(_0x1ebdd8(0x100))](_0x48911a[_0x1ebdd8(0x17d)],common_1['HttpStatus'][_0x1ebdd8(0x12a)]);}}async['variationSingleImg'](_0x297afb,_0x2b63c2){const _0x485ba2=_0x4b7d50;if(this['queueCount']>=0x3)throw new common_1[(_0x485ba2(0x100))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x485ba2(0x119)]['BAD_REQUEST']);await this[_0x485ba2(0xde)](_0x2b63c2),await this[_0x485ba2(0x11c)](_0x2b63c2),this[_0x485ba2(0x15d)]++,console[_0x485ba2(0x10c)]('用户'+_0x2b63c2[_0x485ba2(0x16b)]['id']+'开始请求变换图片\x20队列+1:\x20',this[_0x485ba2(0x15d)]);const {message_id:_0x2f74d9,orderId:_0x59bcdb}=_0x297afb;try{const _0x4ee57c=await this[_0x485ba2(0x152)]['findOne']({'where':{'message_id':_0x2f74d9}});if(!_0x4ee57c)throw new common_1[(_0x485ba2(0x100))](_0x485ba2(0x12e),common_1[_0x485ba2(0x119)]['BAD_REQUEST']);const {prompt:_0xdaed4e,extend:_0x2e3e0e}=_0x4ee57c;let _0x1dec61=null;try{_0x1dec61=JSON['parse'](_0x2e3e0e);}catch(_0x1c80fe){_0x1dec61=[];}const {components:components=[]}=_0x1dec61;if(!components[_0x485ba2(0xd6)])throw new common_1[(_0x485ba2(0x100))]('当前图片没有绘画信息、无法变体!',common_1[_0x485ba2(0x119)][_0x485ba2(0x12a)]);const _0x4e724a=components[0x1][_0x485ba2(0xe3)][_0x59bcdb-0x1],{custom_id:_0x5d5eb5}=_0x4e724a,_0x362ab1=await this[_0x485ba2(0x152)][_0x485ba2(0x111)]({'where':{'variationId':(0x0,typeorm_1[_0x485ba2(0x17b)])((0x0,typeorm_1[_0x485ba2(0x147)])()),'prompt':(0x0,typeorm_1[_0x485ba2(0x17e)])('%'+_0xdaed4e+'%')}}),_0x4eaf6e=_0x362ab1[_0x485ba2(0x145)](_0x1ef624=>_0x1ef624[_0x485ba2(0x10e)]),_0x2f9ab0={'message_id':_0x2f74d9,'custom_id':_0x5d5eb5,'prompt':_0xdaed4e,'orderId':_0x59bcdb};await this['sendSmInteractions'](_0x2f9ab0);const _0x4067a9=await this['pollForVariationResult'](_0x2f9ab0,_0x4eaf6e);this[_0x485ba2(0x15d)]--,this['queueCount']<0x0&&(this[_0x485ba2(0x15d)]=0x0),console['log']('变换图片任务结束\x20队列-1:\x20',this[_0x485ba2(0x15d)]);const {id:_0x5a440c,content:_0x1e1cc3,channel_id:_0x2a3f08,attachments:attachments=[],timestamp:_0xaecdf3}=_0x4067a9;if(!attachments['length']||!attachments[0x0][_0x485ba2(0x136)])throw new common_1[(_0x485ba2(0x100))](_0x485ba2(0x131),common_1['HttpStatus']['BAD_REQUEST']);const {filename:_0x2eb304,url:_0x2feaf8,width:_0x10192b,height:_0x99b272,size:_0x307768}=attachments[0x0],_0x4f0437=this[_0x485ba2(0x16a)][_0x485ba2(0xd0)](['mjNotSaveImg']);let _0x1a9ce9='';(!Number(_0x4f0437)||Number(_0x4f0437)===0x0)&&(_0x1a9ce9=await this[_0x485ba2(0xfb)][_0x485ba2(0x12b)]({'filename':_0x2eb304,'url':_0x2feaf8}),console[_0x485ba2(0x10c)](_0x485ba2(0x151),_0x1a9ce9));const _0x3d9e9e={'curIp':(0x0,utils_1['getClientIp'])(_0x2b63c2),'userId':_0x2b63c2[_0x485ba2(0x16b)]['id'],'type':balance_constant_1['DeductionKey'][_0x485ba2(0x104)],'prompt':_0xdaed4e,'answer':_0x1a9ce9,'model':'mj','group':0x1,'extend':this[_0x485ba2(0xec)](JSON[_0x485ba2(0x135)](_0x4067a9)),'message_id':_0x5a440c,'upscaleId':_0x5a440c,'variationId':_0x5a440c,'action':_0x485ba2(0xe5),'orderId':_0x2f9ab0['orderId'],'isSaveImg':!Number(_0x4f0437)||Number(_0x4f0437)===0x0,'fileInfo':JSON[_0x485ba2(0x135)]({'width':_0x10192b,'height':_0x99b272,'size':_0x307768,'filename':_0x2eb304,'cosUrl':_0x1a9ce9})};return await this[_0x485ba2(0x102)]['saveChatLog'](_0x3d9e9e),_0x1a9ce9;}catch(_0x2a7ca5){console[_0x485ba2(0x10c)](_0x485ba2(0x126),_0x2a7ca5),this[_0x485ba2(0x15d)]--,this['queueCount']<0x0&&(this[_0x485ba2(0x15d)]=0x0),console[_0x485ba2(0x10c)](_0x485ba2(0x14b),this[_0x485ba2(0x15d)]);throw new common_1[(_0x485ba2(0x100))](_0x2a7ca5[_0x485ba2(0x17d)],common_1[_0x485ba2(0x119)][_0x485ba2(0x12a)]);}}async[_0x4b7d50(0x132)](_0x1bd81f){const _0x420abb=_0x4b7d50,{message_id:_0x1af361,custom_id:_0x5cc6a7}=_0x1bd81f,{application_id:_0x1b3314,guild_id:_0x4f8473,channel_id:_0x18b9cd,session_id:_0x389ce8,version:_0x439782,id:_0x3e42fa,authorization:_0x3d3613,mjProxy:_0x5e3e05}=await this[_0x420abb(0x130)](),_0x57d0bd=_0x5e3e05==0x1?_0x420abb(0x13a):'https://discord.com/api/v9/interactions',_0x266241={'authorization':_0x3d3613},_0x39c825={'type':0x3,'guild_id':_0x4f8473,'channel_id':_0x18b9cd,'message_flags':0x0,'message_id':_0x1af361,'application_id':_0x1b3314,'session_id':_0x389ce8,'data':{'component_type':0x2,'custom_id':_0x5cc6a7}};try{await axios_1[_0x420abb(0x112)]['post'](_0x57d0bd,_0x39c825,{'headers':_0x266241}),console[_0x420abb(0x10c)](_0x420abb(0xda));}catch(_0x14e3e9){console[_0x420abb(0x10c)]('error:\x20',_0x14e3e9);throw new common_1[(_0x420abb(0x100))](_0x420abb(0x170),common_1['HttpStatus'][_0x420abb(0x12a)]);}}async[_0x4b7d50(0xff)](_0x333212,_0x2a6a51){const _0x554466=_0x4b7d50,{message_id:_0x38c6ca,custom_id:_0xb2c882,prompt:_0x76c888,orderId:_0x1d409b}=_0x333212;let _0x3f642f=null,_0x2f26d1=0x0;while(!_0x3f642f&&_0x2f26d1<0xa){try{const _0x33d84c=Date[_0x554466(0x156)](),_0x4c923d=await this[_0x554466(0xed)]();console['log']('第\x20'+(_0x2f26d1+0x1)+_0x554466(0x15c)+_0x4c923d[_0x554466(0xd6)]);_0x4c923d&&_0x4c923d['length']&&(_0x3f642f=await this['findCurrentEnlargeImgResult'](_0x4c923d,_0x333212,_0x2a6a51));const _0x4dc325=Date[_0x554466(0x156)]()-_0x33d84c,_0x639cbf=0xbb8;await this[_0x554466(0x14a)](Math[_0x554466(0x157)](_0x639cbf-_0x4dc325,0x0)),_0x2f26d1++;}catch(_0x263046){console['error'](_0x554466(0x133)+_0x263046['message']);}}return _0x3f642f;}async['pollForVariationResult'](_0x3d9e25,_0x459299){const _0x8ac8fd=_0x4b7d50,{message_id:_0x50d8eb,custom_id:_0x1f9c06,prompt:_0x3dd607,orderId:_0x41464e}=_0x3d9e25;console[_0x8ac8fd(0x10c)](_0x8ac8fd(0x116));let _0x299bf3=null,_0x1d54cf=0x0;while(!_0x299bf3&&_0x1d54cf<0xa){try{console[_0x8ac8fd(0x10c)]('第\x20'+(_0x1d54cf+0x1)+'\x20次开始查询[变换图片]');const _0x2ee954=Date[_0x8ac8fd(0x156)](),_0x5155ee=await this['queryMessageList']();_0x5155ee&&_0x5155ee[_0x8ac8fd(0xd6)]&&(_0x299bf3=await this[_0x8ac8fd(0x12c)](_0x5155ee,_0x3d9e25,_0x459299));const _0x397492=Date['now']()-_0x2ee954,_0x2f31bf=0x1f40;await this[_0x8ac8fd(0x14a)](Math[_0x8ac8fd(0x157)](_0x2f31bf-_0x397492,0x0)),_0x1d54cf++;}catch(_0x2b530e){console[_0x8ac8fd(0x103)]('查询期间出现错误：'+_0x2b530e[_0x8ac8fd(0xf5)]);}}if(!_0x299bf3)throw new common_1['HttpException']('变换当前图片超时！',common_1[_0x8ac8fd(0x119)]['BAD_REQUEST']);return _0x299bf3;}async['findCurrentEnlargeImgResult'](_0x1e02fe,_0x357069,_0x228330){const _0x44384c=_0x4b7d50,{message_id:_0x41e3a3,custom_id:_0xfd514f,prompt:_0x3ae70d,orderId:_0x21fdfe}=_0x357069,_0x5a6cea=_0x3ae70d[_0x44384c(0x173)](0x0,0xc);console[_0x44384c(0x10c)](_0x44384c(0x144),_0x5a6cea);const _0x13655a=_0x1e02fe['find'](_0x3a621f=>{const _0x2531f5=_0x44384c,{content:_0x3ac26c}=_0x3a621f;if(!this[_0x2531f5(0x10b)](_0x3ac26c))return![];const {prompt:_0x7fceec,order:_0x1f31f7}=this['extractContent'](_0x3ac26c);return _0x7fceec[_0x2531f5(0x118)](_0x5a6cea)&&_0x357069[_0x2531f5(0x15f)]===_0x1f31f7&&!_0x228330[_0x2531f5(0x118)](_0x3a621f['id']);});return _0x13655a;}async[_0x4b7d50(0x12c)](_0x599760,_0x4256a2,_0x54a199){const _0x5061e2=_0x4b7d50,{message_id:_0xe58645,custom_id:_0x892685,prompt:_0x216cd5,orderId:_0x5047a6}=_0x4256a2,_0x28b016=_0x216cd5[_0x5061e2(0x173)](0x0,0xc),_0x33d056=_0x599760[_0x5061e2(0x111)](_0x15441c=>{const _0x13efad=_0x5061e2,{content:_0x194275}=_0x15441c,_0x25d365=_0x194275[_0x13efad(0x12f)](/\*\*(.+?)\*\*/),_0x71525c=_0x25d365?_0x25d365[0x1]:'';if(!_0x71525c)return![];return _0x71525c[_0x13efad(0x118)](_0x28b016)&&!_0x54a199[_0x13efad(0x118)](_0x15441c['id']);});return _0x33d056;}async[_0x4b7d50(0x153)](_0x1eefdd,_0x2c5fd1,_0x12c430){const _0x3eb1b0=_0x4b7d50,_0x1f9a5d=await this[_0x3eb1b0(0xed)](),_0x38cec2=await this['findCurrentPromptResult'](_0x1f9a5d,_0x12c430,_0x2c5fd1);if(_0x38cec2)return console[_0x3eb1b0(0x10c)](_0x3eb1b0(0x101),_0x38cec2),_0x38cec2;const {application_id:_0x2ceb7f,guild_id:_0x324589,channel_id:_0xcfe2f2,session_id:_0x21e68b,version:_0x47bb57,id:_0x30403d,authorization:_0x33c0af,mjProxy:_0x331bcf}=await this[_0x3eb1b0(0x130)](),_0x333216={'type':0x2,'application_id':_0x2ceb7f,'guild_id':_0x324589,'channel_id':_0xcfe2f2,'session_id':_0x21e68b,'data':{'version':_0x47bb57,'id':_0x30403d,'name':_0x3eb1b0(0x11a),'type':0x1,'options':[{'type':0x3,'name':_0x3eb1b0(0x10f),'value':_0x1eefdd}],'attachments':[]}};try{const _0x2c1ff7=_0x331bcf==0x1?_0x3eb1b0(0x13a):_0x3eb1b0(0x139),_0x571040={'authorization':_0x33c0af},_0x4565e0=await axios_1[_0x3eb1b0(0x112)]['post'](_0x2c1ff7,_0x333216,{'headers':_0x571040});return console[_0x3eb1b0(0x10c)](_0x3eb1b0(0x169),_0x4565e0['data']),![];}catch(_0x73f8f8){console[_0x3eb1b0(0x10c)](_0x3eb1b0(0x17a),_0x73f8f8);throw new common_1['HttpException'](_0x3eb1b0(0x16c),common_1[_0x3eb1b0(0x119)][_0x3eb1b0(0x12a)]);}}async[_0x4b7d50(0xf1)](_0x5e3951,_0x4baf72,_0x5a2dcf){const _0x386a1f=_0x4b7d50;console[_0x386a1f(0x10c)](_0x386a1f(0xf8));const _0x3bbf4d=Date[_0x386a1f(0x156)]();try{const _0x5da7f2=0xd,_0x113a44=0x2ee0,_0x343b1d=0x1388,_0x2b3073=0x3c*0x3e8;let _0x658dd3=0x0,_0x54ab48=![],_0x118983=null;while(!_0x118983&&_0x658dd3<_0x5da7f2){console[_0x386a1f(0x10c)]('第\x20'+(_0x658dd3+0x1)+_0x386a1f(0xeb));Date[_0x386a1f(0x156)]()-_0x3bbf4d>=_0x2b3073&&(_0x54ab48=!![]);await this['sleep'](_0x54ab48?_0x343b1d:_0x113a44);const _0x437e7f=await this[_0x386a1f(0xed)]();_0x118983=await this[_0x386a1f(0xf9)](_0x437e7f,_0x5a2dcf,_0x4baf72),_0x658dd3++;}if(!_0x118983)throw new common_1[(_0x386a1f(0x100))](_0x386a1f(0xce),common_1[_0x386a1f(0x119)][_0x386a1f(0x12a)]);const _0x20646=Date[_0x386a1f(0x156)]();return console[_0x386a1f(0x10c)](_0x386a1f(0xe9)+Math[_0x386a1f(0x10a)]((_0x20646-_0x3bbf4d)/0x3e8)+'\x20S'),_0x118983;}catch(_0x402526){console['error'](_0x402526[_0x386a1f(0xf5)]);throw new common_1[(_0x386a1f(0x100))](_0x386a1f(0xd3),common_1[_0x386a1f(0x119)][_0x386a1f(0x142)]);}}async['findCurrentPromptResult'](_0x13948a,_0x204471,_0x30492c){const _0x5eb7d7=_0x4b7d50;if(!_0x13948a||!_0x13948a[_0x5eb7d7(0xd6)])return;console['log'](_0x5eb7d7(0xd9),_0x204471);const _0x275f0a=_0x13948a[_0x5eb7d7(0x111)](_0x58bc33=>{const _0x360b64=_0x5eb7d7,{attachments:attachments=[],content:_0x2f2990,edited_timestamp:_0x42641e}=_0x58bc33;return _0x2f2990[_0x360b64(0x118)](_0x204471)&&attachments['length']>0x0&&!_0x42641e&&!_0x30492c['includes'](_0x58bc33['id']);});return _0x275f0a||null;}async['queryMessageList'](){const _0x1d08d0=_0x4b7d50;try{const {application_id:_0x5a7e45,guild_id:_0x10e654,channel_id:_0xbd76e9,session_id:_0x24963f,version:_0x54590b,id:_0x162c21,authorization:_0x4b8a0f,mjProxy:_0x4e7a28}=await this[_0x1d08d0(0x130)](),_0x5db126=_0x4e7a28==0x1?_0x1d08d0(0x180)+_0xbd76e9:'https://discord.com/api/v9/channels/'+_0xbd76e9+'/messages?limit=50',_0x4048d8={'authorization':_0x4b8a0f},_0x372ee2=await axios_1[_0x1d08d0(0x112)][_0x1d08d0(0xe6)](_0x5db126,{'headers':_0x4048d8});return _0x372ee2[_0x1d08d0(0xe7)];}catch(_0x1a4c38){console['log'](_0x1d08d0(0x121),_0x1a4c38);throw new common_1[(_0x1d08d0(0x100))]('查询绘制结果失败...',common_1[_0x1d08d0(0x119)][_0x1d08d0(0x12a)]);}}async[_0x4b7d50(0x14a)](_0x43ba60){return new Promise(_0x23cf41=>setTimeout(_0x23cf41,_0x43ba60));}['extractContent'](_0x3d6818){const _0x119085=_0x4b7d50,_0x478580=_0x3d6818[_0x119085(0x12f)](/\*\*(.+?)\*\*/),_0x1dc2b6=_0x3d6818['match'](/- Image #(\d+)/);if(!_0x478580||!_0x1dc2b6)return null;const _0x53b67a=_0x478580[0x1],_0x5819b6=parseInt(_0x1dc2b6[0x1]);return{'prompt':_0x53b67a,'order':_0x5819b6};}async[_0x4b7d50(0x130)](){const _0x31dc0a=_0x4b7d50,_0x30616f=await this['globalConfigService'][_0x31dc0a(0xd0)](['mjId','mjApplicationId',_0x31dc0a(0x141),'mjChannelId','mjSessionId',_0x31dc0a(0x15a),_0x31dc0a(0x109),_0x31dc0a(0x17c),_0x31dc0a(0xfd)]),_0x3fa287={'application_id':_0x30616f['mjApplicationId'],'guild_id':_0x30616f['mjGuildId'],'channel_id':_0x30616f[_0x31dc0a(0x161)],'session_id':_0x30616f[_0x31dc0a(0x123)],'version':_0x30616f[_0x31dc0a(0x15a)],'id':_0x30616f[_0x31dc0a(0x160)],'authorization':_0x30616f[_0x31dc0a(0x109)],'mjRateLimit':_0x30616f[_0x31dc0a(0x17c)],'mjProxy':_0x30616f[_0x31dc0a(0xfd)]||0x0};return _0x3fa287;}[_0x4b7d50(0xec)](_0x53f778){const _0x2fe3df=_0x4b7d50,_0x265fac=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x53f778[_0x2fe3df(0xf3)](_0x265fac,'');}async['checkAuth'](_0xc8e979){const _0x4fd0eb=_0x4b7d50,_0x39c9ed=await this['balanceEntity'][_0x4fd0eb(0x127)]({'where':{'userId':_0xc8e979['user']['id']}}),{id:_0x1ac36e,balance:_0x5175b9}=_0x39c9ed;if(!_0x5175b9||(_0x39c9ed===null||_0x39c9ed===void 0x0?void 0x0:_0x39c9ed[_0x4fd0eb(0x16e)])<0x1)throw new common_1['HttpException']('您当前暂无MJ绘画余额！！！',common_1[_0x4fd0eb(0x119)][_0x4fd0eb(0x12a)]);}async[_0x4b7d50(0xee)](_0x596046){const _0x2ead40=_0x4b7d50,{id:_0x136ea4,role:_0x479b27}=_0x596046[_0x2ead40(0x16b)];!this[_0x2ead40(0x174)][_0x136ea4]?this[_0x2ead40(0x174)][_0x136ea4]=0x1:this[_0x2ead40(0x174)][_0x136ea4]=this[_0x2ead40(0x174)][_0x136ea4]+0x1,console['log'](_0x2ead40(0xfc)+_0x136ea4+'使用的次数：',this[_0x2ead40(0x174)][_0x136ea4]);}async[_0x4b7d50(0x11c)](_0x32cd28){const _0x4c7a7e=_0x4b7d50,{id:_0x2d2f8f,role:_0x259db6}=_0x32cd28[_0x4c7a7e(0x16b)];if(['admin',_0x4c7a7e(0x120)][_0x4c7a7e(0x118)](_0x259db6))return!![];const {mjRateLimit:_0x162773}=await this[_0x4c7a7e(0x130)]();if(this[_0x4c7a7e(0x167)][_0x2d2f8f]){const _0x3c3cb2=this['rateLimits'][_0x2d2f8f];if(_0x3c3cb2>Date[_0x4c7a7e(0x156)]()){console[_0x4c7a7e(0x10c)](_0x4c7a7e(0x172)+_0x2d2f8f+_0x4c7a7e(0x110));throw new common_1['HttpException'](_0x4c7a7e(0xf4)+_0x162773+_0x4c7a7e(0xea),common_1['HttpStatus'][_0x4c7a7e(0x12a)]);}else this[_0x4c7a7e(0x167)][_0x2d2f8f]=Date['now']()+Number(_0x162773)*0x3e8;}else{const _0x2a8c80=Date['now']();this[_0x4c7a7e(0x167)][_0x2d2f8f]=_0x2a8c80+0x3e8*Number(_0x162773);}}async['deductBalance'](_0x520430){const _0x3c110b=_0x4b7d50;await this['balanceEntity'][_0x3c110b(0x115)]()[_0x3c110b(0x163)](balance_entity_1[_0x3c110b(0x179)])[_0x3c110b(0xe0)]({'balance':()=>_0x3c110b(0x122)})[_0x3c110b(0x13f)]('userId\x20=\x20:userId',{'userId':_0x520430[_0x3c110b(0x16b)]['id']})[_0x3c110b(0x129)]();}async['test'](){return 0x1;}};function _0x9374(_0x24e544,_0x287a78){const _0x5d1435=_0x5d14();return _0x9374=function(_0x93742b,_0x10006c){_0x93742b=_0x93742b-0xcd;let _0x523ae5=_0x5d1435[_0x93742b];return _0x523ae5;},_0x9374(_0x24e544,_0x287a78);}MjService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x4b7d50(0xf0)])(chatLog_entity_1[_0x4b7d50(0xdb)])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(balance_entity_1[_0x4b7d50(0x179)])),__metadata(_0x4b7d50(0x155),[typeorm_1['Repository'],typeorm_1[_0x4b7d50(0x11e)],upload_service_1[_0x4b7d50(0x14c)],chatLog_service_1[_0x4b7d50(0x14d)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0x4b7d50(0x12d)],badwords_service_1[_0x4b7d50(0x175)]])],MjService),exports['MjService']=MjService;