'use strict';const _0x5108b8=_0x3c49;(function(_0x169abd,_0x233f1e){const _0x7788a0=_0x3c49,_0x3679f5=_0x169abd();while(!![]){try{const _0x307737=parseInt(_0x7788a0(0x6f))/0x1+parseInt(_0x7788a0(0x96))/0x2+-parseInt(_0x7788a0(0xcc))/0x3*(parseInt(_0x7788a0(0x120))/0x4)+-parseInt(_0x7788a0(0xc9))/0x5*(-parseInt(_0x7788a0(0xc5))/0x6)+parseInt(_0x7788a0(0xd5))/0x7+-parseInt(_0x7788a0(0xdd))/0x8+parseInt(_0x7788a0(0x11c))/0x9*(-parseInt(_0x7788a0(0x88))/0xa);if(_0x307737===_0x233f1e)break;else _0x3679f5['push'](_0x3679f5['shift']());}catch(_0x273d31){_0x3679f5['push'](_0x3679f5['shift']());}}}(_0x89d9,0x9134d));var __decorate=this&&this[_0x5108b8(0xe3)]||function(_0x4bf7be,_0x4ade10,_0x4bd080,_0x1ce06c){const _0x5d4de6=_0x5108b8;var _0x43bbf3=arguments[_0x5d4de6(0x8b)],_0x17d2f8=_0x43bbf3<0x3?_0x4ade10:_0x1ce06c===null?_0x1ce06c=Object[_0x5d4de6(0xe6)](_0x4ade10,_0x4bd080):_0x1ce06c,_0x26e289;if(typeof Reflect===_0x5d4de6(0x6c)&&typeof Reflect[_0x5d4de6(0x97)]===_0x5d4de6(0xee))_0x17d2f8=Reflect['decorate'](_0x4bf7be,_0x4ade10,_0x4bd080,_0x1ce06c);else{for(var _0x16e3bb=_0x4bf7be[_0x5d4de6(0x8b)]-0x1;_0x16e3bb>=0x0;_0x16e3bb--)if(_0x26e289=_0x4bf7be[_0x16e3bb])_0x17d2f8=(_0x43bbf3<0x3?_0x26e289(_0x17d2f8):_0x43bbf3>0x3?_0x26e289(_0x4ade10,_0x4bd080,_0x17d2f8):_0x26e289(_0x4ade10,_0x4bd080))||_0x17d2f8;}return _0x43bbf3>0x3&&_0x17d2f8&&Object['defineProperty'](_0x4ade10,_0x4bd080,_0x17d2f8),_0x17d2f8;},__metadata=this&&this[_0x5108b8(0xbc)]||function(_0x2bac48,_0x29db28){const _0x51b708=_0x5108b8;if(typeof Reflect===_0x51b708(0x6c)&&typeof Reflect[_0x51b708(0xce)]===_0x51b708(0xee))return Reflect[_0x51b708(0xce)](_0x2bac48,_0x29db28);},__param=this&&this[_0x5108b8(0xef)]||function(_0x4b68ff,_0x3e94e){return function(_0x4bd4a2,_0x3d173e){_0x3e94e(_0x4bd4a2,_0x3d173e,_0x4b68ff);};};Object['defineProperty'](exports,_0x5108b8(0xd4),{'value':!![]}),exports[_0x5108b8(0xe7)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),upload_service_1=require(_0x5108b8(0x100)),common_1=require(_0x5108b8(0xbb)),axios_1=require(_0x5108b8(0xb6)),chatLog_service_1=require(_0x5108b8(0x94)),balance_constant_1=require(_0x5108b8(0x78)),utils_1=require(_0x5108b8(0x8f)),chatLog_entity_1=require(_0x5108b8(0xdc)),typeorm_1=require(_0x5108b8(0xa5)),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require('../userBalance/balance.entity'),fanyi_service_1=require(_0x5108b8(0x91)),badwords_service_1=require(_0x5108b8(0xfc));function _0x89d9(){const _0x3efde5=['绘制图片任务结束\x20队列-1:\x20','../upload/upload.service','Repository','checkAuth','parse','createQueryBuilder','sendDrawInteractions','uploadFileFromUrl','PAINT_TYPE','findCurrentPromptResult','url','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','extractContent','变换当前图片超时！','当前图片没有绘画信息、无法放大!','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','ChatLogService','历史中存在当前图片、直接获取！','match','pollForResult','放大custom_id:\x20','IsNull','开始请求放大图片\x20队列+1:\x20','发送绘画指令结果:\x20','GlobalConfigService','variationSingleImg','mjProxy','findCurrentEnlargeImgResult','mjAuthorization','3212613upTrRm','createRandomUid','发送放大指令成功','绘画超时，请稍后再试！','12GXQFuG','stringify','prompt','object','历史这些id已经被获取过了\x20不能拿了:\x20','post','491002PcKFhF','查询期间出现错误：','Like','\x20次开始查询\x20=>\x20当前查询结果：','开始查询绘画结果轮询','sleep','uploadService','balanceEntity','saveChatLog','../../common/constants/balance.constant','变换当前图片失败','DeductionKey','开始请求用户','mjId','放大图片任务结束\x20队列-1:\x20','\x20队列+1:\x20','\x20次开始查询[变换图片]','user','baiduFanyiSecret','upscaleSingleImg','error:\x20','getClientIp','由于速率限制、当前普通用户限制为','sendSmInteractions','findCurrentVariationImgResult','30vzWYBn','max','map','length','您当前暂无MJ绘画余额！！！','chatLogEntity','pollForVariationResult','../../common/utils','error','../fanyi/fanyi.service','mjVersion','BadwordsService','../chatLog/chatLog.service','本次绘图耗时:\x20','1612118qiklqt','decorate','components','mjservice','globalConfigService','FanyiService','rateLimits','checkRateLimit','badwordsService','开始轮询单张变换图片结果','message','getMjDefaultParams','有历史信息之间返回:\x20','test','now','typeorm','mjChannelId','randomId:\x20','mjNotSaveImg','mjGuildId','HttpException','super','queryMessageList','variationId','网络连接失败，请稍后再试！','\x20次开始查询','mjApplicationId','fanyiService','绘制图片任务异常中断\x20队列-1:\x20','HttpStatus','prompt\x20-------->\x20\x20','BAD_REQUEST','axios','变化图片任务异常中断\x20队列-1:\x20','绘画失败','当前提示词已经在任务队列中了、请勿重复提交。。。','includes','@nestjs/common','__metadata','default','message_id','mjDraw','drawWorking','当前用户','axios:\x20','filter','历史记录中不存在当前图片、请确认您放大的图片是否存在','6302886bmzABz','https://discord.com/api/v9/interactions','mjSessionId','replace','5TZXDRW','变换图片任务结束\x20队列-1:\x20','data','34032MyAyFk','http://172.247.48.137:8000/mj/draw','metadata','InjectRepository','当前图片已经放大过了、请勿重复放大!','Injectable','admin','find','__esModule','3134439TRaxsl','baiduFanyiAppId','\x20请求过于频繁！','enlargeWorking','orderId','mjRateLimit','execute','../chatLog/chatLog.entity','8765208ZrpqCT','chatLogService','拿到了远程地址:\x20','本次放大图片的id:\x20','removeEmoji','放大图片任务异常中断\x20队列-1:\x20','__decorate','BalanceEntity','push','getOwnPropertyDescriptor','MjService','本次比对的随机ID:\x20','ChatLogEntity','http://172.247.48.137:8000/mj/list?channel_id=','queueCount','开始请求变换图片\x20队列+1:\x20','response','function','__param','存入图片完成:\x20','getConfigs','log','enlarge','checkFree','imagine','当前图片没有绘画信息、无法变体!','design:paramtypes','秒请求一次、请合理使用！','绘图指令完成','pollForUpscaleResult','substring','../badwords/badwords.service','freeQueueUsers','findOne'];_0x89d9=function(){return _0x3efde5;};return _0x89d9();}let MjService=class MjService{constructor(_0x570b30,_0x5a829c,_0x2686f2,_0x3e9200,_0x3c7b95,_0x5d4fc7,_0xc452d9){const _0x3c4ada=_0x5108b8;this[_0x3c4ada(0x8d)]=_0x570b30,this['balanceEntity']=_0x5a829c,this['uploadService']=_0x2686f2,this[_0x3c4ada(0xde)]=_0x3e9200,this[_0x3c4ada(0x9a)]=_0x3c7b95,this[_0x3c4ada(0xb1)]=_0x5d4fc7,this[_0x3c4ada(0x9e)]=_0xc452d9,this['rateLimits']={},this['drawWorking']=[],this[_0x3c4ada(0xd8)]=[],this['queueCount']=0x0,this['freeQueueUsers']={};}async[_0x5108b8(0xbf)](_0x240419){const _0x18bf7b=_0x5108b8,{jobId:_0x5f3369,prompt:_0x2c6b2a,startTime:_0x2b385b,userId:_0x247895}=_0x240419;return console[_0x18bf7b(0xf2)]('绘画任务开始',_0x18bf7b(0x99)),await new Promise(_0x4db50f=>setTimeout(_0x4db50f,0x1388)),{'a':0x1,'b':0x2};}async['draw'](_0x18090d,_0x115657){const _0x437f47=_0x5108b8;await this[_0x437f47(0x102)](_0x115657),await this['badwordsService']['checkBadWords'](_0x18090d[_0x437f47(0x6b)],_0x115657['user']['id']);const _0x2886c9=_0x18090d[_0x437f47(0x6b)];let _0xb57aa6=_0x18090d[_0x437f47(0x6b)];const {baiduFanyiAppId:_0x1b5765,baiduFanyiSecret:_0x2ec32e}=await this['globalConfigService'][_0x437f47(0xf1)]([_0x437f47(0xd6),_0x437f47(0x81)]);_0x1b5765&&_0x2ec32e&&(_0xb57aa6=await this[_0x437f47(0xb1)]['convertToEnglish'](_0x2886c9));const _0x747e63='['+(0x0,utils_1[_0x437f47(0x11d)])()+']',_0x492604=_0x747e63+'\x20'+_0xb57aa6;console[_0x437f47(0xf2)](_0x437f47(0xa7),_0x747e63),console[_0x437f47(0xf2)](_0x437f47(0xb4),_0x492604);const _0x509d94=this['drawWorking'][_0x437f47(0xd3)](_0x1069dd=>_0x1069dd['includes'](_0x18090d[_0x437f47(0x6b)]));if(_0x509d94)throw new common_1[(_0x437f47(0xaa))](_0x437f47(0xb9),common_1[_0x437f47(0xb3)][_0x437f47(0xb5)]);if(this['queueCount']>=0x3)throw new common_1[(_0x437f47(0xaa))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x437f47(0xb3)]['BAD_REQUEST']);await this['checkRateLimit'](_0x115657),this[_0x437f47(0xeb)]++,console[_0x437f47(0xf2)](_0x437f47(0x7b)+_0x115657['user']['id']+_0x437f47(0x7e),this['queueCount']);try{const _0xa1b932=await this[_0x437f47(0x8d)]['find']({'where':{'prompt':(0x0,typeorm_1[_0x437f47(0x71)])('%'+_0x492604+'%')}}),_0x2d99fa=_0xa1b932[_0x437f47(0x8a)](_0x582bcb=>_0x582bcb[_0x437f47(0xbe)]);this['drawWorking'][_0x437f47(0xe5)](_0x492604);let _0x241cd1;const _0x8995b8=await this[_0x437f47(0x105)](_0x492604,_0x2d99fa,_0x747e63);_0x8995b8?(console[_0x437f47(0xf2)](_0x437f47(0x110)),_0x241cd1=_0x8995b8):_0x241cd1=await this[_0x437f47(0x112)](_0x492604,_0x2d99fa,_0x747e63);this[_0x437f47(0xeb)]--,this[_0x437f47(0xeb)]<0x0&&(this[_0x437f47(0xeb)]=0x0),console[_0x437f47(0xf2)](_0x437f47(0xff),this[_0x437f47(0xeb)]);const {id:_0x4068a4,content:_0x24e3f5,channel_id:_0x5d8a0f,attachments:attachments=[],timestamp:_0x1cbc44}=_0x241cd1;if(!attachments[_0x437f47(0x8b)]||!attachments[0x0][_0x437f47(0x109)])throw new common_1[(_0x437f47(0xaa))](_0x437f47(0xb8),common_1[_0x437f47(0xb3)][_0x437f47(0xb5)]);const {filename:_0x3b8bff,url:_0x157ca5,width:_0x36a776,height:_0x8e8f3a,size:_0x5dd77c}=attachments[0x0];console[_0x437f47(0xf2)](_0x437f47(0xdf),_0x157ca5);const _0x32fc99=this[_0x437f47(0x9a)][_0x437f47(0xf1)]([_0x437f47(0xa8)]);let _0x3c9b79='';(!Number(_0x32fc99)||Number(_0x32fc99)===0x0)&&(_0x3c9b79=await this[_0x437f47(0x75)][_0x437f47(0x106)]({'filename':_0x3b8bff,'url':_0x157ca5}),console[_0x437f47(0xf2)](_0x437f47(0xf0),_0x3c9b79));const _0x4cbd4b={'curIp':(0x0,utils_1[_0x437f47(0x84)])(_0x115657),'userId':_0x115657['user']['id'],'type':balance_constant_1[_0x437f47(0x7a)]['PAINT_TYPE'],'prompt':_0x492604,'answer':_0x3c9b79,'model':'mj','extend':this['removeEmoji'](JSON[_0x437f47(0x121)](_0x241cd1)),'message_id':_0x4068a4,'variationId':_0x4068a4,'upscaleId':_0x4068a4,'group':0x1,'isSaveImg':!Number(_0x32fc99)||Number(_0x32fc99)===0x0,'fileInfo':JSON[_0x437f47(0x121)]({'width':_0x36a776,'height':_0x8e8f3a,'size':_0x5dd77c,'filename':_0x3b8bff,'cosUrl':_0x3c9b79})};return await this['chatLogService'][_0x437f47(0x77)](_0x4cbd4b),await this['deductBalance'](_0x115657),this['drawWorking']=this['drawWorking'][_0x437f47(0xc3)](_0x5d862b=>_0x5d862b!==_0x18090d[_0x437f47(0x6b)]),_0x3c9b79;}catch(_0x4575e5){this[_0x437f47(0xeb)]--,this[_0x437f47(0xeb)]<0x0&&(this['queueCount']=0x0),console['log'](_0x437f47(0xb2),this[_0x437f47(0xeb)]),this[_0x437f47(0xc0)]=this[_0x437f47(0xc0)][_0x437f47(0xc3)](_0x116458=>_0x116458!==_0x18090d[_0x437f47(0x6b)]);throw new common_1[(_0x437f47(0xaa))](_0x4575e5[_0x437f47(0xed)],common_1[_0x437f47(0xb3)][_0x437f47(0xb5)]);}}async[_0x5108b8(0x82)](_0x509869,_0x27703e){const _0x179883=_0x5108b8;if(this[_0x179883(0xeb)]>=0x3)throw new common_1['HttpException']('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x179883(0xb3)][_0x179883(0xb5)]);this[_0x179883(0xeb)]++,console['log']('用户'+_0x27703e[_0x179883(0x80)]['id']+_0x179883(0x115),this['queueCount']);const {message_id:_0x180fb3,orderId:_0xa81fce}=_0x509869;try{const _0x17e4bf=await this[_0x179883(0x8d)][_0x179883(0xfe)]({'where':{'message_id':_0x180fb3}});if(!_0x17e4bf)throw new common_1[(_0x179883(0xaa))](_0x179883(0xc4),common_1[_0x179883(0xb3)][_0x179883(0xb5)]);const _0x239474=await this[_0x179883(0x8d)]['findOne']({'where':{'upscaleId':_0x180fb3,'action':'enlarge','orderId':_0xa81fce}});if(_0x239474)throw new common_1[(_0x179883(0xaa))](_0x179883(0xd0),common_1[_0x179883(0xb3)]['BAD_REQUEST']);const {prompt:_0x574561,extend:_0x50cc5e}=_0x17e4bf;let _0x2135dc=null;try{_0x2135dc=JSON[_0x179883(0x103)](_0x50cc5e);}catch(_0x1fc764){_0x2135dc=[];}const {components:components=[]}=_0x2135dc;if(!components[_0x179883(0x8b)])throw new common_1[(_0x179883(0xaa))](_0x179883(0x10d),common_1['HttpStatus']['BAD_REQUEST']);const _0x4b53a4=components[0x0]['components'][_0xa81fce-0x1],{custom_id:_0x13cf94}=_0x4b53a4;console[_0x179883(0xf2)](_0x179883(0x113),_0x13cf94);const _0x1edbe7={'message_id':_0x180fb3,'custom_id':_0x13cf94,'prompt':_0x574561,'orderId':_0xa81fce};await this[_0x179883(0x86)](_0x1edbe7),console['log'](_0x179883(0x11e));const _0x457284=await this[_0x179883(0x8d)][_0x179883(0xd3)]({'where':{'prompt':(0x0,typeorm_1[_0x179883(0x71)])('%'+_0x574561+'%')}}),_0x5caaaf=_0x457284['map'](_0x5baafa=>_0x5baafa[_0x179883(0xbe)]);console[_0x179883(0xf2)](_0x179883(0x6d),_0x5caaaf);const _0x1273b9=await this['pollForUpscaleResult'](_0x1edbe7,_0x5caaaf);this[_0x179883(0xeb)]--,this['queueCount']<0x0&&(this[_0x179883(0xeb)]=0x0),console[_0x179883(0xf2)](_0x179883(0x7d),this['queueCount']);const {id:_0xa1e87f,content:_0x5585c4,channel_id:_0x366b16,attachments:attachments=[],timestamp:_0x5570d6}=_0x1273b9;if(!attachments['length']||!attachments[0x0][_0x179883(0x109)])throw new common_1[(_0x179883(0xaa))]('放大当前图片失败',common_1[_0x179883(0xb3)][_0x179883(0xb5)]);const {filename:_0x15be3c,url:_0x2bb7ce,width:_0x30a55e,height:_0x3fc541,size:_0x2e7c03}=attachments[0x0],_0xd02959=this[_0x179883(0x9a)][_0x179883(0xf1)]([_0x179883(0xa8)]);let _0x1ef760='';(!Number(_0xd02959)||Number(_0xd02959)===0x0)&&(_0x1ef760=await this[_0x179883(0x75)][_0x179883(0x106)]({'filename':_0x15be3c,'url':_0x2bb7ce}),console['log'](_0x179883(0xf0),_0x1ef760));const _0x38c05a={'curIp':(0x0,utils_1['getClientIp'])(_0x27703e),'userId':_0x27703e[_0x179883(0x80)]['id'],'type':balance_constant_1[_0x179883(0x7a)][_0x179883(0x107)],'prompt':_0x574561,'answer':_0x1ef760,'model':'mj','extend':this[_0x179883(0xe1)](JSON[_0x179883(0x121)](_0x1273b9)),'message_id':_0x180fb3,'upscaleId':_0xa1e87f,'variationId':_0xa1e87f,'action':_0x179883(0xf3),'orderId':_0x1edbe7[_0x179883(0xd9)],'isSaveImg':!Number(_0xd02959)||Number(_0xd02959)===0x0,'fileInfo':JSON[_0x179883(0x121)]({'width':_0x30a55e,'height':_0x3fc541,'size':_0x2e7c03,'filename':_0x15be3c,'cosUrl':_0x1ef760})};return await this['chatLogService'][_0x179883(0x77)](_0x38c05a),_0x1ef760;}catch(_0x4861b6){console[_0x179883(0xf2)](_0x179883(0x83),_0x4861b6),this[_0x179883(0xeb)]--,this[_0x179883(0xeb)]<0x0&&(this['queueCount']=0x0),console['log'](_0x179883(0xe2),this[_0x179883(0xeb)]);throw new common_1[(_0x179883(0xaa))](_0x4861b6[_0x179883(0xed)],common_1['HttpStatus'][_0x179883(0xb5)]);}}async[_0x5108b8(0x118)](_0xd55345,_0xecf901){const _0x48940d=_0x5108b8;if(this[_0x48940d(0xeb)]>=0x3)throw new common_1[(_0x48940d(0xaa))](_0x48940d(0x10a),common_1[_0x48940d(0xb3)][_0x48940d(0xb5)]);await this[_0x48940d(0x102)](_0xecf901),await this[_0x48940d(0x9d)](_0xecf901),this[_0x48940d(0xeb)]++,console[_0x48940d(0xf2)]('用户'+_0xecf901[_0x48940d(0x80)]['id']+_0x48940d(0xec),this[_0x48940d(0xeb)]);const {message_id:_0x31333b,orderId:_0x854c60}=_0xd55345;try{const _0x2bc5a=await this[_0x48940d(0x8d)][_0x48940d(0xfe)]({'where':{'message_id':_0x31333b}});if(!_0x2bc5a)throw new common_1[(_0x48940d(0xaa))]('历史记录中不存在当前图片、请确认您需要变换的图片是否存在',common_1['HttpStatus']['BAD_REQUEST']);const {prompt:_0xe20a33,extend:_0x177063}=_0x2bc5a;let _0x43bfce=null;try{_0x43bfce=JSON[_0x48940d(0x103)](_0x177063);}catch(_0x2c4450){_0x43bfce=[];}const {components:components=[]}=_0x43bfce;if(!components['length'])throw new common_1['HttpException'](_0x48940d(0xf6),common_1['HttpStatus'][_0x48940d(0xb5)]);const _0x4012ba=components[0x1][_0x48940d(0x98)][_0x854c60-0x1],{custom_id:_0x2207cd}=_0x4012ba,_0x1339af=await this[_0x48940d(0x8d)][_0x48940d(0xd3)]({'where':{'variationId':(0x0,typeorm_1['Not'])((0x0,typeorm_1[_0x48940d(0x114)])()),'prompt':(0x0,typeorm_1[_0x48940d(0x71)])('%'+_0xe20a33+'%')}}),_0x382bd6=_0x1339af[_0x48940d(0x8a)](_0x1def8d=>_0x1def8d[_0x48940d(0xad)]),_0x12dfdc={'message_id':_0x31333b,'custom_id':_0x2207cd,'prompt':_0xe20a33,'orderId':_0x854c60};await this[_0x48940d(0x86)](_0x12dfdc);const _0x1f1b5b=await this['pollForVariationResult'](_0x12dfdc,_0x382bd6);this[_0x48940d(0xeb)]--,this['queueCount']<0x0&&(this[_0x48940d(0xeb)]=0x0),console['log'](_0x48940d(0xca),this[_0x48940d(0xeb)]);const {id:_0x585492,content:_0xe76652,channel_id:_0x54f748,attachments:attachments=[],timestamp:_0x33740f}=_0x1f1b5b;if(!attachments[_0x48940d(0x8b)]||!attachments[0x0][_0x48940d(0x109)])throw new common_1[(_0x48940d(0xaa))](_0x48940d(0x79),common_1['HttpStatus'][_0x48940d(0xb5)]);const {filename:_0x5f4abe,url:_0x1acb6f,width:_0x5e8349,height:_0x1c835d,size:_0x999ae8}=attachments[0x0],_0x340c07=this[_0x48940d(0x9a)][_0x48940d(0xf1)](['mjNotSaveImg']);let _0x5ad836='';(!Number(_0x340c07)||Number(_0x340c07)===0x0)&&(_0x5ad836=await this[_0x48940d(0x75)][_0x48940d(0x106)]({'filename':_0x5f4abe,'url':_0x1acb6f}),console['log'](_0x48940d(0xf0),_0x5ad836));const _0x3cd2d3={'curIp':(0x0,utils_1[_0x48940d(0x84)])(_0xecf901),'userId':_0xecf901['user']['id'],'type':balance_constant_1[_0x48940d(0x7a)][_0x48940d(0x107)],'prompt':_0xe20a33,'answer':_0x5ad836,'model':'mj','group':0x1,'extend':this[_0x48940d(0xe1)](JSON['stringify'](_0x1f1b5b)),'message_id':_0x585492,'upscaleId':_0x585492,'variationId':_0x585492,'action':_0x48940d(0xf3),'orderId':_0x12dfdc[_0x48940d(0xd9)],'isSaveImg':!Number(_0x340c07)||Number(_0x340c07)===0x0,'fileInfo':JSON[_0x48940d(0x121)]({'width':_0x5e8349,'height':_0x1c835d,'size':_0x999ae8,'filename':_0x5f4abe,'cosUrl':_0x5ad836})};return await this[_0x48940d(0xde)]['saveChatLog'](_0x3cd2d3),_0x5ad836;}catch(_0x5cac3f){console['log'](_0x48940d(0x83),_0x5cac3f),this[_0x48940d(0xeb)]--,this[_0x48940d(0xeb)]<0x0&&(this[_0x48940d(0xeb)]=0x0),console[_0x48940d(0xf2)](_0x48940d(0xb7),this[_0x48940d(0xeb)]);throw new common_1['HttpException'](_0x5cac3f[_0x48940d(0xed)],common_1[_0x48940d(0xb3)][_0x48940d(0xb5)]);}}async[_0x5108b8(0x86)](_0x3a796a){const _0x31fc6f=_0x5108b8,{message_id:_0x5d896a,custom_id:_0x1c7dda}=_0x3a796a,{application_id:_0x20877a,guild_id:_0x28c830,channel_id:_0x2079b5,session_id:_0x37f6da,version:_0x899326,id:_0x2811f7,authorization:_0x5d535a,mjProxy:_0x248d41}=await this[_0x31fc6f(0xa1)](),_0x1f4243=_0x248d41==0x1?_0x31fc6f(0xcd):_0x31fc6f(0xc6),_0x298185={'authorization':_0x5d535a},_0xc77d46={'type':0x3,'guild_id':_0x28c830,'channel_id':_0x2079b5,'message_flags':0x0,'message_id':_0x5d896a,'application_id':_0x20877a,'session_id':_0x37f6da,'data':{'component_type':0x2,'custom_id':_0x1c7dda}};try{await axios_1['default'][_0x31fc6f(0x6e)](_0x1f4243,_0xc77d46,{'headers':_0x298185}),console[_0x31fc6f(0xf2)](_0x31fc6f(0xf9));}catch(_0x5dafc2){console[_0x31fc6f(0xf2)]('error:\x20',_0x5dafc2);throw new common_1[(_0x31fc6f(0xaa))]('放大单张图片请求失败...',common_1[_0x31fc6f(0xb3)][_0x31fc6f(0xb5)]);}}async[_0x5108b8(0xfa)](_0x532a5c,_0xc6b9b3){const _0x2444ca=_0x5108b8,{message_id:_0x3f4bba,custom_id:_0x2fd288,prompt:_0x54feb1,orderId:_0x490670}=_0x532a5c;let _0x32171c=null,_0x3c6462=0x0;while(!_0x32171c&&_0x3c6462<0xa){try{const _0x57dcf8=Date['now'](),_0x4251e9=await this[_0x2444ca(0xac)]();console[_0x2444ca(0xf2)]('第\x20'+(_0x3c6462+0x1)+_0x2444ca(0x72)+_0x4251e9[_0x2444ca(0x8b)]);_0x4251e9&&_0x4251e9[_0x2444ca(0x8b)]&&(_0x32171c=await this['findCurrentEnlargeImgResult'](_0x4251e9,_0x532a5c,_0xc6b9b3));const _0x151b6c=Date[_0x2444ca(0xa4)]()-_0x57dcf8,_0x3b507b=0xbb8;await this[_0x2444ca(0x74)](Math[_0x2444ca(0x89)](_0x3b507b-_0x151b6c,0x0)),_0x3c6462++;}catch(_0x522e96){console[_0x2444ca(0x90)](_0x2444ca(0x70)+_0x522e96[_0x2444ca(0xa0)]);}}return _0x32171c;}async[_0x5108b8(0x8e)](_0x4e9954,_0x56fd39){const _0x4d45ce=_0x5108b8,{message_id:_0x357b33,custom_id:_0x5cff5b,prompt:_0xa4f2dc,orderId:_0x157d00}=_0x4e9954;console['log'](_0x4d45ce(0x9f));let _0x3c79fb=null,_0x11084a=0x0;while(!_0x3c79fb&&_0x11084a<0xa){try{console['log']('第\x20'+(_0x11084a+0x1)+_0x4d45ce(0x7f));const _0x34a6e0=Date[_0x4d45ce(0xa4)](),_0x475edf=await this[_0x4d45ce(0xac)]();_0x475edf&&_0x475edf[_0x4d45ce(0x8b)]&&(_0x3c79fb=await this[_0x4d45ce(0x87)](_0x475edf,_0x4e9954,_0x56fd39));const _0xaccc6=Date[_0x4d45ce(0xa4)]()-_0x34a6e0,_0x1adae4=0x1f40;await this[_0x4d45ce(0x74)](Math[_0x4d45ce(0x89)](_0x1adae4-_0xaccc6,0x0)),_0x11084a++;}catch(_0x265d62){console['error']('查询期间出现错误：'+_0x265d62['message']);}}if(!_0x3c79fb)throw new common_1['HttpException'](_0x4d45ce(0x10c),common_1['HttpStatus'][_0x4d45ce(0xb5)]);return _0x3c79fb;}async[_0x5108b8(0x11a)](_0xf0aca3,_0x53517a,_0x559c76){const _0x4e8871=_0x5108b8,{message_id:_0x344f1b,custom_id:_0x370f2,prompt:_0x1caa2b,orderId:_0x5f2ab8}=_0x53517a,_0x15a593=_0x1caa2b['substring'](0x0,0xc);console[_0x4e8871(0xf2)](_0x4e8871(0xe0),_0x15a593);const _0x3d5b62=_0xf0aca3[_0x4e8871(0xd3)](_0x43fb8e=>{const _0x133aa4=_0x4e8871,{content:_0x3ad6c7}=_0x43fb8e;if(!this[_0x133aa4(0x10b)](_0x3ad6c7))return![];const {prompt:_0x49377b,order:_0x17da02}=this['extractContent'](_0x3ad6c7);return _0x49377b[_0x133aa4(0xba)](_0x15a593)&&_0x53517a[_0x133aa4(0xd9)]===_0x17da02&&!_0x559c76[_0x133aa4(0xba)](_0x43fb8e['id']);});return _0x3d5b62;}async[_0x5108b8(0x87)](_0x2643b4,_0x122d7c,_0x18acfb){const _0x343d63=_0x5108b8,{message_id:_0x5ed02f,custom_id:_0x1a96b1,prompt:_0x26ea0b,orderId:_0x560349}=_0x122d7c,_0x2556c3=_0x26ea0b[_0x343d63(0xfb)](0x0,0xc),_0x370bcf=_0x2643b4[_0x343d63(0xd3)](_0x3e71d1=>{const _0x487044=_0x343d63,{content:_0x3d4e17}=_0x3e71d1,_0x100d30=_0x3d4e17[_0x487044(0x111)](/\*\*(.+?)\*\*/),_0x1342f1=_0x100d30?_0x100d30[0x1]:'';if(!_0x1342f1)return![];return _0x1342f1[_0x487044(0xba)](_0x2556c3)&&!_0x18acfb['includes'](_0x3e71d1['id']);});return _0x370bcf;}async[_0x5108b8(0x105)](_0x5407cc,_0x1ed9da,_0xce93da){const _0x52da72=_0x5108b8,_0x211386=await this['queryMessageList'](),_0xbca4eb=await this[_0x52da72(0x108)](_0x211386,_0xce93da,_0x1ed9da);if(_0xbca4eb)return console[_0x52da72(0xf2)](_0x52da72(0xa2),_0xbca4eb),_0xbca4eb;const {application_id:_0x14f82e,guild_id:_0x3caea6,channel_id:_0x12a017,session_id:_0xed08c9,version:_0x107425,id:_0x172a28,authorization:_0x2d8afe,mjProxy:_0x3766ef}=await this[_0x52da72(0xa1)](),_0xf03d71={'type':0x2,'application_id':_0x14f82e,'guild_id':_0x3caea6,'channel_id':_0x12a017,'session_id':_0xed08c9,'data':{'version':_0x107425,'id':_0x172a28,'name':_0x52da72(0xf5),'type':0x1,'options':[{'type':0x3,'name':_0x52da72(0x6b),'value':_0x5407cc}],'attachments':[]}};try{const _0xcc279=_0x3766ef==0x1?_0x52da72(0xcd):_0x52da72(0xc6),_0x35d0c7={'authorization':_0x2d8afe},_0x5d8882=await axios_1[_0x52da72(0xbd)][_0x52da72(0x6e)](_0xcc279,_0xf03d71,{'headers':_0x35d0c7});return console[_0x52da72(0xf2)](_0x52da72(0x116),_0x5d8882[_0x52da72(0xcb)]),![];}catch(_0x2a82c5){console['log'](_0x52da72(0xc2),_0x2a82c5);throw new common_1[(_0x52da72(0xaa))](_0x52da72(0x10e),common_1[_0x52da72(0xb3)][_0x52da72(0xb5)]);}}async[_0x5108b8(0x112)](_0x5b5c63,_0x3b1004,_0xf1a705){const _0x5980bb=_0x5108b8;console[_0x5980bb(0xf2)](_0x5980bb(0x73));const _0x3ff2e5=Date[_0x5980bb(0xa4)]();try{const _0x434c61=0xd,_0x5f0709=0x2ee0,_0x59cf18=0x1388,_0x4d6e38=0x3c*0x3e8;let _0x5720b9=0x0,_0x43bb80=![],_0x31dfd8=null;while(!_0x31dfd8&&_0x5720b9<_0x434c61){console['log']('第\x20'+(_0x5720b9+0x1)+_0x5980bb(0xaf));Date['now']()-_0x3ff2e5>=_0x4d6e38&&(_0x43bb80=!![]);await this[_0x5980bb(0x74)](_0x43bb80?_0x59cf18:_0x5f0709);const _0x578520=await this[_0x5980bb(0xac)]();_0x31dfd8=await this['findCurrentPromptResult'](_0x578520,_0xf1a705,_0x3b1004),_0x5720b9++;}if(!_0x31dfd8)throw new common_1[(_0x5980bb(0xaa))](_0x5980bb(0x11f),common_1[_0x5980bb(0xb3)][_0x5980bb(0xb5)]);const _0x293b79=Date[_0x5980bb(0xa4)]();return console[_0x5980bb(0xf2)](_0x5980bb(0x95)+Math['floor']((_0x293b79-_0x3ff2e5)/0x3e8)+'\x20S'),_0x31dfd8;}catch(_0x4e719c){console[_0x5980bb(0x90)](_0x4e719c[_0x5980bb(0xa0)]);throw new common_1[(_0x5980bb(0xaa))](_0x5980bb(0xae),common_1[_0x5980bb(0xb3)]['INTERNAL_SERVER_ERROR']);}}async['findCurrentPromptResult'](_0x48a537,_0x4437e8,_0x94a473){const _0xedc562=_0x5108b8;if(!_0x48a537||!_0x48a537[_0xedc562(0x8b)])return;console['log'](_0xedc562(0xe8),_0x4437e8);const _0x439339=_0x48a537[_0xedc562(0xd3)](_0x117c34=>{const _0x69db51=_0xedc562,{attachments:attachments=[],content:_0x28c096,edited_timestamp:_0x18ab37}=_0x117c34;return _0x28c096[_0x69db51(0xba)](_0x4437e8)&&attachments[_0x69db51(0x8b)]>0x0&&!_0x18ab37&&!_0x94a473[_0x69db51(0xba)](_0x117c34['id']);});return _0x439339||null;}async['queryMessageList'](){const _0x1671a5=_0x5108b8;try{const {application_id:_0x474967,guild_id:_0x59e84a,channel_id:_0x2bd048,session_id:_0x3d0fed,version:_0x30c166,id:_0x111a7b,authorization:_0x6a791c,mjProxy:_0x385fb8}=await this[_0x1671a5(0xa1)](),_0xd37792=_0x385fb8==0x1?_0x1671a5(0xea)+_0x2bd048:'https://discord.com/api/v9/channels/'+_0x2bd048+'/messages?limit=50',_0x1fce5d={'authorization':_0x6a791c},_0x50adc9=await axios_1['default']['get'](_0xd37792,{'headers':_0x1fce5d});return _0x50adc9[_0x1671a5(0xcb)];}catch(_0xc37a43){console[_0x1671a5(0xf2)]('axios\x20get:\x20',_0xc37a43);throw new common_1['HttpException']('查询绘制结果失败...',common_1[_0x1671a5(0xb3)][_0x1671a5(0xb5)]);}}async[_0x5108b8(0x74)](_0x1f3d14){return new Promise(_0x5cf49f=>setTimeout(_0x5cf49f,_0x1f3d14));}[_0x5108b8(0x10b)](_0x5de66c){const _0x3a0af3=_0x5108b8,_0x26b3eb=_0x5de66c['match'](/\*\*(.+?)\*\*/),_0x329a66=_0x5de66c[_0x3a0af3(0x111)](/- Image #(\d+)/);if(!_0x26b3eb||!_0x329a66)return null;const _0x16f1d7=_0x26b3eb[0x1],_0x2cb95e=parseInt(_0x329a66[0x1]);return{'prompt':_0x16f1d7,'order':_0x2cb95e};}async['getMjDefaultParams'](){const _0x39d462=_0x5108b8,_0x346c21=await this[_0x39d462(0x9a)][_0x39d462(0xf1)]([_0x39d462(0x7c),_0x39d462(0xb0),_0x39d462(0xa9),_0x39d462(0xa6),_0x39d462(0xc7),'mjVersion',_0x39d462(0x11b),'mjRateLimit','mjProxy']),_0x3149a8={'application_id':_0x346c21[_0x39d462(0xb0)],'guild_id':_0x346c21[_0x39d462(0xa9)],'channel_id':_0x346c21[_0x39d462(0xa6)],'session_id':_0x346c21[_0x39d462(0xc7)],'version':_0x346c21[_0x39d462(0x92)],'id':_0x346c21[_0x39d462(0x7c)],'authorization':_0x346c21[_0x39d462(0x11b)],'mjRateLimit':_0x346c21[_0x39d462(0xda)],'mjProxy':_0x346c21[_0x39d462(0x119)]||0x0};return _0x3149a8;}[_0x5108b8(0xe1)](_0x3deaf0){const _0x157071=_0x5108b8,_0x245e6d=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x3deaf0[_0x157071(0xc8)](_0x245e6d,'');}async['checkAuth'](_0xa382b4){const _0x13d278=_0x5108b8,_0x30ff75=await this[_0x13d278(0x76)][_0x13d278(0xfe)]({'where':{'userId':_0xa382b4[_0x13d278(0x80)]['id']}}),{id:_0x2626c6,balance:_0x118859}=_0x30ff75;if(!_0x118859||(_0x30ff75===null||_0x30ff75===void 0x0?void 0x0:_0x30ff75['balance'])<0x1)throw new common_1['HttpException'](_0x13d278(0x8c),common_1[_0x13d278(0xb3)][_0x13d278(0xb5)]);}async[_0x5108b8(0xf4)](_0x22ed5f){const _0x1382fb=_0x5108b8,{id:_0x476dfb,role:_0x2259a8}=_0x22ed5f[_0x1382fb(0x80)];!this[_0x1382fb(0xfd)][_0x476dfb]?this[_0x1382fb(0xfd)][_0x476dfb]=0x1:this[_0x1382fb(0xfd)][_0x476dfb]=this['freeQueueUsers'][_0x476dfb]+0x1,console[_0x1382fb(0xf2)](_0x1382fb(0xc1)+_0x476dfb+'使用的次数：',this['freeQueueUsers'][_0x476dfb]);}async[_0x5108b8(0x9d)](_0x519cb2){const _0x192b77=_0x5108b8,{id:_0x189f4f,role:_0x131d80}=_0x519cb2[_0x192b77(0x80)];if([_0x192b77(0xd2),_0x192b77(0xab)][_0x192b77(0xba)](_0x131d80))return!![];const {mjRateLimit:_0x380fac}=await this[_0x192b77(0xa1)]();if(this[_0x192b77(0x9c)][_0x189f4f]){const _0x5f1efe=this[_0x192b77(0x9c)][_0x189f4f];if(_0x5f1efe>Date[_0x192b77(0xa4)]()){console[_0x192b77(0xf2)]('当前用户\x20'+_0x189f4f+_0x192b77(0xd7));throw new common_1['HttpException'](_0x192b77(0x85)+_0x380fac+_0x192b77(0xf8),common_1[_0x192b77(0xb3)]['BAD_REQUEST']);}else this[_0x192b77(0x9c)][_0x189f4f]=Date['now']()+Number(_0x380fac)*0x3e8;}else{const _0x225af5=Date[_0x192b77(0xa4)]();this[_0x192b77(0x9c)][_0x189f4f]=_0x225af5+0x3e8*Number(_0x380fac);}}async['deductBalance'](_0x54d6e5){const _0x3f22a9=_0x5108b8;await this['balanceEntity'][_0x3f22a9(0x104)]()['update'](balance_entity_1[_0x3f22a9(0xe4)])['set']({'balance':()=>'balance\x20-\x201'})['where']('userId\x20=\x20:userId',{'userId':_0x54d6e5[_0x3f22a9(0x80)]['id']})[_0x3f22a9(0xdb)]();}async[_0x5108b8(0xa3)](){return 0x1;}};function _0x3c49(_0x17b747,_0x426548){const _0x89d905=_0x89d9();return _0x3c49=function(_0x3c499e,_0x4e5b47){_0x3c499e=_0x3c499e-0x6b;let _0xf3464e=_0x89d905[_0x3c499e];return _0xf3464e;},_0x3c49(_0x17b747,_0x426548);}MjService=__decorate([(0x0,common_1[_0x5108b8(0xd1)])(),__param(0x0,(0x0,typeorm_2[_0x5108b8(0xcf)])(chatLog_entity_1[_0x5108b8(0xe9)])),__param(0x1,(0x0,typeorm_2[_0x5108b8(0xcf)])(balance_entity_1[_0x5108b8(0xe4)])),__metadata(_0x5108b8(0xf7),[typeorm_1[_0x5108b8(0x101)],typeorm_1[_0x5108b8(0x101)],upload_service_1['UploadService'],chatLog_service_1[_0x5108b8(0x10f)],globalConfig_service_1[_0x5108b8(0x117)],fanyi_service_1[_0x5108b8(0x9b)],badwords_service_1[_0x5108b8(0x93)]])],MjService),exports[_0x5108b8(0xe7)]=MjService;