'use strict';const _0x37abd6=_0x5e5d;function _0x5e5d(_0x54295d,_0x839512){const _0x421e78=_0x421e();return _0x5e5d=function(_0x5e5d55,_0x1978e4){_0x5e5d55=_0x5e5d55-0x1e3;let _0x52c31e=_0x421e78[_0x5e5d55];return _0x52c31e;},_0x5e5d(_0x54295d,_0x839512);}(function(_0x4d01ee,_0x478599){const _0x49bad8=_0x5e5d,_0x28fe5e=_0x4d01ee();while(!![]){try{const _0x46a1f5=parseInt(_0x49bad8(0x217))/0x1+-parseInt(_0x49bad8(0x1f7))/0x2+parseInt(_0x49bad8(0x1ed))/0x3*(-parseInt(_0x49bad8(0x246))/0x4)+-parseInt(_0x49bad8(0x27e))/0x5+-parseInt(_0x49bad8(0x263))/0x6*(parseInt(_0x49bad8(0x206))/0x7)+-parseInt(_0x49bad8(0x200))/0x8*(parseInt(_0x49bad8(0x215))/0x9)+parseInt(_0x49bad8(0x283))/0xa;if(_0x46a1f5===_0x478599)break;else _0x28fe5e['push'](_0x28fe5e['shift']());}catch(_0x209b7d){_0x28fe5e['push'](_0x28fe5e['shift']());}}}(_0x421e,0x74ef3));function _0x421e(){const _0x3255ba=['find','ChatLogService','pollForVariationResult','查询期间出现错误：','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','message','chatLogService','length','baiduFanyiAppId','push','本次绘图耗时:\x20','sendSmInteractions','变化图片任务异常中断\x20队列-1:\x20','../../common/utils','default','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','createQueryBuilder','execute','mjDraw','\x20队列+1:\x20','mjAuthorization','extractContent','design:paramtypes','HttpException','变换图片任务结束\x20队列-1:\x20','放大当前图片失败','108644CYVvTP','INTERNAL_SERVER_ERROR','set','floor','user','mjApplicationId','DeductionKey','历史这些id已经被获取过了\x20不能拿了:\x20','变换当前图片超时！','mjChannelId','globalConfigService','历史中存在当前图片、直接获取！','@nestjs/common','BalanceEntity','mjRateLimit','filter','当前用户\x20','fanyiService','../chatLog/chatLog.entity','error','test','\x20次开始查询\x20=>\x20当前查询结果：','queryMessageList','data','rateLimits','upscaleSingleImg','uploadService','sleep','InjectRepository','6whApcp','绘图指令完成','badwordsService','function','绘制图片任务异常中断\x20队列-1:\x20','findCurrentVariationImgResult','substring','mjSessionId','有历史信息之间返回:\x20','draw','放大custom_id:\x20','randomId:\x20','axios:\x20','parse','由于速率限制、当前普通用户限制为','includes','error:\x20','stringify','findCurrentEnlargeImgResult','../chatLog/chatLog.service','checkFree','message_id','chatLogEntity','update','typeorm','enlarge','url','3075660QQekCm','当前图片没有绘画信息、无法变体!','您当前暂无MJ绘画余额！！！','__decorate','admin','34870590xJaioi','PAINT_TYPE','balance\x20-\x201','log','match','http://172.247.48.137:8000/mj/draw','IsNull','removeEmoji','now','开始查询绘画结果轮询','uploadFileFromUrl','本次放大图片的id:\x20','checkAuth','Not','balanceEntity','\x20请求过于频繁！','/messages?limit=50','变换当前图片失败','mjGuildId','存入图片完成:\x20','当前用户','秒请求一次、请合理使用！','Injectable','../userBalance/balance.entity','ChatLogEntity','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','userId\x20=\x20:userId','90IuHxVb','sendDrawInteractions','网络连接失败，请稍后再试！','../badwords/badwords.service','历史记录中不存在当前图片、请确认您放大的图片是否存在','__param','开始请求放大图片\x20队列+1:\x20','开始请求用户','Repository','response','1016066CsGabZ','\x20次开始查询','https://discord.com/api/v9/interactions','放大单张图片请求失败...','orderId','post','deductBalance','metadata','checkBadWords','1704ZuVVrR','saveChatLog','map','getClientIp','Like','pollForResult','5630443dqFtGU','axios','../globalConfig/globalConfig.service','checkRateLimit','HttpStatus','freeQueueUsers','getOwnPropertyDescriptor','imagine','components','getMjDefaultParams','findOne','getConfigs','放大图片任务异常中断\x20队列-1:\x20','BAD_REQUEST','绘画任务开始','21753sMeRxp','max','249069SYVAOI','prompt','defineProperty','convertToEnglish','http://172.247.48.137:8000/mj/list?channel_id=','__esModule','drawWorking','variationSingleImg','object','queueCount','balance','decorate','mjId','发送放大指令成功','pollForUpscaleResult','where','mjProxy','本次比对的随机ID:\x20','MjService','使用的次数：','mjNotSaveImg'];_0x421e=function(){return _0x3255ba;};return _0x421e();}var __decorate=this&&this[_0x37abd6(0x281)]||function(_0x4d8641,_0x4cb175,_0x12db24,_0x393020){const _0x570dfa=_0x37abd6;var _0x565a77=arguments[_0x570dfa(0x233)],_0x40ff31=_0x565a77<0x3?_0x4cb175:_0x393020===null?_0x393020=Object[_0x570dfa(0x20c)](_0x4cb175,_0x12db24):_0x393020,_0x5d9cc4;if(typeof Reflect===_0x570dfa(0x21f)&&typeof Reflect[_0x570dfa(0x222)]==='function')_0x40ff31=Reflect['decorate'](_0x4d8641,_0x4cb175,_0x12db24,_0x393020);else{for(var _0xb219b7=_0x4d8641[_0x570dfa(0x233)]-0x1;_0xb219b7>=0x0;_0xb219b7--)if(_0x5d9cc4=_0x4d8641[_0xb219b7])_0x40ff31=(_0x565a77<0x3?_0x5d9cc4(_0x40ff31):_0x565a77>0x3?_0x5d9cc4(_0x4cb175,_0x12db24,_0x40ff31):_0x5d9cc4(_0x4cb175,_0x12db24))||_0x40ff31;}return _0x565a77>0x3&&_0x40ff31&&Object[_0x570dfa(0x219)](_0x4cb175,_0x12db24,_0x40ff31),_0x40ff31;},__metadata=this&&this['__metadata']||function(_0x515942,_0x192ac5){const _0x131af7=_0x37abd6;if(typeof Reflect===_0x131af7(0x21f)&&typeof Reflect[_0x131af7(0x1fe)]===_0x131af7(0x266))return Reflect[_0x131af7(0x1fe)](_0x515942,_0x192ac5);},__param=this&&this[_0x37abd6(0x1f2)]||function(_0x5cf70e,_0x259101){return function(_0x725fec,_0x19ab0c){_0x259101(_0x725fec,_0x19ab0c,_0x5cf70e);};};Object[_0x37abd6(0x219)](exports,_0x37abd6(0x21c),{'value':!![]}),exports[_0x37abd6(0x229)]=void 0x0;const globalConfig_service_1=require(_0x37abd6(0x208)),upload_service_1=require('../upload/upload.service'),common_1=require(_0x37abd6(0x252)),axios_1=require(_0x37abd6(0x207)),chatLog_service_1=require(_0x37abd6(0x276)),balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require(_0x37abd6(0x239)),chatLog_entity_1=require(_0x37abd6(0x258)),typeorm_1=require(_0x37abd6(0x27b)),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require(_0x37abd6(0x1e9)),fanyi_service_1=require('../fanyi/fanyi.service'),badwords_service_1=require(_0x37abd6(0x1f0));let MjService=class MjService{constructor(_0x115e8b,_0x386246,_0xc9121c,_0x1ac241,_0x452a1a,_0x1782fd,_0x19a898){const _0x143773=_0x37abd6;this[_0x143773(0x279)]=_0x115e8b,this['balanceEntity']=_0x386246,this['uploadService']=_0xc9121c,this[_0x143773(0x232)]=_0x1ac241,this['globalConfigService']=_0x452a1a,this['fanyiService']=_0x1782fd,this['badwordsService']=_0x19a898,this[_0x143773(0x25e)]={},this['drawWorking']=[],this['enlargeWorking']=[],this[_0x143773(0x220)]=0x0,this[_0x143773(0x20b)]={};}async[_0x37abd6(0x23e)](_0x1ed1df){const _0x60cde0=_0x37abd6,{jobId:_0x4af618,prompt:_0x5dc207,startTime:_0xe5774a,userId:_0x25ae21}=_0x1ed1df;return console[_0x60cde0(0x286)](_0x60cde0(0x214),'mjservice'),await new Promise(_0x515f0a=>setTimeout(_0x515f0a,0x1388)),{'a':0x1,'b':0x2};}async[_0x37abd6(0x26c)](_0x5361a0,_0x1ab618){const _0x3f2f8b=_0x37abd6;await this['checkAuth'](_0x1ab618),await this[_0x3f2f8b(0x265)][_0x3f2f8b(0x1ff)](_0x5361a0[_0x3f2f8b(0x218)],_0x1ab618[_0x3f2f8b(0x24a)]['id']);const _0x2f5547=_0x5361a0[_0x3f2f8b(0x218)];let _0x566ea6=_0x5361a0[_0x3f2f8b(0x218)];const {baiduFanyiAppId:_0x2a626a,baiduFanyiSecret:_0x392bd3}=await this['globalConfigService'][_0x3f2f8b(0x211)]([_0x3f2f8b(0x234),'baiduFanyiSecret']);_0x2a626a&&_0x392bd3&&(_0x566ea6=await this[_0x3f2f8b(0x257)][_0x3f2f8b(0x21a)](_0x2f5547));const _0x2fe641='['+(0x0,utils_1['createRandomUid'])()+']',_0x222be9=_0x2fe641+'\x20'+_0x566ea6;console['log'](_0x3f2f8b(0x26e),_0x2fe641),console[_0x3f2f8b(0x286)]('prompt\x20-------->\x20\x20',_0x222be9);const _0x4e75bb=this[_0x3f2f8b(0x21d)][_0x3f2f8b(0x22c)](_0x30f83c=>_0x30f83c['includes'](_0x5361a0[_0x3f2f8b(0x218)]));if(_0x4e75bb)throw new common_1[(_0x3f2f8b(0x243))]('当前提示词已经在任务队列中了、请勿重复提交。。。',common_1[_0x3f2f8b(0x20a)]['BAD_REQUEST']);if(this[_0x3f2f8b(0x220)]>=0x3)throw new common_1['HttpException']('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1['HttpStatus']['BAD_REQUEST']);await this[_0x3f2f8b(0x209)](_0x1ab618),this['queueCount']++,console['log'](_0x3f2f8b(0x1f4)+_0x1ab618['user']['id']+_0x3f2f8b(0x23f),this[_0x3f2f8b(0x220)]);try{const _0x45cfdd=await this[_0x3f2f8b(0x279)][_0x3f2f8b(0x22c)]({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0x222be9+'%')}}),_0x3355b8=_0x45cfdd[_0x3f2f8b(0x202)](_0x80a5fa=>_0x80a5fa[_0x3f2f8b(0x278)]);this[_0x3f2f8b(0x21d)][_0x3f2f8b(0x235)](_0x222be9);let _0xde83fb;const _0x2c26bb=await this[_0x3f2f8b(0x1ee)](_0x222be9,_0x3355b8,_0x2fe641);_0x2c26bb?(console[_0x3f2f8b(0x286)](_0x3f2f8b(0x251)),_0xde83fb=_0x2c26bb):_0xde83fb=await this['pollForResult'](_0x222be9,_0x3355b8,_0x2fe641);this['queueCount']--,this[_0x3f2f8b(0x220)]<0x0&&(this[_0x3f2f8b(0x220)]=0x0),console[_0x3f2f8b(0x286)]('绘制图片任务结束\x20队列-1:\x20',this[_0x3f2f8b(0x220)]);const {id:_0x5751da,content:_0x5ea98d,channel_id:_0x22bf97,attachments:attachments=[],timestamp:_0x39c4f0}=_0xde83fb;if(!attachments[_0x3f2f8b(0x233)]||!attachments[0x0][_0x3f2f8b(0x27d)])throw new common_1[(_0x3f2f8b(0x243))]('绘画失败',common_1[_0x3f2f8b(0x20a)][_0x3f2f8b(0x213)]);const {filename:_0x54afda,url:_0x3d17db,width:_0x3997e2,height:_0x16a91e,size:_0x12fb92}=attachments[0x0];console['log']('拿到了远程地址:\x20',_0x3d17db);const _0x1d9a09=this[_0x3f2f8b(0x250)][_0x3f2f8b(0x211)](['mjNotSaveImg']);let _0x2b952f='';(!Number(_0x1d9a09)||Number(_0x1d9a09)===0x0)&&(_0x2b952f=await this['uploadService'][_0x3f2f8b(0x28d)]({'filename':_0x54afda,'url':_0x3d17db}),console[_0x3f2f8b(0x286)](_0x3f2f8b(0x1e5),_0x2b952f));const _0x279957={'curIp':(0x0,utils_1[_0x3f2f8b(0x203)])(_0x1ab618),'userId':_0x1ab618[_0x3f2f8b(0x24a)]['id'],'type':balance_constant_1[_0x3f2f8b(0x24c)][_0x3f2f8b(0x284)],'prompt':_0x222be9,'answer':_0x2b952f,'model':'mj','extend':this[_0x3f2f8b(0x28a)](JSON[_0x3f2f8b(0x274)](_0xde83fb)),'message_id':_0x5751da,'variationId':_0x5751da,'upscaleId':_0x5751da,'group':0x1,'isSaveImg':!Number(_0x1d9a09)||Number(_0x1d9a09)===0x0,'fileInfo':JSON[_0x3f2f8b(0x274)]({'width':_0x3997e2,'height':_0x16a91e,'size':_0x12fb92,'filename':_0x54afda,'cosUrl':_0x2b952f})};return await this[_0x3f2f8b(0x232)][_0x3f2f8b(0x201)](_0x279957),await this[_0x3f2f8b(0x1fd)](_0x1ab618),this[_0x3f2f8b(0x21d)]=this['drawWorking'][_0x3f2f8b(0x255)](_0xe89d1b=>_0xe89d1b!==_0x5361a0[_0x3f2f8b(0x218)]),_0x2b952f;}catch(_0x13e28b){this[_0x3f2f8b(0x220)]--,this[_0x3f2f8b(0x220)]<0x0&&(this[_0x3f2f8b(0x220)]=0x0),console[_0x3f2f8b(0x286)](_0x3f2f8b(0x267),this[_0x3f2f8b(0x220)]),this[_0x3f2f8b(0x21d)]=this[_0x3f2f8b(0x21d)]['filter'](_0x5ed347=>_0x5ed347!==_0x5361a0[_0x3f2f8b(0x218)]);throw new common_1[(_0x3f2f8b(0x243))](_0x13e28b[_0x3f2f8b(0x1f6)],common_1[_0x3f2f8b(0x20a)][_0x3f2f8b(0x213)]);}}async[_0x37abd6(0x25f)](_0x2a375a,_0x423e2b){const _0x33e41b=_0x37abd6;if(this[_0x33e41b(0x220)]>=0x3)throw new common_1[(_0x33e41b(0x243))](_0x33e41b(0x230),common_1[_0x33e41b(0x20a)][_0x33e41b(0x213)]);this[_0x33e41b(0x220)]++,console[_0x33e41b(0x286)]('用户'+_0x423e2b[_0x33e41b(0x24a)]['id']+_0x33e41b(0x1f3),this['queueCount']);const {message_id:_0x5605ec,orderId:_0x59d7b5}=_0x2a375a;try{const _0x4a4f16=await this[_0x33e41b(0x279)][_0x33e41b(0x210)]({'where':{'message_id':_0x5605ec}});if(!_0x4a4f16)throw new common_1[(_0x33e41b(0x243))](_0x33e41b(0x1f1),common_1[_0x33e41b(0x20a)][_0x33e41b(0x213)]);const _0x54f727=await this['chatLogEntity'][_0x33e41b(0x210)]({'where':{'upscaleId':_0x5605ec,'action':_0x33e41b(0x27c),'orderId':_0x59d7b5}});if(_0x54f727)throw new common_1['HttpException']('当前图片已经放大过了、请勿重复放大!',common_1[_0x33e41b(0x20a)][_0x33e41b(0x213)]);const {prompt:_0x275f45,extend:_0x5bd027}=_0x4a4f16;let _0x2df194=null;try{_0x2df194=JSON[_0x33e41b(0x270)](_0x5bd027);}catch(_0x208f22){_0x2df194=[];}const {components:components=[]}=_0x2df194;if(!components[_0x33e41b(0x233)])throw new common_1[(_0x33e41b(0x243))]('当前图片没有绘画信息、无法放大!',common_1[_0x33e41b(0x20a)][_0x33e41b(0x213)]);const _0x59f112=components[0x0][_0x33e41b(0x20e)][_0x59d7b5-0x1],{custom_id:_0x375a7b}=_0x59f112;console[_0x33e41b(0x286)](_0x33e41b(0x26d),_0x375a7b);const _0x3d25e1={'message_id':_0x5605ec,'custom_id':_0x375a7b,'prompt':_0x275f45,'orderId':_0x59d7b5};await this[_0x33e41b(0x237)](_0x3d25e1),console['log'](_0x33e41b(0x224));const _0x6c355c=await this[_0x33e41b(0x279)]['find']({'where':{'prompt':(0x0,typeorm_1[_0x33e41b(0x204)])('%'+_0x275f45+'%')}}),_0xc52f19=_0x6c355c[_0x33e41b(0x202)](_0xc28932=>_0xc28932['message_id']);console[_0x33e41b(0x286)](_0x33e41b(0x24d),_0xc52f19);const _0x51a4b3=await this[_0x33e41b(0x225)](_0x3d25e1,_0xc52f19);this['queueCount']--,this[_0x33e41b(0x220)]<0x0&&(this[_0x33e41b(0x220)]=0x0),console[_0x33e41b(0x286)]('放大图片任务结束\x20队列-1:\x20',this[_0x33e41b(0x220)]);const {id:_0x522afa,content:_0x212481,channel_id:_0x1fe699,attachments:attachments=[],timestamp:_0x4a3698}=_0x51a4b3;if(!attachments[_0x33e41b(0x233)]||!attachments[0x0][_0x33e41b(0x27d)])throw new common_1[(_0x33e41b(0x243))](_0x33e41b(0x245),common_1[_0x33e41b(0x20a)][_0x33e41b(0x213)]);const {filename:_0xf383bb,url:_0x1fec61,width:_0x2a2584,height:_0x5ef76a,size:_0x513c96}=attachments[0x0],_0x269b76=this[_0x33e41b(0x250)][_0x33e41b(0x211)]([_0x33e41b(0x22b)]);let _0x498a8c='';(!Number(_0x269b76)||Number(_0x269b76)===0x0)&&(_0x498a8c=await this[_0x33e41b(0x260)]['uploadFileFromUrl']({'filename':_0xf383bb,'url':_0x1fec61}),console[_0x33e41b(0x286)](_0x33e41b(0x1e5),_0x498a8c));const _0x19b04c={'curIp':(0x0,utils_1['getClientIp'])(_0x423e2b),'userId':_0x423e2b['user']['id'],'type':balance_constant_1[_0x33e41b(0x24c)]['PAINT_TYPE'],'prompt':_0x275f45,'answer':_0x498a8c,'model':'mj','extend':this[_0x33e41b(0x28a)](JSON[_0x33e41b(0x274)](_0x51a4b3)),'message_id':_0x5605ec,'upscaleId':_0x522afa,'variationId':_0x522afa,'action':_0x33e41b(0x27c),'orderId':_0x3d25e1[_0x33e41b(0x1fb)],'isSaveImg':!Number(_0x269b76)||Number(_0x269b76)===0x0,'fileInfo':JSON[_0x33e41b(0x274)]({'width':_0x2a2584,'height':_0x5ef76a,'size':_0x513c96,'filename':_0xf383bb,'cosUrl':_0x498a8c})};return await this[_0x33e41b(0x232)][_0x33e41b(0x201)](_0x19b04c),_0x498a8c;}catch(_0x18eb90){console['log'](_0x33e41b(0x273),_0x18eb90),this[_0x33e41b(0x220)]--,this[_0x33e41b(0x220)]<0x0&&(this[_0x33e41b(0x220)]=0x0),console['log'](_0x33e41b(0x212),this['queueCount']);throw new common_1['HttpException'](_0x18eb90['response'],common_1[_0x33e41b(0x20a)][_0x33e41b(0x213)]);}}async[_0x37abd6(0x21e)](_0x28bd58,_0x43a8c0){const _0x3f276b=_0x37abd6;if(this[_0x3f276b(0x220)]>=0x3)throw new common_1[(_0x3f276b(0x243))](_0x3f276b(0x230),common_1['HttpStatus']['BAD_REQUEST']);await this[_0x3f276b(0x28f)](_0x43a8c0),await this[_0x3f276b(0x209)](_0x43a8c0),this[_0x3f276b(0x220)]++,console['log']('用户'+_0x43a8c0[_0x3f276b(0x24a)]['id']+'开始请求变换图片\x20队列+1:\x20',this[_0x3f276b(0x220)]);const {message_id:_0x2a5dcc,orderId:_0x523285}=_0x28bd58;try{const _0x23bf86=await this[_0x3f276b(0x279)]['findOne']({'where':{'message_id':_0x2a5dcc}});if(!_0x23bf86)throw new common_1[(_0x3f276b(0x243))](_0x3f276b(0x23b),common_1['HttpStatus'][_0x3f276b(0x213)]);const {prompt:_0xcf3898,extend:_0x3005b0}=_0x23bf86;let _0x5a412=null;try{_0x5a412=JSON[_0x3f276b(0x270)](_0x3005b0);}catch(_0x351bb1){_0x5a412=[];}const {components:components=[]}=_0x5a412;if(!components[_0x3f276b(0x233)])throw new common_1[(_0x3f276b(0x243))](_0x3f276b(0x27f),common_1[_0x3f276b(0x20a)][_0x3f276b(0x213)]);const _0xeeb12c=components[0x1][_0x3f276b(0x20e)][_0x523285-0x1],{custom_id:_0x439b7c}=_0xeeb12c,_0x674225=await this[_0x3f276b(0x279)][_0x3f276b(0x22c)]({'where':{'variationId':(0x0,typeorm_1[_0x3f276b(0x290)])((0x0,typeorm_1[_0x3f276b(0x289)])()),'prompt':(0x0,typeorm_1[_0x3f276b(0x204)])('%'+_0xcf3898+'%')}}),_0x37c5dd=_0x674225['map'](_0x199f24=>_0x199f24['variationId']),_0x4e0ab3={'message_id':_0x2a5dcc,'custom_id':_0x439b7c,'prompt':_0xcf3898,'orderId':_0x523285};await this[_0x3f276b(0x237)](_0x4e0ab3);const _0x48f52c=await this[_0x3f276b(0x22e)](_0x4e0ab3,_0x37c5dd);this[_0x3f276b(0x220)]--,this[_0x3f276b(0x220)]<0x0&&(this[_0x3f276b(0x220)]=0x0),console[_0x3f276b(0x286)](_0x3f276b(0x244),this['queueCount']);const {id:_0x4462a4,content:_0x3bbb44,channel_id:_0x3c1e84,attachments:attachments=[],timestamp:_0x13138a}=_0x48f52c;if(!attachments['length']||!attachments[0x0][_0x3f276b(0x27d)])throw new common_1[(_0x3f276b(0x243))](_0x3f276b(0x1e3),common_1[_0x3f276b(0x20a)]['BAD_REQUEST']);const {filename:_0x3280c3,url:_0x4ffafe,width:_0x4c2b15,height:_0x1d06a0,size:_0x4f4f9a}=attachments[0x0],_0xae7d7e=this['globalConfigService'][_0x3f276b(0x211)]([_0x3f276b(0x22b)]);let _0x2385fc='';(!Number(_0xae7d7e)||Number(_0xae7d7e)===0x0)&&(_0x2385fc=await this[_0x3f276b(0x260)]['uploadFileFromUrl']({'filename':_0x3280c3,'url':_0x4ffafe}),console[_0x3f276b(0x286)](_0x3f276b(0x1e5),_0x2385fc));const _0x21c964={'curIp':(0x0,utils_1[_0x3f276b(0x203)])(_0x43a8c0),'userId':_0x43a8c0['user']['id'],'type':balance_constant_1['DeductionKey'][_0x3f276b(0x284)],'prompt':_0xcf3898,'answer':_0x2385fc,'model':'mj','group':0x1,'extend':this[_0x3f276b(0x28a)](JSON[_0x3f276b(0x274)](_0x48f52c)),'message_id':_0x4462a4,'upscaleId':_0x4462a4,'variationId':_0x4462a4,'action':_0x3f276b(0x27c),'orderId':_0x4e0ab3[_0x3f276b(0x1fb)],'isSaveImg':!Number(_0xae7d7e)||Number(_0xae7d7e)===0x0,'fileInfo':JSON[_0x3f276b(0x274)]({'width':_0x4c2b15,'height':_0x1d06a0,'size':_0x4f4f9a,'filename':_0x3280c3,'cosUrl':_0x2385fc})};return await this[_0x3f276b(0x232)][_0x3f276b(0x201)](_0x21c964),_0x2385fc;}catch(_0x63326b){console[_0x3f276b(0x286)](_0x3f276b(0x273),_0x63326b),this[_0x3f276b(0x220)]--,this[_0x3f276b(0x220)]<0x0&&(this[_0x3f276b(0x220)]=0x0),console[_0x3f276b(0x286)](_0x3f276b(0x238),this[_0x3f276b(0x220)]);throw new common_1[(_0x3f276b(0x243))](_0x63326b[_0x3f276b(0x1f6)],common_1[_0x3f276b(0x20a)]['BAD_REQUEST']);}}async['sendSmInteractions'](_0x1159c3){const _0x16409c=_0x37abd6,{message_id:_0x4204f0,custom_id:_0x12fa96}=_0x1159c3,{application_id:_0x22c5bc,guild_id:_0x5818f0,channel_id:_0x4663d1,session_id:_0x325a19,version:_0x597b8b,id:_0x40967e,authorization:_0x438c86,mjProxy:_0x15e7a2}=await this[_0x16409c(0x20f)](),_0xfea62d=_0x15e7a2==0x1?_0x16409c(0x288):_0x16409c(0x1f9),_0x567376={'authorization':_0x438c86},_0x2c83f2={'type':0x3,'guild_id':_0x5818f0,'channel_id':_0x4663d1,'message_flags':0x0,'message_id':_0x4204f0,'application_id':_0x22c5bc,'session_id':_0x325a19,'data':{'component_type':0x2,'custom_id':_0x12fa96}};try{await axios_1[_0x16409c(0x23a)][_0x16409c(0x1fc)](_0xfea62d,_0x2c83f2,{'headers':_0x567376}),console[_0x16409c(0x286)](_0x16409c(0x264));}catch(_0x2d6ad9){console[_0x16409c(0x286)]('error:\x20',_0x2d6ad9);throw new common_1['HttpException'](_0x16409c(0x1fa),common_1[_0x16409c(0x20a)][_0x16409c(0x213)]);}}async['pollForUpscaleResult'](_0x21c0af,_0x1400d1){const _0x3988a8=_0x37abd6,{message_id:_0x97301b,custom_id:_0x408da8,prompt:_0x235533,orderId:_0x55c5fa}=_0x21c0af;let _0x1cb868=null,_0x30b815=0x0;while(!_0x1cb868&&_0x30b815<0xa){try{const _0x1cfd56=Date[_0x3988a8(0x28b)](),_0x486851=await this[_0x3988a8(0x25c)]();console[_0x3988a8(0x286)]('第\x20'+(_0x30b815+0x1)+_0x3988a8(0x25b)+_0x486851['length']);_0x486851&&_0x486851[_0x3988a8(0x233)]&&(_0x1cb868=await this[_0x3988a8(0x275)](_0x486851,_0x21c0af,_0x1400d1));const _0x218b85=Date[_0x3988a8(0x28b)]()-_0x1cfd56,_0xef07ba=0xbb8;await this[_0x3988a8(0x261)](Math[_0x3988a8(0x216)](_0xef07ba-_0x218b85,0x0)),_0x30b815++;}catch(_0x5bedbe){console['error']('查询期间出现错误：'+_0x5bedbe[_0x3988a8(0x231)]);}}return _0x1cb868;}async['pollForVariationResult'](_0x529d51,_0x2907cf){const _0x3c10c6=_0x37abd6,{message_id:_0x4d7dfb,custom_id:_0x3da322,prompt:_0x31b3bd,orderId:_0x448553}=_0x529d51;console[_0x3c10c6(0x286)]('开始轮询单张变换图片结果');let _0x4b7d44=null,_0x5ca18f=0x0;while(!_0x4b7d44&&_0x5ca18f<0xa){try{console[_0x3c10c6(0x286)]('第\x20'+(_0x5ca18f+0x1)+'\x20次开始查询[变换图片]');const _0xbe28c3=Date['now'](),_0x10d365=await this[_0x3c10c6(0x25c)]();_0x10d365&&_0x10d365['length']&&(_0x4b7d44=await this['findCurrentVariationImgResult'](_0x10d365,_0x529d51,_0x2907cf));const _0x1c6330=Date[_0x3c10c6(0x28b)]()-_0xbe28c3,_0x58f587=0x1f40;await this['sleep'](Math['max'](_0x58f587-_0x1c6330,0x0)),_0x5ca18f++;}catch(_0x4b35b9){console[_0x3c10c6(0x259)](_0x3c10c6(0x22f)+_0x4b35b9[_0x3c10c6(0x231)]);}}if(!_0x4b7d44)throw new common_1['HttpException'](_0x3c10c6(0x24e),common_1['HttpStatus'][_0x3c10c6(0x213)]);return _0x4b7d44;}async[_0x37abd6(0x275)](_0x19e1fb,_0x4d7d12,_0x4517cf){const _0x56f6da=_0x37abd6,{message_id:_0x20502f,custom_id:_0x571abb,prompt:_0xa91f84,orderId:_0x2f1892}=_0x4d7d12,_0x3e4287=_0xa91f84[_0x56f6da(0x269)](0x0,0xc);console[_0x56f6da(0x286)](_0x56f6da(0x28e),_0x3e4287);const _0x25ed39=_0x19e1fb['find'](_0x201346=>{const _0x24e980=_0x56f6da,{content:_0x2cdb2f}=_0x201346;if(!this[_0x24e980(0x241)](_0x2cdb2f))return![];const {prompt:_0x39f137,order:_0xabdb00}=this[_0x24e980(0x241)](_0x2cdb2f);return _0x39f137['includes'](_0x3e4287)&&_0x4d7d12[_0x24e980(0x1fb)]===_0xabdb00&&!_0x4517cf['includes'](_0x201346['id']);});return _0x25ed39;}async[_0x37abd6(0x268)](_0x48a009,_0x40b960,_0x27ab18){const _0x5d86a4=_0x37abd6,{message_id:_0xbadbb8,custom_id:_0x80d03b,prompt:_0x4b8294,orderId:_0x16e3b0}=_0x40b960,_0x1444d8=_0x4b8294[_0x5d86a4(0x269)](0x0,0xc),_0x4fd117=_0x48a009[_0x5d86a4(0x22c)](_0x58691a=>{const _0x56ace9=_0x5d86a4,{content:_0x4e972f}=_0x58691a,_0xeb4e87=_0x4e972f[_0x56ace9(0x287)](/\*\*(.+?)\*\*/),_0x1b4ac6=_0xeb4e87?_0xeb4e87[0x1]:'';if(!_0x1b4ac6)return![];return _0x1b4ac6[_0x56ace9(0x272)](_0x1444d8)&&!_0x27ab18[_0x56ace9(0x272)](_0x58691a['id']);});return _0x4fd117;}async[_0x37abd6(0x1ee)](_0x34bf8c,_0x27a83d,_0x15c96d){const _0x3696b8=_0x37abd6,_0x3ad67a=await this[_0x3696b8(0x25c)](),_0x1aef71=await this['findCurrentPromptResult'](_0x3ad67a,_0x15c96d,_0x27a83d);if(_0x1aef71)return console[_0x3696b8(0x286)](_0x3696b8(0x26b),_0x1aef71),_0x1aef71;const {application_id:_0x3854b2,guild_id:_0x404fb9,channel_id:_0xbcc3d7,session_id:_0x376100,version:_0x13838f,id:_0x3bc544,authorization:_0x14cbcd,mjProxy:_0x238ebf}=await this[_0x3696b8(0x20f)](),_0x27bf48={'type':0x2,'application_id':_0x3854b2,'guild_id':_0x404fb9,'channel_id':_0xbcc3d7,'session_id':_0x376100,'data':{'version':_0x13838f,'id':_0x3bc544,'name':_0x3696b8(0x20d),'type':0x1,'options':[{'type':0x3,'name':_0x3696b8(0x218),'value':_0x34bf8c}],'attachments':[]}};try{const _0x18198f=_0x238ebf==0x1?_0x3696b8(0x288):_0x3696b8(0x1f9),_0x409a33={'authorization':_0x14cbcd},_0x1e2dae=await axios_1[_0x3696b8(0x23a)][_0x3696b8(0x1fc)](_0x18198f,_0x27bf48,{'headers':_0x409a33});return console[_0x3696b8(0x286)]('发送绘画指令结果:\x20',_0x1e2dae['data']),![];}catch(_0x128ac3){console[_0x3696b8(0x286)](_0x3696b8(0x26f),_0x128ac3);throw new common_1['HttpException'](_0x3696b8(0x1eb),common_1[_0x3696b8(0x20a)]['BAD_REQUEST']);}}async[_0x37abd6(0x205)](_0x1d223d,_0x10abeb,_0x5ad7e7){const _0x19bbfd=_0x37abd6;console['log'](_0x19bbfd(0x28c));const _0x56fd7f=Date[_0x19bbfd(0x28b)]();try{const _0x50f147=0xd,_0x25c028=0x2ee0,_0x3b1c1f=0x1388,_0x3ec35a=0x3c*0x3e8;let _0x34b9ec=0x0,_0x5f3929=![],_0x168934=null;while(!_0x168934&&_0x34b9ec<_0x50f147){console['log']('第\x20'+(_0x34b9ec+0x1)+_0x19bbfd(0x1f8));Date[_0x19bbfd(0x28b)]()-_0x56fd7f>=_0x3ec35a&&(_0x5f3929=!![]);await this[_0x19bbfd(0x261)](_0x5f3929?_0x3b1c1f:_0x25c028);const _0x5f2a37=await this[_0x19bbfd(0x25c)]();_0x168934=await this['findCurrentPromptResult'](_0x5f2a37,_0x5ad7e7,_0x10abeb),_0x34b9ec++;}if(!_0x168934)throw new common_1[(_0x19bbfd(0x243))]('绘画超时，请稍后再试！',common_1[_0x19bbfd(0x20a)][_0x19bbfd(0x213)]);const _0x49f5af=Date[_0x19bbfd(0x28b)]();return console[_0x19bbfd(0x286)](_0x19bbfd(0x236)+Math[_0x19bbfd(0x249)]((_0x49f5af-_0x56fd7f)/0x3e8)+'\x20S'),_0x168934;}catch(_0xeb39c4){console['error'](_0xeb39c4[_0x19bbfd(0x231)]);throw new common_1[(_0x19bbfd(0x243))](_0x19bbfd(0x1ef),common_1[_0x19bbfd(0x20a)][_0x19bbfd(0x247)]);}}async['findCurrentPromptResult'](_0x5cf541,_0x4f019e,_0x1f5695){const _0x5b32ad=_0x37abd6;if(!_0x5cf541||!_0x5cf541['length'])return;console['log'](_0x5b32ad(0x228),_0x4f019e);const _0x697231=_0x5cf541[_0x5b32ad(0x22c)](_0x3db85d=>{const _0x136194=_0x5b32ad,{attachments:attachments=[],content:_0x48d5f7,edited_timestamp:_0x41821b}=_0x3db85d;return _0x48d5f7[_0x136194(0x272)](_0x4f019e)&&attachments[_0x136194(0x233)]>0x0&&!_0x41821b&&!_0x1f5695[_0x136194(0x272)](_0x3db85d['id']);});return _0x697231||null;}async[_0x37abd6(0x25c)](){const _0x12b686=_0x37abd6;try{const {application_id:_0x143062,guild_id:_0x206c80,channel_id:_0x3de92d,session_id:_0xea20ba,version:_0x420b8b,id:_0x532b17,authorization:_0x2a98c9,mjProxy:_0x105f19}=await this[_0x12b686(0x20f)](),_0x39ec06=_0x105f19==0x1?_0x12b686(0x21b)+_0x3de92d:'https://discord.com/api/v9/channels/'+_0x3de92d+_0x12b686(0x293),_0x534712={'authorization':_0x2a98c9},_0x31ee37=await axios_1[_0x12b686(0x23a)]['get'](_0x39ec06,{'headers':_0x534712});return _0x31ee37[_0x12b686(0x25d)];}catch(_0xd5981b){console['log']('axios\x20get:\x20',_0xd5981b);throw new common_1[(_0x12b686(0x243))]('查询绘制结果失败...',common_1['HttpStatus'][_0x12b686(0x213)]);}}async[_0x37abd6(0x261)](_0x41f994){return new Promise(_0x3cf1d7=>setTimeout(_0x3cf1d7,_0x41f994));}['extractContent'](_0x22a073){const _0x2fd017=_0x37abd6,_0x1e8ae9=_0x22a073[_0x2fd017(0x287)](/\*\*(.+?)\*\*/),_0x1f9d6f=_0x22a073[_0x2fd017(0x287)](/- Image #(\d+)/);if(!_0x1e8ae9||!_0x1f9d6f)return null;const _0x4fe4b0=_0x1e8ae9[0x1],_0xdd55a1=parseInt(_0x1f9d6f[0x1]);return{'prompt':_0x4fe4b0,'order':_0xdd55a1};}async[_0x37abd6(0x20f)](){const _0x5446e6=_0x37abd6,_0x3d340d=await this[_0x5446e6(0x250)]['getConfigs'](['mjId','mjApplicationId',_0x5446e6(0x1e4),'mjChannelId','mjSessionId','mjVersion','mjAuthorization',_0x5446e6(0x254),'mjProxy']),_0x4fd9ee={'application_id':_0x3d340d[_0x5446e6(0x24b)],'guild_id':_0x3d340d[_0x5446e6(0x1e4)],'channel_id':_0x3d340d[_0x5446e6(0x24f)],'session_id':_0x3d340d[_0x5446e6(0x26a)],'version':_0x3d340d['mjVersion'],'id':_0x3d340d[_0x5446e6(0x223)],'authorization':_0x3d340d[_0x5446e6(0x240)],'mjRateLimit':_0x3d340d[_0x5446e6(0x254)],'mjProxy':_0x3d340d[_0x5446e6(0x227)]||0x0};return _0x4fd9ee;}[_0x37abd6(0x28a)](_0x316a5d){const _0x4db790=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x316a5d['replace'](_0x4db790,'');}async[_0x37abd6(0x28f)](_0xfe2e3a){const _0x1b913f=_0x37abd6,_0x258f8b=await this[_0x1b913f(0x291)][_0x1b913f(0x210)]({'where':{'userId':_0xfe2e3a[_0x1b913f(0x24a)]['id']}}),{id:_0x575eff,balance:_0x29b6c1}=_0x258f8b;if(!_0x29b6c1||(_0x258f8b===null||_0x258f8b===void 0x0?void 0x0:_0x258f8b[_0x1b913f(0x221)])<0x1)throw new common_1[(_0x1b913f(0x243))](_0x1b913f(0x280),common_1[_0x1b913f(0x20a)][_0x1b913f(0x213)]);}async[_0x37abd6(0x277)](_0x2f94c5){const _0x25581d=_0x37abd6,{id:_0x5d9ba4,role:_0x11c5f4}=_0x2f94c5['user'];!this[_0x25581d(0x20b)][_0x5d9ba4]?this[_0x25581d(0x20b)][_0x5d9ba4]=0x1:this[_0x25581d(0x20b)][_0x5d9ba4]=this[_0x25581d(0x20b)][_0x5d9ba4]+0x1,console['log'](_0x25581d(0x1e6)+_0x5d9ba4+_0x25581d(0x22a),this[_0x25581d(0x20b)][_0x5d9ba4]);}async[_0x37abd6(0x209)](_0x5dd59b){const _0x414407=_0x37abd6,{id:_0x33226a,role:_0x4b37b2}=_0x5dd59b['user'];if([_0x414407(0x282),'super'][_0x414407(0x272)](_0x4b37b2))return!![];const {mjRateLimit:_0xdfd3ec}=await this[_0x414407(0x20f)]();if(this['rateLimits'][_0x33226a]){const _0x5c0a89=this[_0x414407(0x25e)][_0x33226a];if(_0x5c0a89>Date['now']()){console['log'](_0x414407(0x256)+_0x33226a+_0x414407(0x292));throw new common_1[(_0x414407(0x243))](_0x414407(0x271)+_0xdfd3ec+_0x414407(0x1e7),common_1[_0x414407(0x20a)][_0x414407(0x213)]);}else this[_0x414407(0x25e)][_0x33226a]=Date[_0x414407(0x28b)]()+Number(_0xdfd3ec)*0x3e8;}else{const _0x35f7bc=Date[_0x414407(0x28b)]();this[_0x414407(0x25e)][_0x33226a]=_0x35f7bc+0x3e8*Number(_0xdfd3ec);}}async[_0x37abd6(0x1fd)](_0x3615f7){const _0x52f064=_0x37abd6;await this[_0x52f064(0x291)][_0x52f064(0x23c)]()[_0x52f064(0x27a)](balance_entity_1[_0x52f064(0x253)])[_0x52f064(0x248)]({'balance':()=>_0x52f064(0x285)})[_0x52f064(0x226)](_0x52f064(0x1ec),{'userId':_0x3615f7[_0x52f064(0x24a)]['id']})[_0x52f064(0x23d)]();}async[_0x37abd6(0x25a)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x37abd6(0x1e8)])(),__param(0x0,(0x0,typeorm_2[_0x37abd6(0x262)])(chatLog_entity_1[_0x37abd6(0x1ea)])),__param(0x1,(0x0,typeorm_2[_0x37abd6(0x262)])(balance_entity_1['BalanceEntity'])),__metadata(_0x37abd6(0x242),[typeorm_1[_0x37abd6(0x1f5)],typeorm_1[_0x37abd6(0x1f5)],upload_service_1['UploadService'],chatLog_service_1[_0x37abd6(0x22d)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1['FanyiService'],badwords_service_1['BadwordsService']])],MjService),exports[_0x37abd6(0x229)]=MjService;