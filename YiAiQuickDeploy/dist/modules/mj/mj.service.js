'use strict';const _0x208520=_0x3af2;(function(_0x2bd80c,_0x49b524){const _0x2f13b6=_0x3af2,_0xf9da3f=_0x2bd80c();while(!![]){try{const _0x519fcc=-parseInt(_0x2f13b6(0x175))/0x1*(-parseInt(_0x2f13b6(0x103))/0x2)+-parseInt(_0x2f13b6(0x109))/0x3+parseInt(_0x2f13b6(0x19a))/0x4*(-parseInt(_0x2f13b6(0x112))/0x5)+parseInt(_0x2f13b6(0xfd))/0x6*(-parseInt(_0x2f13b6(0x123))/0x7)+parseInt(_0x2f13b6(0x17a))/0x8+parseInt(_0x2f13b6(0x19f))/0x9*(parseInt(_0x2f13b6(0x196))/0xa)+parseInt(_0x2f13b6(0x12b))/0xb;if(_0x519fcc===_0x49b524)break;else _0xf9da3f['push'](_0xf9da3f['shift']());}catch(_0x409def){_0xf9da3f['push'](_0xf9da3f['shift']());}}}(_0x5aa7,0xdac78));var __decorate=this&&this[_0x208520(0x14b)]||function(_0x3058ff,_0x51ff14,_0x317b60,_0x138950){const _0x1e011f=_0x208520;var _0x164893=arguments[_0x1e011f(0x13a)],_0x6e6243=_0x164893<0x3?_0x51ff14:_0x138950===null?_0x138950=Object[_0x1e011f(0x145)](_0x51ff14,_0x317b60):_0x138950,_0x27d3c8;if(typeof Reflect==='object'&&typeof Reflect[_0x1e011f(0xf2)]==='function')_0x6e6243=Reflect[_0x1e011f(0xf2)](_0x3058ff,_0x51ff14,_0x317b60,_0x138950);else{for(var _0x2d12e5=_0x3058ff[_0x1e011f(0x13a)]-0x1;_0x2d12e5>=0x0;_0x2d12e5--)if(_0x27d3c8=_0x3058ff[_0x2d12e5])_0x6e6243=(_0x164893<0x3?_0x27d3c8(_0x6e6243):_0x164893>0x3?_0x27d3c8(_0x51ff14,_0x317b60,_0x6e6243):_0x27d3c8(_0x51ff14,_0x317b60))||_0x6e6243;}return _0x164893>0x3&&_0x6e6243&&Object[_0x1e011f(0x143)](_0x51ff14,_0x317b60,_0x6e6243),_0x6e6243;},__metadata=this&&this[_0x208520(0x10d)]||function(_0x1e831b,_0x400bbe){const _0x3c4de2=_0x208520;if(typeof Reflect==='object'&&typeof Reflect[_0x3c4de2(0xf4)]===_0x3c4de2(0x13b))return Reflect[_0x3c4de2(0xf4)](_0x1e831b,_0x400bbe);},__param=this&&this[_0x208520(0x197)]||function(_0x3cdbd2,_0x5cb720){return function(_0x1ebb0a,_0x112499){_0x5cb720(_0x1ebb0a,_0x112499,_0x3cdbd2);};};Object[_0x208520(0x143)](exports,_0x208520(0x126),{'value':!![]}),exports['MjService']=void 0x0;function _0x3af2(_0x989859,_0xb8b386){const _0x5aa776=_0x5aa7();return _0x3af2=function(_0x3af2da,_0x43f2f2){_0x3af2da=_0x3af2da-0xf1;let _0x1b7244=_0x5aa776[_0x3af2da];return _0x1b7244;},_0x3af2(_0x989859,_0xb8b386);}const globalConfig_service_1=require(_0x208520(0x1ae)),upload_service_1=require('../upload/upload.service'),common_1=require('@nestjs/common'),axios_1=require(_0x208520(0x194)),chatLog_service_1=require(_0x208520(0xf6)),balance_constant_1=require(_0x208520(0x153)),utils_1=require(_0x208520(0x15b)),chatLog_entity_1=require(_0x208520(0x1af)),typeorm_1=require(_0x208520(0x105)),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require('../userBalance/balance.entity'),fanyi_service_1=require(_0x208520(0x179)),badwords_service_1=require(_0x208520(0x17f));let MjService=class MjService{constructor(_0x15cb53,_0x165666,_0x3f79a6,_0x3f3ee9,_0x4958dc,_0x6d9fc6,_0x320e87){const _0x368e52=_0x208520;this[_0x368e52(0x170)]=_0x15cb53,this[_0x368e52(0x1ab)]=_0x165666,this['uploadService']=_0x3f79a6,this[_0x368e52(0x14e)]=_0x3f3ee9,this['globalConfigService']=_0x4958dc,this[_0x368e52(0x18f)]=_0x6d9fc6,this[_0x368e52(0x174)]=_0x320e87,this[_0x368e52(0x119)]={},this['drawWorking']=[],this[_0x368e52(0x11c)]=[],this[_0x368e52(0x104)]=0x0,this['freeQueueUsers']={};}async[_0x208520(0x199)](_0x36ef83){const _0xd61ec9=_0x208520,{jobId:_0x372312,prompt:_0x311946,startTime:_0xb7bd6e,userId:_0x5d6a8b}=_0x36ef83;return console[_0xd61ec9(0x11f)](_0xd61ec9(0x12c),'mjservice'),await new Promise(_0x1eaa8a=>setTimeout(_0x1eaa8a,0x1388)),{'a':0x1,'b':0x2};}async[_0x208520(0x173)](_0x4839ce,_0x588a21){const _0x4cbf9c=_0x208520;await this[_0x4cbf9c(0x135)](_0x588a21),await this[_0x4cbf9c(0x174)][_0x4cbf9c(0x15f)](_0x4839ce[_0x4cbf9c(0x16b)],_0x588a21[_0x4cbf9c(0x16c)]['id']);const _0x25cd71=_0x4839ce[_0x4cbf9c(0x16b)];let _0x1017d4=_0x4839ce[_0x4cbf9c(0x16b)];const {baiduFanyiAppId:_0x425bf0,baiduFanyiSecret:_0x1087ad}=await this[_0x4cbf9c(0x111)][_0x4cbf9c(0x17d)]([_0x4cbf9c(0x102),_0x4cbf9c(0x198)]);_0x425bf0&&_0x1087ad&&(_0x1017d4=await this[_0x4cbf9c(0x18f)][_0x4cbf9c(0x1a4)](_0x25cd71));const _0x316155='['+(0x0,utils_1[_0x4cbf9c(0x124)])()+']',_0x647dca=_0x316155+'\x20'+_0x1017d4;console[_0x4cbf9c(0x11f)]('randomId:\x20',_0x316155),console[_0x4cbf9c(0x11f)](_0x4cbf9c(0x1ac),_0x647dca);const _0x26b719=this[_0x4cbf9c(0x14c)]['find'](_0x3e4f16=>_0x3e4f16['includes'](_0x4839ce['prompt']));if(_0x26b719)throw new common_1[(_0x4cbf9c(0x128))](_0x4cbf9c(0x177),common_1[_0x4cbf9c(0x165)]['BAD_REQUEST']);if(this[_0x4cbf9c(0x104)]>=0x3)throw new common_1['HttpException'](_0x4cbf9c(0x17c),common_1[_0x4cbf9c(0x165)][_0x4cbf9c(0x192)]);await this[_0x4cbf9c(0x118)](_0x588a21),this[_0x4cbf9c(0x104)]++,console['log'](_0x4cbf9c(0x156)+_0x588a21['user']['id']+_0x4cbf9c(0x1b1),this[_0x4cbf9c(0x104)]);try{const _0x27d920=await this[_0x4cbf9c(0x170)][_0x4cbf9c(0x147)]({'where':{'prompt':(0x0,typeorm_1[_0x4cbf9c(0x15d)])('%'+_0x647dca+'%')}}),_0x404173=_0x27d920[_0x4cbf9c(0xfe)](_0x78f1c7=>_0x78f1c7[_0x4cbf9c(0x136)]);this[_0x4cbf9c(0x14c)][_0x4cbf9c(0xf1)](_0x647dca);let _0x6417fe;const _0x1673c4=await this[_0x4cbf9c(0x1a7)](_0x647dca,_0x404173,_0x316155);_0x1673c4?(console[_0x4cbf9c(0x11f)]('历史中存在当前图片、直接获取！'),_0x6417fe=_0x1673c4):_0x6417fe=await this[_0x4cbf9c(0x178)](_0x647dca,_0x404173,_0x316155);this[_0x4cbf9c(0x104)]--,this[_0x4cbf9c(0x104)]<0x0&&(this[_0x4cbf9c(0x104)]=0x0),console['log'](_0x4cbf9c(0x132),this['queueCount']);const {id:_0x41a35d,content:_0x2f8eb0,channel_id:_0x200c35,attachments:attachments=[],timestamp:_0x11b98f}=_0x6417fe;if(!attachments[_0x4cbf9c(0x13a)]||!attachments[0x0][_0x4cbf9c(0x144)])throw new common_1['HttpException'](_0x4cbf9c(0x106),common_1['HttpStatus'][_0x4cbf9c(0x192)]);const {filename:_0x37cd63,url:_0x136520,width:_0x46891f,height:_0x22d972,size:_0x407274}=attachments[0x0];console['log'](_0x4cbf9c(0x181),_0x136520);const _0x39c793=this[_0x4cbf9c(0x111)]['getConfigs'](['mjNotSaveImg']);let _0x22ceea='';(!Number(_0x39c793)||Number(_0x39c793)===0x0)&&(_0x22ceea=await this['uploadService']['uploadFileFromUrl']({'filename':_0x37cd63,'url':_0x136520}),console[_0x4cbf9c(0x11f)](_0x4cbf9c(0xfc),_0x22ceea));const _0x4f795f={'curIp':(0x0,utils_1[_0x4cbf9c(0x185)])(_0x588a21),'userId':_0x588a21[_0x4cbf9c(0x16c)]['id'],'type':balance_constant_1['DeductionKey'][_0x4cbf9c(0x114)],'prompt':_0x647dca,'answer':_0x22ceea,'model':'mj','extend':this['removeEmoji'](JSON[_0x4cbf9c(0xff)](_0x6417fe)),'message_id':_0x41a35d,'variationId':_0x41a35d,'upscaleId':_0x41a35d,'group':0x1,'isSaveImg':!Number(_0x39c793)||Number(_0x39c793)===0x0,'fileInfo':JSON[_0x4cbf9c(0xff)]({'width':_0x46891f,'height':_0x22d972,'size':_0x407274,'filename':_0x37cd63,'cosUrl':_0x22ceea})};return await this[_0x4cbf9c(0x14e)]['saveChatLog'](_0x4f795f),await this['deductBalance'](_0x588a21),this[_0x4cbf9c(0x14c)]=this[_0x4cbf9c(0x14c)][_0x4cbf9c(0x108)](_0x3032e6=>_0x3032e6!==_0x4839ce['prompt']),_0x22ceea;}catch(_0x244d87){this[_0x4cbf9c(0x104)]--,this[_0x4cbf9c(0x104)]<0x0&&(this[_0x4cbf9c(0x104)]=0x0),console[_0x4cbf9c(0x11f)](_0x4cbf9c(0x148),this[_0x4cbf9c(0x104)]),this['drawWorking']=this[_0x4cbf9c(0x14c)][_0x4cbf9c(0x108)](_0x515966=>_0x515966!==_0x4839ce['prompt']);throw new common_1[(_0x4cbf9c(0x128))](_0x244d87[_0x4cbf9c(0x140)],common_1[_0x4cbf9c(0x165)][_0x4cbf9c(0x192)]);}}async[_0x208520(0x172)](_0x42aae4,_0x587f4d){const _0x4be648=_0x208520;if(this[_0x4be648(0x104)]>=0x3)throw new common_1[(_0x4be648(0x128))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x4be648(0x165)]['BAD_REQUEST']);this[_0x4be648(0x104)]++,console[_0x4be648(0x11f)]('用户'+_0x587f4d[_0x4be648(0x16c)]['id']+'开始请求放大图片\x20队列+1:\x20',this[_0x4be648(0x104)]);const {message_id:_0x52759f,orderId:_0x865400}=_0x42aae4;try{const _0x414de9=await this[_0x4be648(0x170)][_0x4be648(0x110)]({'where':{'message_id':_0x52759f}});if(!_0x414de9)throw new common_1[(_0x4be648(0x128))](_0x4be648(0x10e),common_1[_0x4be648(0x165)][_0x4be648(0x192)]);const _0x4095ec=await this[_0x4be648(0x170)]['findOne']({'where':{'upscaleId':_0x52759f,'action':'enlarge','orderId':_0x865400}});if(_0x4095ec)throw new common_1[(_0x4be648(0x128))](_0x4be648(0x13c),common_1[_0x4be648(0x165)][_0x4be648(0x192)]);const {prompt:_0x479981,extend:_0xf86499}=_0x414de9;let _0x3ead4c=null;try{_0x3ead4c=JSON[_0x4be648(0x166)](_0xf86499);}catch(_0xb67926){_0x3ead4c=[];}const {components:components=[]}=_0x3ead4c;if(!components['length'])throw new common_1[(_0x4be648(0x128))]('当前图片没有绘画信息、无法放大!',common_1['HttpStatus'][_0x4be648(0x192)]);const _0xd93edb=components[0x0]['components'][_0x865400-0x1],{custom_id:_0xf1db73}=_0xd93edb;console[_0x4be648(0x11f)](_0x4be648(0x134),_0xf1db73);const _0x4ed8ea={'message_id':_0x52759f,'custom_id':_0xf1db73,'prompt':_0x479981,'orderId':_0x865400};await this['sendSmInteractions'](_0x4ed8ea),console[_0x4be648(0x11f)](_0x4be648(0x142));const _0x26c216=await this[_0x4be648(0x170)][_0x4be648(0x147)]({'where':{'prompt':(0x0,typeorm_1[_0x4be648(0x15d)])('%'+_0x479981+'%')}}),_0x406386=_0x26c216[_0x4be648(0xfe)](_0x51dd37=>_0x51dd37[_0x4be648(0x136)]);console['log'](_0x4be648(0x182),_0x406386);const _0x186388=await this[_0x4be648(0xfb)](_0x4ed8ea,_0x406386);this['queueCount']--,this[_0x4be648(0x104)]<0x0&&(this[_0x4be648(0x104)]=0x0),console[_0x4be648(0x11f)]('放大图片任务结束\x20队列-1:\x20',this[_0x4be648(0x104)]);const {id:_0x406df3,content:_0x1fd61a,channel_id:_0x174624,attachments:attachments=[],timestamp:_0x2d32e6}=_0x186388;if(!attachments[_0x4be648(0x13a)]||!attachments[0x0][_0x4be648(0x144)])throw new common_1[(_0x4be648(0x128))](_0x4be648(0x101),common_1[_0x4be648(0x165)]['BAD_REQUEST']);const {filename:_0x1a055c,url:_0x46efe9,width:_0x42f609,height:_0x241a02,size:_0x39997f}=attachments[0x0],_0x5751a0=this[_0x4be648(0x111)]['getConfigs']([_0x4be648(0x1b3)]);let _0x18530e='';(!Number(_0x5751a0)||Number(_0x5751a0)===0x0)&&(_0x18530e=await this[_0x4be648(0x187)][_0x4be648(0x154)]({'filename':_0x1a055c,'url':_0x46efe9}),console['log'](_0x4be648(0xfc),_0x18530e));const _0x1894da={'curIp':(0x0,utils_1[_0x4be648(0x185)])(_0x587f4d),'userId':_0x587f4d['user']['id'],'type':balance_constant_1[_0x4be648(0x10f)][_0x4be648(0x114)],'prompt':_0x479981,'answer':_0x18530e,'model':'mj','extend':this[_0x4be648(0x10c)](JSON['stringify'](_0x186388)),'message_id':_0x52759f,'upscaleId':_0x406df3,'variationId':_0x406df3,'action':_0x4be648(0x159),'orderId':_0x4ed8ea[_0x4be648(0x164)],'isSaveImg':!Number(_0x5751a0)||Number(_0x5751a0)===0x0,'fileInfo':JSON[_0x4be648(0xff)]({'width':_0x42f609,'height':_0x241a02,'size':_0x39997f,'filename':_0x1a055c,'cosUrl':_0x18530e})};return await this[_0x4be648(0x14e)][_0x4be648(0x169)](_0x1894da),_0x18530e;}catch(_0xbcf603){console[_0x4be648(0x11f)](_0x4be648(0x138),_0xbcf603),this[_0x4be648(0x104)]--,this[_0x4be648(0x104)]<0x0&&(this[_0x4be648(0x104)]=0x0),console['log'](_0x4be648(0x1ad),this[_0x4be648(0x104)]);throw new common_1[(_0x4be648(0x128))](_0xbcf603[_0x4be648(0x140)],common_1[_0x4be648(0x165)][_0x4be648(0x192)]);}}async[_0x208520(0x151)](_0x51ed92,_0x2c4a8a){const _0x332bae=_0x208520;if(this[_0x332bae(0x104)]>=0x3)throw new common_1[(_0x332bae(0x128))](_0x332bae(0x17c),common_1[_0x332bae(0x165)][_0x332bae(0x192)]);await this[_0x332bae(0x135)](_0x2c4a8a),await this[_0x332bae(0x118)](_0x2c4a8a),this[_0x332bae(0x104)]++,console[_0x332bae(0x11f)]('用户'+_0x2c4a8a[_0x332bae(0x16c)]['id']+_0x332bae(0x1a6),this[_0x332bae(0x104)]);const {message_id:_0x549c2e,orderId:_0x29c615}=_0x51ed92;try{const _0x23ff42=await this[_0x332bae(0x170)][_0x332bae(0x110)]({'where':{'message_id':_0x549c2e}});if(!_0x23ff42)throw new common_1[(_0x332bae(0x128))](_0x332bae(0x1a5),common_1[_0x332bae(0x165)][_0x332bae(0x192)]);const {prompt:_0x4f7a63,extend:_0x30a720}=_0x23ff42;let _0x5851e7=null;try{_0x5851e7=JSON[_0x332bae(0x166)](_0x30a720);}catch(_0x577a18){_0x5851e7=[];}const {components:components=[]}=_0x5851e7;if(!components[_0x332bae(0x13a)])throw new common_1[(_0x332bae(0x128))](_0x332bae(0x190),common_1['HttpStatus'][_0x332bae(0x192)]);const _0x5b3340=components[0x1][_0x332bae(0x10a)][_0x29c615-0x1],{custom_id:_0x2a0b2a}=_0x5b3340,_0x1bdb7c=await this[_0x332bae(0x170)]['find']({'where':{'variationId':(0x0,typeorm_1[_0x332bae(0x168)])((0x0,typeorm_1[_0x332bae(0x11b)])()),'prompt':(0x0,typeorm_1[_0x332bae(0x15d)])('%'+_0x4f7a63+'%')}}),_0x2b8a49=_0x1bdb7c['map'](_0x559627=>_0x559627[_0x332bae(0x18e)]),_0x24621c={'message_id':_0x549c2e,'custom_id':_0x2a0b2a,'prompt':_0x4f7a63,'orderId':_0x29c615};await this[_0x332bae(0x130)](_0x24621c);const _0x430230=await this[_0x332bae(0xf8)](_0x24621c,_0x2b8a49);this['queueCount']--,this[_0x332bae(0x104)]<0x0&&(this['queueCount']=0x0),console[_0x332bae(0x11f)](_0x332bae(0x11e),this[_0x332bae(0x104)]);const {id:_0x318ff3,content:_0x5f3491,channel_id:_0x32137e,attachments:attachments=[],timestamp:_0x2c3759}=_0x430230;if(!attachments[_0x332bae(0x13a)]||!attachments[0x0][_0x332bae(0x144)])throw new common_1[(_0x332bae(0x128))](_0x332bae(0x14f),common_1[_0x332bae(0x165)][_0x332bae(0x192)]);const {filename:_0x4dcd75,url:_0x3b77f2,width:_0xa7b8f1,height:_0x147163,size:_0x20b90f}=attachments[0x0],_0x9e4101=this['globalConfigService'][_0x332bae(0x17d)]([_0x332bae(0x1b3)]);let _0x1c304b='';(!Number(_0x9e4101)||Number(_0x9e4101)===0x0)&&(_0x1c304b=await this[_0x332bae(0x187)][_0x332bae(0x154)]({'filename':_0x4dcd75,'url':_0x3b77f2}),console[_0x332bae(0x11f)](_0x332bae(0xfc),_0x1c304b));const _0x2e0031={'curIp':(0x0,utils_1[_0x332bae(0x185)])(_0x2c4a8a),'userId':_0x2c4a8a[_0x332bae(0x16c)]['id'],'type':balance_constant_1['DeductionKey'][_0x332bae(0x114)],'prompt':_0x4f7a63,'answer':_0x1c304b,'model':'mj','group':0x1,'extend':this[_0x332bae(0x10c)](JSON['stringify'](_0x430230)),'message_id':_0x318ff3,'upscaleId':_0x318ff3,'variationId':_0x318ff3,'action':_0x332bae(0x159),'orderId':_0x24621c[_0x332bae(0x164)],'isSaveImg':!Number(_0x9e4101)||Number(_0x9e4101)===0x0,'fileInfo':JSON[_0x332bae(0xff)]({'width':_0xa7b8f1,'height':_0x147163,'size':_0x20b90f,'filename':_0x4dcd75,'cosUrl':_0x1c304b})};return await this['chatLogService'][_0x332bae(0x169)](_0x2e0031),_0x1c304b;}catch(_0x598653){console['log'](_0x332bae(0x138),_0x598653),this['queueCount']--,this[_0x332bae(0x104)]<0x0&&(this[_0x332bae(0x104)]=0x0),console[_0x332bae(0x11f)](_0x332bae(0x127),this[_0x332bae(0x104)]);throw new common_1['HttpException'](_0x598653[_0x332bae(0x140)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x208520(0x130)](_0x59533b){const _0x229196=_0x208520,{message_id:_0x3744dd,custom_id:_0x1b6d9a}=_0x59533b,{application_id:_0x4bf33a,guild_id:_0x58ab33,channel_id:_0x16947a,session_id:_0x2c8d90,version:_0x4e5667,id:_0x2f77f7,authorization:_0xbe28ef,mjProxy:_0x33d41a}=await this['getMjDefaultParams'](),_0x4b36ca=_0x33d41a==0x1?'http://172.247.48.137:8000/mj/draw':'https://discord.com/api/v9/interactions',_0x4f2fd7={'authorization':_0xbe28ef},_0x3c9dd2={'type':0x3,'guild_id':_0x58ab33,'channel_id':_0x16947a,'message_flags':0x0,'message_id':_0x3744dd,'application_id':_0x4bf33a,'session_id':_0x2c8d90,'data':{'component_type':0x2,'custom_id':_0x1b6d9a}};try{await axios_1[_0x229196(0x188)][_0x229196(0x18d)](_0x4b36ca,_0x3c9dd2,{'headers':_0x4f2fd7}),console[_0x229196(0x11f)](_0x229196(0x18b));}catch(_0x194444){console[_0x229196(0x11f)](_0x229196(0x138),_0x194444);throw new common_1[(_0x229196(0x128))](_0x229196(0x189),common_1['HttpStatus'][_0x229196(0x192)]);}}async[_0x208520(0xfb)](_0x3c4109,_0x34666d){const _0x427d46=_0x208520,{message_id:_0x4a708f,custom_id:_0x279838,prompt:_0x5f1860,orderId:_0x92d65f}=_0x3c4109;let _0x24b9ad=null,_0x385c85=0x0;while(!_0x24b9ad&&_0x385c85<0xa){try{const _0x2e825e=Date[_0x427d46(0x152)](),_0x19c829=await this[_0x427d46(0x15c)]();console[_0x427d46(0x11f)]('第\x20'+(_0x385c85+0x1)+_0x427d46(0x183)+_0x19c829[_0x427d46(0x13a)]);_0x19c829&&_0x19c829[_0x427d46(0x13a)]&&(_0x24b9ad=await this[_0x427d46(0xf9)](_0x19c829,_0x3c4109,_0x34666d));const _0x1dbeb7=Date[_0x427d46(0x152)]()-_0x2e825e,_0x24f5e4=0xbb8;await this[_0x427d46(0x1a1)](Math[_0x427d46(0x18a)](_0x24f5e4-_0x1dbeb7,0x0)),_0x385c85++;}catch(_0xc9e88d){console[_0x427d46(0x17e)](_0x427d46(0x162)+_0xc9e88d[_0x427d46(0x186)]);}}return _0x24b9ad;}async[_0x208520(0xf8)](_0x18ccf8,_0x11c015){const _0x201488=_0x208520,{message_id:_0x21bf4e,custom_id:_0x1ef2d0,prompt:_0x301c17,orderId:_0x2d5944}=_0x18ccf8;console['log'](_0x201488(0x16f));let _0x4067f8=null,_0x47ad15=0x0;while(!_0x4067f8&&_0x47ad15<0xa){try{console['log']('第\x20'+(_0x47ad15+0x1)+_0x201488(0x15a));const _0x1fea1b=Date[_0x201488(0x152)](),_0x58204f=await this[_0x201488(0x15c)]();_0x58204f&&_0x58204f['length']&&(_0x4067f8=await this['findCurrentVariationImgResult'](_0x58204f,_0x18ccf8,_0x11c015));const _0x27dac6=Date[_0x201488(0x152)]()-_0x1fea1b,_0x53724e=0x1f40;await this[_0x201488(0x1a1)](Math['max'](_0x53724e-_0x27dac6,0x0)),_0x47ad15++;}catch(_0x3077d3){console['error'](_0x201488(0x162)+_0x3077d3[_0x201488(0x186)]);}}if(!_0x4067f8)throw new common_1['HttpException'](_0x201488(0x13e),common_1[_0x201488(0x165)]['BAD_REQUEST']);return _0x4067f8;}async[_0x208520(0xf9)](_0xdcdd53,_0x33f06e,_0x21241d){const _0x1dab84=_0x208520,{message_id:_0x444eab,custom_id:_0xf1533d,prompt:_0x5c1712,orderId:_0x3c97d5}=_0x33f06e,_0x4cc675=_0x5c1712[_0x1dab84(0x120)](0x0,0xc);console[_0x1dab84(0x11f)](_0x1dab84(0x125),_0x4cc675);const _0x1caccb=_0xdcdd53['find'](_0x1fd3ec=>{const _0x4a5f81=_0x1dab84,{content:_0x58bb4a}=_0x1fd3ec;if(!this[_0x4a5f81(0x191)](_0x58bb4a))return![];const {prompt:_0x57c11b,order:_0x36fabe}=this[_0x4a5f81(0x191)](_0x58bb4a);return _0x57c11b[_0x4a5f81(0x146)](_0x4cc675)&&_0x33f06e[_0x4a5f81(0x164)]===_0x36fabe&&!_0x21241d[_0x4a5f81(0x146)](_0x1fd3ec['id']);});return _0x1caccb;}async[_0x208520(0x150)](_0x4aa751,_0xce4674,_0x45e030){const _0x3ffa14=_0x208520,{message_id:_0x2b8d98,custom_id:_0x4e0526,prompt:_0x558cc4,orderId:_0x2b9bf1}=_0xce4674,_0x51cd06=_0x558cc4['substring'](0x0,0xc),_0x911ecb=_0x4aa751[_0x3ffa14(0x147)](_0x3c07c1=>{const _0x21248a=_0x3ffa14,{content:_0x512f62}=_0x3c07c1,_0x5b83e2=_0x512f62[_0x21248a(0x18c)](/\*\*(.+?)\*\*/),_0x55f0fd=_0x5b83e2?_0x5b83e2[0x1]:'';if(!_0x55f0fd)return![];return _0x55f0fd[_0x21248a(0x146)](_0x51cd06)&&!_0x45e030['includes'](_0x3c07c1['id']);});return _0x911ecb;}async[_0x208520(0x1a7)](_0x328ad8,_0x3535e3,_0x31a506){const _0x22f5cf=_0x208520,_0x3eff4a=await this['queryMessageList'](),_0x489ca6=await this[_0x22f5cf(0x129)](_0x3eff4a,_0x31a506,_0x3535e3);if(_0x489ca6)return console[_0x22f5cf(0x11f)]('有历史信息之间返回:\x20',_0x489ca6),_0x489ca6;const {application_id:_0x444824,guild_id:_0x20457f,channel_id:_0x4295e2,session_id:_0x26a053,version:_0x260ab5,id:_0x597472,authorization:_0x260590,mjProxy:_0x25f240}=await this['getMjDefaultParams'](),_0x16ac2d={'type':0x2,'application_id':_0x444824,'guild_id':_0x20457f,'channel_id':_0x4295e2,'session_id':_0x26a053,'data':{'version':_0x260ab5,'id':_0x597472,'name':_0x22f5cf(0x1a8),'type':0x1,'options':[{'type':0x3,'name':'prompt','value':_0x328ad8}],'attachments':[]}};try{const _0x54ca7e=_0x25f240==0x1?_0x22f5cf(0x1a9):_0x22f5cf(0xfa),_0x147f7a={'authorization':_0x260590},_0x265763=await axios_1['default'][_0x22f5cf(0x18d)](_0x54ca7e,_0x16ac2d,{'headers':_0x147f7a});return console[_0x22f5cf(0x11f)](_0x22f5cf(0x1aa),_0x265763[_0x22f5cf(0xf3)]),![];}catch(_0x51f873){console[_0x22f5cf(0x11f)](_0x22f5cf(0x11a),_0x51f873);throw new common_1[(_0x22f5cf(0x128))]('绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...',common_1[_0x22f5cf(0x165)]['BAD_REQUEST']);}}async[_0x208520(0x178)](_0x1a5a40,_0x3c4c46,_0x467f04){const _0x3bf665=_0x208520;console[_0x3bf665(0x11f)](_0x3bf665(0x11d));const _0x338c6c=Date['now']();try{const _0x42b3a5=0xd,_0x182e48=0x2ee0,_0x4adf1c=0x1388,_0x48539a=0x3c*0x3e8;let _0x2acff4=0x0,_0x4fd22c=![],_0x3ea1b3=null;while(!_0x3ea1b3&&_0x2acff4<_0x42b3a5){console['log']('第\x20'+(_0x2acff4+0x1)+_0x3bf665(0x184));Date[_0x3bf665(0x152)]()-_0x338c6c>=_0x48539a&&(_0x4fd22c=!![]);await this[_0x3bf665(0x1a1)](_0x4fd22c?_0x4adf1c:_0x182e48);const _0xa7efb0=await this[_0x3bf665(0x15c)]();_0x3ea1b3=await this[_0x3bf665(0x129)](_0xa7efb0,_0x467f04,_0x3c4c46),_0x2acff4++;}if(!_0x3ea1b3)throw new common_1[(_0x3bf665(0x128))](_0x3bf665(0x131),common_1[_0x3bf665(0x165)]['BAD_REQUEST']);const _0x36a005=Date[_0x3bf665(0x152)]();return console[_0x3bf665(0x11f)](_0x3bf665(0x17b)+Math[_0x3bf665(0x15e)]((_0x36a005-_0x338c6c)/0x3e8)+'\x20S'),_0x3ea1b3;}catch(_0x472a17){console[_0x3bf665(0x17e)](_0x472a17['message']);throw new common_1['HttpException'](_0x3bf665(0xf5),common_1[_0x3bf665(0x165)][_0x3bf665(0x161)]);}}async[_0x208520(0x129)](_0x58df54,_0x51324a,_0x2c67cd){const _0xff52ba=_0x208520;if(!_0x58df54||!_0x58df54[_0xff52ba(0x13a)])return;console[_0xff52ba(0x11f)](_0xff52ba(0x122),_0x51324a);const _0x23d165=_0x58df54[_0xff52ba(0x147)](_0x38f94a=>{const _0x3f0a16=_0xff52ba,{attachments:attachments=[],content:_0x2cdf6c,edited_timestamp:_0x51ff11}=_0x38f94a;return _0x2cdf6c[_0x3f0a16(0x146)](_0x51324a)&&attachments[_0x3f0a16(0x13a)]>0x0&&!_0x51ff11&&!_0x2c67cd[_0x3f0a16(0x146)](_0x38f94a['id']);});return _0x23d165||null;}async['queryMessageList'](){const _0x3ba904=_0x208520;try{const {application_id:_0x34ca7f,guild_id:_0xddc60e,channel_id:_0x30a300,session_id:_0xb30ebb,version:_0x21da05,id:_0x9b5adb,authorization:_0x568170,mjProxy:_0x2ae953}=await this[_0x3ba904(0x121)](),_0x31443b=_0x2ae953==0x1?'http://172.247.48.137:8000/mj/list?channel_id='+_0x30a300:_0x3ba904(0x1b0)+_0x30a300+_0x3ba904(0x157),_0x5357bc={'authorization':_0x568170},_0x1d8e21=await axios_1[_0x3ba904(0x188)][_0x3ba904(0x19d)](_0x31443b,{'headers':_0x5357bc});return _0x1d8e21[_0x3ba904(0xf3)];}catch(_0x1f98cd){console[_0x3ba904(0x11f)](_0x3ba904(0x1b4),_0x1f98cd);throw new common_1['HttpException'](_0x3ba904(0x141),common_1['HttpStatus'][_0x3ba904(0x192)]);}}async[_0x208520(0x1a1)](_0x5946ba){return new Promise(_0x57ca1d=>setTimeout(_0x57ca1d,_0x5946ba));}['extractContent'](_0x2380df){const _0x89f0df=_0x208520,_0x42da34=_0x2380df[_0x89f0df(0x18c)](/\*\*(.+?)\*\*/),_0x19562d=_0x2380df['match'](/- Image #(\d+)/);if(!_0x42da34||!_0x19562d)return null;const _0x22c7bc=_0x42da34[0x1],_0x3b4f28=parseInt(_0x19562d[0x1]);return{'prompt':_0x22c7bc,'order':_0x3b4f28};}async['getMjDefaultParams'](){const _0x5ee1d2=_0x208520,_0x4e486a=await this['globalConfigService'][_0x5ee1d2(0x17d)](['mjId',_0x5ee1d2(0x13d),'mjGuildId','mjChannelId','mjSessionId','mjVersion',_0x5ee1d2(0x155),_0x5ee1d2(0x160),_0x5ee1d2(0x1b2)]),_0x34ac1f={'application_id':_0x4e486a[_0x5ee1d2(0x13d)],'guild_id':_0x4e486a[_0x5ee1d2(0x115)],'channel_id':_0x4e486a[_0x5ee1d2(0x163)],'session_id':_0x4e486a[_0x5ee1d2(0x10b)],'version':_0x4e486a[_0x5ee1d2(0x100)],'id':_0x4e486a[_0x5ee1d2(0x158)],'authorization':_0x4e486a[_0x5ee1d2(0x155)],'mjRateLimit':_0x4e486a['mjRateLimit'],'mjProxy':_0x4e486a[_0x5ee1d2(0x1b2)]||0x0};return _0x34ac1f;}[_0x208520(0x10c)](_0x3e7d5b){const _0x572cd3=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x3e7d5b['replace'](_0x572cd3,'');}async['checkAuth'](_0xa69013){const _0xf6ca21=_0x208520,_0x289fbb=await this[_0xf6ca21(0x1ab)][_0xf6ca21(0x110)]({'where':{'userId':_0xa69013['user']['id']}}),{id:_0x140bc3,balance:_0x3f310d}=_0x289fbb;if(!_0x3f310d||(_0x289fbb===null||_0x289fbb===void 0x0?void 0x0:_0x289fbb[_0xf6ca21(0x16a)])<0x1)throw new common_1[(_0xf6ca21(0x128))](_0xf6ca21(0x176),common_1['HttpStatus'][_0xf6ca21(0x192)]);}async[_0x208520(0x180)](_0x188e9c){const _0x15204a=_0x208520,{id:_0x13d411,role:_0x39eb5a}=_0x188e9c[_0x15204a(0x16c)];!this[_0x15204a(0x19b)][_0x13d411]?this[_0x15204a(0x19b)][_0x13d411]=0x1:this[_0x15204a(0x19b)][_0x13d411]=this[_0x15204a(0x19b)][_0x13d411]+0x1,console[_0x15204a(0x11f)](_0x15204a(0x116)+_0x13d411+_0x15204a(0x193),this['freeQueueUsers'][_0x13d411]);}async[_0x208520(0x118)](_0x36875d){const _0xea6ca2=_0x208520,{id:_0x3dd345,role:_0xa8849}=_0x36875d[_0xea6ca2(0x16c)];if([_0xea6ca2(0x12a),_0xea6ca2(0x113)][_0xea6ca2(0x146)](_0xa8849))return!![];const {mjRateLimit:_0x22a705}=await this[_0xea6ca2(0x121)]();if(this['rateLimits'][_0x3dd345]){const _0x591e88=this[_0xea6ca2(0x119)][_0x3dd345];if(_0x591e88>Date[_0xea6ca2(0x152)]()){console['log'](_0xea6ca2(0x12e)+_0x3dd345+_0xea6ca2(0x117));throw new common_1[(_0xea6ca2(0x128))]('由于速率限制、当前普通用户限制为'+_0x22a705+_0xea6ca2(0x139),common_1[_0xea6ca2(0x165)][_0xea6ca2(0x192)]);}else this['rateLimits'][_0x3dd345]=Date[_0xea6ca2(0x152)]()+Number(_0x22a705)*0x3e8;}else{const _0x186385=Date['now']();this[_0xea6ca2(0x119)][_0x3dd345]=_0x186385+0x3e8*Number(_0x22a705);}}async[_0x208520(0x107)](_0x2a93b6){const _0x13c23e=_0x208520;await this[_0x13c23e(0x1ab)][_0x13c23e(0x1a0)]()[_0x13c23e(0x14a)](balance_entity_1[_0x13c23e(0x16e)])[_0x13c23e(0x12f)]({'balance':()=>_0x13c23e(0x167)})[_0x13c23e(0x1a2)](_0x13c23e(0x133),{'userId':_0x2a93b6['user']['id']})[_0x13c23e(0x171)]();}async[_0x208520(0x16d)](){return 0x1;}};function _0x5aa7(){const _0x2d6243=['saveChatLog','balance','prompt','user','test','BalanceEntity','开始轮询单张变换图片结果','chatLogEntity','execute','upscaleSingleImg','draw','badwordsService','1263143Ymdvqg','您当前暂无MJ绘画余额！！！','当前提示词已经在任务队列中了、请勿重复提交。。。','pollForResult','../fanyi/fanyi.service','55960lPnhdd','本次绘图耗时:\x20','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','getConfigs','error','../badwords/badwords.service','checkFree','拿到了远程地址:\x20','历史这些id已经被获取过了\x20不能拿了:\x20','\x20次开始查询\x20=>\x20当前查询结果：','\x20次开始查询','getClientIp','message','uploadService','default','放大单张图片请求失败...','max','绘图指令完成','match','post','variationId','fanyiService','当前图片没有绘画信息、无法变体!','extractContent','BAD_REQUEST','使用的次数：','axios','BadwordsService','9830uIYHYz','__param','baiduFanyiSecret','mjDraw','122332YwasCt','freeQueueUsers','Repository','get','ChatLogService','15111FWUCLl','createQueryBuilder','sleep','where','ChatLogEntity','convertToEnglish','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','开始请求变换图片\x20队列+1:\x20','sendDrawInteractions','imagine','http://172.247.48.137:8000/mj/draw','发送绘画指令结果:\x20','balanceEntity','prompt\x20-------->\x20\x20','放大图片任务异常中断\x20队列-1:\x20','../globalConfig/globalConfig.service','../chatLog/chatLog.entity','https://discord.com/api/v9/channels/','\x20队列+1:\x20','mjProxy','mjNotSaveImg','axios\x20get:\x20','push','decorate','data','metadata','网络连接失败，请稍后再试！','../chatLog/chatLog.service','FanyiService','pollForVariationResult','findCurrentEnlargeImgResult','https://discord.com/api/v9/interactions','pollForUpscaleResult','存入图片完成:\x20','3630564xLUHgg','map','stringify','mjVersion','放大当前图片失败','baiduFanyiAppId','2rCdYXX','queueCount','typeorm','绘画失败','deductBalance','filter','2969634nqYNvX','components','mjSessionId','removeEmoji','__metadata','历史记录中不存在当前图片、请确认您放大的图片是否存在','DeductionKey','findOne','globalConfigService','25ASqiZh','super','PAINT_TYPE','mjGuildId','当前用户','\x20请求过于频繁！','checkRateLimit','rateLimits','axios:\x20','IsNull','enlargeWorking','开始查询绘画结果轮询','变换图片任务结束\x20队列-1:\x20','log','substring','getMjDefaultParams','本次比对的随机ID:\x20','14wVqcFV','createRandomUid','本次放大图片的id:\x20','__esModule','变化图片任务异常中断\x20队列-1:\x20','HttpException','findCurrentPromptResult','admin','3613566sHpyzb','绘画任务开始','GlobalConfigService','当前用户\x20','set','sendSmInteractions','绘画超时，请稍后再试！','绘制图片任务结束\x20队列-1:\x20','userId\x20=\x20:userId','放大custom_id:\x20','checkAuth','message_id','design:paramtypes','error:\x20','秒请求一次、请合理使用！','length','function','当前图片已经放大过了、请勿重复放大!','mjApplicationId','变换当前图片超时！','Injectable','response','查询绘制结果失败...','发送放大指令成功','defineProperty','url','getOwnPropertyDescriptor','includes','find','绘制图片任务异常中断\x20队列-1:\x20','UploadService','update','__decorate','drawWorking','InjectRepository','chatLogService','变换当前图片失败','findCurrentVariationImgResult','variationSingleImg','now','../../common/constants/balance.constant','uploadFileFromUrl','mjAuthorization','开始请求用户','/messages?limit=50','mjId','enlarge','\x20次开始查询[变换图片]','../../common/utils','queryMessageList','Like','floor','checkBadWords','mjRateLimit','INTERNAL_SERVER_ERROR','查询期间出现错误：','mjChannelId','orderId','HttpStatus','parse','balance\x20-\x201','Not'];_0x5aa7=function(){return _0x2d6243;};return _0x5aa7();}MjService=__decorate([(0x0,common_1[_0x208520(0x13f)])(),__param(0x0,(0x0,typeorm_2[_0x208520(0x14d)])(chatLog_entity_1[_0x208520(0x1a3)])),__param(0x1,(0x0,typeorm_2[_0x208520(0x14d)])(balance_entity_1[_0x208520(0x16e)])),__metadata(_0x208520(0x137),[typeorm_1[_0x208520(0x19c)],typeorm_1['Repository'],upload_service_1[_0x208520(0x149)],chatLog_service_1[_0x208520(0x19e)],globalConfig_service_1[_0x208520(0x12d)],fanyi_service_1[_0x208520(0xf7)],badwords_service_1[_0x208520(0x195)]])],MjService),exports['MjService']=MjService;