'use strict';const _0x45af72=_0x6422;function _0x6422(_0x1084c7,_0x11a549){const _0x7686e0=_0x7686();return _0x6422=function(_0x6422f,_0x5d5189){_0x6422f=_0x6422f-0xdf;let _0x48f0f1=_0x7686e0[_0x6422f];return _0x48f0f1;},_0x6422(_0x1084c7,_0x11a549);}(function(_0x4921ba,_0x4cc16c){const _0x1f4d21=_0x6422,_0x5ae1a6=_0x4921ba();while(!![]){try{const _0x389242=parseInt(_0x1f4d21(0x12f))/0x1*(-parseInt(_0x1f4d21(0x123))/0x2)+parseInt(_0x1f4d21(0x125))/0x3+parseInt(_0x1f4d21(0x121))/0x4+parseInt(_0x1f4d21(0xfd))/0x5*(parseInt(_0x1f4d21(0x17e))/0x6)+-parseInt(_0x1f4d21(0x135))/0x7*(parseInt(_0x1f4d21(0xfe))/0x8)+-parseInt(_0x1f4d21(0x110))/0x9+parseInt(_0x1f4d21(0x177))/0xa;if(_0x389242===_0x4cc16c)break;else _0x5ae1a6['push'](_0x5ae1a6['shift']());}catch(_0xc8ba35){_0x5ae1a6['push'](_0x5ae1a6['shift']());}}}(_0x7686,0x9741b));var __decorate=this&&this['__decorate']||function(_0x2a72b6,_0x141fbe,_0x38e11c,_0x4e76c2){const _0x36fde1=_0x6422;var _0x56e12b=arguments[_0x36fde1(0x108)],_0x67ec1=_0x56e12b<0x3?_0x141fbe:_0x4e76c2===null?_0x4e76c2=Object[_0x36fde1(0x180)](_0x141fbe,_0x38e11c):_0x4e76c2,_0x440839;if(typeof Reflect===_0x36fde1(0x105)&&typeof Reflect[_0x36fde1(0x162)]==='function')_0x67ec1=Reflect[_0x36fde1(0x162)](_0x2a72b6,_0x141fbe,_0x38e11c,_0x4e76c2);else{for(var _0x420521=_0x2a72b6['length']-0x1;_0x420521>=0x0;_0x420521--)if(_0x440839=_0x2a72b6[_0x420521])_0x67ec1=(_0x56e12b<0x3?_0x440839(_0x67ec1):_0x56e12b>0x3?_0x440839(_0x141fbe,_0x38e11c,_0x67ec1):_0x440839(_0x141fbe,_0x38e11c))||_0x67ec1;}return _0x56e12b>0x3&&_0x67ec1&&Object[_0x36fde1(0x145)](_0x141fbe,_0x38e11c,_0x67ec1),_0x67ec1;},__metadata=this&&this[_0x45af72(0xe6)]||function(_0x438cee,_0x327439){const _0x523a8e=_0x45af72;if(typeof Reflect==='object'&&typeof Reflect[_0x523a8e(0x12c)]===_0x523a8e(0x158))return Reflect[_0x523a8e(0x12c)](_0x438cee,_0x327439);},__param=this&&this['__param']||function(_0x51a1f7,_0x4a4e07){return function(_0x342010,_0x211e0a){_0x4a4e07(_0x342010,_0x211e0a,_0x51a1f7);};};Object[_0x45af72(0x145)](exports,_0x45af72(0x117),{'value':!![]}),exports[_0x45af72(0x140)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),upload_service_1=require(_0x45af72(0x186)),common_1=require(_0x45af72(0x16d)),axios_1=require(_0x45af72(0x120)),chatLog_service_1=require('../chatLog/chatLog.service'),balance_constant_1=require(_0x45af72(0x126)),utils_1=require(_0x45af72(0x17a)),chatLog_entity_1=require(_0x45af72(0x189)),typeorm_1=require(_0x45af72(0x13e)),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require(_0x45af72(0x147)),fanyi_service_1=require(_0x45af72(0xeb)),badwords_service_1=require(_0x45af72(0x109));let MjService=class MjService{constructor(_0x16776a,_0x56a0ab,_0x870f51,_0x28312d,_0x52ae09,_0x184cf2,_0x243db8){const _0x2657be=_0x45af72;this[_0x2657be(0x128)]=_0x16776a,this[_0x2657be(0x150)]=_0x56a0ab,this['uploadService']=_0x870f51,this[_0x2657be(0x11a)]=_0x28312d,this[_0x2657be(0x127)]=_0x52ae09,this['fanyiService']=_0x184cf2,this[_0x2657be(0xee)]=_0x243db8,this[_0x2657be(0x17b)]={},this[_0x2657be(0x15a)]=[],this[_0x2657be(0x176)]=[],this[_0x2657be(0xf6)]=0x0,this[_0x2657be(0x167)]={};}async[_0x45af72(0x13f)](_0x653bff){const _0x56f83c=_0x45af72,{jobId:_0x195852,prompt:_0x28ee68,startTime:_0x504151,userId:_0x4777d5}=_0x653bff;return console[_0x56f83c(0x173)](_0x56f83c(0x138),'mjservice'),await new Promise(_0x3fda88=>setTimeout(_0x3fda88,0x1388)),{'a':0x1,'b':0x2};}async[_0x45af72(0x10f)](_0x534ff8,_0x4f7f05){const _0x3077fb=_0x45af72;await this['checkAuth'](_0x4f7f05),await this[_0x3077fb(0xee)]['checkBadWords'](_0x534ff8[_0x3077fb(0x18a)],_0x4f7f05['user']['id']);const _0x36734a=_0x534ff8[_0x3077fb(0x18a)];let _0x4f6977=_0x534ff8[_0x3077fb(0x18a)];const {baiduFanyiAppId:_0x3653be,baiduFanyiSecret:_0x223e6d}=await this[_0x3077fb(0x127)][_0x3077fb(0x15e)]([_0x3077fb(0x179),_0x3077fb(0x17c)]);_0x3653be&&_0x223e6d&&(_0x4f6977=await this[_0x3077fb(0x152)]['convertToEnglish'](_0x36734a));const _0x1a37e9='['+(0x0,utils_1[_0x3077fb(0x131)])()+']',_0x15e8ae=_0x1a37e9+'\x20'+_0x4f6977;console['log']('randomId:\x20',_0x1a37e9),console[_0x3077fb(0x173)](_0x3077fb(0x182),_0x15e8ae);const _0x14a962=this[_0x3077fb(0x15a)][_0x3077fb(0x132)](_0x5e4803=>_0x5e4803[_0x3077fb(0x165)](_0x534ff8[_0x3077fb(0x18a)]));if(_0x14a962)throw new common_1['HttpException'](_0x3077fb(0x103),common_1[_0x3077fb(0x13d)][_0x3077fb(0xf0)]);if(this[_0x3077fb(0xf6)]>=0x3)throw new common_1[(_0x3077fb(0x178))](_0x3077fb(0x174),common_1['HttpStatus'][_0x3077fb(0xf0)]);await this[_0x3077fb(0x18c)](_0x4f7f05),this[_0x3077fb(0xf6)]++,console[_0x3077fb(0x173)](_0x3077fb(0x16a)+_0x4f7f05[_0x3077fb(0xff)]['id']+_0x3077fb(0xfa),this[_0x3077fb(0xf6)]);try{const _0x161f84=await this['chatLogEntity'][_0x3077fb(0x132)]({'where':{'prompt':(0x0,typeorm_1[_0x3077fb(0x119)])('%'+_0x15e8ae+'%')}}),_0x2607dd=_0x161f84[_0x3077fb(0x10a)](_0x469034=>_0x469034[_0x3077fb(0x13a)]);this[_0x3077fb(0x15a)][_0x3077fb(0xdf)](_0x15e8ae);let _0x3a2298;const _0x495b37=await this[_0x3077fb(0x159)](_0x15e8ae,_0x2607dd,_0x1a37e9);_0x495b37?(console['log']('历史中存在当前图片、直接获取！'),_0x3a2298=_0x495b37):_0x3a2298=await this['pollForResult'](_0x15e8ae,_0x2607dd,_0x1a37e9);this[_0x3077fb(0xf6)]--,this[_0x3077fb(0xf6)]<0x0&&(this[_0x3077fb(0xf6)]=0x0),console[_0x3077fb(0x173)](_0x3077fb(0xf2),this[_0x3077fb(0xf6)]);const {id:_0x23edeb,content:_0x5b883c,channel_id:_0x3e3cd3,attachments:attachments=[],timestamp:_0x811f6f}=_0x3a2298;if(!attachments[_0x3077fb(0x108)]||!attachments[0x0][_0x3077fb(0x15f)])throw new common_1[(_0x3077fb(0x178))]('绘画失败',common_1[_0x3077fb(0x13d)]['BAD_REQUEST']);const {filename:_0x4c387b,url:_0x138a8e,width:_0x1c1cb9,height:_0x55daab,size:_0x5b9343}=attachments[0x0];console[_0x3077fb(0x173)](_0x3077fb(0x15b),_0x138a8e);const _0x1424d4=this[_0x3077fb(0x127)][_0x3077fb(0x15e)](['mjNotSaveImg']);let _0x22d151='';(!Number(_0x1424d4)||Number(_0x1424d4)===0x0)&&(_0x22d151=await this[_0x3077fb(0x106)][_0x3077fb(0x166)]({'filename':_0x4c387b,'url':_0x138a8e}),console[_0x3077fb(0x173)](_0x3077fb(0x124),_0x22d151));const _0x246ded={'curIp':(0x0,utils_1[_0x3077fb(0x15d)])(_0x4f7f05),'userId':_0x4f7f05[_0x3077fb(0xff)]['id'],'type':balance_constant_1[_0x3077fb(0x12d)][_0x3077fb(0x13b)],'prompt':_0x15e8ae,'answer':_0x22d151,'model':'mj','extend':this[_0x3077fb(0x10d)](JSON[_0x3077fb(0xfc)](_0x3a2298)),'message_id':_0x23edeb,'variationId':_0x23edeb,'upscaleId':_0x23edeb,'group':0x1,'isSaveImg':!Number(_0x1424d4)||Number(_0x1424d4)===0x0,'fileInfo':JSON[_0x3077fb(0xfc)]({'width':_0x1c1cb9,'height':_0x55daab,'size':_0x5b9343,'filename':_0x4c387b,'cosUrl':_0x22d151})};return await this[_0x3077fb(0x11a)]['saveChatLog'](_0x246ded),await this[_0x3077fb(0x12b)](_0x4f7f05),this['drawWorking']=this[_0x3077fb(0x15a)][_0x3077fb(0x133)](_0x23bcd5=>_0x23bcd5!==_0x534ff8[_0x3077fb(0x18a)]),_0x22d151;}catch(_0x3d26d8){this[_0x3077fb(0xf6)]--,this[_0x3077fb(0xf6)]<0x0&&(this[_0x3077fb(0xf6)]=0x0),console[_0x3077fb(0x173)](_0x3077fb(0xf9),this[_0x3077fb(0xf6)]),this['drawWorking']=this[_0x3077fb(0x15a)]['filter'](_0x68d803=>_0x68d803!==_0x534ff8[_0x3077fb(0x18a)]);throw new common_1[(_0x3077fb(0x178))](_0x3d26d8[_0x3077fb(0x16e)],common_1[_0x3077fb(0x13d)][_0x3077fb(0xf0)]);}}async[_0x45af72(0x14a)](_0x41b3bb,_0x5c844f){const _0x52a4de=_0x45af72;if(this[_0x52a4de(0xf6)]>=0x3)throw new common_1[(_0x52a4de(0x178))](_0x52a4de(0x174),common_1[_0x52a4de(0x13d)][_0x52a4de(0xf0)]);this[_0x52a4de(0xf6)]++,console[_0x52a4de(0x173)]('用户'+_0x5c844f[_0x52a4de(0xff)]['id']+_0x52a4de(0x164),this[_0x52a4de(0xf6)]);const {message_id:_0x1c7388,orderId:_0x5c30a4}=_0x41b3bb;try{const _0x3e9a7f=await this['chatLogEntity']['findOne']({'where':{'message_id':_0x1c7388}});if(!_0x3e9a7f)throw new common_1[(_0x52a4de(0x178))](_0x52a4de(0x154),common_1['HttpStatus'][_0x52a4de(0xf0)]);const _0x4e503f=await this[_0x52a4de(0x128)][_0x52a4de(0xe1)]({'where':{'upscaleId':_0x1c7388,'action':'enlarge','orderId':_0x5c30a4}});if(_0x4e503f)throw new common_1[(_0x52a4de(0x178))](_0x52a4de(0x12a),common_1[_0x52a4de(0x13d)]['BAD_REQUEST']);const {prompt:_0x460b54,extend:_0x3ba83d}=_0x3e9a7f;let _0x55da9=null;try{_0x55da9=JSON[_0x52a4de(0x170)](_0x3ba83d);}catch(_0xb7c43b){_0x55da9=[];}const {components:components=[]}=_0x55da9;if(!components[_0x52a4de(0x108)])throw new common_1[(_0x52a4de(0x178))](_0x52a4de(0x160),common_1['HttpStatus'][_0x52a4de(0xf0)]);const _0xd2cd1f=components[0x0]['components'][_0x5c30a4-0x1],{custom_id:_0x2389cf}=_0xd2cd1f;console[_0x52a4de(0x173)](_0x52a4de(0xe7),_0x2389cf);const _0x154f62={'message_id':_0x1c7388,'custom_id':_0x2389cf,'prompt':_0x460b54,'orderId':_0x5c30a4};await this[_0x52a4de(0x13c)](_0x154f62),console[_0x52a4de(0x173)](_0x52a4de(0x185));const _0x36b7f5=await this[_0x52a4de(0x128)]['find']({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0x460b54+'%')}}),_0x42e8e1=_0x36b7f5[_0x52a4de(0x10a)](_0x1b4ac1=>_0x1b4ac1[_0x52a4de(0x13a)]);console[_0x52a4de(0x173)]('历史这些id已经被获取过了\x20不能拿了:\x20',_0x42e8e1);const _0x4086df=await this[_0x52a4de(0xf4)](_0x154f62,_0x42e8e1);this[_0x52a4de(0xf6)]--,this[_0x52a4de(0xf6)]<0x0&&(this[_0x52a4de(0xf6)]=0x0),console[_0x52a4de(0x173)](_0x52a4de(0xfb),this[_0x52a4de(0xf6)]);const {id:_0x3116c8,content:_0x5ba57b,channel_id:_0x1d6aa1,attachments:attachments=[],timestamp:_0xc8d3a1}=_0x4086df;if(!attachments[_0x52a4de(0x108)]||!attachments[0x0][_0x52a4de(0x15f)])throw new common_1[(_0x52a4de(0x178))](_0x52a4de(0xe5),common_1['HttpStatus'][_0x52a4de(0xf0)]);const {filename:_0x2d6d82,url:_0x350544,width:_0x447468,height:_0x2e066a,size:_0x575df9}=attachments[0x0],_0x511bdf=this[_0x52a4de(0x127)][_0x52a4de(0x15e)](['mjNotSaveImg']);let _0xe3d898='';(!Number(_0x511bdf)||Number(_0x511bdf)===0x0)&&(_0xe3d898=await this[_0x52a4de(0x106)][_0x52a4de(0x166)]({'filename':_0x2d6d82,'url':_0x350544}),console[_0x52a4de(0x173)](_0x52a4de(0x124),_0xe3d898));const _0x121c2b={'curIp':(0x0,utils_1[_0x52a4de(0x15d)])(_0x5c844f),'userId':_0x5c844f['user']['id'],'type':balance_constant_1[_0x52a4de(0x12d)][_0x52a4de(0x13b)],'prompt':_0x460b54,'answer':_0xe3d898,'model':'mj','extend':this[_0x52a4de(0x10d)](JSON[_0x52a4de(0xfc)](_0x4086df)),'message_id':_0x1c7388,'upscaleId':_0x3116c8,'variationId':_0x3116c8,'action':_0x52a4de(0xe0),'orderId':_0x154f62[_0x52a4de(0x118)],'isSaveImg':!Number(_0x511bdf)||Number(_0x511bdf)===0x0,'fileInfo':JSON[_0x52a4de(0xfc)]({'width':_0x447468,'height':_0x2e066a,'size':_0x575df9,'filename':_0x2d6d82,'cosUrl':_0xe3d898})};return await this[_0x52a4de(0x11a)][_0x52a4de(0x14f)](_0x121c2b),_0xe3d898;}catch(_0x3aa839){console[_0x52a4de(0x173)](_0x52a4de(0x168),_0x3aa839),this[_0x52a4de(0xf6)]--,this[_0x52a4de(0xf6)]<0x0&&(this[_0x52a4de(0xf6)]=0x0),console[_0x52a4de(0x173)](_0x52a4de(0x11e),this[_0x52a4de(0xf6)]);throw new common_1[(_0x52a4de(0x178))](_0x3aa839[_0x52a4de(0x16e)],common_1['HttpStatus'][_0x52a4de(0xf0)]);}}async[_0x45af72(0x141)](_0x4b8b83,_0x51eb91){const _0xc94834=_0x45af72;if(this[_0xc94834(0xf6)]>=0x3)throw new common_1[(_0xc94834(0x178))](_0xc94834(0x174),common_1[_0xc94834(0x13d)][_0xc94834(0xf0)]);await this[_0xc94834(0x146)](_0x51eb91),await this['checkRateLimit'](_0x51eb91),this[_0xc94834(0xf6)]++,console[_0xc94834(0x173)]('用户'+_0x51eb91[_0xc94834(0xff)]['id']+'开始请求变换图片\x20队列+1:\x20',this[_0xc94834(0xf6)]);const {message_id:_0x17276d,orderId:_0x68b6e}=_0x4b8b83;try{const _0x3a6b85=await this['chatLogEntity'][_0xc94834(0xe1)]({'where':{'message_id':_0x17276d}});if(!_0x3a6b85)throw new common_1[(_0xc94834(0x178))](_0xc94834(0x17f),common_1[_0xc94834(0x13d)][_0xc94834(0xf0)]);const {prompt:_0x4615f1,extend:_0x2f9a70}=_0x3a6b85;let _0xb91ea4=null;try{_0xb91ea4=JSON[_0xc94834(0x170)](_0x2f9a70);}catch(_0x173d49){_0xb91ea4=[];}const {components:components=[]}=_0xb91ea4;if(!components[_0xc94834(0x108)])throw new common_1[(_0xc94834(0x178))]('当前图片没有绘画信息、无法变体!',common_1[_0xc94834(0x13d)][_0xc94834(0xf0)]);const _0x1f8197=components[0x1]['components'][_0x68b6e-0x1],{custom_id:_0x48b602}=_0x1f8197,_0x5dc515=await this[_0xc94834(0x128)][_0xc94834(0x132)]({'where':{'variationId':(0x0,typeorm_1['Not'])((0x0,typeorm_1[_0xc94834(0x142)])()),'prompt':(0x0,typeorm_1[_0xc94834(0x119)])('%'+_0x4615f1+'%')}}),_0x19d6b2=_0x5dc515[_0xc94834(0x10a)](_0x1f312b=>_0x1f312b['variationId']),_0x391f4c={'message_id':_0x17276d,'custom_id':_0x48b602,'prompt':_0x4615f1,'orderId':_0x68b6e};await this[_0xc94834(0x13c)](_0x391f4c);const _0x3b7184=await this[_0xc94834(0xf3)](_0x391f4c,_0x19d6b2);this['queueCount']--,this[_0xc94834(0xf6)]<0x0&&(this[_0xc94834(0xf6)]=0x0),console[_0xc94834(0x173)](_0xc94834(0x171),this[_0xc94834(0xf6)]);const {id:_0x3e0d40,content:_0x382307,channel_id:_0x5c708d,attachments:attachments=[],timestamp:_0x58223d}=_0x3b7184;if(!attachments[_0xc94834(0x108)]||!attachments[0x0][_0xc94834(0x15f)])throw new common_1['HttpException'](_0xc94834(0xed),common_1[_0xc94834(0x13d)][_0xc94834(0xf0)]);const {filename:_0x6f7e9c,url:_0x10d5d8,width:_0x5dadf8,height:_0x4a0b6c,size:_0x4fa501}=attachments[0x0],_0x57af38=this[_0xc94834(0x127)]['getConfigs'](['mjNotSaveImg']);let _0x5ea686='';(!Number(_0x57af38)||Number(_0x57af38)===0x0)&&(_0x5ea686=await this[_0xc94834(0x106)][_0xc94834(0x166)]({'filename':_0x6f7e9c,'url':_0x10d5d8}),console['log'](_0xc94834(0x124),_0x5ea686));const _0x31f43f={'curIp':(0x0,utils_1[_0xc94834(0x15d)])(_0x51eb91),'userId':_0x51eb91['user']['id'],'type':balance_constant_1[_0xc94834(0x12d)][_0xc94834(0x13b)],'prompt':_0x4615f1,'answer':_0x5ea686,'model':'mj','group':0x1,'extend':this['removeEmoji'](JSON[_0xc94834(0xfc)](_0x3b7184)),'message_id':_0x3e0d40,'upscaleId':_0x3e0d40,'variationId':_0x3e0d40,'action':'enlarge','orderId':_0x391f4c['orderId'],'isSaveImg':!Number(_0x57af38)||Number(_0x57af38)===0x0,'fileInfo':JSON[_0xc94834(0xfc)]({'width':_0x5dadf8,'height':_0x4a0b6c,'size':_0x4fa501,'filename':_0x6f7e9c,'cosUrl':_0x5ea686})};return await this[_0xc94834(0x11a)][_0xc94834(0x14f)](_0x31f43f),_0x5ea686;}catch(_0x1173b6){console[_0xc94834(0x173)](_0xc94834(0x168),_0x1173b6),this[_0xc94834(0xf6)]--,this[_0xc94834(0xf6)]<0x0&&(this[_0xc94834(0xf6)]=0x0),console[_0xc94834(0x173)](_0xc94834(0x10b),this[_0xc94834(0xf6)]);throw new common_1['HttpException'](_0x1173b6['response'],common_1[_0xc94834(0x13d)][_0xc94834(0xf0)]);}}async[_0x45af72(0x13c)](_0x186515){const _0x1f2a0a=_0x45af72,{message_id:_0x169cce,custom_id:_0x664315}=_0x186515,{application_id:_0x4ccc68,guild_id:_0x3175e3,channel_id:_0x566f33,session_id:_0x3f73bf,version:_0x564191,id:_0xd5ea94,authorization:_0x229ce9,mjProxy:_0x57b332}=await this[_0x1f2a0a(0xf8)](),_0x220621=_0x57b332==0x1?_0x1f2a0a(0x184):'https://discord.com/api/v9/interactions',_0xc8a535={'authorization':_0x229ce9},_0x2d73f3={'type':0x3,'guild_id':_0x3175e3,'channel_id':_0x566f33,'message_flags':0x0,'message_id':_0x169cce,'application_id':_0x4ccc68,'session_id':_0x3f73bf,'data':{'component_type':0x2,'custom_id':_0x664315}};try{await axios_1[_0x1f2a0a(0x175)][_0x1f2a0a(0x139)](_0x220621,_0x2d73f3,{'headers':_0xc8a535}),console['log'](_0x1f2a0a(0x113));}catch(_0xa5863b){console[_0x1f2a0a(0x173)]('error:\x20',_0xa5863b);throw new common_1[(_0x1f2a0a(0x178))](_0x1f2a0a(0x188),common_1[_0x1f2a0a(0x13d)]['BAD_REQUEST']);}}async[_0x45af72(0xf4)](_0x5b8e5f,_0x4bfb23){const _0x330f3c=_0x45af72,{message_id:_0x540f98,custom_id:_0x33059e,prompt:_0x11527a,orderId:_0xbbc6c7}=_0x5b8e5f;let _0x384e12=null,_0xe1f4fb=0x0;while(!_0x384e12&&_0xe1f4fb<0xa){try{const _0x4869b1=Date[_0x330f3c(0x12e)](),_0x12cab4=await this[_0x330f3c(0x14c)]();console[_0x330f3c(0x173)]('第\x20'+(_0xe1f4fb+0x1)+'\x20次开始查询\x20=>\x20当前查询结果：'+_0x12cab4[_0x330f3c(0x108)]);_0x12cab4&&_0x12cab4[_0x330f3c(0x108)]&&(_0x384e12=await this[_0x330f3c(0x130)](_0x12cab4,_0x5b8e5f,_0x4bfb23));const _0x2b7dd7=Date[_0x330f3c(0x12e)]()-_0x4869b1,_0x142da9=0xbb8;await this[_0x330f3c(0x16f)](Math[_0x330f3c(0x101)](_0x142da9-_0x2b7dd7,0x0)),_0xe1f4fb++;}catch(_0x276212){console[_0x330f3c(0x136)](_0x330f3c(0x137)+_0x276212['message']);}}return _0x384e12;}async[_0x45af72(0xf3)](_0x511594,_0x2bc86d){const _0x4e3053=_0x45af72,{message_id:_0x2ca7c9,custom_id:_0x2270fe,prompt:_0x59b51c,orderId:_0x4b4335}=_0x511594;console[_0x4e3053(0x173)](_0x4e3053(0x15c));let _0x2c8472=null,_0x1f2610=0x0;while(!_0x2c8472&&_0x1f2610<0xa){try{console[_0x4e3053(0x173)]('第\x20'+(_0x1f2610+0x1)+'\x20次开始查询[变换图片]');const _0xada766=Date[_0x4e3053(0x12e)](),_0x2bdb4d=await this[_0x4e3053(0x14c)]();_0x2bdb4d&&_0x2bdb4d['length']&&(_0x2c8472=await this[_0x4e3053(0xe2)](_0x2bdb4d,_0x511594,_0x2bc86d));const _0x2b3b2e=Date[_0x4e3053(0x12e)]()-_0xada766,_0x4f50ef=0x1f40;await this[_0x4e3053(0x16f)](Math[_0x4e3053(0x101)](_0x4f50ef-_0x2b3b2e,0x0)),_0x1f2610++;}catch(_0x39062c){console[_0x4e3053(0x136)](_0x4e3053(0x137)+_0x39062c['message']);}}if(!_0x2c8472)throw new common_1[(_0x4e3053(0x178))]('变换当前图片超时！',common_1[_0x4e3053(0x13d)][_0x4e3053(0xf0)]);return _0x2c8472;}async[_0x45af72(0x130)](_0x454188,_0x56413f,_0x323867){const _0x12d017=_0x45af72,{message_id:_0x5bdf1a,custom_id:_0x52564c,prompt:_0x5a6fe7,orderId:_0xad6bcc}=_0x56413f,_0x48e0b9=_0x5a6fe7[_0x12d017(0x129)](0x0,0xc);console['log'](_0x12d017(0x10c),_0x48e0b9);const _0x5e3e19=_0x454188[_0x12d017(0x132)](_0x41411c=>{const _0x3a7cb1=_0x12d017,{content:_0x116071}=_0x41411c;if(!this[_0x3a7cb1(0x11d)](_0x116071))return![];const {prompt:_0x139419,order:_0x21b0c5}=this[_0x3a7cb1(0x11d)](_0x116071);return _0x139419[_0x3a7cb1(0x165)](_0x48e0b9)&&_0x56413f[_0x3a7cb1(0x118)]===_0x21b0c5&&!_0x323867['includes'](_0x41411c['id']);});return _0x5e3e19;}async[_0x45af72(0xe2)](_0x449a63,_0x2a9b0c,_0x67b48e){const _0x1f9f49=_0x45af72,{message_id:_0x2aa09c,custom_id:_0x435f3f,prompt:_0xf6a62e,orderId:_0x6c0b0d}=_0x2a9b0c,_0x4939a2=_0xf6a62e[_0x1f9f49(0x129)](0x0,0xc),_0x5664df=_0x449a63[_0x1f9f49(0x132)](_0x545990=>{const _0x4ea7a5=_0x1f9f49,{content:_0x321904}=_0x545990,_0x567722=_0x321904['match'](/\*\*(.+?)\*\*/),_0x43adda=_0x567722?_0x567722[0x1]:'';if(!_0x43adda)return![];return _0x43adda[_0x4ea7a5(0x165)](_0x4939a2)&&!_0x67b48e[_0x4ea7a5(0x165)](_0x545990['id']);});return _0x5664df;}async[_0x45af72(0x159)](_0x27a7dd,_0x27d303,_0xabb176){const _0x55016c=_0x45af72,_0x49aa5f=await this['queryMessageList'](),_0x3524d1=await this[_0x55016c(0x111)](_0x49aa5f,_0xabb176,_0x27d303);if(_0x3524d1)return console[_0x55016c(0x173)]('有历史信息之间返回:\x20',_0x3524d1),_0x3524d1;const {application_id:_0x188449,guild_id:_0x39ec49,channel_id:_0x4dc4ab,session_id:_0x41ef74,version:_0x17b899,id:_0x35f224,authorization:_0xabce7b,mjProxy:_0x32f2fc}=await this[_0x55016c(0xf8)](),_0x542799={'type':0x2,'application_id':_0x188449,'guild_id':_0x39ec49,'channel_id':_0x4dc4ab,'session_id':_0x41ef74,'data':{'version':_0x17b899,'id':_0x35f224,'name':_0x55016c(0x143),'type':0x1,'options':[{'type':0x3,'name':'prompt','value':_0x27a7dd}],'attachments':[]}};try{const _0x3f5dc7=_0x32f2fc==0x1?'http://172.247.48.137:8000/mj/draw':'https://discord.com/api/v9/interactions',_0xd19be8={'authorization':_0xabce7b},_0x5c8da3=await axios_1[_0x55016c(0x175)][_0x55016c(0x139)](_0x3f5dc7,_0x542799,{'headers':_0xd19be8});return console[_0x55016c(0x173)](_0x55016c(0x14e),_0x5c8da3['data']),![];}catch(_0x28706c){console[_0x55016c(0x173)](_0x55016c(0xf1),_0x28706c);throw new common_1[(_0x55016c(0x178))]('绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...',common_1[_0x55016c(0x13d)][_0x55016c(0xf0)]);}}async['pollForResult'](_0x21d719,_0x274dc4,_0x31ab9f){const _0x71415c=_0x45af72;console[_0x71415c(0x173)]('开始查询绘画结果轮询');const _0x57a001=Date['now']();try{const _0x772035=0xd,_0x119fd3=0x2ee0,_0x162daa=0x1388,_0x2538b4=0x3c*0x3e8;let _0x517f49=0x0,_0x43977c=![],_0x34aead=null;while(!_0x34aead&&_0x517f49<_0x772035){console[_0x71415c(0x173)]('第\x20'+(_0x517f49+0x1)+'\x20次开始查询');Date[_0x71415c(0x12e)]()-_0x57a001>=_0x2538b4&&(_0x43977c=!![]);await this[_0x71415c(0x16f)](_0x43977c?_0x162daa:_0x119fd3);const _0x4ba63f=await this[_0x71415c(0x14c)]();_0x34aead=await this[_0x71415c(0x111)](_0x4ba63f,_0x31ab9f,_0x274dc4),_0x517f49++;}if(!_0x34aead)throw new common_1['HttpException'](_0x71415c(0x112),common_1[_0x71415c(0x13d)][_0x71415c(0xf0)]);const _0x59761d=Date[_0x71415c(0x12e)]();return console[_0x71415c(0x173)]('本次绘图耗时:\x20'+Math[_0x71415c(0xe3)]((_0x59761d-_0x57a001)/0x3e8)+'\x20S'),_0x34aead;}catch(_0x5ee45a){console[_0x71415c(0x136)](_0x5ee45a[_0x71415c(0x169)]);throw new common_1[(_0x71415c(0x178))]('网络连接失败，请稍后再试！',common_1[_0x71415c(0x13d)][_0x71415c(0xea)]);}}async[_0x45af72(0x111)](_0x12e084,_0x253596,_0x3eae5a){const _0x2634ed=_0x45af72;if(!_0x12e084||!_0x12e084[_0x2634ed(0x108)])return;console['log'](_0x2634ed(0x156),_0x253596);const _0xa97cc9=_0x12e084[_0x2634ed(0x132)](_0x472399=>{const _0x5f0aa7=_0x2634ed,{attachments:attachments=[],content:_0xd25150,edited_timestamp:_0x34a421}=_0x472399;return _0xd25150[_0x5f0aa7(0x165)](_0x253596)&&attachments[_0x5f0aa7(0x108)]>0x0&&!_0x34a421&&!_0x3eae5a[_0x5f0aa7(0x165)](_0x472399['id']);});return _0xa97cc9||null;}async[_0x45af72(0x14c)](){const _0x501cd4=_0x45af72;try{const {application_id:_0x442e9e,guild_id:_0x247a93,channel_id:_0x5c1bba,session_id:_0x3a65d0,version:_0x14515d,id:_0x13dfdf,authorization:_0x5084db,mjProxy:_0xf037dd}=await this[_0x501cd4(0xf8)](),_0x3bb30c=_0xf037dd==0x1?_0x501cd4(0xf7)+_0x5c1bba:_0x501cd4(0x114)+_0x5c1bba+_0x501cd4(0x115),_0xac707b={'authorization':_0x5084db},_0x22fe05=await axios_1[_0x501cd4(0x175)][_0x501cd4(0xef)](_0x3bb30c,{'headers':_0xac707b});return _0x22fe05[_0x501cd4(0x153)];}catch(_0x5b8536){console[_0x501cd4(0x173)](_0x501cd4(0x18d),_0x5b8536);throw new common_1[(_0x501cd4(0x178))](_0x501cd4(0x116),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x45af72(0x16f)](_0x29e8dc){return new Promise(_0x256d30=>setTimeout(_0x256d30,_0x29e8dc));}[_0x45af72(0x11d)](_0x597692){const _0x3e9a66=_0x45af72,_0x282501=_0x597692['match'](/\*\*(.+?)\*\*/),_0x27544a=_0x597692[_0x3e9a66(0x161)](/- Image #(\d+)/);if(!_0x282501||!_0x27544a)return null;const _0x463312=_0x282501[0x1],_0x287e4f=parseInt(_0x27544a[0x1]);return{'prompt':_0x463312,'order':_0x287e4f};}async[_0x45af72(0xf8)](){const _0x495fdd=_0x45af72,_0x5a6fdc=await this['globalConfigService']['getConfigs']([_0x495fdd(0xe8),'mjApplicationId',_0x495fdd(0x102),_0x495fdd(0x104),'mjSessionId',_0x495fdd(0x122),_0x495fdd(0x100),_0x495fdd(0x134),_0x495fdd(0x16b)]),_0x43602b={'application_id':_0x5a6fdc[_0x495fdd(0x107)],'guild_id':_0x5a6fdc[_0x495fdd(0x102)],'channel_id':_0x5a6fdc[_0x495fdd(0x104)],'session_id':_0x5a6fdc[_0x495fdd(0x11c)],'version':_0x5a6fdc[_0x495fdd(0x122)],'id':_0x5a6fdc[_0x495fdd(0xe8)],'authorization':_0x5a6fdc[_0x495fdd(0x100)],'mjRateLimit':_0x5a6fdc[_0x495fdd(0x134)],'mjProxy':_0x5a6fdc[_0x495fdd(0x16b)]||0x0};return _0x43602b;}['removeEmoji'](_0x1c8d6b){const _0x3ee208=_0x45af72,_0x232506=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x1c8d6b[_0x3ee208(0x187)](_0x232506,'');}async[_0x45af72(0x146)](_0x21666a){const _0x519158=_0x45af72,_0x54f8e3=await this[_0x519158(0x150)]['findOne']({'where':{'userId':_0x21666a[_0x519158(0xff)]['id']}}),{id:_0x1ff21f,balance:_0x2a0715}=_0x54f8e3;if(!_0x2a0715||(_0x54f8e3===null||_0x54f8e3===void 0x0?void 0x0:_0x54f8e3['balance'])<0x1)throw new common_1[(_0x519158(0x178))]('您当前暂无MJ绘画余额！！！',common_1[_0x519158(0x13d)][_0x519158(0xf0)]);}async[_0x45af72(0x14b)](_0x3cae2e){const _0x58d19f=_0x45af72,{id:_0x29bb3a,role:_0x289f3e}=_0x3cae2e[_0x58d19f(0xff)];!this[_0x58d19f(0x167)][_0x29bb3a]?this[_0x58d19f(0x167)][_0x29bb3a]=0x1:this['freeQueueUsers'][_0x29bb3a]=this[_0x58d19f(0x167)][_0x29bb3a]+0x1,console['log'](_0x58d19f(0x11b)+_0x29bb3a+_0x58d19f(0x18b),this[_0x58d19f(0x167)][_0x29bb3a]);}async[_0x45af72(0x18c)](_0x285f2e){const _0x127ca0=_0x45af72,{id:_0x1db42c,role:_0x964605}=_0x285f2e[_0x127ca0(0xff)];if(['admin',_0x127ca0(0x148)]['includes'](_0x964605))return!![];const {mjRateLimit:_0x52e0aa}=await this[_0x127ca0(0xf8)]();if(this[_0x127ca0(0x17b)][_0x1db42c]){const _0x5191f1=this[_0x127ca0(0x17b)][_0x1db42c];if(_0x5191f1>Date['now']()){console[_0x127ca0(0x173)](_0x127ca0(0x151)+_0x1db42c+_0x127ca0(0xf5));throw new common_1[(_0x127ca0(0x178))]('由于速率限制、当前普通用户限制为'+_0x52e0aa+_0x127ca0(0x157),common_1['HttpStatus'][_0x127ca0(0xf0)]);}else this['rateLimits'][_0x1db42c]=Date['now']()+Number(_0x52e0aa)*0x3e8;}else{const _0x167f2b=Date[_0x127ca0(0x12e)]();this[_0x127ca0(0x17b)][_0x1db42c]=_0x167f2b+0x3e8*Number(_0x52e0aa);}}async[_0x45af72(0x12b)](_0x285b12){const _0x27433f=_0x45af72;await this[_0x27433f(0x150)][_0x27433f(0x172)]()[_0x27433f(0x183)](balance_entity_1[_0x27433f(0xe9)])[_0x27433f(0x11f)]({'balance':()=>_0x27433f(0x16c)})['where'](_0x27433f(0x163),{'userId':_0x285b12['user']['id']})[_0x27433f(0x181)]();}async['test'](){return 0x1;}};function _0x7686(){const _0x397ee6=['查询绘制结果失败...','__esModule','orderId','Like','chatLogService','当前用户','mjSessionId','extractContent','放大图片任务异常中断\x20队列-1:\x20','set','axios','783752EHwsym','mjVersion','2pHvduz','存入图片完成:\x20','1953042XeQCjG','../../common/constants/balance.constant','globalConfigService','chatLogEntity','substring','当前图片已经放大过了、请勿重复放大!','deductBalance','metadata','DeductionKey','now','1146616TiehYy','findCurrentEnlargeImgResult','createRandomUid','find','filter','mjRateLimit','7QOLCjT','error','查询期间出现错误：','绘画任务开始','post','message_id','PAINT_TYPE','sendSmInteractions','HttpStatus','typeorm','mjDraw','MjService','variationSingleImg','IsNull','imagine','BadwordsService','defineProperty','checkAuth','../userBalance/balance.entity','super','ChatLogEntity','upscaleSingleImg','checkFree','queryMessageList','GlobalConfigService','发送绘画指令结果:\x20','saveChatLog','balanceEntity','当前用户\x20','fanyiService','data','历史记录中不存在当前图片、请确认您放大的图片是否存在','Injectable','本次比对的随机ID:\x20','秒请求一次、请合理使用！','function','sendDrawInteractions','drawWorking','拿到了远程地址:\x20','开始轮询单张变换图片结果','getClientIp','getConfigs','url','当前图片没有绘画信息、无法放大!','match','decorate','userId\x20=\x20:userId','开始请求放大图片\x20队列+1:\x20','includes','uploadFileFromUrl','freeQueueUsers','error:\x20','message','开始请求用户','mjProxy','balance\x20-\x201','@nestjs/common','response','sleep','parse','变换图片任务结束\x20队列-1:\x20','createQueryBuilder','log','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','default','enlargeWorking','17737860kedPUB','HttpException','baiduFanyiAppId','../../common/utils','rateLimits','baiduFanyiSecret','InjectRepository','1510794zYFWMI','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','getOwnPropertyDescriptor','execute','prompt\x20-------->\x20\x20','update','http://172.247.48.137:8000/mj/draw','发送放大指令成功','../upload/upload.service','replace','放大单张图片请求失败...','../chatLog/chatLog.entity','prompt','使用的次数：','checkRateLimit','axios\x20get:\x20','push','enlarge','findOne','findCurrentVariationImgResult','floor','FanyiService','放大当前图片失败','__metadata','放大custom_id:\x20','mjId','BalanceEntity','INTERNAL_SERVER_ERROR','../fanyi/fanyi.service','Repository','变换当前图片失败','badwordsService','get','BAD_REQUEST','axios:\x20','绘制图片任务结束\x20队列-1:\x20','pollForVariationResult','pollForUpscaleResult','\x20请求过于频繁！','queueCount','http://172.247.48.137:8000/mj/list?channel_id=','getMjDefaultParams','绘制图片任务异常中断\x20队列-1:\x20','\x20队列+1:\x20','放大图片任务结束\x20队列-1:\x20','stringify','10ADyZii','2104384NHqaeM','user','mjAuthorization','max','mjGuildId','当前提示词已经在任务队列中了、请勿重复提交。。。','mjChannelId','object','uploadService','mjApplicationId','length','../badwords/badwords.service','map','变化图片任务异常中断\x20队列-1:\x20','本次放大图片的id:\x20','removeEmoji','UploadService','draw','9856125OlaRVI','findCurrentPromptResult','绘画超时，请稍后再试！','绘图指令完成','https://discord.com/api/v9/channels/','/messages?limit=50'];_0x7686=function(){return _0x397ee6;};return _0x7686();}MjService=__decorate([(0x0,common_1[_0x45af72(0x155)])(),__param(0x0,(0x0,typeorm_2[_0x45af72(0x17d)])(chatLog_entity_1[_0x45af72(0x149)])),__param(0x1,(0x0,typeorm_2[_0x45af72(0x17d)])(balance_entity_1[_0x45af72(0xe9)])),__metadata('design:paramtypes',[typeorm_1[_0x45af72(0xec)],typeorm_1[_0x45af72(0xec)],upload_service_1[_0x45af72(0x10e)],chatLog_service_1['ChatLogService'],globalConfig_service_1[_0x45af72(0x14d)],fanyi_service_1[_0x45af72(0xe4)],badwords_service_1[_0x45af72(0x144)]])],MjService),exports[_0x45af72(0x140)]=MjService;