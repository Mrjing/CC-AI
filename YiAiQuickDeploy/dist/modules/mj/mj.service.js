'use strict';const _0x2c2734=_0x1643;function _0x1643(_0x32a4c3,_0x5454aa){const _0x4067ed=_0x4067();return _0x1643=function(_0x16430a,_0x36f7e0){_0x16430a=_0x16430a-0xaf;let _0x20df01=_0x4067ed[_0x16430a];return _0x20df01;},_0x1643(_0x32a4c3,_0x5454aa);}(function(_0x2903da,_0x1437c4){const _0x102058=_0x1643,_0x5d7fc0=_0x2903da();while(!![]){try{const _0x1f0e5e=-parseInt(_0x102058(0xc9))/0x1+parseInt(_0x102058(0xf5))/0x2+parseInt(_0x102058(0xe7))/0x3+parseInt(_0x102058(0x103))/0x4*(parseInt(_0x102058(0xdd))/0x5)+parseInt(_0x102058(0xdc))/0x6+parseInt(_0x102058(0xdb))/0x7*(parseInt(_0x102058(0xb0))/0x8)+-parseInt(_0x102058(0xb8))/0x9;if(_0x1f0e5e===_0x1437c4)break;else _0x5d7fc0['push'](_0x5d7fc0['shift']());}catch(_0x2c2ca4){_0x5d7fc0['push'](_0x5d7fc0['shift']());}}}(_0x4067,0x1bf3a));var __decorate=this&&this['__decorate']||function(_0x1f73e4,_0x539141,_0x302992,_0x3fb032){const _0x5d1dda=_0x1643;var _0x3daf54=arguments['length'],_0x1d96d0=_0x3daf54<0x3?_0x539141:_0x3fb032===null?_0x3fb032=Object[_0x5d1dda(0x124)](_0x539141,_0x302992):_0x3fb032,_0x5f54b0;if(typeof Reflect===_0x5d1dda(0xce)&&typeof Reflect['decorate']===_0x5d1dda(0x127))_0x1d96d0=Reflect['decorate'](_0x1f73e4,_0x539141,_0x302992,_0x3fb032);else{for(var _0x819a5f=_0x1f73e4[_0x5d1dda(0x102)]-0x1;_0x819a5f>=0x0;_0x819a5f--)if(_0x5f54b0=_0x1f73e4[_0x819a5f])_0x1d96d0=(_0x3daf54<0x3?_0x5f54b0(_0x1d96d0):_0x3daf54>0x3?_0x5f54b0(_0x539141,_0x302992,_0x1d96d0):_0x5f54b0(_0x539141,_0x302992))||_0x1d96d0;}return _0x3daf54>0x3&&_0x1d96d0&&Object[_0x5d1dda(0xb2)](_0x539141,_0x302992,_0x1d96d0),_0x1d96d0;},__metadata=this&&this[_0x2c2734(0x137)]||function(_0xb22ff9,_0x482a6d){const _0x5caa16=_0x2c2734;if(typeof Reflect===_0x5caa16(0xce)&&typeof Reflect[_0x5caa16(0xbd)]==='function')return Reflect['metadata'](_0xb22ff9,_0x482a6d);},__param=this&&this[_0x2c2734(0x13c)]||function(_0x1a70fb,_0x4515e6){return function(_0x4d00e6,_0x5a89e3){_0x4515e6(_0x4d00e6,_0x5a89e3,_0x1a70fb);};};Object[_0x2c2734(0xb2)](exports,'__esModule',{'value':!![]}),exports[_0x2c2734(0xcb)]=void 0x0;const globalConfig_service_1=require(_0x2c2734(0xd8)),upload_service_1=require(_0x2c2734(0x13d)),common_1=require('@nestjs/common'),axios_1=require(_0x2c2734(0xe4)),chatLog_service_1=require(_0x2c2734(0x126)),balance_constant_1=require(_0x2c2734(0x14e)),utils_1=require(_0x2c2734(0xc3)),chatLog_entity_1=require(_0x2c2734(0x13b)),typeorm_1=require('typeorm'),typeorm_2=require(_0x2c2734(0x161)),balance_entity_1=require(_0x2c2734(0xde)),fanyi_service_1=require(_0x2c2734(0xd5)),badwords_service_1=require(_0x2c2734(0x118));let MjService=class MjService{constructor(_0x4e74a0,_0x2e1f85,_0x4f520e,_0x171244,_0x15acdb,_0x230549,_0x51b014){const _0x517d88=_0x2c2734;this[_0x517d88(0xdf)]=_0x4e74a0,this[_0x517d88(0xea)]=_0x2e1f85,this[_0x517d88(0x13a)]=_0x4f520e,this['chatLogService']=_0x171244,this[_0x517d88(0x157)]=_0x15acdb,this[_0x517d88(0x12d)]=_0x230549,this[_0x517d88(0x119)]=_0x51b014,this['rateLimits']={},this[_0x517d88(0xb7)]=[],this[_0x517d88(0xf8)]=[],this[_0x517d88(0xf6)]=0x0,this[_0x517d88(0x123)]={};}async[_0x2c2734(0xfc)](_0x482ae4){const _0x275eda=_0x2c2734,{jobId:_0xc49b7c,prompt:_0x12e5a8,startTime:_0x8910b8,userId:_0xe26ac8}=_0x482ae4;return console[_0x275eda(0xf3)](_0x275eda(0xed),_0x275eda(0xf7)),await new Promise(_0x3c4b5f=>setTimeout(_0x3c4b5f,0x1388)),{'a':0x1,'b':0x2};}async['draw'](_0x37086d,_0x219967){const _0x2c7c19=_0x2c2734;await this[_0x2c7c19(0x152)](_0x219967),await this[_0x2c7c19(0x119)]['checkBadWords'](_0x37086d[_0x2c7c19(0x114)],_0x219967[_0x2c7c19(0xe6)]['id']);const _0x55f12c=_0x37086d[_0x2c7c19(0x114)];let _0x22b357=_0x37086d[_0x2c7c19(0x114)];const {baiduFanyiAppId:_0x536db6,baiduFanyiSecret:_0x324727}=await this['globalConfigService'][_0x2c7c19(0x154)]([_0x2c7c19(0x130),'baiduFanyiSecret']);_0x536db6&&_0x324727&&(_0x22b357=await this[_0x2c7c19(0x12d)][_0x2c7c19(0xe9)](_0x55f12c));const _0x2117eb='['+(0x0,utils_1[_0x2c7c19(0xd0)])()+']',_0xffa301=_0x2117eb+'\x20'+_0x22b357;console[_0x2c7c19(0xf3)](_0x2c7c19(0x113),_0x2117eb),console['log'](_0x2c7c19(0xbc),_0xffa301);const _0x1978f6=this[_0x2c7c19(0xb7)][_0x2c7c19(0xc6)](_0x6a46a5=>_0x6a46a5[_0x2c7c19(0xcd)](_0x37086d[_0x2c7c19(0x114)]));if(_0x1978f6)throw new common_1[(_0x2c7c19(0xfd))](_0x2c7c19(0x149),common_1['HttpStatus'][_0x2c7c19(0xc8)]);if(this[_0x2c7c19(0xf6)]>=0x3)throw new common_1[(_0x2c7c19(0xfd))](_0x2c7c19(0x117),common_1[_0x2c7c19(0x15c)][_0x2c7c19(0xc8)]);await this[_0x2c7c19(0xc7)](_0x219967),this['queueCount']++,console['log'](_0x2c7c19(0x12f)+_0x219967[_0x2c7c19(0xe6)]['id']+_0x2c7c19(0x14c),this[_0x2c7c19(0xf6)]);try{const _0x56f9d3=await this['chatLogEntity'][_0x2c7c19(0xc6)]({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0xffa301+'%')}}),_0x5e6b53=_0x56f9d3[_0x2c7c19(0xbb)](_0x15e48b=>_0x15e48b[_0x2c7c19(0x143)]);this[_0x2c7c19(0xb7)][_0x2c7c19(0xeb)](_0xffa301);let _0xe15a38;const _0x258e43=await this[_0x2c7c19(0x11e)](_0xffa301,_0x5e6b53,_0x2117eb);_0x258e43?(console[_0x2c7c19(0xf3)]('历史中存在当前图片、直接获取！'),_0xe15a38=_0x258e43):_0xe15a38=await this[_0x2c7c19(0xe8)](_0xffa301,_0x5e6b53,_0x2117eb);this['queueCount']--,this[_0x2c7c19(0xf6)]<0x0&&(this[_0x2c7c19(0xf6)]=0x0),console['log'](_0x2c7c19(0x12b),this[_0x2c7c19(0xf6)]);const {id:_0x1a0969,content:_0x10b65d,channel_id:_0x40d088,attachments:attachments=[],timestamp:_0x459ea3}=_0xe15a38;if(!attachments['length']||!attachments[0x0][_0x2c7c19(0x13e)])throw new common_1[(_0x2c7c19(0xfd))]('绘画失败',common_1[_0x2c7c19(0x15c)][_0x2c7c19(0xc8)]);const {filename:_0x5e0682,url:_0x406076,width:_0x274865,height:_0x127b85,size:_0x55fef0}=attachments[0x0];console[_0x2c7c19(0xf3)]('拿到了远程地址:\x20',_0x406076);const _0x4738e5=this[_0x2c7c19(0x157)][_0x2c7c19(0x154)]([_0x2c7c19(0xb9)]);let _0x5a6902='';(!Number(_0x4738e5)||Number(_0x4738e5)===0x0)&&(_0x5a6902=await this[_0x2c7c19(0x13a)][_0x2c7c19(0x101)]({'filename':_0x5e0682,'url':_0x406076}),console[_0x2c7c19(0xf3)](_0x2c7c19(0xf1),_0x5a6902));const _0x18f00a={'curIp':(0x0,utils_1[_0x2c7c19(0x12c)])(_0x219967),'userId':_0x219967[_0x2c7c19(0xe6)]['id'],'type':balance_constant_1['DeductionKey'][_0x2c7c19(0x156)],'prompt':_0xffa301,'answer':_0x5a6902,'model':'mj','extend':this['removeEmoji'](JSON[_0x2c7c19(0x140)](_0xe15a38)),'message_id':_0x1a0969,'variationId':_0x1a0969,'upscaleId':_0x1a0969,'group':0x1,'isSaveImg':!Number(_0x4738e5)||Number(_0x4738e5)===0x0,'fileInfo':JSON[_0x2c7c19(0x140)]({'width':_0x274865,'height':_0x127b85,'size':_0x55fef0,'filename':_0x5e0682,'cosUrl':_0x5a6902})};return await this[_0x2c7c19(0xbf)][_0x2c7c19(0x132)](_0x18f00a),await this[_0x2c7c19(0xc2)](_0x219967),this['drawWorking']=this[_0x2c7c19(0xb7)][_0x2c7c19(0xc0)](_0x337d9a=>_0x337d9a!==_0x37086d[_0x2c7c19(0x114)]),_0x5a6902;}catch(_0xc97fe6){this[_0x2c7c19(0xf6)]--,this[_0x2c7c19(0xf6)]<0x0&&(this['queueCount']=0x0),console[_0x2c7c19(0xf3)](_0x2c7c19(0x160),this['queueCount']),this['drawWorking']=this['drawWorking'][_0x2c7c19(0xc0)](_0x1baf73=>_0x1baf73!==_0x37086d[_0x2c7c19(0x114)]);throw new common_1[(_0x2c7c19(0xfd))](_0xc97fe6[_0x2c7c19(0x105)],common_1[_0x2c7c19(0x15c)][_0x2c7c19(0xc8)]);}}async[_0x2c2734(0xcc)](_0x1f4ba8,_0x1933dc){const _0x75ff58=_0x2c2734;if(this[_0x75ff58(0xf6)]>=0x3)throw new common_1[(_0x75ff58(0xfd))](_0x75ff58(0x117),common_1[_0x75ff58(0x15c)][_0x75ff58(0xc8)]);this[_0x75ff58(0xf6)]++,console[_0x75ff58(0xf3)]('用户'+_0x1933dc[_0x75ff58(0xe6)]['id']+_0x75ff58(0x147),this[_0x75ff58(0xf6)]);const {message_id:_0x4facb4,orderId:_0x44ab0d}=_0x1f4ba8;try{const _0x564ab0=await this[_0x75ff58(0xdf)]['findOne']({'where':{'message_id':_0x4facb4}});if(!_0x564ab0)throw new common_1['HttpException'](_0x75ff58(0x116),common_1['HttpStatus']['BAD_REQUEST']);const _0xb20bf9=await this['chatLogEntity'][_0x75ff58(0x164)]({'where':{'upscaleId':_0x4facb4,'action':'enlarge','orderId':_0x44ab0d}});if(_0xb20bf9)throw new common_1[(_0x75ff58(0xfd))]('当前图片已经放大过了、请勿重复放大!',common_1[_0x75ff58(0x15c)][_0x75ff58(0xc8)]);const {prompt:_0xad0804,extend:_0x61a317}=_0x564ab0;let _0x36c852=null;try{_0x36c852=JSON['parse'](_0x61a317);}catch(_0x3e353a){_0x36c852=[];}const {components:components=[]}=_0x36c852;if(!components['length'])throw new common_1[(_0x75ff58(0xfd))](_0x75ff58(0x109),common_1[_0x75ff58(0x15c)]['BAD_REQUEST']);const _0xf21f79=components[0x0][_0x75ff58(0x163)][_0x44ab0d-0x1],{custom_id:_0x2bd9ba}=_0xf21f79;console[_0x75ff58(0xf3)](_0x75ff58(0xaf),_0x2bd9ba);const _0x19a355={'message_id':_0x4facb4,'custom_id':_0x2bd9ba,'prompt':_0xad0804,'orderId':_0x44ab0d};await this[_0x75ff58(0x12a)](_0x19a355),console[_0x75ff58(0xf3)](_0x75ff58(0x106));const _0x5b310e=await this[_0x75ff58(0xdf)][_0x75ff58(0xc6)]({'where':{'prompt':(0x0,typeorm_1[_0x75ff58(0xec)])('%'+_0xad0804+'%')}}),_0x334b46=_0x5b310e[_0x75ff58(0xbb)](_0x400302=>_0x400302[_0x75ff58(0x143)]);console[_0x75ff58(0xf3)](_0x75ff58(0x15a),_0x334b46);const _0xa612c8=await this[_0x75ff58(0xe5)](_0x19a355,_0x334b46);this[_0x75ff58(0xf6)]--,this[_0x75ff58(0xf6)]<0x0&&(this[_0x75ff58(0xf6)]=0x0),console[_0x75ff58(0xf3)](_0x75ff58(0xd9),this[_0x75ff58(0xf6)]);const {id:_0x1078c0,content:_0x2c56f3,channel_id:_0x2e3cfc,attachments:attachments=[],timestamp:_0x933805}=_0xa612c8;if(!attachments[_0x75ff58(0x102)]||!attachments[0x0][_0x75ff58(0x13e)])throw new common_1['HttpException'](_0x75ff58(0xef),common_1['HttpStatus']['BAD_REQUEST']);const {filename:_0x8a82f9,url:_0x124f7c,width:_0x1f5e7f,height:_0x5255d8,size:_0x251f3a}=attachments[0x0],_0x37f6c6=this[_0x75ff58(0x157)]['getConfigs']([_0x75ff58(0xb9)]);let _0x561150='';(!Number(_0x37f6c6)||Number(_0x37f6c6)===0x0)&&(_0x561150=await this[_0x75ff58(0x13a)][_0x75ff58(0x101)]({'filename':_0x8a82f9,'url':_0x124f7c}),console[_0x75ff58(0xf3)](_0x75ff58(0xf1),_0x561150));const _0x31f148={'curIp':(0x0,utils_1[_0x75ff58(0x12c)])(_0x1933dc),'userId':_0x1933dc[_0x75ff58(0xe6)]['id'],'type':balance_constant_1[_0x75ff58(0xda)][_0x75ff58(0x156)],'prompt':_0xad0804,'answer':_0x561150,'model':'mj','extend':this[_0x75ff58(0x131)](JSON[_0x75ff58(0x140)](_0xa612c8)),'message_id':_0x4facb4,'upscaleId':_0x1078c0,'variationId':_0x1078c0,'action':'enlarge','orderId':_0x19a355['orderId'],'isSaveImg':!Number(_0x37f6c6)||Number(_0x37f6c6)===0x0,'fileInfo':JSON[_0x75ff58(0x140)]({'width':_0x1f5e7f,'height':_0x5255d8,'size':_0x251f3a,'filename':_0x8a82f9,'cosUrl':_0x561150})};return await this['chatLogService']['saveChatLog'](_0x31f148),_0x561150;}catch(_0x478200){console['log'](_0x75ff58(0x15f),_0x478200),this[_0x75ff58(0xf6)]--,this[_0x75ff58(0xf6)]<0x0&&(this[_0x75ff58(0xf6)]=0x0),console[_0x75ff58(0xf3)](_0x75ff58(0xca),this[_0x75ff58(0xf6)]);throw new common_1[(_0x75ff58(0xfd))](_0x478200['response'],common_1[_0x75ff58(0x15c)][_0x75ff58(0xc8)]);}}async['variationSingleImg'](_0x14e741,_0x2e039c){const _0x4346d7=_0x2c2734;if(this[_0x4346d7(0xf6)]>=0x3)throw new common_1[(_0x4346d7(0xfd))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x4346d7(0x15c)][_0x4346d7(0xc8)]);await this[_0x4346d7(0x152)](_0x2e039c),await this[_0x4346d7(0xc7)](_0x2e039c),this['queueCount']++,console[_0x4346d7(0xf3)]('用户'+_0x2e039c[_0x4346d7(0xe6)]['id']+'开始请求变换图片\x20队列+1:\x20',this[_0x4346d7(0xf6)]);const {message_id:_0x3a36f1,orderId:_0x91a045}=_0x14e741;try{const _0x3f3d1b=await this[_0x4346d7(0xdf)][_0x4346d7(0x164)]({'where':{'message_id':_0x3a36f1}});if(!_0x3f3d1b)throw new common_1[(_0x4346d7(0xfd))](_0x4346d7(0x120),common_1[_0x4346d7(0x15c)][_0x4346d7(0xc8)]);const {prompt:_0x25ed07,extend:_0x2f8257}=_0x3f3d1b;let _0x48cab1=null;try{_0x48cab1=JSON[_0x4346d7(0x112)](_0x2f8257);}catch(_0x17f98c){_0x48cab1=[];}const {components:components=[]}=_0x48cab1;if(!components['length'])throw new common_1['HttpException']('当前图片没有绘画信息、无法变体!',common_1['HttpStatus'][_0x4346d7(0xc8)]);const _0x5ed930=components[0x1][_0x4346d7(0x163)][_0x91a045-0x1],{custom_id:_0x121fd1}=_0x5ed930,_0x5217e1=await this['chatLogEntity'][_0x4346d7(0xc6)]({'where':{'variationId':(0x0,typeorm_1[_0x4346d7(0x115)])((0x0,typeorm_1[_0x4346d7(0xd4)])()),'prompt':(0x0,typeorm_1[_0x4346d7(0xec)])('%'+_0x25ed07+'%')}}),_0x2875ac=_0x5217e1[_0x4346d7(0xbb)](_0x45166c=>_0x45166c[_0x4346d7(0x11f)]),_0x4a7202={'message_id':_0x3a36f1,'custom_id':_0x121fd1,'prompt':_0x25ed07,'orderId':_0x91a045};await this[_0x4346d7(0x12a)](_0x4a7202);const _0x56fdf2=await this[_0x4346d7(0x146)](_0x4a7202,_0x2875ac);this['queueCount']--,this[_0x4346d7(0xf6)]<0x0&&(this['queueCount']=0x0),console[_0x4346d7(0xf3)](_0x4346d7(0x155),this['queueCount']);const {id:_0x51e908,content:_0x25195e,channel_id:_0x5a178e,attachments:attachments=[],timestamp:_0x45b274}=_0x56fdf2;if(!attachments[_0x4346d7(0x102)]||!attachments[0x0]['url'])throw new common_1['HttpException'](_0x4346d7(0xe3),common_1[_0x4346d7(0x15c)][_0x4346d7(0xc8)]);const {filename:_0x3f0ddc,url:_0x107dc2,width:_0x18a2ae,height:_0x19f57b,size:_0x20691d}=attachments[0x0],_0x18ee6d=this['globalConfigService'][_0x4346d7(0x154)](['mjNotSaveImg']);let _0x3e0316='';(!Number(_0x18ee6d)||Number(_0x18ee6d)===0x0)&&(_0x3e0316=await this[_0x4346d7(0x13a)]['uploadFileFromUrl']({'filename':_0x3f0ddc,'url':_0x107dc2}),console[_0x4346d7(0xf3)](_0x4346d7(0xf1),_0x3e0316));const _0x401f6d={'curIp':(0x0,utils_1[_0x4346d7(0x12c)])(_0x2e039c),'userId':_0x2e039c[_0x4346d7(0xe6)]['id'],'type':balance_constant_1[_0x4346d7(0xda)]['PAINT_TYPE'],'prompt':_0x25ed07,'answer':_0x3e0316,'model':'mj','group':0x1,'extend':this[_0x4346d7(0x131)](JSON[_0x4346d7(0x140)](_0x56fdf2)),'message_id':_0x51e908,'upscaleId':_0x51e908,'variationId':_0x51e908,'action':_0x4346d7(0xb1),'orderId':_0x4a7202['orderId'],'isSaveImg':!Number(_0x18ee6d)||Number(_0x18ee6d)===0x0,'fileInfo':JSON[_0x4346d7(0x140)]({'width':_0x18a2ae,'height':_0x19f57b,'size':_0x20691d,'filename':_0x3f0ddc,'cosUrl':_0x3e0316})};return await this[_0x4346d7(0xbf)][_0x4346d7(0x132)](_0x401f6d),_0x3e0316;}catch(_0x5e73bd){console['log'](_0x4346d7(0x15f),_0x5e73bd),this[_0x4346d7(0xf6)]--,this[_0x4346d7(0xf6)]<0x0&&(this[_0x4346d7(0xf6)]=0x0),console[_0x4346d7(0xf3)](_0x4346d7(0x15b),this[_0x4346d7(0xf6)]);throw new common_1[(_0x4346d7(0xfd))](_0x5e73bd['response'],common_1[_0x4346d7(0x15c)][_0x4346d7(0xc8)]);}}async[_0x2c2734(0x12a)](_0x1566fb){const _0x316bcc=_0x2c2734,{message_id:_0x4aecda,custom_id:_0x4d4c2d}=_0x1566fb,{application_id:_0x240575,guild_id:_0x218068,channel_id:_0x3c54d6,session_id:_0x4d010b,version:_0x315634,id:_0x4a62bb,authorization:_0x4ce5ac,mjProxy:_0x341fcf}=await this['getMjDefaultParams'](),_0x39e077=_0x341fcf==0x1?'http://172.247.48.137:8000/mj/draw':_0x316bcc(0xd6),_0x4a2188={'authorization':_0x4ce5ac},_0x42968e={'type':0x3,'guild_id':_0x218068,'channel_id':_0x3c54d6,'message_flags':0x0,'message_id':_0x4aecda,'application_id':_0x240575,'session_id':_0x4d010b,'data':{'component_type':0x2,'custom_id':_0x4d4c2d}};try{await axios_1[_0x316bcc(0xb6)][_0x316bcc(0xc4)](_0x39e077,_0x42968e,{'headers':_0x4a2188}),console[_0x316bcc(0xf3)]('绘图指令完成');}catch(_0x169261){console[_0x316bcc(0xf3)](_0x316bcc(0x15f),_0x169261);throw new common_1[(_0x316bcc(0xfd))](_0x316bcc(0xd3),common_1[_0x316bcc(0x15c)][_0x316bcc(0xc8)]);}}async[_0x2c2734(0xe5)](_0x27d874,_0x18a205){const _0x539323=_0x2c2734,{message_id:_0x2164ce,custom_id:_0x29d2a8,prompt:_0x236fdb,orderId:_0x1b259f}=_0x27d874;let _0x59baff=null,_0x57e635=0x0;while(!_0x59baff&&_0x57e635<0xa){try{const _0x30d76a=Date[_0x539323(0x142)](),_0x2c018b=await this[_0x539323(0x162)]();console[_0x539323(0xf3)]('第\x20'+(_0x57e635+0x1)+_0x539323(0x100)+_0x2c018b[_0x539323(0x102)]);_0x2c018b&&_0x2c018b[_0x539323(0x102)]&&(_0x59baff=await this[_0x539323(0x144)](_0x2c018b,_0x27d874,_0x18a205));const _0x1efdc2=Date[_0x539323(0x142)]()-_0x30d76a,_0x5ee0df=0xbb8;await this[_0x539323(0x14b)](Math[_0x539323(0x153)](_0x5ee0df-_0x1efdc2,0x0)),_0x57e635++;}catch(_0x275579){console[_0x539323(0xb5)](_0x539323(0x121)+_0x275579['message']);}}return _0x59baff;}async[_0x2c2734(0x146)](_0x229e3c,_0x3e1f0b){const _0x522632=_0x2c2734,{message_id:_0x5037c8,custom_id:_0x412c3a,prompt:_0x3f98b9,orderId:_0xfcbfac}=_0x229e3c;console[_0x522632(0xf3)](_0x522632(0xb4));let _0x292c21=null,_0x1b1e1e=0x0;while(!_0x292c21&&_0x1b1e1e<0xa){try{console[_0x522632(0xf3)]('第\x20'+(_0x1b1e1e+0x1)+_0x522632(0x150));const _0x471172=Date['now'](),_0x1b758e=await this['queryMessageList']();_0x1b758e&&_0x1b758e[_0x522632(0x102)]&&(_0x292c21=await this['findCurrentVariationImgResult'](_0x1b758e,_0x229e3c,_0x3e1f0b));const _0x34f129=Date[_0x522632(0x142)]()-_0x471172,_0x3baa78=0x1f40;await this[_0x522632(0x14b)](Math['max'](_0x3baa78-_0x34f129,0x0)),_0x1b1e1e++;}catch(_0x2becea){console[_0x522632(0xb5)](_0x522632(0x121)+_0x2becea[_0x522632(0x10e)]);}}if(!_0x292c21)throw new common_1[(_0x522632(0xfd))](_0x522632(0x122),common_1[_0x522632(0x15c)][_0x522632(0xc8)]);return _0x292c21;}async[_0x2c2734(0x144)](_0x51bc31,_0x35190d,_0x156648){const _0x4d3aae=_0x2c2734,{message_id:_0x5f009b,custom_id:_0x31b4f8,prompt:_0x18bbb5,orderId:_0x3fada0}=_0x35190d,_0x33ea46=_0x18bbb5[_0x4d3aae(0xd2)](0x0,0xc);console['log'](_0x4d3aae(0x138),_0x33ea46);const _0x2f4547=_0x51bc31['find'](_0x248b07=>{const _0x118d4c=_0x4d3aae,{content:_0x86447}=_0x248b07;if(!this[_0x118d4c(0x14a)](_0x86447))return![];const {prompt:_0x2aed01,order:_0x11135d}=this[_0x118d4c(0x14a)](_0x86447);return _0x2aed01[_0x118d4c(0xcd)](_0x33ea46)&&_0x35190d['orderId']===_0x11135d&&!_0x156648[_0x118d4c(0xcd)](_0x248b07['id']);});return _0x2f4547;}async[_0x2c2734(0x134)](_0xa3874a,_0x294946,_0x13dba6){const _0x5e1b28=_0x2c2734,{message_id:_0x369f8b,custom_id:_0x38618f,prompt:_0x59fc90,orderId:_0x4ead1e}=_0x294946,_0x325103=_0x59fc90['substring'](0x0,0xc),_0x2788a3=_0xa3874a[_0x5e1b28(0xc6)](_0x22f265=>{const _0x29e9a4=_0x5e1b28,{content:_0x4d3604}=_0x22f265,_0x16b6bb=_0x4d3604[_0x29e9a4(0x14f)](/\*\*(.+?)\*\*/),_0x4ed75c=_0x16b6bb?_0x16b6bb[0x1]:'';if(!_0x4ed75c)return![];return _0x4ed75c[_0x29e9a4(0xcd)](_0x325103)&&!_0x13dba6[_0x29e9a4(0xcd)](_0x22f265['id']);});return _0x2788a3;}async['sendDrawInteractions'](_0x506155,_0xe7ed29,_0x21c389){const _0x537df5=_0x2c2734,_0x1ab1e7=await this[_0x537df5(0x162)](),_0xd9aa34=await this[_0x537df5(0x12e)](_0x1ab1e7,_0x21c389,_0xe7ed29);if(_0xd9aa34)return console[_0x537df5(0xf3)]('有历史信息之间返回:\x20',_0xd9aa34),_0xd9aa34;const {application_id:_0x4d08d8,guild_id:_0x75c9fe,channel_id:_0x35f1c2,session_id:_0x3a6539,version:_0x52bb90,id:_0x819d5d,authorization:_0x530d0f,mjProxy:_0x23406a}=await this[_0x537df5(0xc5)](),_0x4d1661={'type':0x2,'application_id':_0x4d08d8,'guild_id':_0x75c9fe,'channel_id':_0x35f1c2,'session_id':_0x3a6539,'data':{'version':_0x52bb90,'id':_0x819d5d,'name':_0x537df5(0x133),'type':0x1,'options':[{'type':0x3,'name':_0x537df5(0x114),'value':_0x506155}],'attachments':[]}};try{const _0x133951=_0x23406a==0x1?_0x537df5(0x10a):_0x537df5(0xd6),_0x34a7b4={'authorization':_0x530d0f},_0x19f105=await axios_1['default'][_0x537df5(0xc4)](_0x133951,_0x4d1661,{'headers':_0x34a7b4});return console[_0x537df5(0xf3)]('发送绘画指令结果:\x20',_0x19f105[_0x537df5(0x141)]),![];}catch(_0x481412){console[_0x537df5(0xf3)](_0x537df5(0x128),_0x481412);throw new common_1[(_0x537df5(0xfd))](_0x537df5(0x14d),common_1[_0x537df5(0x15c)]['BAD_REQUEST']);}}async['pollForResult'](_0x4ab06e,_0x53aa99,_0x269d9e){const _0x2497c0=_0x2c2734;console[_0x2497c0(0xf3)](_0x2497c0(0xfb));const _0x180a52=Date[_0x2497c0(0x142)]();try{const _0x53fdb3=0xd,_0x405a84=0x2ee0,_0xc0e41b=0x1388,_0x4b067e=0x3c*0x3e8;let _0x1c065f=0x0,_0x3a2678=![],_0x11df39=null;while(!_0x11df39&&_0x1c065f<_0x53fdb3){console['log']('第\x20'+(_0x1c065f+0x1)+'\x20次开始查询');Date[_0x2497c0(0x142)]()-_0x180a52>=_0x4b067e&&(_0x3a2678=!![]);await this[_0x2497c0(0x14b)](_0x3a2678?_0xc0e41b:_0x405a84);const _0x16f3e6=await this['queryMessageList']();_0x11df39=await this['findCurrentPromptResult'](_0x16f3e6,_0x269d9e,_0x53aa99),_0x1c065f++;}if(!_0x11df39)throw new common_1[(_0x2497c0(0xfd))](_0x2497c0(0x145),common_1[_0x2497c0(0x15c)][_0x2497c0(0xc8)]);const _0x2027c7=Date[_0x2497c0(0x142)]();return console[_0x2497c0(0xf3)]('本次绘图耗时:\x20'+Math[_0x2497c0(0x15d)]((_0x2027c7-_0x180a52)/0x3e8)+'\x20S'),_0x11df39;}catch(_0x4b268e){console[_0x2497c0(0xb5)](_0x4b268e['message']);throw new common_1['HttpException'](_0x2497c0(0xff),common_1[_0x2497c0(0x15c)][_0x2497c0(0x104)]);}}async[_0x2c2734(0x12e)](_0x30153d,_0x116ee2,_0x4b55f4){const _0x184f07=_0x2c2734;if(!_0x30153d||!_0x30153d['length'])return;console[_0x184f07(0xf3)](_0x184f07(0x10c),_0x116ee2);const _0x96bdfd=_0x30153d[_0x184f07(0xc6)](_0xc17eb9=>{const _0x112a4a=_0x184f07,{attachments:attachments=[],content:_0x35e08c,edited_timestamp:_0x139957}=_0xc17eb9;return _0x35e08c[_0x112a4a(0xcd)](_0x116ee2)&&attachments[_0x112a4a(0x102)]>0x0&&!_0x139957&&!_0x4b55f4[_0x112a4a(0xcd)](_0xc17eb9['id']);});return _0x96bdfd||null;}async[_0x2c2734(0x162)](){const _0x2eda1e=_0x2c2734;try{const {application_id:_0x28cb46,guild_id:_0x4c376d,channel_id:_0x4e7359,session_id:_0x33fd83,version:_0x2c6d04,id:_0x587264,authorization:_0x24d5de,mjProxy:_0x556bbb}=await this[_0x2eda1e(0xc5)](),_0x560e46=_0x556bbb==0x1?'http://172.247.48.137:8000/mj/list?channel_id='+_0x4e7359:_0x2eda1e(0xcf)+_0x4e7359+_0x2eda1e(0xe0),_0x53bbc3={'authorization':_0x24d5de},_0x526d3f=await axios_1[_0x2eda1e(0xb6)]['get'](_0x560e46,{'headers':_0x53bbc3});return _0x526d3f[_0x2eda1e(0x141)];}catch(_0x250365){console['log'](_0x2eda1e(0xf2),_0x250365);throw new common_1[(_0x2eda1e(0xfd))]('查询绘制结果失败...',common_1['HttpStatus'][_0x2eda1e(0xc8)]);}}async[_0x2c2734(0x14b)](_0x20ce5d){return new Promise(_0x24ef29=>setTimeout(_0x24ef29,_0x20ce5d));}[_0x2c2734(0x14a)](_0x3bdab7){const _0x38e956=_0x2c2734,_0x22c100=_0x3bdab7[_0x38e956(0x14f)](/\*\*(.+?)\*\*/),_0x1e70af=_0x3bdab7[_0x38e956(0x14f)](/- Image #(\d+)/);if(!_0x22c100||!_0x1e70af)return null;const _0x443a86=_0x22c100[0x1],_0x52ba1b=parseInt(_0x1e70af[0x1]);return{'prompt':_0x443a86,'order':_0x52ba1b};}async[_0x2c2734(0xc5)](){const _0x580023=_0x2c2734,_0x3455c0=await this[_0x580023(0x157)][_0x580023(0x154)]([_0x580023(0xb3),_0x580023(0x129),_0x580023(0x13f),_0x580023(0x139),'mjSessionId',_0x580023(0x148),_0x580023(0xbe),'mjRateLimit',_0x580023(0x159)]),_0x18fef0={'application_id':_0x3455c0[_0x580023(0x129)],'guild_id':_0x3455c0[_0x580023(0x13f)],'channel_id':_0x3455c0['mjChannelId'],'session_id':_0x3455c0[_0x580023(0x10b)],'version':_0x3455c0[_0x580023(0x148)],'id':_0x3455c0['mjId'],'authorization':_0x3455c0[_0x580023(0xbe)],'mjRateLimit':_0x3455c0[_0x580023(0xd1)],'mjProxy':_0x3455c0['mjProxy']||0x0};return _0x18fef0;}[_0x2c2734(0x131)](_0x40eb91){const _0x5a2180=_0x2c2734,_0x2ba6e9=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x40eb91[_0x5a2180(0x11a)](_0x2ba6e9,'');}async[_0x2c2734(0x152)](_0x2dceae){const _0x4c8eaa=_0x2c2734,_0x1e988e=await this['balanceEntity']['findOne']({'where':{'userId':_0x2dceae['user']['id']}}),{id:_0x38515b,balance:_0x2fdf0d}=_0x1e988e;if(!_0x2fdf0d||(_0x1e988e===null||_0x1e988e===void 0x0?void 0x0:_0x1e988e[_0x4c8eaa(0xe1)])<0x1)throw new common_1[(_0x4c8eaa(0xfd))]('您当前暂无MJ绘画余额！！！',common_1[_0x4c8eaa(0x15c)]['BAD_REQUEST']);}async[_0x2c2734(0x110)](_0x2cb8d0){const _0x2ec1be=_0x2c2734,{id:_0x370145,role:_0x3604e6}=_0x2cb8d0['user'];!this[_0x2ec1be(0x123)][_0x370145]?this[_0x2ec1be(0x123)][_0x370145]=0x1:this['freeQueueUsers'][_0x370145]=this[_0x2ec1be(0x123)][_0x370145]+0x1,console[_0x2ec1be(0xf3)](_0x2ec1be(0x15e)+_0x370145+_0x2ec1be(0x10d),this[_0x2ec1be(0x123)][_0x370145]);}async['checkRateLimit'](_0x6764d3){const _0x3eac29=_0x2c2734,{id:_0x22a723,role:_0x4735dc}=_0x6764d3[_0x3eac29(0xe6)];if([_0x3eac29(0xf0),_0x3eac29(0x11b)][_0x3eac29(0xcd)](_0x4735dc))return!![];const {mjRateLimit:_0x14048d}=await this[_0x3eac29(0xc5)]();if(this[_0x3eac29(0xd7)][_0x22a723]){const _0x12cfa3=this[_0x3eac29(0xd7)][_0x22a723];if(_0x12cfa3>Date['now']()){console[_0x3eac29(0xf3)](_0x3eac29(0xfa)+_0x22a723+_0x3eac29(0x11d));throw new common_1['HttpException'](_0x3eac29(0x11c)+_0x14048d+'秒请求一次、请合理使用！',common_1['HttpStatus']['BAD_REQUEST']);}else this[_0x3eac29(0xd7)][_0x22a723]=Date[_0x3eac29(0x142)]()+Number(_0x14048d)*0x3e8;}else{const _0x4f5847=Date[_0x3eac29(0x142)]();this['rateLimits'][_0x22a723]=_0x4f5847+0x3e8*Number(_0x14048d);}}async[_0x2c2734(0xc2)](_0x36c037){const _0x4fcc89=_0x2c2734;await this['balanceEntity'][_0x4fcc89(0x107)]()['update'](balance_entity_1[_0x4fcc89(0x125)])[_0x4fcc89(0xe2)]({'balance':()=>_0x4fcc89(0xee)})[_0x4fcc89(0xfe)](_0x4fcc89(0xc1),{'userId':_0x36c037['user']['id']})[_0x4fcc89(0x135)]();}async[_0x2c2734(0x151)](){return 0x1;}};function _0x4067(){const _0x4d0043=['@nestjs/typeorm','queryMessageList','components','findOne','放大custom_id:\x20','10424ijXmEt','enlarge','defineProperty','mjId','开始轮询单张变换图片结果','error','default','drawWorking','174447vFKVMQ','mjNotSaveImg','FanyiService','map','prompt\x20-------->\x20\x20','metadata','mjAuthorization','chatLogService','filter','userId\x20=\x20:userId','deductBalance','../../common/utils','post','getMjDefaultParams','find','checkRateLimit','BAD_REQUEST','147464wHoEVd','放大图片任务异常中断\x20队列-1:\x20','MjService','upscaleSingleImg','includes','object','https://discord.com/api/v9/channels/','createRandomUid','mjRateLimit','substring','放大单张图片请求失败...','IsNull','../fanyi/fanyi.service','https://discord.com/api/v9/interactions','rateLimits','../globalConfig/globalConfig.service','放大图片任务结束\x20队列-1:\x20','DeductionKey','91nadFnK','746292wCuCGp','5hVODwX','../userBalance/balance.entity','chatLogEntity','/messages?limit=50','balance','set','变换当前图片失败','axios','pollForUpscaleResult','user','355065bjstzS','pollForResult','convertToEnglish','balanceEntity','push','Like','绘画任务开始','balance\x20-\x201','放大当前图片失败','admin','存入图片完成:\x20','axios\x20get:\x20','log','design:paramtypes','31756sTrrOg','queueCount','mjservice','enlargeWorking','ChatLogEntity','当前用户\x20','开始查询绘画结果轮询','mjDraw','HttpException','where','网络连接失败，请稍后再试！','\x20次开始查询\x20=>\x20当前查询结果：','uploadFileFromUrl','length','23132PsstcC','INTERNAL_SERVER_ERROR','response','发送放大指令成功','createQueryBuilder','ChatLogService','当前图片没有绘画信息、无法放大!','http://172.247.48.137:8000/mj/draw','mjSessionId','本次比对的随机ID:\x20','使用的次数：','message','GlobalConfigService','checkFree','BadwordsService','parse','randomId:\x20','prompt','Not','历史记录中不存在当前图片、请确认您放大的图片是否存在','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','../badwords/badwords.service','badwordsService','replace','super','由于速率限制、当前普通用户限制为','\x20请求过于频繁！','sendDrawInteractions','variationId','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','查询期间出现错误：','变换当前图片超时！','freeQueueUsers','getOwnPropertyDescriptor','BalanceEntity','../chatLog/chatLog.service','function','axios:\x20','mjApplicationId','sendSmInteractions','绘制图片任务结束\x20队列-1:\x20','getClientIp','fanyiService','findCurrentPromptResult','开始请求用户','baiduFanyiAppId','removeEmoji','saveChatLog','imagine','findCurrentVariationImgResult','execute','Repository','__metadata','本次放大图片的id:\x20','mjChannelId','uploadService','../chatLog/chatLog.entity','__param','../upload/upload.service','url','mjGuildId','stringify','data','now','message_id','findCurrentEnlargeImgResult','绘画超时，请稍后再试！','pollForVariationResult','开始请求放大图片\x20队列+1:\x20','mjVersion','当前提示词已经在任务队列中了、请勿重复提交。。。','extractContent','sleep','\x20队列+1:\x20','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','../../common/constants/balance.constant','match','\x20次开始查询[变换图片]','test','checkAuth','max','getConfigs','变换图片任务结束\x20队列-1:\x20','PAINT_TYPE','globalConfigService','UploadService','mjProxy','历史这些id已经被获取过了\x20不能拿了:\x20','变化图片任务异常中断\x20队列-1:\x20','HttpStatus','floor','当前用户','error:\x20','绘制图片任务异常中断\x20队列-1:\x20'];_0x4067=function(){return _0x4d0043;};return _0x4067();}MjService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(chatLog_entity_1[_0x2c2734(0xf9)])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(balance_entity_1[_0x2c2734(0x125)])),__metadata(_0x2c2734(0xf4),[typeorm_1[_0x2c2734(0x136)],typeorm_1[_0x2c2734(0x136)],upload_service_1[_0x2c2734(0x158)],chatLog_service_1[_0x2c2734(0x108)],globalConfig_service_1[_0x2c2734(0x10f)],fanyi_service_1[_0x2c2734(0xba)],badwords_service_1[_0x2c2734(0x111)]])],MjService),exports[_0x2c2734(0xcb)]=MjService;