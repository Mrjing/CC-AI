'use strict';const _0x54c0fc=_0x42db;(function(_0x1c0eb7,_0x12e88d){const _0x5d0a7c=_0x42db,_0x40f05c=_0x1c0eb7();while(!![]){try{const _0x24a17d=-parseInt(_0x5d0a7c(0x146))/0x1*(parseInt(_0x5d0a7c(0x10d))/0x2)+-parseInt(_0x5d0a7c(0x166))/0x3*(parseInt(_0x5d0a7c(0x11e))/0x4)+-parseInt(_0x5d0a7c(0x186))/0x5+parseInt(_0x5d0a7c(0x148))/0x6*(-parseInt(_0x5d0a7c(0x130))/0x7)+-parseInt(_0x5d0a7c(0x16b))/0x8+parseInt(_0x5d0a7c(0x19f))/0x9*(-parseInt(_0x5d0a7c(0x1ad))/0xa)+-parseInt(_0x5d0a7c(0x12b))/0xb*(-parseInt(_0x5d0a7c(0x12a))/0xc);if(_0x24a17d===_0x12e88d)break;else _0x40f05c['push'](_0x40f05c['shift']());}catch(_0x120683){_0x40f05c['push'](_0x40f05c['shift']());}}}(_0x385f,0x52dc6));function _0x42db(_0x54501e,_0x1003ee){const _0x385f9d=_0x385f();return _0x42db=function(_0x42dbd7,_0x17af29){_0x42dbd7=_0x42dbd7-0x10c;let _0x547677=_0x385f9d[_0x42dbd7];return _0x547677;},_0x42db(_0x54501e,_0x1003ee);}var __decorate=this&&this[_0x54c0fc(0x183)]||function(_0x3343cc,_0x1fb58e,_0x339845,_0x1c018f){const _0xb2957d=_0x54c0fc;var _0x13e880=arguments[_0xb2957d(0x1b0)],_0x4eca22=_0x13e880<0x3?_0x1fb58e:_0x1c018f===null?_0x1c018f=Object[_0xb2957d(0x10e)](_0x1fb58e,_0x339845):_0x1c018f,_0x12847b;if(typeof Reflect===_0xb2957d(0x1b2)&&typeof Reflect[_0xb2957d(0x16e)]===_0xb2957d(0x139))_0x4eca22=Reflect[_0xb2957d(0x16e)](_0x3343cc,_0x1fb58e,_0x339845,_0x1c018f);else{for(var _0x2d6d30=_0x3343cc['length']-0x1;_0x2d6d30>=0x0;_0x2d6d30--)if(_0x12847b=_0x3343cc[_0x2d6d30])_0x4eca22=(_0x13e880<0x3?_0x12847b(_0x4eca22):_0x13e880>0x3?_0x12847b(_0x1fb58e,_0x339845,_0x4eca22):_0x12847b(_0x1fb58e,_0x339845))||_0x4eca22;}return _0x13e880>0x3&&_0x4eca22&&Object[_0xb2957d(0x152)](_0x1fb58e,_0x339845,_0x4eca22),_0x4eca22;},__metadata=this&&this['__metadata']||function(_0x12b468,_0x418e1f){const _0x29b450=_0x54c0fc;if(typeof Reflect===_0x29b450(0x1b2)&&typeof Reflect[_0x29b450(0x167)]===_0x29b450(0x139))return Reflect['metadata'](_0x12b468,_0x418e1f);},__param=this&&this[_0x54c0fc(0x118)]||function(_0x134f25,_0x4d997a){return function(_0x93f2a0,_0x260aa3){_0x4d997a(_0x93f2a0,_0x260aa3,_0x134f25);};};function _0x385f(){const _0x5337a6=['Injectable','__decorate','drawWorking','变化图片任务异常中断\x20队列-1:\x20','2905535NPHgcx','imagine','freeQueueUsers','prompt','变换当前图片失败','default','checkRateLimit','get','stringify','error:\x20','使用的次数：','MjService','sendSmInteractions','\x20次开始查询','UploadService','Repository','秒请求一次、请合理使用！','map','findCurrentPromptResult','本次比对的随机ID:\x20','http://172.247.48.137:8000/mj/draw','mjVersion','balanceEntity','历史记录中不存在当前图片、请确认您放大的图片是否存在','createQueryBuilder','774ieePDG','variationSingleImg','发送绘画指令结果:\x20','查询期间出现错误：','balance\x20-\x201','log','findCurrentEnlargeImgResult','由于速率限制、当前普通用户限制为','where','BalanceEntity','fanyiService','InjectRepository','enlarge','balance','37030cqyWrL','HttpException','/messages?limit=50','length','../userBalance/balance.entity','object','mjChannelId','message','\x20次开始查询\x20=>\x20当前查询结果：','queryMessageList','拿到了远程地址:\x20','954502ikUdDm','getOwnPropertyDescriptor','removeEmoji','userId\x20=\x20:userId','BAD_REQUEST','开始请求放大图片\x20队列+1:\x20','admin','now','includes','本次绘图耗时:\x20','substring','__param','globalConfigService','upscaleSingleImg','放大custom_id:\x20','randomId:\x20','当前图片没有绘画信息、无法变体!','19828MSfQHg','IsNull','../globalConfig/globalConfig.service','response','user','当前用户','getConfigs','\x20请求过于频繁！','https://discord.com/api/v9/interactions','mjAuthorization','checkAuth','mjGuildId','22812pMZXmR','19272rcJVKX','__esModule','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','getClientIp','update','1360716IQSoik','放大单张图片请求失败...','mjNotSaveImg','Like','sendDrawInteractions','@nestjs/common','sleep','当前提示词已经在任务队列中了、请勿重复提交。。。','url','function','pollForVariationResult','convertToEnglish','放大图片任务结束\x20队列-1:\x20','当前用户\x20','findOne','HttpStatus','\x20次开始查询[变换图片]','deductBalance','rateLimits','error','发送放大指令成功','存入图片完成:\x20','1qtXzyS','../chatLog/chatLog.service','12dUzCrM','getMjDefaultParams','orderId','checkBadWords','mjSessionId','message_id','ChatLogService','components','match','查询绘制结果失败...','defineProperty','放大当前图片失败','find','绘图指令完成','draw','max','test','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','mjProxy','开始请求变换图片\x20队列+1:\x20','axios','badwordsService','replace','http://172.247.48.137:8000/mj/list?channel_id=','super','历史中存在当前图片、直接获取！','mjApplicationId','saveChatLog','INTERNAL_SERVER_ERROR','381YPtKdO','metadata','floor','design:paramtypes','post','4768184mIIfxK','DeductionKey','chatLogEntity','decorate','push','axios:\x20','当前图片已经放大过了、请勿重复放大!','parse','变换图片任务结束\x20队列-1:\x20','../../common/constants/balance.constant','../../common/utils','有历史信息之间返回:\x20','prompt\x20-------->\x20\x20','chatLogService','../chatLog/chatLog.entity','data','GlobalConfigService','findCurrentVariationImgResult','mjRateLimit','mjId','uploadService','queueCount','filter'];_0x385f=function(){return _0x5337a6;};return _0x385f();}Object[_0x54c0fc(0x152)](exports,_0x54c0fc(0x12c),{'value':!![]}),exports[_0x54c0fc(0x191)]=void 0x0;const globalConfig_service_1=require(_0x54c0fc(0x120)),upload_service_1=require('../upload/upload.service'),common_1=require(_0x54c0fc(0x135)),axios_1=require(_0x54c0fc(0x15d)),chatLog_service_1=require(_0x54c0fc(0x147)),balance_constant_1=require(_0x54c0fc(0x174)),utils_1=require(_0x54c0fc(0x175)),chatLog_entity_1=require(_0x54c0fc(0x179)),typeorm_1=require('typeorm'),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require(_0x54c0fc(0x1b1)),fanyi_service_1=require('../fanyi/fanyi.service'),badwords_service_1=require('../badwords/badwords.service');let MjService=class MjService{constructor(_0x4f0022,_0x110977,_0xb9dde5,_0xbf5f00,_0x15f6e7,_0x2005bc,_0x84a6b7){const _0x30f697=_0x54c0fc;this[_0x30f697(0x16d)]=_0x4f0022,this[_0x30f697(0x19c)]=_0x110977,this[_0x30f697(0x17f)]=_0xb9dde5,this['chatLogService']=_0xbf5f00,this[_0x30f697(0x119)]=_0x15f6e7,this[_0x30f697(0x1a9)]=_0x2005bc,this['badwordsService']=_0x84a6b7,this[_0x30f697(0x142)]={},this['drawWorking']=[],this['enlargeWorking']=[],this['queueCount']=0x0,this['freeQueueUsers']={};}async['mjDraw'](_0x3859f5){const _0x370f99=_0x54c0fc,{jobId:_0x17c032,prompt:_0x3b413d,startTime:_0x5be695,userId:_0x11af0d}=_0x3859f5;return console[_0x370f99(0x1a4)]('绘画任务开始','mjservice'),await new Promise(_0x2b4754=>setTimeout(_0x2b4754,0x1388)),{'a':0x1,'b':0x2};}async[_0x54c0fc(0x156)](_0x2771a6,_0xb04abf){const _0x3e5441=_0x54c0fc;await this[_0x3e5441(0x128)](_0xb04abf),await this[_0x3e5441(0x15e)][_0x3e5441(0x14b)](_0x2771a6[_0x3e5441(0x189)],_0xb04abf[_0x3e5441(0x122)]['id']);const _0x13850f=_0x2771a6[_0x3e5441(0x189)];let _0x2b8a96=_0x2771a6[_0x3e5441(0x189)];const {baiduFanyiAppId:_0x44438a,baiduFanyiSecret:_0xe9594}=await this[_0x3e5441(0x119)][_0x3e5441(0x124)](['baiduFanyiAppId','baiduFanyiSecret']);_0x44438a&&_0xe9594&&(_0x2b8a96=await this[_0x3e5441(0x1a9)][_0x3e5441(0x13b)](_0x13850f));const _0x483c65='['+(0x0,utils_1['createRandomUid'])()+']',_0x5f0941=_0x483c65+'\x20'+_0x2b8a96;console[_0x3e5441(0x1a4)](_0x3e5441(0x11c),_0x483c65),console[_0x3e5441(0x1a4)](_0x3e5441(0x177),_0x5f0941);const _0x291616=this['drawWorking'][_0x3e5441(0x154)](_0x224c48=>_0x224c48[_0x3e5441(0x115)](_0x2771a6[_0x3e5441(0x189)]));if(_0x291616)throw new common_1[(_0x3e5441(0x1ae))](_0x3e5441(0x137),common_1[_0x3e5441(0x13f)][_0x3e5441(0x111)]);if(this[_0x3e5441(0x180)]>=0x3)throw new common_1['HttpException'](_0x3e5441(0x12d),common_1[_0x3e5441(0x13f)][_0x3e5441(0x111)]);await this[_0x3e5441(0x18c)](_0xb04abf),this[_0x3e5441(0x180)]++,console['log']('开始请求用户'+_0xb04abf[_0x3e5441(0x122)]['id']+'\x20队列+1:\x20',this[_0x3e5441(0x180)]);try{const _0xa477a9=await this[_0x3e5441(0x16d)][_0x3e5441(0x154)]({'where':{'prompt':(0x0,typeorm_1[_0x3e5441(0x133)])('%'+_0x5f0941+'%')}}),_0x2b17b3=_0xa477a9[_0x3e5441(0x197)](_0x1e2f76=>_0x1e2f76[_0x3e5441(0x14d)]);this['drawWorking'][_0x3e5441(0x16f)](_0x5f0941);let _0x42a05a;const _0x1199fa=await this[_0x3e5441(0x134)](_0x5f0941,_0x2b17b3,_0x483c65);_0x1199fa?(console['log'](_0x3e5441(0x162)),_0x42a05a=_0x1199fa):_0x42a05a=await this['pollForResult'](_0x5f0941,_0x2b17b3,_0x483c65);this[_0x3e5441(0x180)]--,this[_0x3e5441(0x180)]<0x0&&(this[_0x3e5441(0x180)]=0x0),console[_0x3e5441(0x1a4)]('绘制图片任务结束\x20队列-1:\x20',this['queueCount']);const {id:_0x4e8bfc,content:_0x1190c0,channel_id:_0x1cb1cb,attachments:attachments=[],timestamp:_0x312c5a}=_0x42a05a;if(!attachments[_0x3e5441(0x1b0)]||!attachments[0x0]['url'])throw new common_1['HttpException']('绘画失败',common_1[_0x3e5441(0x13f)][_0x3e5441(0x111)]);const {filename:_0x10a3e5,url:_0x5f2540,width:_0x503315,height:_0x5ca583,size:_0x5c32c2}=attachments[0x0];console[_0x3e5441(0x1a4)](_0x3e5441(0x10c),_0x5f2540);const _0x19dcc0=this[_0x3e5441(0x119)]['getConfigs']([_0x3e5441(0x132)]);let _0x148de0='';(!Number(_0x19dcc0)||Number(_0x19dcc0)===0x0)&&(_0x148de0=await this[_0x3e5441(0x17f)]['uploadFileFromUrl']({'filename':_0x10a3e5,'url':_0x5f2540}),console[_0x3e5441(0x1a4)](_0x3e5441(0x145),_0x148de0));const _0x188c94={'curIp':(0x0,utils_1[_0x3e5441(0x12e)])(_0xb04abf),'userId':_0xb04abf[_0x3e5441(0x122)]['id'],'type':balance_constant_1['DeductionKey']['PAINT_TYPE'],'prompt':_0x5f0941,'answer':_0x148de0,'model':'mj','extend':this[_0x3e5441(0x10f)](JSON[_0x3e5441(0x18e)](_0x42a05a)),'message_id':_0x4e8bfc,'variationId':_0x4e8bfc,'upscaleId':_0x4e8bfc,'group':0x1,'isSaveImg':!Number(_0x19dcc0)||Number(_0x19dcc0)===0x0,'fileInfo':JSON[_0x3e5441(0x18e)]({'width':_0x503315,'height':_0x5ca583,'size':_0x5c32c2,'filename':_0x10a3e5,'cosUrl':_0x148de0})};return await this[_0x3e5441(0x178)][_0x3e5441(0x164)](_0x188c94),await this[_0x3e5441(0x141)](_0xb04abf),this[_0x3e5441(0x184)]=this[_0x3e5441(0x184)]['filter'](_0x43cc6c=>_0x43cc6c!==_0x2771a6[_0x3e5441(0x189)]),_0x148de0;}catch(_0x3b29de){this[_0x3e5441(0x180)]--,this[_0x3e5441(0x180)]<0x0&&(this[_0x3e5441(0x180)]=0x0),console[_0x3e5441(0x1a4)]('绘制图片任务异常中断\x20队列-1:\x20',this[_0x3e5441(0x180)]),this[_0x3e5441(0x184)]=this['drawWorking'][_0x3e5441(0x181)](_0x21a614=>_0x21a614!==_0x2771a6['prompt']);throw new common_1[(_0x3e5441(0x1ae))](_0x3b29de[_0x3e5441(0x121)],common_1[_0x3e5441(0x13f)][_0x3e5441(0x111)]);}}async[_0x54c0fc(0x11a)](_0x1e908a,_0x40d29e){const _0x2a6733=_0x54c0fc;if(this[_0x2a6733(0x180)]>=0x3)throw new common_1[(_0x2a6733(0x1ae))](_0x2a6733(0x12d),common_1['HttpStatus']['BAD_REQUEST']);this[_0x2a6733(0x180)]++,console[_0x2a6733(0x1a4)]('用户'+_0x40d29e[_0x2a6733(0x122)]['id']+_0x2a6733(0x112),this[_0x2a6733(0x180)]);const {message_id:_0x15ed0a,orderId:_0x524c9d}=_0x1e908a;try{const _0x2f9ac6=await this[_0x2a6733(0x16d)][_0x2a6733(0x13e)]({'where':{'message_id':_0x15ed0a}});if(!_0x2f9ac6)throw new common_1['HttpException'](_0x2a6733(0x19d),common_1[_0x2a6733(0x13f)]['BAD_REQUEST']);const _0x4fd99d=await this[_0x2a6733(0x16d)][_0x2a6733(0x13e)]({'where':{'upscaleId':_0x15ed0a,'action':_0x2a6733(0x1ab),'orderId':_0x524c9d}});if(_0x4fd99d)throw new common_1[(_0x2a6733(0x1ae))](_0x2a6733(0x171),common_1[_0x2a6733(0x13f)][_0x2a6733(0x111)]);const {prompt:_0x514708,extend:_0x2a7cd6}=_0x2f9ac6;let _0x1e1374=null;try{_0x1e1374=JSON[_0x2a6733(0x172)](_0x2a7cd6);}catch(_0x53de7d){_0x1e1374=[];}const {components:components=[]}=_0x1e1374;if(!components['length'])throw new common_1[(_0x2a6733(0x1ae))]('当前图片没有绘画信息、无法放大!',common_1[_0x2a6733(0x13f)][_0x2a6733(0x111)]);const _0x1f9243=components[0x0][_0x2a6733(0x14f)][_0x524c9d-0x1],{custom_id:_0x1926ed}=_0x1f9243;console[_0x2a6733(0x1a4)](_0x2a6733(0x11b),_0x1926ed);const _0x559e25={'message_id':_0x15ed0a,'custom_id':_0x1926ed,'prompt':_0x514708,'orderId':_0x524c9d};await this['sendSmInteractions'](_0x559e25),console[_0x2a6733(0x1a4)](_0x2a6733(0x144));const _0x4dba66=await this[_0x2a6733(0x16d)][_0x2a6733(0x154)]({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0x514708+'%')}}),_0x3af740=_0x4dba66[_0x2a6733(0x197)](_0x2b3a63=>_0x2b3a63[_0x2a6733(0x14d)]);console[_0x2a6733(0x1a4)]('历史这些id已经被获取过了\x20不能拿了:\x20',_0x3af740);const _0x1a59e8=await this['pollForUpscaleResult'](_0x559e25,_0x3af740);this[_0x2a6733(0x180)]--,this[_0x2a6733(0x180)]<0x0&&(this['queueCount']=0x0),console[_0x2a6733(0x1a4)](_0x2a6733(0x13c),this['queueCount']);const {id:_0x586978,content:_0x43ec6d,channel_id:_0x44520e,attachments:attachments=[],timestamp:_0x101e29}=_0x1a59e8;if(!attachments['length']||!attachments[0x0][_0x2a6733(0x138)])throw new common_1[(_0x2a6733(0x1ae))](_0x2a6733(0x153),common_1['HttpStatus'][_0x2a6733(0x111)]);const {filename:_0x49fc93,url:_0x8efb69,width:_0x762c26,height:_0x43c081,size:_0x1d1021}=attachments[0x0],_0x5ee6f8=this['globalConfigService']['getConfigs']([_0x2a6733(0x132)]);let _0x501bda='';(!Number(_0x5ee6f8)||Number(_0x5ee6f8)===0x0)&&(_0x501bda=await this[_0x2a6733(0x17f)]['uploadFileFromUrl']({'filename':_0x49fc93,'url':_0x8efb69}),console[_0x2a6733(0x1a4)]('存入图片完成:\x20',_0x501bda));const _0x2a13a7={'curIp':(0x0,utils_1[_0x2a6733(0x12e)])(_0x40d29e),'userId':_0x40d29e[_0x2a6733(0x122)]['id'],'type':balance_constant_1[_0x2a6733(0x16c)]['PAINT_TYPE'],'prompt':_0x514708,'answer':_0x501bda,'model':'mj','extend':this['removeEmoji'](JSON[_0x2a6733(0x18e)](_0x1a59e8)),'message_id':_0x15ed0a,'upscaleId':_0x586978,'variationId':_0x586978,'action':_0x2a6733(0x1ab),'orderId':_0x559e25[_0x2a6733(0x14a)],'isSaveImg':!Number(_0x5ee6f8)||Number(_0x5ee6f8)===0x0,'fileInfo':JSON['stringify']({'width':_0x762c26,'height':_0x43c081,'size':_0x1d1021,'filename':_0x49fc93,'cosUrl':_0x501bda})};return await this[_0x2a6733(0x178)][_0x2a6733(0x164)](_0x2a13a7),_0x501bda;}catch(_0x839e54){console[_0x2a6733(0x1a4)](_0x2a6733(0x18f),_0x839e54),this[_0x2a6733(0x180)]--,this['queueCount']<0x0&&(this['queueCount']=0x0),console['log']('放大图片任务异常中断\x20队列-1:\x20',this[_0x2a6733(0x180)]);throw new common_1[(_0x2a6733(0x1ae))](_0x839e54['response'],common_1[_0x2a6733(0x13f)][_0x2a6733(0x111)]);}}async[_0x54c0fc(0x1a0)](_0x4ae3e1,_0x4a9e00){const _0x2050b3=_0x54c0fc;if(this['queueCount']>=0x3)throw new common_1[(_0x2050b3(0x1ae))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x2050b3(0x13f)][_0x2050b3(0x111)]);await this[_0x2050b3(0x128)](_0x4a9e00),await this[_0x2050b3(0x18c)](_0x4a9e00),this[_0x2050b3(0x180)]++,console[_0x2050b3(0x1a4)]('用户'+_0x4a9e00['user']['id']+_0x2050b3(0x15c),this[_0x2050b3(0x180)]);const {message_id:_0x390947,orderId:_0x1abed4}=_0x4ae3e1;try{const _0x10a410=await this[_0x2050b3(0x16d)][_0x2050b3(0x13e)]({'where':{'message_id':_0x390947}});if(!_0x10a410)throw new common_1[(_0x2050b3(0x1ae))](_0x2050b3(0x159),common_1['HttpStatus']['BAD_REQUEST']);const {prompt:_0x57e407,extend:_0x1e5ddb}=_0x10a410;let _0x27f668=null;try{_0x27f668=JSON[_0x2050b3(0x172)](_0x1e5ddb);}catch(_0x549be2){_0x27f668=[];}const {components:components=[]}=_0x27f668;if(!components['length'])throw new common_1[(_0x2050b3(0x1ae))](_0x2050b3(0x11d),common_1['HttpStatus'][_0x2050b3(0x111)]);const _0x824a91=components[0x1][_0x2050b3(0x14f)][_0x1abed4-0x1],{custom_id:_0x18a2ad}=_0x824a91,_0x4dafe9=await this[_0x2050b3(0x16d)][_0x2050b3(0x154)]({'where':{'variationId':(0x0,typeorm_1['Not'])((0x0,typeorm_1[_0x2050b3(0x11f)])()),'prompt':(0x0,typeorm_1['Like'])('%'+_0x57e407+'%')}}),_0x3daf52=_0x4dafe9['map'](_0x5a5bcc=>_0x5a5bcc['variationId']),_0x9c1547={'message_id':_0x390947,'custom_id':_0x18a2ad,'prompt':_0x57e407,'orderId':_0x1abed4};await this['sendSmInteractions'](_0x9c1547);const _0x202ce5=await this[_0x2050b3(0x13a)](_0x9c1547,_0x3daf52);this['queueCount']--,this[_0x2050b3(0x180)]<0x0&&(this[_0x2050b3(0x180)]=0x0),console['log'](_0x2050b3(0x173),this[_0x2050b3(0x180)]);const {id:_0x2512e2,content:_0x57579b,channel_id:_0x48130d,attachments:attachments=[],timestamp:_0x559bb6}=_0x202ce5;if(!attachments['length']||!attachments[0x0][_0x2050b3(0x138)])throw new common_1[(_0x2050b3(0x1ae))](_0x2050b3(0x18a),common_1[_0x2050b3(0x13f)]['BAD_REQUEST']);const {filename:_0x51f3f4,url:_0x3a4ae7,width:_0x23ac32,height:_0x36dcb8,size:_0x228aca}=attachments[0x0],_0x1f10cc=this['globalConfigService']['getConfigs'](['mjNotSaveImg']);let _0x501a50='';(!Number(_0x1f10cc)||Number(_0x1f10cc)===0x0)&&(_0x501a50=await this[_0x2050b3(0x17f)]['uploadFileFromUrl']({'filename':_0x51f3f4,'url':_0x3a4ae7}),console[_0x2050b3(0x1a4)](_0x2050b3(0x145),_0x501a50));const _0x27f440={'curIp':(0x0,utils_1['getClientIp'])(_0x4a9e00),'userId':_0x4a9e00['user']['id'],'type':balance_constant_1[_0x2050b3(0x16c)]['PAINT_TYPE'],'prompt':_0x57e407,'answer':_0x501a50,'model':'mj','group':0x1,'extend':this['removeEmoji'](JSON[_0x2050b3(0x18e)](_0x202ce5)),'message_id':_0x2512e2,'upscaleId':_0x2512e2,'variationId':_0x2512e2,'action':_0x2050b3(0x1ab),'orderId':_0x9c1547['orderId'],'isSaveImg':!Number(_0x1f10cc)||Number(_0x1f10cc)===0x0,'fileInfo':JSON['stringify']({'width':_0x23ac32,'height':_0x36dcb8,'size':_0x228aca,'filename':_0x51f3f4,'cosUrl':_0x501a50})};return await this[_0x2050b3(0x178)][_0x2050b3(0x164)](_0x27f440),_0x501a50;}catch(_0x5aeb45){console['log'](_0x2050b3(0x18f),_0x5aeb45),this['queueCount']--,this[_0x2050b3(0x180)]<0x0&&(this[_0x2050b3(0x180)]=0x0),console[_0x2050b3(0x1a4)](_0x2050b3(0x185),this['queueCount']);throw new common_1[(_0x2050b3(0x1ae))](_0x5aeb45['response'],common_1[_0x2050b3(0x13f)][_0x2050b3(0x111)]);}}async[_0x54c0fc(0x192)](_0x30040d){const _0x1594e5=_0x54c0fc,{message_id:_0x71011c,custom_id:_0x3e4388}=_0x30040d,{application_id:_0x26626e,guild_id:_0x335f1b,channel_id:_0xac035e,session_id:_0x42e437,version:_0x4f38b7,id:_0x593d47,authorization:_0x439a75,mjProxy:_0x10e37a}=await this[_0x1594e5(0x149)](),_0x529bea=_0x10e37a==0x1?_0x1594e5(0x19a):_0x1594e5(0x126),_0x5a243b={'authorization':_0x439a75},_0x4653bb={'type':0x3,'guild_id':_0x335f1b,'channel_id':_0xac035e,'message_flags':0x0,'message_id':_0x71011c,'application_id':_0x26626e,'session_id':_0x42e437,'data':{'component_type':0x2,'custom_id':_0x3e4388}};try{await axios_1[_0x1594e5(0x18b)][_0x1594e5(0x16a)](_0x529bea,_0x4653bb,{'headers':_0x5a243b}),console[_0x1594e5(0x1a4)](_0x1594e5(0x155));}catch(_0x214d27){console[_0x1594e5(0x1a4)]('error:\x20',_0x214d27);throw new common_1[(_0x1594e5(0x1ae))](_0x1594e5(0x131),common_1[_0x1594e5(0x13f)][_0x1594e5(0x111)]);}}async['pollForUpscaleResult'](_0x83fdfd,_0x4bc9a6){const _0x3c297f=_0x54c0fc,{message_id:_0x19241c,custom_id:_0x390349,prompt:_0x33bec7,orderId:_0x497c08}=_0x83fdfd;let _0x125aec=null,_0x40eb05=0x0;while(!_0x125aec&&_0x40eb05<0xa){try{const _0x3cbeb7=Date[_0x3c297f(0x114)](),_0x6f2c47=await this[_0x3c297f(0x1b6)]();console[_0x3c297f(0x1a4)]('第\x20'+(_0x40eb05+0x1)+_0x3c297f(0x1b5)+_0x6f2c47[_0x3c297f(0x1b0)]);_0x6f2c47&&_0x6f2c47[_0x3c297f(0x1b0)]&&(_0x125aec=await this[_0x3c297f(0x1a5)](_0x6f2c47,_0x83fdfd,_0x4bc9a6));const _0x62a2ac=Date['now']()-_0x3cbeb7,_0x38f7a4=0xbb8;await this['sleep'](Math[_0x3c297f(0x157)](_0x38f7a4-_0x62a2ac,0x0)),_0x40eb05++;}catch(_0x27617f){console[_0x3c297f(0x143)]('查询期间出现错误：'+_0x27617f[_0x3c297f(0x1b4)]);}}return _0x125aec;}async[_0x54c0fc(0x13a)](_0x2db865,_0x3dd41a){const _0x250cde=_0x54c0fc,{message_id:_0x1afc9d,custom_id:_0x445273,prompt:_0x3c4be9,orderId:_0x54080a}=_0x2db865;console['log']('开始轮询单张变换图片结果');let _0x4774ce=null,_0x801575=0x0;while(!_0x4774ce&&_0x801575<0xa){try{console[_0x250cde(0x1a4)]('第\x20'+(_0x801575+0x1)+_0x250cde(0x140));const _0x2b48bd=Date[_0x250cde(0x114)](),_0x24251f=await this[_0x250cde(0x1b6)]();_0x24251f&&_0x24251f[_0x250cde(0x1b0)]&&(_0x4774ce=await this['findCurrentVariationImgResult'](_0x24251f,_0x2db865,_0x3dd41a));const _0x4f73ef=Date[_0x250cde(0x114)]()-_0x2b48bd,_0x39d945=0x1f40;await this[_0x250cde(0x136)](Math[_0x250cde(0x157)](_0x39d945-_0x4f73ef,0x0)),_0x801575++;}catch(_0x6a7c90){console[_0x250cde(0x143)](_0x250cde(0x1a2)+_0x6a7c90['message']);}}if(!_0x4774ce)throw new common_1[(_0x250cde(0x1ae))]('变换当前图片超时！',common_1['HttpStatus'][_0x250cde(0x111)]);return _0x4774ce;}async[_0x54c0fc(0x1a5)](_0x55e341,_0x4ec24e,_0x4d3163){const _0x5384fe=_0x54c0fc,{message_id:_0x27faf8,custom_id:_0x592b55,prompt:_0x2514ae,orderId:_0x2c4567}=_0x4ec24e,_0x2f32ba=_0x2514ae[_0x5384fe(0x117)](0x0,0xc);console[_0x5384fe(0x1a4)]('本次放大图片的id:\x20',_0x2f32ba);const _0x15b975=_0x55e341[_0x5384fe(0x154)](_0x4e7c56=>{const _0x124387=_0x5384fe,{content:_0x22eabd}=_0x4e7c56;if(!this['extractContent'](_0x22eabd))return![];const {prompt:_0x182172,order:_0x2545cf}=this['extractContent'](_0x22eabd);return _0x182172[_0x124387(0x115)](_0x2f32ba)&&_0x4ec24e[_0x124387(0x14a)]===_0x2545cf&&!_0x4d3163[_0x124387(0x115)](_0x4e7c56['id']);});return _0x15b975;}async[_0x54c0fc(0x17c)](_0x2ba269,_0x1433fc,_0x5e93ac){const _0x517c08=_0x54c0fc,{message_id:_0x189381,custom_id:_0x5ec470,prompt:_0x1251c7,orderId:_0x52197b}=_0x1433fc,_0x48d369=_0x1251c7[_0x517c08(0x117)](0x0,0xc),_0xca1e96=_0x2ba269['find'](_0x1aa959=>{const _0x1f0ef0=_0x517c08,{content:_0x398111}=_0x1aa959,_0x40f3be=_0x398111[_0x1f0ef0(0x150)](/\*\*(.+?)\*\*/),_0x25411e=_0x40f3be?_0x40f3be[0x1]:'';if(!_0x25411e)return![];return _0x25411e[_0x1f0ef0(0x115)](_0x48d369)&&!_0x5e93ac[_0x1f0ef0(0x115)](_0x1aa959['id']);});return _0xca1e96;}async[_0x54c0fc(0x134)](_0x2678dd,_0x20f5cc,_0x410072){const _0x45e8b9=_0x54c0fc,_0x17b019=await this[_0x45e8b9(0x1b6)](),_0x4b458e=await this[_0x45e8b9(0x198)](_0x17b019,_0x410072,_0x20f5cc);if(_0x4b458e)return console['log'](_0x45e8b9(0x176),_0x4b458e),_0x4b458e;const {application_id:_0x4cf67e,guild_id:_0x240f15,channel_id:_0x492379,session_id:_0x1ed26b,version:_0x58aee6,id:_0x231119,authorization:_0x14c75d,mjProxy:_0x36cc16}=await this[_0x45e8b9(0x149)](),_0x1dd780={'type':0x2,'application_id':_0x4cf67e,'guild_id':_0x240f15,'channel_id':_0x492379,'session_id':_0x1ed26b,'data':{'version':_0x58aee6,'id':_0x231119,'name':_0x45e8b9(0x187),'type':0x1,'options':[{'type':0x3,'name':_0x45e8b9(0x189),'value':_0x2678dd}],'attachments':[]}};try{const _0x14efd7=_0x36cc16==0x1?_0x45e8b9(0x19a):_0x45e8b9(0x126),_0x371914={'authorization':_0x14c75d},_0xca166f=await axios_1['default'][_0x45e8b9(0x16a)](_0x14efd7,_0x1dd780,{'headers':_0x371914});return console[_0x45e8b9(0x1a4)](_0x45e8b9(0x1a1),_0xca166f['data']),![];}catch(_0x2e8cda){console[_0x45e8b9(0x1a4)](_0x45e8b9(0x170),_0x2e8cda);throw new common_1[(_0x45e8b9(0x1ae))](_0x45e8b9(0x15a),common_1[_0x45e8b9(0x13f)]['BAD_REQUEST']);}}async['pollForResult'](_0x437530,_0x109356,_0x273027){const _0x3db825=_0x54c0fc;console[_0x3db825(0x1a4)]('开始查询绘画结果轮询');const _0x15ef54=Date[_0x3db825(0x114)]();try{const _0x374687=0xd,_0x4aba5a=0x2ee0,_0x189553=0x1388,_0x58b5d2=0x3c*0x3e8;let _0x294305=0x0,_0xff3508=![],_0x4c6da2=null;while(!_0x4c6da2&&_0x294305<_0x374687){console[_0x3db825(0x1a4)]('第\x20'+(_0x294305+0x1)+_0x3db825(0x193));Date[_0x3db825(0x114)]()-_0x15ef54>=_0x58b5d2&&(_0xff3508=!![]);await this[_0x3db825(0x136)](_0xff3508?_0x189553:_0x4aba5a);const _0x93e4ff=await this[_0x3db825(0x1b6)]();_0x4c6da2=await this['findCurrentPromptResult'](_0x93e4ff,_0x273027,_0x109356),_0x294305++;}if(!_0x4c6da2)throw new common_1[(_0x3db825(0x1ae))]('绘画超时，请稍后再试！',common_1[_0x3db825(0x13f)][_0x3db825(0x111)]);const _0x303ee5=Date[_0x3db825(0x114)]();return console[_0x3db825(0x1a4)](_0x3db825(0x116)+Math[_0x3db825(0x168)]((_0x303ee5-_0x15ef54)/0x3e8)+'\x20S'),_0x4c6da2;}catch(_0x203a79){console[_0x3db825(0x143)](_0x203a79[_0x3db825(0x1b4)]);throw new common_1['HttpException']('网络连接失败，请稍后再试！',common_1[_0x3db825(0x13f)][_0x3db825(0x165)]);}}async[_0x54c0fc(0x198)](_0x78424c,_0x2b49bf,_0x359c00){const _0x39023d=_0x54c0fc;if(!_0x78424c||!_0x78424c[_0x39023d(0x1b0)])return;console[_0x39023d(0x1a4)](_0x39023d(0x199),_0x2b49bf);const _0x4b648b=_0x78424c[_0x39023d(0x154)](_0x4cdb9b=>{const _0x367418=_0x39023d,{attachments:attachments=[],content:_0xd4d15b,edited_timestamp:_0x47399f}=_0x4cdb9b;return _0xd4d15b[_0x367418(0x115)](_0x2b49bf)&&attachments[_0x367418(0x1b0)]>0x0&&!_0x47399f&&!_0x359c00[_0x367418(0x115)](_0x4cdb9b['id']);});return _0x4b648b||null;}async['queryMessageList'](){const _0x11824b=_0x54c0fc;try{const {application_id:_0x7f513b,guild_id:_0x3fe624,channel_id:_0x2ff650,session_id:_0xaf9f5e,version:_0x4ca1a6,id:_0x52fbc8,authorization:_0x176e7b,mjProxy:_0x267398}=await this[_0x11824b(0x149)](),_0x4e88ae=_0x267398==0x1?_0x11824b(0x160)+_0x2ff650:'https://discord.com/api/v9/channels/'+_0x2ff650+_0x11824b(0x1af),_0x498195={'authorization':_0x176e7b},_0x4319c9=await axios_1['default'][_0x11824b(0x18d)](_0x4e88ae,{'headers':_0x498195});return _0x4319c9[_0x11824b(0x17a)];}catch(_0x221e51){console[_0x11824b(0x1a4)]('axios\x20get:\x20',_0x221e51);throw new common_1['HttpException'](_0x11824b(0x151),common_1[_0x11824b(0x13f)][_0x11824b(0x111)]);}}async[_0x54c0fc(0x136)](_0xd35c6d){return new Promise(_0x20cc63=>setTimeout(_0x20cc63,_0xd35c6d));}['extractContent'](_0x3d0b5e){const _0x4edf21=_0x54c0fc,_0x2b4913=_0x3d0b5e[_0x4edf21(0x150)](/\*\*(.+?)\*\*/),_0x1cd6e6=_0x3d0b5e[_0x4edf21(0x150)](/- Image #(\d+)/);if(!_0x2b4913||!_0x1cd6e6)return null;const _0x358aa7=_0x2b4913[0x1],_0x229b95=parseInt(_0x1cd6e6[0x1]);return{'prompt':_0x358aa7,'order':_0x229b95};}async['getMjDefaultParams'](){const _0x110bde=_0x54c0fc,_0x34466e=await this[_0x110bde(0x119)][_0x110bde(0x124)](['mjId',_0x110bde(0x163),_0x110bde(0x129),'mjChannelId',_0x110bde(0x14c),_0x110bde(0x19b),'mjAuthorization',_0x110bde(0x17d),_0x110bde(0x15b)]),_0x585468={'application_id':_0x34466e[_0x110bde(0x163)],'guild_id':_0x34466e[_0x110bde(0x129)],'channel_id':_0x34466e[_0x110bde(0x1b3)],'session_id':_0x34466e[_0x110bde(0x14c)],'version':_0x34466e[_0x110bde(0x19b)],'id':_0x34466e[_0x110bde(0x17e)],'authorization':_0x34466e[_0x110bde(0x127)],'mjRateLimit':_0x34466e[_0x110bde(0x17d)],'mjProxy':_0x34466e[_0x110bde(0x15b)]||0x0};return _0x585468;}[_0x54c0fc(0x10f)](_0x196e0a){const _0x5d7e0f=_0x54c0fc,_0x497453=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x196e0a[_0x5d7e0f(0x15f)](_0x497453,'');}async['checkAuth'](_0x36fe61){const _0x3d245a=_0x54c0fc,_0x124cf3=await this['balanceEntity'][_0x3d245a(0x13e)]({'where':{'userId':_0x36fe61[_0x3d245a(0x122)]['id']}}),{id:_0x58e030,balance:_0xee2630}=_0x124cf3;if(!_0xee2630||(_0x124cf3===null||_0x124cf3===void 0x0?void 0x0:_0x124cf3[_0x3d245a(0x1ac)])<0x1)throw new common_1[(_0x3d245a(0x1ae))]('您当前暂无MJ绘画余额！！！',common_1[_0x3d245a(0x13f)]['BAD_REQUEST']);}async['checkFree'](_0x176898){const _0x37eb54=_0x54c0fc,{id:_0x4aa4eb,role:_0x111b5a}=_0x176898[_0x37eb54(0x122)];!this[_0x37eb54(0x188)][_0x4aa4eb]?this[_0x37eb54(0x188)][_0x4aa4eb]=0x1:this[_0x37eb54(0x188)][_0x4aa4eb]=this[_0x37eb54(0x188)][_0x4aa4eb]+0x1,console['log'](_0x37eb54(0x123)+_0x4aa4eb+_0x37eb54(0x190),this[_0x37eb54(0x188)][_0x4aa4eb]);}async[_0x54c0fc(0x18c)](_0x56e46c){const _0x2783a8=_0x54c0fc,{id:_0x165619,role:_0x3ecb7b}=_0x56e46c[_0x2783a8(0x122)];if([_0x2783a8(0x113),_0x2783a8(0x161)][_0x2783a8(0x115)](_0x3ecb7b))return!![];const {mjRateLimit:_0x1256c3}=await this[_0x2783a8(0x149)]();if(this[_0x2783a8(0x142)][_0x165619]){const _0x191c4a=this[_0x2783a8(0x142)][_0x165619];if(_0x191c4a>Date[_0x2783a8(0x114)]()){console[_0x2783a8(0x1a4)](_0x2783a8(0x13d)+_0x165619+_0x2783a8(0x125));throw new common_1[(_0x2783a8(0x1ae))](_0x2783a8(0x1a6)+_0x1256c3+_0x2783a8(0x196),common_1[_0x2783a8(0x13f)][_0x2783a8(0x111)]);}else this[_0x2783a8(0x142)][_0x165619]=Date[_0x2783a8(0x114)]()+Number(_0x1256c3)*0x3e8;}else{const _0xb059fd=Date[_0x2783a8(0x114)]();this['rateLimits'][_0x165619]=_0xb059fd+0x3e8*Number(_0x1256c3);}}async[_0x54c0fc(0x141)](_0x36ee82){const _0xd0a3b3=_0x54c0fc;await this[_0xd0a3b3(0x19c)][_0xd0a3b3(0x19e)]()[_0xd0a3b3(0x12f)](balance_entity_1[_0xd0a3b3(0x1a8)])['set']({'balance':()=>_0xd0a3b3(0x1a3)})[_0xd0a3b3(0x1a7)](_0xd0a3b3(0x110),{'userId':_0x36ee82[_0xd0a3b3(0x122)]['id']})['execute']();}async[_0x54c0fc(0x158)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x54c0fc(0x182)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_2[_0x54c0fc(0x1aa)])(balance_entity_1[_0x54c0fc(0x1a8)])),__metadata(_0x54c0fc(0x169),[typeorm_1[_0x54c0fc(0x195)],typeorm_1[_0x54c0fc(0x195)],upload_service_1[_0x54c0fc(0x194)],chatLog_service_1[_0x54c0fc(0x14e)],globalConfig_service_1[_0x54c0fc(0x17b)],fanyi_service_1['FanyiService'],badwords_service_1['BadwordsService']])],MjService),exports[_0x54c0fc(0x191)]=MjService;