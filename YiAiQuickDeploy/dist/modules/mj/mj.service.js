'use strict';const _0x37d9fd=_0xbe52;function _0x8e04(){const _0x3ddaab=['object','freeQueueUsers','set','放大单张图片请求失败...','InjectRepository','mjId','__decorate','deductBalance','decorate','HttpException','绘制图片任务结束\x20队列-1:\x20','发送放大指令成功','data','绘画超时，请稍后再试！','当前用户','__param','\x20次开始查询','开始查询绘画结果轮询','UploadService','绘画失败','uploadFileFromUrl','当前图片已经放大过了、请勿重复放大!','692200razVgG','../userBalance/balance.entity','Not','error','mjAuthorization','response','url','mjVersion','queryMessageList','update','upscaleSingleImg','components','MjService','prompt','mjSessionId','变换当前图片超时！','parse','length','发送绘画指令结果:\x20','查询绘制结果失败...','799992PGSFNb','mjChannelId','now','getMjDefaultParams','function','Like','createQueryBuilder','checkAuth','includes','globalConfigService','rateLimits','BAD_REQUEST','mjNotSaveImg','@nestjs/common','getConfigs','2133VwMHHg','execute','46369rdnsZo','getOwnPropertyDescriptor','使用的次数：','error:\x20','prompt\x20-------->\x20\x20','test','pollForUpscaleResult','BadwordsService','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','findOne','message','绘图指令完成','saveChatLog','sendDrawInteractions','findCurrentPromptResult','PAINT_TYPE','variationId','checkFree','imagine','stringify','sleep','ChatLogEntity','baiduFanyiAppId','BalanceEntity','where','drawWorking','balance','../../common/constants/balance.constant','__esModule','mjGuildId','createRandomUid','查询期间出现错误：','queueCount','本次绘图耗时:\x20','metadata','../badwords/badwords.service','INTERNAL_SERVER_ERROR','变换当前图片失败','draw','绘制图片任务异常中断\x20队列-1:\x20','match','checkBadWords','存入图片完成:\x20','substring','有历史信息之间返回:\x20','user','message_id','defineProperty','userId\x20=\x20:userId','default','extractContent','findCurrentVariationImgResult','DeductionKey','filter','sendSmInteractions','map','当前图片没有绘画信息、无法变体!','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','post','axios:\x20','历史这些id已经被获取过了\x20不能拿了:\x20','badwordsService','uploadService','mjApplicationId','super','秒请求一次、请合理使用！','FanyiService','../chatLog/chatLog.service','HttpStatus','pollForResult','935584lMaBZL','http://172.247.48.137:8000/mj/list?channel_id=','mjProxy','baiduFanyiSecret','balanceEntity','https://discord.com/api/v9/channels/','fanyiService','mjRateLimit','473895ZyCfRM','绘画任务开始','randomId:\x20','getClientIp','8UnlfMj','\x20请求过于频繁！','https://discord.com/api/v9/interactions','Injectable','log','\x20次开始查询\x20=>\x20当前查询结果：','find','pollForVariationResult','enlarge','Repository','get','907984zXRWFD','放大图片任务结束\x20队列-1:\x20','axios\x20get:\x20','orderId','checkRateLimit','本次比对的随机ID:\x20','拿到了远程地址:\x20','网络连接失败，请稍后再试！','admin','4824AFdZEj','chatLogService','chatLogEntity','../fanyi/fanyi.service','floor','mjservice','@nestjs/typeorm','变化图片任务异常中断\x20队列-1:\x20','http://172.247.48.137:8000/mj/draw','当前图片没有绘画信息、无法放大!','typeorm','variationSingleImg','removeEmoji'];_0x8e04=function(){return _0x3ddaab;};return _0x8e04();}(function(_0x172b7f,_0x11ee33){const _0x13345f=_0xbe52,_0x53df93=_0x172b7f();while(!![]){try{const _0x1a37aa=-parseInt(_0x13345f(0x1cd))/0x1*(-parseInt(_0x13345f(0x21f))/0x2)+parseInt(_0x13345f(0x21b))/0x3+-parseInt(_0x13345f(0x213))/0x4+parseInt(_0x13345f(0x1a8))/0x5+-parseInt(_0x13345f(0x1bc))/0x6+-parseInt(_0x13345f(0x22a))/0x7+parseInt(_0x13345f(0x233))/0x8*(parseInt(_0x13345f(0x1cb))/0x9);if(_0x1a37aa===_0x11ee33)break;else _0x53df93['push'](_0x53df93['shift']());}catch(_0x4276b7){_0x53df93['push'](_0x53df93['shift']());}}}(_0x8e04,0x1f36c));function _0xbe52(_0x4d70cd,_0x2fe1bc){const _0x8e043=_0x8e04();return _0xbe52=function(_0xbe528d,_0x44f718){_0xbe528d=_0xbe528d-0x198;let _0x55e6d7=_0x8e043[_0xbe528d];return _0x55e6d7;},_0xbe52(_0x4d70cd,_0x2fe1bc);}var __decorate=this&&this[_0x37d9fd(0x198)]||function(_0x5bd04a,_0x4dc136,_0x1f8f07,_0x1a83df){const _0x5dfa81=_0x37d9fd;var _0x18bfd8=arguments['length'],_0x48995e=_0x18bfd8<0x3?_0x4dc136:_0x1a83df===null?_0x1a83df=Object[_0x5dfa81(0x1ce)](_0x4dc136,_0x1f8f07):_0x1a83df,_0xf8b73b;if(typeof Reflect===_0x5dfa81(0x240)&&typeof Reflect[_0x5dfa81(0x19a)]==='function')_0x48995e=Reflect[_0x5dfa81(0x19a)](_0x5bd04a,_0x4dc136,_0x1f8f07,_0x1a83df);else{for(var _0x3bd525=_0x5bd04a['length']-0x1;_0x3bd525>=0x0;_0x3bd525--)if(_0xf8b73b=_0x5bd04a[_0x3bd525])_0x48995e=(_0x18bfd8<0x3?_0xf8b73b(_0x48995e):_0x18bfd8>0x3?_0xf8b73b(_0x4dc136,_0x1f8f07,_0x48995e):_0xf8b73b(_0x4dc136,_0x1f8f07))||_0x48995e;}return _0x18bfd8>0x3&&_0x48995e&&Object[_0x5dfa81(0x1fc)](_0x4dc136,_0x1f8f07,_0x48995e),_0x48995e;},__metadata=this&&this['__metadata']||function(_0x4cfafd,_0x4cd04a){const _0x18726e=_0x37d9fd;if(typeof Reflect===_0x18726e(0x240)&&typeof Reflect[_0x18726e(0x1ef)]===_0x18726e(0x1c0))return Reflect[_0x18726e(0x1ef)](_0x4cfafd,_0x4cd04a);},__param=this&&this[_0x37d9fd(0x1a1)]||function(_0x5c0560,_0x366060){return function(_0x53a95a,_0x326ff4){_0x366060(_0x53a95a,_0x326ff4,_0x5c0560);};};Object['defineProperty'](exports,_0x37d9fd(0x1e9),{'value':!![]}),exports[_0x37d9fd(0x1b4)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),upload_service_1=require('../upload/upload.service'),common_1=require(_0x37d9fd(0x1c9)),axios_1=require('axios'),chatLog_service_1=require(_0x37d9fd(0x210)),balance_constant_1=require(_0x37d9fd(0x1e8)),utils_1=require('../../common/utils'),chatLog_entity_1=require('../chatLog/chatLog.entity'),typeorm_1=require(_0x37d9fd(0x23d)),typeorm_2=require(_0x37d9fd(0x239)),balance_entity_1=require(_0x37d9fd(0x1a9)),fanyi_service_1=require(_0x37d9fd(0x236)),badwords_service_1=require(_0x37d9fd(0x1f0));let MjService=class MjService{constructor(_0x5c3765,_0x2e32d0,_0x2ebe9d,_0x2537e6,_0x23b76a,_0x3249ef,_0x16de41){const _0x56cc27=_0x37d9fd;this[_0x56cc27(0x235)]=_0x5c3765,this['balanceEntity']=_0x2e32d0,this[_0x56cc27(0x20b)]=_0x2ebe9d,this['chatLogService']=_0x2537e6,this[_0x56cc27(0x1c5)]=_0x23b76a,this[_0x56cc27(0x219)]=_0x3249ef,this[_0x56cc27(0x20a)]=_0x16de41,this[_0x56cc27(0x1c6)]={},this[_0x56cc27(0x1e6)]=[],this['enlargeWorking']=[],this[_0x56cc27(0x1ed)]=0x0,this[_0x56cc27(0x241)]={};}async['mjDraw'](_0x5d2a6e){const _0x528582=_0x37d9fd,{jobId:_0x36e255,prompt:_0x343249,startTime:_0x401c51,userId:_0x36dbf1}=_0x5d2a6e;return console[_0x528582(0x223)](_0x528582(0x21c),_0x528582(0x238)),await new Promise(_0x339102=>setTimeout(_0x339102,0x1388)),{'a':0x1,'b':0x2};}async[_0x37d9fd(0x1f3)](_0x210f98,_0x83aa4b){const _0x6eb115=_0x37d9fd;await this['checkAuth'](_0x83aa4b),await this['badwordsService'][_0x6eb115(0x1f6)](_0x210f98['prompt'],_0x83aa4b[_0x6eb115(0x1fa)]['id']);const _0x28e28e=_0x210f98[_0x6eb115(0x1b5)];let _0x42a505=_0x210f98[_0x6eb115(0x1b5)];const {baiduFanyiAppId:_0x369ba6,baiduFanyiSecret:_0x47fe92}=await this['globalConfigService']['getConfigs']([_0x6eb115(0x1e3),_0x6eb115(0x216)]);_0x369ba6&&_0x47fe92&&(_0x42a505=await this[_0x6eb115(0x219)]['convertToEnglish'](_0x28e28e));const _0x5d0e90='['+(0x0,utils_1[_0x6eb115(0x1eb)])()+']',_0x5b21df=_0x5d0e90+'\x20'+_0x42a505;console[_0x6eb115(0x223)](_0x6eb115(0x21d),_0x5d0e90),console[_0x6eb115(0x223)](_0x6eb115(0x1d1),_0x5b21df);const _0x102f09=this[_0x6eb115(0x1e6)][_0x6eb115(0x225)](_0x2d24e8=>_0x2d24e8[_0x6eb115(0x1c4)](_0x210f98[_0x6eb115(0x1b5)]));if(_0x102f09)throw new common_1['HttpException']('当前提示词已经在任务队列中了、请勿重复提交。。。',common_1['HttpStatus'][_0x6eb115(0x1c7)]);if(this[_0x6eb115(0x1ed)]>=0x3)throw new common_1['HttpException'](_0x6eb115(0x206),common_1[_0x6eb115(0x211)][_0x6eb115(0x1c7)]);await this[_0x6eb115(0x22e)](_0x83aa4b),this[_0x6eb115(0x1ed)]++,console[_0x6eb115(0x223)]('开始请求用户'+_0x83aa4b[_0x6eb115(0x1fa)]['id']+'\x20队列+1:\x20',this[_0x6eb115(0x1ed)]);try{const _0x171316=await this[_0x6eb115(0x235)][_0x6eb115(0x225)]({'where':{'prompt':(0x0,typeorm_1[_0x6eb115(0x1c1)])('%'+_0x5b21df+'%')}}),_0x37e769=_0x171316[_0x6eb115(0x204)](_0x5f36c9=>_0x5f36c9[_0x6eb115(0x1fb)]);this[_0x6eb115(0x1e6)]['push'](_0x5b21df);let _0x56da5e;const _0xc54de6=await this[_0x6eb115(0x1da)](_0x5b21df,_0x37e769,_0x5d0e90);_0xc54de6?(console[_0x6eb115(0x223)]('历史中存在当前图片、直接获取！'),_0x56da5e=_0xc54de6):_0x56da5e=await this[_0x6eb115(0x212)](_0x5b21df,_0x37e769,_0x5d0e90);this['queueCount']--,this[_0x6eb115(0x1ed)]<0x0&&(this[_0x6eb115(0x1ed)]=0x0),console[_0x6eb115(0x223)](_0x6eb115(0x19c),this[_0x6eb115(0x1ed)]);const {id:_0x58a323,content:_0x1e37de,channel_id:_0x299344,attachments:attachments=[],timestamp:_0x7aff7a}=_0x56da5e;if(!attachments[_0x6eb115(0x1b9)]||!attachments[0x0][_0x6eb115(0x1ae)])throw new common_1[(_0x6eb115(0x19b))](_0x6eb115(0x1a5),common_1[_0x6eb115(0x211)][_0x6eb115(0x1c7)]);const {filename:_0x598ca9,url:_0x8e4d5f,width:_0x5dbb3f,height:_0x467cab,size:_0x465b41}=attachments[0x0];console['log'](_0x6eb115(0x230),_0x8e4d5f);const _0x1c76df=this[_0x6eb115(0x1c5)][_0x6eb115(0x1ca)](['mjNotSaveImg']);let _0x241f78='';(!Number(_0x1c76df)||Number(_0x1c76df)===0x0)&&(_0x241f78=await this[_0x6eb115(0x20b)]['uploadFileFromUrl']({'filename':_0x598ca9,'url':_0x8e4d5f}),console['log'](_0x6eb115(0x1f7),_0x241f78));const _0x191474={'curIp':(0x0,utils_1[_0x6eb115(0x21e)])(_0x83aa4b),'userId':_0x83aa4b['user']['id'],'type':balance_constant_1[_0x6eb115(0x201)]['PAINT_TYPE'],'prompt':_0x5b21df,'answer':_0x241f78,'model':'mj','extend':this['removeEmoji'](JSON[_0x6eb115(0x1e0)](_0x56da5e)),'message_id':_0x58a323,'variationId':_0x58a323,'upscaleId':_0x58a323,'group':0x1,'isSaveImg':!Number(_0x1c76df)||Number(_0x1c76df)===0x0,'fileInfo':JSON[_0x6eb115(0x1e0)]({'width':_0x5dbb3f,'height':_0x467cab,'size':_0x465b41,'filename':_0x598ca9,'cosUrl':_0x241f78})};return await this['chatLogService'][_0x6eb115(0x1d9)](_0x191474),await this[_0x6eb115(0x199)](_0x83aa4b),this[_0x6eb115(0x1e6)]=this[_0x6eb115(0x1e6)]['filter'](_0x33d0b9=>_0x33d0b9!==_0x210f98[_0x6eb115(0x1b5)]),_0x241f78;}catch(_0x19ee20){this['queueCount']--,this[_0x6eb115(0x1ed)]<0x0&&(this[_0x6eb115(0x1ed)]=0x0),console[_0x6eb115(0x223)](_0x6eb115(0x1f4),this[_0x6eb115(0x1ed)]),this[_0x6eb115(0x1e6)]=this[_0x6eb115(0x1e6)][_0x6eb115(0x202)](_0xd80544=>_0xd80544!==_0x210f98[_0x6eb115(0x1b5)]);throw new common_1[(_0x6eb115(0x19b))](_0x19ee20['response'],common_1[_0x6eb115(0x211)][_0x6eb115(0x1c7)]);}}async[_0x37d9fd(0x1b2)](_0xeb9d86,_0xe83bdb){const _0x3afbff=_0x37d9fd;if(this[_0x3afbff(0x1ed)]>=0x3)throw new common_1[(_0x3afbff(0x19b))](_0x3afbff(0x206),common_1['HttpStatus'][_0x3afbff(0x1c7)]);this[_0x3afbff(0x1ed)]++,console['log']('用户'+_0xe83bdb[_0x3afbff(0x1fa)]['id']+'开始请求放大图片\x20队列+1:\x20',this[_0x3afbff(0x1ed)]);const {message_id:_0x1dc092,orderId:_0x4e93b4}=_0xeb9d86;try{const _0xe77012=await this[_0x3afbff(0x235)][_0x3afbff(0x1d6)]({'where':{'message_id':_0x1dc092}});if(!_0xe77012)throw new common_1['HttpException']('历史记录中不存在当前图片、请确认您放大的图片是否存在',common_1[_0x3afbff(0x211)]['BAD_REQUEST']);const _0x199c56=await this[_0x3afbff(0x235)][_0x3afbff(0x1d6)]({'where':{'upscaleId':_0x1dc092,'action':'enlarge','orderId':_0x4e93b4}});if(_0x199c56)throw new common_1[(_0x3afbff(0x19b))](_0x3afbff(0x1a7),common_1[_0x3afbff(0x211)][_0x3afbff(0x1c7)]);const {prompt:_0x37e7c2,extend:_0x28a82b}=_0xe77012;let _0x207e05=null;try{_0x207e05=JSON[_0x3afbff(0x1b8)](_0x28a82b);}catch(_0x4f71a2){_0x207e05=[];}const {components:components=[]}=_0x207e05;if(!components[_0x3afbff(0x1b9)])throw new common_1[(_0x3afbff(0x19b))](_0x3afbff(0x23c),common_1['HttpStatus'][_0x3afbff(0x1c7)]);const _0x3aa8f9=components[0x0]['components'][_0x4e93b4-0x1],{custom_id:_0x32c62c}=_0x3aa8f9;console[_0x3afbff(0x223)]('放大custom_id:\x20',_0x32c62c);const _0x20f183={'message_id':_0x1dc092,'custom_id':_0x32c62c,'prompt':_0x37e7c2,'orderId':_0x4e93b4};await this['sendSmInteractions'](_0x20f183),console[_0x3afbff(0x223)](_0x3afbff(0x19d));const _0x4b3f38=await this[_0x3afbff(0x235)][_0x3afbff(0x225)]({'where':{'prompt':(0x0,typeorm_1[_0x3afbff(0x1c1)])('%'+_0x37e7c2+'%')}}),_0x45242e=_0x4b3f38['map'](_0x18ca97=>_0x18ca97[_0x3afbff(0x1fb)]);console[_0x3afbff(0x223)](_0x3afbff(0x209),_0x45242e);const _0x34ced0=await this[_0x3afbff(0x1d3)](_0x20f183,_0x45242e);this[_0x3afbff(0x1ed)]--,this[_0x3afbff(0x1ed)]<0x0&&(this[_0x3afbff(0x1ed)]=0x0),console['log'](_0x3afbff(0x22b),this[_0x3afbff(0x1ed)]);const {id:_0x42b09e,content:_0x7bce05,channel_id:_0x2c4168,attachments:attachments=[],timestamp:_0x37bffb}=_0x34ced0;if(!attachments[_0x3afbff(0x1b9)]||!attachments[0x0]['url'])throw new common_1[(_0x3afbff(0x19b))]('放大当前图片失败',common_1[_0x3afbff(0x211)][_0x3afbff(0x1c7)]);const {filename:_0x491e46,url:_0x472ba7,width:_0x59a72f,height:_0x41a87b,size:_0xdcbfb6}=attachments[0x0],_0xe60f18=this[_0x3afbff(0x1c5)][_0x3afbff(0x1ca)]([_0x3afbff(0x1c8)]);let _0x1a668d='';(!Number(_0xe60f18)||Number(_0xe60f18)===0x0)&&(_0x1a668d=await this[_0x3afbff(0x20b)][_0x3afbff(0x1a6)]({'filename':_0x491e46,'url':_0x472ba7}),console['log']('存入图片完成:\x20',_0x1a668d));const _0x4b88e7={'curIp':(0x0,utils_1[_0x3afbff(0x21e)])(_0xe83bdb),'userId':_0xe83bdb['user']['id'],'type':balance_constant_1[_0x3afbff(0x201)][_0x3afbff(0x1dc)],'prompt':_0x37e7c2,'answer':_0x1a668d,'model':'mj','extend':this[_0x3afbff(0x23f)](JSON[_0x3afbff(0x1e0)](_0x34ced0)),'message_id':_0x1dc092,'upscaleId':_0x42b09e,'variationId':_0x42b09e,'action':_0x3afbff(0x227),'orderId':_0x20f183[_0x3afbff(0x22d)],'isSaveImg':!Number(_0xe60f18)||Number(_0xe60f18)===0x0,'fileInfo':JSON[_0x3afbff(0x1e0)]({'width':_0x59a72f,'height':_0x41a87b,'size':_0xdcbfb6,'filename':_0x491e46,'cosUrl':_0x1a668d})};return await this[_0x3afbff(0x234)]['saveChatLog'](_0x4b88e7),_0x1a668d;}catch(_0x26bdb9){console[_0x3afbff(0x223)](_0x3afbff(0x1d0),_0x26bdb9),this[_0x3afbff(0x1ed)]--,this[_0x3afbff(0x1ed)]<0x0&&(this['queueCount']=0x0),console[_0x3afbff(0x223)]('放大图片任务异常中断\x20队列-1:\x20',this[_0x3afbff(0x1ed)]);throw new common_1[(_0x3afbff(0x19b))](_0x26bdb9[_0x3afbff(0x1ad)],common_1[_0x3afbff(0x211)][_0x3afbff(0x1c7)]);}}async[_0x37d9fd(0x23e)](_0x10e0d5,_0x1843d6){const _0x2e4906=_0x37d9fd;if(this[_0x2e4906(0x1ed)]>=0x3)throw new common_1[(_0x2e4906(0x19b))](_0x2e4906(0x206),common_1[_0x2e4906(0x211)]['BAD_REQUEST']);await this[_0x2e4906(0x1c3)](_0x1843d6),await this[_0x2e4906(0x22e)](_0x1843d6),this[_0x2e4906(0x1ed)]++,console[_0x2e4906(0x223)]('用户'+_0x1843d6[_0x2e4906(0x1fa)]['id']+'开始请求变换图片\x20队列+1:\x20',this[_0x2e4906(0x1ed)]);const {message_id:_0x1db341,orderId:_0x359ea9}=_0x10e0d5;try{const _0x58a362=await this[_0x2e4906(0x235)][_0x2e4906(0x1d6)]({'where':{'message_id':_0x1db341}});if(!_0x58a362)throw new common_1[(_0x2e4906(0x19b))](_0x2e4906(0x1d5),common_1[_0x2e4906(0x211)][_0x2e4906(0x1c7)]);const {prompt:_0x290ea4,extend:_0xcbdee}=_0x58a362;let _0x40a7e0=null;try{_0x40a7e0=JSON[_0x2e4906(0x1b8)](_0xcbdee);}catch(_0x250927){_0x40a7e0=[];}const {components:components=[]}=_0x40a7e0;if(!components[_0x2e4906(0x1b9)])throw new common_1[(_0x2e4906(0x19b))](_0x2e4906(0x205),common_1['HttpStatus'][_0x2e4906(0x1c7)]);const _0x3766e1=components[0x1][_0x2e4906(0x1b3)][_0x359ea9-0x1],{custom_id:_0x2ed7da}=_0x3766e1,_0xd39900=await this[_0x2e4906(0x235)]['find']({'where':{'variationId':(0x0,typeorm_1[_0x2e4906(0x1aa)])((0x0,typeorm_1['IsNull'])()),'prompt':(0x0,typeorm_1[_0x2e4906(0x1c1)])('%'+_0x290ea4+'%')}}),_0x2de55d=_0xd39900[_0x2e4906(0x204)](_0x3c0072=>_0x3c0072[_0x2e4906(0x1dd)]),_0x1f1e79={'message_id':_0x1db341,'custom_id':_0x2ed7da,'prompt':_0x290ea4,'orderId':_0x359ea9};await this[_0x2e4906(0x203)](_0x1f1e79);const _0x42b51c=await this[_0x2e4906(0x226)](_0x1f1e79,_0x2de55d);this['queueCount']--,this[_0x2e4906(0x1ed)]<0x0&&(this[_0x2e4906(0x1ed)]=0x0),console[_0x2e4906(0x223)]('变换图片任务结束\x20队列-1:\x20',this[_0x2e4906(0x1ed)]);const {id:_0x4346d4,content:_0x782cc,channel_id:_0x368556,attachments:attachments=[],timestamp:_0x375840}=_0x42b51c;if(!attachments[_0x2e4906(0x1b9)]||!attachments[0x0][_0x2e4906(0x1ae)])throw new common_1['HttpException'](_0x2e4906(0x1f2),common_1['HttpStatus'][_0x2e4906(0x1c7)]);const {filename:_0xa2ebd9,url:_0x19662c,width:_0x59a528,height:_0x2b5e71,size:_0xca5eb2}=attachments[0x0],_0x1fd5a4=this[_0x2e4906(0x1c5)][_0x2e4906(0x1ca)]([_0x2e4906(0x1c8)]);let _0x175070='';(!Number(_0x1fd5a4)||Number(_0x1fd5a4)===0x0)&&(_0x175070=await this['uploadService']['uploadFileFromUrl']({'filename':_0xa2ebd9,'url':_0x19662c}),console[_0x2e4906(0x223)](_0x2e4906(0x1f7),_0x175070));const _0x11e61f={'curIp':(0x0,utils_1[_0x2e4906(0x21e)])(_0x1843d6),'userId':_0x1843d6[_0x2e4906(0x1fa)]['id'],'type':balance_constant_1[_0x2e4906(0x201)]['PAINT_TYPE'],'prompt':_0x290ea4,'answer':_0x175070,'model':'mj','group':0x1,'extend':this[_0x2e4906(0x23f)](JSON['stringify'](_0x42b51c)),'message_id':_0x4346d4,'upscaleId':_0x4346d4,'variationId':_0x4346d4,'action':_0x2e4906(0x227),'orderId':_0x1f1e79[_0x2e4906(0x22d)],'isSaveImg':!Number(_0x1fd5a4)||Number(_0x1fd5a4)===0x0,'fileInfo':JSON[_0x2e4906(0x1e0)]({'width':_0x59a528,'height':_0x2b5e71,'size':_0xca5eb2,'filename':_0xa2ebd9,'cosUrl':_0x175070})};return await this[_0x2e4906(0x234)][_0x2e4906(0x1d9)](_0x11e61f),_0x175070;}catch(_0x54afec){console[_0x2e4906(0x223)](_0x2e4906(0x1d0),_0x54afec),this['queueCount']--,this['queueCount']<0x0&&(this['queueCount']=0x0),console['log'](_0x2e4906(0x23a),this['queueCount']);throw new common_1[(_0x2e4906(0x19b))](_0x54afec[_0x2e4906(0x1ad)],common_1[_0x2e4906(0x211)][_0x2e4906(0x1c7)]);}}async[_0x37d9fd(0x203)](_0x43869e){const _0x2efe69=_0x37d9fd,{message_id:_0xcca85c,custom_id:_0x94bb03}=_0x43869e,{application_id:_0x3006cb,guild_id:_0x34c489,channel_id:_0xf1b442,session_id:_0x597a1a,version:_0x589aa3,id:_0x2b6923,authorization:_0x198885,mjProxy:_0x57ebef}=await this[_0x2efe69(0x1bf)](),_0xf348=_0x57ebef==0x1?_0x2efe69(0x23b):_0x2efe69(0x221),_0x5a2b07={'authorization':_0x198885},_0x23cc81={'type':0x3,'guild_id':_0x34c489,'channel_id':_0xf1b442,'message_flags':0x0,'message_id':_0xcca85c,'application_id':_0x3006cb,'session_id':_0x597a1a,'data':{'component_type':0x2,'custom_id':_0x94bb03}};try{await axios_1[_0x2efe69(0x1fe)][_0x2efe69(0x207)](_0xf348,_0x23cc81,{'headers':_0x5a2b07}),console['log'](_0x2efe69(0x1d8));}catch(_0x2872f2){console['log'](_0x2efe69(0x1d0),_0x2872f2);throw new common_1['HttpException'](_0x2efe69(0x243),common_1[_0x2efe69(0x211)][_0x2efe69(0x1c7)]);}}async[_0x37d9fd(0x1d3)](_0x53ec4d,_0x934509){const _0x417985=_0x37d9fd,{message_id:_0x20302a,custom_id:_0x54bb7c,prompt:_0x44042,orderId:_0x2f62ec}=_0x53ec4d;let _0xd22e2f=null,_0x50f421=0x0;while(!_0xd22e2f&&_0x50f421<0xa){try{const _0x4b4870=Date[_0x417985(0x1be)](),_0x5ce678=await this[_0x417985(0x1b0)]();console[_0x417985(0x223)]('第\x20'+(_0x50f421+0x1)+_0x417985(0x224)+_0x5ce678['length']);_0x5ce678&&_0x5ce678[_0x417985(0x1b9)]&&(_0xd22e2f=await this['findCurrentEnlargeImgResult'](_0x5ce678,_0x53ec4d,_0x934509));const _0x2a4671=Date[_0x417985(0x1be)]()-_0x4b4870,_0x580f9f=0xbb8;await this[_0x417985(0x1e1)](Math['max'](_0x580f9f-_0x2a4671,0x0)),_0x50f421++;}catch(_0x3fe6e1){console[_0x417985(0x1ab)](_0x417985(0x1ec)+_0x3fe6e1[_0x417985(0x1d7)]);}}return _0xd22e2f;}async['pollForVariationResult'](_0x1812d7,_0x5990b8){const _0x70c301=_0x37d9fd,{message_id:_0x201f29,custom_id:_0x40c499,prompt:_0x20970a,orderId:_0x3f4559}=_0x1812d7;console[_0x70c301(0x223)]('开始轮询单张变换图片结果');let _0x28b49e=null,_0x3d92fc=0x0;while(!_0x28b49e&&_0x3d92fc<0xa){try{console[_0x70c301(0x223)]('第\x20'+(_0x3d92fc+0x1)+'\x20次开始查询[变换图片]');const _0x52fcfb=Date[_0x70c301(0x1be)](),_0x54ffb4=await this['queryMessageList']();_0x54ffb4&&_0x54ffb4[_0x70c301(0x1b9)]&&(_0x28b49e=await this[_0x70c301(0x200)](_0x54ffb4,_0x1812d7,_0x5990b8));const _0x3e5895=Date[_0x70c301(0x1be)]()-_0x52fcfb,_0x4c18c5=0x1f40;await this['sleep'](Math['max'](_0x4c18c5-_0x3e5895,0x0)),_0x3d92fc++;}catch(_0x309461){console[_0x70c301(0x1ab)](_0x70c301(0x1ec)+_0x309461[_0x70c301(0x1d7)]);}}if(!_0x28b49e)throw new common_1[(_0x70c301(0x19b))](_0x70c301(0x1b7),common_1[_0x70c301(0x211)][_0x70c301(0x1c7)]);return _0x28b49e;}async['findCurrentEnlargeImgResult'](_0x3112b1,_0x7cdcf9,_0x59bc84){const _0x17e3bf=_0x37d9fd,{message_id:_0x76ad40,custom_id:_0x1965f9,prompt:_0x5c3bb3,orderId:_0x2ab4d7}=_0x7cdcf9,_0xd89064=_0x5c3bb3[_0x17e3bf(0x1f8)](0x0,0xc);console[_0x17e3bf(0x223)]('本次放大图片的id:\x20',_0xd89064);const _0x1de8f8=_0x3112b1['find'](_0x574986=>{const _0x12505f=_0x17e3bf,{content:_0x59f06a}=_0x574986;if(!this[_0x12505f(0x1ff)](_0x59f06a))return![];const {prompt:_0x397a9c,order:_0x275d8a}=this[_0x12505f(0x1ff)](_0x59f06a);return _0x397a9c[_0x12505f(0x1c4)](_0xd89064)&&_0x7cdcf9['orderId']===_0x275d8a&&!_0x59bc84[_0x12505f(0x1c4)](_0x574986['id']);});return _0x1de8f8;}async[_0x37d9fd(0x200)](_0x404e0b,_0x10deab,_0x7ca668){const _0xb31241=_0x37d9fd,{message_id:_0x2fd2c7,custom_id:_0x5ed91e,prompt:_0x52f80d,orderId:_0x1a10b8}=_0x10deab,_0x33f97a=_0x52f80d[_0xb31241(0x1f8)](0x0,0xc),_0x191e37=_0x404e0b[_0xb31241(0x225)](_0x3cff56=>{const _0x1fee8=_0xb31241,{content:_0x5c3972}=_0x3cff56,_0x2768bf=_0x5c3972[_0x1fee8(0x1f5)](/\*\*(.+?)\*\*/),_0x3aa4d5=_0x2768bf?_0x2768bf[0x1]:'';if(!_0x3aa4d5)return![];return _0x3aa4d5['includes'](_0x33f97a)&&!_0x7ca668[_0x1fee8(0x1c4)](_0x3cff56['id']);});return _0x191e37;}async[_0x37d9fd(0x1da)](_0x4f666b,_0x502939,_0x2754a3){const _0xbbcaea=_0x37d9fd,_0x5331a4=await this[_0xbbcaea(0x1b0)](),_0x1ee174=await this[_0xbbcaea(0x1db)](_0x5331a4,_0x2754a3,_0x502939);if(_0x1ee174)return console[_0xbbcaea(0x223)](_0xbbcaea(0x1f9),_0x1ee174),_0x1ee174;const {application_id:_0xb79c61,guild_id:_0x51513e,channel_id:_0x5800b0,session_id:_0x36ec38,version:_0x3c79b1,id:_0x51d311,authorization:_0x22a8c6,mjProxy:_0x56f846}=await this[_0xbbcaea(0x1bf)](),_0xefab8={'type':0x2,'application_id':_0xb79c61,'guild_id':_0x51513e,'channel_id':_0x5800b0,'session_id':_0x36ec38,'data':{'version':_0x3c79b1,'id':_0x51d311,'name':_0xbbcaea(0x1df),'type':0x1,'options':[{'type':0x3,'name':'prompt','value':_0x4f666b}],'attachments':[]}};try{const _0x275f87=_0x56f846==0x1?_0xbbcaea(0x23b):_0xbbcaea(0x221),_0xef9e6b={'authorization':_0x22a8c6},_0x392ad9=await axios_1['default'][_0xbbcaea(0x207)](_0x275f87,_0xefab8,{'headers':_0xef9e6b});return console['log'](_0xbbcaea(0x1ba),_0x392ad9[_0xbbcaea(0x19e)]),![];}catch(_0x56b4d5){console['log'](_0xbbcaea(0x208),_0x56b4d5);throw new common_1[(_0xbbcaea(0x19b))]('绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...',common_1['HttpStatus'][_0xbbcaea(0x1c7)]);}}async[_0x37d9fd(0x212)](_0xc429a8,_0x5bf21a,_0x4dbc88){const _0x40a89c=_0x37d9fd;console['log'](_0x40a89c(0x1a3));const _0x42119e=Date[_0x40a89c(0x1be)]();try{const _0x391017=0xd,_0x2f591c=0x2ee0,_0x15520b=0x1388,_0x19260b=0x3c*0x3e8;let _0x245cf6=0x0,_0x30affb=![],_0x23c6fe=null;while(!_0x23c6fe&&_0x245cf6<_0x391017){console[_0x40a89c(0x223)]('第\x20'+(_0x245cf6+0x1)+_0x40a89c(0x1a2));Date[_0x40a89c(0x1be)]()-_0x42119e>=_0x19260b&&(_0x30affb=!![]);await this[_0x40a89c(0x1e1)](_0x30affb?_0x15520b:_0x2f591c);const _0x3743ac=await this[_0x40a89c(0x1b0)]();_0x23c6fe=await this['findCurrentPromptResult'](_0x3743ac,_0x4dbc88,_0x5bf21a),_0x245cf6++;}if(!_0x23c6fe)throw new common_1[(_0x40a89c(0x19b))](_0x40a89c(0x19f),common_1[_0x40a89c(0x211)][_0x40a89c(0x1c7)]);const _0x58a12a=Date[_0x40a89c(0x1be)]();return console[_0x40a89c(0x223)](_0x40a89c(0x1ee)+Math[_0x40a89c(0x237)]((_0x58a12a-_0x42119e)/0x3e8)+'\x20S'),_0x23c6fe;}catch(_0x417c6e){console[_0x40a89c(0x1ab)](_0x417c6e[_0x40a89c(0x1d7)]);throw new common_1[(_0x40a89c(0x19b))](_0x40a89c(0x231),common_1[_0x40a89c(0x211)][_0x40a89c(0x1f1)]);}}async[_0x37d9fd(0x1db)](_0x2215e6,_0x4c866f,_0x520189){const _0x461516=_0x37d9fd;if(!_0x2215e6||!_0x2215e6[_0x461516(0x1b9)])return;console['log'](_0x461516(0x22f),_0x4c866f);const _0xc49e87=_0x2215e6[_0x461516(0x225)](_0xdc1075=>{const _0x2c35fe=_0x461516,{attachments:attachments=[],content:_0x2e1312,edited_timestamp:_0x2970f1}=_0xdc1075;return _0x2e1312[_0x2c35fe(0x1c4)](_0x4c866f)&&attachments[_0x2c35fe(0x1b9)]>0x0&&!_0x2970f1&&!_0x520189[_0x2c35fe(0x1c4)](_0xdc1075['id']);});return _0xc49e87||null;}async['queryMessageList'](){const _0x47961c=_0x37d9fd;try{const {application_id:_0xe43edd,guild_id:_0x4e4802,channel_id:_0x9e7db9,session_id:_0x2ece23,version:_0x2c441f,id:_0x8d8ec5,authorization:_0x27bde6,mjProxy:_0x4d98af}=await this[_0x47961c(0x1bf)](),_0x40658d=_0x4d98af==0x1?_0x47961c(0x214)+_0x9e7db9:_0x47961c(0x218)+_0x9e7db9+'/messages?limit=50',_0x572ca7={'authorization':_0x27bde6},_0x5e3c40=await axios_1['default'][_0x47961c(0x229)](_0x40658d,{'headers':_0x572ca7});return _0x5e3c40[_0x47961c(0x19e)];}catch(_0x3a339e){console['log'](_0x47961c(0x22c),_0x3a339e);throw new common_1[(_0x47961c(0x19b))](_0x47961c(0x1bb),common_1[_0x47961c(0x211)][_0x47961c(0x1c7)]);}}async['sleep'](_0x446208){return new Promise(_0x4668eb=>setTimeout(_0x4668eb,_0x446208));}['extractContent'](_0x4bc023){const _0x57163c=_0x37d9fd,_0xe24235=_0x4bc023['match'](/\*\*(.+?)\*\*/),_0x47e250=_0x4bc023[_0x57163c(0x1f5)](/- Image #(\d+)/);if(!_0xe24235||!_0x47e250)return null;const _0x2ed5dc=_0xe24235[0x1],_0x355908=parseInt(_0x47e250[0x1]);return{'prompt':_0x2ed5dc,'order':_0x355908};}async[_0x37d9fd(0x1bf)](){const _0x29faef=_0x37d9fd,_0x5a9f95=await this[_0x29faef(0x1c5)]['getConfigs'](['mjId','mjApplicationId','mjGuildId',_0x29faef(0x1bd),_0x29faef(0x1b6),_0x29faef(0x1af),_0x29faef(0x1ac),'mjRateLimit',_0x29faef(0x215)]),_0x1288cf={'application_id':_0x5a9f95[_0x29faef(0x20c)],'guild_id':_0x5a9f95[_0x29faef(0x1ea)],'channel_id':_0x5a9f95[_0x29faef(0x1bd)],'session_id':_0x5a9f95[_0x29faef(0x1b6)],'version':_0x5a9f95[_0x29faef(0x1af)],'id':_0x5a9f95[_0x29faef(0x245)],'authorization':_0x5a9f95[_0x29faef(0x1ac)],'mjRateLimit':_0x5a9f95[_0x29faef(0x21a)],'mjProxy':_0x5a9f95[_0x29faef(0x215)]||0x0};return _0x1288cf;}[_0x37d9fd(0x23f)](_0x39c2a1){const _0x438595=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x39c2a1['replace'](_0x438595,'');}async['checkAuth'](_0x441247){const _0x2bc17e=_0x37d9fd,_0x58c85c=await this[_0x2bc17e(0x217)][_0x2bc17e(0x1d6)]({'where':{'userId':_0x441247['user']['id']}}),{id:_0x2b27a1,balance:_0x1e10d7}=_0x58c85c;if(!_0x1e10d7||(_0x58c85c===null||_0x58c85c===void 0x0?void 0x0:_0x58c85c[_0x2bc17e(0x1e7)])<0x1)throw new common_1[(_0x2bc17e(0x19b))]('您当前暂无MJ绘画余额！！！',common_1[_0x2bc17e(0x211)][_0x2bc17e(0x1c7)]);}async[_0x37d9fd(0x1de)](_0x47d902){const _0x23f212=_0x37d9fd,{id:_0x50cc77,role:_0x268ce3}=_0x47d902[_0x23f212(0x1fa)];!this[_0x23f212(0x241)][_0x50cc77]?this[_0x23f212(0x241)][_0x50cc77]=0x1:this['freeQueueUsers'][_0x50cc77]=this[_0x23f212(0x241)][_0x50cc77]+0x1,console['log'](_0x23f212(0x1a0)+_0x50cc77+_0x23f212(0x1cf),this['freeQueueUsers'][_0x50cc77]);}async[_0x37d9fd(0x22e)](_0x15e444){const _0x44cd63=_0x37d9fd,{id:_0x4029ca,role:_0x218d6a}=_0x15e444[_0x44cd63(0x1fa)];if([_0x44cd63(0x232),_0x44cd63(0x20d)][_0x44cd63(0x1c4)](_0x218d6a))return!![];const {mjRateLimit:_0x542869}=await this[_0x44cd63(0x1bf)]();if(this[_0x44cd63(0x1c6)][_0x4029ca]){const _0x105f16=this[_0x44cd63(0x1c6)][_0x4029ca];if(_0x105f16>Date[_0x44cd63(0x1be)]()){console[_0x44cd63(0x223)]('当前用户\x20'+_0x4029ca+_0x44cd63(0x220));throw new common_1[(_0x44cd63(0x19b))]('由于速率限制、当前普通用户限制为'+_0x542869+_0x44cd63(0x20e),common_1['HttpStatus'][_0x44cd63(0x1c7)]);}else this['rateLimits'][_0x4029ca]=Date['now']()+Number(_0x542869)*0x3e8;}else{const _0x425489=Date['now']();this[_0x44cd63(0x1c6)][_0x4029ca]=_0x425489+0x3e8*Number(_0x542869);}}async[_0x37d9fd(0x199)](_0x3315bd){const _0x395e1a=_0x37d9fd;await this[_0x395e1a(0x217)][_0x395e1a(0x1c2)]()[_0x395e1a(0x1b1)](balance_entity_1[_0x395e1a(0x1e4)])[_0x395e1a(0x242)]({'balance':()=>'balance\x20-\x201'})[_0x395e1a(0x1e5)](_0x395e1a(0x1fd),{'userId':_0x3315bd['user']['id']})[_0x395e1a(0x1cc)]();}async[_0x37d9fd(0x1d2)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x37d9fd(0x222)])(),__param(0x0,(0x0,typeorm_2[_0x37d9fd(0x244)])(chatLog_entity_1[_0x37d9fd(0x1e2)])),__param(0x1,(0x0,typeorm_2[_0x37d9fd(0x244)])(balance_entity_1[_0x37d9fd(0x1e4)])),__metadata('design:paramtypes',[typeorm_1[_0x37d9fd(0x228)],typeorm_1[_0x37d9fd(0x228)],upload_service_1[_0x37d9fd(0x1a4)],chatLog_service_1['ChatLogService'],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0x37d9fd(0x20f)],badwords_service_1[_0x37d9fd(0x1d4)]])],MjService),exports[_0x37d9fd(0x1b4)]=MjService;