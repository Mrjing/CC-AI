'use strict';const _0x2d8223=_0x57aa;(function(_0x3b1514,_0x1eeacc){const _0x5170e5=_0x57aa,_0x529eb7=_0x3b1514();while(!![]){try{const _0x5bd9ea=-parseInt(_0x5170e5(0x16e))/0x1+parseInt(_0x5170e5(0x1a8))/0x2*(parseInt(_0x5170e5(0x160))/0x3)+-parseInt(_0x5170e5(0x195))/0x4+parseInt(_0x5170e5(0x17f))/0x5*(-parseInt(_0x5170e5(0x115))/0x6)+-parseInt(_0x5170e5(0x1ad))/0x7+parseInt(_0x5170e5(0x1b4))/0x8+-parseInt(_0x5170e5(0x1aa))/0x9*(-parseInt(_0x5170e5(0x1b0))/0xa);if(_0x5bd9ea===_0x1eeacc)break;else _0x529eb7['push'](_0x529eb7['shift']());}catch(_0x160eab){_0x529eb7['push'](_0x529eb7['shift']());}}}(_0x20cf,0xaa8a3));function _0x57aa(_0x11f21e,_0x85ae5f){const _0x20cfc1=_0x20cf();return _0x57aa=function(_0x57aa22,_0x2a8d5b){_0x57aa22=_0x57aa22-0x110;let _0x1aabcf=_0x20cfc1[_0x57aa22];return _0x1aabcf;},_0x57aa(_0x11f21e,_0x85ae5f);}var __decorate=this&&this[_0x2d8223(0x1c0)]||function(_0x3ff536,_0x50f341,_0xd55732,_0x2ab106){const _0x376e2e=_0x2d8223;var _0x7a2558=arguments[_0x376e2e(0x171)],_0x5acfe3=_0x7a2558<0x3?_0x50f341:_0x2ab106===null?_0x2ab106=Object[_0x376e2e(0x12a)](_0x50f341,_0xd55732):_0x2ab106,_0x916603;if(typeof Reflect===_0x376e2e(0x139)&&typeof Reflect[_0x376e2e(0x165)]===_0x376e2e(0x180))_0x5acfe3=Reflect[_0x376e2e(0x165)](_0x3ff536,_0x50f341,_0xd55732,_0x2ab106);else{for(var _0x48674c=_0x3ff536[_0x376e2e(0x171)]-0x1;_0x48674c>=0x0;_0x48674c--)if(_0x916603=_0x3ff536[_0x48674c])_0x5acfe3=(_0x7a2558<0x3?_0x916603(_0x5acfe3):_0x7a2558>0x3?_0x916603(_0x50f341,_0xd55732,_0x5acfe3):_0x916603(_0x50f341,_0xd55732))||_0x5acfe3;}return _0x7a2558>0x3&&_0x5acfe3&&Object[_0x376e2e(0x142)](_0x50f341,_0xd55732,_0x5acfe3),_0x5acfe3;},__metadata=this&&this[_0x2d8223(0x173)]||function(_0x20c0e9,_0x5aa6fc){const _0x345a9d=_0x2d8223;if(typeof Reflect===_0x345a9d(0x139)&&typeof Reflect['metadata']===_0x345a9d(0x180))return Reflect[_0x345a9d(0x15d)](_0x20c0e9,_0x5aa6fc);},__param=this&&this[_0x2d8223(0x174)]||function(_0x3bf41e,_0x329c60){return function(_0x285249,_0x25a6d1){_0x329c60(_0x285249,_0x25a6d1,_0x3bf41e);};};function _0x20cf(){const _0x4311e0=['findCurrentPromptResult','mjChannelId','__decorate','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','baiduFanyiAppId','历史记录中不存在当前图片、请确认您放大的图片是否存在','使用的次数：','enlarge','查询绘制结果失败...','where','draw','GlobalConfigService','6840858cUnxPV','@nestjs/common','max','@nestjs/typeorm','design:paramtypes','InjectRepository','queueCount','uploadFileFromUrl','freeQueueUsers','../../common/utils','map','saveChatLog','历史这些id已经被获取过了\x20不能拿了:\x20','Injectable','message_id','开始请求放大图片\x20队列+1:\x20','Repository','get','stringify','有历史信息之间返回:\x20','\x20请求过于频繁！','getOwnPropertyDescriptor','开始轮询单张变换图片结果','mjRateLimit','find','variationSingleImg','mjVersion','由于速率限制、当前普通用户限制为','Like','fanyiService','now','查询期间出现错误：','mjGuildId','checkRateLimit','FanyiService','orderId','object','mjAuthorization','本次比对的随机ID:\x20','findCurrentVariationImgResult','HttpException','error','substring','mjservice','绘画失败','defineProperty','BAD_REQUEST','绘画任务开始','变换图片任务结束\x20队列-1:\x20','pollForUpscaleResult','变换当前图片超时！','removeEmoji','axios:\x20','INTERNAL_SERVER_ERROR','../chatLog/chatLog.entity','../badwords/badwords.service','floor','badwordsService','Not','/messages?limit=50','chatLogService','sendSmInteractions','mjProxy','update','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','发送放大指令成功','当前用户\x20','BadwordsService','网络连接失败，请稍后再试！','prompt','DeductionKey','HttpStatus','metadata','sendDrawInteractions','findCurrentEnlargeImgResult','12315HxScZX','开始请求用户','findOne','放大图片任务结束\x20队列-1:\x20','parse','decorate','rateLimits','data','drawWorking','includes','本次放大图片的id:\x20','push','log','您当前暂无MJ绘画余额！！！','1191012oDfNtd','deductBalance','error:\x20','length','chatLogEntity','__metadata','__param','getClientIp','uploadService','replace','放大custom_id:\x20','变换当前图片失败','放大图片任务异常中断\x20队列-1:\x20','typeorm','__esModule','\x20次开始查询','BalanceEntity','5VVquDU','function','randomId:\x20','response','\x20队列+1:\x20','imagine','user','post','pollForResult','../userBalance/balance.entity','axios','MjService','拿到了远程地址:\x20','pollForVariationResult','存入图片完成:\x20','绘画超时，请稍后再试！','balance\x20-\x201','IsNull','enlargeWorking','url','extractContent','admin','1628372yoMqMm','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','queryMessageList','checkBadWords','axios\x20get:\x20','getConfigs','mjApplicationId','历史中存在当前图片、直接获取！','mjNotSaveImg','http://172.247.48.137:8000/mj/list?channel_id=','https://discord.com/api/v9/interactions','components','match','default','\x20次开始查询\x20=>\x20当前查询结果：','绘图指令完成','checkAuth','../upload/upload.service','sleep','34xosDmQ','../fanyi/fanyi.service','602271WYBqWE','../globalConfig/globalConfig.service','upscaleSingleImg','3779839DXHFvp','message','convertToEnglish','380tbDhuT','getMjDefaultParams','filter','../../common/constants/balance.constant','10912392YVdzVX','https://discord.com/api/v9/channels/','balanceEntity','createQueryBuilder','当前用户','execute','PAINT_TYPE','checkFree','globalConfigService','http://172.247.48.137:8000/mj/draw'];_0x20cf=function(){return _0x4311e0;};return _0x20cf();}Object[_0x2d8223(0x142)](exports,_0x2d8223(0x17c),{'value':!![]}),exports['MjService']=void 0x0;const globalConfig_service_1=require(_0x2d8223(0x1ab)),upload_service_1=require(_0x2d8223(0x1a6)),common_1=require(_0x2d8223(0x116)),axios_1=require(_0x2d8223(0x189)),chatLog_service_1=require('../chatLog/chatLog.service'),balance_constant_1=require(_0x2d8223(0x1b3)),utils_1=require(_0x2d8223(0x11e)),chatLog_entity_1=require(_0x2d8223(0x14b)),typeorm_1=require(_0x2d8223(0x17b)),typeorm_2=require(_0x2d8223(0x118)),balance_entity_1=require(_0x2d8223(0x188)),fanyi_service_1=require(_0x2d8223(0x1a9)),badwords_service_1=require(_0x2d8223(0x14c));let MjService=class MjService{constructor(_0x39dcd4,_0x3c320e,_0x2e2efe,_0x4cc8e0,_0x351aaa,_0x296c88,_0x24f515){const _0x3a5a40=_0x2d8223;this[_0x3a5a40(0x172)]=_0x39dcd4,this[_0x3a5a40(0x1b6)]=_0x3c320e,this[_0x3a5a40(0x176)]=_0x2e2efe,this[_0x3a5a40(0x151)]=_0x4cc8e0,this['globalConfigService']=_0x351aaa,this[_0x3a5a40(0x132)]=_0x296c88,this[_0x3a5a40(0x14e)]=_0x24f515,this[_0x3a5a40(0x166)]={},this[_0x3a5a40(0x168)]=[],this[_0x3a5a40(0x191)]=[],this['queueCount']=0x0,this['freeQueueUsers']={};}async['mjDraw'](_0x20c5b9){const _0x19b8c4=_0x2d8223,{jobId:_0x2047fb,prompt:_0xa67d6b,startTime:_0x725071,userId:_0x3161ee}=_0x20c5b9;return console[_0x19b8c4(0x16c)](_0x19b8c4(0x144),_0x19b8c4(0x140)),await new Promise(_0x415be=>setTimeout(_0x415be,0x1388)),{'a':0x1,'b':0x2};}async[_0x2d8223(0x113)](_0x506b8c,_0xcab634){const _0x59abc2=_0x2d8223;await this[_0x59abc2(0x1a5)](_0xcab634),await this[_0x59abc2(0x14e)][_0x59abc2(0x198)](_0x506b8c[_0x59abc2(0x15a)],_0xcab634[_0x59abc2(0x185)]['id']);const _0x1393d3=_0x506b8c['prompt'];let _0x338e89=_0x506b8c[_0x59abc2(0x15a)];const {baiduFanyiAppId:_0x275673,baiduFanyiSecret:_0x5caf3f}=await this[_0x59abc2(0x1bc)]['getConfigs']([_0x59abc2(0x1c2),'baiduFanyiSecret']);_0x275673&&_0x5caf3f&&(_0x338e89=await this[_0x59abc2(0x132)][_0x59abc2(0x1af)](_0x1393d3));const _0x5ae309='['+(0x0,utils_1['createRandomUid'])()+']',_0x501f51=_0x5ae309+'\x20'+_0x338e89;console[_0x59abc2(0x16c)](_0x59abc2(0x181),_0x5ae309),console[_0x59abc2(0x16c)]('prompt\x20-------->\x20\x20',_0x501f51);const _0x15e3e8=this[_0x59abc2(0x168)][_0x59abc2(0x12d)](_0x500271=>_0x500271[_0x59abc2(0x169)](_0x506b8c['prompt']));if(_0x15e3e8)throw new common_1[(_0x59abc2(0x13d))]('当前提示词已经在任务队列中了、请勿重复提交。。。',common_1[_0x59abc2(0x15c)][_0x59abc2(0x143)]);if(this[_0x59abc2(0x11b)]>=0x3)throw new common_1[(_0x59abc2(0x13d))](_0x59abc2(0x1c1),common_1['HttpStatus'][_0x59abc2(0x143)]);await this['checkRateLimit'](_0xcab634),this[_0x59abc2(0x11b)]++,console[_0x59abc2(0x16c)](_0x59abc2(0x161)+_0xcab634[_0x59abc2(0x185)]['id']+_0x59abc2(0x183),this[_0x59abc2(0x11b)]);try{const _0x4958d5=await this['chatLogEntity'][_0x59abc2(0x12d)]({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0x501f51+'%')}}),_0x188757=_0x4958d5['map'](_0x2adb33=>_0x2adb33[_0x59abc2(0x123)]);this[_0x59abc2(0x168)][_0x59abc2(0x16b)](_0x501f51);let _0x311733;const _0x192d21=await this[_0x59abc2(0x15e)](_0x501f51,_0x188757,_0x5ae309);_0x192d21?(console[_0x59abc2(0x16c)](_0x59abc2(0x19c)),_0x311733=_0x192d21):_0x311733=await this[_0x59abc2(0x187)](_0x501f51,_0x188757,_0x5ae309);this[_0x59abc2(0x11b)]--,this[_0x59abc2(0x11b)]<0x0&&(this['queueCount']=0x0),console['log']('绘制图片任务结束\x20队列-1:\x20',this['queueCount']);const {id:_0x1cf154,content:_0x4367d5,channel_id:_0x4bdeb9,attachments:attachments=[],timestamp:_0xd0e13}=_0x311733;if(!attachments[_0x59abc2(0x171)]||!attachments[0x0][_0x59abc2(0x192)])throw new common_1[(_0x59abc2(0x13d))](_0x59abc2(0x141),common_1[_0x59abc2(0x15c)]['BAD_REQUEST']);const {filename:_0x57dc0b,url:_0x46aab9,width:_0x2be90b,height:_0x3c186f,size:_0x427bbb}=attachments[0x0];console[_0x59abc2(0x16c)](_0x59abc2(0x18b),_0x46aab9);const _0x118189=this['globalConfigService'][_0x59abc2(0x19a)]([_0x59abc2(0x19d)]);let _0x2f17cf='';(!Number(_0x118189)||Number(_0x118189)===0x0)&&(_0x2f17cf=await this['uploadService'][_0x59abc2(0x11c)]({'filename':_0x57dc0b,'url':_0x46aab9}),console[_0x59abc2(0x16c)]('存入图片完成:\x20',_0x2f17cf));const _0x2fadc9={'curIp':(0x0,utils_1[_0x59abc2(0x175)])(_0xcab634),'userId':_0xcab634[_0x59abc2(0x185)]['id'],'type':balance_constant_1[_0x59abc2(0x15b)]['PAINT_TYPE'],'prompt':_0x501f51,'answer':_0x2f17cf,'model':'mj','extend':this[_0x59abc2(0x148)](JSON[_0x59abc2(0x127)](_0x311733)),'message_id':_0x1cf154,'variationId':_0x1cf154,'upscaleId':_0x1cf154,'group':0x1,'isSaveImg':!Number(_0x118189)||Number(_0x118189)===0x0,'fileInfo':JSON['stringify']({'width':_0x2be90b,'height':_0x3c186f,'size':_0x427bbb,'filename':_0x57dc0b,'cosUrl':_0x2f17cf})};return await this['chatLogService']['saveChatLog'](_0x2fadc9),await this[_0x59abc2(0x16f)](_0xcab634),this[_0x59abc2(0x168)]=this['drawWorking'][_0x59abc2(0x1b2)](_0x320eb1=>_0x320eb1!==_0x506b8c[_0x59abc2(0x15a)]),_0x2f17cf;}catch(_0x3a91d1){this[_0x59abc2(0x11b)]--,this['queueCount']<0x0&&(this[_0x59abc2(0x11b)]=0x0),console[_0x59abc2(0x16c)]('绘制图片任务异常中断\x20队列-1:\x20',this[_0x59abc2(0x11b)]),this[_0x59abc2(0x168)]=this[_0x59abc2(0x168)][_0x59abc2(0x1b2)](_0x522416=>_0x522416!==_0x506b8c[_0x59abc2(0x15a)]);throw new common_1[(_0x59abc2(0x13d))](_0x3a91d1[_0x59abc2(0x182)],common_1[_0x59abc2(0x15c)]['BAD_REQUEST']);}}async[_0x2d8223(0x1ac)](_0x23f9bd,_0x2c4c0e){const _0x327f9d=_0x2d8223;if(this['queueCount']>=0x3)throw new common_1['HttpException'](_0x327f9d(0x1c1),common_1[_0x327f9d(0x15c)][_0x327f9d(0x143)]);this[_0x327f9d(0x11b)]++,console[_0x327f9d(0x16c)]('用户'+_0x2c4c0e[_0x327f9d(0x185)]['id']+_0x327f9d(0x124),this[_0x327f9d(0x11b)]);const {message_id:_0x1b2715,orderId:_0x4d629}=_0x23f9bd;try{const _0x524251=await this['chatLogEntity'][_0x327f9d(0x162)]({'where':{'message_id':_0x1b2715}});if(!_0x524251)throw new common_1[(_0x327f9d(0x13d))](_0x327f9d(0x1c3),common_1[_0x327f9d(0x15c)][_0x327f9d(0x143)]);const _0x4796e3=await this[_0x327f9d(0x172)][_0x327f9d(0x162)]({'where':{'upscaleId':_0x1b2715,'action':_0x327f9d(0x110),'orderId':_0x4d629}});if(_0x4796e3)throw new common_1[(_0x327f9d(0x13d))]('当前图片已经放大过了、请勿重复放大!',common_1[_0x327f9d(0x15c)][_0x327f9d(0x143)]);const {prompt:_0x1df544,extend:_0x5234b1}=_0x524251;let _0x5dda1=null;try{_0x5dda1=JSON['parse'](_0x5234b1);}catch(_0x22d7f8){_0x5dda1=[];}const {components:components=[]}=_0x5dda1;if(!components[_0x327f9d(0x171)])throw new common_1[(_0x327f9d(0x13d))]('当前图片没有绘画信息、无法放大!',common_1[_0x327f9d(0x15c)][_0x327f9d(0x143)]);const _0x43a5be=components[0x0][_0x327f9d(0x1a0)][_0x4d629-0x1],{custom_id:_0x2b5f03}=_0x43a5be;console[_0x327f9d(0x16c)](_0x327f9d(0x178),_0x2b5f03);const _0x3aa200={'message_id':_0x1b2715,'custom_id':_0x2b5f03,'prompt':_0x1df544,'orderId':_0x4d629};await this[_0x327f9d(0x152)](_0x3aa200),console[_0x327f9d(0x16c)](_0x327f9d(0x156));const _0x54578c=await this[_0x327f9d(0x172)]['find']({'where':{'prompt':(0x0,typeorm_1[_0x327f9d(0x131)])('%'+_0x1df544+'%')}}),_0x4af7cf=_0x54578c[_0x327f9d(0x11f)](_0x219703=>_0x219703['message_id']);console[_0x327f9d(0x16c)](_0x327f9d(0x121),_0x4af7cf);const _0x3e41a0=await this[_0x327f9d(0x146)](_0x3aa200,_0x4af7cf);this[_0x327f9d(0x11b)]--,this[_0x327f9d(0x11b)]<0x0&&(this[_0x327f9d(0x11b)]=0x0),console[_0x327f9d(0x16c)](_0x327f9d(0x163),this[_0x327f9d(0x11b)]);const {id:_0xca2dd7,content:_0x353f4a,channel_id:_0x3fa108,attachments:attachments=[],timestamp:_0x32411c}=_0x3e41a0;if(!attachments['length']||!attachments[0x0][_0x327f9d(0x192)])throw new common_1[(_0x327f9d(0x13d))]('放大当前图片失败',common_1[_0x327f9d(0x15c)][_0x327f9d(0x143)]);const {filename:_0x59198f,url:_0x4d9acf,width:_0x3c33c2,height:_0x484d12,size:_0x4955fc}=attachments[0x0],_0x4894c6=this[_0x327f9d(0x1bc)][_0x327f9d(0x19a)]([_0x327f9d(0x19d)]);let _0x47b515='';(!Number(_0x4894c6)||Number(_0x4894c6)===0x0)&&(_0x47b515=await this[_0x327f9d(0x176)][_0x327f9d(0x11c)]({'filename':_0x59198f,'url':_0x4d9acf}),console[_0x327f9d(0x16c)](_0x327f9d(0x18d),_0x47b515));const _0x10ec43={'curIp':(0x0,utils_1['getClientIp'])(_0x2c4c0e),'userId':_0x2c4c0e[_0x327f9d(0x185)]['id'],'type':balance_constant_1[_0x327f9d(0x15b)]['PAINT_TYPE'],'prompt':_0x1df544,'answer':_0x47b515,'model':'mj','extend':this[_0x327f9d(0x148)](JSON[_0x327f9d(0x127)](_0x3e41a0)),'message_id':_0x1b2715,'upscaleId':_0xca2dd7,'variationId':_0xca2dd7,'action':'enlarge','orderId':_0x3aa200['orderId'],'isSaveImg':!Number(_0x4894c6)||Number(_0x4894c6)===0x0,'fileInfo':JSON['stringify']({'width':_0x3c33c2,'height':_0x484d12,'size':_0x4955fc,'filename':_0x59198f,'cosUrl':_0x47b515})};return await this[_0x327f9d(0x151)]['saveChatLog'](_0x10ec43),_0x47b515;}catch(_0x249b50){console[_0x327f9d(0x16c)](_0x327f9d(0x170),_0x249b50),this[_0x327f9d(0x11b)]--,this['queueCount']<0x0&&(this[_0x327f9d(0x11b)]=0x0),console[_0x327f9d(0x16c)](_0x327f9d(0x17a),this[_0x327f9d(0x11b)]);throw new common_1[(_0x327f9d(0x13d))](_0x249b50['response'],common_1[_0x327f9d(0x15c)]['BAD_REQUEST']);}}async[_0x2d8223(0x12e)](_0x5dfab8,_0x522218){const _0x4bf344=_0x2d8223;if(this[_0x4bf344(0x11b)]>=0x3)throw new common_1[(_0x4bf344(0x13d))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x4bf344(0x15c)]['BAD_REQUEST']);await this[_0x4bf344(0x1a5)](_0x522218),await this[_0x4bf344(0x136)](_0x522218),this[_0x4bf344(0x11b)]++,console[_0x4bf344(0x16c)]('用户'+_0x522218['user']['id']+'开始请求变换图片\x20队列+1:\x20',this[_0x4bf344(0x11b)]);const {message_id:_0x302318,orderId:_0x3d277c}=_0x5dfab8;try{const _0x1223e2=await this[_0x4bf344(0x172)]['findOne']({'where':{'message_id':_0x302318}});if(!_0x1223e2)throw new common_1['HttpException'](_0x4bf344(0x155),common_1[_0x4bf344(0x15c)][_0x4bf344(0x143)]);const {prompt:_0x7c0935,extend:_0x3a9320}=_0x1223e2;let _0x500060=null;try{_0x500060=JSON[_0x4bf344(0x164)](_0x3a9320);}catch(_0x4816e6){_0x500060=[];}const {components:components=[]}=_0x500060;if(!components[_0x4bf344(0x171)])throw new common_1[(_0x4bf344(0x13d))]('当前图片没有绘画信息、无法变体!',common_1[_0x4bf344(0x15c)][_0x4bf344(0x143)]);const _0x18836d=components[0x1]['components'][_0x3d277c-0x1],{custom_id:_0x2dc4b7}=_0x18836d,_0x4a9586=await this[_0x4bf344(0x172)][_0x4bf344(0x12d)]({'where':{'variationId':(0x0,typeorm_1[_0x4bf344(0x14f)])((0x0,typeorm_1[_0x4bf344(0x190)])()),'prompt':(0x0,typeorm_1[_0x4bf344(0x131)])('%'+_0x7c0935+'%')}}),_0x3e9619=_0x4a9586[_0x4bf344(0x11f)](_0x375411=>_0x375411['variationId']),_0x1a4569={'message_id':_0x302318,'custom_id':_0x2dc4b7,'prompt':_0x7c0935,'orderId':_0x3d277c};await this['sendSmInteractions'](_0x1a4569);const _0x51ce5c=await this[_0x4bf344(0x18c)](_0x1a4569,_0x3e9619);this[_0x4bf344(0x11b)]--,this[_0x4bf344(0x11b)]<0x0&&(this['queueCount']=0x0),console['log'](_0x4bf344(0x145),this[_0x4bf344(0x11b)]);const {id:_0x5ee8b7,content:_0x412992,channel_id:_0xb97ce0,attachments:attachments=[],timestamp:_0x2210dd}=_0x51ce5c;if(!attachments[_0x4bf344(0x171)]||!attachments[0x0][_0x4bf344(0x192)])throw new common_1[(_0x4bf344(0x13d))](_0x4bf344(0x179),common_1['HttpStatus'][_0x4bf344(0x143)]);const {filename:_0xfe4f1a,url:_0x1456e3,width:_0x5db251,height:_0x47bdb4,size:_0x277dc7}=attachments[0x0],_0x9d55df=this[_0x4bf344(0x1bc)]['getConfigs']([_0x4bf344(0x19d)]);let _0x2e2610='';(!Number(_0x9d55df)||Number(_0x9d55df)===0x0)&&(_0x2e2610=await this[_0x4bf344(0x176)][_0x4bf344(0x11c)]({'filename':_0xfe4f1a,'url':_0x1456e3}),console[_0x4bf344(0x16c)](_0x4bf344(0x18d),_0x2e2610));const _0x11b939={'curIp':(0x0,utils_1[_0x4bf344(0x175)])(_0x522218),'userId':_0x522218[_0x4bf344(0x185)]['id'],'type':balance_constant_1[_0x4bf344(0x15b)][_0x4bf344(0x1ba)],'prompt':_0x7c0935,'answer':_0x2e2610,'model':'mj','group':0x1,'extend':this[_0x4bf344(0x148)](JSON[_0x4bf344(0x127)](_0x51ce5c)),'message_id':_0x5ee8b7,'upscaleId':_0x5ee8b7,'variationId':_0x5ee8b7,'action':'enlarge','orderId':_0x1a4569['orderId'],'isSaveImg':!Number(_0x9d55df)||Number(_0x9d55df)===0x0,'fileInfo':JSON['stringify']({'width':_0x5db251,'height':_0x47bdb4,'size':_0x277dc7,'filename':_0xfe4f1a,'cosUrl':_0x2e2610})};return await this['chatLogService'][_0x4bf344(0x120)](_0x11b939),_0x2e2610;}catch(_0x1062be){console['log']('error:\x20',_0x1062be),this[_0x4bf344(0x11b)]--,this[_0x4bf344(0x11b)]<0x0&&(this['queueCount']=0x0),console[_0x4bf344(0x16c)]('变化图片任务异常中断\x20队列-1:\x20',this[_0x4bf344(0x11b)]);throw new common_1[(_0x4bf344(0x13d))](_0x1062be[_0x4bf344(0x182)],common_1[_0x4bf344(0x15c)][_0x4bf344(0x143)]);}}async[_0x2d8223(0x152)](_0x1c7df9){const _0x5dc035=_0x2d8223,{message_id:_0x4876af,custom_id:_0x379093}=_0x1c7df9,{application_id:_0x33637d,guild_id:_0x2d5c21,channel_id:_0x272d3b,session_id:_0x625a6c,version:_0xed2b03,id:_0x466ce1,authorization:_0x23b232,mjProxy:_0x46fc73}=await this['getMjDefaultParams'](),_0x37cc52=_0x46fc73==0x1?_0x5dc035(0x1bd):_0x5dc035(0x19f),_0x3037f2={'authorization':_0x23b232},_0x403350={'type':0x3,'guild_id':_0x2d5c21,'channel_id':_0x272d3b,'message_flags':0x0,'message_id':_0x4876af,'application_id':_0x33637d,'session_id':_0x625a6c,'data':{'component_type':0x2,'custom_id':_0x379093}};try{await axios_1[_0x5dc035(0x1a2)][_0x5dc035(0x186)](_0x37cc52,_0x403350,{'headers':_0x3037f2}),console[_0x5dc035(0x16c)](_0x5dc035(0x1a4));}catch(_0x495f88){console[_0x5dc035(0x16c)](_0x5dc035(0x170),_0x495f88);throw new common_1[(_0x5dc035(0x13d))]('放大单张图片请求失败...',common_1[_0x5dc035(0x15c)][_0x5dc035(0x143)]);}}async[_0x2d8223(0x146)](_0x50102e,_0xc7b70a){const _0x1513aa=_0x2d8223,{message_id:_0x68944a,custom_id:_0x5e4785,prompt:_0x242ae7,orderId:_0x498f99}=_0x50102e;let _0x1969f0=null,_0x28f842=0x0;while(!_0x1969f0&&_0x28f842<0xa){try{const _0x1c8001=Date[_0x1513aa(0x133)](),_0x2f0455=await this['queryMessageList']();console[_0x1513aa(0x16c)]('第\x20'+(_0x28f842+0x1)+_0x1513aa(0x1a3)+_0x2f0455[_0x1513aa(0x171)]);_0x2f0455&&_0x2f0455[_0x1513aa(0x171)]&&(_0x1969f0=await this[_0x1513aa(0x15f)](_0x2f0455,_0x50102e,_0xc7b70a));const _0x2c2b61=Date[_0x1513aa(0x133)]()-_0x1c8001,_0x59d312=0xbb8;await this[_0x1513aa(0x1a7)](Math[_0x1513aa(0x117)](_0x59d312-_0x2c2b61,0x0)),_0x28f842++;}catch(_0x5cc783){console[_0x1513aa(0x13e)](_0x1513aa(0x134)+_0x5cc783[_0x1513aa(0x1ae)]);}}return _0x1969f0;}async['pollForVariationResult'](_0xbd0d93,_0x157ed0){const _0x28d253=_0x2d8223,{message_id:_0x3b5e4c,custom_id:_0x190ccc,prompt:_0x4bc4cf,orderId:_0x51539c}=_0xbd0d93;console[_0x28d253(0x16c)](_0x28d253(0x12b));let _0x2c9f41=null,_0x118312=0x0;while(!_0x2c9f41&&_0x118312<0xa){try{console[_0x28d253(0x16c)]('第\x20'+(_0x118312+0x1)+'\x20次开始查询[变换图片]');const _0x4ab537=Date['now'](),_0x28460f=await this['queryMessageList']();_0x28460f&&_0x28460f[_0x28d253(0x171)]&&(_0x2c9f41=await this[_0x28d253(0x13c)](_0x28460f,_0xbd0d93,_0x157ed0));const _0x32f4d0=Date[_0x28d253(0x133)]()-_0x4ab537,_0x404b27=0x1f40;await this['sleep'](Math[_0x28d253(0x117)](_0x404b27-_0x32f4d0,0x0)),_0x118312++;}catch(_0x5a489a){console[_0x28d253(0x13e)](_0x28d253(0x134)+_0x5a489a['message']);}}if(!_0x2c9f41)throw new common_1[(_0x28d253(0x13d))](_0x28d253(0x147),common_1[_0x28d253(0x15c)]['BAD_REQUEST']);return _0x2c9f41;}async[_0x2d8223(0x15f)](_0x16043b,_0x7f923c,_0x453cd0){const _0x265344=_0x2d8223,{message_id:_0x78973c,custom_id:_0x257854,prompt:_0x4f8ad5,orderId:_0x3f4060}=_0x7f923c,_0x18e6ed=_0x4f8ad5[_0x265344(0x13f)](0x0,0xc);console[_0x265344(0x16c)](_0x265344(0x16a),_0x18e6ed);const _0x5d2adf=_0x16043b[_0x265344(0x12d)](_0x4510f2=>{const _0x24c202=_0x265344,{content:_0x368b3d}=_0x4510f2;if(!this[_0x24c202(0x193)](_0x368b3d))return![];const {prompt:_0x130098,order:_0x1b1637}=this[_0x24c202(0x193)](_0x368b3d);return _0x130098[_0x24c202(0x169)](_0x18e6ed)&&_0x7f923c[_0x24c202(0x138)]===_0x1b1637&&!_0x453cd0[_0x24c202(0x169)](_0x4510f2['id']);});return _0x5d2adf;}async[_0x2d8223(0x13c)](_0x42e90c,_0x2cdcb0,_0x345b14){const _0x31f8b7=_0x2d8223,{message_id:_0x41ef06,custom_id:_0x217c79,prompt:_0x1ea238,orderId:_0x192877}=_0x2cdcb0,_0x2936cf=_0x1ea238[_0x31f8b7(0x13f)](0x0,0xc),_0x23746e=_0x42e90c['find'](_0x4a1799=>{const _0x524314=_0x31f8b7,{content:_0x5a6534}=_0x4a1799,_0x4fbe0d=_0x5a6534[_0x524314(0x1a1)](/\*\*(.+?)\*\*/),_0x40c812=_0x4fbe0d?_0x4fbe0d[0x1]:'';if(!_0x40c812)return![];return _0x40c812[_0x524314(0x169)](_0x2936cf)&&!_0x345b14[_0x524314(0x169)](_0x4a1799['id']);});return _0x23746e;}async[_0x2d8223(0x15e)](_0xff832b,_0x1efbba,_0x326d34){const _0x3d8f17=_0x2d8223,_0x153886=await this[_0x3d8f17(0x197)](),_0x3270ac=await this[_0x3d8f17(0x1be)](_0x153886,_0x326d34,_0x1efbba);if(_0x3270ac)return console[_0x3d8f17(0x16c)](_0x3d8f17(0x128),_0x3270ac),_0x3270ac;const {application_id:_0x5e9605,guild_id:_0x514c23,channel_id:_0x461b34,session_id:_0x4fa85d,version:_0x5d3eda,id:_0x11ac4f,authorization:_0x1b1002,mjProxy:_0x36b337}=await this[_0x3d8f17(0x1b1)](),_0x5a1466={'type':0x2,'application_id':_0x5e9605,'guild_id':_0x514c23,'channel_id':_0x461b34,'session_id':_0x4fa85d,'data':{'version':_0x5d3eda,'id':_0x11ac4f,'name':_0x3d8f17(0x184),'type':0x1,'options':[{'type':0x3,'name':_0x3d8f17(0x15a),'value':_0xff832b}],'attachments':[]}};try{const _0xf668c0=_0x36b337==0x1?_0x3d8f17(0x1bd):_0x3d8f17(0x19f),_0x16243a={'authorization':_0x1b1002},_0x16d666=await axios_1[_0x3d8f17(0x1a2)]['post'](_0xf668c0,_0x5a1466,{'headers':_0x16243a});return console[_0x3d8f17(0x16c)]('发送绘画指令结果:\x20',_0x16d666[_0x3d8f17(0x167)]),![];}catch(_0x158fa8){console[_0x3d8f17(0x16c)](_0x3d8f17(0x149),_0x158fa8);throw new common_1['HttpException'](_0x3d8f17(0x196),common_1['HttpStatus'][_0x3d8f17(0x143)]);}}async['pollForResult'](_0x2d5949,_0x52c77c,_0x35d33f){const _0x370d95=_0x2d8223;console['log']('开始查询绘画结果轮询');const _0x5f2a26=Date['now']();try{const _0xce5b94=0xd,_0x2d191e=0x2ee0,_0x8bc20a=0x1388,_0x1636e3=0x3c*0x3e8;let _0x490e69=0x0,_0x537779=![],_0x4d3185=null;while(!_0x4d3185&&_0x490e69<_0xce5b94){console[_0x370d95(0x16c)]('第\x20'+(_0x490e69+0x1)+_0x370d95(0x17d));Date['now']()-_0x5f2a26>=_0x1636e3&&(_0x537779=!![]);await this['sleep'](_0x537779?_0x8bc20a:_0x2d191e);const _0x538b9a=await this[_0x370d95(0x197)]();_0x4d3185=await this[_0x370d95(0x1be)](_0x538b9a,_0x35d33f,_0x52c77c),_0x490e69++;}if(!_0x4d3185)throw new common_1[(_0x370d95(0x13d))](_0x370d95(0x18e),common_1[_0x370d95(0x15c)][_0x370d95(0x143)]);const _0x21ba6f=Date[_0x370d95(0x133)]();return console[_0x370d95(0x16c)]('本次绘图耗时:\x20'+Math[_0x370d95(0x14d)]((_0x21ba6f-_0x5f2a26)/0x3e8)+'\x20S'),_0x4d3185;}catch(_0x9b19ba){console[_0x370d95(0x13e)](_0x9b19ba['message']);throw new common_1['HttpException'](_0x370d95(0x159),common_1[_0x370d95(0x15c)][_0x370d95(0x14a)]);}}async[_0x2d8223(0x1be)](_0x1756e1,_0x176526,_0x1fc088){const _0x1ca5e2=_0x2d8223;if(!_0x1756e1||!_0x1756e1[_0x1ca5e2(0x171)])return;console[_0x1ca5e2(0x16c)](_0x1ca5e2(0x13b),_0x176526);const _0x2ab900=_0x1756e1[_0x1ca5e2(0x12d)](_0x38e351=>{const _0x40c733=_0x1ca5e2,{attachments:attachments=[],content:_0x16e834,edited_timestamp:_0x2fc777}=_0x38e351;return _0x16e834[_0x40c733(0x169)](_0x176526)&&attachments['length']>0x0&&!_0x2fc777&&!_0x1fc088[_0x40c733(0x169)](_0x38e351['id']);});return _0x2ab900||null;}async[_0x2d8223(0x197)](){const _0x4ca6dc=_0x2d8223;try{const {application_id:_0x2c8e42,guild_id:_0x358e80,channel_id:_0x2a889b,session_id:_0x2c721d,version:_0xc4bbef,id:_0x29a611,authorization:_0x425dbf,mjProxy:_0x216f25}=await this['getMjDefaultParams'](),_0x3d04f6=_0x216f25==0x1?_0x4ca6dc(0x19e)+_0x2a889b:_0x4ca6dc(0x1b5)+_0x2a889b+_0x4ca6dc(0x150),_0xc8c1cf={'authorization':_0x425dbf},_0x15b99b=await axios_1[_0x4ca6dc(0x1a2)][_0x4ca6dc(0x126)](_0x3d04f6,{'headers':_0xc8c1cf});return _0x15b99b[_0x4ca6dc(0x167)];}catch(_0x2a90c2){console[_0x4ca6dc(0x16c)](_0x4ca6dc(0x199),_0x2a90c2);throw new common_1[(_0x4ca6dc(0x13d))](_0x4ca6dc(0x111),common_1[_0x4ca6dc(0x15c)][_0x4ca6dc(0x143)]);}}async[_0x2d8223(0x1a7)](_0x3792ee){return new Promise(_0x212107=>setTimeout(_0x212107,_0x3792ee));}[_0x2d8223(0x193)](_0x265238){const _0x3e00e5=_0x2d8223,_0x20968f=_0x265238['match'](/\*\*(.+?)\*\*/),_0x3d1bd3=_0x265238[_0x3e00e5(0x1a1)](/- Image #(\d+)/);if(!_0x20968f||!_0x3d1bd3)return null;const _0x5f2de4=_0x20968f[0x1],_0x513062=parseInt(_0x3d1bd3[0x1]);return{'prompt':_0x5f2de4,'order':_0x513062};}async[_0x2d8223(0x1b1)](){const _0x4c74c8=_0x2d8223,_0x2c593c=await this['globalConfigService'][_0x4c74c8(0x19a)](['mjId','mjApplicationId',_0x4c74c8(0x135),_0x4c74c8(0x1bf),'mjSessionId',_0x4c74c8(0x12f),_0x4c74c8(0x13a),_0x4c74c8(0x12c),_0x4c74c8(0x153)]),_0x379f66={'application_id':_0x2c593c[_0x4c74c8(0x19b)],'guild_id':_0x2c593c[_0x4c74c8(0x135)],'channel_id':_0x2c593c['mjChannelId'],'session_id':_0x2c593c['mjSessionId'],'version':_0x2c593c[_0x4c74c8(0x12f)],'id':_0x2c593c['mjId'],'authorization':_0x2c593c['mjAuthorization'],'mjRateLimit':_0x2c593c[_0x4c74c8(0x12c)],'mjProxy':_0x2c593c[_0x4c74c8(0x153)]||0x0};return _0x379f66;}[_0x2d8223(0x148)](_0x46eb27){const _0x59f220=_0x2d8223,_0x20a368=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x46eb27[_0x59f220(0x177)](_0x20a368,'');}async[_0x2d8223(0x1a5)](_0x11acf0){const _0x36befd=_0x2d8223,_0x3a5591=await this[_0x36befd(0x1b6)][_0x36befd(0x162)]({'where':{'userId':_0x11acf0[_0x36befd(0x185)]['id']}}),{id:_0x56b6d3,balance:_0x1abf8a}=_0x3a5591;if(!_0x1abf8a||(_0x3a5591===null||_0x3a5591===void 0x0?void 0x0:_0x3a5591['balance'])<0x1)throw new common_1[(_0x36befd(0x13d))](_0x36befd(0x16d),common_1[_0x36befd(0x15c)][_0x36befd(0x143)]);}async[_0x2d8223(0x1bb)](_0x358dbd){const _0x275e23=_0x2d8223,{id:_0x2ced36,role:_0x138232}=_0x358dbd[_0x275e23(0x185)];!this[_0x275e23(0x11d)][_0x2ced36]?this[_0x275e23(0x11d)][_0x2ced36]=0x1:this[_0x275e23(0x11d)][_0x2ced36]=this[_0x275e23(0x11d)][_0x2ced36]+0x1,console['log'](_0x275e23(0x1b8)+_0x2ced36+_0x275e23(0x1c4),this['freeQueueUsers'][_0x2ced36]);}async[_0x2d8223(0x136)](_0xd139cc){const _0x472ee5=_0x2d8223,{id:_0x429dda,role:_0x5990e9}=_0xd139cc['user'];if([_0x472ee5(0x194),'super'][_0x472ee5(0x169)](_0x5990e9))return!![];const {mjRateLimit:_0x28c036}=await this[_0x472ee5(0x1b1)]();if(this['rateLimits'][_0x429dda]){const _0xb0477d=this['rateLimits'][_0x429dda];if(_0xb0477d>Date[_0x472ee5(0x133)]()){console['log'](_0x472ee5(0x157)+_0x429dda+_0x472ee5(0x129));throw new common_1[(_0x472ee5(0x13d))](_0x472ee5(0x130)+_0x28c036+'秒请求一次、请合理使用！',common_1['HttpStatus'][_0x472ee5(0x143)]);}else this['rateLimits'][_0x429dda]=Date[_0x472ee5(0x133)]()+Number(_0x28c036)*0x3e8;}else{const _0x59a4f7=Date[_0x472ee5(0x133)]();this[_0x472ee5(0x166)][_0x429dda]=_0x59a4f7+0x3e8*Number(_0x28c036);}}async[_0x2d8223(0x16f)](_0x1eaea1){const _0x45e3fe=_0x2d8223;await this[_0x45e3fe(0x1b6)][_0x45e3fe(0x1b7)]()[_0x45e3fe(0x154)](balance_entity_1[_0x45e3fe(0x17e)])['set']({'balance':()=>_0x45e3fe(0x18f)})[_0x45e3fe(0x112)]('userId\x20=\x20:userId',{'userId':_0x1eaea1[_0x45e3fe(0x185)]['id']})[_0x45e3fe(0x1b9)]();}async['test'](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x2d8223(0x122)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_2[_0x2d8223(0x11a)])(balance_entity_1[_0x2d8223(0x17e)])),__metadata(_0x2d8223(0x119),[typeorm_1[_0x2d8223(0x125)],typeorm_1[_0x2d8223(0x125)],upload_service_1['UploadService'],chatLog_service_1['ChatLogService'],globalConfig_service_1[_0x2d8223(0x114)],fanyi_service_1[_0x2d8223(0x137)],badwords_service_1[_0x2d8223(0x158)]])],MjService),exports[_0x2d8223(0x18a)]=MjService;