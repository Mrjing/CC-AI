'use strict';const _0x412d53=_0x2438;function _0x2438(_0x2ae052,_0x5d6e94){const _0x5250fc=_0x5250();return _0x2438=function(_0x2438ef,_0x4b324e){_0x2438ef=_0x2438ef-0x1bc;let _0x14735d=_0x5250fc[_0x2438ef];return _0x14735d;},_0x2438(_0x2ae052,_0x5d6e94);}(function(_0xfda540,_0x15b530){const _0xd9119e=_0x2438,_0x4aaacb=_0xfda540();while(!![]){try{const _0x17ad72=-parseInt(_0xd9119e(0x25d))/0x1+parseInt(_0xd9119e(0x20f))/0x2+-parseInt(_0xd9119e(0x1f4))/0x3*(-parseInt(_0xd9119e(0x214))/0x4)+parseInt(_0xd9119e(0x1ce))/0x5+-parseInt(_0xd9119e(0x1c3))/0x6+-parseInt(_0xd9119e(0x229))/0x7+-parseInt(_0xd9119e(0x1f5))/0x8;if(_0x17ad72===_0x15b530)break;else _0x4aaacb['push'](_0x4aaacb['shift']());}catch(_0x580a6f){_0x4aaacb['push'](_0x4aaacb['shift']());}}}(_0x5250,0xda223));var __decorate=this&&this['__decorate']||function(_0x1b7227,_0x566615,_0x195212,_0x767270){const _0x4cfe08=_0x2438;var _0x2a3513=arguments['length'],_0x420dd9=_0x2a3513<0x3?_0x566615:_0x767270===null?_0x767270=Object['getOwnPropertyDescriptor'](_0x566615,_0x195212):_0x767270,_0x5f426d;if(typeof Reflect===_0x4cfe08(0x257)&&typeof Reflect['decorate']===_0x4cfe08(0x225))_0x420dd9=Reflect[_0x4cfe08(0x207)](_0x1b7227,_0x566615,_0x195212,_0x767270);else{for(var _0x2a2a02=_0x1b7227[_0x4cfe08(0x248)]-0x1;_0x2a2a02>=0x0;_0x2a2a02--)if(_0x5f426d=_0x1b7227[_0x2a2a02])_0x420dd9=(_0x2a3513<0x3?_0x5f426d(_0x420dd9):_0x2a3513>0x3?_0x5f426d(_0x566615,_0x195212,_0x420dd9):_0x5f426d(_0x566615,_0x195212))||_0x420dd9;}return _0x2a3513>0x3&&_0x420dd9&&Object[_0x4cfe08(0x1c0)](_0x566615,_0x195212,_0x420dd9),_0x420dd9;},__metadata=this&&this[_0x412d53(0x20b)]||function(_0x1e71a5,_0x40b197){const _0x48e98f=_0x412d53;if(typeof Reflect===_0x48e98f(0x257)&&typeof Reflect[_0x48e98f(0x242)]===_0x48e98f(0x225))return Reflect[_0x48e98f(0x242)](_0x1e71a5,_0x40b197);},__param=this&&this[_0x412d53(0x1cf)]||function(_0x1e91bb,_0x54633e){return function(_0x231e99,_0x13351a){_0x54633e(_0x231e99,_0x13351a,_0x1e91bb);};};Object[_0x412d53(0x1c0)](exports,_0x412d53(0x24e),{'value':!![]}),exports[_0x412d53(0x254)]=void 0x0;const user_entity_1=require('./../user/user.entity'),common_1=require(_0x412d53(0x223)),typeorm_1=require(_0x412d53(0x24c)),midjourney_entity_1=require('./midjourney.entity'),typeorm_2=require(_0x412d53(0x215)),axios_1=require(_0x412d53(0x201)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),midjourney_constant_1=require(_0x412d53(0x256)),upload_service_1=require(_0x412d53(0x252)),userBalance_service_1=require(_0x412d53(0x24a)),utils_1=require(_0x412d53(0x246)),redisCache_service_1=require(_0x412d53(0x23e)),prompt_entity_1=require('./prompt.entity'),image_size_1=require(_0x412d53(0x25b));function _0x5250(){const _0x5de359=['Error\x20fetching\x20image\x20size:','function','MidjourneyEntity','发送绘图指令失败、请联系管理员检测绘画配置！','drawSuccess','5379262pdBAkD','drawRatio','VARIATION','createdAt','/fetch','label','data','HttpStatus','Injectable','findOne','轮询过程中发生错误:\x20','buttons','set','操作成功！','HttpException','log','fullPrompt','get','UserEntity','replace','filter','../redisCache/redisCache.service','from','mjProxyUrl','DRAWING','metadata','globalConfigService','Zoom\x20Out\x201.5x','MidjourneyStatusEnum','../../common/utils','非法操作！','length','stringify','../userBalance/userBalance.service','draw','@nestjs/typeorm','当前管理员限制单用户同时最多能执行','__esModule','binary','$1****$2','queryPrompt','../upload/upload.service','uploadFileFromUrl','MidjourneyService','email','../../common/constants/midjourney.constant','object','IMAGINE','map','userId','image-size','payloadJson','234623YEyYab','proxyImg','post','updateDrawData','未能获取结果数据','delete','MJ::JOB::reroll::0::','defineProperty','count','find','7214040ukWitI','mjPromptsEntity','存储图片失败，使用原始图片链接','now','formatCreateOrUpdateDate','url','getImageSizeFromUrl','getConfigs','DRAWFAIL','.png','height','7278035owPoil','__param','updateDrawStatus','orderId','addDrawQueue','imageUrl','midjourney:getList','删除失败！','删除记录失败！','update','更新绘画数据失败','checkLimit','process','积分。','uploadService','/mj/task/','RedisCacheService','action','setPrompt','UploadService','WAITING','getDrawActionDetail','绘制中的图片任务、禁止删除！','本次不存图片了','绘画ID:\x20','assign','获取我得绘制列表失败','save','affected','redisCacheService','getAdminDrawList','InjectRepository','REGENERATE','arraybuffer','bindJobId','rec','deleteDraw','base64','3NpGCqo','10945304DJEZvS','parse','application/x-www-form-urlencoded','forEach','error','Zoom\x20Out\x202x','userInfo','findAndCount','prompt','pollComparisonResultDraw','drawUrl','Logger','axios','error:\x20','Repository','test','username','ZOOM','decorate','user','drawId','delPrompt','__metadata','mjPromptEntity','Error\x20in\x20addDrawQueue:','GlobalConfigService','3484648ovdvKq','userBalanceService','startsWith','DRAWED','mjKey','5076544dFgpZh','typeorm','userEntity','绘画超时，请稍后再试！','DESC','BAD_REQUEST','design:paramtypes','轮询失败次数过多，请稍后再试！','getDrawList','删除记录成功！','status','res','midjourneyEntity','default','removeEmoji','@nestjs/common'];_0x5250=function(){return _0x5de359;};return _0x5250();}let MidjourneyService=class MidjourneyService{constructor(_0x558464,_0x17b045,_0x5459da,_0x10e1d2,_0x33e16e,_0x52d2db,_0xffd4b6){const _0x17fd3d=_0x412d53;this[_0x17fd3d(0x220)]=_0x558464,this[_0x17fd3d(0x216)]=_0x17b045,this[_0x17fd3d(0x1c4)]=_0x5459da,this[_0x17fd3d(0x243)]=_0x10e1d2,this[_0x17fd3d(0x1dc)]=_0x33e16e,this[_0x17fd3d(0x210)]=_0x52d2db,this[_0x17fd3d(0x1eb)]=_0xffd4b6,this['lockPrompt']=[];}async['sleep'](_0x1bb047){return new Promise(_0x49e7fd=>setTimeout(_0x49e7fd,_0x1bb047));}async[_0x412d53(0x1c9)](_0x434c6c){const _0x5f5b63=_0x412d53;try{const _0x3a3782=await axios_1['default']['get'](_0x434c6c,{'responseType':_0x5f5b63(0x1ef)}),_0x79f483=Buffer[_0x5f5b63(0x23f)](_0x3a3782['data'],_0x5f5b63(0x24f)),_0x314fcc=(0x0,image_size_1[_0x5f5b63(0x221)])(_0x79f483);return{'width':_0x314fcc['width'],'height':_0x314fcc[_0x5f5b63(0x1cd)]};}catch(_0x38f0bd){console[_0x5f5b63(0x1f9)](_0x5f5b63(0x224),_0x38f0bd);throw _0x38f0bd;}}async[_0x412d53(0x24b)](_0x3caa24,_0x3fc5c8){const _0x41d655=_0x412d53,{id:_0xc87fda,action:_0x1b773d,drawId:_0x1568a8}=_0x3caa24,_0x408543=await this[_0x41d655(0x220)][_0x41d655(0x232)]({'where':{'id':_0xc87fda}}),{customId:_0x3bed27}=_0x408543;try{await this[_0x41d655(0x1f0)](_0xc87fda,_0x3fc5c8),await this[_0x41d655(0x1d0)](_0xc87fda,midjourney_constant_1[_0x41d655(0x245)][_0x41d655(0x241)]);const _0x1873d2=await this['sendDrawCommand'](_0x408543,_0x1b773d);_0x408543[_0x41d655(0x209)]=_0x1873d2;const _0x32a6c4=await this['pollComparisonResultDraw'](_0xc87fda,_0x408543);return await this[_0x41d655(0x1bc)](_0x3caa24,_0x32a6c4),this[_0x41d655(0x228)](_0x3caa24),!![];}catch(_0xc579e4){return console['log'](_0x41d655(0x202),_0xc579e4),!![];}}async[_0x412d53(0x1d2)](_0x5872e1){const _0x4c4cb0=_0x412d53;try{const {prompt:_0x2b3ab7,imgUrl:imgUrl='',extraParam:extraParam='',action:_0x4cf7c8,userId:_0x58d36e,orderId:_0x56f82f,customId:_0x45cfec,drawId:_0xb91797}=_0x5872e1,_0x20daa2=imgUrl?imgUrl+'\x20'+_0x2b3ab7+'\x20'+extraParam:_0x2b3ab7+'\x20'+extraParam,_0x4a852b={'userId':_0x58d36e,'drawId':_0xb91797,'extraParam':extraParam,'prompt':_0x2b3ab7,'imgUrl':imgUrl,'fullPrompt':_0x20daa2,'status':midjourney_constant_1[_0x4c4cb0(0x245)][_0x4c4cb0(0x1e2)],'action':_0x4cf7c8,'orderId':_0x56f82f,'customId':_0x45cfec},_0x5c7955=await this['midjourneyEntity'][_0x4c4cb0(0x1e9)](_0x4a852b);return _0x5c7955;}catch(_0x210ab6){console[_0x4c4cb0(0x1f9)](_0x4c4cb0(0x20d),_0x210ab6);throw _0x210ab6;}}async[_0x412d53(0x1d0)](_0x37532c,_0x18c370){const _0x20c49a=_0x412d53;await this[_0x20c49a(0x220)]['update']({'id':_0x37532c},{'status':_0x18c370});}async[_0x412d53(0x1bc)](_0x4bbb69,_0x278018){const _0x3744ab=_0x412d53;try{const {id:_0x18c94d,imageUrl:_0x2d85c4,action:_0x2e3728,submitTime:_0x3e18fc,finishTime:_0x153e82,progress:_0xbb53f4}=_0x278018,_0x125fb0=_0x153e82-_0x3e18fc;let _0x23963b=Date[_0x3744ab(0x1c6)]()+'-'+_0x18c94d+_0x3744ab(0x1cc);const _0x3e2864=await this[_0x3744ab(0x243)][_0x3744ab(0x1ca)](['mjNotSaveImg']);let _0x1ddcc9='',_0x50dbd8=!![];try{!Number(_0x3e2864)||Number(_0x3e2864)===0x0?(common_1[_0x3744ab(0x200)]['debug']('------>\x20开始上传图片！！！','MidjourneyService'),_0x1ddcc9=await this[_0x3744ab(0x1dc)][_0x3744ab(0x253)]({'filename':_0x23963b,'url':_0x2d85c4})):(_0x1ddcc9=_0x2d85c4,_0x50dbd8=![],common_1[_0x3744ab(0x200)]['debug'](_0x3744ab(0x1e5),'MidjourneyService'));}catch(_0x4a710e){common_1[_0x3744ab(0x200)][_0x3744ab(0x1f9)](_0x3744ab(0x1c5),_0x3744ab(0x254)),_0x1ddcc9=_0x2d85c4,_0x50dbd8=![];}const {width:_0x1b6a6f,height:_0x192e46}=await this['getImageSizeFromUrl'](_0x2d85c4),_0x5238fd={'status':midjourney_constant_1['MidjourneyStatusEnum'][_0x3744ab(0x212)],'drawId':_0x18c94d,'action':_0x2e3728,'drawUrl':_0x1ddcc9,'drawRatio':_0x1b6a6f+'x'+_0x192e46,'progress':0x64,'extend':this[_0x3744ab(0x222)](JSON[_0x3744ab(0x249)](_0x278018)),'durationSpent':_0x125fb0,'isSaveImg':_0x50dbd8};await this[_0x3744ab(0x220)][_0x3744ab(0x1d7)]({'id':_0x4bbb69['id']},_0x5238fd);}catch(_0x50c58b){throw new common_1[(_0x3744ab(0x237))](_0x3744ab(0x1d8),common_1['HttpStatus']['BAD_REQUEST']);}}async['sendDrawCommand'](_0x145b17,_0xff614d){const _0x3b3ecf=_0x412d53,_0x48de6f=await this['globalConfigService'][_0x3b3ecf(0x1ca)]([_0x3b3ecf(0x240)]),_0x4df9bd=await this[_0x3b3ecf(0x243)][_0x3b3ecf(0x1ca)]([_0x3b3ecf(0x213)]),{id:_0xba9de4,fullPrompt:_0x58850c,imgUrl:_0x59b229,drawId:_0x13cfed,customId:_0x37bb7c}=_0x145b17,_0x267b26=_0x59b229?_0x59b229+'\x20'+_0x58850c:''+_0x58850c;let _0x3c6365='',_0x2e1b0d={};const _0x255e8c=0x3;let _0x2e17d9=0x0;while(_0x2e17d9<_0x255e8c){try{_0xff614d===_0x3b3ecf(0x258)?(_0x3c6365=_0x48de6f+'/mj/submit/imagine',_0x2e1b0d={'prompt':_0x267b26}):(_0x3c6365=_0x48de6f+'/mj/submit/action',_0x2e1b0d={'taskId':_0x13cfed,'customId':_0x37bb7c});const _0x40d41f={'mj-api-secret':_0x4df9bd};console[_0x3b3ecf(0x238)](_0x3b3ecf(0x1c8),_0x3c6365),console[_0x3b3ecf(0x238)](_0x3b3ecf(0x25c),_0x2e1b0d);const _0x225ec8=await axios_1[_0x3b3ecf(0x221)][_0x3b3ecf(0x25f)](_0x3c6365,_0x2e1b0d,{'headers':_0x40d41f}),{result:_0x865af7}=_0x225ec8[_0x3b3ecf(0x22f)];console[_0x3b3ecf(0x238)](_0x3b3ecf(0x21f),_0x225ec8[_0x3b3ecf(0x22f)]);if(_0x865af7)return common_1[_0x3b3ecf(0x200)][_0x3b3ecf(0x238)](_0x3b3ecf(0x1e6)+_0x865af7,_0x3b3ecf(0x254)),_0x865af7;else throw new Error(_0x3b3ecf(0x1bd));}catch(_0x2716e2){console[_0x3b3ecf(0x238)](_0x3b3ecf(0x1f9),_0x2716e2),_0x2e17d9++;if(_0x2e17d9>=_0x255e8c){await this[_0x3b3ecf(0x1d0)](_0xba9de4,midjourney_constant_1[_0x3b3ecf(0x245)][_0x3b3ecf(0x1cb)]);throw new common_1[(_0x3b3ecf(0x237))](_0x3b3ecf(0x227),common_1[_0x3b3ecf(0x230)][_0x3b3ecf(0x219)]);}}}}async[_0x412d53(0x1fe)](_0x4f5148,_0x1c06b9){const _0x59655b=_0x412d53,_0x37fa90=await this[_0x59655b(0x243)]['getConfigs']([_0x59655b(0x240)]),_0x544448=await this[_0x59655b(0x243)][_0x59655b(0x1ca)](['mjKey']),_0x31d256=Date[_0x59655b(0x1c6)](),_0x1a5584=0x1388,_0x26b91d=0x249f0;let _0x45b249=0x0,_0x495a39=0x0;const _0x3ad7ee=0x5,{drawId:_0x3c4ff4}=_0x1c06b9;try{while(Date['now']()-_0x31d256<_0x26b91d&&_0x495a39<_0x3ad7ee){await new Promise(_0x1f0965=>setTimeout(_0x1f0965,_0x1a5584));try{const _0x4c17bd={'Content-Type':_0x59655b(0x1f7),'mj-api-secret':_0x544448},_0x240898=_0x37fa90+_0x59655b(0x1dd)+_0x3c4ff4+_0x59655b(0x22d),_0x1961d2=await axios_1[_0x59655b(0x221)][_0x59655b(0x23a)](_0x240898,{'headers':_0x4c17bd}),_0x5a930c=_0x1961d2['data'],_0x35919a=_0x5a930c[_0x59655b(0x1da)];await this[_0x59655b(0x220)][_0x59655b(0x1d7)]({'id':_0x4f5148},{'progress':_0x35919a});if(_0x5a930c[_0x59655b(0x21e)]==='SUCCESS')return common_1[_0x59655b(0x200)][_0x59655b(0x238)]('绘制成功,\x20URL:\x20'+_0x5a930c[_0x59655b(0x1d3)],'MidjourneyService'),_0x5a930c;}catch(_0x6cdb3e){_0x495a39++,common_1[_0x59655b(0x200)][_0x59655b(0x1f9)](_0x59655b(0x233)+_0x6cdb3e,_0x59655b(0x254));}_0x45b249++;}if(_0x495a39>=_0x3ad7ee){await this[_0x59655b(0x1d0)](_0x4f5148,midjourney_constant_1[_0x59655b(0x245)][_0x59655b(0x1cb)]);throw new common_1[(_0x59655b(0x237))](_0x59655b(0x21b),common_1['HttpStatus'][_0x59655b(0x219)]);}common_1[_0x59655b(0x200)][_0x59655b(0x1f9)]('绘画超时，请稍后再试！',_0x59655b(0x254)),await this[_0x59655b(0x1d0)](_0x4f5148,midjourney_constant_1[_0x59655b(0x245)][_0x59655b(0x1cb)]);throw new common_1[(_0x59655b(0x237))](_0x59655b(0x217),common_1['HttpStatus']['BAD_REQUEST']);}catch(_0x21379e){common_1[_0x59655b(0x200)]['error']('获取图片结果失败:\x20',_0x21379e,_0x59655b(0x254)),await this[_0x59655b(0x1d0)](_0x4f5148,midjourney_constant_1[_0x59655b(0x245)]['DRAWFAIL']);throw _0x21379e;}}['removeEmoji'](_0x5551d8){const _0x1bfae0=_0x412d53,_0x168c69=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x5551d8[_0x1bfae0(0x23c)](_0x168c69,'');}async[_0x412d53(0x1f0)](_0xa5f37,_0x55183a){const _0x4ea9e7=_0x412d53;await this[_0x4ea9e7(0x220)]['update']({'id':_0xa5f37},{'jobId':_0x55183a});}async[_0x412d53(0x21c)](_0x3799bd,_0x2eaf5f){const _0x4618fd=_0x412d53;try{const {page:page=0x1,size:size=0x1e}=_0x2eaf5f,[_0x40d0f1,_0x44155b]=await this['midjourneyEntity'][_0x4618fd(0x1fc)]({'where':{'userId':_0x3799bd[_0x4618fd(0x208)]['id'],'isDelete':0x0},'order':{'id':_0x4618fd(0x218)},'take':size,'skip':(page-0x1)*size,'select':['id','userId',_0x4618fd(0x1fd),'extraParam',_0x4618fd(0x239),_0x4618fd(0x1f1),_0x4618fd(0x1d1),'drawId','drawUrl',_0x4618fd(0x22a),'isDelete',_0x4618fd(0x21e),_0x4618fd(0x1df)]}),_0x48354f=await this[_0x4618fd(0x220)][_0x4618fd(0x1c1)]({'where':{'isDelete':0x0,'status':(0x0,typeorm_2['In'])([0x1,0x2])}}),_0x3f1dbd={'rows':(0x0,utils_1[_0x4618fd(0x1c7)])(_0x40d0f1),'count':_0x44155b,'countQueue':_0x48354f};return _0x3f1dbd;}catch(_0x489347){throw new common_1[(_0x4618fd(0x237))](_0x4618fd(0x1e8),common_1[_0x4618fd(0x230)][_0x4618fd(0x219)]);}}async[_0x412d53(0x1e3)](_0x51b8b7,_0x3a3606,_0xe57fdb){const _0x4f2995=_0x412d53,_0xa08577=await this['midjourneyEntity'][_0x4f2995(0x232)]({'where':{'drawId':_0x3a3606}}),{extend:_0x2f8d7d,prompt:_0x33caae,imgUrl:_0x5b9b28,extraParam:_0x46cc59}=_0xa08577,_0xccbcb2=JSON[_0x4f2995(0x1f6)](_0x2f8d7d),_0x516503=_0xccbcb2[_0x4f2995(0x234)]||[];let _0x4548fb;_0x51b8b7==='UPSCALE'&&(_0x4548fb=_0x516503[_0x4f2995(0x1c2)](_0x2138e2=>{const _0x198e5e=_0x4f2995,_0x14db2a=_0x2138e2[_0x198e5e(0x22e)][_0x198e5e(0x211)]('U'+_0xe57fdb),_0x139de4=_0xe57fdb===0x1&&/(Redo )?Upscale \(Subtle\)/[_0x198e5e(0x204)](_0x2138e2[_0x198e5e(0x22e)])||_0xe57fdb===0x2&&/(Redo )?Upscale \(Creative\)/['test'](_0x2138e2[_0x198e5e(0x22e)]);return _0x14db2a||_0x139de4;}));_0x51b8b7===_0x4f2995(0x22b)&&(_0x4548fb=_0x516503[_0x4f2995(0x1c2)](_0x8ec97f=>{const _0x24d33f=_0x4f2995,_0x2ee4a3=_0x8ec97f['label']['startsWith']('V'+_0xe57fdb),_0x3af698=_0xe57fdb===0x1&&/Vary \(Strong\)/[_0x24d33f(0x204)](_0x8ec97f[_0x24d33f(0x22e)])||_0xe57fdb===0x2&&/Vary \(Region\)/[_0x24d33f(0x204)](_0x8ec97f[_0x24d33f(0x22e)]);return _0x2ee4a3||_0x3af698;}));_0x51b8b7===_0x4f2995(0x1ee)&&(_0x4548fb=_0x516503['find'](_0x401337=>_0x401337['customId'][_0x4f2995(0x211)](_0x4f2995(0x1bf))&&_0x401337[_0x4f2995(0x22e)]===''));_0x51b8b7===_0x4f2995(0x206)&&(_0x4548fb=_0x516503['find'](_0x184c7f=>_0xe57fdb===0x1&&_0x184c7f['label']===_0x4f2995(0x1fa)||_0xe57fdb===0x2&&_0x184c7f[_0x4f2995(0x22e)]===_0x4f2995(0x244)));if(!_0x4548fb)throw new common_1[(_0x4f2995(0x237))]('所需绘画操作信息不存在!',common_1[_0x4f2995(0x230)][_0x4f2995(0x219)]);const {customId:_0x42c60d}=_0x4548fb;return{'customId':_0x42c60d,'prompt':_0x33caae,'extraParam':_0x46cc59,'drawId':_0x3a3606};}async[_0x412d53(0x1f2)](_0x3b60c7,_0x4e2db7){const _0x5448f2=_0x412d53,_0x11f59f=await this['midjourneyEntity']['findOne']({'where':{'id':_0x3b60c7,'userId':_0x4e2db7[_0x5448f2(0x208)]['id'],'isDelete':0x0}});if(!_0x11f59f)throw new common_1[(_0x5448f2(0x237))]('当前图片不存在！',common_1[_0x5448f2(0x230)]['BAD_REQUEST']);if(_0x11f59f[_0x5448f2(0x21e)]===0x2)throw new common_1[(_0x5448f2(0x237))](_0x5448f2(0x1e4),common_1[_0x5448f2(0x230)][_0x5448f2(0x219)]);const _0x48eebb=await this[_0x5448f2(0x220)]['update']({'id':_0x3b60c7},{'isDelete':0x1});if(_0x48eebb[_0x5448f2(0x1ea)]>0x0)return'删除成功！';else throw new common_1[(_0x5448f2(0x237))](_0x5448f2(0x1d5),common_1[_0x5448f2(0x230)][_0x5448f2(0x219)]);}async[_0x412d53(0x1d9)](_0x24bd67){const _0x4d448b=_0x412d53,{role:_0x560a57,id:_0x2add5f}=_0x24bd67[_0x4d448b(0x208)],_0x502514=await this[_0x4d448b(0x220)]['count']({'where':{'userId':_0x2add5f,'isDelete':0x0,'status':(0x0,typeorm_2['In'])([0x1,0x2])}}),_0xa1df9e=await this[_0x4d448b(0x243)][_0x4d448b(0x1ca)](['mjLimitCount']),_0x421980=_0xa1df9e?Number(_0xa1df9e):0x2;if(_0x502514>=_0x421980)throw new common_1['HttpException'](_0x4d448b(0x24d)+_0x421980+'个任务',common_1[_0x4d448b(0x230)]['BAD_REQUEST']);}async['drawFailed'](_0x153dd4){const _0x31e1de=_0x412d53,{id:_0x332b54,userId:_0x35523a,action:_0x49cdd4}=_0x153dd4;await this[_0x31e1de(0x220)]['update']({'id':_0x332b54},{'status':0x4});}async['drawSuccess'](_0x41a4fa){const _0x2a277b=_0x412d53,{id:_0x4e68a3,userId:_0xd0790f,action:_0x316de9}=_0x41a4fa,_0x5f2584=_0x316de9==='UPSCALE'?0x1:0x4;common_1[_0x2a277b(0x200)]['debug']('绘画完成，执行扣费，扣除费用:'+_0x5f2584+_0x2a277b(0x1db)),await this['userBalanceService']['refundMjBalance'](_0xd0790f,-_0x5f2584),await this[_0x2a277b(0x220)][_0x2a277b(0x1d7)]({'id':_0x4e68a3},{'status':0x3});}async['getList'](_0x47b42a){const _0x3dea0e=_0x412d53,{page:page=0x1,size:size=0x14,rec:_0x2fbfa8,userId:_0x463025,status:_0x81e61e}=_0x47b42a;if(Number(size)===0x3e7){const _0x39e979=await this['redisCacheService']['get']({'key':_0x3dea0e(0x1d4)});if(_0x39e979)try{return JSON['parse'](_0x39e979);}catch(_0x22dc7b){return[];}}const _0x31ab16={'isDelete':0x0};_0x2fbfa8&&Object['assign'](_0x31ab16,{'rec':_0x2fbfa8}),_0x463025&&Object[_0x3dea0e(0x1e7)](_0x31ab16,{'userId':_0x463025}),_0x81e61e&&Object[_0x3dea0e(0x1e7)](_0x31ab16,{'status':_0x81e61e});const [_0x312765,_0x3391c0]=await this['midjourneyEntity'][_0x3dea0e(0x1fc)]({'where':_0x31ab16,'order':{'id':_0x3dea0e(0x218)},'take':size,'skip':(page-0x1)*size,'select':['id',_0x3dea0e(0x209),_0x3dea0e(0x1ff),_0x3dea0e(0x22a),'prompt',_0x3dea0e(0x239),_0x3dea0e(0x1f1),_0x3dea0e(0x22c),'action',_0x3dea0e(0x21e)]});if(Number(size)===0x3e7){const _0x44988d={'rows':_0x312765[_0x3dea0e(0x259)](_0x2e8b97=>{const {id:_0x4aa45e,drawId:_0xf2098a,drawUrl:_0x193ba3,drawRatio:_0x47fc27,prompt:_0x213bbb,fullPrompt:_0x3dedb0,createdAt:_0x15c52f,rec:_0x19378e,action:_0x173c73,status:_0x59c3f7}=_0x2e8b97;return{'id':_0x4aa45e,'drawId':_0xf2098a,'drawUrl':_0x193ba3,'drawRatio':_0x47fc27,'prompt':_0x213bbb,'fullPrompt':_0x3dedb0,'createdAt':_0x15c52f,'rec':_0x19378e,'action':_0x173c73,'status':_0x59c3f7};}),'count':_0x3391c0};return await this[_0x3dea0e(0x1eb)][_0x3dea0e(0x235)]({'key':_0x3dea0e(0x1d4),'val':JSON[_0x3dea0e(0x249)](_0x44988d)},0x3c*0x5),_0x44988d;}const _0x1bbc45={'rows':_0x312765,'count':_0x3391c0};return _0x1bbc45;}async['getFullPrompt'](_0x30cd37){const _0x34db42=_0x412d53,_0x5206ff=await this['midjourneyEntity'][_0x34db42(0x232)]({'where':{'id':_0x30cd37}});if(!_0x5206ff)return'';const {fullPrompt:_0x15ae02}=_0x5206ff;return _0x15ae02;}async[_0x412d53(0x1ec)](_0x2dbeb0,_0xab68aa){const _0x140186=_0x412d53;try{const {page:page=0x1,size:size=0xa,rec:_0x1e068e,userId:_0x118a17,status:_0x8dd42f}=_0xab68aa,_0x5a827c={'isDelete':0x0};_0x1e068e&&Object[_0x140186(0x1e7)](_0x5a827c,{'rec':_0x1e068e}),_0x118a17&&Object[_0x140186(0x1e7)](_0x5a827c,{'userId':_0x118a17}),_0x8dd42f&&Object[_0x140186(0x1e7)](_0x5a827c,{'status':_0x8dd42f});const [_0x40df9d,_0x31e9ef]=await this['midjourneyEntity'][_0x140186(0x1fc)]({'where':_0x5a827c,'order':{'id':_0x140186(0x218)},'take':size,'skip':(page-0x1)*size}),_0x13f9cb=_0x40df9d[_0x140186(0x259)](_0x35fb5f=>_0x35fb5f[_0x140186(0x25a)])[_0x140186(0x23d)](_0x2a819a=>_0x2a819a<0x186a0),_0x282b10=await this[_0x140186(0x216)][_0x140186(0x1c2)]({'where':{'id':(0x0,typeorm_2['In'])(_0x13f9cb)},'select':['id',_0x140186(0x205),'avatar',_0x140186(0x255)]});return _0x40df9d[_0x140186(0x1f8)](_0x2ff601=>{const _0x1d1b6f=_0x140186;_0x2ff601[_0x1d1b6f(0x1fb)]=_0x282b10[_0x1d1b6f(0x1c2)](_0x149b25=>_0x149b25['id']===_0x2ff601[_0x1d1b6f(0x25a)]);}),_0x2dbeb0['user']['role']!=='super'&&_0x40df9d[_0x140186(0x1f8)](_0x2dacc7=>{const _0x88b721=_0x140186;_0x2dacc7[_0x88b721(0x1fb)]&&_0x2dacc7[_0x88b721(0x1fb)][_0x88b721(0x255)]&&(_0x2dacc7['userInfo'][_0x88b721(0x255)]=_0x2dacc7[_0x88b721(0x1fb)][_0x88b721(0x255)]['replace'](/(.{2}).+(.{2}@.+)/,_0x88b721(0x250)));}),{'rows':_0x40df9d,'count':_0x31e9ef};}catch(_0x2f689f){throw new common_1[(_0x140186(0x237))]('查询失败！',common_1[_0x140186(0x230)]['BAD_REQUEST']);}}async['recDraw'](_0x4a1930){const _0x43e76f=_0x412d53,{id:_0x40968f}=_0x4a1930,_0x417895=await this[_0x43e76f(0x220)][_0x43e76f(0x232)]({'where':{'id':_0x40968f,'status':0x3,'isDelete':0x0}});if(!_0x417895)throw new common_1[(_0x43e76f(0x237))]('当前图片不存在！',common_1[_0x43e76f(0x230)][_0x43e76f(0x219)]);const {rec:_0x4fd985}=_0x417895,_0x520ac7=await this[_0x43e76f(0x220)][_0x43e76f(0x1d7)]({'id':_0x40968f},{'rec':_0x4fd985===0x1?0x0:0x1});if(_0x520ac7[_0x43e76f(0x1ea)]>0x0)return _0x43e76f(0x236);}async['cleanQueue'](){const _0x4a103b=_0x412d53;try{await this[_0x4a103b(0x220)]['update']({'status':0x2},{'status':0x4});}catch(_0x12ae59){console[_0x4a103b(0x238)]('TODO->error:\x20',_0x12ae59);}}async['delLog'](_0x2d2b9a,_0x36ae27){const _0x3620ec=_0x412d53,{id:_0xe43b5d}=_0x36ae27;if(!_0xe43b5d)throw new common_1[(_0x3620ec(0x237))](_0x3620ec(0x247),common_1[_0x3620ec(0x230)][_0x3620ec(0x219)]);const _0xde44c5=await this[_0x3620ec(0x220)][_0x3620ec(0x1be)]({'id':_0xe43b5d});if(_0xde44c5[_0x3620ec(0x1ea)]>0x0)return _0x3620ec(0x21d);else throw new common_1[(_0x3620ec(0x237))](_0x3620ec(0x1d6),common_1[_0x3620ec(0x230)][_0x3620ec(0x219)]);}async[_0x412d53(0x1e0)](_0x2b5a4c,_0x48af6d){const _0x19aefe=_0x412d53;try{const {prompt:_0x593a09,status:_0x5790c5,isCarryParams:_0x427dbc,title:_0x278fe1,order:_0x2dd136,id:_0x4e8d2d,aspect:_0x3e3408}=_0x48af6d;return _0x4e8d2d?await this['mjPromptsEntity'][_0x19aefe(0x1d7)]({'id':_0x4e8d2d},{'prompt':_0x593a09,'status':_0x5790c5,'isCarryParams':_0x427dbc,'order':_0x2dd136,'aspect':_0x3e3408}):await this[_0x19aefe(0x1c4)][_0x19aefe(0x1e9)]({'prompt':_0x593a09,'status':_0x5790c5,'isCarryParams':_0x427dbc,'title':_0x278fe1,'order':_0x2dd136,'aspect':_0x3e3408});}catch(_0x38fbab){console['log'](_0x19aefe(0x202),_0x38fbab);}}async[_0x412d53(0x20a)](_0x5649d6,_0x60caad){const _0x10a43d=_0x412d53,{id:_0x30d94b}=_0x60caad;if(!_0x30d94b)throw new common_1[(_0x10a43d(0x237))](_0x10a43d(0x247),common_1[_0x10a43d(0x230)][_0x10a43d(0x219)]);return await this[_0x10a43d(0x1c4)][_0x10a43d(0x1be)]({'id':_0x30d94b});}async[_0x412d53(0x251)](){const _0x51aa80=_0x412d53;return await this[_0x51aa80(0x1c4)][_0x51aa80(0x1c2)]({'order':{'order':_0x51aa80(0x218)}});}async[_0x412d53(0x25e)](_0x12942a){const _0x7cedbd=_0x412d53,{url:_0x3ea5a3}=_0x12942a;if(!_0x3ea5a3)return;const _0x1f12fc=await axios_1['default'][_0x7cedbd(0x23a)](_0x3ea5a3,{'responseType':_0x7cedbd(0x1ef)}),_0x24d1ad=Buffer[_0x7cedbd(0x23f)](_0x1f12fc['data'])['toString'](_0x7cedbd(0x1f3));return _0x24d1ad;}};MidjourneyService=__decorate([(0x0,common_1[_0x412d53(0x231)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1[_0x412d53(0x226)])),__param(0x1,(0x0,typeorm_1[_0x412d53(0x1ed)])(user_entity_1[_0x412d53(0x23b)])),__param(0x2,(0x0,typeorm_1[_0x412d53(0x1ed)])(prompt_entity_1[_0x412d53(0x20c)])),__metadata(_0x412d53(0x21a),[typeorm_2[_0x412d53(0x203)],typeorm_2[_0x412d53(0x203)],typeorm_2['Repository'],globalConfig_service_1[_0x412d53(0x20e)],upload_service_1[_0x412d53(0x1e1)],userBalance_service_1['UserBalanceService'],redisCache_service_1[_0x412d53(0x1de)]])],MidjourneyService),exports[_0x412d53(0x254)]=MidjourneyService;