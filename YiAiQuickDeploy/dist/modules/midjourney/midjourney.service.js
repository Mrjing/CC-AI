'use strict';const _0x8a515e=_0x549e;function _0x47f7(){const _0x22da8a=['post','绘制中的图片任务、禁止删除！','super','mjPromptEntity','156820bNlbkp','data','user','getList','formatCreateOrUpdateDate','height','所需绘画操作信息不存在!','toString','test','------>\x20开始上传图片！！！','find','image-size','userId','from','@nestjs/common','../redisCache/redisCache.service','SUCCESS','积分。','affected','label','绘制成功,\x20URL:\x20','Repository','轮询过程中发生错误:\x20','findOne','4863232NBXLgC','../upload/upload.service','drawUrl','getAdminDrawList','.png','MidjourneyService','HttpException','error','个任务','Injectable','145BannRr','drawFailed','midjourneyEntity','removeEmoji','uploadFileFromUrl','sleep','default','删除记录失败！','prompt','GlobalConfigService','mjNotSaveImg','forEach','res','binary','parse','HttpStatus','metadata','userInfo','debug','UPSCALE','setPrompt','decorate','mjPromptsEntity','buttons','findAndCount','查询失败！','mjKey','@nestjs/typeorm','DESC','refundMjBalance','绘画完成，执行扣费，扣除费用:','TODO->error:\x20','删除成功！','MidjourneyStatusEnum','cleanQueue','userBalanceService','customId','getDrawList','54481JXCSad','object','./../user/user.entity','delLog','url','count','map','$1****$2','获取图片结果失败:\x20','uploadService','recDraw','drawId','updateDrawData','assign','action','DRAWED','WAITING','getConfigs','status','ZOOM','delPrompt','./prompt.entity','__metadata','addDrawQueue','绘画超时，请稍后再试！','createdAt','发送绘图指令失败、请联系管理员检测绘画配置！','264ZPPJij','IMAGINE','updateDrawStatus','email','startsWith','isDelete','username','pollComparisonResultDraw','log','design:paramtypes','2636349iYAYQT','delete','fullPrompt','deleteDraw','save','绘画ID:\x20','../userBalance/userBalance.service','sendDrawCommand','set','__decorate','globalConfigService','Zoom\x20Out\x202x','../../common/constants/midjourney.constant','Logger','userEntity','InjectRepository','arraybuffer','getImageSizeFromUrl','BAD_REQUEST','now','Error\x20in\x20addDrawQueue:','1754194zvcKtr','DRAWFAIL','orderId','proxyImg','update','base64','typeorm','getOwnPropertyDescriptor','function','get','mjProxyUrl','axios','/mj/submit/action','mjLimitCount','/mj/task/','删除失败！','存储图片失败，使用原始图片链接','UserBalanceService','UserEntity','177274BGOQVN','获取我得绘制列表失败','当前图片不存在！','queryPrompt','Zoom\x20Out\x201.5x','rec','midjourney:getList','DRAWING','Error\x20fetching\x20image\x20size:','redisCacheService','drawRatio','RedisCacheService','非法操作！','bindJobId','replace','length','19600479QVTsZX','draw','role'];_0x47f7=function(){return _0x22da8a;};return _0x47f7();}(function(_0x3af5da,_0x466a50){const _0x345c5f=_0x549e,_0x41ba25=_0x3af5da();while(!![]){try{const _0x40721d=-parseInt(_0x345c5f(0x1ab))/0x1+parseInt(_0x345c5f(0x198))/0x2+-parseInt(_0x345c5f(0x183))/0x3+parseInt(_0x345c5f(0x1c2))/0x4*(-parseInt(_0x345c5f(0x1e4))/0x5)+parseInt(_0x345c5f(0x225))/0x6*(parseInt(_0x345c5f(0x20a))/0x7)+-parseInt(_0x345c5f(0x1da))/0x8+parseInt(_0x345c5f(0x1bb))/0x9;if(_0x40721d===_0x466a50)break;else _0x41ba25['push'](_0x41ba25['shift']());}catch(_0x32c805){_0x41ba25['push'](_0x41ba25['shift']());}}}(_0x47f7,0x919fa));var __decorate=this&&this[_0x8a515e(0x18c)]||function(_0x2bab0e,_0x510f4a,_0x3fd715,_0x106185){const _0x374d2b=_0x8a515e;var _0x1474a5=arguments['length'],_0x1c5faa=_0x1474a5<0x3?_0x510f4a:_0x106185===null?_0x106185=Object[_0x374d2b(0x19f)](_0x510f4a,_0x3fd715):_0x106185,_0xeb0ebb;if(typeof Reflect===_0x374d2b(0x20b)&&typeof Reflect[_0x374d2b(0x1f9)]===_0x374d2b(0x1a0))_0x1c5faa=Reflect[_0x374d2b(0x1f9)](_0x2bab0e,_0x510f4a,_0x3fd715,_0x106185);else{for(var _0x2d102f=_0x2bab0e[_0x374d2b(0x1ba)]-0x1;_0x2d102f>=0x0;_0x2d102f--)if(_0xeb0ebb=_0x2bab0e[_0x2d102f])_0x1c5faa=(_0x1474a5<0x3?_0xeb0ebb(_0x1c5faa):_0x1474a5>0x3?_0xeb0ebb(_0x510f4a,_0x3fd715,_0x1c5faa):_0xeb0ebb(_0x510f4a,_0x3fd715))||_0x1c5faa;}return _0x1474a5>0x3&&_0x1c5faa&&Object['defineProperty'](_0x510f4a,_0x3fd715,_0x1c5faa),_0x1c5faa;},__metadata=this&&this[_0x8a515e(0x220)]||function(_0x5ac660,_0x2c49d0){const _0x581872=_0x8a515e;if(typeof Reflect===_0x581872(0x20b)&&typeof Reflect[_0x581872(0x1f4)]===_0x581872(0x1a0))return Reflect[_0x581872(0x1f4)](_0x5ac660,_0x2c49d0);},__param=this&&this['__param']||function(_0xe9c61,_0x48788f){return function(_0x1ac0ba,_0x30c14d){_0x48788f(_0x1ac0ba,_0x30c14d,_0xe9c61);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x8a515e(0x1df)]=void 0x0;function _0x549e(_0x282f8c,_0x310188){const _0x47f77b=_0x47f7();return _0x549e=function(_0x549eb6,_0x2dd598){_0x549eb6=_0x549eb6-0x181;let _0xf77817=_0x47f77b[_0x549eb6];return _0xf77817;},_0x549e(_0x282f8c,_0x310188);}const user_entity_1=require(_0x8a515e(0x20c)),common_1=require(_0x8a515e(0x1d0)),typeorm_1=require(_0x8a515e(0x1ff)),midjourney_entity_1=require('./midjourney.entity'),typeorm_2=require(_0x8a515e(0x19e)),axios_1=require(_0x8a515e(0x1a3)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),midjourney_constant_1=require(_0x8a515e(0x18f)),upload_service_1=require(_0x8a515e(0x1db)),userBalance_service_1=require(_0x8a515e(0x189)),utils_1=require('../../common/utils'),redisCache_service_1=require(_0x8a515e(0x1d1)),prompt_entity_1=require(_0x8a515e(0x21f)),image_size_1=require(_0x8a515e(0x1cd));let MidjourneyService=class MidjourneyService{constructor(_0x537cba,_0x239e24,_0x57e731,_0x51c6d3,_0x132ea8,_0x182e05,_0x214196){const _0x4448be=_0x8a515e;this[_0x4448be(0x1e6)]=_0x537cba,this[_0x4448be(0x191)]=_0x239e24,this[_0x4448be(0x1fa)]=_0x57e731,this[_0x4448be(0x18d)]=_0x51c6d3,this['uploadService']=_0x132ea8,this[_0x4448be(0x207)]=_0x182e05,this['redisCacheService']=_0x214196,this['lockPrompt']=[];}async[_0x8a515e(0x1e9)](_0x2a6d20){return new Promise(_0xebf4c5=>setTimeout(_0xebf4c5,_0x2a6d20));}async[_0x8a515e(0x194)](_0x4e0e1f){const _0x7598d9=_0x8a515e;try{const _0x21041b=await axios_1[_0x7598d9(0x1ea)][_0x7598d9(0x1a1)](_0x4e0e1f,{'responseType':_0x7598d9(0x193)}),_0x59b187=Buffer[_0x7598d9(0x1cf)](_0x21041b[_0x7598d9(0x1c3)],_0x7598d9(0x1f1)),_0x4d38d=(0x0,image_size_1['default'])(_0x59b187);return{'width':_0x4d38d['width'],'height':_0x4d38d[_0x7598d9(0x1c7)]};}catch(_0x2545f0){console[_0x7598d9(0x1e1)](_0x7598d9(0x1b3),_0x2545f0);throw _0x2545f0;}}async[_0x8a515e(0x1bc)](_0x5b9cb8,_0xbf620){const _0x274af1=_0x8a515e,{id:_0x3cabf8,action:_0x2491bc,drawId:_0x1736a8}=_0x5b9cb8,_0x1a0629=await this[_0x274af1(0x1e6)]['findOne']({'where':{'id':_0x3cabf8}}),{customId:_0x52de4e}=_0x1a0629;try{await this[_0x274af1(0x1b8)](_0x3cabf8,_0xbf620),await this['updateDrawStatus'](_0x3cabf8,midjourney_constant_1['MidjourneyStatusEnum'][_0x274af1(0x1b2)]);const _0x5735f3=await this[_0x274af1(0x18a)](_0x1a0629,_0x2491bc);_0x1a0629[_0x274af1(0x215)]=_0x5735f3;const _0x246db0=await this[_0x274af1(0x22c)](_0x3cabf8,_0x1a0629);return await this[_0x274af1(0x216)](_0x5b9cb8,_0x246db0),this['drawSuccess'](_0x5b9cb8),!![];}catch(_0x484bd8){return console[_0x274af1(0x181)]('error:\x20',_0x484bd8),!![];}}async[_0x8a515e(0x221)](_0x5b8888){const _0x2832a9=_0x8a515e;try{const {prompt:_0x2e6a4c,imgUrl:imgUrl='',extraParam:extraParam='',action:_0x2a0196,userId:_0x45b0fb,orderId:_0x5a6ac2,customId:_0x3b37d5,drawId:_0x8a2245}=_0x5b8888,_0x37c65e=imgUrl?imgUrl+'\x20'+_0x2e6a4c+'\x20'+extraParam:_0x2e6a4c+'\x20'+extraParam,_0x324dac={'userId':_0x45b0fb,'drawId':_0x8a2245,'extraParam':extraParam,'prompt':_0x2e6a4c,'imgUrl':imgUrl,'fullPrompt':_0x37c65e,'status':midjourney_constant_1[_0x2832a9(0x205)][_0x2832a9(0x21a)],'action':_0x2a0196,'orderId':_0x5a6ac2,'customId':_0x3b37d5},_0x3f84b3=await this[_0x2832a9(0x1e6)]['save'](_0x324dac);return _0x3f84b3;}catch(_0x27f1f9){console['error'](_0x2832a9(0x197),_0x27f1f9);throw _0x27f1f9;}}async[_0x8a515e(0x227)](_0x8feb2e,_0x8c3c9f){const _0x1a4e23=_0x8a515e;await this[_0x1a4e23(0x1e6)][_0x1a4e23(0x19c)]({'id':_0x8feb2e},{'status':_0x8c3c9f});}async['updateDrawData'](_0x249468,_0x1e66e5){const _0x5e85ad=_0x8a515e;try{const {id:_0x43f4b3,imageUrl:_0x26b8c1,action:_0x2b0f50,submitTime:_0x21896e,finishTime:_0x19118c,progress:_0x53f556}=_0x1e66e5,_0x2a6185=_0x19118c-_0x21896e;let _0xdc5b4=Date['now']()+'-'+_0x43f4b3+_0x5e85ad(0x1de);const _0x265356=await this['globalConfigService'][_0x5e85ad(0x21b)]([_0x5e85ad(0x1ee)]);let _0x5b52a3='',_0x39e0e0=!![];try{!Number(_0x265356)||Number(_0x265356)===0x0?(common_1[_0x5e85ad(0x190)][_0x5e85ad(0x1f6)](_0x5e85ad(0x1cb),_0x5e85ad(0x1df)),_0x5b52a3=await this[_0x5e85ad(0x213)][_0x5e85ad(0x1e8)]({'filename':_0xdc5b4,'url':_0x26b8c1})):(_0x5b52a3=_0x26b8c1,_0x39e0e0=![],common_1[_0x5e85ad(0x190)][_0x5e85ad(0x1f6)]('本次不存图片了',_0x5e85ad(0x1df)));}catch(_0x3d692c){common_1['Logger'][_0x5e85ad(0x1e1)](_0x5e85ad(0x1a8),'MidjourneyService'),_0x5b52a3=_0x26b8c1,_0x39e0e0=![];}const {width:_0x4cdcd9,height:_0x18c18c}=await this[_0x5e85ad(0x194)](_0x26b8c1),_0x7ace62={'status':midjourney_constant_1[_0x5e85ad(0x205)][_0x5e85ad(0x219)],'drawId':_0x43f4b3,'action':_0x2b0f50,'drawUrl':_0x5b52a3,'drawRatio':_0x4cdcd9+'x'+_0x18c18c,'progress':0x64,'extend':this[_0x5e85ad(0x1e7)](JSON['stringify'](_0x1e66e5)),'durationSpent':_0x2a6185,'isSaveImg':_0x39e0e0};await this['midjourneyEntity'][_0x5e85ad(0x19c)]({'id':_0x249468['id']},_0x7ace62);}catch(_0x10f9cb){throw new common_1[(_0x5e85ad(0x1e0))]('更新绘画数据失败',common_1['HttpStatus'][_0x5e85ad(0x195)]);}}async[_0x8a515e(0x18a)](_0x329602,_0x15539c){const _0x1ecd12=_0x8a515e,_0x484dc0=await this[_0x1ecd12(0x18d)][_0x1ecd12(0x21b)]([_0x1ecd12(0x1a2)]),_0x160a0d=await this[_0x1ecd12(0x18d)]['getConfigs'](['mjKey']),{id:_0x12e5b8,fullPrompt:_0x3fc487,imgUrl:_0x55ae4d,drawId:_0x1a4b87,customId:_0x33fc67}=_0x329602,_0x25e720=_0x55ae4d?_0x55ae4d+'\x20'+_0x3fc487:''+_0x3fc487;let _0x43e357='',_0x5042c0={};const _0x428cf2=0x3;let _0x3a992f=0x0;while(_0x3a992f<_0x428cf2){try{_0x15539c===_0x1ecd12(0x226)?(_0x43e357=_0x484dc0+'/mj/submit/imagine',_0x5042c0={'prompt':_0x25e720}):(_0x43e357=_0x484dc0+_0x1ecd12(0x1a4),_0x5042c0={'taskId':_0x1a4b87,'customId':_0x33fc67});const _0x51c078={'mj-api-secret':_0x160a0d};console[_0x1ecd12(0x181)](_0x1ecd12(0x20e),_0x43e357),console[_0x1ecd12(0x181)]('payloadJson',_0x5042c0);const _0x21fd9f=await axios_1[_0x1ecd12(0x1ea)][_0x1ecd12(0x1be)](_0x43e357,_0x5042c0,{'headers':_0x51c078}),{result:_0xd4fd6f}=_0x21fd9f[_0x1ecd12(0x1c3)];console[_0x1ecd12(0x181)](_0x1ecd12(0x1f0),_0x21fd9f[_0x1ecd12(0x1c3)]);if(_0xd4fd6f)return common_1['Logger'][_0x1ecd12(0x181)](_0x1ecd12(0x188)+_0xd4fd6f,_0x1ecd12(0x1df)),_0xd4fd6f;else throw new Error('未能获取结果数据');}catch(_0x3ce455){console[_0x1ecd12(0x181)](_0x1ecd12(0x1e1),_0x3ce455),_0x3a992f++;if(_0x3a992f>=_0x428cf2){await this[_0x1ecd12(0x227)](_0x12e5b8,midjourney_constant_1[_0x1ecd12(0x205)][_0x1ecd12(0x199)]);throw new common_1[(_0x1ecd12(0x1e0))](_0x1ecd12(0x224),common_1[_0x1ecd12(0x1f3)][_0x1ecd12(0x195)]);}}}}async[_0x8a515e(0x22c)](_0x2dffe8,_0x49a584){const _0x30501c=_0x8a515e,_0x4dc7dd=await this['globalConfigService']['getConfigs']([_0x30501c(0x1a2)]),_0x1d6175=await this[_0x30501c(0x18d)][_0x30501c(0x21b)]([_0x30501c(0x1fe)]),_0x53a106=Date[_0x30501c(0x196)](),_0x488ed9=0x1388,_0x339b63=0x249f0;let _0x523da5=0x0,_0x4b5480=0x0;const _0x3a008e=0x5,{drawId:_0x4f61a2}=_0x49a584;try{while(Date[_0x30501c(0x196)]()-_0x53a106<_0x339b63&&_0x4b5480<_0x3a008e){await new Promise(_0x4246de=>setTimeout(_0x4246de,_0x488ed9));try{const _0x2f3323={'Content-Type':'application/x-www-form-urlencoded','mj-api-secret':_0x1d6175},_0x232cd4=_0x4dc7dd+_0x30501c(0x1a6)+_0x4f61a2+'/fetch',_0x25e9a6=await axios_1[_0x30501c(0x1ea)]['get'](_0x232cd4,{'headers':_0x2f3323}),_0x45497c=_0x25e9a6[_0x30501c(0x1c3)],_0x42386f=_0x45497c['process'];await this[_0x30501c(0x1e6)][_0x30501c(0x19c)]({'id':_0x2dffe8},{'progress':_0x42386f});if(_0x45497c[_0x30501c(0x21c)]===_0x30501c(0x1d2))return common_1[_0x30501c(0x190)][_0x30501c(0x181)](_0x30501c(0x1d6)+_0x45497c['imageUrl'],_0x30501c(0x1df)),_0x45497c;}catch(_0x59320d){_0x4b5480++,common_1[_0x30501c(0x190)][_0x30501c(0x1e1)](_0x30501c(0x1d8)+_0x59320d,_0x30501c(0x1df));}_0x523da5++;}if(_0x4b5480>=_0x3a008e){await this[_0x30501c(0x227)](_0x2dffe8,midjourney_constant_1['MidjourneyStatusEnum'][_0x30501c(0x199)]);throw new common_1[(_0x30501c(0x1e0))]('轮询失败次数过多，请稍后再试！',common_1[_0x30501c(0x1f3)][_0x30501c(0x195)]);}common_1[_0x30501c(0x190)][_0x30501c(0x1e1)](_0x30501c(0x222),_0x30501c(0x1df)),await this['updateDrawStatus'](_0x2dffe8,midjourney_constant_1['MidjourneyStatusEnum'][_0x30501c(0x199)]);throw new common_1[(_0x30501c(0x1e0))](_0x30501c(0x222),common_1['HttpStatus'][_0x30501c(0x195)]);}catch(_0x1f0f4d){common_1['Logger'][_0x30501c(0x1e1)](_0x30501c(0x212),_0x1f0f4d,_0x30501c(0x1df)),await this[_0x30501c(0x227)](_0x2dffe8,midjourney_constant_1[_0x30501c(0x205)]['DRAWFAIL']);throw _0x1f0f4d;}}[_0x8a515e(0x1e7)](_0x403840){const _0x3b6dce=_0x8a515e,_0x550604=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x403840[_0x3b6dce(0x1b9)](_0x550604,'');}async['bindJobId'](_0x390ddf,_0x43007a){const _0x53e931=_0x8a515e;await this[_0x53e931(0x1e6)]['update']({'id':_0x390ddf},{'jobId':_0x43007a});}async[_0x8a515e(0x209)](_0x3516e3,_0x23ec9d){const _0x182e86=_0x8a515e;try{const {page:page=0x1,size:size=0x1e}=_0x23ec9d,[_0x15d355,_0x170585]=await this[_0x182e86(0x1e6)]['findAndCount']({'where':{'userId':_0x3516e3['user']['id'],'isDelete':0x0},'order':{'id':_0x182e86(0x200)},'take':size,'skip':(page-0x1)*size,'select':['id',_0x182e86(0x1ce),_0x182e86(0x1ec),'extraParam',_0x182e86(0x185),_0x182e86(0x1b0),_0x182e86(0x19a),_0x182e86(0x215),'drawUrl','drawRatio',_0x182e86(0x22a),_0x182e86(0x21c),_0x182e86(0x218)]}),_0x4f1a67=await this[_0x182e86(0x1e6)][_0x182e86(0x20f)]({'where':{'isDelete':0x0,'status':(0x0,typeorm_2['In'])([0x1,0x2])}}),_0x3f1352={'rows':(0x0,utils_1[_0x182e86(0x1c6)])(_0x15d355),'count':_0x170585,'countQueue':_0x4f1a67};return _0x3f1352;}catch(_0x2e8f1e){throw new common_1[(_0x182e86(0x1e0))](_0x182e86(0x1ac),common_1['HttpStatus'][_0x182e86(0x195)]);}}async['getDrawActionDetail'](_0x5bf5fc,_0x3956f7,_0x26b2f2){const _0x237c4a=_0x8a515e,_0x551e3b=await this[_0x237c4a(0x1e6)][_0x237c4a(0x1d9)]({'where':{'drawId':_0x3956f7}}),{extend:_0x12dad7,prompt:_0x24983e,imgUrl:_0x52e576,extraParam:_0x29777d}=_0x551e3b,_0x3231df=JSON['parse'](_0x12dad7),_0xbc1cd9=_0x3231df[_0x237c4a(0x1fb)]||[];let _0x5e9a33;_0x5bf5fc==='UPSCALE'&&(_0x5e9a33=_0xbc1cd9[_0x237c4a(0x1cc)](_0x476354=>{const _0x368004=_0x237c4a,_0x4b9db6=_0x476354[_0x368004(0x1d5)]['startsWith']('U'+_0x26b2f2),_0x42d133=_0x26b2f2===0x1&&/(Redo )?Upscale \(Subtle\)/[_0x368004(0x1ca)](_0x476354[_0x368004(0x1d5)])||_0x26b2f2===0x2&&/(Redo )?Upscale \(Creative\)/[_0x368004(0x1ca)](_0x476354[_0x368004(0x1d5)]);return _0x4b9db6||_0x42d133;}));_0x5bf5fc==='VARIATION'&&(_0x5e9a33=_0xbc1cd9[_0x237c4a(0x1cc)](_0xc6ab16=>{const _0x2b7758=_0x237c4a,_0x2a5cdf=_0xc6ab16[_0x2b7758(0x1d5)][_0x2b7758(0x229)]('V'+_0x26b2f2),_0x4bf9af=_0x26b2f2===0x1&&/Vary \(Strong\)/[_0x2b7758(0x1ca)](_0xc6ab16[_0x2b7758(0x1d5)])||_0x26b2f2===0x2&&/Vary \(Region\)/[_0x2b7758(0x1ca)](_0xc6ab16[_0x2b7758(0x1d5)]);return _0x2a5cdf||_0x4bf9af;}));_0x5bf5fc==='REGENERATE'&&(_0x5e9a33=_0xbc1cd9[_0x237c4a(0x1cc)](_0xe512f=>_0xe512f[_0x237c4a(0x208)]['startsWith']('MJ::JOB::reroll::0::')&&_0xe512f['label']===''));_0x5bf5fc===_0x237c4a(0x21d)&&(_0x5e9a33=_0xbc1cd9['find'](_0x385931=>_0x26b2f2===0x1&&_0x385931[_0x237c4a(0x1d5)]===_0x237c4a(0x18e)||_0x26b2f2===0x2&&_0x385931[_0x237c4a(0x1d5)]===_0x237c4a(0x1af)));if(!_0x5e9a33)throw new common_1[(_0x237c4a(0x1e0))](_0x237c4a(0x1c8),common_1[_0x237c4a(0x1f3)]['BAD_REQUEST']);const {customId:_0x1b7add}=_0x5e9a33;return{'customId':_0x1b7add,'prompt':_0x24983e,'extraParam':_0x29777d,'drawId':_0x3956f7};}async[_0x8a515e(0x186)](_0x561d69,_0x5cb0f1){const _0x2647c7=_0x8a515e,_0x16ad6c=await this[_0x2647c7(0x1e6)][_0x2647c7(0x1d9)]({'where':{'id':_0x561d69,'userId':_0x5cb0f1[_0x2647c7(0x1c4)]['id'],'isDelete':0x0}});if(!_0x16ad6c)throw new common_1[(_0x2647c7(0x1e0))](_0x2647c7(0x1ad),common_1[_0x2647c7(0x1f3)][_0x2647c7(0x195)]);if(_0x16ad6c[_0x2647c7(0x21c)]===0x2)throw new common_1['HttpException'](_0x2647c7(0x1bf),common_1[_0x2647c7(0x1f3)][_0x2647c7(0x195)]);const _0x5bf423=await this[_0x2647c7(0x1e6)]['update']({'id':_0x561d69},{'isDelete':0x1});if(_0x5bf423[_0x2647c7(0x1d4)]>0x0)return _0x2647c7(0x204);else throw new common_1['HttpException'](_0x2647c7(0x1a7),common_1[_0x2647c7(0x1f3)][_0x2647c7(0x195)]);}async['checkLimit'](_0x51f247){const _0x3a59ff=_0x8a515e,{role:_0x44b85a,id:_0x5e1ed7}=_0x51f247[_0x3a59ff(0x1c4)],_0x1b2d96=await this[_0x3a59ff(0x1e6)][_0x3a59ff(0x20f)]({'where':{'userId':_0x5e1ed7,'isDelete':0x0,'status':(0x0,typeorm_2['In'])([0x1,0x2])}}),_0x3bdc85=await this[_0x3a59ff(0x18d)]['getConfigs']([_0x3a59ff(0x1a5)]),_0x50ef16=_0x3bdc85?Number(_0x3bdc85):0x2;if(_0x1b2d96>=_0x50ef16)throw new common_1[(_0x3a59ff(0x1e0))]('当前管理员限制单用户同时最多能执行'+_0x50ef16+_0x3a59ff(0x1e2),common_1[_0x3a59ff(0x1f3)]['BAD_REQUEST']);}async[_0x8a515e(0x1e5)](_0x1ce235){const _0x3f653f=_0x8a515e,{id:_0x4b2811,userId:_0x4d232e,action:_0xaf7d3d}=_0x1ce235;await this[_0x3f653f(0x1e6)][_0x3f653f(0x19c)]({'id':_0x4b2811},{'status':0x4});}async['drawSuccess'](_0x494a17){const _0x214e91=_0x8a515e,{id:_0x4ef368,userId:_0x115194,action:_0x18139b}=_0x494a17,_0x4461d9=_0x18139b===_0x214e91(0x1f7)?0x1:0x4;common_1[_0x214e91(0x190)]['debug'](_0x214e91(0x202)+_0x4461d9+_0x214e91(0x1d3)),await this[_0x214e91(0x207)][_0x214e91(0x201)](_0x115194,-_0x4461d9),await this[_0x214e91(0x1e6)]['update']({'id':_0x4ef368},{'status':0x3});}async[_0x8a515e(0x1c5)](_0x538ac2){const _0x23b7f5=_0x8a515e,{page:page=0x1,size:size=0x14,rec:_0x5887ba,userId:_0x3f4dcc,status:_0xcec82f}=_0x538ac2;if(Number(size)===0x3e7){const _0x565545=await this[_0x23b7f5(0x1b4)]['get']({'key':_0x23b7f5(0x1b1)});if(_0x565545)try{return JSON[_0x23b7f5(0x1f2)](_0x565545);}catch(_0x5715c4){return[];}}const _0x4edd7b={'isDelete':0x0};_0x5887ba&&Object['assign'](_0x4edd7b,{'rec':_0x5887ba}),_0x3f4dcc&&Object[_0x23b7f5(0x217)](_0x4edd7b,{'userId':_0x3f4dcc}),_0xcec82f&&Object[_0x23b7f5(0x217)](_0x4edd7b,{'status':_0xcec82f});const [_0x565832,_0x314f08]=await this[_0x23b7f5(0x1e6)][_0x23b7f5(0x1fc)]({'where':_0x4edd7b,'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size,'select':['id','drawId',_0x23b7f5(0x1dc),_0x23b7f5(0x1b5),_0x23b7f5(0x1ec),_0x23b7f5(0x185),_0x23b7f5(0x1b0),_0x23b7f5(0x223),_0x23b7f5(0x218),_0x23b7f5(0x21c)]});if(Number(size)===0x3e7){const _0x18fbec={'rows':_0x565832[_0x23b7f5(0x210)](_0x5b2606=>{const {id:_0x53ae63,drawId:_0x429cc0,drawUrl:_0x3df18d,drawRatio:_0x1b80aa,prompt:_0x4dd9ad,fullPrompt:_0x2ca542,createdAt:_0x33cfd4,rec:_0x45b139,action:_0x373ddd,status:_0x3882a9}=_0x5b2606;return{'id':_0x53ae63,'drawId':_0x429cc0,'drawUrl':_0x3df18d,'drawRatio':_0x1b80aa,'prompt':_0x4dd9ad,'fullPrompt':_0x2ca542,'createdAt':_0x33cfd4,'rec':_0x45b139,'action':_0x373ddd,'status':_0x3882a9};}),'count':_0x314f08};return await this[_0x23b7f5(0x1b4)][_0x23b7f5(0x18b)]({'key':_0x23b7f5(0x1b1),'val':JSON['stringify'](_0x18fbec)},0x3c*0x5),_0x18fbec;}const _0x554c51={'rows':_0x565832,'count':_0x314f08};return _0x554c51;}async['getFullPrompt'](_0x3541b1){const _0x8f05c2=await this['midjourneyEntity']['findOne']({'where':{'id':_0x3541b1}});if(!_0x8f05c2)return'';const {fullPrompt:_0x16a4c1}=_0x8f05c2;return _0x16a4c1;}async[_0x8a515e(0x1dd)](_0x3d2acd,_0x463e47){const _0x5f31c0=_0x8a515e;try{const {page:page=0x1,size:size=0xa,rec:_0x1ac973,userId:_0x3aeded,status:_0x2b2493}=_0x463e47,_0xe95cc4={'isDelete':0x0};_0x1ac973&&Object[_0x5f31c0(0x217)](_0xe95cc4,{'rec':_0x1ac973}),_0x3aeded&&Object['assign'](_0xe95cc4,{'userId':_0x3aeded}),_0x2b2493&&Object[_0x5f31c0(0x217)](_0xe95cc4,{'status':_0x2b2493});const [_0x312097,_0x40f3cd]=await this[_0x5f31c0(0x1e6)]['findAndCount']({'where':_0xe95cc4,'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size}),_0x3f071c=_0x312097['map'](_0x5ad1ad=>_0x5ad1ad[_0x5f31c0(0x1ce)])['filter'](_0x4742a0=>_0x4742a0<0x186a0),_0x438ec0=await this['userEntity'][_0x5f31c0(0x1cc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3f071c)},'select':['id',_0x5f31c0(0x22b),'avatar',_0x5f31c0(0x228)]});return _0x312097[_0x5f31c0(0x1ef)](_0x9b9c8a=>{const _0x134627=_0x5f31c0;_0x9b9c8a['userInfo']=_0x438ec0['find'](_0x486b63=>_0x486b63['id']===_0x9b9c8a[_0x134627(0x1ce)]);}),_0x3d2acd['user'][_0x5f31c0(0x1bd)]!==_0x5f31c0(0x1c0)&&_0x312097['forEach'](_0x38e28b=>{const _0x2b3b17=_0x5f31c0;_0x38e28b[_0x2b3b17(0x1f5)]&&_0x38e28b[_0x2b3b17(0x1f5)][_0x2b3b17(0x228)]&&(_0x38e28b[_0x2b3b17(0x1f5)][_0x2b3b17(0x228)]=_0x38e28b[_0x2b3b17(0x1f5)][_0x2b3b17(0x228)]['replace'](/(.{2}).+(.{2}@.+)/,_0x2b3b17(0x211)));}),{'rows':_0x312097,'count':_0x40f3cd};}catch(_0x243df5){throw new common_1['HttpException'](_0x5f31c0(0x1fd),common_1[_0x5f31c0(0x1f3)][_0x5f31c0(0x195)]);}}async[_0x8a515e(0x214)](_0x4d2209){const _0x229733=_0x8a515e,{id:_0x2524c7}=_0x4d2209,_0x15377c=await this[_0x229733(0x1e6)][_0x229733(0x1d9)]({'where':{'id':_0x2524c7,'status':0x3,'isDelete':0x0}});if(!_0x15377c)throw new common_1[(_0x229733(0x1e0))](_0x229733(0x1ad),common_1[_0x229733(0x1f3)][_0x229733(0x195)]);const {rec:_0x7789c5}=_0x15377c,_0x4d2ae6=await this[_0x229733(0x1e6)][_0x229733(0x19c)]({'id':_0x2524c7},{'rec':_0x7789c5===0x1?0x0:0x1});if(_0x4d2ae6[_0x229733(0x1d4)]>0x0)return'操作成功！';}async[_0x8a515e(0x206)](){const _0x31c190=_0x8a515e;try{await this[_0x31c190(0x1e6)][_0x31c190(0x19c)]({'status':0x2},{'status':0x4});}catch(_0x1e1cad){console[_0x31c190(0x181)](_0x31c190(0x203),_0x1e1cad);}}async[_0x8a515e(0x20d)](_0xee7261,_0x33d40c){const _0x4528be=_0x8a515e,{id:_0xbd177c}=_0x33d40c;if(!_0xbd177c)throw new common_1[(_0x4528be(0x1e0))](_0x4528be(0x1b7),common_1['HttpStatus'][_0x4528be(0x195)]);const _0x44757b=await this[_0x4528be(0x1e6)][_0x4528be(0x184)]({'id':_0xbd177c});if(_0x44757b[_0x4528be(0x1d4)]>0x0)return'删除记录成功！';else throw new common_1[(_0x4528be(0x1e0))](_0x4528be(0x1eb),common_1[_0x4528be(0x1f3)][_0x4528be(0x195)]);}async[_0x8a515e(0x1f8)](_0x24fba9,_0x537614){const _0x207dcb=_0x8a515e;try{const {prompt:_0x558e98,status:_0x16fef7,isCarryParams:_0x140466,title:_0x21b134,order:_0x4d1792,id:_0x1a453d,aspect:_0x299178}=_0x537614;return _0x1a453d?await this[_0x207dcb(0x1fa)]['update']({'id':_0x1a453d},{'prompt':_0x558e98,'status':_0x16fef7,'isCarryParams':_0x140466,'order':_0x4d1792,'aspect':_0x299178}):await this[_0x207dcb(0x1fa)][_0x207dcb(0x187)]({'prompt':_0x558e98,'status':_0x16fef7,'isCarryParams':_0x140466,'title':_0x21b134,'order':_0x4d1792,'aspect':_0x299178});}catch(_0x58a4d){console['log']('error:\x20',_0x58a4d);}}async[_0x8a515e(0x21e)](_0x471284,_0x409061){const _0x5b6768=_0x8a515e,{id:_0x18c7e7}=_0x409061;if(!_0x18c7e7)throw new common_1[(_0x5b6768(0x1e0))]('非法操作！',common_1['HttpStatus']['BAD_REQUEST']);return await this[_0x5b6768(0x1fa)][_0x5b6768(0x184)]({'id':_0x18c7e7});}async[_0x8a515e(0x1ae)](){const _0x425da2=_0x8a515e;return await this[_0x425da2(0x1fa)]['find']({'order':{'order':'DESC'}});}async[_0x8a515e(0x19b)](_0x5d1e6b){const _0x557e76=_0x8a515e,{url:_0x215d12}=_0x5d1e6b;if(!_0x215d12)return;const _0x281e23=await axios_1[_0x557e76(0x1ea)][_0x557e76(0x1a1)](_0x215d12,{'responseType':'arraybuffer'}),_0x3b152c=Buffer[_0x557e76(0x1cf)](_0x281e23[_0x557e76(0x1c3)])[_0x557e76(0x1c9)](_0x557e76(0x19d));return _0x3b152c;}};MidjourneyService=__decorate([(0x0,common_1[_0x8a515e(0x1e3)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1['MidjourneyEntity'])),__param(0x1,(0x0,typeorm_1[_0x8a515e(0x192)])(user_entity_1[_0x8a515e(0x1aa)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(prompt_entity_1[_0x8a515e(0x1c1)])),__metadata(_0x8a515e(0x182),[typeorm_2['Repository'],typeorm_2[_0x8a515e(0x1d7)],typeorm_2['Repository'],globalConfig_service_1[_0x8a515e(0x1ed)],upload_service_1['UploadService'],userBalance_service_1[_0x8a515e(0x1a9)],redisCache_service_1[_0x8a515e(0x1b6)]])],MidjourneyService),exports['MidjourneyService']=MidjourneyService;