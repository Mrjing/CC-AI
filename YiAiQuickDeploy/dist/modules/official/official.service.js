'use strict';const _0x34082a=_0x1f6b;function _0x4359(){const _0x25fcb0=['AutoreplyService','decorate','../autoreply/autoreply.service','132uqbjpc','chatgptService','../globalConfig/globalConfig.service','getQRSceneStr','checkAutoReply','digest','__decorate','loginByCode','split','17512wgrZTh','scanedSceneStrMap','chatSyncFree','default','update','1752EDQkIR','getConfigs','../../common/utils','accessToken***','get','toFixed','qrcodecreate','hex','race','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','sceneStrMap','57968tlRncl',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','来自公众号的回复问题\x20=======>\x20超时导致问题无法回答完整','getOwnPropertyDescriptor','user','getUserById','@nestjs/common','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','3653133uliAXK','scan','crypto','HttpStatus','verify','bindWx','str:\x20','genXmlMsgByConfig','&timestamp=','object','6FiKVba','log','AuthService','非法参数','来自公众号的询问问题\x20=======>\x20','21TAAXCt','createHash','post','wechatAccessToken','axios','genXmlMsg','&code=','function','wechatOfficialAppId','wechatJsapiTicket','回跳跳转地址:\x20','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','1QPZJTp','getJsapiTicket','getQRSceneStrByBind','BAD_REQUEST','sort','sha1','authService','../auth/auth.service','https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=','onModuleInit','globalConfigService','请求超时',']]></Content>\x0a\x20\x20\x20\x20</xml>','wechatOfficialAppSecret','createRandomNonceStr','../chatgpt/chatgpt.service','autoreplyService','10kwQoyb','&grant_type=authorization_code','metadata','now','length','getUserOpenId','getUserFromOpenId','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','aotoPlay','fetchQRCodeTicket','HttpException','getQRCodeTicket','OfficialService','716882psJfqU','400803drVIDT','fromusername','GlobalConfigService','jsapi_ticket=','__esModule','QR_STR_SCENE','UserService','userService','&url=','loginBySceneStr','defineProperty','appId:\x20','9815tJOrIZ','4458078neUpNC','__metadata'];_0x4359=function(){return _0x25fcb0;};return _0x4359();}(function(_0x5b4548,_0x3327ab){const _0x52c955=_0x1f6b,_0x1b9f42=_0x5b4548();while(!![]){try{const _0x168197=parseInt(_0x52c955(0x224))/0x1*(-parseInt(_0x52c955(0x1d5))/0x2)+-parseInt(_0x52c955(0x213))/0x3*(-parseInt(_0x52c955(0x201))/0x4)+-parseInt(_0x52c955(0x1e2))/0x5*(-parseInt(_0x52c955(0x1f6))/0x6)+parseInt(_0x52c955(0x218))/0x7*(parseInt(_0x52c955(0x1f1))/0x8)+-parseInt(_0x52c955(0x1e3))/0x9+parseInt(_0x52c955(0x1c8))/0xa*(parseInt(_0x52c955(0x209))/0xb)+-parseInt(_0x52c955(0x1e8))/0xc*(-parseInt(_0x52c955(0x1d6))/0xd);if(_0x168197===_0x3327ab)break;else _0x1b9f42['push'](_0x1b9f42['shift']());}catch(_0x1b37c0){_0x1b9f42['push'](_0x1b9f42['shift']());}}}(_0x4359,0x680e0));function _0x1f6b(_0x550b41,_0x13e153){const _0x4359d9=_0x4359();return _0x1f6b=function(_0x1f6b21,_0x1bcb73){_0x1f6b21=_0x1f6b21-0x1be;let _0x31a028=_0x4359d9[_0x1f6b21];return _0x31a028;},_0x1f6b(_0x550b41,_0x13e153);}var __decorate=this&&this[_0x34082a(0x1ee)]||function(_0x12bdd5,_0x324979,_0x53f6fe,_0x12b14e){const _0x18d82c=_0x34082a;var _0x273c9e=arguments[_0x18d82c(0x1cc)],_0x206f52=_0x273c9e<0x3?_0x324979:_0x12b14e===null?_0x12b14e=Object[_0x18d82c(0x204)](_0x324979,_0x53f6fe):_0x12b14e,_0x22febc;if(typeof Reflect===_0x18d82c(0x212)&&typeof Reflect['decorate']===_0x18d82c(0x21f))_0x206f52=Reflect[_0x18d82c(0x1e6)](_0x12bdd5,_0x324979,_0x53f6fe,_0x12b14e);else{for(var _0xd405d=_0x12bdd5[_0x18d82c(0x1cc)]-0x1;_0xd405d>=0x0;_0xd405d--)if(_0x22febc=_0x12bdd5[_0xd405d])_0x206f52=(_0x273c9e<0x3?_0x22febc(_0x206f52):_0x273c9e>0x3?_0x22febc(_0x324979,_0x53f6fe,_0x206f52):_0x22febc(_0x324979,_0x53f6fe))||_0x206f52;}return _0x273c9e>0x3&&_0x206f52&&Object[_0x18d82c(0x1e0)](_0x324979,_0x53f6fe,_0x206f52),_0x206f52;},__metadata=this&&this[_0x34082a(0x1e4)]||function(_0x5cae2a,_0x87fa8d){const _0x4b97a4=_0x34082a;if(typeof Reflect===_0x4b97a4(0x212)&&typeof Reflect['metadata']===_0x4b97a4(0x21f))return Reflect[_0x4b97a4(0x1ca)](_0x5cae2a,_0x87fa8d);};Object[_0x34082a(0x1e0)](exports,_0x34082a(0x1da),{'value':!![]}),exports[_0x34082a(0x1d4)]=void 0x0;const chatgpt_service_1=require(_0x34082a(0x1c6)),globalConfig_service_1=require(_0x34082a(0x1ea)),auth_service_1=require(_0x34082a(0x1be)),user_service_1=require('../user/user.service'),autoreply_service_1=require(_0x34082a(0x1e7)),common_1=require(_0x34082a(0x207)),crypto=require(_0x34082a(0x20b)),axios_1=require(_0x34082a(0x21c)),utils_1=require(_0x34082a(0x1f8));let OfficialService=class OfficialService{constructor(_0x3a9787,_0xeb231f,_0x5ddeb3,_0x2abd2e,_0x10b708){const _0x23f680=_0x34082a;this['autoreplyService']=_0x3a9787,this[_0x23f680(0x1dd)]=_0xeb231f,this[_0x23f680(0x22a)]=_0x5ddeb3,this['globalConfigService']=_0x2abd2e,this['chatgptService']=_0x10b708,this['sceneStrMap']={},this[_0x23f680(0x1f2)]={};}async[_0x34082a(0x1c0)](){const _0x3a9de7=_0x34082a;await this[_0x3a9de7(0x1c1)]['getWechatAccessToken'](!![]);}async[_0x34082a(0x1eb)](_0x188aa7){const _0x250345=_0x34082a,{invitedBy:_0x539e0e}=_0x188aa7;let _0xcc1b46=(0x0,utils_1[_0x250345(0x1c5)])(0x20);return _0x539e0e&&(_0xcc1b46+=':'+_0x539e0e),this['sceneStrMap'][_0xcc1b46]=!![],_0xcc1b46;}async[_0x34082a(0x226)](_0x33ae8b){const _0x3dda4d=_0x34082a,{id:_0x47d12c}=_0x33ae8b[_0x3dda4d(0x205)],_0x541a6b=(0x0,utils_1[_0x3dda4d(0x1c5)])(0x20)+'/'+_0x47d12c;return this['sceneStrMap'][_0x541a6b]=!![],_0x541a6b;}async[_0x34082a(0x1d3)](_0x370d13){const _0x2ed777=_0x34082a;return this[_0x2ed777(0x1d1)](_0x370d13);}async['getRedirectUrl'](_0x594003){const _0x1e6530=_0x34082a,_0x4976e5=await this[_0x1e6530(0x1c1)][_0x1e6530(0x1f7)]([_0x1e6530(0x220)]),_0x581aca='https://open.weixin.qq.com/connect/oauth2/authorize?appid='+_0x4976e5+'&redirect_uri='+encodeURIComponent(_0x594003)+_0x1e6530(0x208);return console['log'](_0x1e6530(0x222),_0x581aca),_0x581aca;}async[_0x34082a(0x225)](_0x3c17a5){const _0x4b51b9=_0x34082a,_0x27f140=(0x0,utils_1[_0x4b51b9(0x1c5)])(0x20),_0x247897=(Date[_0x4b51b9(0x1cb)]()/0x3e8)[_0x4b51b9(0x1fb)](0x0),_0x11a735=await this[_0x4b51b9(0x1c1)]['getConfigs']([_0x4b51b9(0x221)]);console['log']('jsapiTicket:\x20',_0x11a735);const _0x5448ad=await this[_0x4b51b9(0x1c1)][_0x4b51b9(0x1f7)]([_0x4b51b9(0x220)]);console['log'](_0x4b51b9(0x1e1),_0x5448ad);const _0x17185e=_0x4b51b9(0x1d9)+_0x11a735+'&noncestr='+_0x27f140+_0x4b51b9(0x211)+_0x247897+_0x4b51b9(0x1de)+_0x3c17a5;console['log'](_0x4b51b9(0x20f),_0x17185e);const _0x4f88f2=this[_0x4b51b9(0x229)](_0x17185e);return{'appId':_0x5448ad,'nonceStr':_0x27f140,'timestamp':_0x247897,'signature':_0x4f88f2};}async['fetchQRCodeTicket'](_0x473df0){const _0x280d5c=_0x34082a,_0x2efe52=await this[_0x280d5c(0x1c1)][_0x280d5c(0x1f7)]([_0x280d5c(0x21b)]),_0x40b9bd={'action_name':_0x280d5c(0x1db),'action_info':{'scene':{'scene_str':_0x473df0}}};console[_0x280d5c(0x214)](_0x280d5c(0x1f9),_0x2efe52);const _0x4f2e20=await axios_1[_0x280d5c(0x1f4)][_0x280d5c(0x21a)](_0x280d5c(0x1bf)+_0x2efe52,_0x40b9bd),{data:{errmsg:_0x258d1a,ticket:_0x154eeb}}=_0x4f2e20;console['log'](_0x280d5c(0x1fc),_0x4f2e20);if(_0x258d1a)throw new common_1[(_0x280d5c(0x1d2))](_0x258d1a,common_1['HttpStatus']['BAD_REQUEST']);return _0x154eeb;}async[_0x34082a(0x1ef)](_0x3e2cf5,_0x32cb41){const _0x2f8c79=_0x34082a,_0x5df50a=await this[_0x2f8c79(0x1c1)][_0x2f8c79(0x1f7)]([_0x2f8c79(0x220)]),_0x10ae99=await this['globalConfigService'][_0x2f8c79(0x1f7)]([_0x2f8c79(0x1c4)]),_0xb7c422=await axios_1['default'][_0x2f8c79(0x1fa)](_0x2f8c79(0x1cf)+_0x5df50a+'&secret='+_0x10ae99+_0x2f8c79(0x21e)+_0x32cb41+_0x2f8c79(0x1c9)),{data:{errmsg:_0x39a10b,openid:_0x1fc73e}}=_0xb7c422;if(_0x39a10b)throw new common_1[(_0x2f8c79(0x1d2))](_0x39a10b,common_1['HttpStatus'][_0x2f8c79(0x227)]);let _0x27c3ee;return _0x27c3ee=await this['userService'][_0x2f8c79(0x1cd)](_0x1fc73e),!_0x27c3ee&&(_0x27c3ee=await this['userService']['getUserFromOpenId'](_0x1fc73e)),this[_0x2f8c79(0x22a)]['loginByOpenId'](_0x27c3ee,_0x3e2cf5);}async[_0x34082a(0x20a)](_0x220227,_0x36af63){const _0x3de292=_0x34082a;if(!this[_0x3de292(0x200)][_0x36af63])throw new common_1[(_0x3de292(0x1d2))](_0x3de292(0x216),common_1[_0x3de292(0x20c)]['BAD_REQUEST']);const _0x695c93=await this[_0x3de292(0x1dd)][_0x3de292(0x1ce)](_0x220227,_0x36af63);this[_0x3de292(0x1f2)][_0x36af63]=_0x695c93['id'];}async[_0x34082a(0x1df)](_0x373c19,_0x31c97d){const _0x300b16=_0x34082a;if(!this['sceneStrMap'][_0x31c97d])return;const _0x220790=this[_0x300b16(0x1f2)][_0x31c97d];if(!_0x220790)return'';const _0x4aec4a=await this[_0x300b16(0x1dd)][_0x300b16(0x206)](_0x220790);return delete this[_0x300b16(0x1f2)][_0x31c97d],this['authService']['loginByOpenId'](_0x4aec4a,_0x373c19);}async['scanBindWx'](_0x502b1b,_0x44a227){const _0x5352d6=_0x34082a;if(!this['sceneStrMap'][_0x44a227])throw new common_1[(_0x5352d6(0x1d2))](_0x5352d6(0x216),common_1[_0x5352d6(0x20c)][_0x5352d6(0x227)]);const _0x1b46f9=_0x44a227[_0x5352d6(0x1f0)]('/')[0x1],_0x2eb497=await this[_0x5352d6(0x1dd)][_0x5352d6(0x20e)](_0x502b1b,_0x1b46f9);this[_0x5352d6(0x1f2)][_0x44a227]=_0x2eb497;}async['bindWxBySceneStr'](_0x1354a2,_0x37ccb8){const _0x3fd7ac=_0x34082a;if(!this[_0x3fd7ac(0x200)][_0x37ccb8])throw new common_1['HttpException']('非法参数',common_1[_0x3fd7ac(0x20c)]['BAD_REQUEST']);const {id:_0x55102e}=_0x1354a2[_0x3fd7ac(0x205)],_0x2e0542=this[_0x3fd7ac(0x1f2)][_0x37ccb8];if(!_0x2e0542)return'';return delete this[_0x3fd7ac(0x1f2)][_0x37ccb8],_0x2e0542;}async[_0x34082a(0x20d)](_0x2364be,_0x59d933,_0x457682){const _0x1ad303=_0x34082a,_0x29cf33=await this[_0x1ad303(0x1c1)][_0x1ad303(0x1f7)](['wechatOfficialToken'])||'jiangly';return await this[_0x1ad303(0x229)]([_0x29cf33,_0x59d933,_0x457682][_0x1ad303(0x228)]()['join'](''))==_0x2364be;}[_0x34082a(0x229)](_0x1ecceb){const _0x524ca2=_0x34082a;return crypto[_0x524ca2(0x219)]('sha1')[_0x524ca2(0x1f5)](_0x1ecceb)[_0x524ca2(0x1ed)](_0x524ca2(0x1fd));}async[_0x34082a(0x210)](_0x7413b5,_0x5f46ba){const _0x48e171=_0x34082a,_0x158939=await this[_0x48e171(0x1c1)][_0x48e171(0x1f7)]([_0x5f46ba]);return this[_0x48e171(0x21d)](_0x7413b5,_0x158939);}async[_0x34082a(0x21d)](_0x23fd80,_0x10fb4e){const _0xa6307e=_0x34082a;return _0xa6307e(0x1ff)+_0x23fd80[_0xa6307e(0x1d7)][0x0]+']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA['+_0x23fd80['tousername'][0x0]+_0xa6307e(0x202)+new Date()['getTime']()+_0xa6307e(0x223)+_0x10fb4e+_0xa6307e(0x1c3);}async[_0x34082a(0x1d0)](_0x1abacd){const _0x2153d0=_0x34082a,_0x391137=new Promise((_0x5bf720,_0x5c5bde)=>{setTimeout(()=>{const _0x138a94=_0x1f6b;_0x5c5bde(new Error(_0x138a94(0x1c2)));},0x12c0);});let _0x320b70='';try{console[_0x2153d0(0x214)](_0x2153d0(0x217),_0x1abacd);const _0x2a39a6=await Promise[_0x2153d0(0x1fe)]([this[_0x2153d0(0x1e9)][_0x2153d0(0x1f3)](_0x1abacd),_0x391137]);_0x320b70=_0x2a39a6||await this[_0x2153d0(0x1c7)][_0x2153d0(0x1ec)](_0x1abacd);}catch(_0xba70e4){console['log'](_0x2153d0(0x203)),_0x320b70=await this[_0x2153d0(0x1c1)][_0x2153d0(0x1f7)](['officialAutoReplyText'])||'由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！';}return _0x320b70;}};OfficialService=__decorate([(0x0,common_1['Injectable'])(),__metadata('design:paramtypes',[autoreply_service_1[_0x34082a(0x1e5)],user_service_1[_0x34082a(0x1dc)],auth_service_1[_0x34082a(0x215)],globalConfig_service_1[_0x34082a(0x1d8)],chatgpt_service_1['ChatgptService']])],OfficialService),exports[_0x34082a(0x1d4)]=OfficialService;