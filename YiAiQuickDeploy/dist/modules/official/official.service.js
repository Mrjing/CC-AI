'use strict';const _0x52fb9c=_0x52fd;(function(_0x1d76d3,_0x1d4000){const _0x847664=_0x52fd,_0x58d66c=_0x1d76d3();while(!![]){try{const _0x5a16fc=-parseInt(_0x847664(0x12f))/0x1*(-parseInt(_0x847664(0x10e))/0x2)+-parseInt(_0x847664(0xf7))/0x3*(parseInt(_0x847664(0x128))/0x4)+-parseInt(_0x847664(0xef))/0x5*(parseInt(_0x847664(0x119))/0x6)+parseInt(_0x847664(0x100))/0x7*(-parseInt(_0x847664(0xf4))/0x8)+-parseInt(_0x847664(0x145))/0x9+parseInt(_0x847664(0x127))/0xa+parseInt(_0x847664(0x11a))/0xb;if(_0x5a16fc===_0x1d4000)break;else _0x58d66c['push'](_0x58d66c['shift']());}catch(_0x2d326f){_0x58d66c['push'](_0x58d66c['shift']());}}}(_0x3be9,0x734ab));function _0x52fd(_0x51e452,_0x3a0997){const _0x3be989=_0x3be9();return _0x52fd=function(_0x52fd2c,_0x396664){_0x52fd2c=_0x52fd2c-0xe9;let _0x2563d0=_0x3be989[_0x52fd2c];return _0x2563d0;},_0x52fd(_0x51e452,_0x3a0997);}var __decorate=this&&this[_0x52fb9c(0x118)]||function(_0xe50d54,_0x4d9851,_0x2bf3bb,_0x30b176){const _0x4c2a7f=_0x52fb9c;var _0x29fc6e=arguments[_0x4c2a7f(0x134)],_0x5c1746=_0x29fc6e<0x3?_0x4d9851:_0x30b176===null?_0x30b176=Object[_0x4c2a7f(0xfc)](_0x4d9851,_0x2bf3bb):_0x30b176,_0x4da552;if(typeof Reflect===_0x4c2a7f(0xed)&&typeof Reflect[_0x4c2a7f(0x122)]===_0x4c2a7f(0xf1))_0x5c1746=Reflect[_0x4c2a7f(0x122)](_0xe50d54,_0x4d9851,_0x2bf3bb,_0x30b176);else{for(var _0x48d69b=_0xe50d54['length']-0x1;_0x48d69b>=0x0;_0x48d69b--)if(_0x4da552=_0xe50d54[_0x48d69b])_0x5c1746=(_0x29fc6e<0x3?_0x4da552(_0x5c1746):_0x29fc6e>0x3?_0x4da552(_0x4d9851,_0x2bf3bb,_0x5c1746):_0x4da552(_0x4d9851,_0x2bf3bb))||_0x5c1746;}return _0x29fc6e>0x3&&_0x5c1746&&Object[_0x4c2a7f(0x105)](_0x4d9851,_0x2bf3bb,_0x5c1746),_0x5c1746;},__metadata=this&&this[_0x52fb9c(0x123)]||function(_0x4dbccb,_0x30de85){const _0x22fc18=_0x52fb9c;if(typeof Reflect===_0x22fc18(0xed)&&typeof Reflect[_0x22fc18(0x139)]===_0x22fc18(0xf1))return Reflect[_0x22fc18(0x139)](_0x4dbccb,_0x30de85);};Object['defineProperty'](exports,_0x52fb9c(0x13a),{'value':!![]}),exports[_0x52fb9c(0x10a)]=void 0x0;const chatgpt_service_1=require(_0x52fb9c(0xeb)),globalConfig_service_1=require(_0x52fb9c(0x120)),auth_service_1=require(_0x52fb9c(0x108)),user_service_1=require(_0x52fb9c(0x13b)),autoreply_service_1=require(_0x52fb9c(0x125)),common_1=require(_0x52fb9c(0xf8)),crypto=require('crypto'),axios_1=require(_0x52fb9c(0x136)),utils_1=require('../../common/utils');let OfficialService=class OfficialService{constructor(_0x1c5afc,_0x4e36ca,_0x50ad27,_0x20d687,_0x538ae4){const _0x39543c=_0x52fb9c;this[_0x39543c(0x121)]=_0x1c5afc,this[_0x39543c(0x10b)]=_0x4e36ca,this[_0x39543c(0x13d)]=_0x50ad27,this[_0x39543c(0x12a)]=_0x20d687,this[_0x39543c(0x129)]=_0x538ae4,this[_0x39543c(0x126)]={},this[_0x39543c(0xf5)]={};}async[_0x52fb9c(0xf6)](){const _0x17b2e4=_0x52fb9c;await this[_0x17b2e4(0x12a)][_0x17b2e4(0x12e)](!![]);}async[_0x52fb9c(0x13f)](_0x3e335e){const {invitedBy:_0x343681}=_0x3e335e;let _0x4bfaec=(0x0,utils_1['createRandomNonceStr'])(0x20);return _0x343681&&(_0x4bfaec+=':'+_0x343681),this['sceneStrMap'][_0x4bfaec]=!![],_0x4bfaec;}async[_0x52fb9c(0x143)](_0x5f2144){const _0x3c568f=_0x52fb9c,{id:_0x2c597c}=_0x5f2144[_0x3c568f(0x11e)],_0x436ac6=(0x0,utils_1['createRandomNonceStr'])(0x20)+'/'+_0x2c597c;return this[_0x3c568f(0x126)][_0x436ac6]=!![],_0x436ac6;}async[_0x52fb9c(0x14d)](_0x5f16a7){return this['fetchQRCodeTicket'](_0x5f16a7);}async[_0x52fb9c(0x14e)](_0x11a87a){const _0x3c6c86=_0x52fb9c,_0x3ed8a7=await this['globalConfigService'][_0x3c6c86(0x10d)]([_0x3c6c86(0xf9)]),_0xa0aadf='https://open.weixin.qq.com/connect/oauth2/authorize?appid='+_0x3ed8a7+_0x3c6c86(0xfe)+encodeURIComponent(_0x11a87a)+_0x3c6c86(0x101);return console[_0x3c6c86(0xe9)](_0x3c6c86(0x14b),_0xa0aadf),_0xa0aadf;}async[_0x52fb9c(0xf2)](_0x3015c6){const _0x27eaa2=_0x52fb9c,_0x3a37ed=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x168933=(Date['now']()/0x3e8)[_0x27eaa2(0x124)](0x0),_0x128e61=await this['globalConfigService'][_0x27eaa2(0x10d)](['wechatJsapiTicket']);console[_0x27eaa2(0xe9)](_0x27eaa2(0x103),_0x128e61);const _0x13507a=await this['globalConfigService']['getConfigs'](['wechatOfficialAppId']);console['log'](_0x27eaa2(0xfa),_0x13507a);const _0x24d388='jsapi_ticket='+_0x128e61+_0x27eaa2(0x13e)+_0x3a37ed+_0x27eaa2(0x148)+_0x168933+_0x27eaa2(0x130)+_0x3015c6;console['log']('str:\x20',_0x24d388);const _0x1577ed=this[_0x27eaa2(0x110)](_0x24d388);return{'appId':_0x13507a,'nonceStr':_0x3a37ed,'timestamp':_0x168933,'signature':_0x1577ed};}async['fetchQRCodeTicket'](_0x43445a){const _0x6cb488=_0x52fb9c,_0x302c01=await this[_0x6cb488(0x12a)][_0x6cb488(0x10d)]([_0x6cb488(0x131)]),_0x19a06f={'action_name':_0x6cb488(0x12c),'action_info':{'scene':{'scene_str':_0x43445a}}},_0x50f817=await axios_1['default'][_0x6cb488(0x116)]('https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token='+_0x302c01,_0x19a06f),{data:{errmsg:_0x4be63d,ticket:_0x49285d}}=_0x50f817;if(_0x4be63d)throw new common_1[(_0x6cb488(0x12d))](_0x4be63d,common_1['HttpStatus'][_0x6cb488(0x11b)]);return _0x49285d;}async[_0x52fb9c(0x144)](_0x2459ec,_0x5f013a){const _0x8fd353=_0x52fb9c,_0x2b3bb0=await this['globalConfigService'][_0x8fd353(0x10d)]([_0x8fd353(0xf9)]),_0x1a9e56=await this['globalConfigService'][_0x8fd353(0x10d)]([_0x8fd353(0x111)]),_0x5a6cd2=await axios_1[_0x8fd353(0x12b)][_0x8fd353(0x10c)]('https://api.weixin.qq.com/sns/oauth2/access_token?appid='+_0x2b3bb0+_0x8fd353(0x11f)+_0x1a9e56+_0x8fd353(0x150)+_0x5f013a+_0x8fd353(0xf3)),{data:{errmsg:_0x1642ec,openid:_0x445fa1}}=_0x5a6cd2;if(_0x1642ec)throw new common_1[(_0x8fd353(0x12d))](_0x1642ec,common_1['HttpStatus'][_0x8fd353(0x11b)]);let _0x78322c;return _0x78322c=await this[_0x8fd353(0x10b)][_0x8fd353(0x102)](_0x445fa1),!_0x78322c&&(_0x78322c=await this[_0x8fd353(0x10b)][_0x8fd353(0x142)](_0x445fa1)),this['authService'][_0x8fd353(0xfb)](_0x78322c,_0x2459ec);}async[_0x52fb9c(0x151)](_0x43f1ec,_0xdc6aae){const _0x35b3a0=_0x52fb9c;if(!this[_0x35b3a0(0x126)][_0xdc6aae])throw new common_1[(_0x35b3a0(0x12d))](_0x35b3a0(0x138),common_1['HttpStatus']['BAD_REQUEST']);const _0xb27487=await this[_0x35b3a0(0x10b)][_0x35b3a0(0x142)](_0x43f1ec,_0xdc6aae);this[_0x35b3a0(0xf5)][_0xdc6aae]=_0xb27487['id'];}async[_0x52fb9c(0x11c)](_0x585bcb,_0x1a9e9b){const _0x274b70=_0x52fb9c;if(!this[_0x274b70(0x126)][_0x1a9e9b])return;const _0x5d71f2=this[_0x274b70(0xf5)][_0x1a9e9b];if(!_0x5d71f2)return'';const _0x545b48=await this[_0x274b70(0x10b)][_0x274b70(0x11d)](_0x5d71f2);return delete this[_0x274b70(0xf5)][_0x1a9e9b],this['authService'][_0x274b70(0xfb)](_0x545b48,_0x585bcb);}async[_0x52fb9c(0x107)](_0x3a7586,_0x3ac274){const _0x4cb3f5=_0x52fb9c;if(!this['sceneStrMap'][_0x3ac274])throw new common_1[(_0x4cb3f5(0x12d))](_0x4cb3f5(0x138),common_1[_0x4cb3f5(0xfd)]['BAD_REQUEST']);const _0x2ecc83=_0x3ac274['split']('/')[0x1],_0x242de6=await this['userService'][_0x4cb3f5(0x106)](_0x3a7586,_0x2ecc83);this[_0x4cb3f5(0xf5)][_0x3ac274]=_0x242de6;}async[_0x52fb9c(0x113)](_0x4c95b7,_0x31c79f){const _0x5554c2=_0x52fb9c;if(!this[_0x5554c2(0x126)][_0x31c79f])throw new common_1[(_0x5554c2(0x12d))]('非法参数',common_1[_0x5554c2(0xfd)][_0x5554c2(0x11b)]);const {id:_0xb0dc1c}=_0x4c95b7[_0x5554c2(0x11e)],_0xfa4920=this[_0x5554c2(0xf5)][_0x31c79f];if(!_0xfa4920)return'';return delete this[_0x5554c2(0xf5)][_0x31c79f],_0xfa4920;}async[_0x52fb9c(0x109)](_0x546adc,_0x39d26c,_0x5150f7){const _0x284be3=_0x52fb9c,_0x188a98=await this['globalConfigService'][_0x284be3(0x10d)]([_0x284be3(0x114)])||_0x284be3(0x14a);return await this[_0x284be3(0x110)]([_0x188a98,_0x39d26c,_0x5150f7][_0x284be3(0x149)]()[_0x284be3(0x146)](''))==_0x546adc;}[_0x52fb9c(0x110)](_0x1028c0){const _0x238226=_0x52fb9c;return crypto['createHash'](_0x238226(0x110))[_0x238226(0x112)](_0x1028c0)[_0x238226(0x135)]('hex');}async[_0x52fb9c(0x140)](_0x38a80b,_0x270059){const _0x3da888=_0x52fb9c,_0x145918=await this['globalConfigService']['getConfigs']([_0x270059]);return this[_0x3da888(0x132)](_0x38a80b,_0x145918);}async[_0x52fb9c(0x132)](_0x5e27f7,_0x379138){const _0x4a8c97=_0x52fb9c;return _0x4a8c97(0xea)+_0x5e27f7[_0x4a8c97(0xec)][0x0]+']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA['+_0x5e27f7[_0x4a8c97(0xee)][0x0]+_0x4a8c97(0x141)+new Date()[_0x4a8c97(0x14c)]()+_0x4a8c97(0x137)+_0x379138+_0x4a8c97(0x13c);}async[_0x52fb9c(0x133)](_0x52c270){const _0x151215=_0x52fb9c,_0x327165=new Promise((_0x1180be,_0x1d4271)=>{setTimeout(()=>{const _0x55c018=_0x52fd;_0x1d4271(new Error(_0x55c018(0x104)));},0x12c0);});let _0x22b060='';try{console[_0x151215(0xe9)](_0x151215(0xff),_0x52c270);const _0x37ea77=await Promise[_0x151215(0x115)]([this[_0x151215(0x129)]['chatSyncFree'](_0x52c270),_0x327165]);_0x22b060=_0x37ea77||await this[_0x151215(0x121)]['checkAutoReply'](_0x52c270);}catch(_0x5429c5){console[_0x151215(0xe9)]('来自公众号的回复问题\x20=======>\x20超时导致问题无法回答完整'),_0x22b060=await this['globalConfigService']['getConfigs']([_0x151215(0x10f)])||'由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！';}return _0x22b060;}};function _0x3be9(){const _0x577fc9=['../chatgpt/chatgpt.service','fromusername','object','tousername','50PdQgGh','ChatgptService','function','getJsapiTicket','&grant_type=authorization_code','8OlwJPS','scanedSceneStrMap','onModuleInit','150CTgmzf','@nestjs/common','wechatOfficialAppId','appId:\x20','loginByOpenId','getOwnPropertyDescriptor','HttpStatus','&redirect_uri=','来自公众号的询问问题\x20=======>\x20','3550155xJidHI','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','getUserOpenId','jsapiTicket:\x20','请求超时','defineProperty','bindWx','scanBindWx','../auth/auth.service','verify','OfficialService','userService','get','getConfigs','2OnfRTU','officialAutoReplyText','sha1','wechatOfficialAppSecret','update','bindWxBySceneStr','wechatOfficialToken','race','post','design:paramtypes','__decorate','499530vocQla','23770703fjfEBr','BAD_REQUEST','loginBySceneStr','getUserById','user','&secret=','../globalConfig/globalConfig.service','autoreplyService','decorate','__metadata','toFixed','../autoreply/autoreply.service','sceneStrMap','6354430TGAlGv','61044ohmAgS','chatgptService','globalConfigService','default','QR_STR_SCENE','HttpException','getWechatAccessToken','193139kSSRXj','&url=','wechatAccessToken','genXmlMsg','aotoPlay','length','digest','axios','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','非法参数','metadata','__esModule','../user/user.service',']]></Content>\x0a\x20\x20\x20\x20</xml>','authService','&noncestr=','getQRSceneStr','genXmlMsgByConfig',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','getUserFromOpenId','getQRSceneStrByBind','loginByCode','3730995LzCaFX','join','GlobalConfigService','&timestamp=','sort','jiangly','回跳跳转地址:\x20','getTime','getQRCodeTicket','getRedirectUrl','AutoreplyService','&code=','scan','log','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA['];_0x3be9=function(){return _0x577fc9;};return _0x3be9();}OfficialService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x52fb9c(0x117),[autoreply_service_1[_0x52fb9c(0x14f)],user_service_1['UserService'],auth_service_1['AuthService'],globalConfig_service_1[_0x52fb9c(0x147)],chatgpt_service_1[_0x52fb9c(0xf0)]])],OfficialService),exports[_0x52fb9c(0x10a)]=OfficialService;