'use strict';const _0x59bf4a=_0x517c;function _0x3afe(){const _0x56a86a=[']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','AutoreplyService','metadata','get','wechatOfficialToken','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','loginByOpenId','__metadata','ChatgptService','2778648edZVHw','getUserOpenId','userService','globalConfigService','请求超时','chatgptService','非法参数','default','../user/user.service','../auth/auth.service','autoreplyService','defineProperty','__decorate','chatSyncFree','HttpException','object','wechatOfficialAppId','&url=','sha1','&code=','GlobalConfigService','post','genXmlMsgByConfig','scanBindWx','createRandomNonceStr','../../common/utils','loginByCode','5374920rvNArn','log','getQRCodeTicket','axios','&timestamp=','HttpStatus','3724047HBnVns','2TrRvkY','&secret=','scanedSceneStrMap','now','OfficialService','getOwnPropertyDescriptor','&noncestr=','onModuleInit','BAD_REQUEST','checkAutoReply',']]></Content>\x0a\x20\x20\x20\x20</xml>','getQRSceneStrByBind','length','split','update','wechatAccessToken','740FESltc','fromusername','sceneStrMap','__esModule','genXmlMsg','1670481azhPil','QR_STR_SCENE','55380yddaNO','decorate','由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！','aotoPlay','crypto','getConfigs','authService','bindWx','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=','join','../autoreply/autoreply.service','2558703xJLhmC','570249yAhxvM','getTime','function','wechatJsapiTicket','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','Injectable','UserService','回跳跳转地址:\x20','fetchQRCodeTicket','来自公众号的回复问题\x20=======>\x20超时导致问题无法回答完整','getJsapiTicket','appId:\x20','verify',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA['];_0x3afe=function(){return _0x56a86a;};return _0x3afe();}(function(_0x5e8b40,_0x3acffe){const _0x435fbc=_0x517c,_0x57d77b=_0x5e8b40();while(!![]){try{const _0x549c5a=-parseInt(_0x435fbc(0x10e))/0x1+parseInt(_0x435fbc(0x147))/0x2*(parseInt(_0x435fbc(0xff))/0x3)+-parseInt(_0x435fbc(0x125))/0x4+parseInt(_0x435fbc(0xfa))/0x5*(parseInt(_0x435fbc(0x101))/0x6)+parseInt(_0x435fbc(0x10d))/0x7+-parseInt(_0x435fbc(0x140))/0x8+parseInt(_0x435fbc(0x146))/0x9;if(_0x549c5a===_0x3acffe)break;else _0x57d77b['push'](_0x57d77b['shift']());}catch(_0x2c6b7e){_0x57d77b['push'](_0x57d77b['shift']());}}}(_0x3afe,0xbaddb));function _0x517c(_0x549afb,_0x4bb521){const _0x3afec9=_0x3afe();return _0x517c=function(_0x517cc9,_0x4fbbc5){_0x517cc9=_0x517cc9-0xf5;let _0x3b6a8d=_0x3afec9[_0x517cc9];return _0x3b6a8d;},_0x517c(_0x549afb,_0x4bb521);}var __decorate=this&&this[_0x59bf4a(0x131)]||function(_0x197fa4,_0x864c0a,_0x2fce0a,_0x4202cc){const _0x2b281f=_0x59bf4a;var _0x4d72e9=arguments['length'],_0x4d42ea=_0x4d72e9<0x3?_0x864c0a:_0x4202cc===null?_0x4202cc=Object[_0x2b281f(0x14c)](_0x864c0a,_0x2fce0a):_0x4202cc,_0x1be0fd;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0x4d42ea=Reflect[_0x2b281f(0x102)](_0x197fa4,_0x864c0a,_0x2fce0a,_0x4202cc);else{for(var _0x272eae=_0x197fa4[_0x2b281f(0xf6)]-0x1;_0x272eae>=0x0;_0x272eae--)if(_0x1be0fd=_0x197fa4[_0x272eae])_0x4d42ea=(_0x4d72e9<0x3?_0x1be0fd(_0x4d42ea):_0x4d72e9>0x3?_0x1be0fd(_0x864c0a,_0x2fce0a,_0x4d42ea):_0x1be0fd(_0x864c0a,_0x2fce0a))||_0x4d42ea;}return _0x4d72e9>0x3&&_0x4d42ea&&Object[_0x2b281f(0x130)](_0x864c0a,_0x2fce0a,_0x4d42ea),_0x4d42ea;},__metadata=this&&this[_0x59bf4a(0x123)]||function(_0x1dae2a,_0x31efe9){const _0x448efe=_0x59bf4a;if(typeof Reflect===_0x448efe(0x134)&&typeof Reflect[_0x448efe(0x11e)]===_0x448efe(0x110))return Reflect[_0x448efe(0x11e)](_0x1dae2a,_0x31efe9);};Object[_0x59bf4a(0x130)](exports,_0x59bf4a(0xfd),{'value':!![]}),exports['OfficialService']=void 0x0;const chatgpt_service_1=require('../chatgpt/chatgpt.service'),globalConfig_service_1=require('../globalConfig/globalConfig.service'),auth_service_1=require(_0x59bf4a(0x12e)),user_service_1=require(_0x59bf4a(0x12d)),autoreply_service_1=require(_0x59bf4a(0x10c)),common_1=require('@nestjs/common'),crypto=require(_0x59bf4a(0x105)),axios_1=require(_0x59bf4a(0x143)),utils_1=require(_0x59bf4a(0x13e));let OfficialService=class OfficialService{constructor(_0x2896d5,_0x16fa86,_0x2f9071,_0x4f38d2,_0x304a32){const _0x21d677=_0x59bf4a;this[_0x21d677(0x12f)]=_0x2896d5,this['userService']=_0x16fa86,this[_0x21d677(0x107)]=_0x2f9071,this[_0x21d677(0x128)]=_0x4f38d2,this['chatgptService']=_0x304a32,this['sceneStrMap']={},this[_0x21d677(0x149)]={};}async[_0x59bf4a(0x14e)](){await this['globalConfigService']['getWechatAccessToken'](!![]);}async['getQRSceneStr'](_0x495b2c){const _0xb98eee=_0x59bf4a,{invitedBy:_0x576b52}=_0x495b2c;let _0x4f2ca4=(0x0,utils_1['createRandomNonceStr'])(0x20);return _0x576b52&&(_0x4f2ca4+=':'+_0x576b52),this[_0xb98eee(0xfc)][_0x4f2ca4]=!![],_0x4f2ca4;}async[_0x59bf4a(0xf5)](_0x314e40){const _0x44fd8b=_0x59bf4a,{id:_0x62acba}=_0x314e40['user'],_0x1d66f0=(0x0,utils_1[_0x44fd8b(0x13d)])(0x20)+'/'+_0x62acba;return this['sceneStrMap'][_0x1d66f0]=!![],_0x1d66f0;}async[_0x59bf4a(0x142)](_0x532300){const _0x456e54=_0x59bf4a;return this[_0x456e54(0x116)](_0x532300);}async['getRedirectUrl'](_0x5c14e6){const _0x171278=_0x59bf4a,_0x45dd35=await this[_0x171278(0x128)][_0x171278(0x106)]([_0x171278(0x135)]),_0x5c6c87='https://open.weixin.qq.com/connect/oauth2/authorize?appid='+_0x45dd35+'&redirect_uri='+encodeURIComponent(_0x5c14e6)+_0x171278(0x121);return console['log'](_0x171278(0x115),_0x5c6c87),_0x5c6c87;}async[_0x59bf4a(0x118)](_0x3feb71){const _0x3f97a9=_0x59bf4a,_0x4d3466=(0x0,utils_1[_0x3f97a9(0x13d)])(0x20),_0xb421ba=(Date[_0x3f97a9(0x14a)]()/0x3e8)['toFixed'](0x0),_0x3eb914=await this[_0x3f97a9(0x128)][_0x3f97a9(0x106)]([_0x3f97a9(0x111)]);console[_0x3f97a9(0x141)]('jsapiTicket:\x20',_0x3eb914);const _0x2fcc47=await this['globalConfigService'][_0x3f97a9(0x106)](['wechatOfficialAppId']);console[_0x3f97a9(0x141)](_0x3f97a9(0x119),_0x2fcc47);const _0x2c7385='jsapi_ticket='+_0x3eb914+_0x3f97a9(0x14d)+_0x4d3466+_0x3f97a9(0x144)+_0xb421ba+_0x3f97a9(0x136)+_0x3feb71;console[_0x3f97a9(0x141)]('str:\x20',_0x2c7385);const _0x4ea798=this[_0x3f97a9(0x137)](_0x2c7385);return{'appId':_0x2fcc47,'nonceStr':_0x4d3466,'timestamp':_0xb421ba,'signature':_0x4ea798};}async[_0x59bf4a(0x116)](_0x342337){const _0x5d32ed=_0x59bf4a,_0x386ee1=await this[_0x5d32ed(0x128)]['getConfigs']([_0x5d32ed(0xf9)]),_0x5177d1={'action_name':_0x5d32ed(0x100),'action_info':{'scene':{'scene_str':_0x342337}}},_0x33aa1e=await axios_1[_0x5d32ed(0x12c)][_0x5d32ed(0x13a)](_0x5d32ed(0x10a)+_0x386ee1,_0x5177d1),{data:{errmsg:_0x599adc,ticket:_0x388338}}=_0x33aa1e;if(_0x599adc)throw new common_1[(_0x5d32ed(0x133))](_0x599adc,common_1[_0x5d32ed(0x145)][_0x5d32ed(0x14f)]);return _0x388338;}async[_0x59bf4a(0x13f)](_0x1b793a,_0x55c73f){const _0x1e4ca3=_0x59bf4a,_0x2af45d=await this['globalConfigService'][_0x1e4ca3(0x106)]([_0x1e4ca3(0x135)]),_0x1bd060=await this[_0x1e4ca3(0x128)][_0x1e4ca3(0x106)](['wechatOfficialAppSecret']),_0x368fb8=await axios_1[_0x1e4ca3(0x12c)][_0x1e4ca3(0x11f)]('https://api.weixin.qq.com/sns/oauth2/access_token?appid='+_0x2af45d+_0x1e4ca3(0x148)+_0x1bd060+_0x1e4ca3(0x138)+_0x55c73f+'&grant_type=authorization_code'),{data:{errmsg:_0x47da58,openid:_0x6a181e}}=_0x368fb8;if(_0x47da58)throw new common_1[(_0x1e4ca3(0x133))](_0x47da58,common_1['HttpStatus'][_0x1e4ca3(0x14f)]);let _0xed8d71;return _0xed8d71=await this[_0x1e4ca3(0x127)][_0x1e4ca3(0x126)](_0x6a181e),!_0xed8d71&&(_0xed8d71=await this['userService']['getUserFromOpenId'](_0x6a181e)),this['authService'][_0x1e4ca3(0x122)](_0xed8d71,_0x1b793a);}async['scan'](_0x2aeabe,_0x1355f6){const _0x2e70d8=_0x59bf4a;if(!this[_0x2e70d8(0xfc)][_0x1355f6])throw new common_1[(_0x2e70d8(0x133))](_0x2e70d8(0x12b),common_1[_0x2e70d8(0x145)][_0x2e70d8(0x14f)]);const _0x14cea4=await this[_0x2e70d8(0x127)]['getUserFromOpenId'](_0x2aeabe,_0x1355f6);this[_0x2e70d8(0x149)][_0x1355f6]=_0x14cea4['id'];}async['loginBySceneStr'](_0x1f4fc6,_0x26b2df){const _0xe17c1=_0x59bf4a;if(!this[_0xe17c1(0xfc)][_0x26b2df])return;const _0x475923=this[_0xe17c1(0x149)][_0x26b2df];if(!_0x475923)return'';const _0x336bd6=await this[_0xe17c1(0x127)]['getUserById'](_0x475923);return delete this[_0xe17c1(0x149)][_0x26b2df],this[_0xe17c1(0x107)][_0xe17c1(0x122)](_0x336bd6,_0x1f4fc6);}async[_0x59bf4a(0x13c)](_0x564011,_0x46fbac){const _0x1ed644=_0x59bf4a;if(!this[_0x1ed644(0xfc)][_0x46fbac])throw new common_1[(_0x1ed644(0x133))]('非法参数',common_1[_0x1ed644(0x145)]['BAD_REQUEST']);const _0x1874f8=_0x46fbac[_0x1ed644(0xf7)]('/')[0x1],_0x41c047=await this[_0x1ed644(0x127)][_0x1ed644(0x108)](_0x564011,_0x1874f8);this[_0x1ed644(0x149)][_0x46fbac]=_0x41c047;}async['bindWxBySceneStr'](_0x1b7667,_0x15842f){const _0x149fb0=_0x59bf4a;if(!this[_0x149fb0(0xfc)][_0x15842f])throw new common_1[(_0x149fb0(0x133))](_0x149fb0(0x12b),common_1[_0x149fb0(0x145)][_0x149fb0(0x14f)]);const {id:_0x589c6e}=_0x1b7667['user'],_0x341287=this[_0x149fb0(0x149)][_0x15842f];if(!_0x341287)return'';return delete this[_0x149fb0(0x149)][_0x15842f],_0x341287;}async[_0x59bf4a(0x11a)](_0x2693ea,_0xa97bc5,_0x59e808){const _0x3c35ea=_0x59bf4a,_0x47a14d=await this['globalConfigService']['getConfigs']([_0x3c35ea(0x120)])||'jiangly';return await this[_0x3c35ea(0x137)]([_0x47a14d,_0xa97bc5,_0x59e808]['sort']()[_0x3c35ea(0x10b)](''))==_0x2693ea;}[_0x59bf4a(0x137)](_0x13bf48){const _0x1ecd82=_0x59bf4a;return crypto['createHash'](_0x1ecd82(0x137))[_0x1ecd82(0xf8)](_0x13bf48)['digest']('hex');}async[_0x59bf4a(0x13b)](_0x3830ef,_0x4afd58){const _0x516353=_0x59bf4a,_0x2b36d9=await this['globalConfigService'][_0x516353(0x106)]([_0x4afd58]);return this[_0x516353(0xfe)](_0x3830ef,_0x2b36d9);}async[_0x59bf4a(0xfe)](_0x2e4ce7,_0x39108a){const _0x381b73=_0x59bf4a;return _0x381b73(0x109)+_0x2e4ce7[_0x381b73(0xfb)][0x0]+_0x381b73(0x11b)+_0x2e4ce7['tousername'][0x0]+_0x381b73(0x11c)+new Date()[_0x381b73(0x10f)]()+_0x381b73(0x112)+_0x39108a+_0x381b73(0x151);}async[_0x59bf4a(0x104)](_0x483756){const _0x13f53b=_0x59bf4a,_0x5cecc6=new Promise((_0x196f07,_0x15d33a)=>{setTimeout(()=>{const _0x4cea7c=_0x517c;_0x15d33a(new Error(_0x4cea7c(0x129)));},0x12c0);});let _0x427a09='';try{console[_0x13f53b(0x141)]('来自公众号的询问问题\x20=======>\x20',_0x483756);const _0x498341=await Promise['race']([this[_0x13f53b(0x12a)][_0x13f53b(0x132)](_0x483756),_0x5cecc6]);_0x427a09=_0x498341||await this[_0x13f53b(0x12f)][_0x13f53b(0x150)](_0x483756);}catch(_0x3809ee){console['log'](_0x13f53b(0x117)),_0x427a09=await this[_0x13f53b(0x128)]['getConfigs'](['officialAutoReplyText'])||_0x13f53b(0x103);}return _0x427a09;}};OfficialService=__decorate([(0x0,common_1[_0x59bf4a(0x113)])(),__metadata('design:paramtypes',[autoreply_service_1[_0x59bf4a(0x11d)],user_service_1[_0x59bf4a(0x114)],auth_service_1['AuthService'],globalConfig_service_1[_0x59bf4a(0x139)],chatgpt_service_1[_0x59bf4a(0x124)]])],OfficialService),exports[_0x59bf4a(0x14b)]=OfficialService;