'use strict';const _0x29eea5=_0x2b61;(function(_0x37ae04,_0x3e0eb1){const _0xfac25c=_0x2b61,_0x5ae5f9=_0x37ae04();while(!![]){try{const _0x48bb5b=-parseInt(_0xfac25c(0xa6))/0x1+-parseInt(_0xfac25c(0xdd))/0x2*(parseInt(_0xfac25c(0xb5))/0x3)+parseInt(_0xfac25c(0xc9))/0x4+-parseInt(_0xfac25c(0xd3))/0x5+parseInt(_0xfac25c(0xe2))/0x6*(-parseInt(_0xfac25c(0x82))/0x7)+-parseInt(_0xfac25c(0x8a))/0x8*(-parseInt(_0xfac25c(0x9d))/0x9)+parseInt(_0xfac25c(0x9f))/0xa;if(_0x48bb5b===_0x3e0eb1)break;else _0x5ae5f9['push'](_0x5ae5f9['shift']());}catch(_0x336fe3){_0x5ae5f9['push'](_0x5ae5f9['shift']());}}}(_0x3922,0x5cfe5));function _0x2b61(_0x5b18cf,_0x53b895){const _0x3922cf=_0x3922();return _0x2b61=function(_0x2b61e7,_0x41d87d){_0x2b61e7=_0x2b61e7-0x82;let _0x15d212=_0x3922cf[_0x2b61e7];return _0x15d212;},_0x2b61(_0x5b18cf,_0x53b895);}function _0x3922(){const _0x3512f9=['wechatOfficialToken','GlobalConfigService','getUserById','log','globalConfigService','loginBySceneStr','userService','Injectable','loginByCode','非法参数','str:\x20','jsapi_ticket=','get','wechatOfficialAppSecret','3021244aoqZFd','user','update','appId:\x20','../../common/utils','@nestjs/common','回跳跳转地址:\x20','now','BAD_REQUEST','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','1949640PmYGuW',']]></Content>\x0a\x20\x20\x20\x20</xml>','object','join','post','aotoPlay','HttpException','wechatJsapiTicket','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','chatSyncFree','488716SFLwsd','getQRSceneStrByBind','getOwnPropertyDescriptor','getUserFromOpenId','UserService','2156982jNMMHo','&redirect_uri=','loginByOpenId','scanedSceneStrMap','autoreplyService','createHash','AutoreplyService','hex','length','&secret=','wechatOfficialAppId','7TqKwRK','&timestamp=','tousername','default','authService','OfficialService','crypto','&code=','378968hBshqd','toFixed','split','chatgptService','metadata','digest','sha1','verify','fromusername','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','getTime','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','HttpStatus','ChatgptService','fetchQRCodeTicket','officialAutoReplyText','genXmlMsg','getJsapiTicket','__esModule','81YRNhbM','scan','3763820fYJaty','createRandomNonceStr','__decorate','__metadata','bindWxBySceneStr','genXmlMsgByConfig','sort','183348FAMkmg','scanBindWx','function','getConfigs','defineProperty','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','axios','jsapiTicket:\x20','getUserOpenId','jiangly','../chatgpt/chatgpt.service','getQRSceneStr','sceneStrMap','decorate','&noncestr=','3IUVZQZ','来自公众号的回复问题\x20=======>\x20超时导致问题无法回答完整','请求超时','wechatAccessToken','getQRCodeTicket','../globalConfig/globalConfig.service'];_0x3922=function(){return _0x3512f9;};return _0x3922();}var __decorate=this&&this[_0x29eea5(0xa1)]||function(_0xdd1757,_0x46146b,_0x20b661,_0x5cc1e4){const _0x57060d=_0x29eea5;var _0x537aa5=arguments[_0x57060d(0xea)],_0x3ecbc1=_0x537aa5<0x3?_0x46146b:_0x5cc1e4===null?_0x5cc1e4=Object[_0x57060d(0xdf)](_0x46146b,_0x20b661):_0x5cc1e4,_0x3e9947;if(typeof Reflect===_0x57060d(0xd5)&&typeof Reflect['decorate']===_0x57060d(0xa8))_0x3ecbc1=Reflect[_0x57060d(0xb3)](_0xdd1757,_0x46146b,_0x20b661,_0x5cc1e4);else{for(var _0x5eab02=_0xdd1757[_0x57060d(0xea)]-0x1;_0x5eab02>=0x0;_0x5eab02--)if(_0x3e9947=_0xdd1757[_0x5eab02])_0x3ecbc1=(_0x537aa5<0x3?_0x3e9947(_0x3ecbc1):_0x537aa5>0x3?_0x3e9947(_0x46146b,_0x20b661,_0x3ecbc1):_0x3e9947(_0x46146b,_0x20b661))||_0x3ecbc1;}return _0x537aa5>0x3&&_0x3ecbc1&&Object[_0x57060d(0xaa)](_0x46146b,_0x20b661,_0x3ecbc1),_0x3ecbc1;},__metadata=this&&this[_0x29eea5(0xa2)]||function(_0x350ab1,_0x22fc49){const _0x282d8a=_0x29eea5;if(typeof Reflect==='object'&&typeof Reflect[_0x282d8a(0x8e)]==='function')return Reflect['metadata'](_0x350ab1,_0x22fc49);};Object[_0x29eea5(0xaa)](exports,_0x29eea5(0x9c),{'value':!![]}),exports[_0x29eea5(0x87)]=void 0x0;const chatgpt_service_1=require(_0x29eea5(0xb0)),globalConfig_service_1=require(_0x29eea5(0xba)),auth_service_1=require('../auth/auth.service'),user_service_1=require('../user/user.service'),autoreply_service_1=require('../autoreply/autoreply.service'),common_1=require(_0x29eea5(0xce)),crypto=require(_0x29eea5(0x88)),axios_1=require(_0x29eea5(0xac)),utils_1=require(_0x29eea5(0xcd));let OfficialService=class OfficialService{constructor(_0x348cf2,_0x180f0d,_0x279d6f,_0x4454dc,_0x37d5a){const _0xd63373=_0x29eea5;this[_0xd63373(0xe6)]=_0x348cf2,this[_0xd63373(0xc1)]=_0x180f0d,this[_0xd63373(0x86)]=_0x279d6f,this['globalConfigService']=_0x4454dc,this[_0xd63373(0x8d)]=_0x37d5a,this['sceneStrMap']={},this[_0xd63373(0xe5)]={};}async['onModuleInit'](){const _0x49200c=_0x29eea5;await this[_0x49200c(0xbf)]['getWechatAccessToken'](!![]);}async[_0x29eea5(0xb1)](_0x36ed9b){const _0x14d241=_0x29eea5,{invitedBy:_0x37d5aa}=_0x36ed9b;let _0x23cf43=(0x0,utils_1[_0x14d241(0xa0)])(0x20);return _0x37d5aa&&(_0x23cf43+=':'+_0x37d5aa),this[_0x14d241(0xb2)][_0x23cf43]=!![],_0x23cf43;}async[_0x29eea5(0xde)](_0x45d002){const _0x50696e=_0x29eea5,{id:_0x38ff4c}=_0x45d002[_0x50696e(0xca)],_0xb420de=(0x0,utils_1[_0x50696e(0xa0)])(0x20)+'/'+_0x38ff4c;return this[_0x50696e(0xb2)][_0xb420de]=!![],_0xb420de;}async[_0x29eea5(0xb9)](_0x3f9dd8){return this['fetchQRCodeTicket'](_0x3f9dd8);}async['getRedirectUrl'](_0x1ebadc){const _0x2c0889=_0x29eea5,_0x3c53f5=await this['globalConfigService'][_0x2c0889(0xa9)]([_0x2c0889(0xec)]),_0x4b8d4b=_0x2c0889(0xdb)+_0x3c53f5+_0x2c0889(0xe3)+encodeURIComponent(_0x1ebadc)+_0x2c0889(0xd2);return console['log'](_0x2c0889(0xcf),_0x4b8d4b),_0x4b8d4b;}async[_0x29eea5(0x9b)](_0x2d1e48){const _0x44f17a=_0x29eea5,_0x8c646f=(0x0,utils_1[_0x44f17a(0xa0)])(0x20),_0x3bd305=(Date[_0x44f17a(0xd0)]()/0x3e8)[_0x44f17a(0x8b)](0x0),_0x2334e1=await this[_0x44f17a(0xbf)][_0x44f17a(0xa9)]([_0x44f17a(0xda)]);console[_0x44f17a(0xbe)](_0x44f17a(0xad),_0x2334e1);const _0x21ea32=await this[_0x44f17a(0xbf)][_0x44f17a(0xa9)]([_0x44f17a(0xec)]);console['log'](_0x44f17a(0xcc),_0x21ea32);const _0x2b4fdd=_0x44f17a(0xc6)+_0x2334e1+_0x44f17a(0xb4)+_0x8c646f+_0x44f17a(0x83)+_0x3bd305+'&url='+_0x2d1e48;console['log'](_0x44f17a(0xc5),_0x2b4fdd);const _0x1759b6=this[_0x44f17a(0x90)](_0x2b4fdd);return{'appId':_0x21ea32,'nonceStr':_0x8c646f,'timestamp':_0x3bd305,'signature':_0x1759b6};}async[_0x29eea5(0x98)](_0x5be685){const _0x35cf0=_0x29eea5,_0x572597=await this[_0x35cf0(0xbf)][_0x35cf0(0xa9)]([_0x35cf0(0xb8)]),_0xf0c7c6={'action_name':'QR_STR_SCENE','action_info':{'scene':{'scene_str':_0x5be685}}},_0x2825a7=await axios_1[_0x35cf0(0x85)][_0x35cf0(0xd7)]('https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token='+_0x572597,_0xf0c7c6),{data:{errmsg:_0x3d97ae,ticket:_0x3647ad}}=_0x2825a7;if(_0x3d97ae)throw new common_1['HttpException'](_0x3d97ae,common_1[_0x35cf0(0x96)][_0x35cf0(0xd1)]);return _0x3647ad;}async[_0x29eea5(0xc3)](_0x35f889,_0x483604){const _0x2475d8=_0x29eea5,_0x2ba7dc=await this[_0x2475d8(0xbf)][_0x2475d8(0xa9)]([_0x2475d8(0xec)]),_0x6f0c96=await this[_0x2475d8(0xbf)][_0x2475d8(0xa9)]([_0x2475d8(0xc8)]),_0x3f411f=await axios_1[_0x2475d8(0x85)][_0x2475d8(0xc7)](_0x2475d8(0x93)+_0x2ba7dc+_0x2475d8(0xeb)+_0x6f0c96+_0x2475d8(0x89)+_0x483604+'&grant_type=authorization_code'),{data:{errmsg:_0x4dfe82,openid:_0x4fd0b7}}=_0x3f411f;if(_0x4dfe82)throw new common_1[(_0x2475d8(0xd9))](_0x4dfe82,common_1[_0x2475d8(0x96)][_0x2475d8(0xd1)]);let _0x3c983f;return _0x3c983f=await this[_0x2475d8(0xc1)][_0x2475d8(0xae)](_0x4fd0b7),!_0x3c983f&&(_0x3c983f=await this[_0x2475d8(0xc1)]['getUserFromOpenId'](_0x4fd0b7)),this[_0x2475d8(0x86)]['loginByOpenId'](_0x3c983f,_0x35f889);}async[_0x29eea5(0x9e)](_0x83cc2c,_0x4ba261){const _0x4c8b8a=_0x29eea5;if(!this['sceneStrMap'][_0x4ba261])throw new common_1[(_0x4c8b8a(0xd9))](_0x4c8b8a(0xc4),common_1[_0x4c8b8a(0x96)][_0x4c8b8a(0xd1)]);const _0x377497=await this[_0x4c8b8a(0xc1)][_0x4c8b8a(0xe0)](_0x83cc2c,_0x4ba261);this[_0x4c8b8a(0xe5)][_0x4ba261]=_0x377497['id'];}async[_0x29eea5(0xc0)](_0x389d0b,_0x5a5900){const _0x446883=_0x29eea5;if(!this[_0x446883(0xb2)][_0x5a5900])return;const _0x503681=this[_0x446883(0xe5)][_0x5a5900];if(!_0x503681)return'';const _0x344aba=await this[_0x446883(0xc1)][_0x446883(0xbd)](_0x503681);return delete this[_0x446883(0xe5)][_0x5a5900],this[_0x446883(0x86)][_0x446883(0xe4)](_0x344aba,_0x389d0b);}async[_0x29eea5(0xa7)](_0xc45dd6,_0x665c17){const _0x2b9675=_0x29eea5;if(!this[_0x2b9675(0xb2)][_0x665c17])throw new common_1[(_0x2b9675(0xd9))]('非法参数',common_1[_0x2b9675(0x96)][_0x2b9675(0xd1)]);const _0x5eff14=_0x665c17[_0x2b9675(0x8c)]('/')[0x1],_0x3eb225=await this[_0x2b9675(0xc1)]['bindWx'](_0xc45dd6,_0x5eff14);this[_0x2b9675(0xe5)][_0x665c17]=_0x3eb225;}async[_0x29eea5(0xa3)](_0x3e6302,_0x4113bd){const _0x209d40=_0x29eea5;if(!this[_0x209d40(0xb2)][_0x4113bd])throw new common_1[(_0x209d40(0xd9))](_0x209d40(0xc4),common_1[_0x209d40(0x96)][_0x209d40(0xd1)]);const {id:_0x216410}=_0x3e6302[_0x209d40(0xca)],_0x465996=this[_0x209d40(0xe5)][_0x4113bd];if(!_0x465996)return'';return delete this[_0x209d40(0xe5)][_0x4113bd],_0x465996;}async[_0x29eea5(0x91)](_0x4468b0,_0x25cfa4,_0x3bb233){const _0x274f79=_0x29eea5,_0x3155a0=await this[_0x274f79(0xbf)][_0x274f79(0xa9)]([_0x274f79(0xbb)])||_0x274f79(0xaf);return await this['sha1']([_0x3155a0,_0x25cfa4,_0x3bb233][_0x274f79(0xa5)]()[_0x274f79(0xd6)](''))==_0x4468b0;}[_0x29eea5(0x90)](_0x6bd697){const _0x40f725=_0x29eea5;return crypto[_0x40f725(0xe7)](_0x40f725(0x90))[_0x40f725(0xcb)](_0x6bd697)[_0x40f725(0x8f)](_0x40f725(0xe9));}async[_0x29eea5(0xa4)](_0x3b01bf,_0x228931){const _0x4c9c89=_0x29eea5,_0x3aaa70=await this['globalConfigService']['getConfigs']([_0x228931]);return this[_0x4c9c89(0x9a)](_0x3b01bf,_0x3aaa70);}async['genXmlMsg'](_0x58c396,_0x2a34ca){const _0x5a9168=_0x29eea5;return _0x5a9168(0x95)+_0x58c396[_0x5a9168(0x92)][0x0]+']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA['+_0x58c396[_0x5a9168(0x84)][0x0]+']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>'+new Date()[_0x5a9168(0x94)]()+_0x5a9168(0xab)+_0x2a34ca+_0x5a9168(0xd4);}async[_0x29eea5(0xd8)](_0x4cff05){const _0x1493b=_0x29eea5,_0x2e979e=new Promise((_0x35eaae,_0x5e02e4)=>{setTimeout(()=>{const _0x5d4a0c=_0x2b61;_0x5e02e4(new Error(_0x5d4a0c(0xb7)));},0x12c0);});let _0x57f711='';try{console[_0x1493b(0xbe)]('来自公众号的询问问题\x20=======>\x20',_0x4cff05);const _0x6f909f=await Promise['race']([this['chatgptService'][_0x1493b(0xdc)](_0x4cff05),_0x2e979e]);_0x57f711=_0x6f909f||await this[_0x1493b(0xe6)]['checkAutoReply'](_0x4cff05);}catch(_0x245bb3){console[_0x1493b(0xbe)](_0x1493b(0xb6)),_0x57f711=await this[_0x1493b(0xbf)][_0x1493b(0xa9)]([_0x1493b(0x99)])||'由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！';}return _0x57f711;}};OfficialService=__decorate([(0x0,common_1[_0x29eea5(0xc2)])(),__metadata('design:paramtypes',[autoreply_service_1[_0x29eea5(0xe8)],user_service_1[_0x29eea5(0xe1)],auth_service_1['AuthService'],globalConfig_service_1[_0x29eea5(0xbc)],chatgpt_service_1[_0x29eea5(0x97)]])],OfficialService),exports[_0x29eea5(0x87)]=OfficialService;