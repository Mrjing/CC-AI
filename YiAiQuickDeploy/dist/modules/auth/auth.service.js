'use strict';const _0x2fc8e8=_0x2c73;(function(_0x4babef,_0xd01e29){const _0x80fd4=_0x2c73,_0x1de642=_0x4babef();while(!![]){try{const _0x138fcb=-parseInt(_0x80fd4(0x120))/0x1*(parseInt(_0x80fd4(0x110))/0x2)+parseInt(_0x80fd4(0x12c))/0x3*(parseInt(_0x80fd4(0xfe))/0x4)+parseInt(_0x80fd4(0xea))/0x5+parseInt(_0x80fd4(0xef))/0x6+parseInt(_0x80fd4(0x10d))/0x7+-parseInt(_0x80fd4(0x130))/0x8+parseInt(_0x80fd4(0xc9))/0x9;if(_0x138fcb===_0xd01e29)break;else _0x1de642['push'](_0x1de642['shift']());}catch(_0xffdf84){_0x1de642['push'](_0x1de642['shift']());}}}(_0x1b58,0x6ec27));var __decorate=this&&this[_0x2fc8e8(0xd5)]||function(_0x414954,_0x569414,_0x2a9670,_0x5c777b){const _0x3a77a0=_0x2fc8e8;var _0x97fe19=arguments[_0x3a77a0(0x139)],_0x3d8e1b=_0x97fe19<0x3?_0x569414:_0x5c777b===null?_0x5c777b=Object['getOwnPropertyDescriptor'](_0x569414,_0x2a9670):_0x5c777b,_0x37b221;if(typeof Reflect===_0x3a77a0(0xdb)&&typeof Reflect[_0x3a77a0(0xf7)]===_0x3a77a0(0xc4))_0x3d8e1b=Reflect[_0x3a77a0(0xf7)](_0x414954,_0x569414,_0x2a9670,_0x5c777b);else{for(var _0x281446=_0x414954[_0x3a77a0(0x139)]-0x1;_0x281446>=0x0;_0x281446--)if(_0x37b221=_0x414954[_0x281446])_0x3d8e1b=(_0x97fe19<0x3?_0x37b221(_0x3d8e1b):_0x97fe19>0x3?_0x37b221(_0x569414,_0x2a9670,_0x3d8e1b):_0x37b221(_0x569414,_0x2a9670))||_0x3d8e1b;}return _0x97fe19>0x3&&_0x3d8e1b&&Object[_0x3a77a0(0xd2)](_0x569414,_0x2a9670,_0x3d8e1b),_0x3d8e1b;},__metadata=this&&this['__metadata']||function(_0x32186d,_0x91e819){const _0x303d07=_0x2fc8e8;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x303d07(0xc4))return Reflect[_0x303d07(0x114)](_0x32186d,_0x91e819);},__param=this&&this[_0x2fc8e8(0xf5)]||function(_0x2280cb,_0x41fecc){return function(_0x1fa379,_0x5f21c7){_0x41fecc(_0x1fa379,_0x5f21c7,_0x2280cb);};};function _0x2c73(_0x36a756,_0x14c434){const _0x1b5806=_0x1b58();return _0x2c73=function(_0x2c737e,_0x5ca090){_0x2c737e=_0x2c737e-0xc4;let _0x247b52=_0x1b5806[_0x2c737e];return _0x247b52;},_0x2c73(_0x36a756,_0x14c434);}Object[_0x2fc8e8(0xd2)](exports,_0x2fc8e8(0x133),{'value':!![]}),exports[_0x2fc8e8(0xf3)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),verification_constant_1=require(_0x2fc8e8(0xfb)),verification_service_1=require(_0x2fc8e8(0x113)),common_1=require(_0x2fc8e8(0xda)),jwt_1=require(_0x2fc8e8(0x138)),user_service_1=require('../user/user.service'),mailer_service_1=require(_0x2fc8e8(0x13b)),user_constant_1=require('../../common/constants/user.constant'),userBalance_service_1=require('../userBalance/userBalance.service'),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require('typeorm'),typeorm_2=require(_0x2fc8e8(0xdd)),utils_1=require('../../common/utils'),os=require('os'),redisCache_service_1=require(_0x2fc8e8(0x100)),svgCaptcha=require(_0x2fc8e8(0x137)),bcrypt=require('bcryptjs');function _0x1b58(){const _0x306d0f=['object','verifyUserCredentials','@nestjs/typeorm','非法操作、请联系管理员！','text','UserStatusEnum','client','registerFailEmailTitle','configKey','password','queryUserInfoById','verifyUserRegisterByPhone','Registration','activateAccount','reduce','3139385BRnBvj','UserStatusErrMsg','set','userService','GlobalConfigService','338220mKRmtx','账户已被激活过','getClientIp','旧密码错误、请检查提交','AuthService','saveToken','__param','internal','decorate','HttpException','无权此操作！','hashSync','../../common/constants/verification.constant','Injectable','sign','637284UTfyLi','registerSuccessEmailTitle','../redisCache/redisCache.service','error:\x20','getInfo',':PHONECODE:','oldPassword','get','savaLoginIp','#fff','login','createTokenFromFingerprint','getUserInfo','verificationService','user','2528358FyVVmZ','getConfigs','jwtService','41012aPnfjM','configEntity','admin','../verification/verification.service','metadata','验证码发送成功、请填写验证码完成注册！','&username=','qureyUserInfoByInviteCode','mailerService','VerificationEnum','captcha','registerByPhone','addBalanceToNewUser','@nine.com','networkInterfaces','ConfigEntity','1SkUOdB','userId','UserBalanceService','padStart','design:paramtypes','updateUserPassword','InjectRepository','VerificationService','&registerSuccessEmailTeamName=','IPv4',':CAPTCHA:','keys','3pfxrAb','userBalanceService','getIp','redirect','6004424JcroVm','createMathExpr','verifyCaptcha','__esModule','createRandomUid','globalConfigService','response','svg-captcha','@nestjs/jwt','length','registerSuccessEmaileAppend','../mailer/mailer.service','BAD_REQUEST','getUserStatus','register','userDefautlAvatar','loginByPhone','getNamespace','/api/auth/registerSuccess?id=','验证码类型错误','sendPhoneCode','&registerSuccessEmailTitle=','function','redisCacheService','verifyUserPassword','/api/auth/registerError?message=','data','179712xsLSAd','RedisCacheService','ACTIVE','sendPhoneCodeWithQcloud','forEach','address','ttl','HttpStatus','verifyCode','defineProperty','updatePassword','avatar','__decorate','秒内不得重复发送短信！','密码修改成功','Repository','log','@nestjs/common'];_0x1b58=function(){return _0x306d0f;};return _0x1b58();}let AuthService=class AuthService{constructor(_0x46b46f,_0x2752ea,_0x1cd5f6,_0x224fe6,_0x48fc42,_0x50f06e,_0x5a9b7d,_0x4eaf8b){const _0x2f1d66=_0x2fc8e8;this[_0x2f1d66(0x111)]=_0x46b46f,this[_0x2f1d66(0xed)]=_0x2752ea,this['jwtService']=_0x1cd5f6,this[_0x2f1d66(0x118)]=_0x224fe6,this[_0x2f1d66(0x10b)]=_0x48fc42,this[_0x2f1d66(0x12d)]=_0x50f06e,this[_0x2f1d66(0xc5)]=_0x5a9b7d,this[_0x2f1d66(0x135)]=_0x4eaf8b;}async['onModuleInit'](){const _0x26a4c7=_0x2fc8e8;this[_0x26a4c7(0x12e)]();}async[_0x2fc8e8(0x13e)](_0x5ee915,_0x5a6b97){const _0x1dfe01=_0x2fc8e8;await this['verificationService']['verifyCaptcha'](_0x5ee915);const _0x4de21c=await this[_0x1dfe01(0xed)]['createUserAndVerifycation'](_0x5ee915,_0x5a6b97),{username:_0x36c470,email:_0x5b13c6,client:_0x3feea3,id:_0x19bdcc}=_0x4de21c,_0x1a58e4={'username':_0x36c470,'email':_0x5b13c6,'id':_0x19bdcc};return _0x3feea3&&(_0x1a58e4[_0x1dfe01(0xe1)]=_0x3feea3),_0x1a58e4;}async[_0x2fc8e8(0x11b)](_0x575a6c,_0x393e64){const _0x55d246=_0x2fc8e8,{username:_0x9f6c71,password:_0x4dd8d3,phone:_0x37ae10,phoneCode:_0x75dafc,invitedBy:_0x3d5dd0}=_0x575a6c;await this[_0x55d246(0xed)][_0x55d246(0xe6)](_0x575a6c);const _0x51657c=await this['globalConfigService'][_0x55d246(0x141)](),_0x51701f=_0x51657c+':PHONECODE:'+_0x37ae10,_0x280d20=await this[_0x55d246(0xc5)][_0x55d246(0x105)]({'key':_0x51701f});if(!_0x280d20)throw new common_1['HttpException']('验证码已过期、请重新发送！',common_1[_0x55d246(0xd0)]['BAD_REQUEST']);if(_0x75dafc!==_0x280d20)throw new common_1[(_0x55d246(0xf8))]('验证码填写错误、请重新输入！',common_1[_0x55d246(0xd0)][_0x55d246(0x13c)]);const _0x2ef355=(0x0,utils_1['createRandomUid'])()+_0x55d246(0x11d),_0x494aff={'username':_0x9f6c71,'password':_0x4dd8d3,'phone':_0x37ae10,'invitedBy':_0x3d5dd0,'email':_0x2ef355,'status':user_constant_1[_0x55d246(0xe0)][_0x55d246(0xcb)]},_0x580c91=await this[_0x55d246(0x135)][_0x55d246(0x10e)]([_0x55d246(0x13f)]);_0x494aff[_0x55d246(0xd4)]=_0x580c91;const _0x4427a0=bcrypt[_0x55d246(0xfa)](_0x4dd8d3,0xa);_0x494aff[_0x55d246(0xe4)]=_0x4427a0;const _0x43bd57=await this[_0x55d246(0xed)]['createUser'](_0x494aff);let _0x224893;_0x3d5dd0&&(_0x224893=await this[_0x55d246(0xed)][_0x55d246(0x117)](_0x3d5dd0));await this[_0x55d246(0x12d)][_0x55d246(0x11c)](_0x43bd57['id'],_0x224893===null||_0x224893===void 0x0?void 0x0:_0x224893['id']);return;}async[_0x2fc8e8(0x108)](_0x24e1bf,_0x34d864){const _0x22fadf=_0x2fc8e8,_0x575819=await this['userService'][_0x22fadf(0xdc)](_0x24e1bf),{username:_0x201bd7,id:_0x4f2a75,email:_0x4723fe,role:_0x5ed68c,openId:_0x3b22a5,client:_0x4eb428}=_0x575819,_0x5058b2=(0x0,utils_1[_0x22fadf(0xf1)])(_0x34d864);await this['userService'][_0x22fadf(0x106)](_0x4f2a75,_0x5058b2);const _0x130336=await this['jwtService'][_0x22fadf(0xfd)]({'username':_0x201bd7,'id':_0x4f2a75,'email':_0x4723fe,'role':_0x5ed68c,'openId':_0x3b22a5,'client':_0x4eb428});return await this[_0x22fadf(0xc5)][_0x22fadf(0xf4)](_0x4f2a75,_0x130336),_0x130336;}async[_0x2fc8e8(0x140)](_0x3a0580,_0x5df52a){const _0x2d88a3=_0x2fc8e8,_0xb400b8=await this[_0x2d88a3(0xed)][_0x2d88a3(0xdc)](_0x3a0580),{username:_0x34d7b2,id:_0x5b4221,email:_0x1745be,role:_0xdb0d36,openId:_0x577b6b,client:_0x25ab8d}=_0xb400b8,_0x574283=(0x0,utils_1[_0x2d88a3(0xf1)])(_0x5df52a);await this[_0x2d88a3(0xed)][_0x2d88a3(0x106)](_0x5b4221,_0x574283);const {phone:_0x278065}=_0x3a0580,_0x3632d9=await this['jwtService']['sign']({'username':_0x34d7b2,'id':_0x5b4221,'email':_0x1745be,'role':_0xdb0d36,'openId':_0x577b6b,'client':_0x25ab8d,'phone':_0x278065});return await this['redisCacheService'][_0x2d88a3(0xf4)](_0x5b4221,_0x3632d9),_0x3632d9;}async['loginByOpenId'](_0x49cd3a,_0x35cafd){const _0x47ed31=_0x2fc8e8,{status:_0x348a53}=_0x49cd3a;if(_0x348a53!==user_constant_1[_0x47ed31(0xe0)]['ACTIVE'])throw new common_1['HttpException'](user_constant_1[_0x47ed31(0xeb)][_0x348a53],common_1['HttpStatus'][_0x47ed31(0x13c)]);const {username:_0x241a8b,id:_0x34c983,email:_0xe6187f,role:_0x361a00,openId:_0x4569c1,client:_0x588f16}=_0x49cd3a,_0x5750a4=(0x0,utils_1[_0x47ed31(0xf1)])(_0x35cafd);await this['userService']['savaLoginIp'](_0x34c983,_0x5750a4);const _0x3e84a7=await this[_0x47ed31(0x10f)][_0x47ed31(0xfd)]({'username':_0x241a8b,'id':_0x34c983,'email':_0xe6187f,'role':_0x361a00,'openId':_0x4569c1,'client':_0x588f16});return await this[_0x47ed31(0xc5)]['saveToken'](_0x34c983,_0x3e84a7),_0x3e84a7;}async[_0x2fc8e8(0x102)](_0x586de7){const _0x4b9130=_0x2fc8e8,{id:_0x2d95a1}=_0x586de7[_0x4b9130(0x10c)];return await this[_0x4b9130(0xed)][_0x4b9130(0x10a)](_0x2d95a1);}async[_0x2fc8e8(0xe8)](_0x33726e,_0x6d40bf){const _0x549f36=_0x2fc8e8,_0x2305cf=await this[_0x549f36(0x111)]['find']({'where':{'configKey':(0x0,typeorm_1['In'])([_0x549f36(0xff),'registerSuccessEmailTeamName',_0x549f36(0x13a),_0x549f36(0xe2),'registerFailEmailTeamName'])}}),_0x25cd5b=_0x2305cf[_0x549f36(0xe9)]((_0x44b0f0,_0x10bc84)=>{const _0x2f36fb=_0x549f36;return _0x44b0f0[_0x10bc84[_0x2f36fb(0xe3)]]=_0x10bc84['configVal'],_0x44b0f0;},{});try{const _0x44c0b0=await this[_0x549f36(0x10b)][_0x549f36(0xd1)](_0x33726e,verification_constant_1[_0x549f36(0x119)][_0x549f36(0xe7)]),{type:_0x15a7cf,userId:_0x3422ae}=_0x44c0b0;if(_0x15a7cf!==verification_constant_1[_0x549f36(0x119)][_0x549f36(0xe7)])throw new common_1[(_0x549f36(0xf8))](_0x549f36(0x143),common_1[_0x549f36(0xd0)][_0x549f36(0x13c)]);const _0x3796bf=await this['userService'][_0x549f36(0x13d)](_0x3422ae);if(_0x3796bf===user_constant_1['UserStatusEnum'][_0x549f36(0xcb)])throw new common_1[(_0x549f36(0xf8))](_0x549f36(0xf0),common_1[_0x549f36(0xd0)]['BAD_REQUEST']);await this[_0x549f36(0xed)]['updateUserStatus'](_0x44c0b0[_0x549f36(0x121)],user_constant_1[_0x549f36(0xe0)][_0x549f36(0xcb)]);const _0x2f9378=await this[_0x549f36(0xed)][_0x549f36(0xe5)](_0x44c0b0[_0x549f36(0x121)]),{username:_0x12d1f4,email:_0x3d9c66,id:_0x10c04e,invitedBy:_0x11ef77}=_0x2f9378;let _0x356b63;_0x11ef77&&(_0x356b63=await this[_0x549f36(0xed)][_0x549f36(0x117)](_0x11ef77)),await this[_0x549f36(0x12d)][_0x549f36(0x11c)](_0x10c04e,_0x356b63===null||_0x356b63===void 0x0?void 0x0:_0x356b63['id']),_0x6d40bf[_0x549f36(0x12f)](_0x549f36(0x142)+_0x10c04e['toString']()[_0x549f36(0x123)](0x4,'0')+_0x549f36(0x116)+_0x12d1f4+'&email='+_0x3d9c66+_0x549f36(0x145)+_0x25cd5b[_0x549f36(0xff)]+_0x549f36(0x128)+_0x25cd5b['registerSuccessEmailTeamName']+'&registerSuccessEmaileAppend='+_0x25cd5b[_0x549f36(0x13a)]);}catch(_0x4bf0a3){console[_0x549f36(0xd9)](_0x549f36(0x101),_0x4bf0a3);const _0x472df3=_0x4bf0a3[_0x549f36(0x136)];_0x6d40bf[_0x549f36(0x12f)](_0x549f36(0xc7)+_0x472df3+'&registerFailEmailTitle='+_0x25cd5b[_0x549f36(0xe2)]+'&registerFailEmailTeamName='+_0x25cd5b['registerFailEmailTeamName']);}}async[_0x2fc8e8(0xd3)](_0x217f59,_0x362242){const _0x588865=_0x2fc8e8,{id:_0x634dda,client:_0x3062b2,role:_0x2356f2}=_0x217f59[_0x588865(0x10c)];if(_0x3062b2&&Number(_0x3062b2)>0x0)throw new common_1[(_0x588865(0xf8))]('无权此操作、请联系管理员！',common_1['HttpStatus'][_0x588865(0x13c)]);if(_0x2356f2===_0x588865(0x112))throw new common_1['HttpException'](_0x588865(0xde),common_1[_0x588865(0xd0)][_0x588865(0x13c)]);const _0x1b9383=await this['userService'][_0x588865(0xc6)](_0x634dda,_0x362242[_0x588865(0x104)]);if(!_0x1b9383)throw new common_1[(_0x588865(0xf8))](_0x588865(0xf2),common_1['HttpStatus'][_0x588865(0x13c)]);return this[_0x588865(0xed)][_0x588865(0x125)](_0x634dda,_0x362242[_0x588865(0xe4)]),'密码修改成功';}async['updatePassByOther'](_0x5e0e66,_0x5f16f9){const _0x8f1962=_0x2fc8e8,{id:_0x150f37,client:_0x5aee9e}=_0x5e0e66[_0x8f1962(0x10c)];if(!_0x5aee9e)throw new common_1[(_0x8f1962(0xf8))](_0x8f1962(0xf9),common_1[_0x8f1962(0xd0)][_0x8f1962(0x13c)]);return this['userService']['updateUserPassword'](_0x150f37,_0x5f16f9[_0x8f1962(0xe4)]),_0x8f1962(0xd7);}[_0x2fc8e8(0x12e)](){const _0x2bd81c=_0x2fc8e8;let _0x53c682;const _0x114a69=os[_0x2bd81c(0x11e)]();Object[_0x2bd81c(0x12b)](_0x114a69)[_0x2bd81c(0xcd)](_0x10368f=>{const _0x1bf226=_0x2bd81c,_0x425043=_0x114a69[_0x10368f];for(let _0xdf2ba4=0x0;_0xdf2ba4<_0x425043[_0x1bf226(0x139)];_0xdf2ba4++){const _0x569fbe=_0x425043[_0xdf2ba4];if(_0x569fbe['family']===_0x1bf226(0x129)&&_0x569fbe[_0x1bf226(0xce)]!=='127.0.0.1'&&!_0x569fbe[_0x1bf226(0xf6)]){_0x53c682=_0x569fbe['address'];break;}}}),this['ipAddress']=_0x53c682;}async[_0x2fc8e8(0x11a)](_0x1e5e2d){const _0x2decf7=_0x2fc8e8,_0x3bb618=await this['globalConfigService'][_0x2decf7(0x141)](),{color:color=_0x2decf7(0x107)}=_0x1e5e2d,_0x30cf88=svgCaptcha[_0x2decf7(0x131)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x4204a1=_0x30cf88[_0x2decf7(0xdf)],_0x4b4a9e=(0x0,utils_1[_0x2decf7(0x134)])(),_0x58f5aa=_0x3bb618+_0x2decf7(0x12a)+_0x4b4a9e;return await this[_0x2decf7(0xc5)][_0x2decf7(0xec)]({'key':_0x58f5aa,'val':_0x30cf88[_0x2decf7(0xdf)]},0x5*0x3c),{'svgCode':_0x30cf88[_0x2decf7(0xc8)],'code':_0x4b4a9e};}async[_0x2fc8e8(0x144)](_0x425b78){const _0x5a4b01=_0x2fc8e8;await this[_0x5a4b01(0x10b)][_0x5a4b01(0x132)](_0x425b78);const {phone:_0x25ec5f}=_0x425b78,_0x570546=await this[_0x5a4b01(0x135)]['getNamespace'](),_0x58f89f=_0x570546+_0x5a4b01(0x103)+_0x25ec5f,_0x2ba15c=await this['redisCacheService'][_0x5a4b01(0xcf)](_0x58f89f);if(_0x2ba15c&&_0x2ba15c>0x0)throw new common_1[(_0x5a4b01(0xf8))](_0x2ba15c+_0x5a4b01(0xd6),common_1['HttpStatus'][_0x5a4b01(0x13c)]);const _0x1e6acb=(0x0,utils_1['createRandomCode'])(),_0x302e15={'phone':_0x25ec5f,'code':_0x1e6acb};return await this[_0x5a4b01(0x10b)][_0x5a4b01(0xcc)](_0x302e15),await this[_0x5a4b01(0xc5)][_0x5a4b01(0xec)]({'key':_0x58f89f,'val':_0x1e6acb},0x1*0x3c),_0x5a4b01(0x115);}[_0x2fc8e8(0x109)](_0x2e0303){const _0x3a7fdd=_0x2fc8e8,_0x369a9a=this[_0x3a7fdd(0x10f)][_0x3a7fdd(0xfd)]({'username':'游客'+_0x2e0303,'id':_0x2e0303,'email':_0x2e0303+_0x3a7fdd(0x11d),'role':'visitor','openId':null,'client':null});return _0x369a9a;}};AuthService=__decorate([(0x0,common_1[_0x2fc8e8(0xfc)])(),__param(0x0,(0x0,typeorm_2[_0x2fc8e8(0x126)])(config_entity_1[_0x2fc8e8(0x11f)])),__metadata(_0x2fc8e8(0x124),[typeorm_1[_0x2fc8e8(0xd8)],user_service_1['UserService'],jwt_1['JwtService'],mailer_service_1['MailerService'],verification_service_1[_0x2fc8e8(0x127)],userBalance_service_1[_0x2fc8e8(0x122)],redisCache_service_1[_0x2fc8e8(0xca)],globalConfig_service_1[_0x2fc8e8(0xee)]])],AuthService),exports[_0x2fc8e8(0xf3)]=AuthService;