'use strict';const _0x372a4f=_0x2390;(function(_0x263671,_0x3a7d4a){const _0x50a862=_0x2390,_0xddccc3=_0x263671();while(!![]){try{const _0x1c5f7d=-parseInt(_0x50a862(0x1d6))/0x1*(-parseInt(_0x50a862(0x1a5))/0x2)+-parseInt(_0x50a862(0x1a7))/0x3*(parseInt(_0x50a862(0x1a4))/0x4)+-parseInt(_0x50a862(0x1e6))/0x5*(parseInt(_0x50a862(0x1bf))/0x6)+-parseInt(_0x50a862(0x1dc))/0x7*(-parseInt(_0x50a862(0x18c))/0x8)+-parseInt(_0x50a862(0x169))/0x9*(parseInt(_0x50a862(0x1bb))/0xa)+parseInt(_0x50a862(0x18d))/0xb*(-parseInt(_0x50a862(0x1d0))/0xc)+-parseInt(_0x50a862(0x1ce))/0xd*(-parseInt(_0x50a862(0x1ae))/0xe);if(_0x1c5f7d===_0x3a7d4a)break;else _0xddccc3['push'](_0xddccc3['shift']());}catch(_0x5d25b8){_0xddccc3['push'](_0xddccc3['shift']());}}}(_0x3b39,0x230be));var __decorate=this&&this[_0x372a4f(0x1be)]||function(_0x451f80,_0x393f0a,_0x131c52,_0x4c7c8a){const _0x135dcd=_0x372a4f;var _0x53414a=arguments['length'],_0x735a63=_0x53414a<0x3?_0x393f0a:_0x4c7c8a===null?_0x4c7c8a=Object[_0x135dcd(0x185)](_0x393f0a,_0x131c52):_0x4c7c8a,_0x5d91e8;if(typeof Reflect==='object'&&typeof Reflect[_0x135dcd(0x1f0)]===_0x135dcd(0x1ab))_0x735a63=Reflect['decorate'](_0x451f80,_0x393f0a,_0x131c52,_0x4c7c8a);else{for(var _0x3cee23=_0x451f80['length']-0x1;_0x3cee23>=0x0;_0x3cee23--)if(_0x5d91e8=_0x451f80[_0x3cee23])_0x735a63=(_0x53414a<0x3?_0x5d91e8(_0x735a63):_0x53414a>0x3?_0x5d91e8(_0x393f0a,_0x131c52,_0x735a63):_0x5d91e8(_0x393f0a,_0x131c52))||_0x735a63;}return _0x53414a>0x3&&_0x735a63&&Object[_0x135dcd(0x18f)](_0x393f0a,_0x131c52,_0x735a63),_0x735a63;},__metadata=this&&this[_0x372a4f(0x16f)]||function(_0x34de3e,_0x4ddebb){const _0x1c7384=_0x372a4f;if(typeof Reflect===_0x1c7384(0x182)&&typeof Reflect['metadata']===_0x1c7384(0x1ab))return Reflect[_0x1c7384(0x19c)](_0x34de3e,_0x4ddebb);},__param=this&&this[_0x372a4f(0x170)]||function(_0x35b45c,_0x4ad7cc){return function(_0x324ac5,_0x372b19){_0x4ad7cc(_0x324ac5,_0x372b19,_0x35b45c);};};Object[_0x372a4f(0x18f)](exports,'__esModule',{'value':!![]}),exports['AuthService']=void 0x0;function _0x2390(_0x5d24a4,_0x4d856a){const _0x3b3910=_0x3b39();return _0x2390=function(_0x23906c,_0x277c0f){_0x23906c=_0x23906c-0x169;let _0x480fb8=_0x3b3910[_0x23906c];return _0x480fb8;},_0x2390(_0x5d24a4,_0x4d856a);}const globalConfig_service_1=require('../globalConfig/globalConfig.service'),verification_constant_1=require(_0x372a4f(0x1df)),verification_service_1=require(_0x372a4f(0x1b5)),common_1=require(_0x372a4f(0x16d)),jwt_1=require('@nestjs/jwt'),user_service_1=require(_0x372a4f(0x1cc)),mailer_service_1=require(_0x372a4f(0x1d3)),user_constant_1=require(_0x372a4f(0x19a)),userBalance_service_1=require('../userBalance/userBalance.service'),config_entity_1=require(_0x372a4f(0x194)),typeorm_1=require('typeorm'),typeorm_2=require('@nestjs/typeorm'),utils_1=require(_0x372a4f(0x198)),os=require('os'),redisCache_service_1=require(_0x372a4f(0x179)),svgCaptcha=require('svg-captcha'),bcrypt=require(_0x372a4f(0x199));function _0x3b39(){const _0x2466b0=['验证码填写错误、请重新输入！','8uvJSBQ','2ALOiaS','password','32163YpxCNt','verifyUserPassword','verificationService','userId','function','onModuleInit','MailerService','39522ObMNFF','family','userService','admin','UserBalanceService','text','无权此操作！','../verification/verification.service','getIp','updatePassByOther','verifyUserRegisterByPhone','&registerSuccessEmailTitle=','旧密码错误、请检查提交','653090QMxztW','&email=','密码修改成功','__decorate','6312SHjQiv','updateUserPassword','createRandomCode','账户已被激活过','非法操作、请联系管理员！','saveToken','IPv4','VerificationEnum','networkInterfaces','client','registerByPhone','captcha','&username=','../user/user.service','127.0.0.1','1846gNUEqO','configVal','25176VqMVjz','verifyUserCredentials','UserStatusEnum','../mailer/mailer.service','visitor','queryUserInfoById','194455iLOBpG','jwtService','reduce','InjectRepository',':PHONECODE:','ACTIVE','63RpCJOH','createRandomUid','registerFailEmailTitle','../../common/constants/verification.constant','验证码已过期、请重新发送！','hashSync','UserService','verifyCaptcha','Repository','sendPhoneCodeWithQcloud','1270viUzFF','registerFailEmailTeamName','error:\x20','qureyUserInfoByInviteCode','&registerFailEmailTeamName=','set','updateUserStatus','Registration',':CAPTCHA:','getConfigs','decorate','RedisCacheService','toString','验证码类型错误','/api/auth/registerError?message=','UserStatusErrMsg','getUserStatus','redirect','HttpException','Injectable','27bXkUhb','forEach','@nine.com','registerSuccessEmailTitle','@nestjs/common','updatePassword','__metadata','__param','registerSuccessEmailTeamName','configEntity','userDefautlAvatar','register','秒内不得重复发送短信！','user','createTokenFromFingerprint','&registerFailEmailTitle=','../redisCache/redisCache.service','sign','HttpStatus','&registerSuccessEmailTeamName=','verifyCode','globalConfigService','getNamespace','createMathExpr','addBalanceToNewUser','object','#fff','address','getOwnPropertyDescriptor','BAD_REQUEST','createUser','ipAddress','activateAccount','login','registerSuccessEmaileAppend','195136yQYkZn','979FvZOTQ','response','defineProperty','loginByPhone','JwtService','getClientIp','userBalanceService','../globalConfig/config.entity','length','&registerSuccessEmaileAppend=','find','../../common/utils','bcryptjs','../../common/constants/user.constant','sendPhoneCode','metadata','design:paramtypes','VerificationService','redisCacheService','get','savaLoginIp','无权此操作、请联系管理员！'];_0x3b39=function(){return _0x2466b0;};return _0x3b39();}let AuthService=class AuthService{constructor(_0x123278,_0xf1286a,_0x37a881,_0x2eb229,_0x400c4b,_0x1f0a59,_0x4e2d27,_0x2c516d){const _0x36e93d=_0x372a4f;this[_0x36e93d(0x172)]=_0x123278,this[_0x36e93d(0x1b0)]=_0xf1286a,this['jwtService']=_0x37a881,this['mailerService']=_0x2eb229,this[_0x36e93d(0x1a9)]=_0x400c4b,this[_0x36e93d(0x193)]=_0x1f0a59,this[_0x36e93d(0x19f)]=_0x4e2d27,this[_0x36e93d(0x17e)]=_0x2c516d;}async[_0x372a4f(0x1ac)](){const _0x1b8061=_0x372a4f;this[_0x1b8061(0x1b6)]();}async[_0x372a4f(0x174)](_0x211cfa,_0x2c862e){const _0x58da7a=_0x372a4f;await this[_0x58da7a(0x1a9)][_0x58da7a(0x1e3)](_0x211cfa);const _0x52ec76=await this[_0x58da7a(0x1b0)]['createUserAndVerifycation'](_0x211cfa,_0x2c862e),{username:_0x2348d7,email:_0x1c7012,client:_0x17d2cb,id:_0x293875}=_0x52ec76,_0x36e11f={'username':_0x2348d7,'email':_0x1c7012,'id':_0x293875};return _0x17d2cb&&(_0x36e11f[_0x58da7a(0x1c8)]=_0x17d2cb),_0x36e11f;}async[_0x372a4f(0x1c9)](_0x32051c,_0x181f62){const _0xef98ac=_0x372a4f,{username:_0x7ca1e0,password:_0x3085a0,phone:_0x29e246,phoneCode:_0x560605,invitedBy:_0x4fcd37}=_0x32051c;await this['userService'][_0xef98ac(0x1b8)](_0x32051c);const _0x52b76a=await this[_0xef98ac(0x17e)][_0xef98ac(0x17f)](),_0x51b530=_0x52b76a+_0xef98ac(0x1da)+_0x29e246,_0x3f70cb=await this['redisCacheService'][_0xef98ac(0x1a0)]({'key':_0x51b530});if(!_0x3f70cb)throw new common_1[(_0xef98ac(0x1f8))](_0xef98ac(0x1e0),common_1['HttpStatus'][_0xef98ac(0x186)]);if(_0x560605!==_0x3f70cb)throw new common_1[(_0xef98ac(0x1f8))](_0xef98ac(0x1a3),common_1[_0xef98ac(0x17b)]['BAD_REQUEST']);const _0x3deacc=(0x0,utils_1[_0xef98ac(0x1dd)])()+_0xef98ac(0x16b),_0x1684fb={'username':_0x7ca1e0,'password':_0x3085a0,'phone':_0x29e246,'invitedBy':_0x4fcd37,'email':_0x3deacc,'status':user_constant_1[_0xef98ac(0x1d2)]['ACTIVE']},_0x1f7884=await this[_0xef98ac(0x17e)][_0xef98ac(0x1ef)]([_0xef98ac(0x173)]);_0x1684fb['avatar']=_0x1f7884;const _0x49c216=bcrypt[_0xef98ac(0x1e1)](_0x3085a0,0xa);_0x1684fb['password']=_0x49c216;const _0x8e06a9=await this['userService'][_0xef98ac(0x187)](_0x1684fb);let _0x22ca8f;_0x4fcd37&&(_0x22ca8f=await this['userService'][_0xef98ac(0x1e9)](_0x4fcd37));await this[_0xef98ac(0x193)][_0xef98ac(0x181)](_0x8e06a9['id'],_0x22ca8f===null||_0x22ca8f===void 0x0?void 0x0:_0x22ca8f['id']);return;}async[_0x372a4f(0x18a)](_0x5bba3d,_0x3151a9){const _0x2a8b11=_0x372a4f,_0x21788e=await this[_0x2a8b11(0x1b0)][_0x2a8b11(0x1d1)](_0x5bba3d),{username:_0x112369,id:_0x1789ea,email:_0x5dff74,role:_0x2573bf,openId:_0x3f7118,client:_0x3d77ba}=_0x21788e,_0xc8691d=(0x0,utils_1[_0x2a8b11(0x192)])(_0x3151a9);await this[_0x2a8b11(0x1b0)][_0x2a8b11(0x1a1)](_0x1789ea,_0xc8691d);const _0x2b93c0=await this[_0x2a8b11(0x1d7)]['sign']({'username':_0x112369,'id':_0x1789ea,'email':_0x5dff74,'role':_0x2573bf,'openId':_0x3f7118,'client':_0x3d77ba});return await this[_0x2a8b11(0x19f)][_0x2a8b11(0x1c4)](_0x1789ea,_0x2b93c0),_0x2b93c0;}async[_0x372a4f(0x190)](_0x4fa4c0,_0x354f49){const _0x5f10bc=_0x372a4f,_0x1742c9=await this[_0x5f10bc(0x1b0)][_0x5f10bc(0x1d1)](_0x4fa4c0),{username:_0x9e55d9,id:_0x863a41,email:_0x50cb01,role:_0x218807,openId:_0x4670f2,client:_0x4d6cc6}=_0x1742c9,_0x46729e=(0x0,utils_1['getClientIp'])(_0x354f49);await this['userService']['savaLoginIp'](_0x863a41,_0x46729e);const {phone:_0x103d03}=_0x4fa4c0,_0x441d35=await this[_0x5f10bc(0x1d7)][_0x5f10bc(0x17a)]({'username':_0x9e55d9,'id':_0x863a41,'email':_0x50cb01,'role':_0x218807,'openId':_0x4670f2,'client':_0x4d6cc6,'phone':_0x103d03});return await this['redisCacheService'][_0x5f10bc(0x1c4)](_0x863a41,_0x441d35),_0x441d35;}async['loginByOpenId'](_0xdf6962,_0xf4b693){const _0xa24b14=_0x372a4f,{status:_0x11040b}=_0xdf6962;if(_0x11040b!==user_constant_1[_0xa24b14(0x1d2)]['ACTIVE'])throw new common_1['HttpException'](user_constant_1[_0xa24b14(0x1f5)][_0x11040b],common_1['HttpStatus']['BAD_REQUEST']);const {username:_0x4bf3f4,id:_0x48b008,email:_0x10c7fd,role:_0x54b670,openId:_0x1d5e80,client:_0x2245cf}=_0xdf6962,_0x28967e=(0x0,utils_1[_0xa24b14(0x192)])(_0xf4b693);await this[_0xa24b14(0x1b0)][_0xa24b14(0x1a1)](_0x48b008,_0x28967e);const _0x3e1d84=await this[_0xa24b14(0x1d7)][_0xa24b14(0x17a)]({'username':_0x4bf3f4,'id':_0x48b008,'email':_0x10c7fd,'role':_0x54b670,'openId':_0x1d5e80,'client':_0x2245cf});return await this[_0xa24b14(0x19f)][_0xa24b14(0x1c4)](_0x48b008,_0x3e1d84),_0x3e1d84;}async['getInfo'](_0x17a7eb){const _0x12c454=_0x372a4f,{id:_0x3a49ac}=_0x17a7eb[_0x12c454(0x176)];return await this[_0x12c454(0x1b0)]['getUserInfo'](_0x3a49ac);}async[_0x372a4f(0x189)](_0x5ade2f,_0x55b53e){const _0x15dd0e=_0x372a4f,_0x145750=await this[_0x15dd0e(0x172)][_0x15dd0e(0x197)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x15dd0e(0x16c),'registerSuccessEmailTeamName',_0x15dd0e(0x18b),_0x15dd0e(0x1de),_0x15dd0e(0x1e7)])}}),_0x5642a0=_0x145750[_0x15dd0e(0x1d8)]((_0xbd09be,_0x3a769f)=>{const _0x1bd534=_0x15dd0e;return _0xbd09be[_0x3a769f['configKey']]=_0x3a769f[_0x1bd534(0x1cf)],_0xbd09be;},{});try{const _0x1658f5=await this[_0x15dd0e(0x1a9)][_0x15dd0e(0x17d)](_0x5ade2f,verification_constant_1[_0x15dd0e(0x1c6)][_0x15dd0e(0x1ed)]),{type:_0x1f4893,userId:_0xee8eed}=_0x1658f5;if(_0x1f4893!==verification_constant_1['VerificationEnum'][_0x15dd0e(0x1ed)])throw new common_1[(_0x15dd0e(0x1f8))](_0x15dd0e(0x1f3),common_1['HttpStatus']['BAD_REQUEST']);const _0x4ab736=await this[_0x15dd0e(0x1b0)][_0x15dd0e(0x1f6)](_0xee8eed);if(_0x4ab736===user_constant_1[_0x15dd0e(0x1d2)][_0x15dd0e(0x1db)])throw new common_1[(_0x15dd0e(0x1f8))](_0x15dd0e(0x1c2),common_1[_0x15dd0e(0x17b)][_0x15dd0e(0x186)]);await this[_0x15dd0e(0x1b0)][_0x15dd0e(0x1ec)](_0x1658f5[_0x15dd0e(0x1aa)],user_constant_1['UserStatusEnum'][_0x15dd0e(0x1db)]);const _0x8a0bfe=await this[_0x15dd0e(0x1b0)][_0x15dd0e(0x1d5)](_0x1658f5['userId']),{username:_0x48a6b2,email:_0x38d89b,id:_0x47d6e4,invitedBy:_0x5b74d9}=_0x8a0bfe;let _0x50f748;_0x5b74d9&&(_0x50f748=await this['userService']['qureyUserInfoByInviteCode'](_0x5b74d9)),await this[_0x15dd0e(0x193)]['addBalanceToNewUser'](_0x47d6e4,_0x50f748===null||_0x50f748===void 0x0?void 0x0:_0x50f748['id']),_0x55b53e[_0x15dd0e(0x1f7)]('/api/auth/registerSuccess?id='+_0x47d6e4[_0x15dd0e(0x1f2)]()['padStart'](0x4,'0')+_0x15dd0e(0x1cb)+_0x48a6b2+_0x15dd0e(0x1bc)+_0x38d89b+_0x15dd0e(0x1b9)+_0x5642a0[_0x15dd0e(0x16c)]+_0x15dd0e(0x17c)+_0x5642a0[_0x15dd0e(0x171)]+_0x15dd0e(0x196)+_0x5642a0['registerSuccessEmaileAppend']);}catch(_0x53b625){console['log'](_0x15dd0e(0x1e8),_0x53b625);const _0x5ab97a=_0x53b625[_0x15dd0e(0x18e)];_0x55b53e['redirect'](_0x15dd0e(0x1f4)+_0x5ab97a+_0x15dd0e(0x178)+_0x5642a0[_0x15dd0e(0x1de)]+_0x15dd0e(0x1ea)+_0x5642a0[_0x15dd0e(0x1e7)]);}}async[_0x372a4f(0x16e)](_0x5eccab,_0x42e0bb){const _0x1ed55a=_0x372a4f,{id:_0x39e173,client:_0x597c6e,role:_0x184faa}=_0x5eccab[_0x1ed55a(0x176)];if(_0x597c6e&&Number(_0x597c6e)>0x0)throw new common_1[(_0x1ed55a(0x1f8))](_0x1ed55a(0x1a2),common_1['HttpStatus'][_0x1ed55a(0x186)]);if(_0x184faa===_0x1ed55a(0x1b1))throw new common_1[(_0x1ed55a(0x1f8))](_0x1ed55a(0x1c3),common_1['HttpStatus'][_0x1ed55a(0x186)]);const _0x106e8e=await this[_0x1ed55a(0x1b0)][_0x1ed55a(0x1a8)](_0x39e173,_0x42e0bb['oldPassword']);if(!_0x106e8e)throw new common_1[(_0x1ed55a(0x1f8))](_0x1ed55a(0x1ba),common_1[_0x1ed55a(0x17b)]['BAD_REQUEST']);return this['userService']['updateUserPassword'](_0x39e173,_0x42e0bb[_0x1ed55a(0x1a6)]),'密码修改成功';}async[_0x372a4f(0x1b7)](_0x458d6f,_0x4f34ac){const _0x53791a=_0x372a4f,{id:_0x231539,client:_0xf785e1}=_0x458d6f[_0x53791a(0x176)];if(!_0xf785e1)throw new common_1[(_0x53791a(0x1f8))](_0x53791a(0x1b4),common_1[_0x53791a(0x17b)][_0x53791a(0x186)]);return this[_0x53791a(0x1b0)][_0x53791a(0x1c0)](_0x231539,_0x4f34ac[_0x53791a(0x1a6)]),_0x53791a(0x1bd);}['getIp'](){const _0x56ad3c=_0x372a4f;let _0x45a4ab;const _0x1ec131=os[_0x56ad3c(0x1c7)]();Object['keys'](_0x1ec131)[_0x56ad3c(0x16a)](_0x58fec6=>{const _0x3ed3e8=_0x56ad3c,_0x59cdfe=_0x1ec131[_0x58fec6];for(let _0x46d4b3=0x0;_0x46d4b3<_0x59cdfe[_0x3ed3e8(0x195)];_0x46d4b3++){const _0x130771=_0x59cdfe[_0x46d4b3];if(_0x130771[_0x3ed3e8(0x1af)]===_0x3ed3e8(0x1c5)&&_0x130771[_0x3ed3e8(0x184)]!==_0x3ed3e8(0x1cd)&&!_0x130771['internal']){_0x45a4ab=_0x130771[_0x3ed3e8(0x184)];break;}}}),this[_0x56ad3c(0x188)]=_0x45a4ab;}async[_0x372a4f(0x1ca)](_0x4a257d){const _0x3324f7=_0x372a4f,_0x7a211f=await this['globalConfigService'][_0x3324f7(0x17f)](),{color:color=_0x3324f7(0x183)}=_0x4a257d,_0x3d01f5=svgCaptcha[_0x3324f7(0x180)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x316830=_0x3d01f5[_0x3324f7(0x1b3)],_0x5f0a89=(0x0,utils_1[_0x3324f7(0x1dd)])(),_0x3d88e2=_0x7a211f+_0x3324f7(0x1ee)+_0x5f0a89;return await this['redisCacheService'][_0x3324f7(0x1eb)]({'key':_0x3d88e2,'val':_0x3d01f5[_0x3324f7(0x1b3)]},0x5*0x3c),{'svgCode':_0x3d01f5['data'],'code':_0x5f0a89};}async[_0x372a4f(0x19b)](_0x46f296){const _0xeaabb8=_0x372a4f;await this[_0xeaabb8(0x1a9)]['verifyCaptcha'](_0x46f296);const {phone:_0x1171da}=_0x46f296,_0x219b93=await this[_0xeaabb8(0x17e)][_0xeaabb8(0x17f)](),_0x394ce6=_0x219b93+':PHONECODE:'+_0x1171da,_0x27f309=await this[_0xeaabb8(0x19f)]['ttl'](_0x394ce6);if(_0x27f309&&_0x27f309>0x0)throw new common_1[(_0xeaabb8(0x1f8))](_0x27f309+_0xeaabb8(0x175),common_1['HttpStatus'][_0xeaabb8(0x186)]);const _0x54f537=(0x0,utils_1[_0xeaabb8(0x1c1)])(),_0x3d7aa4={'phone':_0x1171da,'code':_0x54f537};return await this['verificationService'][_0xeaabb8(0x1e5)](_0x3d7aa4),await this[_0xeaabb8(0x19f)][_0xeaabb8(0x1eb)]({'key':_0x394ce6,'val':_0x54f537},0x1*0x3c),'验证码发送成功、请填写验证码完成注册！';}[_0x372a4f(0x177)](_0x262f23){const _0x19edd4=_0x372a4f,_0x4ae639=this[_0x19edd4(0x1d7)][_0x19edd4(0x17a)]({'username':'游客'+_0x262f23,'id':_0x262f23,'email':_0x262f23+_0x19edd4(0x16b),'role':_0x19edd4(0x1d4),'openId':null,'client':null});return _0x4ae639;}};AuthService=__decorate([(0x0,common_1[_0x372a4f(0x1f9)])(),__param(0x0,(0x0,typeorm_2[_0x372a4f(0x1d9)])(config_entity_1['ConfigEntity'])),__metadata(_0x372a4f(0x19d),[typeorm_1[_0x372a4f(0x1e4)],user_service_1[_0x372a4f(0x1e2)],jwt_1[_0x372a4f(0x191)],mailer_service_1[_0x372a4f(0x1ad)],verification_service_1[_0x372a4f(0x19e)],userBalance_service_1[_0x372a4f(0x1b2)],redisCache_service_1[_0x372a4f(0x1f1)],globalConfig_service_1['GlobalConfigService']])],AuthService),exports['AuthService']=AuthService;