'use strict';function _0x1b94(_0x4ecbb5,_0x4a3eff){const _0x149576=_0x1495();return _0x1b94=function(_0x1b9439,_0x440a0f){_0x1b9439=_0x1b9439-0xdf;let _0xf7ebfb=_0x149576[_0x1b9439];return _0xf7ebfb;},_0x1b94(_0x4ecbb5,_0x4a3eff);}const _0x1d0c4d=_0x1b94;(function(_0xf87c53,_0xc1ef3c){const _0x241fcc=_0x1b94,_0x437b99=_0xf87c53();while(!![]){try{const _0x5a231f=parseInt(_0x241fcc(0x156))/0x1+parseInt(_0x241fcc(0x128))/0x2*(parseInt(_0x241fcc(0x141))/0x3)+-parseInt(_0x241fcc(0x120))/0x4*(-parseInt(_0x241fcc(0xe0))/0x5)+parseInt(_0x241fcc(0xf3))/0x6*(-parseInt(_0x241fcc(0x131))/0x7)+-parseInt(_0x241fcc(0x142))/0x8+-parseInt(_0x241fcc(0xea))/0x9*(-parseInt(_0x241fcc(0x119))/0xa)+-parseInt(_0x241fcc(0xe1))/0xb;if(_0x5a231f===_0xc1ef3c)break;else _0x437b99['push'](_0x437b99['shift']());}catch(_0x4d91f3){_0x437b99['push'](_0x437b99['shift']());}}}(_0x1495,0x448aa));function _0x1495(){const _0xc279ad=['密码修改成功','design:paramtypes','onModuleInit','qureyUserInfoByInviteCode','internal','toString','9WsWbHr','1238200gCLNDO','updatePassword','getOwnPropertyDescriptor','addBalanceToNewUser','../../common/constants/user.constant','BAD_REQUEST','MailerService','bcryptjs','object','Registration','&username=','decorate','&registerSuccessEmailTitle=','createUser','/api/auth/registerError?message=','验证码填写错误、请重新输入！','set','UserStatusEnum','networkInterfaces','metadata','137966sKwvch','captcha','秒内不得重复发送短信！','__esModule','非法操作、请联系管理员！','HttpException','registerFailEmailTeamName','无权此操作！','defineProperty','activateAccount','padStart',':PHONECODE:','function','registerByPhone','reduce','verificationService','验证码类型错误','saveToken','getIp','&registerSuccessEmailTeamName=','HttpStatus','get','&registerSuccessEmaileAppend=','875890MDZEic','5488362xKhrDR','__decorate','sign','configEntity','@nestjs/common','userBalanceService','verifyUserPassword','验证码发送成功、请填写验证码完成注册！','data','1224522eYPfcL',':CAPTCHA:','globalConfigService','mailerService','../mailer/mailer.service','userService','../../common/utils','../globalConfig/config.entity','GlobalConfigService','1526412aftRjl','registerSuccessEmaileAppend','verifyCaptcha','updatePassByOther','JwtService','../verification/verification.service','user','registerSuccessEmailTitle','sendPhoneCode','UserStatusErrMsg','&registerFailEmailTeamName=','registerSuccessEmailTeamName','Injectable','password','hashSync','账户已被激活过','updateUserStatus','@nine.com','response','../userBalance/userBalance.service','../../common/constants/verification.constant','/api/auth/registerSuccess?id=','getUserStatus','configVal','&registerFailEmailTitle=','ACTIVE','../globalConfig/globalConfig.service','svg-captcha','getConfigs','length','getNamespace','createUserAndVerifycation','userDefautlAvatar','savaLoginIp','family','redirect','updateUserPassword','loginByPhone','20BICljV','ConfigEntity','client','VerificationEnum','getUserInfo','find','createTokenFromFingerprint','12rhWYiL','login','queryUserInfoById','registerFailEmailTitle','&email=','visitor','text','createMathExpr','338434dsYnRG','log','getClientIp','AuthService','UserService','createRandomUid','address','UserBalanceService','@nestjs/typeorm','14BWDDsx','getInfo','../user/user.service','ttl','RedisCacheService','jwtService','forEach','admin','ipAddress','redisCacheService'];_0x1495=function(){return _0xc279ad;};return _0x1495();}var __decorate=this&&this[_0x1d0c4d(0xe2)]||function(_0x29797b,_0x193d35,_0x4e62ba,_0x52f81a){const _0x5dfe40=_0x1d0c4d;var _0xabe9aa=arguments[_0x5dfe40(0x110)],_0xcc595e=_0xabe9aa<0x3?_0x193d35:_0x52f81a===null?_0x52f81a=Object[_0x5dfe40(0x144)](_0x193d35,_0x4e62ba):_0x52f81a,_0x2eaa53;if(typeof Reflect===_0x5dfe40(0x14a)&&typeof Reflect['decorate']==='function')_0xcc595e=Reflect[_0x5dfe40(0x14d)](_0x29797b,_0x193d35,_0x4e62ba,_0x52f81a);else{for(var _0x179f56=_0x29797b['length']-0x1;_0x179f56>=0x0;_0x179f56--)if(_0x2eaa53=_0x29797b[_0x179f56])_0xcc595e=(_0xabe9aa<0x3?_0x2eaa53(_0xcc595e):_0xabe9aa>0x3?_0x2eaa53(_0x193d35,_0x4e62ba,_0xcc595e):_0x2eaa53(_0x193d35,_0x4e62ba))||_0xcc595e;}return _0xabe9aa>0x3&&_0xcc595e&&Object[_0x5dfe40(0x15e)](_0x193d35,_0x4e62ba,_0xcc595e),_0xcc595e;},__metadata=this&&this['__metadata']||function(_0x486d51,_0x4a603f){const _0x5e1e94=_0x1d0c4d;if(typeof Reflect===_0x5e1e94(0x14a)&&typeof Reflect[_0x5e1e94(0x155)]===_0x5e1e94(0x162))return Reflect[_0x5e1e94(0x155)](_0x486d51,_0x4a603f);},__param=this&&this['__param']||function(_0x53642c,_0x3b3db8){return function(_0x2915e6,_0x223b60){_0x3b3db8(_0x2915e6,_0x223b60,_0x53642c);};};Object[_0x1d0c4d(0x15e)](exports,_0x1d0c4d(0x159),{'value':!![]}),exports[_0x1d0c4d(0x12b)]=void 0x0;const globalConfig_service_1=require(_0x1d0c4d(0x10d)),verification_constant_1=require(_0x1d0c4d(0x107)),verification_service_1=require(_0x1d0c4d(0xf8)),common_1=require(_0x1d0c4d(0xe5)),jwt_1=require('@nestjs/jwt'),user_service_1=require(_0x1d0c4d(0x133)),mailer_service_1=require(_0x1d0c4d(0xee)),user_constant_1=require(_0x1d0c4d(0x146)),userBalance_service_1=require(_0x1d0c4d(0x106)),config_entity_1=require(_0x1d0c4d(0xf1)),typeorm_1=require('typeorm'),typeorm_2=require(_0x1d0c4d(0x130)),utils_1=require(_0x1d0c4d(0xf0)),os=require('os'),redisCache_service_1=require('../redisCache/redisCache.service'),svgCaptcha=require(_0x1d0c4d(0x10e)),bcrypt=require(_0x1d0c4d(0x149));let AuthService=class AuthService{constructor(_0x2bd886,_0x1453dd,_0x265f8c,_0x2410fd,_0x268dba,_0x3949b1,_0x22745b,_0x3d66e2){const _0x1db58c=_0x1d0c4d;this[_0x1db58c(0xe4)]=_0x2bd886,this[_0x1db58c(0xef)]=_0x1453dd,this[_0x1db58c(0x136)]=_0x265f8c,this[_0x1db58c(0xed)]=_0x2410fd,this[_0x1db58c(0x165)]=_0x268dba,this[_0x1db58c(0xe6)]=_0x3949b1,this[_0x1db58c(0x13a)]=_0x22745b,this[_0x1db58c(0xec)]=_0x3d66e2;}async[_0x1d0c4d(0x13d)](){const _0x5df127=_0x1d0c4d;this[_0x5df127(0x168)]();}async['register'](_0x268248,_0xb147ce){const _0x182f00=_0x1d0c4d;await this[_0x182f00(0x165)][_0x182f00(0xf5)](_0x268248);const _0xb87078=await this['userService'][_0x182f00(0x112)](_0x268248,_0xb147ce),{username:_0xd1aecd,email:_0x59867f,client:_0x9f2d1e,id:_0x357192}=_0xb87078,_0x15e9f3={'username':_0xd1aecd,'email':_0x59867f,'id':_0x357192};return _0x9f2d1e&&(_0x15e9f3[_0x182f00(0x11b)]=_0x9f2d1e),_0x15e9f3;}async[_0x1d0c4d(0x163)](_0x436b5d,_0x2a4023){const _0x3c9120=_0x1d0c4d,{username:_0x1970be,password:_0x1dd568,phone:_0x10f56f,phoneCode:_0x5a7036,invitedBy:_0x3310a0}=_0x436b5d;await this[_0x3c9120(0xef)]['verifyUserRegisterByPhone'](_0x436b5d);const _0x236966=await this[_0x3c9120(0xec)][_0x3c9120(0x111)](),_0x2fba87=_0x236966+_0x3c9120(0x161)+_0x10f56f,_0x501bc8=await this['redisCacheService'][_0x3c9120(0x16b)]({'key':_0x2fba87});if(!_0x501bc8)throw new common_1[(_0x3c9120(0x15b))]('验证码已过期、请重新发送！',common_1[_0x3c9120(0x16a)][_0x3c9120(0x147)]);if(_0x5a7036!==_0x501bc8)throw new common_1[(_0x3c9120(0x15b))](_0x3c9120(0x151),common_1['HttpStatus'][_0x3c9120(0x147)]);const _0x4b7e82=(0x0,utils_1[_0x3c9120(0x12d)])()+_0x3c9120(0x104),_0x469919={'username':_0x1970be,'password':_0x1dd568,'phone':_0x10f56f,'invitedBy':_0x3310a0,'email':_0x4b7e82,'status':user_constant_1['UserStatusEnum']['ACTIVE']},_0x2d3d0c=await this[_0x3c9120(0xec)][_0x3c9120(0x10f)]([_0x3c9120(0x113)]);_0x469919['avatar']=_0x2d3d0c;const _0x33b9e0=bcrypt[_0x3c9120(0x101)](_0x1dd568,0xa);_0x469919[_0x3c9120(0x100)]=_0x33b9e0;const _0x45104a=await this['userService'][_0x3c9120(0x14f)](_0x469919);let _0x1276c1;_0x3310a0&&(_0x1276c1=await this[_0x3c9120(0xef)][_0x3c9120(0x13e)](_0x3310a0));await this[_0x3c9120(0xe6)][_0x3c9120(0x145)](_0x45104a['id'],_0x1276c1===null||_0x1276c1===void 0x0?void 0x0:_0x1276c1['id']);return;}async[_0x1d0c4d(0x121)](_0xda4a6c,_0x13cabe){const _0x197a0d=_0x1d0c4d,_0x505fd3=await this[_0x197a0d(0xef)]['verifyUserCredentials'](_0xda4a6c),{username:_0xd5980a,id:_0x100470,email:_0x301c07,role:_0x10b4e0,openId:_0xcce4c3,client:_0x30bc81}=_0x505fd3,_0x3f8473=(0x0,utils_1['getClientIp'])(_0x13cabe);await this[_0x197a0d(0xef)][_0x197a0d(0x114)](_0x100470,_0x3f8473);const _0x1129b0=await this[_0x197a0d(0x136)][_0x197a0d(0xe3)]({'username':_0xd5980a,'id':_0x100470,'email':_0x301c07,'role':_0x10b4e0,'openId':_0xcce4c3,'client':_0x30bc81});return await this[_0x197a0d(0x13a)][_0x197a0d(0x167)](_0x100470,_0x1129b0),_0x1129b0;}async[_0x1d0c4d(0x118)](_0xe16ef8,_0x366d61){const _0x5af951=_0x1d0c4d,_0x573510=await this['userService']['verifyUserCredentials'](_0xe16ef8),{username:_0x14611d,id:_0x3e3c7a,email:_0x37b372,role:_0x33dbaf,openId:_0x3aa0bb,client:_0xf7e3b3}=_0x573510,_0x4480aa=(0x0,utils_1[_0x5af951(0x12a)])(_0x366d61);await this[_0x5af951(0xef)]['savaLoginIp'](_0x3e3c7a,_0x4480aa);const {phone:_0x5a4cf2}=_0xe16ef8,_0x3d5c3f=await this[_0x5af951(0x136)]['sign']({'username':_0x14611d,'id':_0x3e3c7a,'email':_0x37b372,'role':_0x33dbaf,'openId':_0x3aa0bb,'client':_0xf7e3b3,'phone':_0x5a4cf2});return await this[_0x5af951(0x13a)][_0x5af951(0x167)](_0x3e3c7a,_0x3d5c3f),_0x3d5c3f;}async['loginByOpenId'](_0x4967dc,_0x1d6ac1){const _0x1beceb=_0x1d0c4d,{status:_0x1e174d}=_0x4967dc;if(_0x1e174d!==user_constant_1[_0x1beceb(0x153)][_0x1beceb(0x10c)])throw new common_1[(_0x1beceb(0x15b))](user_constant_1[_0x1beceb(0xfc)][_0x1e174d],common_1['HttpStatus'][_0x1beceb(0x147)]);const {username:_0x457043,id:_0x1c2362,email:_0x13e257,role:_0x273ee7,openId:_0x5be626,client:_0x4c0955}=_0x4967dc,_0x3a8e1f=(0x0,utils_1[_0x1beceb(0x12a)])(_0x1d6ac1);await this[_0x1beceb(0xef)][_0x1beceb(0x114)](_0x1c2362,_0x3a8e1f);const _0x1c8f4a=await this[_0x1beceb(0x136)][_0x1beceb(0xe3)]({'username':_0x457043,'id':_0x1c2362,'email':_0x13e257,'role':_0x273ee7,'openId':_0x5be626,'client':_0x4c0955});return await this['redisCacheService'][_0x1beceb(0x167)](_0x1c2362,_0x1c8f4a),_0x1c8f4a;}async[_0x1d0c4d(0x132)](_0x5848ae){const _0x1fe2b8=_0x1d0c4d,{id:_0x2b7b0a}=_0x5848ae[_0x1fe2b8(0xf9)];return await this[_0x1fe2b8(0xef)][_0x1fe2b8(0x11d)](_0x2b7b0a);}async[_0x1d0c4d(0x15f)](_0x40050b,_0x4435db){const _0xf127bc=_0x1d0c4d,_0x45910d=await this[_0xf127bc(0xe4)][_0xf127bc(0x11e)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0xf127bc(0xfa),_0xf127bc(0xfe),_0xf127bc(0xf4),'registerFailEmailTitle','registerFailEmailTeamName'])}}),_0x22d595=_0x45910d[_0xf127bc(0x164)]((_0x35003c,_0x26e72d)=>{const _0x34f5e8=_0xf127bc;return _0x35003c[_0x26e72d['configKey']]=_0x26e72d[_0x34f5e8(0x10a)],_0x35003c;},{});try{const _0x311e9e=await this[_0xf127bc(0x165)]['verifyCode'](_0x40050b,verification_constant_1[_0xf127bc(0x11c)][_0xf127bc(0x14b)]),{type:_0x4b8d2d,userId:_0x7df84e}=_0x311e9e;if(_0x4b8d2d!==verification_constant_1[_0xf127bc(0x11c)][_0xf127bc(0x14b)])throw new common_1[(_0xf127bc(0x15b))](_0xf127bc(0x166),common_1[_0xf127bc(0x16a)][_0xf127bc(0x147)]);const _0x5bfcb8=await this['userService'][_0xf127bc(0x109)](_0x7df84e);if(_0x5bfcb8===user_constant_1[_0xf127bc(0x153)][_0xf127bc(0x10c)])throw new common_1[(_0xf127bc(0x15b))](_0xf127bc(0x102),common_1[_0xf127bc(0x16a)][_0xf127bc(0x147)]);await this['userService'][_0xf127bc(0x103)](_0x311e9e['userId'],user_constant_1[_0xf127bc(0x153)][_0xf127bc(0x10c)]);const _0x5e5884=await this[_0xf127bc(0xef)][_0xf127bc(0x122)](_0x311e9e['userId']),{username:_0x299b1e,email:_0xb238f8,id:_0x478215,invitedBy:_0x1fce09}=_0x5e5884;let _0x14f733;_0x1fce09&&(_0x14f733=await this[_0xf127bc(0xef)]['qureyUserInfoByInviteCode'](_0x1fce09)),await this['userBalanceService']['addBalanceToNewUser'](_0x478215,_0x14f733===null||_0x14f733===void 0x0?void 0x0:_0x14f733['id']),_0x4435db[_0xf127bc(0x116)](_0xf127bc(0x108)+_0x478215[_0xf127bc(0x140)]()[_0xf127bc(0x160)](0x4,'0')+_0xf127bc(0x14c)+_0x299b1e+_0xf127bc(0x124)+_0xb238f8+_0xf127bc(0x14e)+_0x22d595[_0xf127bc(0xfa)]+_0xf127bc(0x169)+_0x22d595[_0xf127bc(0xfe)]+_0xf127bc(0xdf)+_0x22d595[_0xf127bc(0xf4)]);}catch(_0xfcf8bd){console[_0xf127bc(0x129)]('error:\x20',_0xfcf8bd);const _0x15afbd=_0xfcf8bd[_0xf127bc(0x105)];_0x4435db['redirect'](_0xf127bc(0x150)+_0x15afbd+_0xf127bc(0x10b)+_0x22d595[_0xf127bc(0x123)]+_0xf127bc(0xfd)+_0x22d595[_0xf127bc(0x15c)]);}}async[_0x1d0c4d(0x143)](_0x133c11,_0x1d1101){const _0x1f95cb=_0x1d0c4d,{id:_0x412021,client:_0xcd6977,role:_0x5bcb0e}=_0x133c11['user'];if(_0xcd6977&&Number(_0xcd6977)>0x0)throw new common_1[(_0x1f95cb(0x15b))]('无权此操作、请联系管理员！',common_1[_0x1f95cb(0x16a)][_0x1f95cb(0x147)]);if(_0x5bcb0e===_0x1f95cb(0x138))throw new common_1['HttpException'](_0x1f95cb(0x15a),common_1['HttpStatus'][_0x1f95cb(0x147)]);const _0xf8ae41=await this[_0x1f95cb(0xef)][_0x1f95cb(0xe7)](_0x412021,_0x1d1101['oldPassword']);if(!_0xf8ae41)throw new common_1[(_0x1f95cb(0x15b))]('旧密码错误、请检查提交',common_1[_0x1f95cb(0x16a)][_0x1f95cb(0x147)]);return this['userService'][_0x1f95cb(0x117)](_0x412021,_0x1d1101[_0x1f95cb(0x100)]),_0x1f95cb(0x13b);}async[_0x1d0c4d(0xf6)](_0x1899e9,_0x2d459c){const _0xa9f5da=_0x1d0c4d,{id:_0xeef559,client:_0xe65acb}=_0x1899e9[_0xa9f5da(0xf9)];if(!_0xe65acb)throw new common_1[(_0xa9f5da(0x15b))](_0xa9f5da(0x15d),common_1[_0xa9f5da(0x16a)][_0xa9f5da(0x147)]);return this[_0xa9f5da(0xef)]['updateUserPassword'](_0xeef559,_0x2d459c[_0xa9f5da(0x100)]),_0xa9f5da(0x13b);}['getIp'](){const _0x3ee3fb=_0x1d0c4d;let _0x2986d7;const _0x3c9e6d=os[_0x3ee3fb(0x154)]();Object['keys'](_0x3c9e6d)[_0x3ee3fb(0x137)](_0x123b62=>{const _0x158f59=_0x3ee3fb,_0xa45e0f=_0x3c9e6d[_0x123b62];for(let _0x154eab=0x0;_0x154eab<_0xa45e0f[_0x158f59(0x110)];_0x154eab++){const _0x4d36ba=_0xa45e0f[_0x154eab];if(_0x4d36ba[_0x158f59(0x115)]==='IPv4'&&_0x4d36ba[_0x158f59(0x12e)]!=='127.0.0.1'&&!_0x4d36ba[_0x158f59(0x13f)]){_0x2986d7=_0x4d36ba['address'];break;}}}),this[_0x3ee3fb(0x139)]=_0x2986d7;}async[_0x1d0c4d(0x157)](_0x2fa27b){const _0x148b0f=_0x1d0c4d,_0x5f0613=await this['globalConfigService']['getNamespace'](),{color:color='#fff'}=_0x2fa27b,_0xd59c07=svgCaptcha[_0x148b0f(0x127)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x3587bf=_0xd59c07['text'],_0x1b51b1=(0x0,utils_1[_0x148b0f(0x12d)])(),_0x4bade2=_0x5f0613+_0x148b0f(0xeb)+_0x1b51b1;return await this[_0x148b0f(0x13a)][_0x148b0f(0x152)]({'key':_0x4bade2,'val':_0xd59c07[_0x148b0f(0x126)]},0x5*0x3c),{'svgCode':_0xd59c07[_0x148b0f(0xe9)],'code':_0x1b51b1};}async[_0x1d0c4d(0xfb)](_0xd363a7){const _0x479b1f=_0x1d0c4d;await this[_0x479b1f(0x165)][_0x479b1f(0xf5)](_0xd363a7);const {phone:_0x30cd2a}=_0xd363a7,_0x2c2b83=await this['globalConfigService'][_0x479b1f(0x111)](),_0x4a30e5=_0x2c2b83+_0x479b1f(0x161)+_0x30cd2a,_0x19ff74=await this[_0x479b1f(0x13a)][_0x479b1f(0x134)](_0x4a30e5);if(_0x19ff74&&_0x19ff74>0x0)throw new common_1[(_0x479b1f(0x15b))](_0x19ff74+_0x479b1f(0x158),common_1[_0x479b1f(0x16a)][_0x479b1f(0x147)]);const _0x86c21a=(0x0,utils_1['createRandomCode'])(),_0x3c6a27={'phone':_0x30cd2a,'code':_0x86c21a};return await this[_0x479b1f(0x165)]['sendPhoneCodeWithQcloud'](_0x3c6a27),await this['redisCacheService'][_0x479b1f(0x152)]({'key':_0x4a30e5,'val':_0x86c21a},0x1*0x3c),_0x479b1f(0xe8);}[_0x1d0c4d(0x11f)](_0x4192a9){const _0x12c6f4=_0x1d0c4d,_0x53cc12=this[_0x12c6f4(0x136)]['sign']({'username':'游客'+_0x4192a9,'id':_0x4192a9,'email':_0x4192a9+'@nine.com','role':_0x12c6f4(0x125),'openId':null,'client':null});return _0x53cc12;}};AuthService=__decorate([(0x0,common_1[_0x1d0c4d(0xff)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(config_entity_1[_0x1d0c4d(0x11a)])),__metadata(_0x1d0c4d(0x13c),[typeorm_1['Repository'],user_service_1[_0x1d0c4d(0x12c)],jwt_1[_0x1d0c4d(0xf7)],mailer_service_1[_0x1d0c4d(0x148)],verification_service_1['VerificationService'],userBalance_service_1[_0x1d0c4d(0x12f)],redisCache_service_1[_0x1d0c4d(0x135)],globalConfig_service_1[_0x1d0c4d(0xf2)]])],AuthService),exports[_0x1d0c4d(0x12b)]=AuthService;