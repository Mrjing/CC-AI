'use strict';const _0x1731dd=_0x3bc6;function _0x4fbe(){const _0x49010d=['activateAccount','/api/auth/registerSuccess?id=','10291010zfLsyo','VerificationEnum','registerSuccessEmailTeamName','旧密码错误、请检查提交','registerSuccessEmailTitle','text','getConfigs','@nestjs/jwt','密码修改成功','验证码发送成功、请填写验证码完成注册！','updatePassByOther','InjectRepository','set','userId','无权此操作、请联系管理员！',':PHONECODE:','verifyUserCredentials','reduce','@nestjs/common','ACTIVE','@nine.com','114GauHfF','验证码类型错误','../userBalance/userBalance.service','client','ipAddress','family','sign','globalConfigService','verifyUserPassword','admin','UserService','length','registerFailEmailTitle','无权此操作！','userService','&email=','__decorate','qureyUserInfoByInviteCode','object','savaLoginIp','getClientIp','toString','networkInterfaces','address','visitor','BAD_REQUEST','HttpStatus','1168723MJRGQH','&username=','metadata','getOwnPropertyDescriptor','__esModule','createUser','../redisCache/redisCache.service','../verification/verification.service','verifyCaptcha','UserBalanceService','Registration','Repository','loginByOpenId','IPv4','sendPhoneCode','addBalanceToNewUser','GlobalConfigService','../globalConfig/config.entity','UserStatusEnum','createTokenFromFingerprint','jwtService','data','configEntity','updateUserStatus','oldPassword','registerFailEmailTeamName','keys','typeorm','9327410acmwqD','15IYaZdu','captcha','MailerService','decorate','redisCacheService','design:paramtypes','../../common/utils','get','&registerFailEmailTitle=','find','error:\x20','HttpException','response','&registerSuccessEmaileAppend=','userBalanceService','hashSync','defineProperty','userDefautlAvatar','svg-captcha','VerificationService','configKey','279601sSkXJN','2405082lOLiEB','verifyCode','function','../globalConfig/globalConfig.service','updateUserPassword','9OQvTdp','Injectable','&registerSuccessEmailTitle=','createRandomUid','JwtService','getUserInfo','getInfo','ttl','2008000OaMYzC','user','bcryptjs','/api/auth/registerError?message=','getIp','log',':CAPTCHA:','registerSuccessEmaileAppend','验证码已过期、请重新发送！','verificationService','625304xIqSkt','redirect','127.0.0.1','forEach','saveToken','../user/user.service','ConfigEntity','非法操作、请联系管理员！','createRandomCode','updatePassword','internal'];_0x4fbe=function(){return _0x49010d;};return _0x4fbe();}(function(_0x23b52a,_0x1b9ef5){const _0x1fbdd8=_0x3bc6,_0x4af04b=_0x23b52a();while(!![]){try{const _0x4ad48d=-parseInt(_0x1fbdd8(0x172))/0x1+parseInt(_0x1fbdd8(0x11e))/0x2+parseInt(_0x1fbdd8(0x108))/0x3*(parseInt(_0x1fbdd8(0x135))/0x4)+-parseInt(_0x1fbdd8(0x107))/0x5+parseInt(_0x1fbdd8(0x157))/0x6*(parseInt(_0x1fbdd8(0x11d))/0x7)+parseInt(_0x1fbdd8(0x12b))/0x8+-parseInt(_0x1fbdd8(0x123))/0x9*(-parseInt(_0x1fbdd8(0x142))/0xa);if(_0x4ad48d===_0x1b9ef5)break;else _0x4af04b['push'](_0x4af04b['shift']());}catch(_0x49f70c){_0x4af04b['push'](_0x4af04b['shift']());}}}(_0x4fbe,0xf1738));var __decorate=this&&this[_0x1731dd(0x167)]||function(_0x3421a5,_0x21319c,_0x3a08fb,_0x379b5a){const _0xd8b2af=_0x1731dd;var _0x33f559=arguments[_0xd8b2af(0x162)],_0x1cf2d9=_0x33f559<0x3?_0x21319c:_0x379b5a===null?_0x379b5a=Object[_0xd8b2af(0x175)](_0x21319c,_0x3a08fb):_0x379b5a,_0x476f42;if(typeof Reflect===_0xd8b2af(0x169)&&typeof Reflect['decorate']===_0xd8b2af(0x120))_0x1cf2d9=Reflect[_0xd8b2af(0x10b)](_0x3421a5,_0x21319c,_0x3a08fb,_0x379b5a);else{for(var _0x2c72e7=_0x3421a5[_0xd8b2af(0x162)]-0x1;_0x2c72e7>=0x0;_0x2c72e7--)if(_0x476f42=_0x3421a5[_0x2c72e7])_0x1cf2d9=(_0x33f559<0x3?_0x476f42(_0x1cf2d9):_0x33f559>0x3?_0x476f42(_0x21319c,_0x3a08fb,_0x1cf2d9):_0x476f42(_0x21319c,_0x3a08fb))||_0x1cf2d9;}return _0x33f559>0x3&&_0x1cf2d9&&Object[_0xd8b2af(0x118)](_0x21319c,_0x3a08fb,_0x1cf2d9),_0x1cf2d9;},__metadata=this&&this['__metadata']||function(_0x1302e7,_0x10c9c6){const _0xa9aeed=_0x1731dd;if(typeof Reflect===_0xa9aeed(0x169)&&typeof Reflect[_0xa9aeed(0x174)]===_0xa9aeed(0x120))return Reflect[_0xa9aeed(0x174)](_0x1302e7,_0x10c9c6);},__param=this&&this['__param']||function(_0xfba3ef,_0x4fb7c4){return function(_0x287fda,_0x3e5162){_0x4fb7c4(_0x287fda,_0x3e5162,_0xfba3ef);};};Object['defineProperty'](exports,_0x1731dd(0x176),{'value':!![]}),exports['AuthService']=void 0x0;function _0x3bc6(_0x8750e4,_0x16008e){const _0x4fbe0a=_0x4fbe();return _0x3bc6=function(_0x3bc6eb,_0x5b5cf9){_0x3bc6eb=_0x3bc6eb-0xf7;let _0x3fb2fe=_0x4fbe0a[_0x3bc6eb];return _0x3fb2fe;},_0x3bc6(_0x8750e4,_0x16008e);}const globalConfig_service_1=require(_0x1731dd(0x121)),verification_constant_1=require('../../common/constants/verification.constant'),verification_service_1=require(_0x1731dd(0x179)),common_1=require(_0x1731dd(0x154)),jwt_1=require(_0x1731dd(0x149)),user_service_1=require(_0x1731dd(0x13a)),mailer_service_1=require('../mailer/mailer.service'),user_constant_1=require('../../common/constants/user.constant'),userBalance_service_1=require(_0x1731dd(0x159)),config_entity_1=require(_0x1731dd(0xfc)),typeorm_1=require(_0x1731dd(0x106)),typeorm_2=require('@nestjs/typeorm'),utils_1=require(_0x1731dd(0x10e)),os=require('os'),redisCache_service_1=require(_0x1731dd(0x178)),svgCaptcha=require(_0x1731dd(0x11a)),bcrypt=require(_0x1731dd(0x12d));let AuthService=class AuthService{constructor(_0xcecf81,_0x27655f,_0x7380b9,_0x13e4bf,_0xe3cf49,_0x38b303,_0xa69247,_0x14211c){const _0x121615=_0x1731dd;this[_0x121615(0x101)]=_0xcecf81,this[_0x121615(0x165)]=_0x27655f,this[_0x121615(0xff)]=_0x7380b9,this['mailerService']=_0x13e4bf,this[_0x121615(0x134)]=_0xe3cf49,this['userBalanceService']=_0x38b303,this[_0x121615(0x10c)]=_0xa69247,this[_0x121615(0x15e)]=_0x14211c;}async['onModuleInit'](){const _0x2c40ba=_0x1731dd;this[_0x2c40ba(0x12f)]();}async['register'](_0xe5cf59,_0x2a7aaa){const _0x5e4577=_0x1731dd;await this[_0x5e4577(0x134)][_0x5e4577(0x17a)](_0xe5cf59);const _0x4c1afa=await this[_0x5e4577(0x165)]['createUserAndVerifycation'](_0xe5cf59,_0x2a7aaa),{username:_0x325f7b,email:_0x57ad4f,client:_0x235d59,id:_0x252495}=_0x4c1afa,_0x18f476={'username':_0x325f7b,'email':_0x57ad4f,'id':_0x252495};return _0x235d59&&(_0x18f476[_0x5e4577(0x15a)]=_0x235d59),_0x18f476;}async['registerByPhone'](_0x3045e0,_0x3dcea0){const _0x5b4fdf=_0x1731dd,{username:_0x32755a,password:_0x2dea9,phone:_0x2898d3,phoneCode:_0x11fe18,invitedBy:_0x4cad50}=_0x3045e0;await this[_0x5b4fdf(0x165)]['verifyUserRegisterByPhone'](_0x3045e0);const _0x24cee2=await this[_0x5b4fdf(0x15e)]['getNamespace'](),_0xd0dfa=_0x24cee2+_0x5b4fdf(0x151)+_0x2898d3,_0x492eba=await this[_0x5b4fdf(0x10c)][_0x5b4fdf(0x10f)]({'key':_0xd0dfa});if(!_0x492eba)throw new common_1[(_0x5b4fdf(0x113))](_0x5b4fdf(0x133),common_1[_0x5b4fdf(0x171)]['BAD_REQUEST']);if(_0x11fe18!==_0x492eba)throw new common_1[(_0x5b4fdf(0x113))]('验证码填写错误、请重新输入！',common_1[_0x5b4fdf(0x171)]['BAD_REQUEST']);const _0x44dc40=(0x0,utils_1[_0x5b4fdf(0x126)])()+'@nine.com',_0x33b0a7={'username':_0x32755a,'password':_0x2dea9,'phone':_0x2898d3,'invitedBy':_0x4cad50,'email':_0x44dc40,'status':user_constant_1['UserStatusEnum'][_0x5b4fdf(0x155)]},_0x4f8144=await this[_0x5b4fdf(0x15e)][_0x5b4fdf(0x148)]([_0x5b4fdf(0x119)]);_0x33b0a7['avatar']=_0x4f8144;const _0x41f1d3=bcrypt[_0x5b4fdf(0x117)](_0x2dea9,0xa);_0x33b0a7['password']=_0x41f1d3;const _0x579f22=await this[_0x5b4fdf(0x165)][_0x5b4fdf(0x177)](_0x33b0a7);let _0x47000d;_0x4cad50&&(_0x47000d=await this[_0x5b4fdf(0x165)][_0x5b4fdf(0x168)](_0x4cad50));await this[_0x5b4fdf(0x116)][_0x5b4fdf(0xfa)](_0x579f22['id'],_0x47000d===null||_0x47000d===void 0x0?void 0x0:_0x47000d['id']);return;}async['login'](_0x2074ae,_0x4bbf9a){const _0x181c02=_0x1731dd,_0x177148=await this[_0x181c02(0x165)]['verifyUserCredentials'](_0x2074ae),{username:_0x16ba46,id:_0x4f150a,email:_0x16d106,role:_0x235b60,openId:_0x4188df,client:_0x15dd84}=_0x177148,_0x3e7d72=(0x0,utils_1[_0x181c02(0x16b)])(_0x4bbf9a);await this['userService'][_0x181c02(0x16a)](_0x4f150a,_0x3e7d72);const _0x82b831=await this['jwtService'][_0x181c02(0x15d)]({'username':_0x16ba46,'id':_0x4f150a,'email':_0x16d106,'role':_0x235b60,'openId':_0x4188df,'client':_0x15dd84});return await this['redisCacheService'][_0x181c02(0x139)](_0x4f150a,_0x82b831),_0x82b831;}async['loginByPhone'](_0x5b881d,_0x4d57b1){const _0x26d178=_0x1731dd,_0x216df6=await this[_0x26d178(0x165)][_0x26d178(0x152)](_0x5b881d),{username:_0x1ac349,id:_0x4e6f6e,email:_0x512f9c,role:_0x47cd79,openId:_0x4fb069,client:_0xd03cd5}=_0x216df6,_0x10fe09=(0x0,utils_1[_0x26d178(0x16b)])(_0x4d57b1);await this['userService'][_0x26d178(0x16a)](_0x4e6f6e,_0x10fe09);const {phone:_0x15af91}=_0x5b881d,_0x174ef0=await this['jwtService'][_0x26d178(0x15d)]({'username':_0x1ac349,'id':_0x4e6f6e,'email':_0x512f9c,'role':_0x47cd79,'openId':_0x4fb069,'client':_0xd03cd5,'phone':_0x15af91});return await this[_0x26d178(0x10c)][_0x26d178(0x139)](_0x4e6f6e,_0x174ef0),_0x174ef0;}async[_0x1731dd(0xf7)](_0xe85ee2,_0x3277a7){const _0x5171a0=_0x1731dd,{status:_0x45bf6f}=_0xe85ee2;if(_0x45bf6f!==user_constant_1['UserStatusEnum'][_0x5171a0(0x155)])throw new common_1[(_0x5171a0(0x113))](user_constant_1['UserStatusErrMsg'][_0x45bf6f],common_1[_0x5171a0(0x171)][_0x5171a0(0x170)]);const {username:_0x402267,id:_0x3b079c,email:_0x9d694b,role:_0x2a4011,openId:_0x191160,client:_0x5ba456}=_0xe85ee2,_0x10bcdc=(0x0,utils_1[_0x5171a0(0x16b)])(_0x3277a7);await this['userService']['savaLoginIp'](_0x3b079c,_0x10bcdc);const _0x355e64=await this[_0x5171a0(0xff)][_0x5171a0(0x15d)]({'username':_0x402267,'id':_0x3b079c,'email':_0x9d694b,'role':_0x2a4011,'openId':_0x191160,'client':_0x5ba456});return await this[_0x5171a0(0x10c)][_0x5171a0(0x139)](_0x3b079c,_0x355e64),_0x355e64;}async[_0x1731dd(0x129)](_0x471692){const _0x285a16=_0x1731dd,{id:_0x31c933}=_0x471692[_0x285a16(0x12c)];return await this['userService'][_0x285a16(0x128)](_0x31c933);}async[_0x1731dd(0x140)](_0x2c6a8b,_0x86e093){const _0x21126c=_0x1731dd,_0x485574=await this['configEntity'][_0x21126c(0x111)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x21126c(0x146),_0x21126c(0x144),_0x21126c(0x132),_0x21126c(0x163),_0x21126c(0x104)])}}),_0x4447a2=_0x485574[_0x21126c(0x153)]((_0x4bc86f,_0x1220f7)=>{const _0x1918c3=_0x21126c;return _0x4bc86f[_0x1220f7[_0x1918c3(0x11c)]]=_0x1220f7['configVal'],_0x4bc86f;},{});try{const _0x4e194b=await this[_0x21126c(0x134)][_0x21126c(0x11f)](_0x2c6a8b,verification_constant_1[_0x21126c(0x143)][_0x21126c(0x17c)]),{type:_0x2f9a4c,userId:_0x2019ee}=_0x4e194b;if(_0x2f9a4c!==verification_constant_1[_0x21126c(0x143)]['Registration'])throw new common_1['HttpException'](_0x21126c(0x158),common_1[_0x21126c(0x171)][_0x21126c(0x170)]);const _0x5b9c2a=await this[_0x21126c(0x165)]['getUserStatus'](_0x2019ee);if(_0x5b9c2a===user_constant_1['UserStatusEnum'][_0x21126c(0x155)])throw new common_1[(_0x21126c(0x113))]('账户已被激活过',common_1['HttpStatus'][_0x21126c(0x170)]);await this[_0x21126c(0x165)][_0x21126c(0x102)](_0x4e194b[_0x21126c(0x14f)],user_constant_1[_0x21126c(0xfd)][_0x21126c(0x155)]);const _0x26c812=await this['userService']['queryUserInfoById'](_0x4e194b['userId']),{username:_0x3122d3,email:_0x49c047,id:_0x380205,invitedBy:_0x243d78}=_0x26c812;let _0x456403;_0x243d78&&(_0x456403=await this[_0x21126c(0x165)][_0x21126c(0x168)](_0x243d78)),await this[_0x21126c(0x116)][_0x21126c(0xfa)](_0x380205,_0x456403===null||_0x456403===void 0x0?void 0x0:_0x456403['id']),_0x86e093[_0x21126c(0x136)](_0x21126c(0x141)+_0x380205[_0x21126c(0x16c)]()['padStart'](0x4,'0')+_0x21126c(0x173)+_0x3122d3+_0x21126c(0x166)+_0x49c047+_0x21126c(0x125)+_0x4447a2[_0x21126c(0x146)]+'&registerSuccessEmailTeamName='+_0x4447a2[_0x21126c(0x144)]+_0x21126c(0x115)+_0x4447a2[_0x21126c(0x132)]);}catch(_0x5f115c){console[_0x21126c(0x130)](_0x21126c(0x112),_0x5f115c);const _0xc8d3fe=_0x5f115c[_0x21126c(0x114)];_0x86e093[_0x21126c(0x136)](_0x21126c(0x12e)+_0xc8d3fe+_0x21126c(0x110)+_0x4447a2[_0x21126c(0x163)]+'&registerFailEmailTeamName='+_0x4447a2[_0x21126c(0x104)]);}}async[_0x1731dd(0x13e)](_0x399b23,_0x170022){const _0x599c66=_0x1731dd,{id:_0x47c9cc,client:_0x591075,role:_0xb55996}=_0x399b23['user'];if(_0x591075&&Number(_0x591075)>0x0)throw new common_1[(_0x599c66(0x113))](_0x599c66(0x150),common_1['HttpStatus'][_0x599c66(0x170)]);if(_0xb55996===_0x599c66(0x160))throw new common_1['HttpException'](_0x599c66(0x13c),common_1[_0x599c66(0x171)][_0x599c66(0x170)]);const _0x2a88fd=await this[_0x599c66(0x165)][_0x599c66(0x15f)](_0x47c9cc,_0x170022[_0x599c66(0x103)]);if(!_0x2a88fd)throw new common_1['HttpException'](_0x599c66(0x145),common_1[_0x599c66(0x171)]['BAD_REQUEST']);return this[_0x599c66(0x165)][_0x599c66(0x122)](_0x47c9cc,_0x170022['password']),_0x599c66(0x14a);}async[_0x1731dd(0x14c)](_0x50a200,_0x552aa2){const _0x72d291=_0x1731dd,{id:_0x194c7b,client:_0x14279c}=_0x50a200[_0x72d291(0x12c)];if(!_0x14279c)throw new common_1['HttpException'](_0x72d291(0x164),common_1[_0x72d291(0x171)][_0x72d291(0x170)]);return this[_0x72d291(0x165)]['updateUserPassword'](_0x194c7b,_0x552aa2['password']),_0x72d291(0x14a);}[_0x1731dd(0x12f)](){const _0x45cd26=_0x1731dd;let _0x1db5b5;const _0x3edbee=os[_0x45cd26(0x16d)]();Object[_0x45cd26(0x105)](_0x3edbee)[_0x45cd26(0x138)](_0x331887=>{const _0x59eed4=_0x45cd26,_0x55862b=_0x3edbee[_0x331887];for(let _0x5347dc=0x0;_0x5347dc<_0x55862b[_0x59eed4(0x162)];_0x5347dc++){const _0x431f23=_0x55862b[_0x5347dc];if(_0x431f23[_0x59eed4(0x15c)]===_0x59eed4(0xf8)&&_0x431f23['address']!==_0x59eed4(0x137)&&!_0x431f23[_0x59eed4(0x13f)]){_0x1db5b5=_0x431f23[_0x59eed4(0x16e)];break;}}}),this[_0x45cd26(0x15b)]=_0x1db5b5;}async[_0x1731dd(0x109)](_0x3582de){const _0x4a8cd8=_0x1731dd,_0x51deac=await this[_0x4a8cd8(0x15e)]['getNamespace'](),{color:color='#fff'}=_0x3582de,_0x5c7deb=svgCaptcha['createMathExpr']({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x8896ee=_0x5c7deb[_0x4a8cd8(0x147)],_0x14e79a=(0x0,utils_1['createRandomUid'])(),_0x4431df=_0x51deac+_0x4a8cd8(0x131)+_0x14e79a;return await this[_0x4a8cd8(0x10c)][_0x4a8cd8(0x14e)]({'key':_0x4431df,'val':_0x5c7deb[_0x4a8cd8(0x147)]},0x5*0x3c),{'svgCode':_0x5c7deb[_0x4a8cd8(0x100)],'code':_0x14e79a};}async[_0x1731dd(0xf9)](_0x5a7fea){const _0xbf4573=_0x1731dd;await this[_0xbf4573(0x134)]['verifyCaptcha'](_0x5a7fea);const {phone:_0x47ac9d}=_0x5a7fea,_0x44aba5=await this[_0xbf4573(0x15e)]['getNamespace'](),_0x194cab=_0x44aba5+_0xbf4573(0x151)+_0x47ac9d,_0x6017f=await this[_0xbf4573(0x10c)][_0xbf4573(0x12a)](_0x194cab);if(_0x6017f&&_0x6017f>0x0)throw new common_1[(_0xbf4573(0x113))](_0x6017f+'秒内不得重复发送短信！',common_1[_0xbf4573(0x171)][_0xbf4573(0x170)]);const _0x3b3014=(0x0,utils_1[_0xbf4573(0x13d)])(),_0x401d78={'phone':_0x47ac9d,'code':_0x3b3014};return await this[_0xbf4573(0x134)]['sendPhoneCodeWithQcloud'](_0x401d78),await this[_0xbf4573(0x10c)][_0xbf4573(0x14e)]({'key':_0x194cab,'val':_0x3b3014},0x1*0x3c),_0xbf4573(0x14b);}[_0x1731dd(0xfe)](_0x34e136){const _0xf3e98a=_0x1731dd,_0x48ad77=this['jwtService'][_0xf3e98a(0x15d)]({'username':'游客'+_0x34e136,'id':_0x34e136,'email':_0x34e136+_0xf3e98a(0x156),'role':_0xf3e98a(0x16f),'openId':null,'client':null});return _0x48ad77;}};AuthService=__decorate([(0x0,common_1[_0x1731dd(0x124)])(),__param(0x0,(0x0,typeorm_2[_0x1731dd(0x14d)])(config_entity_1[_0x1731dd(0x13b)])),__metadata(_0x1731dd(0x10d),[typeorm_1[_0x1731dd(0x17d)],user_service_1[_0x1731dd(0x161)],jwt_1[_0x1731dd(0x127)],mailer_service_1[_0x1731dd(0x10a)],verification_service_1[_0x1731dd(0x11b)],userBalance_service_1[_0x1731dd(0x17b)],redisCache_service_1['RedisCacheService'],globalConfig_service_1[_0x1731dd(0xfb)]])],AuthService),exports['AuthService']=AuthService;