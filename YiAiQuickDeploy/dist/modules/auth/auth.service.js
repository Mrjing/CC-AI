'use strict';const _0x4042e5=_0x1c41;(function(_0x1d71db,_0x587dc5){const _0x378e38=_0x1c41,_0x5bd934=_0x1d71db();while(!![]){try{const _0x1e0dd8=parseInt(_0x378e38(0x260))/0x1+-parseInt(_0x378e38(0x1f1))/0x2+-parseInt(_0x378e38(0x20e))/0x3*(-parseInt(_0x378e38(0x247))/0x4)+parseInt(_0x378e38(0x246))/0x5+-parseInt(_0x378e38(0x23a))/0x6*(-parseInt(_0x378e38(0x225))/0x7)+-parseInt(_0x378e38(0x25a))/0x8*(-parseInt(_0x378e38(0x275))/0x9)+-parseInt(_0x378e38(0x274))/0xa*(parseInt(_0x378e38(0x212))/0xb);if(_0x1e0dd8===_0x587dc5)break;else _0x5bd934['push'](_0x5bd934['shift']());}catch(_0x59b544){_0x5bd934['push'](_0x5bd934['shift']());}}}(_0x26ce,0x566f5));function _0x26ce(){const _0x31b49b=['getClientIp','HttpException','registerFailEmailTitle','402825RfRGfj',':CAPTCHA:','createUserAndVerifycation','userId','configKey','../redisCache/redisCache.service','createRandomCode','sendPhoneCode','addBalanceToNewUser','UserStatusEnum','user','ConfigEntity','../user/user.service','data','find','&registerSuccessEmailTitle=','getInfo','configEntity','../../common/constants/verification.constant','oldPassword','63080EorTLr','2925117EWqdpl','@nestjs/typeorm','configVal','userDefautlAvatar','error:\x20','function','10028tstyMl','loginByOpenId','MailerService','VerificationService','sign','__metadata','../../common/constants/user.constant','getUserInfo','账户已被激活过','loginByPhone','UserBalanceService','验证码填写错误、请重新输入！','@nine.com','avatar','verifyCaptcha','verifyUserCredentials','mailerService','object','Injectable','forEach','updateUserPassword','registerSuccessEmaileAppend','#fff','Registration','family','getNamespace','&email=','GlobalConfigService','../../common/utils','573gDYRzT','savaLoginIp','&username=','keys','3982JZCksn','ACTIVE','getIp','updatePassword','秒内不得重复发送短信！','userService','BAD_REQUEST','../verification/verification.service','registerSuccessEmailTeamName','updatePassByOther','无权此操作、请联系管理员！','&registerFailEmailTitle=','set','onModuleInit','redisCacheService','ttl','defineProperty','jwtService','length','140ncuuuY','registerFailEmailTeamName','userBalanceService','design:paramtypes',':PHONECODE:','旧密码错误、请检查提交','queryUserInfoById','saveToken','HttpStatus','address','验证码发送成功、请填写验证码完成注册！','password','hashSync','client','text','internal','getConfigs','reduce','verifyUserPassword','createRandomUid','__esModule','91110FrhSSR','log','verifyCode','createMathExpr','visitor','admin','updateUserStatus','get','&registerSuccessEmaileAppend=','127.0.0.1','sendPhoneCodeWithQcloud','register','3382575wmBwYF','12764stSERx','@nestjs/jwt','InjectRepository','UserService','../globalConfig/config.entity','verifyUserRegisterByPhone','typeorm','getOwnPropertyDescriptor','验证码已过期、请重新发送！','JwtService','../globalConfig/globalConfig.service','redirect','verificationService','qureyUserInfoByInviteCode','ipAddress','globalConfigService','IPv4','AuthService','&registerFailEmailTeamName=','16BlKSpJ','toString','metadata'];_0x26ce=function(){return _0x31b49b;};return _0x26ce();}var __decorate=this&&this['__decorate']||function(_0x30a788,_0x2585c8,_0x3e1016,_0x5106ec){const _0x1a5d35=_0x1c41;var _0x6a15a1=arguments['length'],_0x3aadd6=_0x6a15a1<0x3?_0x2585c8:_0x5106ec===null?_0x5106ec=Object[_0x1a5d35(0x24e)](_0x2585c8,_0x3e1016):_0x5106ec,_0x37ba5e;if(typeof Reflect===_0x1a5d35(0x202)&&typeof Reflect['decorate']===_0x1a5d35(0x1f0))_0x3aadd6=Reflect['decorate'](_0x30a788,_0x2585c8,_0x3e1016,_0x5106ec);else{for(var _0x2c31ad=_0x30a788[_0x1a5d35(0x224)]-0x1;_0x2c31ad>=0x0;_0x2c31ad--)if(_0x37ba5e=_0x30a788[_0x2c31ad])_0x3aadd6=(_0x6a15a1<0x3?_0x37ba5e(_0x3aadd6):_0x6a15a1>0x3?_0x37ba5e(_0x2585c8,_0x3e1016,_0x3aadd6):_0x37ba5e(_0x2585c8,_0x3e1016))||_0x3aadd6;}return _0x6a15a1>0x3&&_0x3aadd6&&Object[_0x1a5d35(0x222)](_0x2585c8,_0x3e1016,_0x3aadd6),_0x3aadd6;},__metadata=this&&this[_0x4042e5(0x1f6)]||function(_0x3df061,_0x409a70){const _0x1e4899=_0x4042e5;if(typeof Reflect==='object'&&typeof Reflect[_0x1e4899(0x25c)]===_0x1e4899(0x1f0))return Reflect['metadata'](_0x3df061,_0x409a70);},__param=this&&this['__param']||function(_0x5d3400,_0x579246){return function(_0x1dc34e,_0x5964c4){_0x579246(_0x1dc34e,_0x5964c4,_0x5d3400);};};function _0x1c41(_0x23e546,_0x3e3034){const _0x26ce51=_0x26ce();return _0x1c41=function(_0x1c4127,_0x2579e7){_0x1c4127=_0x1c4127-0x1ed;let _0x1b9751=_0x26ce51[_0x1c4127];return _0x1b9751;},_0x1c41(_0x23e546,_0x3e3034);}Object[_0x4042e5(0x222)](exports,_0x4042e5(0x239),{'value':!![]}),exports[_0x4042e5(0x258)]=void 0x0;const globalConfig_service_1=require(_0x4042e5(0x251)),verification_constant_1=require(_0x4042e5(0x272)),verification_service_1=require(_0x4042e5(0x219)),common_1=require('@nestjs/common'),jwt_1=require(_0x4042e5(0x248)),user_service_1=require(_0x4042e5(0x26c)),mailer_service_1=require('../mailer/mailer.service'),user_constant_1=require(_0x4042e5(0x1f7)),userBalance_service_1=require('../userBalance/userBalance.service'),config_entity_1=require(_0x4042e5(0x24b)),typeorm_1=require(_0x4042e5(0x24d)),typeorm_2=require(_0x4042e5(0x276)),utils_1=require(_0x4042e5(0x20d)),os=require('os'),redisCache_service_1=require(_0x4042e5(0x265)),svgCaptcha=require('svg-captcha'),bcrypt=require('bcryptjs');let AuthService=class AuthService{constructor(_0x1dfbe1,_0x353bc1,_0x7cd8e1,_0x27aa53,_0x1bd796,_0x1af4f3,_0x376cb1,_0x307f92){const _0x128456=_0x4042e5;this['configEntity']=_0x1dfbe1,this[_0x128456(0x217)]=_0x353bc1,this['jwtService']=_0x7cd8e1,this[_0x128456(0x201)]=_0x27aa53,this[_0x128456(0x253)]=_0x1bd796,this[_0x128456(0x227)]=_0x1af4f3,this[_0x128456(0x220)]=_0x376cb1,this[_0x128456(0x256)]=_0x307f92;}async[_0x4042e5(0x21f)](){const _0x56e9af=_0x4042e5;this[_0x56e9af(0x214)]();}async[_0x4042e5(0x245)](_0x133566,_0x4ffd05){const _0xad12d1=_0x4042e5;await this['verificationService']['verifyCaptcha'](_0x133566);const _0x3e2234=await this['userService'][_0xad12d1(0x262)](_0x133566,_0x4ffd05),{username:_0x46b01b,email:_0xfecb35,client:_0x3c73f5,id:_0x13a802}=_0x3e2234,_0x26d72c={'username':_0x46b01b,'email':_0xfecb35,'id':_0x13a802};return _0x3c73f5&&(_0x26d72c[_0xad12d1(0x232)]=_0x3c73f5),_0x26d72c;}async['registerByPhone'](_0x27f103,_0x187f5e){const _0x570271=_0x4042e5,{username:_0x4ff12f,password:_0x39f616,phone:_0x2a1e03,phoneCode:_0x5207e6,invitedBy:_0x141f6e}=_0x27f103;await this[_0x570271(0x217)][_0x570271(0x24c)](_0x27f103);const _0x30bb7f=await this[_0x570271(0x256)]['getNamespace'](),_0x860b90=_0x30bb7f+_0x570271(0x229)+_0x2a1e03,_0x33df4e=await this['redisCacheService'][_0x570271(0x241)]({'key':_0x860b90});if(!_0x33df4e)throw new common_1[(_0x570271(0x25e))](_0x570271(0x24f),common_1['HttpStatus'][_0x570271(0x218)]);if(_0x5207e6!==_0x33df4e)throw new common_1[(_0x570271(0x25e))](_0x570271(0x1fc),common_1[_0x570271(0x22d)][_0x570271(0x218)]);const _0x52a0b1=(0x0,utils_1[_0x570271(0x238)])()+_0x570271(0x1fd),_0xf20b2c={'username':_0x4ff12f,'password':_0x39f616,'phone':_0x2a1e03,'invitedBy':_0x141f6e,'email':_0x52a0b1,'status':user_constant_1['UserStatusEnum']['ACTIVE']},_0x56c924=await this[_0x570271(0x256)][_0x570271(0x235)]([_0x570271(0x1ee)]);_0xf20b2c[_0x570271(0x1fe)]=_0x56c924;const _0x55378d=bcrypt[_0x570271(0x231)](_0x39f616,0xa);_0xf20b2c['password']=_0x55378d;const _0x33cad9=await this[_0x570271(0x217)]['createUser'](_0xf20b2c);let _0xf87d6c;_0x141f6e&&(_0xf87d6c=await this[_0x570271(0x217)][_0x570271(0x254)](_0x141f6e));await this[_0x570271(0x227)][_0x570271(0x268)](_0x33cad9['id'],_0xf87d6c===null||_0xf87d6c===void 0x0?void 0x0:_0xf87d6c['id']);return;}async['login'](_0x1892eb,_0xdf6dc3){const _0x4fb062=_0x4042e5,_0x44887f=await this[_0x4fb062(0x217)][_0x4fb062(0x200)](_0x1892eb),{username:_0x57915b,id:_0x3a9046,email:_0x455fa3,role:_0x57a702,openId:_0x3c658c,client:_0x3ac741}=_0x44887f,_0x2ea870=(0x0,utils_1[_0x4fb062(0x25d)])(_0xdf6dc3);await this[_0x4fb062(0x217)][_0x4fb062(0x20f)](_0x3a9046,_0x2ea870);const _0x46a403=await this[_0x4fb062(0x223)][_0x4fb062(0x1f5)]({'username':_0x57915b,'id':_0x3a9046,'email':_0x455fa3,'role':_0x57a702,'openId':_0x3c658c,'client':_0x3ac741});return await this['redisCacheService'][_0x4fb062(0x22c)](_0x3a9046,_0x46a403),_0x46a403;}async[_0x4042e5(0x1fa)](_0x31d20e,_0x5b10e8){const _0x339603=_0x4042e5,_0x2650ea=await this[_0x339603(0x217)]['verifyUserCredentials'](_0x31d20e),{username:_0x19cb1d,id:_0x2fa6d2,email:_0x1db246,role:_0x32d55f,openId:_0x5265b3,client:_0x107058}=_0x2650ea,_0x19b85e=(0x0,utils_1[_0x339603(0x25d)])(_0x5b10e8);await this[_0x339603(0x217)][_0x339603(0x20f)](_0x2fa6d2,_0x19b85e);const {phone:_0x526cea}=_0x31d20e,_0x4dac9c=await this[_0x339603(0x223)]['sign']({'username':_0x19cb1d,'id':_0x2fa6d2,'email':_0x1db246,'role':_0x32d55f,'openId':_0x5265b3,'client':_0x107058,'phone':_0x526cea});return await this[_0x339603(0x220)]['saveToken'](_0x2fa6d2,_0x4dac9c),_0x4dac9c;}async[_0x4042e5(0x1f2)](_0x18408c,_0x56fb24){const _0x555f1e=_0x4042e5,{status:_0x534df5}=_0x18408c;if(_0x534df5!==user_constant_1[_0x555f1e(0x269)][_0x555f1e(0x213)])throw new common_1[(_0x555f1e(0x25e))](user_constant_1['UserStatusErrMsg'][_0x534df5],common_1[_0x555f1e(0x22d)][_0x555f1e(0x218)]);const {username:_0x40e239,id:_0x1088ec,email:_0x24b471,role:_0x26ac94,openId:_0x19790d,client:_0x41f158}=_0x18408c,_0x2375ef=(0x0,utils_1[_0x555f1e(0x25d)])(_0x56fb24);await this[_0x555f1e(0x217)][_0x555f1e(0x20f)](_0x1088ec,_0x2375ef);const _0x49401f=await this['jwtService']['sign']({'username':_0x40e239,'id':_0x1088ec,'email':_0x24b471,'role':_0x26ac94,'openId':_0x19790d,'client':_0x41f158});return await this[_0x555f1e(0x220)][_0x555f1e(0x22c)](_0x1088ec,_0x49401f),_0x49401f;}async[_0x4042e5(0x270)](_0x3d9b16){const _0x51d9e6=_0x4042e5,{id:_0x1dc3c3}=_0x3d9b16[_0x51d9e6(0x26a)];return await this['userService'][_0x51d9e6(0x1f8)](_0x1dc3c3);}async['activateAccount'](_0x533d04,_0x255481){const _0xbb99fa=_0x4042e5,_0x278ee2=await this[_0xbb99fa(0x271)][_0xbb99fa(0x26e)]({'where':{'configKey':(0x0,typeorm_1['In'])(['registerSuccessEmailTitle',_0xbb99fa(0x21a),_0xbb99fa(0x206),_0xbb99fa(0x25f),_0xbb99fa(0x226)])}}),_0x5753b0=_0x278ee2[_0xbb99fa(0x236)]((_0x146c2f,_0x2f7a75)=>{const _0x4beaba=_0xbb99fa;return _0x146c2f[_0x2f7a75[_0x4beaba(0x264)]]=_0x2f7a75[_0x4beaba(0x1ed)],_0x146c2f;},{});try{const _0x1d334e=await this[_0xbb99fa(0x253)][_0xbb99fa(0x23c)](_0x533d04,verification_constant_1['VerificationEnum'][_0xbb99fa(0x208)]),{type:_0x2a82ee,userId:_0x181d35}=_0x1d334e;if(_0x2a82ee!==verification_constant_1['VerificationEnum'][_0xbb99fa(0x208)])throw new common_1[(_0xbb99fa(0x25e))]('验证码类型错误',common_1[_0xbb99fa(0x22d)][_0xbb99fa(0x218)]);const _0x550eb0=await this[_0xbb99fa(0x217)]['getUserStatus'](_0x181d35);if(_0x550eb0===user_constant_1['UserStatusEnum'][_0xbb99fa(0x213)])throw new common_1[(_0xbb99fa(0x25e))](_0xbb99fa(0x1f9),common_1[_0xbb99fa(0x22d)]['BAD_REQUEST']);await this[_0xbb99fa(0x217)][_0xbb99fa(0x240)](_0x1d334e[_0xbb99fa(0x263)],user_constant_1['UserStatusEnum'][_0xbb99fa(0x213)]);const _0x1ee0ea=await this['userService'][_0xbb99fa(0x22b)](_0x1d334e[_0xbb99fa(0x263)]),{username:_0x22552d,email:_0x387993,id:_0x4cdb68,invitedBy:_0x40f969}=_0x1ee0ea;let _0x287b03;_0x40f969&&(_0x287b03=await this['userService'][_0xbb99fa(0x254)](_0x40f969)),await this['userBalanceService'][_0xbb99fa(0x268)](_0x4cdb68,_0x287b03===null||_0x287b03===void 0x0?void 0x0:_0x287b03['id']),_0x255481['redirect']('/api/auth/registerSuccess?id='+_0x4cdb68[_0xbb99fa(0x25b)]()['padStart'](0x4,'0')+_0xbb99fa(0x210)+_0x22552d+_0xbb99fa(0x20b)+_0x387993+_0xbb99fa(0x26f)+_0x5753b0['registerSuccessEmailTitle']+'&registerSuccessEmailTeamName='+_0x5753b0['registerSuccessEmailTeamName']+_0xbb99fa(0x242)+_0x5753b0[_0xbb99fa(0x206)]);}catch(_0x4797dd){console[_0xbb99fa(0x23b)](_0xbb99fa(0x1ef),_0x4797dd);const _0x5607da=_0x4797dd['response'];_0x255481[_0xbb99fa(0x252)]('/api/auth/registerError?message='+_0x5607da+_0xbb99fa(0x21d)+_0x5753b0['registerFailEmailTitle']+_0xbb99fa(0x259)+_0x5753b0['registerFailEmailTeamName']);}}async[_0x4042e5(0x215)](_0x1f105e,_0x1d63d8){const _0x49ad1a=_0x4042e5,{id:_0x3392a7,client:_0x3914d3,role:_0x27d20e}=_0x1f105e[_0x49ad1a(0x26a)];if(_0x3914d3&&Number(_0x3914d3)>0x0)throw new common_1[(_0x49ad1a(0x25e))](_0x49ad1a(0x21c),common_1[_0x49ad1a(0x22d)]['BAD_REQUEST']);if(_0x27d20e===_0x49ad1a(0x23f))throw new common_1[(_0x49ad1a(0x25e))]('非法操作、请联系管理员！',common_1[_0x49ad1a(0x22d)][_0x49ad1a(0x218)]);const _0x54cfd5=await this[_0x49ad1a(0x217)][_0x49ad1a(0x237)](_0x3392a7,_0x1d63d8[_0x49ad1a(0x273)]);if(!_0x54cfd5)throw new common_1['HttpException'](_0x49ad1a(0x22a),common_1[_0x49ad1a(0x22d)][_0x49ad1a(0x218)]);return this[_0x49ad1a(0x217)][_0x49ad1a(0x205)](_0x3392a7,_0x1d63d8[_0x49ad1a(0x230)]),'密码修改成功';}async[_0x4042e5(0x21b)](_0x4fc21d,_0x3019cf){const _0x2f3749=_0x4042e5,{id:_0x1cc558,client:_0xef58d8}=_0x4fc21d[_0x2f3749(0x26a)];if(!_0xef58d8)throw new common_1[(_0x2f3749(0x25e))]('无权此操作！',common_1[_0x2f3749(0x22d)][_0x2f3749(0x218)]);return this[_0x2f3749(0x217)]['updateUserPassword'](_0x1cc558,_0x3019cf['password']),'密码修改成功';}[_0x4042e5(0x214)](){const _0x2f4798=_0x4042e5;let _0x1928ca;const _0xc2df0f=os['networkInterfaces']();Object[_0x2f4798(0x211)](_0xc2df0f)[_0x2f4798(0x204)](_0x169d27=>{const _0x5c6863=_0x2f4798,_0xca4aba=_0xc2df0f[_0x169d27];for(let _0xe4fe78=0x0;_0xe4fe78<_0xca4aba['length'];_0xe4fe78++){const _0x4273ba=_0xca4aba[_0xe4fe78];if(_0x4273ba[_0x5c6863(0x209)]===_0x5c6863(0x257)&&_0x4273ba['address']!==_0x5c6863(0x243)&&!_0x4273ba[_0x5c6863(0x234)]){_0x1928ca=_0x4273ba[_0x5c6863(0x22e)];break;}}}),this[_0x2f4798(0x255)]=_0x1928ca;}async['captcha'](_0x2c0700){const _0x44e548=_0x4042e5,_0x2a1111=await this[_0x44e548(0x256)][_0x44e548(0x20a)](),{color:color=_0x44e548(0x207)}=_0x2c0700,_0x1a7ade=svgCaptcha[_0x44e548(0x23d)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x174405=_0x1a7ade['text'],_0xe625f=(0x0,utils_1[_0x44e548(0x238)])(),_0x45b7f9=_0x2a1111+_0x44e548(0x261)+_0xe625f;return await this['redisCacheService'][_0x44e548(0x21e)]({'key':_0x45b7f9,'val':_0x1a7ade[_0x44e548(0x233)]},0x5*0x3c),{'svgCode':_0x1a7ade[_0x44e548(0x26d)],'code':_0xe625f};}async[_0x4042e5(0x267)](_0x2a4e2e){const _0x25f6e3=_0x4042e5;await this[_0x25f6e3(0x253)][_0x25f6e3(0x1ff)](_0x2a4e2e);const {phone:_0x416389}=_0x2a4e2e,_0x49bf02=await this[_0x25f6e3(0x256)]['getNamespace'](),_0x4c7b7f=_0x49bf02+':PHONECODE:'+_0x416389,_0x2c4caa=await this['redisCacheService'][_0x25f6e3(0x221)](_0x4c7b7f);if(_0x2c4caa&&_0x2c4caa>0x0)throw new common_1[(_0x25f6e3(0x25e))](_0x2c4caa+_0x25f6e3(0x216),common_1[_0x25f6e3(0x22d)][_0x25f6e3(0x218)]);const _0x3732a8=(0x0,utils_1[_0x25f6e3(0x266)])(),_0x29ad6d={'phone':_0x416389,'code':_0x3732a8};return await this[_0x25f6e3(0x253)][_0x25f6e3(0x244)](_0x29ad6d),await this[_0x25f6e3(0x220)][_0x25f6e3(0x21e)]({'key':_0x4c7b7f,'val':_0x3732a8},0x1*0x3c),_0x25f6e3(0x22f);}['createTokenFromFingerprint'](_0x3d4006){const _0x3bcc73=_0x4042e5,_0x2f47d2=this[_0x3bcc73(0x223)]['sign']({'username':'游客'+_0x3d4006,'id':_0x3d4006,'email':_0x3d4006+'@nine.com','role':_0x3bcc73(0x23e),'openId':null,'client':null});return _0x2f47d2;}};AuthService=__decorate([(0x0,common_1[_0x4042e5(0x203)])(),__param(0x0,(0x0,typeorm_2[_0x4042e5(0x249)])(config_entity_1[_0x4042e5(0x26b)])),__metadata(_0x4042e5(0x228),[typeorm_1['Repository'],user_service_1[_0x4042e5(0x24a)],jwt_1[_0x4042e5(0x250)],mailer_service_1[_0x4042e5(0x1f3)],verification_service_1[_0x4042e5(0x1f4)],userBalance_service_1[_0x4042e5(0x1fb)],redisCache_service_1['RedisCacheService'],globalConfig_service_1[_0x4042e5(0x20c)]])],AuthService),exports['AuthService']=AuthService;