'use strict';function _0x3bc6(){const _0x57cfd8=['bcryptjs','密码修改成功','../verification/verification.service','registerFailEmailTitle','__metadata','verificationService','updateUserPassword','22jmHLQT','&registerSuccessEmailTeamName=','networkInterfaces','&username=','&registerSuccessEmaileAppend=','visitor','3090921MwWrCd','registerSuccessEmailTeamName','function','__decorate','defineProperty','savaLoginIp','GlobalConfigService','/api/auth/registerSuccess?id=','/api/auth/registerError?message=','registerSuccessEmailTitle','createUserAndVerifycation','address','object','error:\x20','get','addBalanceToNewUser','userDefautlAvatar','verifyUserCredentials','UserService','sign','getIp','family','globalConfigService','1aJsdFr','895881wAthEA','internal','userService','验证码填写错误、请重新输入！','sendPhoneCode','decorate','ipAddress','find','client','ttl','qureyUserInfoByInviteCode','../../common/utils','验证码已过期、请重新发送！','UserBalanceService','design:paramtypes','verifyCode','@nestjs/typeorm','updateUserStatus','getInfo','admin','jwtService','1455130uUWrou','../userBalance/userBalance.service','response','captcha','@nestjs/common','验证码类型错误','UserStatusEnum','set','reduce','../../common/constants/verification.constant','avatar','../../common/constants/user.constant','createRandomCode','4SIhbcJ','Repository','queryUserInfoById','UserStatusErrMsg','userId','mailerService','registerFailEmailTeamName','VerificationService','redirect','2202336EINafL','register','VerificationEnum','#fff','redisCacheService','../globalConfig/globalConfig.service','../redisCache/redisCache.service','11394TmCmgK','createTokenFromFingerprint','ACTIVE','getUserInfo','InjectRepository','AuthService','login','2890aNQRzN','log','registerSuccessEmaileAppend','userBalanceService','verifyUserRegisterByPhone','svg-captcha','configEntity','length','MailerService','77298qemwNd','getNamespace','configVal','activateAccount',':PHONECODE:','metadata','../globalConfig/config.entity','BAD_REQUEST','createMathExpr','ConfigEntity','无权此操作、请联系管理员！','password','8fBeETk','createRandomUid','getOwnPropertyDescriptor','&registerSuccessEmailTitle=','__param','text','&registerFailEmailTitle=','Registration','Injectable','getConfigs','sendPhoneCodeWithQcloud','saveToken','verifyUserPassword','HttpException','typeorm','@nine.com','getClientIp','68654ZcAApa','data','../mailer/mailer.service','padStart','__esModule','IPv4','onModuleInit','1668DYnzaW','秒内不得重复发送短信！',':CAPTCHA:','toString','forEach','user','HttpStatus','updatePassword','oldPassword'];_0x3bc6=function(){return _0x57cfd8;};return _0x3bc6();}function _0x663a(_0x30c550,_0x2da06e){const _0x3bc6be=_0x3bc6();return _0x663a=function(_0x663a9d,_0x3217d4){_0x663a9d=_0x663a9d-0x68;let _0x20659c=_0x3bc6be[_0x663a9d];return _0x20659c;},_0x663a(_0x30c550,_0x2da06e);}const _0x104373=_0x663a;(function(_0x2457a2,_0x2205bd){const _0x4ef14d=_0x663a,_0x418f25=_0x2457a2();while(!![]){try{const _0x505126=parseInt(_0x4ef14d(0xd2))/0x1*(-parseInt(_0x4ef14d(0x9e))/0x2)+-parseInt(_0x4ef14d(0xbb))/0x3*(-parseInt(_0x4ef14d(0xf5))/0x4)+parseInt(_0x4ef14d(0x78))/0x5*(-parseInt(_0x4ef14d(0x71))/0x6)+parseInt(_0x4ef14d(0xd3))/0x7*(-parseInt(_0x4ef14d(0x8d))/0x8)+parseInt(_0x4ef14d(0x6a))/0x9+parseInt(_0x4ef14d(0xe8))/0xa*(-parseInt(_0x4ef14d(0xb5))/0xb)+parseInt(_0x4ef14d(0xa5))/0xc*(parseInt(_0x4ef14d(0x81))/0xd);if(_0x505126===_0x2205bd)break;else _0x418f25['push'](_0x418f25['shift']());}catch(_0x16d4e8){_0x418f25['push'](_0x418f25['shift']());}}}(_0x3bc6,0x86693));var __decorate=this&&this[_0x104373(0xbe)]||function(_0x113896,_0xf80658,_0x26ded0,_0x1ad28f){const _0x2ddce9=_0x104373;var _0x117c38=arguments[_0x2ddce9(0x7f)],_0x1e5e21=_0x117c38<0x3?_0xf80658:_0x1ad28f===null?_0x1ad28f=Object[_0x2ddce9(0x8f)](_0xf80658,_0x26ded0):_0x1ad28f,_0x519eb9;if(typeof Reflect===_0x2ddce9(0xc7)&&typeof Reflect[_0x2ddce9(0xd8)]==='function')_0x1e5e21=Reflect[_0x2ddce9(0xd8)](_0x113896,_0xf80658,_0x26ded0,_0x1ad28f);else{for(var _0x189fc0=_0x113896[_0x2ddce9(0x7f)]-0x1;_0x189fc0>=0x0;_0x189fc0--)if(_0x519eb9=_0x113896[_0x189fc0])_0x1e5e21=(_0x117c38<0x3?_0x519eb9(_0x1e5e21):_0x117c38>0x3?_0x519eb9(_0xf80658,_0x26ded0,_0x1e5e21):_0x519eb9(_0xf80658,_0x26ded0))||_0x1e5e21;}return _0x117c38>0x3&&_0x1e5e21&&Object[_0x2ddce9(0xbf)](_0xf80658,_0x26ded0,_0x1e5e21),_0x1e5e21;},__metadata=this&&this[_0x104373(0xb2)]||function(_0x1dcc31,_0x192fae){const _0x11fe2d=_0x104373;if(typeof Reflect===_0x11fe2d(0xc7)&&typeof Reflect[_0x11fe2d(0x86)]===_0x11fe2d(0xbd))return Reflect[_0x11fe2d(0x86)](_0x1dcc31,_0x192fae);},__param=this&&this[_0x104373(0x91)]||function(_0x6911b5,_0x5498d3){return function(_0x3d4e5e,_0x458b53){_0x5498d3(_0x3d4e5e,_0x458b53,_0x6911b5);};};Object['defineProperty'](exports,_0x104373(0xa2),{'value':!![]}),exports[_0x104373(0x76)]=void 0x0;const globalConfig_service_1=require(_0x104373(0x6f)),verification_constant_1=require(_0x104373(0xf1)),verification_service_1=require(_0x104373(0xb0)),common_1=require(_0x104373(0xec)),jwt_1=require('@nestjs/jwt'),user_service_1=require('../user/user.service'),mailer_service_1=require(_0x104373(0xa0)),user_constant_1=require(_0x104373(0xf3)),userBalance_service_1=require(_0x104373(0xe9)),config_entity_1=require(_0x104373(0x87)),typeorm_1=require(_0x104373(0x9b)),typeorm_2=require(_0x104373(0xe3)),utils_1=require(_0x104373(0xde)),os=require('os'),redisCache_service_1=require(_0x104373(0x70)),svgCaptcha=require(_0x104373(0x7d)),bcrypt=require(_0x104373(0xae));let AuthService=class AuthService{constructor(_0x1452d3,_0x528e83,_0x5bdb90,_0x5b73d6,_0x49e5a0,_0x2d2285,_0x1ca84c,_0x50717e){const _0x396698=_0x104373;this[_0x396698(0x7e)]=_0x1452d3,this[_0x396698(0xd5)]=_0x528e83,this[_0x396698(0xe7)]=_0x5bdb90,this[_0x396698(0xfa)]=_0x5b73d6,this[_0x396698(0xb3)]=_0x49e5a0,this[_0x396698(0x7b)]=_0x2d2285,this[_0x396698(0x6e)]=_0x1ca84c,this[_0x396698(0xd1)]=_0x50717e;}async[_0x104373(0xa4)](){const _0x223622=_0x104373;this[_0x223622(0xcf)]();}async[_0x104373(0x6b)](_0x330eb7,_0xe0380d){const _0xdc89bd=_0x104373;await this[_0xdc89bd(0xb3)]['verifyCaptcha'](_0x330eb7);const _0x148d7d=await this[_0xdc89bd(0xd5)][_0xdc89bd(0xc5)](_0x330eb7,_0xe0380d),{username:_0x3ff0a9,email:_0x51611c,client:_0x1be5fb,id:_0xf388ac}=_0x148d7d,_0x4868af={'username':_0x3ff0a9,'email':_0x51611c,'id':_0xf388ac};return _0x1be5fb&&(_0x4868af[_0xdc89bd(0xdb)]=_0x1be5fb),_0x4868af;}async['registerByPhone'](_0x3a8be9,_0x26b092){const _0x217c54=_0x104373,{username:_0x46f673,password:_0xfcb9f7,phone:_0x2c31d8,phoneCode:_0x129291,invitedBy:_0x571843}=_0x3a8be9;await this[_0x217c54(0xd5)][_0x217c54(0x7c)](_0x3a8be9);const _0x4dc3b8=await this['globalConfigService'][_0x217c54(0x82)](),_0x8263d9=_0x4dc3b8+_0x217c54(0x85)+_0x2c31d8,_0x396a57=await this[_0x217c54(0x6e)][_0x217c54(0xc9)]({'key':_0x8263d9});if(!_0x396a57)throw new common_1['HttpException'](_0x217c54(0xdf),common_1[_0x217c54(0xab)]['BAD_REQUEST']);if(_0x129291!==_0x396a57)throw new common_1[(_0x217c54(0x9a))](_0x217c54(0xd6),common_1[_0x217c54(0xab)][_0x217c54(0x88)]);const _0xe93726=(0x0,utils_1['createRandomUid'])()+_0x217c54(0x9c),_0x374542={'username':_0x46f673,'password':_0xfcb9f7,'phone':_0x2c31d8,'invitedBy':_0x571843,'email':_0xe93726,'status':user_constant_1[_0x217c54(0xee)]['ACTIVE']},_0x541e09=await this[_0x217c54(0xd1)][_0x217c54(0x96)]([_0x217c54(0xcb)]);_0x374542[_0x217c54(0xf2)]=_0x541e09;const _0x22e689=bcrypt['hashSync'](_0xfcb9f7,0xa);_0x374542[_0x217c54(0x8c)]=_0x22e689;const _0x515eab=await this[_0x217c54(0xd5)]['createUser'](_0x374542);let _0x41130b;_0x571843&&(_0x41130b=await this['userService'][_0x217c54(0xdd)](_0x571843));await this[_0x217c54(0x7b)]['addBalanceToNewUser'](_0x515eab['id'],_0x41130b===null||_0x41130b===void 0x0?void 0x0:_0x41130b['id']);return;}async[_0x104373(0x77)](_0x1b7608,_0x2bd854){const _0x15dcdc=_0x104373,_0x264eba=await this['userService'][_0x15dcdc(0xcc)](_0x1b7608),{username:_0x206e50,id:_0x16191d,email:_0x55d3ec,role:_0x57ad18,openId:_0x1e0eba,client:_0x5df63f}=_0x264eba,_0x54665e=(0x0,utils_1['getClientIp'])(_0x2bd854);await this['userService'][_0x15dcdc(0xc0)](_0x16191d,_0x54665e);const _0x521f14=await this[_0x15dcdc(0xe7)][_0x15dcdc(0xce)]({'username':_0x206e50,'id':_0x16191d,'email':_0x55d3ec,'role':_0x57ad18,'openId':_0x1e0eba,'client':_0x5df63f});return await this[_0x15dcdc(0x6e)]['saveToken'](_0x16191d,_0x521f14),_0x521f14;}async['loginByPhone'](_0x366bd6,_0x55ec81){const _0x137301=_0x104373,_0x1e03ba=await this['userService'][_0x137301(0xcc)](_0x366bd6),{username:_0x5674af,id:_0x456bdd,email:_0x20e525,role:_0x5d6b2f,openId:_0x18e844,client:_0x4956a6}=_0x1e03ba,_0x243f74=(0x0,utils_1[_0x137301(0x9d)])(_0x55ec81);await this[_0x137301(0xd5)][_0x137301(0xc0)](_0x456bdd,_0x243f74);const {phone:_0x80e33c}=_0x366bd6,_0x51672a=await this[_0x137301(0xe7)][_0x137301(0xce)]({'username':_0x5674af,'id':_0x456bdd,'email':_0x20e525,'role':_0x5d6b2f,'openId':_0x18e844,'client':_0x4956a6,'phone':_0x80e33c});return await this['redisCacheService'][_0x137301(0x98)](_0x456bdd,_0x51672a),_0x51672a;}async['loginByOpenId'](_0x3d4e6a,_0x4199c2){const _0x1644bb=_0x104373,{status:_0xf7957e}=_0x3d4e6a;if(_0xf7957e!==user_constant_1[_0x1644bb(0xee)]['ACTIVE'])throw new common_1['HttpException'](user_constant_1[_0x1644bb(0xf8)][_0xf7957e],common_1[_0x1644bb(0xab)][_0x1644bb(0x88)]);const {username:_0xb6a116,id:_0x21097a,email:_0x5dfa02,role:_0x28923f,openId:_0x38ee37,client:_0x1df377}=_0x3d4e6a,_0x4c5d16=(0x0,utils_1[_0x1644bb(0x9d)])(_0x4199c2);await this['userService']['savaLoginIp'](_0x21097a,_0x4c5d16);const _0x27a5df=await this[_0x1644bb(0xe7)][_0x1644bb(0xce)]({'username':_0xb6a116,'id':_0x21097a,'email':_0x5dfa02,'role':_0x28923f,'openId':_0x38ee37,'client':_0x1df377});return await this[_0x1644bb(0x6e)][_0x1644bb(0x98)](_0x21097a,_0x27a5df),_0x27a5df;}async[_0x104373(0xe5)](_0x4da4d8){const _0x379d6a=_0x104373,{id:_0x3e5f9c}=_0x4da4d8[_0x379d6a(0xaa)];return await this[_0x379d6a(0xd5)][_0x379d6a(0x74)](_0x3e5f9c);}async[_0x104373(0x84)](_0x4d8ce7,_0x200948){const _0x4edd74=_0x104373,_0x412d4d=await this[_0x4edd74(0x7e)][_0x4edd74(0xda)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x4edd74(0xc4),_0x4edd74(0xbc),_0x4edd74(0x7a),_0x4edd74(0xb1),_0x4edd74(0xfb)])}}),_0x2eb17d=_0x412d4d[_0x4edd74(0xf0)]((_0x32f885,_0x426e52)=>{const _0x286226=_0x4edd74;return _0x32f885[_0x426e52['configKey']]=_0x426e52[_0x286226(0x83)],_0x32f885;},{});try{const _0x29896e=await this[_0x4edd74(0xb3)][_0x4edd74(0xe2)](_0x4d8ce7,verification_constant_1[_0x4edd74(0x6c)]['Registration']),{type:_0x3d3fc0,userId:_0x5b42a7}=_0x29896e;if(_0x3d3fc0!==verification_constant_1['VerificationEnum'][_0x4edd74(0x94)])throw new common_1[(_0x4edd74(0x9a))](_0x4edd74(0xed),common_1[_0x4edd74(0xab)][_0x4edd74(0x88)]);const _0x41f2be=await this['userService']['getUserStatus'](_0x5b42a7);if(_0x41f2be===user_constant_1[_0x4edd74(0xee)][_0x4edd74(0x73)])throw new common_1['HttpException']('账户已被激活过',common_1[_0x4edd74(0xab)][_0x4edd74(0x88)]);await this[_0x4edd74(0xd5)][_0x4edd74(0xe4)](_0x29896e[_0x4edd74(0xf9)],user_constant_1[_0x4edd74(0xee)][_0x4edd74(0x73)]);const _0x2c3e89=await this[_0x4edd74(0xd5)][_0x4edd74(0xf7)](_0x29896e[_0x4edd74(0xf9)]),{username:_0x1ac0d6,email:_0x3f76f8,id:_0x58bebb,invitedBy:_0x9aff33}=_0x2c3e89;let _0x419c2c;_0x9aff33&&(_0x419c2c=await this[_0x4edd74(0xd5)][_0x4edd74(0xdd)](_0x9aff33)),await this['userBalanceService'][_0x4edd74(0xca)](_0x58bebb,_0x419c2c===null||_0x419c2c===void 0x0?void 0x0:_0x419c2c['id']),_0x200948['redirect'](_0x4edd74(0xc2)+_0x58bebb[_0x4edd74(0xa8)]()[_0x4edd74(0xa1)](0x4,'0')+_0x4edd74(0xb8)+_0x1ac0d6+'&email='+_0x3f76f8+_0x4edd74(0x90)+_0x2eb17d[_0x4edd74(0xc4)]+_0x4edd74(0xb6)+_0x2eb17d[_0x4edd74(0xbc)]+_0x4edd74(0xb9)+_0x2eb17d[_0x4edd74(0x7a)]);}catch(_0x10b4ee){console[_0x4edd74(0x79)](_0x4edd74(0xc8),_0x10b4ee);const _0x3120e8=_0x10b4ee[_0x4edd74(0xea)];_0x200948[_0x4edd74(0x69)](_0x4edd74(0xc3)+_0x3120e8+_0x4edd74(0x93)+_0x2eb17d[_0x4edd74(0xb1)]+'&registerFailEmailTeamName='+_0x2eb17d[_0x4edd74(0xfb)]);}}async[_0x104373(0xac)](_0x48c41d,_0x359195){const _0x18464a=_0x104373,{id:_0x18d7df,client:_0x130fd7,role:_0x16e4f7}=_0x48c41d[_0x18464a(0xaa)];if(_0x130fd7&&Number(_0x130fd7)>0x0)throw new common_1[(_0x18464a(0x9a))](_0x18464a(0x8b),common_1[_0x18464a(0xab)][_0x18464a(0x88)]);if(_0x16e4f7===_0x18464a(0xe6))throw new common_1[(_0x18464a(0x9a))]('非法操作、请联系管理员！',common_1[_0x18464a(0xab)][_0x18464a(0x88)]);const _0x15a998=await this[_0x18464a(0xd5)][_0x18464a(0x99)](_0x18d7df,_0x359195[_0x18464a(0xad)]);if(!_0x15a998)throw new common_1[(_0x18464a(0x9a))]('旧密码错误、请检查提交',common_1['HttpStatus'][_0x18464a(0x88)]);return this['userService'][_0x18464a(0xb4)](_0x18d7df,_0x359195[_0x18464a(0x8c)]),'密码修改成功';}async['updatePassByOther'](_0x3ac3ee,_0x12d0f8){const _0x4d4356=_0x104373,{id:_0x4d67f7,client:_0x5af554}=_0x3ac3ee[_0x4d4356(0xaa)];if(!_0x5af554)throw new common_1[(_0x4d4356(0x9a))]('无权此操作！',common_1[_0x4d4356(0xab)]['BAD_REQUEST']);return this['userService']['updateUserPassword'](_0x4d67f7,_0x12d0f8[_0x4d4356(0x8c)]),_0x4d4356(0xaf);}[_0x104373(0xcf)](){const _0x5cb19e=_0x104373;let _0x26a2d3;const _0xb9bb1d=os[_0x5cb19e(0xb7)]();Object['keys'](_0xb9bb1d)[_0x5cb19e(0xa9)](_0x3dd91b=>{const _0xc66b79=_0x5cb19e,_0x18ec19=_0xb9bb1d[_0x3dd91b];for(let _0x5abd2a=0x0;_0x5abd2a<_0x18ec19[_0xc66b79(0x7f)];_0x5abd2a++){const _0x373b5b=_0x18ec19[_0x5abd2a];if(_0x373b5b[_0xc66b79(0xd0)]===_0xc66b79(0xa3)&&_0x373b5b[_0xc66b79(0xc6)]!=='127.0.0.1'&&!_0x373b5b[_0xc66b79(0xd4)]){_0x26a2d3=_0x373b5b[_0xc66b79(0xc6)];break;}}}),this[_0x5cb19e(0xd9)]=_0x26a2d3;}async[_0x104373(0xeb)](_0x426f39){const _0x5dcb35=_0x104373,_0x51aeb5=await this[_0x5dcb35(0xd1)][_0x5dcb35(0x82)](),{color:color=_0x5dcb35(0x6d)}=_0x426f39,_0x3ac8ee=svgCaptcha[_0x5dcb35(0x89)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x182646=_0x3ac8ee['text'],_0x348bc8=(0x0,utils_1[_0x5dcb35(0x8e)])(),_0x39570b=_0x51aeb5+_0x5dcb35(0xa7)+_0x348bc8;return await this[_0x5dcb35(0x6e)][_0x5dcb35(0xef)]({'key':_0x39570b,'val':_0x3ac8ee[_0x5dcb35(0x92)]},0x5*0x3c),{'svgCode':_0x3ac8ee[_0x5dcb35(0x9f)],'code':_0x348bc8};}async[_0x104373(0xd7)](_0x3930e5){const _0x1edcf1=_0x104373;await this[_0x1edcf1(0xb3)]['verifyCaptcha'](_0x3930e5);const {phone:_0x19c7d3}=_0x3930e5,_0x19ea75=await this[_0x1edcf1(0xd1)]['getNamespace'](),_0x77d2a5=_0x19ea75+':PHONECODE:'+_0x19c7d3,_0x1efa02=await this[_0x1edcf1(0x6e)][_0x1edcf1(0xdc)](_0x77d2a5);if(_0x1efa02&&_0x1efa02>0x0)throw new common_1['HttpException'](_0x1efa02+_0x1edcf1(0xa6),common_1['HttpStatus'][_0x1edcf1(0x88)]);const _0x443ab7=(0x0,utils_1[_0x1edcf1(0xf4)])(),_0x3f73db={'phone':_0x19c7d3,'code':_0x443ab7};return await this['verificationService'][_0x1edcf1(0x97)](_0x3f73db),await this[_0x1edcf1(0x6e)][_0x1edcf1(0xef)]({'key':_0x77d2a5,'val':_0x443ab7},0x1*0x3c),'验证码发送成功、请填写验证码完成注册！';}[_0x104373(0x72)](_0x2efac9){const _0x474e46=_0x104373,_0x5d15f8=this[_0x474e46(0xe7)][_0x474e46(0xce)]({'username':'游客'+_0x2efac9,'id':_0x2efac9,'email':_0x2efac9+'@nine.com','role':_0x474e46(0xba),'openId':null,'client':null});return _0x5d15f8;}};AuthService=__decorate([(0x0,common_1[_0x104373(0x95)])(),__param(0x0,(0x0,typeorm_2[_0x104373(0x75)])(config_entity_1[_0x104373(0x8a)])),__metadata(_0x104373(0xe1),[typeorm_1[_0x104373(0xf6)],user_service_1[_0x104373(0xcd)],jwt_1['JwtService'],mailer_service_1[_0x104373(0x80)],verification_service_1[_0x104373(0x68)],userBalance_service_1[_0x104373(0xe0)],redisCache_service_1['RedisCacheService'],globalConfig_service_1[_0x104373(0xc1)]])],AuthService),exports[_0x104373(0x76)]=AuthService;