'use strict';const _0x3f3f5b=_0x2b00;(function(_0x16543d,_0x4ecef5){const _0x378a2a=_0x2b00,_0x21c3c7=_0x16543d();while(!![]){try{const _0x4b54ee=parseInt(_0x378a2a(0x19f))/0x1*(-parseInt(_0x378a2a(0x1b9))/0x2)+parseInt(_0x378a2a(0x169))/0x3+parseInt(_0x378a2a(0x1b6))/0x4+-parseInt(_0x378a2a(0x1b0))/0x5*(parseInt(_0x378a2a(0x17b))/0x6)+parseInt(_0x378a2a(0x177))/0x7*(parseInt(_0x378a2a(0x19b))/0x8)+-parseInt(_0x378a2a(0x162))/0x9+-parseInt(_0x378a2a(0x16e))/0xa*(-parseInt(_0x378a2a(0x190))/0xb);if(_0x4b54ee===_0x4ecef5)break;else _0x21c3c7['push'](_0x21c3c7['shift']());}catch(_0x51b566){_0x21c3c7['push'](_0x21c3c7['shift']());}}}(_0x15d4,0xd3d10));var __decorate=this&&this[_0x3f3f5b(0x196)]||function(_0x5ef267,_0x1466df,_0x2e149c,_0x3d73ed){const _0x3c8e48=_0x3f3f5b;var _0x37c0d5=arguments[_0x3c8e48(0x1b3)],_0x491909=_0x37c0d5<0x3?_0x1466df:_0x3d73ed===null?_0x3d73ed=Object[_0x3c8e48(0x165)](_0x1466df,_0x2e149c):_0x3d73ed,_0x40eed9;if(typeof Reflect===_0x3c8e48(0x197)&&typeof Reflect[_0x3c8e48(0x182)]===_0x3c8e48(0x143))_0x491909=Reflect['decorate'](_0x5ef267,_0x1466df,_0x2e149c,_0x3d73ed);else{for(var _0x32b679=_0x5ef267[_0x3c8e48(0x1b3)]-0x1;_0x32b679>=0x0;_0x32b679--)if(_0x40eed9=_0x5ef267[_0x32b679])_0x491909=(_0x37c0d5<0x3?_0x40eed9(_0x491909):_0x37c0d5>0x3?_0x40eed9(_0x1466df,_0x2e149c,_0x491909):_0x40eed9(_0x1466df,_0x2e149c))||_0x491909;}return _0x37c0d5>0x3&&_0x491909&&Object[_0x3c8e48(0x156)](_0x1466df,_0x2e149c,_0x491909),_0x491909;},__metadata=this&&this[_0x3f3f5b(0x18c)]||function(_0x53e085,_0xb7a432){const _0x58e3d8=_0x3f3f5b;if(typeof Reflect===_0x58e3d8(0x197)&&typeof Reflect[_0x58e3d8(0x15f)]==='function')return Reflect['metadata'](_0x53e085,_0xb7a432);},__param=this&&this[_0x3f3f5b(0x1cd)]||function(_0x138c75,_0x55fa70){return function(_0x7d6821,_0x21db0b){_0x55fa70(_0x7d6821,_0x21db0b,_0x138c75);};};function _0x2b00(_0x50a79f,_0x27d683){const _0x15d489=_0x15d4();return _0x2b00=function(_0x2b00c5,_0x5bfe8e){_0x2b00c5=_0x2b00c5-0x13f;let _0x49378b=_0x15d489[_0x2b00c5];return _0x49378b;},_0x2b00(_0x50a79f,_0x27d683);}function _0x15d4(){const _0x5e0ad5=['get','../globalConfig/config.entity','getOwnPropertyDescriptor','redisCacheService','&registerSuccessEmaileAppend=','addBalanceToNewUser','3419235naToop','../../common/constants/user.constant','getConfigs','savaLoginIp','configKey','24730RTIRtW','error:\x20','验证码类型错误','queryUserInfoById','verifyCode','address','@nine.com','configEntity','&registerFailEmailTeamName=','49NrNZII','verifyUserPassword','&registerFailEmailTitle=','createRandomUid','420lnXQgf','userBalanceService','ACTIVE','&registerSuccessEmailTeamName=','updateUserPassword','registerSuccessEmailTitle','UserBalanceService','decorate','../../common/utils','GlobalConfigService','createTokenFromFingerprint','globalConfigService','jwtService','getNamespace','text','forEach','createUser','__metadata','../../common/constants/verification.constant','VerificationService','visitor','627YDoDgt','/api/auth/registerError?message=','@nestjs/typeorm','onModuleInit','verifyUserCredentials','VerificationEnum','__decorate','object','UserStatusErrMsg','registerByPhone','HttpException','1030488jjwnKs','log','oldPassword','非法操作、请联系管理员！','280354JdlXqK','avatar','AuthService','密码修改成功','../mailer/mailer.service','captcha','Registration','password','updateUserStatus','design:paramtypes','Injectable','verifyUserRegisterByPhone','../globalConfig/globalConfig.service','registerSuccessEmailTeamName','验证码发送成功、请填写验证码完成注册！','userId','无权此操作！','29365IkEQlD','IPv4','reduce','length','sendPhoneCode','JwtService','2489720QeaUYQ','toString','sign','8ESUzPh','BAD_REQUEST','ipAddress','sendPhoneCodeWithQcloud','registerSuccessEmaileAppend','127.0.0.1','getIp','ttl','registerFailEmailTeamName','hashSync','activateAccount','&registerSuccessEmailTitle=','saveToken','family','updatePassword','UserStatusEnum','mailerService','createRandomCode','getUserStatus','createUserAndVerifycation','__param','InjectRepository','find','createMathExpr','configVal','function','UserService','MailerService','userDefautlAvatar','client','@nestjs/common','verificationService','验证码填写错误、请重新输入！',':CAPTCHA:',':PHONECODE:','Repository','redirect','getClientIp','../verification/verification.service','../user/user.service','typeorm','keys','loginByOpenId','registerFailEmailTitle','defineProperty','verifyCaptcha','userService','&username=','register','loginByPhone','padStart','svg-captcha','updatePassByOther','metadata','HttpStatus','../userBalance/userBalance.service','3642183nYYtYc'];_0x15d4=function(){return _0x5e0ad5;};return _0x15d4();}Object[_0x3f3f5b(0x156)](exports,'__esModule',{'value':!![]}),exports[_0x3f3f5b(0x1a1)]=void 0x0;const globalConfig_service_1=require(_0x3f3f5b(0x1ab)),verification_constant_1=require(_0x3f3f5b(0x18d)),verification_service_1=require(_0x3f3f5b(0x150)),common_1=require(_0x3f3f5b(0x148)),jwt_1=require('@nestjs/jwt'),user_service_1=require(_0x3f3f5b(0x151)),mailer_service_1=require(_0x3f3f5b(0x1a3)),user_constant_1=require(_0x3f3f5b(0x16a)),userBalance_service_1=require(_0x3f3f5b(0x161)),config_entity_1=require(_0x3f3f5b(0x164)),typeorm_1=require(_0x3f3f5b(0x152)),typeorm_2=require(_0x3f3f5b(0x192)),utils_1=require(_0x3f3f5b(0x183)),os=require('os'),redisCache_service_1=require('../redisCache/redisCache.service'),svgCaptcha=require(_0x3f3f5b(0x15d)),bcrypt=require('bcryptjs');let AuthService=class AuthService{constructor(_0x2d5a5f,_0x4ce74f,_0x320804,_0x4c00bc,_0x586eea,_0x1169b6,_0x3ea2d6,_0x57cc97){const _0x444ffd=_0x3f3f5b;this[_0x444ffd(0x175)]=_0x2d5a5f,this[_0x444ffd(0x158)]=_0x4ce74f,this['jwtService']=_0x320804,this[_0x444ffd(0x1c9)]=_0x4c00bc,this[_0x444ffd(0x149)]=_0x586eea,this['userBalanceService']=_0x1169b6,this[_0x444ffd(0x166)]=_0x3ea2d6,this[_0x444ffd(0x186)]=_0x57cc97;}async[_0x3f3f5b(0x193)](){const _0x2f782e=_0x3f3f5b;this[_0x2f782e(0x1bf)]();}async[_0x3f3f5b(0x15a)](_0xb7ed07,_0x271dfd){const _0x4ea336=_0x3f3f5b;await this[_0x4ea336(0x149)]['verifyCaptcha'](_0xb7ed07);const _0x12b9e4=await this['userService'][_0x4ea336(0x1cc)](_0xb7ed07,_0x271dfd),{username:_0x57db36,email:_0x3d9f0b,client:_0x2ff07b,id:_0x51ea0d}=_0x12b9e4,_0x1b07fc={'username':_0x57db36,'email':_0x3d9f0b,'id':_0x51ea0d};return _0x2ff07b&&(_0x1b07fc[_0x4ea336(0x147)]=_0x2ff07b),_0x1b07fc;}async[_0x3f3f5b(0x199)](_0x287de9,_0x5af9d3){const _0x2872c8=_0x3f3f5b,{username:_0x29a91f,password:_0x238d12,phone:_0x549115,phoneCode:_0x587371,invitedBy:_0x5b3163}=_0x287de9;await this[_0x2872c8(0x158)][_0x2872c8(0x1aa)](_0x287de9);const _0x351579=await this['globalConfigService'][_0x2872c8(0x188)](),_0x309348=_0x351579+_0x2872c8(0x14c)+_0x549115,_0x2e9efd=await this[_0x2872c8(0x166)][_0x2872c8(0x163)]({'key':_0x309348});if(!_0x2e9efd)throw new common_1[(_0x2872c8(0x19a))]('验证码已过期、请重新发送！',common_1[_0x2872c8(0x160)][_0x2872c8(0x1ba)]);if(_0x587371!==_0x2e9efd)throw new common_1[(_0x2872c8(0x19a))](_0x2872c8(0x14a),common_1[_0x2872c8(0x160)][_0x2872c8(0x1ba)]);const _0x290cf6=(0x0,utils_1[_0x2872c8(0x17a)])()+_0x2872c8(0x174),_0x5ed415={'username':_0x29a91f,'password':_0x238d12,'phone':_0x549115,'invitedBy':_0x5b3163,'email':_0x290cf6,'status':user_constant_1[_0x2872c8(0x1c8)][_0x2872c8(0x17d)]},_0x2dcac6=await this[_0x2872c8(0x186)][_0x2872c8(0x16b)]([_0x2872c8(0x146)]);_0x5ed415[_0x2872c8(0x1a0)]=_0x2dcac6;const _0x312e3b=bcrypt[_0x2872c8(0x1c2)](_0x238d12,0xa);_0x5ed415[_0x2872c8(0x1a6)]=_0x312e3b;const _0x5e1446=await this['userService'][_0x2872c8(0x18b)](_0x5ed415);let _0x37adbd;_0x5b3163&&(_0x37adbd=await this[_0x2872c8(0x158)]['qureyUserInfoByInviteCode'](_0x5b3163));await this[_0x2872c8(0x17c)][_0x2872c8(0x168)](_0x5e1446['id'],_0x37adbd===null||_0x37adbd===void 0x0?void 0x0:_0x37adbd['id']);return;}async['login'](_0x1e8b20,_0x406f69){const _0x5ab116=_0x3f3f5b,_0xec8647=await this['userService'][_0x5ab116(0x194)](_0x1e8b20),{username:_0x566add,id:_0x332f0d,email:_0x125af6,role:_0x219ff3,openId:_0x4c5f36,client:_0x59b00e}=_0xec8647,_0x46c5da=(0x0,utils_1[_0x5ab116(0x14f)])(_0x406f69);await this['userService'][_0x5ab116(0x16c)](_0x332f0d,_0x46c5da);const _0x39cff8=await this[_0x5ab116(0x187)]['sign']({'username':_0x566add,'id':_0x332f0d,'email':_0x125af6,'role':_0x219ff3,'openId':_0x4c5f36,'client':_0x59b00e});return await this['redisCacheService']['saveToken'](_0x332f0d,_0x39cff8),_0x39cff8;}async[_0x3f3f5b(0x15b)](_0x50b588,_0x5c7374){const _0x856247=_0x3f3f5b,_0x251fee=await this[_0x856247(0x158)]['verifyUserCredentials'](_0x50b588),{username:_0x4d32e3,id:_0x3e48d7,email:_0x40bc61,role:_0x5bd520,openId:_0x5a7f7f,client:_0xfb6bda}=_0x251fee,_0x5d3fe5=(0x0,utils_1[_0x856247(0x14f)])(_0x5c7374);await this['userService'][_0x856247(0x16c)](_0x3e48d7,_0x5d3fe5);const {phone:_0x4c4768}=_0x50b588,_0xfdd1d6=await this['jwtService'][_0x856247(0x1b8)]({'username':_0x4d32e3,'id':_0x3e48d7,'email':_0x40bc61,'role':_0x5bd520,'openId':_0x5a7f7f,'client':_0xfb6bda,'phone':_0x4c4768});return await this['redisCacheService'][_0x856247(0x1c5)](_0x3e48d7,_0xfdd1d6),_0xfdd1d6;}async[_0x3f3f5b(0x154)](_0x5a474b,_0x5c195b){const _0x3b167f=_0x3f3f5b,{status:_0x5b5416}=_0x5a474b;if(_0x5b5416!==user_constant_1[_0x3b167f(0x1c8)]['ACTIVE'])throw new common_1[(_0x3b167f(0x19a))](user_constant_1[_0x3b167f(0x198)][_0x5b5416],common_1[_0x3b167f(0x160)][_0x3b167f(0x1ba)]);const {username:_0x32b7b9,id:_0x2e9e74,email:_0x4a28ef,role:_0x4d8565,openId:_0x29a119,client:_0x540792}=_0x5a474b,_0x56b541=(0x0,utils_1[_0x3b167f(0x14f)])(_0x5c195b);await this[_0x3b167f(0x158)][_0x3b167f(0x16c)](_0x2e9e74,_0x56b541);const _0x20477f=await this[_0x3b167f(0x187)][_0x3b167f(0x1b8)]({'username':_0x32b7b9,'id':_0x2e9e74,'email':_0x4a28ef,'role':_0x4d8565,'openId':_0x29a119,'client':_0x540792});return await this[_0x3b167f(0x166)][_0x3b167f(0x1c5)](_0x2e9e74,_0x20477f),_0x20477f;}async['getInfo'](_0x46fda0){const _0x12104f=_0x3f3f5b,{id:_0x1f9dac}=_0x46fda0['user'];return await this[_0x12104f(0x158)]['getUserInfo'](_0x1f9dac);}async[_0x3f3f5b(0x1c3)](_0x175057,_0x23d608){const _0x469ed5=_0x3f3f5b,_0x461027=await this[_0x469ed5(0x175)][_0x469ed5(0x140)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x469ed5(0x180),_0x469ed5(0x1ac),_0x469ed5(0x1bd),_0x469ed5(0x155),_0x469ed5(0x1c1)])}}),_0x2e5344=_0x461027[_0x469ed5(0x1b2)]((_0x4466c7,_0x3350f2)=>{const _0x256023=_0x469ed5;return _0x4466c7[_0x3350f2[_0x256023(0x16d)]]=_0x3350f2[_0x256023(0x142)],_0x4466c7;},{});try{const _0x2a8e81=await this[_0x469ed5(0x149)][_0x469ed5(0x172)](_0x175057,verification_constant_1[_0x469ed5(0x195)][_0x469ed5(0x1a5)]),{type:_0x1c5f3b,userId:_0x19ab53}=_0x2a8e81;if(_0x1c5f3b!==verification_constant_1[_0x469ed5(0x195)][_0x469ed5(0x1a5)])throw new common_1[(_0x469ed5(0x19a))](_0x469ed5(0x170),common_1[_0x469ed5(0x160)][_0x469ed5(0x1ba)]);const _0x45022f=await this[_0x469ed5(0x158)][_0x469ed5(0x1cb)](_0x19ab53);if(_0x45022f===user_constant_1[_0x469ed5(0x1c8)]['ACTIVE'])throw new common_1['HttpException']('账户已被激活过',common_1[_0x469ed5(0x160)]['BAD_REQUEST']);await this[_0x469ed5(0x158)][_0x469ed5(0x1a7)](_0x2a8e81[_0x469ed5(0x1ae)],user_constant_1[_0x469ed5(0x1c8)][_0x469ed5(0x17d)]);const _0x267474=await this[_0x469ed5(0x158)][_0x469ed5(0x171)](_0x2a8e81[_0x469ed5(0x1ae)]),{username:_0x45988a,email:_0x21c31b,id:_0x382fb7,invitedBy:_0x4f8aa2}=_0x267474;let _0x391cc2;_0x4f8aa2&&(_0x391cc2=await this['userService']['qureyUserInfoByInviteCode'](_0x4f8aa2)),await this['userBalanceService'][_0x469ed5(0x168)](_0x382fb7,_0x391cc2===null||_0x391cc2===void 0x0?void 0x0:_0x391cc2['id']),_0x23d608[_0x469ed5(0x14e)]('/api/auth/registerSuccess?id='+_0x382fb7[_0x469ed5(0x1b7)]()[_0x469ed5(0x15c)](0x4,'0')+_0x469ed5(0x159)+_0x45988a+'&email='+_0x21c31b+_0x469ed5(0x1c4)+_0x2e5344[_0x469ed5(0x180)]+_0x469ed5(0x17e)+_0x2e5344[_0x469ed5(0x1ac)]+_0x469ed5(0x167)+_0x2e5344['registerSuccessEmaileAppend']);}catch(_0x45d2e6){console[_0x469ed5(0x19c)](_0x469ed5(0x16f),_0x45d2e6);const _0x5e88ee=_0x45d2e6['response'];_0x23d608['redirect'](_0x469ed5(0x191)+_0x5e88ee+_0x469ed5(0x179)+_0x2e5344[_0x469ed5(0x155)]+_0x469ed5(0x176)+_0x2e5344[_0x469ed5(0x1c1)]);}}async[_0x3f3f5b(0x1c7)](_0x289a75,_0x1338e3){const _0x5151c3=_0x3f3f5b,{id:_0x4ce01d,client:_0x4be90a,role:_0x372c4d}=_0x289a75['user'];if(_0x4be90a&&Number(_0x4be90a)>0x0)throw new common_1[(_0x5151c3(0x19a))]('无权此操作、请联系管理员！',common_1[_0x5151c3(0x160)]['BAD_REQUEST']);if(_0x372c4d==='admin')throw new common_1[(_0x5151c3(0x19a))](_0x5151c3(0x19e),common_1[_0x5151c3(0x160)][_0x5151c3(0x1ba)]);const _0x25e915=await this[_0x5151c3(0x158)][_0x5151c3(0x178)](_0x4ce01d,_0x1338e3[_0x5151c3(0x19d)]);if(!_0x25e915)throw new common_1[(_0x5151c3(0x19a))]('旧密码错误、请检查提交',common_1['HttpStatus'][_0x5151c3(0x1ba)]);return this['userService']['updateUserPassword'](_0x4ce01d,_0x1338e3[_0x5151c3(0x1a6)]),_0x5151c3(0x1a2);}async[_0x3f3f5b(0x15e)](_0x445f5f,_0x23cd92){const _0x4aee44=_0x3f3f5b,{id:_0x2a6ec4,client:_0x39fadf}=_0x445f5f['user'];if(!_0x39fadf)throw new common_1[(_0x4aee44(0x19a))](_0x4aee44(0x1af),common_1['HttpStatus'][_0x4aee44(0x1ba)]);return this[_0x4aee44(0x158)][_0x4aee44(0x17f)](_0x2a6ec4,_0x23cd92[_0x4aee44(0x1a6)]),_0x4aee44(0x1a2);}[_0x3f3f5b(0x1bf)](){const _0x55b8a5=_0x3f3f5b;let _0x1fdda1;const _0x575a92=os['networkInterfaces']();Object[_0x55b8a5(0x153)](_0x575a92)[_0x55b8a5(0x18a)](_0x730564=>{const _0x46da42=_0x55b8a5,_0x14e5be=_0x575a92[_0x730564];for(let _0x16fd13=0x0;_0x16fd13<_0x14e5be[_0x46da42(0x1b3)];_0x16fd13++){const _0x3d03c5=_0x14e5be[_0x16fd13];if(_0x3d03c5[_0x46da42(0x1c6)]===_0x46da42(0x1b1)&&_0x3d03c5[_0x46da42(0x173)]!==_0x46da42(0x1be)&&!_0x3d03c5['internal']){_0x1fdda1=_0x3d03c5[_0x46da42(0x173)];break;}}}),this[_0x55b8a5(0x1bb)]=_0x1fdda1;}async[_0x3f3f5b(0x1a4)](_0x189c3c){const _0x5b2a90=_0x3f3f5b,_0x21d5a5=await this[_0x5b2a90(0x186)][_0x5b2a90(0x188)](),{color:color='#fff'}=_0x189c3c,_0x5a1a70=svgCaptcha[_0x5b2a90(0x141)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x442e74=_0x5a1a70[_0x5b2a90(0x189)],_0x44ca9a=(0x0,utils_1[_0x5b2a90(0x17a)])(),_0xfadae=_0x21d5a5+_0x5b2a90(0x14b)+_0x44ca9a;return await this[_0x5b2a90(0x166)]['set']({'key':_0xfadae,'val':_0x5a1a70['text']},0x5*0x3c),{'svgCode':_0x5a1a70['data'],'code':_0x44ca9a};}async[_0x3f3f5b(0x1b4)](_0x4c77ec){const _0x320bbe=_0x3f3f5b;await this[_0x320bbe(0x149)][_0x320bbe(0x157)](_0x4c77ec);const {phone:_0x2178a5}=_0x4c77ec,_0xf31926=await this[_0x320bbe(0x186)][_0x320bbe(0x188)](),_0x2e57c7=_0xf31926+':PHONECODE:'+_0x2178a5,_0x5642b9=await this[_0x320bbe(0x166)][_0x320bbe(0x1c0)](_0x2e57c7);if(_0x5642b9&&_0x5642b9>0x0)throw new common_1[(_0x320bbe(0x19a))](_0x5642b9+'秒内不得重复发送短信！',common_1[_0x320bbe(0x160)][_0x320bbe(0x1ba)]);const _0x2eec06=(0x0,utils_1[_0x320bbe(0x1ca)])(),_0x272a63={'phone':_0x2178a5,'code':_0x2eec06};return await this['verificationService'][_0x320bbe(0x1bc)](_0x272a63),await this[_0x320bbe(0x166)]['set']({'key':_0x2e57c7,'val':_0x2eec06},0x1*0x3c),_0x320bbe(0x1ad);}[_0x3f3f5b(0x185)](_0x3d1bd3){const _0x278b9c=_0x3f3f5b,_0x2cc530=this[_0x278b9c(0x187)][_0x278b9c(0x1b8)]({'username':'游客'+_0x3d1bd3,'id':_0x3d1bd3,'email':_0x3d1bd3+'@nine.com','role':_0x278b9c(0x18f),'openId':null,'client':null});return _0x2cc530;}};AuthService=__decorate([(0x0,common_1[_0x3f3f5b(0x1a9)])(),__param(0x0,(0x0,typeorm_2[_0x3f3f5b(0x13f)])(config_entity_1['ConfigEntity'])),__metadata(_0x3f3f5b(0x1a8),[typeorm_1[_0x3f3f5b(0x14d)],user_service_1[_0x3f3f5b(0x144)],jwt_1[_0x3f3f5b(0x1b5)],mailer_service_1[_0x3f3f5b(0x145)],verification_service_1[_0x3f3f5b(0x18e)],userBalance_service_1[_0x3f3f5b(0x181)],redisCache_service_1['RedisCacheService'],globalConfig_service_1[_0x3f3f5b(0x184)]])],AuthService),exports[_0x3f3f5b(0x1a1)]=AuthService;