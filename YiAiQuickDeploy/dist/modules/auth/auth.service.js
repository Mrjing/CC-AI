'use strict';const _0x58d0ab=_0x1159;(function(_0x91b9ff,_0xaa47f0){const _0x591870=_0x1159,_0x2cbcfa=_0x91b9ff();while(!![]){try{const _0x4b296a=parseInt(_0x591870(0x1ef))/0x1*(-parseInt(_0x591870(0x1c0))/0x2)+parseInt(_0x591870(0x218))/0x3+-parseInt(_0x591870(0x1c9))/0x4+parseInt(_0x591870(0x1c8))/0x5+-parseInt(_0x591870(0x1e3))/0x6*(-parseInt(_0x591870(0x199))/0x7)+parseInt(_0x591870(0x213))/0x8+parseInt(_0x591870(0x1f3))/0x9;if(_0x4b296a===_0xaa47f0)break;else _0x2cbcfa['push'](_0x2cbcfa['shift']());}catch(_0x331758){_0x2cbcfa['push'](_0x2cbcfa['shift']());}}}(_0x2f5b,0x7f15c));var __decorate=this&&this[_0x58d0ab(0x1b8)]||function(_0x4d6411,_0x4395d3,_0x1edd9d,_0x5a8472){const _0xaa6354=_0x58d0ab;var _0xc524b0=arguments[_0xaa6354(0x1d9)],_0x561bd7=_0xc524b0<0x3?_0x4395d3:_0x5a8472===null?_0x5a8472=Object['getOwnPropertyDescriptor'](_0x4395d3,_0x1edd9d):_0x5a8472,_0x44121b;if(typeof Reflect===_0xaa6354(0x1fd)&&typeof Reflect[_0xaa6354(0x209)]===_0xaa6354(0x1f6))_0x561bd7=Reflect[_0xaa6354(0x209)](_0x4d6411,_0x4395d3,_0x1edd9d,_0x5a8472);else{for(var _0x4f5de6=_0x4d6411[_0xaa6354(0x1d9)]-0x1;_0x4f5de6>=0x0;_0x4f5de6--)if(_0x44121b=_0x4d6411[_0x4f5de6])_0x561bd7=(_0xc524b0<0x3?_0x44121b(_0x561bd7):_0xc524b0>0x3?_0x44121b(_0x4395d3,_0x1edd9d,_0x561bd7):_0x44121b(_0x4395d3,_0x1edd9d))||_0x561bd7;}return _0xc524b0>0x3&&_0x561bd7&&Object['defineProperty'](_0x4395d3,_0x1edd9d,_0x561bd7),_0x561bd7;},__metadata=this&&this[_0x58d0ab(0x1d5)]||function(_0x7726e2,_0x2bd54c){const _0x38b6f8=_0x58d0ab;if(typeof Reflect===_0x38b6f8(0x1fd)&&typeof Reflect[_0x38b6f8(0x1b7)]===_0x38b6f8(0x1f6))return Reflect[_0x38b6f8(0x1b7)](_0x7726e2,_0x2bd54c);},__param=this&&this[_0x58d0ab(0x1da)]||function(_0x2a1ac6,_0x3fd132){return function(_0x5daf21,_0x163819){_0x3fd132(_0x5daf21,_0x163819,_0x2a1ac6);};};function _0x1159(_0x357f0f,_0x253a81){const _0x2f5b2f=_0x2f5b();return _0x1159=function(_0x1159e5,_0x324cbb){_0x1159e5=_0x1159e5-0x18c;let _0x34f144=_0x2f5b2f[_0x1159e5];return _0x34f144;},_0x1159(_0x357f0f,_0x253a81);}Object[_0x58d0ab(0x1ec)](exports,_0x58d0ab(0x1bb),{'value':!![]}),exports[_0x58d0ab(0x1b2)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),verification_constant_1=require(_0x58d0ab(0x19c)),verification_service_1=require(_0x58d0ab(0x1a6)),common_1=require(_0x58d0ab(0x1b1)),jwt_1=require(_0x58d0ab(0x1e9)),user_service_1=require('../user/user.service'),mailer_service_1=require(_0x58d0ab(0x1ce)),user_constant_1=require(_0x58d0ab(0x1ab)),userBalance_service_1=require(_0x58d0ab(0x1ea)),config_entity_1=require(_0x58d0ab(0x1dd)),typeorm_1=require(_0x58d0ab(0x1b3)),typeorm_2=require(_0x58d0ab(0x1f4)),utils_1=require('../../common/utils'),os=require('os'),redisCache_service_1=require(_0x58d0ab(0x208)),svgCaptcha=require(_0x58d0ab(0x1b0)),bcrypt=require(_0x58d0ab(0x204));let AuthService=class AuthService{constructor(_0x315be4,_0x1a23ce,_0x15a21d,_0x29d004,_0x3a3a8d,_0x294f1e,_0x517abe,_0x37a15a){const _0x454a17=_0x58d0ab;this[_0x454a17(0x20e)]=_0x315be4,this[_0x454a17(0x1ee)]=_0x1a23ce,this[_0x454a17(0x1c3)]=_0x15a21d,this[_0x454a17(0x191)]=_0x29d004,this[_0x454a17(0x1de)]=_0x3a3a8d,this[_0x454a17(0x1a1)]=_0x294f1e,this[_0x454a17(0x20b)]=_0x517abe,this[_0x454a17(0x198)]=_0x37a15a;}async['onModuleInit'](){const _0x2938fb=_0x58d0ab;this[_0x2938fb(0x1e0)]();}async[_0x58d0ab(0x20a)](_0x2c36bf,_0x13b52c){const _0x139203=_0x58d0ab;await this[_0x139203(0x1de)][_0x139203(0x192)](_0x2c36bf);const _0x124bce=await this[_0x139203(0x1ee)][_0x139203(0x1a2)](_0x2c36bf,_0x13b52c),{username:_0xad6bc9,email:_0x3259e1,client:_0x4765ef,id:_0x2e9e82}=_0x124bce,_0x4f20d3={'username':_0xad6bc9,'email':_0x3259e1,'id':_0x2e9e82};return _0x4765ef&&(_0x4f20d3['client']=_0x4765ef),_0x4f20d3;}async[_0x58d0ab(0x1f8)](_0x8a05f7,_0x168ab2){const _0x512934=_0x58d0ab,{username:_0x5f2e19,password:_0x4df5cf,phone:_0x4d320b,phoneCode:_0x1fd8d3,invitedBy:_0x5f1e37}=_0x8a05f7;await this[_0x512934(0x1ee)][_0x512934(0x195)](_0x8a05f7);const _0x17b59d=await this['globalConfigService']['getNamespace'](),_0x189029=_0x17b59d+_0x512934(0x1eb)+_0x4d320b,_0x13ede4=await this['redisCacheService'][_0x512934(0x1a9)]({'key':_0x189029});if(!_0x13ede4)throw new common_1[(_0x512934(0x1fb))](_0x512934(0x19b),common_1[_0x512934(0x217)][_0x512934(0x1bc)]);if(_0x1fd8d3!==_0x13ede4)throw new common_1[(_0x512934(0x1fb))]('验证码填写错误、请重新输入！',common_1[_0x512934(0x217)][_0x512934(0x1bc)]);const _0x27fa04=(0x0,utils_1[_0x512934(0x1c7)])()+'@nine.com',_0x2a1cc7={'username':_0x5f2e19,'password':_0x4df5cf,'phone':_0x4d320b,'invitedBy':_0x5f1e37,'email':_0x27fa04,'status':user_constant_1[_0x512934(0x1d3)]['ACTIVE']},_0x4a3792=await this[_0x512934(0x198)][_0x512934(0x201)](['userDefautlAvatar']);_0x2a1cc7[_0x512934(0x1ca)]=_0x4a3792;const _0x21d087=bcrypt['hashSync'](_0x4df5cf,0xa);_0x2a1cc7[_0x512934(0x1f1)]=_0x21d087;const _0x2261bc=await this[_0x512934(0x1ee)][_0x512934(0x1cb)](_0x2a1cc7);let _0x8c958f;_0x5f1e37&&(_0x8c958f=await this['userService'][_0x512934(0x20f)](_0x5f1e37));await this[_0x512934(0x1a1)][_0x512934(0x1a0)](_0x2261bc['id'],_0x8c958f===null||_0x8c958f===void 0x0?void 0x0:_0x8c958f['id']);return;}async['login'](_0x103fbf,_0x2db4ec){const _0x44f558=_0x58d0ab,_0x5aa6c4=await this[_0x44f558(0x1ee)][_0x44f558(0x1cd)](_0x103fbf),{username:_0xaa5fec,id:_0x2e8812,email:_0x3b6107,role:_0x5e3bca,openId:_0x1e28f1,client:_0x1b1a45}=_0x5aa6c4,_0x1f8d23=(0x0,utils_1[_0x44f558(0x1df)])(_0x2db4ec);await this[_0x44f558(0x1ee)][_0x44f558(0x211)](_0x2e8812,_0x1f8d23);const _0x512911=await this[_0x44f558(0x1c3)][_0x44f558(0x216)]({'username':_0xaa5fec,'id':_0x2e8812,'email':_0x3b6107,'role':_0x5e3bca,'openId':_0x1e28f1,'client':_0x1b1a45});return await this[_0x44f558(0x20b)][_0x44f558(0x1f0)](_0x2e8812,_0x512911),_0x512911;}async[_0x58d0ab(0x1d0)](_0x327402,_0x417187){const _0x238462=_0x58d0ab,_0x26e4c0=await this[_0x238462(0x1ee)][_0x238462(0x1cd)](_0x327402),{username:_0xd73344,id:_0x529fd6,email:_0x1424b9,role:_0x23cd2e,openId:_0x56317e,client:_0x292615}=_0x26e4c0,_0x2049ed=(0x0,utils_1['getClientIp'])(_0x417187);await this[_0x238462(0x1ee)][_0x238462(0x211)](_0x529fd6,_0x2049ed);const {phone:_0x36fd96}=_0x327402,_0x3a7503=await this['jwtService'][_0x238462(0x216)]({'username':_0xd73344,'id':_0x529fd6,'email':_0x1424b9,'role':_0x23cd2e,'openId':_0x56317e,'client':_0x292615,'phone':_0x36fd96});return await this[_0x238462(0x20b)]['saveToken'](_0x529fd6,_0x3a7503),_0x3a7503;}async[_0x58d0ab(0x1a7)](_0x52f901,_0x280ea8){const _0x504937=_0x58d0ab,{status:_0x7a69cf}=_0x52f901;if(_0x7a69cf!==user_constant_1[_0x504937(0x1d3)]['ACTIVE'])throw new common_1[(_0x504937(0x1fb))](user_constant_1['UserStatusErrMsg'][_0x7a69cf],common_1[_0x504937(0x217)]['BAD_REQUEST']);const {username:_0x37f69e,id:_0x2cffd4,email:_0x594482,role:_0x52e15b,openId:_0x16285e,client:_0xa25a55}=_0x52f901,_0x12c8d0=(0x0,utils_1['getClientIp'])(_0x280ea8);await this[_0x504937(0x1ee)]['savaLoginIp'](_0x2cffd4,_0x12c8d0);const _0x3df6d6=await this[_0x504937(0x1c3)][_0x504937(0x216)]({'username':_0x37f69e,'id':_0x2cffd4,'email':_0x594482,'role':_0x52e15b,'openId':_0x16285e,'client':_0xa25a55});return await this[_0x504937(0x20b)]['saveToken'](_0x2cffd4,_0x3df6d6),_0x3df6d6;}async[_0x58d0ab(0x1a5)](_0x35a380){const _0x306b90=_0x58d0ab,{id:_0x1c8359}=_0x35a380['user'];return await this[_0x306b90(0x1ee)]['getUserInfo'](_0x1c8359);}async['activateAccount'](_0x16d8cc,_0x1fd16d){const _0x3c7026=_0x58d0ab,_0x14fe87=await this['configEntity']['find']({'where':{'configKey':(0x0,typeorm_1['In'])([_0x3c7026(0x18c),_0x3c7026(0x206),_0x3c7026(0x190),'registerFailEmailTitle',_0x3c7026(0x1a3)])}}),_0x56c18b=_0x14fe87[_0x3c7026(0x19f)]((_0x5bc935,_0x38595e)=>{const _0x3c1521=_0x3c7026;return _0x5bc935[_0x38595e[_0x3c1521(0x207)]]=_0x38595e[_0x3c1521(0x1d2)],_0x5bc935;},{});try{const _0x2bbffb=await this[_0x3c7026(0x1de)][_0x3c7026(0x1c2)](_0x16d8cc,verification_constant_1[_0x3c7026(0x196)][_0x3c7026(0x210)]),{type:_0x5befe2,userId:_0x4d7459}=_0x2bbffb;if(_0x5befe2!==verification_constant_1[_0x3c7026(0x196)][_0x3c7026(0x210)])throw new common_1['HttpException'](_0x3c7026(0x212),common_1[_0x3c7026(0x217)]['BAD_REQUEST']);const _0x130b98=await this['userService'][_0x3c7026(0x1ff)](_0x4d7459);if(_0x130b98===user_constant_1['UserStatusEnum'][_0x3c7026(0x18d)])throw new common_1[(_0x3c7026(0x1fb))](_0x3c7026(0x1e6),common_1[_0x3c7026(0x217)][_0x3c7026(0x1bc)]);await this['userService'][_0x3c7026(0x1ac)](_0x2bbffb['userId'],user_constant_1[_0x3c7026(0x1d3)][_0x3c7026(0x18d)]);const _0x85bee=await this[_0x3c7026(0x1ee)][_0x3c7026(0x18e)](_0x2bbffb[_0x3c7026(0x1c5)]),{username:_0x58b45b,email:_0x1537e9,id:_0x22b318,invitedBy:_0x36f9d1}=_0x85bee;let _0x4e98f3;_0x36f9d1&&(_0x4e98f3=await this[_0x3c7026(0x1ee)][_0x3c7026(0x20f)](_0x36f9d1)),await this[_0x3c7026(0x1a1)][_0x3c7026(0x1a0)](_0x22b318,_0x4e98f3===null||_0x4e98f3===void 0x0?void 0x0:_0x4e98f3['id']),_0x1fd16d[_0x3c7026(0x1c1)]('/api/auth/registerSuccess?id='+_0x22b318[_0x3c7026(0x19a)]()[_0x3c7026(0x194)](0x4,'0')+_0x3c7026(0x1d7)+_0x58b45b+_0x3c7026(0x20c)+_0x1537e9+'&registerSuccessEmailTitle='+_0x56c18b[_0x3c7026(0x18c)]+'&registerSuccessEmailTeamName='+_0x56c18b[_0x3c7026(0x206)]+_0x3c7026(0x18f)+_0x56c18b[_0x3c7026(0x190)]);}catch(_0x1f0c87){console[_0x3c7026(0x20d)](_0x3c7026(0x1d8),_0x1f0c87);const _0x260db3=_0x1f0c87[_0x3c7026(0x205)];_0x1fd16d['redirect'](_0x3c7026(0x1bf)+_0x260db3+'&registerFailEmailTitle='+_0x56c18b[_0x3c7026(0x1f5)]+_0x3c7026(0x21a)+_0x56c18b['registerFailEmailTeamName']);}}async[_0x58d0ab(0x1af)](_0xe6adf4,_0x2e4a21){const _0x382181=_0x58d0ab,{id:_0x3ac91b,client:_0x378235,role:_0x4210b0}=_0xe6adf4[_0x382181(0x1b5)];if(_0x378235&&Number(_0x378235)>0x0)throw new common_1['HttpException'](_0x382181(0x1d6),common_1['HttpStatus']['BAD_REQUEST']);if(_0x4210b0==='admin')throw new common_1[(_0x382181(0x1fb))](_0x382181(0x1e2),common_1[_0x382181(0x217)][_0x382181(0x1bc)]);const _0x2ed77f=await this[_0x382181(0x1ee)][_0x382181(0x1cc)](_0x3ac91b,_0x2e4a21[_0x382181(0x1c6)]);if(!_0x2ed77f)throw new common_1['HttpException'](_0x382181(0x1a8),common_1[_0x382181(0x217)][_0x382181(0x1bc)]);return this['userService']['updateUserPassword'](_0x3ac91b,_0x2e4a21['password']),'密码修改成功';}async['updatePassByOther'](_0x822612,_0x585cf9){const _0x2cb874=_0x58d0ab,{id:_0x5867e4,client:_0xd8a428}=_0x822612[_0x2cb874(0x1b5)];if(!_0xd8a428)throw new common_1[(_0x2cb874(0x1fb))](_0x2cb874(0x1e1),common_1[_0x2cb874(0x217)]['BAD_REQUEST']);return this['userService'][_0x2cb874(0x1bd)](_0x5867e4,_0x585cf9[_0x2cb874(0x1f1)]),_0x2cb874(0x214);}[_0x58d0ab(0x1e0)](){const _0x1211c0=_0x58d0ab;let _0x357be2;const _0x42beed=os[_0x1211c0(0x197)]();Object[_0x1211c0(0x1e5)](_0x42beed)[_0x1211c0(0x219)](_0x5e4930=>{const _0x6fe2f4=_0x1211c0,_0x36506e=_0x42beed[_0x5e4930];for(let _0x4b7c33=0x0;_0x4b7c33<_0x36506e['length'];_0x4b7c33++){const _0x11de26=_0x36506e[_0x4b7c33];if(_0x11de26[_0x6fe2f4(0x202)]===_0x6fe2f4(0x1fe)&&_0x11de26[_0x6fe2f4(0x1cf)]!==_0x6fe2f4(0x1db)&&!_0x11de26['internal']){_0x357be2=_0x11de26[_0x6fe2f4(0x1cf)];break;}}}),this[_0x1211c0(0x1ad)]=_0x357be2;}async[_0x58d0ab(0x1b4)](_0x4dd25c){const _0x452006=_0x58d0ab,_0x47a0bf=await this[_0x452006(0x198)][_0x452006(0x1d4)](),{color:color=_0x452006(0x1f7)}=_0x4dd25c,_0x5ea70b=svgCaptcha[_0x452006(0x1b6)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x339718=_0x5ea70b[_0x452006(0x203)],_0x319ff6=(0x0,utils_1[_0x452006(0x1c7)])(),_0x1b47b6=_0x47a0bf+_0x452006(0x19e)+_0x319ff6;return await this[_0x452006(0x20b)][_0x452006(0x1ba)]({'key':_0x1b47b6,'val':_0x5ea70b[_0x452006(0x203)]},0x5*0x3c),{'svgCode':_0x5ea70b[_0x452006(0x1be)],'code':_0x319ff6};}async[_0x58d0ab(0x1e7)](_0x53d426){const _0x16b00a=_0x58d0ab;await this['verificationService'][_0x16b00a(0x192)](_0x53d426);const {phone:_0x4c03ae}=_0x53d426,_0x5f0733=await this[_0x16b00a(0x198)][_0x16b00a(0x1d4)](),_0x39e16f=_0x5f0733+_0x16b00a(0x1eb)+_0x4c03ae,_0x1d36e5=await this[_0x16b00a(0x20b)][_0x16b00a(0x1aa)](_0x39e16f);if(_0x1d36e5&&_0x1d36e5>0x0)throw new common_1[(_0x16b00a(0x1fb))](_0x1d36e5+_0x16b00a(0x1ed),common_1['HttpStatus'][_0x16b00a(0x1bc)]);const _0x489e00=(0x0,utils_1[_0x16b00a(0x1fa)])(),_0x3d5b97={'phone':_0x4c03ae,'code':_0x489e00};return await this[_0x16b00a(0x1de)][_0x16b00a(0x1e8)](_0x3d5b97),await this[_0x16b00a(0x20b)][_0x16b00a(0x1ba)]({'key':_0x39e16f,'val':_0x489e00},0x1*0x3c),_0x16b00a(0x1a4);}[_0x58d0ab(0x1ae)](_0xc8034d){const _0x5ed0c8=_0x58d0ab,_0x3abdd9=this[_0x5ed0c8(0x1c3)][_0x5ed0c8(0x216)]({'username':'游客'+_0xc8034d,'id':_0xc8034d,'email':_0xc8034d+_0x5ed0c8(0x1e4),'role':'visitor','openId':null,'client':null});return _0x3abdd9;}};AuthService=__decorate([(0x0,common_1[_0x58d0ab(0x1b9)])(),__param(0x0,(0x0,typeorm_2[_0x58d0ab(0x1f9)])(config_entity_1[_0x58d0ab(0x1f2)])),__metadata(_0x58d0ab(0x200),[typeorm_1['Repository'],user_service_1[_0x58d0ab(0x1fc)],jwt_1[_0x58d0ab(0x1c4)],mailer_service_1[_0x58d0ab(0x19d)],verification_service_1[_0x58d0ab(0x1d1)],userBalance_service_1[_0x58d0ab(0x215)],redisCache_service_1[_0x58d0ab(0x1dc)],globalConfig_service_1[_0x58d0ab(0x193)]])],AuthService),exports['AuthService']=AuthService;function _0x2f5b(){const _0x655729=['data','/api/auth/registerError?message=','2ysrGEo','redirect','verifyCode','jwtService','JwtService','userId','oldPassword','createRandomUid','2379710YRCIyb','3806828HXnPRv','avatar','createUser','verifyUserPassword','verifyUserCredentials','../mailer/mailer.service','address','loginByPhone','VerificationService','configVal','UserStatusEnum','getNamespace','__metadata','无权此操作、请联系管理员！','&username=','error:\x20','length','__param','127.0.0.1','RedisCacheService','../globalConfig/config.entity','verificationService','getClientIp','getIp','无权此操作！','非法操作、请联系管理员！','1086IINgAq','@nine.com','keys','账户已被激活过','sendPhoneCode','sendPhoneCodeWithQcloud','@nestjs/jwt','../userBalance/userBalance.service',':PHONECODE:','defineProperty','秒内不得重复发送短信！','userService','208170gYTVeF','saveToken','password','ConfigEntity','2811177wcwHdc','@nestjs/typeorm','registerFailEmailTitle','function','#fff','registerByPhone','InjectRepository','createRandomCode','HttpException','UserService','object','IPv4','getUserStatus','design:paramtypes','getConfigs','family','text','bcryptjs','response','registerSuccessEmailTeamName','configKey','../redisCache/redisCache.service','decorate','register','redisCacheService','&email=','log','configEntity','qureyUserInfoByInviteCode','Registration','savaLoginIp','验证码类型错误','577072vkndNB','密码修改成功','UserBalanceService','sign','HttpStatus','1225725QyEGHE','forEach','&registerFailEmailTeamName=','registerSuccessEmailTitle','ACTIVE','queryUserInfoById','&registerSuccessEmaileAppend=','registerSuccessEmaileAppend','mailerService','verifyCaptcha','GlobalConfigService','padStart','verifyUserRegisterByPhone','VerificationEnum','networkInterfaces','globalConfigService','15911NqLvnz','toString','验证码已过期、请重新发送！','../../common/constants/verification.constant','MailerService',':CAPTCHA:','reduce','addBalanceToNewUser','userBalanceService','createUserAndVerifycation','registerFailEmailTeamName','验证码发送成功、请填写验证码完成注册！','getInfo','../verification/verification.service','loginByOpenId','旧密码错误、请检查提交','get','ttl','../../common/constants/user.constant','updateUserStatus','ipAddress','createTokenFromFingerprint','updatePassword','svg-captcha','@nestjs/common','AuthService','typeorm','captcha','user','createMathExpr','metadata','__decorate','Injectable','set','__esModule','BAD_REQUEST','updateUserPassword'];_0x2f5b=function(){return _0x655729;};return _0x2f5b();}