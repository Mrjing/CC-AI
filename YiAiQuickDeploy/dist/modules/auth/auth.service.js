'use strict';function _0x62eb(){const _0x525104=['verifyUserPassword','globalConfigService','非法操作、请联系管理员！','keys','find','InjectRepository','reduce','秒内不得重复发送短信！','&registerSuccessEmailTeamName=','9HRRqna','HttpStatus','getUserInfo','redirect','savaLoginIp','UserStatusEnum','avatar','visitor','updatePassword','getNamespace','旧密码错误、请检查提交','无权此操作！','error:\x20','updateUserPassword','16075352wsORdD','length','&registerSuccessEmailTitle=','decorate','client','BAD_REQUEST','response','bcryptjs','1103591pKLoDF','qureyUserInfoByInviteCode','registerSuccessEmailTitle','createTokenFromFingerprint','address','&registerFailEmailTeamName=','log','AuthService','networkInterfaces','userId','loginByPhone','createRandomCode','redisCacheService','padStart','addBalanceToNewUser','userService','VerificationService','VerificationEnum','userDefautlAvatar','127.0.0.1','internal','__esModule','verificationService','svg-captcha','jwtService','GlobalConfigService','getOwnPropertyDescriptor','createUser','&username=','get','&registerFailEmailTitle=','验证码填写错误、请重新输入！','验证码发送成功、请填写验证码完成注册！','../verification/verification.service','verifyCode','password','configVal','@nestjs/typeorm','user','createRandomUid','register','design:paramtypes','mailerService','密码修改成功','../user/user.service','../../common/constants/verification.constant','../redisCache/redisCache.service','family','forEach','__decorate','sign','/api/auth/registerSuccess?id=','__metadata','text','activateAccount','__param','Injectable','hashSync','verifyCaptcha','5885978HwXqPL','userBalanceService','ACTIVE','loginByOpenId','saveToken','updatePassByOther','../../common/constants/user.constant','账户已被激活过','../../common/utils','toString','187340xBXThV','getIp','admin','getInfo','onModuleInit','configEntity','HttpException','4350000VXNqjH','registerFailEmailTitle','sendPhoneCode','验证码已过期、请重新发送！','1925000pACBmm','ConfigEntity','Repository','../userBalance/userBalance.service','registerFailEmailTeamName','&registerSuccessEmaileAppend=','function','registerSuccessEmaileAppend','UserBalanceService','@nine.com','metadata','object','getClientIp','Registration','7279974lOCLYM','MailerService','无权此操作、请联系管理员！','defineProperty','@nestjs/common','registerSuccessEmailTeamName',':CAPTCHA:','IPv4','UserService','set','../globalConfig/globalConfig.service'];_0x62eb=function(){return _0x525104;};return _0x62eb();}function _0x1bea(_0x32129f,_0x5c94dd){const _0x62ebe1=_0x62eb();return _0x1bea=function(_0x1beab4,_0x32873c){_0x1beab4=_0x1beab4-0x17f;let _0x5dc0b7=_0x62ebe1[_0x1beab4];return _0x5dc0b7;},_0x1bea(_0x32129f,_0x5c94dd);}const _0x2c7274=_0x1bea;(function(_0xf0a28c,_0x353349){const _0x4ae423=_0x1bea,_0x21ef44=_0xf0a28c();while(!![]){try{const _0x2973c7=-parseInt(_0x4ae423(0x1ba))/0x1+-parseInt(_0x4ae423(0x1ff))/0x2*(parseInt(_0x4ae423(0x1a4))/0x3)+-parseInt(_0x4ae423(0x182))/0x4+parseInt(_0x4ae423(0x206))/0x5+-parseInt(_0x4ae423(0x190))/0x6+parseInt(_0x4ae423(0x1f5))/0x7+parseInt(_0x4ae423(0x1b2))/0x8;if(_0x2973c7===_0x353349)break;else _0x21ef44['push'](_0x21ef44['shift']());}catch(_0x15cb5a){_0x21ef44['push'](_0x21ef44['shift']());}}}(_0x62eb,0x9c845));var __decorate=this&&this[_0x2c7274(0x1eb)]||function(_0x41a57a,_0x33f9d3,_0x40864b,_0x123331){const _0x595df7=_0x2c7274;var _0x4f6330=arguments[_0x595df7(0x1b3)],_0x6a4c3c=_0x4f6330<0x3?_0x33f9d3:_0x123331===null?_0x123331=Object[_0x595df7(0x1d4)](_0x33f9d3,_0x40864b):_0x123331,_0x5cfe7f;if(typeof Reflect===_0x595df7(0x18d)&&typeof Reflect[_0x595df7(0x1b5)]===_0x595df7(0x188))_0x6a4c3c=Reflect['decorate'](_0x41a57a,_0x33f9d3,_0x40864b,_0x123331);else{for(var _0x1c0d57=_0x41a57a['length']-0x1;_0x1c0d57>=0x0;_0x1c0d57--)if(_0x5cfe7f=_0x41a57a[_0x1c0d57])_0x6a4c3c=(_0x4f6330<0x3?_0x5cfe7f(_0x6a4c3c):_0x4f6330>0x3?_0x5cfe7f(_0x33f9d3,_0x40864b,_0x6a4c3c):_0x5cfe7f(_0x33f9d3,_0x40864b))||_0x6a4c3c;}return _0x4f6330>0x3&&_0x6a4c3c&&Object['defineProperty'](_0x33f9d3,_0x40864b,_0x6a4c3c),_0x6a4c3c;},__metadata=this&&this[_0x2c7274(0x1ee)]||function(_0x3bbfae,_0x2b27f7){const _0x5d40fc=_0x2c7274;if(typeof Reflect===_0x5d40fc(0x18d)&&typeof Reflect[_0x5d40fc(0x18c)]==='function')return Reflect[_0x5d40fc(0x18c)](_0x3bbfae,_0x2b27f7);},__param=this&&this[_0x2c7274(0x1f1)]||function(_0x50bac4,_0x2d35a7){return function(_0x47d26b,_0x3d771b){_0x2d35a7(_0x47d26b,_0x3d771b,_0x50bac4);};};Object[_0x2c7274(0x193)](exports,_0x2c7274(0x1cf),{'value':!![]}),exports[_0x2c7274(0x1c1)]=void 0x0;const globalConfig_service_1=require(_0x2c7274(0x19a)),verification_constant_1=require(_0x2c7274(0x1e7)),verification_service_1=require(_0x2c7274(0x1db)),common_1=require(_0x2c7274(0x194)),jwt_1=require('@nestjs/jwt'),user_service_1=require(_0x2c7274(0x1e6)),mailer_service_1=require('../mailer/mailer.service'),user_constant_1=require(_0x2c7274(0x1fb)),userBalance_service_1=require(_0x2c7274(0x185)),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require('typeorm'),typeorm_2=require(_0x2c7274(0x1df)),utils_1=require(_0x2c7274(0x1fd)),os=require('os'),redisCache_service_1=require(_0x2c7274(0x1e8)),svgCaptcha=require(_0x2c7274(0x1d1)),bcrypt=require(_0x2c7274(0x1b9));let AuthService=class AuthService{constructor(_0x47a3d9,_0x347346,_0x22ee7b,_0x2c102b,_0x512b6f,_0xc68785,_0x1890a4,_0x21b487){const _0x58b5db=_0x2c7274;this['configEntity']=_0x47a3d9,this['userService']=_0x347346,this[_0x58b5db(0x1d2)]=_0x22ee7b,this[_0x58b5db(0x1e4)]=_0x2c102b,this[_0x58b5db(0x1d0)]=_0x512b6f,this[_0x58b5db(0x1f6)]=_0xc68785,this[_0x58b5db(0x1c6)]=_0x1890a4,this[_0x58b5db(0x19c)]=_0x21b487;}async[_0x2c7274(0x203)](){const _0x1a4ef1=_0x2c7274;this[_0x1a4ef1(0x200)]();}async[_0x2c7274(0x1e2)](_0x30e148,_0x994b4c){const _0x1c91fa=_0x2c7274;await this['verificationService'][_0x1c91fa(0x1f4)](_0x30e148);const _0x53cc33=await this['userService']['createUserAndVerifycation'](_0x30e148,_0x994b4c),{username:_0x5b0f56,email:_0x1f779,client:_0x537998,id:_0x549640}=_0x53cc33,_0x22cb04={'username':_0x5b0f56,'email':_0x1f779,'id':_0x549640};return _0x537998&&(_0x22cb04[_0x1c91fa(0x1b6)]=_0x537998),_0x22cb04;}async['registerByPhone'](_0x53d9fb,_0x104bd9){const _0x25068a=_0x2c7274,{username:_0xcdab24,password:_0x9a6b34,phone:_0xd6cd4,phoneCode:_0x1e4724,invitedBy:_0x4f2b99}=_0x53d9fb;await this[_0x25068a(0x1c9)]['verifyUserRegisterByPhone'](_0x53d9fb);const _0x5981a9=await this['globalConfigService'][_0x25068a(0x1ad)](),_0x4c951c=_0x5981a9+':PHONECODE:'+_0xd6cd4,_0x5a0c7f=await this['redisCacheService'][_0x25068a(0x1d7)]({'key':_0x4c951c});if(!_0x5a0c7f)throw new common_1[(_0x25068a(0x205))](_0x25068a(0x181),common_1[_0x25068a(0x1a5)][_0x25068a(0x1b7)]);if(_0x1e4724!==_0x5a0c7f)throw new common_1[(_0x25068a(0x205))](_0x25068a(0x1d9),common_1[_0x25068a(0x1a5)][_0x25068a(0x1b7)]);const _0x13b251=(0x0,utils_1[_0x25068a(0x1e1)])()+_0x25068a(0x18b),_0x2d80cb={'username':_0xcdab24,'password':_0x9a6b34,'phone':_0xd6cd4,'invitedBy':_0x4f2b99,'email':_0x13b251,'status':user_constant_1['UserStatusEnum'][_0x25068a(0x1f7)]},_0x1e9987=await this[_0x25068a(0x19c)]['getConfigs']([_0x25068a(0x1cc)]);_0x2d80cb[_0x25068a(0x1aa)]=_0x1e9987;const _0x43ba42=bcrypt[_0x25068a(0x1f3)](_0x9a6b34,0xa);_0x2d80cb['password']=_0x43ba42;const _0x5d1e05=await this[_0x25068a(0x1c9)][_0x25068a(0x1d5)](_0x2d80cb);let _0x5b17ff;_0x4f2b99&&(_0x5b17ff=await this['userService'][_0x25068a(0x1bb)](_0x4f2b99));await this[_0x25068a(0x1f6)][_0x25068a(0x1c8)](_0x5d1e05['id'],_0x5b17ff===null||_0x5b17ff===void 0x0?void 0x0:_0x5b17ff['id']);return;}async['login'](_0x5c5491,_0x41280f){const _0x3b1371=_0x2c7274,_0x450363=await this[_0x3b1371(0x1c9)]['verifyUserCredentials'](_0x5c5491),{username:_0x224026,id:_0x5de4ca,email:_0xe7aae0,role:_0x115bc7,openId:_0xda2645,client:_0x189bfd}=_0x450363,_0x548364=(0x0,utils_1[_0x3b1371(0x18e)])(_0x41280f);await this[_0x3b1371(0x1c9)][_0x3b1371(0x1a8)](_0x5de4ca,_0x548364);const _0x2b7fda=await this[_0x3b1371(0x1d2)][_0x3b1371(0x1ec)]({'username':_0x224026,'id':_0x5de4ca,'email':_0xe7aae0,'role':_0x115bc7,'openId':_0xda2645,'client':_0x189bfd});return await this[_0x3b1371(0x1c6)][_0x3b1371(0x1f9)](_0x5de4ca,_0x2b7fda),_0x2b7fda;}async[_0x2c7274(0x1c4)](_0x3269aa,_0xb23053){const _0x5d8200=_0x2c7274,_0x248d1e=await this['userService']['verifyUserCredentials'](_0x3269aa),{username:_0x4828fe,id:_0x22d300,email:_0x5376ba,role:_0x809354,openId:_0x5698be,client:_0x47700c}=_0x248d1e,_0x27c33e=(0x0,utils_1[_0x5d8200(0x18e)])(_0xb23053);await this[_0x5d8200(0x1c9)][_0x5d8200(0x1a8)](_0x22d300,_0x27c33e);const {phone:_0x44dfc2}=_0x3269aa,_0x59a884=await this['jwtService']['sign']({'username':_0x4828fe,'id':_0x22d300,'email':_0x5376ba,'role':_0x809354,'openId':_0x5698be,'client':_0x47700c,'phone':_0x44dfc2});return await this[_0x5d8200(0x1c6)][_0x5d8200(0x1f9)](_0x22d300,_0x59a884),_0x59a884;}async[_0x2c7274(0x1f8)](_0x4a52ed,_0x2df9f1){const _0x2a9192=_0x2c7274,{status:_0x36cd74}=_0x4a52ed;if(_0x36cd74!==user_constant_1[_0x2a9192(0x1a9)]['ACTIVE'])throw new common_1[(_0x2a9192(0x205))](user_constant_1['UserStatusErrMsg'][_0x36cd74],common_1[_0x2a9192(0x1a5)][_0x2a9192(0x1b7)]);const {username:_0x5f6f67,id:_0x27b773,email:_0x167d32,role:_0x3a5377,openId:_0x47934e,client:_0x139b44}=_0x4a52ed,_0x57cd81=(0x0,utils_1[_0x2a9192(0x18e)])(_0x2df9f1);await this['userService']['savaLoginIp'](_0x27b773,_0x57cd81);const _0x50938c=await this['jwtService'][_0x2a9192(0x1ec)]({'username':_0x5f6f67,'id':_0x27b773,'email':_0x167d32,'role':_0x3a5377,'openId':_0x47934e,'client':_0x139b44});return await this[_0x2a9192(0x1c6)][_0x2a9192(0x1f9)](_0x27b773,_0x50938c),_0x50938c;}async[_0x2c7274(0x202)](_0x3af12d){const _0x353b92=_0x2c7274,{id:_0x36990f}=_0x3af12d[_0x353b92(0x1e0)];return await this[_0x353b92(0x1c9)][_0x353b92(0x1a6)](_0x36990f);}async[_0x2c7274(0x1f0)](_0x345fee,_0x16cd4a){const _0x35fff3=_0x2c7274,_0x396a7e=await this[_0x35fff3(0x204)][_0x35fff3(0x19f)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x35fff3(0x1bc),_0x35fff3(0x195),'registerSuccessEmaileAppend',_0x35fff3(0x17f),_0x35fff3(0x186)])}}),_0x16426d=_0x396a7e[_0x35fff3(0x1a1)]((_0x3f038c,_0x4b7658)=>{const _0x12dd90=_0x35fff3;return _0x3f038c[_0x4b7658['configKey']]=_0x4b7658[_0x12dd90(0x1de)],_0x3f038c;},{});try{const _0xc0b899=await this[_0x35fff3(0x1d0)][_0x35fff3(0x1dc)](_0x345fee,verification_constant_1['VerificationEnum'][_0x35fff3(0x18f)]),{type:_0x14266a,userId:_0x4c2b0e}=_0xc0b899;if(_0x14266a!==verification_constant_1[_0x35fff3(0x1cb)][_0x35fff3(0x18f)])throw new common_1[(_0x35fff3(0x205))]('验证码类型错误',common_1['HttpStatus']['BAD_REQUEST']);const _0x52cf9d=await this[_0x35fff3(0x1c9)]['getUserStatus'](_0x4c2b0e);if(_0x52cf9d===user_constant_1[_0x35fff3(0x1a9)]['ACTIVE'])throw new common_1[(_0x35fff3(0x205))](_0x35fff3(0x1fc),common_1[_0x35fff3(0x1a5)]['BAD_REQUEST']);await this['userService']['updateUserStatus'](_0xc0b899['userId'],user_constant_1[_0x35fff3(0x1a9)][_0x35fff3(0x1f7)]);const _0x35b718=await this[_0x35fff3(0x1c9)]['queryUserInfoById'](_0xc0b899[_0x35fff3(0x1c3)]),{username:_0x48ae8e,email:_0x51db9e,id:_0x266e9e,invitedBy:_0x31e841}=_0x35b718;let _0x70b29b;_0x31e841&&(_0x70b29b=await this[_0x35fff3(0x1c9)][_0x35fff3(0x1bb)](_0x31e841)),await this[_0x35fff3(0x1f6)][_0x35fff3(0x1c8)](_0x266e9e,_0x70b29b===null||_0x70b29b===void 0x0?void 0x0:_0x70b29b['id']),_0x16cd4a[_0x35fff3(0x1a7)](_0x35fff3(0x1ed)+_0x266e9e[_0x35fff3(0x1fe)]()[_0x35fff3(0x1c7)](0x4,'0')+_0x35fff3(0x1d6)+_0x48ae8e+'&email='+_0x51db9e+_0x35fff3(0x1b4)+_0x16426d['registerSuccessEmailTitle']+_0x35fff3(0x1a3)+_0x16426d[_0x35fff3(0x195)]+_0x35fff3(0x187)+_0x16426d[_0x35fff3(0x189)]);}catch(_0x21449c){console[_0x35fff3(0x1c0)](_0x35fff3(0x1b0),_0x21449c);const _0x42b418=_0x21449c[_0x35fff3(0x1b8)];_0x16cd4a['redirect']('/api/auth/registerError?message='+_0x42b418+_0x35fff3(0x1d8)+_0x16426d[_0x35fff3(0x17f)]+_0x35fff3(0x1bf)+_0x16426d['registerFailEmailTeamName']);}}async[_0x2c7274(0x1ac)](_0xe15365,_0x2ecd64){const _0x108e09=_0x2c7274,{id:_0x3183ea,client:_0x2747d8,role:_0x56ccd8}=_0xe15365['user'];if(_0x2747d8&&Number(_0x2747d8)>0x0)throw new common_1[(_0x108e09(0x205))](_0x108e09(0x192),common_1[_0x108e09(0x1a5)][_0x108e09(0x1b7)]);if(_0x56ccd8===_0x108e09(0x201))throw new common_1[(_0x108e09(0x205))](_0x108e09(0x19d),common_1[_0x108e09(0x1a5)][_0x108e09(0x1b7)]);const _0x4b648e=await this[_0x108e09(0x1c9)][_0x108e09(0x19b)](_0x3183ea,_0x2ecd64['oldPassword']);if(!_0x4b648e)throw new common_1[(_0x108e09(0x205))](_0x108e09(0x1ae),common_1[_0x108e09(0x1a5)][_0x108e09(0x1b7)]);return this[_0x108e09(0x1c9)][_0x108e09(0x1b1)](_0x3183ea,_0x2ecd64[_0x108e09(0x1dd)]),_0x108e09(0x1e5);}async[_0x2c7274(0x1fa)](_0x1657c3,_0x20ee24){const _0x582c0d=_0x2c7274,{id:_0x166ef4,client:_0x3fed2e}=_0x1657c3[_0x582c0d(0x1e0)];if(!_0x3fed2e)throw new common_1[(_0x582c0d(0x205))](_0x582c0d(0x1af),common_1[_0x582c0d(0x1a5)][_0x582c0d(0x1b7)]);return this[_0x582c0d(0x1c9)]['updateUserPassword'](_0x166ef4,_0x20ee24[_0x582c0d(0x1dd)]),_0x582c0d(0x1e5);}[_0x2c7274(0x200)](){const _0x482556=_0x2c7274;let _0x2d5d96;const _0x5f37d4=os[_0x482556(0x1c2)]();Object[_0x482556(0x19e)](_0x5f37d4)[_0x482556(0x1ea)](_0x1c6b38=>{const _0x4d5a1d=_0x482556,_0xb271bd=_0x5f37d4[_0x1c6b38];for(let _0x5cf19b=0x0;_0x5cf19b<_0xb271bd[_0x4d5a1d(0x1b3)];_0x5cf19b++){const _0x433bcc=_0xb271bd[_0x5cf19b];if(_0x433bcc[_0x4d5a1d(0x1e9)]===_0x4d5a1d(0x197)&&_0x433bcc[_0x4d5a1d(0x1be)]!==_0x4d5a1d(0x1cd)&&!_0x433bcc[_0x4d5a1d(0x1ce)]){_0x2d5d96=_0x433bcc[_0x4d5a1d(0x1be)];break;}}}),this['ipAddress']=_0x2d5d96;}async['captcha'](_0xe3dfb9){const _0x59fe92=_0x2c7274,_0x5b3522=await this['globalConfigService'][_0x59fe92(0x1ad)](),{color:color='#fff'}=_0xe3dfb9,_0x51f804=svgCaptcha['createMathExpr']({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x58f181=_0x51f804[_0x59fe92(0x1ef)],_0x3f1838=(0x0,utils_1[_0x59fe92(0x1e1)])(),_0x320972=_0x5b3522+_0x59fe92(0x196)+_0x3f1838;return await this[_0x59fe92(0x1c6)][_0x59fe92(0x199)]({'key':_0x320972,'val':_0x51f804[_0x59fe92(0x1ef)]},0x5*0x3c),{'svgCode':_0x51f804['data'],'code':_0x3f1838};}async[_0x2c7274(0x180)](_0x1a6b9b){const _0x50f492=_0x2c7274;await this[_0x50f492(0x1d0)][_0x50f492(0x1f4)](_0x1a6b9b);const {phone:_0x347abe}=_0x1a6b9b,_0x1ba151=await this[_0x50f492(0x19c)][_0x50f492(0x1ad)](),_0x1db240=_0x1ba151+':PHONECODE:'+_0x347abe,_0x24be3a=await this[_0x50f492(0x1c6)]['ttl'](_0x1db240);if(_0x24be3a&&_0x24be3a>0x0)throw new common_1['HttpException'](_0x24be3a+_0x50f492(0x1a2),common_1[_0x50f492(0x1a5)][_0x50f492(0x1b7)]);const _0xd90767=(0x0,utils_1[_0x50f492(0x1c5)])(),_0x59036f={'phone':_0x347abe,'code':_0xd90767};return await this['verificationService']['sendPhoneCodeWithQcloud'](_0x59036f),await this[_0x50f492(0x1c6)][_0x50f492(0x199)]({'key':_0x1db240,'val':_0xd90767},0x1*0x3c),_0x50f492(0x1da);}[_0x2c7274(0x1bd)](_0x25e519){const _0x5ae21d=_0x2c7274,_0x2bd68f=this[_0x5ae21d(0x1d2)][_0x5ae21d(0x1ec)]({'username':'游客'+_0x25e519,'id':_0x25e519,'email':_0x25e519+_0x5ae21d(0x18b),'role':_0x5ae21d(0x1ab),'openId':null,'client':null});return _0x2bd68f;}};AuthService=__decorate([(0x0,common_1[_0x2c7274(0x1f2)])(),__param(0x0,(0x0,typeorm_2[_0x2c7274(0x1a0)])(config_entity_1[_0x2c7274(0x183)])),__metadata(_0x2c7274(0x1e3),[typeorm_1[_0x2c7274(0x184)],user_service_1[_0x2c7274(0x198)],jwt_1['JwtService'],mailer_service_1[_0x2c7274(0x191)],verification_service_1[_0x2c7274(0x1ca)],userBalance_service_1[_0x2c7274(0x18a)],redisCache_service_1['RedisCacheService'],globalConfig_service_1[_0x2c7274(0x1d3)]])],AuthService),exports[_0x2c7274(0x1c1)]=AuthService;