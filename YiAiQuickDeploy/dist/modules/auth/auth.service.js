'use strict';const _0xdb7749=_0x1036;function _0x1036(_0x3bf3a9,_0x5d81c8){const _0x45aeda=_0x45ae();return _0x1036=function(_0x103684,_0x743282){_0x103684=_0x103684-0xac;let _0xe3e34b=_0x45aeda[_0x103684];return _0xe3e34b;},_0x1036(_0x3bf3a9,_0x5d81c8);}(function(_0x5b7431,_0x57737f){const _0x44d350=_0x1036,_0x37a3b4=_0x5b7431();while(!![]){try{const _0x51ce4d=-parseInt(_0x44d350(0x11a))/0x1+-parseInt(_0x44d350(0x119))/0x2+-parseInt(_0x44d350(0xb3))/0x3+-parseInt(_0x44d350(0x12b))/0x4+parseInt(_0x44d350(0xf1))/0x5*(parseInt(_0x44d350(0xc3))/0x6)+-parseInt(_0x44d350(0x112))/0x7+parseInt(_0x44d350(0x106))/0x8*(parseInt(_0x44d350(0xe9))/0x9);if(_0x51ce4d===_0x57737f)break;else _0x37a3b4['push'](_0x37a3b4['shift']());}catch(_0x1da6d0){_0x37a3b4['push'](_0x37a3b4['shift']());}}}(_0x45ae,0xb2745));var __decorate=this&&this[_0xdb7749(0x130)]||function(_0x1ab6a4,_0x87d5b8,_0x5544fc,_0x336f10){const _0x3ebda8=_0xdb7749;var _0x3f99cc=arguments[_0x3ebda8(0x102)],_0x260557=_0x3f99cc<0x3?_0x87d5b8:_0x336f10===null?_0x336f10=Object[_0x3ebda8(0xee)](_0x87d5b8,_0x5544fc):_0x336f10,_0x393911;if(typeof Reflect===_0x3ebda8(0xd6)&&typeof Reflect[_0x3ebda8(0xf2)]===_0x3ebda8(0xff))_0x260557=Reflect['decorate'](_0x1ab6a4,_0x87d5b8,_0x5544fc,_0x336f10);else{for(var _0xaa545e=_0x1ab6a4[_0x3ebda8(0x102)]-0x1;_0xaa545e>=0x0;_0xaa545e--)if(_0x393911=_0x1ab6a4[_0xaa545e])_0x260557=(_0x3f99cc<0x3?_0x393911(_0x260557):_0x3f99cc>0x3?_0x393911(_0x87d5b8,_0x5544fc,_0x260557):_0x393911(_0x87d5b8,_0x5544fc))||_0x260557;}return _0x3f99cc>0x3&&_0x260557&&Object[_0x3ebda8(0xe2)](_0x87d5b8,_0x5544fc,_0x260557),_0x260557;},__metadata=this&&this[_0xdb7749(0xec)]||function(_0x4a0afa,_0x5b2e03){const _0x4ce502=_0xdb7749;if(typeof Reflect===_0x4ce502(0xd6)&&typeof Reflect['metadata']===_0x4ce502(0xff))return Reflect[_0x4ce502(0xf9)](_0x4a0afa,_0x5b2e03);},__param=this&&this['__param']||function(_0x313099,_0x1758ec){return function(_0x355df3,_0x42540b){_0x1758ec(_0x355df3,_0x42540b,_0x313099);};};Object[_0xdb7749(0xe2)](exports,_0xdb7749(0x111),{'value':!![]}),exports[_0xdb7749(0x109)]=void 0x0;const globalConfig_service_1=require(_0xdb7749(0x126)),verification_constant_1=require(_0xdb7749(0x117)),verification_service_1=require(_0xdb7749(0x107)),common_1=require(_0xdb7749(0xbc)),jwt_1=require(_0xdb7749(0xcf)),user_service_1=require(_0xdb7749(0xb2)),mailer_service_1=require(_0xdb7749(0x101)),user_constant_1=require('../../common/constants/user.constant'),userBalance_service_1=require(_0xdb7749(0xcb)),config_entity_1=require(_0xdb7749(0x116)),typeorm_1=require(_0xdb7749(0xe3)),typeorm_2=require(_0xdb7749(0xe6)),utils_1=require(_0xdb7749(0x103)),os=require('os'),redisCache_service_1=require(_0xdb7749(0xfa)),svgCaptcha=require(_0xdb7749(0x10d)),bcrypt=require('bcryptjs');function _0x45ae(){const _0x553068=['../globalConfig/globalConfig.service','visitor','internal','updatePassword','sign','934724sDqmYz','/api/auth/registerSuccess?id=','InjectRepository','&registerSuccessEmailTitle=',':CAPTCHA:','__decorate','verifyCode','&registerFailEmailTeamName=','verificationService','getUserInfo','saveToken','getNamespace','register','onModuleInit','../user/user.service','1716825SCdcXQ','updateUserStatus','userDefautlAvatar','getIp','find','set','redirect','非法操作、请联系管理员！','verifyUserCredentials','@nestjs/common','hashSync','password','秒内不得重复发送短信！','验证码填写错误、请重新输入！','activateAccount','configVal','6pdBjuY','UserStatusEnum','旧密码错误、请检查提交','Registration','updateUserPassword','verifyUserRegisterByPhone','ttl','127.0.0.1','../userBalance/userBalance.service','HttpStatus','验证码类型错误','queryUserInfoById','@nestjs/jwt','registerSuccessEmaileAppend','&registerSuccessEmaileAppend=','updatePassByOther','registerByPhone','error:\x20','text','object','#fff','networkInterfaces','VerificationEnum','createUserAndVerifycation','ConfigEntity','oldPassword','userService','response','无权此操作、请联系管理员！','createRandomCode','registerSuccessEmailTitle','defineProperty','typeorm','jwtService','ipAddress','@nestjs/typeorm',':PHONECODE:','addBalanceToNewUser','2727hZlUjf','HttpException','userId','__metadata','user','getOwnPropertyDescriptor','login','Repository','770930ovkfln','decorate','avatar','redisCacheService','ACTIVE','Injectable','userBalanceService','savaLoginIp','metadata','../redisCache/redisCache.service','@nine.com','验证码发送成功、请填写验证码完成注册！','padStart','configKey','function','&email=','../mailer/mailer.service','length','../../common/utils','registerFailEmailTeamName','GlobalConfigService','100328MdqYef','../verification/verification.service','JwtService','AuthService','验证码已过期、请重新发送！','verifyUserPassword','captcha','svg-captcha','BAD_REQUEST','&registerFailEmailTitle=','address','__esModule','7137438IBYaqO','sendPhoneCodeWithQcloud','RedisCacheService','qureyUserInfoByInviteCode','../globalConfig/config.entity','../../common/constants/verification.constant','registerSuccessEmailTeamName','594846GpaXZK','1100147pFqmKY','log','verifyCaptcha','createTokenFromFingerprint','loginByOpenId','getClientIp','密码修改成功','createRandomUid','mailerService','globalConfigService','reduce','IPv4'];_0x45ae=function(){return _0x553068;};return _0x45ae();}let AuthService=class AuthService{constructor(_0x377a89,_0x4e7d69,_0x34949b,_0x35def7,_0x5cdf76,_0x575fe0,_0x47671c,_0x25c80f){const _0x7cc0e=_0xdb7749;this['configEntity']=_0x377a89,this['userService']=_0x4e7d69,this[_0x7cc0e(0xe4)]=_0x34949b,this[_0x7cc0e(0x122)]=_0x35def7,this[_0x7cc0e(0xac)]=_0x5cdf76,this[_0x7cc0e(0xf7)]=_0x575fe0,this['redisCacheService']=_0x47671c,this[_0x7cc0e(0x123)]=_0x25c80f;}async[_0xdb7749(0xb1)](){const _0x34ff77=_0xdb7749;this[_0x34ff77(0xb6)]();}async[_0xdb7749(0xb0)](_0x4ff41d,_0x545650){const _0x220d56=_0xdb7749;await this[_0x220d56(0xac)]['verifyCaptcha'](_0x4ff41d);const _0xd089d3=await this[_0x220d56(0xdd)][_0x220d56(0xda)](_0x4ff41d,_0x545650),{username:_0x31e779,email:_0xc6efb1,client:_0x4590ed,id:_0x158484}=_0xd089d3,_0x1504c7={'username':_0x31e779,'email':_0xc6efb1,'id':_0x158484};return _0x4590ed&&(_0x1504c7['client']=_0x4590ed),_0x1504c7;}async[_0xdb7749(0xd3)](_0x33c988,_0x31669e){const _0x3f931a=_0xdb7749,{username:_0x501d5d,password:_0x42a189,phone:_0x317956,phoneCode:_0x30ca3a,invitedBy:_0x44aee0}=_0x33c988;await this['userService'][_0x3f931a(0xc8)](_0x33c988);const _0x274a52=await this[_0x3f931a(0x123)][_0x3f931a(0xaf)](),_0x438f7e=_0x274a52+':PHONECODE:'+_0x317956,_0x3a5b61=await this[_0x3f931a(0xf4)]['get']({'key':_0x438f7e});if(!_0x3a5b61)throw new common_1[(_0x3f931a(0xea))](_0x3f931a(0x10a),common_1['HttpStatus']['BAD_REQUEST']);if(_0x30ca3a!==_0x3a5b61)throw new common_1[(_0x3f931a(0xea))](_0x3f931a(0xc0),common_1['HttpStatus']['BAD_REQUEST']);const _0x52c5da=(0x0,utils_1[_0x3f931a(0x121)])()+_0x3f931a(0xfb),_0x10fbb1={'username':_0x501d5d,'password':_0x42a189,'phone':_0x317956,'invitedBy':_0x44aee0,'email':_0x52c5da,'status':user_constant_1[_0x3f931a(0xc4)]['ACTIVE']},_0x54c792=await this[_0x3f931a(0x123)]['getConfigs']([_0x3f931a(0xb5)]);_0x10fbb1[_0x3f931a(0xf3)]=_0x54c792;const _0x1d1327=bcrypt[_0x3f931a(0xbd)](_0x42a189,0xa);_0x10fbb1[_0x3f931a(0xbe)]=_0x1d1327;const _0x15d0c6=await this['userService']['createUser'](_0x10fbb1);let _0x13234a;_0x44aee0&&(_0x13234a=await this[_0x3f931a(0xdd)]['qureyUserInfoByInviteCode'](_0x44aee0));await this[_0x3f931a(0xf7)]['addBalanceToNewUser'](_0x15d0c6['id'],_0x13234a===null||_0x13234a===void 0x0?void 0x0:_0x13234a['id']);return;}async[_0xdb7749(0xef)](_0x55a6f1,_0x8f4c24){const _0x364057=_0xdb7749,_0x16f070=await this[_0x364057(0xdd)]['verifyUserCredentials'](_0x55a6f1),{username:_0x4bd5e8,id:_0x25728b,email:_0x21e72f,role:_0x4c4d75,openId:_0x263e08,client:_0x5539ed}=_0x16f070,_0x3587f0=(0x0,utils_1[_0x364057(0x11f)])(_0x8f4c24);await this[_0x364057(0xdd)]['savaLoginIp'](_0x25728b,_0x3587f0);const _0x36b25f=await this[_0x364057(0xe4)]['sign']({'username':_0x4bd5e8,'id':_0x25728b,'email':_0x21e72f,'role':_0x4c4d75,'openId':_0x263e08,'client':_0x5539ed});return await this[_0x364057(0xf4)][_0x364057(0xae)](_0x25728b,_0x36b25f),_0x36b25f;}async['loginByPhone'](_0x16494b,_0x4d6e9f){const _0x1f216b=_0xdb7749,_0x1e4bd1=await this[_0x1f216b(0xdd)][_0x1f216b(0xbb)](_0x16494b),{username:_0x38d8cc,id:_0x295bd0,email:_0x5c3e30,role:_0x3a4926,openId:_0x5108c8,client:_0x22ee61}=_0x1e4bd1,_0x8db0f6=(0x0,utils_1[_0x1f216b(0x11f)])(_0x4d6e9f);await this[_0x1f216b(0xdd)][_0x1f216b(0xf8)](_0x295bd0,_0x8db0f6);const {phone:_0x17c62c}=_0x16494b,_0x58fc26=await this[_0x1f216b(0xe4)]['sign']({'username':_0x38d8cc,'id':_0x295bd0,'email':_0x5c3e30,'role':_0x3a4926,'openId':_0x5108c8,'client':_0x22ee61,'phone':_0x17c62c});return await this[_0x1f216b(0xf4)][_0x1f216b(0xae)](_0x295bd0,_0x58fc26),_0x58fc26;}async[_0xdb7749(0x11e)](_0x8e638e,_0x584a6){const _0x355b23=_0xdb7749,{status:_0xba70a9}=_0x8e638e;if(_0xba70a9!==user_constant_1[_0x355b23(0xc4)]['ACTIVE'])throw new common_1['HttpException'](user_constant_1['UserStatusErrMsg'][_0xba70a9],common_1['HttpStatus'][_0x355b23(0x10e)]);const {username:_0x1b25e3,id:_0x2630df,email:_0x28327b,role:_0x10e223,openId:_0x39cbe7,client:_0x2b40fb}=_0x8e638e,_0x3a2d67=(0x0,utils_1[_0x355b23(0x11f)])(_0x584a6);await this[_0x355b23(0xdd)][_0x355b23(0xf8)](_0x2630df,_0x3a2d67);const _0x4114cb=await this[_0x355b23(0xe4)][_0x355b23(0x12a)]({'username':_0x1b25e3,'id':_0x2630df,'email':_0x28327b,'role':_0x10e223,'openId':_0x39cbe7,'client':_0x2b40fb});return await this[_0x355b23(0xf4)][_0x355b23(0xae)](_0x2630df,_0x4114cb),_0x4114cb;}async['getInfo'](_0x40cb4c){const _0x3978bf=_0xdb7749,{id:_0x50e3c9}=_0x40cb4c['user'];return await this[_0x3978bf(0xdd)][_0x3978bf(0xad)](_0x50e3c9);}async[_0xdb7749(0xc1)](_0x58c29b,_0x312dba){const _0x10e392=_0xdb7749,_0x5962ac=await this['configEntity'][_0x10e392(0xb7)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x10e392(0xe1),_0x10e392(0x118),_0x10e392(0xd0),'registerFailEmailTitle',_0x10e392(0x104)])}}),_0x29101f=_0x5962ac[_0x10e392(0x124)]((_0x112010,_0x379f36)=>{const _0x265151=_0x10e392;return _0x112010[_0x379f36[_0x265151(0xfe)]]=_0x379f36[_0x265151(0xc2)],_0x112010;},{});try{const _0x3f25ee=await this[_0x10e392(0xac)][_0x10e392(0x131)](_0x58c29b,verification_constant_1[_0x10e392(0xd9)][_0x10e392(0xc6)]),{type:_0xd3c163,userId:_0x1a7994}=_0x3f25ee;if(_0xd3c163!==verification_constant_1[_0x10e392(0xd9)][_0x10e392(0xc6)])throw new common_1[(_0x10e392(0xea))](_0x10e392(0xcd),common_1[_0x10e392(0xcc)]['BAD_REQUEST']);const _0x47e6b3=await this[_0x10e392(0xdd)]['getUserStatus'](_0x1a7994);if(_0x47e6b3===user_constant_1[_0x10e392(0xc4)][_0x10e392(0xf5)])throw new common_1[(_0x10e392(0xea))]('账户已被激活过',common_1[_0x10e392(0xcc)]['BAD_REQUEST']);await this[_0x10e392(0xdd)][_0x10e392(0xb4)](_0x3f25ee[_0x10e392(0xeb)],user_constant_1[_0x10e392(0xc4)][_0x10e392(0xf5)]);const _0x429037=await this[_0x10e392(0xdd)][_0x10e392(0xce)](_0x3f25ee[_0x10e392(0xeb)]),{username:_0x14525a,email:_0x5bf858,id:_0x1546cd,invitedBy:_0x500dc1}=_0x429037;let _0x34fb7d;_0x500dc1&&(_0x34fb7d=await this[_0x10e392(0xdd)][_0x10e392(0x115)](_0x500dc1)),await this[_0x10e392(0xf7)][_0x10e392(0xe8)](_0x1546cd,_0x34fb7d===null||_0x34fb7d===void 0x0?void 0x0:_0x34fb7d['id']),_0x312dba['redirect'](_0x10e392(0x12c)+_0x1546cd['toString']()[_0x10e392(0xfd)](0x4,'0')+'&username='+_0x14525a+_0x10e392(0x100)+_0x5bf858+_0x10e392(0x12e)+_0x29101f[_0x10e392(0xe1)]+'&registerSuccessEmailTeamName='+_0x29101f[_0x10e392(0x118)]+_0x10e392(0xd1)+_0x29101f[_0x10e392(0xd0)]);}catch(_0xa30409){console[_0x10e392(0x11b)](_0x10e392(0xd4),_0xa30409);const _0x4cb1b9=_0xa30409[_0x10e392(0xde)];_0x312dba[_0x10e392(0xb9)]('/api/auth/registerError?message='+_0x4cb1b9+_0x10e392(0x10f)+_0x29101f['registerFailEmailTitle']+_0x10e392(0x132)+_0x29101f['registerFailEmailTeamName']);}}async[_0xdb7749(0x129)](_0x211021,_0x50da4a){const _0x4f6dbe=_0xdb7749,{id:_0xf20142,client:_0x31f634,role:_0x1585a1}=_0x211021[_0x4f6dbe(0xed)];if(_0x31f634&&Number(_0x31f634)>0x0)throw new common_1[(_0x4f6dbe(0xea))](_0x4f6dbe(0xdf),common_1[_0x4f6dbe(0xcc)][_0x4f6dbe(0x10e)]);if(_0x1585a1==='admin')throw new common_1[(_0x4f6dbe(0xea))](_0x4f6dbe(0xba),common_1[_0x4f6dbe(0xcc)][_0x4f6dbe(0x10e)]);const _0x3f061c=await this[_0x4f6dbe(0xdd)][_0x4f6dbe(0x10b)](_0xf20142,_0x50da4a[_0x4f6dbe(0xdc)]);if(!_0x3f061c)throw new common_1[(_0x4f6dbe(0xea))](_0x4f6dbe(0xc5),common_1[_0x4f6dbe(0xcc)]['BAD_REQUEST']);return this['userService']['updateUserPassword'](_0xf20142,_0x50da4a[_0x4f6dbe(0xbe)]),_0x4f6dbe(0x120);}async[_0xdb7749(0xd2)](_0x311ef3,_0x4ae726){const _0x1b7b76=_0xdb7749,{id:_0x55ff28,client:_0x58d851}=_0x311ef3[_0x1b7b76(0xed)];if(!_0x58d851)throw new common_1[(_0x1b7b76(0xea))]('无权此操作！',common_1[_0x1b7b76(0xcc)]['BAD_REQUEST']);return this[_0x1b7b76(0xdd)][_0x1b7b76(0xc7)](_0x55ff28,_0x4ae726['password']),_0x1b7b76(0x120);}[_0xdb7749(0xb6)](){const _0x4cecfc=_0xdb7749;let _0x41945b;const _0x412adc=os[_0x4cecfc(0xd8)]();Object['keys'](_0x412adc)['forEach'](_0x340e4d=>{const _0x58ef8a=_0x4cecfc,_0x515521=_0x412adc[_0x340e4d];for(let _0x1d5e5b=0x0;_0x1d5e5b<_0x515521[_0x58ef8a(0x102)];_0x1d5e5b++){const _0x14bb37=_0x515521[_0x1d5e5b];if(_0x14bb37['family']===_0x58ef8a(0x125)&&_0x14bb37[_0x58ef8a(0x110)]!==_0x58ef8a(0xca)&&!_0x14bb37[_0x58ef8a(0x128)]){_0x41945b=_0x14bb37[_0x58ef8a(0x110)];break;}}}),this[_0x4cecfc(0xe5)]=_0x41945b;}async[_0xdb7749(0x10c)](_0x2b2e8e){const _0x4b0966=_0xdb7749,_0x3d3e5d=await this[_0x4b0966(0x123)]['getNamespace'](),{color:color=_0x4b0966(0xd7)}=_0x2b2e8e,_0x3f33fe=svgCaptcha['createMathExpr']({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x4140ec=_0x3f33fe[_0x4b0966(0xd5)],_0x3658f0=(0x0,utils_1[_0x4b0966(0x121)])(),_0x17fef4=_0x3d3e5d+_0x4b0966(0x12f)+_0x3658f0;return await this['redisCacheService'][_0x4b0966(0xb8)]({'key':_0x17fef4,'val':_0x3f33fe[_0x4b0966(0xd5)]},0x5*0x3c),{'svgCode':_0x3f33fe['data'],'code':_0x3658f0};}async['sendPhoneCode'](_0xf4dcd0){const _0xd93547=_0xdb7749;await this[_0xd93547(0xac)][_0xd93547(0x11c)](_0xf4dcd0);const {phone:_0x1b8049}=_0xf4dcd0,_0x55141e=await this['globalConfigService']['getNamespace'](),_0x3132a7=_0x55141e+_0xd93547(0xe7)+_0x1b8049,_0x389ea9=await this[_0xd93547(0xf4)][_0xd93547(0xc9)](_0x3132a7);if(_0x389ea9&&_0x389ea9>0x0)throw new common_1['HttpException'](_0x389ea9+_0xd93547(0xbf),common_1[_0xd93547(0xcc)][_0xd93547(0x10e)]);const _0x26b6b6=(0x0,utils_1[_0xd93547(0xe0)])(),_0x1d0072={'phone':_0x1b8049,'code':_0x26b6b6};return await this['verificationService'][_0xd93547(0x113)](_0x1d0072),await this[_0xd93547(0xf4)][_0xd93547(0xb8)]({'key':_0x3132a7,'val':_0x26b6b6},0x1*0x3c),_0xd93547(0xfc);}[_0xdb7749(0x11d)](_0x39b704){const _0x31dce6=_0xdb7749,_0x4bf022=this['jwtService'][_0x31dce6(0x12a)]({'username':'游客'+_0x39b704,'id':_0x39b704,'email':_0x39b704+_0x31dce6(0xfb),'role':_0x31dce6(0x127),'openId':null,'client':null});return _0x4bf022;}};AuthService=__decorate([(0x0,common_1[_0xdb7749(0xf6)])(),__param(0x0,(0x0,typeorm_2[_0xdb7749(0x12d)])(config_entity_1[_0xdb7749(0xdb)])),__metadata('design:paramtypes',[typeorm_1[_0xdb7749(0xf0)],user_service_1['UserService'],jwt_1[_0xdb7749(0x108)],mailer_service_1['MailerService'],verification_service_1['VerificationService'],userBalance_service_1['UserBalanceService'],redisCache_service_1[_0xdb7749(0x114)],globalConfig_service_1[_0xdb7749(0x105)]])],AuthService),exports[_0xdb7749(0x109)]=AuthService;