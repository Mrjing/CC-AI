'use strict';const _0x1a6b3c=_0x12a3;(function(_0x508f06,_0x33f7e7){const _0x45221c=_0x12a3,_0x2c358a=_0x508f06();while(!![]){try{const _0x437a25=parseInt(_0x45221c(0x1df))/0x1+-parseInt(_0x45221c(0x18c))/0x2+-parseInt(_0x45221c(0x1a7))/0x3+parseInt(_0x45221c(0x1ca))/0x4*(parseInt(_0x45221c(0x1c2))/0x5)+-parseInt(_0x45221c(0x1f1))/0x6+-parseInt(_0x45221c(0x17e))/0x7+-parseInt(_0x45221c(0x1b2))/0x8*(-parseInt(_0x45221c(0x1d6))/0x9);if(_0x437a25===_0x33f7e7)break;else _0x2c358a['push'](_0x2c358a['shift']());}catch(_0x50f7e9){_0x2c358a['push'](_0x2c358a['shift']());}}}(_0x4988,0xc2a57));var __decorate=this&&this['__decorate']||function(_0x3f9956,_0x1f947b,_0x3fd238,_0x551b7f){const _0x126a41=_0x12a3;var _0x16da6b=arguments[_0x126a41(0x1d4)],_0x19b421=_0x16da6b<0x3?_0x1f947b:_0x551b7f===null?_0x551b7f=Object['getOwnPropertyDescriptor'](_0x1f947b,_0x3fd238):_0x551b7f,_0x58f5c1;if(typeof Reflect===_0x126a41(0x1ae)&&typeof Reflect['decorate']===_0x126a41(0x1da))_0x19b421=Reflect['decorate'](_0x3f9956,_0x1f947b,_0x3fd238,_0x551b7f);else{for(var _0x5b472f=_0x3f9956['length']-0x1;_0x5b472f>=0x0;_0x5b472f--)if(_0x58f5c1=_0x3f9956[_0x5b472f])_0x19b421=(_0x16da6b<0x3?_0x58f5c1(_0x19b421):_0x16da6b>0x3?_0x58f5c1(_0x1f947b,_0x3fd238,_0x19b421):_0x58f5c1(_0x1f947b,_0x3fd238))||_0x19b421;}return _0x16da6b>0x3&&_0x19b421&&Object[_0x126a41(0x1ef)](_0x1f947b,_0x3fd238,_0x19b421),_0x19b421;},__metadata=this&&this[_0x1a6b3c(0x19a)]||function(_0xcba627,_0x551ee5){const _0x31b89e=_0x1a6b3c;if(typeof Reflect==='object'&&typeof Reflect[_0x31b89e(0x1a0)]===_0x31b89e(0x1da))return Reflect[_0x31b89e(0x1a0)](_0xcba627,_0x551ee5);},__param=this&&this['__param']||function(_0x5a9bb5,_0x4eb9cf){return function(_0x2e2893,_0x13f2eb){_0x4eb9cf(_0x2e2893,_0x13f2eb,_0x5a9bb5);};};function _0x4988(){const _0x141119=['design:paramtypes','internal','Repository','IPv4','set','userService','getUserInfo','response','127.0.0.1','data','jwtService','getInfo','configEntity','215jvNqqL','userDefautlAvatar','&email=','#fff','../globalConfig/config.entity','getIp','无权此操作、请联系管理员！','registerSuccessEmailTitle','61212EUUugO',':PHONECODE:','createTokenFromFingerprint','sendPhoneCode','验证码填写错误、请重新输入！','getNamespace','VerificationEnum','verifyUserRegisterByPhone','JwtService','HttpException','length','UserStatusEnum','1897569ioAjFj','@nestjs/common','globalConfigService','getClientIp','function','&registerSuccessEmailTitle=','redirect','hashSync','@nine.com','1369668BWkxGL','&registerSuccessEmaileAppend=','Registration','&username=','验证码发送成功、请填写验证码完成注册！','reduce','MailerService','getUserStatus','HttpStatus','userId','验证码已过期、请重新发送！','log','error:\x20','sign','oldPassword','BAD_REQUEST','defineProperty','keys','6034260SKPMfl','login','qureyUserInfoByInviteCode','register','/api/auth/registerError?message=','verifyUserCredentials','&registerFailEmailTitle=','find','userBalanceService','../verification/verification.service','loginByPhone','updatePassword','updatePassByOther','savaLoginIp','@nestjs/typeorm','8223446kNJJQm','__esModule','redisCacheService','Injectable','ACTIVE','verifyUserPassword','verifyCode','registerSuccessEmailTeamName','验证码类型错误','updateUserPassword','ConfigEntity','&registerFailEmailTeamName=','UserBalanceService','UserStatusErrMsg','2424158BgWywJ','createRandomUid','verifyCaptcha','AuthService','RedisCacheService','avatar',':CAPTCHA:','registerSuccessEmaileAppend','verificationService','configVal','text','padStart','registerFailEmailTeamName','visitor','__metadata','非法操作、请联系管理员！','user','ttl','queryUserInfoById','密码修改成功','metadata','ipAddress','address','get','../../common/utils','getConfigs','createUserAndVerifycation','471330pBsQMB','../redisCache/redisCache.service','password','createUser','bcryptjs','updateUserStatus','onModuleInit','object','captcha','typeorm','saveToken','88xdcZuG','账户已被激活过','networkInterfaces'];_0x4988=function(){return _0x141119;};return _0x4988();}function _0x12a3(_0x4c21a2,_0xbd35f0){const _0x498836=_0x4988();return _0x12a3=function(_0x12a360,_0x2c8a41){_0x12a360=_0x12a360-0x17e;let _0x1d9487=_0x498836[_0x12a360];return _0x1d9487;},_0x12a3(_0x4c21a2,_0xbd35f0);}Object[_0x1a6b3c(0x1ef)](exports,_0x1a6b3c(0x17f),{'value':!![]}),exports[_0x1a6b3c(0x18f)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),verification_constant_1=require('../../common/constants/verification.constant'),verification_service_1=require(_0x1a6b3c(0x1fa)),common_1=require(_0x1a6b3c(0x1d7)),jwt_1=require('@nestjs/jwt'),user_service_1=require('../user/user.service'),mailer_service_1=require('../mailer/mailer.service'),user_constant_1=require('../../common/constants/user.constant'),userBalance_service_1=require('../userBalance/userBalance.service'),config_entity_1=require(_0x1a6b3c(0x1c6)),typeorm_1=require(_0x1a6b3c(0x1b0)),typeorm_2=require(_0x1a6b3c(0x1ff)),utils_1=require(_0x1a6b3c(0x1a4)),os=require('os'),redisCache_service_1=require(_0x1a6b3c(0x1a8)),svgCaptcha=require('svg-captcha'),bcrypt=require(_0x1a6b3c(0x1ab));let AuthService=class AuthService{constructor(_0x11ccc1,_0x161c30,_0x4ebdc3,_0x12fa0e,_0x345532,_0x5f3a60,_0x32e906,_0x45f94e){const _0x45b890=_0x1a6b3c;this[_0x45b890(0x1c1)]=_0x11ccc1,this[_0x45b890(0x1ba)]=_0x161c30,this[_0x45b890(0x1bf)]=_0x4ebdc3,this['mailerService']=_0x12fa0e,this[_0x45b890(0x194)]=_0x345532,this[_0x45b890(0x1f9)]=_0x5f3a60,this[_0x45b890(0x180)]=_0x32e906,this[_0x45b890(0x1d8)]=_0x45f94e;}async[_0x1a6b3c(0x1ad)](){this['getIp']();}async[_0x1a6b3c(0x1f4)](_0x2d5104,_0x45e7e1){const _0x2d1457=_0x1a6b3c;await this[_0x2d1457(0x194)]['verifyCaptcha'](_0x2d5104);const _0x158c93=await this[_0x2d1457(0x1ba)][_0x2d1457(0x1a6)](_0x2d5104,_0x45e7e1),{username:_0x5888d5,email:_0x41e507,client:_0x17e7aa,id:_0x3a8356}=_0x158c93,_0x29840f={'username':_0x5888d5,'email':_0x41e507,'id':_0x3a8356};return _0x17e7aa&&(_0x29840f['client']=_0x17e7aa),_0x29840f;}async['registerByPhone'](_0x359b00,_0x5da2eb){const _0x30dc5f=_0x1a6b3c,{username:_0x271881,password:_0x5b05f5,phone:_0x230282,phoneCode:_0x1cae70,invitedBy:_0x395ef4}=_0x359b00;await this[_0x30dc5f(0x1ba)][_0x30dc5f(0x1d1)](_0x359b00);const _0x546137=await this[_0x30dc5f(0x1d8)][_0x30dc5f(0x1cf)](),_0x7af96f=_0x546137+_0x30dc5f(0x1cb)+_0x230282,_0xe17258=await this[_0x30dc5f(0x180)][_0x30dc5f(0x1a3)]({'key':_0x7af96f});if(!_0xe17258)throw new common_1['HttpException'](_0x30dc5f(0x1e9),common_1[_0x30dc5f(0x1e7)][_0x30dc5f(0x1ee)]);if(_0x1cae70!==_0xe17258)throw new common_1[(_0x30dc5f(0x1d3))](_0x30dc5f(0x1ce),common_1[_0x30dc5f(0x1e7)][_0x30dc5f(0x1ee)]);const _0x476193=(0x0,utils_1['createRandomUid'])()+_0x30dc5f(0x1de),_0x247839={'username':_0x271881,'password':_0x5b05f5,'phone':_0x230282,'invitedBy':_0x395ef4,'email':_0x476193,'status':user_constant_1['UserStatusEnum'][_0x30dc5f(0x182)]},_0x255ac0=await this[_0x30dc5f(0x1d8)][_0x30dc5f(0x1a5)]([_0x30dc5f(0x1c3)]);_0x247839[_0x30dc5f(0x191)]=_0x255ac0;const _0xdd126=bcrypt[_0x30dc5f(0x1dd)](_0x5b05f5,0xa);_0x247839['password']=_0xdd126;const _0x4e3a02=await this[_0x30dc5f(0x1ba)][_0x30dc5f(0x1aa)](_0x247839);let _0x5a2545;_0x395ef4&&(_0x5a2545=await this[_0x30dc5f(0x1ba)][_0x30dc5f(0x1f3)](_0x395ef4));await this[_0x30dc5f(0x1f9)]['addBalanceToNewUser'](_0x4e3a02['id'],_0x5a2545===null||_0x5a2545===void 0x0?void 0x0:_0x5a2545['id']);return;}async[_0x1a6b3c(0x1f2)](_0x347114,_0x14c189){const _0x1e1564=_0x1a6b3c,_0x2bc780=await this[_0x1e1564(0x1ba)][_0x1e1564(0x1f6)](_0x347114),{username:_0x54f8b9,id:_0x22d84e,email:_0x198a2e,role:_0x1366e0,openId:_0x417dda,client:_0x1beda6}=_0x2bc780,_0x465149=(0x0,utils_1['getClientIp'])(_0x14c189);await this[_0x1e1564(0x1ba)][_0x1e1564(0x1fe)](_0x22d84e,_0x465149);const _0x1c4404=await this[_0x1e1564(0x1bf)][_0x1e1564(0x1ec)]({'username':_0x54f8b9,'id':_0x22d84e,'email':_0x198a2e,'role':_0x1366e0,'openId':_0x417dda,'client':_0x1beda6});return await this['redisCacheService'][_0x1e1564(0x1b1)](_0x22d84e,_0x1c4404),_0x1c4404;}async[_0x1a6b3c(0x1fb)](_0x2480c6,_0x2c2b8f){const _0x3b774d=_0x1a6b3c,_0x512d42=await this[_0x3b774d(0x1ba)][_0x3b774d(0x1f6)](_0x2480c6),{username:_0x4fb65a,id:_0x2f5341,email:_0x2bb8db,role:_0x1576ef,openId:_0x5609b0,client:_0x259cd5}=_0x512d42,_0x282e00=(0x0,utils_1[_0x3b774d(0x1d9)])(_0x2c2b8f);await this['userService'][_0x3b774d(0x1fe)](_0x2f5341,_0x282e00);const {phone:_0x3866c1}=_0x2480c6,_0xbb8e5d=await this[_0x3b774d(0x1bf)][_0x3b774d(0x1ec)]({'username':_0x4fb65a,'id':_0x2f5341,'email':_0x2bb8db,'role':_0x1576ef,'openId':_0x5609b0,'client':_0x259cd5,'phone':_0x3866c1});return await this['redisCacheService'][_0x3b774d(0x1b1)](_0x2f5341,_0xbb8e5d),_0xbb8e5d;}async['loginByOpenId'](_0x3de4f1,_0x51b970){const _0x3db855=_0x1a6b3c,{status:_0x4a4481}=_0x3de4f1;if(_0x4a4481!==user_constant_1[_0x3db855(0x1d5)][_0x3db855(0x182)])throw new common_1['HttpException'](user_constant_1[_0x3db855(0x18b)][_0x4a4481],common_1[_0x3db855(0x1e7)][_0x3db855(0x1ee)]);const {username:_0xb55196,id:_0x177a73,email:_0xb0be8b,role:_0xd4749d,openId:_0x4f6ec4,client:_0xa74eee}=_0x3de4f1,_0x30bb99=(0x0,utils_1[_0x3db855(0x1d9)])(_0x51b970);await this[_0x3db855(0x1ba)][_0x3db855(0x1fe)](_0x177a73,_0x30bb99);const _0x508f56=await this[_0x3db855(0x1bf)][_0x3db855(0x1ec)]({'username':_0xb55196,'id':_0x177a73,'email':_0xb0be8b,'role':_0xd4749d,'openId':_0x4f6ec4,'client':_0xa74eee});return await this[_0x3db855(0x180)][_0x3db855(0x1b1)](_0x177a73,_0x508f56),_0x508f56;}async[_0x1a6b3c(0x1c0)](_0x5b9699){const _0x20b06a=_0x1a6b3c,{id:_0x1fdc9b}=_0x5b9699[_0x20b06a(0x19c)];return await this['userService'][_0x20b06a(0x1bb)](_0x1fdc9b);}async['activateAccount'](_0x35c6ed,_0x5b5d54){const _0x43f103=_0x1a6b3c,_0x2b87c5=await this['configEntity'][_0x43f103(0x1f8)]({'where':{'configKey':(0x0,typeorm_1['In'])(['registerSuccessEmailTitle','registerSuccessEmailTeamName',_0x43f103(0x193),'registerFailEmailTitle',_0x43f103(0x198)])}}),_0x1a9586=_0x2b87c5[_0x43f103(0x1e4)]((_0x535fa7,_0x3251bf)=>{const _0x5d6af2=_0x43f103;return _0x535fa7[_0x3251bf['configKey']]=_0x3251bf[_0x5d6af2(0x195)],_0x535fa7;},{});try{const _0x1eb981=await this[_0x43f103(0x194)][_0x43f103(0x184)](_0x35c6ed,verification_constant_1[_0x43f103(0x1d0)][_0x43f103(0x1e1)]),{type:_0x3bd7b8,userId:_0x1ea895}=_0x1eb981;if(_0x3bd7b8!==verification_constant_1[_0x43f103(0x1d0)][_0x43f103(0x1e1)])throw new common_1['HttpException'](_0x43f103(0x186),common_1[_0x43f103(0x1e7)]['BAD_REQUEST']);const _0x5c11f5=await this[_0x43f103(0x1ba)][_0x43f103(0x1e6)](_0x1ea895);if(_0x5c11f5===user_constant_1['UserStatusEnum'][_0x43f103(0x182)])throw new common_1[(_0x43f103(0x1d3))](_0x43f103(0x1b3),common_1['HttpStatus'][_0x43f103(0x1ee)]);await this['userService'][_0x43f103(0x1ac)](_0x1eb981['userId'],user_constant_1[_0x43f103(0x1d5)]['ACTIVE']);const _0x17cfb6=await this[_0x43f103(0x1ba)][_0x43f103(0x19e)](_0x1eb981[_0x43f103(0x1e8)]),{username:_0x276eda,email:_0x176aa3,id:_0x323050,invitedBy:_0x3a95b6}=_0x17cfb6;let _0x2cc11c;_0x3a95b6&&(_0x2cc11c=await this['userService'][_0x43f103(0x1f3)](_0x3a95b6)),await this[_0x43f103(0x1f9)]['addBalanceToNewUser'](_0x323050,_0x2cc11c===null||_0x2cc11c===void 0x0?void 0x0:_0x2cc11c['id']),_0x5b5d54[_0x43f103(0x1dc)]('/api/auth/registerSuccess?id='+_0x323050['toString']()[_0x43f103(0x197)](0x4,'0')+_0x43f103(0x1e2)+_0x276eda+_0x43f103(0x1c4)+_0x176aa3+_0x43f103(0x1db)+_0x1a9586[_0x43f103(0x1c9)]+'&registerSuccessEmailTeamName='+_0x1a9586[_0x43f103(0x185)]+_0x43f103(0x1e0)+_0x1a9586[_0x43f103(0x193)]);}catch(_0x1dee2e){console[_0x43f103(0x1ea)](_0x43f103(0x1eb),_0x1dee2e);const _0x53f4f2=_0x1dee2e[_0x43f103(0x1bc)];_0x5b5d54[_0x43f103(0x1dc)](_0x43f103(0x1f5)+_0x53f4f2+_0x43f103(0x1f7)+_0x1a9586['registerFailEmailTitle']+_0x43f103(0x189)+_0x1a9586[_0x43f103(0x198)]);}}async[_0x1a6b3c(0x1fc)](_0x46642e,_0x5a0881){const _0xbbe8f5=_0x1a6b3c,{id:_0xf31d10,client:_0x46f8a7,role:_0x658f92}=_0x46642e[_0xbbe8f5(0x19c)];if(_0x46f8a7&&Number(_0x46f8a7)>0x0)throw new common_1[(_0xbbe8f5(0x1d3))](_0xbbe8f5(0x1c8),common_1[_0xbbe8f5(0x1e7)]['BAD_REQUEST']);if(_0x658f92==='admin')throw new common_1[(_0xbbe8f5(0x1d3))](_0xbbe8f5(0x19b),common_1[_0xbbe8f5(0x1e7)][_0xbbe8f5(0x1ee)]);const _0x4331da=await this['userService'][_0xbbe8f5(0x183)](_0xf31d10,_0x5a0881[_0xbbe8f5(0x1ed)]);if(!_0x4331da)throw new common_1['HttpException']('旧密码错误、请检查提交',common_1[_0xbbe8f5(0x1e7)][_0xbbe8f5(0x1ee)]);return this[_0xbbe8f5(0x1ba)]['updateUserPassword'](_0xf31d10,_0x5a0881[_0xbbe8f5(0x1a9)]),_0xbbe8f5(0x19f);}async[_0x1a6b3c(0x1fd)](_0x253c65,_0x45afa5){const _0x521802=_0x1a6b3c,{id:_0x16f7d8,client:_0x363665}=_0x253c65[_0x521802(0x19c)];if(!_0x363665)throw new common_1['HttpException']('无权此操作！',common_1[_0x521802(0x1e7)]['BAD_REQUEST']);return this['userService'][_0x521802(0x187)](_0x16f7d8,_0x45afa5['password']),_0x521802(0x19f);}[_0x1a6b3c(0x1c7)](){const _0x42183e=_0x1a6b3c;let _0x3832e1;const _0xbcba9d=os[_0x42183e(0x1b4)]();Object[_0x42183e(0x1f0)](_0xbcba9d)['forEach'](_0x3c6cf6=>{const _0x4103c9=_0x42183e,_0x54e9d1=_0xbcba9d[_0x3c6cf6];for(let _0x4168de=0x0;_0x4168de<_0x54e9d1[_0x4103c9(0x1d4)];_0x4168de++){const _0x118cff=_0x54e9d1[_0x4168de];if(_0x118cff['family']===_0x4103c9(0x1b8)&&_0x118cff[_0x4103c9(0x1a2)]!==_0x4103c9(0x1bd)&&!_0x118cff[_0x4103c9(0x1b6)]){_0x3832e1=_0x118cff[_0x4103c9(0x1a2)];break;}}}),this[_0x42183e(0x1a1)]=_0x3832e1;}async[_0x1a6b3c(0x1af)](_0xfc5483){const _0x416621=_0x1a6b3c,_0x2d4a6c=await this[_0x416621(0x1d8)][_0x416621(0x1cf)](),{color:color=_0x416621(0x1c5)}=_0xfc5483,_0x33be59=svgCaptcha['createMathExpr']({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x615c7=_0x33be59['text'],_0x136aa1=(0x0,utils_1[_0x416621(0x18d)])(),_0x2eb0a0=_0x2d4a6c+_0x416621(0x192)+_0x136aa1;return await this[_0x416621(0x180)]['set']({'key':_0x2eb0a0,'val':_0x33be59[_0x416621(0x196)]},0x5*0x3c),{'svgCode':_0x33be59[_0x416621(0x1be)],'code':_0x136aa1};}async[_0x1a6b3c(0x1cd)](_0x55ed16){const _0x483ba9=_0x1a6b3c;await this[_0x483ba9(0x194)][_0x483ba9(0x18e)](_0x55ed16);const {phone:_0x1184d2}=_0x55ed16,_0x26430e=await this['globalConfigService'][_0x483ba9(0x1cf)](),_0x588123=_0x26430e+_0x483ba9(0x1cb)+_0x1184d2,_0x56c641=await this[_0x483ba9(0x180)][_0x483ba9(0x19d)](_0x588123);if(_0x56c641&&_0x56c641>0x0)throw new common_1[(_0x483ba9(0x1d3))](_0x56c641+'秒内不得重复发送短信！',common_1[_0x483ba9(0x1e7)][_0x483ba9(0x1ee)]);const _0xe83bd7=(0x0,utils_1['createRandomCode'])(),_0x1e0278={'phone':_0x1184d2,'code':_0xe83bd7};return await this['verificationService']['sendPhoneCodeWithQcloud'](_0x1e0278),await this[_0x483ba9(0x180)][_0x483ba9(0x1b9)]({'key':_0x588123,'val':_0xe83bd7},0x1*0x3c),_0x483ba9(0x1e3);}[_0x1a6b3c(0x1cc)](_0x393209){const _0x5a9d0c=_0x1a6b3c,_0x2c436b=this['jwtService'][_0x5a9d0c(0x1ec)]({'username':'游客'+_0x393209,'id':_0x393209,'email':_0x393209+_0x5a9d0c(0x1de),'role':_0x5a9d0c(0x199),'openId':null,'client':null});return _0x2c436b;}};AuthService=__decorate([(0x0,common_1[_0x1a6b3c(0x181)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(config_entity_1[_0x1a6b3c(0x188)])),__metadata(_0x1a6b3c(0x1b5),[typeorm_1[_0x1a6b3c(0x1b7)],user_service_1['UserService'],jwt_1[_0x1a6b3c(0x1d2)],mailer_service_1[_0x1a6b3c(0x1e5)],verification_service_1['VerificationService'],userBalance_service_1[_0x1a6b3c(0x18a)],redisCache_service_1[_0x1a6b3c(0x190)],globalConfig_service_1['GlobalConfigService']])],AuthService),exports[_0x1a6b3c(0x18f)]=AuthService;