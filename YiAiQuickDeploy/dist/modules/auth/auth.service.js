'use strict';function _0xc450(_0x4bbba2,_0x120f78){const _0x10ec14=_0x10ec();return _0xc450=function(_0xc45040,_0x2877e1){_0xc45040=_0xc45040-0xd9;let _0x43fda0=_0x10ec14[_0xc45040];return _0x43fda0;},_0xc450(_0x4bbba2,_0x120f78);}const _0x415e58=_0xc450;(function(_0x52240d,_0x496c97){const _0x5b138a=_0xc450,_0x1f58e5=_0x52240d();while(!![]){try{const _0x58d448=-parseInt(_0x5b138a(0x142))/0x1*(-parseInt(_0x5b138a(0x134))/0x2)+parseInt(_0x5b138a(0x152))/0x3+-parseInt(_0x5b138a(0x157))/0x4*(parseInt(_0x5b138a(0x13b))/0x5)+parseInt(_0x5b138a(0x104))/0x6+parseInt(_0x5b138a(0x14c))/0x7+parseInt(_0x5b138a(0x14d))/0x8+parseInt(_0x5b138a(0x110))/0x9*(-parseInt(_0x5b138a(0xe0))/0xa);if(_0x58d448===_0x496c97)break;else _0x1f58e5['push'](_0x1f58e5['shift']());}catch(_0x15a5e2){_0x1f58e5['push'](_0x1f58e5['shift']());}}}(_0x10ec,0xf021e));function _0x10ec(){const _0x54c96d=['Registration','registerSuccessEmailTitle','../verification/verification.service','toString','HttpException','4475996rQATWB','7785432aMYuLm','registerSuccessEmailTeamName','sendPhoneCodeWithQcloud','registerFailEmailTeamName','set','1564632ZVXTuX','userBalanceService','design:paramtypes','createRandomCode','object','11504kiNAIS','__decorate','ACTIVE','&username=','metadata','getNamespace','RedisCacheService','activateAccount','UserStatusEnum','updateUserPassword','createTokenFromFingerprint','updatePassword','registerFailEmailTitle','jwtService','../globalConfig/config.entity','keys','savaLoginIp','sendPhoneCode','2867570LnsiDq','Repository','verifyUserRegisterByPhone','&registerFailEmailTitle=','mailerService','verifyCaptcha','family','password','login','forEach','redirect','function','__param','createUserAndVerifycation','hashSync','VerificationEnum','configKey','reduce','getConfigs','configEntity','HttpStatus','ConfigEntity','无权此操作、请联系管理员！','registerSuccessEmaileAppend','../../common/constants/user.constant','getUserStatus','无权此操作！','&registerSuccessEmaileAppend=','error:\x20','text','Injectable','addBalanceToNewUser','旧密码错误、请检查提交','oldPassword',':CAPTCHA:','getClientIp','360024iytlBl','AuthService','client','userId','updateUserStatus','秒内不得重复发送短信！','验证码已过期、请重新发送！','address','createUser','__esModule','find','user','63DGNWDv','BAD_REQUEST','非法操作、请联系管理员！','log','账户已被激活过','&email=','@nestjs/jwt','data','IPv4','UserStatusErrMsg','sign','networkInterfaces','../redisCache/redisCache.service','/api/auth/registerSuccess?id=','getOwnPropertyDescriptor','decorate','verifyCode','loginByPhone','&registerFailEmailTeamName=','register','typeorm',':PHONECODE:','getIp','verificationService','userService','&registerSuccessEmailTitle=','loginByOpenId','ipAddress','registerByPhone','verifyUserCredentials','../mailer/mailer.service','defineProperty','verifyUserPassword','saveToken','captcha','internal','290228imPQnO','createRandomUid','密码修改成功','admin','127.0.0.1','length','&registerSuccessEmailTeamName=','1390tsIAcz','redisCacheService','@nestjs/typeorm','createMathExpr','UserBalanceService','getInfo','@nine.com','11OrwkbO','GlobalConfigService','globalConfigService','验证码类型错误','__metadata'];_0x10ec=function(){return _0x54c96d;};return _0x10ec();}var __decorate=this&&this[_0x415e58(0x158)]||function(_0x594fc5,_0x4d5611,_0x4079eb,_0x5092b0){const _0x16e4ed=_0x415e58;var _0x121378=arguments[_0x16e4ed(0x139)],_0x2f5aa4=_0x121378<0x3?_0x4d5611:_0x5092b0===null?_0x5092b0=Object[_0x16e4ed(0x11e)](_0x4d5611,_0x4079eb):_0x5092b0,_0x25c049;if(typeof Reflect==='object'&&typeof Reflect[_0x16e4ed(0x11f)]===_0x16e4ed(0xeb))_0x2f5aa4=Reflect[_0x16e4ed(0x11f)](_0x594fc5,_0x4d5611,_0x4079eb,_0x5092b0);else{for(var _0x14bb65=_0x594fc5['length']-0x1;_0x14bb65>=0x0;_0x14bb65--)if(_0x25c049=_0x594fc5[_0x14bb65])_0x2f5aa4=(_0x121378<0x3?_0x25c049(_0x2f5aa4):_0x121378>0x3?_0x25c049(_0x4d5611,_0x4079eb,_0x2f5aa4):_0x25c049(_0x4d5611,_0x4079eb))||_0x2f5aa4;}return _0x121378>0x3&&_0x2f5aa4&&Object['defineProperty'](_0x4d5611,_0x4079eb,_0x2f5aa4),_0x2f5aa4;},__metadata=this&&this[_0x415e58(0x146)]||function(_0x39baa7,_0x13ff7c){const _0xfd900b=_0x415e58;if(typeof Reflect===_0xfd900b(0x156)&&typeof Reflect[_0xfd900b(0x15b)]===_0xfd900b(0xeb))return Reflect[_0xfd900b(0x15b)](_0x39baa7,_0x13ff7c);},__param=this&&this[_0x415e58(0xec)]||function(_0x59fd57,_0x4ba04e){return function(_0x1a79bc,_0x2ea46f){_0x4ba04e(_0x1a79bc,_0x2ea46f,_0x59fd57);};};Object[_0x415e58(0x12f)](exports,_0x415e58(0x10d),{'value':!![]}),exports[_0x415e58(0x105)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),verification_constant_1=require('../../common/constants/verification.constant'),verification_service_1=require(_0x415e58(0x149)),common_1=require('@nestjs/common'),jwt_1=require(_0x415e58(0x116)),user_service_1=require('../user/user.service'),mailer_service_1=require(_0x415e58(0x12e)),user_constant_1=require(_0x415e58(0xf8)),userBalance_service_1=require('../userBalance/userBalance.service'),config_entity_1=require(_0x415e58(0xdc)),typeorm_1=require(_0x415e58(0x124)),typeorm_2=require(_0x415e58(0x13d)),utils_1=require('../../common/utils'),os=require('os'),redisCache_service_1=require(_0x415e58(0x11c)),svgCaptcha=require('svg-captcha'),bcrypt=require('bcryptjs');let AuthService=class AuthService{constructor(_0x5ed70e,_0x56f955,_0xc9e9b3,_0x248ffa,_0x15c826,_0x379675,_0x3bdd23,_0x8b787d){const _0x28d528=_0x415e58;this[_0x28d528(0xf3)]=_0x5ed70e,this[_0x28d528(0x128)]=_0x56f955,this[_0x28d528(0xdb)]=_0xc9e9b3,this[_0x28d528(0xe4)]=_0x248ffa,this[_0x28d528(0x127)]=_0x15c826,this[_0x28d528(0x153)]=_0x379675,this[_0x28d528(0x13c)]=_0x3bdd23,this[_0x28d528(0x144)]=_0x8b787d;}async['onModuleInit'](){this['getIp']();}async[_0x415e58(0x123)](_0x23ed4b,_0x566a70){const _0x1253ea=_0x415e58;await this[_0x1253ea(0x127)][_0x1253ea(0xe5)](_0x23ed4b);const _0x13ea26=await this[_0x1253ea(0x128)][_0x1253ea(0xed)](_0x23ed4b,_0x566a70),{username:_0xcd8072,email:_0x257c15,client:_0x2c123d,id:_0x2c77b4}=_0x13ea26,_0x43a8a6={'username':_0xcd8072,'email':_0x257c15,'id':_0x2c77b4};return _0x2c123d&&(_0x43a8a6[_0x1253ea(0x106)]=_0x2c123d),_0x43a8a6;}async[_0x415e58(0x12c)](_0x116a12,_0x45e6a3){const _0x99a276=_0x415e58,{username:_0x9dba29,password:_0xc4e9ed,phone:_0xb154bb,phoneCode:_0x142970,invitedBy:_0x4622c9}=_0x116a12;await this[_0x99a276(0x128)][_0x99a276(0xe2)](_0x116a12);const _0x4c7f7f=await this[_0x99a276(0x144)][_0x99a276(0x15c)](),_0x4f4918=_0x4c7f7f+_0x99a276(0x125)+_0xb154bb,_0x5100dc=await this[_0x99a276(0x13c)]['get']({'key':_0x4f4918});if(!_0x5100dc)throw new common_1['HttpException'](_0x99a276(0x10a),common_1[_0x99a276(0xf4)][_0x99a276(0x111)]);if(_0x142970!==_0x5100dc)throw new common_1[(_0x99a276(0x14b))]('验证码填写错误、请重新输入！',common_1[_0x99a276(0xf4)][_0x99a276(0x111)]);const _0x55259a=(0x0,utils_1[_0x99a276(0x135)])()+_0x99a276(0x141),_0x515b26={'username':_0x9dba29,'password':_0xc4e9ed,'phone':_0xb154bb,'invitedBy':_0x4622c9,'email':_0x55259a,'status':user_constant_1['UserStatusEnum'][_0x99a276(0x159)]},_0x8c5bb2=await this[_0x99a276(0x144)][_0x99a276(0xf2)](['userDefautlAvatar']);_0x515b26['avatar']=_0x8c5bb2;const _0x251293=bcrypt[_0x99a276(0xee)](_0xc4e9ed,0xa);_0x515b26[_0x99a276(0xe7)]=_0x251293;const _0x279567=await this[_0x99a276(0x128)][_0x99a276(0x10c)](_0x515b26);let _0x45dd0d;_0x4622c9&&(_0x45dd0d=await this['userService']['qureyUserInfoByInviteCode'](_0x4622c9));await this[_0x99a276(0x153)][_0x99a276(0xff)](_0x279567['id'],_0x45dd0d===null||_0x45dd0d===void 0x0?void 0x0:_0x45dd0d['id']);return;}async[_0x415e58(0xe8)](_0x4ea4ff,_0x33872a){const _0x5cf571=_0x415e58,_0x1fb38f=await this[_0x5cf571(0x128)][_0x5cf571(0x12d)](_0x4ea4ff),{username:_0x3ef125,id:_0x5657c8,email:_0x26b5b7,role:_0x4d30af,openId:_0x52c7e,client:_0x3786c8}=_0x1fb38f,_0x57d618=(0x0,utils_1[_0x5cf571(0x103)])(_0x33872a);await this[_0x5cf571(0x128)][_0x5cf571(0xde)](_0x5657c8,_0x57d618);const _0x2f3099=await this[_0x5cf571(0xdb)]['sign']({'username':_0x3ef125,'id':_0x5657c8,'email':_0x26b5b7,'role':_0x4d30af,'openId':_0x52c7e,'client':_0x3786c8});return await this[_0x5cf571(0x13c)][_0x5cf571(0x131)](_0x5657c8,_0x2f3099),_0x2f3099;}async[_0x415e58(0x121)](_0x5d3d18,_0xae0a3a){const _0x83a9ba=_0x415e58,_0x41339b=await this[_0x83a9ba(0x128)][_0x83a9ba(0x12d)](_0x5d3d18),{username:_0x26402d,id:_0x4ef80c,email:_0x5c969c,role:_0x245575,openId:_0x5e6ec1,client:_0x3ddaf7}=_0x41339b,_0x250bd6=(0x0,utils_1[_0x83a9ba(0x103)])(_0xae0a3a);await this['userService'][_0x83a9ba(0xde)](_0x4ef80c,_0x250bd6);const {phone:_0x4e6449}=_0x5d3d18,_0x26517d=await this[_0x83a9ba(0xdb)][_0x83a9ba(0x11a)]({'username':_0x26402d,'id':_0x4ef80c,'email':_0x5c969c,'role':_0x245575,'openId':_0x5e6ec1,'client':_0x3ddaf7,'phone':_0x4e6449});return await this[_0x83a9ba(0x13c)][_0x83a9ba(0x131)](_0x4ef80c,_0x26517d),_0x26517d;}async[_0x415e58(0x12a)](_0x255d8c,_0x533b6c){const _0x1d2bce=_0x415e58,{status:_0x23f8f5}=_0x255d8c;if(_0x23f8f5!==user_constant_1[_0x1d2bce(0x15f)][_0x1d2bce(0x159)])throw new common_1['HttpException'](user_constant_1[_0x1d2bce(0x119)][_0x23f8f5],common_1[_0x1d2bce(0xf4)][_0x1d2bce(0x111)]);const {username:_0x2de803,id:_0x4face6,email:_0x3875cb,role:_0xe7770,openId:_0x1aa978,client:_0x2c75f5}=_0x255d8c,_0x50f31e=(0x0,utils_1[_0x1d2bce(0x103)])(_0x533b6c);await this[_0x1d2bce(0x128)][_0x1d2bce(0xde)](_0x4face6,_0x50f31e);const _0x1e56d2=await this[_0x1d2bce(0xdb)][_0x1d2bce(0x11a)]({'username':_0x2de803,'id':_0x4face6,'email':_0x3875cb,'role':_0xe7770,'openId':_0x1aa978,'client':_0x2c75f5});return await this['redisCacheService'][_0x1d2bce(0x131)](_0x4face6,_0x1e56d2),_0x1e56d2;}async[_0x415e58(0x140)](_0x5c2a34){const _0x471528=_0x415e58,{id:_0x54a756}=_0x5c2a34['user'];return await this[_0x471528(0x128)]['getUserInfo'](_0x54a756);}async[_0x415e58(0x15e)](_0x3ae123,_0x5c9546){const _0x52545d=_0x415e58,_0x70f123=await this['configEntity'][_0x52545d(0x10e)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x52545d(0x148),_0x52545d(0x14e),_0x52545d(0xf7),'registerFailEmailTitle',_0x52545d(0x150)])}}),_0x1c83f9=_0x70f123[_0x52545d(0xf1)]((_0x563fea,_0x52a86b)=>{const _0x410cb7=_0x52545d;return _0x563fea[_0x52a86b[_0x410cb7(0xf0)]]=_0x52a86b['configVal'],_0x563fea;},{});try{const _0x4486bc=await this['verificationService'][_0x52545d(0x120)](_0x3ae123,verification_constant_1['VerificationEnum'][_0x52545d(0x147)]),{type:_0x3f2fbd,userId:_0x1ce239}=_0x4486bc;if(_0x3f2fbd!==verification_constant_1[_0x52545d(0xef)][_0x52545d(0x147)])throw new common_1[(_0x52545d(0x14b))](_0x52545d(0x145),common_1[_0x52545d(0xf4)][_0x52545d(0x111)]);const _0x10ec19=await this[_0x52545d(0x128)][_0x52545d(0xf9)](_0x1ce239);if(_0x10ec19===user_constant_1['UserStatusEnum'][_0x52545d(0x159)])throw new common_1[(_0x52545d(0x14b))](_0x52545d(0x114),common_1['HttpStatus']['BAD_REQUEST']);await this[_0x52545d(0x128)][_0x52545d(0x108)](_0x4486bc['userId'],user_constant_1[_0x52545d(0x15f)][_0x52545d(0x159)]);const _0x1ce35f=await this[_0x52545d(0x128)]['queryUserInfoById'](_0x4486bc[_0x52545d(0x107)]),{username:_0x5b152a,email:_0x5cfef9,id:_0x14483,invitedBy:_0x4293e8}=_0x1ce35f;let _0xba828e;_0x4293e8&&(_0xba828e=await this[_0x52545d(0x128)]['qureyUserInfoByInviteCode'](_0x4293e8)),await this[_0x52545d(0x153)][_0x52545d(0xff)](_0x14483,_0xba828e===null||_0xba828e===void 0x0?void 0x0:_0xba828e['id']),_0x5c9546[_0x52545d(0xea)](_0x52545d(0x11d)+_0x14483[_0x52545d(0x14a)]()['padStart'](0x4,'0')+_0x52545d(0x15a)+_0x5b152a+_0x52545d(0x115)+_0x5cfef9+_0x52545d(0x129)+_0x1c83f9[_0x52545d(0x148)]+_0x52545d(0x13a)+_0x1c83f9[_0x52545d(0x14e)]+_0x52545d(0xfb)+_0x1c83f9[_0x52545d(0xf7)]);}catch(_0x5180a2){console[_0x52545d(0x113)](_0x52545d(0xfc),_0x5180a2);const _0x32bb1e=_0x5180a2['response'];_0x5c9546[_0x52545d(0xea)]('/api/auth/registerError?message='+_0x32bb1e+_0x52545d(0xe3)+_0x1c83f9[_0x52545d(0xda)]+_0x52545d(0x122)+_0x1c83f9[_0x52545d(0x150)]);}}async[_0x415e58(0xd9)](_0x5d2453,_0x361fe5){const _0x146c19=_0x415e58,{id:_0x42a13e,client:_0x451559,role:_0xb571db}=_0x5d2453['user'];if(_0x451559&&Number(_0x451559)>0x0)throw new common_1[(_0x146c19(0x14b))](_0x146c19(0xf6),common_1[_0x146c19(0xf4)][_0x146c19(0x111)]);if(_0xb571db===_0x146c19(0x137))throw new common_1[(_0x146c19(0x14b))](_0x146c19(0x112),common_1[_0x146c19(0xf4)][_0x146c19(0x111)]);const _0x54244e=await this['userService'][_0x146c19(0x130)](_0x42a13e,_0x361fe5[_0x146c19(0x101)]);if(!_0x54244e)throw new common_1[(_0x146c19(0x14b))](_0x146c19(0x100),common_1[_0x146c19(0xf4)][_0x146c19(0x111)]);return this[_0x146c19(0x128)][_0x146c19(0x160)](_0x42a13e,_0x361fe5[_0x146c19(0xe7)]),_0x146c19(0x136);}async['updatePassByOther'](_0x86ee66,_0x50ce98){const _0x2c9ade=_0x415e58,{id:_0x26b91f,client:_0x369acb}=_0x86ee66[_0x2c9ade(0x10f)];if(!_0x369acb)throw new common_1[(_0x2c9ade(0x14b))](_0x2c9ade(0xfa),common_1[_0x2c9ade(0xf4)][_0x2c9ade(0x111)]);return this[_0x2c9ade(0x128)][_0x2c9ade(0x160)](_0x26b91f,_0x50ce98[_0x2c9ade(0xe7)]),_0x2c9ade(0x136);}[_0x415e58(0x126)](){const _0x42df90=_0x415e58;let _0x31fcaa;const _0x117ebf=os[_0x42df90(0x11b)]();Object[_0x42df90(0xdd)](_0x117ebf)[_0x42df90(0xe9)](_0x2e2b19=>{const _0x1291ed=_0x42df90,_0x52e4a0=_0x117ebf[_0x2e2b19];for(let _0x10e021=0x0;_0x10e021<_0x52e4a0[_0x1291ed(0x139)];_0x10e021++){const _0x567ca4=_0x52e4a0[_0x10e021];if(_0x567ca4[_0x1291ed(0xe6)]===_0x1291ed(0x118)&&_0x567ca4[_0x1291ed(0x10b)]!==_0x1291ed(0x138)&&!_0x567ca4[_0x1291ed(0x133)]){_0x31fcaa=_0x567ca4[_0x1291ed(0x10b)];break;}}}),this[_0x42df90(0x12b)]=_0x31fcaa;}async[_0x415e58(0x132)](_0x146c24){const _0x1f368e=_0x415e58,_0x1fa737=await this['globalConfigService'][_0x1f368e(0x15c)](),{color:color='#fff'}=_0x146c24,_0x106f71=svgCaptcha[_0x1f368e(0x13e)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x5b73a2=_0x106f71[_0x1f368e(0xfd)],_0x5aa117=(0x0,utils_1[_0x1f368e(0x135)])(),_0xed20e4=_0x1fa737+_0x1f368e(0x102)+_0x5aa117;return await this[_0x1f368e(0x13c)][_0x1f368e(0x151)]({'key':_0xed20e4,'val':_0x106f71['text']},0x5*0x3c),{'svgCode':_0x106f71[_0x1f368e(0x117)],'code':_0x5aa117};}async[_0x415e58(0xdf)](_0x5e9143){const _0x19b7a8=_0x415e58;await this[_0x19b7a8(0x127)][_0x19b7a8(0xe5)](_0x5e9143);const {phone:_0x1a1aae}=_0x5e9143,_0x132950=await this['globalConfigService'][_0x19b7a8(0x15c)](),_0x1f99b4=_0x132950+_0x19b7a8(0x125)+_0x1a1aae,_0x4e8ad7=await this[_0x19b7a8(0x13c)]['ttl'](_0x1f99b4);if(_0x4e8ad7&&_0x4e8ad7>0x0)throw new common_1['HttpException'](_0x4e8ad7+_0x19b7a8(0x109),common_1[_0x19b7a8(0xf4)][_0x19b7a8(0x111)]);const _0x446212=(0x0,utils_1[_0x19b7a8(0x155)])(),_0x39451c={'phone':_0x1a1aae,'code':_0x446212};return await this[_0x19b7a8(0x127)][_0x19b7a8(0x14f)](_0x39451c),await this[_0x19b7a8(0x13c)]['set']({'key':_0x1f99b4,'val':_0x446212},0x1*0x3c),'验证码发送成功、请填写验证码完成注册！';}[_0x415e58(0x161)](_0x1b6467){const _0x43e12d=_0x415e58,_0x4b2e78=this[_0x43e12d(0xdb)][_0x43e12d(0x11a)]({'username':'游客'+_0x1b6467,'id':_0x1b6467,'email':_0x1b6467+'@nine.com','role':'visitor','openId':null,'client':null});return _0x4b2e78;}};AuthService=__decorate([(0x0,common_1[_0x415e58(0xfe)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(config_entity_1[_0x415e58(0xf5)])),__metadata(_0x415e58(0x154),[typeorm_1[_0x415e58(0xe1)],user_service_1['UserService'],jwt_1['JwtService'],mailer_service_1['MailerService'],verification_service_1['VerificationService'],userBalance_service_1[_0x415e58(0x13f)],redisCache_service_1[_0x415e58(0x15d)],globalConfig_service_1[_0x415e58(0x143)]])],AuthService),exports['AuthService']=AuthService;