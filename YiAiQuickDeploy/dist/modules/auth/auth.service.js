'use strict';function _0x1308(){const _0x56c6a9=['Injectable','BAD_REQUEST','../../common/constants/user.constant','updatePassByOther','register','InjectRepository','onModuleInit','password','networkInterfaces','HttpException','GlobalConfigService','updatePassword','UserBalanceService','ipAddress','&registerSuccessEmailTeamName=','ttl','registerFailEmailTitle','mailerService','ACTIVE','__metadata','密码修改成功','updateUserStatus','registerFailEmailTeamName','2309868weMlLO','set','userService','response','verificationService','@nestjs/jwt','createRandomCode','user','../verification/verification.service','Repository','find','verifyUserPassword','qureyUserInfoByInviteCode','getIp','createMathExpr','client','MailerService','design:paramtypes','../user/user.service','verifyCaptcha','jwtService','captcha','旧密码错误、请检查提交','&registerFailEmailTitle=','../../common/utils','验证码填写错误、请重新输入！',':PHONECODE:','&email=','UserService','hashSync','@nine.com','visitor','saveToken','get','configVal','sign','text','keys','createRandomUid','秒内不得重复发送短信！','verifyCode','bcryptjs','getOwnPropertyDescriptor','verifyUserRegisterByPhone','registerSuccessEmaileAppend','defineProperty','HttpStatus','605864VtFRQr','configEntity','&registerSuccessEmaileAppend=','&registerFailEmailTeamName=','1706785ViXqoT','getConfigs','decorate','5532492fTikls','RedisCacheService','IPv4','__decorate','/api/auth/registerSuccess?id=','data','getNamespace','loginByOpenId','registerSuccessEmailTitle','address','UserStatusErrMsg','账户已被激活过','../globalConfig/config.entity','log',':CAPTCHA:','registerByPhone','getUserStatus','redirect','addBalanceToNewUser','updateUserPassword','configKey','getInfo','301716kkQFRf','verifyUserCredentials','8MtIEww','avatar','sendPhoneCodeWithQcloud','globalConfigService','23667426TJMdaZ','typeorm','admin','../userBalance/userBalance.service','getClientIp','Registration','UserStatusEnum','userBalanceService','queryUserInfoById','error:\x20','savaLoginIp','非法操作、请联系管理员！','userDefautlAvatar','/api/auth/registerError?message=','login','验证码已过期、请重新发送！','无权此操作、请联系管理员！','getUserInfo','activateAccount','function','redisCacheService','svg-captcha','registerSuccessEmailTeamName','../globalConfig/globalConfig.service','sendPhoneCode','127.0.0.1','length','3KAHHgE','VerificationEnum','&username=','277692AVSNVB','__esModule'];_0x1308=function(){return _0x56c6a9;};return _0x1308();}const _0x261947=_0xa902;function _0xa902(_0x375e85,_0x285a66){const _0x130806=_0x1308();return _0xa902=function(_0xa902b,_0x144f63){_0xa902b=_0xa902b-0x1c0;let _0x99ca15=_0x130806[_0xa902b];return _0x99ca15;},_0xa902(_0x375e85,_0x285a66);}(function(_0x18c94b,_0xde37cb){const _0x503185=_0xa902,_0xb4fc0a=_0x18c94b();while(!![]){try{const _0x1c400d=-parseInt(_0x503185(0x23c))/0x1+-parseInt(_0x503185(0x1d7))/0x2*(parseInt(_0x503185(0x1d4))/0x3)+parseInt(_0x503185(0x23e))/0x4*(-parseInt(_0x503185(0x223))/0x5)+-parseInt(_0x503185(0x1f0))/0x6+-parseInt(_0x503185(0x226))/0x7+parseInt(_0x503185(0x21f))/0x8+parseInt(_0x503185(0x242))/0x9;if(_0x1c400d===_0xde37cb)break;else _0xb4fc0a['push'](_0xb4fc0a['shift']());}catch(_0x2edab2){_0xb4fc0a['push'](_0xb4fc0a['shift']());}}}(_0x1308,0x63535));var __decorate=this&&this[_0x261947(0x229)]||function(_0x2616ad,_0x46d7c4,_0x294b43,_0x14fde6){const _0x7a4a7=_0x261947;var _0x342ac0=arguments[_0x7a4a7(0x1d3)],_0x243c83=_0x342ac0<0x3?_0x46d7c4:_0x14fde6===null?_0x14fde6=Object[_0x7a4a7(0x21a)](_0x46d7c4,_0x294b43):_0x14fde6,_0x58c8d3;if(typeof Reflect==='object'&&typeof Reflect[_0x7a4a7(0x225)]===_0x7a4a7(0x1cc))_0x243c83=Reflect[_0x7a4a7(0x225)](_0x2616ad,_0x46d7c4,_0x294b43,_0x14fde6);else{for(var _0x23ca01=_0x2616ad[_0x7a4a7(0x1d3)]-0x1;_0x23ca01>=0x0;_0x23ca01--)if(_0x58c8d3=_0x2616ad[_0x23ca01])_0x243c83=(_0x342ac0<0x3?_0x58c8d3(_0x243c83):_0x342ac0>0x3?_0x58c8d3(_0x46d7c4,_0x294b43,_0x243c83):_0x58c8d3(_0x46d7c4,_0x294b43))||_0x243c83;}return _0x342ac0>0x3&&_0x243c83&&Object[_0x7a4a7(0x21d)](_0x46d7c4,_0x294b43,_0x243c83),_0x243c83;},__metadata=this&&this[_0x261947(0x1ec)]||function(_0x3ccc9b,_0x4fa643){const _0x2f3b72=_0x261947;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x2f3b72(0x1cc))return Reflect['metadata'](_0x3ccc9b,_0x4fa643);},__param=this&&this['__param']||function(_0x56b932,_0x49f5eb){return function(_0x542291,_0x11aed5){_0x49f5eb(_0x542291,_0x11aed5,_0x56b932);};};Object[_0x261947(0x21d)](exports,_0x261947(0x1d8),{'value':!![]}),exports['AuthService']=void 0x0;const globalConfig_service_1=require(_0x261947(0x1d0)),verification_constant_1=require('../../common/constants/verification.constant'),verification_service_1=require(_0x261947(0x1f8)),common_1=require('@nestjs/common'),jwt_1=require(_0x261947(0x1f5)),user_service_1=require(_0x261947(0x202)),mailer_service_1=require('../mailer/mailer.service'),user_constant_1=require(_0x261947(0x1db)),userBalance_service_1=require(_0x261947(0x245)),config_entity_1=require(_0x261947(0x232)),typeorm_1=require(_0x261947(0x243)),typeorm_2=require('@nestjs/typeorm'),utils_1=require(_0x261947(0x208)),os=require('os'),redisCache_service_1=require('../redisCache/redisCache.service'),svgCaptcha=require(_0x261947(0x1ce)),bcrypt=require(_0x261947(0x219));let AuthService=class AuthService{constructor(_0x57d559,_0x306c01,_0x149004,_0xe7ce34,_0x54a10d,_0x84992d,_0x9cec46,_0x31ff82){const _0x4adff0=_0x261947;this[_0x4adff0(0x220)]=_0x57d559,this[_0x4adff0(0x1f2)]=_0x306c01,this['jwtService']=_0x149004,this[_0x4adff0(0x1ea)]=_0xe7ce34,this[_0x4adff0(0x1f4)]=_0x54a10d,this[_0x4adff0(0x1c0)]=_0x84992d,this[_0x4adff0(0x1cd)]=_0x9cec46,this[_0x4adff0(0x241)]=_0x31ff82;}async[_0x261947(0x1df)](){const _0x5a703f=_0x261947;this[_0x5a703f(0x1fd)]();}async[_0x261947(0x1dd)](_0x30c5e3,_0x35e50b){const _0x457367=_0x261947;await this[_0x457367(0x1f4)][_0x457367(0x203)](_0x30c5e3);const _0x5d6aad=await this[_0x457367(0x1f2)]['createUserAndVerifycation'](_0x30c5e3,_0x35e50b),{username:_0x523a7,email:_0x7612db,client:_0x36b3b0,id:_0x58c02b}=_0x5d6aad,_0x26e4b0={'username':_0x523a7,'email':_0x7612db,'id':_0x58c02b};return _0x36b3b0&&(_0x26e4b0[_0x457367(0x1ff)]=_0x36b3b0),_0x26e4b0;}async[_0x261947(0x235)](_0x1a9e19,_0x3af126){const _0x71b861=_0x261947,{username:_0x353f36,password:_0x391de6,phone:_0x49fa04,phoneCode:_0x143891,invitedBy:_0x30e8f7}=_0x1a9e19;await this[_0x71b861(0x1f2)][_0x71b861(0x21b)](_0x1a9e19);const _0x4439ad=await this['globalConfigService'][_0x71b861(0x22c)](),_0x39143d=_0x4439ad+_0x71b861(0x20a)+_0x49fa04,_0x321cc0=await this[_0x71b861(0x1cd)][_0x71b861(0x211)]({'key':_0x39143d});if(!_0x321cc0)throw new common_1[(_0x71b861(0x1e2))](_0x71b861(0x1c8),common_1[_0x71b861(0x21e)][_0x71b861(0x1da)]);if(_0x143891!==_0x321cc0)throw new common_1['HttpException'](_0x71b861(0x209),common_1[_0x71b861(0x21e)][_0x71b861(0x1da)]);const _0x194948=(0x0,utils_1[_0x71b861(0x216)])()+_0x71b861(0x20e),_0xb3d23={'username':_0x353f36,'password':_0x391de6,'phone':_0x49fa04,'invitedBy':_0x30e8f7,'email':_0x194948,'status':user_constant_1['UserStatusEnum'][_0x71b861(0x1eb)]},_0x3ddd50=await this['globalConfigService'][_0x71b861(0x224)]([_0x71b861(0x1c5)]);_0xb3d23[_0x71b861(0x23f)]=_0x3ddd50;const _0x3c8421=bcrypt[_0x71b861(0x20d)](_0x391de6,0xa);_0xb3d23[_0x71b861(0x1e0)]=_0x3c8421;const _0x3a30f4=await this[_0x71b861(0x1f2)]['createUser'](_0xb3d23);let _0x2e9141;_0x30e8f7&&(_0x2e9141=await this[_0x71b861(0x1f2)][_0x71b861(0x1fc)](_0x30e8f7));await this[_0x71b861(0x1c0)][_0x71b861(0x238)](_0x3a30f4['id'],_0x2e9141===null||_0x2e9141===void 0x0?void 0x0:_0x2e9141['id']);return;}async[_0x261947(0x1c7)](_0x2a689f,_0xaaf2ff){const _0x478795=_0x261947,_0x479aed=await this[_0x478795(0x1f2)][_0x478795(0x23d)](_0x2a689f),{username:_0x42c566,id:_0x1f9675,email:_0xd771d0,role:_0x57a374,openId:_0x38240c,client:_0x1ba687}=_0x479aed,_0x3fb827=(0x0,utils_1['getClientIp'])(_0xaaf2ff);await this[_0x478795(0x1f2)]['savaLoginIp'](_0x1f9675,_0x3fb827);const _0x5a866c=await this[_0x478795(0x204)][_0x478795(0x213)]({'username':_0x42c566,'id':_0x1f9675,'email':_0xd771d0,'role':_0x57a374,'openId':_0x38240c,'client':_0x1ba687});return await this[_0x478795(0x1cd)][_0x478795(0x210)](_0x1f9675,_0x5a866c),_0x5a866c;}async['loginByPhone'](_0x3d4cea,_0x372fd6){const _0x8641f0=_0x261947,_0x1db636=await this[_0x8641f0(0x1f2)][_0x8641f0(0x23d)](_0x3d4cea),{username:_0x555ff0,id:_0x1a0637,email:_0x5ecfbb,role:_0x440a4b,openId:_0x4494d8,client:_0x582cb5}=_0x1db636,_0x354d2f=(0x0,utils_1[_0x8641f0(0x246)])(_0x372fd6);await this[_0x8641f0(0x1f2)][_0x8641f0(0x1c3)](_0x1a0637,_0x354d2f);const {phone:_0xa3f777}=_0x3d4cea,_0x589299=await this['jwtService'][_0x8641f0(0x213)]({'username':_0x555ff0,'id':_0x1a0637,'email':_0x5ecfbb,'role':_0x440a4b,'openId':_0x4494d8,'client':_0x582cb5,'phone':_0xa3f777});return await this['redisCacheService'][_0x8641f0(0x210)](_0x1a0637,_0x589299),_0x589299;}async[_0x261947(0x22d)](_0x48dfbd,_0x4720e7){const _0x491505=_0x261947,{status:_0x334c07}=_0x48dfbd;if(_0x334c07!==user_constant_1['UserStatusEnum'][_0x491505(0x1eb)])throw new common_1[(_0x491505(0x1e2))](user_constant_1[_0x491505(0x230)][_0x334c07],common_1[_0x491505(0x21e)]['BAD_REQUEST']);const {username:_0x38f5c3,id:_0x35de08,email:_0x29d4bd,role:_0x18e56d,openId:_0xaaa890,client:_0x5c9f95}=_0x48dfbd,_0x2cf68a=(0x0,utils_1[_0x491505(0x246)])(_0x4720e7);await this[_0x491505(0x1f2)]['savaLoginIp'](_0x35de08,_0x2cf68a);const _0x9909fb=await this[_0x491505(0x204)][_0x491505(0x213)]({'username':_0x38f5c3,'id':_0x35de08,'email':_0x29d4bd,'role':_0x18e56d,'openId':_0xaaa890,'client':_0x5c9f95});return await this[_0x491505(0x1cd)][_0x491505(0x210)](_0x35de08,_0x9909fb),_0x9909fb;}async[_0x261947(0x23b)](_0x5071e1){const _0x53a481=_0x261947,{id:_0x2b77b8}=_0x5071e1[_0x53a481(0x1f7)];return await this[_0x53a481(0x1f2)][_0x53a481(0x1ca)](_0x2b77b8);}async[_0x261947(0x1cb)](_0x3ed714,_0x520021){const _0x400123=_0x261947,_0x3cfded=await this[_0x400123(0x220)][_0x400123(0x1fa)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x400123(0x22e),_0x400123(0x1cf),_0x400123(0x21c),_0x400123(0x1e9),_0x400123(0x1ef)])}}),_0x1f88d8=_0x3cfded['reduce']((_0x40be97,_0x124971)=>{const _0x1ef905=_0x400123;return _0x40be97[_0x124971[_0x1ef905(0x23a)]]=_0x124971[_0x1ef905(0x212)],_0x40be97;},{});try{const _0x8a00fe=await this[_0x400123(0x1f4)][_0x400123(0x218)](_0x3ed714,verification_constant_1[_0x400123(0x1d5)]['Registration']),{type:_0x29853f,userId:_0x8971c5}=_0x8a00fe;if(_0x29853f!==verification_constant_1['VerificationEnum'][_0x400123(0x247)])throw new common_1[(_0x400123(0x1e2))]('验证码类型错误',common_1[_0x400123(0x21e)][_0x400123(0x1da)]);const _0xd01534=await this[_0x400123(0x1f2)][_0x400123(0x236)](_0x8971c5);if(_0xd01534===user_constant_1['UserStatusEnum'][_0x400123(0x1eb)])throw new common_1[(_0x400123(0x1e2))](_0x400123(0x231),common_1[_0x400123(0x21e)][_0x400123(0x1da)]);await this['userService'][_0x400123(0x1ee)](_0x8a00fe['userId'],user_constant_1[_0x400123(0x248)][_0x400123(0x1eb)]);const _0x1f392b=await this['userService'][_0x400123(0x1c1)](_0x8a00fe['userId']),{username:_0x2d7dd2,email:_0x4437cf,id:_0x31626b,invitedBy:_0x1a413b}=_0x1f392b;let _0x4bf93f;_0x1a413b&&(_0x4bf93f=await this[_0x400123(0x1f2)][_0x400123(0x1fc)](_0x1a413b)),await this[_0x400123(0x1c0)][_0x400123(0x238)](_0x31626b,_0x4bf93f===null||_0x4bf93f===void 0x0?void 0x0:_0x4bf93f['id']),_0x520021['redirect'](_0x400123(0x22a)+_0x31626b['toString']()['padStart'](0x4,'0')+_0x400123(0x1d6)+_0x2d7dd2+_0x400123(0x20b)+_0x4437cf+'&registerSuccessEmailTitle='+_0x1f88d8[_0x400123(0x22e)]+_0x400123(0x1e7)+_0x1f88d8[_0x400123(0x1cf)]+_0x400123(0x221)+_0x1f88d8[_0x400123(0x21c)]);}catch(_0x53b035){console[_0x400123(0x233)](_0x400123(0x1c2),_0x53b035);const _0x1f3664=_0x53b035[_0x400123(0x1f3)];_0x520021[_0x400123(0x237)](_0x400123(0x1c6)+_0x1f3664+_0x400123(0x207)+_0x1f88d8[_0x400123(0x1e9)]+_0x400123(0x222)+_0x1f88d8[_0x400123(0x1ef)]);}}async[_0x261947(0x1e4)](_0x4eaaf2,_0x477e41){const _0x3e7666=_0x261947,{id:_0x4240f1,client:_0xa39d34,role:_0x588dd3}=_0x4eaaf2[_0x3e7666(0x1f7)];if(_0xa39d34&&Number(_0xa39d34)>0x0)throw new common_1[(_0x3e7666(0x1e2))](_0x3e7666(0x1c9),common_1['HttpStatus'][_0x3e7666(0x1da)]);if(_0x588dd3===_0x3e7666(0x244))throw new common_1[(_0x3e7666(0x1e2))](_0x3e7666(0x1c4),common_1['HttpStatus'][_0x3e7666(0x1da)]);const _0x3ff936=await this['userService'][_0x3e7666(0x1fb)](_0x4240f1,_0x477e41['oldPassword']);if(!_0x3ff936)throw new common_1[(_0x3e7666(0x1e2))](_0x3e7666(0x206),common_1[_0x3e7666(0x21e)][_0x3e7666(0x1da)]);return this[_0x3e7666(0x1f2)][_0x3e7666(0x239)](_0x4240f1,_0x477e41[_0x3e7666(0x1e0)]),_0x3e7666(0x1ed);}async[_0x261947(0x1dc)](_0x11a7c8,_0x5b1833){const _0x35549f=_0x261947,{id:_0x31a67e,client:_0x53e079}=_0x11a7c8[_0x35549f(0x1f7)];if(!_0x53e079)throw new common_1[(_0x35549f(0x1e2))]('无权此操作！',common_1[_0x35549f(0x21e)][_0x35549f(0x1da)]);return this[_0x35549f(0x1f2)][_0x35549f(0x239)](_0x31a67e,_0x5b1833[_0x35549f(0x1e0)]),_0x35549f(0x1ed);}['getIp'](){const _0x100a7e=_0x261947;let _0x58c0cf;const _0x4fe02b=os[_0x100a7e(0x1e1)]();Object[_0x100a7e(0x215)](_0x4fe02b)['forEach'](_0x409b5d=>{const _0x4e1871=_0x100a7e,_0x1553bb=_0x4fe02b[_0x409b5d];for(let _0x384910=0x0;_0x384910<_0x1553bb['length'];_0x384910++){const _0xeefc83=_0x1553bb[_0x384910];if(_0xeefc83['family']===_0x4e1871(0x228)&&_0xeefc83[_0x4e1871(0x22f)]!==_0x4e1871(0x1d2)&&!_0xeefc83['internal']){_0x58c0cf=_0xeefc83[_0x4e1871(0x22f)];break;}}}),this[_0x100a7e(0x1e6)]=_0x58c0cf;}async[_0x261947(0x205)](_0x5df378){const _0xa10d0b=_0x261947,_0x363068=await this[_0xa10d0b(0x241)][_0xa10d0b(0x22c)](),{color:color='#fff'}=_0x5df378,_0x926b1e=svgCaptcha[_0xa10d0b(0x1fe)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x3df6b2=_0x926b1e[_0xa10d0b(0x214)],_0x5676ef=(0x0,utils_1[_0xa10d0b(0x216)])(),_0x1ec1b0=_0x363068+_0xa10d0b(0x234)+_0x5676ef;return await this[_0xa10d0b(0x1cd)][_0xa10d0b(0x1f1)]({'key':_0x1ec1b0,'val':_0x926b1e[_0xa10d0b(0x214)]},0x5*0x3c),{'svgCode':_0x926b1e[_0xa10d0b(0x22b)],'code':_0x5676ef};}async[_0x261947(0x1d1)](_0x168412){const _0x4a2bd6=_0x261947;await this['verificationService'][_0x4a2bd6(0x203)](_0x168412);const {phone:_0x500def}=_0x168412,_0x424e45=await this['globalConfigService']['getNamespace'](),_0x3da016=_0x424e45+':PHONECODE:'+_0x500def,_0x43f3a7=await this[_0x4a2bd6(0x1cd)][_0x4a2bd6(0x1e8)](_0x3da016);if(_0x43f3a7&&_0x43f3a7>0x0)throw new common_1[(_0x4a2bd6(0x1e2))](_0x43f3a7+_0x4a2bd6(0x217),common_1[_0x4a2bd6(0x21e)][_0x4a2bd6(0x1da)]);const _0xdd34e5=(0x0,utils_1[_0x4a2bd6(0x1f6)])(),_0x3d538d={'phone':_0x500def,'code':_0xdd34e5};return await this[_0x4a2bd6(0x1f4)][_0x4a2bd6(0x240)](_0x3d538d),await this[_0x4a2bd6(0x1cd)][_0x4a2bd6(0x1f1)]({'key':_0x3da016,'val':_0xdd34e5},0x1*0x3c),'验证码发送成功、请填写验证码完成注册！';}['createTokenFromFingerprint'](_0x38efd1){const _0x3bfceb=_0x261947,_0x39e24b=this[_0x3bfceb(0x204)][_0x3bfceb(0x213)]({'username':'游客'+_0x38efd1,'id':_0x38efd1,'email':_0x38efd1+_0x3bfceb(0x20e),'role':_0x3bfceb(0x20f),'openId':null,'client':null});return _0x39e24b;}};AuthService=__decorate([(0x0,common_1[_0x261947(0x1d9)])(),__param(0x0,(0x0,typeorm_2[_0x261947(0x1de)])(config_entity_1['ConfigEntity'])),__metadata(_0x261947(0x201),[typeorm_1[_0x261947(0x1f9)],user_service_1[_0x261947(0x20c)],jwt_1['JwtService'],mailer_service_1[_0x261947(0x200)],verification_service_1['VerificationService'],userBalance_service_1[_0x261947(0x1e5)],redisCache_service_1[_0x261947(0x227)],globalConfig_service_1[_0x261947(0x1e3)]])],AuthService),exports['AuthService']=AuthService;