'use strict';function _0x13e0(_0x2d1243,_0x24c4c7){const _0x2fd931=_0x2fd9();return _0x13e0=function(_0x13e027,_0x3ac5ec){_0x13e027=_0x13e027-0xaa;let _0x1dc242=_0x2fd931[_0x13e027];return _0x1dc242;},_0x13e0(_0x2d1243,_0x24c4c7);}const _0x3819d3=_0x13e0;(function(_0x37095c,_0x1077e5){const _0x10c826=_0x13e0,_0x194060=_0x37095c();while(!![]){try{const _0x56edd2=parseInt(_0x10c826(0xd8))/0x1+-parseInt(_0x10c826(0xaf))/0x2*(parseInt(_0x10c826(0xbd))/0x3)+-parseInt(_0x10c826(0xb2))/0x4*(-parseInt(_0x10c826(0xd0))/0x5)+-parseInt(_0x10c826(0xbe))/0x6+parseInt(_0x10c826(0xc8))/0x7+-parseInt(_0x10c826(0xba))/0x8+parseInt(_0x10c826(0xd5))/0x9;if(_0x56edd2===_0x1077e5)break;else _0x194060['push'](_0x194060['shift']());}catch(_0x15da6c){_0x194060['push'](_0x194060['shift']());}}}(_0x2fd9,0x8ed4a));var __decorate=this&&this[_0x3819d3(0xab)]||function(_0x224ee9,_0x2101c8,_0x2f724d,_0x5547f3){const _0x34e5e3=_0x3819d3;var _0x1f7590=arguments[_0x34e5e3(0xc5)],_0x4e8711=_0x1f7590<0x3?_0x2101c8:_0x5547f3===null?_0x5547f3=Object[_0x34e5e3(0xb1)](_0x2101c8,_0x2f724d):_0x5547f3,_0x20c7a0;if(typeof Reflect===_0x34e5e3(0xc0)&&typeof Reflect['decorate']===_0x34e5e3(0xc3))_0x4e8711=Reflect[_0x34e5e3(0xd3)](_0x224ee9,_0x2101c8,_0x2f724d,_0x5547f3);else{for(var _0x55cbcf=_0x224ee9['length']-0x1;_0x55cbcf>=0x0;_0x55cbcf--)if(_0x20c7a0=_0x224ee9[_0x55cbcf])_0x4e8711=(_0x1f7590<0x3?_0x20c7a0(_0x4e8711):_0x1f7590>0x3?_0x20c7a0(_0x2101c8,_0x2f724d,_0x4e8711):_0x20c7a0(_0x2101c8,_0x2f724d))||_0x4e8711;}return _0x1f7590>0x3&&_0x4e8711&&Object['defineProperty'](_0x2101c8,_0x2f724d,_0x4e8711),_0x4e8711;},__metadata=this&&this[_0x3819d3(0xd1)]||function(_0x4729cf,_0x5fb076){const _0xc1de99=_0x3819d3;if(typeof Reflect===_0xc1de99(0xc0)&&typeof Reflect[_0xc1de99(0xb3)]===_0xc1de99(0xc3))return Reflect[_0xc1de99(0xb3)](_0x4729cf,_0x5fb076);},__param=this&&this['__param']||function(_0x8248af,_0x2d0f3e){return function(_0x20e9e1,_0x5a3915){_0x2d0f3e(_0x20e9e1,_0x5a3915,_0x8248af);};};Object[_0x3819d3(0xc1)](exports,_0x3819d3(0xb4),{'value':!![]}),exports[_0x3819d3(0xc2)]=void 0x0;const common_1=require(_0x3819d3(0xd4)),bull_1=require('@nestjs/bull'),utils_1=require('../../common/utils'),midjourney_service_1=require('../midjourney/midjourney.service'),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require(_0x3819d3(0xad));function _0x2fd9(){const _0x209f86=['618837cBBEhx','581040heVrqD','mjTimeoutMs','object','defineProperty','QueueService','function','InjectQueue','length','createRandomUid','userBalanceService','5837580PAYyDs','add','push','checkLimit','mjDrawQueue','HttpStatus','assign','addDrawQueue','5DDdNNw','__metadata','mjDraw','decorate','@nestjs/common','3732840fwXklB','缺少必要参数！','active','361959WJUgsz','jobIds','GlobalConfigService','design:paramtypes','user','globalConfigService','getQueue','__decorate','midjourneyService','../globalConfig/globalConfig.service','UPSCALE','4vVKCYo','getConfigs','getOwnPropertyDescriptor','782320fluALN','metadata','__esModule','getDrawActionDetail','HttpException','clean','validateBalance','cleanQueue','5694456tAVIDB','MidjourneyService','IMAGINE'];_0x2fd9=function(){return _0x209f86;};return _0x2fd9();}let QueueService=class QueueService{constructor(_0x1317ab,_0x315d7a,_0x36d464,_0x2ab6f8){const _0x34d294=_0x3819d3;this[_0x34d294(0xcc)]=_0x1317ab,this['midjourneyService']=_0x315d7a,this[_0x34d294(0xc7)]=_0x36d464,this[_0x34d294(0xdd)]=_0x2ab6f8,this['jobIds']=[];}async['onApplicationBootstrap'](){const _0x1c7132=_0x3819d3;await this['mjDrawQueue'][_0x1c7132(0xb7)](0x0,_0x1c7132(0xd7)),await this[_0x1c7132(0xac)][_0x1c7132(0xb9)]();}async['addMjDrawQueue'](_0x270064,_0x52eae2){const _0x6c8848=_0x3819d3,{imgUrl:_0x2f657f,orderId:_0x171231,action:_0xb31e56,drawId:_0x59eb61}=_0x270064;await this[_0x6c8848(0xac)][_0x6c8848(0xcb)](_0x52eae2),await this['userBalanceService'][_0x6c8848(0xb8)](_0x52eae2,_0x6c8848(0xd2),_0xb31e56===_0x6c8848(0xae)?0x1:0x4);if(_0xb31e56===_0x6c8848(0xbc)){const _0x174167=''+(0x0,utils_1[_0x6c8848(0xc6)])(),_0x1f0da6=Object[_0x6c8848(0xce)](Object['assign']({},_0x270064),{'userId':_0x52eae2[_0x6c8848(0xdc)]['id'],'randomDrawId':_0x174167}),_0x171a08=await this[_0x6c8848(0xac)][_0x6c8848(0xcf)](_0x1f0da6),_0x4bbea3=await this[_0x6c8848(0xdd)][_0x6c8848(0xb0)]([_0x6c8848(0xbf)])||0x30d40,_0x4f178a=await this[_0x6c8848(0xcc)]['add'](_0x6c8848(0xd2),{'id':_0x171a08['id'],'action':_0xb31e56,'userId':_0x52eae2[_0x6c8848(0xdc)]['id']},{'delay':0x3e8,'timeout':+_0x4bbea3});return this['jobIds'][_0x6c8848(0xca)](_0x4f178a['id']),!![];}else{const {orderId:_0x22dc9d,action:_0x5dfc4d,drawId:_0x215539}=_0x270064,_0xb6cfc6=await this[_0x6c8848(0xac)][_0x6c8848(0xb5)](_0x5dfc4d,_0x215539,_0x22dc9d),_0x3982c0=Object[_0x6c8848(0xce)](Object[_0x6c8848(0xce)](Object[_0x6c8848(0xce)]({},_0x270064),{'userId':_0x52eae2[_0x6c8848(0xdc)]['id']}),_0xb6cfc6),_0x42a07d=await this[_0x6c8848(0xac)][_0x6c8848(0xcf)](_0x3982c0),_0x20d0ba=await this[_0x6c8848(0xdd)][_0x6c8848(0xb0)]([_0x6c8848(0xbf)])||0x30d40,_0x484b88=await this['mjDrawQueue'][_0x6c8848(0xc9)](_0x6c8848(0xd2),{'id':_0x42a07d['id'],'action':_0x5dfc4d,'userId':_0x52eae2[_0x6c8848(0xdc)]['id']},{'delay':0x3e8,'timeout':+_0x20d0ba});this[_0x6c8848(0xd9)]['push'](_0x484b88['id']);return;}if(!_0x59eb61||!_0x171231)throw new common_1[(_0x6c8848(0xb6))](_0x6c8848(0xd6),common_1[_0x6c8848(0xcd)]['BAD_REQUEST']);}async[_0x3819d3(0xaa)](){const _0x41ac66=_0x3819d3;return{'jobIds':this[_0x41ac66(0xd9)]};}};QueueService=__decorate([__param(0x0,(0x0,bull_1[_0x3819d3(0xc4)])('MJDRAW')),__metadata(_0x3819d3(0xdb),[Object,midjourney_service_1[_0x3819d3(0xbb)],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x3819d3(0xda)]])],QueueService),exports[_0x3819d3(0xc2)]=QueueService;