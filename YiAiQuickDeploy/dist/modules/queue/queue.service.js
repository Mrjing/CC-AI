'use strict';const _0xff18a5=_0x4a2c;(function(_0x77255b,_0x4b0bff){const _0x9c65d3=_0x4a2c,_0x4c06e9=_0x77255b();while(!![]){try{const _0x45fbfa=parseInt(_0x9c65d3(0x1d9))/0x1+-parseInt(_0x9c65d3(0x1eb))/0x2+parseInt(_0x9c65d3(0x203))/0x3*(-parseInt(_0x9c65d3(0x1f0))/0x4)+-parseInt(_0x9c65d3(0x1d2))/0x5+parseInt(_0x9c65d3(0x1fc))/0x6*(-parseInt(_0x9c65d3(0x1e7))/0x7)+parseInt(_0x9c65d3(0x200))/0x8+-parseInt(_0x9c65d3(0x1ee))/0x9*(-parseInt(_0x9c65d3(0x1db))/0xa);if(_0x45fbfa===_0x4b0bff)break;else _0x4c06e9['push'](_0x4c06e9['shift']());}catch(_0x2a2b63){_0x4c06e9['push'](_0x4c06e9['shift']());}}}(_0x2c42,0xa33d8));function _0x4a2c(_0x340af6,_0xa62a3d){const _0x2c422e=_0x2c42();return _0x4a2c=function(_0x4a2cf0,_0x134679){_0x4a2cf0=_0x4a2cf0-0x1d2;let _0x1edf71=_0x2c422e[_0x4a2cf0];return _0x1edf71;},_0x4a2c(_0x340af6,_0xa62a3d);}var __decorate=this&&this[_0xff18a5(0x1f3)]||function(_0x57920e,_0xb80466,_0x185ff9,_0x5289e5){const _0x1ae221=_0xff18a5;var _0x567e38=arguments['length'],_0x2c204a=_0x567e38<0x3?_0xb80466:_0x5289e5===null?_0x5289e5=Object['getOwnPropertyDescriptor'](_0xb80466,_0x185ff9):_0x5289e5,_0x1c239e;if(typeof Reflect===_0x1ae221(0x1dc)&&typeof Reflect[_0x1ae221(0x1e9)]===_0x1ae221(0x1e6))_0x2c204a=Reflect[_0x1ae221(0x1e9)](_0x57920e,_0xb80466,_0x185ff9,_0x5289e5);else{for(var _0x1dbf74=_0x57920e['length']-0x1;_0x1dbf74>=0x0;_0x1dbf74--)if(_0x1c239e=_0x57920e[_0x1dbf74])_0x2c204a=(_0x567e38<0x3?_0x1c239e(_0x2c204a):_0x567e38>0x3?_0x1c239e(_0xb80466,_0x185ff9,_0x2c204a):_0x1c239e(_0xb80466,_0x185ff9))||_0x2c204a;}return _0x567e38>0x3&&_0x2c204a&&Object[_0x1ae221(0x1da)](_0xb80466,_0x185ff9,_0x2c204a),_0x2c204a;},__metadata=this&&this['__metadata']||function(_0x1c5ec1,_0x402987){const _0x34140d=_0xff18a5;if(typeof Reflect===_0x34140d(0x1dc)&&typeof Reflect[_0x34140d(0x1dd)]===_0x34140d(0x1e6))return Reflect[_0x34140d(0x1dd)](_0x1c5ec1,_0x402987);},__param=this&&this[_0xff18a5(0x1f2)]||function(_0x954746,_0x19c98c){return function(_0x273329,_0x1754d1){_0x19c98c(_0x273329,_0x1754d1,_0x954746);};};Object[_0xff18a5(0x1da)](exports,'__esModule',{'value':!![]}),exports[_0xff18a5(0x201)]=void 0x0;function _0x2c42(){const _0x57e953=['7615866lPPJXW','addDrawQueue','mjTimeoutMs','getConfigs','4123584MTjkcL','QueueService','user','3600oNkgrS','UserBalanceService','1537995wTBikG','design:paramtypes','checkLimit','createRandomUid','midjourneyService','add','BAD_REQUEST','417063IKEqLP','defineProperty','84650FoqneO','object','metadata','addMjDrawQueue','MJDRAW','InjectQueue','push','缺少必要参数！','GlobalConfigService','MidjourneyService','HttpException','function','7tgKPIm','UPSCALE','decorate','assign','2591428eiBzGE','../midjourney/midjourney.service','../../common/utils','2817jjPUrC','getDrawActionDetail','136RVKiAO','globalConfigService','__param','__decorate','@nestjs/common','userBalanceService','../userBalance/userBalance.service','@nestjs/bull','mjDrawQueue','jobIds','getQueue','mjDraw'];_0x2c42=function(){return _0x57e953;};return _0x2c42();}const common_1=require(_0xff18a5(0x1f4)),bull_1=require(_0xff18a5(0x1f7)),utils_1=require(_0xff18a5(0x1ed)),midjourney_service_1=require(_0xff18a5(0x1ec)),userBalance_service_1=require(_0xff18a5(0x1f6)),globalConfig_service_1=require('../globalConfig/globalConfig.service');let QueueService=class QueueService{constructor(_0x1a0276,_0x3ce1ed,_0x9afaa2,_0x593fb6){const _0x495378=_0xff18a5;this['mjDrawQueue']=_0x1a0276,this[_0x495378(0x1d6)]=_0x3ce1ed,this[_0x495378(0x1f5)]=_0x9afaa2,this[_0x495378(0x1f1)]=_0x593fb6,this['jobIds']=[];}async['onApplicationBootstrap'](){const _0x1370c3=_0xff18a5;await this[_0x1370c3(0x1f8)]['clean'](0x0,'active'),await this[_0x1370c3(0x1d6)]['cleanQueue']();}async[_0xff18a5(0x1de)](_0x1c0e32,_0x280a3a){const _0x2ce638=_0xff18a5,{imgUrl:_0x282c50,orderId:_0x4aaa86,action:_0x25042e,drawId:_0x904f7c}=_0x1c0e32;await this['midjourneyService'][_0x2ce638(0x1d4)](_0x280a3a),await this['userBalanceService']['validateBalance'](_0x280a3a,_0x2ce638(0x1fb),_0x25042e===_0x2ce638(0x1e8)?0x1:0x4);if(_0x25042e==='IMAGINE'){const _0x4871be=''+(0x0,utils_1[_0x2ce638(0x1d5)])(),_0x4f21ac=Object[_0x2ce638(0x1ea)](Object[_0x2ce638(0x1ea)]({},_0x1c0e32),{'userId':_0x280a3a[_0x2ce638(0x202)]['id'],'randomDrawId':_0x4871be}),_0x35667d=await this[_0x2ce638(0x1d6)][_0x2ce638(0x1fd)](_0x4f21ac),_0x343593=await this[_0x2ce638(0x1f1)][_0x2ce638(0x1ff)](['mjTimeoutMs'])||0x30d40,_0x4d4450=await this['mjDrawQueue'][_0x2ce638(0x1d7)](_0x2ce638(0x1fb),{'id':_0x35667d['id'],'action':_0x25042e,'userId':_0x280a3a['user']['id']},{'delay':0x3e8,'timeout':+_0x343593});return this[_0x2ce638(0x1f9)][_0x2ce638(0x1e1)](_0x4d4450['id']),!![];}else{const {orderId:_0x1aed83,action:_0x23587e,drawId:_0x142691}=_0x1c0e32,_0x1f0136=await this[_0x2ce638(0x1d6)][_0x2ce638(0x1ef)](_0x23587e,_0x142691,_0x1aed83),_0x363d5b=Object['assign'](Object[_0x2ce638(0x1ea)](Object[_0x2ce638(0x1ea)]({},_0x1c0e32),{'userId':_0x280a3a['user']['id']}),_0x1f0136),_0x2f34b9=await this['midjourneyService'][_0x2ce638(0x1fd)](_0x363d5b),_0x5c0480=await this[_0x2ce638(0x1f1)][_0x2ce638(0x1ff)]([_0x2ce638(0x1fe)])||0x30d40,_0xe688dc=await this['mjDrawQueue'][_0x2ce638(0x1d7)](_0x2ce638(0x1fb),{'id':_0x2f34b9['id'],'action':_0x23587e,'userId':_0x280a3a[_0x2ce638(0x202)]['id']},{'delay':0x3e8,'timeout':+_0x5c0480});this[_0x2ce638(0x1f9)][_0x2ce638(0x1e1)](_0xe688dc['id']);return;}if(!_0x904f7c||!_0x4aaa86)throw new common_1[(_0x2ce638(0x1e5))](_0x2ce638(0x1e2),common_1['HttpStatus'][_0x2ce638(0x1d8)]);}async[_0xff18a5(0x1fa)](){const _0x36d5c8=_0xff18a5;return{'jobIds':this[_0x36d5c8(0x1f9)]};}};QueueService=__decorate([__param(0x0,(0x0,bull_1[_0xff18a5(0x1e0)])(_0xff18a5(0x1df))),__metadata(_0xff18a5(0x1d3),[Object,midjourney_service_1[_0xff18a5(0x1e4)],userBalance_service_1[_0xff18a5(0x204)],globalConfig_service_1[_0xff18a5(0x1e3)]])],QueueService),exports[_0xff18a5(0x201)]=QueueService;