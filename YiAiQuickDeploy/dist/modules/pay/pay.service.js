'use strict';const _0x312b31=_0x1116;function _0x1116(_0x381c59,_0x8080b9){const _0x22f71d=_0x22f7();return _0x1116=function(_0x11169e,_0x29106){_0x11169e=_0x11169e-0xec;let _0x9a5490=_0x22f71d[_0x11169e];return _0x9a5490;},_0x1116(_0x381c59,_0x8080b9);}(function(_0xa128ef,_0x5de6fe){const _0x2daf54=_0x1116,_0x45404b=_0xa128ef();while(!![]){try{const _0x5e6c0f=parseInt(_0x2daf54(0x182))/0x1+parseInt(_0x2daf54(0x103))/0x2+-parseInt(_0x2daf54(0x178))/0x3*(parseInt(_0x2daf54(0x133))/0x4)+-parseInt(_0x2daf54(0x15d))/0x5*(parseInt(_0x2daf54(0x181))/0x6)+-parseInt(_0x2daf54(0x197))/0x7*(-parseInt(_0x2daf54(0x19a))/0x8)+-parseInt(_0x2daf54(0xf4))/0x9+parseInt(_0x2daf54(0x12b))/0xa;if(_0x5e6c0f===_0x5de6fe)break;else _0x45404b['push'](_0x45404b['shift']());}catch(_0x253459){_0x45404b['push'](_0x45404b['shift']());}}}(_0x22f7,0x9a5ac));var __decorate=this&&this[_0x312b31(0x192)]||function(_0xd19aad,_0x39868b,_0x117cf0,_0x28218a){const _0x1d1956=_0x312b31;var _0x19298e=arguments[_0x1d1956(0x17b)],_0x49e00b=_0x19298e<0x3?_0x39868b:_0x28218a===null?_0x28218a=Object[_0x1d1956(0x11e)](_0x39868b,_0x117cf0):_0x28218a,_0xaef30f;if(typeof Reflect===_0x1d1956(0x140)&&typeof Reflect[_0x1d1956(0x120)]===_0x1d1956(0x15e))_0x49e00b=Reflect[_0x1d1956(0x120)](_0xd19aad,_0x39868b,_0x117cf0,_0x28218a);else{for(var _0x4e6030=_0xd19aad['length']-0x1;_0x4e6030>=0x0;_0x4e6030--)if(_0xaef30f=_0xd19aad[_0x4e6030])_0x49e00b=(_0x19298e<0x3?_0xaef30f(_0x49e00b):_0x19298e>0x3?_0xaef30f(_0x39868b,_0x117cf0,_0x49e00b):_0xaef30f(_0x39868b,_0x117cf0))||_0x49e00b;}return _0x19298e>0x3&&_0x49e00b&&Object[_0x1d1956(0x17d)](_0x39868b,_0x117cf0,_0x49e00b),_0x49e00b;},__metadata=this&&this[_0x312b31(0x176)]||function(_0xb19d4a,_0x4e4ee4){const _0x5adda4=_0x312b31;if(typeof Reflect===_0x5adda4(0x140)&&typeof Reflect[_0x5adda4(0x11b)]===_0x5adda4(0x15e))return Reflect[_0x5adda4(0x11b)](_0xb19d4a,_0x4e4ee4);},__param=this&&this[_0x312b31(0x128)]||function(_0x37c945,_0x409962){return function(_0x173595,_0x358fd8){_0x409962(_0x173595,_0x358fd8,_0x37c945);};};Object[_0x312b31(0x17d)](exports,_0x312b31(0xed),{'value':!![]}),exports[_0x312b31(0x10a)]=void 0x0;const typeorm_1=require(_0x312b31(0x11d)),typeorm_2=require(_0x312b31(0x126)),common_1=require('@nestjs/common'),crypto=require(_0x312b31(0xfd)),axios_1=require(_0x312b31(0x149)),order_entity_1=require(_0x312b31(0x158)),cramiPackage_entity_1=require(_0x312b31(0x143)),userBalance_service_1=require(_0x312b31(0x17a)),globalConfig_service_1=require(_0x312b31(0x173)),utils_1=require(_0x312b31(0x132)),user_service_1=require(_0x312b31(0x189));let PayService=class PayService{constructor(_0x25ba29,_0x5297d2,_0x226262,_0x35154b,_0x425a87){const _0x4bb2dd=_0x312b31;this['cramiPackageEntity']=_0x25ba29,this[_0x4bb2dd(0xf3)]=_0x5297d2,this[_0x4bb2dd(0x110)]=_0x226262,this[_0x4bb2dd(0x129)]=_0x35154b,this['userService']=_0x425a87;}async['onModuleInit'](){const _0x13bf49=_0x312b31,_0x377112=await(0x0,utils_1[_0x13bf49(0xf0)])(_0x13bf49(0x11f));this[_0x13bf49(0x15a)]=(_0x377112===null||_0x377112===void 0x0?void 0x0:_0x377112[_0x13bf49(0x188)])?_0x377112[_0x13bf49(0x188)]:_0x377112;}async[_0x312b31(0x14b)](_0x29d6c8){const _0x243af7=_0x312b31;if(_0x29d6c8['param']==_0x243af7(0x172))return this[_0x243af7(0x190)](_0x29d6c8);if(_0x29d6c8['attach']==_0x243af7(0x108))return this[_0x243af7(0x123)](_0x29d6c8);if(typeof _0x29d6c8[_0x243af7(0xfb)]=='object')return this[_0x243af7(0x16e)](_0x29d6c8);return this['notifyMpay'](_0x29d6c8);}async[_0x312b31(0x142)](_0x3af45,_0xdb9f9b,_0x1bf689=_0x312b31(0x107)){const _0x3e4955=_0x312b31,_0x3c2d4e=await this[_0x3e4955(0xf3)][_0x3e4955(0x134)]({'where':{'userId':_0x3af45,'orderId':_0xdb9f9b}});if(!_0x3c2d4e)throw new common_1[(_0x3e4955(0xf8))](_0x3e4955(0x13d),common_1[_0x3e4955(0x100)][_0x3e4955(0x155)]);const _0x88d115=await this['cramiPackageEntity'][_0x3e4955(0x134)]({'where':{'id':_0x3c2d4e[_0x3e4955(0x119)]}});if(!_0x88d115)throw new common_1[(_0x3e4955(0xf8))](_0x3e4955(0x18e),common_1['HttpStatus']['BAD_REQUEST']);console[_0x3e4955(0x154)]('本次支付类型:\x20',_0x3c2d4e['payPlatform']);try{if(_0x3c2d4e[_0x3e4955(0x186)]=='wechat')return this[_0x3e4955(0xf1)](_0x3af45,_0xdb9f9b,_0x1bf689);if(_0x3c2d4e[_0x3e4955(0x186)]==_0x3e4955(0x172))return this['payEpay'](_0x3af45,_0xdb9f9b,_0x1bf689);if(_0x3c2d4e['payPlatform']==_0x3e4955(0xec))return this[_0x3e4955(0x10f)](_0x3af45,_0xdb9f9b,_0x1bf689);if(_0x3c2d4e['payPlatform']==_0x3e4955(0x108))return this['payHupi'](_0x3af45,_0xdb9f9b,_0x1bf689);}catch(_0x397a67){console['log']('支付请求失败:\x20',_0x397a67);throw new common_1[(_0x3e4955(0xf8))](_0x3e4955(0x12d),common_1[_0x3e4955(0x100)][_0x3e4955(0x155)]);}}async['query'](_0x1e8d45){const _0x12d87d=_0x312b31,_0x23d0b3=await this[_0x12d87d(0xf3)]['findOne']({'where':{'orderId':_0x1e8d45}});if(!_0x23d0b3)throw new common_1[(_0x12d87d(0xf8))](_0x12d87d(0x13d),common_1[_0x12d87d(0x100)][_0x12d87d(0x155)]);return _0x23d0b3;}async['notifyHupi'](_0x29f622){const _0x3c0166=_0x312b31,_0x566c03=await this[_0x3c0166(0x129)][_0x3c0166(0x147)]([_0x3c0166(0x111)]),_0x5beddd=_0x29f622[_0x3c0166(0x187)];delete _0x29f622[_0x3c0166(0x187)];if(this[_0x3c0166(0x102)](_0x29f622,_0x566c03)!=_0x5beddd)return _0x3c0166(0x13b);const _0x1ed1f2=await this[_0x3c0166(0xf3)]['findOne']({'where':{'orderId':_0x29f622[_0x3c0166(0x138)],'status':0x0}});if(!_0x1ed1f2)return _0x3c0166(0x13b);await this['userBalanceService'][_0x3c0166(0x105)](_0x1ed1f2);const _0x561d08=await this[_0x3c0166(0xf3)][_0x3c0166(0x17e)]({'orderId':_0x29f622[_0x3c0166(0x138)]},{'status':0x1,'paydAt':new Date()});if(_0x561d08[_0x3c0166(0x18a)]!=0x1)return _0x3c0166(0x13b);return _0x3c0166(0x183);}async['payHupi'](_0xb0b065,_0x28dbe9,_0x1721f2='wxpay'){const _0x567812=_0x312b31,_0x23b7ee=await this[_0x567812(0xf3)][_0x567812(0x134)]({'where':{'userId':_0xb0b065,'orderId':_0x28dbe9}});if(!_0x23b7ee)throw new common_1['HttpException'](_0x567812(0x13d),common_1[_0x567812(0x100)]['BAD_REQUEST']);const _0x124ceb=await this['cramiPackageEntity'][_0x567812(0x134)]({'where':{'id':_0x23b7ee[_0x567812(0x119)]}});if(!_0x124ceb)throw new common_1[(_0x567812(0xf8))](_0x567812(0x18e),common_1[_0x567812(0x100)]['BAD_REQUEST']);const {payHupiAppId:_0x3f882e,payHupiSecret:_0x47a6a6,payHupiNotifyUrl:_0x3a01b0,payHupiReturnUrl:_0x5d8931,payHupiGatewayUrl:_0x2244a1}=await this[_0x567812(0x129)][_0x567812(0x147)]([_0x567812(0x18c),'payHupiSecret','payHupiNotifyUrl','payHupiReturnUrl',_0x567812(0x195)]),_0x249ca={};_0x249ca[_0x567812(0x146)]=_0x567812(0x144),_0x249ca[_0x567812(0x196)]=_0x3f882e,_0x249ca[_0x567812(0x131)]=(Date[_0x567812(0x13c)]()/0x3e8)[_0x567812(0x10b)](0x0),_0x249ca[_0x567812(0x130)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x249ca[_0x567812(0x138)]=_0x28dbe9,_0x249ca[_0x567812(0x166)]=_0x124ceb[_0x567812(0x157)],_0x249ca[_0x567812(0x141)]=_0x23b7ee[_0x567812(0x171)],_0x249ca['notify_url']=_0x3a01b0,_0x249ca[_0x567812(0x114)]=_0x5d8931,_0x249ca[_0x567812(0x162)]='hupi',_0x249ca[_0x567812(0x187)]=this[_0x567812(0x102)](_0x249ca,_0x47a6a6);const {data:{errcode:_0x6be4e2,errmsg:_0xcc8f94,url_qrcode:_0x3da95c,url:_0x5145b0}}=await axios_1[_0x567812(0x188)][_0x567812(0x124)](_0x2244a1||_0x567812(0x104),_0x249ca);if(_0x6be4e2!=0x0)throw new common_1[(_0x567812(0xf8))](_0xcc8f94,common_1[_0x567812(0x100)]['BAD_REQUEST']);return{'url_qrcode':_0x3da95c,'url':_0x5145b0};}async[_0x312b31(0x15b)](_0x5dd568){const _0x1aec58=_0x312b31,{payHupiAppId:_0x1dd2da,payHupiSecret:_0x1ac2f6}=await this[_0x1aec58(0x129)][_0x1aec58(0x147)]([_0x1aec58(0x18c),_0x1aec58(0x111)]),_0x25e4b3={};_0x25e4b3[_0x1aec58(0x146)]=_0x1aec58(0x144),_0x25e4b3[_0x1aec58(0x196)]=_0x1dd2da,_0x25e4b3['time']=(Date[_0x1aec58(0x13c)]()/0x3e8)[_0x1aec58(0x10b)](0x0),_0x25e4b3[_0x1aec58(0x130)]=(0x0,utils_1[_0x1aec58(0x16c)])(0x20),_0x25e4b3[_0x1aec58(0x165)]=_0x5dd568,_0x25e4b3[_0x1aec58(0x187)]=this[_0x1aec58(0x102)](_0x25e4b3,_0x1ac2f6);const {data:{errcode:_0x3c33c9,errmsg:_0x10c508,data:_0x5cc106}}=await axios_1[_0x1aec58(0x188)][_0x1aec58(0x124)](_0x1aec58(0x15c),_0x25e4b3);if(_0x3c33c9!=0x0)throw new common_1['HttpException'](_0x10c508,common_1[_0x1aec58(0x100)]['BAD_REQUEST']);return _0x5cc106;}async[_0x312b31(0x190)](_0x580f90){const _0x48eced=_0x312b31,_0x3c09d7=_0x580f90[_0x48eced(0x102)];delete _0x580f90[_0x48eced(0x102)],delete _0x580f90[_0x48eced(0x112)];const _0x4fe8c8=await this[_0x48eced(0x129)]['getConfigs']([_0x48eced(0x121)]);if(this[_0x48eced(0x102)](_0x580f90,_0x4fe8c8)!=_0x3c09d7)return _0x48eced(0x13b);console[_0x48eced(0x154)]('校验签名通过');const _0x5eb142=await this['orderEntity'][_0x48eced(0x134)]({'where':{'orderId':_0x580f90[_0x48eced(0x127)],'status':0x0}});if(!_0x5eb142)return _0x48eced(0x13b);const _0x56a6d4=_0x580f90[_0x48eced(0xef)]=='TRADE_SUCCESS'?0x1:0x2,_0x1bc97e=await this['orderEntity'][_0x48eced(0x17e)]({'orderId':_0x580f90[_0x48eced(0x127)]},{'status':_0x56a6d4,'paydAt':new Date()});_0x56a6d4===0x1&&await this[_0x48eced(0x110)][_0x48eced(0x105)](_0x5eb142);if(_0x1bc97e[_0x48eced(0x18a)]!=0x1)return _0x48eced(0x13b);return'success';}async['payEpay'](_0x4ecfef,_0x188dc3,_0x57ed92=_0x312b31(0x148)){const _0x1b721b=_0x312b31,_0x451cda=await this[_0x1b721b(0xf3)][_0x1b721b(0x134)]({'where':{'userId':_0x4ecfef,'orderId':_0x188dc3}});if(!_0x451cda)throw new common_1['HttpException'](_0x1b721b(0x13d),common_1[_0x1b721b(0x100)]['BAD_REQUEST']);const _0x157a49=await this[_0x1b721b(0x14e)][_0x1b721b(0x134)]({'where':{'id':_0x451cda[_0x1b721b(0x119)]}});if(!_0x157a49)throw new common_1[(_0x1b721b(0xf8))](_0x1b721b(0x18e),common_1[_0x1b721b(0x100)][_0x1b721b(0x155)]);const {payEpayPid:_0x4f5990,payEpaySecret:_0x191e32,payEpayNotifyUrl:_0x40fc6c,payEpayReturnUrl:_0x3a039e,payEpayApiPayUrl:_0x4ec172}=await this['globalConfigService'][_0x1b721b(0x147)]([_0x1b721b(0x153),_0x1b721b(0x121),_0x1b721b(0x125),'payEpayReturnUrl',_0x1b721b(0x18b)]);let _0x188620;_0x4f5990[_0x1b721b(0x17b)]<=0x10?_0x188620=Number(_0x4f5990):_0x188620=BigInt(_0x4f5990);const _0x374014={};_0x374014[_0x1b721b(0x164)]=_0x188620,_0x374014[_0x1b721b(0x14f)]=_0x57ed92,_0x374014[_0x1b721b(0x127)]=_0x188dc3,_0x374014['name']=_0x157a49[_0x1b721b(0x157)],_0x374014[_0x1b721b(0x11c)]=_0x451cda['total'],_0x374014[_0x1b721b(0x163)]=_0x1b721b(0x17f),_0x374014[_0x1b721b(0x199)]='pc',_0x374014[_0x1b721b(0x193)]=_0x40fc6c,_0x374014[_0x1b721b(0x114)]=_0x3a039e,_0x374014[_0x1b721b(0x10e)]=_0x1b721b(0x172),_0x374014[_0x1b721b(0x102)]=this[_0x1b721b(0x102)](_0x374014,_0x191e32),_0x374014[_0x1b721b(0x112)]=_0x1b721b(0xfa);const _0x4bbe8b=new URLSearchParams(_0x374014)['toString'](),_0x55c855=_0x4ec172+'?'+_0x4bbe8b;if(_0x4ec172[_0x1b721b(0x18d)](_0x1b721b(0xfe)))return{'url_qrcode':null,'redirectUrl':_0x55c855,'channel':_0x57ed92,'isRedirect':!![]};else{const _0xe640ff=await axios_1[_0x1b721b(0x188)]['get'](_0x4ec172,{'params':_0x374014});console[_0x1b721b(0x154)](_0x1b721b(0x194),_0xe640ff['data']);const {data:{code:_0x590305,msg:_0x1e794e,qrcode:_0x5796f3}}=_0xe640ff;if(_0x590305!=0x1)throw new common_1[(_0x1b721b(0xf8))](_0x1e794e,common_1[_0x1b721b(0x100)][_0x1b721b(0x155)]);return{'url_qrcode':_0x5796f3,'redirectUrl':null,'channel':_0x57ed92,'isRedirect':![]};}}async[_0x312b31(0x16b)](_0x5d2547){const _0x19c9fe=_0x312b31,{payEpayPid:_0x1f3752,payEpaySecret:_0x1a4b30,payEpayApiQueryUrl:_0x321ca5}=await this[_0x19c9fe(0x129)]['getConfigs']([_0x19c9fe(0x153),_0x19c9fe(0x121),'payEpayApiQueryUrl']),_0x3a10ec={};_0x3a10ec[_0x19c9fe(0x151)]=_0x19c9fe(0xee),_0x3a10ec[_0x19c9fe(0x127)]=_0x5d2547,_0x3a10ec['pid']=_0x1f3752,_0x3a10ec[_0x19c9fe(0x11a)]=_0x1a4b30;const {data:{code:_0x3922f4,msg:_0x4c5026,data:_0x4f9f4b}}=await axios_1[_0x19c9fe(0x188)][_0x19c9fe(0x136)](_0x321ca5,{'params':_0x3a10ec});if(_0x3922f4!=0x1)throw new common_1[(_0x19c9fe(0xf8))](_0x4c5026,common_1['HttpStatus'][_0x19c9fe(0x155)]);return _0x4f9f4b;}async[_0x312b31(0x139)](_0x2b88a8){const _0x4f998f=_0x312b31,_0x174019=_0x2b88a8['sign'];delete _0x2b88a8[_0x4f998f(0x102)],delete _0x2b88a8['sign_type'];const _0x2f1136=await this[_0x4f998f(0x129)][_0x4f998f(0x147)]([_0x4f998f(0x175)]);console[_0x4f998f(0x154)](_0x4f998f(0x198));if(this[_0x4f998f(0x102)](_0x2b88a8,_0x2f1136)!=_0x174019)return'failed';console[_0x4f998f(0x154)](_0x4f998f(0x180));const _0x531e5f=await this[_0x4f998f(0xf3)][_0x4f998f(0x134)]({'where':{'orderId':_0x2b88a8['out_trade_no'],'status':0x0}});if(!_0x531e5f)return _0x4f998f(0x13b);const _0x4eb9f5=_0x2b88a8[_0x4f998f(0xef)]==_0x4f998f(0x12f)?0x1:0x2;console[_0x4f998f(0x154)](_0x4f998f(0x150),_0x4eb9f5);const _0x1d8bda=await this[_0x4f998f(0xf3)]['update']({'orderId':_0x2b88a8[_0x4f998f(0x127)]},{'status':_0x4eb9f5,'paydAt':new Date()});_0x4eb9f5===0x1&&await this[_0x4f998f(0x110)]['addBalanceToOrder'](_0x531e5f);if(_0x1d8bda[_0x4f998f(0x18a)]!=0x1)return _0x4f998f(0x13b);return'success';}async[_0x312b31(0x10f)](_0x5dfe9a,_0x2347fb,_0x27a31b='wxpay'){const _0x342c1a=_0x312b31,_0x5012b0=await this[_0x342c1a(0xf3)][_0x342c1a(0x134)]({'where':{'userId':_0x5dfe9a,'orderId':_0x2347fb}});if(!_0x5012b0)throw new common_1[(_0x342c1a(0xf8))](_0x342c1a(0x13d),common_1['HttpStatus'][_0x342c1a(0x155)]);const _0x61ba4c=await this[_0x342c1a(0x14e)][_0x342c1a(0x134)]({'where':{'id':_0x5012b0[_0x342c1a(0x119)]}});if(!_0x61ba4c)throw new common_1['HttpException'](_0x342c1a(0x18e),common_1[_0x342c1a(0x100)]['BAD_REQUEST']);const {payMpayPid:_0x59a567,payMpaySecret:_0x76124,payMpayNotifyUrl:_0xceec46,payMpayReturnUrl:_0x3102b5,payMpayApiPayUrl:_0x2ddb28}=await this[_0x342c1a(0x129)]['getConfigs']([_0x342c1a(0x156),'payMpaySecret',_0x342c1a(0x118),'payMpayReturnUrl','payMpayApiPayUrl']),_0x365190={};_0x365190[_0x342c1a(0x164)]=Number(_0x59a567),_0x365190[_0x342c1a(0x14f)]=_0x27a31b,_0x365190['out_trade_no']=_0x2347fb,_0x365190[_0x342c1a(0x157)]=_0x61ba4c[_0x342c1a(0x157)],_0x365190['money']=_0x5012b0[_0x342c1a(0x171)],_0x365190[_0x342c1a(0x193)]=_0xceec46,_0x365190[_0x342c1a(0x114)]=_0x3102b5,_0x365190[_0x342c1a(0x102)]=this[_0x342c1a(0x102)](_0x365190,_0x76124),_0x365190[_0x342c1a(0x112)]=_0x342c1a(0xfa);const _0x416fa7=new URLSearchParams(_0x365190)[_0x342c1a(0x122)](),_0x5c5aa0=_0x2ddb28+'?'+_0x416fa7;return{'url_qrcode':null,'redirectUrl':_0x5c5aa0,'channel':_0x27a31b,'isRedirect':!![]};const _0x198cd9=await axios_1['default'][_0x342c1a(0x136)](_0x2ddb28,{'params':_0x365190});}async[_0x312b31(0x184)](_0x4108df){const _0x484868=_0x312b31,{payMpayApiQueryUrl:_0x387503}=await this['globalConfigService'][_0x484868(0x147)](['payMpayPid','payMpaySecret',_0x484868(0x135)]),_0x49e2ff={};_0x49e2ff['type']=0x2,_0x49e2ff['order_no']=_0x4108df;const {data:{code:_0x492614,msg:_0x24e6f1,data:_0x333df0}}=await axios_1[_0x484868(0x188)]['get'](_0x387503,{'params':_0x49e2ff});if(_0x492614!=0x1)throw new common_1[(_0x484868(0xf8))](_0x24e6f1,common_1[_0x484868(0x100)][_0x484868(0x155)]);return _0x333df0;}async[_0x312b31(0x16e)](_0x5c916c){const _0x39dc63=_0x312b31;console[_0x39dc63(0x154)](_0x39dc63(0x116),_0x5c916c);const {payWeChatAppId:_0x572692,payWeChatMchId:_0x571654,payWeChatSecret:_0x414cfa,payWeChatPublicKey:_0xeedfed,payWeChatPrivateKey:_0x261149}=await this['globalConfigService'][_0x39dc63(0x147)](['payWeChatAppId',_0x39dc63(0x13a),'payWeChatSecret',_0x39dc63(0x167),_0x39dc63(0x106)]),_0x48cceb=new this[(_0x39dc63(0x15a))]({'appid':_0x572692,'mchid':_0x571654,'publicKey':_0xeedfed,'privateKey':_0x261149});try{if(_0x5c916c[_0x39dc63(0x12c)]=='TRANSACTION.SUCCESS'){const {ciphertext:_0x200250,associated_data:_0x10a313,nonce:_0x4c0c78}=_0x5c916c['resource'],_0x181207=_0x48cceb['decipher_gcm'](_0x200250,_0x10a313,_0x4c0c78,_0x414cfa),_0x32e32b=await this[_0x39dc63(0xf3)][_0x39dc63(0x134)]({'where':{'orderId':_0x181207[_0x39dc63(0x127)],'status':0x0}});if(!_0x32e32b)return'failed';const _0x158464=_0x181207[_0x39dc63(0x13f)]=='SUCCESS'?0x1:0x2,_0x170ccc=await this[_0x39dc63(0xf3)][_0x39dc63(0x17e)]({'orderId':_0x181207[_0x39dc63(0x127)]},{'status':_0x158464,'paydAt':new Date()});_0x158464===0x1&&await this[_0x39dc63(0x110)][_0x39dc63(0x105)](_0x32e32b);if(_0x170ccc[_0x39dc63(0x18a)]!=0x1)return _0x39dc63(0x13b);}return'success';}catch(_0x4520fd){return console[_0x39dc63(0x154)](_0x39dc63(0x170),_0x4520fd),console[_0x39dc63(0x154)]('支付通知验证失败:\x20',_0x4520fd),_0x39dc63(0x13b);}}async[_0x312b31(0xf1)](_0xf245b7,_0x56a958,_0x5455cb=_0x312b31(0x12a)){const _0x2c98ba=_0x312b31;var _0x14b4d9,_0xd83967,_0x10a3cd;console[_0x2c98ba(0x154)](_0x2c98ba(0x16d),_0x5455cb);const _0x22a67d=await this[_0x2c98ba(0xf3)][_0x2c98ba(0x134)]({'where':{'userId':_0xf245b7,'orderId':_0x56a958}});if(!_0x22a67d)throw new common_1['HttpException'](_0x2c98ba(0x13d),common_1[_0x2c98ba(0x100)][_0x2c98ba(0x155)]);const _0x3f1adf=await this[_0x2c98ba(0x14e)][_0x2c98ba(0x134)]({'where':{'id':_0x22a67d[_0x2c98ba(0x119)]}});if(!_0x3f1adf)throw new common_1['HttpException'](_0x2c98ba(0x18e),common_1[_0x2c98ba(0x100)]['BAD_REQUEST']);const {payWeChatAppId:_0x4e7072,payWeChatMchId:_0x67e1f5,payWeChatPublicKey:_0x583c65,payWeChatPrivateKey:_0x405a40,payWeChatNotifyUrl:_0x25f5d3,payWeChatH5Name:_0x37f88e,payWeChatH5Url:_0x28d7e0}=await this[_0x2c98ba(0x129)][_0x2c98ba(0x147)]([_0x2c98ba(0x191),'payWeChatMchId',_0x2c98ba(0x167),_0x2c98ba(0x106),_0x2c98ba(0x16a),_0x2c98ba(0x177),'payWeChatH5Url']);console[_0x2c98ba(0x154)](_0x2c98ba(0x191),_0x4e7072),console['log'](_0x2c98ba(0x13a),_0x67e1f5),console[_0x2c98ba(0x154)]('payWeChatPublicKey',_0x583c65),console[_0x2c98ba(0x154)](_0x2c98ba(0x106),_0x405a40);const _0x142aa7=new this[(_0x2c98ba(0x15a))]({'appid':_0x4e7072,'mchid':_0x67e1f5,'publicKey':_0x583c65,'privateKey':_0x405a40,'serial_no':process['env'][_0x2c98ba(0x14c)]}),_0x29579f={'appid':_0x4e7072,'mchid':_0x67e1f5,'description':_0x3f1adf['name'],'out_trade_no':_0x56a958,'notify_url':_0x25f5d3,'amount':{'total':Number(_0x22a67d[_0x2c98ba(0x171)]*0x64)},'scene_info':{'payer_client_ip':_0x2c98ba(0x17f)}};console['log'](_0x2c98ba(0xf5),_0x29579f);if(_0x5455cb=='h5'){_0x29579f[_0x2c98ba(0x117)][_0x2c98ba(0x185)]={'type':'Wap','app_name':_0x37f88e,'app_url':_0x28d7e0};const _0x17cd9a=await _0x142aa7[_0x2c98ba(0x159)](_0x29579f);if(_0x17cd9a['status']===0x193){const _0x4def79=(_0x10a3cd=(_0xd83967=(_0x14b4d9=_0x17cd9a===null||_0x17cd9a===void 0x0?void 0x0:_0x17cd9a[_0x2c98ba(0x16f)])===null||_0x14b4d9===void 0x0?void 0x0:_0x14b4d9['response'])===null||_0xd83967===void 0x0?void 0x0:_0xd83967[_0x2c98ba(0x113)])===null||_0x10a3cd===void 0x0?void 0x0:_0x10a3cd[_0x2c98ba(0x169)];throw new common_1[(_0x2c98ba(0xf8))]((_0x17cd9a===null||_0x17cd9a===void 0x0?void 0x0:_0x17cd9a[_0x2c98ba(0x169)])||_0x2c98ba(0x10c),common_1[_0x2c98ba(0x100)][_0x2c98ba(0x155)]);}const {h5_url:_0x2f15e5}=_0x17cd9a;return{'url':_0x2f15e5};}if(_0x5455cb==_0x2c98ba(0x109)){const _0x3b36eb=await this[_0x2c98ba(0x14a)][_0x2c98ba(0x115)](_0xf245b7);console[_0x2c98ba(0x154)]('用户openId:\x20',_0x3b36eb),_0x29579f[_0x2c98ba(0x145)]={'openid':_0x3b36eb};const _0x4086fd=await _0x142aa7[_0x2c98ba(0xf9)](_0x29579f);return console[_0x2c98ba(0x154)](_0x2c98ba(0x152),_0x4086fd),_0x4086fd;}if(_0x5455cb==_0x2c98ba(0x12a)){const _0x92e0c3=await _0x142aa7[_0x2c98ba(0x12e)](_0x29579f),{data:_0x280532,status:_0x45bbcf}=_0x92e0c3;if(_0x45bbcf!==0xc8)throw new common_1[(_0x2c98ba(0xf8))](_0x2c98ba(0xf6),_0x92e0c3);const {code_url:_0x23398e}=_0x280532;return!_0x23398e&&console[_0x2c98ba(0x154)](_0x2c98ba(0x15f),_0x92e0c3),{'url_qrcode':_0x23398e,'isRedirect':![]};}throw new common_1['HttpException'](_0x2c98ba(0x137),common_1[_0x2c98ba(0x100)][_0x2c98ba(0x155)]);}async[_0x312b31(0xfc)](_0x213306){const _0x505016=_0x312b31,{payWeChatAppId:_0x3feccd,payWeChatMchId:_0x42ed1d,payWeChatPublicKey:_0x147847,payWeChatPrivateKey:_0x49dbab,payWeChatNotifyUrl:_0x5b96f2,payWeChatH5Name:_0x26d40c,payWeChatH5Url:_0x31aeea}=await this['globalConfigService'][_0x505016(0x147)]([_0x505016(0x191),_0x505016(0x13a),'payWeChatPublicKey',_0x505016(0x106)]),_0x347962=new this[(_0x505016(0x15a))]({'appid':_0x3feccd,'mchid':_0x42ed1d,'publicKey':_0x147847,'privateKey':_0x49dbab}),_0x27c30a=await _0x347962[_0x505016(0x179)]({'out_trade_no':_0x213306});return _0x27c30a;}[_0x312b31(0x102)](_0x36f200,_0x453bc8){const _0x1e955f=_0x312b31,_0x16ee17=Object[_0x1e955f(0x18f)](_0x36f200)[_0x1e955f(0x168)]()[_0x1e955f(0xff)](_0x3dee57=>_0x3dee57+'='+_0x36f200[_0x3dee57])['join']('&')+_0x453bc8;return crypto['createHash']('md5')[_0x1e955f(0x17e)](_0x16ee17)[_0x1e955f(0x10d)](_0x1e955f(0xf2));}};PayService=__decorate([(0x0,common_1[_0x312b31(0x160)])(),__param(0x0,(0x0,typeorm_1[_0x312b31(0x161)])(cramiPackage_entity_1[_0x312b31(0x14d)])),__param(0x1,(0x0,typeorm_1[_0x312b31(0x161)])(order_entity_1[_0x312b31(0xf7)])),__metadata('design:paramtypes',[typeorm_2[_0x312b31(0x174)],typeorm_2['Repository'],userBalance_service_1[_0x312b31(0x13e)],globalConfig_service_1[_0x312b31(0x101)],user_service_1[_0x312b31(0x17c)]])],PayService),exports['PayService']=PayService;function _0x22f7(){const _0x4e3707=['decorate','payEpaySecret','toString','notifyHupi','post','payEpayNotifyUrl','typeorm','out_trade_no','__param','globalConfigService','native','7946780MxDkDP','event_type','支付请求失败!','transactions_native','TRADE_SUCCESS','nonce_str','time','../../common/utils','26252CFyFyr','findOne','payMpayApiQueryUrl','get','unsupported\x20pay\x20type','trade_order_id','notifyMpay','payWeChatMchId','failed','now','订单不存在!','UserBalanceService','trade_state','object','total_fee','pay','../crami/cramiPackage.entity','1.1','payer','version','getConfigs','alipay','axios','userService','notify','SERIAL_NO','CramiPackageEntity','cramiPackageEntity','type','status:\x20','act','jsapi支付结果返回值:\x20','payEpayPid','log','BAD_REQUEST','payMpayPid','name','../order/order.entity','transactions_h5','WxPay','queryHupi','https://api.xunhupay.com/payment/query.html','509645gnmXLf','function','wx-native\x20获取二维码地址为空','Injectable','InjectRepository','attach','clientip','pid','out_trade_order','title','payWeChatPublicKey','sort','message','payWeChatNotifyUrl','queryEpay','createRandomNonceStr','payType:\x20','notifyWeChat','errRaw','error:\x20','total','epay','../globalConfig/globalConfig.service','Repository','payMpaySecret','__metadata','payWeChatH5Name','51uJflBS','query','../userBalance/userBalance.service','length','UserService','defineProperty','update','192.168.1.100','校验签名通过','18ZYMxIV','377357NioZVB','success','queryMpay','h5_info','payPlatform','hash','default','../user/user.service','affected','payEpayApiPayUrl','payHupiAppId','includes','套餐不存在!','keys','notifyEpay','payWeChatAppId','__decorate','notify_url','epay\x20--->\x20res:\x20','payHupiGatewayUrl','appid','76916ehGulC','校验签名','device','48pnytzQ','mpay','__esModule','order','trade_status','importDynamic','payWeChat','hex','orderEntity','8607681oKREzl','wechat-pay:\x20','获取支付二维码失败','OrderEntity','HttpException','transactions_jsapi','MD5','resource','queryWeChat','crypto','submit.php','map','HttpStatus','GlobalConfigService','sign','1536080aNmhOp','https://api.xunhupay.com/payment/do.html','addBalanceToOrder','payWeChatPrivateKey','wxpay','hupi','jsapi','PayService','toFixed','微信H5支付失败！','digest','param','payMpay','userBalanceService','payHupiSecret','sign_type','text','return_url','getOpenIdByUserId','微信支付通知params:\x20','scene_info','payMpayNotifyUrl','goodsId','key','metadata','money','@nestjs/typeorm','getOwnPropertyDescriptor','wechatpay-node-v3'];_0x22f7=function(){return _0x4e3707;};return _0x22f7();}