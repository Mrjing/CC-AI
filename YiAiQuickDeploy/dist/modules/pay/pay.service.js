'use strict';const _0x521700=_0xb636;(function(_0xa3668f,_0xcfbe11){const _0x44db8c=_0xb636,_0x38e174=_0xa3668f();while(!![]){try{const _0x4ae1d5=-parseInt(_0x44db8c(0xf5))/0x1*(-parseInt(_0x44db8c(0x13a))/0x2)+-parseInt(_0x44db8c(0x102))/0x3*(-parseInt(_0x44db8c(0x15a))/0x4)+-parseInt(_0x44db8c(0xf4))/0x5*(-parseInt(_0x44db8c(0x109))/0x6)+parseInt(_0x44db8c(0xeb))/0x7+parseInt(_0x44db8c(0x172))/0x8+parseInt(_0x44db8c(0xf1))/0x9*(-parseInt(_0x44db8c(0x133))/0xa)+-parseInt(_0x44db8c(0x177))/0xb;if(_0x4ae1d5===_0xcfbe11)break;else _0x38e174['push'](_0x38e174['shift']());}catch(_0x1d9676){_0x38e174['push'](_0x38e174['shift']());}}}(_0x2745,0x75a9b));function _0xb636(_0x4cdee3,_0x56b02d){const _0x274579=_0x2745();return _0xb636=function(_0xb636f8,_0xfd2703){_0xb636f8=_0xb636f8-0xde;let _0xac96c9=_0x274579[_0xb636f8];return _0xac96c9;},_0xb636(_0x4cdee3,_0x56b02d);}function _0x2745(){const _0x5e0eeb=['userService','attach','jsapi支付结果返回值:\x20','用户openId:\x20','payWeChatPrivateKey','payType:\x20','payWeChatH5Name','epay','支付请求失败!','pay','payEpayApiQueryUrl','axios','device','payWeChatPublicKey','queryMpay','get','校验签名通过','globalConfigService','getOwnPropertyDescriptor','../user/user.service','@nestjs/common','queryEpay','jsapi','32RQgLvy','createRandomNonceStr','Injectable','../userBalance/userBalance.service','notify','event_type','orderEntity','addBalanceToOrder','join','decipher_gcm','payEpayPid','SUCCESS','total_fee','userBalanceService','appid','payEpayNotifyUrl','resource','wechat','TRADE_SUCCESS','payMpaySecret','return_url','time','transactions_native','epay\x20--->\x20res:\x20','7461392wcuFua','toFixed','function','payHupiGatewayUrl','object','27676077peFdtA','../globalConfig/globalConfig.service','response','BAD_REQUEST','sign','onModuleInit','HttpException','log','length','payWeChatAppId','../crami/cramiPackage.entity','__esModule','type','metadata','getConfigs','submit.php','name','sort','post','notify_url','192.168.1.100','payEpayApiPayUrl','scene_info','wechat-pay:\x20','订单不存在!','affected','goodsId','param','4309235QOJlBi','校验签名','payHupiSecret','pid','transactions_h5','alipay','54FTYfxV','PayService','微信支付通知params:\x20','4749125hImgLV','215478cAGsTw','../../common/utils','mpay','cramiPackageEntity','default','支付请求失败:\x20','@nestjs/typeorm','GlobalConfigService','payHupiAppId','notifyWeChat','payMpayReturnUrl','failed','map','267429TugoBO','act','MD5','1.1','queryHupi','trade_status','out_trade_no','6kCVjTH','payEpaySecret','payMpayNotifyUrl','https://api.xunhupay.com/payment/do.html','https://api.xunhupay.com/payment/query.html','notifyEpay','套餐不存在!','payMpayApiQueryUrl','__param','payer','update','wxpay','payPlatform','InjectRepository','wx-native','HttpStatus','notifyMpay','now','payWeChatNotifyUrl','__decorate','hupi','payWeChatSecret','unsupported\x20pay\x20type','OrderEntity','trade_state','Wap','toString','key','total','WxPay','error:\x20','CramiPackageEntity','defineProperty','status','queryWeChat','native','query','payWeChatMchId','hex','version','status:\x20','payWeChatH5Url','1432880UDpxAv','trade_order_id','nonce_str','sign_type','findOne','payEpay','money','6zZjCOU','typeorm','__metadata','message','hash','decorate','errRaw','payHupi','success'];_0x2745=function(){return _0x5e0eeb;};return _0x2745();}var __decorate=this&&this[_0x521700(0x11c)]||function(_0x170917,_0x41706b,_0x37be13,_0xd015fd){const _0x152baf=_0x521700;var _0x543feb=arguments['length'],_0x10b8d7=_0x543feb<0x3?_0x41706b:_0xd015fd===null?_0xd015fd=Object[_0x152baf(0x155)](_0x41706b,_0x37be13):_0xd015fd,_0x46c6ab;if(typeof Reflect==='object'&&typeof Reflect[_0x152baf(0x13f)]==='function')_0x10b8d7=Reflect['decorate'](_0x170917,_0x41706b,_0x37be13,_0xd015fd);else{for(var _0x28cd5b=_0x170917[_0x152baf(0x17f)]-0x1;_0x28cd5b>=0x0;_0x28cd5b--)if(_0x46c6ab=_0x170917[_0x28cd5b])_0x10b8d7=(_0x543feb<0x3?_0x46c6ab(_0x10b8d7):_0x543feb>0x3?_0x46c6ab(_0x41706b,_0x37be13,_0x10b8d7):_0x46c6ab(_0x41706b,_0x37be13))||_0x10b8d7;}return _0x543feb>0x3&&_0x10b8d7&&Object['defineProperty'](_0x41706b,_0x37be13,_0x10b8d7),_0x10b8d7;},__metadata=this&&this[_0x521700(0x13c)]||function(_0x49add0,_0x14d38d){const _0x42cdf2=_0x521700;if(typeof Reflect===_0x42cdf2(0x176)&&typeof Reflect[_0x42cdf2(0x184)]===_0x42cdf2(0x174))return Reflect[_0x42cdf2(0x184)](_0x49add0,_0x14d38d);},__param=this&&this[_0x521700(0x111)]||function(_0x590fdc,_0x219c8a){return function(_0x206c90,_0x2157a7){_0x219c8a(_0x206c90,_0x2157a7,_0x590fdc);};};Object[_0x521700(0x129)](exports,_0x521700(0x182),{'value':!![]}),exports[_0x521700(0xf2)]=void 0x0;const typeorm_1=require(_0x521700(0xfb)),typeorm_2=require(_0x521700(0x13b)),common_1=require(_0x521700(0x157)),crypto=require('crypto'),axios_1=require(_0x521700(0x14e)),order_entity_1=require('../order/order.entity'),cramiPackage_entity_1=require(_0x521700(0x181)),userBalance_service_1=require(_0x521700(0x15d)),globalConfig_service_1=require(_0x521700(0x178)),utils_1=require(_0x521700(0xf6)),user_service_1=require(_0x521700(0x156));let PayService=class PayService{constructor(_0x578291,_0x485861,_0x37dcdd,_0x419054,_0x2c6a88){const _0x5a70a9=_0x521700;this[_0x5a70a9(0xf8)]=_0x578291,this[_0x5a70a9(0x160)]=_0x485861,this[_0x5a70a9(0x167)]=_0x37dcdd,this[_0x5a70a9(0x154)]=_0x419054,this[_0x5a70a9(0x143)]=_0x2c6a88;}async[_0x521700(0x17c)](){const _0x1832f3=_0x521700,_0x2dff2f=await(0x0,utils_1['importDynamic'])('wechatpay-node-v3');this['WxPay']=(_0x2dff2f===null||_0x2dff2f===void 0x0?void 0x0:_0x2dff2f[_0x1832f3(0xf9)])?_0x2dff2f[_0x1832f3(0xf9)]:_0x2dff2f;}async[_0x521700(0x15e)](_0x438b15){const _0x4f4c9e=_0x521700;if(_0x438b15[_0x4f4c9e(0xea)]==_0x4f4c9e(0x14a))return this[_0x4f4c9e(0x10e)](_0x438b15);if(_0x438b15[_0x4f4c9e(0x144)]=='hupi')return this['notifyHupi'](_0x438b15);if(typeof _0x438b15['resource']=='object')return this[_0x4f4c9e(0xfe)](_0x438b15);return this[_0x4f4c9e(0x119)](_0x438b15);}async[_0x521700(0x14c)](_0x3d0bb6,_0x18a06b,_0x198ff9=_0x521700(0x114)){const _0x247b94=_0x521700,_0xe6a46=await this[_0x247b94(0x160)][_0x247b94(0x137)]({'where':{'userId':_0x3d0bb6,'orderId':_0x18a06b}});if(!_0xe6a46)throw new common_1['HttpException'](_0x247b94(0xe7),common_1[_0x247b94(0x118)]['BAD_REQUEST']);const _0x5e1df4=await this[_0x247b94(0xf8)][_0x247b94(0x137)]({'where':{'id':_0xe6a46[_0x247b94(0xe9)]}});if(!_0x5e1df4)throw new common_1[(_0x247b94(0x17d))](_0x247b94(0x10f),common_1[_0x247b94(0x118)][_0x247b94(0x17a)]);console[_0x247b94(0x17e)]('本次支付类型:\x20',_0xe6a46[_0x247b94(0x115)]);try{if(_0xe6a46[_0x247b94(0x115)]==_0x247b94(0x16b))return this['payWeChat'](_0x3d0bb6,_0x18a06b,_0x198ff9);if(_0xe6a46[_0x247b94(0x115)]==_0x247b94(0x14a))return this[_0x247b94(0x138)](_0x3d0bb6,_0x18a06b,_0x198ff9);if(_0xe6a46[_0x247b94(0x115)]==_0x247b94(0xf7))return this['payMpay'](_0x3d0bb6,_0x18a06b,_0x198ff9);if(_0xe6a46[_0x247b94(0x115)]==_0x247b94(0x11d))return this[_0x247b94(0x141)](_0x3d0bb6,_0x18a06b,_0x198ff9);}catch(_0x14390d){console[_0x247b94(0x17e)](_0x247b94(0xfa),_0x14390d);throw new common_1[(_0x247b94(0x17d))](_0x247b94(0x14b),common_1['HttpStatus'][_0x247b94(0x17a)]);}}async[_0x521700(0x12d)](_0x262b19){const _0x36abc9=_0x521700,_0x1891fe=await this['orderEntity'][_0x36abc9(0x137)]({'where':{'orderId':_0x262b19}});if(!_0x1891fe)throw new common_1[(_0x36abc9(0x17d))](_0x36abc9(0xe7),common_1['HttpStatus'][_0x36abc9(0x17a)]);return _0x1891fe;}async['notifyHupi'](_0x45855a){const _0x2d2a61=_0x521700,_0x16fb7e=await this[_0x2d2a61(0x154)][_0x2d2a61(0x185)]([_0x2d2a61(0xed)]),_0x57c2f4=_0x45855a['hash'];delete _0x45855a[_0x2d2a61(0x13e)];if(this['sign'](_0x45855a,_0x16fb7e)!=_0x57c2f4)return _0x2d2a61(0x100);const _0x51d885=await this['orderEntity'][_0x2d2a61(0x137)]({'where':{'orderId':_0x45855a[_0x2d2a61(0x134)],'status':0x0}});if(!_0x51d885)return'failed';await this[_0x2d2a61(0x167)][_0x2d2a61(0x161)](_0x51d885);const _0x2ee15e=await this[_0x2d2a61(0x160)]['update']({'orderId':_0x45855a[_0x2d2a61(0x134)]},{'status':0x1,'paydAt':new Date()});if(_0x2ee15e[_0x2d2a61(0xe8)]!=0x1)return'failed';return _0x2d2a61(0x142);}async[_0x521700(0x141)](_0x38dbde,_0x40b9b9,_0x1297e7=_0x521700(0x114)){const _0x35643c=_0x521700,_0x38f8c3=await this[_0x35643c(0x160)]['findOne']({'where':{'userId':_0x38dbde,'orderId':_0x40b9b9}});if(!_0x38f8c3)throw new common_1[(_0x35643c(0x17d))](_0x35643c(0xe7),common_1[_0x35643c(0x118)][_0x35643c(0x17a)]);const _0x576f90=await this['cramiPackageEntity'][_0x35643c(0x137)]({'where':{'id':_0x38f8c3[_0x35643c(0xe9)]}});if(!_0x576f90)throw new common_1[(_0x35643c(0x17d))](_0x35643c(0x10f),common_1['HttpStatus'][_0x35643c(0x17a)]);const {payHupiAppId:_0xa5dd1a,payHupiSecret:_0x327bc0,payHupiNotifyUrl:_0x13c061,payHupiReturnUrl:_0x316c7e,payHupiGatewayUrl:_0x4e583f}=await this[_0x35643c(0x154)][_0x35643c(0x185)]([_0x35643c(0xfd),_0x35643c(0xed),'payHupiNotifyUrl','payHupiReturnUrl',_0x35643c(0x175)]),_0x2c6e0b={};_0x2c6e0b[_0x35643c(0x130)]='1.1',_0x2c6e0b[_0x35643c(0x168)]=_0xa5dd1a,_0x2c6e0b[_0x35643c(0x16f)]=(Date[_0x35643c(0x11a)]()/0x3e8)[_0x35643c(0x173)](0x0),_0x2c6e0b[_0x35643c(0x135)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x2c6e0b[_0x35643c(0x134)]=_0x40b9b9,_0x2c6e0b['title']=_0x576f90[_0x35643c(0xdf)],_0x2c6e0b[_0x35643c(0x166)]=_0x38f8c3[_0x35643c(0x125)],_0x2c6e0b[_0x35643c(0xe2)]=_0x13c061,_0x2c6e0b['return_url']=_0x316c7e,_0x2c6e0b[_0x35643c(0x144)]=_0x35643c(0x11d),_0x2c6e0b[_0x35643c(0x13e)]=this[_0x35643c(0x17b)](_0x2c6e0b,_0x327bc0);const {data:{errcode:_0x5e58eb,errmsg:_0x40ae15,url_qrcode:_0x49fe1f,url:_0x44e62b}}=await axios_1['default'][_0x35643c(0xe1)](_0x4e583f||_0x35643c(0x10c),_0x2c6e0b);if(_0x5e58eb!=0x0)throw new common_1[(_0x35643c(0x17d))](_0x40ae15,common_1[_0x35643c(0x118)][_0x35643c(0x17a)]);return{'url_qrcode':_0x49fe1f,'url':_0x44e62b};}async[_0x521700(0x106)](_0x2c0d54){const _0x26f749=_0x521700,{payHupiAppId:_0x55769e,payHupiSecret:_0x2944c5}=await this['globalConfigService']['getConfigs']([_0x26f749(0xfd),'payHupiSecret']),_0x15432d={};_0x15432d[_0x26f749(0x130)]=_0x26f749(0x105),_0x15432d[_0x26f749(0x168)]=_0x55769e,_0x15432d[_0x26f749(0x16f)]=(Date[_0x26f749(0x11a)]()/0x3e8)['toFixed'](0x0),_0x15432d[_0x26f749(0x135)]=(0x0,utils_1[_0x26f749(0x15b)])(0x20),_0x15432d['out_trade_order']=_0x2c0d54,_0x15432d[_0x26f749(0x13e)]=this['sign'](_0x15432d,_0x2944c5);const {data:{errcode:_0x7c4ea,errmsg:_0x437fe2,data:_0x343b77}}=await axios_1['default']['post'](_0x26f749(0x10d),_0x15432d);if(_0x7c4ea!=0x0)throw new common_1[(_0x26f749(0x17d))](_0x437fe2,common_1['HttpStatus'][_0x26f749(0x17a)]);return _0x343b77;}async[_0x521700(0x10e)](_0x9aaa19){const _0x1a1a77=_0x521700,_0x23c8f6=_0x9aaa19[_0x1a1a77(0x17b)];delete _0x9aaa19[_0x1a1a77(0x17b)],delete _0x9aaa19[_0x1a1a77(0x136)];const _0x4a581b=await this['globalConfigService']['getConfigs'](['payEpaySecret']);if(this[_0x1a1a77(0x17b)](_0x9aaa19,_0x4a581b)!=_0x23c8f6)return _0x1a1a77(0x100);console[_0x1a1a77(0x17e)]('校验签名通过');const _0x4fbe0a=await this['orderEntity'][_0x1a1a77(0x137)]({'where':{'orderId':_0x9aaa19[_0x1a1a77(0x108)],'status':0x0}});if(!_0x4fbe0a)return _0x1a1a77(0x100);const _0x1e6ea6=_0x9aaa19[_0x1a1a77(0x107)]=='TRADE_SUCCESS'?0x1:0x2,_0x31920c=await this[_0x1a1a77(0x160)]['update']({'orderId':_0x9aaa19[_0x1a1a77(0x108)]},{'status':_0x1e6ea6,'paydAt':new Date()});_0x1e6ea6===0x1&&await this[_0x1a1a77(0x167)][_0x1a1a77(0x161)](_0x4fbe0a);if(_0x31920c[_0x1a1a77(0xe8)]!=0x1)return _0x1a1a77(0x100);return'success';}async[_0x521700(0x138)](_0x231d38,_0x177a56,_0xe9090b=_0x521700(0xf0)){const _0x5dda56=_0x521700,_0x16a131=await this[_0x5dda56(0x160)][_0x5dda56(0x137)]({'where':{'userId':_0x231d38,'orderId':_0x177a56}});if(!_0x16a131)throw new common_1[(_0x5dda56(0x17d))](_0x5dda56(0xe7),common_1[_0x5dda56(0x118)][_0x5dda56(0x17a)]);const _0x3d2625=await this[_0x5dda56(0xf8)][_0x5dda56(0x137)]({'where':{'id':_0x16a131[_0x5dda56(0xe9)]}});if(!_0x3d2625)throw new common_1['HttpException'](_0x5dda56(0x10f),common_1[_0x5dda56(0x118)][_0x5dda56(0x17a)]);const {payEpayPid:_0x2c79ca,payEpaySecret:_0x236c7a,payEpayNotifyUrl:_0x134664,payEpayReturnUrl:_0x5a9e34,payEpayApiPayUrl:_0x1ab2f1}=await this['globalConfigService'][_0x5dda56(0x185)](['payEpayPid',_0x5dda56(0x10a),_0x5dda56(0x169),'payEpayReturnUrl',_0x5dda56(0xe4)]);let _0x274dc3;_0x2c79ca[_0x5dda56(0x17f)]<=0x10?_0x274dc3=Number(_0x2c79ca):_0x274dc3=BigInt(_0x2c79ca);const _0x5baffa={};_0x5baffa['pid']=_0x274dc3,_0x5baffa[_0x5dda56(0x183)]=_0xe9090b,_0x5baffa[_0x5dda56(0x108)]=_0x177a56,_0x5baffa[_0x5dda56(0xdf)]=_0x3d2625['name'],_0x5baffa[_0x5dda56(0x139)]=_0x16a131[_0x5dda56(0x125)],_0x5baffa['clientip']='192.168.1.100',_0x5baffa[_0x5dda56(0x14f)]='pc',_0x5baffa['notify_url']=_0x134664,_0x5baffa[_0x5dda56(0x16e)]=_0x5a9e34,_0x5baffa['param']=_0x5dda56(0x14a),_0x5baffa[_0x5dda56(0x17b)]=this['sign'](_0x5baffa,_0x236c7a),_0x5baffa[_0x5dda56(0x136)]=_0x5dda56(0x104);const _0x5d0de7=new URLSearchParams(_0x5baffa)['toString'](),_0x5909f4=_0x1ab2f1+'?'+_0x5d0de7;if(_0x1ab2f1['includes'](_0x5dda56(0xde)))return{'url_qrcode':null,'redirectUrl':_0x5909f4,'channel':_0xe9090b,'isRedirect':!![]};else{const _0x3088cf=await axios_1['default'][_0x5dda56(0x152)](_0x1ab2f1,{'params':_0x5baffa});console[_0x5dda56(0x17e)](_0x5dda56(0x171),_0x3088cf['data']);const {data:{code:_0x15867b,msg:_0x2f3e8e,qrcode:_0x2f8deb}}=_0x3088cf;if(_0x15867b!=0x1)throw new common_1['HttpException'](_0x2f3e8e,common_1['HttpStatus'][_0x5dda56(0x17a)]);return{'url_qrcode':_0x2f8deb,'redirectUrl':null,'channel':_0xe9090b,'isRedirect':![]};}}async[_0x521700(0x158)](_0x4eadb7){const _0x56ac5f=_0x521700,{payEpayPid:_0x12c4df,payEpaySecret:_0x15a8c4,payEpayApiQueryUrl:_0x1e8f0c}=await this['globalConfigService'][_0x56ac5f(0x185)]([_0x56ac5f(0x164),_0x56ac5f(0x10a),_0x56ac5f(0x14d)]),_0x8c73e2={};_0x8c73e2[_0x56ac5f(0x103)]='order',_0x8c73e2[_0x56ac5f(0x108)]=_0x4eadb7,_0x8c73e2['pid']=_0x12c4df,_0x8c73e2[_0x56ac5f(0x124)]=_0x15a8c4;const {data:{code:_0x4ea31c,msg:_0x3bb30b,data:_0x211c68}}=await axios_1[_0x56ac5f(0xf9)][_0x56ac5f(0x152)](_0x1e8f0c,{'params':_0x8c73e2});if(_0x4ea31c!=0x1)throw new common_1[(_0x56ac5f(0x17d))](_0x3bb30b,common_1[_0x56ac5f(0x118)][_0x56ac5f(0x17a)]);return _0x211c68;}async[_0x521700(0x119)](_0x3d7e86){const _0x38c927=_0x521700,_0x26a5d3=_0x3d7e86['sign'];delete _0x3d7e86[_0x38c927(0x17b)],delete _0x3d7e86['sign_type'];const _0x8325cf=await this[_0x38c927(0x154)]['getConfigs'](['payMpaySecret']);console[_0x38c927(0x17e)](_0x38c927(0xec));if(this[_0x38c927(0x17b)](_0x3d7e86,_0x8325cf)!=_0x26a5d3)return _0x38c927(0x100);console[_0x38c927(0x17e)](_0x38c927(0x153));const _0x4c06d0=await this[_0x38c927(0x160)]['findOne']({'where':{'orderId':_0x3d7e86[_0x38c927(0x108)],'status':0x0}});if(!_0x4c06d0)return _0x38c927(0x100);const _0x28959d=_0x3d7e86[_0x38c927(0x107)]==_0x38c927(0x16c)?0x1:0x2;console['log'](_0x38c927(0x131),_0x28959d);const _0x9f028b=await this[_0x38c927(0x160)][_0x38c927(0x113)]({'orderId':_0x3d7e86[_0x38c927(0x108)]},{'status':_0x28959d,'paydAt':new Date()});_0x28959d===0x1&&await this[_0x38c927(0x167)]['addBalanceToOrder'](_0x4c06d0);if(_0x9f028b[_0x38c927(0xe8)]!=0x1)return _0x38c927(0x100);return _0x38c927(0x142);}async['payMpay'](_0xeb0cc6,_0x3e0e76,_0x1ad612=_0x521700(0x114)){const _0x13bd05=_0x521700,_0x2a1674=await this[_0x13bd05(0x160)][_0x13bd05(0x137)]({'where':{'userId':_0xeb0cc6,'orderId':_0x3e0e76}});if(!_0x2a1674)throw new common_1[(_0x13bd05(0x17d))](_0x13bd05(0xe7),common_1['HttpStatus'][_0x13bd05(0x17a)]);const _0x5dd9cc=await this['cramiPackageEntity'][_0x13bd05(0x137)]({'where':{'id':_0x2a1674[_0x13bd05(0xe9)]}});if(!_0x5dd9cc)throw new common_1[(_0x13bd05(0x17d))](_0x13bd05(0x10f),common_1[_0x13bd05(0x118)]['BAD_REQUEST']);const {payMpayPid:_0x268799,payMpaySecret:_0x2225b7,payMpayNotifyUrl:_0x13fb57,payMpayReturnUrl:_0x17ff65,payMpayApiPayUrl:_0x4e738d}=await this[_0x13bd05(0x154)][_0x13bd05(0x185)](['payMpayPid',_0x13bd05(0x16d),_0x13bd05(0x10b),_0x13bd05(0xff),'payMpayApiPayUrl']),_0x2a9501={};_0x2a9501[_0x13bd05(0xee)]=Number(_0x268799),_0x2a9501[_0x13bd05(0x183)]=_0x1ad612,_0x2a9501[_0x13bd05(0x108)]=_0x3e0e76,_0x2a9501[_0x13bd05(0xdf)]=_0x5dd9cc[_0x13bd05(0xdf)],_0x2a9501[_0x13bd05(0x139)]=_0x2a1674[_0x13bd05(0x125)],_0x2a9501[_0x13bd05(0xe2)]=_0x13fb57,_0x2a9501[_0x13bd05(0x16e)]=_0x17ff65,_0x2a9501[_0x13bd05(0x17b)]=this[_0x13bd05(0x17b)](_0x2a9501,_0x2225b7),_0x2a9501[_0x13bd05(0x136)]=_0x13bd05(0x104);const _0x162572=new URLSearchParams(_0x2a9501)[_0x13bd05(0x123)](),_0x5927ad=_0x4e738d+'?'+_0x162572;return{'url_qrcode':null,'redirectUrl':_0x5927ad,'channel':_0x1ad612,'isRedirect':!![]};const _0x4a9849=await axios_1[_0x13bd05(0xf9)][_0x13bd05(0x152)](_0x4e738d,{'params':_0x2a9501});}async[_0x521700(0x151)](_0x3d5511){const _0x5352ce=_0x521700,{payMpayApiQueryUrl:_0x2bfbc3}=await this[_0x5352ce(0x154)][_0x5352ce(0x185)](['payMpayPid','payMpaySecret',_0x5352ce(0x110)]),_0x30e945={};_0x30e945[_0x5352ce(0x183)]=0x2,_0x30e945['order_no']=_0x3d5511;const {data:{code:_0x2740c5,msg:_0x4bab7c,data:_0x2cd3b9}}=await axios_1[_0x5352ce(0xf9)][_0x5352ce(0x152)](_0x2bfbc3,{'params':_0x30e945});if(_0x2740c5!=0x1)throw new common_1[(_0x5352ce(0x17d))](_0x4bab7c,common_1['HttpStatus']['BAD_REQUEST']);return _0x2cd3b9;}async['notifyWeChat'](_0x26f57e){const _0x4ffe05=_0x521700;console[_0x4ffe05(0x17e)](_0x4ffe05(0xf3),_0x26f57e);const {payWeChatAppId:_0x2f56ca,payWeChatMchId:_0x399df7,payWeChatSecret:_0x108da9,payWeChatPublicKey:_0x5e0ec5,payWeChatPrivateKey:_0x370ca1}=await this[_0x4ffe05(0x154)]['getConfigs']([_0x4ffe05(0x180),_0x4ffe05(0x12e),_0x4ffe05(0x11e),_0x4ffe05(0x150),_0x4ffe05(0x147)]),_0x32530f=new this[(_0x4ffe05(0x126))]({'appid':_0x2f56ca,'mchid':_0x399df7,'publicKey':_0x5e0ec5,'privateKey':_0x370ca1});try{if(_0x26f57e[_0x4ffe05(0x15f)]=='TRANSACTION.SUCCESS'){const {ciphertext:_0x165f10,associated_data:_0x17fec3,nonce:_0x27be37}=_0x26f57e[_0x4ffe05(0x16a)],_0x4920a5=_0x32530f[_0x4ffe05(0x163)](_0x165f10,_0x17fec3,_0x27be37,_0x108da9),_0x4fde37=await this[_0x4ffe05(0x160)][_0x4ffe05(0x137)]({'where':{'orderId':_0x4920a5[_0x4ffe05(0x108)],'status':0x0}});if(!_0x4fde37)return _0x4ffe05(0x100);const _0x5aa918=_0x4920a5[_0x4ffe05(0x121)]==_0x4ffe05(0x165)?0x1:0x2,_0xadb89=await this['orderEntity'][_0x4ffe05(0x113)]({'orderId':_0x4920a5[_0x4ffe05(0x108)]},{'status':_0x5aa918,'paydAt':new Date()});_0x5aa918===0x1&&await this[_0x4ffe05(0x167)][_0x4ffe05(0x161)](_0x4fde37);if(_0xadb89['affected']!=0x1)return'failed';}return _0x4ffe05(0x142);}catch(_0xa7c301){return console['log'](_0x4ffe05(0x127),_0xa7c301),console[_0x4ffe05(0x17e)]('支付通知验证失败:\x20',_0xa7c301),'failed';}}async['payWeChat'](_0x2aa704,_0x2fe681,_0x5f1668=_0x521700(0x12c)){const _0x3a9bdd=_0x521700;var _0x45d2f3,_0x15a92c,_0x7c47b3;console[_0x3a9bdd(0x17e)](_0x3a9bdd(0x148),_0x5f1668);const _0x5af781=await this['orderEntity'][_0x3a9bdd(0x137)]({'where':{'userId':_0x2aa704,'orderId':_0x2fe681}});if(!_0x5af781)throw new common_1['HttpException']('订单不存在!',common_1[_0x3a9bdd(0x118)][_0x3a9bdd(0x17a)]);const _0x4a7810=await this['cramiPackageEntity'][_0x3a9bdd(0x137)]({'where':{'id':_0x5af781[_0x3a9bdd(0xe9)]}});if(!_0x4a7810)throw new common_1[(_0x3a9bdd(0x17d))](_0x3a9bdd(0x10f),common_1[_0x3a9bdd(0x118)][_0x3a9bdd(0x17a)]);const {payWeChatAppId:_0x4fe506,payWeChatMchId:_0x390a59,payWeChatPublicKey:_0x31096c,payWeChatPrivateKey:_0x3123c4,payWeChatNotifyUrl:_0x1ad8b0,payWeChatH5Name:_0xdcb9c3,payWeChatH5Url:_0x2bb80e}=await this[_0x3a9bdd(0x154)][_0x3a9bdd(0x185)]([_0x3a9bdd(0x180),_0x3a9bdd(0x12e),_0x3a9bdd(0x150),'payWeChatPrivateKey',_0x3a9bdd(0x11b),_0x3a9bdd(0x149),_0x3a9bdd(0x132)]),_0x21b23d=new this[(_0x3a9bdd(0x126))]({'appid':_0x4fe506,'mchid':_0x390a59,'publicKey':_0x31096c,'privateKey':_0x3123c4}),_0x387bad={'appid':_0x4fe506,'mchid':_0x390a59,'description':_0x4a7810[_0x3a9bdd(0xdf)],'out_trade_no':_0x2fe681,'notify_url':_0x1ad8b0,'amount':{'total':Number(_0x5af781[_0x3a9bdd(0x125)]*0x64)},'scene_info':{'payer_client_ip':_0x3a9bdd(0xe3)}};console[_0x3a9bdd(0x17e)](_0x3a9bdd(0xe6),_0x387bad);if(_0x5f1668=='h5'){_0x387bad[_0x3a9bdd(0xe5)]['h5_info']={'type':_0x3a9bdd(0x122),'app_name':_0xdcb9c3,'app_url':_0x2bb80e};const _0x3d8ed7=await _0x21b23d[_0x3a9bdd(0xef)](_0x387bad);if(_0x3d8ed7[_0x3a9bdd(0x12a)]===0x193){const _0x24456e=(_0x7c47b3=(_0x15a92c=(_0x45d2f3=_0x3d8ed7===null||_0x3d8ed7===void 0x0?void 0x0:_0x3d8ed7[_0x3a9bdd(0x140)])===null||_0x45d2f3===void 0x0?void 0x0:_0x45d2f3[_0x3a9bdd(0x179)])===null||_0x15a92c===void 0x0?void 0x0:_0x15a92c['text'])===null||_0x7c47b3===void 0x0?void 0x0:_0x7c47b3[_0x3a9bdd(0x13d)];throw new common_1[(_0x3a9bdd(0x17d))]((_0x3d8ed7===null||_0x3d8ed7===void 0x0?void 0x0:_0x3d8ed7[_0x3a9bdd(0x13d)])||'微信H5支付失败！',common_1['HttpStatus'][_0x3a9bdd(0x17a)]);}const {h5_url:_0x2660d9}=_0x3d8ed7;return{'url':_0x2660d9};}if(_0x5f1668==_0x3a9bdd(0x159)){const _0xb41924=await this[_0x3a9bdd(0x143)]['getOpenIdByUserId'](_0x2aa704);console[_0x3a9bdd(0x17e)](_0x3a9bdd(0x146),_0xb41924),_0x387bad[_0x3a9bdd(0x112)]={'openid':_0xb41924};const _0x4fc3bd=await _0x21b23d['transactions_jsapi'](_0x387bad);return console[_0x3a9bdd(0x17e)](_0x3a9bdd(0x145),_0x4fc3bd),_0x4fc3bd;}if(_0x5f1668==_0x3a9bdd(0x12c)){const _0x23b517=await _0x21b23d[_0x3a9bdd(0x170)](_0x387bad),{code_url:_0x4bf33b}=_0x23b517;return!_0x4bf33b&&console['log'](_0x3a9bdd(0x117),_0x23b517),{'url_qrcode':_0x4bf33b,'isRedirect':![]};}throw new common_1[(_0x3a9bdd(0x17d))](_0x3a9bdd(0x11f),common_1[_0x3a9bdd(0x118)][_0x3a9bdd(0x17a)]);}async[_0x521700(0x12b)](_0x17f28e){const _0x5b6a28=_0x521700,{payWeChatAppId:_0xbdd96,payWeChatMchId:_0x58524d,payWeChatPublicKey:_0x338a5f,payWeChatPrivateKey:_0x15b0ab,payWeChatNotifyUrl:_0x542588,payWeChatH5Name:_0x59deb6,payWeChatH5Url:_0x4c2d18}=await this[_0x5b6a28(0x154)][_0x5b6a28(0x185)](['payWeChatAppId',_0x5b6a28(0x12e),'payWeChatPublicKey',_0x5b6a28(0x147)]),_0x5735a3=new this[(_0x5b6a28(0x126))]({'appid':_0xbdd96,'mchid':_0x58524d,'publicKey':_0x338a5f,'privateKey':_0x15b0ab}),_0x4a60fb=await _0x5735a3['query']({'out_trade_no':_0x17f28e});return _0x4a60fb;}['sign'](_0x3cf623,_0x45f856){const _0x38f7a1=_0x521700,_0x59f690=Object['keys'](_0x3cf623)[_0x38f7a1(0xe0)]()[_0x38f7a1(0x101)](_0x40bc24=>_0x40bc24+'='+_0x3cf623[_0x40bc24])[_0x38f7a1(0x162)]('&')+_0x45f856;return crypto['createHash']('md5')[_0x38f7a1(0x113)](_0x59f690)['digest'](_0x38f7a1(0x12f));}};PayService=__decorate([(0x0,common_1[_0x521700(0x15c)])(),__param(0x0,(0x0,typeorm_1[_0x521700(0x116)])(cramiPackage_entity_1[_0x521700(0x128)])),__param(0x1,(0x0,typeorm_1[_0x521700(0x116)])(order_entity_1[_0x521700(0x120)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2['Repository'],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x521700(0xfc)],user_service_1['UserService']])],PayService),exports['PayService']=PayService;