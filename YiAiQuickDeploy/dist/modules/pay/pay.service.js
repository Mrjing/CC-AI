'use strict';const _0x1b8558=_0x6f45;function _0x6f45(_0x172e05,_0x4dc21b){const _0x58ed70=_0x58ed();return _0x6f45=function(_0x6f4517,_0x4aa0a1){_0x6f4517=_0x6f4517-0x96;let _0x278ae8=_0x58ed70[_0x6f4517];return _0x278ae8;},_0x6f45(_0x172e05,_0x4dc21b);}function _0x58ed(){const _0x41c36e=['payWeChatH5Name','payEpayPid','userService','payWeChatMchId','env','addBalanceToOrder','affected','wechatpay-node-v3','act','notifyWeChat','Repository','wx-native\x20获取二维码地址为空','wxpay','payMpayPid','pay','queryMpay','epay','decorate','pid','return_url','get','nonce_str','trade_status','校验签名通过','hash','response','支付请求失败:\x20','3106548QUunnX','jsapi','payHupiReturnUrl','TRANSACTION.SUCCESS','typeorm','metadata','payWeChatNotifyUrl','payEpay','../user/user.service','TRADE_SUCCESS','payWeChatH5Url','userBalanceService','payWeChatAppId','crypto','192.168.1.100','572CLcAVU','payHupiGatewayUrl','payWeChatSecret','payPlatform','device','payMpayNotifyUrl','toFixed','hex','post','keys','6931736MbmFuY','order','time','event_type','https://api.xunhupay.com/payment/query.html','resource','HttpStatus','globalConfigService','10320037XsAJxA','hupi','queryHupi','../crami/cramiPackage.entity','createRandomNonceStr','cramiPackageEntity','h5_info','UserBalanceService','length','error:\x20','notify_url','HttpException','onModuleInit','jsapi支付结果返回值:\x20','payer','status','goodsId','payWeChatPublicKey','axios','epay\x20--->\x20res:\x20','getConfigs','name','text','payMpaySecret','map','1.1','wechat-pay:\x20','update','42oqtnsv','InjectRepository','data','SERIAL_NO','transactions_native','../../common/utils','payHupi','trade_order_id','wechat','notifyEpay','GlobalConfigService','log','payEpayNotifyUrl','notify','payMpay','payMpayApiQueryUrl','attach','toString','orderEntity','MD5','6891HVHKHp','sign','__param','BAD_REQUEST','money','type','title','success','UserService','total','key','clientip','message','query','total_fee','payEpaySecret','design:paramtypes','payHupiAppId','payMpayReturnUrl','payWeChatPrivateKey','now','644065OYZGfN','套餐不存在!','OrderEntity','errRaw','appid','findOne','scene_info','sign_type','notifyMpay','微信支付通知params:\x20','digest','payMpayApiPayUrl','../globalConfig/globalConfig.service','969870sFAEMK','payWeChat','payHupiSecret','Injectable','out_trade_no','payHupiNotifyUrl','订单不存在!','object','transactions_jsapi','WxPay','importDynamic','payEpayApiQueryUrl','trade_state','payType:\x20','default','CramiPackageEntity','defineProperty','alipay','version','transactions_h5','__esModule','payEpayReturnUrl','failed','用户openId:\x20','payEpayApiPayUrl','本次支付类型:\x20','md5','Wap','join','decipher_gcm','submit.php','支付请求失败!','1143437ywVgQW','function'];_0x58ed=function(){return _0x41c36e;};return _0x58ed();}(function(_0x56713c,_0x3cb0ff){const _0x51c124=_0x6f45,_0xe2c370=_0x56713c();while(!![]){try{const _0x216cee=-parseInt(_0x51c124(0x119))/0x1+parseInt(_0x51c124(0xf9))/0x2+parseInt(_0x51c124(0xd7))/0x3*(parseInt(_0x51c124(0x145))/0x4)+parseInt(_0x51c124(0xec))/0x5*(parseInt(_0x51c124(0xc3))/0x6)+parseInt(_0x51c124(0xa7))/0x7+-parseInt(_0x51c124(0x9f))/0x8+-parseInt(_0x51c124(0x136))/0x9;if(_0x216cee===_0x3cb0ff)break;else _0xe2c370['push'](_0xe2c370['shift']());}catch(_0x13090d){_0xe2c370['push'](_0xe2c370['shift']());}}}(_0x58ed,0xcbb08));var __decorate=this&&this['__decorate']||function(_0x2053c7,_0x59da87,_0x54f5c4,_0x3c7e74){const _0x3ae718=_0x6f45;var _0x701200=arguments['length'],_0x549ff0=_0x701200<0x3?_0x59da87:_0x3c7e74===null?_0x3c7e74=Object['getOwnPropertyDescriptor'](_0x59da87,_0x54f5c4):_0x3c7e74,_0x387bf7;if(typeof Reflect===_0x3ae718(0x100)&&typeof Reflect['decorate']===_0x3ae718(0x11a))_0x549ff0=Reflect[_0x3ae718(0x12c)](_0x2053c7,_0x59da87,_0x54f5c4,_0x3c7e74);else{for(var _0x63ab00=_0x2053c7[_0x3ae718(0xaf)]-0x1;_0x63ab00>=0x0;_0x63ab00--)if(_0x387bf7=_0x2053c7[_0x63ab00])_0x549ff0=(_0x701200<0x3?_0x387bf7(_0x549ff0):_0x701200>0x3?_0x387bf7(_0x59da87,_0x54f5c4,_0x549ff0):_0x387bf7(_0x59da87,_0x54f5c4))||_0x549ff0;}return _0x701200>0x3&&_0x549ff0&&Object[_0x3ae718(0x109)](_0x59da87,_0x54f5c4,_0x549ff0),_0x549ff0;},__metadata=this&&this['__metadata']||function(_0x2be853,_0x4cf15a){const _0x1a3d47=_0x6f45;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x1a3d47(0x11a))return Reflect[_0x1a3d47(0x13b)](_0x2be853,_0x4cf15a);},__param=this&&this[_0x1b8558(0xd9)]||function(_0x4836ba,_0x426b2e){return function(_0x517023,_0x48ce29){_0x426b2e(_0x517023,_0x48ce29,_0x4836ba);};};Object['defineProperty'](exports,_0x1b8558(0x10d),{'value':!![]}),exports['PayService']=void 0x0;const typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x1b8558(0x13a)),common_1=require('@nestjs/common'),crypto=require(_0x1b8558(0x143)),axios_1=require(_0x1b8558(0xb9)),order_entity_1=require('../order/order.entity'),cramiPackage_entity_1=require(_0x1b8558(0xaa)),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require(_0x1b8558(0xf8)),utils_1=require(_0x1b8558(0xc8)),user_service_1=require(_0x1b8558(0x13e));let PayService=class PayService{constructor(_0x4a68e2,_0x23c5ad,_0x5a9bb3,_0xf2a905,_0x54ffda){const _0x694771=_0x1b8558;this['cramiPackageEntity']=_0x4a68e2,this['orderEntity']=_0x23c5ad,this[_0x694771(0x141)]=_0x5a9bb3,this[_0x694771(0xa6)]=_0xf2a905,this[_0x694771(0x11d)]=_0x54ffda;}async[_0x1b8558(0xb3)](){const _0xd75fdb=_0x1b8558,_0x25fe5d=await(0x0,utils_1[_0xd75fdb(0x103)])(_0xd75fdb(0x122));this['WxPay']=(_0x25fe5d===null||_0x25fe5d===void 0x0?void 0x0:_0x25fe5d[_0xd75fdb(0x107)])?_0x25fe5d[_0xd75fdb(0x107)]:_0x25fe5d;}async[_0x1b8558(0xd0)](_0x19831d){const _0x3599bd=_0x1b8558;if(_0x19831d['param']==_0x3599bd(0x12b))return this[_0x3599bd(0xcc)](_0x19831d);if(_0x19831d[_0x3599bd(0xd3)]==_0x3599bd(0xa8))return this['notifyHupi'](_0x19831d);if(typeof _0x19831d[_0x3599bd(0xa4)]==_0x3599bd(0x100))return this[_0x3599bd(0x124)](_0x19831d);return this[_0x3599bd(0xf4)](_0x19831d);}async[_0x1b8558(0x129)](_0xee7dbb,_0x4a2927,_0x45e039=_0x1b8558(0x127)){const _0x2902c9=_0x1b8558,_0x54ca7e=await this[_0x2902c9(0xd5)][_0x2902c9(0xf1)]({'where':{'userId':_0xee7dbb,'orderId':_0x4a2927}});if(!_0x54ca7e)throw new common_1[(_0x2902c9(0xb2))](_0x2902c9(0xff),common_1[_0x2902c9(0xa5)]['BAD_REQUEST']);const _0x2362e7=await this[_0x2902c9(0xac)]['findOne']({'where':{'id':_0x54ca7e[_0x2902c9(0xb7)]}});if(!_0x2362e7)throw new common_1[(_0x2902c9(0xb2))](_0x2902c9(0xed),common_1[_0x2902c9(0xa5)][_0x2902c9(0xda)]);console['log'](_0x2902c9(0x112),_0x54ca7e['payPlatform']);try{if(_0x54ca7e['payPlatform']==_0x2902c9(0xcb))return this[_0x2902c9(0xfa)](_0xee7dbb,_0x4a2927,_0x45e039);if(_0x54ca7e[_0x2902c9(0x98)]==_0x2902c9(0x12b))return this[_0x2902c9(0x13d)](_0xee7dbb,_0x4a2927,_0x45e039);if(_0x54ca7e[_0x2902c9(0x98)]=='mpay')return this[_0x2902c9(0xd1)](_0xee7dbb,_0x4a2927,_0x45e039);if(_0x54ca7e[_0x2902c9(0x98)]=='hupi')return this[_0x2902c9(0xc9)](_0xee7dbb,_0x4a2927,_0x45e039);}catch(_0x1ac625){console['log'](_0x2902c9(0x135),_0x1ac625);throw new common_1['HttpException'](_0x2902c9(0x118),common_1['HttpStatus']['BAD_REQUEST']);}}async['query'](_0x516b7b){const _0x1e76ea=_0x1b8558,_0x5ebe95=await this[_0x1e76ea(0xd5)][_0x1e76ea(0xf1)]({'where':{'orderId':_0x516b7b}});if(!_0x5ebe95)throw new common_1[(_0x1e76ea(0xb2))](_0x1e76ea(0xff),common_1['HttpStatus'][_0x1e76ea(0xda)]);return _0x5ebe95;}async['notifyHupi'](_0x1f8a54){const _0x16ba35=_0x1b8558,_0x976239=await this['globalConfigService'][_0x16ba35(0xbb)]([_0x16ba35(0xfb)]),_0x1a0ab3=_0x1f8a54[_0x16ba35(0x133)];delete _0x1f8a54[_0x16ba35(0x133)];if(this['sign'](_0x1f8a54,_0x976239)!=_0x1a0ab3)return _0x16ba35(0x10f);const _0x19b9d5=await this['orderEntity'][_0x16ba35(0xf1)]({'where':{'orderId':_0x1f8a54[_0x16ba35(0xca)],'status':0x0}});if(!_0x19b9d5)return _0x16ba35(0x10f);await this[_0x16ba35(0x141)][_0x16ba35(0x120)](_0x19b9d5);const _0x2b3745=await this[_0x16ba35(0xd5)][_0x16ba35(0xc2)]({'orderId':_0x1f8a54[_0x16ba35(0xca)]},{'status':0x1,'paydAt':new Date()});if(_0x2b3745['affected']!=0x1)return'failed';return _0x16ba35(0xde);}async['payHupi'](_0x17a4cc,_0x36dee9,_0x3365d3=_0x1b8558(0x127)){const _0x1fc7a9=_0x1b8558,_0x2724b4=await this[_0x1fc7a9(0xd5)]['findOne']({'where':{'userId':_0x17a4cc,'orderId':_0x36dee9}});if(!_0x2724b4)throw new common_1[(_0x1fc7a9(0xb2))]('订单不存在!',common_1[_0x1fc7a9(0xa5)][_0x1fc7a9(0xda)]);const _0x17fd9c=await this[_0x1fc7a9(0xac)][_0x1fc7a9(0xf1)]({'where':{'id':_0x2724b4['goodsId']}});if(!_0x17fd9c)throw new common_1['HttpException'](_0x1fc7a9(0xed),common_1[_0x1fc7a9(0xa5)][_0x1fc7a9(0xda)]);const {payHupiAppId:_0x51489e,payHupiSecret:_0x161a68,payHupiNotifyUrl:_0x59ccc8,payHupiReturnUrl:_0x484274,payHupiGatewayUrl:_0x2fbf06}=await this[_0x1fc7a9(0xa6)][_0x1fc7a9(0xbb)]([_0x1fc7a9(0xe8),_0x1fc7a9(0xfb),_0x1fc7a9(0xfe),_0x1fc7a9(0x138),_0x1fc7a9(0x96)]),_0x846849={};_0x846849['version']=_0x1fc7a9(0xc0),_0x846849[_0x1fc7a9(0xf0)]=_0x51489e,_0x846849[_0x1fc7a9(0xa1)]=(Date[_0x1fc7a9(0xeb)]()/0x3e8)[_0x1fc7a9(0x9b)](0x0),_0x846849['nonce_str']=(0x0,utils_1[_0x1fc7a9(0xab)])(0x20),_0x846849[_0x1fc7a9(0xca)]=_0x36dee9,_0x846849[_0x1fc7a9(0xdd)]=_0x17fd9c[_0x1fc7a9(0xbc)],_0x846849[_0x1fc7a9(0xe5)]=_0x2724b4[_0x1fc7a9(0xe0)],_0x846849['notify_url']=_0x59ccc8,_0x846849['return_url']=_0x484274,_0x846849[_0x1fc7a9(0xd3)]=_0x1fc7a9(0xa8),_0x846849['hash']=this['sign'](_0x846849,_0x161a68);const {data:{errcode:_0x189aa5,errmsg:_0x47da41,url_qrcode:_0x192338,url:_0x483d9c}}=await axios_1['default'][_0x1fc7a9(0x9d)](_0x2fbf06||'https://api.xunhupay.com/payment/do.html',_0x846849);if(_0x189aa5!=0x0)throw new common_1[(_0x1fc7a9(0xb2))](_0x47da41,common_1['HttpStatus'][_0x1fc7a9(0xda)]);return{'url_qrcode':_0x192338,'url':_0x483d9c};}async[_0x1b8558(0xa9)](_0x8658f9){const _0x4e6873=_0x1b8558,{payHupiAppId:_0x280e85,payHupiSecret:_0x320343}=await this['globalConfigService'][_0x4e6873(0xbb)](['payHupiAppId',_0x4e6873(0xfb)]),_0x38b80f={};_0x38b80f[_0x4e6873(0x10b)]=_0x4e6873(0xc0),_0x38b80f['appid']=_0x280e85,_0x38b80f[_0x4e6873(0xa1)]=(Date[_0x4e6873(0xeb)]()/0x3e8)[_0x4e6873(0x9b)](0x0),_0x38b80f[_0x4e6873(0x130)]=(0x0,utils_1[_0x4e6873(0xab)])(0x20),_0x38b80f['out_trade_order']=_0x8658f9,_0x38b80f[_0x4e6873(0x133)]=this[_0x4e6873(0xd8)](_0x38b80f,_0x320343);const {data:{errcode:_0x2ffdb2,errmsg:_0x12f333,data:_0x3df242}}=await axios_1[_0x4e6873(0x107)][_0x4e6873(0x9d)](_0x4e6873(0xa3),_0x38b80f);if(_0x2ffdb2!=0x0)throw new common_1[(_0x4e6873(0xb2))](_0x12f333,common_1['HttpStatus'][_0x4e6873(0xda)]);return _0x3df242;}async[_0x1b8558(0xcc)](_0x1caef1){const _0x236705=_0x1b8558,_0x5a36e6=_0x1caef1['sign'];delete _0x1caef1[_0x236705(0xd8)],delete _0x1caef1[_0x236705(0xf3)];const _0x58a500=await this[_0x236705(0xa6)][_0x236705(0xbb)]([_0x236705(0xe6)]);if(this[_0x236705(0xd8)](_0x1caef1,_0x58a500)!=_0x5a36e6)return _0x236705(0x10f);console[_0x236705(0xce)](_0x236705(0x132));const _0x201417=await this['orderEntity']['findOne']({'where':{'orderId':_0x1caef1[_0x236705(0xfd)],'status':0x0}});if(!_0x201417)return'failed';const _0x24a88f=_0x1caef1[_0x236705(0x131)]=='TRADE_SUCCESS'?0x1:0x2,_0x53c0cc=await this['orderEntity']['update']({'orderId':_0x1caef1[_0x236705(0xfd)]},{'status':_0x24a88f,'paydAt':new Date()});_0x24a88f===0x1&&await this[_0x236705(0x141)][_0x236705(0x120)](_0x201417);if(_0x53c0cc['affected']!=0x1)return'failed';return _0x236705(0xde);}async[_0x1b8558(0x13d)](_0xe6c2ca,_0x211872,_0x406998=_0x1b8558(0x10a)){const _0x17f64e=_0x1b8558,_0x4d06b5=await this[_0x17f64e(0xd5)][_0x17f64e(0xf1)]({'where':{'userId':_0xe6c2ca,'orderId':_0x211872}});if(!_0x4d06b5)throw new common_1[(_0x17f64e(0xb2))](_0x17f64e(0xff),common_1[_0x17f64e(0xa5)][_0x17f64e(0xda)]);const _0x5835a0=await this[_0x17f64e(0xac)][_0x17f64e(0xf1)]({'where':{'id':_0x4d06b5[_0x17f64e(0xb7)]}});if(!_0x5835a0)throw new common_1[(_0x17f64e(0xb2))](_0x17f64e(0xed),common_1[_0x17f64e(0xa5)]['BAD_REQUEST']);const {payEpayPid:_0x3bfb79,payEpaySecret:_0xe04f23,payEpayNotifyUrl:_0x184601,payEpayReturnUrl:_0xe965a9,payEpayApiPayUrl:_0x251cd9}=await this[_0x17f64e(0xa6)]['getConfigs']([_0x17f64e(0x11c),_0x17f64e(0xe6),_0x17f64e(0xcf),_0x17f64e(0x10e),_0x17f64e(0x111)]);let _0x2b6bd9;_0x3bfb79[_0x17f64e(0xaf)]<=0x10?_0x2b6bd9=Number(_0x3bfb79):_0x2b6bd9=BigInt(_0x3bfb79);const _0x341172={};_0x341172['pid']=_0x2b6bd9,_0x341172[_0x17f64e(0xdc)]=_0x406998,_0x341172['out_trade_no']=_0x211872,_0x341172[_0x17f64e(0xbc)]=_0x5835a0[_0x17f64e(0xbc)],_0x341172[_0x17f64e(0xdb)]=_0x4d06b5[_0x17f64e(0xe0)],_0x341172[_0x17f64e(0xe2)]='192.168.1.100',_0x341172[_0x17f64e(0x99)]='pc',_0x341172[_0x17f64e(0xb1)]=_0x184601,_0x341172['return_url']=_0xe965a9,_0x341172['param']='epay',_0x341172[_0x17f64e(0xd8)]=this[_0x17f64e(0xd8)](_0x341172,_0xe04f23),_0x341172[_0x17f64e(0xf3)]=_0x17f64e(0xd6);const _0x519a8c=new URLSearchParams(_0x341172)[_0x17f64e(0xd4)](),_0x32cd1a=_0x251cd9+'?'+_0x519a8c;if(_0x251cd9['includes'](_0x17f64e(0x117)))return{'url_qrcode':null,'redirectUrl':_0x32cd1a,'channel':_0x406998,'isRedirect':!![]};else{const _0x270246=await axios_1[_0x17f64e(0x107)]['get'](_0x251cd9,{'params':_0x341172});console['log'](_0x17f64e(0xba),_0x270246[_0x17f64e(0xc5)]);const {data:{code:_0x3d95cf,msg:_0x36f66c,qrcode:_0x457882}}=_0x270246;if(_0x3d95cf!=0x1)throw new common_1[(_0x17f64e(0xb2))](_0x36f66c,common_1[_0x17f64e(0xa5)]['BAD_REQUEST']);return{'url_qrcode':_0x457882,'redirectUrl':null,'channel':_0x406998,'isRedirect':![]};}}async['queryEpay'](_0x1e7855){const _0x1d1bd5=_0x1b8558,{payEpayPid:_0x3db5de,payEpaySecret:_0x636ec4,payEpayApiQueryUrl:_0x5cbcd4}=await this[_0x1d1bd5(0xa6)][_0x1d1bd5(0xbb)]([_0x1d1bd5(0x11c),_0x1d1bd5(0xe6),_0x1d1bd5(0x104)]),_0x526929={};_0x526929[_0x1d1bd5(0x123)]=_0x1d1bd5(0xa0),_0x526929[_0x1d1bd5(0xfd)]=_0x1e7855,_0x526929[_0x1d1bd5(0x12d)]=_0x3db5de,_0x526929[_0x1d1bd5(0xe1)]=_0x636ec4;const {data:{code:_0xa4e2c3,msg:_0x162723,data:_0x220771}}=await axios_1[_0x1d1bd5(0x107)][_0x1d1bd5(0x12f)](_0x5cbcd4,{'params':_0x526929});if(_0xa4e2c3!=0x1)throw new common_1[(_0x1d1bd5(0xb2))](_0x162723,common_1['HttpStatus']['BAD_REQUEST']);return _0x220771;}async[_0x1b8558(0xf4)](_0x2e4d41){const _0x306a9d=_0x1b8558,_0x10cf06=_0x2e4d41['sign'];delete _0x2e4d41[_0x306a9d(0xd8)],delete _0x2e4d41['sign_type'];const _0x3cee06=await this[_0x306a9d(0xa6)][_0x306a9d(0xbb)]([_0x306a9d(0xbe)]);console[_0x306a9d(0xce)]('校验签名');if(this[_0x306a9d(0xd8)](_0x2e4d41,_0x3cee06)!=_0x10cf06)return _0x306a9d(0x10f);console[_0x306a9d(0xce)](_0x306a9d(0x132));const _0x34818e=await this['orderEntity'][_0x306a9d(0xf1)]({'where':{'orderId':_0x2e4d41[_0x306a9d(0xfd)],'status':0x0}});if(!_0x34818e)return _0x306a9d(0x10f);const _0x4584c8=_0x2e4d41[_0x306a9d(0x131)]==_0x306a9d(0x13f)?0x1:0x2;console[_0x306a9d(0xce)]('status:\x20',_0x4584c8);const _0x2418dd=await this[_0x306a9d(0xd5)]['update']({'orderId':_0x2e4d41['out_trade_no']},{'status':_0x4584c8,'paydAt':new Date()});_0x4584c8===0x1&&await this[_0x306a9d(0x141)][_0x306a9d(0x120)](_0x34818e);if(_0x2418dd[_0x306a9d(0x121)]!=0x1)return _0x306a9d(0x10f);return'success';}async[_0x1b8558(0xd1)](_0x4dae46,_0x48d80f,_0x18f415='wxpay'){const _0x401b50=_0x1b8558,_0x4f7a89=await this[_0x401b50(0xd5)][_0x401b50(0xf1)]({'where':{'userId':_0x4dae46,'orderId':_0x48d80f}});if(!_0x4f7a89)throw new common_1['HttpException'](_0x401b50(0xff),common_1[_0x401b50(0xa5)][_0x401b50(0xda)]);const _0x213843=await this[_0x401b50(0xac)]['findOne']({'where':{'id':_0x4f7a89[_0x401b50(0xb7)]}});if(!_0x213843)throw new common_1[(_0x401b50(0xb2))](_0x401b50(0xed),common_1[_0x401b50(0xa5)][_0x401b50(0xda)]);const {payMpayPid:_0x5f2f64,payMpaySecret:_0x1bb43b,payMpayNotifyUrl:_0x540490,payMpayReturnUrl:_0xb67f4a,payMpayApiPayUrl:_0x2164ef}=await this[_0x401b50(0xa6)][_0x401b50(0xbb)]([_0x401b50(0x128),_0x401b50(0xbe),_0x401b50(0x9a),_0x401b50(0xe9),_0x401b50(0xf7)]),_0x13ff78={};_0x13ff78[_0x401b50(0x12d)]=Number(_0x5f2f64),_0x13ff78['type']=_0x18f415,_0x13ff78[_0x401b50(0xfd)]=_0x48d80f,_0x13ff78[_0x401b50(0xbc)]=_0x213843[_0x401b50(0xbc)],_0x13ff78[_0x401b50(0xdb)]=_0x4f7a89[_0x401b50(0xe0)],_0x13ff78[_0x401b50(0xb1)]=_0x540490,_0x13ff78[_0x401b50(0x12e)]=_0xb67f4a,_0x13ff78['sign']=this[_0x401b50(0xd8)](_0x13ff78,_0x1bb43b),_0x13ff78[_0x401b50(0xf3)]='MD5';const _0x49cd48=new URLSearchParams(_0x13ff78)[_0x401b50(0xd4)](),_0xe79a70=_0x2164ef+'?'+_0x49cd48;return{'url_qrcode':null,'redirectUrl':_0xe79a70,'channel':_0x18f415,'isRedirect':!![]};const _0x47dc15=await axios_1[_0x401b50(0x107)][_0x401b50(0x12f)](_0x2164ef,{'params':_0x13ff78});}async[_0x1b8558(0x12a)](_0x16fad0){const _0x4ebebe=_0x1b8558,{payMpayApiQueryUrl:_0x4e49dd}=await this['globalConfigService'][_0x4ebebe(0xbb)]([_0x4ebebe(0x128),_0x4ebebe(0xbe),_0x4ebebe(0xd2)]),_0x26fd1d={};_0x26fd1d[_0x4ebebe(0xdc)]=0x2,_0x26fd1d['order_no']=_0x16fad0;const {data:{code:_0x45a5fd,msg:_0x199d31,data:_0x5b496b}}=await axios_1[_0x4ebebe(0x107)][_0x4ebebe(0x12f)](_0x4e49dd,{'params':_0x26fd1d});if(_0x45a5fd!=0x1)throw new common_1[(_0x4ebebe(0xb2))](_0x199d31,common_1['HttpStatus'][_0x4ebebe(0xda)]);return _0x5b496b;}async[_0x1b8558(0x124)](_0x63ce9c){const _0xbc84d9=_0x1b8558;console[_0xbc84d9(0xce)](_0xbc84d9(0xf5),_0x63ce9c);const {payWeChatAppId:_0x486840,payWeChatMchId:_0x5d28f1,payWeChatSecret:_0x3e756a,payWeChatPublicKey:_0x9e25eb,payWeChatPrivateKey:_0x2515b9}=await this['globalConfigService']['getConfigs']([_0xbc84d9(0x142),_0xbc84d9(0x11e),_0xbc84d9(0x97),'payWeChatPublicKey',_0xbc84d9(0xea)]),_0x5d5296=new this[(_0xbc84d9(0x102))]({'appid':_0x486840,'mchid':_0x5d28f1,'publicKey':_0x9e25eb,'privateKey':_0x2515b9});try{if(_0x63ce9c[_0xbc84d9(0xa2)]==_0xbc84d9(0x139)){const {ciphertext:_0x3f7baa,associated_data:_0x428b67,nonce:_0x42568b}=_0x63ce9c[_0xbc84d9(0xa4)],_0x4fd3df=_0x5d5296[_0xbc84d9(0x116)](_0x3f7baa,_0x428b67,_0x42568b,_0x3e756a),_0x22b3f8=await this['orderEntity']['findOne']({'where':{'orderId':_0x4fd3df['out_trade_no'],'status':0x0}});if(!_0x22b3f8)return _0xbc84d9(0x10f);const _0x100ecc=_0x4fd3df[_0xbc84d9(0x105)]=='SUCCESS'?0x1:0x2,_0x492586=await this['orderEntity'][_0xbc84d9(0xc2)]({'orderId':_0x4fd3df[_0xbc84d9(0xfd)]},{'status':_0x100ecc,'paydAt':new Date()});_0x100ecc===0x1&&await this['userBalanceService'][_0xbc84d9(0x120)](_0x22b3f8);if(_0x492586[_0xbc84d9(0x121)]!=0x1)return'failed';}return _0xbc84d9(0xde);}catch(_0x5f251c){return console['log'](_0xbc84d9(0xb0),_0x5f251c),console[_0xbc84d9(0xce)]('支付通知验证失败:\x20',_0x5f251c),'failed';}}async[_0x1b8558(0xfa)](_0x42fc82,_0xc602d4,_0x233f9d='native'){const _0x3de193=_0x1b8558;var _0x256769,_0x3cb574,_0x1d7022;console[_0x3de193(0xce)](_0x3de193(0x106),_0x233f9d);const _0x2c7caa=await this[_0x3de193(0xd5)][_0x3de193(0xf1)]({'where':{'userId':_0x42fc82,'orderId':_0xc602d4}});if(!_0x2c7caa)throw new common_1['HttpException'](_0x3de193(0xff),common_1[_0x3de193(0xa5)][_0x3de193(0xda)]);const _0x244ab6=await this[_0x3de193(0xac)][_0x3de193(0xf1)]({'where':{'id':_0x2c7caa[_0x3de193(0xb7)]}});if(!_0x244ab6)throw new common_1['HttpException'](_0x3de193(0xed),common_1['HttpStatus'][_0x3de193(0xda)]);const {payWeChatAppId:_0x456609,payWeChatMchId:_0xf3b9e0,payWeChatPublicKey:_0x24a6c9,payWeChatPrivateKey:_0x330d1c,payWeChatNotifyUrl:_0x316941,payWeChatH5Name:_0x3d61ac,payWeChatH5Url:_0x2ec571}=await this[_0x3de193(0xa6)][_0x3de193(0xbb)]([_0x3de193(0x142),_0x3de193(0x11e),'payWeChatPublicKey','payWeChatPrivateKey',_0x3de193(0x13c),_0x3de193(0x11b),_0x3de193(0x140)]);console[_0x3de193(0xce)](_0x3de193(0x142),_0x456609),console[_0x3de193(0xce)](_0x3de193(0x11e),_0xf3b9e0),console[_0x3de193(0xce)](_0x3de193(0xb8),_0x24a6c9),console[_0x3de193(0xce)]('payWeChatPrivateKey',_0x330d1c);const _0x54e74b=new this[(_0x3de193(0x102))]({'appid':_0x456609,'mchid':_0xf3b9e0,'publicKey':_0x24a6c9,'privateKey':_0x330d1c,'serial_no':process[_0x3de193(0x11f)][_0x3de193(0xc6)]}),_0x53b007={'appid':_0x456609,'mchid':_0xf3b9e0,'description':_0x244ab6[_0x3de193(0xbc)],'out_trade_no':_0xc602d4,'notify_url':_0x316941,'amount':{'total':Number(_0x2c7caa[_0x3de193(0xe0)]*0x64)},'scene_info':{'payer_client_ip':_0x3de193(0x144)}};console[_0x3de193(0xce)](_0x3de193(0xc1),_0x53b007);if(_0x233f9d=='h5'){_0x53b007[_0x3de193(0xf2)][_0x3de193(0xad)]={'type':_0x3de193(0x114),'app_name':_0x3d61ac,'app_url':_0x2ec571};const _0x4f9737=await _0x54e74b[_0x3de193(0x10c)](_0x53b007);if(_0x4f9737[_0x3de193(0xb6)]===0x193){const _0x572643=(_0x1d7022=(_0x3cb574=(_0x256769=_0x4f9737===null||_0x4f9737===void 0x0?void 0x0:_0x4f9737[_0x3de193(0xef)])===null||_0x256769===void 0x0?void 0x0:_0x256769[_0x3de193(0x134)])===null||_0x3cb574===void 0x0?void 0x0:_0x3cb574[_0x3de193(0xbd)])===null||_0x1d7022===void 0x0?void 0x0:_0x1d7022[_0x3de193(0xe3)];throw new common_1['HttpException']((_0x4f9737===null||_0x4f9737===void 0x0?void 0x0:_0x4f9737[_0x3de193(0xe3)])||'微信H5支付失败！',common_1[_0x3de193(0xa5)]['BAD_REQUEST']);}const {h5_url:_0x3167a3}=_0x4f9737;return{'url':_0x3167a3};}if(_0x233f9d==_0x3de193(0x137)){const _0x33386a=await this[_0x3de193(0x11d)]['getOpenIdByUserId'](_0x42fc82);console[_0x3de193(0xce)](_0x3de193(0x110),_0x33386a),_0x53b007[_0x3de193(0xb5)]={'openid':_0x33386a};const _0x185a5f=await _0x54e74b[_0x3de193(0x101)](_0x53b007);return console[_0x3de193(0xce)](_0x3de193(0xb4),_0x185a5f),_0x185a5f;}if(_0x233f9d=='native'){const _0x191f94=await _0x54e74b[_0x3de193(0xc7)](_0x53b007),{data:_0x3bdf3b,status:_0x466ed2}=_0x191f94;if(_0x466ed2!==0xc8)throw new common_1[(_0x3de193(0xb2))]('获取支付二维码失败',_0x191f94);const {code_url:_0x4a8587}=_0x3bdf3b;return!_0x4a8587&&console['log'](_0x3de193(0x126),_0x191f94),{'url_qrcode':_0x4a8587,'isRedirect':![]};}throw new common_1[(_0x3de193(0xb2))]('unsupported\x20pay\x20type',common_1['HttpStatus'][_0x3de193(0xda)]);}async['queryWeChat'](_0x5da7ec){const _0x35aa9e=_0x1b8558,{payWeChatAppId:_0x3e0584,payWeChatMchId:_0x58cedd,payWeChatPublicKey:_0x5651f4,payWeChatPrivateKey:_0x9fd04c,payWeChatNotifyUrl:_0x51ab55,payWeChatH5Name:_0xc231db,payWeChatH5Url:_0x4ebf92}=await this[_0x35aa9e(0xa6)][_0x35aa9e(0xbb)]([_0x35aa9e(0x142),_0x35aa9e(0x11e),_0x35aa9e(0xb8),_0x35aa9e(0xea)]),_0x1f6dab=new this[(_0x35aa9e(0x102))]({'appid':_0x3e0584,'mchid':_0x58cedd,'publicKey':_0x5651f4,'privateKey':_0x9fd04c}),_0x536956=await _0x1f6dab[_0x35aa9e(0xe4)]({'out_trade_no':_0x5da7ec});return _0x536956;}[_0x1b8558(0xd8)](_0x54b960,_0x3e011d){const _0x49991f=_0x1b8558,_0x57861e=Object[_0x49991f(0x9e)](_0x54b960)['sort']()[_0x49991f(0xbf)](_0x4d0f1b=>_0x4d0f1b+'='+_0x54b960[_0x4d0f1b])[_0x49991f(0x115)]('&')+_0x3e011d;return crypto['createHash'](_0x49991f(0x113))[_0x49991f(0xc2)](_0x57861e)[_0x49991f(0xf6)](_0x49991f(0x9c));}};PayService=__decorate([(0x0,common_1[_0x1b8558(0xfc)])(),__param(0x0,(0x0,typeorm_1[_0x1b8558(0xc4)])(cramiPackage_entity_1[_0x1b8558(0x108)])),__param(0x1,(0x0,typeorm_1[_0x1b8558(0xc4)])(order_entity_1[_0x1b8558(0xee)])),__metadata(_0x1b8558(0xe7),[typeorm_2[_0x1b8558(0x125)],typeorm_2['Repository'],userBalance_service_1[_0x1b8558(0xae)],globalConfig_service_1[_0x1b8558(0xcd)],user_service_1[_0x1b8558(0xdf)]])],PayService),exports['PayService']=PayService;