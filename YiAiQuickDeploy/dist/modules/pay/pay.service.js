'use strict';const _0xd5b88b=_0x2992;(function(_0x397552,_0x3087f3){const _0x1a68a0=_0x2992,_0x1157c7=_0x397552();while(!![]){try{const _0x10bd7b=parseInt(_0x1a68a0(0x1ab))/0x1*(-parseInt(_0x1a68a0(0x1a6))/0x2)+-parseInt(_0x1a68a0(0x158))/0x3*(-parseInt(_0x1a68a0(0x164))/0x4)+-parseInt(_0x1a68a0(0x18b))/0x5+parseInt(_0x1a68a0(0x188))/0x6+-parseInt(_0x1a68a0(0x154))/0x7*(parseInt(_0x1a68a0(0x182))/0x8)+parseInt(_0x1a68a0(0x121))/0x9*(parseInt(_0x1a68a0(0x13e))/0xa)+parseInt(_0x1a68a0(0x185))/0xb;if(_0x10bd7b===_0x3087f3)break;else _0x1157c7['push'](_0x1157c7['shift']());}catch(_0x49a532){_0x1157c7['push'](_0x1157c7['shift']());}}}(_0x1bf0,0x96fee));function _0x1bf0(){const _0x391902=['UserBalanceService','payMpay','onModuleInit','payWeChatPrivateKey','hupi','jsapi','join','axios','queryEpay','order_no','appid','payWeChatPublicKey','1800uWecQI','payWeChatSecret','decorate','trade_order_id','queryMpay','wxpay','param','design:paramtypes','InjectRepository','Wap','post','notifyMpay','Injectable','../globalConfig/globalConfig.service','data','payEpayApiQueryUrl','payEpaySecret','notify_url','key','function','errRaw','event_type','5242181kstnLr','MD5','@nestjs/typeorm','1.1','47883CTWRKy','globalConfigService','default','notifyEpay','套餐不存在!','payWeChatH5Url','trade_status','length','../userBalance/userBalance.service','attach','__metadata','微信支付通知params:\x20','304AUpCaF','findOne','status','payMpayApiQueryUrl','total_fee','return_url','money','get','校验签名','订单不存在!','keys','hex','payWeChatAppId','校验签名通过','mpay','transactions_h5','sort','resource','metadata','toFixed','digest','crypto','payWeChatH5Name','../crami/cramiPackage.entity','createRandomNonceStr','微信H5支付失败！','UserService','transactions_jsapi','payHupiAppId','total','8OXEbUo','__decorate','epay\x20--->\x20res:\x20','15111712cssokg','version','payEpayPid','646548jwlytt','__param','success','5447795SHpZJp','native','sign_type','scene_info','object','支付通知验证失败:\x20','__esModule','map','getConfigs','failed','GlobalConfigService','payWeChatNotifyUrl','payHupi','orderEntity','sign','payEpay','decipher_gcm','query','cramiPackageEntity','userBalanceService','submit.php','Repository','log','userService','jsapi支付结果返回值:\x20','payWeChatMchId','wechat','742eScpsp','alipay','payMpayNotifyUrl','payMpaySecret','queryHupi','1266HPBZLY','now','wechatpay-node-v3','toString','HttpException','payWeChat','支付请求失败:\x20','wx-native','payEpayApiPayUrl','HttpStatus','addBalanceToOrder','../order/order.entity','error:\x20','queryWeChat','affected','includes','trade_state','notifyWeChat','payHupiReturnUrl','https://api.xunhupay.com/payment/query.html','payHupiSecret','name','WxPay','PayService','act','192.168.1.100','out_trade_no','hash','getOpenIdByUserId','pid','defineProperty','11601qNEoqq','time','本次支付类型:\x20','update','TRADE_SUCCESS','device','typeorm','payPlatform','order','payMpayPid','h5_info','createHash','../user/user.service','goodsId','type','notifyHupi','BAD_REQUEST'];_0x1bf0=function(){return _0x391902;};return _0x1bf0();}var __decorate=this&&this[_0xd5b88b(0x183)]||function(_0x426156,_0x4af823,_0xbf8306,_0x35a917){const _0x491005=_0xd5b88b;var _0x3a7ae1=arguments['length'],_0x2f4ffa=_0x3a7ae1<0x3?_0x4af823:_0x35a917===null?_0x35a917=Object['getOwnPropertyDescriptor'](_0x4af823,_0xbf8306):_0x35a917,_0x1f212d;if(typeof Reflect===_0x491005(0x18f)&&typeof Reflect[_0x491005(0x140)]===_0x491005(0x151))_0x2f4ffa=Reflect['decorate'](_0x426156,_0x4af823,_0xbf8306,_0x35a917);else{for(var _0x5e1428=_0x426156[_0x491005(0x15f)]-0x1;_0x5e1428>=0x0;_0x5e1428--)if(_0x1f212d=_0x426156[_0x5e1428])_0x2f4ffa=(_0x3a7ae1<0x3?_0x1f212d(_0x2f4ffa):_0x3a7ae1>0x3?_0x1f212d(_0x4af823,_0xbf8306,_0x2f4ffa):_0x1f212d(_0x4af823,_0xbf8306))||_0x2f4ffa;}return _0x3a7ae1>0x3&&_0x2f4ffa&&Object[_0x491005(0x120)](_0x4af823,_0xbf8306,_0x2f4ffa),_0x2f4ffa;},__metadata=this&&this[_0xd5b88b(0x162)]||function(_0xab1791,_0x2106fb){const _0x2e4bcb=_0xd5b88b;if(typeof Reflect===_0x2e4bcb(0x18f)&&typeof Reflect[_0x2e4bcb(0x176)]===_0x2e4bcb(0x151))return Reflect[_0x2e4bcb(0x176)](_0xab1791,_0x2106fb);},__param=this&&this[_0xd5b88b(0x189)]||function(_0x535561,_0x5321cb){return function(_0x2a4ebd,_0x34aed4){_0x5321cb(_0x2a4ebd,_0x34aed4,_0x535561);};};function _0x2992(_0x268185,_0x3445ef){const _0x1bf046=_0x1bf0();return _0x2992=function(_0x2992b8,_0x36ba81){_0x2992b8=_0x2992b8-0x120;let _0x5b24a0=_0x1bf046[_0x2992b8];return _0x5b24a0;},_0x2992(_0x268185,_0x3445ef);}Object[_0xd5b88b(0x120)](exports,_0xd5b88b(0x191),{'value':!![]}),exports[_0xd5b88b(0x1c2)]=void 0x0;const typeorm_1=require(_0xd5b88b(0x156)),typeorm_2=require(_0xd5b88b(0x127)),common_1=require('@nestjs/common'),crypto=require(_0xd5b88b(0x179)),axios_1=require(_0xd5b88b(0x139)),order_entity_1=require(_0xd5b88b(0x1b6)),cramiPackage_entity_1=require(_0xd5b88b(0x17b)),userBalance_service_1=require(_0xd5b88b(0x160)),globalConfig_service_1=require(_0xd5b88b(0x14b)),utils_1=require('../../common/utils'),user_service_1=require(_0xd5b88b(0x12d));let PayService=class PayService{constructor(_0x5dcd2d,_0x5bb0e5,_0x42e5e4,_0x2a2bcb,_0x5117d6){const _0x1fca21=_0xd5b88b;this[_0x1fca21(0x19d)]=_0x5dcd2d,this[_0x1fca21(0x198)]=_0x5bb0e5,this['userBalanceService']=_0x42e5e4,this['globalConfigService']=_0x2a2bcb,this[_0x1fca21(0x1a2)]=_0x5117d6;}async[_0xd5b88b(0x134)](){const _0x308abb=_0xd5b88b,_0x476b47=await(0x0,utils_1['importDynamic'])(_0x308abb(0x1ad));this[_0x308abb(0x1c1)]=(_0x476b47===null||_0x476b47===void 0x0?void 0x0:_0x476b47[_0x308abb(0x15a)])?_0x476b47[_0x308abb(0x15a)]:_0x476b47;}async['notify'](_0x47eb37){const _0x4eb450=_0xd5b88b;if(_0x47eb37[_0x4eb450(0x144)]=='epay')return this['notifyEpay'](_0x47eb37);if(_0x47eb37[_0x4eb450(0x161)]==_0x4eb450(0x136))return this['notifyHupi'](_0x47eb37);if(typeof _0x47eb37['resource']=='object')return this[_0x4eb450(0x1bc)](_0x47eb37);return this[_0x4eb450(0x149)](_0x47eb37);}async['pay'](_0x5ba1d4,_0x5186b1,_0x54ce2f=_0xd5b88b(0x143)){const _0x3b85f1=_0xd5b88b,_0x53208e=await this['orderEntity']['findOne']({'where':{'userId':_0x5ba1d4,'orderId':_0x5186b1}});if(!_0x53208e)throw new common_1['HttpException'](_0x3b85f1(0x16d),common_1[_0x3b85f1(0x1b4)]['BAD_REQUEST']);const _0x3b2509=await this['cramiPackageEntity'][_0x3b85f1(0x165)]({'where':{'id':_0x53208e[_0x3b85f1(0x12e)]}});if(!_0x3b2509)throw new common_1['HttpException'](_0x3b85f1(0x15c),common_1[_0x3b85f1(0x1b4)][_0x3b85f1(0x131)]);console['log'](_0x3b85f1(0x123),_0x53208e[_0x3b85f1(0x128)]);try{if(_0x53208e[_0x3b85f1(0x128)]==_0x3b85f1(0x1a5))return this[_0x3b85f1(0x1b0)](_0x5ba1d4,_0x5186b1,_0x54ce2f);if(_0x53208e[_0x3b85f1(0x128)]=='epay')return this['payEpay'](_0x5ba1d4,_0x5186b1,_0x54ce2f);if(_0x53208e[_0x3b85f1(0x128)]==_0x3b85f1(0x172))return this[_0x3b85f1(0x133)](_0x5ba1d4,_0x5186b1,_0x54ce2f);if(_0x53208e['payPlatform']==_0x3b85f1(0x136))return this[_0x3b85f1(0x197)](_0x5ba1d4,_0x5186b1,_0x54ce2f);}catch(_0x2376db){console[_0x3b85f1(0x1a1)](_0x3b85f1(0x1b1),_0x2376db);throw new common_1[(_0x3b85f1(0x1af))]('支付请求失败!',common_1[_0x3b85f1(0x1b4)][_0x3b85f1(0x131)]);}}async[_0xd5b88b(0x19c)](_0x579636){const _0x1f4ec1=_0xd5b88b,_0x239189=await this['orderEntity'][_0x1f4ec1(0x165)]({'where':{'orderId':_0x579636}});if(!_0x239189)throw new common_1[(_0x1f4ec1(0x1af))]('订单不存在!',common_1[_0x1f4ec1(0x1b4)][_0x1f4ec1(0x131)]);return _0x239189;}async[_0xd5b88b(0x130)](_0x504543){const _0x5a59fb=_0xd5b88b,_0x476fff=await this['globalConfigService'][_0x5a59fb(0x193)]([_0x5a59fb(0x1bf)]),_0x202073=_0x504543[_0x5a59fb(0x1c6)];delete _0x504543[_0x5a59fb(0x1c6)];if(this[_0x5a59fb(0x199)](_0x504543,_0x476fff)!=_0x202073)return _0x5a59fb(0x194);const _0x56523c=await this['orderEntity'][_0x5a59fb(0x165)]({'where':{'orderId':_0x504543[_0x5a59fb(0x141)],'status':0x0}});if(!_0x56523c)return _0x5a59fb(0x194);await this[_0x5a59fb(0x19e)][_0x5a59fb(0x1b5)](_0x56523c);const _0x16707c=await this['orderEntity'][_0x5a59fb(0x124)]({'orderId':_0x504543[_0x5a59fb(0x141)]},{'status':0x1,'paydAt':new Date()});if(_0x16707c[_0x5a59fb(0x1b9)]!=0x1)return _0x5a59fb(0x194);return _0x5a59fb(0x18a);}async['payHupi'](_0x41f976,_0xfe5f48,_0x28405b=_0xd5b88b(0x143)){const _0x2e2554=_0xd5b88b,_0x2a3e75=await this[_0x2e2554(0x198)][_0x2e2554(0x165)]({'where':{'userId':_0x41f976,'orderId':_0xfe5f48}});if(!_0x2a3e75)throw new common_1[(_0x2e2554(0x1af))](_0x2e2554(0x16d),common_1[_0x2e2554(0x1b4)]['BAD_REQUEST']);const _0x5370ec=await this[_0x2e2554(0x19d)][_0x2e2554(0x165)]({'where':{'id':_0x2a3e75[_0x2e2554(0x12e)]}});if(!_0x5370ec)throw new common_1[(_0x2e2554(0x1af))](_0x2e2554(0x15c),common_1[_0x2e2554(0x1b4)]['BAD_REQUEST']);const {payHupiAppId:_0x199885,payHupiSecret:_0x356ec2,payHupiNotifyUrl:_0x132ccd,payHupiReturnUrl:_0x3ef54b,payHupiGatewayUrl:_0x16dd6c}=await this['globalConfigService'][_0x2e2554(0x193)]([_0x2e2554(0x180),_0x2e2554(0x1bf),'payHupiNotifyUrl',_0x2e2554(0x1bd),'payHupiGatewayUrl']),_0x12dae1={};_0x12dae1[_0x2e2554(0x186)]=_0x2e2554(0x157),_0x12dae1['appid']=_0x199885,_0x12dae1[_0x2e2554(0x122)]=(Date['now']()/0x3e8)[_0x2e2554(0x177)](0x0),_0x12dae1['nonce_str']=(0x0,utils_1[_0x2e2554(0x17c)])(0x20),_0x12dae1[_0x2e2554(0x141)]=_0xfe5f48,_0x12dae1['title']=_0x5370ec['name'],_0x12dae1[_0x2e2554(0x168)]=_0x2a3e75[_0x2e2554(0x181)],_0x12dae1['notify_url']=_0x132ccd,_0x12dae1['return_url']=_0x3ef54b,_0x12dae1[_0x2e2554(0x161)]=_0x2e2554(0x136),_0x12dae1[_0x2e2554(0x1c6)]=this[_0x2e2554(0x199)](_0x12dae1,_0x356ec2);const {data:{errcode:_0x397580,errmsg:_0x3db56c,url_qrcode:_0x48bd93,url:_0xa05b1b}}=await axios_1[_0x2e2554(0x15a)][_0x2e2554(0x148)](_0x16dd6c||'https://api.xunhupay.com/payment/do.html',_0x12dae1);if(_0x397580!=0x0)throw new common_1['HttpException'](_0x3db56c,common_1['HttpStatus']['BAD_REQUEST']);return{'url_qrcode':_0x48bd93,'url':_0xa05b1b};}async[_0xd5b88b(0x1aa)](_0x276f57){const _0x17e3d1=_0xd5b88b,{payHupiAppId:_0x4be381,payHupiSecret:_0x21fd20}=await this['globalConfigService'][_0x17e3d1(0x193)]([_0x17e3d1(0x180),'payHupiSecret']),_0x2248d9={};_0x2248d9[_0x17e3d1(0x186)]=_0x17e3d1(0x157),_0x2248d9[_0x17e3d1(0x13c)]=_0x4be381,_0x2248d9['time']=(Date[_0x17e3d1(0x1ac)]()/0x3e8)['toFixed'](0x0),_0x2248d9['nonce_str']=(0x0,utils_1[_0x17e3d1(0x17c)])(0x20),_0x2248d9['out_trade_order']=_0x276f57,_0x2248d9[_0x17e3d1(0x1c6)]=this[_0x17e3d1(0x199)](_0x2248d9,_0x21fd20);const {data:{errcode:_0x4c6af4,errmsg:_0x3fd0b8,data:_0x48d46a}}=await axios_1['default']['post'](_0x17e3d1(0x1be),_0x2248d9);if(_0x4c6af4!=0x0)throw new common_1[(_0x17e3d1(0x1af))](_0x3fd0b8,common_1[_0x17e3d1(0x1b4)][_0x17e3d1(0x131)]);return _0x48d46a;}async[_0xd5b88b(0x15b)](_0x2868eb){const _0x3868ed=_0xd5b88b,_0x363592=_0x2868eb[_0x3868ed(0x199)];delete _0x2868eb[_0x3868ed(0x199)],delete _0x2868eb[_0x3868ed(0x18d)];const _0x8fc30e=await this[_0x3868ed(0x159)][_0x3868ed(0x193)]([_0x3868ed(0x14e)]);if(this[_0x3868ed(0x199)](_0x2868eb,_0x8fc30e)!=_0x363592)return'failed';console[_0x3868ed(0x1a1)](_0x3868ed(0x171));const _0x172e24=await this[_0x3868ed(0x198)]['findOne']({'where':{'orderId':_0x2868eb[_0x3868ed(0x1c5)],'status':0x0}});if(!_0x172e24)return'failed';const _0x1f5213=_0x2868eb[_0x3868ed(0x15e)]==_0x3868ed(0x125)?0x1:0x2,_0x853961=await this[_0x3868ed(0x198)][_0x3868ed(0x124)]({'orderId':_0x2868eb[_0x3868ed(0x1c5)]},{'status':_0x1f5213,'paydAt':new Date()});_0x1f5213===0x1&&await this[_0x3868ed(0x19e)][_0x3868ed(0x1b5)](_0x172e24);if(_0x853961[_0x3868ed(0x1b9)]!=0x1)return _0x3868ed(0x194);return _0x3868ed(0x18a);}async[_0xd5b88b(0x19a)](_0x2a7a81,_0x7bd9cb,_0x19c56c=_0xd5b88b(0x1a7)){const _0xeb5ce8=_0xd5b88b,_0x40b665=await this['orderEntity'][_0xeb5ce8(0x165)]({'where':{'userId':_0x2a7a81,'orderId':_0x7bd9cb}});if(!_0x40b665)throw new common_1['HttpException'](_0xeb5ce8(0x16d),common_1[_0xeb5ce8(0x1b4)][_0xeb5ce8(0x131)]);const _0x965a3a=await this[_0xeb5ce8(0x19d)][_0xeb5ce8(0x165)]({'where':{'id':_0x40b665[_0xeb5ce8(0x12e)]}});if(!_0x965a3a)throw new common_1[(_0xeb5ce8(0x1af))]('套餐不存在!',common_1[_0xeb5ce8(0x1b4)]['BAD_REQUEST']);const {payEpayPid:_0x472d7f,payEpaySecret:_0x498c17,payEpayNotifyUrl:_0x18ecb4,payEpayReturnUrl:_0x2fb0aa,payEpayApiPayUrl:_0x3187da}=await this[_0xeb5ce8(0x159)][_0xeb5ce8(0x193)](['payEpayPid',_0xeb5ce8(0x14e),'payEpayNotifyUrl','payEpayReturnUrl',_0xeb5ce8(0x1b3)]);let _0x19094a;_0x472d7f[_0xeb5ce8(0x15f)]<=0x10?_0x19094a=Number(_0x472d7f):_0x19094a=BigInt(_0x472d7f);const _0x39c128={};_0x39c128[_0xeb5ce8(0x1c8)]=_0x19094a,_0x39c128['type']=_0x19c56c,_0x39c128[_0xeb5ce8(0x1c5)]=_0x7bd9cb,_0x39c128['name']=_0x965a3a[_0xeb5ce8(0x1c0)],_0x39c128[_0xeb5ce8(0x16a)]=_0x40b665[_0xeb5ce8(0x181)],_0x39c128['clientip']=_0xeb5ce8(0x1c4),_0x39c128[_0xeb5ce8(0x126)]='pc',_0x39c128[_0xeb5ce8(0x14f)]=_0x18ecb4,_0x39c128[_0xeb5ce8(0x169)]=_0x2fb0aa,_0x39c128[_0xeb5ce8(0x144)]='epay',_0x39c128[_0xeb5ce8(0x199)]=this[_0xeb5ce8(0x199)](_0x39c128,_0x498c17),_0x39c128[_0xeb5ce8(0x18d)]=_0xeb5ce8(0x155);const _0x533bfa=new URLSearchParams(_0x39c128)[_0xeb5ce8(0x1ae)](),_0x4336b1=_0x3187da+'?'+_0x533bfa;if(_0x3187da[_0xeb5ce8(0x1ba)](_0xeb5ce8(0x19f)))return{'url_qrcode':null,'redirectUrl':_0x4336b1,'channel':_0x19c56c,'isRedirect':!![]};else{const _0x5e6824=await axios_1['default'][_0xeb5ce8(0x16b)](_0x3187da,{'params':_0x39c128});console[_0xeb5ce8(0x1a1)](_0xeb5ce8(0x184),_0x5e6824[_0xeb5ce8(0x14c)]);const {data:{code:_0x27ccec,msg:_0x8e7548,qrcode:_0x7085d1}}=_0x5e6824;if(_0x27ccec!=0x1)throw new common_1[(_0xeb5ce8(0x1af))](_0x8e7548,common_1['HttpStatus'][_0xeb5ce8(0x131)]);return{'url_qrcode':_0x7085d1,'redirectUrl':null,'channel':_0x19c56c,'isRedirect':![]};}}async[_0xd5b88b(0x13a)](_0x1fdb83){const _0x2fc1f4=_0xd5b88b,{payEpayPid:_0x515bf1,payEpaySecret:_0x453d01,payEpayApiQueryUrl:_0x5c5860}=await this['globalConfigService']['getConfigs']([_0x2fc1f4(0x187),_0x2fc1f4(0x14e),_0x2fc1f4(0x14d)]),_0x2b7b64={};_0x2b7b64[_0x2fc1f4(0x1c3)]=_0x2fc1f4(0x129),_0x2b7b64[_0x2fc1f4(0x1c5)]=_0x1fdb83,_0x2b7b64[_0x2fc1f4(0x1c8)]=_0x515bf1,_0x2b7b64[_0x2fc1f4(0x150)]=_0x453d01;const {data:{code:_0x1eee34,msg:_0x20a01d,data:_0x228718}}=await axios_1[_0x2fc1f4(0x15a)][_0x2fc1f4(0x16b)](_0x5c5860,{'params':_0x2b7b64});if(_0x1eee34!=0x1)throw new common_1[(_0x2fc1f4(0x1af))](_0x20a01d,common_1[_0x2fc1f4(0x1b4)][_0x2fc1f4(0x131)]);return _0x228718;}async[_0xd5b88b(0x149)](_0x1e2bd5){const _0x46562f=_0xd5b88b,_0x5ed59d=_0x1e2bd5[_0x46562f(0x199)];delete _0x1e2bd5[_0x46562f(0x199)],delete _0x1e2bd5['sign_type'];const _0x4ac37b=await this[_0x46562f(0x159)]['getConfigs']([_0x46562f(0x1a9)]);console[_0x46562f(0x1a1)](_0x46562f(0x16c));if(this['sign'](_0x1e2bd5,_0x4ac37b)!=_0x5ed59d)return _0x46562f(0x194);console[_0x46562f(0x1a1)]('校验签名通过');const _0x51c9b3=await this[_0x46562f(0x198)][_0x46562f(0x165)]({'where':{'orderId':_0x1e2bd5[_0x46562f(0x1c5)],'status':0x0}});if(!_0x51c9b3)return _0x46562f(0x194);const _0x513508=_0x1e2bd5['trade_status']=='TRADE_SUCCESS'?0x1:0x2;console['log']('status:\x20',_0x513508);const _0xf57267=await this['orderEntity'][_0x46562f(0x124)]({'orderId':_0x1e2bd5[_0x46562f(0x1c5)]},{'status':_0x513508,'paydAt':new Date()});_0x513508===0x1&&await this[_0x46562f(0x19e)][_0x46562f(0x1b5)](_0x51c9b3);if(_0xf57267[_0x46562f(0x1b9)]!=0x1)return _0x46562f(0x194);return _0x46562f(0x18a);}async['payMpay'](_0x2ff68c,_0xef027a,_0x5dca4b=_0xd5b88b(0x143)){const _0x1d9ce7=_0xd5b88b,_0x3b8348=await this[_0x1d9ce7(0x198)][_0x1d9ce7(0x165)]({'where':{'userId':_0x2ff68c,'orderId':_0xef027a}});if(!_0x3b8348)throw new common_1[(_0x1d9ce7(0x1af))](_0x1d9ce7(0x16d),common_1[_0x1d9ce7(0x1b4)][_0x1d9ce7(0x131)]);const _0x316c15=await this[_0x1d9ce7(0x19d)][_0x1d9ce7(0x165)]({'where':{'id':_0x3b8348[_0x1d9ce7(0x12e)]}});if(!_0x316c15)throw new common_1[(_0x1d9ce7(0x1af))]('套餐不存在!',common_1['HttpStatus'][_0x1d9ce7(0x131)]);const {payMpayPid:_0x1bf64e,payMpaySecret:_0x398d9b,payMpayNotifyUrl:_0x4b70ac,payMpayReturnUrl:_0x11f41e,payMpayApiPayUrl:_0x540afb}=await this['globalConfigService'][_0x1d9ce7(0x193)]([_0x1d9ce7(0x12a),'payMpaySecret',_0x1d9ce7(0x1a8),'payMpayReturnUrl','payMpayApiPayUrl']),_0x19f644={};_0x19f644[_0x1d9ce7(0x1c8)]=Number(_0x1bf64e),_0x19f644[_0x1d9ce7(0x12f)]=_0x5dca4b,_0x19f644[_0x1d9ce7(0x1c5)]=_0xef027a,_0x19f644[_0x1d9ce7(0x1c0)]=_0x316c15[_0x1d9ce7(0x1c0)],_0x19f644['money']=_0x3b8348[_0x1d9ce7(0x181)],_0x19f644[_0x1d9ce7(0x14f)]=_0x4b70ac,_0x19f644[_0x1d9ce7(0x169)]=_0x11f41e,_0x19f644[_0x1d9ce7(0x199)]=this['sign'](_0x19f644,_0x398d9b),_0x19f644[_0x1d9ce7(0x18d)]='MD5';const _0x96bd0c=new URLSearchParams(_0x19f644)[_0x1d9ce7(0x1ae)](),_0x307b38=_0x540afb+'?'+_0x96bd0c;return{'url_qrcode':null,'redirectUrl':_0x307b38,'channel':_0x5dca4b,'isRedirect':!![]};const _0x977d32=await axios_1[_0x1d9ce7(0x15a)][_0x1d9ce7(0x16b)](_0x540afb,{'params':_0x19f644});}async[_0xd5b88b(0x142)](_0x4e2721){const _0x2a1bc3=_0xd5b88b,{payMpayApiQueryUrl:_0x101856}=await this['globalConfigService'][_0x2a1bc3(0x193)]([_0x2a1bc3(0x12a),_0x2a1bc3(0x1a9),_0x2a1bc3(0x167)]),_0x48b581={};_0x48b581[_0x2a1bc3(0x12f)]=0x2,_0x48b581[_0x2a1bc3(0x13b)]=_0x4e2721;const {data:{code:_0x4abf28,msg:_0x3c2e9a,data:_0x20a9cf}}=await axios_1[_0x2a1bc3(0x15a)][_0x2a1bc3(0x16b)](_0x101856,{'params':_0x48b581});if(_0x4abf28!=0x1)throw new common_1[(_0x2a1bc3(0x1af))](_0x3c2e9a,common_1[_0x2a1bc3(0x1b4)][_0x2a1bc3(0x131)]);return _0x20a9cf;}async[_0xd5b88b(0x1bc)](_0x210f19){const _0x259e26=_0xd5b88b;console[_0x259e26(0x1a1)](_0x259e26(0x163),_0x210f19);const {payWeChatAppId:_0x30734d,payWeChatMchId:_0x22eb88,payWeChatSecret:_0x6cf6a5,payWeChatPublicKey:_0x5937ec,payWeChatPrivateKey:_0x30687b}=await this['globalConfigService'][_0x259e26(0x193)]([_0x259e26(0x170),_0x259e26(0x1a4),_0x259e26(0x13f),_0x259e26(0x13d),_0x259e26(0x135)]),_0x314393=new this['WxPay']({'appid':_0x30734d,'mchid':_0x22eb88,'publicKey':_0x5937ec,'privateKey':_0x30687b});try{if(_0x210f19[_0x259e26(0x153)]=='TRANSACTION.SUCCESS'){const {ciphertext:_0x5ebca4,associated_data:_0xc1f3c4,nonce:_0x32c2ab}=_0x210f19[_0x259e26(0x175)],_0x2a478f=_0x314393[_0x259e26(0x19b)](_0x5ebca4,_0xc1f3c4,_0x32c2ab,_0x6cf6a5),_0x2f11b1=await this[_0x259e26(0x198)][_0x259e26(0x165)]({'where':{'orderId':_0x2a478f['out_trade_no'],'status':0x0}});if(!_0x2f11b1)return _0x259e26(0x194);const _0x2e6b36=_0x2a478f[_0x259e26(0x1bb)]=='SUCCESS'?0x1:0x2,_0x218567=await this[_0x259e26(0x198)][_0x259e26(0x124)]({'orderId':_0x2a478f[_0x259e26(0x1c5)]},{'status':_0x2e6b36,'paydAt':new Date()});_0x2e6b36===0x1&&await this[_0x259e26(0x19e)]['addBalanceToOrder'](_0x2f11b1);if(_0x218567[_0x259e26(0x1b9)]!=0x1)return _0x259e26(0x194);}return'success';}catch(_0x52ca4d){return console[_0x259e26(0x1a1)](_0x259e26(0x1b7),_0x52ca4d),console['log'](_0x259e26(0x190),_0x52ca4d),'failed';}}async['payWeChat'](_0x195a9f,_0x4faab8,_0x32e4dc=_0xd5b88b(0x18c)){const _0x1635f1=_0xd5b88b;var _0x41da2a,_0x18b264,_0x583af0;console[_0x1635f1(0x1a1)]('payType:\x20',_0x32e4dc);const _0x171ca6=await this[_0x1635f1(0x198)][_0x1635f1(0x165)]({'where':{'userId':_0x195a9f,'orderId':_0x4faab8}});if(!_0x171ca6)throw new common_1[(_0x1635f1(0x1af))](_0x1635f1(0x16d),common_1[_0x1635f1(0x1b4)][_0x1635f1(0x131)]);const _0x12bb6d=await this[_0x1635f1(0x19d)]['findOne']({'where':{'id':_0x171ca6[_0x1635f1(0x12e)]}});if(!_0x12bb6d)throw new common_1[(_0x1635f1(0x1af))]('套餐不存在!',common_1['HttpStatus']['BAD_REQUEST']);const {payWeChatAppId:_0x1f7159,payWeChatMchId:_0x390d04,payWeChatPublicKey:_0xed8d3a,payWeChatPrivateKey:_0x2be2a3,payWeChatNotifyUrl:_0x5bfc03,payWeChatH5Name:_0x4e0df3,payWeChatH5Url:_0x17da40}=await this[_0x1635f1(0x159)][_0x1635f1(0x193)]([_0x1635f1(0x170),_0x1635f1(0x1a4),_0x1635f1(0x13d),_0x1635f1(0x135),_0x1635f1(0x196),_0x1635f1(0x17a),_0x1635f1(0x15d)]),_0x5ef927=new this[(_0x1635f1(0x1c1))]({'appid':_0x1f7159,'mchid':_0x390d04,'publicKey':_0xed8d3a,'privateKey':_0x2be2a3}),_0x3bcc99={'appid':_0x1f7159,'mchid':_0x390d04,'description':_0x12bb6d['name'],'out_trade_no':_0x4faab8,'notify_url':_0x5bfc03,'amount':{'total':Number(_0x171ca6[_0x1635f1(0x181)]*0x64)},'scene_info':{'payer_client_ip':_0x1635f1(0x1c4)}};console[_0x1635f1(0x1a1)]('wechat-pay:\x20',_0x3bcc99);if(_0x32e4dc=='h5'){_0x3bcc99[_0x1635f1(0x18e)][_0x1635f1(0x12b)]={'type':_0x1635f1(0x147),'app_name':_0x4e0df3,'app_url':_0x17da40};const _0x54b3f9=await _0x5ef927[_0x1635f1(0x173)](_0x3bcc99);if(_0x54b3f9[_0x1635f1(0x166)]===0x193){const _0x187aa0=(_0x583af0=(_0x18b264=(_0x41da2a=_0x54b3f9===null||_0x54b3f9===void 0x0?void 0x0:_0x54b3f9[_0x1635f1(0x152)])===null||_0x41da2a===void 0x0?void 0x0:_0x41da2a['response'])===null||_0x18b264===void 0x0?void 0x0:_0x18b264['text'])===null||_0x583af0===void 0x0?void 0x0:_0x583af0['message'];throw new common_1[(_0x1635f1(0x1af))]((_0x54b3f9===null||_0x54b3f9===void 0x0?void 0x0:_0x54b3f9['message'])||_0x1635f1(0x17d),common_1[_0x1635f1(0x1b4)][_0x1635f1(0x131)]);}const {h5_url:_0x25905c}=_0x54b3f9;return{'url':_0x25905c};}if(_0x32e4dc==_0x1635f1(0x137)){const _0x26a9d4=await this[_0x1635f1(0x1a2)][_0x1635f1(0x1c7)](_0x195a9f);console['log']('用户openId:\x20',_0x26a9d4),_0x3bcc99['payer']={'openid':_0x26a9d4};const _0x3c8adf=await _0x5ef927[_0x1635f1(0x17f)](_0x3bcc99);return console[_0x1635f1(0x1a1)](_0x1635f1(0x1a3),_0x3c8adf),_0x3c8adf;}if(_0x32e4dc=='native'){const _0x3d8e26=await _0x5ef927['transactions_native'](_0x3bcc99),{code_url:_0x4e08ea}=_0x3d8e26;return!_0x4e08ea&&console[_0x1635f1(0x1a1)](_0x1635f1(0x1b2),_0x3d8e26),{'url_qrcode':_0x4e08ea,'isRedirect':![]};}throw new common_1[(_0x1635f1(0x1af))]('unsupported\x20pay\x20type',common_1[_0x1635f1(0x1b4)][_0x1635f1(0x131)]);}async[_0xd5b88b(0x1b8)](_0x324cdc){const _0x2c5dfb=_0xd5b88b,{payWeChatAppId:_0x46a8f1,payWeChatMchId:_0x570193,payWeChatPublicKey:_0x594dfe,payWeChatPrivateKey:_0x127819,payWeChatNotifyUrl:_0x5653ca,payWeChatH5Name:_0x9f84d4,payWeChatH5Url:_0x5e9f1e}=await this[_0x2c5dfb(0x159)]['getConfigs'](['payWeChatAppId',_0x2c5dfb(0x1a4),_0x2c5dfb(0x13d),_0x2c5dfb(0x135)]),_0x2738fd=new this[(_0x2c5dfb(0x1c1))]({'appid':_0x46a8f1,'mchid':_0x570193,'publicKey':_0x594dfe,'privateKey':_0x127819}),_0x57be21=await _0x2738fd['query']({'out_trade_no':_0x324cdc});return _0x57be21;}[_0xd5b88b(0x199)](_0x43268e,_0x3c836f){const _0x1478a1=_0xd5b88b,_0x34b114=Object[_0x1478a1(0x16e)](_0x43268e)[_0x1478a1(0x174)]()[_0x1478a1(0x192)](_0x462d14=>_0x462d14+'='+_0x43268e[_0x462d14])[_0x1478a1(0x138)]('&')+_0x3c836f;return crypto[_0x1478a1(0x12c)]('md5')['update'](_0x34b114)[_0x1478a1(0x178)](_0x1478a1(0x16f));}};PayService=__decorate([(0x0,common_1[_0xd5b88b(0x14a)])(),__param(0x0,(0x0,typeorm_1[_0xd5b88b(0x146)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1['OrderEntity'])),__metadata(_0xd5b88b(0x145),[typeorm_2[_0xd5b88b(0x1a0)],typeorm_2[_0xd5b88b(0x1a0)],userBalance_service_1[_0xd5b88b(0x132)],globalConfig_service_1[_0xd5b88b(0x195)],user_service_1[_0xd5b88b(0x17e)]])],PayService),exports['PayService']=PayService;