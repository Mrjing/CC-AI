'use strict';const _0x53ab85=_0x8c9d;(function(_0x6d95a,_0x3de4a2){const _0x5e433a=_0x8c9d,_0x1d1522=_0x6d95a();while(!![]){try{const _0x590304=-parseInt(_0x5e433a(0x119))/0x1+-parseInt(_0x5e433a(0xf6))/0x2*(-parseInt(_0x5e433a(0x11b))/0x3)+parseInt(_0x5e433a(0x103))/0x4*(parseInt(_0x5e433a(0x9a))/0x5)+-parseInt(_0x5e433a(0x9f))/0x6*(-parseInt(_0x5e433a(0xa3))/0x7)+parseInt(_0x5e433a(0x88))/0x8*(-parseInt(_0x5e433a(0x96))/0x9)+-parseInt(_0x5e433a(0xb9))/0xa+-parseInt(_0x5e433a(0xca))/0xb*(-parseInt(_0x5e433a(0x91))/0xc);if(_0x590304===_0x3de4a2)break;else _0x1d1522['push'](_0x1d1522['shift']());}catch(_0x2f5bcb){_0x1d1522['push'](_0x1d1522['shift']());}}}(_0x20ca,0x8b210));var __decorate=this&&this['__decorate']||function(_0x99004d,_0x1a0533,_0x539bd1,_0x5e05b4){const _0x12f6b3=_0x8c9d;var _0x5975d3=arguments[_0x12f6b3(0x10c)],_0x441d7c=_0x5975d3<0x3?_0x1a0533:_0x5e05b4===null?_0x5e05b4=Object[_0x12f6b3(0xa6)](_0x1a0533,_0x539bd1):_0x5e05b4,_0x5e9445;if(typeof Reflect==='object'&&typeof Reflect[_0x12f6b3(0xce)]===_0x12f6b3(0xb7))_0x441d7c=Reflect[_0x12f6b3(0xce)](_0x99004d,_0x1a0533,_0x539bd1,_0x5e05b4);else{for(var _0x1958e9=_0x99004d[_0x12f6b3(0x10c)]-0x1;_0x1958e9>=0x0;_0x1958e9--)if(_0x5e9445=_0x99004d[_0x1958e9])_0x441d7c=(_0x5975d3<0x3?_0x5e9445(_0x441d7c):_0x5975d3>0x3?_0x5e9445(_0x1a0533,_0x539bd1,_0x441d7c):_0x5e9445(_0x1a0533,_0x539bd1))||_0x441d7c;}return _0x5975d3>0x3&&_0x441d7c&&Object[_0x12f6b3(0x10a)](_0x1a0533,_0x539bd1,_0x441d7c),_0x441d7c;},__metadata=this&&this[_0x53ab85(0xea)]||function(_0x2ce070,_0x517878){const _0x4ba972=_0x53ab85;if(typeof Reflect===_0x4ba972(0xad)&&typeof Reflect[_0x4ba972(0xd3)]===_0x4ba972(0xb7))return Reflect[_0x4ba972(0xd3)](_0x2ce070,_0x517878);},__param=this&&this[_0x53ab85(0x12d)]||function(_0x5f2349,_0x122702){return function(_0x2cc943,_0x1321d3){_0x122702(_0x2cc943,_0x1321d3,_0x5f2349);};};function _0x8c9d(_0x556e8a,_0x13a351){const _0x20ca91=_0x20ca();return _0x8c9d=function(_0x8c9db4,_0x3f3b7a){_0x8c9db4=_0x8c9db4-0x84;let _0x18eee8=_0x20ca91[_0x8c9db4];return _0x18eee8;},_0x8c9d(_0x556e8a,_0x13a351);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x53ab85(0xc0)]=void 0x0;const typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),common_1=require(_0x53ab85(0xc4)),crypto=require(_0x53ab85(0x90)),axios_1=require(_0x53ab85(0x8b)),order_entity_1=require(_0x53ab85(0x12f)),cramiPackage_entity_1=require(_0x53ab85(0xfa)),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require(_0x53ab85(0x10e)),utils_1=require(_0x53ab85(0xf2)),user_service_1=require(_0x53ab85(0xae));let PayService=class PayService{constructor(_0x567f79,_0x32deff,_0x37b294,_0x52e507,_0x287d62){const _0x25a129=_0x53ab85;this[_0x25a129(0xd8)]=_0x567f79,this[_0x25a129(0xf0)]=_0x32deff,this[_0x25a129(0x11c)]=_0x37b294,this['globalConfigService']=_0x52e507,this[_0x25a129(0xe6)]=_0x287d62;}async[_0x53ab85(0x116)](){const _0x3a47a3=_0x53ab85,_0x4dda3d=await(0x0,utils_1[_0x3a47a3(0x10d)])('wechatpay-node-v3');this[_0x3a47a3(0xef)]=(_0x4dda3d===null||_0x4dda3d===void 0x0?void 0x0:_0x4dda3d[_0x3a47a3(0xc6)])?_0x4dda3d[_0x3a47a3(0xc6)]:_0x4dda3d;}async[_0x53ab85(0x120)](_0x6983a3){const _0x1d8cdc=_0x53ab85;if(_0x6983a3[_0x1d8cdc(0x87)]=='epay')return this[_0x1d8cdc(0x125)](_0x6983a3);if(_0x6983a3[_0x1d8cdc(0x115)]==_0x1d8cdc(0xd0))return this['notifyHupi'](_0x6983a3);if(typeof _0x6983a3['resource']==_0x1d8cdc(0xad))return this[_0x1d8cdc(0xda)](_0x6983a3);return this[_0x1d8cdc(0x92)](_0x6983a3);}async[_0x53ab85(0xe7)](_0x36c9a6,_0x3f27d5,_0x31465e=_0x53ab85(0xd4)){const _0x41b87d=_0x53ab85,_0x1b68a8=await this[_0x41b87d(0xf0)][_0x41b87d(0xe9)]({'where':{'userId':_0x36c9a6,'orderId':_0x3f27d5}});if(!_0x1b68a8)throw new common_1[(_0x41b87d(0x100))](_0x41b87d(0x98),common_1['HttpStatus']['BAD_REQUEST']);const _0x46f45c=await this[_0x41b87d(0xd8)]['findOne']({'where':{'id':_0x1b68a8['goodsId']}});if(!_0x46f45c)throw new common_1['HttpException'](_0x41b87d(0xf1),common_1['HttpStatus']['BAD_REQUEST']);console[_0x41b87d(0x106)](_0x41b87d(0xa5),_0x1b68a8[_0x41b87d(0xbe)]);try{if(_0x1b68a8[_0x41b87d(0xbe)]==_0x41b87d(0xc2))return this[_0x41b87d(0x134)](_0x36c9a6,_0x3f27d5,_0x31465e);if(_0x1b68a8[_0x41b87d(0xbe)]=='epay')return this['payEpay'](_0x36c9a6,_0x3f27d5,_0x31465e);if(_0x1b68a8[_0x41b87d(0xbe)]==_0x41b87d(0xee))return this[_0x41b87d(0x105)](_0x36c9a6,_0x3f27d5,_0x31465e);if(_0x1b68a8[_0x41b87d(0xbe)]=='hupi')return this[_0x41b87d(0x12e)](_0x36c9a6,_0x3f27d5,_0x31465e);}catch(_0x43ae82){console[_0x41b87d(0x106)]('支付请求失败:\x20',_0x43ae82);throw new common_1[(_0x41b87d(0x100))](_0x41b87d(0xba),common_1['HttpStatus'][_0x41b87d(0x8e)]);}}async['query'](_0x40383d){const _0x79550d=_0x53ab85,_0xc0c748=await this[_0x79550d(0xf0)][_0x79550d(0xe9)]({'where':{'orderId':_0x40383d}});if(!_0xc0c748)throw new common_1[(_0x79550d(0x100))]('订单不存在!',common_1[_0x79550d(0xfc)][_0x79550d(0x8e)]);return _0xc0c748;}async[_0x53ab85(0xb6)](_0x537f36){const _0x4f7717=_0x53ab85,_0x4e7d24=await this[_0x4f7717(0xf5)][_0x4f7717(0x11f)](['payHupiSecret']),_0x16e258=_0x537f36[_0x4f7717(0x118)];delete _0x537f36['hash'];if(this[_0x4f7717(0xa9)](_0x537f36,_0x4e7d24)!=_0x16e258)return _0x4f7717(0xcc);const _0x2ee8ee=await this[_0x4f7717(0xf0)][_0x4f7717(0xe9)]({'where':{'orderId':_0x537f36[_0x4f7717(0x108)],'status':0x0}});if(!_0x2ee8ee)return'failed';await this[_0x4f7717(0x11c)][_0x4f7717(0xcb)](_0x2ee8ee);const _0x3dcf06=await this[_0x4f7717(0xf0)][_0x4f7717(0x117)]({'orderId':_0x537f36[_0x4f7717(0x108)]},{'status':0x1,'paydAt':new Date()});if(_0x3dcf06[_0x4f7717(0xbc)]!=0x1)return _0x4f7717(0xcc);return'success';}async[_0x53ab85(0x12e)](_0x120279,_0x5ecf02,_0x4ee028=_0x53ab85(0xd4)){const _0x588ec3=_0x53ab85,_0xf30e52=await this['orderEntity'][_0x588ec3(0xe9)]({'where':{'userId':_0x120279,'orderId':_0x5ecf02}});if(!_0xf30e52)throw new common_1[(_0x588ec3(0x100))](_0x588ec3(0x98),common_1[_0x588ec3(0xfc)]['BAD_REQUEST']);const _0x4da742=await this['cramiPackageEntity']['findOne']({'where':{'id':_0xf30e52['goodsId']}});if(!_0x4da742)throw new common_1['HttpException']('套餐不存在!',common_1[_0x588ec3(0xfc)][_0x588ec3(0x8e)]);const {payHupiAppId:_0x43c52a,payHupiSecret:_0x2ebc1b,payHupiNotifyUrl:_0x10143d,payHupiReturnUrl:_0x67d30,payHupiGatewayUrl:_0x4f4ee3}=await this[_0x588ec3(0xf5)][_0x588ec3(0x11f)]([_0x588ec3(0x9c),_0x588ec3(0xa4),_0x588ec3(0x8a),_0x588ec3(0xe0),_0x588ec3(0xaf)]),_0x386d01={};_0x386d01['version']='1.1',_0x386d01[_0x588ec3(0x133)]=_0x43c52a,_0x386d01[_0x588ec3(0x107)]=(Date[_0x588ec3(0xbb)]()/0x3e8)[_0x588ec3(0xc9)](0x0),_0x386d01[_0x588ec3(0xfd)]=(0x0,utils_1[_0x588ec3(0xb8)])(0x20),_0x386d01[_0x588ec3(0x108)]=_0x5ecf02,_0x386d01[_0x588ec3(0xaa)]=_0x4da742[_0x588ec3(0x128)],_0x386d01['total_fee']=_0xf30e52[_0x588ec3(0x110)],_0x386d01[_0x588ec3(0x9b)]=_0x10143d,_0x386d01[_0x588ec3(0xbd)]=_0x67d30,_0x386d01[_0x588ec3(0x115)]=_0x588ec3(0xd0),_0x386d01[_0x588ec3(0x118)]=this[_0x588ec3(0xa9)](_0x386d01,_0x2ebc1b);const {data:{errcode:_0x5d5ce8,errmsg:_0x4e50ac,url_qrcode:_0x3af9d4,url:_0x46ef26}}=await axios_1[_0x588ec3(0xc6)]['post'](_0x4f4ee3||_0x588ec3(0x8f),_0x386d01);if(_0x5d5ce8!=0x0)throw new common_1['HttpException'](_0x4e50ac,common_1[_0x588ec3(0xfc)][_0x588ec3(0x8e)]);return{'url_qrcode':_0x3af9d4,'url':_0x46ef26};}async[_0x53ab85(0x10f)](_0x4c500a){const _0x173552=_0x53ab85,{payHupiAppId:_0x3b7528,payHupiSecret:_0x1c8d3a}=await this[_0x173552(0xf5)][_0x173552(0x11f)]([_0x173552(0x9c),_0x173552(0xa4)]),_0x4a6b64={};_0x4a6b64['version']=_0x173552(0x104),_0x4a6b64[_0x173552(0x133)]=_0x3b7528,_0x4a6b64['time']=(Date['now']()/0x3e8)[_0x173552(0xc9)](0x0),_0x4a6b64['nonce_str']=(0x0,utils_1[_0x173552(0xb8)])(0x20),_0x4a6b64[_0x173552(0xe5)]=_0x4c500a,_0x4a6b64[_0x173552(0x118)]=this[_0x173552(0xa9)](_0x4a6b64,_0x1c8d3a);const {data:{errcode:_0x52320b,errmsg:_0x2bc9de,data:_0x4a6ea3}}=await axios_1[_0x173552(0xc6)][_0x173552(0xb4)](_0x173552(0xc1),_0x4a6b64);if(_0x52320b!=0x0)throw new common_1['HttpException'](_0x2bc9de,common_1[_0x173552(0xfc)][_0x173552(0x8e)]);return _0x4a6ea3;}async[_0x53ab85(0x125)](_0x38dc04){const _0x23c7dd=_0x53ab85,_0x220681=_0x38dc04[_0x23c7dd(0xa9)];delete _0x38dc04[_0x23c7dd(0xa9)],delete _0x38dc04[_0x23c7dd(0x11a)];const _0x483329=await this[_0x23c7dd(0xf5)][_0x23c7dd(0x11f)]([_0x23c7dd(0xa1)]);if(this[_0x23c7dd(0xa9)](_0x38dc04,_0x483329)!=_0x220681)return _0x23c7dd(0xcc);console[_0x23c7dd(0x106)](_0x23c7dd(0x123));const _0x91f183=await this[_0x23c7dd(0xf0)][_0x23c7dd(0xe9)]({'where':{'orderId':_0x38dc04[_0x23c7dd(0xa2)],'status':0x0}});if(!_0x91f183)return _0x23c7dd(0xcc);const _0x3d7c70=_0x38dc04[_0x23c7dd(0xb1)]==_0x23c7dd(0xe2)?0x1:0x2,_0x197647=await this['orderEntity'][_0x23c7dd(0x117)]({'orderId':_0x38dc04[_0x23c7dd(0xa2)]},{'status':_0x3d7c70,'paydAt':new Date()});_0x3d7c70===0x1&&await this[_0x23c7dd(0x11c)][_0x23c7dd(0xcb)](_0x91f183);if(_0x197647[_0x23c7dd(0xbc)]!=0x1)return'failed';return'success';}async[_0x53ab85(0x112)](_0x37d3b7,_0x4b3e54,_0x10c823=_0x53ab85(0x126)){const _0x210313=_0x53ab85,_0x15da1f=await this['orderEntity'][_0x210313(0xe9)]({'where':{'userId':_0x37d3b7,'orderId':_0x4b3e54}});if(!_0x15da1f)throw new common_1[(_0x210313(0x100))](_0x210313(0x98),common_1[_0x210313(0xfc)][_0x210313(0x8e)]);const _0x6294b8=await this['cramiPackageEntity'][_0x210313(0xe9)]({'where':{'id':_0x15da1f[_0x210313(0xd9)]}});if(!_0x6294b8)throw new common_1[(_0x210313(0x100))](_0x210313(0xf1),common_1['HttpStatus'][_0x210313(0x8e)]);const {payEpayPid:_0x1c61ff,payEpaySecret:_0x4ecca9,payEpayNotifyUrl:_0x443654,payEpayReturnUrl:_0x3a8c67,payEpayApiPayUrl:_0x57231e}=await this['globalConfigService'][_0x210313(0x11f)](['payEpayPid',_0x210313(0xa1),_0x210313(0xd6),_0x210313(0x124),_0x210313(0x12b)]);let _0x68aa8d;_0x1c61ff[_0x210313(0x10c)]<=0x10?_0x68aa8d=Number(_0x1c61ff):_0x68aa8d=BigInt(_0x1c61ff);const _0x29e798={};_0x29e798[_0x210313(0x111)]=_0x68aa8d,_0x29e798[_0x210313(0x132)]=_0x10c823,_0x29e798[_0x210313(0xa2)]=_0x4b3e54,_0x29e798[_0x210313(0x128)]=_0x6294b8[_0x210313(0x128)],_0x29e798['money']=_0x15da1f[_0x210313(0x110)],_0x29e798[_0x210313(0x93)]=_0x210313(0xf9),_0x29e798[_0x210313(0x130)]='pc',_0x29e798[_0x210313(0x9b)]=_0x443654,_0x29e798[_0x210313(0xbd)]=_0x3a8c67,_0x29e798[_0x210313(0x87)]=_0x210313(0x121),_0x29e798[_0x210313(0xa9)]=this['sign'](_0x29e798,_0x4ecca9),_0x29e798[_0x210313(0x11a)]='MD5';const _0x2e3b82=new URLSearchParams(_0x29e798)[_0x210313(0x113)](),_0x389ac1=_0x57231e+'?'+_0x2e3b82;if(_0x57231e[_0x210313(0x9d)](_0x210313(0xa7)))return{'url_qrcode':null,'redirectUrl':_0x389ac1,'channel':_0x10c823,'isRedirect':!![]};else{const _0x38b6f0=await axios_1[_0x210313(0xc6)][_0x210313(0xd7)](_0x57231e,{'params':_0x29e798});console['log'](_0x210313(0xcf),_0x38b6f0['data']);const {data:{code:_0xe50f13,msg:_0x106787,qrcode:_0x2e68ad}}=_0x38b6f0;if(_0xe50f13!=0x1)throw new common_1[(_0x210313(0x100))](_0x106787,common_1[_0x210313(0xfc)][_0x210313(0x8e)]);return{'url_qrcode':_0x2e68ad,'redirectUrl':null,'channel':_0x10c823,'isRedirect':![]};}}async['queryEpay'](_0x57e1ce){const _0x4d510f=_0x53ab85,{payEpayPid:_0x4084bc,payEpaySecret:_0x13507e,payEpayApiQueryUrl:_0x4a0746}=await this[_0x4d510f(0xf5)][_0x4d510f(0x11f)](['payEpayPid','payEpaySecret',_0x4d510f(0x102)]),_0x139ab9={};_0x139ab9['act']=_0x4d510f(0xd1),_0x139ab9[_0x4d510f(0xa2)]=_0x57e1ce,_0x139ab9[_0x4d510f(0x111)]=_0x4084bc,_0x139ab9[_0x4d510f(0xec)]=_0x13507e;const {data:{code:_0x3fe966,msg:_0x447a82,data:_0x1b4b76}}=await axios_1[_0x4d510f(0xc6)][_0x4d510f(0xd7)](_0x4a0746,{'params':_0x139ab9});if(_0x3fe966!=0x1)throw new common_1['HttpException'](_0x447a82,common_1[_0x4d510f(0xfc)][_0x4d510f(0x8e)]);return _0x1b4b76;}async[_0x53ab85(0x92)](_0x12fe19){const _0x182bb1=_0x53ab85,_0x38bd9b=_0x12fe19[_0x182bb1(0xa9)];delete _0x12fe19[_0x182bb1(0xa9)],delete _0x12fe19['sign_type'];const _0x3751c9=await this['globalConfigService']['getConfigs']([_0x182bb1(0xb3)]);console[_0x182bb1(0x106)](_0x182bb1(0xf8));if(this[_0x182bb1(0xa9)](_0x12fe19,_0x3751c9)!=_0x38bd9b)return _0x182bb1(0xcc);console[_0x182bb1(0x106)](_0x182bb1(0x123));const _0x2c86e6=await this[_0x182bb1(0xf0)][_0x182bb1(0xe9)]({'where':{'orderId':_0x12fe19['out_trade_no'],'status':0x0}});if(!_0x2c86e6)return _0x182bb1(0xcc);const _0x2d8096=_0x12fe19['trade_status']==_0x182bb1(0xe2)?0x1:0x2;console[_0x182bb1(0x106)](_0x182bb1(0x97),_0x2d8096);const _0x5f0ebe=await this['orderEntity'][_0x182bb1(0x117)]({'orderId':_0x12fe19[_0x182bb1(0xa2)]},{'status':_0x2d8096,'paydAt':new Date()});_0x2d8096===0x1&&await this[_0x182bb1(0x11c)][_0x182bb1(0xcb)](_0x2c86e6);if(_0x5f0ebe[_0x182bb1(0xbc)]!=0x1)return'failed';return _0x182bb1(0xdb);}async[_0x53ab85(0x105)](_0x57d4ec,_0x5bf3ef,_0x42967b=_0x53ab85(0xd4)){const _0x37ff77=_0x53ab85,_0x3e1651=await this[_0x37ff77(0xf0)][_0x37ff77(0xe9)]({'where':{'userId':_0x57d4ec,'orderId':_0x5bf3ef}});if(!_0x3e1651)throw new common_1[(_0x37ff77(0x100))](_0x37ff77(0x98),common_1[_0x37ff77(0xfc)]['BAD_REQUEST']);const _0x40cc95=await this['cramiPackageEntity'][_0x37ff77(0xe9)]({'where':{'id':_0x3e1651[_0x37ff77(0xd9)]}});if(!_0x40cc95)throw new common_1[(_0x37ff77(0x100))](_0x37ff77(0xf1),common_1[_0x37ff77(0xfc)][_0x37ff77(0x8e)]);const {payMpayPid:_0x423e41,payMpaySecret:_0x383c4f,payMpayNotifyUrl:_0x5e3fe4,payMpayReturnUrl:_0x19b561,payMpayApiPayUrl:_0x2335d4}=await this['globalConfigService']['getConfigs'](['payMpayPid',_0x37ff77(0xb3),_0x37ff77(0xfb),_0x37ff77(0xe3),'payMpayApiPayUrl']),_0x5c03c8={};_0x5c03c8['pid']=Number(_0x423e41),_0x5c03c8[_0x37ff77(0x132)]=_0x42967b,_0x5c03c8[_0x37ff77(0xa2)]=_0x5bf3ef,_0x5c03c8['name']=_0x40cc95['name'],_0x5c03c8[_0x37ff77(0xc5)]=_0x3e1651[_0x37ff77(0x110)],_0x5c03c8[_0x37ff77(0x9b)]=_0x5e3fe4,_0x5c03c8[_0x37ff77(0xbd)]=_0x19b561,_0x5c03c8['sign']=this[_0x37ff77(0xa9)](_0x5c03c8,_0x383c4f),_0x5c03c8[_0x37ff77(0x11a)]='MD5';const _0x442a38=new URLSearchParams(_0x5c03c8)[_0x37ff77(0x113)](),_0x1de36d=_0x2335d4+'?'+_0x442a38;return{'url_qrcode':null,'redirectUrl':_0x1de36d,'channel':_0x42967b,'isRedirect':!![]};const _0x277764=await axios_1[_0x37ff77(0xc6)][_0x37ff77(0xd7)](_0x2335d4,{'params':_0x5c03c8});}async[_0x53ab85(0xd2)](_0xdf1cde){const _0x2542ef=_0x53ab85,{payMpayApiQueryUrl:_0x4d7579}=await this['globalConfigService'][_0x2542ef(0x11f)]([_0x2542ef(0xed),'payMpaySecret',_0x2542ef(0xdc)]),_0x363c54={};_0x363c54[_0x2542ef(0x132)]=0x2,_0x363c54[_0x2542ef(0xb5)]=_0xdf1cde;const {data:{code:_0x241edd,msg:_0xc7e8fc,data:_0x2f025c}}=await axios_1[_0x2542ef(0xc6)][_0x2542ef(0xd7)](_0x4d7579,{'params':_0x363c54});if(_0x241edd!=0x1)throw new common_1[(_0x2542ef(0x100))](_0xc7e8fc,common_1[_0x2542ef(0xfc)][_0x2542ef(0x8e)]);return _0x2f025c;}async['notifyWeChat'](_0x151247){const _0x469196=_0x53ab85;console['log']('微信支付通知params:\x20',_0x151247);const {payWeChatAppId:_0x2e4a89,payWeChatMchId:_0x138690,payWeChatSecret:_0x2a9e13,payWeChatPublicKey:_0x4962db,payWeChatPrivateKey:_0x104115}=await this[_0x469196(0xf5)][_0x469196(0x11f)]([_0x469196(0xcd),_0x469196(0x12c),'payWeChatSecret','payWeChatPublicKey',_0x469196(0xc8)]),_0x1002a0=new this[(_0x469196(0xef))]({'appid':_0x2e4a89,'mchid':_0x138690,'publicKey':_0x4962db,'privateKey':_0x104115});try{if(_0x151247[_0x469196(0x11e)]==_0x469196(0x89)){const {ciphertext:_0x46d36c,associated_data:_0x3d586a,nonce:_0x211e28}=_0x151247['resource'],_0x5c190b=_0x1002a0[_0x469196(0xdd)](_0x46d36c,_0x3d586a,_0x211e28,_0x2a9e13),_0x124f77=await this[_0x469196(0xf0)][_0x469196(0xe9)]({'where':{'orderId':_0x5c190b[_0x469196(0xa2)],'status':0x0}});if(!_0x124f77)return _0x469196(0xcc);const _0x248d83=_0x5c190b[_0x469196(0xab)]=='SUCCESS'?0x1:0x2,_0x2a08e1=await this[_0x469196(0xf0)][_0x469196(0x117)]({'orderId':_0x5c190b[_0x469196(0xa2)]},{'status':_0x248d83,'paydAt':new Date()});_0x248d83===0x1&&await this[_0x469196(0x11c)][_0x469196(0xcb)](_0x124f77);if(_0x2a08e1[_0x469196(0xbc)]!=0x1)return _0x469196(0xcc);}return _0x469196(0xdb);}catch(_0x4dc9cf){return console[_0x469196(0x106)](_0x469196(0xac),_0x4dc9cf),console[_0x469196(0x106)]('支付通知验证失败:\x20',_0x4dc9cf),_0x469196(0xcc);}}async['payWeChat'](_0x5186c5,_0x4dc1f0,_0x34ec68=_0x53ab85(0xc3)){const _0x28a7c4=_0x53ab85;var _0x4d0710,_0x3cafe7,_0x19c7ff;console['log']('payType:\x20',_0x34ec68);const _0x477592=await this[_0x28a7c4(0xf0)]['findOne']({'where':{'userId':_0x5186c5,'orderId':_0x4dc1f0}});if(!_0x477592)throw new common_1['HttpException']('订单不存在!',common_1[_0x28a7c4(0xfc)]['BAD_REQUEST']);const _0x1c436f=await this['cramiPackageEntity'][_0x28a7c4(0xe9)]({'where':{'id':_0x477592[_0x28a7c4(0xd9)]}});if(!_0x1c436f)throw new common_1[(_0x28a7c4(0x100))](_0x28a7c4(0xf1),common_1['HttpStatus'][_0x28a7c4(0x8e)]);const {payWeChatAppId:_0x202bce,payWeChatMchId:_0x1500a9,payWeChatPublicKey:_0x80140e,payWeChatPrivateKey:_0x1aae9c,payWeChatNotifyUrl:_0x26ed61,payWeChatH5Name:_0x3b6120,payWeChatH5Url:_0x4516a7}=await this[_0x28a7c4(0xf5)]['getConfigs']([_0x28a7c4(0xcd),_0x28a7c4(0x12c),_0x28a7c4(0xeb),_0x28a7c4(0xc8),_0x28a7c4(0xe4),_0x28a7c4(0xb2),_0x28a7c4(0xe8)]);console[_0x28a7c4(0x106)](_0x28a7c4(0xcd),_0x202bce),console[_0x28a7c4(0x106)](_0x28a7c4(0x12c),_0x1500a9),console[_0x28a7c4(0x106)](_0x28a7c4(0xeb),_0x80140e),console[_0x28a7c4(0x106)](_0x28a7c4(0xc8),_0x1aae9c);const _0x47ec56=new this[(_0x28a7c4(0xef))]({'appid':_0x202bce,'mchid':_0x1500a9,'publicKey':_0x80140e,'privateKey':_0x1aae9c,'serial_no':process[_0x28a7c4(0x122)][_0x28a7c4(0x99)]}),_0x46abad={'appid':_0x202bce,'mchid':_0x1500a9,'description':_0x1c436f[_0x28a7c4(0x128)],'out_trade_no':_0x4dc1f0,'notify_url':_0x26ed61,'amount':{'total':Number(_0x477592['total']*0x64)},'scene_info':{'payer_client_ip':_0x28a7c4(0xf9)}};console['log'](_0x28a7c4(0x101),_0x46abad);if(_0x34ec68=='h5'){_0x46abad[_0x28a7c4(0x131)][_0x28a7c4(0x8c)]={'type':_0x28a7c4(0xdf),'app_name':_0x3b6120,'app_url':_0x4516a7};const _0x31f0be=await _0x47ec56[_0x28a7c4(0xf7)](_0x46abad);if(_0x31f0be['status']===0x193){const _0x20f593=(_0x19c7ff=(_0x3cafe7=(_0x4d0710=_0x31f0be===null||_0x31f0be===void 0x0?void 0x0:_0x31f0be[_0x28a7c4(0x10b)])===null||_0x4d0710===void 0x0?void 0x0:_0x4d0710['response'])===null||_0x3cafe7===void 0x0?void 0x0:_0x3cafe7['text'])===null||_0x19c7ff===void 0x0?void 0x0:_0x19c7ff[_0x28a7c4(0x12a)];throw new common_1[(_0x28a7c4(0x100))]((_0x31f0be===null||_0x31f0be===void 0x0?void 0x0:_0x31f0be[_0x28a7c4(0x12a)])||_0x28a7c4(0x109),common_1['HttpStatus'][_0x28a7c4(0x8e)]);}const {h5_url:_0x35a675}=_0x31f0be;return{'url':_0x35a675};}if(_0x34ec68==_0x28a7c4(0xde)){const _0xfb6d11=await this[_0x28a7c4(0xe6)][_0x28a7c4(0xc7)](_0x5186c5);console[_0x28a7c4(0x106)](_0x28a7c4(0x85),_0xfb6d11),_0x46abad[_0x28a7c4(0xa8)]={'openid':_0xfb6d11};const _0x34173e=await _0x47ec56['transactions_jsapi'](_0x46abad);return console[_0x28a7c4(0x106)](_0x28a7c4(0x9e),_0x34173e),_0x34173e;}if(_0x34ec68=='native'){const _0x27d242=await _0x47ec56['transactions_native'](_0x46abad),{data:_0x1be3b8,status:_0x42b511}=_0x27d242;if(_0x42b511!==0xc8)throw new common_1['HttpException'](_0x28a7c4(0x127),_0x27d242);const {code_url:_0x10b7b5}=_0x1be3b8;return!_0x10b7b5&&console[_0x28a7c4(0x106)](_0x28a7c4(0xff),_0x27d242),{'url_qrcode':_0x10b7b5,'isRedirect':![]};}throw new common_1[(_0x28a7c4(0x100))](_0x28a7c4(0xd5),common_1[_0x28a7c4(0xfc)]['BAD_REQUEST']);}async['queryWeChat'](_0x2b012f){const _0x18eda7=_0x53ab85,{payWeChatAppId:_0x3c5425,payWeChatMchId:_0x32554b,payWeChatPublicKey:_0x5731ba,payWeChatPrivateKey:_0x4d8f0e,payWeChatNotifyUrl:_0x3837a8,payWeChatH5Name:_0xfcbe69,payWeChatH5Url:_0x31b1e6}=await this['globalConfigService'][_0x18eda7(0x11f)](['payWeChatAppId','payWeChatMchId',_0x18eda7(0xeb),'payWeChatPrivateKey']),_0x3bd4b6=new this[(_0x18eda7(0xef))]({'appid':_0x3c5425,'mchid':_0x32554b,'publicKey':_0x5731ba,'privateKey':_0x4d8f0e}),_0x17af0d=await _0x3bd4b6[_0x18eda7(0x86)]({'out_trade_no':_0x2b012f});return _0x17af0d;}['sign'](_0x4e05e9,_0x460715){const _0x3b443b=_0x53ab85,_0x19ee92=Object['keys'](_0x4e05e9)['sort']()[_0x3b443b(0xbf)](_0x3bd52c=>_0x3bd52c+'='+_0x4e05e9[_0x3bd52c])[_0x3b443b(0xe1)]('&')+_0x460715;return crypto[_0x3b443b(0xfe)](_0x3b443b(0x94))[_0x3b443b(0x117)](_0x19ee92)[_0x3b443b(0x114)](_0x3b443b(0xb0));}};PayService=__decorate([(0x0,common_1[_0x53ab85(0xf4)])(),__param(0x0,(0x0,typeorm_1[_0x53ab85(0x84)])(cramiPackage_entity_1[_0x53ab85(0x11d)])),__param(0x1,(0x0,typeorm_1[_0x53ab85(0x84)])(order_entity_1[_0x53ab85(0x95)])),__metadata(_0x53ab85(0xf3),[typeorm_2[_0x53ab85(0xa0)],typeorm_2[_0x53ab85(0xa0)],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x53ab85(0x129)],user_service_1[_0x53ab85(0x8d)]])],PayService),exports['PayService']=PayService;function _0x20ca(){const _0x3c79f8=['../user/user.service','payHupiGatewayUrl','hex','trade_status','payWeChatH5Name','payMpaySecret','post','order_no','notifyHupi','function','createRandomNonceStr','8925610mbZjGh','支付请求失败!','now','affected','return_url','payPlatform','map','PayService','https://api.xunhupay.com/payment/query.html','wechat','native','@nestjs/common','money','default','getOpenIdByUserId','payWeChatPrivateKey','toFixed','209BhEeLp','addBalanceToOrder','failed','payWeChatAppId','decorate','epay\x20--->\x20res:\x20','hupi','order','queryMpay','metadata','wxpay','unsupported\x20pay\x20type','payEpayNotifyUrl','get','cramiPackageEntity','goodsId','notifyWeChat','success','payMpayApiQueryUrl','decipher_gcm','jsapi','Wap','payHupiReturnUrl','join','TRADE_SUCCESS','payMpayReturnUrl','payWeChatNotifyUrl','out_trade_order','userService','pay','payWeChatH5Url','findOne','__metadata','payWeChatPublicKey','key','payMpayPid','mpay','WxPay','orderEntity','套餐不存在!','../../common/utils','design:paramtypes','Injectable','globalConfigService','134KBCttW','transactions_h5','校验签名','192.168.1.100','../crami/cramiPackage.entity','payMpayNotifyUrl','HttpStatus','nonce_str','createHash','wx-native\x20获取二维码地址为空','HttpException','wechat-pay:\x20','payEpayApiQueryUrl','11652zfbgSA','1.1','payMpay','log','time','trade_order_id','微信H5支付失败！','defineProperty','errRaw','length','importDynamic','../globalConfig/globalConfig.service','queryHupi','total','pid','payEpay','toString','digest','attach','onModuleInit','update','hash','948010FDLNhY','sign_type','2121aICZjQ','userBalanceService','CramiPackageEntity','event_type','getConfigs','notify','epay','env','校验签名通过','payEpayReturnUrl','notifyEpay','alipay','获取支付二维码失败','name','GlobalConfigService','message','payEpayApiPayUrl','payWeChatMchId','__param','payHupi','../order/order.entity','device','scene_info','type','appid','payWeChat','InjectRepository','用户openId:\x20','query','param','26392xPZvRX','TRANSACTION.SUCCESS','payHupiNotifyUrl','axios','h5_info','UserService','BAD_REQUEST','https://api.xunhupay.com/payment/do.html','crypto','556044HcbizU','notifyMpay','clientip','md5','OrderEntity','819trCORt','status:\x20','订单不存在!','SERIAL_NO','1450GEVOmB','notify_url','payHupiAppId','includes','jsapi支付结果返回值:\x20','2814330kVpNDN','Repository','payEpaySecret','out_trade_no','14TdtNyg','payHupiSecret','本次支付类型:\x20','getOwnPropertyDescriptor','submit.php','payer','sign','title','trade_state','error:\x20','object'];_0x20ca=function(){return _0x3c79f8;};return _0x20ca();}