'use strict';const _0x2a463b=_0x57d8;(function(_0x45b773,_0x31c7a2){const _0x2a1a30=_0x57d8,_0x779e2b=_0x45b773();while(!![]){try{const _0x404dde=-parseInt(_0x2a1a30(0x243))/0x1+-parseInt(_0x2a1a30(0x208))/0x2*(-parseInt(_0x2a1a30(0x257))/0x3)+-parseInt(_0x2a1a30(0x21c))/0x4+-parseInt(_0x2a1a30(0x207))/0x5+parseInt(_0x2a1a30(0x23e))/0x6+parseInt(_0x2a1a30(0x251))/0x7*(-parseInt(_0x2a1a30(0x1f3))/0x8)+parseInt(_0x2a1a30(0x26e))/0x9*(parseInt(_0x2a1a30(0x24c))/0xa);if(_0x404dde===_0x31c7a2)break;else _0x779e2b['push'](_0x779e2b['shift']());}catch(_0x4ef6dc){_0x779e2b['push'](_0x779e2b['shift']());}}}(_0x443f,0xad756));var __decorate=this&&this['__decorate']||function(_0x27e573,_0x385d79,_0x8f236c,_0x4e5d2e){const _0x280264=_0x57d8;var _0x893437=arguments['length'],_0x3f5477=_0x893437<0x3?_0x385d79:_0x4e5d2e===null?_0x4e5d2e=Object[_0x280264(0x21e)](_0x385d79,_0x8f236c):_0x4e5d2e,_0x262e86;if(typeof Reflect===_0x280264(0x21d)&&typeof Reflect[_0x280264(0x20b)]===_0x280264(0x20e))_0x3f5477=Reflect[_0x280264(0x20b)](_0x27e573,_0x385d79,_0x8f236c,_0x4e5d2e);else{for(var _0x33461b=_0x27e573[_0x280264(0x1f2)]-0x1;_0x33461b>=0x0;_0x33461b--)if(_0x262e86=_0x27e573[_0x33461b])_0x3f5477=(_0x893437<0x3?_0x262e86(_0x3f5477):_0x893437>0x3?_0x262e86(_0x385d79,_0x8f236c,_0x3f5477):_0x262e86(_0x385d79,_0x8f236c))||_0x3f5477;}return _0x893437>0x3&&_0x3f5477&&Object[_0x280264(0x1d6)](_0x385d79,_0x8f236c,_0x3f5477),_0x3f5477;},__metadata=this&&this[_0x2a463b(0x222)]||function(_0x4dfcbe,_0xf91baf){if(typeof Reflect==='object'&&typeof Reflect['metadata']==='function')return Reflect['metadata'](_0x4dfcbe,_0xf91baf);},__param=this&&this[_0x2a463b(0x219)]||function(_0x3b975c,_0x249a6f){return function(_0x2ec491,_0xb9b71d){_0x249a6f(_0x2ec491,_0xb9b71d,_0x3b975c);};};function _0x443f(){const _0x56feaf=['act','BAD_REQUEST','decipher_gcm','wechatpay-node-v3','transactions_native','trade_state','findOne','payWeChatAppId','trade_order_id','724375aaJuwD','30538HqJduw','keys','join','decorate','design:paramtypes','Repository','function','update','mpay','payMpayApiQueryUrl','payEpaySecret','appid','order_no','payPlatform','Injectable','微信支付通知params:\x20','version','__param','notifyEpay','本次支付类型:\x20','1866488kiJoXF','object','getOwnPropertyDescriptor','payMpaySecret','支付请求失败:\x20','payMpayPid','__metadata','affected','h5_info','toFixed','trade_status','title','native','GlobalConfigService','axios','payEpayPid','default','log','map','jsapi支付结果返回值:\x20','payEpay','payWeChatNotifyUrl','HttpStatus','param','notifyWeChat','money','goodsId','payMpayNotifyUrl','getConfigs','toString','sign','payWeChatMchId','device','@nestjs/typeorm','2953320JLHLjW','orderEntity','payHupiReturnUrl','TRADE_SUCCESS','get','138168kGMNmT','notifyHupi','createHash','queryWeChat','cramiPackageEntity','payHupiSecret','nonce_str','../../common/utils','https://api.xunhupay.com/payment/do.html','334410KhASRP','name','response','../userBalance/userBalance.service','alipay','1058183URciWE','userService','校验签名通过','pid','payType:\x20','createRandomNonceStr','135hQNdFh','total','sort','errRaw','wechat-pay:\x20','支付通知验证失败:\x20','type','payMpayReturnUrl','套餐不存在!','globalConfigService','sign_type','https://api.xunhupay.com/payment/query.html','out_trade_no','OrderEntity','return_url','success','支付请求失败!','payHupiNotifyUrl','TRANSACTION.SUCCESS','failed','微信H5支付失败！','HttpException','queryHupi','279aCoOxS','query','hash','notifyMpay','digest','订单不存在!','post','payWeChatPublicKey','payWeChat','error:\x20','payer','order','payHupiAppId','InjectRepository','onModuleInit','queryEpay','out_trade_order','hupi','resource','defineProperty','data','notify','transactions_h5','payHupi','hex','payEpayApiPayUrl','addBalanceToOrder','userBalanceService','unsupported\x20pay\x20type','校验签名','payWeChatH5Name','time','wxpay','CramiPackageEntity','payEpayNotifyUrl','wx-native','epay','用户openId:\x20','payMpayApiPayUrl','queryMpay','event_type','notify_url','192.168.1.100','typeorm','payHupiGatewayUrl','crypto','../globalConfig/globalConfig.service','length','40TDZWIf','now','payMpay','payWeChatPrivateKey','transactions_jsapi','__esModule','WxPay','MD5','wechat','message','UserService'];_0x443f=function(){return _0x56feaf;};return _0x443f();}Object[_0x2a463b(0x1d6)](exports,_0x2a463b(0x1f8),{'value':!![]}),exports['PayService']=void 0x0;const typeorm_1=require(_0x2a463b(0x23d)),typeorm_2=require(_0x2a463b(0x1ee)),common_1=require('@nestjs/common'),crypto=require(_0x2a463b(0x1f0)),axios_1=require(_0x2a463b(0x22a)),order_entity_1=require('../order/order.entity'),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_service_1=require(_0x2a463b(0x24f)),globalConfig_service_1=require(_0x2a463b(0x1f1)),utils_1=require(_0x2a463b(0x24a)),user_service_1=require('../user/user.service');let PayService=class PayService{constructor(_0x4a08c7,_0x3d5017,_0x415b5d,_0x538a9,_0x30a3da){const _0x4e38b8=_0x2a463b;this['cramiPackageEntity']=_0x4a08c7,this[_0x4e38b8(0x23f)]=_0x3d5017,this[_0x4e38b8(0x1de)]=_0x415b5d,this['globalConfigService']=_0x538a9,this[_0x4e38b8(0x252)]=_0x30a3da;}async[_0x2a463b(0x27c)](){const _0x2ba077=_0x2a463b,_0x4c26ed=await(0x0,utils_1['importDynamic'])(_0x2ba077(0x201));this[_0x2ba077(0x1f9)]=(_0x4c26ed===null||_0x4c26ed===void 0x0?void 0x0:_0x4c26ed[_0x2ba077(0x22c)])?_0x4c26ed[_0x2ba077(0x22c)]:_0x4c26ed;}async[_0x2a463b(0x1d8)](_0x41d408){const _0x3bc0f3=_0x2a463b;if(_0x41d408[_0x3bc0f3(0x233)]==_0x3bc0f3(0x1e7))return this[_0x3bc0f3(0x21a)](_0x41d408);if(_0x41d408['attach']=='hupi')return this[_0x3bc0f3(0x244)](_0x41d408);if(typeof _0x41d408[_0x3bc0f3(0x1d5)]==_0x3bc0f3(0x21d))return this['notifyWeChat'](_0x41d408);return this[_0x3bc0f3(0x271)](_0x41d408);}async['pay'](_0x4ee24e,_0x4ef8b4,_0x3cdbc2=_0x2a463b(0x1e3)){const _0x185311=_0x2a463b,_0x2e2363=await this[_0x185311(0x23f)][_0x185311(0x204)]({'where':{'userId':_0x4ee24e,'orderId':_0x4ef8b4}});if(!_0x2e2363)throw new common_1['HttpException'](_0x185311(0x273),common_1['HttpStatus'][_0x185311(0x1ff)]);const _0x4a6e95=await this[_0x185311(0x247)][_0x185311(0x204)]({'where':{'id':_0x2e2363[_0x185311(0x236)]}});if(!_0x4a6e95)throw new common_1[(_0x185311(0x26c))]('套餐不存在!',common_1[_0x185311(0x232)][_0x185311(0x1ff)]);console[_0x185311(0x22d)](_0x185311(0x21b),_0x2e2363[_0x185311(0x215)]);try{if(_0x2e2363[_0x185311(0x215)]==_0x185311(0x1fb))return this[_0x185311(0x276)](_0x4ee24e,_0x4ef8b4,_0x3cdbc2);if(_0x2e2363[_0x185311(0x215)]==_0x185311(0x1e7))return this[_0x185311(0x230)](_0x4ee24e,_0x4ef8b4,_0x3cdbc2);if(_0x2e2363[_0x185311(0x215)]==_0x185311(0x210))return this[_0x185311(0x1f5)](_0x4ee24e,_0x4ef8b4,_0x3cdbc2);if(_0x2e2363[_0x185311(0x215)]==_0x185311(0x1d4))return this[_0x185311(0x1da)](_0x4ee24e,_0x4ef8b4,_0x3cdbc2);}catch(_0x298574){console[_0x185311(0x22d)](_0x185311(0x220),_0x298574);throw new common_1[(_0x185311(0x26c))](_0x185311(0x267),common_1[_0x185311(0x232)]['BAD_REQUEST']);}}async[_0x2a463b(0x26f)](_0x2da66b){const _0xe42ffb=_0x2a463b,_0x40fb4e=await this[_0xe42ffb(0x23f)][_0xe42ffb(0x204)]({'where':{'orderId':_0x2da66b}});if(!_0x40fb4e)throw new common_1['HttpException'](_0xe42ffb(0x273),common_1[_0xe42ffb(0x232)][_0xe42ffb(0x1ff)]);return _0x40fb4e;}async[_0x2a463b(0x244)](_0x207cd4){const _0x1ac27c=_0x2a463b,_0x4c7f93=await this[_0x1ac27c(0x260)]['getConfigs']([_0x1ac27c(0x248)]),_0x4e0f05=_0x207cd4['hash'];delete _0x207cd4[_0x1ac27c(0x270)];if(this[_0x1ac27c(0x23a)](_0x207cd4,_0x4c7f93)!=_0x4e0f05)return _0x1ac27c(0x26a);const _0x57f2a3=await this[_0x1ac27c(0x23f)][_0x1ac27c(0x204)]({'where':{'orderId':_0x207cd4[_0x1ac27c(0x206)],'status':0x0}});if(!_0x57f2a3)return'failed';await this[_0x1ac27c(0x1de)][_0x1ac27c(0x1dd)](_0x57f2a3);const _0x222a73=await this[_0x1ac27c(0x23f)][_0x1ac27c(0x20f)]({'orderId':_0x207cd4[_0x1ac27c(0x206)]},{'status':0x1,'paydAt':new Date()});if(_0x222a73[_0x1ac27c(0x223)]!=0x1)return _0x1ac27c(0x26a);return _0x1ac27c(0x266);}async[_0x2a463b(0x1da)](_0x85622d,_0x322c17,_0x15fb74=_0x2a463b(0x1e3)){const _0x2232d6=_0x2a463b,_0x6b3e2a=await this[_0x2232d6(0x23f)][_0x2232d6(0x204)]({'where':{'userId':_0x85622d,'orderId':_0x322c17}});if(!_0x6b3e2a)throw new common_1[(_0x2232d6(0x26c))](_0x2232d6(0x273),common_1[_0x2232d6(0x232)][_0x2232d6(0x1ff)]);const _0x47e8d7=await this['cramiPackageEntity'][_0x2232d6(0x204)]({'where':{'id':_0x6b3e2a[_0x2232d6(0x236)]}});if(!_0x47e8d7)throw new common_1[(_0x2232d6(0x26c))](_0x2232d6(0x25f),common_1[_0x2232d6(0x232)]['BAD_REQUEST']);const {payHupiAppId:_0x410e18,payHupiSecret:_0x1c1105,payHupiNotifyUrl:_0x240684,payHupiReturnUrl:_0x1a82e8,payHupiGatewayUrl:_0x13103b}=await this['globalConfigService']['getConfigs']([_0x2232d6(0x27a),_0x2232d6(0x248),_0x2232d6(0x268),_0x2232d6(0x240),_0x2232d6(0x1ef)]),_0x33e316={};_0x33e316[_0x2232d6(0x218)]='1.1',_0x33e316[_0x2232d6(0x213)]=_0x410e18,_0x33e316['time']=(Date[_0x2232d6(0x1f4)]()/0x3e8)[_0x2232d6(0x225)](0x0),_0x33e316[_0x2232d6(0x249)]=(0x0,utils_1[_0x2232d6(0x256)])(0x20),_0x33e316[_0x2232d6(0x206)]=_0x322c17,_0x33e316[_0x2232d6(0x227)]=_0x47e8d7['name'],_0x33e316['total_fee']=_0x6b3e2a[_0x2232d6(0x258)],_0x33e316[_0x2232d6(0x1ec)]=_0x240684,_0x33e316[_0x2232d6(0x265)]=_0x1a82e8,_0x33e316['attach']=_0x2232d6(0x1d4),_0x33e316[_0x2232d6(0x270)]=this[_0x2232d6(0x23a)](_0x33e316,_0x1c1105);const {data:{errcode:_0x3612a6,errmsg:_0x44f994,url_qrcode:_0x3825d3,url:_0x5ddcc7}}=await axios_1[_0x2232d6(0x22c)]['post'](_0x13103b||_0x2232d6(0x24b),_0x33e316);if(_0x3612a6!=0x0)throw new common_1[(_0x2232d6(0x26c))](_0x44f994,common_1[_0x2232d6(0x232)][_0x2232d6(0x1ff)]);return{'url_qrcode':_0x3825d3,'url':_0x5ddcc7};}async[_0x2a463b(0x26d)](_0x2a3089){const _0x4055fc=_0x2a463b,{payHupiAppId:_0x43006c,payHupiSecret:_0x3b5d0c}=await this[_0x4055fc(0x260)][_0x4055fc(0x238)]([_0x4055fc(0x27a),_0x4055fc(0x248)]),_0xc89fa7={};_0xc89fa7[_0x4055fc(0x218)]='1.1',_0xc89fa7['appid']=_0x43006c,_0xc89fa7[_0x4055fc(0x1e2)]=(Date[_0x4055fc(0x1f4)]()/0x3e8)[_0x4055fc(0x225)](0x0),_0xc89fa7[_0x4055fc(0x249)]=(0x0,utils_1[_0x4055fc(0x256)])(0x20),_0xc89fa7[_0x4055fc(0x1d3)]=_0x2a3089,_0xc89fa7['hash']=this[_0x4055fc(0x23a)](_0xc89fa7,_0x3b5d0c);const {data:{errcode:_0x31a1ce,errmsg:_0x3bf155,data:_0xbeffb4}}=await axios_1[_0x4055fc(0x22c)][_0x4055fc(0x274)](_0x4055fc(0x262),_0xc89fa7);if(_0x31a1ce!=0x0)throw new common_1['HttpException'](_0x3bf155,common_1[_0x4055fc(0x232)][_0x4055fc(0x1ff)]);return _0xbeffb4;}async[_0x2a463b(0x21a)](_0x2566a6){const _0x244cd6=_0x2a463b,_0x51a79e=_0x2566a6['sign'];delete _0x2566a6[_0x244cd6(0x23a)],delete _0x2566a6[_0x244cd6(0x261)];const _0x3eb0a2=await this[_0x244cd6(0x260)]['getConfigs']([_0x244cd6(0x212)]);if(this[_0x244cd6(0x23a)](_0x2566a6,_0x3eb0a2)!=_0x51a79e)return'failed';console[_0x244cd6(0x22d)](_0x244cd6(0x253));const _0x59b7b9=await this[_0x244cd6(0x23f)][_0x244cd6(0x204)]({'where':{'orderId':_0x2566a6[_0x244cd6(0x263)],'status':0x0}});if(!_0x59b7b9)return _0x244cd6(0x26a);const _0x210c64=_0x2566a6[_0x244cd6(0x226)]=='TRADE_SUCCESS'?0x1:0x2,_0x2dba66=await this['orderEntity']['update']({'orderId':_0x2566a6[_0x244cd6(0x263)]},{'status':_0x210c64,'paydAt':new Date()});_0x210c64===0x1&&await this['userBalanceService'][_0x244cd6(0x1dd)](_0x59b7b9);if(_0x2dba66[_0x244cd6(0x223)]!=0x1)return _0x244cd6(0x26a);return _0x244cd6(0x266);}async[_0x2a463b(0x230)](_0x165bbd,_0x1059b9,_0x39ff4b=_0x2a463b(0x250)){const _0x10b3e7=_0x2a463b,_0x59cbda=await this[_0x10b3e7(0x23f)][_0x10b3e7(0x204)]({'where':{'userId':_0x165bbd,'orderId':_0x1059b9}});if(!_0x59cbda)throw new common_1['HttpException'](_0x10b3e7(0x273),common_1[_0x10b3e7(0x232)][_0x10b3e7(0x1ff)]);const _0x161c28=await this[_0x10b3e7(0x247)][_0x10b3e7(0x204)]({'where':{'id':_0x59cbda[_0x10b3e7(0x236)]}});if(!_0x161c28)throw new common_1[(_0x10b3e7(0x26c))](_0x10b3e7(0x25f),common_1[_0x10b3e7(0x232)][_0x10b3e7(0x1ff)]);const {payEpayPid:_0xdeb10a,payEpaySecret:_0x5ee05a,payEpayNotifyUrl:_0x33cfed,payEpayReturnUrl:_0x86ea91,payEpayApiPayUrl:_0x484285}=await this[_0x10b3e7(0x260)][_0x10b3e7(0x238)]([_0x10b3e7(0x22b),'payEpaySecret',_0x10b3e7(0x1e5),'payEpayReturnUrl',_0x10b3e7(0x1dc)]);let _0x1b73dc;_0xdeb10a[_0x10b3e7(0x1f2)]<=0x10?_0x1b73dc=Number(_0xdeb10a):_0x1b73dc=BigInt(_0xdeb10a);const _0x1e1c90={};_0x1e1c90['pid']=_0x1b73dc,_0x1e1c90[_0x10b3e7(0x25d)]=_0x39ff4b,_0x1e1c90[_0x10b3e7(0x263)]=_0x1059b9,_0x1e1c90[_0x10b3e7(0x24d)]=_0x161c28[_0x10b3e7(0x24d)],_0x1e1c90[_0x10b3e7(0x235)]=_0x59cbda['total'],_0x1e1c90['clientip']=_0x10b3e7(0x1ed),_0x1e1c90[_0x10b3e7(0x23c)]='pc',_0x1e1c90[_0x10b3e7(0x1ec)]=_0x33cfed,_0x1e1c90['return_url']=_0x86ea91,_0x1e1c90['param']='epay',_0x1e1c90[_0x10b3e7(0x23a)]=this['sign'](_0x1e1c90,_0x5ee05a),_0x1e1c90[_0x10b3e7(0x261)]='MD5';const _0x26dc17=new URLSearchParams(_0x1e1c90)['toString'](),_0x4e7ec6=_0x484285+'?'+_0x26dc17;if(_0x484285['includes']('submit.php'))return{'url_qrcode':null,'redirectUrl':_0x4e7ec6,'channel':_0x39ff4b,'isRedirect':!![]};else{const _0x11f1dc=await axios_1[_0x10b3e7(0x22c)][_0x10b3e7(0x242)](_0x484285,{'params':_0x1e1c90});console[_0x10b3e7(0x22d)]('epay\x20--->\x20res:\x20',_0x11f1dc[_0x10b3e7(0x1d7)]);const {data:{code:_0x120d5a,msg:_0x160e2f,qrcode:_0x528466}}=_0x11f1dc;if(_0x120d5a!=0x1)throw new common_1[(_0x10b3e7(0x26c))](_0x160e2f,common_1['HttpStatus']['BAD_REQUEST']);return{'url_qrcode':_0x528466,'redirectUrl':null,'channel':_0x39ff4b,'isRedirect':![]};}}async[_0x2a463b(0x1d2)](_0x33b8b3){const _0x229f99=_0x2a463b,{payEpayPid:_0x415074,payEpaySecret:_0x22edaa,payEpayApiQueryUrl:_0x37978b}=await this[_0x229f99(0x260)][_0x229f99(0x238)]([_0x229f99(0x22b),_0x229f99(0x212),'payEpayApiQueryUrl']),_0x272795={};_0x272795[_0x229f99(0x1fe)]=_0x229f99(0x279),_0x272795[_0x229f99(0x263)]=_0x33b8b3,_0x272795[_0x229f99(0x254)]=_0x415074,_0x272795['key']=_0x22edaa;const {data:{code:_0x3a48f1,msg:_0x44a56b,data:_0x37c4df}}=await axios_1[_0x229f99(0x22c)][_0x229f99(0x242)](_0x37978b,{'params':_0x272795});if(_0x3a48f1!=0x1)throw new common_1[(_0x229f99(0x26c))](_0x44a56b,common_1[_0x229f99(0x232)][_0x229f99(0x1ff)]);return _0x37c4df;}async[_0x2a463b(0x271)](_0x370d7f){const _0x523e0b=_0x2a463b,_0x19432e=_0x370d7f['sign'];delete _0x370d7f[_0x523e0b(0x23a)],delete _0x370d7f[_0x523e0b(0x261)];const _0x3331b6=await this['globalConfigService'][_0x523e0b(0x238)]([_0x523e0b(0x21f)]);console[_0x523e0b(0x22d)](_0x523e0b(0x1e0));if(this[_0x523e0b(0x23a)](_0x370d7f,_0x3331b6)!=_0x19432e)return _0x523e0b(0x26a);console[_0x523e0b(0x22d)](_0x523e0b(0x253));const _0x17f640=await this[_0x523e0b(0x23f)]['findOne']({'where':{'orderId':_0x370d7f[_0x523e0b(0x263)],'status':0x0}});if(!_0x17f640)return _0x523e0b(0x26a);const _0x4ebf3d=_0x370d7f[_0x523e0b(0x226)]==_0x523e0b(0x241)?0x1:0x2;console['log']('status:\x20',_0x4ebf3d);const _0x21ae01=await this[_0x523e0b(0x23f)]['update']({'orderId':_0x370d7f['out_trade_no']},{'status':_0x4ebf3d,'paydAt':new Date()});_0x4ebf3d===0x1&&await this[_0x523e0b(0x1de)][_0x523e0b(0x1dd)](_0x17f640);if(_0x21ae01[_0x523e0b(0x223)]!=0x1)return'failed';return'success';}async[_0x2a463b(0x1f5)](_0x71a138,_0x2414b9,_0x2a2658=_0x2a463b(0x1e3)){const _0x4b5cf1=_0x2a463b,_0x494e79=await this[_0x4b5cf1(0x23f)]['findOne']({'where':{'userId':_0x71a138,'orderId':_0x2414b9}});if(!_0x494e79)throw new common_1[(_0x4b5cf1(0x26c))](_0x4b5cf1(0x273),common_1[_0x4b5cf1(0x232)][_0x4b5cf1(0x1ff)]);const _0x7a0b60=await this['cramiPackageEntity'][_0x4b5cf1(0x204)]({'where':{'id':_0x494e79[_0x4b5cf1(0x236)]}});if(!_0x7a0b60)throw new common_1[(_0x4b5cf1(0x26c))]('套餐不存在!',common_1[_0x4b5cf1(0x232)]['BAD_REQUEST']);const {payMpayPid:_0x40b65f,payMpaySecret:_0x1b6943,payMpayNotifyUrl:_0x46aadc,payMpayReturnUrl:_0x375b68,payMpayApiPayUrl:_0x34894f}=await this[_0x4b5cf1(0x260)]['getConfigs']([_0x4b5cf1(0x221),'payMpaySecret',_0x4b5cf1(0x237),_0x4b5cf1(0x25e),_0x4b5cf1(0x1e9)]),_0x33600d={};_0x33600d[_0x4b5cf1(0x254)]=Number(_0x40b65f),_0x33600d['type']=_0x2a2658,_0x33600d['out_trade_no']=_0x2414b9,_0x33600d['name']=_0x7a0b60['name'],_0x33600d[_0x4b5cf1(0x235)]=_0x494e79['total'],_0x33600d[_0x4b5cf1(0x1ec)]=_0x46aadc,_0x33600d[_0x4b5cf1(0x265)]=_0x375b68,_0x33600d['sign']=this[_0x4b5cf1(0x23a)](_0x33600d,_0x1b6943),_0x33600d[_0x4b5cf1(0x261)]=_0x4b5cf1(0x1fa);const _0x2c169d=new URLSearchParams(_0x33600d)[_0x4b5cf1(0x239)](),_0x8427d8=_0x34894f+'?'+_0x2c169d;return{'url_qrcode':null,'redirectUrl':_0x8427d8,'channel':_0x2a2658,'isRedirect':!![]};const _0x57ee3a=await axios_1[_0x4b5cf1(0x22c)][_0x4b5cf1(0x242)](_0x34894f,{'params':_0x33600d});}async[_0x2a463b(0x1ea)](_0x3eefc1){const _0x11266f=_0x2a463b,{payMpayApiQueryUrl:_0x4b02ac}=await this['globalConfigService']['getConfigs']([_0x11266f(0x221),_0x11266f(0x21f),_0x11266f(0x211)]),_0x201b4e={};_0x201b4e[_0x11266f(0x25d)]=0x2,_0x201b4e[_0x11266f(0x214)]=_0x3eefc1;const {data:{code:_0x5efab3,msg:_0x3dadb7,data:_0x189609}}=await axios_1['default'][_0x11266f(0x242)](_0x4b02ac,{'params':_0x201b4e});if(_0x5efab3!=0x1)throw new common_1[(_0x11266f(0x26c))](_0x3dadb7,common_1[_0x11266f(0x232)][_0x11266f(0x1ff)]);return _0x189609;}async[_0x2a463b(0x234)](_0x132318){const _0x3aeaf2=_0x2a463b;console['log'](_0x3aeaf2(0x217),_0x132318);const {payWeChatAppId:_0x4da734,payWeChatMchId:_0x4d5a67,payWeChatSecret:_0xb90a61,payWeChatPublicKey:_0x299a9d,payWeChatPrivateKey:_0x1afcd0}=await this[_0x3aeaf2(0x260)][_0x3aeaf2(0x238)]([_0x3aeaf2(0x205),_0x3aeaf2(0x23b),'payWeChatSecret',_0x3aeaf2(0x275),_0x3aeaf2(0x1f6)]),_0x22d893=new this[(_0x3aeaf2(0x1f9))]({'appid':_0x4da734,'mchid':_0x4d5a67,'publicKey':_0x299a9d,'privateKey':_0x1afcd0});try{if(_0x132318[_0x3aeaf2(0x1eb)]==_0x3aeaf2(0x269)){const {ciphertext:_0x2b4e6f,associated_data:_0x3ad104,nonce:_0x2a099d}=_0x132318['resource'],_0x6917a7=_0x22d893[_0x3aeaf2(0x200)](_0x2b4e6f,_0x3ad104,_0x2a099d,_0xb90a61),_0x2fedc4=await this[_0x3aeaf2(0x23f)][_0x3aeaf2(0x204)]({'where':{'orderId':_0x6917a7[_0x3aeaf2(0x263)],'status':0x0}});if(!_0x2fedc4)return'failed';const _0x10f837=_0x6917a7[_0x3aeaf2(0x203)]=='SUCCESS'?0x1:0x2,_0x2b705=await this['orderEntity'][_0x3aeaf2(0x20f)]({'orderId':_0x6917a7[_0x3aeaf2(0x263)]},{'status':_0x10f837,'paydAt':new Date()});_0x10f837===0x1&&await this['userBalanceService']['addBalanceToOrder'](_0x2fedc4);if(_0x2b705[_0x3aeaf2(0x223)]!=0x1)return _0x3aeaf2(0x26a);}return _0x3aeaf2(0x266);}catch(_0x42e58c){return console['log'](_0x3aeaf2(0x277),_0x42e58c),console[_0x3aeaf2(0x22d)](_0x3aeaf2(0x25c),_0x42e58c),_0x3aeaf2(0x26a);}}async[_0x2a463b(0x276)](_0x149443,_0x28fb88,_0x3fdb06=_0x2a463b(0x228)){const _0x2741eb=_0x2a463b;var _0x4848b0,_0x4ed080,_0x499c18;console[_0x2741eb(0x22d)](_0x2741eb(0x255),_0x3fdb06);const _0x4d69f6=await this[_0x2741eb(0x23f)][_0x2741eb(0x204)]({'where':{'userId':_0x149443,'orderId':_0x28fb88}});if(!_0x4d69f6)throw new common_1[(_0x2741eb(0x26c))]('订单不存在!',common_1[_0x2741eb(0x232)][_0x2741eb(0x1ff)]);const _0x33f42d=await this['cramiPackageEntity'][_0x2741eb(0x204)]({'where':{'id':_0x4d69f6['goodsId']}});if(!_0x33f42d)throw new common_1[(_0x2741eb(0x26c))](_0x2741eb(0x25f),common_1['HttpStatus'][_0x2741eb(0x1ff)]);const {payWeChatAppId:_0xfcff2a,payWeChatMchId:_0x28c98a,payWeChatPublicKey:_0x4ceb23,payWeChatPrivateKey:_0x1d95e6,payWeChatNotifyUrl:_0x9b01b3,payWeChatH5Name:_0x2ce266,payWeChatH5Url:_0x2a84c1}=await this['globalConfigService'][_0x2741eb(0x238)]([_0x2741eb(0x205),'payWeChatMchId',_0x2741eb(0x275),_0x2741eb(0x1f6),_0x2741eb(0x231),_0x2741eb(0x1e1),'payWeChatH5Url']),_0x1487a5=new this[(_0x2741eb(0x1f9))]({'appid':_0xfcff2a,'mchid':_0x28c98a,'publicKey':_0x4ceb23,'privateKey':_0x1d95e6}),_0x482ccf={'appid':_0xfcff2a,'mchid':_0x28c98a,'description':_0x33f42d[_0x2741eb(0x24d)],'out_trade_no':_0x28fb88,'notify_url':_0x9b01b3,'amount':{'total':Number(_0x4d69f6['total']*0x64)},'scene_info':{'payer_client_ip':_0x2741eb(0x1ed)}};console[_0x2741eb(0x22d)](_0x2741eb(0x25b),_0x482ccf);if(_0x3fdb06=='h5'){_0x482ccf['scene_info'][_0x2741eb(0x224)]={'type':'Wap','app_name':_0x2ce266,'app_url':_0x2a84c1};const _0x12d562=await _0x1487a5[_0x2741eb(0x1d9)](_0x482ccf);if(_0x12d562['status']===0x193){const _0x4e2ff2=(_0x499c18=(_0x4ed080=(_0x4848b0=_0x12d562===null||_0x12d562===void 0x0?void 0x0:_0x12d562[_0x2741eb(0x25a)])===null||_0x4848b0===void 0x0?void 0x0:_0x4848b0[_0x2741eb(0x24e)])===null||_0x4ed080===void 0x0?void 0x0:_0x4ed080['text'])===null||_0x499c18===void 0x0?void 0x0:_0x499c18[_0x2741eb(0x1fc)];throw new common_1['HttpException']((_0x12d562===null||_0x12d562===void 0x0?void 0x0:_0x12d562[_0x2741eb(0x1fc)])||_0x2741eb(0x26b),common_1[_0x2741eb(0x232)]['BAD_REQUEST']);}const {h5_url:_0x41941e}=_0x12d562;return{'url':_0x41941e};}if(_0x3fdb06=='jsapi'){const _0x266034=await this[_0x2741eb(0x252)]['getOpenIdByUserId'](_0x149443);console['log'](_0x2741eb(0x1e8),_0x266034),_0x482ccf[_0x2741eb(0x278)]={'openid':_0x266034};const _0x4ef89b=await _0x1487a5[_0x2741eb(0x1f7)](_0x482ccf);return console[_0x2741eb(0x22d)](_0x2741eb(0x22f),_0x4ef89b),_0x4ef89b;}if(_0x3fdb06==_0x2741eb(0x228)){const _0x3e12a2=await _0x1487a5[_0x2741eb(0x202)](_0x482ccf),{code_url:_0x476e53}=_0x3e12a2;return!_0x476e53&&console[_0x2741eb(0x22d)](_0x2741eb(0x1e6),_0x3e12a2),{'url_qrcode':_0x476e53,'isRedirect':![]};}throw new common_1['HttpException'](_0x2741eb(0x1df),common_1[_0x2741eb(0x232)][_0x2741eb(0x1ff)]);}async[_0x2a463b(0x246)](_0x3424a0){const _0x26162b=_0x2a463b,{payWeChatAppId:_0x469ae1,payWeChatMchId:_0x178111,payWeChatPublicKey:_0x571631,payWeChatPrivateKey:_0x25f813,payWeChatNotifyUrl:_0x3f30e2,payWeChatH5Name:_0x33417d,payWeChatH5Url:_0x17827e}=await this[_0x26162b(0x260)][_0x26162b(0x238)](['payWeChatAppId',_0x26162b(0x23b),_0x26162b(0x275),_0x26162b(0x1f6)]),_0x3d456d=new this['WxPay']({'appid':_0x469ae1,'mchid':_0x178111,'publicKey':_0x571631,'privateKey':_0x25f813}),_0x4e2b1d=await _0x3d456d[_0x26162b(0x26f)]({'out_trade_no':_0x3424a0});return _0x4e2b1d;}['sign'](_0x123f3d,_0x56b2f4){const _0x482bf1=_0x2a463b,_0x31e9f1=Object[_0x482bf1(0x209)](_0x123f3d)[_0x482bf1(0x259)]()[_0x482bf1(0x22e)](_0xcdf607=>_0xcdf607+'='+_0x123f3d[_0xcdf607])[_0x482bf1(0x20a)]('&')+_0x56b2f4;return crypto[_0x482bf1(0x245)]('md5')[_0x482bf1(0x20f)](_0x31e9f1)[_0x482bf1(0x272)](_0x482bf1(0x1db));}};function _0x57d8(_0x4694ed,_0x2afb92){const _0x443f43=_0x443f();return _0x57d8=function(_0x57d81c,_0xe848c9){_0x57d81c=_0x57d81c-0x1d2;let _0x14468a=_0x443f43[_0x57d81c];return _0x14468a;},_0x57d8(_0x4694ed,_0x2afb92);}PayService=__decorate([(0x0,common_1[_0x2a463b(0x216)])(),__param(0x0,(0x0,typeorm_1[_0x2a463b(0x27b)])(cramiPackage_entity_1[_0x2a463b(0x1e4)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x2a463b(0x264)])),__metadata(_0x2a463b(0x20c),[typeorm_2[_0x2a463b(0x20d)],typeorm_2[_0x2a463b(0x20d)],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x2a463b(0x229)],user_service_1[_0x2a463b(0x1fd)]])],PayService),exports['PayService']=PayService;