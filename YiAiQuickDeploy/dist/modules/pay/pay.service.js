'use strict';const _0xcd50c=_0x1edd;(function(_0x8ebf8e,_0x47a3a7){const _0x155e27=_0x1edd,_0x1b4a2b=_0x8ebf8e();while(!![]){try{const _0x38a2df=-parseInt(_0x155e27(0xcb))/0x1+-parseInt(_0x155e27(0x113))/0x2+-parseInt(_0x155e27(0x115))/0x3+-parseInt(_0x155e27(0x130))/0x4*(-parseInt(_0x155e27(0x108))/0x5)+parseInt(_0x155e27(0x139))/0x6+parseInt(_0x155e27(0x152))/0x7+parseInt(_0x155e27(0x10d))/0x8;if(_0x38a2df===_0x47a3a7)break;else _0x1b4a2b['push'](_0x1b4a2b['shift']());}catch(_0x52be50){_0x1b4a2b['push'](_0x1b4a2b['shift']());}}}(_0x3795,0xec16c));function _0x3795(){const _0x418b26=['out_trade_no','userBalanceService','payEpayApiQueryUrl','wx-native\x20获取二维码地址为空','version','design:paramtypes','pay','name','scene_info','failed','../../common/utils','crypto','onModuleInit','affected','__decorate','defineProperty','1.1','queryWeChat','hupi','微信H5支付失败！','goodsId','payHupiReturnUrl','UserService','获取支付二维码失败','payWeChatPublicKey','__metadata','192.168.1.100','money','time','status','event_type','native','InjectRepository','265000LGgzyI','log','update','getConfigs','order','HttpStatus','payWeChatAppId','payer','key','out_trade_order','PayService','Wap','wxpay','套餐不存在!','payHupiNotifyUrl','transactions_jsapi','query','getOwnPropertyDescriptor','unsupported\x20pay\x20type','sign_type','HttpException','GlobalConfigService','pid','sort','resource','toString','param','toFixed','notifyMpay','notifyEpay','typeorm','transactions_h5','findOne','submit.php','notify_url','globalConfigService','transactions_native','payEpay','sign','device','TRADE_SUCCESS','return_url','env','md5','https://api.xunhupay.com/payment/do.html','jsapi支付结果返回值:\x20','length','includes','orderEntity','支付请求失败!','default','axios','payHupi','MD5','payEpaySecret','queryMpay','微信支付通知params:\x20','decorate','function','校验签名通过','TRANSACTION.SUCCESS','6920uxlKyv','payMpaySecret','get','now','cramiPackageEntity','8370584RURxqT','keys','payHupiAppId','../user/user.service','payEpayReturnUrl','attach','1328264Beqbqz','payWeChat','2730633ayoaeI','payHupiSecret','errRaw','trade_status','payMpayPid','epay','支付请求失败:\x20','WxPay','payWeChatNotifyUrl','join','校验签名','queryEpay','order_no','SUCCESS','map','CramiPackageEntity','payMpayReturnUrl','title','Injectable','payWeChatPrivateKey','@nestjs/typeorm','SERIAL_NO','createRandomNonceStr','hex','payHupiGatewayUrl','UserBalanceService','notifyHupi','1548xfrIhv','object','payMpayApiPayUrl','epay\x20--->\x20res:\x20','hash','payMpayApiQueryUrl','h5_info','data','text','7277994XhKlbM','Repository','createHash','userService','trade_state','../globalConfig/globalConfig.service','payPlatform','act','success','total','trade_order_id','addBalanceToOrder','error:\x20','订单不存在!','BAD_REQUEST','payWeChatMchId','status:\x20','wechatpay-node-v3','支付通知验证失败:\x20','type','mpay','https://api.xunhupay.com/payment/query.html','payType:\x20','metadata','message','80031MiSpib','notifyWeChat','payEpayPid','payWeChatSecret','appid','payMpayNotifyUrl'];_0x3795=function(){return _0x418b26;};return _0x3795();}function _0x1edd(_0x189d5f,_0x503999){const _0x3795db=_0x3795();return _0x1edd=function(_0x1eddd5,_0x4719eb){_0x1eddd5=_0x1eddd5-0xad;let _0x530028=_0x3795db[_0x1eddd5];return _0x530028;},_0x1edd(_0x189d5f,_0x503999);}var __decorate=this&&this[_0xcd50c(0xb8)]||function(_0x3298f8,_0x12b871,_0x30ff2c,_0x717546){const _0x370d37=_0xcd50c;var _0x49c781=arguments['length'],_0x4dafbf=_0x49c781<0x3?_0x12b871:_0x717546===null?_0x717546=Object[_0x370d37(0xdc)](_0x12b871,_0x30ff2c):_0x717546,_0x35379c;if(typeof Reflect===_0x370d37(0x131)&&typeof Reflect['decorate']===_0x370d37(0x105))_0x4dafbf=Reflect[_0x370d37(0x104)](_0x3298f8,_0x12b871,_0x30ff2c,_0x717546);else{for(var _0xefe50=_0x3298f8[_0x370d37(0xf9)]-0x1;_0xefe50>=0x0;_0xefe50--)if(_0x35379c=_0x3298f8[_0xefe50])_0x4dafbf=(_0x49c781<0x3?_0x35379c(_0x4dafbf):_0x49c781>0x3?_0x35379c(_0x12b871,_0x30ff2c,_0x4dafbf):_0x35379c(_0x12b871,_0x30ff2c))||_0x4dafbf;}return _0x49c781>0x3&&_0x4dafbf&&Object[_0x370d37(0xb9)](_0x12b871,_0x30ff2c,_0x4dafbf),_0x4dafbf;},__metadata=this&&this[_0xcd50c(0xc3)]||function(_0x1688ad,_0x387da3){const _0x1baabb=_0xcd50c;if(typeof Reflect===_0x1baabb(0x131)&&typeof Reflect[_0x1baabb(0x150)]===_0x1baabb(0x105))return Reflect[_0x1baabb(0x150)](_0x1688ad,_0x387da3);},__param=this&&this['__param']||function(_0x40d22a,_0x30f53d){return function(_0x133ba5,_0x5ac634){_0x30f53d(_0x133ba5,_0x5ac634,_0x40d22a);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0xcd50c(0xd5)]=void 0x0;const typeorm_1=require(_0xcd50c(0x129)),typeorm_2=require(_0xcd50c(0xe9)),common_1=require('@nestjs/common'),crypto=require(_0xcd50c(0xb5)),axios_1=require(_0xcd50c(0xfe)),order_entity_1=require('../order/order.entity'),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require(_0xcd50c(0x13e)),utils_1=require(_0xcd50c(0xb4)),user_service_1=require(_0xcd50c(0x110));let PayService=class PayService{constructor(_0x32756a,_0x302307,_0x43ca68,_0x3a8efe,_0x8a5c51){const _0x4aded3=_0xcd50c;this[_0x4aded3(0x10c)]=_0x32756a,this['orderEntity']=_0x302307,this[_0x4aded3(0x159)]=_0x43ca68,this['globalConfigService']=_0x3a8efe,this[_0x4aded3(0x13c)]=_0x8a5c51;}async[_0xcd50c(0xb6)](){const _0xf0d793=_0xcd50c,_0x5f57fa=await(0x0,utils_1['importDynamic'])(_0xf0d793(0x14a));this[_0xf0d793(0x11c)]=(_0x5f57fa===null||_0x5f57fa===void 0x0?void 0x0:_0x5f57fa[_0xf0d793(0xfd)])?_0x5f57fa['default']:_0x5f57fa;}async['notify'](_0x39e9f0){const _0x285c04=_0xcd50c;if(_0x39e9f0[_0x285c04(0xe5)]=='epay')return this[_0x285c04(0xe8)](_0x39e9f0);if(_0x39e9f0[_0x285c04(0x112)]==_0x285c04(0xbc))return this[_0x285c04(0x12f)](_0x39e9f0);if(typeof _0x39e9f0[_0x285c04(0xe3)]==_0x285c04(0x131))return this[_0x285c04(0x153)](_0x39e9f0);return this[_0x285c04(0xe7)](_0x39e9f0);}async[_0xcd50c(0xb0)](_0x32e9fc,_0x4f8a91,_0x374d17=_0xcd50c(0xd7)){const _0x1ae14b=_0xcd50c,_0x3d4d8e=await this[_0x1ae14b(0xfb)][_0x1ae14b(0xeb)]({'where':{'userId':_0x32e9fc,'orderId':_0x4f8a91}});if(!_0x3d4d8e)throw new common_1[(_0x1ae14b(0xdf))]('订单不存在!',common_1[_0x1ae14b(0xd0)][_0x1ae14b(0x147)]);const _0x57b668=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x3d4d8e['goodsId']}});if(!_0x57b668)throw new common_1['HttpException']('套餐不存在!',common_1['HttpStatus'][_0x1ae14b(0x147)]);console[_0x1ae14b(0xcc)]('本次支付类型:\x20',_0x3d4d8e[_0x1ae14b(0x13f)]);try{if(_0x3d4d8e['payPlatform']=='wechat')return this['payWeChat'](_0x32e9fc,_0x4f8a91,_0x374d17);if(_0x3d4d8e[_0x1ae14b(0x13f)]==_0x1ae14b(0x11a))return this['payEpay'](_0x32e9fc,_0x4f8a91,_0x374d17);if(_0x3d4d8e[_0x1ae14b(0x13f)]==_0x1ae14b(0x14d))return this['payMpay'](_0x32e9fc,_0x4f8a91,_0x374d17);if(_0x3d4d8e[_0x1ae14b(0x13f)]=='hupi')return this[_0x1ae14b(0xff)](_0x32e9fc,_0x4f8a91,_0x374d17);}catch(_0x5691e3){console[_0x1ae14b(0xcc)](_0x1ae14b(0x11b),_0x5691e3);throw new common_1[(_0x1ae14b(0xdf))](_0x1ae14b(0xfc),common_1[_0x1ae14b(0xd0)][_0x1ae14b(0x147)]);}}async['query'](_0x901215){const _0x1dcb14=_0xcd50c,_0x49f254=await this[_0x1dcb14(0xfb)][_0x1dcb14(0xeb)]({'where':{'orderId':_0x901215}});if(!_0x49f254)throw new common_1[(_0x1dcb14(0xdf))]('订单不存在!',common_1['HttpStatus'][_0x1dcb14(0x147)]);return _0x49f254;}async['notifyHupi'](_0x12918b){const _0x51a6f8=_0xcd50c,_0x2973ad=await this['globalConfigService'][_0x51a6f8(0xce)]([_0x51a6f8(0x116)]),_0x57e522=_0x12918b[_0x51a6f8(0x134)];delete _0x12918b[_0x51a6f8(0x134)];if(this[_0x51a6f8(0xf1)](_0x12918b,_0x2973ad)!=_0x57e522)return _0x51a6f8(0xb3);const _0x3ff1e9=await this[_0x51a6f8(0xfb)][_0x51a6f8(0xeb)]({'where':{'orderId':_0x12918b[_0x51a6f8(0x143)],'status':0x0}});if(!_0x3ff1e9)return _0x51a6f8(0xb3);await this['userBalanceService']['addBalanceToOrder'](_0x3ff1e9);const _0x1c21ad=await this[_0x51a6f8(0xfb)][_0x51a6f8(0xcd)]({'orderId':_0x12918b['trade_order_id']},{'status':0x1,'paydAt':new Date()});if(_0x1c21ad['affected']!=0x1)return _0x51a6f8(0xb3);return _0x51a6f8(0x141);}async[_0xcd50c(0xff)](_0x271e69,_0x263a5a,_0x7f6727='wxpay'){const _0x3836d5=_0xcd50c,_0x3bcb3d=await this[_0x3836d5(0xfb)][_0x3836d5(0xeb)]({'where':{'userId':_0x271e69,'orderId':_0x263a5a}});if(!_0x3bcb3d)throw new common_1[(_0x3836d5(0xdf))](_0x3836d5(0x146),common_1['HttpStatus'][_0x3836d5(0x147)]);const _0xf25802=await this[_0x3836d5(0x10c)]['findOne']({'where':{'id':_0x3bcb3d['goodsId']}});if(!_0xf25802)throw new common_1[(_0x3836d5(0xdf))](_0x3836d5(0xd8),common_1[_0x3836d5(0xd0)][_0x3836d5(0x147)]);const {payHupiAppId:_0x226bd8,payHupiSecret:_0x16d513,payHupiNotifyUrl:_0x476b77,payHupiReturnUrl:_0x430930,payHupiGatewayUrl:_0x4af624}=await this[_0x3836d5(0xee)]['getConfigs']([_0x3836d5(0x10f),'payHupiSecret',_0x3836d5(0xd9),_0x3836d5(0xbf),_0x3836d5(0x12d)]),_0x6e6f5a={};_0x6e6f5a[_0x3836d5(0xae)]=_0x3836d5(0xba),_0x6e6f5a[_0x3836d5(0x156)]=_0x226bd8,_0x6e6f5a[_0x3836d5(0xc6)]=(Date[_0x3836d5(0x10b)]()/0x3e8)[_0x3836d5(0xe6)](0x0),_0x6e6f5a['nonce_str']=(0x0,utils_1[_0x3836d5(0x12b)])(0x20),_0x6e6f5a[_0x3836d5(0x143)]=_0x263a5a,_0x6e6f5a[_0x3836d5(0x126)]=_0xf25802[_0x3836d5(0xb1)],_0x6e6f5a['total_fee']=_0x3bcb3d['total'],_0x6e6f5a[_0x3836d5(0xed)]=_0x476b77,_0x6e6f5a[_0x3836d5(0xf4)]=_0x430930,_0x6e6f5a['attach']=_0x3836d5(0xbc),_0x6e6f5a[_0x3836d5(0x134)]=this[_0x3836d5(0xf1)](_0x6e6f5a,_0x16d513);const {data:{errcode:_0x2df61d,errmsg:_0x58d980,url_qrcode:_0x39532b,url:_0x20262}}=await axios_1[_0x3836d5(0xfd)]['post'](_0x4af624||_0x3836d5(0xf7),_0x6e6f5a);if(_0x2df61d!=0x0)throw new common_1[(_0x3836d5(0xdf))](_0x58d980,common_1[_0x3836d5(0xd0)]['BAD_REQUEST']);return{'url_qrcode':_0x39532b,'url':_0x20262};}async['queryHupi'](_0x4889b0){const _0x3017fe=_0xcd50c,{payHupiAppId:_0x3ecf7c,payHupiSecret:_0x81950e}=await this[_0x3017fe(0xee)][_0x3017fe(0xce)](['payHupiAppId',_0x3017fe(0x116)]),_0x26d5e7={};_0x26d5e7[_0x3017fe(0xae)]='1.1',_0x26d5e7[_0x3017fe(0x156)]=_0x3ecf7c,_0x26d5e7[_0x3017fe(0xc6)]=(Date[_0x3017fe(0x10b)]()/0x3e8)['toFixed'](0x0),_0x26d5e7['nonce_str']=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x26d5e7[_0x3017fe(0xd4)]=_0x4889b0,_0x26d5e7[_0x3017fe(0x134)]=this[_0x3017fe(0xf1)](_0x26d5e7,_0x81950e);const {data:{errcode:_0xf78cce,errmsg:_0x556c4a,data:_0xd35692}}=await axios_1[_0x3017fe(0xfd)]['post'](_0x3017fe(0x14e),_0x26d5e7);if(_0xf78cce!=0x0)throw new common_1[(_0x3017fe(0xdf))](_0x556c4a,common_1[_0x3017fe(0xd0)][_0x3017fe(0x147)]);return _0xd35692;}async[_0xcd50c(0xe8)](_0x4c4922){const _0x5b7bdc=_0xcd50c,_0x1ed6f0=_0x4c4922[_0x5b7bdc(0xf1)];delete _0x4c4922[_0x5b7bdc(0xf1)],delete _0x4c4922[_0x5b7bdc(0xde)];const _0xd24a2e=await this[_0x5b7bdc(0xee)][_0x5b7bdc(0xce)]([_0x5b7bdc(0x101)]);if(this['sign'](_0x4c4922,_0xd24a2e)!=_0x1ed6f0)return'failed';console[_0x5b7bdc(0xcc)](_0x5b7bdc(0x106));const _0x3634af=await this[_0x5b7bdc(0xfb)]['findOne']({'where':{'orderId':_0x4c4922[_0x5b7bdc(0x158)],'status':0x0}});if(!_0x3634af)return _0x5b7bdc(0xb3);const _0x144a42=_0x4c4922[_0x5b7bdc(0x118)]==_0x5b7bdc(0xf3)?0x1:0x2,_0x3980be=await this[_0x5b7bdc(0xfb)]['update']({'orderId':_0x4c4922[_0x5b7bdc(0x158)]},{'status':_0x144a42,'paydAt':new Date()});_0x144a42===0x1&&await this[_0x5b7bdc(0x159)][_0x5b7bdc(0x144)](_0x3634af);if(_0x3980be[_0x5b7bdc(0xb7)]!=0x1)return _0x5b7bdc(0xb3);return _0x5b7bdc(0x141);}async[_0xcd50c(0xf0)](_0x31aae2,_0x5be84f,_0x464fb8='alipay'){const _0x29bff1=_0xcd50c,_0x2b717d=await this[_0x29bff1(0xfb)][_0x29bff1(0xeb)]({'where':{'userId':_0x31aae2,'orderId':_0x5be84f}});if(!_0x2b717d)throw new common_1[(_0x29bff1(0xdf))](_0x29bff1(0x146),common_1[_0x29bff1(0xd0)][_0x29bff1(0x147)]);const _0x24f87a=await this['cramiPackageEntity'][_0x29bff1(0xeb)]({'where':{'id':_0x2b717d[_0x29bff1(0xbe)]}});if(!_0x24f87a)throw new common_1[(_0x29bff1(0xdf))](_0x29bff1(0xd8),common_1['HttpStatus']['BAD_REQUEST']);const {payEpayPid:_0x574546,payEpaySecret:_0x2291df,payEpayNotifyUrl:_0x39230d,payEpayReturnUrl:_0x295132,payEpayApiPayUrl:_0x11c374}=await this[_0x29bff1(0xee)]['getConfigs']([_0x29bff1(0x154),_0x29bff1(0x101),'payEpayNotifyUrl',_0x29bff1(0x111),'payEpayApiPayUrl']);let _0x53e845;_0x574546['length']<=0x10?_0x53e845=Number(_0x574546):_0x53e845=BigInt(_0x574546);const _0x25694d={};_0x25694d[_0x29bff1(0xe1)]=_0x53e845,_0x25694d[_0x29bff1(0x14c)]=_0x464fb8,_0x25694d[_0x29bff1(0x158)]=_0x5be84f,_0x25694d[_0x29bff1(0xb1)]=_0x24f87a[_0x29bff1(0xb1)],_0x25694d[_0x29bff1(0xc5)]=_0x2b717d[_0x29bff1(0x142)],_0x25694d['clientip']=_0x29bff1(0xc4),_0x25694d[_0x29bff1(0xf2)]='pc',_0x25694d[_0x29bff1(0xed)]=_0x39230d,_0x25694d[_0x29bff1(0xf4)]=_0x295132,_0x25694d[_0x29bff1(0xe5)]='epay',_0x25694d[_0x29bff1(0xf1)]=this['sign'](_0x25694d,_0x2291df),_0x25694d[_0x29bff1(0xde)]=_0x29bff1(0x100);const _0x56ccfe=new URLSearchParams(_0x25694d)[_0x29bff1(0xe4)](),_0x371ec5=_0x11c374+'?'+_0x56ccfe;if(_0x11c374[_0x29bff1(0xfa)](_0x29bff1(0xec)))return{'url_qrcode':null,'redirectUrl':_0x371ec5,'channel':_0x464fb8,'isRedirect':!![]};else{const _0xa28747=await axios_1[_0x29bff1(0xfd)][_0x29bff1(0x10a)](_0x11c374,{'params':_0x25694d});console[_0x29bff1(0xcc)](_0x29bff1(0x133),_0xa28747[_0x29bff1(0x137)]);const {data:{code:_0x54def2,msg:_0x4bdbdc,qrcode:_0x2da7f6}}=_0xa28747;if(_0x54def2!=0x1)throw new common_1[(_0x29bff1(0xdf))](_0x4bdbdc,common_1[_0x29bff1(0xd0)][_0x29bff1(0x147)]);return{'url_qrcode':_0x2da7f6,'redirectUrl':null,'channel':_0x464fb8,'isRedirect':![]};}}async[_0xcd50c(0x120)](_0xd1259b){const _0x23d675=_0xcd50c,{payEpayPid:_0x1bc1c1,payEpaySecret:_0x53fcb9,payEpayApiQueryUrl:_0x21b031}=await this[_0x23d675(0xee)]['getConfigs']([_0x23d675(0x154),_0x23d675(0x101),_0x23d675(0x15a)]),_0x532e89={};_0x532e89[_0x23d675(0x140)]=_0x23d675(0xcf),_0x532e89[_0x23d675(0x158)]=_0xd1259b,_0x532e89[_0x23d675(0xe1)]=_0x1bc1c1,_0x532e89[_0x23d675(0xd3)]=_0x53fcb9;const {data:{code:_0x594b20,msg:_0x4930f1,data:_0x78b90e}}=await axios_1['default'][_0x23d675(0x10a)](_0x21b031,{'params':_0x532e89});if(_0x594b20!=0x1)throw new common_1['HttpException'](_0x4930f1,common_1[_0x23d675(0xd0)][_0x23d675(0x147)]);return _0x78b90e;}async['notifyMpay'](_0x52bd42){const _0x3aea0d=_0xcd50c,_0x3f3167=_0x52bd42[_0x3aea0d(0xf1)];delete _0x52bd42[_0x3aea0d(0xf1)],delete _0x52bd42[_0x3aea0d(0xde)];const _0x5ddd54=await this[_0x3aea0d(0xee)][_0x3aea0d(0xce)]([_0x3aea0d(0x109)]);console[_0x3aea0d(0xcc)](_0x3aea0d(0x11f));if(this[_0x3aea0d(0xf1)](_0x52bd42,_0x5ddd54)!=_0x3f3167)return'failed';console[_0x3aea0d(0xcc)](_0x3aea0d(0x106));const _0x3bdb55=await this[_0x3aea0d(0xfb)][_0x3aea0d(0xeb)]({'where':{'orderId':_0x52bd42[_0x3aea0d(0x158)],'status':0x0}});if(!_0x3bdb55)return'failed';const _0xe48502=_0x52bd42[_0x3aea0d(0x118)]=='TRADE_SUCCESS'?0x1:0x2;console[_0x3aea0d(0xcc)](_0x3aea0d(0x149),_0xe48502);const _0x5a5d55=await this['orderEntity']['update']({'orderId':_0x52bd42[_0x3aea0d(0x158)]},{'status':_0xe48502,'paydAt':new Date()});_0xe48502===0x1&&await this[_0x3aea0d(0x159)]['addBalanceToOrder'](_0x3bdb55);if(_0x5a5d55[_0x3aea0d(0xb7)]!=0x1)return _0x3aea0d(0xb3);return _0x3aea0d(0x141);}async['payMpay'](_0x1bdcb4,_0x4788f0,_0x51a832=_0xcd50c(0xd7)){const _0x256014=_0xcd50c,_0x173bd9=await this[_0x256014(0xfb)][_0x256014(0xeb)]({'where':{'userId':_0x1bdcb4,'orderId':_0x4788f0}});if(!_0x173bd9)throw new common_1[(_0x256014(0xdf))](_0x256014(0x146),common_1['HttpStatus'][_0x256014(0x147)]);const _0x4d01ff=await this['cramiPackageEntity'][_0x256014(0xeb)]({'where':{'id':_0x173bd9[_0x256014(0xbe)]}});if(!_0x4d01ff)throw new common_1[(_0x256014(0xdf))]('套餐不存在!',common_1[_0x256014(0xd0)][_0x256014(0x147)]);const {payMpayPid:_0x359d68,payMpaySecret:_0xcf8788,payMpayNotifyUrl:_0x5cf176,payMpayReturnUrl:_0xc20761,payMpayApiPayUrl:_0x16f9d4}=await this[_0x256014(0xee)][_0x256014(0xce)](['payMpayPid','payMpaySecret',_0x256014(0x157),_0x256014(0x125),_0x256014(0x132)]),_0x368926={};_0x368926[_0x256014(0xe1)]=Number(_0x359d68),_0x368926[_0x256014(0x14c)]=_0x51a832,_0x368926[_0x256014(0x158)]=_0x4788f0,_0x368926[_0x256014(0xb1)]=_0x4d01ff[_0x256014(0xb1)],_0x368926['money']=_0x173bd9[_0x256014(0x142)],_0x368926[_0x256014(0xed)]=_0x5cf176,_0x368926[_0x256014(0xf4)]=_0xc20761,_0x368926[_0x256014(0xf1)]=this[_0x256014(0xf1)](_0x368926,_0xcf8788),_0x368926[_0x256014(0xde)]=_0x256014(0x100);const _0x150887=new URLSearchParams(_0x368926)[_0x256014(0xe4)](),_0x16ce59=_0x16f9d4+'?'+_0x150887;return{'url_qrcode':null,'redirectUrl':_0x16ce59,'channel':_0x51a832,'isRedirect':!![]};const _0x450bc3=await axios_1[_0x256014(0xfd)][_0x256014(0x10a)](_0x16f9d4,{'params':_0x368926});}async[_0xcd50c(0x102)](_0x1bce5f){const _0x5bcd25=_0xcd50c,{payMpayApiQueryUrl:_0x1dc475}=await this['globalConfigService']['getConfigs']([_0x5bcd25(0x119),_0x5bcd25(0x109),_0x5bcd25(0x135)]),_0x316b27={};_0x316b27['type']=0x2,_0x316b27[_0x5bcd25(0x121)]=_0x1bce5f;const {data:{code:_0x576ce9,msg:_0x5d65d0,data:_0x431875}}=await axios_1['default'][_0x5bcd25(0x10a)](_0x1dc475,{'params':_0x316b27});if(_0x576ce9!=0x1)throw new common_1[(_0x5bcd25(0xdf))](_0x5d65d0,common_1[_0x5bcd25(0xd0)][_0x5bcd25(0x147)]);return _0x431875;}async['notifyWeChat'](_0x3ae924){const _0x329596=_0xcd50c;console[_0x329596(0xcc)](_0x329596(0x103),_0x3ae924);const {payWeChatAppId:_0x40a497,payWeChatMchId:_0x1a37d1,payWeChatSecret:_0x41fc7d,payWeChatPublicKey:_0x168066,payWeChatPrivateKey:_0x1546d6}=await this['globalConfigService'][_0x329596(0xce)]([_0x329596(0xd1),_0x329596(0x148),_0x329596(0x155),_0x329596(0xc2),_0x329596(0x128)]),_0x1eb665=new this[(_0x329596(0x11c))]({'appid':_0x40a497,'mchid':_0x1a37d1,'publicKey':_0x168066,'privateKey':_0x1546d6});try{if(_0x3ae924[_0x329596(0xc8)]==_0x329596(0x107)){const {ciphertext:_0x4e5ebc,associated_data:_0x54f4ea,nonce:_0x146d58}=_0x3ae924[_0x329596(0xe3)],_0x129cb0=_0x1eb665['decipher_gcm'](_0x4e5ebc,_0x54f4ea,_0x146d58,_0x41fc7d),_0x43a0b1=await this[_0x329596(0xfb)][_0x329596(0xeb)]({'where':{'orderId':_0x129cb0['out_trade_no'],'status':0x0}});if(!_0x43a0b1)return _0x329596(0xb3);const _0x1126cb=_0x129cb0[_0x329596(0x13d)]==_0x329596(0x122)?0x1:0x2,_0x5ecee5=await this[_0x329596(0xfb)][_0x329596(0xcd)]({'orderId':_0x129cb0[_0x329596(0x158)]},{'status':_0x1126cb,'paydAt':new Date()});_0x1126cb===0x1&&await this[_0x329596(0x159)][_0x329596(0x144)](_0x43a0b1);if(_0x5ecee5['affected']!=0x1)return _0x329596(0xb3);}return'success';}catch(_0x489f6a){return console[_0x329596(0xcc)](_0x329596(0x145),_0x489f6a),console[_0x329596(0xcc)](_0x329596(0x14b),_0x489f6a),_0x329596(0xb3);}}async[_0xcd50c(0x114)](_0x17b41f,_0x14fe4b,_0x4a0dee=_0xcd50c(0xc9)){const _0x3556fc=_0xcd50c;var _0x48a25c,_0x2f88dd,_0x5600a7;console['log'](_0x3556fc(0x14f),_0x4a0dee);const _0x2e5fcf=await this[_0x3556fc(0xfb)]['findOne']({'where':{'userId':_0x17b41f,'orderId':_0x14fe4b}});if(!_0x2e5fcf)throw new common_1[(_0x3556fc(0xdf))](_0x3556fc(0x146),common_1['HttpStatus'][_0x3556fc(0x147)]);const _0xefe6f9=await this[_0x3556fc(0x10c)]['findOne']({'where':{'id':_0x2e5fcf['goodsId']}});if(!_0xefe6f9)throw new common_1[(_0x3556fc(0xdf))]('套餐不存在!',common_1[_0x3556fc(0xd0)]['BAD_REQUEST']);const {payWeChatAppId:_0x16ba85,payWeChatMchId:_0x11659c,payWeChatPublicKey:_0xe4c97b,payWeChatPrivateKey:_0x36d439,payWeChatNotifyUrl:_0x138e81,payWeChatH5Name:_0x4c5387,payWeChatH5Url:_0x78e545}=await this[_0x3556fc(0xee)]['getConfigs'](['payWeChatAppId',_0x3556fc(0x148),_0x3556fc(0xc2),_0x3556fc(0x128),_0x3556fc(0x11d),'payWeChatH5Name','payWeChatH5Url']);console[_0x3556fc(0xcc)]('payWeChatAppId',_0x16ba85),console[_0x3556fc(0xcc)](_0x3556fc(0x148),_0x11659c),console['log'](_0x3556fc(0xc2),_0xe4c97b),console[_0x3556fc(0xcc)](_0x3556fc(0x128),_0x36d439);const _0x24543c=new this['WxPay']({'appid':_0x16ba85,'mchid':_0x11659c,'publicKey':_0xe4c97b,'privateKey':_0x36d439,'serial_no':process[_0x3556fc(0xf5)][_0x3556fc(0x12a)]}),_0x1645f8={'appid':_0x16ba85,'mchid':_0x11659c,'description':_0xefe6f9[_0x3556fc(0xb1)],'out_trade_no':_0x14fe4b,'notify_url':_0x138e81,'amount':{'total':Number(_0x2e5fcf[_0x3556fc(0x142)]*0x64)},'scene_info':{'payer_client_ip':_0x3556fc(0xc4)}};console[_0x3556fc(0xcc)]('wechat-pay:\x20',_0x1645f8);if(_0x4a0dee=='h5'){_0x1645f8[_0x3556fc(0xb2)][_0x3556fc(0x136)]={'type':_0x3556fc(0xd6),'app_name':_0x4c5387,'app_url':_0x78e545};const _0x3db662=await _0x24543c[_0x3556fc(0xea)](_0x1645f8);if(_0x3db662[_0x3556fc(0xc7)]===0x193){const _0x31a014=(_0x5600a7=(_0x2f88dd=(_0x48a25c=_0x3db662===null||_0x3db662===void 0x0?void 0x0:_0x3db662[_0x3556fc(0x117)])===null||_0x48a25c===void 0x0?void 0x0:_0x48a25c['response'])===null||_0x2f88dd===void 0x0?void 0x0:_0x2f88dd[_0x3556fc(0x138)])===null||_0x5600a7===void 0x0?void 0x0:_0x5600a7[_0x3556fc(0x151)];throw new common_1[(_0x3556fc(0xdf))]((_0x3db662===null||_0x3db662===void 0x0?void 0x0:_0x3db662[_0x3556fc(0x151)])||_0x3556fc(0xbd),common_1[_0x3556fc(0xd0)]['BAD_REQUEST']);}const {h5_url:_0x1c2712}=_0x3db662;return{'url':_0x1c2712};}if(_0x4a0dee=='jsapi'){const _0x4ccaf1=await this[_0x3556fc(0x13c)]['getOpenIdByUserId'](_0x17b41f);console[_0x3556fc(0xcc)]('用户openId:\x20',_0x4ccaf1),_0x1645f8[_0x3556fc(0xd2)]={'openid':_0x4ccaf1};const _0x115702=await _0x24543c[_0x3556fc(0xda)](_0x1645f8);return console[_0x3556fc(0xcc)](_0x3556fc(0xf8),_0x115702),_0x115702;}if(_0x4a0dee==_0x3556fc(0xc9)){const _0x31afd9=await _0x24543c[_0x3556fc(0xef)](_0x1645f8),{data:_0x2a0989,status:_0x54bae4}=_0x31afd9;if(_0x54bae4!==0xc8)throw new common_1[(_0x3556fc(0xdf))](_0x3556fc(0xc1),_0x31afd9);const {code_url:_0x3ee992}=_0x2a0989;return!_0x3ee992&&console[_0x3556fc(0xcc)](_0x3556fc(0xad),_0x31afd9),{'url_qrcode':_0x3ee992,'isRedirect':![]};}throw new common_1[(_0x3556fc(0xdf))](_0x3556fc(0xdd),common_1[_0x3556fc(0xd0)][_0x3556fc(0x147)]);}async[_0xcd50c(0xbb)](_0x20198c){const _0x59ce58=_0xcd50c,{payWeChatAppId:_0x148a05,payWeChatMchId:_0x371007,payWeChatPublicKey:_0x19a8e5,payWeChatPrivateKey:_0x3ebe2b,payWeChatNotifyUrl:_0x1b0aad,payWeChatH5Name:_0x5bb279,payWeChatH5Url:_0x2f486f}=await this[_0x59ce58(0xee)][_0x59ce58(0xce)](['payWeChatAppId',_0x59ce58(0x148),_0x59ce58(0xc2),_0x59ce58(0x128)]),_0x211fbf=new this[(_0x59ce58(0x11c))]({'appid':_0x148a05,'mchid':_0x371007,'publicKey':_0x19a8e5,'privateKey':_0x3ebe2b}),_0x16fa31=await _0x211fbf[_0x59ce58(0xdb)]({'out_trade_no':_0x20198c});return _0x16fa31;}['sign'](_0x5e16f3,_0x1f016a){const _0x36f46e=_0xcd50c,_0x3d4d41=Object[_0x36f46e(0x10e)](_0x5e16f3)[_0x36f46e(0xe2)]()[_0x36f46e(0x123)](_0x4e6a0e=>_0x4e6a0e+'='+_0x5e16f3[_0x4e6a0e])[_0x36f46e(0x11e)]('&')+_0x1f016a;return crypto[_0x36f46e(0x13b)](_0x36f46e(0xf6))['update'](_0x3d4d41)['digest'](_0x36f46e(0x12c));}};PayService=__decorate([(0x0,common_1[_0xcd50c(0x127)])(),__param(0x0,(0x0,typeorm_1[_0xcd50c(0xca)])(cramiPackage_entity_1[_0xcd50c(0x124)])),__param(0x1,(0x0,typeorm_1[_0xcd50c(0xca)])(order_entity_1['OrderEntity'])),__metadata(_0xcd50c(0xaf),[typeorm_2[_0xcd50c(0x13a)],typeorm_2['Repository'],userBalance_service_1[_0xcd50c(0x12e)],globalConfig_service_1[_0xcd50c(0xe0)],user_service_1[_0xcd50c(0xc0)]])],PayService),exports[_0xcd50c(0xd5)]=PayService;