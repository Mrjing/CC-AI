'use strict';const _0x42da19=_0xda7f;function _0x455b(){const _0x276de9=['payHupiSecret','https://api.xunhupay.com/payment/query.html','payEpaySecret','SERIAL_NO','notifyHupi','套餐不存在!','HttpStatus','payEpayReturnUrl','payHupiReturnUrl','map','axios','money','1670gNUolz','text','errRaw','UserService','native','status:\x20','TRADE_SUCCESS','10622910TSoajc','orderEntity','sign_type','data','SUCCESS','wx-native\x20获取二维码地址为空','notifyWeChat','../order/order.entity','BAD_REQUEST','event_type','update','total_fee','queryWeChat','payEpayApiQueryUrl','get','message','payMpayPid','CramiPackageEntity','alipay','payMpayReturnUrl','payPlatform','payMpayApiQueryUrl','out_trade_order','affected','log','epay\x20--->\x20res:\x20','device','queryMpay','now','wxpay','192.168.1.100','本次支付类型:\x20','crypto','../crami/cramiPackage.entity','payWeChatPublicKey','校验签名','addBalanceToOrder','wechat','sign','object','校验签名通过','error:\x20','transactions_h5','function','notify_url','notify','hash','notifyMpay','payHupiGatewayUrl','default','TRANSACTION.SUCCESS','WxPay','toFixed','payEpayApiPayUrl','pay','payWeChat','transactions_native','payWeChatMchId','userService','importDynamic','trade_status','支付通知验证失败:\x20','defineProperty','getConfigs','payMpay','globalConfigService','176184eKBzJD','12108YqBloT','getOpenIdByUserId','__metadata','version','trade_order_id','Repository','../user/user.service','goodsId','GlobalConfigService','payEpay','__decorate','order_no','HttpException','171063ysqEge','获取支付二维码失败','notifyEpay','attach','join','out_trade_no','param','payMpayNotifyUrl','transactions_jsapi','metadata','@nestjs/typeorm','payMpaySecret','onModuleInit','type','pid','query','2348688TIGeHy','payWeChatPrivateKey','支付请求失败!','jsapi','design:paramtypes','支付请求失败:\x20','wechat-pay:\x20','length','payType:\x20','decorate','userBalanceService','typeorm','findOne','submit.php','__esModule','unsupported\x20pay\x20type','MD5','env','post','../../common/utils','appid','status','payHupiAppId','success','1.1','epay','resource','nonce_str','12LclEEC','payEpayNotifyUrl','total','mpay','payHupi','@nestjs/common','28FELPAN','cramiPackageEntity','UserBalanceService','OrderEntity','payMpayApiPayUrl','InjectRepository','payWeChatAppId','scene_info','payEpayPid','hex','return_url','md5','name','payHupiNotifyUrl','keys','payWeChatNotifyUrl','h5_info','用户openId:\x20','decipher_gcm','订单不存在!','1421326ZadrJv','clientip','getOwnPropertyDescriptor','order','toString','failed','jsapi支付结果返回值:\x20','hupi','PayService','2257910NITVeO','createRandomNonceStr'];_0x455b=function(){return _0x276de9;};return _0x455b();}(function(_0x1a65eb,_0x491db5){const _0x2a44ed=_0xda7f,_0x13e03f=_0x1a65eb();while(!![]){try{const _0x91b6b2=parseInt(_0x2a44ed(0x1d2))/0x1+-parseInt(_0x2a44ed(0x233))/0x2+parseInt(_0x2a44ed(0x232))/0x3*(parseInt(_0x2a44ed(0x1b8))/0x4)+-parseInt(_0x2a44ed(0x1db))/0x5+parseInt(_0x2a44ed(0x1f0))/0x6+parseInt(_0x2a44ed(0x1be))/0x7*(parseInt(_0x2a44ed(0x250))/0x8)+parseInt(_0x2a44ed(0x240))/0x9*(-parseInt(_0x2a44ed(0x1e9))/0xa);if(_0x91b6b2===_0x491db5)break;else _0x13e03f['push'](_0x13e03f['shift']());}catch(_0x198463){_0x13e03f['push'](_0x13e03f['shift']());}}}(_0x455b,0xde4c6));var __decorate=this&&this[_0x42da19(0x23d)]||function(_0x11724a,_0x32076b,_0xe02f5d,_0x2cfbc3){const _0x425053=_0x42da19;var _0x5b096b=arguments[_0x425053(0x257)],_0x30ac60=_0x5b096b<0x3?_0x32076b:_0x2cfbc3===null?_0x2cfbc3=Object[_0x425053(0x1d4)](_0x32076b,_0xe02f5d):_0x2cfbc3,_0x2cbe2d;if(typeof Reflect===_0x425053(0x217)&&typeof Reflect['decorate']===_0x425053(0x21b))_0x30ac60=Reflect[_0x425053(0x259)](_0x11724a,_0x32076b,_0xe02f5d,_0x2cfbc3);else{for(var _0x303b1d=_0x11724a[_0x425053(0x257)]-0x1;_0x303b1d>=0x0;_0x303b1d--)if(_0x2cbe2d=_0x11724a[_0x303b1d])_0x30ac60=(_0x5b096b<0x3?_0x2cbe2d(_0x30ac60):_0x5b096b>0x3?_0x2cbe2d(_0x32076b,_0xe02f5d,_0x30ac60):_0x2cbe2d(_0x32076b,_0xe02f5d))||_0x30ac60;}return _0x5b096b>0x3&&_0x30ac60&&Object[_0x425053(0x22e)](_0x32076b,_0xe02f5d,_0x30ac60),_0x30ac60;},__metadata=this&&this[_0x42da19(0x235)]||function(_0x454a5b,_0x2e0666){const _0x17d4a2=_0x42da19;if(typeof Reflect===_0x17d4a2(0x217)&&typeof Reflect[_0x17d4a2(0x249)]===_0x17d4a2(0x21b))return Reflect[_0x17d4a2(0x249)](_0x454a5b,_0x2e0666);},__param=this&&this['__param']||function(_0x4da174,_0x3a45ea){return function(_0x121923,_0xc23c29){_0x3a45ea(_0x121923,_0xc23c29,_0x4da174);};};Object[_0x42da19(0x22e)](exports,_0x42da19(0x25e),{'value':!![]}),exports[_0x42da19(0x1da)]=void 0x0;const typeorm_1=require(_0x42da19(0x24a)),typeorm_2=require(_0x42da19(0x25b)),common_1=require(_0x42da19(0x1bd)),crypto=require(_0x42da19(0x210)),axios_1=require(_0x42da19(0x1e7)),order_entity_1=require(_0x42da19(0x1f7)),cramiPackage_entity_1=require(_0x42da19(0x211)),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require('../globalConfig/globalConfig.service'),utils_1=require(_0x42da19(0x263)),user_service_1=require(_0x42da19(0x239));function _0xda7f(_0x5ab49d,_0x3f79b4){const _0x455b75=_0x455b();return _0xda7f=function(_0xda7f3d,_0x138fe3){_0xda7f3d=_0xda7f3d-0x1b5;let _0x1e41b7=_0x455b75[_0xda7f3d];return _0x1e41b7;},_0xda7f(_0x5ab49d,_0x3f79b4);}let PayService=class PayService{constructor(_0x43e4cf,_0x5f0cac,_0x13c808,_0x4bca8c,_0x3e0fcb){const _0x5d918=_0x42da19;this[_0x5d918(0x1bf)]=_0x43e4cf,this[_0x5d918(0x1f1)]=_0x5f0cac,this[_0x5d918(0x25a)]=_0x13c808,this[_0x5d918(0x231)]=_0x4bca8c,this[_0x5d918(0x22a)]=_0x3e0fcb;}async[_0x42da19(0x24c)](){const _0x5b4298=_0x42da19,_0x3155cc=await(0x0,utils_1[_0x5b4298(0x22b)])('wechatpay-node-v3');this[_0x5b4298(0x223)]=(_0x3155cc===null||_0x3155cc===void 0x0?void 0x0:_0x3155cc[_0x5b4298(0x221)])?_0x3155cc[_0x5b4298(0x221)]:_0x3155cc;}async[_0x42da19(0x21d)](_0x2b3cd5){const _0x5f5d8e=_0x42da19;if(_0x2b3cd5[_0x5f5d8e(0x246)]==_0x5f5d8e(0x1b5))return this['notifyEpay'](_0x2b3cd5);if(_0x2b3cd5[_0x5f5d8e(0x243)]==_0x5f5d8e(0x1d9))return this[_0x5f5d8e(0x1e1)](_0x2b3cd5);if(typeof _0x2b3cd5[_0x5f5d8e(0x1b6)]==_0x5f5d8e(0x217))return this[_0x5f5d8e(0x1f6)](_0x2b3cd5);return this[_0x5f5d8e(0x21f)](_0x2b3cd5);}async[_0x42da19(0x226)](_0x431c4b,_0x4d49e7,_0x1df0e8=_0x42da19(0x20d)){const _0x9ff7d9=_0x42da19,_0x1de317=await this['orderEntity'][_0x9ff7d9(0x25c)]({'where':{'userId':_0x431c4b,'orderId':_0x4d49e7}});if(!_0x1de317)throw new common_1[(_0x9ff7d9(0x23f))]('订单不存在!',common_1[_0x9ff7d9(0x1e3)][_0x9ff7d9(0x1f8)]);const _0x1844fc=await this['cramiPackageEntity'][_0x9ff7d9(0x25c)]({'where':{'id':_0x1de317[_0x9ff7d9(0x23a)]}});if(!_0x1844fc)throw new common_1[(_0x9ff7d9(0x23f))](_0x9ff7d9(0x1e2),common_1[_0x9ff7d9(0x1e3)]['BAD_REQUEST']);console['log'](_0x9ff7d9(0x20f),_0x1de317[_0x9ff7d9(0x204)]);try{if(_0x1de317[_0x9ff7d9(0x204)]==_0x9ff7d9(0x215))return this['payWeChat'](_0x431c4b,_0x4d49e7,_0x1df0e8);if(_0x1de317[_0x9ff7d9(0x204)]==_0x9ff7d9(0x1b5))return this[_0x9ff7d9(0x23c)](_0x431c4b,_0x4d49e7,_0x1df0e8);if(_0x1de317[_0x9ff7d9(0x204)]==_0x9ff7d9(0x1bb))return this['payMpay'](_0x431c4b,_0x4d49e7,_0x1df0e8);if(_0x1de317[_0x9ff7d9(0x204)]==_0x9ff7d9(0x1d9))return this['payHupi'](_0x431c4b,_0x4d49e7,_0x1df0e8);}catch(_0x3acc52){console[_0x9ff7d9(0x208)](_0x9ff7d9(0x255),_0x3acc52);throw new common_1['HttpException'](_0x9ff7d9(0x252),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x42da19(0x24f)](_0x1a4e26){const _0x26404e=_0x42da19,_0x32eee6=await this[_0x26404e(0x1f1)][_0x26404e(0x25c)]({'where':{'orderId':_0x1a4e26}});if(!_0x32eee6)throw new common_1['HttpException'](_0x26404e(0x1d1),common_1['HttpStatus'][_0x26404e(0x1f8)]);return _0x32eee6;}async[_0x42da19(0x1e1)](_0x2bf067){const _0x5c5de9=_0x42da19,_0x441663=await this[_0x5c5de9(0x231)][_0x5c5de9(0x22f)]([_0x5c5de9(0x1dd)]),_0x4e5dad=_0x2bf067[_0x5c5de9(0x21e)];delete _0x2bf067['hash'];if(this['sign'](_0x2bf067,_0x441663)!=_0x4e5dad)return _0x5c5de9(0x1d7);const _0x2a3296=await this[_0x5c5de9(0x1f1)][_0x5c5de9(0x25c)]({'where':{'orderId':_0x2bf067[_0x5c5de9(0x237)],'status':0x0}});if(!_0x2a3296)return _0x5c5de9(0x1d7);await this['userBalanceService'][_0x5c5de9(0x214)](_0x2a3296);const _0x257c49=await this['orderEntity'][_0x5c5de9(0x1fa)]({'orderId':_0x2bf067['trade_order_id']},{'status':0x1,'paydAt':new Date()});if(_0x257c49['affected']!=0x1)return'failed';return'success';}async[_0x42da19(0x1bc)](_0xf6ef7f,_0x25fcf5,_0x21c059=_0x42da19(0x20d)){const _0x53164a=_0x42da19,_0x40b965=await this[_0x53164a(0x1f1)]['findOne']({'where':{'userId':_0xf6ef7f,'orderId':_0x25fcf5}});if(!_0x40b965)throw new common_1['HttpException'](_0x53164a(0x1d1),common_1[_0x53164a(0x1e3)]['BAD_REQUEST']);const _0x587832=await this[_0x53164a(0x1bf)][_0x53164a(0x25c)]({'where':{'id':_0x40b965['goodsId']}});if(!_0x587832)throw new common_1['HttpException']('套餐不存在!',common_1[_0x53164a(0x1e3)]['BAD_REQUEST']);const {payHupiAppId:_0x495fc4,payHupiSecret:_0x2f79a4,payHupiNotifyUrl:_0x2d4529,payHupiReturnUrl:_0x29979d,payHupiGatewayUrl:_0x1aac4a}=await this[_0x53164a(0x231)][_0x53164a(0x22f)](['payHupiAppId',_0x53164a(0x1dd),_0x53164a(0x1cb),_0x53164a(0x1e5),_0x53164a(0x220)]),_0x5ebbae={};_0x5ebbae[_0x53164a(0x236)]='1.1',_0x5ebbae['appid']=_0x495fc4,_0x5ebbae['time']=(Date[_0x53164a(0x20c)]()/0x3e8)[_0x53164a(0x224)](0x0),_0x5ebbae[_0x53164a(0x1b7)]=(0x0,utils_1[_0x53164a(0x1dc)])(0x20),_0x5ebbae[_0x53164a(0x237)]=_0x25fcf5,_0x5ebbae['title']=_0x587832[_0x53164a(0x1ca)],_0x5ebbae[_0x53164a(0x1fb)]=_0x40b965[_0x53164a(0x1ba)],_0x5ebbae['notify_url']=_0x2d4529,_0x5ebbae[_0x53164a(0x1c8)]=_0x29979d,_0x5ebbae[_0x53164a(0x243)]=_0x53164a(0x1d9),_0x5ebbae[_0x53164a(0x21e)]=this[_0x53164a(0x216)](_0x5ebbae,_0x2f79a4);const {data:{errcode:_0x4cae8c,errmsg:_0x53ce2b,url_qrcode:_0x470088,url:_0x2e83b5}}=await axios_1[_0x53164a(0x221)]['post'](_0x1aac4a||'https://api.xunhupay.com/payment/do.html',_0x5ebbae);if(_0x4cae8c!=0x0)throw new common_1[(_0x53164a(0x23f))](_0x53ce2b,common_1['HttpStatus'][_0x53164a(0x1f8)]);return{'url_qrcode':_0x470088,'url':_0x2e83b5};}async['queryHupi'](_0x12f01f){const _0x370975=_0x42da19,{payHupiAppId:_0x4d6f22,payHupiSecret:_0x548a8b}=await this['globalConfigService'][_0x370975(0x22f)]([_0x370975(0x266),_0x370975(0x1dd)]),_0x17140f={};_0x17140f['version']=_0x370975(0x268),_0x17140f[_0x370975(0x264)]=_0x4d6f22,_0x17140f['time']=(Date[_0x370975(0x20c)]()/0x3e8)[_0x370975(0x224)](0x0),_0x17140f[_0x370975(0x1b7)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x17140f[_0x370975(0x206)]=_0x12f01f,_0x17140f[_0x370975(0x21e)]=this[_0x370975(0x216)](_0x17140f,_0x548a8b);const {data:{errcode:_0x2fefcd,errmsg:_0x53e67b,data:_0xdf62f}}=await axios_1[_0x370975(0x221)][_0x370975(0x262)](_0x370975(0x1de),_0x17140f);if(_0x2fefcd!=0x0)throw new common_1[(_0x370975(0x23f))](_0x53e67b,common_1[_0x370975(0x1e3)][_0x370975(0x1f8)]);return _0xdf62f;}async[_0x42da19(0x242)](_0x43c9ba){const _0x23e7b3=_0x42da19,_0x1ffabb=_0x43c9ba[_0x23e7b3(0x216)];delete _0x43c9ba[_0x23e7b3(0x216)],delete _0x43c9ba['sign_type'];const _0x8e6bb7=await this[_0x23e7b3(0x231)][_0x23e7b3(0x22f)]([_0x23e7b3(0x1df)]);if(this[_0x23e7b3(0x216)](_0x43c9ba,_0x8e6bb7)!=_0x1ffabb)return _0x23e7b3(0x1d7);console['log'](_0x23e7b3(0x218));const _0xf9489=await this[_0x23e7b3(0x1f1)][_0x23e7b3(0x25c)]({'where':{'orderId':_0x43c9ba[_0x23e7b3(0x245)],'status':0x0}});if(!_0xf9489)return'failed';const _0x53c220=_0x43c9ba[_0x23e7b3(0x22c)]==_0x23e7b3(0x1ef)?0x1:0x2,_0x404303=await this['orderEntity']['update']({'orderId':_0x43c9ba['out_trade_no']},{'status':_0x53c220,'paydAt':new Date()});_0x53c220===0x1&&await this[_0x23e7b3(0x25a)]['addBalanceToOrder'](_0xf9489);if(_0x404303[_0x23e7b3(0x207)]!=0x1)return _0x23e7b3(0x1d7);return _0x23e7b3(0x267);}async[_0x42da19(0x23c)](_0x576472,_0x2855b2,_0x13fd29=_0x42da19(0x202)){const _0x1ba076=_0x42da19,_0x29255a=await this['orderEntity'][_0x1ba076(0x25c)]({'where':{'userId':_0x576472,'orderId':_0x2855b2}});if(!_0x29255a)throw new common_1['HttpException'](_0x1ba076(0x1d1),common_1[_0x1ba076(0x1e3)][_0x1ba076(0x1f8)]);const _0x478bbc=await this[_0x1ba076(0x1bf)][_0x1ba076(0x25c)]({'where':{'id':_0x29255a[_0x1ba076(0x23a)]}});if(!_0x478bbc)throw new common_1[(_0x1ba076(0x23f))](_0x1ba076(0x1e2),common_1[_0x1ba076(0x1e3)][_0x1ba076(0x1f8)]);const {payEpayPid:_0x33b51f,payEpaySecret:_0x1dd833,payEpayNotifyUrl:_0x506dc0,payEpayReturnUrl:_0x450ab4,payEpayApiPayUrl:_0x25e863}=await this[_0x1ba076(0x231)][_0x1ba076(0x22f)](['payEpayPid','payEpaySecret',_0x1ba076(0x1b9),_0x1ba076(0x1e4),_0x1ba076(0x225)]);let _0x4b257d;_0x33b51f[_0x1ba076(0x257)]<=0x10?_0x4b257d=Number(_0x33b51f):_0x4b257d=BigInt(_0x33b51f);const _0x53390d={};_0x53390d[_0x1ba076(0x24e)]=_0x4b257d,_0x53390d[_0x1ba076(0x24d)]=_0x13fd29,_0x53390d[_0x1ba076(0x245)]=_0x2855b2,_0x53390d[_0x1ba076(0x1ca)]=_0x478bbc[_0x1ba076(0x1ca)],_0x53390d[_0x1ba076(0x1e8)]=_0x29255a[_0x1ba076(0x1ba)],_0x53390d[_0x1ba076(0x1d3)]=_0x1ba076(0x20e),_0x53390d[_0x1ba076(0x20a)]='pc',_0x53390d[_0x1ba076(0x21c)]=_0x506dc0,_0x53390d['return_url']=_0x450ab4,_0x53390d['param']=_0x1ba076(0x1b5),_0x53390d['sign']=this[_0x1ba076(0x216)](_0x53390d,_0x1dd833),_0x53390d[_0x1ba076(0x1f2)]=_0x1ba076(0x260);const _0x2f7f92=new URLSearchParams(_0x53390d)[_0x1ba076(0x1d6)](),_0x82df55=_0x25e863+'?'+_0x2f7f92;if(_0x25e863['includes'](_0x1ba076(0x25d)))return{'url_qrcode':null,'redirectUrl':_0x82df55,'channel':_0x13fd29,'isRedirect':!![]};else{const _0x391adb=await axios_1[_0x1ba076(0x221)][_0x1ba076(0x1fe)](_0x25e863,{'params':_0x53390d});console[_0x1ba076(0x208)](_0x1ba076(0x209),_0x391adb[_0x1ba076(0x1f3)]);const {data:{code:_0x412925,msg:_0x29dc7d,qrcode:_0x1d1f7c}}=_0x391adb;if(_0x412925!=0x1)throw new common_1[(_0x1ba076(0x23f))](_0x29dc7d,common_1[_0x1ba076(0x1e3)][_0x1ba076(0x1f8)]);return{'url_qrcode':_0x1d1f7c,'redirectUrl':null,'channel':_0x13fd29,'isRedirect':![]};}}async['queryEpay'](_0x24af36){const _0x4d25c2=_0x42da19,{payEpayPid:_0x2e63e4,payEpaySecret:_0x21f521,payEpayApiQueryUrl:_0x5907f2}=await this[_0x4d25c2(0x231)][_0x4d25c2(0x22f)]([_0x4d25c2(0x1c6),_0x4d25c2(0x1df),_0x4d25c2(0x1fd)]),_0x5a6080={};_0x5a6080['act']=_0x4d25c2(0x1d5),_0x5a6080['out_trade_no']=_0x24af36,_0x5a6080['pid']=_0x2e63e4,_0x5a6080['key']=_0x21f521;const {data:{code:_0x22146a,msg:_0xa1e413,data:_0x3d54fe}}=await axios_1[_0x4d25c2(0x221)][_0x4d25c2(0x1fe)](_0x5907f2,{'params':_0x5a6080});if(_0x22146a!=0x1)throw new common_1[(_0x4d25c2(0x23f))](_0xa1e413,common_1[_0x4d25c2(0x1e3)][_0x4d25c2(0x1f8)]);return _0x3d54fe;}async['notifyMpay'](_0x363050){const _0x1af691=_0x42da19,_0x5ce93c=_0x363050[_0x1af691(0x216)];delete _0x363050[_0x1af691(0x216)],delete _0x363050[_0x1af691(0x1f2)];const _0x22e6a3=await this[_0x1af691(0x231)]['getConfigs']([_0x1af691(0x24b)]);console[_0x1af691(0x208)](_0x1af691(0x213));if(this[_0x1af691(0x216)](_0x363050,_0x22e6a3)!=_0x5ce93c)return _0x1af691(0x1d7);console['log'](_0x1af691(0x218));const _0x57bb76=await this[_0x1af691(0x1f1)]['findOne']({'where':{'orderId':_0x363050[_0x1af691(0x245)],'status':0x0}});if(!_0x57bb76)return _0x1af691(0x1d7);const _0x39517c=_0x363050[_0x1af691(0x22c)]==_0x1af691(0x1ef)?0x1:0x2;console[_0x1af691(0x208)](_0x1af691(0x1ee),_0x39517c);const _0x1d54fb=await this[_0x1af691(0x1f1)][_0x1af691(0x1fa)]({'orderId':_0x363050[_0x1af691(0x245)]},{'status':_0x39517c,'paydAt':new Date()});_0x39517c===0x1&&await this[_0x1af691(0x25a)]['addBalanceToOrder'](_0x57bb76);if(_0x1d54fb[_0x1af691(0x207)]!=0x1)return'failed';return _0x1af691(0x267);}async[_0x42da19(0x230)](_0x4a000b,_0x4251de,_0x53918c=_0x42da19(0x20d)){const _0x1194d4=_0x42da19,_0x27206a=await this[_0x1194d4(0x1f1)][_0x1194d4(0x25c)]({'where':{'userId':_0x4a000b,'orderId':_0x4251de}});if(!_0x27206a)throw new common_1[(_0x1194d4(0x23f))]('订单不存在!',common_1[_0x1194d4(0x1e3)][_0x1194d4(0x1f8)]);const _0x3a5c9e=await this['cramiPackageEntity'][_0x1194d4(0x25c)]({'where':{'id':_0x27206a[_0x1194d4(0x23a)]}});if(!_0x3a5c9e)throw new common_1[(_0x1194d4(0x23f))](_0x1194d4(0x1e2),common_1[_0x1194d4(0x1e3)][_0x1194d4(0x1f8)]);const {payMpayPid:_0x29b034,payMpaySecret:_0x129d13,payMpayNotifyUrl:_0x32f12,payMpayReturnUrl:_0x2f62c8,payMpayApiPayUrl:_0x4e598e}=await this[_0x1194d4(0x231)]['getConfigs']([_0x1194d4(0x200),'payMpaySecret',_0x1194d4(0x247),_0x1194d4(0x203),_0x1194d4(0x1c2)]),_0x42cbad={};_0x42cbad[_0x1194d4(0x24e)]=Number(_0x29b034),_0x42cbad['type']=_0x53918c,_0x42cbad[_0x1194d4(0x245)]=_0x4251de,_0x42cbad['name']=_0x3a5c9e['name'],_0x42cbad[_0x1194d4(0x1e8)]=_0x27206a[_0x1194d4(0x1ba)],_0x42cbad[_0x1194d4(0x21c)]=_0x32f12,_0x42cbad[_0x1194d4(0x1c8)]=_0x2f62c8,_0x42cbad[_0x1194d4(0x216)]=this[_0x1194d4(0x216)](_0x42cbad,_0x129d13),_0x42cbad[_0x1194d4(0x1f2)]=_0x1194d4(0x260);const _0x465d63=new URLSearchParams(_0x42cbad)[_0x1194d4(0x1d6)](),_0x239b93=_0x4e598e+'?'+_0x465d63;return{'url_qrcode':null,'redirectUrl':_0x239b93,'channel':_0x53918c,'isRedirect':!![]};const _0x2e4c61=await axios_1[_0x1194d4(0x221)]['get'](_0x4e598e,{'params':_0x42cbad});}async[_0x42da19(0x20b)](_0x4aa205){const _0x5920fc=_0x42da19,{payMpayApiQueryUrl:_0xe818f5}=await this['globalConfigService'][_0x5920fc(0x22f)]([_0x5920fc(0x200),_0x5920fc(0x24b),_0x5920fc(0x205)]),_0xce8427={};_0xce8427[_0x5920fc(0x24d)]=0x2,_0xce8427[_0x5920fc(0x23e)]=_0x4aa205;const {data:{code:_0x535273,msg:_0x3008db,data:_0x10d059}}=await axios_1[_0x5920fc(0x221)][_0x5920fc(0x1fe)](_0xe818f5,{'params':_0xce8427});if(_0x535273!=0x1)throw new common_1[(_0x5920fc(0x23f))](_0x3008db,common_1['HttpStatus'][_0x5920fc(0x1f8)]);return _0x10d059;}async['notifyWeChat'](_0x5f30d7){const _0x5e2d3d=_0x42da19;console[_0x5e2d3d(0x208)]('微信支付通知params:\x20',_0x5f30d7);const {payWeChatAppId:_0x2641e3,payWeChatMchId:_0xbec868,payWeChatSecret:_0x969a21,payWeChatPublicKey:_0x533332,payWeChatPrivateKey:_0x17d0ae}=await this[_0x5e2d3d(0x231)]['getConfigs']([_0x5e2d3d(0x1c4),_0x5e2d3d(0x229),'payWeChatSecret',_0x5e2d3d(0x212),'payWeChatPrivateKey']),_0x2a36e3=new this[(_0x5e2d3d(0x223))]({'appid':_0x2641e3,'mchid':_0xbec868,'publicKey':_0x533332,'privateKey':_0x17d0ae});try{if(_0x5f30d7[_0x5e2d3d(0x1f9)]==_0x5e2d3d(0x222)){const {ciphertext:_0x23cf86,associated_data:_0x136f69,nonce:_0x452ac6}=_0x5f30d7[_0x5e2d3d(0x1b6)],_0x2fc6ed=_0x2a36e3[_0x5e2d3d(0x1d0)](_0x23cf86,_0x136f69,_0x452ac6,_0x969a21),_0x14e6c9=await this['orderEntity'][_0x5e2d3d(0x25c)]({'where':{'orderId':_0x2fc6ed['out_trade_no'],'status':0x0}});if(!_0x14e6c9)return _0x5e2d3d(0x1d7);const _0x8f9cbb=_0x2fc6ed['trade_state']==_0x5e2d3d(0x1f4)?0x1:0x2,_0x574c2d=await this[_0x5e2d3d(0x1f1)][_0x5e2d3d(0x1fa)]({'orderId':_0x2fc6ed[_0x5e2d3d(0x245)]},{'status':_0x8f9cbb,'paydAt':new Date()});_0x8f9cbb===0x1&&await this['userBalanceService'][_0x5e2d3d(0x214)](_0x14e6c9);if(_0x574c2d[_0x5e2d3d(0x207)]!=0x1)return'failed';}return _0x5e2d3d(0x267);}catch(_0x29e4e4){return console[_0x5e2d3d(0x208)](_0x5e2d3d(0x219),_0x29e4e4),console['log'](_0x5e2d3d(0x22d),_0x29e4e4),'failed';}}async[_0x42da19(0x227)](_0x5cd281,_0xf6fd4,_0x4384e6=_0x42da19(0x1ed)){const _0x447680=_0x42da19;var _0xee425,_0x3386d4,_0x43cb5c;console[_0x447680(0x208)](_0x447680(0x258),_0x4384e6);const _0x4e1de9=await this[_0x447680(0x1f1)][_0x447680(0x25c)]({'where':{'userId':_0x5cd281,'orderId':_0xf6fd4}});if(!_0x4e1de9)throw new common_1[(_0x447680(0x23f))](_0x447680(0x1d1),common_1['HttpStatus'][_0x447680(0x1f8)]);const _0x2a81a6=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x4e1de9[_0x447680(0x23a)]}});if(!_0x2a81a6)throw new common_1['HttpException']('套餐不存在!',common_1[_0x447680(0x1e3)]['BAD_REQUEST']);const {payWeChatAppId:_0x3c8036,payWeChatMchId:_0x24ba60,payWeChatPublicKey:_0x4bb96b,payWeChatPrivateKey:_0x19d2d1,payWeChatNotifyUrl:_0x11ff7a,payWeChatH5Name:_0x41825c,payWeChatH5Url:_0x2598cb}=await this['globalConfigService']['getConfigs']([_0x447680(0x1c4),_0x447680(0x229),_0x447680(0x212),_0x447680(0x251),_0x447680(0x1cd),'payWeChatH5Name','payWeChatH5Url']);console['log']('payWeChatAppId',_0x3c8036),console[_0x447680(0x208)](_0x447680(0x229),_0x24ba60),console[_0x447680(0x208)](_0x447680(0x212),_0x4bb96b),console['log'](_0x447680(0x251),_0x19d2d1);const _0x29f587=new this['WxPay']({'appid':_0x3c8036,'mchid':_0x24ba60,'publicKey':_0x4bb96b,'privateKey':_0x19d2d1,'serial_no':process[_0x447680(0x261)][_0x447680(0x1e0)]}),_0x5b4eb2={'appid':_0x3c8036,'mchid':_0x24ba60,'description':_0x2a81a6[_0x447680(0x1ca)],'out_trade_no':_0xf6fd4,'notify_url':_0x11ff7a,'amount':{'total':Number(_0x4e1de9[_0x447680(0x1ba)]*0x64)},'scene_info':{'payer_client_ip':_0x447680(0x20e)}};console[_0x447680(0x208)](_0x447680(0x256),_0x5b4eb2);if(_0x4384e6=='h5'){_0x5b4eb2[_0x447680(0x1c5)][_0x447680(0x1ce)]={'type':'Wap','app_name':_0x41825c,'app_url':_0x2598cb};const _0x2ed16a=await _0x29f587[_0x447680(0x21a)](_0x5b4eb2);if(_0x2ed16a[_0x447680(0x265)]===0x193){const _0x4a39cf=(_0x43cb5c=(_0x3386d4=(_0xee425=_0x2ed16a===null||_0x2ed16a===void 0x0?void 0x0:_0x2ed16a[_0x447680(0x1eb)])===null||_0xee425===void 0x0?void 0x0:_0xee425['response'])===null||_0x3386d4===void 0x0?void 0x0:_0x3386d4[_0x447680(0x1ea)])===null||_0x43cb5c===void 0x0?void 0x0:_0x43cb5c['message'];throw new common_1[(_0x447680(0x23f))]((_0x2ed16a===null||_0x2ed16a===void 0x0?void 0x0:_0x2ed16a[_0x447680(0x1ff)])||'微信H5支付失败！',common_1[_0x447680(0x1e3)]['BAD_REQUEST']);}const {h5_url:_0x42f546}=_0x2ed16a;return{'url':_0x42f546};}if(_0x4384e6==_0x447680(0x253)){const _0x2e51dd=await this[_0x447680(0x22a)][_0x447680(0x234)](_0x5cd281);console[_0x447680(0x208)](_0x447680(0x1cf),_0x2e51dd),_0x5b4eb2['payer']={'openid':_0x2e51dd};const _0x3e0da0=await _0x29f587[_0x447680(0x248)](_0x5b4eb2);return console[_0x447680(0x208)](_0x447680(0x1d8),_0x3e0da0),_0x3e0da0;}if(_0x4384e6=='native'){const _0x4caaa6=await _0x29f587[_0x447680(0x228)](_0x5b4eb2),{data:_0x3e391a,status:_0x43d801}=_0x4caaa6;if(_0x43d801!==0xc8)throw new common_1['HttpException'](_0x447680(0x241),_0x4caaa6);const {code_url:_0x28f0e5}=_0x3e391a;return!_0x28f0e5&&console[_0x447680(0x208)](_0x447680(0x1f5),_0x4caaa6),{'url_qrcode':_0x28f0e5,'isRedirect':![]};}throw new common_1[(_0x447680(0x23f))](_0x447680(0x25f),common_1['HttpStatus'][_0x447680(0x1f8)]);}async[_0x42da19(0x1fc)](_0x5de2d1){const _0x321d1a=_0x42da19,{payWeChatAppId:_0x301ed6,payWeChatMchId:_0x4c8804,payWeChatPublicKey:_0x47a831,payWeChatPrivateKey:_0xe2e2d7,payWeChatNotifyUrl:_0xbf0f8c,payWeChatH5Name:_0x44271c,payWeChatH5Url:_0x2726be}=await this['globalConfigService']['getConfigs']([_0x321d1a(0x1c4),_0x321d1a(0x229),'payWeChatPublicKey',_0x321d1a(0x251)]),_0x15a8ed=new this['WxPay']({'appid':_0x301ed6,'mchid':_0x4c8804,'publicKey':_0x47a831,'privateKey':_0xe2e2d7}),_0x4aa8c3=await _0x15a8ed['query']({'out_trade_no':_0x5de2d1});return _0x4aa8c3;}[_0x42da19(0x216)](_0x5edfbb,_0x156b75){const _0x1f284d=_0x42da19,_0x226bd9=Object[_0x1f284d(0x1cc)](_0x5edfbb)['sort']()[_0x1f284d(0x1e6)](_0x59680a=>_0x59680a+'='+_0x5edfbb[_0x59680a])[_0x1f284d(0x244)]('&')+_0x156b75;return crypto['createHash'](_0x1f284d(0x1c9))[_0x1f284d(0x1fa)](_0x226bd9)['digest'](_0x1f284d(0x1c7));}};PayService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x42da19(0x1c3)])(cramiPackage_entity_1[_0x42da19(0x201)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x42da19(0x1c1)])),__metadata(_0x42da19(0x254),[typeorm_2[_0x42da19(0x238)],typeorm_2[_0x42da19(0x238)],userBalance_service_1[_0x42da19(0x1c0)],globalConfig_service_1[_0x42da19(0x23b)],user_service_1[_0x42da19(0x1ec)]])],PayService),exports[_0x42da19(0x1da)]=PayService;