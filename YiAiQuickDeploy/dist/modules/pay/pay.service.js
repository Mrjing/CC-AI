'use strict';const _0x30b50b=_0x5ccc;function _0x5ccc(_0x137e43,_0x42a7a1){const _0x44ec0a=_0x44ec();return _0x5ccc=function(_0x5ccc5b,_0x4a656f){_0x5ccc5b=_0x5ccc5b-0x11b;let _0x48c579=_0x44ec0a[_0x5ccc5b];return _0x48c579;},_0x5ccc(_0x137e43,_0x42a7a1);}(function(_0x240dc2,_0x5e1cde){const _0x41bd3a=_0x5ccc,_0x14b304=_0x240dc2();while(!![]){try{const _0x7c8df6=-parseInt(_0x41bd3a(0x18a))/0x1*(-parseInt(_0x41bd3a(0x14a))/0x2)+-parseInt(_0x41bd3a(0x184))/0x3*(parseInt(_0x41bd3a(0x16a))/0x4)+parseInt(_0x41bd3a(0x162))/0x5*(parseInt(_0x41bd3a(0x149))/0x6)+parseInt(_0x41bd3a(0x1aa))/0x7+parseInt(_0x41bd3a(0x1c7))/0x8+-parseInt(_0x41bd3a(0x139))/0x9*(-parseInt(_0x41bd3a(0x1ad))/0xa)+-parseInt(_0x41bd3a(0x14e))/0xb;if(_0x7c8df6===_0x5e1cde)break;else _0x14b304['push'](_0x14b304['shift']());}catch(_0xf55d7){_0x14b304['push'](_0x14b304['shift']());}}}(_0x44ec,0xaf6d0));var __decorate=this&&this[_0x30b50b(0x190)]||function(_0x195f39,_0x9cdaff,_0x306d40,_0x3b65b7){const _0x39af80=_0x30b50b;var _0x4f9be8=arguments[_0x39af80(0x11d)],_0x2e8a7b=_0x4f9be8<0x3?_0x9cdaff:_0x3b65b7===null?_0x3b65b7=Object['getOwnPropertyDescriptor'](_0x9cdaff,_0x306d40):_0x3b65b7,_0xb6e72d;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x39af80(0x15b))_0x2e8a7b=Reflect[_0x39af80(0x173)](_0x195f39,_0x9cdaff,_0x306d40,_0x3b65b7);else{for(var _0x27b625=_0x195f39['length']-0x1;_0x27b625>=0x0;_0x27b625--)if(_0xb6e72d=_0x195f39[_0x27b625])_0x2e8a7b=(_0x4f9be8<0x3?_0xb6e72d(_0x2e8a7b):_0x4f9be8>0x3?_0xb6e72d(_0x9cdaff,_0x306d40,_0x2e8a7b):_0xb6e72d(_0x9cdaff,_0x306d40))||_0x2e8a7b;}return _0x4f9be8>0x3&&_0x2e8a7b&&Object[_0x39af80(0x126)](_0x9cdaff,_0x306d40,_0x2e8a7b),_0x2e8a7b;},__metadata=this&&this['__metadata']||function(_0xd89ccd,_0x720286){const _0x2b6c6c=_0x30b50b;if(typeof Reflect==='object'&&typeof Reflect[_0x2b6c6c(0x16f)]===_0x2b6c6c(0x15b))return Reflect[_0x2b6c6c(0x16f)](_0xd89ccd,_0x720286);},__param=this&&this[_0x30b50b(0x16b)]||function(_0x1073f8,_0x5abcd5){return function(_0x1a9f06,_0x3c62c5){_0x5abcd5(_0x1a9f06,_0x3c62c5,_0x1073f8);};};Object[_0x30b50b(0x126)](exports,'__esModule',{'value':!![]}),exports[_0x30b50b(0x1bd)]=void 0x0;const typeorm_1=require(_0x30b50b(0x132)),typeorm_2=require(_0x30b50b(0x159)),common_1=require(_0x30b50b(0x1ba)),crypto=require(_0x30b50b(0x187)),axios_1=require('axios'),order_entity_1=require('../order/order.entity'),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_service_1=require(_0x30b50b(0x133)),globalConfig_service_1=require(_0x30b50b(0x196)),utils_1=require(_0x30b50b(0x121)),user_service_1=require(_0x30b50b(0x1c6));function _0x44ec(){const _0x111862=['epay\x20--->\x20res:\x20','now','5932PImTTg','__param','payWeChatAppId','https://api.xunhupay.com/payment/query.html','payMpayApiPayUrl','metadata','HttpStatus','orderEntity','env','decorate','payMpayPid','payWeChatPrivateKey','notify','env\x20payWeChatPublicKey','payEpay','goodsId','default','money','errRaw','version','getOpenIdByUserId','queryMpay','wechat-pay:\x20','affected','digest','payWeChat','477bwgkhk','param','update','crypto','name','epay','714769bhADGx','status:\x20','notify_url','notifyMpay','sign_type','submit.php','__decorate','includes','response','payWeChatMchId','payType:\x20','post','../globalConfig/globalConfig.service','payMpayApiQueryUrl','TRADE_SUCCESS','toFixed','globalConfigService','payMpay','支付请求失败!','data','BAD_REQUEST','userBalanceService','WxPay','attach','type','return_url','nonce_str','payEpayApiQueryUrl','h5_info','query','key','order_no','456834wYdTHH','onModuleInit','订单不存在!','10acVuvG','InjectRepository','hash','out_trade_no','sign','sort','importDynamic','md5','微信H5支付失败！','queryEpay','message','hupi','payPlatform','@nestjs/common','status','Repository','PayService','event_type','getConfigs','clientip','校验签名通过','toString','payHupiGatewayUrl','log','UserService','../user/user.service','3969008bwruRR','TRANSACTION.SUCCESS','payWeChatNotifyUrl','out_trade_order','length','用户openId:\x20','wechat','join','../../common/utils','Injectable','CramiPackageEntity','trade_state','payHupiReturnUrl','defineProperty','failed','pid','payEpayPid','支付请求失败:\x20','校验签名','native','resource','payEpayReturnUrl','total','time','wechatpay-node-v3','@nestjs/typeorm','../userBalance/userBalance.service','payHupi','payEpaySecret','jsapi','trade_order_id','title','9186201xtTWkA','appid','keys','scene_info','design:paramtypes','payHupiAppId','createRandomNonceStr','1.1','notifyEpay','device','套餐不存在!','192.168.1.100','trade_status','cramiPackageEntity','get','payWeChatPublicKey','313314DKzHtP','2riaVZc','alipay','payMpaySecret','payWeChatSecret','25681326qrlZvA','支付通知验证失败:\x20','act','pay','success','decipher_gcm','jsapi支付结果返回值:\x20','OrderEntity','order','notifyWeChat','addBalanceToOrder','typeorm','queryWeChat','function','wx-native','createHash','mpay','https://api.xunhupay.com/payment/do.html','HttpException','findOne','95nDzRvj','transactions_h5','notifyHupi','payHupiSecret','wxpay','userService'];_0x44ec=function(){return _0x111862;};return _0x44ec();}let PayService=class PayService{constructor(_0x396cca,_0x264e39,_0xe37c1d,_0x4d2a0c,_0x50aa84){const _0x5c9ec1=_0x30b50b;this[_0x5c9ec1(0x146)]=_0x396cca,this['orderEntity']=_0x264e39,this['userBalanceService']=_0xe37c1d,this[_0x5c9ec1(0x19a)]=_0x4d2a0c,this[_0x5c9ec1(0x167)]=_0x50aa84;}async[_0x30b50b(0x1ab)](){const _0x3d25ef=_0x30b50b,_0xb92f1e=await(0x0,utils_1[_0x3d25ef(0x1b3)])(_0x3d25ef(0x131));this['WxPay']=(_0xb92f1e===null||_0xb92f1e===void 0x0?void 0x0:_0xb92f1e['default'])?_0xb92f1e[_0x3d25ef(0x17a)]:_0xb92f1e;}async[_0x30b50b(0x176)](_0x46b126){const _0x41cee8=_0x30b50b;if(_0x46b126[_0x41cee8(0x185)]=='epay')return this['notifyEpay'](_0x46b126);if(_0x46b126[_0x41cee8(0x1a1)]==_0x41cee8(0x1b8))return this[_0x41cee8(0x164)](_0x46b126);if(typeof _0x46b126['resource']=='object')return this['notifyWeChat'](_0x46b126);return this['notifyMpay'](_0x46b126);}async[_0x30b50b(0x151)](_0x2af243,_0x1d4bda,_0x139df5='wxpay'){const _0x2a7e28=_0x30b50b,_0x5a33f1=await this['orderEntity'][_0x2a7e28(0x161)]({'where':{'userId':_0x2af243,'orderId':_0x1d4bda}});if(!_0x5a33f1)throw new common_1[(_0x2a7e28(0x160))](_0x2a7e28(0x1ac),common_1[_0x2a7e28(0x170)][_0x2a7e28(0x19e)]);const _0x244f55=await this[_0x2a7e28(0x146)][_0x2a7e28(0x161)]({'where':{'id':_0x5a33f1[_0x2a7e28(0x179)]}});if(!_0x244f55)throw new common_1['HttpException'](_0x2a7e28(0x143),common_1['HttpStatus'][_0x2a7e28(0x19e)]);console[_0x2a7e28(0x1c4)]('本次支付类型:\x20',_0x5a33f1['payPlatform']);try{if(_0x5a33f1[_0x2a7e28(0x1b9)]==_0x2a7e28(0x11f))return this[_0x2a7e28(0x183)](_0x2af243,_0x1d4bda,_0x139df5);if(_0x5a33f1[_0x2a7e28(0x1b9)]==_0x2a7e28(0x189))return this[_0x2a7e28(0x178)](_0x2af243,_0x1d4bda,_0x139df5);if(_0x5a33f1[_0x2a7e28(0x1b9)]==_0x2a7e28(0x15e))return this[_0x2a7e28(0x19b)](_0x2af243,_0x1d4bda,_0x139df5);if(_0x5a33f1['payPlatform']==_0x2a7e28(0x1b8))return this[_0x2a7e28(0x134)](_0x2af243,_0x1d4bda,_0x139df5);}catch(_0x17485a){console['log'](_0x2a7e28(0x12a),_0x17485a);throw new common_1['HttpException'](_0x2a7e28(0x19c),common_1['HttpStatus']['BAD_REQUEST']);}}async['query'](_0x3f46c4){const _0x1d0d58=_0x30b50b,_0x4b26ea=await this[_0x1d0d58(0x171)]['findOne']({'where':{'orderId':_0x3f46c4}});if(!_0x4b26ea)throw new common_1[(_0x1d0d58(0x160))](_0x1d0d58(0x1ac),common_1[_0x1d0d58(0x170)]['BAD_REQUEST']);return _0x4b26ea;}async[_0x30b50b(0x164)](_0xfac702){const _0x39fdde=_0x30b50b,_0x241d89=await this[_0x39fdde(0x19a)]['getConfigs']([_0x39fdde(0x165)]),_0x73f4a6=_0xfac702['hash'];delete _0xfac702[_0x39fdde(0x1af)];if(this[_0x39fdde(0x1b1)](_0xfac702,_0x241d89)!=_0x73f4a6)return'failed';const _0x4b6c8b=await this[_0x39fdde(0x171)][_0x39fdde(0x161)]({'where':{'orderId':_0xfac702[_0x39fdde(0x137)],'status':0x0}});if(!_0x4b6c8b)return _0x39fdde(0x127);await this[_0x39fdde(0x19f)][_0x39fdde(0x158)](_0x4b6c8b);const _0x2ce67a=await this[_0x39fdde(0x171)][_0x39fdde(0x186)]({'orderId':_0xfac702[_0x39fdde(0x137)]},{'status':0x1,'paydAt':new Date()});if(_0x2ce67a[_0x39fdde(0x181)]!=0x1)return _0x39fdde(0x127);return _0x39fdde(0x152);}async[_0x30b50b(0x134)](_0x14670d,_0x315a15,_0x5094e7=_0x30b50b(0x166)){const _0x223d79=_0x30b50b,_0xbee41a=await this[_0x223d79(0x171)][_0x223d79(0x161)]({'where':{'userId':_0x14670d,'orderId':_0x315a15}});if(!_0xbee41a)throw new common_1[(_0x223d79(0x160))](_0x223d79(0x1ac),common_1['HttpStatus']['BAD_REQUEST']);const _0x2e38ba=await this[_0x223d79(0x146)][_0x223d79(0x161)]({'where':{'id':_0xbee41a[_0x223d79(0x179)]}});if(!_0x2e38ba)throw new common_1['HttpException'](_0x223d79(0x143),common_1[_0x223d79(0x170)]['BAD_REQUEST']);const {payHupiAppId:_0x5290d9,payHupiSecret:_0x3c3e8c,payHupiNotifyUrl:_0x21eb54,payHupiReturnUrl:_0x3aeea5,payHupiGatewayUrl:_0x514078}=await this[_0x223d79(0x19a)][_0x223d79(0x1bf)]([_0x223d79(0x13e),'payHupiSecret','payHupiNotifyUrl',_0x223d79(0x125),_0x223d79(0x1c3)]),_0x3d7b7e={};_0x3d7b7e[_0x223d79(0x17d)]=_0x223d79(0x140),_0x3d7b7e[_0x223d79(0x13a)]=_0x5290d9,_0x3d7b7e[_0x223d79(0x130)]=(Date[_0x223d79(0x169)]()/0x3e8)['toFixed'](0x0),_0x3d7b7e[_0x223d79(0x1a4)]=(0x0,utils_1[_0x223d79(0x13f)])(0x20),_0x3d7b7e['trade_order_id']=_0x315a15,_0x3d7b7e[_0x223d79(0x138)]=_0x2e38ba[_0x223d79(0x188)],_0x3d7b7e['total_fee']=_0xbee41a[_0x223d79(0x12f)],_0x3d7b7e['notify_url']=_0x21eb54,_0x3d7b7e['return_url']=_0x3aeea5,_0x3d7b7e[_0x223d79(0x1a1)]=_0x223d79(0x1b8),_0x3d7b7e['hash']=this[_0x223d79(0x1b1)](_0x3d7b7e,_0x3c3e8c);const {data:{errcode:_0x2fed21,errmsg:_0xb5d145,url_qrcode:_0x5e696f,url:_0x3f29e6}}=await axios_1[_0x223d79(0x17a)][_0x223d79(0x195)](_0x514078||_0x223d79(0x15f),_0x3d7b7e);if(_0x2fed21!=0x0)throw new common_1['HttpException'](_0xb5d145,common_1[_0x223d79(0x170)][_0x223d79(0x19e)]);return{'url_qrcode':_0x5e696f,'url':_0x3f29e6};}async['queryHupi'](_0x51e6b5){const _0x8d8a04=_0x30b50b,{payHupiAppId:_0x4a0cb6,payHupiSecret:_0x5494c8}=await this[_0x8d8a04(0x19a)][_0x8d8a04(0x1bf)](['payHupiAppId',_0x8d8a04(0x165)]),_0x919d06={};_0x919d06[_0x8d8a04(0x17d)]='1.1',_0x919d06[_0x8d8a04(0x13a)]=_0x4a0cb6,_0x919d06[_0x8d8a04(0x130)]=(Date[_0x8d8a04(0x169)]()/0x3e8)[_0x8d8a04(0x199)](0x0),_0x919d06[_0x8d8a04(0x1a4)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x919d06[_0x8d8a04(0x11c)]=_0x51e6b5,_0x919d06[_0x8d8a04(0x1af)]=this[_0x8d8a04(0x1b1)](_0x919d06,_0x5494c8);const {data:{errcode:_0x27aefc,errmsg:_0xb5fee,data:_0x173512}}=await axios_1['default']['post'](_0x8d8a04(0x16d),_0x919d06);if(_0x27aefc!=0x0)throw new common_1['HttpException'](_0xb5fee,common_1[_0x8d8a04(0x170)]['BAD_REQUEST']);return _0x173512;}async[_0x30b50b(0x141)](_0x16c352){const _0x7d836f=_0x30b50b,_0x27b7c8=_0x16c352[_0x7d836f(0x1b1)];delete _0x16c352['sign'],delete _0x16c352[_0x7d836f(0x18e)];const _0x39866d=await this[_0x7d836f(0x19a)][_0x7d836f(0x1bf)]([_0x7d836f(0x135)]);if(this[_0x7d836f(0x1b1)](_0x16c352,_0x39866d)!=_0x27b7c8)return _0x7d836f(0x127);console[_0x7d836f(0x1c4)](_0x7d836f(0x1c1));const _0x58e79e=await this[_0x7d836f(0x171)][_0x7d836f(0x161)]({'where':{'orderId':_0x16c352[_0x7d836f(0x1b0)],'status':0x0}});if(!_0x58e79e)return _0x7d836f(0x127);const _0x137a36=_0x16c352[_0x7d836f(0x145)]==_0x7d836f(0x198)?0x1:0x2,_0x4d3b12=await this['orderEntity']['update']({'orderId':_0x16c352[_0x7d836f(0x1b0)]},{'status':_0x137a36,'paydAt':new Date()});_0x137a36===0x1&&await this[_0x7d836f(0x19f)][_0x7d836f(0x158)](_0x58e79e);if(_0x4d3b12[_0x7d836f(0x181)]!=0x1)return _0x7d836f(0x127);return _0x7d836f(0x152);}async[_0x30b50b(0x178)](_0x13d51,_0xcee961,_0x25af0c=_0x30b50b(0x14b)){const _0x491c92=_0x30b50b,_0x54e1d3=await this['orderEntity'][_0x491c92(0x161)]({'where':{'userId':_0x13d51,'orderId':_0xcee961}});if(!_0x54e1d3)throw new common_1[(_0x491c92(0x160))](_0x491c92(0x1ac),common_1['HttpStatus']['BAD_REQUEST']);const _0x35ccef=await this['cramiPackageEntity'][_0x491c92(0x161)]({'where':{'id':_0x54e1d3[_0x491c92(0x179)]}});if(!_0x35ccef)throw new common_1[(_0x491c92(0x160))](_0x491c92(0x143),common_1[_0x491c92(0x170)][_0x491c92(0x19e)]);const {payEpayPid:_0x39e4f8,payEpaySecret:_0x594389,payEpayNotifyUrl:_0x3e42e2,payEpayReturnUrl:_0x511f00,payEpayApiPayUrl:_0x362941}=await this[_0x491c92(0x19a)][_0x491c92(0x1bf)]([_0x491c92(0x129),'payEpaySecret','payEpayNotifyUrl',_0x491c92(0x12e),'payEpayApiPayUrl']);let _0x1cfab4;_0x39e4f8[_0x491c92(0x11d)]<=0x10?_0x1cfab4=Number(_0x39e4f8):_0x1cfab4=BigInt(_0x39e4f8);const _0x1e4f47={};_0x1e4f47[_0x491c92(0x128)]=_0x1cfab4,_0x1e4f47[_0x491c92(0x1a2)]=_0x25af0c,_0x1e4f47['out_trade_no']=_0xcee961,_0x1e4f47[_0x491c92(0x188)]=_0x35ccef[_0x491c92(0x188)],_0x1e4f47[_0x491c92(0x17b)]=_0x54e1d3[_0x491c92(0x12f)],_0x1e4f47[_0x491c92(0x1c0)]='192.168.1.100',_0x1e4f47[_0x491c92(0x142)]='pc',_0x1e4f47[_0x491c92(0x18c)]=_0x3e42e2,_0x1e4f47[_0x491c92(0x1a3)]=_0x511f00,_0x1e4f47['param']='epay',_0x1e4f47[_0x491c92(0x1b1)]=this[_0x491c92(0x1b1)](_0x1e4f47,_0x594389),_0x1e4f47[_0x491c92(0x18e)]='MD5';const _0x322d98=new URLSearchParams(_0x1e4f47)[_0x491c92(0x1c2)](),_0x4453fe=_0x362941+'?'+_0x322d98;if(_0x362941[_0x491c92(0x191)](_0x491c92(0x18f)))return{'url_qrcode':null,'redirectUrl':_0x4453fe,'channel':_0x25af0c,'isRedirect':!![]};else{const _0x327f88=await axios_1[_0x491c92(0x17a)]['get'](_0x362941,{'params':_0x1e4f47});console[_0x491c92(0x1c4)](_0x491c92(0x168),_0x327f88[_0x491c92(0x19d)]);const {data:{code:_0x474a01,msg:_0x3a6e64,qrcode:_0x281ac6}}=_0x327f88;if(_0x474a01!=0x1)throw new common_1[(_0x491c92(0x160))](_0x3a6e64,common_1[_0x491c92(0x170)]['BAD_REQUEST']);return{'url_qrcode':_0x281ac6,'redirectUrl':null,'channel':_0x25af0c,'isRedirect':![]};}}async[_0x30b50b(0x1b6)](_0x8c9d5c){const _0x158682=_0x30b50b,{payEpayPid:_0x3a636e,payEpaySecret:_0x575864,payEpayApiQueryUrl:_0x49d286}=await this[_0x158682(0x19a)]['getConfigs']([_0x158682(0x129),_0x158682(0x135),_0x158682(0x1a5)]),_0x3b11f1={};_0x3b11f1[_0x158682(0x150)]=_0x158682(0x156),_0x3b11f1[_0x158682(0x1b0)]=_0x8c9d5c,_0x3b11f1[_0x158682(0x128)]=_0x3a636e,_0x3b11f1[_0x158682(0x1a8)]=_0x575864;const {data:{code:_0x5d68a9,msg:_0x4fb715,data:_0x2437e4}}=await axios_1[_0x158682(0x17a)][_0x158682(0x147)](_0x49d286,{'params':_0x3b11f1});if(_0x5d68a9!=0x1)throw new common_1[(_0x158682(0x160))](_0x4fb715,common_1[_0x158682(0x170)][_0x158682(0x19e)]);return _0x2437e4;}async[_0x30b50b(0x18d)](_0xe738d7){const _0x3ae892=_0x30b50b,_0x327a88=_0xe738d7[_0x3ae892(0x1b1)];delete _0xe738d7[_0x3ae892(0x1b1)],delete _0xe738d7['sign_type'];const _0x2d2112=await this[_0x3ae892(0x19a)][_0x3ae892(0x1bf)](['payMpaySecret']);console['log'](_0x3ae892(0x12b));if(this[_0x3ae892(0x1b1)](_0xe738d7,_0x2d2112)!=_0x327a88)return _0x3ae892(0x127);console[_0x3ae892(0x1c4)](_0x3ae892(0x1c1));const _0x45cd7c=await this[_0x3ae892(0x171)][_0x3ae892(0x161)]({'where':{'orderId':_0xe738d7[_0x3ae892(0x1b0)],'status':0x0}});if(!_0x45cd7c)return _0x3ae892(0x127);const _0x5a29ce=_0xe738d7[_0x3ae892(0x145)]==_0x3ae892(0x198)?0x1:0x2;console['log'](_0x3ae892(0x18b),_0x5a29ce);const _0x195301=await this['orderEntity'][_0x3ae892(0x186)]({'orderId':_0xe738d7[_0x3ae892(0x1b0)]},{'status':_0x5a29ce,'paydAt':new Date()});_0x5a29ce===0x1&&await this[_0x3ae892(0x19f)]['addBalanceToOrder'](_0x45cd7c);if(_0x195301['affected']!=0x1)return _0x3ae892(0x127);return _0x3ae892(0x152);}async[_0x30b50b(0x19b)](_0x439fdf,_0x109125,_0x5c282b=_0x30b50b(0x166)){const _0x2dd921=_0x30b50b,_0x118335=await this[_0x2dd921(0x171)]['findOne']({'where':{'userId':_0x439fdf,'orderId':_0x109125}});if(!_0x118335)throw new common_1[(_0x2dd921(0x160))]('订单不存在!',common_1[_0x2dd921(0x170)][_0x2dd921(0x19e)]);const _0x2428bf=await this['cramiPackageEntity'][_0x2dd921(0x161)]({'where':{'id':_0x118335[_0x2dd921(0x179)]}});if(!_0x2428bf)throw new common_1['HttpException'](_0x2dd921(0x143),common_1[_0x2dd921(0x170)][_0x2dd921(0x19e)]);const {payMpayPid:_0xf7734d,payMpaySecret:_0x4730e7,payMpayNotifyUrl:_0x218e2e,payMpayReturnUrl:_0x690b0b,payMpayApiPayUrl:_0x400006}=await this[_0x2dd921(0x19a)][_0x2dd921(0x1bf)]([_0x2dd921(0x174),_0x2dd921(0x14c),'payMpayNotifyUrl','payMpayReturnUrl',_0x2dd921(0x16e)]),_0x5823d5={};_0x5823d5[_0x2dd921(0x128)]=Number(_0xf7734d),_0x5823d5['type']=_0x5c282b,_0x5823d5['out_trade_no']=_0x109125,_0x5823d5[_0x2dd921(0x188)]=_0x2428bf[_0x2dd921(0x188)],_0x5823d5[_0x2dd921(0x17b)]=_0x118335[_0x2dd921(0x12f)],_0x5823d5[_0x2dd921(0x18c)]=_0x218e2e,_0x5823d5[_0x2dd921(0x1a3)]=_0x690b0b,_0x5823d5['sign']=this['sign'](_0x5823d5,_0x4730e7),_0x5823d5[_0x2dd921(0x18e)]='MD5';const _0x35078c=new URLSearchParams(_0x5823d5)['toString'](),_0xfbca78=_0x400006+'?'+_0x35078c;return{'url_qrcode':null,'redirectUrl':_0xfbca78,'channel':_0x5c282b,'isRedirect':!![]};const _0x3aec75=await axios_1[_0x2dd921(0x17a)][_0x2dd921(0x147)](_0x400006,{'params':_0x5823d5});}async[_0x30b50b(0x17f)](_0x3f4b23){const _0x1d6908=_0x30b50b,{payMpayApiQueryUrl:_0x275f1c}=await this['globalConfigService'][_0x1d6908(0x1bf)]([_0x1d6908(0x174),_0x1d6908(0x14c),_0x1d6908(0x197)]),_0x237c0b={};_0x237c0b[_0x1d6908(0x1a2)]=0x2,_0x237c0b[_0x1d6908(0x1a9)]=_0x3f4b23;const {data:{code:_0x25bf94,msg:_0xfe31ef,data:_0x28661d}}=await axios_1['default']['get'](_0x275f1c,{'params':_0x237c0b});if(_0x25bf94!=0x1)throw new common_1[(_0x1d6908(0x160))](_0xfe31ef,common_1[_0x1d6908(0x170)][_0x1d6908(0x19e)]);return _0x28661d;}async[_0x30b50b(0x157)](_0x4cfe7e){const _0x2c17f7=_0x30b50b;console['log']('微信支付通知params:\x20',_0x4cfe7e);const {payWeChatAppId:_0x7e13c4,payWeChatMchId:_0x46c070,payWeChatSecret:_0x324e74,payWeChatPublicKey:_0x474e14,payWeChatPrivateKey:_0x307f1c}=await this[_0x2c17f7(0x19a)][_0x2c17f7(0x1bf)](['payWeChatAppId',_0x2c17f7(0x193),_0x2c17f7(0x14d),_0x2c17f7(0x148),_0x2c17f7(0x175)]),_0x43986f=new this[(_0x2c17f7(0x1a0))]({'appid':_0x7e13c4,'mchid':_0x46c070,'publicKey':_0x474e14,'privateKey':_0x307f1c});try{if(_0x4cfe7e[_0x2c17f7(0x1be)]==_0x2c17f7(0x1c8)){const {ciphertext:_0x52fd58,associated_data:_0x1a81bd,nonce:_0x394f64}=_0x4cfe7e[_0x2c17f7(0x12d)],_0x16493d=_0x43986f[_0x2c17f7(0x153)](_0x52fd58,_0x1a81bd,_0x394f64,_0x324e74),_0x312b82=await this['orderEntity'][_0x2c17f7(0x161)]({'where':{'orderId':_0x16493d[_0x2c17f7(0x1b0)],'status':0x0}});if(!_0x312b82)return _0x2c17f7(0x127);const _0x3efe3e=_0x16493d[_0x2c17f7(0x124)]=='SUCCESS'?0x1:0x2,_0xd5f7c6=await this[_0x2c17f7(0x171)][_0x2c17f7(0x186)]({'orderId':_0x16493d[_0x2c17f7(0x1b0)]},{'status':_0x3efe3e,'paydAt':new Date()});_0x3efe3e===0x1&&await this[_0x2c17f7(0x19f)][_0x2c17f7(0x158)](_0x312b82);if(_0xd5f7c6['affected']!=0x1)return'failed';}return _0x2c17f7(0x152);}catch(_0x2de5a4){return console[_0x2c17f7(0x1c4)]('error:\x20',_0x2de5a4),console[_0x2c17f7(0x1c4)](_0x2c17f7(0x14f),_0x2de5a4),'failed';}}async[_0x30b50b(0x183)](_0x41a4d7,_0x38639c,_0x1dd75c=_0x30b50b(0x12c)){const _0x5d27ea=_0x30b50b;var _0x3e34aa,_0xf580c7,_0x170153;console[_0x5d27ea(0x1c4)](_0x5d27ea(0x194),_0x1dd75c);const _0x5305bc=await this['orderEntity'][_0x5d27ea(0x161)]({'where':{'userId':_0x41a4d7,'orderId':_0x38639c}});if(!_0x5305bc)throw new common_1[(_0x5d27ea(0x160))](_0x5d27ea(0x1ac),common_1['HttpStatus'][_0x5d27ea(0x19e)]);const _0x229a70=await this[_0x5d27ea(0x146)][_0x5d27ea(0x161)]({'where':{'id':_0x5305bc[_0x5d27ea(0x179)]}});if(!_0x229a70)throw new common_1[(_0x5d27ea(0x160))](_0x5d27ea(0x143),common_1[_0x5d27ea(0x170)][_0x5d27ea(0x19e)]);const {payWeChatAppId:_0x139ccf,payWeChatMchId:_0x3757b5,payWeChatPublicKey:_0x413746,payWeChatPrivateKey:_0x3daad7,payWeChatNotifyUrl:_0x366814,payWeChatH5Name:_0x382717,payWeChatH5Url:_0x5db259}=await this[_0x5d27ea(0x19a)][_0x5d27ea(0x1bf)]([_0x5d27ea(0x16c),_0x5d27ea(0x193),'payWeChatPublicKey',_0x5d27ea(0x175),_0x5d27ea(0x11b),'payWeChatH5Name','payWeChatH5Url']),_0x4f03c5=new this[(_0x5d27ea(0x1a0))]({'appid':_0x139ccf,'mchid':_0x3757b5,'publicKey':_0x413746,'privateKey':_0x3daad7}),_0x3053fb={'appid':_0x139ccf,'mchid':_0x3757b5,'description':_0x229a70[_0x5d27ea(0x188)],'out_trade_no':_0x38639c,'notify_url':_0x366814,'amount':{'total':Number(_0x5305bc['total']*0x64)},'scene_info':{'payer_client_ip':_0x5d27ea(0x144)}};console[_0x5d27ea(0x1c4)](_0x5d27ea(0x180),_0x3053fb);if(_0x1dd75c=='h5'){_0x3053fb[_0x5d27ea(0x13c)][_0x5d27ea(0x1a6)]={'type':'Wap','app_name':_0x382717,'app_url':_0x5db259};const _0x39fe03=await _0x4f03c5[_0x5d27ea(0x163)](_0x3053fb);if(_0x39fe03[_0x5d27ea(0x1bb)]===0x193){const _0x450170=(_0x170153=(_0xf580c7=(_0x3e34aa=_0x39fe03===null||_0x39fe03===void 0x0?void 0x0:_0x39fe03[_0x5d27ea(0x17c)])===null||_0x3e34aa===void 0x0?void 0x0:_0x3e34aa[_0x5d27ea(0x192)])===null||_0xf580c7===void 0x0?void 0x0:_0xf580c7['text'])===null||_0x170153===void 0x0?void 0x0:_0x170153[_0x5d27ea(0x1b7)];throw new common_1[(_0x5d27ea(0x160))]((_0x39fe03===null||_0x39fe03===void 0x0?void 0x0:_0x39fe03['message'])||_0x5d27ea(0x1b5),common_1[_0x5d27ea(0x170)][_0x5d27ea(0x19e)]);}const {h5_url:_0x3132f3}=_0x39fe03;return{'url':_0x3132f3};}if(_0x1dd75c==_0x5d27ea(0x136)){const _0x1b7070=await this[_0x5d27ea(0x167)][_0x5d27ea(0x17e)](_0x41a4d7);console[_0x5d27ea(0x1c4)](_0x5d27ea(0x11e),_0x1b7070),_0x3053fb['payer']={'openid':_0x1b7070};const _0xabf9ae=await _0x4f03c5['transactions_jsapi'](_0x3053fb);return console[_0x5d27ea(0x1c4)](_0x5d27ea(0x154),_0xabf9ae),_0xabf9ae;}if(_0x1dd75c=='native'){const _0x3e74b7=await _0x4f03c5['transactions_native'](_0x3053fb),{code_url:_0x4f4641}=_0x3e74b7;return!_0x4f4641&&console[_0x5d27ea(0x1c4)](_0x5d27ea(0x15c),_0x3e74b7),{'url_qrcode':_0x4f4641,'isRedirect':![]};}throw new common_1[(_0x5d27ea(0x160))]('unsupported\x20pay\x20type',common_1[_0x5d27ea(0x170)][_0x5d27ea(0x19e)]);}async[_0x30b50b(0x15a)](_0xb244a0){const _0x5a61a9=_0x30b50b,{payWeChatAppId:_0x6752ea,payWeChatMchId:_0x3b3f1b,payWeChatPublicKey:_0x500b8e,payWeChatPrivateKey:_0x3d6544,payWeChatNotifyUrl:_0xcd4db0,payWeChatH5Name:_0x37dc51,payWeChatH5Url:_0x5bfb09}=await this[_0x5a61a9(0x19a)][_0x5a61a9(0x1bf)]([_0x5a61a9(0x16c),_0x5a61a9(0x193),_0x5a61a9(0x148),'payWeChatPrivateKey']);console['log'](_0x5a61a9(0x177),process['env'][_0x5a61a9(0x148)]),console['log']('env\x20payWeChatPrivateKey',process[_0x5a61a9(0x172)]['payWeChatPrivateKey']),console[_0x5a61a9(0x1c4)](_0x5a61a9(0x148),_0x500b8e),console['log']('payWeChatPrivateKey',_0x3d6544),console['log'](_0x5a61a9(0x16c),_0x6752ea),console[_0x5a61a9(0x1c4)](_0x5a61a9(0x193),_0x3b3f1b);const _0xb40a35=new this[(_0x5a61a9(0x1a0))]({'appid':_0x6752ea,'mchid':_0x3b3f1b,'publicKey':_0x500b8e,'privateKey':_0x3d6544}),_0x6ab219=await _0xb40a35[_0x5a61a9(0x1a7)]({'out_trade_no':_0xb244a0});return _0x6ab219;}['sign'](_0x497a0a,_0x186cf2){const _0x1ad902=_0x30b50b,_0x19a55e=Object[_0x1ad902(0x13b)](_0x497a0a)[_0x1ad902(0x1b2)]()['map'](_0x1e35f2=>_0x1e35f2+'='+_0x497a0a[_0x1e35f2])[_0x1ad902(0x120)]('&')+_0x186cf2;return crypto[_0x1ad902(0x15d)](_0x1ad902(0x1b4))[_0x1ad902(0x186)](_0x19a55e)[_0x1ad902(0x182)]('hex');}};PayService=__decorate([(0x0,common_1[_0x30b50b(0x122)])(),__param(0x0,(0x0,typeorm_1[_0x30b50b(0x1ae)])(cramiPackage_entity_1[_0x30b50b(0x123)])),__param(0x1,(0x0,typeorm_1[_0x30b50b(0x1ae)])(order_entity_1[_0x30b50b(0x155)])),__metadata(_0x30b50b(0x13d),[typeorm_2[_0x30b50b(0x1bc)],typeorm_2[_0x30b50b(0x1bc)],userBalance_service_1['UserBalanceService'],globalConfig_service_1['GlobalConfigService'],user_service_1[_0x30b50b(0x1c5)]])],PayService),exports['PayService']=PayService;