'use strict';const _0x42fab0=_0x2003;function _0x4400(){const _0x597138=['@nestjs/typeorm','TRADE_SUCCESS','1.1','attach','transactions_native','notifyWeChat','payMpayApiQueryUrl','1836AoJjpy','decipher_gcm','93133dIkgnP','payWeChatH5Url','trade_order_id','payMpay','get','epay\x20--->\x20res:\x20','trade_status','submit.php','getConfigs','length','payWeChatPublicKey','sign_type','sort','WxPay','notifyHupi','payEpayNotifyUrl','userBalanceService','PayService','payEpayApiQueryUrl','SERIAL_NO','../../common/utils','defineProperty','scene_info','errRaw','payMpayApiPayUrl','payWeChatPrivateKey','payMpayPid','payEpay','hex','payEpayApiPayUrl','../userBalance/userBalance.service','hupi','payMpaySecret','GlobalConfigService','return_url','version','mpay','time','payWeChatAppId','order_no','resource','payType:\x20','hash','metadata','title','order','userService','param','nonce_str','SUCCESS','获取支付二维码失败','transactions_jsapi','decorate','query','HttpException','@nestjs/common','post','payWeChatMchId','wxpay','CramiPackageEntity','onModuleInit','queryEpay','../globalConfig/globalConfig.service','支付请求失败!','609796ZQUmDj','getOwnPropertyDescriptor','校验签名','notify_url','out_trade_no','event_type','UserService','payHupi','payMpayReturnUrl','now','default','jsapi支付结果返回值:\x20','sign','用户openId:\x20','订单不存在!','支付通知验证失败:\x20','微信支付通知params:\x20','payHupiReturnUrl','design:paramtypes','jsapi','__metadata','24tTqVjd','money','crypto','message','h5_info','type','__param','text','total','微信H5支付失败！','out_trade_order','payEpayPid','toString','InjectRepository','BAD_REQUEST','1044009HRTqSS','payPlatform','notifyEpay','alipay','md5','update','transactions_h5','keys','payer','notifyMpay','../user/user.service','appid','MD5','支付请求失败:\x20','cramiPackageEntity','TRANSACTION.SUCCESS','payHupiAppId','payHupiSecret','log','includes','failed','notify','OrderEntity','Injectable','wx-native\x20获取二维码地址为空','套餐不存在!','https://api.xunhupay.com/payment/do.html','globalConfigService','本次支付类型:\x20','8608KxocDK','orderEntity','key','createRandomNonceStr','wechatpay-node-v3','findOne','HttpStatus','payWeChat','payHupiNotifyUrl','addBalanceToOrder','function','toFixed','pay','epay','__decorate','pid','native','192.168.1.100','goodsId','307699bDDfyF','name','data','response','UserBalanceService','wechat','queryWeChat','payEpaySecret','affected','device','error:\x20','status:\x20','createHash','1256500BbYhkK','object','payMpayNotifyUrl','13312FHPYvS','success','Repository','digest'];_0x4400=function(){return _0x597138;};return _0x4400();}(function(_0x447992,_0x4ef7e7){const _0x2101a1=_0x2003,_0x3612ec=_0x447992();while(!![]){try{const _0x10895f=-parseInt(_0x2101a1(0x1cd))/0x1+-parseInt(_0x2101a1(0x1c0))/0x2+parseInt(_0x2101a1(0x180))/0x3+-parseInt(_0x2101a1(0x20d))/0x4+-parseInt(_0x2101a1(0x1bd))/0x5+-parseInt(_0x2101a1(0x222))/0x6*(-parseInt(_0x2101a1(0x1b0))/0x7)+-parseInt(_0x2101a1(0x19d))/0x8*(-parseInt(_0x2101a1(0x1cb))/0x9);if(_0x10895f===_0x4ef7e7)break;else _0x3612ec['push'](_0x3612ec['shift']());}catch(_0x333e64){_0x3612ec['push'](_0x3612ec['shift']());}}}(_0x4400,0x3a8b5));function _0x2003(_0x2c5abf,_0x2c1330){const _0x4400ed=_0x4400();return _0x2003=function(_0x200334,_0xdcc4d4){_0x200334=_0x200334-0x178;let _0x471df3=_0x4400ed[_0x200334];return _0x471df3;},_0x2003(_0x2c5abf,_0x2c1330);}var __decorate=this&&this[_0x42fab0(0x1ab)]||function(_0x28ac4c,_0x33a09c,_0x22655d,_0x575153){const _0x9a028f=_0x42fab0;var _0x4ec348=arguments[_0x9a028f(0x1d6)],_0x5d3b7c=_0x4ec348<0x3?_0x33a09c:_0x575153===null?_0x575153=Object[_0x9a028f(0x20e)](_0x33a09c,_0x22655d):_0x575153,_0x4c6920;if(typeof Reflect===_0x9a028f(0x1be)&&typeof Reflect[_0x9a028f(0x201)]===_0x9a028f(0x1a7))_0x5d3b7c=Reflect[_0x9a028f(0x201)](_0x28ac4c,_0x33a09c,_0x22655d,_0x575153);else{for(var _0x5ebeb1=_0x28ac4c['length']-0x1;_0x5ebeb1>=0x0;_0x5ebeb1--)if(_0x4c6920=_0x28ac4c[_0x5ebeb1])_0x5d3b7c=(_0x4ec348<0x3?_0x4c6920(_0x5d3b7c):_0x4ec348>0x3?_0x4c6920(_0x33a09c,_0x22655d,_0x5d3b7c):_0x4c6920(_0x33a09c,_0x22655d))||_0x5d3b7c;}return _0x4ec348>0x3&&_0x5d3b7c&&Object[_0x9a028f(0x1e2)](_0x33a09c,_0x22655d,_0x5d3b7c),_0x5d3b7c;},__metadata=this&&this[_0x42fab0(0x221)]||function(_0x5aa300,_0x4c12f9){const _0x280653=_0x42fab0;if(typeof Reflect===_0x280653(0x1be)&&typeof Reflect['metadata']===_0x280653(0x1a7))return Reflect[_0x280653(0x1f8)](_0x5aa300,_0x4c12f9);},__param=this&&this[_0x42fab0(0x228)]||function(_0x1f2839,_0x27435a){return function(_0x40d7a5,_0x4119ab){_0x27435a(_0x40d7a5,_0x4119ab,_0x1f2839);};};Object[_0x42fab0(0x1e2)](exports,'__esModule',{'value':!![]}),exports[_0x42fab0(0x1de)]=void 0x0;const typeorm_1=require(_0x42fab0(0x1c4)),typeorm_2=require('typeorm'),common_1=require(_0x42fab0(0x204)),crypto=require(_0x42fab0(0x224)),axios_1=require('axios'),order_entity_1=require('../order/order.entity'),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_service_1=require(_0x42fab0(0x1eb)),globalConfig_service_1=require(_0x42fab0(0x20b)),utils_1=require(_0x42fab0(0x1e1)),user_service_1=require(_0x42fab0(0x18a));let PayService=class PayService{constructor(_0x2c3fc3,_0x3d5170,_0xad96b5,_0x57f75a,_0x466985){const _0x2ea770=_0x42fab0;this[_0x2ea770(0x18e)]=_0x2c3fc3,this[_0x2ea770(0x19e)]=_0x3d5170,this[_0x2ea770(0x1dd)]=_0xad96b5,this[_0x2ea770(0x19b)]=_0x57f75a,this['userService']=_0x466985;}async[_0x42fab0(0x209)](){const _0x305b46=_0x42fab0,_0x466402=await(0x0,utils_1['importDynamic'])(_0x305b46(0x1a1));this[_0x305b46(0x1da)]=(_0x466402===null||_0x466402===void 0x0?void 0x0:_0x466402['default'])?_0x466402[_0x305b46(0x217)]:_0x466402;}async[_0x42fab0(0x195)](_0x23e979){const _0x18d444=_0x42fab0;if(_0x23e979[_0x18d444(0x1fc)]==_0x18d444(0x1aa))return this[_0x18d444(0x182)](_0x23e979);if(_0x23e979['attach']==_0x18d444(0x1ec))return this[_0x18d444(0x1db)](_0x23e979);if(typeof _0x23e979[_0x18d444(0x1f5)]==_0x18d444(0x1be))return this[_0x18d444(0x1c9)](_0x23e979);return this[_0x18d444(0x189)](_0x23e979);}async[_0x42fab0(0x1a9)](_0x49da03,_0x3ad1e7,_0x459a0a=_0x42fab0(0x207)){const _0x5482e4=_0x42fab0,_0x558617=await this[_0x5482e4(0x19e)][_0x5482e4(0x1a2)]({'where':{'userId':_0x49da03,'orderId':_0x3ad1e7}});if(!_0x558617)throw new common_1['HttpException'](_0x5482e4(0x21b),common_1[_0x5482e4(0x1a3)][_0x5482e4(0x17f)]);const _0x3b6bce=await this[_0x5482e4(0x18e)][_0x5482e4(0x1a2)]({'where':{'id':_0x558617['goodsId']}});if(!_0x3b6bce)throw new common_1['HttpException']('套餐不存在!',common_1[_0x5482e4(0x1a3)][_0x5482e4(0x17f)]);console[_0x5482e4(0x192)](_0x5482e4(0x19c),_0x558617[_0x5482e4(0x181)]);try{if(_0x558617[_0x5482e4(0x181)]==_0x5482e4(0x1b5))return this[_0x5482e4(0x1a4)](_0x49da03,_0x3ad1e7,_0x459a0a);if(_0x558617[_0x5482e4(0x181)]==_0x5482e4(0x1aa))return this['payEpay'](_0x49da03,_0x3ad1e7,_0x459a0a);if(_0x558617[_0x5482e4(0x181)]==_0x5482e4(0x1f1))return this[_0x5482e4(0x1d0)](_0x49da03,_0x3ad1e7,_0x459a0a);if(_0x558617['payPlatform']==_0x5482e4(0x1ec))return this['payHupi'](_0x49da03,_0x3ad1e7,_0x459a0a);}catch(_0x41efe6){console['log'](_0x5482e4(0x18d),_0x41efe6);throw new common_1[(_0x5482e4(0x203))](_0x5482e4(0x20c),common_1[_0x5482e4(0x1a3)]['BAD_REQUEST']);}}async[_0x42fab0(0x202)](_0xdbc90b){const _0x2dd178=_0x42fab0,_0x5c1c49=await this[_0x2dd178(0x19e)][_0x2dd178(0x1a2)]({'where':{'orderId':_0xdbc90b}});if(!_0x5c1c49)throw new common_1[(_0x2dd178(0x203))](_0x2dd178(0x21b),common_1[_0x2dd178(0x1a3)][_0x2dd178(0x17f)]);return _0x5c1c49;}async[_0x42fab0(0x1db)](_0x4d62c8){const _0x3a2729=_0x42fab0,_0x1a44cd=await this[_0x3a2729(0x19b)]['getConfigs']([_0x3a2729(0x191)]),_0x40e4fd=_0x4d62c8[_0x3a2729(0x1f7)];delete _0x4d62c8[_0x3a2729(0x1f7)];if(this[_0x3a2729(0x219)](_0x4d62c8,_0x1a44cd)!=_0x40e4fd)return _0x3a2729(0x194);const _0x447934=await this[_0x3a2729(0x19e)][_0x3a2729(0x1a2)]({'where':{'orderId':_0x4d62c8[_0x3a2729(0x1cf)],'status':0x0}});if(!_0x447934)return _0x3a2729(0x194);await this[_0x3a2729(0x1dd)][_0x3a2729(0x1a6)](_0x447934);const _0x3d2d2b=await this[_0x3a2729(0x19e)][_0x3a2729(0x185)]({'orderId':_0x4d62c8[_0x3a2729(0x1cf)]},{'status':0x1,'paydAt':new Date()});if(_0x3d2d2b[_0x3a2729(0x1b8)]!=0x1)return'failed';return _0x3a2729(0x1c1);}async[_0x42fab0(0x214)](_0xded04b,_0x5d6aa4,_0x1d1313=_0x42fab0(0x207)){const _0x568dad=_0x42fab0,_0x5c66ae=await this[_0x568dad(0x19e)][_0x568dad(0x1a2)]({'where':{'userId':_0xded04b,'orderId':_0x5d6aa4}});if(!_0x5c66ae)throw new common_1[(_0x568dad(0x203))](_0x568dad(0x21b),common_1[_0x568dad(0x1a3)][_0x568dad(0x17f)]);const _0xabb287=await this[_0x568dad(0x18e)]['findOne']({'where':{'id':_0x5c66ae[_0x568dad(0x1af)]}});if(!_0xabb287)throw new common_1[(_0x568dad(0x203))](_0x568dad(0x199),common_1[_0x568dad(0x1a3)][_0x568dad(0x17f)]);const {payHupiAppId:_0x2d15e6,payHupiSecret:_0x45e2a1,payHupiNotifyUrl:_0x3f6949,payHupiReturnUrl:_0x18061c,payHupiGatewayUrl:_0x4a265b}=await this[_0x568dad(0x19b)][_0x568dad(0x1d5)]([_0x568dad(0x190),_0x568dad(0x191),_0x568dad(0x1a5),_0x568dad(0x21e),'payHupiGatewayUrl']),_0x369e84={};_0x369e84[_0x568dad(0x1f0)]=_0x568dad(0x1c6),_0x369e84[_0x568dad(0x18b)]=_0x2d15e6,_0x369e84[_0x568dad(0x1f2)]=(Date[_0x568dad(0x216)]()/0x3e8)['toFixed'](0x0),_0x369e84[_0x568dad(0x1fd)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x369e84[_0x568dad(0x1cf)]=_0x5d6aa4,_0x369e84[_0x568dad(0x1f9)]=_0xabb287[_0x568dad(0x1b1)],_0x369e84['total_fee']=_0x5c66ae[_0x568dad(0x179)],_0x369e84['notify_url']=_0x3f6949,_0x369e84[_0x568dad(0x1ef)]=_0x18061c,_0x369e84[_0x568dad(0x1c7)]='hupi',_0x369e84[_0x568dad(0x1f7)]=this['sign'](_0x369e84,_0x45e2a1);const {data:{errcode:_0x2ad72d,errmsg:_0x5c478a,url_qrcode:_0xa8a313,url:_0x4231f6}}=await axios_1['default']['post'](_0x4a265b||_0x568dad(0x19a),_0x369e84);if(_0x2ad72d!=0x0)throw new common_1[(_0x568dad(0x203))](_0x5c478a,common_1[_0x568dad(0x1a3)]['BAD_REQUEST']);return{'url_qrcode':_0xa8a313,'url':_0x4231f6};}async['queryHupi'](_0x2221c7){const _0x35fd29=_0x42fab0,{payHupiAppId:_0x28145e,payHupiSecret:_0x599384}=await this['globalConfigService'][_0x35fd29(0x1d5)]([_0x35fd29(0x190),'payHupiSecret']),_0x916c2e={};_0x916c2e[_0x35fd29(0x1f0)]=_0x35fd29(0x1c6),_0x916c2e['appid']=_0x28145e,_0x916c2e[_0x35fd29(0x1f2)]=(Date[_0x35fd29(0x216)]()/0x3e8)[_0x35fd29(0x1a8)](0x0),_0x916c2e[_0x35fd29(0x1fd)]=(0x0,utils_1[_0x35fd29(0x1a0)])(0x20),_0x916c2e[_0x35fd29(0x17b)]=_0x2221c7,_0x916c2e[_0x35fd29(0x1f7)]=this[_0x35fd29(0x219)](_0x916c2e,_0x599384);const {data:{errcode:_0x1b2752,errmsg:_0x8f542f,data:_0x157b38}}=await axios_1[_0x35fd29(0x217)][_0x35fd29(0x205)]('https://api.xunhupay.com/payment/query.html',_0x916c2e);if(_0x1b2752!=0x0)throw new common_1[(_0x35fd29(0x203))](_0x8f542f,common_1[_0x35fd29(0x1a3)][_0x35fd29(0x17f)]);return _0x157b38;}async['notifyEpay'](_0x5b34a8){const _0x2a69c5=_0x42fab0,_0x287436=_0x5b34a8[_0x2a69c5(0x219)];delete _0x5b34a8[_0x2a69c5(0x219)],delete _0x5b34a8[_0x2a69c5(0x1d8)];const _0x357cc2=await this[_0x2a69c5(0x19b)]['getConfigs'](['payEpaySecret']);if(this[_0x2a69c5(0x219)](_0x5b34a8,_0x357cc2)!=_0x287436)return _0x2a69c5(0x194);console[_0x2a69c5(0x192)]('校验签名通过');const _0x4250ee=await this['orderEntity'][_0x2a69c5(0x1a2)]({'where':{'orderId':_0x5b34a8[_0x2a69c5(0x211)],'status':0x0}});if(!_0x4250ee)return'failed';const _0x2004b3=_0x5b34a8[_0x2a69c5(0x1d3)]==_0x2a69c5(0x1c5)?0x1:0x2,_0x50037d=await this['orderEntity'][_0x2a69c5(0x185)]({'orderId':_0x5b34a8[_0x2a69c5(0x211)]},{'status':_0x2004b3,'paydAt':new Date()});_0x2004b3===0x1&&await this[_0x2a69c5(0x1dd)][_0x2a69c5(0x1a6)](_0x4250ee);if(_0x50037d[_0x2a69c5(0x1b8)]!=0x1)return _0x2a69c5(0x194);return _0x2a69c5(0x1c1);}async[_0x42fab0(0x1e8)](_0x389e8e,_0x2590b1,_0x954c5a=_0x42fab0(0x183)){const _0x4ba2a8=_0x42fab0,_0x17f4e9=await this['orderEntity'][_0x4ba2a8(0x1a2)]({'where':{'userId':_0x389e8e,'orderId':_0x2590b1}});if(!_0x17f4e9)throw new common_1[(_0x4ba2a8(0x203))](_0x4ba2a8(0x21b),common_1['HttpStatus'][_0x4ba2a8(0x17f)]);const _0x32ad45=await this[_0x4ba2a8(0x18e)][_0x4ba2a8(0x1a2)]({'where':{'id':_0x17f4e9[_0x4ba2a8(0x1af)]}});if(!_0x32ad45)throw new common_1[(_0x4ba2a8(0x203))]('套餐不存在!',common_1[_0x4ba2a8(0x1a3)][_0x4ba2a8(0x17f)]);const {payEpayPid:_0x4883c1,payEpaySecret:_0x177e79,payEpayNotifyUrl:_0x4805a6,payEpayReturnUrl:_0x2e17c5,payEpayApiPayUrl:_0x2429ac}=await this[_0x4ba2a8(0x19b)][_0x4ba2a8(0x1d5)]([_0x4ba2a8(0x17c),_0x4ba2a8(0x1b7),_0x4ba2a8(0x1dc),'payEpayReturnUrl',_0x4ba2a8(0x1ea)]);let _0x4e5a15;_0x4883c1[_0x4ba2a8(0x1d6)]<=0x10?_0x4e5a15=Number(_0x4883c1):_0x4e5a15=BigInt(_0x4883c1);const _0xd719f9={};_0xd719f9[_0x4ba2a8(0x1ac)]=_0x4e5a15,_0xd719f9[_0x4ba2a8(0x227)]=_0x954c5a,_0xd719f9['out_trade_no']=_0x2590b1,_0xd719f9[_0x4ba2a8(0x1b1)]=_0x32ad45[_0x4ba2a8(0x1b1)],_0xd719f9[_0x4ba2a8(0x223)]=_0x17f4e9[_0x4ba2a8(0x179)],_0xd719f9['clientip']=_0x4ba2a8(0x1ae),_0xd719f9[_0x4ba2a8(0x1b9)]='pc',_0xd719f9[_0x4ba2a8(0x210)]=_0x4805a6,_0xd719f9[_0x4ba2a8(0x1ef)]=_0x2e17c5,_0xd719f9['param']=_0x4ba2a8(0x1aa),_0xd719f9[_0x4ba2a8(0x219)]=this['sign'](_0xd719f9,_0x177e79),_0xd719f9[_0x4ba2a8(0x1d8)]=_0x4ba2a8(0x18c);const _0xc8c949=new URLSearchParams(_0xd719f9)['toString'](),_0x4a2962=_0x2429ac+'?'+_0xc8c949;if(_0x2429ac[_0x4ba2a8(0x193)](_0x4ba2a8(0x1d4)))return{'url_qrcode':null,'redirectUrl':_0x4a2962,'channel':_0x954c5a,'isRedirect':!![]};else{const _0x4bb49c=await axios_1['default'][_0x4ba2a8(0x1d1)](_0x2429ac,{'params':_0xd719f9});console[_0x4ba2a8(0x192)](_0x4ba2a8(0x1d2),_0x4bb49c[_0x4ba2a8(0x1b2)]);const {data:{code:_0x3c4847,msg:_0x23d5c5,qrcode:_0x527e8b}}=_0x4bb49c;if(_0x3c4847!=0x1)throw new common_1[(_0x4ba2a8(0x203))](_0x23d5c5,common_1[_0x4ba2a8(0x1a3)][_0x4ba2a8(0x17f)]);return{'url_qrcode':_0x527e8b,'redirectUrl':null,'channel':_0x954c5a,'isRedirect':![]};}}async[_0x42fab0(0x20a)](_0x5c5b1f){const _0x506192=_0x42fab0,{payEpayPid:_0x30a2da,payEpaySecret:_0x21dc61,payEpayApiQueryUrl:_0x1aa690}=await this[_0x506192(0x19b)][_0x506192(0x1d5)]([_0x506192(0x17c),_0x506192(0x1b7),_0x506192(0x1df)]),_0x47adf7={};_0x47adf7['act']=_0x506192(0x1fa),_0x47adf7['out_trade_no']=_0x5c5b1f,_0x47adf7[_0x506192(0x1ac)]=_0x30a2da,_0x47adf7[_0x506192(0x19f)]=_0x21dc61;const {data:{code:_0x2b963f,msg:_0x56a55f,data:_0x228a03}}=await axios_1['default'][_0x506192(0x1d1)](_0x1aa690,{'params':_0x47adf7});if(_0x2b963f!=0x1)throw new common_1['HttpException'](_0x56a55f,common_1[_0x506192(0x1a3)][_0x506192(0x17f)]);return _0x228a03;}async[_0x42fab0(0x189)](_0x47a303){const _0xb74c50=_0x42fab0,_0x5d326e=_0x47a303[_0xb74c50(0x219)];delete _0x47a303[_0xb74c50(0x219)],delete _0x47a303['sign_type'];const _0x459c90=await this['globalConfigService'][_0xb74c50(0x1d5)]([_0xb74c50(0x1ed)]);console[_0xb74c50(0x192)](_0xb74c50(0x20f));if(this[_0xb74c50(0x219)](_0x47a303,_0x459c90)!=_0x5d326e)return _0xb74c50(0x194);console['log']('校验签名通过');const _0x3d942d=await this[_0xb74c50(0x19e)][_0xb74c50(0x1a2)]({'where':{'orderId':_0x47a303[_0xb74c50(0x211)],'status':0x0}});if(!_0x3d942d)return _0xb74c50(0x194);const _0x3af535=_0x47a303[_0xb74c50(0x1d3)]=='TRADE_SUCCESS'?0x1:0x2;console[_0xb74c50(0x192)](_0xb74c50(0x1bb),_0x3af535);const _0x1d755b=await this[_0xb74c50(0x19e)][_0xb74c50(0x185)]({'orderId':_0x47a303[_0xb74c50(0x211)]},{'status':_0x3af535,'paydAt':new Date()});_0x3af535===0x1&&await this[_0xb74c50(0x1dd)][_0xb74c50(0x1a6)](_0x3d942d);if(_0x1d755b[_0xb74c50(0x1b8)]!=0x1)return _0xb74c50(0x194);return _0xb74c50(0x1c1);}async[_0x42fab0(0x1d0)](_0x3ea685,_0x533389,_0x127561='wxpay'){const _0x3c9731=_0x42fab0,_0x5ce668=await this[_0x3c9731(0x19e)]['findOne']({'where':{'userId':_0x3ea685,'orderId':_0x533389}});if(!_0x5ce668)throw new common_1[(_0x3c9731(0x203))](_0x3c9731(0x21b),common_1[_0x3c9731(0x1a3)][_0x3c9731(0x17f)]);const _0x5116c8=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x5ce668[_0x3c9731(0x1af)]}});if(!_0x5116c8)throw new common_1[(_0x3c9731(0x203))](_0x3c9731(0x199),common_1['HttpStatus'][_0x3c9731(0x17f)]);const {payMpayPid:_0x12528c,payMpaySecret:_0x1c4fe0,payMpayNotifyUrl:_0x112099,payMpayReturnUrl:_0x43427e,payMpayApiPayUrl:_0x1dcdaa}=await this[_0x3c9731(0x19b)]['getConfigs'](['payMpayPid',_0x3c9731(0x1ed),_0x3c9731(0x1bf),_0x3c9731(0x215),_0x3c9731(0x1e5)]),_0x141210={};_0x141210['pid']=Number(_0x12528c),_0x141210[_0x3c9731(0x227)]=_0x127561,_0x141210[_0x3c9731(0x211)]=_0x533389,_0x141210[_0x3c9731(0x1b1)]=_0x5116c8[_0x3c9731(0x1b1)],_0x141210[_0x3c9731(0x223)]=_0x5ce668[_0x3c9731(0x179)],_0x141210[_0x3c9731(0x210)]=_0x112099,_0x141210[_0x3c9731(0x1ef)]=_0x43427e,_0x141210[_0x3c9731(0x219)]=this['sign'](_0x141210,_0x1c4fe0),_0x141210[_0x3c9731(0x1d8)]=_0x3c9731(0x18c);const _0x42152e=new URLSearchParams(_0x141210)[_0x3c9731(0x17d)](),_0x1ac780=_0x1dcdaa+'?'+_0x42152e;return{'url_qrcode':null,'redirectUrl':_0x1ac780,'channel':_0x127561,'isRedirect':!![]};const _0x20c0b9=await axios_1['default'][_0x3c9731(0x1d1)](_0x1dcdaa,{'params':_0x141210});}async['queryMpay'](_0x40c1b2){const _0x5d6c07=_0x42fab0,{payMpayApiQueryUrl:_0x26a9f8}=await this[_0x5d6c07(0x19b)]['getConfigs']([_0x5d6c07(0x1e7),_0x5d6c07(0x1ed),_0x5d6c07(0x1ca)]),_0x465439={};_0x465439['type']=0x2,_0x465439[_0x5d6c07(0x1f4)]=_0x40c1b2;const {data:{code:_0x404a5a,msg:_0x2ba8cb,data:_0x419ea5}}=await axios_1['default'][_0x5d6c07(0x1d1)](_0x26a9f8,{'params':_0x465439});if(_0x404a5a!=0x1)throw new common_1[(_0x5d6c07(0x203))](_0x2ba8cb,common_1[_0x5d6c07(0x1a3)][_0x5d6c07(0x17f)]);return _0x419ea5;}async['notifyWeChat'](_0x549685){const _0x1ff034=_0x42fab0;console[_0x1ff034(0x192)](_0x1ff034(0x21d),_0x549685);const {payWeChatAppId:_0x34041c,payWeChatMchId:_0x34a724,payWeChatSecret:_0x2c239e,payWeChatPublicKey:_0x5c2ec5,payWeChatPrivateKey:_0x54a798}=await this['globalConfigService']['getConfigs'](['payWeChatAppId','payWeChatMchId','payWeChatSecret',_0x1ff034(0x1d7),'payWeChatPrivateKey']),_0x28ef21=new this[(_0x1ff034(0x1da))]({'appid':_0x34041c,'mchid':_0x34a724,'publicKey':_0x5c2ec5,'privateKey':_0x54a798});try{if(_0x549685[_0x1ff034(0x212)]==_0x1ff034(0x18f)){const {ciphertext:_0x25452d,associated_data:_0x4d1ea4,nonce:_0x346671}=_0x549685[_0x1ff034(0x1f5)],_0x26efd2=_0x28ef21[_0x1ff034(0x1cc)](_0x25452d,_0x4d1ea4,_0x346671,_0x2c239e),_0x57000b=await this['orderEntity'][_0x1ff034(0x1a2)]({'where':{'orderId':_0x26efd2[_0x1ff034(0x211)],'status':0x0}});if(!_0x57000b)return _0x1ff034(0x194);const _0x2ac8ef=_0x26efd2['trade_state']==_0x1ff034(0x1fe)?0x1:0x2,_0x5d1203=await this[_0x1ff034(0x19e)]['update']({'orderId':_0x26efd2[_0x1ff034(0x211)]},{'status':_0x2ac8ef,'paydAt':new Date()});_0x2ac8ef===0x1&&await this[_0x1ff034(0x1dd)][_0x1ff034(0x1a6)](_0x57000b);if(_0x5d1203[_0x1ff034(0x1b8)]!=0x1)return _0x1ff034(0x194);}return _0x1ff034(0x1c1);}catch(_0x3b28f3){return console['log'](_0x1ff034(0x1ba),_0x3b28f3),console[_0x1ff034(0x192)](_0x1ff034(0x21c),_0x3b28f3),_0x1ff034(0x194);}}async[_0x42fab0(0x1a4)](_0x4b4e86,_0xe570ba,_0x31b839=_0x42fab0(0x1ad)){const _0x3019f7=_0x42fab0;var _0x2e0bc4,_0x303228,_0x389859;console[_0x3019f7(0x192)](_0x3019f7(0x1f6),_0x31b839);const _0x1af909=await this[_0x3019f7(0x19e)][_0x3019f7(0x1a2)]({'where':{'userId':_0x4b4e86,'orderId':_0xe570ba}});if(!_0x1af909)throw new common_1['HttpException'](_0x3019f7(0x21b),common_1[_0x3019f7(0x1a3)]['BAD_REQUEST']);const _0x40292d=await this[_0x3019f7(0x18e)][_0x3019f7(0x1a2)]({'where':{'id':_0x1af909[_0x3019f7(0x1af)]}});if(!_0x40292d)throw new common_1[(_0x3019f7(0x203))](_0x3019f7(0x199),common_1[_0x3019f7(0x1a3)][_0x3019f7(0x17f)]);const {payWeChatAppId:_0x598ef5,payWeChatMchId:_0x18b6c5,payWeChatPublicKey:_0x52a177,payWeChatPrivateKey:_0x371129,payWeChatNotifyUrl:_0x49870d,payWeChatH5Name:_0x5b7388,payWeChatH5Url:_0x861cca}=await this[_0x3019f7(0x19b)][_0x3019f7(0x1d5)]([_0x3019f7(0x1f3),_0x3019f7(0x206),'payWeChatPublicKey','payWeChatPrivateKey','payWeChatNotifyUrl','payWeChatH5Name',_0x3019f7(0x1ce)]);console[_0x3019f7(0x192)]('payWeChatAppId',_0x598ef5),console[_0x3019f7(0x192)](_0x3019f7(0x206),_0x18b6c5),console['log'](_0x3019f7(0x1d7),_0x52a177),console[_0x3019f7(0x192)](_0x3019f7(0x1e6),_0x371129);const _0x22b111=new this[(_0x3019f7(0x1da))]({'appid':_0x598ef5,'mchid':_0x18b6c5,'publicKey':_0x52a177,'privateKey':_0x371129,'serial_no':process['env'][_0x3019f7(0x1e0)]}),_0x5aa866={'appid':_0x598ef5,'mchid':_0x18b6c5,'description':_0x40292d[_0x3019f7(0x1b1)],'out_trade_no':_0xe570ba,'notify_url':_0x49870d,'amount':{'total':Number(_0x1af909[_0x3019f7(0x179)]*0x64)},'scene_info':{'payer_client_ip':_0x3019f7(0x1ae)}};console[_0x3019f7(0x192)]('wechat-pay:\x20',_0x5aa866);if(_0x31b839=='h5'){_0x5aa866[_0x3019f7(0x1e3)][_0x3019f7(0x226)]={'type':'Wap','app_name':_0x5b7388,'app_url':_0x861cca};const _0x57f6ac=await _0x22b111[_0x3019f7(0x186)](_0x5aa866);if(_0x57f6ac['status']===0x193){const _0x4c57f2=(_0x389859=(_0x303228=(_0x2e0bc4=_0x57f6ac===null||_0x57f6ac===void 0x0?void 0x0:_0x57f6ac[_0x3019f7(0x1e4)])===null||_0x2e0bc4===void 0x0?void 0x0:_0x2e0bc4[_0x3019f7(0x1b3)])===null||_0x303228===void 0x0?void 0x0:_0x303228[_0x3019f7(0x178)])===null||_0x389859===void 0x0?void 0x0:_0x389859['message'];throw new common_1['HttpException']((_0x57f6ac===null||_0x57f6ac===void 0x0?void 0x0:_0x57f6ac[_0x3019f7(0x225)])||_0x3019f7(0x17a),common_1[_0x3019f7(0x1a3)][_0x3019f7(0x17f)]);}const {h5_url:_0x2ec0c8}=_0x57f6ac;return{'url':_0x2ec0c8};}if(_0x31b839==_0x3019f7(0x220)){const _0x648af5=await this[_0x3019f7(0x1fb)]['getOpenIdByUserId'](_0x4b4e86);console[_0x3019f7(0x192)](_0x3019f7(0x21a),_0x648af5),_0x5aa866[_0x3019f7(0x188)]={'openid':_0x648af5};const _0x47a9a4=await _0x22b111[_0x3019f7(0x200)](_0x5aa866);return console[_0x3019f7(0x192)](_0x3019f7(0x218),_0x47a9a4),_0x47a9a4;}if(_0x31b839==_0x3019f7(0x1ad)){const _0x3b95c4=await _0x22b111[_0x3019f7(0x1c8)](_0x5aa866),{data:_0x1c07cd,status:_0x5d7672}=_0x3b95c4;if(_0x5d7672!==0xc8)throw new common_1[(_0x3019f7(0x203))](_0x3019f7(0x1ff),_0x3b95c4);const {code_url:_0x46808f}=_0x1c07cd;return!_0x46808f&&console[_0x3019f7(0x192)](_0x3019f7(0x198),_0x3b95c4),{'url_qrcode':_0x46808f,'isRedirect':![]};}throw new common_1[(_0x3019f7(0x203))]('unsupported\x20pay\x20type',common_1['HttpStatus'][_0x3019f7(0x17f)]);}async[_0x42fab0(0x1b6)](_0x16f74e){const _0x157ccc=_0x42fab0,{payWeChatAppId:_0x2015a3,payWeChatMchId:_0x4d801d,payWeChatPublicKey:_0x2b848b,payWeChatPrivateKey:_0x31a784,payWeChatNotifyUrl:_0x3375f8,payWeChatH5Name:_0x4049be,payWeChatH5Url:_0x1c008b}=await this[_0x157ccc(0x19b)][_0x157ccc(0x1d5)]([_0x157ccc(0x1f3),_0x157ccc(0x206),_0x157ccc(0x1d7),'payWeChatPrivateKey']),_0x54996a=new this[(_0x157ccc(0x1da))]({'appid':_0x2015a3,'mchid':_0x4d801d,'publicKey':_0x2b848b,'privateKey':_0x31a784}),_0x9f63bb=await _0x54996a[_0x157ccc(0x202)]({'out_trade_no':_0x16f74e});return _0x9f63bb;}[_0x42fab0(0x219)](_0x430766,_0x9c1742){const _0x51d06b=_0x42fab0,_0x5d2df7=Object[_0x51d06b(0x187)](_0x430766)[_0x51d06b(0x1d9)]()['map'](_0x1b9a45=>_0x1b9a45+'='+_0x430766[_0x1b9a45])['join']('&')+_0x9c1742;return crypto[_0x51d06b(0x1bc)](_0x51d06b(0x184))['update'](_0x5d2df7)[_0x51d06b(0x1c3)](_0x51d06b(0x1e9));}};PayService=__decorate([(0x0,common_1[_0x42fab0(0x197)])(),__param(0x0,(0x0,typeorm_1[_0x42fab0(0x17e)])(cramiPackage_entity_1[_0x42fab0(0x208)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x42fab0(0x196)])),__metadata(_0x42fab0(0x21f),[typeorm_2[_0x42fab0(0x1c2)],typeorm_2[_0x42fab0(0x1c2)],userBalance_service_1[_0x42fab0(0x1b4)],globalConfig_service_1[_0x42fab0(0x1ee)],user_service_1[_0x42fab0(0x213)]])],PayService),exports[_0x42fab0(0x1de)]=PayService;