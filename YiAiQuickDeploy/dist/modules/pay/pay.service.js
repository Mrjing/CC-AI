'use strict';function _0x2021(){const _0x96fb32=['alipay','pid','sign','name','type','notifyHupi','微信支付通知params:\x20','套餐不存在!','wx-native','../../common/utils','total','resource','clientip','payHupiReturnUrl','__esModule','55GhqCuN','message','payWeChatH5Url','event_type','payMpayApiQueryUrl','用户openId:\x20','payWeChatMchId','sort','axios','PayService','default','3174004SAfrQD','../order/order.entity','defineProperty','payHupi','wechat-pay:\x20','getOwnPropertyDescriptor','GlobalConfigService','payEpayNotifyUrl','本次支付类型:\x20','return_url','order_no','globalConfigService','payMpay','notify','payEpayPid','affected','keys','SUCCESS','get','transactions_jsapi','errRaw','订单不存在!','315078gUeeCr','map','out_trade_no','object','payEpayApiPayUrl','h5_info','userBalanceService','cramiPackageEntity','queryEpay','TRADE_SUCCESS','query','hupi','payHupiNotifyUrl','submit.php','4FBsMBf','jsapi支付结果返回值:\x20','crypto','CramiPackageEntity','onModuleInit','getConfigs','UserBalanceService','queryMpay','notifyEpay','payEpayReturnUrl','trade_order_id','校验签名','money','userService','MD5','decorate','nonce_str','BAD_REQUEST','764213qwedkH','key','epay','Wap','校验签名通过','payHupiSecret','payMpayApiPayUrl','4772048UHPXNi','param','../user/user.service','1.1','native','transactions_h5','192.168.1.100','../globalConfig/globalConfig.service','支付通知验证失败:\x20','post','UserService','importDynamic','text','length','toString','title','now','device','payEpayApiQueryUrl','支付请求失败:\x20','act','payHupiAppId','failed','metadata','join','typeorm','goodsId','23137596aDRfBm','payWeChatPublicKey','payWeChat','payMpayPid','log','notifyWeChat','Repository','scene_info','payMpayNotifyUrl','hash','attach','data','payWeChatSecret','sign_type','InjectRepository','__decorate','orderEntity','payWeChatPrivateKey','payEpaySecret','out_trade_order','payer','queryWeChat','md5','transactions_native','getOpenIdByUserId','design:paramtypes','payPlatform','success','@nestjs/typeorm','notify_url','../userBalance/userBalance.service','Injectable','payWeChatH5Name','time','105477EKERzB','wxpay','../crami/cramiPackage.entity','update','HttpStatus','order','notifyMpay','createRandomNonceStr','error:\x20','3827950AZrBtH','createHash','支付请求失败!','HttpException','payMpaySecret','https://api.xunhupay.com/payment/query.html','WxPay','payWeChatAppId','addBalanceToOrder','total_fee','OrderEntity','微信H5支付失败！','findOne','payEpay','appid'];_0x2021=function(){return _0x96fb32;};return _0x2021();}const _0x2fa35d=_0x5593;function _0x5593(_0x2180df,_0x324c85){const _0x202194=_0x2021();return _0x5593=function(_0x559359,_0x83f003){_0x559359=_0x559359-0x12d;let _0x86cb13=_0x202194[_0x559359];return _0x86cb13;},_0x5593(_0x2180df,_0x324c85);}(function(_0x25b7d0,_0x13912a){const _0x7a8596=_0x5593,_0x591722=_0x25b7d0();while(!![]){try{const _0x31ec1e=-parseInt(_0x7a8596(0x19a))/0x1+-parseInt(_0x7a8596(0x188))/0x2*(parseInt(_0x7a8596(0x132))/0x3)+-parseInt(_0x7a8596(0x164))/0x4+-parseInt(_0x7a8596(0x159))/0x5*(parseInt(_0x7a8596(0x17a))/0x6)+-parseInt(_0x7a8596(0x13b))/0x7+parseInt(_0x7a8596(0x1a1))/0x8+parseInt(_0x7a8596(0x1bc))/0x9;if(_0x31ec1e===_0x13912a)break;else _0x591722['push'](_0x591722['shift']());}catch(_0xf843f3){_0x591722['push'](_0x591722['shift']());}}}(_0x2021,0x65469));var __decorate=this&&this[_0x2fa35d(0x1cb)]||function(_0x4887b4,_0x9e9ced,_0x456410,_0x3f3f37){const _0x25511b=_0x2fa35d;var _0x563475=arguments['length'],_0x4c6449=_0x563475<0x3?_0x9e9ced:_0x3f3f37===null?_0x3f3f37=Object[_0x25511b(0x169)](_0x9e9ced,_0x456410):_0x3f3f37,_0x14f4d7;if(typeof Reflect===_0x25511b(0x17d)&&typeof Reflect[_0x25511b(0x197)]==='function')_0x4c6449=Reflect[_0x25511b(0x197)](_0x4887b4,_0x9e9ced,_0x456410,_0x3f3f37);else{for(var _0x3578fa=_0x4887b4[_0x25511b(0x1ae)]-0x1;_0x3578fa>=0x0;_0x3578fa--)if(_0x14f4d7=_0x4887b4[_0x3578fa])_0x4c6449=(_0x563475<0x3?_0x14f4d7(_0x4c6449):_0x563475>0x3?_0x14f4d7(_0x9e9ced,_0x456410,_0x4c6449):_0x14f4d7(_0x9e9ced,_0x456410))||_0x4c6449;}return _0x563475>0x3&&_0x4c6449&&Object[_0x25511b(0x166)](_0x9e9ced,_0x456410,_0x4c6449),_0x4c6449;},__metadata=this&&this['__metadata']||function(_0x26ba8e,_0x20304e){const _0x4f1a10=_0x2fa35d;if(typeof Reflect==='object'&&typeof Reflect[_0x4f1a10(0x1b8)]==='function')return Reflect[_0x4f1a10(0x1b8)](_0x26ba8e,_0x20304e);},__param=this&&this['__param']||function(_0x2fcd38,_0x1c5d30){return function(_0x407f82,_0x31a927){_0x1c5d30(_0x407f82,_0x31a927,_0x2fcd38);};};Object[_0x2fa35d(0x166)](exports,_0x2fa35d(0x158),{'value':!![]}),exports[_0x2fa35d(0x162)]=void 0x0;const typeorm_1=require(_0x2fa35d(0x1d8)),typeorm_2=require(_0x2fa35d(0x1ba)),common_1=require('@nestjs/common'),crypto=require(_0x2fa35d(0x18a)),axios_1=require(_0x2fa35d(0x161)),order_entity_1=require(_0x2fa35d(0x165)),cramiPackage_entity_1=require(_0x2fa35d(0x134)),userBalance_service_1=require(_0x2fa35d(0x12e)),globalConfig_service_1=require(_0x2fa35d(0x1a8)),utils_1=require(_0x2fa35d(0x153)),user_service_1=require(_0x2fa35d(0x1a3));let PayService=class PayService{constructor(_0x2c93b6,_0x7370a7,_0x181a21,_0x589ec7,_0x1a9830){const _0x14d50e=_0x2fa35d;this[_0x14d50e(0x181)]=_0x2c93b6,this[_0x14d50e(0x1cc)]=_0x7370a7,this[_0x14d50e(0x180)]=_0x181a21,this['globalConfigService']=_0x589ec7,this[_0x14d50e(0x195)]=_0x1a9830;}async[_0x2fa35d(0x18c)](){const _0x1e055e=_0x2fa35d,_0x368e10=await(0x0,utils_1[_0x1e055e(0x1ac)])('wechatpay-node-v3');this[_0x1e055e(0x141)]=(_0x368e10===null||_0x368e10===void 0x0?void 0x0:_0x368e10['default'])?_0x368e10[_0x1e055e(0x163)]:_0x368e10;}async[_0x2fa35d(0x171)](_0x23cb4b){const _0x4c4737=_0x2fa35d;if(_0x23cb4b[_0x4c4737(0x1a2)]==_0x4c4737(0x19c))return this[_0x4c4737(0x190)](_0x23cb4b);if(_0x23cb4b[_0x4c4737(0x1c6)]=='hupi')return this['notifyHupi'](_0x23cb4b);if(typeof _0x23cb4b[_0x4c4737(0x155)]==_0x4c4737(0x17d))return this['notifyWeChat'](_0x23cb4b);return this[_0x4c4737(0x138)](_0x23cb4b);}async['pay'](_0xe59611,_0x15a145,_0x36dccb='wxpay'){const _0x266db2=_0x2fa35d,_0x55bc91=await this['orderEntity'][_0x266db2(0x147)]({'where':{'userId':_0xe59611,'orderId':_0x15a145}});if(!_0x55bc91)throw new common_1['HttpException'](_0x266db2(0x179),common_1[_0x266db2(0x136)][_0x266db2(0x199)]);const _0x2e931e=await this[_0x266db2(0x181)][_0x266db2(0x147)]({'where':{'id':_0x55bc91['goodsId']}});if(!_0x2e931e)throw new common_1[(_0x266db2(0x13e))](_0x266db2(0x151),common_1[_0x266db2(0x136)][_0x266db2(0x199)]);console[_0x266db2(0x1c0)](_0x266db2(0x16c),_0x55bc91['payPlatform']);try{if(_0x55bc91[_0x266db2(0x1d6)]=='wechat')return this[_0x266db2(0x1be)](_0xe59611,_0x15a145,_0x36dccb);if(_0x55bc91['payPlatform']==_0x266db2(0x19c))return this[_0x266db2(0x148)](_0xe59611,_0x15a145,_0x36dccb);if(_0x55bc91[_0x266db2(0x1d6)]=='mpay')return this[_0x266db2(0x170)](_0xe59611,_0x15a145,_0x36dccb);if(_0x55bc91[_0x266db2(0x1d6)]=='hupi')return this[_0x266db2(0x167)](_0xe59611,_0x15a145,_0x36dccb);}catch(_0x177eb4){console[_0x266db2(0x1c0)](_0x266db2(0x1b4),_0x177eb4);throw new common_1['HttpException'](_0x266db2(0x13d),common_1[_0x266db2(0x136)][_0x266db2(0x199)]);}}async['query'](_0x2e8bc5){const _0x33b200=_0x2fa35d,_0xb3553f=await this[_0x33b200(0x1cc)][_0x33b200(0x147)]({'where':{'orderId':_0x2e8bc5}});if(!_0xb3553f)throw new common_1['HttpException'](_0x33b200(0x179),common_1['HttpStatus'][_0x33b200(0x199)]);return _0xb3553f;}async[_0x2fa35d(0x14f)](_0x2cfe72){const _0x29e218=_0x2fa35d,_0x45bf5f=await this[_0x29e218(0x16f)][_0x29e218(0x18d)]([_0x29e218(0x19f)]),_0x4a5896=_0x2cfe72[_0x29e218(0x1c5)];delete _0x2cfe72[_0x29e218(0x1c5)];if(this[_0x29e218(0x14c)](_0x2cfe72,_0x45bf5f)!=_0x4a5896)return _0x29e218(0x1b7);const _0x33c15f=await this['orderEntity']['findOne']({'where':{'orderId':_0x2cfe72[_0x29e218(0x192)],'status':0x0}});if(!_0x33c15f)return _0x29e218(0x1b7);await this[_0x29e218(0x180)][_0x29e218(0x143)](_0x33c15f);const _0x425e73=await this[_0x29e218(0x1cc)][_0x29e218(0x135)]({'orderId':_0x2cfe72['trade_order_id']},{'status':0x1,'paydAt':new Date()});if(_0x425e73['affected']!=0x1)return _0x29e218(0x1b7);return'success';}async[_0x2fa35d(0x167)](_0x429a9a,_0x61b2e3,_0x1378f4=_0x2fa35d(0x133)){const _0x363026=_0x2fa35d,_0x1be111=await this[_0x363026(0x1cc)][_0x363026(0x147)]({'where':{'userId':_0x429a9a,'orderId':_0x61b2e3}});if(!_0x1be111)throw new common_1['HttpException'](_0x363026(0x179),common_1[_0x363026(0x136)]['BAD_REQUEST']);const _0x42849=await this['cramiPackageEntity'][_0x363026(0x147)]({'where':{'id':_0x1be111['goodsId']}});if(!_0x42849)throw new common_1['HttpException'](_0x363026(0x151),common_1[_0x363026(0x136)][_0x363026(0x199)]);const {payHupiAppId:_0x4ca927,payHupiSecret:_0x52c8e1,payHupiNotifyUrl:_0x297246,payHupiReturnUrl:_0x2f2288,payHupiGatewayUrl:_0x1f84ed}=await this[_0x363026(0x16f)][_0x363026(0x18d)](['payHupiAppId','payHupiSecret',_0x363026(0x186),_0x363026(0x157),'payHupiGatewayUrl']),_0x3475cb={};_0x3475cb['version']=_0x363026(0x1a4),_0x3475cb['appid']=_0x4ca927,_0x3475cb[_0x363026(0x131)]=(Date['now']()/0x3e8)['toFixed'](0x0),_0x3475cb[_0x363026(0x198)]=(0x0,utils_1[_0x363026(0x139)])(0x20),_0x3475cb[_0x363026(0x192)]=_0x61b2e3,_0x3475cb[_0x363026(0x1b0)]=_0x42849['name'],_0x3475cb[_0x363026(0x144)]=_0x1be111[_0x363026(0x154)],_0x3475cb['notify_url']=_0x297246,_0x3475cb['return_url']=_0x2f2288,_0x3475cb[_0x363026(0x1c6)]=_0x363026(0x185),_0x3475cb[_0x363026(0x1c5)]=this[_0x363026(0x14c)](_0x3475cb,_0x52c8e1);const {data:{errcode:_0x5d07fd,errmsg:_0x1d0bd0,url_qrcode:_0x228991,url:_0x3f238a}}=await axios_1[_0x363026(0x163)][_0x363026(0x1aa)](_0x1f84ed||'https://api.xunhupay.com/payment/do.html',_0x3475cb);if(_0x5d07fd!=0x0)throw new common_1[(_0x363026(0x13e))](_0x1d0bd0,common_1[_0x363026(0x136)][_0x363026(0x199)]);return{'url_qrcode':_0x228991,'url':_0x3f238a};}async['queryHupi'](_0x14cde4){const _0x4c967f=_0x2fa35d,{payHupiAppId:_0x36503e,payHupiSecret:_0x197ec7}=await this[_0x4c967f(0x16f)][_0x4c967f(0x18d)]([_0x4c967f(0x1b6),_0x4c967f(0x19f)]),_0x5168f7={};_0x5168f7['version']=_0x4c967f(0x1a4),_0x5168f7[_0x4c967f(0x149)]=_0x36503e,_0x5168f7[_0x4c967f(0x131)]=(Date[_0x4c967f(0x1b1)]()/0x3e8)['toFixed'](0x0),_0x5168f7['nonce_str']=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x5168f7[_0x4c967f(0x1cf)]=_0x14cde4,_0x5168f7[_0x4c967f(0x1c5)]=this['sign'](_0x5168f7,_0x197ec7);const {data:{errcode:_0x471fe9,errmsg:_0x51cc1a,data:_0x261d89}}=await axios_1[_0x4c967f(0x163)]['post'](_0x4c967f(0x140),_0x5168f7);if(_0x471fe9!=0x0)throw new common_1['HttpException'](_0x51cc1a,common_1[_0x4c967f(0x136)][_0x4c967f(0x199)]);return _0x261d89;}async[_0x2fa35d(0x190)](_0x255875){const _0xfcf92f=_0x2fa35d,_0x1eb03c=_0x255875[_0xfcf92f(0x14c)];delete _0x255875[_0xfcf92f(0x14c)],delete _0x255875[_0xfcf92f(0x1c9)];const _0x4cb8ba=await this[_0xfcf92f(0x16f)][_0xfcf92f(0x18d)]([_0xfcf92f(0x1ce)]);if(this['sign'](_0x255875,_0x4cb8ba)!=_0x1eb03c)return _0xfcf92f(0x1b7);console[_0xfcf92f(0x1c0)](_0xfcf92f(0x19e));const _0x16af51=await this[_0xfcf92f(0x1cc)]['findOne']({'where':{'orderId':_0x255875[_0xfcf92f(0x17c)],'status':0x0}});if(!_0x16af51)return _0xfcf92f(0x1b7);const _0x1dad4a=_0x255875['trade_status']==_0xfcf92f(0x183)?0x1:0x2,_0xe46c1=await this[_0xfcf92f(0x1cc)][_0xfcf92f(0x135)]({'orderId':_0x255875[_0xfcf92f(0x17c)]},{'status':_0x1dad4a,'paydAt':new Date()});_0x1dad4a===0x1&&await this[_0xfcf92f(0x180)][_0xfcf92f(0x143)](_0x16af51);if(_0xe46c1[_0xfcf92f(0x173)]!=0x1)return _0xfcf92f(0x1b7);return _0xfcf92f(0x1d7);}async[_0x2fa35d(0x148)](_0xb047e3,_0x1cd494,_0x347f6a=_0x2fa35d(0x14a)){const _0xbc2339=_0x2fa35d,_0x329d3e=await this[_0xbc2339(0x1cc)]['findOne']({'where':{'userId':_0xb047e3,'orderId':_0x1cd494}});if(!_0x329d3e)throw new common_1[(_0xbc2339(0x13e))](_0xbc2339(0x179),common_1['HttpStatus']['BAD_REQUEST']);const _0x48242a=await this[_0xbc2339(0x181)]['findOne']({'where':{'id':_0x329d3e[_0xbc2339(0x1bb)]}});if(!_0x48242a)throw new common_1['HttpException']('套餐不存在!',common_1[_0xbc2339(0x136)][_0xbc2339(0x199)]);const {payEpayPid:_0x512511,payEpaySecret:_0x46690e,payEpayNotifyUrl:_0x55a001,payEpayReturnUrl:_0x4a42e7,payEpayApiPayUrl:_0x301527}=await this[_0xbc2339(0x16f)]['getConfigs'](['payEpayPid',_0xbc2339(0x1ce),_0xbc2339(0x16b),_0xbc2339(0x191),_0xbc2339(0x17e)]);let _0x1d02fc;_0x512511[_0xbc2339(0x1ae)]<=0x10?_0x1d02fc=Number(_0x512511):_0x1d02fc=BigInt(_0x512511);const _0x25a372={};_0x25a372[_0xbc2339(0x14b)]=_0x1d02fc,_0x25a372['type']=_0x347f6a,_0x25a372[_0xbc2339(0x17c)]=_0x1cd494,_0x25a372[_0xbc2339(0x14d)]=_0x48242a['name'],_0x25a372[_0xbc2339(0x194)]=_0x329d3e['total'],_0x25a372[_0xbc2339(0x156)]=_0xbc2339(0x1a7),_0x25a372[_0xbc2339(0x1b2)]='pc',_0x25a372[_0xbc2339(0x12d)]=_0x55a001,_0x25a372[_0xbc2339(0x16d)]=_0x4a42e7,_0x25a372['param']=_0xbc2339(0x19c),_0x25a372[_0xbc2339(0x14c)]=this['sign'](_0x25a372,_0x46690e),_0x25a372[_0xbc2339(0x1c9)]=_0xbc2339(0x196);const _0x246d63=new URLSearchParams(_0x25a372)[_0xbc2339(0x1af)](),_0x10b431=_0x301527+'?'+_0x246d63;if(_0x301527['includes'](_0xbc2339(0x187)))return{'url_qrcode':null,'redirectUrl':_0x10b431,'channel':_0x347f6a,'isRedirect':!![]};else{const _0x521de1=await axios_1[_0xbc2339(0x163)][_0xbc2339(0x176)](_0x301527,{'params':_0x25a372});console['log']('epay\x20--->\x20res:\x20',_0x521de1[_0xbc2339(0x1c7)]);const {data:{code:_0x2361c4,msg:_0x5bf85d,qrcode:_0xe223e2}}=_0x521de1;if(_0x2361c4!=0x1)throw new common_1[(_0xbc2339(0x13e))](_0x5bf85d,common_1[_0xbc2339(0x136)]['BAD_REQUEST']);return{'url_qrcode':_0xe223e2,'redirectUrl':null,'channel':_0x347f6a,'isRedirect':![]};}}async[_0x2fa35d(0x182)](_0x1127a1){const _0x1864e3=_0x2fa35d,{payEpayPid:_0x567eb7,payEpaySecret:_0x12499c,payEpayApiQueryUrl:_0x1eda66}=await this[_0x1864e3(0x16f)][_0x1864e3(0x18d)]([_0x1864e3(0x172),_0x1864e3(0x1ce),_0x1864e3(0x1b3)]),_0x19ebbe={};_0x19ebbe[_0x1864e3(0x1b5)]=_0x1864e3(0x137),_0x19ebbe[_0x1864e3(0x17c)]=_0x1127a1,_0x19ebbe['pid']=_0x567eb7,_0x19ebbe[_0x1864e3(0x19b)]=_0x12499c;const {data:{code:_0x36f77c,msg:_0x4ee9bb,data:_0x3be33b}}=await axios_1[_0x1864e3(0x163)][_0x1864e3(0x176)](_0x1eda66,{'params':_0x19ebbe});if(_0x36f77c!=0x1)throw new common_1['HttpException'](_0x4ee9bb,common_1[_0x1864e3(0x136)]['BAD_REQUEST']);return _0x3be33b;}async[_0x2fa35d(0x138)](_0x17f848){const _0x4f6393=_0x2fa35d,_0x533b35=_0x17f848[_0x4f6393(0x14c)];delete _0x17f848[_0x4f6393(0x14c)],delete _0x17f848[_0x4f6393(0x1c9)];const _0x2ebff3=await this[_0x4f6393(0x16f)][_0x4f6393(0x18d)]([_0x4f6393(0x13f)]);console['log'](_0x4f6393(0x193));if(this['sign'](_0x17f848,_0x2ebff3)!=_0x533b35)return _0x4f6393(0x1b7);console[_0x4f6393(0x1c0)]('校验签名通过');const _0xaafd55=await this[_0x4f6393(0x1cc)]['findOne']({'where':{'orderId':_0x17f848['out_trade_no'],'status':0x0}});if(!_0xaafd55)return'failed';const _0x1f5435=_0x17f848['trade_status']==_0x4f6393(0x183)?0x1:0x2;console[_0x4f6393(0x1c0)]('status:\x20',_0x1f5435);const _0x5732e0=await this[_0x4f6393(0x1cc)][_0x4f6393(0x135)]({'orderId':_0x17f848[_0x4f6393(0x17c)]},{'status':_0x1f5435,'paydAt':new Date()});_0x1f5435===0x1&&await this['userBalanceService']['addBalanceToOrder'](_0xaafd55);if(_0x5732e0[_0x4f6393(0x173)]!=0x1)return'failed';return _0x4f6393(0x1d7);}async['payMpay'](_0x4366d7,_0x24027e,_0x100ff0=_0x2fa35d(0x133)){const _0x195084=_0x2fa35d,_0x27f835=await this[_0x195084(0x1cc)][_0x195084(0x147)]({'where':{'userId':_0x4366d7,'orderId':_0x24027e}});if(!_0x27f835)throw new common_1[(_0x195084(0x13e))](_0x195084(0x179),common_1['HttpStatus']['BAD_REQUEST']);const _0x237d0a=await this[_0x195084(0x181)]['findOne']({'where':{'id':_0x27f835[_0x195084(0x1bb)]}});if(!_0x237d0a)throw new common_1['HttpException']('套餐不存在!',common_1[_0x195084(0x136)]['BAD_REQUEST']);const {payMpayPid:_0xf2c24e,payMpaySecret:_0x502fe0,payMpayNotifyUrl:_0x5c41b9,payMpayReturnUrl:_0x203dd2,payMpayApiPayUrl:_0x4c37c2}=await this['globalConfigService'][_0x195084(0x18d)]([_0x195084(0x1bf),_0x195084(0x13f),_0x195084(0x1c4),'payMpayReturnUrl',_0x195084(0x1a0)]),_0x22aad0={};_0x22aad0[_0x195084(0x14b)]=Number(_0xf2c24e),_0x22aad0[_0x195084(0x14e)]=_0x100ff0,_0x22aad0[_0x195084(0x17c)]=_0x24027e,_0x22aad0[_0x195084(0x14d)]=_0x237d0a[_0x195084(0x14d)],_0x22aad0[_0x195084(0x194)]=_0x27f835[_0x195084(0x154)],_0x22aad0[_0x195084(0x12d)]=_0x5c41b9,_0x22aad0[_0x195084(0x16d)]=_0x203dd2,_0x22aad0[_0x195084(0x14c)]=this[_0x195084(0x14c)](_0x22aad0,_0x502fe0),_0x22aad0[_0x195084(0x1c9)]=_0x195084(0x196);const _0x1e5ffd=new URLSearchParams(_0x22aad0)[_0x195084(0x1af)](),_0x49f42c=_0x4c37c2+'?'+_0x1e5ffd;return{'url_qrcode':null,'redirectUrl':_0x49f42c,'channel':_0x100ff0,'isRedirect':!![]};const _0xacdeed=await axios_1[_0x195084(0x163)][_0x195084(0x176)](_0x4c37c2,{'params':_0x22aad0});}async[_0x2fa35d(0x18f)](_0x18454c){const _0x1ec1b8=_0x2fa35d,{payMpayApiQueryUrl:_0x4cece3}=await this[_0x1ec1b8(0x16f)][_0x1ec1b8(0x18d)]([_0x1ec1b8(0x1bf),_0x1ec1b8(0x13f),_0x1ec1b8(0x15d)]),_0x57e691={};_0x57e691[_0x1ec1b8(0x14e)]=0x2,_0x57e691[_0x1ec1b8(0x16e)]=_0x18454c;const {data:{code:_0x91a345,msg:_0x136179,data:_0x1ac420}}=await axios_1[_0x1ec1b8(0x163)][_0x1ec1b8(0x176)](_0x4cece3,{'params':_0x57e691});if(_0x91a345!=0x1)throw new common_1[(_0x1ec1b8(0x13e))](_0x136179,common_1[_0x1ec1b8(0x136)]['BAD_REQUEST']);return _0x1ac420;}async[_0x2fa35d(0x1c1)](_0x7c637d){const _0x501bd3=_0x2fa35d;console[_0x501bd3(0x1c0)](_0x501bd3(0x150),_0x7c637d);const {payWeChatAppId:_0x1f741f,payWeChatMchId:_0xd0d78d,payWeChatSecret:_0xac6349,payWeChatPublicKey:_0x5e6f98,payWeChatPrivateKey:_0x26a3c7}=await this[_0x501bd3(0x16f)]['getConfigs']([_0x501bd3(0x142),_0x501bd3(0x15f),_0x501bd3(0x1c8),_0x501bd3(0x1bd),_0x501bd3(0x1cd)]),_0x31810c=new this['WxPay']({'appid':_0x1f741f,'mchid':_0xd0d78d,'publicKey':_0x5e6f98,'privateKey':_0x26a3c7});try{if(_0x7c637d[_0x501bd3(0x15c)]=='TRANSACTION.SUCCESS'){const {ciphertext:_0x424bae,associated_data:_0x21e63d,nonce:_0x39ae80}=_0x7c637d['resource'],_0x352c1a=_0x31810c['decipher_gcm'](_0x424bae,_0x21e63d,_0x39ae80,_0xac6349),_0x30f150=await this[_0x501bd3(0x1cc)][_0x501bd3(0x147)]({'where':{'orderId':_0x352c1a['out_trade_no'],'status':0x0}});if(!_0x30f150)return _0x501bd3(0x1b7);const _0x3ad467=_0x352c1a['trade_state']==_0x501bd3(0x175)?0x1:0x2,_0x4e5c60=await this[_0x501bd3(0x1cc)]['update']({'orderId':_0x352c1a['out_trade_no']},{'status':_0x3ad467,'paydAt':new Date()});_0x3ad467===0x1&&await this[_0x501bd3(0x180)][_0x501bd3(0x143)](_0x30f150);if(_0x4e5c60[_0x501bd3(0x173)]!=0x1)return _0x501bd3(0x1b7);}return _0x501bd3(0x1d7);}catch(_0x468809){return console[_0x501bd3(0x1c0)](_0x501bd3(0x13a),_0x468809),console['log'](_0x501bd3(0x1a9),_0x468809),_0x501bd3(0x1b7);}}async['payWeChat'](_0x236240,_0x14c64e,_0x5ce4bc='native'){const _0x503452=_0x2fa35d;var _0x36b59a,_0x2a20a9,_0x1b68c5;console[_0x503452(0x1c0)]('payType:\x20',_0x5ce4bc);const _0x501795=await this['orderEntity'][_0x503452(0x147)]({'where':{'userId':_0x236240,'orderId':_0x14c64e}});if(!_0x501795)throw new common_1[(_0x503452(0x13e))](_0x503452(0x179),common_1[_0x503452(0x136)][_0x503452(0x199)]);const _0x3756c6=await this[_0x503452(0x181)][_0x503452(0x147)]({'where':{'id':_0x501795['goodsId']}});if(!_0x3756c6)throw new common_1['HttpException']('套餐不存在!',common_1['HttpStatus'][_0x503452(0x199)]);const {payWeChatAppId:_0x22f48e,payWeChatMchId:_0x263ab9,payWeChatPublicKey:_0x502f22,payWeChatPrivateKey:_0x4a9ca5,payWeChatNotifyUrl:_0x214f9c,payWeChatH5Name:_0x25ce62,payWeChatH5Url:_0x38504c}=await this[_0x503452(0x16f)]['getConfigs'](['payWeChatAppId',_0x503452(0x15f),_0x503452(0x1bd),'payWeChatPrivateKey','payWeChatNotifyUrl',_0x503452(0x130),_0x503452(0x15b)]),_0x5696af=new this[(_0x503452(0x141))]({'appid':_0x22f48e,'mchid':_0x263ab9,'publicKey':_0x502f22,'privateKey':_0x4a9ca5}),_0x4701ac={'appid':_0x22f48e,'mchid':_0x263ab9,'description':_0x3756c6['name'],'out_trade_no':_0x14c64e,'notify_url':_0x214f9c,'amount':{'total':Number(_0x501795[_0x503452(0x154)]*0x64)},'scene_info':{'payer_client_ip':_0x503452(0x1a7)}};console[_0x503452(0x1c0)](_0x503452(0x168),_0x4701ac);if(_0x5ce4bc=='h5'){_0x4701ac[_0x503452(0x1c3)][_0x503452(0x17f)]={'type':_0x503452(0x19d),'app_name':_0x25ce62,'app_url':_0x38504c};const _0x32cf56=await _0x5696af[_0x503452(0x1a6)](_0x4701ac);if(_0x32cf56['status']===0x193){const _0x430a8f=(_0x1b68c5=(_0x2a20a9=(_0x36b59a=_0x32cf56===null||_0x32cf56===void 0x0?void 0x0:_0x32cf56[_0x503452(0x178)])===null||_0x36b59a===void 0x0?void 0x0:_0x36b59a['response'])===null||_0x2a20a9===void 0x0?void 0x0:_0x2a20a9[_0x503452(0x1ad)])===null||_0x1b68c5===void 0x0?void 0x0:_0x1b68c5['message'];throw new common_1[(_0x503452(0x13e))]((_0x32cf56===null||_0x32cf56===void 0x0?void 0x0:_0x32cf56[_0x503452(0x15a)])||_0x503452(0x146),common_1['HttpStatus'][_0x503452(0x199)]);}const {h5_url:_0x2c17b6}=_0x32cf56;return{'url':_0x2c17b6};}if(_0x5ce4bc=='jsapi'){const _0x54045c=await this[_0x503452(0x195)][_0x503452(0x1d4)](_0x236240);console['log'](_0x503452(0x15e),_0x54045c),_0x4701ac[_0x503452(0x1d0)]={'openid':_0x54045c};const _0x14a03d=await _0x5696af[_0x503452(0x177)](_0x4701ac);return console[_0x503452(0x1c0)](_0x503452(0x189),_0x14a03d),_0x14a03d;}if(_0x5ce4bc==_0x503452(0x1a5)){const _0x5927bf=await _0x5696af[_0x503452(0x1d3)](_0x4701ac),{code_url:_0x1d7b77}=_0x5927bf;return!_0x1d7b77&&console['log'](_0x503452(0x152),_0x5927bf),{'url_qrcode':_0x1d7b77,'isRedirect':![]};}throw new common_1[(_0x503452(0x13e))]('unsupported\x20pay\x20type',common_1[_0x503452(0x136)][_0x503452(0x199)]);}async[_0x2fa35d(0x1d1)](_0x405c9e){const _0x196ac2=_0x2fa35d,{payWeChatAppId:_0x497a0e,payWeChatMchId:_0x47c690,payWeChatPublicKey:_0x4c5679,payWeChatPrivateKey:_0x18351e,payWeChatNotifyUrl:_0x34d314,payWeChatH5Name:_0x347a37,payWeChatH5Url:_0xdc9d9d}=await this['globalConfigService']['getConfigs']([_0x196ac2(0x142),_0x196ac2(0x15f),'payWeChatPublicKey','payWeChatPrivateKey']),_0x5434a1=new this[(_0x196ac2(0x141))]({'appid':_0x497a0e,'mchid':_0x47c690,'publicKey':_0x4c5679,'privateKey':_0x18351e}),_0x482b46=await _0x5434a1[_0x196ac2(0x184)]({'out_trade_no':_0x405c9e});return _0x482b46;}[_0x2fa35d(0x14c)](_0x264384,_0x90fd2c){const _0x11bb6a=_0x2fa35d,_0x59d9a0=Object[_0x11bb6a(0x174)](_0x264384)[_0x11bb6a(0x160)]()[_0x11bb6a(0x17b)](_0x3b0997=>_0x3b0997+'='+_0x264384[_0x3b0997])[_0x11bb6a(0x1b9)]('&')+_0x90fd2c;return crypto[_0x11bb6a(0x13c)](_0x11bb6a(0x1d2))[_0x11bb6a(0x135)](_0x59d9a0)['digest']('hex');}};PayService=__decorate([(0x0,common_1[_0x2fa35d(0x12f)])(),__param(0x0,(0x0,typeorm_1[_0x2fa35d(0x1ca)])(cramiPackage_entity_1[_0x2fa35d(0x18b)])),__param(0x1,(0x0,typeorm_1[_0x2fa35d(0x1ca)])(order_entity_1[_0x2fa35d(0x145)])),__metadata(_0x2fa35d(0x1d5),[typeorm_2['Repository'],typeorm_2[_0x2fa35d(0x1c2)],userBalance_service_1[_0x2fa35d(0x18e)],globalConfig_service_1[_0x2fa35d(0x16a)],user_service_1[_0x2fa35d(0x1ab)]])],PayService),exports['PayService']=PayService;