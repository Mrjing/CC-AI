'use strict';function _0x5c91(_0x183f75,_0x36bd0c){const _0x3f238b=_0x3f23();return _0x5c91=function(_0x5c91f8,_0x4e4a39){_0x5c91f8=_0x5c91f8-0x8d;let _0x181a21=_0x3f238b[_0x5c91f8];return _0x181a21;},_0x5c91(_0x183f75,_0x36bd0c);}const _0xe5c1c9=_0x5c91;(function(_0x5525b5,_0x5c9b0c){const _0x22c94b=_0x5c91,_0x183d4a=_0x5525b5();while(!![]){try{const _0x5e8885=-parseInt(_0x22c94b(0xf7))/0x1*(parseInt(_0x22c94b(0x93))/0x2)+-parseInt(_0x22c94b(0x14b))/0x3+parseInt(_0x22c94b(0xf8))/0x4*(parseInt(_0x22c94b(0xc2))/0x5)+-parseInt(_0x22c94b(0x8e))/0x6*(-parseInt(_0x22c94b(0xac))/0x7)+parseInt(_0x22c94b(0x129))/0x8+parseInt(_0x22c94b(0xe9))/0x9*(-parseInt(_0x22c94b(0xe2))/0xa)+parseInt(_0x22c94b(0x107))/0xb;if(_0x5e8885===_0x5c9b0c)break;else _0x183d4a['push'](_0x183d4a['shift']());}catch(_0x11723e){_0x183d4a['push'](_0x183d4a['shift']());}}}(_0x3f23,0x78782));var __decorate=this&&this[_0xe5c1c9(0xe0)]||function(_0xdaed9f,_0x208786,_0x277dc9,_0x112b2f){const _0xa9b5e2=_0xe5c1c9;var _0x27325e=arguments['length'],_0x3efe7a=_0x27325e<0x3?_0x208786:_0x112b2f===null?_0x112b2f=Object['getOwnPropertyDescriptor'](_0x208786,_0x277dc9):_0x112b2f,_0x4eea5d;if(typeof Reflect===_0xa9b5e2(0x145)&&typeof Reflect[_0xa9b5e2(0x10c)]===_0xa9b5e2(0xbc))_0x3efe7a=Reflect[_0xa9b5e2(0x10c)](_0xdaed9f,_0x208786,_0x277dc9,_0x112b2f);else{for(var _0x59869d=_0xdaed9f[_0xa9b5e2(0xe6)]-0x1;_0x59869d>=0x0;_0x59869d--)if(_0x4eea5d=_0xdaed9f[_0x59869d])_0x3efe7a=(_0x27325e<0x3?_0x4eea5d(_0x3efe7a):_0x27325e>0x3?_0x4eea5d(_0x208786,_0x277dc9,_0x3efe7a):_0x4eea5d(_0x208786,_0x277dc9))||_0x3efe7a;}return _0x27325e>0x3&&_0x3efe7a&&Object[_0xa9b5e2(0xbe)](_0x208786,_0x277dc9,_0x3efe7a),_0x3efe7a;},__metadata=this&&this[_0xe5c1c9(0x100)]||function(_0x48f678,_0x2ffa13){const _0x569bad=_0xe5c1c9;if(typeof Reflect===_0x569bad(0x145)&&typeof Reflect[_0x569bad(0xa8)]===_0x569bad(0xbc))return Reflect[_0x569bad(0xa8)](_0x48f678,_0x2ffa13);},__param=this&&this[_0xe5c1c9(0xba)]||function(_0x2c1890,_0x338388){return function(_0x578d5b,_0x7522f8){_0x338388(_0x578d5b,_0x7522f8,_0x2c1890);};};function _0x3f23(){const _0x11a181=['super','email','7051737SBnhaC','memberModel3Count','useModel4Token','BalanceEntity','visitorMJNum','decorate','inviteGiveSendDrawMjCount','查询用户账户失败！','packageId','../sales/sales.service','UserEntity','当前套餐不存在！','getAccountLog','getRechargeLog','rechargeType','hideString','useDrawMjToken','writeOldBalanceToNewTable','充值失败！','headers','查询当前用户余额失败！','SalesUsersEntity','REFER_GIFT','design:paramtypes','inviteSendStatus','当前用户无需创建账户信息！','globalConfigService','缺失当前用户账户记录！','getConfigs','midjourneyEntity','InjectRepository','firstRegisterSendRank','sumModel4Count','vxNumber','5336112pElxsd','accountLogEntity','add','refundMjBalance','UserBalanceEntity','useModel3Count','getVisitorCount','ConfigEntity','drawMjCount','getMonth','days','SCAN_PAY','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','createSalesRecords','非法操作、当前充值套餐暂不存在！','format','firstRregisterSendModel3Count','salesService','forEach','./balance.entity','registerSendDrawMjCount','salesUsersEntity','SalesService','当前用户不存在,记录充值日志异常','../../common/utils','memberModel4Count','invitedGuestSendModel3Count','firstRregisterSendModel4Count','object','../midjourney/midjourney.entity','UserBalanceService','GlobalConfigService','user','default','2117688uRYKfU','findAndCount','addBalanceToUser','setConfig','username','HttpException','MjCount','../globalConfig/config.entity','formatDate','model3','registerSendModel4Count','registerSendModel3Count','typeorm','sumDrawMjCount','90SiLoAl','消费余额失败！','getFullYear','../crami/cramiPackage.entity','充值的工单信息:','14AHFZYA','chatGroupEntity','inviteGiveSendModel3Count','CramiPackageEntity','DESC','Logger','RechargeType','Repository','>\x20或购买专属套餐\x20！','HttpStatus','deductFromBalance','visitorModel3Num','phone','../user/user.entity','账户信息已经存在、迁移无效','chatLogEntity','createBaseUserBalance','YYYY-MM-DD','map','saveCommissionAmount','upgradeBalance','metadata','../sales/salesUsers.entity','model4Count','addBalanceToNewUser','153853DyjPVu','saveRecordRechargeLog','configKey','findOne','configEntity','debug','查询用户账户信息失败！','invitedGuestSendModel4Count','../../common/utils/date','userBalanceEntity','save','goodsId','Injectable','memberDrawMjCount','__param','充值失败','function','YYYY-MM-DD\x20HH:mm:ss','defineProperty','total','firstRegisterSendStatus','../chatGroup/chatGroup.entity','10TxnZFB','configVal','count','WhiteListEntity','mjDraw','avatar','find','formatCreateOrUpdateDate','error:\x20','缺失当前套餐ID、充值失败！','MidjourneyEntity','visitor','inheritVisitorData','validateVisitorBalance','log','useModel4Count','./fingerprint.entity','update','model3Count','expirationTime','inviteGiveSendModel4Count','BalanceService','./userBalance.entity','ChatLogEntity','ChatGroupEntity','invitedGuestSendDrawMjCount','registerSendStatus','旧账户信息迁移失败','affected','whiteListEntity','__decorate','isUpdatedToday','10BfsIxF','cramiPackageEntity','upgradeStatus','./accountLog.entity','length','REG_GIFT','visitorModel4Num','1519245CAgSBV','createRandomUid','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','@nestjs/common','AccountLogEntity','includes','firstRregisterSendDrawMjCount','day','BAD_REQUEST','---','model4','userId','LessThan','validateBalance','140885UQqYwC','1433144HGyRgc','../../common/constants/balance.constant','useModel3Token','then','weight','PAYMENT_REQUIRED','reduce','../globalConfig/globalConfig.service','__metadata','useCount','userEntity','queryUserBalance','fingerprintLogEntity'];_0x3f23=function(){return _0x11a181;};return _0x3f23();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0xe5c1c9(0x147)]=void 0x0;const globalConfig_service_1=require(_0xe5c1c9(0xff)),typeorm_1=require('@nestjs/typeorm'),balance_entity_1=require(_0xe5c1c9(0x13c)),common_1=require(_0xe5c1c9(0xec)),typeorm_2=require(_0xe5c1c9(0x157)),balance_constant_1=require(_0xe5c1c9(0xf9)),accountLog_entity_1=require(_0xe5c1c9(0xe5)),utils_1=require(_0xe5c1c9(0x141)),config_entity_1=require(_0xe5c1c9(0x152)),cramiPackage_entity_1=require(_0xe5c1c9(0x91)),userBalance_entity_1=require(_0xe5c1c9(0xd8)),date_1=require(_0xe5c1c9(0xb4)),user_entity_1=require(_0xe5c1c9(0xa0)),salesUsers_entity_1=require(_0xe5c1c9(0xa9)),sales_service_1=require(_0xe5c1c9(0x110)),whiteList_entity_1=require('../chatgpt/whiteList.entity'),fingerprint_entity_1=require(_0xe5c1c9(0xd2)),chatLog_entity_1=require('../chatLog/chatLog.entity'),chatGroup_entity_1=require(_0xe5c1c9(0xc1)),midjourney_entity_1=require(_0xe5c1c9(0x146));let UserBalanceService=class UserBalanceService{constructor(_0x37a49d,_0x23cf12,_0x3a42f2,_0x396cc7,_0x4180b0,_0x5d7ba7,_0xdc9e8f,_0x176e34,_0x49d9fa,_0x3e063f,_0x18d8b5,_0x59f806,_0x3f3116,_0x52e1bd){const _0x217116=_0xe5c1c9;this['balanceEntity']=_0x37a49d,this['userBalanceEntity']=_0x23cf12,this[_0x217116(0x12a)]=_0x3a42f2,this[_0x217116(0xe3)]=_0x396cc7,this[_0x217116(0xb0)]=_0x4180b0,this[_0x217116(0x102)]=_0x5d7ba7,this[_0x217116(0x13e)]=_0xdc9e8f,this[_0x217116(0xdf)]=_0x176e34,this['fingerprintLogEntity']=_0x49d9fa,this[_0x217116(0x94)]=_0x3e063f,this[_0x217116(0xa2)]=_0x18d8b5,this[_0x217116(0x124)]=_0x59f806,this[_0x217116(0x13a)]=_0x3f3116,this[_0x217116(0x121)]=_0x52e1bd;}async[_0xe5c1c9(0xab)](_0x11ae3f,_0x1d5b43){const _0x300afb=_0xe5c1c9;try{const _0x54506b=await this[_0x300afb(0xb0)][_0x300afb(0xc8)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x300afb(0xdc),_0x300afb(0x156),_0x300afb(0x155),_0x300afb(0x13d),_0x300afb(0xc0),_0x300afb(0x126),'firstRregisterSendModel3Count','firstRregisterSendModel4Count',_0x300afb(0xef),_0x300afb(0x11f),_0x300afb(0x95),_0x300afb(0xd6),'inviteGiveSendDrawMjCount',_0x300afb(0x143),_0x300afb(0xdb),'invitedGuestSendModel4Count'])}}),_0x6c4c69=_0x54506b[_0x300afb(0xfe)]((_0x91c782,_0x4833c2)=>{const _0xcef7ec=_0x300afb,_0x7a3cae=Number(_0x4833c2[_0xcef7ec(0xc3)]),_0x1549ca=Number['isInteger'](_0x7a3cae)&&_0x7a3cae>0x0?_0x7a3cae:0x0;return _0x91c782[_0x4833c2[_0xcef7ec(0xae)]]=_0x1549ca,_0x91c782;},{});let _0x4a7fd7=0x0,_0x464c60=0x0,_0x3681e3=0x0;_0x6c4c69[_0x300afb(0xdc)]===0x1&&(_0x4a7fd7=_0x4a7fd7+_0x6c4c69[_0x300afb(0x156)],_0x464c60=_0x464c60+_0x6c4c69[_0x300afb(0x155)],_0x3681e3=_0x3681e3+_0x6c4c69[_0x300afb(0x13d)]),_0x6c4c69[_0x300afb(0xdc)]===0x1&&_0x6c4c69['firstRegisterSendStatus']===0x1&&_0x11ae3f<=_0x6c4c69[_0x300afb(0x126)]&&(_0x4a7fd7=_0x4a7fd7+_0x6c4c69[_0x300afb(0x139)],_0x464c60=_0x464c60+_0x6c4c69[_0x300afb(0x144)],_0x3681e3=_0x3681e3+_0x6c4c69[_0x300afb(0xef)]),await this[_0x300afb(0xad)]({'userId':_0x11ae3f,'rechargeType':balance_constant_1[_0x300afb(0x99)][_0x300afb(0xe7)],'model3Count':_0x4a7fd7,'drawMjCount':_0x3681e3,'model4Count':_0x464c60}),_0x1d5b43&&(Number(_0x6c4c69[_0x300afb(0x11f)])===0x1&&(_0x4a7fd7=_0x4a7fd7+Number(_0x6c4c69['invitedGuestSendModel3Count']),_0x464c60=_0x464c60+Number(_0x6c4c69[_0x300afb(0xb3)]),_0x3681e3=_0x3681e3+Number(_0x6c4c69[_0x300afb(0xdb)]),await this[_0x300afb(0xad)]({'userId':_0x11ae3f,'rechargeType':balance_constant_1[_0x300afb(0x99)]['INVITE_GIFT'],'model3Count':_0x6c4c69[_0x300afb(0x143)],'model4Count':_0x6c4c69[_0x300afb(0xb3)],'drawMjCount':_0x6c4c69[_0x300afb(0xdb)]}),await this[_0x300afb(0x14d)](_0x1d5b43,{'model3Count':_0x6c4c69['inviteGiveSendModel3Count'],'model4Count':_0x6c4c69[_0x300afb(0xd6)],'drawMjCount':_0x6c4c69[_0x300afb(0x10d)]}),await this[_0x300afb(0xad)]({'userId':_0x1d5b43,'rechargeType':balance_constant_1[_0x300afb(0x99)][_0x300afb(0x11d)],'model3Count':_0x6c4c69[_0x300afb(0x95)],'model4Count':_0x6c4c69['inviteGiveSendModel4Count'],'drawMjCount':_0x6c4c69['inviteGiveSendDrawMjCount']}))),await this[_0x300afb(0xb5)]['save']({'userId':_0x11ae3f,'model3Count':_0x4a7fd7,'model4Count':_0x464c60,'drawMjCount':_0x3681e3,'useTokens':0x0});}catch(_0x34ac4b){console[_0x300afb(0xd0)]('error:\x20',_0x34ac4b);throw new common_1[(_0x300afb(0x150))]('注册赠送失败,请联系管理员！',common_1[_0x300afb(0x9c)][_0x300afb(0xf1)]);}}async[_0xe5c1c9(0xf6)](_0x4a95fd,_0x48d929,_0x44f2ba){const _0x27b14f=_0xe5c1c9,{id:_0x48c2f3,role:_0x574486}=_0x4a95fd[_0x27b14f(0x149)];let _0x2d3540=await this[_0x27b14f(0xb5)]['findOne']({'where':{'userId':_0x48c2f3}});!_0x2d3540&&(_0x2d3540=await this[_0x27b14f(0xa3)](_0x48c2f3));if(_0x574486===_0x27b14f(0xcd))return this[_0x27b14f(0xcf)](_0x4a95fd,_0x48d929,_0x44f2ba);const _0x81b81e=await this['configEntity'][_0x27b14f(0xaf)]({'where':{'configKey':_0x27b14f(0x128)}}),_0x54ae59=_0x81b81e?_0x81b81e['configVal']:_0x27b14f(0xf2),_0x3ecca7=_0x48d929===_0x27b14f(0x154)?_0x27b14f(0x108):_0x48d929===_0x27b14f(0xf3)?_0x27b14f(0x142):_0x48d929===_0x27b14f(0xc6)?_0x27b14f(0xb9):null,_0xbfa4bb=_0x48d929===_0x27b14f(0x154)?_0x27b14f(0xd4):_0x48d929===_0x27b14f(0xf3)?'model4Count':_0x48d929===_0x27b14f(0xc6)?_0x27b14f(0x131):null;if(_0x2d3540[_0x27b14f(0x10f)]&&_0x2d3540[_0x3ecca7]<_0x44f2ba){if(_0x2d3540[_0xbfa4bb]<_0x44f2ba)throw new common_1[(_0x27b14f(0x150))](_0x27b14f(0xeb)+_0x54ae59+_0x27b14f(0x9b),common_1['HttpStatus']['PAYMENT_REQUIRED']);}if(!_0x2d3540[_0x27b14f(0x10f)]&&_0x2d3540[_0xbfa4bb]<_0x44f2ba)throw new common_1[(_0x27b14f(0x150))]('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x54ae59+_0x27b14f(0x9b),common_1[_0x27b14f(0x9c)][_0x27b14f(0xfd)]);return _0x2d3540;}async[_0xe5c1c9(0xcf)](_0x2f79e1,_0x560c6d,_0x18c18f){const _0x609469=_0xe5c1c9,{id:_0x18d20f}=_0x2f79e1[_0x609469(0x149)],_0x14b677=_0x560c6d===_0x609469(0x154)?_0x609469(0xd4):_0x560c6d===_0x609469(0xf3)?_0x609469(0xaa):_0x560c6d===_0x609469(0xc6)?'drawMjCount':null,_0x2eedc2=new Date(),_0xfe73ca=await this[_0x609469(0x104)]['findOne']({'where':{'fingerprint':_0x18d20f}}),{visitorModel3Num:_0x507045,visitorModel4Num:_0x1db4dc,visitorMJNum:_0x1a2604}=await this[_0x609469(0x121)][_0x609469(0x123)]([_0x609469(0x9e),_0x609469(0xe8),_0x609469(0x10b)]),_0x3bdd21={'model3Count':_0x507045?Number(_0x507045):0x0,'model4Count':_0x1db4dc?Number(_0x1db4dc):0x0,'drawMjCount':_0x1a2604?Number(_0x1a2604):0x0};if(!_0xfe73ca){const _0x516759={'fingerprint':_0x18d20f,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x516759[_0x14b677]=_0x516759[_0x14b677]+_0x18c18f;if(_0x516759[_0x14b677]>_0x3bdd21[_0x14b677])throw new common_1[(_0x609469(0x150))](_0x609469(0x135),common_1[_0x609469(0x9c)]['PAYMENT_REQUIRED']);else return await this[_0x609469(0x104)][_0x609469(0xb6)](_0x516759),!![];}else{const {model3Count:_0x29ff23,model4Count:_0x4f4dca,drawMjCount:_0x27ab41}=_0xfe73ca;let _0x190d1f={'model3Count':_0x29ff23,'model4Count':_0x4f4dca,'drawMjCount':_0x27ab41};const _0x42017d=Number(new Date(_0xfe73ca['updatedAt'])),_0x137db4=this[_0x609469(0xe1)](_0x42017d);_0x137db4?_0x190d1f[_0x14b677]=_0x190d1f[_0x14b677]+_0x18c18f:(_0x190d1f={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x190d1f[_0x14b677]=_0x190d1f[_0x14b677]+_0x18c18f);if(_0x190d1f[_0x14b677]>_0x3bdd21[_0x14b677])throw new common_1[(_0x609469(0x150))](_0x609469(0x135),common_1['HttpStatus'][_0x609469(0xfd)]);else return await this[_0x609469(0x104)][_0x609469(0xd3)]({'fingerprint':_0x18d20f},_0x190d1f),!![];}}[_0xe5c1c9(0xe1)](_0x446d09){const _0x1c2a31=_0xe5c1c9,_0x5652ae=new Date(),_0x5ca052=new Date(_0x5652ae[_0x1c2a31(0x90)](),_0x5652ae[_0x1c2a31(0x132)](),_0x5652ae['getDate']());return _0x446d09>=_0x5ca052;}async[_0xe5c1c9(0x9d)](_0x5c8392,_0x40a286,_0x4537dc,_0x3da20e=0x0){const _0x1318f6=_0xe5c1c9,_0xfe3658=await this['userBalanceEntity'][_0x1318f6(0xaf)]({'where':{'userId':_0x5c8392}});if(!_0xfe3658)throw new common_1[(_0x1318f6(0x150))](_0x1318f6(0x122),common_1[_0x1318f6(0x9c)]['BAD_REQUEST']);const _0x31e90d=_0x40a286===_0x1318f6(0x154)?_0x1318f6(0x108):_0x40a286===_0x1318f6(0xf3)?_0x1318f6(0x142):_0x40a286==='mjDraw'?_0x1318f6(0xb9):null,_0x5e99ec=_0x40a286==='model3'?'model3Count':_0x40a286===_0x1318f6(0xf3)?_0x1318f6(0xaa):_0x40a286===_0x1318f6(0xc6)?_0x1318f6(0x131):null,_0x2d409a=_0xfe3658['packageId']&&_0xfe3658[_0x31e90d]<_0x4537dc?_0x5e99ec:_0xfe3658['packageId']?_0x31e90d:_0x5e99ec;let _0xf73a04=null;_0x2d409a[_0x1318f6(0xee)]('odel3')&&(_0xf73a04=_0x1318f6(0xfa));_0x2d409a[_0x1318f6(0xee)]('odel4')&&(_0xf73a04=_0x1318f6(0x109));_0x2d409a[_0x1318f6(0xee)](_0x1318f6(0x151))&&(_0xf73a04=_0x1318f6(0x117));const _0x2c8c20={[_0x2d409a]:_0xfe3658[_0x2d409a]-_0x4537dc<0x0?0x0:_0xfe3658[_0x2d409a]-_0x4537dc,[_0xf73a04]:_0xfe3658[_0xf73a04]+_0x3da20e};_0xf73a04===_0x1318f6(0xfa)&&(_0x2c8c20[_0x1318f6(0x12e)]=_0xfe3658['useModel3Count']+_0x4537dc),_0xf73a04===_0x1318f6(0x109)&&(_0x2c8c20[_0x1318f6(0xd1)]=_0xfe3658[_0x1318f6(0xd1)]+_0x4537dc);const _0x4154e6=await this[_0x1318f6(0xb5)][_0x1318f6(0xd3)]({'userId':_0x5c8392},_0x2c8c20);if(_0x4154e6[_0x1318f6(0xde)]===0x0)throw new common_1[(_0x1318f6(0x150))](_0x1318f6(0x8f),common_1['HttpStatus'][_0x1318f6(0xf1)]);}async[_0xe5c1c9(0x103)](_0x2469c9){const _0x265ce8=_0xe5c1c9;try{const _0x248b1a=await this[_0x265ce8(0xb5)][_0x265ce8(0xaf)]({'where':{'userId':_0x2469c9},'select':[_0x265ce8(0x10f),_0x265ce8(0xd4),_0x265ce8(0xaa),_0x265ce8(0x131),'memberModel3Count',_0x265ce8(0x142),'memberDrawMjCount','useModel3Count',_0x265ce8(0xd1),'useModel3Token',_0x265ce8(0x109),_0x265ce8(0x117),_0x265ce8(0xd5)]});if(!_0x248b1a){const _0x18c100=await this['createBaseUserBalance'](_0x2469c9);if(_0x18c100)return await this[_0x265ce8(0x103)](_0x2469c9);else throw new common_1['HttpException'](_0x265ce8(0x11b),common_1[_0x265ce8(0x9c)][_0x265ce8(0xf1)]);}return _0x248b1a['sumModel3Count']=_0x248b1a[_0x265ce8(0x10f)]?_0x248b1a[_0x265ce8(0xd4)]+_0x248b1a[_0x265ce8(0x108)]:_0x248b1a[_0x265ce8(0xd4)],_0x248b1a[_0x265ce8(0x127)]=_0x248b1a[_0x265ce8(0x10f)]?_0x248b1a[_0x265ce8(0xaa)]+_0x248b1a[_0x265ce8(0x142)]:_0x248b1a[_0x265ce8(0xaa)],_0x248b1a[_0x265ce8(0x8d)]=_0x248b1a[_0x265ce8(0x10f)]?_0x248b1a['drawMjCount']+_0x248b1a[_0x265ce8(0xb9)]:_0x248b1a[_0x265ce8(0x131)],_0x248b1a['expirationTime']=_0x248b1a[_0x265ce8(0xd5)]?(0x0,date_1[_0x265ce8(0x153)])(_0x248b1a[_0x265ce8(0xd5)],_0x265ce8(0xa4)):null,_0x248b1a;}catch(_0x14f1a4){console[_0x265ce8(0xd0)](_0x265ce8(0xca),_0x14f1a4);}}async[_0xe5c1c9(0xad)](_0x1e06ba){const _0x1595ce=_0xe5c1c9,{userId:_0xef95f4,rechargeType:_0x25872f,model3Count:_0x809eaa,model4Count:_0x12de64,drawMjCount:_0x5d5ecc,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x1e06ba;if(!_0xef95f4)throw new common_1[(_0x1595ce(0x150))](_0x1595ce(0x140),common_1[_0x1595ce(0x9c)][_0x1595ce(0xf1)]);const _0x439248=(0x0,utils_1[_0x1595ce(0xea)])();return await this['accountLogEntity'][_0x1595ce(0xb6)]({'userId':_0xef95f4,'rechargeType':_0x25872f,'model3Count':_0x809eaa,'model4Count':_0x12de64,'drawMjCount':_0x5d5ecc,'days':days,'extent':extent,'uid':_0x439248,'pkgName':pkgName});}async[_0xe5c1c9(0xa3)](_0x2aaf24,_0x19d57e={}){const _0x14ba5b=_0xe5c1c9,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x19d57e,_0x5d4e5b=await this[_0x14ba5b(0xb5)]['findOne']({'where':{'userId':_0x2aaf24}});if(_0x5d4e5b)throw new common_1[(_0x14ba5b(0x150))](_0x14ba5b(0x120),common_1[_0x14ba5b(0x9c)][_0x14ba5b(0xf1)]);return await this[_0x14ba5b(0xb5)][_0x14ba5b(0xb6)]({'userId':_0x2aaf24,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0xe5c1c9(0x14d)](_0x4ea253,_0x368337,_0x2e2734=-0x1){const _0x5c6b21=_0xe5c1c9;try{const _0x42fd72=await this[_0x5c6b21(0xb5)]['findOne']({'where':{'userId':_0x4ea253}})||await this['createBaseUserBalance'](_0x4ea253);if(!_0x42fd72)throw new common_1[(_0x5c6b21(0x150))](_0x5c6b21(0xb2),common_1[_0x5c6b21(0x9c)][_0x5c6b21(0xf1)]);const {model3Count:_0xae1212,model4Count:_0x942fe2,drawMjCount:_0x45ec95,memberModel3Count:_0x4870c2,memberModel4Count:_0x589216,memberDrawMjCount:_0x13dc4e}=_0x42fd72;let _0x5bef4f={};if(_0x2e2734>0x0){const {packageId:_0x216923}=_0x368337;if(!_0x216923)throw new common_1[(_0x5c6b21(0x150))](_0x5c6b21(0xcb),common_1[_0x5c6b21(0x9c)]['BAD_REQUEST']);const _0x25e3fe=await this[_0x5c6b21(0xe3)][_0x5c6b21(0xaf)]({'where':{'id':_0x216923}});if(!_0x25e3fe)throw new common_1[(_0x5c6b21(0x150))](_0x5c6b21(0x112),common_1['HttpStatus']['BAD_REQUEST']);const {weight:_0xb79a59}=_0x25e3fe;if(!_0x42fd72[_0x5c6b21(0x10f)])_0x5bef4f={'memberModel3Count':_0xae1212+_0x368337[_0x5c6b21(0xd4)],'memberModel4Count':_0x942fe2+_0x368337[_0x5c6b21(0xaa)],'memberDrawMjCount':_0x45ec95+_0x368337[_0x5c6b21(0x131)],'expirationTime':(0x0,date_1[_0x5c6b21(0x14a)])()[_0x5c6b21(0x12b)](_0x2e2734>0x0?_0x2e2734:0x0,'day')['format']('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x216923};else{const _0x5cdaf3=await this['cramiPackageEntity'][_0x5c6b21(0xaf)]({'where':{'id':_0x42fd72[_0x5c6b21(0x10f)]}});_0xb79a59>=_0x5cdaf3[_0x5c6b21(0xfc)]&&(_0x5bef4f={'memberModel3Count':_0x4870c2+_0x368337['model3Count'],'memberModel4Count':_0x589216+_0x368337[_0x5c6b21(0xaa)],'memberDrawMjCount':_0x13dc4e+_0x368337['drawMjCount'],'expirationTime':(0x0,date_1[_0x5c6b21(0x14a)])(_0x42fd72[_0x5c6b21(0xd5)])['add'](_0x2e2734>0x0?_0x2e2734:0x0,_0x5c6b21(0xf0))[_0x5c6b21(0x138)](_0x5c6b21(0xbd)),'packageId':_0x216923}),_0xb79a59<_0x5cdaf3[_0x5c6b21(0xfc)]&&(_0x5bef4f={'memberModel3Count':_0x4870c2+_0x368337[_0x5c6b21(0xd4)],'memberModel4Count':_0x589216+_0x368337[_0x5c6b21(0xaa)],'memberDrawMjCount':_0x13dc4e+_0x368337[_0x5c6b21(0x131)]});}}_0x2e2734<=0x0&&(_0x5bef4f={'model3Count':_0xae1212+_0x368337[_0x5c6b21(0xd4)],'model4Count':_0x942fe2+_0x368337[_0x5c6b21(0xaa)],'drawMjCount':_0x45ec95+_0x368337[_0x5c6b21(0x131)]});const _0x111cab=await this[_0x5c6b21(0xb5)]['update']({'userId':_0x4ea253},_0x5bef4f);if(_0x111cab[_0x5c6b21(0xde)]===0x0)throw new common_1['HttpException'](_0x4ea253+_0x5c6b21(0xbb),common_1[_0x5c6b21(0x9c)][_0x5c6b21(0xf1)]);}catch(_0x316512){console['log'](_0x5c6b21(0xca),_0x316512);throw new common_1[(_0x5c6b21(0x150))]('用户充值失败！',common_1[_0x5c6b21(0x9c)][_0x5c6b21(0xf1)]);}}async['addBalanceToOrder'](_0x511d7b){const _0x4b2a75=_0xe5c1c9;console[_0x4b2a75(0xd0)](_0x4b2a75(0x92),_0x511d7b);try{const {userId:_0x17a298,goodsId:_0x2ed3b4}=_0x511d7b,_0x2fdf27=await this[_0x4b2a75(0xe3)]['findOne']({'where':{'id':_0x511d7b[_0x4b2a75(0xb7)],'status':0x1}});if(!_0x2fdf27)throw new common_1[(_0x4b2a75(0x150))](_0x4b2a75(0x137),common_1[_0x4b2a75(0x9c)]['BAD_REQUEST']);const {model3Count:_0x5a7e0c,model4Count:_0x5b801b,drawMjCount:_0x51a744,days:_0x4245ac,name:_0x148096}=_0x2fdf27,_0xb301e0={'model3Count':_0x5a7e0c,'model4Count':_0x5b801b,'drawMjCount':_0x51a744,'days':_0x4245ac,'packageId':_0x511d7b[_0x4b2a75(0xb7)]};await this['addBalanceToUser'](_0x17a298,_0xb301e0,_0x4245ac),await this[_0x4b2a75(0xad)]({'userId':_0x17a298,'rechargeType':balance_constant_1[_0x4b2a75(0x99)][_0x4b2a75(0x134)],'model3Count':_0x5a7e0c,'model4Count':_0x5b801b,'drawMjCount':_0x51a744,'pkgName':_0x148096,'days':_0x4245ac});const _0x2048b=await this[_0x4b2a75(0x102)][_0x4b2a75(0xaf)]({'where':{'id':_0x17a298}}),{invitedBy:_0x586224}=_0x2048b;if(_0x586224){const _0x4fb52d=await this[_0x4b2a75(0x102)][_0x4b2a75(0xaf)]({'where':{'inviteCode':_0x586224}}),_0x34e40e=await this[_0x4b2a75(0x13e)][_0x4b2a75(0xaf)]({'where':{'userId':_0x4fb52d['id']}});if(!_0x4fb52d)return;const {id:_0x131289}=_0x4fb52d,{performanceRatio:_0x31403d}=_0x34e40e,_0x38abed={'inviterUserId':_0x131289,'inviteeUserId':_0x17a298,'orderId':_0x511d7b['id'],'orderPrice':_0x511d7b[_0x4b2a75(0xbf)],'commissionPercentage':_0x31403d,'commissionAmount':(_0x511d7b[_0x4b2a75(0xbf)]*_0x31403d/0x64)['toFixed'](0x2)};await this[_0x4b2a75(0x13a)][_0x4b2a75(0x136)](_0x38abed),await this[_0x4b2a75(0x13a)][_0x4b2a75(0xa6)](_0x131289,_0x38abed['commissionAmount']);}}catch(_0x48a095){console['log'](_0x4b2a75(0xca),_0x48a095);throw new common_1['HttpException'](_0x4b2a75(0x119),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0xe5c1c9(0x114)](_0x5bba20,_0x15873d){const _0x16c83a=_0xe5c1c9,{page:page=0x1,size:size=0x14}=_0x15873d,{id:_0x48ae80}=_0x5bba20[_0x16c83a(0x149)],[_0xe5cf9c,_0x4e8db8]=await this[_0x16c83a(0x12a)][_0x16c83a(0x14c)]({'where':{'userId':_0x48ae80},'order':{'id':_0x16c83a(0x97)},'skip':(page-0x1)*size,'take':size});return _0xe5cf9c[_0x16c83a(0x13b)](_0x142172=>{const _0x166419=_0x16c83a;_0x142172['expireDateCn']=_0x142172['days']>0x0?_0x142172[_0x166419(0x133)]+'天':'永久';}),{'rows':(0x0,date_1[_0x16c83a(0xc9)])(_0xe5cf9c),'count':_0x4e8db8};}async[_0xe5c1c9(0x113)](_0xf33733,_0x30c355){const _0x40f907=_0xe5c1c9;try{const {page:page=0x1,size:size=0xa,userId:_0x2d01c2,rechargeType:_0x3d3685,packageId:_0x24751e}=_0x30c355,{role:_0x133780}=_0xf33733[_0x40f907(0x149)],_0xa88fb4={};_0x3d3685&&(_0xa88fb4[_0x40f907(0x115)]=_0x3d3685),_0xa88fb4['userId']=_0x2d01c2||(0x0,typeorm_2[_0x40f907(0xf5)])(0x186a0),_0x24751e&&(_0xa88fb4[_0x40f907(0x10f)]={'$like':'%'+_0x24751e+'%'});const [_0xe6138a,_0x3184a2]=await this[_0x40f907(0x12a)][_0x40f907(0x14c)]({'where':_0xa88fb4,'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size}),_0x23ecf2=_0xe6138a[_0x40f907(0xa5)](_0x4c6946=>_0x4c6946[_0x40f907(0xf4)]),_0x2975ac=await this['userEntity'][_0x40f907(0xc8)]({'where':{'id':(0x0,typeorm_2['In'])(_0x23ecf2)}});return _0xe6138a[_0x40f907(0x13b)](_0x31bef8=>{const _0x54b6bb=_0x40f907,_0x35ff3a=_0x2975ac[_0x54b6bb(0xc8)](_0x232a1d=>_0x232a1d['id']===_0x31bef8[_0x54b6bb(0xf4)]);_0x31bef8[_0x54b6bb(0x14f)]=_0x35ff3a===null||_0x35ff3a===void 0x0?void 0x0:_0x35ff3a['username'],_0x31bef8[_0x54b6bb(0x106)]=_0x35ff3a===null||_0x35ff3a===void 0x0?void 0x0:_0x35ff3a[_0x54b6bb(0x106)],_0x31bef8[_0x54b6bb(0x9f)]=_0x35ff3a===null||_0x35ff3a===void 0x0?void 0x0:_0x35ff3a['phone'],_0x31bef8['status']=_0x35ff3a===null||_0x35ff3a===void 0x0?void 0x0:_0x35ff3a['status'],_0x31bef8[_0x54b6bb(0xc7)]=_0x35ff3a===null||_0x35ff3a===void 0x0?void 0x0:_0x35ff3a[_0x54b6bb(0xc7)];}),_0x133780!==_0x40f907(0x105)&&_0xe6138a[_0x40f907(0x13b)](_0x40f255=>{const _0x41aead=_0x40f907;_0x40f255[_0x41aead(0x106)]=_0x40f255[_0x41aead(0x106)]?(0x0,utils_1[_0x41aead(0x116)])(_0x40f255['email']):'',_0x40f255[_0x41aead(0x9f)]=_0x40f255[_0x41aead(0x9f)]?(0x0,utils_1[_0x41aead(0x116)])(_0x40f255[_0x41aead(0x9f)]):'';}),{'rows':_0xe6138a,'count':_0x3184a2};}catch(_0x204021){console['log']('error:\x20',_0x204021);throw new common_1['HttpException'](_0x40f907(0x10e),common_1['HttpStatus'][_0x40f907(0xf1)]);}}async['queryUserBalanceByIds'](_0x277ae8){const _0x45afd9=_0xe5c1c9;return await this[_0x45afd9(0xb5)][_0x45afd9(0xc8)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x277ae8)}});}async[_0xe5c1c9(0x12c)](_0x558e08,_0x134121){const _0x3bc618=_0xe5c1c9;return await this[_0x3bc618(0x9d)](_0x558e08,'mjDraw',-_0x134121);}async[_0xe5c1c9(0xa7)](){const _0x4c351a=_0xe5c1c9,_0x51f84a=await this[_0x4c351a(0x102)][_0x4c351a(0xc8)]();if(!_0x51f84a['length'])return;const _0x465771=await this[_0x4c351a(0x121)]['getConfigs']([_0x4c351a(0xe4)]);if(!_0x465771)await this['globalConfigService'][_0x4c351a(0x14e)]({'settings':[{'configKey':_0x4c351a(0xe4),'configVal':'1'}]});else throw new common_1[(_0x4c351a(0x150))]('您已经升级过了、请勿重复操作！',common_1[_0x4c351a(0x9c)][_0x4c351a(0xf1)]);_0x51f84a[_0x4c351a(0x13b)](_0x10ccba=>{const _0x3c053f=_0x4c351a,{id:_0x4774fb}=_0x10ccba;this['balanceEntity'][_0x3c053f(0xaf)]({'where':{'userId':_0x4774fb}})[_0x3c053f(0xfb)](_0xb4f34e=>{const _0x3045a0=_0x3c053f;if(!_0xb4f34e)return;this[_0x3045a0(0x118)](_0x4774fb,_0xb4f34e);});});}async[_0xe5c1c9(0x118)](_0x4fd0d6,_0x422952){const _0x21d175=_0xe5c1c9,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x422952,_0x19e60d=await this[_0x21d175(0xdf)][_0x21d175(0xaf)]({'where':{'userId':_0x4fd0d6}}),_0x1e0527={'userId':_0x4fd0d6,'model3Count':Number(usesLeft),'model4Count':(_0x19e60d===null||_0x19e60d===void 0x0?void 0x0:_0x19e60d[_0x21d175(0xc4)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x19e60d===null||_0x19e60d===void 0x0?void 0x0:_0x19e60d[_0x21d175(0x101)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x56100a=await this[_0x21d175(0xb5)][_0x21d175(0xaf)]({'where':{'userId':_0x4fd0d6}});_0x56100a?common_1[_0x21d175(0x98)][_0x21d175(0xb1)]('用户'+_0x4fd0d6+_0x21d175(0xa1),'BalanceService'):this[_0x21d175(0xb5)][_0x21d175(0xb6)](_0x1e0527)['then'](_0x3e64a4=>{const _0x53c42a=_0x21d175;common_1[_0x53c42a(0x98)][_0x53c42a(0xb1)]('用户'+_0x4fd0d6+'旧账户信息迁移成功',_0x53c42a(0xd7));})['catch'](_0xf24dea=>{const _0x6e4d9d=_0x21d175;console['log'](_0x6e4d9d(0xca),_0xf24dea),common_1[_0x6e4d9d(0x98)][_0x6e4d9d(0xb1)]('用户'+_0x4fd0d6+_0x6e4d9d(0xdd),'BalanceService');});}async[_0xe5c1c9(0xce)](_0x352bd9){const _0x48bbdc=_0xe5c1c9,{fingerprint:_0x4c1c3f}=_0x352bd9['headers'],{id:_0x2b89ac}=_0x352bd9[_0x48bbdc(0x149)];return await this['chatLogEntity']['update']({'userId':Number(_0x4c1c3f)},{'userId':_0x2b89ac}),await this[_0x48bbdc(0x94)][_0x48bbdc(0xd3)]({'userId':Number(_0x4c1c3f)},{'userId':_0x2b89ac}),await this[_0x48bbdc(0x124)][_0x48bbdc(0xd3)]({'userId':Number(_0x4c1c3f)},{'userId':_0x2b89ac}),0x1;}async[_0xe5c1c9(0x12f)](_0x2bfd04){const _0x3f1754=_0xe5c1c9,{fingerprint:_0x369664}=_0x2bfd04[_0x3f1754(0x11a)],_0x28030e=await this[_0x3f1754(0xa2)]['count']({'where':{'userId':_0x369664}}),_0x15a01c=await this[_0x3f1754(0x94)][_0x3f1754(0xc4)]({'where':{'userId':_0x369664}}),_0x26cb89=await this[_0x3f1754(0x124)][_0x3f1754(0xc4)]({'where':{'userId':_0x369664}});return _0x28030e||_0x15a01c||_0x26cb89||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0xe5c1c9(0xb8)])(),__param(0x0,(0x0,typeorm_1[_0xe5c1c9(0x125)])(balance_entity_1[_0xe5c1c9(0x10a)])),__param(0x1,(0x0,typeorm_1[_0xe5c1c9(0x125)])(userBalance_entity_1[_0xe5c1c9(0x12d)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1[_0xe5c1c9(0xed)])),__param(0x3,(0x0,typeorm_1[_0xe5c1c9(0x125)])(cramiPackage_entity_1[_0xe5c1c9(0x96)])),__param(0x4,(0x0,typeorm_1[_0xe5c1c9(0x125)])(config_entity_1[_0xe5c1c9(0x130)])),__param(0x5,(0x0,typeorm_1[_0xe5c1c9(0x125)])(user_entity_1[_0xe5c1c9(0x111)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1[_0xe5c1c9(0x11c)])),__param(0x7,(0x0,typeorm_1[_0xe5c1c9(0x125)])(whiteList_entity_1[_0xe5c1c9(0xc5)])),__param(0x8,(0x0,typeorm_1[_0xe5c1c9(0x125)])(fingerprint_entity_1['FingerprintLogEntity'])),__param(0x9,(0x0,typeorm_1[_0xe5c1c9(0x125)])(chatGroup_entity_1[_0xe5c1c9(0xda)])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0xe5c1c9(0xd9)])),__param(0xb,(0x0,typeorm_1[_0xe5c1c9(0x125)])(midjourney_entity_1[_0xe5c1c9(0xcc)])),__metadata(_0xe5c1c9(0x11e),[typeorm_2[_0xe5c1c9(0x9a)],typeorm_2[_0xe5c1c9(0x9a)],typeorm_2[_0xe5c1c9(0x9a)],typeorm_2[_0xe5c1c9(0x9a)],typeorm_2[_0xe5c1c9(0x9a)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0xe5c1c9(0x9a)],typeorm_2['Repository'],typeorm_2[_0xe5c1c9(0x9a)],typeorm_2[_0xe5c1c9(0x9a)],typeorm_2['Repository'],sales_service_1[_0xe5c1c9(0x13f)],globalConfig_service_1[_0xe5c1c9(0x148)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;