'use strict';const _0x419ab6=_0x5840;(function(_0x4d8bfe,_0x2cc8d4){const _0x6e95dd=_0x5840,_0x16eb06=_0x4d8bfe();while(!![]){try{const _0xb79570=-parseInt(_0x6e95dd(0x1cd))/0x1*(parseInt(_0x6e95dd(0x276))/0x2)+parseInt(_0x6e95dd(0x273))/0x3*(parseInt(_0x6e95dd(0x23a))/0x4)+parseInt(_0x6e95dd(0x21e))/0x5+-parseInt(_0x6e95dd(0x214))/0x6*(-parseInt(_0x6e95dd(0x229))/0x7)+parseInt(_0x6e95dd(0x218))/0x8*(parseInt(_0x6e95dd(0x1c3))/0x9)+parseInt(_0x6e95dd(0x24b))/0xa*(parseInt(_0x6e95dd(0x23f))/0xb)+-parseInt(_0x6e95dd(0x1eb))/0xc*(parseInt(_0x6e95dd(0x220))/0xd);if(_0xb79570===_0x2cc8d4)break;else _0x16eb06['push'](_0x16eb06['shift']());}catch(_0x3726e9){_0x16eb06['push'](_0x16eb06['shift']());}}}(_0x28cd,0x8095f));function _0x5840(_0x33029c,_0x503cfb){const _0x28cd97=_0x28cd();return _0x5840=function(_0x5840f7,_0x16a12c){_0x5840f7=_0x5840f7-0x1b5;let _0x49b3de=_0x28cd97[_0x5840f7];return _0x49b3de;},_0x5840(_0x33029c,_0x503cfb);}var __decorate=this&&this[_0x419ab6(0x20e)]||function(_0x2ec6fb,_0x26ef5f,_0x3fb9d0,_0x4f16ac){const _0x282dc6=_0x419ab6;var _0x363c44=arguments[_0x282dc6(0x278)],_0x35ac5c=_0x363c44<0x3?_0x26ef5f:_0x4f16ac===null?_0x4f16ac=Object['getOwnPropertyDescriptor'](_0x26ef5f,_0x3fb9d0):_0x4f16ac,_0x2e6a8a;if(typeof Reflect===_0x282dc6(0x244)&&typeof Reflect[_0x282dc6(0x226)]===_0x282dc6(0x240))_0x35ac5c=Reflect[_0x282dc6(0x226)](_0x2ec6fb,_0x26ef5f,_0x3fb9d0,_0x4f16ac);else{for(var _0x4c6d27=_0x2ec6fb[_0x282dc6(0x278)]-0x1;_0x4c6d27>=0x0;_0x4c6d27--)if(_0x2e6a8a=_0x2ec6fb[_0x4c6d27])_0x35ac5c=(_0x363c44<0x3?_0x2e6a8a(_0x35ac5c):_0x363c44>0x3?_0x2e6a8a(_0x26ef5f,_0x3fb9d0,_0x35ac5c):_0x2e6a8a(_0x26ef5f,_0x3fb9d0))||_0x35ac5c;}return _0x363c44>0x3&&_0x35ac5c&&Object[_0x282dc6(0x275)](_0x26ef5f,_0x3fb9d0,_0x35ac5c),_0x35ac5c;},__metadata=this&&this['__metadata']||function(_0x82db7c,_0x4cfe06){const _0x22b335=_0x419ab6;if(typeof Reflect==='object'&&typeof Reflect[_0x22b335(0x213)]==='function')return Reflect[_0x22b335(0x213)](_0x82db7c,_0x4cfe06);},__param=this&&this['__param']||function(_0x28a312,_0x1b36bb){return function(_0x257547,_0x8514dc){_0x1b36bb(_0x257547,_0x8514dc,_0x28a312);};};Object['defineProperty'](exports,_0x419ab6(0x203),{'value':!![]}),exports[_0x419ab6(0x1ef)]=void 0x0;function _0x28cd(){const _0x320301=['../../common/utils','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','查询用户账户信息失败！','YYYY-MM-DD\x20HH:mm:ss','upgradeBalance','email','充值失败','username','model3Count','total','useModel3Token','registerSendModel3Count','visitorMJNum','formatDate','days','用户充值失败！','default','visitorModel3Num','setConfig','../globalConfig/globalConfig.service','user','145884OLavMC','缺失当前套餐ID、充值失败！','configKey','registerSendDrawMjCount','UserBalanceService','day','save','./accountLog.entity','expirationTime','Repository','BalanceEntity','writeOldBalanceToNewTable','HttpStatus','addBalanceToUser','REFER_GIFT','validateBalance','inviteGiveSendDrawMjCount','inheritVisitorData','getConfigs','查询用户账户失败！','reduce','注册赠送失败,请联系管理员！','firstRegisterSendStatus','globalConfigService','__esModule','缺失当前用户账户记录！','whiteListEntity','ChatGroupEntity','packageId','useCount','账户信息已经存在、迁移无效','design:paramtypes','../user/user.entity','userBalanceEntity','DESC','__decorate','useDrawMjToken','sumModel3Count','getVisitorCount','includes','metadata','6umYNbH','getDate','userEntity','createBaseUserBalance','96lQKKPT','registerSendStatus','avatar','configEntity','MidjourneyEntity','../chatgpt/whiteList.entity','1652240qalpnT','充值失败！','1287ZDktLH','UserEntity','registerSendModel4Count','旧账户信息迁移成功','firstRregisterSendModel3Count','getRechargeLog','decorate','./fingerprint.entity','invitedGuestSendModel3Count','3375953WNKMWW','then','goodsId','addBalanceToNewUser','saveRecordRechargeLog','model3','deductFromBalance','firstRregisterSendDrawMjCount','visitorModel4Num','ChatLogEntity','salesUsersEntity','充值的工单信息:','hideString','invitedGuestSendModel4Count','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','../globalConfig/config.entity','findAndCount','87136bFWJJx','catch','fingerprintLogEntity','../../common/constants/balance.constant','sumDrawMjCount','7824443PESCXu','function','inviteGiveSendModel3Count','validateVisitorBalance','isUpdatedToday','object','chatGroupEntity','phone','forEach','mjDraw','useModel4Count','BalanceService','10lMNOyr','PAYMENT_REQUIRED','headers','updatedAt','findOne','affected','memberDrawMjCount','isInteger','../chatLog/chatLog.entity','memberModel4Count','queryUserBalanceByIds','cramiPackageEntity','../sales/sales.service','visitor','upgradeStatus','getFullYear','log','add','model4','RechargeType','HttpException','drawMjCount','ConfigEntity','createSalesRecords','firstRregisterSendModel4Count','expireDateCn','useModel3Count','../midjourney/midjourney.entity','vxNumber','chatLogEntity','消费余额失败！','commissionAmount','inviteGiveSendModel4Count','REG_GIFT','firstRegisterSendRank','Injectable','./balance.entity','useModel4Token','configVal','getAccountLog','123FbEAzE','Logger','defineProperty','70LLjrDr','InjectRepository','length','saveCommissionAmount','queryUserBalance','>\x20或购买专属套餐\x20！','BAD_REQUEST','format','memberModel3Count','salesService','../sales/salesUsers.entity','LessThan','../crami/cramiPackage.entity','midjourneyEntity','count','MjCount','INVITE_GIFT','171117YlikOf','update','invitedGuestSendDrawMjCount','debug','error:\x20','GlobalConfigService','refundMjBalance','旧账户信息迁移失败','SCAN_PAY','当前用户无需创建账户信息！','26146sJAubK','find','userId','../chatGroup/chatGroup.entity','accountLogEntity','inviteSendStatus','AccountLogEntity','SalesUsersEntity','model4Count'];_0x28cd=function(){return _0x320301;};return _0x28cd();}const globalConfig_service_1=require(_0x419ab6(0x1e9)),typeorm_1=require('@nestjs/typeorm'),balance_entity_1=require(_0x419ab6(0x26f)),common_1=require('@nestjs/common'),typeorm_2=require('typeorm'),balance_constant_1=require(_0x419ab6(0x23d)),accountLog_entity_1=require(_0x419ab6(0x1f2)),utils_1=require(_0x419ab6(0x1d6)),config_entity_1=require(_0x419ab6(0x238)),cramiPackage_entity_1=require(_0x419ab6(0x1be)),userBalance_entity_1=require('./userBalance.entity'),date_1=require('../../common/utils/date'),user_entity_1=require(_0x419ab6(0x20b)),salesUsers_entity_1=require(_0x419ab6(0x1bc)),sales_service_1=require(_0x419ab6(0x257)),whiteList_entity_1=require(_0x419ab6(0x21d)),fingerprint_entity_1=require(_0x419ab6(0x227)),chatLog_entity_1=require(_0x419ab6(0x253)),chatGroup_entity_1=require(_0x419ab6(0x1d0)),midjourney_entity_1=require(_0x419ab6(0x266));let UserBalanceService=class UserBalanceService{constructor(_0x40f401,_0x4397ac,_0x272c1b,_0x31ab67,_0x1201fc,_0x52407c,_0x548306,_0x3d3ca2,_0x390999,_0x10598a,_0x50604e,_0x2980b6,_0x3e23d9,_0x42c62d){const _0x92b3c4=_0x419ab6;this['balanceEntity']=_0x40f401,this[_0x92b3c4(0x20c)]=_0x4397ac,this[_0x92b3c4(0x1d1)]=_0x272c1b,this[_0x92b3c4(0x256)]=_0x31ab67,this[_0x92b3c4(0x21b)]=_0x1201fc,this[_0x92b3c4(0x216)]=_0x52407c,this[_0x92b3c4(0x233)]=_0x548306,this['whiteListEntity']=_0x3d3ca2,this['fingerprintLogEntity']=_0x390999,this[_0x92b3c4(0x245)]=_0x10598a,this[_0x92b3c4(0x268)]=_0x50604e,this[_0x92b3c4(0x1bf)]=_0x2980b6,this[_0x92b3c4(0x1bb)]=_0x3e23d9,this[_0x92b3c4(0x202)]=_0x42c62d;}async[_0x419ab6(0x22c)](_0x4de3b9,_0x596557){const _0x1a09c8=_0x419ab6;try{const _0x457b1c=await this[_0x1a09c8(0x21b)][_0x1a09c8(0x1ce)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x1a09c8(0x219),_0x1a09c8(0x1e1),_0x1a09c8(0x222),_0x1a09c8(0x1ee),_0x1a09c8(0x201),_0x1a09c8(0x26d),_0x1a09c8(0x224),_0x1a09c8(0x263),_0x1a09c8(0x230),_0x1a09c8(0x1d2),_0x1a09c8(0x241),_0x1a09c8(0x26b),'inviteGiveSendDrawMjCount',_0x1a09c8(0x228),_0x1a09c8(0x1c5),_0x1a09c8(0x236)])}}),_0x426789=_0x457b1c[_0x1a09c8(0x1ff)]((_0x1f4389,_0x3dc6f9)=>{const _0x20a0ab=_0x1a09c8,_0x3ebb00=Number(_0x3dc6f9['configVal']),_0x4d93db=Number[_0x20a0ab(0x252)](_0x3ebb00)&&_0x3ebb00>0x0?_0x3ebb00:0x0;return _0x1f4389[_0x3dc6f9[_0x20a0ab(0x1ed)]]=_0x4d93db,_0x1f4389;},{});let _0x58dc41=0x0,_0x16f3ec=0x0,_0x242403=0x0;_0x426789[_0x1a09c8(0x219)]===0x1&&(_0x58dc41=_0x58dc41+_0x426789['registerSendModel3Count'],_0x16f3ec=_0x16f3ec+_0x426789[_0x1a09c8(0x222)],_0x242403=_0x242403+_0x426789[_0x1a09c8(0x1ee)]),_0x426789['registerSendStatus']===0x1&&_0x426789[_0x1a09c8(0x201)]===0x1&&_0x4de3b9<=_0x426789[_0x1a09c8(0x26d)]&&(_0x58dc41=_0x58dc41+_0x426789[_0x1a09c8(0x224)],_0x16f3ec=_0x16f3ec+_0x426789[_0x1a09c8(0x263)],_0x242403=_0x242403+_0x426789['firstRregisterSendDrawMjCount']),await this[_0x1a09c8(0x22d)]({'userId':_0x4de3b9,'rechargeType':balance_constant_1[_0x1a09c8(0x25e)][_0x1a09c8(0x26c)],'model3Count':_0x58dc41,'drawMjCount':_0x242403,'model4Count':_0x16f3ec}),_0x596557&&(Number(_0x426789[_0x1a09c8(0x1d2)])===0x1&&(_0x58dc41=_0x58dc41+Number(_0x426789[_0x1a09c8(0x228)]),_0x16f3ec=_0x16f3ec+Number(_0x426789[_0x1a09c8(0x236)]),_0x242403=_0x242403+Number(_0x426789[_0x1a09c8(0x1c5)]),await this[_0x1a09c8(0x22d)]({'userId':_0x4de3b9,'rechargeType':balance_constant_1[_0x1a09c8(0x25e)][_0x1a09c8(0x1c2)],'model3Count':_0x426789[_0x1a09c8(0x228)],'model4Count':_0x426789['invitedGuestSendModel4Count'],'drawMjCount':_0x426789[_0x1a09c8(0x1c5)]}),await this[_0x1a09c8(0x1f8)](_0x596557,{'model3Count':_0x426789[_0x1a09c8(0x241)],'model4Count':_0x426789[_0x1a09c8(0x26b)],'drawMjCount':_0x426789[_0x1a09c8(0x1fb)]}),await this[_0x1a09c8(0x22d)]({'userId':_0x596557,'rechargeType':balance_constant_1[_0x1a09c8(0x25e)][_0x1a09c8(0x1f9)],'model3Count':_0x426789[_0x1a09c8(0x241)],'model4Count':_0x426789[_0x1a09c8(0x26b)],'drawMjCount':_0x426789[_0x1a09c8(0x1fb)]}))),await this[_0x1a09c8(0x20c)][_0x1a09c8(0x1f1)]({'userId':_0x4de3b9,'model3Count':_0x58dc41,'model4Count':_0x16f3ec,'drawMjCount':_0x242403,'useTokens':0x0});}catch(_0x1f633c){console[_0x1a09c8(0x25b)](_0x1a09c8(0x1c7),_0x1f633c);throw new common_1[(_0x1a09c8(0x25f))](_0x1a09c8(0x200),common_1[_0x1a09c8(0x1f7)]['BAD_REQUEST']);}}async[_0x419ab6(0x1fa)](_0x569248,_0x17ce06,_0x1fdbe0){const _0x19c669=_0x419ab6,{id:_0x43a13e,role:_0x50de8b}=_0x569248[_0x19c669(0x1ea)];let _0x29e43a=await this[_0x19c669(0x20c)][_0x19c669(0x24f)]({'where':{'userId':_0x43a13e}});!_0x29e43a&&(_0x29e43a=await this[_0x19c669(0x217)](_0x43a13e));if(_0x50de8b===_0x19c669(0x258))return this[_0x19c669(0x242)](_0x569248,_0x17ce06,_0x1fdbe0);const _0x1a095a=await this[_0x19c669(0x21b)]['findOne']({'where':{'configKey':_0x19c669(0x267)}}),_0x46d18e=_0x1a095a?_0x1a095a[_0x19c669(0x271)]:'---',_0x434cef=_0x17ce06===_0x19c669(0x22e)?_0x19c669(0x1ba):_0x17ce06===_0x19c669(0x25d)?_0x19c669(0x254):_0x17ce06===_0x19c669(0x248)?_0x19c669(0x251):null,_0x4d059c=_0x17ce06===_0x19c669(0x22e)?_0x19c669(0x1de):_0x17ce06==='model4'?'model4Count':_0x17ce06===_0x19c669(0x248)?_0x19c669(0x260):null;if(_0x29e43a[_0x19c669(0x207)]&&_0x29e43a[_0x434cef]<_0x1fdbe0){if(_0x29e43a[_0x4d059c]<_0x1fdbe0)throw new common_1[(_0x19c669(0x25f))](_0x19c669(0x237)+_0x46d18e+_0x19c669(0x1b7),common_1[_0x19c669(0x1f7)][_0x19c669(0x24c)]);}if(!_0x29e43a['packageId']&&_0x29e43a[_0x4d059c]<_0x1fdbe0)throw new common_1[(_0x19c669(0x25f))](_0x19c669(0x237)+_0x46d18e+_0x19c669(0x1b7),common_1[_0x19c669(0x1f7)][_0x19c669(0x24c)]);return _0x29e43a;}async[_0x419ab6(0x242)](_0x49872b,_0x3a7488,_0x2ceac1){const _0x384c1e=_0x419ab6,{id:_0x4a44db}=_0x49872b[_0x384c1e(0x1ea)],_0x36a823=_0x3a7488===_0x384c1e(0x22e)?_0x384c1e(0x1de):_0x3a7488===_0x384c1e(0x25d)?_0x384c1e(0x1d5):_0x3a7488==='mjDraw'?'drawMjCount':null,_0x48003a=new Date(),_0x10e8ba=await this[_0x384c1e(0x23c)][_0x384c1e(0x24f)]({'where':{'fingerprint':_0x4a44db}}),{visitorModel3Num:_0x1b531d,visitorModel4Num:_0x334119,visitorMJNum:_0x833d9e}=await this[_0x384c1e(0x202)]['getConfigs']([_0x384c1e(0x1e7),_0x384c1e(0x231),_0x384c1e(0x1e2)]),_0x236f4f={'model3Count':_0x1b531d?Number(_0x1b531d):0x0,'model4Count':_0x334119?Number(_0x334119):0x0,'drawMjCount':_0x833d9e?Number(_0x833d9e):0x0};if(!_0x10e8ba){const _0x581e73={'fingerprint':_0x4a44db,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x581e73[_0x36a823]=_0x581e73[_0x36a823]+_0x2ceac1;if(_0x581e73[_0x36a823]>_0x236f4f[_0x36a823])throw new common_1[(_0x384c1e(0x25f))](_0x384c1e(0x1d7),common_1[_0x384c1e(0x1f7)][_0x384c1e(0x24c)]);else return await this[_0x384c1e(0x23c)]['save'](_0x581e73),!![];}else{const {model3Count:_0x5eb6a2,model4Count:_0x6aba5c,drawMjCount:_0x22ea10}=_0x10e8ba;let _0x3bc507={'model3Count':_0x5eb6a2,'model4Count':_0x6aba5c,'drawMjCount':_0x22ea10};const _0x3bebef=Number(new Date(_0x10e8ba[_0x384c1e(0x24e)])),_0x3f9333=this[_0x384c1e(0x243)](_0x3bebef);_0x3f9333?_0x3bc507[_0x36a823]=_0x3bc507[_0x36a823]+_0x2ceac1:(_0x3bc507={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x3bc507[_0x36a823]=_0x3bc507[_0x36a823]+_0x2ceac1);if(_0x3bc507[_0x36a823]>_0x236f4f[_0x36a823])throw new common_1[(_0x384c1e(0x25f))](_0x384c1e(0x1d7),common_1['HttpStatus']['PAYMENT_REQUIRED']);else return await this[_0x384c1e(0x23c)][_0x384c1e(0x1c4)]({'fingerprint':_0x4a44db},_0x3bc507),!![];}}[_0x419ab6(0x243)](_0xaa2e63){const _0x358ea4=_0x419ab6,_0x47b020=new Date(),_0x5d55c4=new Date(_0x47b020[_0x358ea4(0x25a)](),_0x47b020['getMonth'](),_0x47b020[_0x358ea4(0x215)]());return _0xaa2e63>=_0x5d55c4;}async[_0x419ab6(0x22f)](_0xaebd8a,_0x9a5322,_0x521491,_0x2b1e1b=0x0){const _0x350dc9=_0x419ab6,_0x570dc0=await this[_0x350dc9(0x20c)]['findOne']({'where':{'userId':_0xaebd8a}});if(!_0x570dc0)throw new common_1[(_0x350dc9(0x25f))](_0x350dc9(0x204),common_1[_0x350dc9(0x1f7)]['BAD_REQUEST']);const _0x118d3d=_0x9a5322===_0x350dc9(0x22e)?_0x350dc9(0x1ba):_0x9a5322===_0x350dc9(0x25d)?_0x350dc9(0x254):_0x9a5322===_0x350dc9(0x248)?_0x350dc9(0x251):null,_0x430d59=_0x9a5322===_0x350dc9(0x22e)?_0x350dc9(0x1de):_0x9a5322===_0x350dc9(0x25d)?_0x350dc9(0x1d5):_0x9a5322===_0x350dc9(0x248)?_0x350dc9(0x260):null,_0x35c8f5=_0x570dc0[_0x350dc9(0x207)]&&_0x570dc0[_0x118d3d]<_0x521491?_0x430d59:_0x570dc0[_0x350dc9(0x207)]?_0x118d3d:_0x430d59;let _0x3d1543=null;_0x35c8f5[_0x350dc9(0x212)]('odel3')&&(_0x3d1543=_0x350dc9(0x1e0));_0x35c8f5[_0x350dc9(0x212)]('odel4')&&(_0x3d1543=_0x350dc9(0x270));_0x35c8f5[_0x350dc9(0x212)](_0x350dc9(0x1c1))&&(_0x3d1543=_0x350dc9(0x20f));const _0x16b3ef={[_0x35c8f5]:_0x570dc0[_0x35c8f5]-_0x521491<0x0?0x0:_0x570dc0[_0x35c8f5]-_0x521491,[_0x3d1543]:_0x570dc0[_0x3d1543]+_0x2b1e1b};_0x3d1543===_0x350dc9(0x1e0)&&(_0x16b3ef[_0x350dc9(0x265)]=_0x570dc0[_0x350dc9(0x265)]+_0x521491),_0x3d1543===_0x350dc9(0x270)&&(_0x16b3ef[_0x350dc9(0x249)]=_0x570dc0[_0x350dc9(0x249)]+_0x521491);const _0x73c16c=await this[_0x350dc9(0x20c)][_0x350dc9(0x1c4)]({'userId':_0xaebd8a},_0x16b3ef);if(_0x73c16c[_0x350dc9(0x250)]===0x0)throw new common_1['HttpException'](_0x350dc9(0x269),common_1[_0x350dc9(0x1f7)]['BAD_REQUEST']);}async['queryUserBalance'](_0x11cee2){const _0x3213ff=_0x419ab6;try{const _0x11ca4b=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x11cee2},'select':[_0x3213ff(0x207),_0x3213ff(0x1de),_0x3213ff(0x1d5),_0x3213ff(0x260),_0x3213ff(0x1ba),'memberModel4Count',_0x3213ff(0x251),_0x3213ff(0x265),_0x3213ff(0x249),_0x3213ff(0x1e0),_0x3213ff(0x270),'useDrawMjToken','expirationTime']});if(!_0x11ca4b){const _0x2055fa=await this[_0x3213ff(0x217)](_0x11cee2);if(_0x2055fa)return await this[_0x3213ff(0x1b6)](_0x11cee2);else throw new common_1[(_0x3213ff(0x25f))]('查询当前用户余额失败！',common_1[_0x3213ff(0x1f7)][_0x3213ff(0x1b8)]);}return _0x11ca4b[_0x3213ff(0x210)]=_0x11ca4b['packageId']?_0x11ca4b['model3Count']+_0x11ca4b['memberModel3Count']:_0x11ca4b['model3Count'],_0x11ca4b['sumModel4Count']=_0x11ca4b[_0x3213ff(0x207)]?_0x11ca4b[_0x3213ff(0x1d5)]+_0x11ca4b[_0x3213ff(0x254)]:_0x11ca4b[_0x3213ff(0x1d5)],_0x11ca4b[_0x3213ff(0x23e)]=_0x11ca4b[_0x3213ff(0x207)]?_0x11ca4b[_0x3213ff(0x260)]+_0x11ca4b[_0x3213ff(0x251)]:_0x11ca4b['drawMjCount'],_0x11ca4b['expirationTime']=_0x11ca4b[_0x3213ff(0x1f3)]?(0x0,date_1[_0x3213ff(0x1e3)])(_0x11ca4b[_0x3213ff(0x1f3)],'YYYY-MM-DD'):null,_0x11ca4b;}catch(_0x15bf8d){console[_0x3213ff(0x25b)](_0x3213ff(0x1c7),_0x15bf8d);}}async[_0x419ab6(0x22d)](_0x2e26e1){const _0x5ca8b7=_0x419ab6,{userId:_0x169c0b,rechargeType:_0x41cf92,model3Count:_0x5def90,model4Count:_0xc9e38,drawMjCount:_0x376c8b,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x2e26e1;if(!_0x169c0b)throw new common_1['HttpException']('当前用户不存在,记录充值日志异常',common_1[_0x5ca8b7(0x1f7)][_0x5ca8b7(0x1b8)]);const _0x393980=(0x0,utils_1['createRandomUid'])();return await this[_0x5ca8b7(0x1d1)][_0x5ca8b7(0x1f1)]({'userId':_0x169c0b,'rechargeType':_0x41cf92,'model3Count':_0x5def90,'model4Count':_0xc9e38,'drawMjCount':_0x376c8b,'days':days,'extent':extent,'uid':_0x393980,'pkgName':pkgName});}async[_0x419ab6(0x217)](_0xb130a2,_0x4261a8={}){const _0x100bd4=_0x419ab6,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4261a8,_0x4586c2=await this[_0x100bd4(0x20c)][_0x100bd4(0x24f)]({'where':{'userId':_0xb130a2}});if(_0x4586c2)throw new common_1['HttpException'](_0x100bd4(0x1cc),common_1['HttpStatus'][_0x100bd4(0x1b8)]);return await this[_0x100bd4(0x20c)]['save']({'userId':_0xb130a2,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x419ab6(0x1f8)](_0x11b94b,_0x357579,_0x4701bc=-0x1){const _0x49e666=_0x419ab6;try{const _0x2abf3c=await this['userBalanceEntity'][_0x49e666(0x24f)]({'where':{'userId':_0x11b94b}})||await this[_0x49e666(0x217)](_0x11b94b);if(!_0x2abf3c)throw new common_1[(_0x49e666(0x25f))](_0x49e666(0x1d8),common_1['HttpStatus'][_0x49e666(0x1b8)]);const {model3Count:_0xa2aab6,model4Count:_0x46b0c7,drawMjCount:_0x43aac8,memberModel3Count:_0xfec90e,memberModel4Count:_0xf10a91,memberDrawMjCount:_0x507423}=_0x2abf3c;let _0x408fd5={};if(_0x4701bc>0x0){const {packageId:_0x658212}=_0x357579;if(!_0x658212)throw new common_1[(_0x49e666(0x25f))](_0x49e666(0x1ec),common_1['HttpStatus'][_0x49e666(0x1b8)]);const _0x1897ae=await this[_0x49e666(0x256)][_0x49e666(0x24f)]({'where':{'id':_0x658212}});if(!_0x1897ae)throw new common_1['HttpException']('当前套餐不存在！',common_1[_0x49e666(0x1f7)][_0x49e666(0x1b8)]);const {weight:_0x3a8a0c}=_0x1897ae;if(!_0x2abf3c[_0x49e666(0x207)])_0x408fd5={'memberModel3Count':_0xa2aab6+_0x357579[_0x49e666(0x1de)],'memberModel4Count':_0x46b0c7+_0x357579[_0x49e666(0x1d5)],'memberDrawMjCount':_0x43aac8+_0x357579['drawMjCount'],'expirationTime':(0x0,date_1[_0x49e666(0x1e6)])()[_0x49e666(0x25c)](_0x4701bc>0x0?_0x4701bc:0x0,_0x49e666(0x1f0))[_0x49e666(0x1b9)](_0x49e666(0x1d9)),'packageId':_0x658212};else{const _0x1de4fc=await this[_0x49e666(0x256)][_0x49e666(0x24f)]({'where':{'id':_0x2abf3c[_0x49e666(0x207)]}});_0x3a8a0c>=_0x1de4fc['weight']&&(_0x408fd5={'memberModel3Count':_0xfec90e+_0x357579['model3Count'],'memberModel4Count':_0xf10a91+_0x357579['model4Count'],'memberDrawMjCount':_0x507423+_0x357579['drawMjCount'],'expirationTime':(0x0,date_1[_0x49e666(0x1e6)])(_0x2abf3c['expirationTime'])['add'](_0x4701bc>0x0?_0x4701bc:0x0,_0x49e666(0x1f0))[_0x49e666(0x1b9)](_0x49e666(0x1d9)),'packageId':_0x658212}),_0x3a8a0c<_0x1de4fc['weight']&&(_0x408fd5={'memberModel3Count':_0xfec90e+_0x357579[_0x49e666(0x1de)],'memberModel4Count':_0xf10a91+_0x357579[_0x49e666(0x1d5)],'memberDrawMjCount':_0x507423+_0x357579[_0x49e666(0x260)]});}}_0x4701bc<=0x0&&(_0x408fd5={'model3Count':_0xa2aab6+_0x357579[_0x49e666(0x1de)],'model4Count':_0x46b0c7+_0x357579[_0x49e666(0x1d5)],'drawMjCount':_0x43aac8+_0x357579[_0x49e666(0x260)]});const _0x1ef2f4=await this[_0x49e666(0x20c)]['update']({'userId':_0x11b94b},_0x408fd5);if(_0x1ef2f4[_0x49e666(0x250)]===0x0)throw new common_1[(_0x49e666(0x25f))](_0x11b94b+_0x49e666(0x1dc),common_1['HttpStatus']['BAD_REQUEST']);}catch(_0x295513){console[_0x49e666(0x25b)](_0x49e666(0x1c7),_0x295513);throw new common_1[(_0x49e666(0x25f))](_0x49e666(0x1e5),common_1['HttpStatus'][_0x49e666(0x1b8)]);}}async['addBalanceToOrder'](_0x2ac347){const _0x4b579e=_0x419ab6;console[_0x4b579e(0x25b)](_0x4b579e(0x234),_0x2ac347);try{const {userId:_0x1c2aac,goodsId:_0x54774c}=_0x2ac347,_0x55558a=await this[_0x4b579e(0x256)][_0x4b579e(0x24f)]({'where':{'id':_0x2ac347[_0x4b579e(0x22b)],'status':0x1}});if(!_0x55558a)throw new common_1[(_0x4b579e(0x25f))]('非法操作、当前充值套餐暂不存在！',common_1[_0x4b579e(0x1f7)][_0x4b579e(0x1b8)]);const {model3Count:_0x2b4396,model4Count:_0x252606,drawMjCount:_0x38ed9b,days:_0x52c424,name:_0x409612}=_0x55558a,_0x38af73={'model3Count':_0x2b4396,'model4Count':_0x252606,'drawMjCount':_0x38ed9b,'days':_0x52c424,'packageId':_0x2ac347['goodsId']};await this[_0x4b579e(0x1f8)](_0x1c2aac,_0x38af73,_0x52c424),await this[_0x4b579e(0x22d)]({'userId':_0x1c2aac,'rechargeType':balance_constant_1[_0x4b579e(0x25e)][_0x4b579e(0x1cb)],'model3Count':_0x2b4396,'model4Count':_0x252606,'drawMjCount':_0x38ed9b,'pkgName':_0x409612,'days':_0x52c424});const _0x5cfd84=await this[_0x4b579e(0x216)][_0x4b579e(0x24f)]({'where':{'id':_0x1c2aac}}),{invitedBy:_0x4c840c}=_0x5cfd84;if(_0x4c840c){const _0x55c9ec=await this[_0x4b579e(0x216)][_0x4b579e(0x24f)]({'where':{'inviteCode':_0x4c840c}}),_0x4ba720=await this[_0x4b579e(0x233)][_0x4b579e(0x24f)]({'where':{'userId':_0x55c9ec['id']}});if(!_0x55c9ec)return;const {id:_0x42bbea}=_0x55c9ec,{performanceRatio:_0x445d5b}=_0x4ba720,_0x33c863={'inviterUserId':_0x42bbea,'inviteeUserId':_0x1c2aac,'orderId':_0x2ac347['id'],'orderPrice':_0x2ac347['total'],'commissionPercentage':_0x445d5b,'commissionAmount':(_0x2ac347[_0x4b579e(0x1df)]*_0x445d5b/0x64)['toFixed'](0x2)};await this[_0x4b579e(0x1bb)][_0x4b579e(0x262)](_0x33c863),await this[_0x4b579e(0x1bb)][_0x4b579e(0x1b5)](_0x42bbea,_0x33c863[_0x4b579e(0x26a)]);}}catch(_0x3191be){console[_0x4b579e(0x25b)](_0x4b579e(0x1c7),_0x3191be);throw new common_1[(_0x4b579e(0x25f))](_0x4b579e(0x21f),common_1['HttpStatus'][_0x4b579e(0x1b8)]);}}async[_0x419ab6(0x225)](_0x42b5c2,_0x4b9702){const _0x1bf171=_0x419ab6,{page:page=0x1,size:size=0x14}=_0x4b9702,{id:_0x59f73c}=_0x42b5c2[_0x1bf171(0x1ea)],[_0x444541,_0x45a9ce]=await this[_0x1bf171(0x1d1)][_0x1bf171(0x239)]({'where':{'userId':_0x59f73c},'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size});return _0x444541['forEach'](_0x28899f=>{const _0x1d9537=_0x1bf171;_0x28899f[_0x1d9537(0x264)]=_0x28899f[_0x1d9537(0x1e4)]>0x0?_0x28899f[_0x1d9537(0x1e4)]+'天':'永久';}),{'rows':(0x0,date_1['formatCreateOrUpdateDate'])(_0x444541),'count':_0x45a9ce};}async[_0x419ab6(0x272)](_0x5ca978,_0x5a4da7){const _0x1d1364=_0x419ab6;try{const {page:page=0x1,size:size=0xa,userId:_0x4c9fa8,rechargeType:_0x5ba368,packageId:_0x257774}=_0x5a4da7,{role:_0x18add9}=_0x5ca978[_0x1d1364(0x1ea)],_0x144789={};_0x5ba368&&(_0x144789['rechargeType']=_0x5ba368),_0x144789[_0x1d1364(0x1cf)]=_0x4c9fa8||(0x0,typeorm_2[_0x1d1364(0x1bd)])(0x186a0),_0x257774&&(_0x144789[_0x1d1364(0x207)]={'$like':'%'+_0x257774+'%'});const [_0x120d2f,_0x31b3fa]=await this[_0x1d1364(0x1d1)][_0x1d1364(0x239)]({'where':_0x144789,'order':{'id':_0x1d1364(0x20d)},'skip':(page-0x1)*size,'take':size}),_0x9d912a=_0x120d2f['map'](_0x3e931e=>_0x3e931e[_0x1d1364(0x1cf)]),_0x4a2cc7=await this[_0x1d1364(0x216)][_0x1d1364(0x1ce)]({'where':{'id':(0x0,typeorm_2['In'])(_0x9d912a)}});return _0x120d2f[_0x1d1364(0x247)](_0x58105c=>{const _0x2b9704=_0x1d1364,_0x510a62=_0x4a2cc7['find'](_0x22081a=>_0x22081a['id']===_0x58105c[_0x2b9704(0x1cf)]);_0x58105c[_0x2b9704(0x1dd)]=_0x510a62===null||_0x510a62===void 0x0?void 0x0:_0x510a62['username'],_0x58105c[_0x2b9704(0x1db)]=_0x510a62===null||_0x510a62===void 0x0?void 0x0:_0x510a62['email'],_0x58105c['phone']=_0x510a62===null||_0x510a62===void 0x0?void 0x0:_0x510a62[_0x2b9704(0x246)],_0x58105c['status']=_0x510a62===null||_0x510a62===void 0x0?void 0x0:_0x510a62['status'],_0x58105c[_0x2b9704(0x21a)]=_0x510a62===null||_0x510a62===void 0x0?void 0x0:_0x510a62['avatar'];}),_0x18add9!=='super'&&_0x120d2f[_0x1d1364(0x247)](_0x4bbb18=>{const _0x271e14=_0x1d1364;_0x4bbb18['email']=_0x4bbb18[_0x271e14(0x1db)]?(0x0,utils_1['hideString'])(_0x4bbb18['email']):'',_0x4bbb18[_0x271e14(0x246)]=_0x4bbb18[_0x271e14(0x246)]?(0x0,utils_1[_0x271e14(0x235)])(_0x4bbb18[_0x271e14(0x246)]):'';}),{'rows':_0x120d2f,'count':_0x31b3fa};}catch(_0x116c25){console[_0x1d1364(0x25b)](_0x1d1364(0x1c7),_0x116c25);throw new common_1[(_0x1d1364(0x25f))](_0x1d1364(0x1fe),common_1[_0x1d1364(0x1f7)]['BAD_REQUEST']);}}async[_0x419ab6(0x255)](_0x2496e5){const _0x45a223=_0x419ab6;return await this[_0x45a223(0x20c)][_0x45a223(0x1ce)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x2496e5)}});}async[_0x419ab6(0x1c9)](_0x565787,_0x1f4e63){const _0x272b11=_0x419ab6;return await this[_0x272b11(0x22f)](_0x565787,_0x272b11(0x248),-_0x1f4e63);}async[_0x419ab6(0x1da)](){const _0x320e75=_0x419ab6,_0x259b2e=await this[_0x320e75(0x216)][_0x320e75(0x1ce)]();if(!_0x259b2e['length'])return;const _0x4d662b=await this[_0x320e75(0x202)][_0x320e75(0x1fd)]([_0x320e75(0x259)]);if(!_0x4d662b)await this[_0x320e75(0x202)][_0x320e75(0x1e8)]({'settings':[{'configKey':'upgradeStatus','configVal':'1'}]});else throw new common_1[(_0x320e75(0x25f))]('您已经升级过了、请勿重复操作！',common_1[_0x320e75(0x1f7)][_0x320e75(0x1b8)]);_0x259b2e[_0x320e75(0x247)](_0x10dfa3=>{const _0xcf3ee5=_0x320e75,{id:_0x5e224a}=_0x10dfa3;this['balanceEntity']['findOne']({'where':{'userId':_0x5e224a}})[_0xcf3ee5(0x22a)](_0x58bde7=>{const _0x369eb1=_0xcf3ee5;if(!_0x58bde7)return;this[_0x369eb1(0x1f6)](_0x5e224a,_0x58bde7);});});}async['writeOldBalanceToNewTable'](_0x2d380f,_0x96a4d3){const _0x3ae464=_0x419ab6,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x96a4d3,_0x2e0bf5=await this[_0x3ae464(0x205)]['findOne']({'where':{'userId':_0x2d380f}}),_0x4ee7d9={'userId':_0x2d380f,'model3Count':Number(usesLeft),'model4Count':(_0x2e0bf5===null||_0x2e0bf5===void 0x0?void 0x0:_0x2e0bf5['count'])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x2e0bf5===null||_0x2e0bf5===void 0x0?void 0x0:_0x2e0bf5[_0x3ae464(0x208)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x461749=await this[_0x3ae464(0x20c)][_0x3ae464(0x24f)]({'where':{'userId':_0x2d380f}});_0x461749?common_1[_0x3ae464(0x274)][_0x3ae464(0x1c6)]('用户'+_0x2d380f+_0x3ae464(0x209),'BalanceService'):this['userBalanceEntity']['save'](_0x4ee7d9)['then'](_0x2a67a2=>{const _0x3d3b47=_0x3ae464;common_1[_0x3d3b47(0x274)]['debug']('用户'+_0x2d380f+_0x3d3b47(0x223),_0x3d3b47(0x24a));})[_0x3ae464(0x23b)](_0x29504c=>{const _0x19e0a4=_0x3ae464;console[_0x19e0a4(0x25b)](_0x19e0a4(0x1c7),_0x29504c),common_1[_0x19e0a4(0x274)][_0x19e0a4(0x1c6)]('用户'+_0x2d380f+_0x19e0a4(0x1ca),_0x19e0a4(0x24a));});}async[_0x419ab6(0x1fc)](_0x107cba){const _0x2f73ff=_0x419ab6,{fingerprint:_0x4ba93a}=_0x107cba[_0x2f73ff(0x24d)],{id:_0x53396b}=_0x107cba[_0x2f73ff(0x1ea)];return await this[_0x2f73ff(0x268)][_0x2f73ff(0x1c4)]({'userId':Number(_0x4ba93a)},{'userId':_0x53396b}),await this[_0x2f73ff(0x245)][_0x2f73ff(0x1c4)]({'userId':Number(_0x4ba93a)},{'userId':_0x53396b}),await this['midjourneyEntity'][_0x2f73ff(0x1c4)]({'userId':Number(_0x4ba93a)},{'userId':_0x53396b}),0x1;}async[_0x419ab6(0x211)](_0x4aa39e){const _0xeb1cd4=_0x419ab6,{fingerprint:_0x3cbe49}=_0x4aa39e[_0xeb1cd4(0x24d)],_0x4da36c=await this[_0xeb1cd4(0x268)]['count']({'where':{'userId':_0x3cbe49}}),_0xb15a89=await this['chatGroupEntity'][_0xeb1cd4(0x1c0)]({'where':{'userId':_0x3cbe49}}),_0x5c738f=await this[_0xeb1cd4(0x1bf)][_0xeb1cd4(0x1c0)]({'where':{'userId':_0x3cbe49}});return _0x4da36c||_0xb15a89||_0x5c738f||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x419ab6(0x26e)])(),__param(0x0,(0x0,typeorm_1[_0x419ab6(0x277)])(balance_entity_1[_0x419ab6(0x1f5)])),__param(0x1,(0x0,typeorm_1[_0x419ab6(0x277)])(userBalance_entity_1['UserBalanceEntity'])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1[_0x419ab6(0x1d3)])),__param(0x3,(0x0,typeorm_1[_0x419ab6(0x277)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x419ab6(0x261)])),__param(0x5,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x419ab6(0x221)])),__param(0x6,(0x0,typeorm_1[_0x419ab6(0x277)])(salesUsers_entity_1[_0x419ab6(0x1d4)])),__param(0x7,(0x0,typeorm_1[_0x419ab6(0x277)])(whiteList_entity_1['WhiteListEntity'])),__param(0x8,(0x0,typeorm_1[_0x419ab6(0x277)])(fingerprint_entity_1['FingerprintLogEntity'])),__param(0x9,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x419ab6(0x206)])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x419ab6(0x232)])),__param(0xb,(0x0,typeorm_1[_0x419ab6(0x277)])(midjourney_entity_1[_0x419ab6(0x21c)])),__metadata(_0x419ab6(0x20a),[typeorm_2['Repository'],typeorm_2[_0x419ab6(0x1f4)],typeorm_2[_0x419ab6(0x1f4)],typeorm_2[_0x419ab6(0x1f4)],typeorm_2['Repository'],typeorm_2[_0x419ab6(0x1f4)],typeorm_2[_0x419ab6(0x1f4)],typeorm_2[_0x419ab6(0x1f4)],typeorm_2[_0x419ab6(0x1f4)],typeorm_2['Repository'],typeorm_2[_0x419ab6(0x1f4)],typeorm_2[_0x419ab6(0x1f4)],sales_service_1['SalesService'],globalConfig_service_1[_0x419ab6(0x1c8)]])],UserBalanceService),exports[_0x419ab6(0x1ef)]=UserBalanceService;