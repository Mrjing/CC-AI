'use strict';const _0x1bcf00=_0x303d;(function(_0x4ea6fa,_0x2b1ddb){const _0x1982d2=_0x303d,_0x3e6cad=_0x4ea6fa();while(!![]){try{const _0x36d8c2=parseInt(_0x1982d2(0x113))/0x1+parseInt(_0x1982d2(0xc2))/0x2+parseInt(_0x1982d2(0x95))/0x3+-parseInt(_0x1982d2(0x9b))/0x4+-parseInt(_0x1982d2(0x11b))/0x5*(parseInt(_0x1982d2(0xbe))/0x6)+parseInt(_0x1982d2(0xe6))/0x7*(parseInt(_0x1982d2(0x130))/0x8)+-parseInt(_0x1982d2(0xa1))/0x9*(-parseInt(_0x1982d2(0x10b))/0xa);if(_0x36d8c2===_0x2b1ddb)break;else _0x3e6cad['push'](_0x3e6cad['shift']());}catch(_0x3d48dc){_0x3e6cad['push'](_0x3e6cad['shift']());}}}(_0xd8b5,0xe89a3));var __decorate=this&&this[_0x1bcf00(0x11c)]||function(_0x5b3151,_0xdc26b1,_0x17560d,_0x27b87d){const _0x45599c=_0x1bcf00;var _0x2439d0=arguments[_0x45599c(0x127)],_0x25eca3=_0x2439d0<0x3?_0xdc26b1:_0x27b87d===null?_0x27b87d=Object[_0x45599c(0x132)](_0xdc26b1,_0x17560d):_0x27b87d,_0x5055ba;if(typeof Reflect===_0x45599c(0xa4)&&typeof Reflect[_0x45599c(0xea)]==='function')_0x25eca3=Reflect[_0x45599c(0xea)](_0x5b3151,_0xdc26b1,_0x17560d,_0x27b87d);else{for(var _0x32e7df=_0x5b3151[_0x45599c(0x127)]-0x1;_0x32e7df>=0x0;_0x32e7df--)if(_0x5055ba=_0x5b3151[_0x32e7df])_0x25eca3=(_0x2439d0<0x3?_0x5055ba(_0x25eca3):_0x2439d0>0x3?_0x5055ba(_0xdc26b1,_0x17560d,_0x25eca3):_0x5055ba(_0xdc26b1,_0x17560d))||_0x25eca3;}return _0x2439d0>0x3&&_0x25eca3&&Object['defineProperty'](_0xdc26b1,_0x17560d,_0x25eca3),_0x25eca3;},__metadata=this&&this[_0x1bcf00(0x92)]||function(_0x2236be,_0x4c9c44){const _0x2cffd5=_0x1bcf00;if(typeof Reflect===_0x2cffd5(0xa4)&&typeof Reflect[_0x2cffd5(0xb9)]===_0x2cffd5(0x9c))return Reflect['metadata'](_0x2236be,_0x4c9c44);},__param=this&&this[_0x1bcf00(0xed)]||function(_0x57e725,_0x2327e7){return function(_0x32c995,_0x3fe146){_0x2327e7(_0x32c995,_0x3fe146,_0x57e725);};};function _0x303d(_0x71f4e3,_0x5c335b){const _0xd8b5f4=_0xd8b5();return _0x303d=function(_0x303ddb,_0xdb7f09){_0x303ddb=_0x303ddb-0x7a;let _0x4921ab=_0xd8b5f4[_0x303ddb];return _0x4921ab;},_0x303d(_0x71f4e3,_0x5c335b);}Object[_0x1bcf00(0x102)](exports,_0x1bcf00(0x124),{'value':!![]}),exports[_0x1bcf00(0xe0)]=void 0x0;const globalConfig_service_1=require(_0x1bcf00(0x9d)),typeorm_1=require(_0x1bcf00(0x94)),balance_entity_1=require(_0x1bcf00(0x91)),common_1=require(_0x1bcf00(0xf9)),typeorm_2=require('typeorm'),balance_constant_1=require(_0x1bcf00(0x133)),accountLog_entity_1=require(_0x1bcf00(0xf7)),utils_1=require(_0x1bcf00(0xd7)),config_entity_1=require(_0x1bcf00(0x12d)),cramiPackage_entity_1=require(_0x1bcf00(0xfb)),userBalance_entity_1=require(_0x1bcf00(0x103)),date_1=require('../../common/utils/date'),user_entity_1=require(_0x1bcf00(0x10d)),salesUsers_entity_1=require(_0x1bcf00(0xf1)),sales_service_1=require('../sales/sales.service'),whiteList_entity_1=require('../chatgpt/whiteList.entity'),fingerprint_entity_1=require(_0x1bcf00(0xf2)),chatLog_entity_1=require(_0x1bcf00(0x121)),chatGroup_entity_1=require(_0x1bcf00(0xaa)),midjourney_entity_1=require(_0x1bcf00(0x11f));let UserBalanceService=class UserBalanceService{constructor(_0x56eff8,_0x3a310d,_0x29c8b5,_0x54fe51,_0x4c7cb3,_0x1a70ab,_0x5e556b,_0x30b4fa,_0x42431f,_0x2f62b1,_0x445e4e,_0x390812,_0x18c8cc,_0x39aada){const _0x187076=_0x1bcf00;this['balanceEntity']=_0x56eff8,this[_0x187076(0xec)]=_0x3a310d,this[_0x187076(0xfc)]=_0x29c8b5,this[_0x187076(0xdb)]=_0x54fe51,this[_0x187076(0xe7)]=_0x4c7cb3,this[_0x187076(0xd4)]=_0x1a70ab,this[_0x187076(0xd0)]=_0x5e556b,this[_0x187076(0x89)]=_0x30b4fa,this[_0x187076(0x93)]=_0x42431f,this['chatGroupEntity']=_0x2f62b1,this[_0x187076(0x11d)]=_0x445e4e,this[_0x187076(0xcc)]=_0x390812,this[_0x187076(0x8d)]=_0x18c8cc,this[_0x187076(0xe8)]=_0x39aada;}async[_0x1bcf00(0xe1)](_0x1da71c,_0x268638){const _0x111822=_0x1bcf00;try{const _0x3a4793=await this[_0x111822(0xe7)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x111822(0xf6),_0x111822(0xae),_0x111822(0x90),_0x111822(0xfa),'firstRegisterSendStatus','firstRegisterSendRank',_0x111822(0xe2),_0x111822(0x80),_0x111822(0x101),_0x111822(0x12c),_0x111822(0xff),_0x111822(0x129),_0x111822(0xc6),_0x111822(0x13a),'invitedGuestSendDrawMjCount',_0x111822(0x117)])}}),_0x3b111f=_0x3a4793[_0x111822(0x10e)]((_0x48a805,_0x344b7d)=>{const _0x12b0a1=_0x111822,_0x142c56=Number(_0x344b7d[_0x12b0a1(0x137)]),_0x1084d8=Number['isInteger'](_0x142c56)&&_0x142c56>0x0?_0x142c56:0x0;return _0x48a805[_0x344b7d[_0x12b0a1(0x10f)]]=_0x1084d8,_0x48a805;},{});let _0x55149b=0x0,_0x35cb85=0x0,_0x422afb=0x0;_0x3b111f[_0x111822(0xf6)]===0x1&&(_0x55149b=_0x55149b+_0x3b111f[_0x111822(0xae)],_0x35cb85=_0x35cb85+_0x3b111f[_0x111822(0x90)],_0x422afb=_0x422afb+_0x3b111f['registerSendDrawMjCount']),_0x3b111f[_0x111822(0xf6)]===0x1&&_0x3b111f['firstRegisterSendStatus']===0x1&&_0x1da71c<=_0x3b111f[_0x111822(0xc9)]&&(_0x55149b=_0x55149b+_0x3b111f[_0x111822(0xe2)],_0x35cb85=_0x35cb85+_0x3b111f[_0x111822(0x80)],_0x422afb=_0x422afb+_0x3b111f[_0x111822(0x101)]),await this['saveRecordRechargeLog']({'userId':_0x1da71c,'rechargeType':balance_constant_1['RechargeType']['REG_GIFT'],'model3Count':_0x55149b,'drawMjCount':_0x422afb,'model4Count':_0x35cb85}),_0x268638&&(Number(_0x3b111f['inviteSendStatus'])===0x1&&(_0x55149b=_0x55149b+Number(_0x3b111f[_0x111822(0x13a)]),_0x35cb85=_0x35cb85+Number(_0x3b111f['invitedGuestSendModel4Count']),_0x422afb=_0x422afb+Number(_0x3b111f[_0x111822(0x82)]),await this['saveRecordRechargeLog']({'userId':_0x1da71c,'rechargeType':balance_constant_1[_0x111822(0x104)]['INVITE_GIFT'],'model3Count':_0x3b111f[_0x111822(0x13a)],'model4Count':_0x3b111f[_0x111822(0x117)],'drawMjCount':_0x3b111f[_0x111822(0x82)]}),await this[_0x111822(0xce)](_0x268638,{'model3Count':_0x3b111f[_0x111822(0xff)],'model4Count':_0x3b111f[_0x111822(0x129)],'drawMjCount':_0x3b111f[_0x111822(0xc6)]}),await this[_0x111822(0xc5)]({'userId':_0x268638,'rechargeType':balance_constant_1['RechargeType'][_0x111822(0xf5)],'model3Count':_0x3b111f[_0x111822(0xff)],'model4Count':_0x3b111f[_0x111822(0x129)],'drawMjCount':_0x3b111f[_0x111822(0xc6)]}))),await this[_0x111822(0xec)]['save']({'userId':_0x1da71c,'model3Count':_0x55149b,'model4Count':_0x35cb85,'drawMjCount':_0x422afb,'useTokens':0x0});}catch(_0x23f943){console['log'](_0x111822(0x108),_0x23f943);throw new common_1[(_0x111822(0x105))](_0x111822(0xcf),common_1[_0x111822(0xd5)]['BAD_REQUEST']);}}async['validateBalance'](_0x1fac1f,_0x4692ed,_0x2d46ae){const _0x3e5d8c=_0x1bcf00,{id:_0x1d52b2,role:_0x4f178f}=_0x1fac1f[_0x3e5d8c(0xd6)];let _0x1d7a99=await this[_0x3e5d8c(0xec)][_0x3e5d8c(0xab)]({'where':{'userId':_0x1d52b2}});!_0x1d7a99&&(_0x1d7a99=await this[_0x3e5d8c(0xf0)](_0x1d52b2));if(_0x4f178f==='visitor')return this[_0x3e5d8c(0x7f)](_0x1fac1f,_0x4692ed,_0x2d46ae);const _0x424cac=await this[_0x3e5d8c(0xe7)][_0x3e5d8c(0xab)]({'where':{'configKey':_0x3e5d8c(0xd8)}}),_0x5f1428=_0x424cac?_0x424cac[_0x3e5d8c(0x137)]:_0x3e5d8c(0xeb),_0x5b1c27=_0x4692ed===_0x3e5d8c(0xa2)?_0x3e5d8c(0x139):_0x4692ed===_0x3e5d8c(0x118)?_0x3e5d8c(0xd9):_0x4692ed==='mjDraw'?'memberDrawMjCount':null,_0x151082=_0x4692ed===_0x3e5d8c(0xa2)?_0x3e5d8c(0x96):_0x4692ed==='model4'?'model4Count':_0x4692ed===_0x3e5d8c(0xaf)?_0x3e5d8c(0xb5):null;if(_0x1d7a99[_0x3e5d8c(0x87)]&&_0x1d7a99[_0x5b1c27]<_0x2d46ae){if(_0x1d7a99[_0x151082]<_0x2d46ae)throw new common_1['HttpException'](_0x3e5d8c(0xd1)+_0x5f1428+_0x3e5d8c(0x112),common_1[_0x3e5d8c(0xd5)][_0x3e5d8c(0xc1)]);}if(!_0x1d7a99['packageId']&&_0x1d7a99[_0x151082]<_0x2d46ae)throw new common_1[(_0x3e5d8c(0x105))](_0x3e5d8c(0xd1)+_0x5f1428+'>\x20或购买专属套餐\x20！',common_1[_0x3e5d8c(0xd5)][_0x3e5d8c(0xc1)]);return _0x1d7a99;}async['validateVisitorBalance'](_0x1e876b,_0x275a19,_0x2c338c){const _0x3c9717=_0x1bcf00,{id:_0x59dca0}=_0x1e876b[_0x3c9717(0xd6)],_0x3823e0=_0x275a19===_0x3c9717(0xa2)?_0x3c9717(0x96):_0x275a19===_0x3c9717(0x118)?'model4Count':_0x275a19===_0x3c9717(0xaf)?_0x3c9717(0xb5):null,_0x21969d=new Date(),_0xaba1f4=await this['fingerprintLogEntity'][_0x3c9717(0xab)]({'where':{'fingerprint':_0x59dca0}}),{visitorModel3Num:_0x4e10b4,visitorModel4Num:_0x56c8a3,visitorMJNum:_0x2934ea}=await this['globalConfigService']['getConfigs']([_0x3c9717(0xbb),_0x3c9717(0xa9),_0x3c9717(0xdc)]),_0x5d885c={'model3Count':_0x4e10b4?Number(_0x4e10b4):0x0,'model4Count':_0x56c8a3?Number(_0x56c8a3):0x0,'drawMjCount':_0x2934ea?Number(_0x2934ea):0x0};if(!_0xaba1f4){const _0x2522f9={'fingerprint':_0x59dca0,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x2522f9[_0x3823e0]=_0x2522f9[_0x3823e0]+_0x2c338c;if(_0x2522f9[_0x3823e0]>_0x5d885c[_0x3823e0])throw new common_1['HttpException'](_0x3c9717(0xbd),common_1['HttpStatus'][_0x3c9717(0xc1)]);else return await this['fingerprintLogEntity'][_0x3c9717(0x9a)](_0x2522f9),!![];}else{const {model3Count:_0x3a14c3,model4Count:_0x1d69bc,drawMjCount:_0x5a6076}=_0xaba1f4;let _0x5043b6={'model3Count':_0x3a14c3,'model4Count':_0x1d69bc,'drawMjCount':_0x5a6076};const _0x133587=Number(new Date(_0xaba1f4['updatedAt'])),_0x3b8b68=this['isUpdatedToday'](_0x133587);_0x3b8b68?_0x5043b6[_0x3823e0]=_0x5043b6[_0x3823e0]+_0x2c338c:(_0x5043b6={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x5043b6[_0x3823e0]=_0x5043b6[_0x3823e0]+_0x2c338c);if(_0x5043b6[_0x3823e0]>_0x5d885c[_0x3823e0])throw new common_1[(_0x3c9717(0x105))](_0x3c9717(0xbd),common_1[_0x3c9717(0xd5)]['PAYMENT_REQUIRED']);else return await this[_0x3c9717(0x93)][_0x3c9717(0x115)]({'fingerprint':_0x59dca0},_0x5043b6),!![];}}[_0x1bcf00(0xa6)](_0x28f4a3){const _0x32cc8e=_0x1bcf00,_0x1ccbda=new Date(),_0x3f2023=new Date(_0x1ccbda[_0x32cc8e(0xad)](),_0x1ccbda[_0x32cc8e(0x88)](),_0x1ccbda['getDate']());return _0x28f4a3>=_0x3f2023;}async[_0x1bcf00(0x85)](_0x5843ba,_0x5804bd,_0x19cc95,_0x4e856d=0x0){const _0x1f415b=_0x1bcf00,_0x30fe96=await this[_0x1f415b(0xec)][_0x1f415b(0xab)]({'where':{'userId':_0x5843ba}});if(!_0x30fe96)throw new common_1[(_0x1f415b(0x105))](_0x1f415b(0x8b),common_1[_0x1f415b(0xd5)]['BAD_REQUEST']);const _0x16e8ed=_0x5804bd===_0x1f415b(0xa2)?_0x1f415b(0x139):_0x5804bd===_0x1f415b(0x118)?'memberModel4Count':_0x5804bd===_0x1f415b(0xaf)?_0x1f415b(0x131):null,_0x4c651b=_0x5804bd===_0x1f415b(0xa2)?'model3Count':_0x5804bd===_0x1f415b(0x118)?_0x1f415b(0x120):_0x5804bd===_0x1f415b(0xaf)?_0x1f415b(0xb5):null,_0x3ad165=_0x30fe96['packageId']&&_0x30fe96[_0x16e8ed]<_0x19cc95?_0x4c651b:_0x30fe96[_0x1f415b(0x87)]?_0x16e8ed:_0x4c651b;let _0x40ce56=null;_0x3ad165[_0x1f415b(0x110)]('odel3')&&(_0x40ce56=_0x1f415b(0xb6));_0x3ad165[_0x1f415b(0x110)](_0x1f415b(0xa0))&&(_0x40ce56=_0x1f415b(0x109));_0x3ad165['includes'](_0x1f415b(0xcb))&&(_0x40ce56='useDrawMjToken');const _0x34a11d={[_0x3ad165]:_0x30fe96[_0x3ad165]-_0x19cc95<0x0?0x0:_0x30fe96[_0x3ad165]-_0x19cc95,[_0x40ce56]:_0x30fe96[_0x40ce56]+_0x4e856d};_0x40ce56===_0x1f415b(0xb6)&&(_0x34a11d[_0x1f415b(0x119)]=_0x30fe96[_0x1f415b(0x119)]+_0x19cc95),_0x40ce56===_0x1f415b(0x109)&&(_0x34a11d[_0x1f415b(0x8c)]=_0x30fe96[_0x1f415b(0x8c)]+_0x19cc95);const _0x27c76e=await this[_0x1f415b(0xec)][_0x1f415b(0x115)]({'userId':_0x5843ba},_0x34a11d);if(_0x27c76e['affected']===0x0)throw new common_1['HttpException'](_0x1f415b(0x97),common_1[_0x1f415b(0xd5)]['BAD_REQUEST']);}async[_0x1bcf00(0x13b)](_0xc2cd1e){const _0x22300f=_0x1bcf00;try{const _0x4a010b=await this[_0x22300f(0xec)][_0x22300f(0xab)]({'where':{'userId':_0xc2cd1e},'select':['packageId',_0x22300f(0x96),_0x22300f(0x120),_0x22300f(0xb5),_0x22300f(0x139),_0x22300f(0xd9),'memberDrawMjCount',_0x22300f(0x119),_0x22300f(0x8c),_0x22300f(0xb6),_0x22300f(0x109),_0x22300f(0x12a),'expirationTime']});if(!_0x4a010b){const _0x5d2662=await this[_0x22300f(0xf0)](_0xc2cd1e);if(_0x5d2662)return await this[_0x22300f(0x13b)](_0xc2cd1e);else throw new common_1[(_0x22300f(0x105))](_0x22300f(0xba),common_1[_0x22300f(0xd5)]['BAD_REQUEST']);}return _0x4a010b[_0x22300f(0x12b)]=_0x4a010b[_0x22300f(0x87)]?_0x4a010b['model3Count']+_0x4a010b[_0x22300f(0x139)]:_0x4a010b[_0x22300f(0x96)],_0x4a010b[_0x22300f(0x111)]=_0x4a010b[_0x22300f(0x87)]?_0x4a010b['model4Count']+_0x4a010b['memberModel4Count']:_0x4a010b['model4Count'],_0x4a010b[_0x22300f(0x12e)]=_0x4a010b[_0x22300f(0x87)]?_0x4a010b[_0x22300f(0xb5)]+_0x4a010b[_0x22300f(0x131)]:_0x4a010b[_0x22300f(0xb5)],_0x4a010b[_0x22300f(0x8e)]=_0x4a010b['expirationTime']?(0x0,date_1[_0x22300f(0x11e)])(_0x4a010b[_0x22300f(0x8e)],'YYYY-MM-DD'):null,_0x4a010b;}catch(_0x1de6ad){console[_0x22300f(0xe4)]('error:\x20',_0x1de6ad);}}async['saveRecordRechargeLog'](_0x595795){const _0x90100f=_0x1bcf00,{userId:_0x50db58,rechargeType:_0x5f0281,model3Count:_0x2df5c9,model4Count:_0x541390,drawMjCount:_0x1c4e55,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x595795;if(!_0x50db58)throw new common_1[(_0x90100f(0x105))](_0x90100f(0x114),common_1[_0x90100f(0xd5)]['BAD_REQUEST']);const _0x19e4c9=(0x0,utils_1[_0x90100f(0x81)])();return await this[_0x90100f(0xfc)][_0x90100f(0x9a)]({'userId':_0x50db58,'rechargeType':_0x5f0281,'model3Count':_0x2df5c9,'model4Count':_0x541390,'drawMjCount':_0x1c4e55,'days':days,'extent':extent,'uid':_0x19e4c9,'pkgName':pkgName});}async['createBaseUserBalance'](_0x4cc29c,_0x117f01={}){const _0x5dce10=_0x1bcf00,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x117f01,_0x4a738d=await this[_0x5dce10(0xec)][_0x5dce10(0xab)]({'where':{'userId':_0x4cc29c}});if(_0x4a738d)throw new common_1[(_0x5dce10(0x105))](_0x5dce10(0x116),common_1[_0x5dce10(0xd5)][_0x5dce10(0x135)]);return await this[_0x5dce10(0xec)][_0x5dce10(0x9a)]({'userId':_0x4cc29c,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x1bcf00(0xce)](_0x58697a,_0x24986d,_0x35506e=-0x1){const _0x2a49c8=_0x1bcf00;try{const _0x4d0902=await this[_0x2a49c8(0xec)]['findOne']({'where':{'userId':_0x58697a}})||await this['createBaseUserBalance'](_0x58697a);if(!_0x4d0902)throw new common_1['HttpException'](_0x2a49c8(0x9f),common_1['HttpStatus'][_0x2a49c8(0x135)]);const {model3Count:_0x103679,model4Count:_0x2d7058,drawMjCount:_0x4c2fdc,memberModel3Count:_0x3debff,memberModel4Count:_0x1ece97,memberDrawMjCount:_0x4a3f6b}=_0x4d0902;let _0x3adb4d={};if(_0x35506e>0x0){const {packageId:_0x127c02}=_0x24986d;if(!_0x127c02)throw new common_1[(_0x2a49c8(0x105))](_0x2a49c8(0xef),common_1[_0x2a49c8(0xd5)][_0x2a49c8(0x135)]);const _0x2f31d8=await this[_0x2a49c8(0xdb)][_0x2a49c8(0xab)]({'where':{'id':_0x127c02}});if(!_0x2f31d8)throw new common_1[(_0x2a49c8(0x105))](_0x2a49c8(0xda),common_1['HttpStatus']['BAD_REQUEST']);const {weight:_0x584001}=_0x2f31d8;if(!_0x4d0902['packageId'])_0x3adb4d={'memberModel3Count':_0x103679+_0x24986d[_0x2a49c8(0x96)],'memberModel4Count':_0x2d7058+_0x24986d[_0x2a49c8(0x120)],'memberDrawMjCount':_0x4c2fdc+_0x24986d['drawMjCount'],'expirationTime':(0x0,date_1[_0x2a49c8(0xc7)])()[_0x2a49c8(0xb8)](_0x35506e>0x0?_0x35506e:0x0,_0x2a49c8(0x106))[_0x2a49c8(0xb7)](_0x2a49c8(0xfd)),'packageId':_0x127c02};else{const _0x4fa903=await this[_0x2a49c8(0xdb)][_0x2a49c8(0xab)]({'where':{'id':_0x4d0902['packageId']}});_0x584001>=_0x4fa903[_0x2a49c8(0x126)]&&(_0x3adb4d={'memberModel3Count':_0x3debff+_0x24986d[_0x2a49c8(0x96)],'memberModel4Count':_0x1ece97+_0x24986d['model4Count'],'memberDrawMjCount':_0x4a3f6b+_0x24986d['drawMjCount'],'expirationTime':(0x0,date_1[_0x2a49c8(0xc7)])(_0x4d0902[_0x2a49c8(0x8e)])['add'](_0x35506e>0x0?_0x35506e:0x0,_0x2a49c8(0x106))[_0x2a49c8(0xb7)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x127c02}),_0x584001<_0x4fa903[_0x2a49c8(0x126)]&&(_0x3adb4d={'memberModel3Count':_0x3debff+_0x24986d['model3Count'],'memberModel4Count':_0x1ece97+_0x24986d[_0x2a49c8(0x120)],'memberDrawMjCount':_0x4a3f6b+_0x24986d[_0x2a49c8(0xb5)]});}}_0x35506e<=0x0&&(_0x3adb4d={'model3Count':_0x103679+_0x24986d[_0x2a49c8(0x96)],'model4Count':_0x2d7058+_0x24986d[_0x2a49c8(0x120)],'drawMjCount':_0x4c2fdc+_0x24986d[_0x2a49c8(0xb5)]});const _0x1ccbd1=await this[_0x2a49c8(0xec)][_0x2a49c8(0x115)]({'userId':_0x58697a},_0x3adb4d);if(_0x1ccbd1['affected']===0x0)throw new common_1[(_0x2a49c8(0x105))](_0x58697a+_0x2a49c8(0xee),common_1[_0x2a49c8(0xd5)][_0x2a49c8(0x135)]);}catch(_0xec3c43){console[_0x2a49c8(0xe4)](_0x2a49c8(0x108),_0xec3c43);throw new common_1[(_0x2a49c8(0x105))](_0x2a49c8(0xfe),common_1['HttpStatus']['BAD_REQUEST']);}}async['addBalanceToOrder'](_0x58f29a){const _0x2ec94c=_0x1bcf00;console[_0x2ec94c(0xe4)]('充值的工单信息:',_0x58f29a);try{const {userId:_0x14b06c,goodsId:_0x8a7d25}=_0x58f29a,_0x1ae2fb=await this[_0x2ec94c(0xdb)]['findOne']({'where':{'id':_0x58f29a['goodsId'],'status':0x1}});if(!_0x1ae2fb)throw new common_1[(_0x2ec94c(0x105))]('非法操作、当前充值套餐暂不存在！',common_1[_0x2ec94c(0xd5)]['BAD_REQUEST']);const {model3Count:_0xdf9df3,model4Count:_0x25009e,drawMjCount:_0xb85045,days:_0x291107,name:_0xdc9b4}=_0x1ae2fb,_0x4d3afd={'model3Count':_0xdf9df3,'model4Count':_0x25009e,'drawMjCount':_0xb85045,'days':_0x291107,'packageId':_0x58f29a[_0x2ec94c(0xf4)]};await this[_0x2ec94c(0xce)](_0x14b06c,_0x4d3afd,_0x291107),await this[_0x2ec94c(0xc5)]({'userId':_0x14b06c,'rechargeType':balance_constant_1['RechargeType'][_0x2ec94c(0xe3)],'model3Count':_0xdf9df3,'model4Count':_0x25009e,'drawMjCount':_0xb85045,'pkgName':_0xdc9b4,'days':_0x291107});const _0x3236ed=await this[_0x2ec94c(0xd4)][_0x2ec94c(0xab)]({'where':{'id':_0x14b06c}}),{invitedBy:_0x42c9ca}=_0x3236ed;if(_0x42c9ca){const _0x386f14=await this[_0x2ec94c(0xd4)][_0x2ec94c(0xab)]({'where':{'inviteCode':_0x42c9ca}}),_0x3167ab=await this['salesUsersEntity'][_0x2ec94c(0xab)]({'where':{'userId':_0x386f14['id']}});if(!_0x386f14)return;const {id:_0x462d9d}=_0x386f14,{performanceRatio:_0x35d29c}=_0x3167ab,_0x1ebbc9={'inviterUserId':_0x462d9d,'inviteeUserId':_0x14b06c,'orderId':_0x58f29a['id'],'orderPrice':_0x58f29a['total'],'commissionPercentage':_0x35d29c,'commissionAmount':(_0x58f29a[_0x2ec94c(0x107)]*_0x35d29c/0x64)[_0x2ec94c(0xd3)](0x2)};await this[_0x2ec94c(0x8d)][_0x2ec94c(0xa8)](_0x1ebbc9),await this[_0x2ec94c(0x8d)][_0x2ec94c(0x84)](_0x462d9d,_0x1ebbc9['commissionAmount']);}}catch(_0x2b2010){console[_0x2ec94c(0xe4)](_0x2ec94c(0x108),_0x2b2010);throw new common_1[(_0x2ec94c(0x105))](_0x2ec94c(0xb1),common_1[_0x2ec94c(0xd5)][_0x2ec94c(0x135)]);}}async[_0x1bcf00(0xca)](_0x399c7c,_0x53cfa6){const _0x394079=_0x1bcf00,{page:page=0x1,size:size=0x14}=_0x53cfa6,{id:_0x5d6fcb}=_0x399c7c[_0x394079(0xd6)],[_0x270e0e,_0x31aff5]=await this[_0x394079(0xfc)]['findAndCount']({'where':{'userId':_0x5d6fcb},'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size});return _0x270e0e[_0x394079(0x134)](_0x453961=>{const _0x19fd43=_0x394079;_0x453961[_0x19fd43(0x7a)]=_0x453961['days']>0x0?_0x453961['days']+'天':'永久';}),{'rows':(0x0,date_1[_0x394079(0x138)])(_0x270e0e),'count':_0x31aff5};}async[_0x1bcf00(0x122)](_0x1bfe04,_0x3790c0){const _0x5c5e24=_0x1bcf00;try{const {page:page=0x1,size:size=0xa,userId:_0x28af5c,rechargeType:_0x23d453,packageId:_0xdb9707}=_0x3790c0,{role:_0x19025a}=_0x1bfe04[_0x5c5e24(0xd6)],_0x538c15={};_0x23d453&&(_0x538c15['rechargeType']=_0x23d453),_0x538c15['userId']=_0x28af5c||(0x0,typeorm_2[_0x5c5e24(0xb0)])(0x186a0),_0xdb9707&&(_0x538c15[_0x5c5e24(0x87)]={'$like':'%'+_0xdb9707+'%'});const [_0x570194,_0x36b126]=await this[_0x5c5e24(0xfc)][_0x5c5e24(0x99)]({'where':_0x538c15,'order':{'id':_0x5c5e24(0xf8)},'skip':(page-0x1)*size,'take':size}),_0x4053cc=_0x570194['map'](_0x2dfe0f=>_0x2dfe0f['userId']),_0x39f727=await this[_0x5c5e24(0xd4)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x4053cc)}});return _0x570194[_0x5c5e24(0x134)](_0x368562=>{const _0x118e61=_0x5c5e24,_0x28249d=_0x39f727[_0x118e61(0xa3)](_0x3f2cd4=>_0x3f2cd4['id']===_0x368562['userId']);_0x368562['username']=_0x28249d===null||_0x28249d===void 0x0?void 0x0:_0x28249d[_0x118e61(0x128)],_0x368562[_0x118e61(0xbf)]=_0x28249d===null||_0x28249d===void 0x0?void 0x0:_0x28249d['email'],_0x368562['phone']=_0x28249d===null||_0x28249d===void 0x0?void 0x0:_0x28249d[_0x118e61(0xf3)],_0x368562[_0x118e61(0x7d)]=_0x28249d===null||_0x28249d===void 0x0?void 0x0:_0x28249d[_0x118e61(0x7d)],_0x368562[_0x118e61(0x125)]=_0x28249d===null||_0x28249d===void 0x0?void 0x0:_0x28249d[_0x118e61(0x125)];}),_0x19025a!=='super'&&_0x570194[_0x5c5e24(0x134)](_0x204e06=>{const _0x1f8fd5=_0x5c5e24;_0x204e06['email']=_0x204e06[_0x1f8fd5(0xbf)]?(0x0,utils_1[_0x1f8fd5(0xdd)])(_0x204e06[_0x1f8fd5(0xbf)]):'',_0x204e06[_0x1f8fd5(0xf3)]=_0x204e06[_0x1f8fd5(0xf3)]?(0x0,utils_1[_0x1f8fd5(0xdd)])(_0x204e06['phone']):'';}),{'rows':_0x570194,'count':_0x36b126};}catch(_0x525d99){console[_0x5c5e24(0xe4)](_0x5c5e24(0x108),_0x525d99);throw new common_1[(_0x5c5e24(0x105))]('查询用户账户失败！',common_1[_0x5c5e24(0xd5)]['BAD_REQUEST']);}}async[_0x1bcf00(0xb2)](_0x11bce9){const _0x4813bf=_0x1bcf00;return await this[_0x4813bf(0xec)][_0x4813bf(0xa3)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x11bce9)}});}async[_0x1bcf00(0x8a)](_0xa4f263,_0x17ea17){const _0x251adf=_0x1bcf00;return await this[_0x251adf(0x85)](_0xa4f263,'mjDraw',-_0x17ea17);}async[_0x1bcf00(0x9e)](){const _0x4fe3b5=_0x1bcf00,_0x5037dd=await this[_0x4fe3b5(0xd4)][_0x4fe3b5(0xa3)]();if(!_0x5037dd['length'])return;const _0x56f1ef=await this['globalConfigService'][_0x4fe3b5(0xa7)]([_0x4fe3b5(0x10a)]);if(!_0x56f1ef)await this[_0x4fe3b5(0xe8)][_0x4fe3b5(0x10c)]({'settings':[{'configKey':_0x4fe3b5(0x10a),'configVal':'1'}]});else throw new common_1[(_0x4fe3b5(0x105))](_0x4fe3b5(0xc4),common_1[_0x4fe3b5(0xd5)][_0x4fe3b5(0x135)]);_0x5037dd[_0x4fe3b5(0x134)](_0x54128c=>{const _0x11169b=_0x4fe3b5,{id:_0x13293e}=_0x54128c;this['balanceEntity'][_0x11169b(0xab)]({'where':{'userId':_0x13293e}})[_0x11169b(0xdf)](_0x3b61c8=>{if(!_0x3b61c8)return;this['writeOldBalanceToNewTable'](_0x13293e,_0x3b61c8);});});}async[_0x1bcf00(0x7c)](_0x158d49,_0x1c9b5b){const _0x503c38=_0x1bcf00,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x1c9b5b,_0x3a99c9=await this[_0x503c38(0x89)][_0x503c38(0xab)]({'where':{'userId':_0x158d49}}),_0x1e3168={'userId':_0x158d49,'model3Count':Number(usesLeft),'model4Count':(_0x3a99c9===null||_0x3a99c9===void 0x0?void 0x0:_0x3a99c9['count'])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x3a99c9===null||_0x3a99c9===void 0x0?void 0x0:_0x3a99c9[_0x503c38(0xb4)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x28a1db=await this[_0x503c38(0xec)][_0x503c38(0xab)]({'where':{'userId':_0x158d49}});_0x28a1db?common_1['Logger'][_0x503c38(0x86)]('用户'+_0x158d49+_0x503c38(0x8f),'BalanceService'):this[_0x503c38(0xec)][_0x503c38(0x9a)](_0x1e3168)[_0x503c38(0xdf)](_0x1396d6=>{const _0x195f4f=_0x503c38;common_1[_0x195f4f(0xa5)][_0x195f4f(0x86)]('用户'+_0x158d49+_0x195f4f(0xc8),_0x195f4f(0xac));})['catch'](_0x54f54d=>{const _0x240633=_0x503c38;console['log'](_0x240633(0x108),_0x54f54d),common_1[_0x240633(0xa5)][_0x240633(0x86)]('用户'+_0x158d49+'旧账户信息迁移失败',_0x240633(0xac));});}async[_0x1bcf00(0x136)](_0x2d4e6f){const _0x1544d0=_0x1bcf00,{fingerprint:_0x139164}=_0x2d4e6f['headers'],{id:_0x12a1c0}=_0x2d4e6f['user'];return await this[_0x1544d0(0x11d)][_0x1544d0(0x115)]({'userId':Number(_0x139164)},{'userId':_0x12a1c0}),await this['chatGroupEntity'][_0x1544d0(0x115)]({'userId':Number(_0x139164)},{'userId':_0x12a1c0}),await this[_0x1544d0(0xcc)]['update']({'userId':Number(_0x139164)},{'userId':_0x12a1c0}),0x1;}async[_0x1bcf00(0xc0)](_0x763c83){const _0x27d755=_0x1bcf00,{fingerprint:_0x3c18e5}=_0x763c83['headers'],_0x4e9d6d=await this['chatLogEntity'][_0x27d755(0xde)]({'where':{'userId':_0x3c18e5}}),_0xb9b8ce=await this[_0x27d755(0x98)][_0x27d755(0xde)]({'where':{'userId':_0x3c18e5}}),_0x2a5645=await this[_0x27d755(0xcc)][_0x27d755(0xde)]({'where':{'userId':_0x3c18e5}});return _0x4e9d6d||_0xb9b8ce||_0x2a5645||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x1bcf00(0x12f)])(),__param(0x0,(0x0,typeorm_1[_0x1bcf00(0xe9)])(balance_entity_1['BalanceEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x1bcf00(0xd2)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1[_0x1bcf00(0x123)])),__param(0x3,(0x0,typeorm_1[_0x1bcf00(0xe9)])(cramiPackage_entity_1[_0x1bcf00(0x11a)])),__param(0x4,(0x0,typeorm_1[_0x1bcf00(0xe9)])(config_entity_1[_0x1bcf00(0xcd)])),__param(0x5,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x1bcf00(0xe5)])),__param(0x6,(0x0,typeorm_1[_0x1bcf00(0xe9)])(salesUsers_entity_1[_0x1bcf00(0x83)])),__param(0x7,(0x0,typeorm_1[_0x1bcf00(0xe9)])(whiteList_entity_1[_0x1bcf00(0x100)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0x1bcf00(0xbc)])),__param(0x9,(0x0,typeorm_1[_0x1bcf00(0xe9)])(chatGroup_entity_1[_0x1bcf00(0xc3)])),__param(0xa,(0x0,typeorm_1[_0x1bcf00(0xe9)])(chatLog_entity_1['ChatLogEntity'])),__param(0xb,(0x0,typeorm_1[_0x1bcf00(0xe9)])(midjourney_entity_1['MidjourneyEntity'])),__metadata(_0x1bcf00(0xb3),[typeorm_2[_0x1bcf00(0x7b)],typeorm_2[_0x1bcf00(0x7b)],typeorm_2[_0x1bcf00(0x7b)],typeorm_2[_0x1bcf00(0x7b)],typeorm_2[_0x1bcf00(0x7b)],typeorm_2[_0x1bcf00(0x7b)],typeorm_2[_0x1bcf00(0x7b)],typeorm_2[_0x1bcf00(0x7b)],typeorm_2[_0x1bcf00(0x7b)],typeorm_2[_0x1bcf00(0x7b)],typeorm_2[_0x1bcf00(0x7b)],typeorm_2[_0x1bcf00(0x7b)],sales_service_1['SalesService'],globalConfig_service_1[_0x1bcf00(0x7e)]])],UserBalanceService),exports[_0x1bcf00(0xe0)]=UserBalanceService;function _0xd8b5(){const _0x2c462d=['mjDraw','LessThan','充值失败！','queryUserBalanceByIds','design:paramtypes','useCount','drawMjCount','useModel3Token','format','add','metadata','查询当前用户余额失败！','visitorModel3Num','FingerprintLogEntity','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','11045514JVprLb','email','getVisitorCount','PAYMENT_REQUIRED','2472548redSMV','ChatGroupEntity','您已经升级过了、请勿重复操作！','saveRecordRechargeLog','inviteGiveSendDrawMjCount','default','旧账户信息迁移成功','firstRegisterSendRank','getRechargeLog','MjCount','midjourneyEntity','ConfigEntity','addBalanceToUser','注册赠送失败,请联系管理员！','salesUsersEntity','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','UserBalanceEntity','toFixed','userEntity','HttpStatus','user','../../common/utils','vxNumber','memberModel4Count','当前套餐不存在！','cramiPackageEntity','visitorMJNum','hideString','count','then','UserBalanceService','addBalanceToNewUser','firstRregisterSendModel3Count','SCAN_PAY','log','UserEntity','21SNTFQz','configEntity','globalConfigService','InjectRepository','decorate','---','userBalanceEntity','__param','充值失败','缺失当前套餐ID、充值失败！','createBaseUserBalance','../sales/salesUsers.entity','./fingerprint.entity','phone','goodsId','REFER_GIFT','registerSendStatus','./accountLog.entity','DESC','@nestjs/common','registerSendDrawMjCount','../crami/cramiPackage.entity','accountLogEntity','YYYY-MM-DD\x20HH:mm:ss','用户充值失败！','inviteGiveSendModel3Count','WhiteListEntity','firstRregisterSendDrawMjCount','defineProperty','./userBalance.entity','RechargeType','HttpException','day','total','error:\x20','useModel4Token','upgradeStatus','10612210blYoPO','setConfig','../user/user.entity','reduce','configKey','includes','sumModel4Count','>\x20或购买专属套餐\x20！','68238rMuYke','当前用户不存在,记录充值日志异常','update','当前用户无需创建账户信息！','invitedGuestSendModel4Count','model4','useModel3Count','CramiPackageEntity','5ifjgGt','__decorate','chatLogEntity','formatDate','../midjourney/midjourney.entity','model4Count','../chatLog/chatLog.entity','getAccountLog','AccountLogEntity','__esModule','avatar','weight','length','username','inviteGiveSendModel4Count','useDrawMjToken','sumModel3Count','inviteSendStatus','../globalConfig/config.entity','sumDrawMjCount','Injectable','4293288ZJHKxE','memberDrawMjCount','getOwnPropertyDescriptor','../../common/constants/balance.constant','forEach','BAD_REQUEST','inheritVisitorData','configVal','formatCreateOrUpdateDate','memberModel3Count','invitedGuestSendModel3Count','queryUserBalance','expireDateCn','Repository','writeOldBalanceToNewTable','status','GlobalConfigService','validateVisitorBalance','firstRregisterSendModel4Count','createRandomUid','invitedGuestSendDrawMjCount','SalesUsersEntity','saveCommissionAmount','deductFromBalance','debug','packageId','getMonth','whiteListEntity','refundMjBalance','缺失当前用户账户记录！','useModel4Count','salesService','expirationTime','账户信息已经存在、迁移无效','registerSendModel4Count','./balance.entity','__metadata','fingerprintLogEntity','@nestjs/typeorm','372414okDprF','model3Count','消费余额失败！','chatGroupEntity','findAndCount','save','5224784NFwBcW','function','../globalConfig/globalConfig.service','upgradeBalance','查询用户账户信息失败！','odel4','9DTanyq','model3','find','object','Logger','isUpdatedToday','getConfigs','createSalesRecords','visitorModel4Num','../chatGroup/chatGroup.entity','findOne','BalanceService','getFullYear','registerSendModel3Count'];_0xd8b5=function(){return _0x2c462d;};return _0xd8b5();}