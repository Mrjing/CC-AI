'use strict';const _0x2feaf7=_0x3ada;function _0x3ada(_0x220a06,_0x188689){const _0x2db865=_0x2db8();return _0x3ada=function(_0x3adacd,_0x4e2a3a){_0x3adacd=_0x3adacd-0x178;let _0xf12409=_0x2db865[_0x3adacd];return _0xf12409;},_0x3ada(_0x220a06,_0x188689);}(function(_0x2d2ee1,_0x4f2b3a){const _0x4fdad0=_0x3ada,_0x2de7a1=_0x2d2ee1();while(!![]){try{const _0x577912=parseInt(_0x4fdad0(0x17f))/0x1*(parseInt(_0x4fdad0(0x22c))/0x2)+parseInt(_0x4fdad0(0x1db))/0x3*(-parseInt(_0x4fdad0(0x1f1))/0x4)+parseInt(_0x4fdad0(0x1c2))/0x5*(-parseInt(_0x4fdad0(0x224))/0x6)+-parseInt(_0x4fdad0(0x1e9))/0x7*(parseInt(_0x4fdad0(0x22a))/0x8)+parseInt(_0x4fdad0(0x20c))/0x9*(parseInt(_0x4fdad0(0x1d8))/0xa)+parseInt(_0x4fdad0(0x1b8))/0xb*(-parseInt(_0x4fdad0(0x223))/0xc)+parseInt(_0x4fdad0(0x17e))/0xd;if(_0x577912===_0x4f2b3a)break;else _0x2de7a1['push'](_0x2de7a1['shift']());}catch(_0x3e4f9d){_0x2de7a1['push'](_0x2de7a1['shift']());}}}(_0x2db8,0x7b542));var __decorate=this&&this[_0x2feaf7(0x1d6)]||function(_0x18afeb,_0x577587,_0x49da99,_0x8b85d7){const _0x48d1b9=_0x2feaf7;var _0x463924=arguments[_0x48d1b9(0x239)],_0x5327b3=_0x463924<0x3?_0x577587:_0x8b85d7===null?_0x8b85d7=Object[_0x48d1b9(0x1de)](_0x577587,_0x49da99):_0x8b85d7,_0x39351c;if(typeof Reflect===_0x48d1b9(0x1ad)&&typeof Reflect[_0x48d1b9(0x21d)]==='function')_0x5327b3=Reflect[_0x48d1b9(0x21d)](_0x18afeb,_0x577587,_0x49da99,_0x8b85d7);else{for(var _0x1c99dc=_0x18afeb[_0x48d1b9(0x239)]-0x1;_0x1c99dc>=0x0;_0x1c99dc--)if(_0x39351c=_0x18afeb[_0x1c99dc])_0x5327b3=(_0x463924<0x3?_0x39351c(_0x5327b3):_0x463924>0x3?_0x39351c(_0x577587,_0x49da99,_0x5327b3):_0x39351c(_0x577587,_0x49da99))||_0x5327b3;}return _0x463924>0x3&&_0x5327b3&&Object[_0x48d1b9(0x191)](_0x577587,_0x49da99,_0x5327b3),_0x5327b3;},__metadata=this&&this[_0x2feaf7(0x180)]||function(_0x1eb749,_0x5af499){const _0xb446c7=_0x2feaf7;if(typeof Reflect===_0xb446c7(0x1ad)&&typeof Reflect[_0xb446c7(0x1ec)]===_0xb446c7(0x1d5))return Reflect['metadata'](_0x1eb749,_0x5af499);},__param=this&&this['__param']||function(_0x11d493,_0x308cb1){return function(_0x57b28f,_0x4fe2e2){_0x308cb1(_0x57b28f,_0x4fe2e2,_0x11d493);};};Object['defineProperty'](exports,_0x2feaf7(0x1cd),{'value':!![]}),exports[_0x2feaf7(0x216)]=void 0x0;const globalConfig_service_1=require(_0x2feaf7(0x192)),typeorm_1=require(_0x2feaf7(0x1bd)),balance_entity_1=require(_0x2feaf7(0x1b1)),common_1=require(_0x2feaf7(0x221)),typeorm_2=require(_0x2feaf7(0x232)),balance_constant_1=require('../../common/constants/balance.constant'),accountLog_entity_1=require(_0x2feaf7(0x23c)),utils_1=require(_0x2feaf7(0x1bf)),config_entity_1=require(_0x2feaf7(0x1be)),cramiPackage_entity_1=require(_0x2feaf7(0x1fc)),userBalance_entity_1=require('./userBalance.entity'),date_1=require('../../common/utils/date'),user_entity_1=require(_0x2feaf7(0x1a1)),salesUsers_entity_1=require(_0x2feaf7(0x222)),sales_service_1=require('../sales/sales.service'),whiteList_entity_1=require('../chatgpt/whiteList.entity'),fingerprint_entity_1=require('./fingerprint.entity'),chatLog_entity_1=require(_0x2feaf7(0x181)),chatGroup_entity_1=require(_0x2feaf7(0x198)),midjourney_entity_1=require(_0x2feaf7(0x208));let UserBalanceService=class UserBalanceService{constructor(_0x1a4ebb,_0x303ab5,_0x17c2a0,_0x5e4e1d,_0x55e5ab,_0x329b7e,_0x5d330f,_0x5b8fb7,_0x51a5a2,_0x3c1d68,_0xb27027,_0x43126b,_0x4228fd,_0x5d53a8){const _0x5879d0=_0x2feaf7;this['balanceEntity']=_0x1a4ebb,this[_0x5879d0(0x186)]=_0x303ab5,this[_0x5879d0(0x1f7)]=_0x17c2a0,this[_0x5879d0(0x1c4)]=_0x5e4e1d,this[_0x5879d0(0x18a)]=_0x55e5ab,this['userEntity']=_0x329b7e,this[_0x5879d0(0x205)]=_0x5d330f,this['whiteListEntity']=_0x5b8fb7,this[_0x5879d0(0x20b)]=_0x51a5a2,this[_0x5879d0(0x226)]=_0x3c1d68,this[_0x5879d0(0x196)]=_0xb27027,this[_0x5879d0(0x1f8)]=_0x43126b,this[_0x5879d0(0x201)]=_0x4228fd,this[_0x5879d0(0x1c0)]=_0x5d53a8;}async[_0x2feaf7(0x1b7)](_0xb15d6d,_0x4a032f){const _0x35200e=_0x2feaf7;try{const _0x2e0af0=await this['configEntity']['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x35200e(0x1c5),_0x35200e(0x1ba),'registerSendModel4Count',_0x35200e(0x1b0),_0x35200e(0x1e2),_0x35200e(0x202),_0x35200e(0x1d9),_0x35200e(0x178),_0x35200e(0x237),_0x35200e(0x23a),_0x35200e(0x1c6),_0x35200e(0x1ee),_0x35200e(0x1f0),'invitedGuestSendModel3Count',_0x35200e(0x190),_0x35200e(0x1eb)])}}),_0x13a15d=_0x2e0af0[_0x35200e(0x214)]((_0x3c8b3e,_0x15c427)=>{const _0x3c1898=_0x35200e,_0x240b89=Number(_0x15c427['configVal']),_0x140a33=Number['isInteger'](_0x240b89)&&_0x240b89>0x0?_0x240b89:0x0;return _0x3c8b3e[_0x15c427[_0x3c1898(0x20e)]]=_0x140a33,_0x3c8b3e;},{});let _0x285d7b=0x0,_0x9419b3=0x0,_0x540314=0x0;_0x13a15d['registerSendStatus']===0x1&&(_0x285d7b=_0x285d7b+_0x13a15d[_0x35200e(0x1ba)],_0x9419b3=_0x9419b3+_0x13a15d[_0x35200e(0x1e5)],_0x540314=_0x540314+_0x13a15d['registerSendDrawMjCount']),_0x13a15d[_0x35200e(0x1c5)]===0x1&&_0x13a15d[_0x35200e(0x1e2)]===0x1&&_0xb15d6d<=_0x13a15d['firstRegisterSendRank']&&(_0x285d7b=_0x285d7b+_0x13a15d[_0x35200e(0x1d9)],_0x9419b3=_0x9419b3+_0x13a15d['firstRregisterSendModel4Count'],_0x540314=_0x540314+_0x13a15d[_0x35200e(0x237)]),await this[_0x35200e(0x194)]({'userId':_0xb15d6d,'rechargeType':balance_constant_1['RechargeType'][_0x35200e(0x220)],'model3Count':_0x285d7b,'drawMjCount':_0x540314,'model4Count':_0x9419b3}),_0x4a032f&&(Number(_0x13a15d[_0x35200e(0x23a)])===0x1&&(_0x285d7b=_0x285d7b+Number(_0x13a15d[_0x35200e(0x1fb)]),_0x9419b3=_0x9419b3+Number(_0x13a15d['invitedGuestSendModel4Count']),_0x540314=_0x540314+Number(_0x13a15d[_0x35200e(0x190)]),await this[_0x35200e(0x194)]({'userId':_0xb15d6d,'rechargeType':balance_constant_1[_0x35200e(0x18d)][_0x35200e(0x1b6)],'model3Count':_0x13a15d['invitedGuestSendModel3Count'],'model4Count':_0x13a15d['invitedGuestSendModel4Count'],'drawMjCount':_0x13a15d[_0x35200e(0x190)]}),await this[_0x35200e(0x1cf)](_0x4a032f,{'model3Count':_0x13a15d[_0x35200e(0x1c6)],'model4Count':_0x13a15d[_0x35200e(0x1ee)],'drawMjCount':_0x13a15d[_0x35200e(0x1f0)]}),await this['saveRecordRechargeLog']({'userId':_0x4a032f,'rechargeType':balance_constant_1['RechargeType']['REFER_GIFT'],'model3Count':_0x13a15d['inviteGiveSendModel3Count'],'model4Count':_0x13a15d['inviteGiveSendModel4Count'],'drawMjCount':_0x13a15d['inviteGiveSendDrawMjCount']}))),await this[_0x35200e(0x186)][_0x35200e(0x189)]({'userId':_0xb15d6d,'model3Count':_0x285d7b,'model4Count':_0x9419b3,'drawMjCount':_0x540314,'useTokens':0x0});}catch(_0x34e52d){console['log'](_0x35200e(0x1e3),_0x34e52d);throw new common_1['HttpException'](_0x35200e(0x1d0),common_1[_0x35200e(0x212)][_0x35200e(0x19e)]);}}async[_0x2feaf7(0x18f)](_0x352349,_0x517cc2,_0xc13174){const _0x173db5=_0x2feaf7,{id:_0x5698ea,role:_0x1aef7d}=_0x352349[_0x173db5(0x1a4)];let _0x2188fb=await this[_0x173db5(0x186)][_0x173db5(0x1e4)]({'where':{'userId':_0x5698ea}});!_0x2188fb&&(_0x2188fb=await this[_0x173db5(0x179)](_0x5698ea));if(_0x1aef7d==='visitor')return this[_0x173db5(0x21e)](_0x352349,_0x517cc2,_0xc13174);const _0x5dc971=await this[_0x173db5(0x18a)][_0x173db5(0x1e4)]({'where':{'configKey':_0x173db5(0x1ab)}}),_0x210d82=_0x5dc971?_0x5dc971[_0x173db5(0x182)]:_0x173db5(0x18c),_0x57ab42=_0x517cc2===_0x173db5(0x22d)?_0x173db5(0x229):_0x517cc2===_0x173db5(0x23f)?_0x173db5(0x200):_0x517cc2===_0x173db5(0x1f5)?_0x173db5(0x1ae):null,_0x64d675=_0x517cc2===_0x173db5(0x22d)?_0x173db5(0x228):_0x517cc2===_0x173db5(0x23f)?_0x173db5(0x241):_0x517cc2==='mjDraw'?_0x173db5(0x1d4):null;if(_0x2188fb['packageId']&&_0x2188fb[_0x57ab42]<_0xc13174){if(_0x2188fb[_0x64d675]<_0xc13174)throw new common_1[(_0x173db5(0x1c1))](_0x173db5(0x20f)+_0x210d82+_0x173db5(0x1e1),common_1[_0x173db5(0x212)][_0x173db5(0x17a)]);}if(!_0x2188fb[_0x173db5(0x195)]&&_0x2188fb[_0x64d675]<_0xc13174)throw new common_1[(_0x173db5(0x1c1))](_0x173db5(0x20f)+_0x210d82+_0x173db5(0x1e1),common_1[_0x173db5(0x212)][_0x173db5(0x17a)]);return _0x2188fb;}async['validateVisitorBalance'](_0x353337,_0x3b379c,_0x31d503){const _0x55aca2=_0x2feaf7,{id:_0x42f65c}=_0x353337['user'],_0x49159a=_0x3b379c===_0x55aca2(0x22d)?_0x55aca2(0x228):_0x3b379c===_0x55aca2(0x23f)?_0x55aca2(0x241):_0x3b379c===_0x55aca2(0x1f5)?_0x55aca2(0x1d4):null,_0x415cfc=new Date(),_0x41cc94=await this[_0x55aca2(0x20b)][_0x55aca2(0x1e4)]({'where':{'fingerprint':_0x42f65c}}),{visitorModel3Num:_0x5c0dc7,visitorModel4Num:_0x385e6e,visitorMJNum:_0x18af3d}=await this[_0x55aca2(0x1c0)][_0x55aca2(0x219)](['visitorModel3Num','visitorModel4Num',_0x55aca2(0x20d)]),_0x3abd6e={'model3Count':_0x5c0dc7?Number(_0x5c0dc7):0x0,'model4Count':_0x385e6e?Number(_0x385e6e):0x0,'drawMjCount':_0x18af3d?Number(_0x18af3d):0x0};if(!_0x41cc94){const _0x42afab={'fingerprint':_0x42f65c,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x42afab[_0x49159a]=_0x42afab[_0x49159a]+_0x31d503;if(_0x42afab[_0x49159a]>_0x3abd6e[_0x49159a])throw new common_1[(_0x55aca2(0x1c1))](_0x55aca2(0x19f),common_1[_0x55aca2(0x212)][_0x55aca2(0x17a)]);else return await this[_0x55aca2(0x20b)][_0x55aca2(0x189)](_0x42afab),!![];}else{const {model3Count:_0xffd3c0,model4Count:_0xff47d8,drawMjCount:_0x2af457}=_0x41cc94;let _0x20d0e0={'model3Count':_0xffd3c0,'model4Count':_0xff47d8,'drawMjCount':_0x2af457};const _0x33868b=Number(new Date(_0x41cc94[_0x55aca2(0x21f)])),_0x23fd7e=this[_0x55aca2(0x20a)](_0x33868b);_0x23fd7e?_0x20d0e0[_0x49159a]=_0x20d0e0[_0x49159a]+_0x31d503:(_0x20d0e0={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x20d0e0[_0x49159a]=_0x20d0e0[_0x49159a]+_0x31d503);if(_0x20d0e0[_0x49159a]>_0x3abd6e[_0x49159a])throw new common_1[(_0x55aca2(0x1c1))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1[_0x55aca2(0x212)]['PAYMENT_REQUIRED']);else return await this[_0x55aca2(0x20b)][_0x55aca2(0x19b)]({'fingerprint':_0x42f65c},_0x20d0e0),!![];}}[_0x2feaf7(0x20a)](_0x44eab7){const _0x1fcf7d=_0x2feaf7,_0x2c8f30=new Date(),_0x315c31=new Date(_0x2c8f30[_0x1fcf7d(0x22f)](),_0x2c8f30[_0x1fcf7d(0x1c8)](),_0x2c8f30['getDate']());return _0x44eab7>=_0x315c31;}async[_0x2feaf7(0x207)](_0x19de59,_0x2cc3b8,_0x5874d5,_0x505686=0x0){const _0x246820=_0x2feaf7,_0x55bea1=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x19de59}});if(!_0x55bea1)throw new common_1[(_0x246820(0x1c1))](_0x246820(0x210),common_1[_0x246820(0x212)][_0x246820(0x19e)]);const _0x5adc72=_0x2cc3b8===_0x246820(0x22d)?_0x246820(0x229):_0x2cc3b8===_0x246820(0x23f)?_0x246820(0x200):_0x2cc3b8===_0x246820(0x1f5)?_0x246820(0x1ae):null,_0x2b1a76=_0x2cc3b8===_0x246820(0x22d)?_0x246820(0x228):_0x2cc3b8===_0x246820(0x23f)?_0x246820(0x241):_0x2cc3b8===_0x246820(0x1f5)?_0x246820(0x1d4):null,_0x2011b1=_0x55bea1[_0x246820(0x195)]&&_0x55bea1[_0x5adc72]<_0x5874d5?_0x2b1a76:_0x55bea1[_0x246820(0x195)]?_0x5adc72:_0x2b1a76;let _0x3c2b07=null;_0x2011b1['includes'](_0x246820(0x1ef))&&(_0x3c2b07='useModel3Token');_0x2011b1['includes'](_0x246820(0x235))&&(_0x3c2b07=_0x246820(0x1f3));_0x2011b1[_0x246820(0x1e8)](_0x246820(0x22e))&&(_0x3c2b07=_0x246820(0x218));const _0x3dab8c={[_0x2011b1]:_0x55bea1[_0x2011b1]-_0x5874d5<0x0?0x0:_0x55bea1[_0x2011b1]-_0x5874d5,[_0x3c2b07]:_0x55bea1[_0x3c2b07]+_0x505686};_0x3c2b07===_0x246820(0x204)&&(_0x3dab8c[_0x246820(0x1c7)]=_0x55bea1['useModel3Count']+_0x5874d5),_0x3c2b07===_0x246820(0x1f3)&&(_0x3dab8c['useModel4Count']=_0x55bea1['useModel4Count']+_0x5874d5);const _0x38be8d=await this[_0x246820(0x186)][_0x246820(0x19b)]({'userId':_0x19de59},_0x3dab8c);if(_0x38be8d[_0x246820(0x217)]===0x0)throw new common_1['HttpException'](_0x246820(0x1a5),common_1[_0x246820(0x212)][_0x246820(0x19e)]);}async[_0x2feaf7(0x1d2)](_0x23e9c8){const _0x3b90e2=_0x2feaf7;try{const _0x44ad09=await this[_0x3b90e2(0x186)][_0x3b90e2(0x1e4)]({'where':{'userId':_0x23e9c8},'select':[_0x3b90e2(0x195),_0x3b90e2(0x228),_0x3b90e2(0x241),_0x3b90e2(0x1d4),_0x3b90e2(0x229),_0x3b90e2(0x200),_0x3b90e2(0x1ae),_0x3b90e2(0x1c7),_0x3b90e2(0x197),_0x3b90e2(0x204),_0x3b90e2(0x1f3),'useDrawMjToken',_0x3b90e2(0x1fa)]});if(!_0x44ad09){const _0x31e8bc=await this['createBaseUserBalance'](_0x23e9c8);if(_0x31e8bc)return await this[_0x3b90e2(0x1d2)](_0x23e9c8);else throw new common_1['HttpException'](_0x3b90e2(0x1aa),common_1['HttpStatus'][_0x3b90e2(0x19e)]);}return _0x44ad09['sumModel3Count']=_0x44ad09[_0x3b90e2(0x195)]?_0x44ad09['model3Count']+_0x44ad09[_0x3b90e2(0x229)]:_0x44ad09['model3Count'],_0x44ad09[_0x3b90e2(0x1df)]=_0x44ad09[_0x3b90e2(0x195)]?_0x44ad09[_0x3b90e2(0x241)]+_0x44ad09['memberModel4Count']:_0x44ad09[_0x3b90e2(0x241)],_0x44ad09[_0x3b90e2(0x1a7)]=_0x44ad09[_0x3b90e2(0x195)]?_0x44ad09[_0x3b90e2(0x1d4)]+_0x44ad09['memberDrawMjCount']:_0x44ad09[_0x3b90e2(0x1d4)],_0x44ad09[_0x3b90e2(0x1fa)]=_0x44ad09[_0x3b90e2(0x1fa)]?(0x0,date_1[_0x3b90e2(0x19d)])(_0x44ad09['expirationTime'],_0x3b90e2(0x1d3)):null,_0x44ad09;}catch(_0x154de6){console[_0x3b90e2(0x233)](_0x3b90e2(0x1e3),_0x154de6);}}async[_0x2feaf7(0x194)](_0x3cf38f){const _0x206718=_0x2feaf7,{userId:_0x914ab2,rechargeType:_0x3bdd06,model3Count:_0x2d9594,model4Count:_0x3cac37,drawMjCount:_0x2570b5,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x3cf38f;if(!_0x914ab2)throw new common_1['HttpException'](_0x206718(0x1e0),common_1[_0x206718(0x212)][_0x206718(0x19e)]);const _0x59aab8=(0x0,utils_1[_0x206718(0x1b5)])();return await this[_0x206718(0x1f7)]['save']({'userId':_0x914ab2,'rechargeType':_0x3bdd06,'model3Count':_0x2d9594,'model4Count':_0x3cac37,'drawMjCount':_0x2570b5,'days':days,'extent':extent,'uid':_0x59aab8,'pkgName':pkgName});}async['createBaseUserBalance'](_0x409e83,_0xb3cb8b={}){const _0x4450c3=_0x2feaf7,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0xb3cb8b,_0xe02b20=await this[_0x4450c3(0x186)][_0x4450c3(0x1e4)]({'where':{'userId':_0x409e83}});if(_0xe02b20)throw new common_1[(_0x4450c3(0x1c1))]('当前用户无需创建账户信息！',common_1[_0x4450c3(0x212)]['BAD_REQUEST']);return await this[_0x4450c3(0x186)]['save']({'userId':_0x409e83,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x2feaf7(0x1cf)](_0x497132,_0x5467f4,_0x15888c=-0x1){const _0x5a5b1c=_0x2feaf7;try{const _0x1ec779=await this[_0x5a5b1c(0x186)]['findOne']({'where':{'userId':_0x497132}})||await this[_0x5a5b1c(0x179)](_0x497132);if(!_0x1ec779)throw new common_1[(_0x5a5b1c(0x1c1))](_0x5a5b1c(0x1bc),common_1[_0x5a5b1c(0x212)][_0x5a5b1c(0x19e)]);const {model3Count:_0x2ffb5a,model4Count:_0xaccdfc,drawMjCount:_0x9a4e92,memberModel3Count:_0xe6fe4f,memberModel4Count:_0x5b8102,memberDrawMjCount:_0x53decd}=_0x1ec779;let _0x4cc32f={};if(_0x15888c>0x0){const {packageId:_0x2cad35}=_0x5467f4;if(!_0x2cad35)throw new common_1[(_0x5a5b1c(0x1c1))](_0x5a5b1c(0x183),common_1[_0x5a5b1c(0x212)]['BAD_REQUEST']);const _0x53eaae=await this['cramiPackageEntity'][_0x5a5b1c(0x1e4)]({'where':{'id':_0x2cad35}});if(!_0x53eaae)throw new common_1[(_0x5a5b1c(0x1c1))](_0x5a5b1c(0x234),common_1['HttpStatus'][_0x5a5b1c(0x19e)]);const {weight:_0x3e7998}=_0x53eaae;if(!_0x1ec779[_0x5a5b1c(0x195)])_0x4cc32f={'memberModel3Count':_0x2ffb5a+_0x5467f4[_0x5a5b1c(0x228)],'memberModel4Count':_0xaccdfc+_0x5467f4[_0x5a5b1c(0x241)],'memberDrawMjCount':_0x9a4e92+_0x5467f4[_0x5a5b1c(0x1d4)],'expirationTime':(0x0,date_1['default'])()['add'](_0x15888c>0x0?_0x15888c:0x0,_0x5a5b1c(0x21c))[_0x5a5b1c(0x209)](_0x5a5b1c(0x1b9)),'packageId':_0x2cad35};else{const _0x48c92a=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x1ec779[_0x5a5b1c(0x195)]}});_0x3e7998>=_0x48c92a['weight']&&(_0x4cc32f={'memberModel3Count':_0xe6fe4f+_0x5467f4[_0x5a5b1c(0x228)],'memberModel4Count':_0x5b8102+_0x5467f4[_0x5a5b1c(0x241)],'memberDrawMjCount':_0x53decd+_0x5467f4[_0x5a5b1c(0x1d4)],'expirationTime':(0x0,date_1[_0x5a5b1c(0x1dc)])(_0x1ec779[_0x5a5b1c(0x1fa)])[_0x5a5b1c(0x23d)](_0x15888c>0x0?_0x15888c:0x0,_0x5a5b1c(0x21c))[_0x5a5b1c(0x209)](_0x5a5b1c(0x1b9)),'packageId':_0x2cad35}),_0x3e7998<_0x48c92a[_0x5a5b1c(0x213)]&&(_0x4cc32f={'memberModel3Count':_0xe6fe4f+_0x5467f4[_0x5a5b1c(0x228)],'memberModel4Count':_0x5b8102+_0x5467f4[_0x5a5b1c(0x241)],'memberDrawMjCount':_0x53decd+_0x5467f4[_0x5a5b1c(0x1d4)]});}}_0x15888c<=0x0&&(_0x4cc32f={'model3Count':_0x2ffb5a+_0x5467f4[_0x5a5b1c(0x228)],'model4Count':_0xaccdfc+_0x5467f4[_0x5a5b1c(0x241)],'drawMjCount':_0x9a4e92+_0x5467f4[_0x5a5b1c(0x1d4)]});const _0x3c7599=await this[_0x5a5b1c(0x186)][_0x5a5b1c(0x19b)]({'userId':_0x497132},_0x4cc32f);if(_0x3c7599[_0x5a5b1c(0x217)]===0x0)throw new common_1[(_0x5a5b1c(0x1c1))](_0x497132+'充值失败',common_1[_0x5a5b1c(0x212)]['BAD_REQUEST']);}catch(_0x42870f){console[_0x5a5b1c(0x233)]('error:\x20',_0x42870f);throw new common_1[(_0x5a5b1c(0x1c1))](_0x5a5b1c(0x1bb),common_1[_0x5a5b1c(0x212)][_0x5a5b1c(0x19e)]);}}async[_0x2feaf7(0x238)](_0x1f7389){const _0xba41a6=_0x2feaf7;console['log'](_0xba41a6(0x1c3),_0x1f7389);try{const {userId:_0x240805,goodsId:_0x310f52}=_0x1f7389,_0x3bcc03=await this[_0xba41a6(0x1c4)][_0xba41a6(0x1e4)]({'where':{'id':_0x1f7389['goodsId'],'status':0x1}});if(!_0x3bcc03)throw new common_1[(_0xba41a6(0x1c1))](_0xba41a6(0x1e7),common_1[_0xba41a6(0x212)][_0xba41a6(0x19e)]);const {model3Count:_0x5e3a9e,model4Count:_0x58d9c0,drawMjCount:_0x38311a,days:_0x1cc8a1,name:_0x4e5f28}=_0x3bcc03,_0x5cb71c={'model3Count':_0x5e3a9e,'model4Count':_0x58d9c0,'drawMjCount':_0x38311a,'days':_0x1cc8a1,'packageId':_0x1f7389[_0xba41a6(0x1ce)]};await this[_0xba41a6(0x1cf)](_0x240805,_0x5cb71c,_0x1cc8a1),await this[_0xba41a6(0x194)]({'userId':_0x240805,'rechargeType':balance_constant_1[_0xba41a6(0x18d)][_0xba41a6(0x1fe)],'model3Count':_0x5e3a9e,'model4Count':_0x58d9c0,'drawMjCount':_0x38311a,'pkgName':_0x4e5f28,'days':_0x1cc8a1});const _0x2f0b5e=await this[_0xba41a6(0x1a3)][_0xba41a6(0x1e4)]({'where':{'id':_0x240805}}),{invitedBy:_0x1ac9ea}=_0x2f0b5e;if(_0x1ac9ea){const _0x1e0dd6=await this[_0xba41a6(0x1a3)]['findOne']({'where':{'inviteCode':_0x1ac9ea}}),_0x248426=await this[_0xba41a6(0x205)][_0xba41a6(0x1e4)]({'where':{'userId':_0x1e0dd6['id']}});if(!_0x1e0dd6)return;const {id:_0x840d2a}=_0x1e0dd6,{performanceRatio:_0x6773f4}=_0x248426,_0x1eb1bc={'inviterUserId':_0x840d2a,'inviteeUserId':_0x240805,'orderId':_0x1f7389['id'],'orderPrice':_0x1f7389[_0xba41a6(0x1af)],'commissionPercentage':_0x6773f4,'commissionAmount':(_0x1f7389['total']*_0x6773f4/0x64)['toFixed'](0x2)};await this[_0xba41a6(0x201)][_0xba41a6(0x188)](_0x1eb1bc),await this[_0xba41a6(0x201)][_0xba41a6(0x21a)](_0x840d2a,_0x1eb1bc[_0xba41a6(0x1a6)]);}}catch(_0x49bafd){console[_0xba41a6(0x233)]('error:\x20',_0x49bafd);throw new common_1[(_0xba41a6(0x1c1))]('充值失败！',common_1['HttpStatus'][_0xba41a6(0x19e)]);}}async['getRechargeLog'](_0x2ead97,_0x14cf51){const _0x4592df=_0x2feaf7,{page:page=0x1,size:size=0x14}=_0x14cf51,{id:_0x1251d6}=_0x2ead97['user'],[_0x29bc5a,_0x493896]=await this[_0x4592df(0x1f7)]['findAndCount']({'where':{'userId':_0x1251d6},'order':{'id':_0x4592df(0x1d1)},'skip':(page-0x1)*size,'take':size});return _0x29bc5a['forEach'](_0x37f6ad=>{const _0x150be5=_0x4592df;_0x37f6ad[_0x150be5(0x1a8)]=_0x37f6ad[_0x150be5(0x193)]>0x0?_0x37f6ad[_0x150be5(0x193)]+'天':'永久';}),{'rows':(0x0,date_1[_0x4592df(0x17b)])(_0x29bc5a),'count':_0x493896};}async['getAccountLog'](_0x2c5ea2,_0x285788){const _0x4ee630=_0x2feaf7;try{const {page:page=0x1,size:size=0xa,userId:_0x947f17,rechargeType:_0x157d66,packageId:_0x3df74f}=_0x285788,{role:_0x32b5d5}=_0x2c5ea2[_0x4ee630(0x1a4)],_0x315191={};_0x157d66&&(_0x315191[_0x4ee630(0x23b)]=_0x157d66),_0x315191[_0x4ee630(0x17d)]=_0x947f17||(0x0,typeorm_2[_0x4ee630(0x21b)])(0x186a0),_0x3df74f&&(_0x315191[_0x4ee630(0x195)]={'$like':'%'+_0x3df74f+'%'});const [_0x331df7,_0x638441]=await this[_0x4ee630(0x1f7)]['findAndCount']({'where':_0x315191,'order':{'id':_0x4ee630(0x1d1)},'skip':(page-0x1)*size,'take':size}),_0x1874d8=_0x331df7['map'](_0xc3b07c=>_0xc3b07c[_0x4ee630(0x17d)]),_0x4ec735=await this[_0x4ee630(0x1a3)][_0x4ee630(0x22b)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1874d8)}});return _0x331df7[_0x4ee630(0x211)](_0x2dbf8b=>{const _0x11e713=_0x4ee630,_0x4e711d=_0x4ec735[_0x11e713(0x22b)](_0x1f837b=>_0x1f837b['id']===_0x2dbf8b[_0x11e713(0x17d)]);_0x2dbf8b[_0x11e713(0x1da)]=_0x4e711d===null||_0x4e711d===void 0x0?void 0x0:_0x4e711d[_0x11e713(0x1da)],_0x2dbf8b[_0x11e713(0x19a)]=_0x4e711d===null||_0x4e711d===void 0x0?void 0x0:_0x4e711d[_0x11e713(0x19a)],_0x2dbf8b[_0x11e713(0x1a0)]=_0x4e711d===null||_0x4e711d===void 0x0?void 0x0:_0x4e711d['phone'],_0x2dbf8b[_0x11e713(0x1ff)]=_0x4e711d===null||_0x4e711d===void 0x0?void 0x0:_0x4e711d[_0x11e713(0x1ff)],_0x2dbf8b[_0x11e713(0x1fd)]=_0x4e711d===null||_0x4e711d===void 0x0?void 0x0:_0x4e711d[_0x11e713(0x1fd)];}),_0x32b5d5!==_0x4ee630(0x1ac)&&_0x331df7['forEach'](_0x35984c=>{const _0x3dd65e=_0x4ee630;_0x35984c[_0x3dd65e(0x19a)]=_0x35984c[_0x3dd65e(0x19a)]?(0x0,utils_1[_0x3dd65e(0x225)])(_0x35984c[_0x3dd65e(0x19a)]):'',_0x35984c['phone']=_0x35984c[_0x3dd65e(0x1a0)]?(0x0,utils_1['hideString'])(_0x35984c['phone']):'';}),{'rows':_0x331df7,'count':_0x638441};}catch(_0x3d02f3){console[_0x4ee630(0x233)](_0x4ee630(0x1e3),_0x3d02f3);throw new common_1['HttpException'](_0x4ee630(0x23e),common_1[_0x4ee630(0x212)][_0x4ee630(0x19e)]);}}async['queryUserBalanceByIds'](_0x22ff36){const _0x3b5063=_0x2feaf7;return await this[_0x3b5063(0x186)][_0x3b5063(0x22b)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x22ff36)}});}async[_0x2feaf7(0x231)](_0x1a5437,_0x51d016){const _0xae10d4=_0x2feaf7;return await this[_0xae10d4(0x207)](_0x1a5437,'mjDraw',-_0x51d016);}async['upgradeBalance'](){const _0x5a3b52=_0x2feaf7,_0x18b958=await this[_0x5a3b52(0x1a3)]['find']();if(!_0x18b958[_0x5a3b52(0x239)])return;const _0x412eb7=await this[_0x5a3b52(0x1c0)][_0x5a3b52(0x219)]([_0x5a3b52(0x185)]);if(!_0x412eb7)await this[_0x5a3b52(0x1c0)][_0x5a3b52(0x1f9)]({'settings':[{'configKey':_0x5a3b52(0x185),'configVal':'1'}]});else throw new common_1[(_0x5a3b52(0x1c1))](_0x5a3b52(0x18b),common_1[_0x5a3b52(0x212)][_0x5a3b52(0x19e)]);_0x18b958[_0x5a3b52(0x211)](_0x32b005=>{const _0x1e2902=_0x5a3b52,{id:_0x2353cb}=_0x32b005;this[_0x1e2902(0x1b4)][_0x1e2902(0x1e4)]({'where':{'userId':_0x2353cb}})[_0x1e2902(0x1f6)](_0x1b38ec=>{const _0x153e01=_0x1e2902;if(!_0x1b38ec)return;this[_0x153e01(0x1e6)](_0x2353cb,_0x1b38ec);});});}async['writeOldBalanceToNewTable'](_0x18361e,_0x794f49){const _0x9403ea=_0x2feaf7,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x794f49,_0x2e31ad=await this[_0x9403ea(0x215)]['findOne']({'where':{'userId':_0x18361e}}),_0x1ddaa0={'userId':_0x18361e,'model3Count':Number(usesLeft),'model4Count':(_0x2e31ad===null||_0x2e31ad===void 0x0?void 0x0:_0x2e31ad[_0x9403ea(0x1b2)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x2e31ad===null||_0x2e31ad===void 0x0?void 0x0:_0x2e31ad[_0x9403ea(0x1f2)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x112cfd=await this[_0x9403ea(0x186)]['findOne']({'where':{'userId':_0x18361e}});_0x112cfd?common_1[_0x9403ea(0x1dd)][_0x9403ea(0x203)]('用户'+_0x18361e+'账户信息已经存在、迁移无效',_0x9403ea(0x1cb)):this[_0x9403ea(0x186)][_0x9403ea(0x189)](_0x1ddaa0)[_0x9403ea(0x1f6)](_0x4822e9=>{const _0x44753b=_0x9403ea;common_1[_0x44753b(0x1dd)][_0x44753b(0x203)]('用户'+_0x18361e+_0x44753b(0x1b3),_0x44753b(0x1cb));})[_0x9403ea(0x199)](_0x1439ca=>{const _0x295256=_0x9403ea;console[_0x295256(0x233)]('error:\x20',_0x1439ca),common_1[_0x295256(0x1dd)][_0x295256(0x203)]('用户'+_0x18361e+_0x295256(0x206),'BalanceService');});}async[_0x2feaf7(0x1a2)](_0x145fad){const _0x39283=_0x2feaf7,{fingerprint:_0x439373}=_0x145fad[_0x39283(0x187)],{id:_0x47a716}=_0x145fad[_0x39283(0x1a4)];return await this[_0x39283(0x196)]['update']({'userId':Number(_0x439373)},{'userId':_0x47a716}),await this[_0x39283(0x226)][_0x39283(0x19b)]({'userId':Number(_0x439373)},{'userId':_0x47a716}),await this[_0x39283(0x1f8)][_0x39283(0x19b)]({'userId':Number(_0x439373)},{'userId':_0x47a716}),0x1;}async[_0x2feaf7(0x1a9)](_0x386170){const _0x182a7d=_0x2feaf7,{fingerprint:_0x288c5f}=_0x386170[_0x182a7d(0x187)],_0x1e8b29=await this[_0x182a7d(0x196)][_0x182a7d(0x1b2)]({'where':{'userId':_0x288c5f}}),_0x56c752=await this['chatGroupEntity']['count']({'where':{'userId':_0x288c5f}}),_0x32be2e=await this[_0x182a7d(0x1f8)][_0x182a7d(0x1b2)]({'where':{'userId':_0x288c5f}});return _0x1e8b29||_0x56c752||_0x32be2e||0x0;}};function _0x2db8(){const _0x370e13=['@nestjs/common','../sales/salesUsers.entity','504612Edyysy','42DyUgwm','hideString','chatGroupEntity','GlobalConfigService','model3Count','memberModel3Count','183752JGHIKk','find','34WmVsSc','model3','MjCount','getFullYear','Repository','refundMjBalance','typeorm','log','当前套餐不存在！','odel4','Injectable','firstRregisterSendDrawMjCount','addBalanceToOrder','length','inviteSendStatus','rechargeType','./accountLog.entity','add','查询用户账户失败！','model4','ChatLogEntity','model4Count','firstRregisterSendModel4Count','createBaseUserBalance','PAYMENT_REQUIRED','formatCreateOrUpdateDate','SalesService','userId','7468539asRqbU','57817KasNVT','__metadata','../chatLog/chatLog.entity','configVal','缺失当前套餐ID、充值失败！','CramiPackageEntity','upgradeStatus','userBalanceEntity','headers','createSalesRecords','save','configEntity','您已经升级过了、请勿重复操作！','---','RechargeType','UserEntity','validateBalance','invitedGuestSendDrawMjCount','defineProperty','../globalConfig/globalConfig.service','days','saveRecordRechargeLog','packageId','chatLogEntity','useModel4Count','../chatGroup/chatGroup.entity','catch','email','update','AccountLogEntity','formatDate','BAD_REQUEST','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','phone','../user/user.entity','inheritVisitorData','userEntity','user','消费余额失败！','commissionAmount','sumDrawMjCount','expireDateCn','getVisitorCount','查询当前用户余额失败！','vxNumber','super','object','memberDrawMjCount','total','registerSendDrawMjCount','./balance.entity','count','旧账户信息迁移成功','balanceEntity','createRandomUid','INVITE_GIFT','addBalanceToNewUser','55ROzlMR','YYYY-MM-DD\x20HH:mm:ss','registerSendModel3Count','用户充值失败！','查询用户账户信息失败！','@nestjs/typeorm','../globalConfig/config.entity','../../common/utils','globalConfigService','HttpException','386305qTDbAC','充值的工单信息:','cramiPackageEntity','registerSendStatus','inviteGiveSendModel3Count','useModel3Count','getMonth','InjectRepository','design:paramtypes','BalanceService','UserBalanceEntity','__esModule','goodsId','addBalanceToUser','注册赠送失败,请联系管理员！','DESC','queryUserBalance','YYYY-MM-DD','drawMjCount','function','__decorate','MidjourneyEntity','9970LVPFqF','firstRregisterSendModel3Count','username','3DraYPz','default','Logger','getOwnPropertyDescriptor','sumModel4Count','当前用户不存在,记录充值日志异常','>\x20或购买专属套餐\x20！','firstRegisterSendStatus','error:\x20','findOne','registerSendModel4Count','writeOldBalanceToNewTable','非法操作、当前充值套餐暂不存在！','includes','35LDIeeM','SalesUsersEntity','invitedGuestSendModel4Count','metadata','FingerprintLogEntity','inviteGiveSendModel4Count','odel3','inviteGiveSendDrawMjCount','2703352MgaBqH','useCount','useModel4Token','ChatGroupEntity','mjDraw','then','accountLogEntity','midjourneyEntity','setConfig','expirationTime','invitedGuestSendModel3Count','../crami/cramiPackage.entity','avatar','SCAN_PAY','status','memberModel4Count','salesService','firstRegisterSendRank','debug','useModel3Token','salesUsersEntity','旧账户信息迁移失败','deductFromBalance','../midjourney/midjourney.entity','format','isUpdatedToday','fingerprintLogEntity','4419AiHKxM','visitorMJNum','configKey','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','缺失当前用户账户记录！','forEach','HttpStatus','weight','reduce','whiteListEntity','UserBalanceService','affected','useDrawMjToken','getConfigs','saveCommissionAmount','LessThan','day','decorate','validateVisitorBalance','updatedAt','REG_GIFT'];_0x2db8=function(){return _0x370e13;};return _0x2db8();}UserBalanceService=__decorate([(0x0,common_1[_0x2feaf7(0x236)])(),__param(0x0,(0x0,typeorm_1[_0x2feaf7(0x1c9)])(balance_entity_1['BalanceEntity'])),__param(0x1,(0x0,typeorm_1[_0x2feaf7(0x1c9)])(userBalance_entity_1[_0x2feaf7(0x1cc)])),__param(0x2,(0x0,typeorm_1[_0x2feaf7(0x1c9)])(accountLog_entity_1[_0x2feaf7(0x19c)])),__param(0x3,(0x0,typeorm_1[_0x2feaf7(0x1c9)])(cramiPackage_entity_1[_0x2feaf7(0x184)])),__param(0x4,(0x0,typeorm_1[_0x2feaf7(0x1c9)])(config_entity_1['ConfigEntity'])),__param(0x5,(0x0,typeorm_1[_0x2feaf7(0x1c9)])(user_entity_1[_0x2feaf7(0x18e)])),__param(0x6,(0x0,typeorm_1[_0x2feaf7(0x1c9)])(salesUsers_entity_1[_0x2feaf7(0x1ea)])),__param(0x7,(0x0,typeorm_1[_0x2feaf7(0x1c9)])(whiteList_entity_1['WhiteListEntity'])),__param(0x8,(0x0,typeorm_1[_0x2feaf7(0x1c9)])(fingerprint_entity_1[_0x2feaf7(0x1ed)])),__param(0x9,(0x0,typeorm_1[_0x2feaf7(0x1c9)])(chatGroup_entity_1[_0x2feaf7(0x1f4)])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x2feaf7(0x240)])),__param(0xb,(0x0,typeorm_1[_0x2feaf7(0x1c9)])(midjourney_entity_1[_0x2feaf7(0x1d7)])),__metadata(_0x2feaf7(0x1ca),[typeorm_2[_0x2feaf7(0x230)],typeorm_2[_0x2feaf7(0x230)],typeorm_2[_0x2feaf7(0x230)],typeorm_2['Repository'],typeorm_2[_0x2feaf7(0x230)],typeorm_2['Repository'],typeorm_2[_0x2feaf7(0x230)],typeorm_2[_0x2feaf7(0x230)],typeorm_2[_0x2feaf7(0x230)],typeorm_2[_0x2feaf7(0x230)],typeorm_2[_0x2feaf7(0x230)],typeorm_2[_0x2feaf7(0x230)],sales_service_1[_0x2feaf7(0x17c)],globalConfig_service_1[_0x2feaf7(0x227)]])],UserBalanceService),exports[_0x2feaf7(0x216)]=UserBalanceService;