'use strict';const _0xdb032f=_0x43e3;(function(_0x414d91,_0x176d16){const _0x1b768b=_0x43e3,_0x4e67a2=_0x414d91();while(!![]){try{const _0x319199=-parseInt(_0x1b768b(0x25a))/0x1*(parseInt(_0x1b768b(0x24b))/0x2)+parseInt(_0x1b768b(0x1f6))/0x3+-parseInt(_0x1b768b(0x245))/0x4*(parseInt(_0x1b768b(0x284))/0x5)+-parseInt(_0x1b768b(0x223))/0x6*(-parseInt(_0x1b768b(0x29b))/0x7)+parseInt(_0x1b768b(0x265))/0x8*(-parseInt(_0x1b768b(0x22e))/0x9)+parseInt(_0x1b768b(0x267))/0xa+-parseInt(_0x1b768b(0x25f))/0xb*(-parseInt(_0x1b768b(0x218))/0xc);if(_0x319199===_0x176d16)break;else _0x4e67a2['push'](_0x4e67a2['shift']());}catch(_0x41e221){_0x4e67a2['push'](_0x4e67a2['shift']());}}}(_0x25bd,0xc26a5));var __decorate=this&&this[_0xdb032f(0x20f)]||function(_0x1347d1,_0x397a5b,_0x2681a8,_0x107d54){const _0x103477=_0xdb032f;var _0xd8f5b=arguments[_0x103477(0x241)],_0x1a7e28=_0xd8f5b<0x3?_0x397a5b:_0x107d54===null?_0x107d54=Object[_0x103477(0x281)](_0x397a5b,_0x2681a8):_0x107d54,_0x25f67e;if(typeof Reflect===_0x103477(0x1f4)&&typeof Reflect[_0x103477(0x21f)]===_0x103477(0x1fa))_0x1a7e28=Reflect['decorate'](_0x1347d1,_0x397a5b,_0x2681a8,_0x107d54);else{for(var _0x3081aa=_0x1347d1[_0x103477(0x241)]-0x1;_0x3081aa>=0x0;_0x3081aa--)if(_0x25f67e=_0x1347d1[_0x3081aa])_0x1a7e28=(_0xd8f5b<0x3?_0x25f67e(_0x1a7e28):_0xd8f5b>0x3?_0x25f67e(_0x397a5b,_0x2681a8,_0x1a7e28):_0x25f67e(_0x397a5b,_0x2681a8))||_0x1a7e28;}return _0xd8f5b>0x3&&_0x1a7e28&&Object[_0x103477(0x23f)](_0x397a5b,_0x2681a8,_0x1a7e28),_0x1a7e28;},__metadata=this&&this['__metadata']||function(_0x36050f,_0x3828a){const _0x44f147=_0xdb032f;if(typeof Reflect===_0x44f147(0x1f4)&&typeof Reflect[_0x44f147(0x289)]===_0x44f147(0x1fa))return Reflect[_0x44f147(0x289)](_0x36050f,_0x3828a);},__param=this&&this[_0xdb032f(0x28d)]||function(_0x2fc225,_0x310ba6){return function(_0xa2f437,_0x26d248){_0x310ba6(_0xa2f437,_0x26d248,_0x2fc225);};};Object['defineProperty'](exports,_0xdb032f(0x282),{'value':!![]}),exports[_0xdb032f(0x22c)]=void 0x0;const globalConfig_service_1=require(_0xdb032f(0x249)),typeorm_1=require(_0xdb032f(0x286)),balance_entity_1=require('./balance.entity'),common_1=require(_0xdb032f(0x264)),typeorm_2=require(_0xdb032f(0x22d)),balance_constant_1=require(_0xdb032f(0x208)),accountLog_entity_1=require(_0xdb032f(0x226)),utils_1=require(_0xdb032f(0x27e)),config_entity_1=require(_0xdb032f(0x20c)),cramiPackage_entity_1=require(_0xdb032f(0x259)),userBalance_entity_1=require(_0xdb032f(0x255)),date_1=require(_0xdb032f(0x269)),user_entity_1=require(_0xdb032f(0x243)),salesUsers_entity_1=require(_0xdb032f(0x271)),sales_service_1=require(_0xdb032f(0x230)),whiteList_entity_1=require(_0xdb032f(0x2a3)),fingerprint_entity_1=require(_0xdb032f(0x277)),chatLog_entity_1=require(_0xdb032f(0x247)),chatGroup_entity_1=require(_0xdb032f(0x216)),midjourney_entity_1=require(_0xdb032f(0x22f));function _0x43e3(_0xdfa82a,_0x26a3ef){const _0x25bdae=_0x25bd();return _0x43e3=function(_0x43e3e0,_0x5c56f8){_0x43e3e0=_0x43e3e0-0x1e2;let _0x1ae890=_0x25bdae[_0x43e3e0];return _0x1ae890;},_0x43e3(_0xdfa82a,_0x26a3ef);}let UserBalanceService=class UserBalanceService{constructor(_0x5588b3,_0x53dd2f,_0x23636e,_0x57c28f,_0x587d10,_0x4956f4,_0x3dfecc,_0x3873bd,_0x24237a,_0x1e12a4,_0xa7c133,_0x582339,_0x2e1bf9,_0x5aec74){const _0x168034=_0xdb032f;this[_0x168034(0x28b)]=_0x5588b3,this[_0x168034(0x1ed)]=_0x53dd2f,this[_0x168034(0x238)]=_0x23636e,this[_0x168034(0x266)]=_0x57c28f,this[_0x168034(0x291)]=_0x587d10,this[_0x168034(0x296)]=_0x4956f4,this[_0x168034(0x272)]=_0x3dfecc,this[_0x168034(0x20e)]=_0x3873bd,this[_0x168034(0x23a)]=_0x24237a,this['chatGroupEntity']=_0x1e12a4,this[_0x168034(0x211)]=_0xa7c133,this[_0x168034(0x26a)]=_0x582339,this[_0x168034(0x280)]=_0x2e1bf9,this[_0x168034(0x2a5)]=_0x5aec74;}async[_0xdb032f(0x202)](_0xb2f9c9,_0x3bdc51){const _0x1f6929=_0xdb032f;try{const _0x4448ab=await this[_0x1f6929(0x291)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x1f6929(0x1ee),_0x1f6929(0x1fd),_0x1f6929(0x290),_0x1f6929(0x1e7),_0x1f6929(0x29e),_0x1f6929(0x279),_0x1f6929(0x203),'firstRregisterSendModel4Count',_0x1f6929(0x201),_0x1f6929(0x253),_0x1f6929(0x274),_0x1f6929(0x2a1),_0x1f6929(0x1f1),_0x1f6929(0x236),_0x1f6929(0x20d),_0x1f6929(0x1e5)])}}),_0x1a493e=_0x4448ab[_0x1f6929(0x1f7)]((_0x16aba5,_0x3e17ef)=>{const _0x224d47=_0x1f6929,_0x2dbfb6=Number(_0x3e17ef['configVal']),_0x550ff0=Number[_0x224d47(0x292)](_0x2dbfb6)&&_0x2dbfb6>0x0?_0x2dbfb6:0x0;return _0x16aba5[_0x3e17ef[_0x224d47(0x252)]]=_0x550ff0,_0x16aba5;},{});let _0xf5ae89=0x0,_0x501a1b=0x0,_0x178e36=0x0;_0x1a493e[_0x1f6929(0x1ee)]===0x1&&(_0xf5ae89=_0xf5ae89+_0x1a493e['registerSendModel3Count'],_0x501a1b=_0x501a1b+_0x1a493e[_0x1f6929(0x290)],_0x178e36=_0x178e36+_0x1a493e['registerSendDrawMjCount']),_0x1a493e[_0x1f6929(0x1ee)]===0x1&&_0x1a493e[_0x1f6929(0x29e)]===0x1&&_0xb2f9c9<=_0x1a493e[_0x1f6929(0x279)]&&(_0xf5ae89=_0xf5ae89+_0x1a493e[_0x1f6929(0x203)],_0x501a1b=_0x501a1b+_0x1a493e[_0x1f6929(0x210)],_0x178e36=_0x178e36+_0x1a493e['firstRregisterSendDrawMjCount']),await this[_0x1f6929(0x27d)]({'userId':_0xb2f9c9,'rechargeType':balance_constant_1[_0x1f6929(0x25b)][_0x1f6929(0x231)],'model3Count':_0xf5ae89,'drawMjCount':_0x178e36,'model4Count':_0x501a1b}),_0x3bdc51&&(Number(_0x1a493e[_0x1f6929(0x253)])===0x1&&(_0xf5ae89=_0xf5ae89+Number(_0x1a493e[_0x1f6929(0x236)]),_0x501a1b=_0x501a1b+Number(_0x1a493e[_0x1f6929(0x1e5)]),_0x178e36=_0x178e36+Number(_0x1a493e['invitedGuestSendDrawMjCount']),await this[_0x1f6929(0x27d)]({'userId':_0xb2f9c9,'rechargeType':balance_constant_1[_0x1f6929(0x25b)][_0x1f6929(0x23b)],'model3Count':_0x1a493e[_0x1f6929(0x236)],'model4Count':_0x1a493e[_0x1f6929(0x1e5)],'drawMjCount':_0x1a493e[_0x1f6929(0x20d)]}),await this[_0x1f6929(0x27f)](_0x3bdc51,{'model3Count':_0x1a493e['inviteGiveSendModel3Count'],'model4Count':_0x1a493e[_0x1f6929(0x2a1)],'drawMjCount':_0x1a493e[_0x1f6929(0x1f1)]}),await this[_0x1f6929(0x27d)]({'userId':_0x3bdc51,'rechargeType':balance_constant_1['RechargeType'][_0x1f6929(0x298)],'model3Count':_0x1a493e[_0x1f6929(0x274)],'model4Count':_0x1a493e[_0x1f6929(0x2a1)],'drawMjCount':_0x1a493e[_0x1f6929(0x1f1)]}))),await this[_0x1f6929(0x1ed)][_0x1f6929(0x25c)]({'userId':_0xb2f9c9,'model3Count':_0xf5ae89,'model4Count':_0x501a1b,'drawMjCount':_0x178e36,'useTokens':0x0});}catch(_0x279277){console[_0x1f6929(0x283)]('error:\x20',_0x279277);throw new common_1['HttpException']('注册赠送失败,请联系管理员！',common_1[_0x1f6929(0x227)][_0x1f6929(0x1e4)]);}}async[_0xdb032f(0x23e)](_0x4df481,_0x5ca83b,_0x4bc4d4){const _0x5e3a0c=_0xdb032f,{id:_0x1446cb,role:_0x195538}=_0x4df481[_0x5e3a0c(0x26d)];let _0x21671d=await this[_0x5e3a0c(0x1ed)][_0x5e3a0c(0x234)]({'where':{'userId':_0x1446cb}});!_0x21671d&&(_0x21671d=await this[_0x5e3a0c(0x206)](_0x1446cb));if(_0x195538===_0x5e3a0c(0x22b))return this[_0x5e3a0c(0x294)](_0x4df481,_0x5ca83b,_0x4bc4d4);const _0x105002=await this[_0x5e3a0c(0x291)][_0x5e3a0c(0x234)]({'where':{'configKey':'vxNumber'}}),_0x128c28=_0x105002?_0x105002[_0x5e3a0c(0x262)]:_0x5e3a0c(0x212),_0x435634=_0x5ca83b==='model3'?_0x5e3a0c(0x21c):_0x5ca83b===_0x5e3a0c(0x263)?'memberModel4Count':_0x5ca83b===_0x5e3a0c(0x27c)?_0x5e3a0c(0x1e3):null,_0x4ac3d2=_0x5ca83b===_0x5e3a0c(0x21a)?_0x5e3a0c(0x29a):_0x5ca83b===_0x5e3a0c(0x263)?_0x5e3a0c(0x276):_0x5ca83b==='mjDraw'?_0x5e3a0c(0x1f5):null;if(_0x21671d[_0x5e3a0c(0x20b)]&&_0x21671d[_0x435634]<_0x4bc4d4){if(_0x21671d[_0x4ac3d2]<_0x4bc4d4)throw new common_1['HttpException'](_0x5e3a0c(0x297)+_0x128c28+_0x5e3a0c(0x1f8),common_1[_0x5e3a0c(0x227)][_0x5e3a0c(0x299)]);}if(!_0x21671d[_0x5e3a0c(0x20b)]&&_0x21671d[_0x4ac3d2]<_0x4bc4d4)throw new common_1[(_0x5e3a0c(0x278))]('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x128c28+'>\x20或购买专属套餐\x20！',common_1[_0x5e3a0c(0x227)][_0x5e3a0c(0x299)]);return _0x21671d;}async[_0xdb032f(0x294)](_0x502def,_0x9341b3,_0x274647){const _0xe7147e=_0xdb032f,{id:_0x138b91}=_0x502def['user'],_0x110c01=_0x9341b3===_0xe7147e(0x21a)?_0xe7147e(0x29a):_0x9341b3===_0xe7147e(0x263)?_0xe7147e(0x276):_0x9341b3===_0xe7147e(0x27c)?_0xe7147e(0x1f5):null,_0x348e32=new Date(),_0x4c194c=await this[_0xe7147e(0x23a)][_0xe7147e(0x234)]({'where':{'fingerprint':_0x138b91}}),{visitorModel3Num:_0x191552,visitorModel4Num:_0x167d98,visitorMJNum:_0x4c9578}=await this[_0xe7147e(0x2a5)][_0xe7147e(0x225)](['visitorModel3Num',_0xe7147e(0x1f9),'visitorMJNum']),_0x2b1cff={'model3Count':_0x191552?Number(_0x191552):0x0,'model4Count':_0x167d98?Number(_0x167d98):0x0,'drawMjCount':_0x4c9578?Number(_0x4c9578):0x0};if(!_0x4c194c){const _0x358706={'fingerprint':_0x138b91,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x358706[_0x110c01]=_0x358706[_0x110c01]+_0x274647;if(_0x358706[_0x110c01]>_0x2b1cff[_0x110c01])throw new common_1[(_0xe7147e(0x278))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1[_0xe7147e(0x227)][_0xe7147e(0x299)]);else return await this[_0xe7147e(0x23a)][_0xe7147e(0x25c)](_0x358706),!![];}else{const {model3Count:_0x1aa362,model4Count:_0x2a0a65,drawMjCount:_0x5c88e7}=_0x4c194c;let _0x118fcd={'model3Count':_0x1aa362,'model4Count':_0x2a0a65,'drawMjCount':_0x5c88e7};const _0x21bd06=Number(new Date(_0x4c194c[_0xe7147e(0x217)])),_0x37d953=this[_0xe7147e(0x207)](_0x21bd06);_0x37d953?_0x118fcd[_0x110c01]=_0x118fcd[_0x110c01]+_0x274647:(_0x118fcd={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x118fcd[_0x110c01]=_0x118fcd[_0x110c01]+_0x274647);if(_0x118fcd[_0x110c01]>_0x2b1cff[_0x110c01])throw new common_1[(_0xe7147e(0x278))](_0xe7147e(0x251),common_1[_0xe7147e(0x227)]['PAYMENT_REQUIRED']);else return await this[_0xe7147e(0x23a)][_0xe7147e(0x209)]({'fingerprint':_0x138b91},_0x118fcd),!![];}}[_0xdb032f(0x207)](_0x2403e6){const _0x4b73fe=_0xdb032f,_0x32476d=new Date(),_0x4ec7aa=new Date(_0x32476d['getFullYear'](),_0x32476d[_0x4b73fe(0x29c)](),_0x32476d['getDate']());return _0x2403e6>=_0x4ec7aa;}async['deductFromBalance'](_0xd89a45,_0xa854e4,_0x56035e,_0x45c6e9=0x0){const _0xaed72a=_0xdb032f,_0x5d6d14=await this[_0xaed72a(0x1ed)][_0xaed72a(0x234)]({'where':{'userId':_0xd89a45}});if(!_0x5d6d14)throw new common_1[(_0xaed72a(0x278))]('缺失当前用户账户记录！',common_1[_0xaed72a(0x227)][_0xaed72a(0x1e4)]);const _0x54fd78=_0xa854e4===_0xaed72a(0x21a)?_0xaed72a(0x21c):_0xa854e4===_0xaed72a(0x263)?_0xaed72a(0x204):_0xa854e4===_0xaed72a(0x27c)?_0xaed72a(0x1e3):null,_0x24251b=_0xa854e4===_0xaed72a(0x21a)?'model3Count':_0xa854e4===_0xaed72a(0x263)?_0xaed72a(0x276):_0xa854e4===_0xaed72a(0x27c)?'drawMjCount':null,_0x55aab3=_0x5d6d14[_0xaed72a(0x20b)]&&_0x5d6d14[_0x54fd78]<_0x56035e?_0x24251b:_0x5d6d14[_0xaed72a(0x20b)]?_0x54fd78:_0x24251b;let _0x4996b9=null;_0x55aab3['includes'](_0xaed72a(0x248))&&(_0x4996b9=_0xaed72a(0x1f0));_0x55aab3[_0xaed72a(0x26b)](_0xaed72a(0x24e))&&(_0x4996b9='useModel4Token');_0x55aab3[_0xaed72a(0x26b)](_0xaed72a(0x205))&&(_0x4996b9=_0xaed72a(0x233));const _0x283e39={[_0x55aab3]:_0x5d6d14[_0x55aab3]-_0x56035e<0x0?0x0:_0x5d6d14[_0x55aab3]-_0x56035e,[_0x4996b9]:_0x5d6d14[_0x4996b9]+_0x45c6e9};_0x4996b9===_0xaed72a(0x1f0)&&(_0x283e39['useModel3Count']=_0x5d6d14['useModel3Count']+_0x56035e),_0x4996b9===_0xaed72a(0x229)&&(_0x283e39['useModel4Count']=_0x5d6d14['useModel4Count']+_0x56035e);const _0x24e46d=await this[_0xaed72a(0x1ed)][_0xaed72a(0x209)]({'userId':_0xd89a45},_0x283e39);if(_0x24e46d[_0xaed72a(0x27a)]===0x0)throw new common_1[(_0xaed72a(0x278))](_0xaed72a(0x25d),common_1[_0xaed72a(0x227)][_0xaed72a(0x1e4)]);}async[_0xdb032f(0x29f)](_0x2204f9){const _0x394542=_0xdb032f;try{const _0x2a2521=await this[_0x394542(0x1ed)][_0x394542(0x234)]({'where':{'userId':_0x2204f9},'select':[_0x394542(0x20b),'model3Count',_0x394542(0x276),_0x394542(0x1f5),_0x394542(0x21c),_0x394542(0x204),_0x394542(0x1e3),_0x394542(0x275),'useModel4Count',_0x394542(0x1f0),_0x394542(0x229),_0x394542(0x233),_0x394542(0x273)]});if(!_0x2a2521){const _0x4b3349=await this['createBaseUserBalance'](_0x2204f9);if(_0x4b3349)return await this[_0x394542(0x29f)](_0x2204f9);else throw new common_1[(_0x394542(0x278))](_0x394542(0x23c),common_1[_0x394542(0x227)]['BAD_REQUEST']);}return _0x2a2521['sumModel3Count']=_0x2a2521[_0x394542(0x20b)]?_0x2a2521['model3Count']+_0x2a2521['memberModel3Count']:_0x2a2521[_0x394542(0x29a)],_0x2a2521[_0x394542(0x1f3)]=_0x2a2521[_0x394542(0x20b)]?_0x2a2521[_0x394542(0x276)]+_0x2a2521[_0x394542(0x204)]:_0x2a2521[_0x394542(0x276)],_0x2a2521['sumDrawMjCount']=_0x2a2521[_0x394542(0x20b)]?_0x2a2521[_0x394542(0x1f5)]+_0x2a2521[_0x394542(0x1e3)]:_0x2a2521['drawMjCount'],_0x2a2521[_0x394542(0x273)]=_0x2a2521['expirationTime']?(0x0,date_1['formatDate'])(_0x2a2521[_0x394542(0x273)],'YYYY-MM-DD'):null,_0x2a2521;}catch(_0x4888f7){console['log'](_0x394542(0x28e),_0x4888f7);}}async[_0xdb032f(0x27d)](_0x727697){const _0x5271ec=_0xdb032f,{userId:_0x3ee49b,rechargeType:_0x350952,model3Count:_0x9c330f,model4Count:_0x3525bd,drawMjCount:_0x2e6cf1,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x727697;if(!_0x3ee49b)throw new common_1[(_0x5271ec(0x278))]('当前用户不存在,记录充值日志异常',common_1[_0x5271ec(0x227)][_0x5271ec(0x1e4)]);const _0x47b08b=(0x0,utils_1[_0x5271ec(0x215)])();return await this[_0x5271ec(0x238)][_0x5271ec(0x25c)]({'userId':_0x3ee49b,'rechargeType':_0x350952,'model3Count':_0x9c330f,'model4Count':_0x3525bd,'drawMjCount':_0x2e6cf1,'days':days,'extent':extent,'uid':_0x47b08b,'pkgName':pkgName});}async['createBaseUserBalance'](_0x3c1e6e,_0x2764ab={}){const _0x4fa811=_0xdb032f,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2764ab,_0x4ad7cf=await this[_0x4fa811(0x1ed)][_0x4fa811(0x234)]({'where':{'userId':_0x3c1e6e}});if(_0x4ad7cf)throw new common_1['HttpException']('当前用户无需创建账户信息！',common_1['HttpStatus'][_0x4fa811(0x1e4)]);return await this['userBalanceEntity'][_0x4fa811(0x25c)]({'userId':_0x3c1e6e,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0xdb032f(0x27f)](_0x135fb1,_0x5d542c,_0x52df10=-0x1){const _0x42189b=_0xdb032f;try{const _0x4a9dd1=await this[_0x42189b(0x1ed)][_0x42189b(0x234)]({'where':{'userId':_0x135fb1}})||await this['createBaseUserBalance'](_0x135fb1);if(!_0x4a9dd1)throw new common_1['HttpException'](_0x42189b(0x1fe),common_1[_0x42189b(0x227)][_0x42189b(0x1e4)]);const {model3Count:_0x55b03e,model4Count:_0x305b08,drawMjCount:_0x54ce33,memberModel3Count:_0x35d471,memberModel4Count:_0x29fc4d,memberDrawMjCount:_0x63d311}=_0x4a9dd1;let _0x75c532={};if(_0x52df10>0x0){const {packageId:_0x1b7a04}=_0x5d542c;if(!_0x1b7a04)throw new common_1[(_0x42189b(0x278))](_0x42189b(0x26c),common_1[_0x42189b(0x227)][_0x42189b(0x1e4)]);const _0x59ec93=await this[_0x42189b(0x266)][_0x42189b(0x234)]({'where':{'id':_0x1b7a04}});if(!_0x59ec93)throw new common_1[(_0x42189b(0x278))](_0x42189b(0x1ef),common_1['HttpStatus']['BAD_REQUEST']);const {weight:_0x4cdd09}=_0x59ec93;if(!_0x4a9dd1[_0x42189b(0x20b)])_0x75c532={'memberModel3Count':_0x55b03e+_0x5d542c['model3Count'],'memberModel4Count':_0x305b08+_0x5d542c['model4Count'],'memberDrawMjCount':_0x54ce33+_0x5d542c[_0x42189b(0x1f5)],'expirationTime':(0x0,date_1[_0x42189b(0x2a8)])()[_0x42189b(0x1ea)](_0x52df10>0x0?_0x52df10:0x0,_0x42189b(0x200))[_0x42189b(0x1fb)](_0x42189b(0x2a0)),'packageId':_0x1b7a04};else{const _0x17cded=await this['cramiPackageEntity'][_0x42189b(0x234)]({'where':{'id':_0x4a9dd1[_0x42189b(0x20b)]}});_0x4cdd09>=_0x17cded[_0x42189b(0x270)]&&(_0x75c532={'memberModel3Count':_0x35d471+_0x5d542c[_0x42189b(0x29a)],'memberModel4Count':_0x29fc4d+_0x5d542c['model4Count'],'memberDrawMjCount':_0x63d311+_0x5d542c[_0x42189b(0x1f5)],'expirationTime':(0x0,date_1[_0x42189b(0x2a8)])(_0x4a9dd1[_0x42189b(0x273)])['add'](_0x52df10>0x0?_0x52df10:0x0,_0x42189b(0x200))[_0x42189b(0x1fb)](_0x42189b(0x2a0)),'packageId':_0x1b7a04}),_0x4cdd09<_0x17cded[_0x42189b(0x270)]&&(_0x75c532={'memberModel3Count':_0x35d471+_0x5d542c[_0x42189b(0x29a)],'memberModel4Count':_0x29fc4d+_0x5d542c[_0x42189b(0x276)],'memberDrawMjCount':_0x63d311+_0x5d542c[_0x42189b(0x1f5)]});}}_0x52df10<=0x0&&(_0x75c532={'model3Count':_0x55b03e+_0x5d542c[_0x42189b(0x29a)],'model4Count':_0x305b08+_0x5d542c[_0x42189b(0x276)],'drawMjCount':_0x54ce33+_0x5d542c['drawMjCount']});const _0x15857d=await this['userBalanceEntity']['update']({'userId':_0x135fb1},_0x75c532);if(_0x15857d[_0x42189b(0x27a)]===0x0)throw new common_1[(_0x42189b(0x278))](_0x135fb1+'充值失败',common_1[_0x42189b(0x227)]['BAD_REQUEST']);}catch(_0x1fba9e){console[_0x42189b(0x283)](_0x42189b(0x28e),_0x1fba9e);throw new common_1[(_0x42189b(0x278))](_0x42189b(0x28f),common_1[_0x42189b(0x227)][_0x42189b(0x1e4)]);}}async[_0xdb032f(0x24a)](_0xc95d8f){const _0x46c5e8=_0xdb032f;console[_0x46c5e8(0x283)](_0x46c5e8(0x220),_0xc95d8f);try{const {userId:_0x5bfd98,goodsId:_0x2004a2}=_0xc95d8f,_0x92701=await this[_0x46c5e8(0x266)][_0x46c5e8(0x234)]({'where':{'id':_0xc95d8f[_0x46c5e8(0x2a4)],'status':0x1}});if(!_0x92701)throw new common_1[(_0x46c5e8(0x278))](_0x46c5e8(0x1fc),common_1[_0x46c5e8(0x227)][_0x46c5e8(0x1e4)]);const {model3Count:_0x47cb5e,model4Count:_0x2fd338,drawMjCount:_0x17338f,days:_0x4c713f,name:_0x76f98b}=_0x92701,_0x325d99={'model3Count':_0x47cb5e,'model4Count':_0x2fd338,'drawMjCount':_0x17338f,'days':_0x4c713f,'packageId':_0xc95d8f[_0x46c5e8(0x2a4)]};await this['addBalanceToUser'](_0x5bfd98,_0x325d99,_0x4c713f),await this[_0x46c5e8(0x27d)]({'userId':_0x5bfd98,'rechargeType':balance_constant_1[_0x46c5e8(0x25b)]['SCAN_PAY'],'model3Count':_0x47cb5e,'model4Count':_0x2fd338,'drawMjCount':_0x17338f,'pkgName':_0x76f98b,'days':_0x4c713f});const _0xceaea7=await this[_0x46c5e8(0x296)][_0x46c5e8(0x234)]({'where':{'id':_0x5bfd98}}),{invitedBy:_0x2f398f}=_0xceaea7;if(_0x2f398f){const _0x59efe1=await this[_0x46c5e8(0x296)][_0x46c5e8(0x234)]({'where':{'inviteCode':_0x2f398f}}),_0x18e23b=await this['salesUsersEntity']['findOne']({'where':{'userId':_0x59efe1['id']}});if(!_0x59efe1)return;const {id:_0x3d637a}=_0x59efe1,{performanceRatio:_0x2f7566}=_0x18e23b,_0x1c5396={'inviterUserId':_0x3d637a,'inviteeUserId':_0x5bfd98,'orderId':_0xc95d8f['id'],'orderPrice':_0xc95d8f[_0x46c5e8(0x246)],'commissionPercentage':_0x2f7566,'commissionAmount':(_0xc95d8f[_0x46c5e8(0x246)]*_0x2f7566/0x64)['toFixed'](0x2)};await this[_0x46c5e8(0x280)][_0x46c5e8(0x228)](_0x1c5396),await this['salesService'][_0x46c5e8(0x21d)](_0x3d637a,_0x1c5396[_0x46c5e8(0x222)]);}}catch(_0xb2ab3f){console[_0x46c5e8(0x283)](_0x46c5e8(0x28e),_0xb2ab3f);throw new common_1['HttpException']('充值失败！',common_1['HttpStatus'][_0x46c5e8(0x1e4)]);}}async[_0xdb032f(0x27b)](_0x2e6bfe,_0x2689fe){const _0x3b4028=_0xdb032f,{page:page=0x1,size:size=0x14}=_0x2689fe,{id:_0x10b699}=_0x2e6bfe[_0x3b4028(0x26d)],[_0x3be78d,_0x34b858]=await this[_0x3b4028(0x238)][_0x3b4028(0x213)]({'where':{'userId':_0x10b699},'order':{'id':_0x3b4028(0x26e)},'skip':(page-0x1)*size,'take':size});return _0x3be78d[_0x3b4028(0x1e2)](_0x1928a1=>{const _0x26dac9=_0x3b4028;_0x1928a1[_0x26dac9(0x237)]=_0x1928a1[_0x26dac9(0x1e6)]>0x0?_0x1928a1[_0x26dac9(0x1e6)]+'天':'永久';}),{'rows':(0x0,date_1[_0x3b4028(0x239)])(_0x3be78d),'count':_0x34b858};}async['getAccountLog'](_0x17ad4d,_0x48015b){const _0x3fa381=_0xdb032f;try{const {page:page=0x1,size:size=0xa,userId:_0xd02faa,rechargeType:_0x1763c1,packageId:_0x618f71}=_0x48015b,{role:_0x566038}=_0x17ad4d[_0x3fa381(0x26d)],_0x34ad57={};_0x1763c1&&(_0x34ad57[_0x3fa381(0x29d)]=_0x1763c1),_0x34ad57[_0x3fa381(0x254)]=_0xd02faa||(0x0,typeorm_2[_0x3fa381(0x258)])(0x186a0),_0x618f71&&(_0x34ad57[_0x3fa381(0x20b)]={'$like':'%'+_0x618f71+'%'});const [_0x50b362,_0x76ca8f]=await this[_0x3fa381(0x238)][_0x3fa381(0x213)]({'where':_0x34ad57,'order':{'id':_0x3fa381(0x26e)},'skip':(page-0x1)*size,'take':size}),_0x596185=_0x50b362['map'](_0x4716bb=>_0x4716bb[_0x3fa381(0x254)]),_0x2c148f=await this[_0x3fa381(0x296)][_0x3fa381(0x224)]({'where':{'id':(0x0,typeorm_2['In'])(_0x596185)}});return _0x50b362[_0x3fa381(0x1e2)](_0x4fb415=>{const _0x268181=_0x3fa381,_0x1fc802=_0x2c148f[_0x268181(0x224)](_0x17fdf1=>_0x17fdf1['id']===_0x4fb415['userId']);_0x4fb415['username']=_0x1fc802===null||_0x1fc802===void 0x0?void 0x0:_0x1fc802[_0x268181(0x268)],_0x4fb415[_0x268181(0x1e8)]=_0x1fc802===null||_0x1fc802===void 0x0?void 0x0:_0x1fc802[_0x268181(0x1e8)],_0x4fb415[_0x268181(0x22a)]=_0x1fc802===null||_0x1fc802===void 0x0?void 0x0:_0x1fc802[_0x268181(0x22a)],_0x4fb415['status']=_0x1fc802===null||_0x1fc802===void 0x0?void 0x0:_0x1fc802[_0x268181(0x1ff)],_0x4fb415['avatar']=_0x1fc802===null||_0x1fc802===void 0x0?void 0x0:_0x1fc802[_0x268181(0x256)];}),_0x566038!=='super'&&_0x50b362[_0x3fa381(0x1e2)](_0xa7a68d=>{const _0x56b607=_0x3fa381;_0xa7a68d['email']=_0xa7a68d[_0x56b607(0x1e8)]?(0x0,utils_1[_0x56b607(0x2a2)])(_0xa7a68d[_0x56b607(0x1e8)]):'',_0xa7a68d[_0x56b607(0x22a)]=_0xa7a68d[_0x56b607(0x22a)]?(0x0,utils_1[_0x56b607(0x2a2)])(_0xa7a68d[_0x56b607(0x22a)]):'';}),{'rows':_0x50b362,'count':_0x76ca8f};}catch(_0x15fc46){console[_0x3fa381(0x283)]('error:\x20',_0x15fc46);throw new common_1['HttpException']('查询用户账户失败！',common_1['HttpStatus'][_0x3fa381(0x1e4)]);}}async[_0xdb032f(0x242)](_0x1e95d9){const _0x9fb0a1=_0xdb032f;return await this[_0x9fb0a1(0x1ed)]['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x1e95d9)}});}async[_0xdb032f(0x24f)](_0xcf6903,_0x148967){const _0x475102=_0xdb032f;return await this['deductFromBalance'](_0xcf6903,_0x475102(0x27c),-_0x148967);}async[_0xdb032f(0x1f2)](){const _0x3a2b6f=_0xdb032f,_0x24aa8c=await this[_0x3a2b6f(0x296)][_0x3a2b6f(0x224)]();if(!_0x24aa8c[_0x3a2b6f(0x241)])return;const _0x25c40e=await this[_0x3a2b6f(0x2a5)][_0x3a2b6f(0x225)](['upgradeStatus']);if(!_0x25c40e)await this[_0x3a2b6f(0x2a5)][_0x3a2b6f(0x244)]({'settings':[{'configKey':_0x3a2b6f(0x214),'configVal':'1'}]});else throw new common_1[(_0x3a2b6f(0x278))](_0x3a2b6f(0x28c),common_1[_0x3a2b6f(0x227)][_0x3a2b6f(0x1e4)]);_0x24aa8c[_0x3a2b6f(0x1e2)](_0x15cfd5=>{const _0x143aa0=_0x3a2b6f,{id:_0x217498}=_0x15cfd5;this[_0x143aa0(0x28b)][_0x143aa0(0x234)]({'where':{'userId':_0x217498}})[_0x143aa0(0x24d)](_0x39ef28=>{if(!_0x39ef28)return;this['writeOldBalanceToNewTable'](_0x217498,_0x39ef28);});});}async[_0xdb032f(0x235)](_0x472db8,_0x448e74){const _0x1c0718=_0xdb032f,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x448e74,_0x252b64=await this[_0x1c0718(0x20e)][_0x1c0718(0x234)]({'where':{'userId':_0x472db8}}),_0xb0182d={'userId':_0x472db8,'model3Count':Number(usesLeft),'model4Count':(_0x252b64===null||_0x252b64===void 0x0?void 0x0:_0x252b64[_0x1c0718(0x23d)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x252b64===null||_0x252b64===void 0x0?void 0x0:_0x252b64[_0x1c0718(0x20a)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x3f29a5=await this[_0x1c0718(0x1ed)][_0x1c0718(0x234)]({'where':{'userId':_0x472db8}});_0x3f29a5?common_1['Logger'][_0x1c0718(0x219)]('用户'+_0x472db8+_0x1c0718(0x21b),_0x1c0718(0x232)):this[_0x1c0718(0x1ed)][_0x1c0718(0x25c)](_0xb0182d)[_0x1c0718(0x24d)](_0x4b2ade=>{const _0x50268f=_0x1c0718;common_1['Logger'][_0x50268f(0x219)]('用户'+_0x472db8+_0x50268f(0x295),'BalanceService');})[_0x1c0718(0x2a6)](_0x25244e=>{const _0x2cde25=_0x1c0718;console['log']('error:\x20',_0x25244e),common_1[_0x2cde25(0x26f)][_0x2cde25(0x219)]('用户'+_0x472db8+_0x2cde25(0x285),_0x2cde25(0x232));});}async['inheritVisitorData'](_0x4ba5e7){const _0x5c40a5=_0xdb032f,{fingerprint:_0x94ec3f}=_0x4ba5e7[_0x5c40a5(0x28a)],{id:_0x4b8645}=_0x4ba5e7[_0x5c40a5(0x26d)];return await this['chatLogEntity'][_0x5c40a5(0x209)]({'userId':Number(_0x94ec3f)},{'userId':_0x4b8645}),await this[_0x5c40a5(0x257)][_0x5c40a5(0x209)]({'userId':Number(_0x94ec3f)},{'userId':_0x4b8645}),await this[_0x5c40a5(0x26a)][_0x5c40a5(0x209)]({'userId':Number(_0x94ec3f)},{'userId':_0x4b8645}),0x1;}async[_0xdb032f(0x21e)](_0x24ad5d){const _0x3975c3=_0xdb032f,{fingerprint:_0x2b347}=_0x24ad5d[_0x3975c3(0x28a)],_0x2d52ce=await this[_0x3975c3(0x211)][_0x3975c3(0x23d)]({'where':{'userId':_0x2b347}}),_0x58d983=await this[_0x3975c3(0x257)][_0x3975c3(0x23d)]({'where':{'userId':_0x2b347}}),_0x130db8=await this[_0x3975c3(0x26a)][_0x3975c3(0x23d)]({'where':{'userId':_0x2b347}});return _0x2d52ce||_0x58d983||_0x130db8||0x0;}};function _0x25bd(){const _0x4d70ca=['10SqERFU','旧账户信息迁移失败','@nestjs/typeorm','MidjourneyEntity','ChatLogEntity','metadata','headers','balanceEntity','您已经升级过了、请勿重复操作！','__param','error:\x20','用户充值失败！','registerSendModel4Count','configEntity','isInteger','ConfigEntity','validateVisitorBalance','旧账户信息迁移成功','userEntity','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','REFER_GIFT','PAYMENT_REQUIRED','model3Count','975506JNNIVg','getMonth','rechargeType','firstRegisterSendStatus','queryUserBalance','YYYY-MM-DD\x20HH:mm:ss','inviteGiveSendModel4Count','hideString','../chatgpt/whiteList.entity','goodsId','globalConfigService','catch','WhiteListEntity','default','forEach','memberDrawMjCount','BAD_REQUEST','invitedGuestSendModel4Count','days','registerSendDrawMjCount','email','UserEntity','add','InjectRepository','Injectable','userBalanceEntity','registerSendStatus','当前套餐不存在！','useModel3Token','inviteGiveSendDrawMjCount','upgradeBalance','sumModel4Count','object','drawMjCount','418206qiMvUH','reduce','>\x20或购买专属套餐\x20！','visitorModel4Num','function','format','非法操作、当前充值套餐暂不存在！','registerSendModel3Count','查询用户账户信息失败！','status','day','firstRregisterSendDrawMjCount','addBalanceToNewUser','firstRregisterSendModel3Count','memberModel4Count','MjCount','createBaseUserBalance','isUpdatedToday','../../common/constants/balance.constant','update','useCount','packageId','../globalConfig/config.entity','invitedGuestSendDrawMjCount','whiteListEntity','__decorate','firstRregisterSendModel4Count','chatLogEntity','---','findAndCount','upgradeStatus','createRandomUid','../chatGroup/chatGroup.entity','updatedAt','177252QshPZI','debug','model3','账户信息已经存在、迁移无效','memberModel3Count','saveCommissionAmount','getVisitorCount','decorate','充值的工单信息:','BalanceEntity','commissionAmount','48NmQRhz','find','getConfigs','./accountLog.entity','HttpStatus','createSalesRecords','useModel4Token','phone','visitor','UserBalanceService','typeorm','9wbXzsE','../midjourney/midjourney.entity','../sales/sales.service','REG_GIFT','BalanceService','useDrawMjToken','findOne','writeOldBalanceToNewTable','invitedGuestSendModel3Count','expireDateCn','accountLogEntity','formatCreateOrUpdateDate','fingerprintLogEntity','INVITE_GIFT','查询当前用户余额失败！','count','validateBalance','defineProperty','GlobalConfigService','length','queryUserBalanceByIds','../user/user.entity','setConfig','930724FquIEb','total','../chatLog/chatLog.entity','odel3','../globalConfig/globalConfig.service','addBalanceToOrder','124mudeVs','ChatGroupEntity','then','odel4','refundMjBalance','AccountLogEntity','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','configKey','inviteSendStatus','userId','./userBalance.entity','avatar','chatGroupEntity','LessThan','../crami/cramiPackage.entity','11411nehHlJ','RechargeType','save','消费余额失败！','UserBalanceEntity','682UlMVQz','FingerprintLogEntity','Repository','configVal','model4','@nestjs/common','10357608pEDNJO','cramiPackageEntity','10938020DETtHJ','username','../../common/utils/date','midjourneyEntity','includes','缺失当前套餐ID、充值失败！','user','DESC','Logger','weight','../sales/salesUsers.entity','salesUsersEntity','expirationTime','inviteGiveSendModel3Count','useModel3Count','model4Count','./fingerprint.entity','HttpException','firstRegisterSendRank','affected','getRechargeLog','mjDraw','saveRecordRechargeLog','../../common/utils','addBalanceToUser','salesService','getOwnPropertyDescriptor','__esModule','log'];_0x25bd=function(){return _0x4d70ca;};return _0x25bd();}UserBalanceService=__decorate([(0x0,common_1[_0xdb032f(0x1ec)])(),__param(0x0,(0x0,typeorm_1[_0xdb032f(0x1eb)])(balance_entity_1[_0xdb032f(0x221)])),__param(0x1,(0x0,typeorm_1[_0xdb032f(0x1eb)])(userBalance_entity_1[_0xdb032f(0x25e)])),__param(0x2,(0x0,typeorm_1[_0xdb032f(0x1eb)])(accountLog_entity_1[_0xdb032f(0x250)])),__param(0x3,(0x0,typeorm_1[_0xdb032f(0x1eb)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0xdb032f(0x293)])),__param(0x5,(0x0,typeorm_1[_0xdb032f(0x1eb)])(user_entity_1[_0xdb032f(0x1e9)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x7,(0x0,typeorm_1[_0xdb032f(0x1eb)])(whiteList_entity_1[_0xdb032f(0x2a7)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0xdb032f(0x260)])),__param(0x9,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0xdb032f(0x24c)])),__param(0xa,(0x0,typeorm_1[_0xdb032f(0x1eb)])(chatLog_entity_1[_0xdb032f(0x288)])),__param(0xb,(0x0,typeorm_1[_0xdb032f(0x1eb)])(midjourney_entity_1[_0xdb032f(0x287)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0xdb032f(0x261)],typeorm_2[_0xdb032f(0x261)],typeorm_2[_0xdb032f(0x261)],typeorm_2[_0xdb032f(0x261)],typeorm_2[_0xdb032f(0x261)],typeorm_2['Repository'],typeorm_2[_0xdb032f(0x261)],typeorm_2['Repository'],typeorm_2[_0xdb032f(0x261)],typeorm_2[_0xdb032f(0x261)],typeorm_2[_0xdb032f(0x261)],sales_service_1['SalesService'],globalConfig_service_1[_0xdb032f(0x240)]])],UserBalanceService),exports[_0xdb032f(0x22c)]=UserBalanceService;