'use strict';const _0x16b0d0=_0x36e0;function _0x4607(){const _0x2b7dee=['whiteListEntity','then','sumDrawMjCount','registerSendModel4Count','查询用户账户失败！','weight','memberModel4Count','cramiPackageEntity','update','status','注册赠送失败,请联系管理员！','firstRregisterSendDrawMjCount','registerSendStatus','非法操作、当前充值套餐暂不存在！','useModel3Count','packageId','defineProperty','updatedAt','upgradeStatus','chatLogEntity','HttpStatus','useModel3Token','../midjourney/midjourney.entity','账户信息已经存在、迁移无效','useModel4Token','---','旧账户信息迁移失败','forEach','affected','BAD_REQUEST','deductFromBalance','email','add','configKey','Repository','formatCreateOrUpdateDate','object','writeOldBalanceToNewTable','../crami/cramiPackage.entity','model3','globalConfigService','model3Count','queryUserBalance','BalanceEntity','findOne','REG_GIFT','addBalanceToUser','getVisitorCount','format','visitorMJNum','vxNumber','length','catch','INVITE_GIFT','drawMjCount','error:\x20','useDrawMjToken','fingerprintLogEntity','inviteGiveSendModel3Count','../sales/salesUsers.entity','AccountLogEntity','design:paramtypes','充值失败','sumModel3Count','upgradeBalance','total','expirationTime','addBalanceToNewUser','BalanceService','旧账户信息迁移成功','createSalesRecords','../../common/constants/balance.constant','registerSendModel3Count','visitorModel4Num','__decorate','typeorm','MjCount','isInteger','getRechargeLog','phone','inviteGiveSendDrawMjCount','../chatGroup/chatGroup.entity','Injectable','>\x20或购买专属套餐\x20！','当前用户无需创建账户信息！','3108231iniocu','midjourneyEntity','PAYMENT_REQUIRED','getFullYear','UserEntity','UserBalanceEntity','__param','find','salesUsersEntity','35944opQdxc','hideString','username','4GGsACU','9153846VqoOAh','HttpException','expireDateCn','decorate','./fingerprint.entity','MidjourneyEntity','salesService','sumModel4Count','avatar','CramiPackageEntity','__esModule','inviteSendStatus','缺失当前套餐ID、充值失败！','YYYY-MM-DD\x20HH:mm:ss','invitedGuestSendModel4Count','UserBalanceService','__metadata','visitorModel3Num','FingerprintLogEntity','days','444nBvLzz','includes','InjectRepository','userBalanceEntity','充值的工单信息:','accountLogEntity','map','getAccountLog','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','visitor','../sales/sales.service','../globalConfig/config.entity','../chatLog/chatLog.entity','memberModel3Count','log','chatGroupEntity','mjDraw','firstRregisterSendModel3Count','metadata','firstRregisterSendModel4Count','7207776gAmKbw','configEntity','您已经升级过了、请勿重复操作！','../chatgpt/whiteList.entity','RechargeType','156219oclQCD','查询用户账户信息失败！','function','15901140WoyvqC','memberDrawMjCount','../user/user.entity','../../common/utils/date','balanceEntity','save','getMonth','user','Logger','createBaseUserBalance','saveRecordRechargeLog','缺失当前用户账户记录！','./balance.entity','ConfigEntity','isUpdatedToday','10Zkeyvv','当前用户不存在,记录充值日志异常','YYYY-MM-DD','inheritVisitorData','firstRegisterSendStatus','invitedGuestSendDrawMjCount','useModel4Count','WhiteListEntity','addBalanceToOrder','ChatGroupEntity','validateVisitorBalance','invitedGuestSendModel3Count','formatDate','SalesService','count','configVal','userEntity','findAndCount','当前套餐不存在！','DESC','SalesUsersEntity','model4Count','headers','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','day','userId','rechargeType','./userBalance.entity','充值失败！','@nestjs/typeorm','3554188xdaDTF','model4','inviteGiveSendModel4Count'];_0x4607=function(){return _0x2b7dee;};return _0x4607();}(function(_0x57ab65,_0x25231a){const _0x16e9a7=_0x36e0,_0x2dd58a=_0x57ab65();while(!![]){try{const _0x3f510f=-parseInt(_0x16e9a7(0x125))/0x1*(-parseInt(_0x16e9a7(0x128))/0x2)+-parseInt(_0x16e9a7(0x1de))/0x3+parseInt(_0x16e9a7(0x186))/0x4*(parseInt(_0x16e9a7(0x168))/0x5)+-parseInt(_0x16e9a7(0x13d))/0x6*(-parseInt(_0x16e9a7(0x156))/0x7)+-parseInt(_0x16e9a7(0x151))/0x8+parseInt(_0x16e9a7(0x129))/0x9+-parseInt(_0x16e9a7(0x159))/0xa;if(_0x3f510f===_0x25231a)break;else _0x2dd58a['push'](_0x2dd58a['shift']());}catch(_0x35c4b4){_0x2dd58a['push'](_0x2dd58a['shift']());}}}(_0x4607,0xf1ca3));function _0x36e0(_0x2597c4,_0x52266c){const _0x460784=_0x4607();return _0x36e0=function(_0x36e0c2,_0x46a228){_0x36e0c2=_0x36e0c2-0x124;let _0x134f75=_0x460784[_0x36e0c2];return _0x134f75;},_0x36e0(_0x2597c4,_0x52266c);}var __decorate=this&&this[_0x16b0d0(0x1d3)]||function(_0x51a4d7,_0x33311f,_0x493c2a,_0x3074bd){const _0x4a6f72=_0x16b0d0;var _0x3c376d=arguments['length'],_0x431aba=_0x3c376d<0x3?_0x33311f:_0x3074bd===null?_0x3074bd=Object['getOwnPropertyDescriptor'](_0x33311f,_0x493c2a):_0x3074bd,_0x83729a;if(typeof Reflect===_0x4a6f72(0x1ad)&&typeof Reflect[_0x4a6f72(0x12c)]==='function')_0x431aba=Reflect[_0x4a6f72(0x12c)](_0x51a4d7,_0x33311f,_0x493c2a,_0x3074bd);else{for(var _0x3c3eab=_0x51a4d7[_0x4a6f72(0x1bc)]-0x1;_0x3c3eab>=0x0;_0x3c3eab--)if(_0x83729a=_0x51a4d7[_0x3c3eab])_0x431aba=(_0x3c376d<0x3?_0x83729a(_0x431aba):_0x3c376d>0x3?_0x83729a(_0x33311f,_0x493c2a,_0x431aba):_0x83729a(_0x33311f,_0x493c2a))||_0x431aba;}return _0x3c376d>0x3&&_0x431aba&&Object[_0x4a6f72(0x199)](_0x33311f,_0x493c2a,_0x431aba),_0x431aba;},__metadata=this&&this[_0x16b0d0(0x139)]||function(_0x4f581f,_0x2c244d){const _0x16e3f9=_0x16b0d0;if(typeof Reflect===_0x16e3f9(0x1ad)&&typeof Reflect['metadata']===_0x16e3f9(0x158))return Reflect[_0x16e3f9(0x14f)](_0x4f581f,_0x2c244d);},__param=this&&this[_0x16b0d0(0x1e4)]||function(_0x1cd3dd,_0x32505c){return function(_0x5edfd9,_0x35a54b){_0x32505c(_0x5edfd9,_0x35a54b,_0x1cd3dd);};};Object['defineProperty'](exports,_0x16b0d0(0x133),{'value':!![]}),exports[_0x16b0d0(0x138)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),typeorm_1=require(_0x16b0d0(0x185)),balance_entity_1=require(_0x16b0d0(0x165)),common_1=require('@nestjs/common'),typeorm_2=require(_0x16b0d0(0x1d4)),balance_constant_1=require(_0x16b0d0(0x1d0)),accountLog_entity_1=require('./accountLog.entity'),utils_1=require('../../common/utils'),config_entity_1=require(_0x16b0d0(0x148)),cramiPackage_entity_1=require(_0x16b0d0(0x1af)),userBalance_entity_1=require(_0x16b0d0(0x183)),date_1=require(_0x16b0d0(0x15c)),user_entity_1=require(_0x16b0d0(0x15b)),salesUsers_entity_1=require(_0x16b0d0(0x1c4)),sales_service_1=require(_0x16b0d0(0x147)),whiteList_entity_1=require(_0x16b0d0(0x154)),fingerprint_entity_1=require(_0x16b0d0(0x12d)),chatLog_entity_1=require(_0x16b0d0(0x149)),chatGroup_entity_1=require(_0x16b0d0(0x1da)),midjourney_entity_1=require(_0x16b0d0(0x19f));let UserBalanceService=class UserBalanceService{constructor(_0x4b70f6,_0x5f2611,_0x353b7c,_0x25f348,_0x4da074,_0x1f44e4,_0x58c3d0,_0x531121,_0x4ab494,_0x276877,_0x2deaf1,_0x5d4ca4,_0x43f443,_0x226118){const _0x48a29a=_0x16b0d0;this[_0x48a29a(0x15d)]=_0x4b70f6,this[_0x48a29a(0x140)]=_0x5f2611,this['accountLogEntity']=_0x353b7c,this[_0x48a29a(0x190)]=_0x25f348,this['configEntity']=_0x4da074,this[_0x48a29a(0x178)]=_0x1f44e4,this[_0x48a29a(0x124)]=_0x58c3d0,this[_0x48a29a(0x189)]=_0x531121,this['fingerprintLogEntity']=_0x4ab494,this[_0x48a29a(0x14c)]=_0x276877,this[_0x48a29a(0x19c)]=_0x2deaf1,this[_0x48a29a(0x1df)]=_0x5d4ca4,this[_0x48a29a(0x12f)]=_0x43f443,this[_0x48a29a(0x1b1)]=_0x226118;}async[_0x16b0d0(0x1cc)](_0x56e545,_0x2e38a7){const _0x41f120=_0x16b0d0;try{const _0x4c8926=await this[_0x41f120(0x152)][_0x41f120(0x1e5)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x41f120(0x195),_0x41f120(0x1d1),_0x41f120(0x18c),'registerSendDrawMjCount',_0x41f120(0x16c),'firstRegisterSendRank',_0x41f120(0x14e),_0x41f120(0x150),_0x41f120(0x194),'inviteSendStatus','inviteGiveSendModel3Count',_0x41f120(0x188),_0x41f120(0x1d9),_0x41f120(0x173),_0x41f120(0x16d),_0x41f120(0x137)])}}),_0x194e62=_0x4c8926['reduce']((_0x52e4c3,_0x4f87e0)=>{const _0x296a7f=_0x41f120,_0x20ddb5=Number(_0x4f87e0[_0x296a7f(0x177)]),_0x32c133=Number[_0x296a7f(0x1d6)](_0x20ddb5)&&_0x20ddb5>0x0?_0x20ddb5:0x0;return _0x52e4c3[_0x4f87e0[_0x296a7f(0x1aa)]]=_0x32c133,_0x52e4c3;},{});let _0x4e6f0f=0x0,_0x6447a0=0x0,_0xb2a8c5=0x0;_0x194e62[_0x41f120(0x195)]===0x1&&(_0x4e6f0f=_0x4e6f0f+_0x194e62[_0x41f120(0x1d1)],_0x6447a0=_0x6447a0+_0x194e62[_0x41f120(0x18c)],_0xb2a8c5=_0xb2a8c5+_0x194e62['registerSendDrawMjCount']),_0x194e62['registerSendStatus']===0x1&&_0x194e62['firstRegisterSendStatus']===0x1&&_0x56e545<=_0x194e62['firstRegisterSendRank']&&(_0x4e6f0f=_0x4e6f0f+_0x194e62[_0x41f120(0x14e)],_0x6447a0=_0x6447a0+_0x194e62[_0x41f120(0x150)],_0xb2a8c5=_0xb2a8c5+_0x194e62['firstRregisterSendDrawMjCount']),await this[_0x41f120(0x163)]({'userId':_0x56e545,'rechargeType':balance_constant_1['RechargeType'][_0x41f120(0x1b6)],'model3Count':_0x4e6f0f,'drawMjCount':_0xb2a8c5,'model4Count':_0x6447a0}),_0x2e38a7&&(Number(_0x194e62[_0x41f120(0x134)])===0x1&&(_0x4e6f0f=_0x4e6f0f+Number(_0x194e62[_0x41f120(0x173)]),_0x6447a0=_0x6447a0+Number(_0x194e62['invitedGuestSendModel4Count']),_0xb2a8c5=_0xb2a8c5+Number(_0x194e62[_0x41f120(0x16d)]),await this[_0x41f120(0x163)]({'userId':_0x56e545,'rechargeType':balance_constant_1['RechargeType'][_0x41f120(0x1be)],'model3Count':_0x194e62[_0x41f120(0x173)],'model4Count':_0x194e62['invitedGuestSendModel4Count'],'drawMjCount':_0x194e62[_0x41f120(0x16d)]}),await this[_0x41f120(0x1b7)](_0x2e38a7,{'model3Count':_0x194e62[_0x41f120(0x1c3)],'model4Count':_0x194e62[_0x41f120(0x188)],'drawMjCount':_0x194e62[_0x41f120(0x1d9)]}),await this[_0x41f120(0x163)]({'userId':_0x2e38a7,'rechargeType':balance_constant_1[_0x41f120(0x155)]['REFER_GIFT'],'model3Count':_0x194e62[_0x41f120(0x1c3)],'model4Count':_0x194e62[_0x41f120(0x188)],'drawMjCount':_0x194e62['inviteGiveSendDrawMjCount']}))),await this['userBalanceEntity']['save']({'userId':_0x56e545,'model3Count':_0x4e6f0f,'model4Count':_0x6447a0,'drawMjCount':_0xb2a8c5,'useTokens':0x0});}catch(_0x15a729){console[_0x41f120(0x14b)](_0x41f120(0x1c0),_0x15a729);throw new common_1[(_0x41f120(0x12a))](_0x41f120(0x193),common_1['HttpStatus'][_0x41f120(0x1a6)]);}}async['validateBalance'](_0x4521ed,_0x28877e,_0x256a99){const _0x16301c=_0x16b0d0,{id:_0x5233af,role:_0x22a5de}=_0x4521ed['user'];let _0x6b2c0f=await this[_0x16301c(0x140)][_0x16301c(0x1b5)]({'where':{'userId':_0x5233af}});!_0x6b2c0f&&(_0x6b2c0f=await this[_0x16301c(0x162)](_0x5233af));if(_0x22a5de===_0x16301c(0x146))return this[_0x16301c(0x172)](_0x4521ed,_0x28877e,_0x256a99);const _0x275517=await this[_0x16301c(0x152)][_0x16301c(0x1b5)]({'where':{'configKey':_0x16301c(0x1bb)}}),_0x3c1132=_0x275517?_0x275517[_0x16301c(0x177)]:_0x16301c(0x1a2),_0x2a3ba9=_0x28877e===_0x16301c(0x1b0)?_0x16301c(0x14a):_0x28877e===_0x16301c(0x187)?_0x16301c(0x18f):_0x28877e===_0x16301c(0x14d)?_0x16301c(0x15a):null,_0x23a69c=_0x28877e==='model3'?_0x16301c(0x1b2):_0x28877e===_0x16301c(0x187)?_0x16301c(0x17d):_0x28877e===_0x16301c(0x14d)?_0x16301c(0x1bf):null;if(_0x6b2c0f[_0x16301c(0x198)]&&_0x6b2c0f[_0x2a3ba9]<_0x256a99){if(_0x6b2c0f[_0x23a69c]<_0x256a99)throw new common_1[(_0x16301c(0x12a))](_0x16301c(0x145)+_0x3c1132+_0x16301c(0x1dc),common_1[_0x16301c(0x19d)][_0x16301c(0x1e0)]);}if(!_0x6b2c0f['packageId']&&_0x6b2c0f[_0x23a69c]<_0x256a99)throw new common_1[(_0x16301c(0x12a))](_0x16301c(0x145)+_0x3c1132+_0x16301c(0x1dc),common_1['HttpStatus'][_0x16301c(0x1e0)]);return _0x6b2c0f;}async[_0x16b0d0(0x172)](_0x12c8f5,_0x2a0705,_0x2c2a57){const _0x53772e=_0x16b0d0,{id:_0x299ff0}=_0x12c8f5['user'],_0x572745=_0x2a0705===_0x53772e(0x1b0)?'model3Count':_0x2a0705===_0x53772e(0x187)?_0x53772e(0x17d):_0x2a0705===_0x53772e(0x14d)?'drawMjCount':null,_0x1ef7c2=new Date(),_0x139b5a=await this[_0x53772e(0x1c2)][_0x53772e(0x1b5)]({'where':{'fingerprint':_0x299ff0}}),{visitorModel3Num:_0x1b7290,visitorModel4Num:_0x47833c,visitorMJNum:_0x19ece4}=await this['globalConfigService']['getConfigs']([_0x53772e(0x13a),_0x53772e(0x1d2),_0x53772e(0x1ba)]),_0x54edef={'model3Count':_0x1b7290?Number(_0x1b7290):0x0,'model4Count':_0x47833c?Number(_0x47833c):0x0,'drawMjCount':_0x19ece4?Number(_0x19ece4):0x0};if(!_0x139b5a){const _0x274719={'fingerprint':_0x299ff0,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x274719[_0x572745]=_0x274719[_0x572745]+_0x2c2a57;if(_0x274719[_0x572745]>_0x54edef[_0x572745])throw new common_1['HttpException'](_0x53772e(0x17f),common_1[_0x53772e(0x19d)][_0x53772e(0x1e0)]);else return await this[_0x53772e(0x1c2)][_0x53772e(0x15e)](_0x274719),!![];}else{const {model3Count:_0xe0bff3,model4Count:_0x56d52,drawMjCount:_0x18b543}=_0x139b5a;let _0x1ecbec={'model3Count':_0xe0bff3,'model4Count':_0x56d52,'drawMjCount':_0x18b543};const _0x5a949a=Number(new Date(_0x139b5a[_0x53772e(0x19a)])),_0x52751b=this['isUpdatedToday'](_0x5a949a);_0x52751b?_0x1ecbec[_0x572745]=_0x1ecbec[_0x572745]+_0x2c2a57:(_0x1ecbec={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x1ecbec[_0x572745]=_0x1ecbec[_0x572745]+_0x2c2a57);if(_0x1ecbec[_0x572745]>_0x54edef[_0x572745])throw new common_1['HttpException'](_0x53772e(0x17f),common_1[_0x53772e(0x19d)][_0x53772e(0x1e0)]);else return await this[_0x53772e(0x1c2)][_0x53772e(0x191)]({'fingerprint':_0x299ff0},_0x1ecbec),!![];}}[_0x16b0d0(0x167)](_0x15dce2){const _0x458ba1=_0x16b0d0,_0x36730c=new Date(),_0x2fba91=new Date(_0x36730c[_0x458ba1(0x1e1)](),_0x36730c[_0x458ba1(0x15f)](),_0x36730c['getDate']());return _0x15dce2>=_0x2fba91;}async[_0x16b0d0(0x1a7)](_0x21dbea,_0x587ee1,_0x25ca6a,_0x42140d=0x0){const _0x2b99dc=_0x16b0d0,_0x160d10=await this[_0x2b99dc(0x140)][_0x2b99dc(0x1b5)]({'where':{'userId':_0x21dbea}});if(!_0x160d10)throw new common_1[(_0x2b99dc(0x12a))](_0x2b99dc(0x164),common_1[_0x2b99dc(0x19d)]['BAD_REQUEST']);const _0xc1fc45=_0x587ee1===_0x2b99dc(0x1b0)?_0x2b99dc(0x14a):_0x587ee1===_0x2b99dc(0x187)?'memberModel4Count':_0x587ee1===_0x2b99dc(0x14d)?_0x2b99dc(0x15a):null,_0x2f7864=_0x587ee1===_0x2b99dc(0x1b0)?_0x2b99dc(0x1b2):_0x587ee1==='model4'?_0x2b99dc(0x17d):_0x587ee1===_0x2b99dc(0x14d)?_0x2b99dc(0x1bf):null,_0x3a872f=_0x160d10[_0x2b99dc(0x198)]&&_0x160d10[_0xc1fc45]<_0x25ca6a?_0x2f7864:_0x160d10['packageId']?_0xc1fc45:_0x2f7864;let _0x2bd23b=null;_0x3a872f[_0x2b99dc(0x13e)]('odel3')&&(_0x2bd23b=_0x2b99dc(0x19e));_0x3a872f['includes']('odel4')&&(_0x2bd23b=_0x2b99dc(0x1a1));_0x3a872f[_0x2b99dc(0x13e)](_0x2b99dc(0x1d5))&&(_0x2bd23b=_0x2b99dc(0x1c1));const _0x391bbf={[_0x3a872f]:_0x160d10[_0x3a872f]-_0x25ca6a<0x0?0x0:_0x160d10[_0x3a872f]-_0x25ca6a,[_0x2bd23b]:_0x160d10[_0x2bd23b]+_0x42140d};_0x2bd23b===_0x2b99dc(0x19e)&&(_0x391bbf['useModel3Count']=_0x160d10['useModel3Count']+_0x25ca6a),_0x2bd23b==='useModel4Token'&&(_0x391bbf[_0x2b99dc(0x16e)]=_0x160d10[_0x2b99dc(0x16e)]+_0x25ca6a);const _0x1d41c5=await this[_0x2b99dc(0x140)]['update']({'userId':_0x21dbea},_0x391bbf);if(_0x1d41c5[_0x2b99dc(0x1a5)]===0x0)throw new common_1[(_0x2b99dc(0x12a))]('消费余额失败！',common_1[_0x2b99dc(0x19d)][_0x2b99dc(0x1a6)]);}async['queryUserBalance'](_0x3248e7){const _0x48dc12=_0x16b0d0;try{const _0x46ee0b=await this['userBalanceEntity'][_0x48dc12(0x1b5)]({'where':{'userId':_0x3248e7},'select':[_0x48dc12(0x198),_0x48dc12(0x1b2),_0x48dc12(0x17d),_0x48dc12(0x1bf),_0x48dc12(0x14a),_0x48dc12(0x18f),_0x48dc12(0x15a),_0x48dc12(0x197),_0x48dc12(0x16e),_0x48dc12(0x19e),'useModel4Token',_0x48dc12(0x1c1),'expirationTime']});if(!_0x46ee0b){const _0x2485e8=await this[_0x48dc12(0x162)](_0x3248e7);if(_0x2485e8)return await this[_0x48dc12(0x1b3)](_0x3248e7);else throw new common_1[(_0x48dc12(0x12a))]('查询当前用户余额失败！',common_1[_0x48dc12(0x19d)][_0x48dc12(0x1a6)]);}return _0x46ee0b[_0x48dc12(0x1c8)]=_0x46ee0b['packageId']?_0x46ee0b[_0x48dc12(0x1b2)]+_0x46ee0b[_0x48dc12(0x14a)]:_0x46ee0b[_0x48dc12(0x1b2)],_0x46ee0b[_0x48dc12(0x130)]=_0x46ee0b[_0x48dc12(0x198)]?_0x46ee0b[_0x48dc12(0x17d)]+_0x46ee0b['memberModel4Count']:_0x46ee0b['model4Count'],_0x46ee0b[_0x48dc12(0x18b)]=_0x46ee0b[_0x48dc12(0x198)]?_0x46ee0b[_0x48dc12(0x1bf)]+_0x46ee0b[_0x48dc12(0x15a)]:_0x46ee0b[_0x48dc12(0x1bf)],_0x46ee0b[_0x48dc12(0x1cb)]=_0x46ee0b[_0x48dc12(0x1cb)]?(0x0,date_1[_0x48dc12(0x174)])(_0x46ee0b['expirationTime'],_0x48dc12(0x16a)):null,_0x46ee0b;}catch(_0x4444db){console[_0x48dc12(0x14b)](_0x48dc12(0x1c0),_0x4444db);}}async[_0x16b0d0(0x163)](_0x1112d9){const _0x878b55=_0x16b0d0,{userId:_0x4d3c31,rechargeType:_0x3714b,model3Count:_0x54bc79,model4Count:_0x2824a4,drawMjCount:_0x3bd60f,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x1112d9;if(!_0x4d3c31)throw new common_1[(_0x878b55(0x12a))](_0x878b55(0x169),common_1[_0x878b55(0x19d)][_0x878b55(0x1a6)]);const _0x3df586=(0x0,utils_1['createRandomUid'])();return await this[_0x878b55(0x142)]['save']({'userId':_0x4d3c31,'rechargeType':_0x3714b,'model3Count':_0x54bc79,'model4Count':_0x2824a4,'drawMjCount':_0x3bd60f,'days':days,'extent':extent,'uid':_0x3df586,'pkgName':pkgName});}async[_0x16b0d0(0x162)](_0x348352,_0x316137={}){const _0x59ee88=_0x16b0d0,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x316137,_0x23cd8a=await this['userBalanceEntity'][_0x59ee88(0x1b5)]({'where':{'userId':_0x348352}});if(_0x23cd8a)throw new common_1['HttpException'](_0x59ee88(0x1dd),common_1[_0x59ee88(0x19d)][_0x59ee88(0x1a6)]);return await this[_0x59ee88(0x140)][_0x59ee88(0x15e)]({'userId':_0x348352,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x16b0d0(0x1b7)](_0x158ea8,_0x3c8dba,_0x14e578=-0x1){const _0x412736=_0x16b0d0;try{const _0x4b0116=await this[_0x412736(0x140)][_0x412736(0x1b5)]({'where':{'userId':_0x158ea8}})||await this[_0x412736(0x162)](_0x158ea8);if(!_0x4b0116)throw new common_1['HttpException'](_0x412736(0x157),common_1[_0x412736(0x19d)][_0x412736(0x1a6)]);const {model3Count:_0x36569b,model4Count:_0x48a380,drawMjCount:_0x47f0d2,memberModel3Count:_0x3d0c23,memberModel4Count:_0x5cdc95,memberDrawMjCount:_0x279611}=_0x4b0116;let _0x4988b1={};if(_0x14e578>0x0){const {packageId:_0xb60f6d}=_0x3c8dba;if(!_0xb60f6d)throw new common_1[(_0x412736(0x12a))](_0x412736(0x135),common_1[_0x412736(0x19d)][_0x412736(0x1a6)]);const _0x3380a3=await this[_0x412736(0x190)][_0x412736(0x1b5)]({'where':{'id':_0xb60f6d}});if(!_0x3380a3)throw new common_1[(_0x412736(0x12a))](_0x412736(0x17a),common_1['HttpStatus'][_0x412736(0x1a6)]);const {weight:_0x55cb3a}=_0x3380a3;if(!_0x4b0116[_0x412736(0x198)])_0x4988b1={'memberModel3Count':_0x36569b+_0x3c8dba['model3Count'],'memberModel4Count':_0x48a380+_0x3c8dba[_0x412736(0x17d)],'memberDrawMjCount':_0x47f0d2+_0x3c8dba[_0x412736(0x1bf)],'expirationTime':(0x0,date_1['default'])()[_0x412736(0x1a9)](_0x14e578>0x0?_0x14e578:0x0,_0x412736(0x180))[_0x412736(0x1b9)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0xb60f6d};else{const _0x479a7e=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x4b0116[_0x412736(0x198)]}});_0x55cb3a>=_0x479a7e[_0x412736(0x18e)]&&(_0x4988b1={'memberModel3Count':_0x3d0c23+_0x3c8dba[_0x412736(0x1b2)],'memberModel4Count':_0x5cdc95+_0x3c8dba['model4Count'],'memberDrawMjCount':_0x279611+_0x3c8dba['drawMjCount'],'expirationTime':(0x0,date_1['default'])(_0x4b0116[_0x412736(0x1cb)])['add'](_0x14e578>0x0?_0x14e578:0x0,'day')[_0x412736(0x1b9)](_0x412736(0x136)),'packageId':_0xb60f6d}),_0x55cb3a<_0x479a7e[_0x412736(0x18e)]&&(_0x4988b1={'memberModel3Count':_0x3d0c23+_0x3c8dba[_0x412736(0x1b2)],'memberModel4Count':_0x5cdc95+_0x3c8dba['model4Count'],'memberDrawMjCount':_0x279611+_0x3c8dba[_0x412736(0x1bf)]});}}_0x14e578<=0x0&&(_0x4988b1={'model3Count':_0x36569b+_0x3c8dba['model3Count'],'model4Count':_0x48a380+_0x3c8dba[_0x412736(0x17d)],'drawMjCount':_0x47f0d2+_0x3c8dba[_0x412736(0x1bf)]});const _0xeef544=await this[_0x412736(0x140)][_0x412736(0x191)]({'userId':_0x158ea8},_0x4988b1);if(_0xeef544[_0x412736(0x1a5)]===0x0)throw new common_1[(_0x412736(0x12a))](_0x158ea8+_0x412736(0x1c7),common_1[_0x412736(0x19d)][_0x412736(0x1a6)]);}catch(_0x4e0a2b){console[_0x412736(0x14b)](_0x412736(0x1c0),_0x4e0a2b);throw new common_1[(_0x412736(0x12a))]('用户充值失败！',common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x16b0d0(0x170)](_0x326990){const _0x3a181d=_0x16b0d0;console[_0x3a181d(0x14b)](_0x3a181d(0x141),_0x326990);try{const {userId:_0x5ecc51,goodsId:_0x26b8ed}=_0x326990,_0x47f8a2=await this[_0x3a181d(0x190)][_0x3a181d(0x1b5)]({'where':{'id':_0x326990['goodsId'],'status':0x1}});if(!_0x47f8a2)throw new common_1[(_0x3a181d(0x12a))](_0x3a181d(0x196),common_1[_0x3a181d(0x19d)][_0x3a181d(0x1a6)]);const {model3Count:_0x1d4ef8,model4Count:_0x591e3d,drawMjCount:_0x1115c7,days:_0x4bf5f2,name:_0x51ad87}=_0x47f8a2,_0x64be79={'model3Count':_0x1d4ef8,'model4Count':_0x591e3d,'drawMjCount':_0x1115c7,'days':_0x4bf5f2,'packageId':_0x326990['goodsId']};await this['addBalanceToUser'](_0x5ecc51,_0x64be79,_0x4bf5f2),await this[_0x3a181d(0x163)]({'userId':_0x5ecc51,'rechargeType':balance_constant_1['RechargeType']['SCAN_PAY'],'model3Count':_0x1d4ef8,'model4Count':_0x591e3d,'drawMjCount':_0x1115c7,'pkgName':_0x51ad87,'days':_0x4bf5f2});const _0x30e5a7=await this[_0x3a181d(0x178)][_0x3a181d(0x1b5)]({'where':{'id':_0x5ecc51}}),{invitedBy:_0x2c378b}=_0x30e5a7;if(_0x2c378b){const _0x2f7375=await this[_0x3a181d(0x178)][_0x3a181d(0x1b5)]({'where':{'inviteCode':_0x2c378b}}),_0x1e7315=await this[_0x3a181d(0x124)][_0x3a181d(0x1b5)]({'where':{'userId':_0x2f7375['id']}});if(!_0x2f7375)return;const {id:_0x186f02}=_0x2f7375,{performanceRatio:_0x56e9fa}=_0x1e7315,_0x9b635d={'inviterUserId':_0x186f02,'inviteeUserId':_0x5ecc51,'orderId':_0x326990['id'],'orderPrice':_0x326990[_0x3a181d(0x1ca)],'commissionPercentage':_0x56e9fa,'commissionAmount':(_0x326990[_0x3a181d(0x1ca)]*_0x56e9fa/0x64)['toFixed'](0x2)};await this[_0x3a181d(0x12f)][_0x3a181d(0x1cf)](_0x9b635d),await this[_0x3a181d(0x12f)]['saveCommissionAmount'](_0x186f02,_0x9b635d['commissionAmount']);}}catch(_0x29cb1c){console[_0x3a181d(0x14b)](_0x3a181d(0x1c0),_0x29cb1c);throw new common_1['HttpException'](_0x3a181d(0x184),common_1[_0x3a181d(0x19d)][_0x3a181d(0x1a6)]);}}async[_0x16b0d0(0x1d7)](_0x2e56d0,_0x1b7c19){const _0x373722=_0x16b0d0,{page:page=0x1,size:size=0x14}=_0x1b7c19,{id:_0x40781f}=_0x2e56d0[_0x373722(0x160)],[_0x2e10ef,_0x32f3c2]=await this[_0x373722(0x142)][_0x373722(0x179)]({'where':{'userId':_0x40781f},'order':{'id':_0x373722(0x17b)},'skip':(page-0x1)*size,'take':size});return _0x2e10ef[_0x373722(0x1a4)](_0x20ae37=>{const _0x5490a9=_0x373722;_0x20ae37[_0x5490a9(0x12b)]=_0x20ae37[_0x5490a9(0x13c)]>0x0?_0x20ae37[_0x5490a9(0x13c)]+'天':'永久';}),{'rows':(0x0,date_1[_0x373722(0x1ac)])(_0x2e10ef),'count':_0x32f3c2};}async[_0x16b0d0(0x144)](_0x3b54a7,_0x12e1a3){const _0x3f177e=_0x16b0d0;try{const {page:page=0x1,size:size=0xa,userId:_0x33e546,rechargeType:_0x328e91,packageId:_0x49b821}=_0x12e1a3,{role:_0x2aa49d}=_0x3b54a7['user'],_0x6d12b9={};_0x328e91&&(_0x6d12b9[_0x3f177e(0x182)]=_0x328e91),_0x6d12b9[_0x3f177e(0x181)]=_0x33e546||(0x0,typeorm_2['LessThan'])(0x186a0),_0x49b821&&(_0x6d12b9[_0x3f177e(0x198)]={'$like':'%'+_0x49b821+'%'});const [_0x2c9355,_0x1cff79]=await this[_0x3f177e(0x142)]['findAndCount']({'where':_0x6d12b9,'order':{'id':_0x3f177e(0x17b)},'skip':(page-0x1)*size,'take':size}),_0x25a2e0=_0x2c9355[_0x3f177e(0x143)](_0x317d5b=>_0x317d5b[_0x3f177e(0x181)]),_0x83cac7=await this[_0x3f177e(0x178)][_0x3f177e(0x1e5)]({'where':{'id':(0x0,typeorm_2['In'])(_0x25a2e0)}});return _0x2c9355['forEach'](_0x34b79e=>{const _0x4b3f68=_0x3f177e,_0x1d4756=_0x83cac7['find'](_0x55c419=>_0x55c419['id']===_0x34b79e[_0x4b3f68(0x181)]);_0x34b79e[_0x4b3f68(0x127)]=_0x1d4756===null||_0x1d4756===void 0x0?void 0x0:_0x1d4756[_0x4b3f68(0x127)],_0x34b79e[_0x4b3f68(0x1a8)]=_0x1d4756===null||_0x1d4756===void 0x0?void 0x0:_0x1d4756[_0x4b3f68(0x1a8)],_0x34b79e[_0x4b3f68(0x1d8)]=_0x1d4756===null||_0x1d4756===void 0x0?void 0x0:_0x1d4756[_0x4b3f68(0x1d8)],_0x34b79e[_0x4b3f68(0x192)]=_0x1d4756===null||_0x1d4756===void 0x0?void 0x0:_0x1d4756[_0x4b3f68(0x192)],_0x34b79e[_0x4b3f68(0x131)]=_0x1d4756===null||_0x1d4756===void 0x0?void 0x0:_0x1d4756[_0x4b3f68(0x131)];}),_0x2aa49d!=='super'&&_0x2c9355[_0x3f177e(0x1a4)](_0x1a4ac1=>{const _0x29abac=_0x3f177e;_0x1a4ac1['email']=_0x1a4ac1[_0x29abac(0x1a8)]?(0x0,utils_1[_0x29abac(0x126)])(_0x1a4ac1['email']):'',_0x1a4ac1[_0x29abac(0x1d8)]=_0x1a4ac1[_0x29abac(0x1d8)]?(0x0,utils_1[_0x29abac(0x126)])(_0x1a4ac1[_0x29abac(0x1d8)]):'';}),{'rows':_0x2c9355,'count':_0x1cff79};}catch(_0x3d7e44){console[_0x3f177e(0x14b)]('error:\x20',_0x3d7e44);throw new common_1[(_0x3f177e(0x12a))](_0x3f177e(0x18d),common_1[_0x3f177e(0x19d)][_0x3f177e(0x1a6)]);}}async['queryUserBalanceByIds'](_0x719e3b){const _0x5d4bd0=_0x16b0d0;return await this[_0x5d4bd0(0x140)]['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x719e3b)}});}async['refundMjBalance'](_0x5614d6,_0x19a4df){const _0x3827c5=_0x16b0d0;return await this[_0x3827c5(0x1a7)](_0x5614d6,_0x3827c5(0x14d),-_0x19a4df);}async[_0x16b0d0(0x1c9)](){const _0x7a4eb9=_0x16b0d0,_0x9121ce=await this['userEntity']['find']();if(!_0x9121ce[_0x7a4eb9(0x1bc)])return;const _0x335815=await this['globalConfigService']['getConfigs']([_0x7a4eb9(0x19b)]);if(!_0x335815)await this[_0x7a4eb9(0x1b1)]['setConfig']({'settings':[{'configKey':'upgradeStatus','configVal':'1'}]});else throw new common_1[(_0x7a4eb9(0x12a))](_0x7a4eb9(0x153),common_1[_0x7a4eb9(0x19d)]['BAD_REQUEST']);_0x9121ce['forEach'](_0x5e2d16=>{const _0x1378db=_0x7a4eb9,{id:_0x3489d5}=_0x5e2d16;this[_0x1378db(0x15d)][_0x1378db(0x1b5)]({'where':{'userId':_0x3489d5}})[_0x1378db(0x18a)](_0xae9c4b=>{const _0x312d81=_0x1378db;if(!_0xae9c4b)return;this[_0x312d81(0x1ae)](_0x3489d5,_0xae9c4b);});});}async[_0x16b0d0(0x1ae)](_0x3d7e6b,_0x3eace8){const _0x50deb3=_0x16b0d0,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x3eace8,_0x2c2b3a=await this[_0x50deb3(0x189)][_0x50deb3(0x1b5)]({'where':{'userId':_0x3d7e6b}}),_0x9e4ba3={'userId':_0x3d7e6b,'model3Count':Number(usesLeft),'model4Count':(_0x2c2b3a===null||_0x2c2b3a===void 0x0?void 0x0:_0x2c2b3a[_0x50deb3(0x176)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x2c2b3a===null||_0x2c2b3a===void 0x0?void 0x0:_0x2c2b3a['useCount'])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x20b8a9=await this[_0x50deb3(0x140)][_0x50deb3(0x1b5)]({'where':{'userId':_0x3d7e6b}});_0x20b8a9?common_1[_0x50deb3(0x161)]['debug']('用户'+_0x3d7e6b+_0x50deb3(0x1a0),_0x50deb3(0x1cd)):this[_0x50deb3(0x140)][_0x50deb3(0x15e)](_0x9e4ba3)[_0x50deb3(0x18a)](_0x4ac32f=>{const _0x60b77b=_0x50deb3;common_1[_0x60b77b(0x161)]['debug']('用户'+_0x3d7e6b+_0x60b77b(0x1ce),_0x60b77b(0x1cd));})[_0x50deb3(0x1bd)](_0x23bca4=>{const _0x52d4b0=_0x50deb3;console[_0x52d4b0(0x14b)]('error:\x20',_0x23bca4),common_1['Logger']['debug']('用户'+_0x3d7e6b+_0x52d4b0(0x1a3),_0x52d4b0(0x1cd));});}async[_0x16b0d0(0x16b)](_0x325107){const _0x1e5dd0=_0x16b0d0,{fingerprint:_0x25c1ef}=_0x325107[_0x1e5dd0(0x17e)],{id:_0x46a147}=_0x325107[_0x1e5dd0(0x160)];return await this[_0x1e5dd0(0x19c)][_0x1e5dd0(0x191)]({'userId':Number(_0x25c1ef)},{'userId':_0x46a147}),await this['chatGroupEntity'][_0x1e5dd0(0x191)]({'userId':Number(_0x25c1ef)},{'userId':_0x46a147}),await this[_0x1e5dd0(0x1df)][_0x1e5dd0(0x191)]({'userId':Number(_0x25c1ef)},{'userId':_0x46a147}),0x1;}async[_0x16b0d0(0x1b8)](_0x28b16c){const _0x3802b1=_0x16b0d0,{fingerprint:_0x41b570}=_0x28b16c[_0x3802b1(0x17e)],_0x5eb139=await this[_0x3802b1(0x19c)][_0x3802b1(0x176)]({'where':{'userId':_0x41b570}}),_0x487555=await this[_0x3802b1(0x14c)]['count']({'where':{'userId':_0x41b570}}),_0x14595c=await this[_0x3802b1(0x1df)]['count']({'where':{'userId':_0x41b570}});return _0x5eb139||_0x487555||_0x14595c||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x16b0d0(0x1db)])(),__param(0x0,(0x0,typeorm_1[_0x16b0d0(0x13f)])(balance_entity_1[_0x16b0d0(0x1b4)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x16b0d0(0x1e3)])),__param(0x2,(0x0,typeorm_1[_0x16b0d0(0x13f)])(accountLog_entity_1[_0x16b0d0(0x1c5)])),__param(0x3,(0x0,typeorm_1[_0x16b0d0(0x13f)])(cramiPackage_entity_1[_0x16b0d0(0x132)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x16b0d0(0x166)])),__param(0x5,(0x0,typeorm_1[_0x16b0d0(0x13f)])(user_entity_1[_0x16b0d0(0x1e2)])),__param(0x6,(0x0,typeorm_1[_0x16b0d0(0x13f)])(salesUsers_entity_1[_0x16b0d0(0x17c)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1[_0x16b0d0(0x16f)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0x16b0d0(0x13b)])),__param(0x9,(0x0,typeorm_1[_0x16b0d0(0x13f)])(chatGroup_entity_1[_0x16b0d0(0x171)])),__param(0xa,(0x0,typeorm_1[_0x16b0d0(0x13f)])(chatLog_entity_1['ChatLogEntity'])),__param(0xb,(0x0,typeorm_1[_0x16b0d0(0x13f)])(midjourney_entity_1[_0x16b0d0(0x12e)])),__metadata(_0x16b0d0(0x1c6),[typeorm_2[_0x16b0d0(0x1ab)],typeorm_2[_0x16b0d0(0x1ab)],typeorm_2['Repository'],typeorm_2[_0x16b0d0(0x1ab)],typeorm_2[_0x16b0d0(0x1ab)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x16b0d0(0x1ab)],typeorm_2[_0x16b0d0(0x1ab)],typeorm_2[_0x16b0d0(0x1ab)],typeorm_2[_0x16b0d0(0x1ab)],typeorm_2[_0x16b0d0(0x1ab)],sales_service_1[_0x16b0d0(0x175)],globalConfig_service_1['GlobalConfigService']])],UserBalanceService),exports[_0x16b0d0(0x138)]=UserBalanceService;