'use strict';const _0x54e40a=_0x1868;(function(_0x4c5ebb,_0x3c2257){const _0x269987=_0x1868,_0xc652e8=_0x4c5ebb();while(!![]){try{const _0x21ec79=parseInt(_0x269987(0x18e))/0x1+-parseInt(_0x269987(0x1c4))/0x2+-parseInt(_0x269987(0x21d))/0x3*(parseInt(_0x269987(0x24e))/0x4)+-parseInt(_0x269987(0x20e))/0x5*(-parseInt(_0x269987(0x21e))/0x6)+-parseInt(_0x269987(0x1c3))/0x7+parseInt(_0x269987(0x1e3))/0x8*(-parseInt(_0x269987(0x1d6))/0x9)+parseInt(_0x269987(0x213))/0xa;if(_0x21ec79===_0x3c2257)break;else _0xc652e8['push'](_0xc652e8['shift']());}catch(_0x975bb5){_0xc652e8['push'](_0xc652e8['shift']());}}}(_0x2529,0x3ab7d));function _0x2529(){const _0x2c8040=['1396HcxTQf','../../common/constants/balance.constant','model4','update','PAYMENT_REQUIRED','ConfigEntity','add','validateVisitorBalance','BalanceEntity','186816bTPwks','mjDraw','balanceEntity','当前套餐不存在！','visitorMJNum','当前用户不存在,记录充值日志异常','UserEntity','days','registerSendModel4Count','../globalConfig/config.entity','model3','HttpException','rechargeType','账户信息已经存在、迁移无效','visitorModel4Num','DESC','用户充值失败！','map','addBalanceToNewUser','user','firstRregisterSendModel4Count','注册赠送失败,请联系管理员！','formatCreateOrUpdateDate','registerSendModel3Count','inviteGiveSendModel4Count','firstRegisterSendStatus','createRandomUid','fingerprintLogEntity','getOwnPropertyDescriptor','ChatLogEntity','./balance.entity','configVal','查询用户账户信息失败！','setConfig','globalConfigService','旧账户信息迁移失败','MjCount','MidjourneyEntity','getRechargeLog','typeorm','sumDrawMjCount','SalesUsersEntity','findOne','function','username','hideString','invitedGuestSendModel4Count','queryUserBalance','toFixed','ChatGroupEntity','visitor','findAndCount','firstRegisterSendRank','3049382wtFTyU','603002ggDPcV','vxNumber','HttpStatus','userBalanceEntity','default','find','@nestjs/typeorm','addBalanceToUser','packageId','cramiPackageEntity','RechargeType','充值失败！','refundMjBalance','addBalanceToOrder','super','SCAN_PAY','../crami/cramiPackage.entity','memberDrawMjCount','27HLoglX','>\x20或购买专属套餐\x20！','whiteListEntity','expirationTime','metadata','CramiPackageEntity','../sales/salesUsers.entity','format','avatar','object','BalanceService','inviteGiveSendDrawMjCount','REG_GIFT','60936XiKZCo','useModel4Token','GlobalConfigService','salesService','chatLogEntity','accountLogEntity','查询当前用户余额失败！','./accountLog.entity','headers','queryUserBalanceByIds','registerSendStatus','invitedGuestSendModel3Count','../../common/utils','model4Count','validateBalance','缺失当前用户账户记录！','@nestjs/common','旧账户信息迁移成功','FingerprintLogEntity','userId','count','useCount','---','您已经升级过了、请勿重复操作！','getAccountLog','UserBalanceEntity','saveRecordRechargeLog','__param','getVisitorCount','../chatgpt/whiteList.entity','chatGroupEntity','UserBalanceService','isInteger','writeOldBalanceToNewTable','非法操作、当前充值套餐暂不存在！','查询用户账户失败！','../../common/utils/date','inheritVisitorData','phone','log','model3Count','../chatLog/chatLog.entity','weight','5wLjEYC','InjectRepository','save','WhiteListEntity','SalesService','10015830dLVHQw','invitedGuestSendDrawMjCount','affected','day','__decorate','sumModel4Count','upgradeBalance','../globalConfig/globalConfig.service','midjourneyEntity','includes','3963pzbNfp','1638702SDYoUv','缺失当前套餐ID、充值失败！','isUpdatedToday','goodsId','getMonth','Repository','YYYY-MM-DD\x20HH:mm:ss','充值失败','useModel4Count','sumModel3Count','updatedAt','odel4','then','catch','useDrawMjToken','registerSendDrawMjCount','useModel3Token','__metadata','forEach','memberModel3Count','status','total','debug','消费余额失败！','visitorModel3Num','drawMjCount','inviteSendStatus','userEntity','formatDate','error:\x20','./userBalance.entity','createBaseUserBalance','inviteGiveSendModel3Count','BAD_REQUEST','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','Logger','email','design:paramtypes','deductFromBalance','firstRregisterSendDrawMjCount','upgradeStatus','useModel3Count','REFER_GIFT','firstRregisterSendModel3Count','configEntity','memberModel4Count','length','createSalesRecords'];_0x2529=function(){return _0x2c8040;};return _0x2529();}var __decorate=this&&this[_0x54e40a(0x217)]||function(_0x2a490b,_0x1d1a9a,_0x5218a4,_0x28f8ec){const _0x2b7080=_0x54e40a;var _0x2fd5cc=arguments[_0x2b7080(0x24c)],_0x149436=_0x2fd5cc<0x3?_0x1d1a9a:_0x28f8ec===null?_0x28f8ec=Object[_0x2b7080(0x1aa)](_0x1d1a9a,_0x5218a4):_0x28f8ec,_0x577f0f;if(typeof Reflect===_0x2b7080(0x1df)&&typeof Reflect['decorate']===_0x2b7080(0x1b9))_0x149436=Reflect['decorate'](_0x2a490b,_0x1d1a9a,_0x5218a4,_0x28f8ec);else{for(var _0x2e4944=_0x2a490b[_0x2b7080(0x24c)]-0x1;_0x2e4944>=0x0;_0x2e4944--)if(_0x577f0f=_0x2a490b[_0x2e4944])_0x149436=(_0x2fd5cc<0x3?_0x577f0f(_0x149436):_0x2fd5cc>0x3?_0x577f0f(_0x1d1a9a,_0x5218a4,_0x149436):_0x577f0f(_0x1d1a9a,_0x5218a4))||_0x149436;}return _0x2fd5cc>0x3&&_0x149436&&Object['defineProperty'](_0x1d1a9a,_0x5218a4,_0x149436),_0x149436;},__metadata=this&&this[_0x54e40a(0x22f)]||function(_0x1c162c,_0x131ad3){const _0x454105=_0x54e40a;if(typeof Reflect==='object'&&typeof Reflect[_0x454105(0x1da)]===_0x454105(0x1b9))return Reflect[_0x454105(0x1da)](_0x1c162c,_0x131ad3);},__param=this&&this[_0x54e40a(0x1fe)]||function(_0x16a118,_0xaef58f){return function(_0x51c00e,_0x29c8de){_0xaef58f(_0x51c00e,_0x29c8de,_0x16a118);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['UserBalanceService']=void 0x0;const globalConfig_service_1=require(_0x54e40a(0x21a)),typeorm_1=require(_0x54e40a(0x1ca)),balance_entity_1=require(_0x54e40a(0x1ac)),common_1=require(_0x54e40a(0x1f3)),typeorm_2=require(_0x54e40a(0x1b5)),balance_constant_1=require(_0x54e40a(0x186)),accountLog_entity_1=require(_0x54e40a(0x1ea)),utils_1=require(_0x54e40a(0x1ef)),config_entity_1=require(_0x54e40a(0x197)),cramiPackage_entity_1=require(_0x54e40a(0x1d4)),userBalance_entity_1=require(_0x54e40a(0x23c)),date_1=require(_0x54e40a(0x207)),user_entity_1=require('../user/user.entity'),salesUsers_entity_1=require(_0x54e40a(0x1dc)),sales_service_1=require('../sales/sales.service'),whiteList_entity_1=require(_0x54e40a(0x200)),fingerprint_entity_1=require('./fingerprint.entity'),chatLog_entity_1=require(_0x54e40a(0x20c)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),midjourney_entity_1=require('../midjourney/midjourney.entity');function _0x1868(_0xd0de1,_0x585c0c){const _0x2529e8=_0x2529();return _0x1868=function(_0x186880,_0x574544){_0x186880=_0x186880-0x186;let _0x43ce88=_0x2529e8[_0x186880];return _0x43ce88;},_0x1868(_0xd0de1,_0x585c0c);}let UserBalanceService=class UserBalanceService{constructor(_0x1017c0,_0xa8e09,_0xd83e37,_0x4a7c7d,_0x69bd89,_0x3e191b,_0x2301cb,_0x5844bc,_0x651432,_0x3d4f4d,_0x3c4ec2,_0x216fee,_0x508204,_0x353764){const _0x423284=_0x54e40a;this[_0x423284(0x190)]=_0x1017c0,this[_0x423284(0x1c7)]=_0xa8e09,this['accountLogEntity']=_0xd83e37,this[_0x423284(0x1cd)]=_0x4a7c7d,this['configEntity']=_0x69bd89,this[_0x423284(0x239)]=_0x3e191b,this['salesUsersEntity']=_0x2301cb,this['whiteListEntity']=_0x5844bc,this[_0x423284(0x1a9)]=_0x651432,this[_0x423284(0x201)]=_0x3d4f4d,this[_0x423284(0x1e7)]=_0x3c4ec2,this['midjourneyEntity']=_0x216fee,this[_0x423284(0x1e6)]=_0x508204,this[_0x423284(0x1b0)]=_0x353764;}async[_0x54e40a(0x1a0)](_0x94b96d,_0x4a4e3c){const _0x2372b8=_0x54e40a;try{const _0x3ad71e=await this[_0x2372b8(0x24a)][_0x2372b8(0x1c9)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x2372b8(0x1ed),_0x2372b8(0x1a5),_0x2372b8(0x196),_0x2372b8(0x22d),_0x2372b8(0x1a7),'firstRegisterSendRank',_0x2372b8(0x249),_0x2372b8(0x1a2),_0x2372b8(0x245),_0x2372b8(0x238),'inviteGiveSendModel3Count',_0x2372b8(0x1a6),'inviteGiveSendDrawMjCount',_0x2372b8(0x1ee),_0x2372b8(0x214),'invitedGuestSendModel4Count'])}}),_0x370ecb=_0x3ad71e['reduce']((_0x3651c8,_0x3fdab5)=>{const _0x74046c=_0x2372b8,_0x1c1373=Number(_0x3fdab5[_0x74046c(0x1ad)]),_0x5b87ba=Number[_0x74046c(0x203)](_0x1c1373)&&_0x1c1373>0x0?_0x1c1373:0x0;return _0x3651c8[_0x3fdab5['configKey']]=_0x5b87ba,_0x3651c8;},{});let _0x3b800a=0x0,_0x70075e=0x0,_0x4513e2=0x0;_0x370ecb['registerSendStatus']===0x1&&(_0x3b800a=_0x3b800a+_0x370ecb['registerSendModel3Count'],_0x70075e=_0x70075e+_0x370ecb[_0x2372b8(0x196)],_0x4513e2=_0x4513e2+_0x370ecb[_0x2372b8(0x22d)]),_0x370ecb[_0x2372b8(0x1ed)]===0x1&&_0x370ecb[_0x2372b8(0x1a7)]===0x1&&_0x94b96d<=_0x370ecb[_0x2372b8(0x1c2)]&&(_0x3b800a=_0x3b800a+_0x370ecb[_0x2372b8(0x249)],_0x70075e=_0x70075e+_0x370ecb[_0x2372b8(0x1a2)],_0x4513e2=_0x4513e2+_0x370ecb['firstRregisterSendDrawMjCount']),await this[_0x2372b8(0x1fd)]({'userId':_0x94b96d,'rechargeType':balance_constant_1[_0x2372b8(0x1ce)][_0x2372b8(0x1e2)],'model3Count':_0x3b800a,'drawMjCount':_0x4513e2,'model4Count':_0x70075e}),_0x4a4e3c&&(Number(_0x370ecb[_0x2372b8(0x238)])===0x1&&(_0x3b800a=_0x3b800a+Number(_0x370ecb[_0x2372b8(0x1ee)]),_0x70075e=_0x70075e+Number(_0x370ecb['invitedGuestSendModel4Count']),_0x4513e2=_0x4513e2+Number(_0x370ecb[_0x2372b8(0x214)]),await this[_0x2372b8(0x1fd)]({'userId':_0x94b96d,'rechargeType':balance_constant_1['RechargeType']['INVITE_GIFT'],'model3Count':_0x370ecb[_0x2372b8(0x1ee)],'model4Count':_0x370ecb[_0x2372b8(0x1bc)],'drawMjCount':_0x370ecb[_0x2372b8(0x214)]}),await this[_0x2372b8(0x1cb)](_0x4a4e3c,{'model3Count':_0x370ecb[_0x2372b8(0x23e)],'model4Count':_0x370ecb[_0x2372b8(0x1a6)],'drawMjCount':_0x370ecb[_0x2372b8(0x1e1)]}),await this[_0x2372b8(0x1fd)]({'userId':_0x4a4e3c,'rechargeType':balance_constant_1[_0x2372b8(0x1ce)][_0x2372b8(0x248)],'model3Count':_0x370ecb[_0x2372b8(0x23e)],'model4Count':_0x370ecb[_0x2372b8(0x1a6)],'drawMjCount':_0x370ecb[_0x2372b8(0x1e1)]}))),await this[_0x2372b8(0x1c7)][_0x2372b8(0x210)]({'userId':_0x94b96d,'model3Count':_0x3b800a,'model4Count':_0x70075e,'drawMjCount':_0x4513e2,'useTokens':0x0});}catch(_0x8c7e09){console['log']('error:\x20',_0x8c7e09);throw new common_1[(_0x2372b8(0x199))](_0x2372b8(0x1a3),common_1['HttpStatus'][_0x2372b8(0x23f)]);}}async[_0x54e40a(0x1f1)](_0x378986,_0x4741c7,_0xc020a8){const _0x279882=_0x54e40a,{id:_0x2871b5,role:_0x48af0a}=_0x378986[_0x279882(0x1a1)];let _0x2a98e8=await this[_0x279882(0x1c7)][_0x279882(0x1b8)]({'where':{'userId':_0x2871b5}});!_0x2a98e8&&(_0x2a98e8=await this['createBaseUserBalance'](_0x2871b5));if(_0x48af0a===_0x279882(0x1c0))return this[_0x279882(0x18c)](_0x378986,_0x4741c7,_0xc020a8);const _0x4bbe5b=await this['configEntity'][_0x279882(0x1b8)]({'where':{'configKey':_0x279882(0x1c5)}}),_0x3e4e8e=_0x4bbe5b?_0x4bbe5b[_0x279882(0x1ad)]:_0x279882(0x1f9),_0x285dd2=_0x4741c7===_0x279882(0x198)?_0x279882(0x231):_0x4741c7===_0x279882(0x187)?_0x279882(0x24b):_0x4741c7===_0x279882(0x18f)?_0x279882(0x1d5):null,_0x2a39f1=_0x4741c7===_0x279882(0x198)?'model3Count':_0x4741c7==='model4'?_0x279882(0x1f0):_0x4741c7===_0x279882(0x18f)?'drawMjCount':null;if(_0x2a98e8[_0x279882(0x1cc)]&&_0x2a98e8[_0x285dd2]<_0xc020a8){if(_0x2a98e8[_0x2a39f1]<_0xc020a8)throw new common_1[(_0x279882(0x199))]('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x3e4e8e+'>\x20或购买专属套餐\x20！',common_1[_0x279882(0x1c6)][_0x279882(0x189)]);}if(!_0x2a98e8[_0x279882(0x1cc)]&&_0x2a98e8[_0x2a39f1]<_0xc020a8)throw new common_1[(_0x279882(0x199))]('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x3e4e8e+_0x279882(0x1d7),common_1[_0x279882(0x1c6)][_0x279882(0x189)]);return _0x2a98e8;}async[_0x54e40a(0x18c)](_0x4bdf33,_0x4baf54,_0xad1e8d){const _0x5636aa=_0x54e40a,{id:_0x158938}=_0x4bdf33[_0x5636aa(0x1a1)],_0x4a544f=_0x4baf54===_0x5636aa(0x198)?'model3Count':_0x4baf54==='model4'?_0x5636aa(0x1f0):_0x4baf54===_0x5636aa(0x18f)?_0x5636aa(0x237):null,_0x3fb2db=new Date(),_0x321ea8=await this[_0x5636aa(0x1a9)][_0x5636aa(0x1b8)]({'where':{'fingerprint':_0x158938}}),{visitorModel3Num:_0x2a8f31,visitorModel4Num:_0x239164,visitorMJNum:_0x56a3e2}=await this['globalConfigService']['getConfigs']([_0x5636aa(0x236),_0x5636aa(0x19c),_0x5636aa(0x192)]),_0x398ced={'model3Count':_0x2a8f31?Number(_0x2a8f31):0x0,'model4Count':_0x239164?Number(_0x239164):0x0,'drawMjCount':_0x56a3e2?Number(_0x56a3e2):0x0};if(!_0x321ea8){const _0x388002={'fingerprint':_0x158938,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x388002[_0x4a544f]=_0x388002[_0x4a544f]+_0xad1e8d;if(_0x388002[_0x4a544f]>_0x398ced[_0x4a544f])throw new common_1['HttpException'](_0x5636aa(0x240),common_1['HttpStatus']['PAYMENT_REQUIRED']);else return await this['fingerprintLogEntity'][_0x5636aa(0x210)](_0x388002),!![];}else{const {model3Count:_0x5ae221,model4Count:_0x1fe1c5,drawMjCount:_0x612b3c}=_0x321ea8;let _0x24d5c0={'model3Count':_0x5ae221,'model4Count':_0x1fe1c5,'drawMjCount':_0x612b3c};const _0x4b250f=Number(new Date(_0x321ea8[_0x5636aa(0x228)])),_0x339ce8=this[_0x5636aa(0x220)](_0x4b250f);_0x339ce8?_0x24d5c0[_0x4a544f]=_0x24d5c0[_0x4a544f]+_0xad1e8d:(_0x24d5c0={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x24d5c0[_0x4a544f]=_0x24d5c0[_0x4a544f]+_0xad1e8d);if(_0x24d5c0[_0x4a544f]>_0x398ced[_0x4a544f])throw new common_1[(_0x5636aa(0x199))](_0x5636aa(0x240),common_1[_0x5636aa(0x1c6)]['PAYMENT_REQUIRED']);else return await this['fingerprintLogEntity'][_0x5636aa(0x188)]({'fingerprint':_0x158938},_0x24d5c0),!![];}}[_0x54e40a(0x220)](_0x107fdc){const _0x2d2e86=_0x54e40a,_0x4583c4=new Date(),_0x520b4e=new Date(_0x4583c4['getFullYear'](),_0x4583c4[_0x2d2e86(0x222)](),_0x4583c4['getDate']());return _0x107fdc>=_0x520b4e;}async['deductFromBalance'](_0x403b5d,_0x194841,_0x2d8dbd,_0x3d22e7=0x0){const _0x18239e=_0x54e40a,_0x17a5fc=await this[_0x18239e(0x1c7)][_0x18239e(0x1b8)]({'where':{'userId':_0x403b5d}});if(!_0x17a5fc)throw new common_1[(_0x18239e(0x199))](_0x18239e(0x1f2),common_1[_0x18239e(0x1c6)][_0x18239e(0x23f)]);const _0x41ca56=_0x194841===_0x18239e(0x198)?_0x18239e(0x231):_0x194841==='model4'?_0x18239e(0x24b):_0x194841===_0x18239e(0x18f)?_0x18239e(0x1d5):null,_0x51b981=_0x194841===_0x18239e(0x198)?'model3Count':_0x194841===_0x18239e(0x187)?_0x18239e(0x1f0):_0x194841===_0x18239e(0x18f)?'drawMjCount':null,_0x296d21=_0x17a5fc[_0x18239e(0x1cc)]&&_0x17a5fc[_0x41ca56]<_0x2d8dbd?_0x51b981:_0x17a5fc['packageId']?_0x41ca56:_0x51b981;let _0x18a1eb=null;_0x296d21['includes']('odel3')&&(_0x18a1eb=_0x18239e(0x22e));_0x296d21[_0x18239e(0x21c)](_0x18239e(0x229))&&(_0x18a1eb=_0x18239e(0x1e4));_0x296d21[_0x18239e(0x21c)](_0x18239e(0x1b2))&&(_0x18a1eb=_0x18239e(0x22c));const _0x43e75a={[_0x296d21]:_0x17a5fc[_0x296d21]-_0x2d8dbd<0x0?0x0:_0x17a5fc[_0x296d21]-_0x2d8dbd,[_0x18a1eb]:_0x17a5fc[_0x18a1eb]+_0x3d22e7};_0x18a1eb===_0x18239e(0x22e)&&(_0x43e75a['useModel3Count']=_0x17a5fc['useModel3Count']+_0x2d8dbd),_0x18a1eb==='useModel4Token'&&(_0x43e75a[_0x18239e(0x226)]=_0x17a5fc[_0x18239e(0x226)]+_0x2d8dbd);const _0xdb4863=await this[_0x18239e(0x1c7)][_0x18239e(0x188)]({'userId':_0x403b5d},_0x43e75a);if(_0xdb4863['affected']===0x0)throw new common_1['HttpException'](_0x18239e(0x235),common_1[_0x18239e(0x1c6)][_0x18239e(0x23f)]);}async['queryUserBalance'](_0xb5520f){const _0x2396b2=_0x54e40a;try{const _0x18b12e=await this[_0x2396b2(0x1c7)][_0x2396b2(0x1b8)]({'where':{'userId':_0xb5520f},'select':[_0x2396b2(0x1cc),_0x2396b2(0x20b),_0x2396b2(0x1f0),'drawMjCount','memberModel3Count',_0x2396b2(0x24b),_0x2396b2(0x1d5),_0x2396b2(0x247),'useModel4Count',_0x2396b2(0x22e),_0x2396b2(0x1e4),'useDrawMjToken',_0x2396b2(0x1d9)]});if(!_0x18b12e){const _0xff12ea=await this[_0x2396b2(0x23d)](_0xb5520f);if(_0xff12ea)return await this[_0x2396b2(0x1bd)](_0xb5520f);else throw new common_1['HttpException'](_0x2396b2(0x1e9),common_1[_0x2396b2(0x1c6)][_0x2396b2(0x23f)]);}return _0x18b12e[_0x2396b2(0x227)]=_0x18b12e[_0x2396b2(0x1cc)]?_0x18b12e[_0x2396b2(0x20b)]+_0x18b12e['memberModel3Count']:_0x18b12e[_0x2396b2(0x20b)],_0x18b12e[_0x2396b2(0x218)]=_0x18b12e['packageId']?_0x18b12e['model4Count']+_0x18b12e[_0x2396b2(0x24b)]:_0x18b12e[_0x2396b2(0x1f0)],_0x18b12e[_0x2396b2(0x1b6)]=_0x18b12e[_0x2396b2(0x1cc)]?_0x18b12e[_0x2396b2(0x237)]+_0x18b12e[_0x2396b2(0x1d5)]:_0x18b12e[_0x2396b2(0x237)],_0x18b12e[_0x2396b2(0x1d9)]=_0x18b12e[_0x2396b2(0x1d9)]?(0x0,date_1[_0x2396b2(0x23a)])(_0x18b12e[_0x2396b2(0x1d9)],'YYYY-MM-DD'):null,_0x18b12e;}catch(_0x444b94){console[_0x2396b2(0x20a)]('error:\x20',_0x444b94);}}async['saveRecordRechargeLog'](_0x3da314){const _0xcb82d2=_0x54e40a,{userId:_0x22098a,rechargeType:_0x8cf55f,model3Count:_0x219520,model4Count:_0x533261,drawMjCount:_0x5dc8a0,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x3da314;if(!_0x22098a)throw new common_1[(_0xcb82d2(0x199))](_0xcb82d2(0x193),common_1[_0xcb82d2(0x1c6)][_0xcb82d2(0x23f)]);const _0x2742e4=(0x0,utils_1[_0xcb82d2(0x1a8)])();return await this[_0xcb82d2(0x1e8)][_0xcb82d2(0x210)]({'userId':_0x22098a,'rechargeType':_0x8cf55f,'model3Count':_0x219520,'model4Count':_0x533261,'drawMjCount':_0x5dc8a0,'days':days,'extent':extent,'uid':_0x2742e4,'pkgName':pkgName});}async[_0x54e40a(0x23d)](_0x178d13,_0x1f4bab={}){const _0x41f22e=_0x54e40a,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x1f4bab,_0x102542=await this[_0x41f22e(0x1c7)]['findOne']({'where':{'userId':_0x178d13}});if(_0x102542)throw new common_1[(_0x41f22e(0x199))]('当前用户无需创建账户信息！',common_1[_0x41f22e(0x1c6)][_0x41f22e(0x23f)]);return await this[_0x41f22e(0x1c7)][_0x41f22e(0x210)]({'userId':_0x178d13,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x54e40a(0x1cb)](_0x58997c,_0x17350e,_0x96dd47=-0x1){const _0x345969=_0x54e40a;try{const _0x4050e7=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x58997c}})||await this[_0x345969(0x23d)](_0x58997c);if(!_0x4050e7)throw new common_1[(_0x345969(0x199))](_0x345969(0x1ae),common_1['HttpStatus']['BAD_REQUEST']);const {model3Count:_0x185f96,model4Count:_0x158475,drawMjCount:_0x3cc03f,memberModel3Count:_0x49b4bc,memberModel4Count:_0x1c336d,memberDrawMjCount:_0x50fd7c}=_0x4050e7;let _0x2b2266={};if(_0x96dd47>0x0){const {packageId:_0x565075}=_0x17350e;if(!_0x565075)throw new common_1[(_0x345969(0x199))](_0x345969(0x21f),common_1[_0x345969(0x1c6)][_0x345969(0x23f)]);const _0x580e0c=await this[_0x345969(0x1cd)][_0x345969(0x1b8)]({'where':{'id':_0x565075}});if(!_0x580e0c)throw new common_1['HttpException'](_0x345969(0x191),common_1[_0x345969(0x1c6)]['BAD_REQUEST']);const {weight:_0x19af2b}=_0x580e0c;if(!_0x4050e7[_0x345969(0x1cc)])_0x2b2266={'memberModel3Count':_0x185f96+_0x17350e[_0x345969(0x20b)],'memberModel4Count':_0x158475+_0x17350e['model4Count'],'memberDrawMjCount':_0x3cc03f+_0x17350e[_0x345969(0x237)],'expirationTime':(0x0,date_1[_0x345969(0x1c8)])()[_0x345969(0x18b)](_0x96dd47>0x0?_0x96dd47:0x0,_0x345969(0x216))[_0x345969(0x1dd)](_0x345969(0x224)),'packageId':_0x565075};else{const _0x4b53ff=await this[_0x345969(0x1cd)][_0x345969(0x1b8)]({'where':{'id':_0x4050e7[_0x345969(0x1cc)]}});_0x19af2b>=_0x4b53ff[_0x345969(0x20d)]&&(_0x2b2266={'memberModel3Count':_0x49b4bc+_0x17350e[_0x345969(0x20b)],'memberModel4Count':_0x1c336d+_0x17350e['model4Count'],'memberDrawMjCount':_0x50fd7c+_0x17350e[_0x345969(0x237)],'expirationTime':(0x0,date_1[_0x345969(0x1c8)])(_0x4050e7[_0x345969(0x1d9)])['add'](_0x96dd47>0x0?_0x96dd47:0x0,'day')[_0x345969(0x1dd)](_0x345969(0x224)),'packageId':_0x565075}),_0x19af2b<_0x4b53ff[_0x345969(0x20d)]&&(_0x2b2266={'memberModel3Count':_0x49b4bc+_0x17350e['model3Count'],'memberModel4Count':_0x1c336d+_0x17350e['model4Count'],'memberDrawMjCount':_0x50fd7c+_0x17350e[_0x345969(0x237)]});}}_0x96dd47<=0x0&&(_0x2b2266={'model3Count':_0x185f96+_0x17350e[_0x345969(0x20b)],'model4Count':_0x158475+_0x17350e[_0x345969(0x1f0)],'drawMjCount':_0x3cc03f+_0x17350e[_0x345969(0x237)]});const _0x1b4cdb=await this[_0x345969(0x1c7)][_0x345969(0x188)]({'userId':_0x58997c},_0x2b2266);if(_0x1b4cdb[_0x345969(0x215)]===0x0)throw new common_1[(_0x345969(0x199))](_0x58997c+_0x345969(0x225),common_1[_0x345969(0x1c6)][_0x345969(0x23f)]);}catch(_0x160ff8){console['log'](_0x345969(0x23b),_0x160ff8);throw new common_1[(_0x345969(0x199))](_0x345969(0x19e),common_1[_0x345969(0x1c6)][_0x345969(0x23f)]);}}async[_0x54e40a(0x1d1)](_0x2d13ab){const _0x5b448e=_0x54e40a;console[_0x5b448e(0x20a)]('充值的工单信息:',_0x2d13ab);try{const {userId:_0x5b8d2e,goodsId:_0x516614}=_0x2d13ab,_0x580fb4=await this['cramiPackageEntity'][_0x5b448e(0x1b8)]({'where':{'id':_0x2d13ab[_0x5b448e(0x221)],'status':0x1}});if(!_0x580fb4)throw new common_1['HttpException'](_0x5b448e(0x205),common_1['HttpStatus'][_0x5b448e(0x23f)]);const {model3Count:_0x2ef14f,model4Count:_0x566b32,drawMjCount:_0x2450cf,days:_0x199884,name:_0x5e7619}=_0x580fb4,_0x41f8e0={'model3Count':_0x2ef14f,'model4Count':_0x566b32,'drawMjCount':_0x2450cf,'days':_0x199884,'packageId':_0x2d13ab['goodsId']};await this[_0x5b448e(0x1cb)](_0x5b8d2e,_0x41f8e0,_0x199884),await this[_0x5b448e(0x1fd)]({'userId':_0x5b8d2e,'rechargeType':balance_constant_1[_0x5b448e(0x1ce)][_0x5b448e(0x1d3)],'model3Count':_0x2ef14f,'model4Count':_0x566b32,'drawMjCount':_0x2450cf,'pkgName':_0x5e7619,'days':_0x199884});const _0x2af4aa=await this[_0x5b448e(0x239)][_0x5b448e(0x1b8)]({'where':{'id':_0x5b8d2e}}),{invitedBy:_0x3780c4}=_0x2af4aa;if(_0x3780c4){const _0x1fe21b=await this[_0x5b448e(0x239)]['findOne']({'where':{'inviteCode':_0x3780c4}}),_0x1cdd46=await this['salesUsersEntity'][_0x5b448e(0x1b8)]({'where':{'userId':_0x1fe21b['id']}});if(!_0x1fe21b)return;const {id:_0x578afb}=_0x1fe21b,{performanceRatio:_0x46612d}=_0x1cdd46,_0x1ec3b8={'inviterUserId':_0x578afb,'inviteeUserId':_0x5b8d2e,'orderId':_0x2d13ab['id'],'orderPrice':_0x2d13ab[_0x5b448e(0x233)],'commissionPercentage':_0x46612d,'commissionAmount':(_0x2d13ab[_0x5b448e(0x233)]*_0x46612d/0x64)[_0x5b448e(0x1be)](0x2)};await this[_0x5b448e(0x1e6)][_0x5b448e(0x24d)](_0x1ec3b8),await this[_0x5b448e(0x1e6)]['saveCommissionAmount'](_0x578afb,_0x1ec3b8['commissionAmount']);}}catch(_0x1f95fc){console[_0x5b448e(0x20a)](_0x5b448e(0x23b),_0x1f95fc);throw new common_1['HttpException'](_0x5b448e(0x1cf),common_1['HttpStatus'][_0x5b448e(0x23f)]);}}async[_0x54e40a(0x1b4)](_0x2c5932,_0x77ec98){const _0x5411fe=_0x54e40a,{page:page=0x1,size:size=0x14}=_0x77ec98,{id:_0x1db708}=_0x2c5932[_0x5411fe(0x1a1)],[_0x2a94f4,_0x4089f9]=await this[_0x5411fe(0x1e8)][_0x5411fe(0x1c1)]({'where':{'userId':_0x1db708},'order':{'id':_0x5411fe(0x19d)},'skip':(page-0x1)*size,'take':size});return _0x2a94f4[_0x5411fe(0x230)](_0x49325b=>{const _0x39ff46=_0x5411fe;_0x49325b['expireDateCn']=_0x49325b[_0x39ff46(0x195)]>0x0?_0x49325b[_0x39ff46(0x195)]+'天':'永久';}),{'rows':(0x0,date_1[_0x5411fe(0x1a4)])(_0x2a94f4),'count':_0x4089f9};}async[_0x54e40a(0x1fb)](_0x2fe8dd,_0x31e1be){const _0x33566b=_0x54e40a;try{const {page:page=0x1,size:size=0xa,userId:_0x437b90,rechargeType:_0x1b5b7c,packageId:_0x4e5c8d}=_0x31e1be,{role:_0x24a26b}=_0x2fe8dd[_0x33566b(0x1a1)],_0x3a7b47={};_0x1b5b7c&&(_0x3a7b47[_0x33566b(0x19a)]=_0x1b5b7c),_0x3a7b47[_0x33566b(0x1f6)]=_0x437b90||(0x0,typeorm_2['LessThan'])(0x186a0),_0x4e5c8d&&(_0x3a7b47[_0x33566b(0x1cc)]={'$like':'%'+_0x4e5c8d+'%'});const [_0x1f593c,_0x1c76c7]=await this[_0x33566b(0x1e8)][_0x33566b(0x1c1)]({'where':_0x3a7b47,'order':{'id':_0x33566b(0x19d)},'skip':(page-0x1)*size,'take':size}),_0x7d8980=_0x1f593c[_0x33566b(0x19f)](_0x1efdb5=>_0x1efdb5['userId']),_0xf21f53=await this[_0x33566b(0x239)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x7d8980)}});return _0x1f593c[_0x33566b(0x230)](_0x4b1083=>{const _0xcc1796=_0x33566b,_0x34e1fa=_0xf21f53[_0xcc1796(0x1c9)](_0x111f9f=>_0x111f9f['id']===_0x4b1083[_0xcc1796(0x1f6)]);_0x4b1083[_0xcc1796(0x1ba)]=_0x34e1fa===null||_0x34e1fa===void 0x0?void 0x0:_0x34e1fa['username'],_0x4b1083[_0xcc1796(0x242)]=_0x34e1fa===null||_0x34e1fa===void 0x0?void 0x0:_0x34e1fa['email'],_0x4b1083[_0xcc1796(0x209)]=_0x34e1fa===null||_0x34e1fa===void 0x0?void 0x0:_0x34e1fa[_0xcc1796(0x209)],_0x4b1083[_0xcc1796(0x232)]=_0x34e1fa===null||_0x34e1fa===void 0x0?void 0x0:_0x34e1fa[_0xcc1796(0x232)],_0x4b1083[_0xcc1796(0x1de)]=_0x34e1fa===null||_0x34e1fa===void 0x0?void 0x0:_0x34e1fa[_0xcc1796(0x1de)];}),_0x24a26b!==_0x33566b(0x1d2)&&_0x1f593c[_0x33566b(0x230)](_0x3cf25d=>{const _0x495738=_0x33566b;_0x3cf25d['email']=_0x3cf25d['email']?(0x0,utils_1[_0x495738(0x1bb)])(_0x3cf25d[_0x495738(0x242)]):'',_0x3cf25d[_0x495738(0x209)]=_0x3cf25d[_0x495738(0x209)]?(0x0,utils_1[_0x495738(0x1bb)])(_0x3cf25d[_0x495738(0x209)]):'';}),{'rows':_0x1f593c,'count':_0x1c76c7};}catch(_0x294099){console[_0x33566b(0x20a)]('error:\x20',_0x294099);throw new common_1[(_0x33566b(0x199))](_0x33566b(0x206),common_1[_0x33566b(0x1c6)]['BAD_REQUEST']);}}async[_0x54e40a(0x1ec)](_0x3bd69e){const _0x4e7a35=_0x54e40a;return await this[_0x4e7a35(0x1c7)][_0x4e7a35(0x1c9)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x3bd69e)}});}async[_0x54e40a(0x1d0)](_0x4297f0,_0x283b91){const _0x4ec23a=_0x54e40a;return await this[_0x4ec23a(0x244)](_0x4297f0,_0x4ec23a(0x18f),-_0x283b91);}async[_0x54e40a(0x219)](){const _0x84c04e=_0x54e40a,_0x441753=await this['userEntity']['find']();if(!_0x441753[_0x84c04e(0x24c)])return;const _0x257252=await this[_0x84c04e(0x1b0)]['getConfigs']([_0x84c04e(0x246)]);if(!_0x257252)await this[_0x84c04e(0x1b0)][_0x84c04e(0x1af)]({'settings':[{'configKey':_0x84c04e(0x246),'configVal':'1'}]});else throw new common_1[(_0x84c04e(0x199))](_0x84c04e(0x1fa),common_1[_0x84c04e(0x1c6)][_0x84c04e(0x23f)]);_0x441753[_0x84c04e(0x230)](_0x1af787=>{const _0x43c877=_0x84c04e,{id:_0x576f3e}=_0x1af787;this[_0x43c877(0x190)][_0x43c877(0x1b8)]({'where':{'userId':_0x576f3e}})['then'](_0x44218f=>{const _0x3c35cd=_0x43c877;if(!_0x44218f)return;this[_0x3c35cd(0x204)](_0x576f3e,_0x44218f);});});}async[_0x54e40a(0x204)](_0x20ba51,_0x1e1474){const _0x4eabe8=_0x54e40a,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x1e1474,_0xf05c58=await this[_0x4eabe8(0x1d8)]['findOne']({'where':{'userId':_0x20ba51}}),_0x28b78a={'userId':_0x20ba51,'model3Count':Number(usesLeft),'model4Count':(_0xf05c58===null||_0xf05c58===void 0x0?void 0x0:_0xf05c58[_0x4eabe8(0x1f7)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0xf05c58===null||_0xf05c58===void 0x0?void 0x0:_0xf05c58[_0x4eabe8(0x1f8)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x306f36=await this[_0x4eabe8(0x1c7)][_0x4eabe8(0x1b8)]({'where':{'userId':_0x20ba51}});_0x306f36?common_1[_0x4eabe8(0x241)][_0x4eabe8(0x234)]('用户'+_0x20ba51+_0x4eabe8(0x19b),_0x4eabe8(0x1e0)):this[_0x4eabe8(0x1c7)][_0x4eabe8(0x210)](_0x28b78a)[_0x4eabe8(0x22a)](_0x1cc59f=>{const _0xb273dc=_0x4eabe8;common_1[_0xb273dc(0x241)][_0xb273dc(0x234)]('用户'+_0x20ba51+_0xb273dc(0x1f4),_0xb273dc(0x1e0));})[_0x4eabe8(0x22b)](_0x21f208=>{const _0x438f4e=_0x4eabe8;console[_0x438f4e(0x20a)](_0x438f4e(0x23b),_0x21f208),common_1[_0x438f4e(0x241)][_0x438f4e(0x234)]('用户'+_0x20ba51+_0x438f4e(0x1b1),'BalanceService');});}async[_0x54e40a(0x208)](_0xd92bb){const _0x1f9069=_0x54e40a,{fingerprint:_0x357dbf}=_0xd92bb[_0x1f9069(0x1eb)],{id:_0x175d5d}=_0xd92bb[_0x1f9069(0x1a1)];return await this['chatLogEntity'][_0x1f9069(0x188)]({'userId':Number(_0x357dbf)},{'userId':_0x175d5d}),await this[_0x1f9069(0x201)][_0x1f9069(0x188)]({'userId':Number(_0x357dbf)},{'userId':_0x175d5d}),await this[_0x1f9069(0x21b)][_0x1f9069(0x188)]({'userId':Number(_0x357dbf)},{'userId':_0x175d5d}),0x1;}async[_0x54e40a(0x1ff)](_0x4681d8){const _0x55bbf1=_0x54e40a,{fingerprint:_0x3fb70a}=_0x4681d8[_0x55bbf1(0x1eb)],_0x554078=await this['chatLogEntity'][_0x55bbf1(0x1f7)]({'where':{'userId':_0x3fb70a}}),_0x496f2a=await this[_0x55bbf1(0x201)][_0x55bbf1(0x1f7)]({'where':{'userId':_0x3fb70a}}),_0x20d131=await this['midjourneyEntity'][_0x55bbf1(0x1f7)]({'where':{'userId':_0x3fb70a}});return _0x554078||_0x496f2a||_0x20d131||0x0;}};UserBalanceService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x54e40a(0x20f)])(balance_entity_1[_0x54e40a(0x18d)])),__param(0x1,(0x0,typeorm_1[_0x54e40a(0x20f)])(userBalance_entity_1[_0x54e40a(0x1fc)])),__param(0x2,(0x0,typeorm_1[_0x54e40a(0x20f)])(accountLog_entity_1['AccountLogEntity'])),__param(0x3,(0x0,typeorm_1[_0x54e40a(0x20f)])(cramiPackage_entity_1[_0x54e40a(0x1db)])),__param(0x4,(0x0,typeorm_1[_0x54e40a(0x20f)])(config_entity_1[_0x54e40a(0x18a)])),__param(0x5,(0x0,typeorm_1[_0x54e40a(0x20f)])(user_entity_1[_0x54e40a(0x194)])),__param(0x6,(0x0,typeorm_1[_0x54e40a(0x20f)])(salesUsers_entity_1[_0x54e40a(0x1b7)])),__param(0x7,(0x0,typeorm_1[_0x54e40a(0x20f)])(whiteList_entity_1[_0x54e40a(0x211)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0x54e40a(0x1f5)])),__param(0x9,(0x0,typeorm_1[_0x54e40a(0x20f)])(chatGroup_entity_1[_0x54e40a(0x1bf)])),__param(0xa,(0x0,typeorm_1[_0x54e40a(0x20f)])(chatLog_entity_1[_0x54e40a(0x1ab)])),__param(0xb,(0x0,typeorm_1[_0x54e40a(0x20f)])(midjourney_entity_1[_0x54e40a(0x1b3)])),__metadata(_0x54e40a(0x243),[typeorm_2[_0x54e40a(0x223)],typeorm_2['Repository'],typeorm_2[_0x54e40a(0x223)],typeorm_2['Repository'],typeorm_2[_0x54e40a(0x223)],typeorm_2[_0x54e40a(0x223)],typeorm_2[_0x54e40a(0x223)],typeorm_2[_0x54e40a(0x223)],typeorm_2[_0x54e40a(0x223)],typeorm_2[_0x54e40a(0x223)],typeorm_2[_0x54e40a(0x223)],typeorm_2['Repository'],sales_service_1[_0x54e40a(0x212)],globalConfig_service_1[_0x54e40a(0x1e5)]])],UserBalanceService),exports[_0x54e40a(0x202)]=UserBalanceService;