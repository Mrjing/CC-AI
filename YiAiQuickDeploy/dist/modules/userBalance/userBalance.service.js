'use strict';const _0x54806d=_0x5d90;(function(_0x150e21,_0x478a58){const _0x4d0689=_0x5d90,_0x7e7451=_0x150e21();while(!![]){try{const _0x13d8fb=parseInt(_0x4d0689(0x178))/0x1+-parseInt(_0x4d0689(0x189))/0x2*(-parseInt(_0x4d0689(0x14a))/0x3)+parseInt(_0x4d0689(0x1b9))/0x4*(-parseInt(_0x4d0689(0x110))/0x5)+parseInt(_0x4d0689(0x198))/0x6*(parseInt(_0x4d0689(0x135))/0x7)+-parseInt(_0x4d0689(0x1ac))/0x8+parseInt(_0x4d0689(0x190))/0x9+-parseInt(_0x4d0689(0x1c2))/0xa*(-parseInt(_0x4d0689(0x116))/0xb);if(_0x13d8fb===_0x478a58)break;else _0x7e7451['push'](_0x7e7451['shift']());}catch(_0x459b27){_0x7e7451['push'](_0x7e7451['shift']());}}}(_0x391c,0x7660a));var __decorate=this&&this[_0x54806d(0x147)]||function(_0x118eb6,_0x4822c5,_0x476c29,_0x36e215){const _0x3b52dc=_0x54806d;var _0x27dd50=arguments['length'],_0x4526e7=_0x27dd50<0x3?_0x4822c5:_0x36e215===null?_0x36e215=Object[_0x3b52dc(0x126)](_0x4822c5,_0x476c29):_0x36e215,_0x18ae3a;if(typeof Reflect===_0x3b52dc(0x131)&&typeof Reflect['decorate']===_0x3b52dc(0x10c))_0x4526e7=Reflect[_0x3b52dc(0x11f)](_0x118eb6,_0x4822c5,_0x476c29,_0x36e215);else{for(var _0x26eae6=_0x118eb6['length']-0x1;_0x26eae6>=0x0;_0x26eae6--)if(_0x18ae3a=_0x118eb6[_0x26eae6])_0x4526e7=(_0x27dd50<0x3?_0x18ae3a(_0x4526e7):_0x27dd50>0x3?_0x18ae3a(_0x4822c5,_0x476c29,_0x4526e7):_0x18ae3a(_0x4822c5,_0x476c29))||_0x4526e7;}return _0x27dd50>0x3&&_0x4526e7&&Object['defineProperty'](_0x4822c5,_0x476c29,_0x4526e7),_0x4526e7;},__metadata=this&&this[_0x54806d(0x1a0)]||function(_0x53c03,_0x74cec){const _0x56a82=_0x54806d;if(typeof Reflect===_0x56a82(0x131)&&typeof Reflect[_0x56a82(0x19f)]===_0x56a82(0x10c))return Reflect[_0x56a82(0x19f)](_0x53c03,_0x74cec);},__param=this&&this[_0x54806d(0x19e)]||function(_0x3db07b,_0x2ea7a8){return function(_0x3cbb1f,_0x1a0be8){_0x2ea7a8(_0x3cbb1f,_0x1a0be8,_0x3db07b);};};Object[_0x54806d(0x17a)](exports,_0x54806d(0x160),{'value':!![]}),exports[_0x54806d(0x156)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),typeorm_1=require(_0x54806d(0x13c)),balance_entity_1=require(_0x54806d(0x17b)),common_1=require(_0x54806d(0x154)),typeorm_2=require(_0x54806d(0x124)),balance_constant_1=require(_0x54806d(0x195)),accountLog_entity_1=require(_0x54806d(0x166)),utils_1=require('../../common/utils'),config_entity_1=require(_0x54806d(0x1b0)),cramiPackage_entity_1=require(_0x54806d(0x16d)),userBalance_entity_1=require(_0x54806d(0x16e)),date_1=require(_0x54806d(0x16a)),user_entity_1=require(_0x54806d(0x15e)),salesUsers_entity_1=require(_0x54806d(0x188)),sales_service_1=require('../sales/sales.service'),whiteList_entity_1=require(_0x54806d(0x1be)),fingerprint_entity_1=require(_0x54806d(0x169)),chatLog_entity_1=require(_0x54806d(0x140)),chatGroup_entity_1=require(_0x54806d(0x149)),midjourney_entity_1=require(_0x54806d(0x1ae));let UserBalanceService=class UserBalanceService{constructor(_0x11607f,_0x4932cf,_0x1a47db,_0x361fb3,_0x5223fc,_0x23bc14,_0xc99ed1,_0x3f07c1,_0x226d31,_0x1d1ebf,_0x52f492,_0x4ace99,_0x1242d1,_0x500ae9){const _0x26abd2=_0x54806d;this[_0x26abd2(0x177)]=_0x11607f,this[_0x26abd2(0x16b)]=_0x4932cf,this[_0x26abd2(0x155)]=_0x1a47db,this[_0x26abd2(0x1b3)]=_0x361fb3,this[_0x26abd2(0x168)]=_0x5223fc,this[_0x26abd2(0x14f)]=_0x23bc14,this[_0x26abd2(0x12f)]=_0xc99ed1,this['whiteListEntity']=_0x3f07c1,this[_0x26abd2(0x153)]=_0x226d31,this[_0x26abd2(0x172)]=_0x1d1ebf,this[_0x26abd2(0x145)]=_0x52f492,this[_0x26abd2(0x11e)]=_0x4ace99,this[_0x26abd2(0x136)]=_0x1242d1,this[_0x26abd2(0x138)]=_0x500ae9;}async[_0x54806d(0x1ca)](_0x318789,_0x50d235){const _0x4e55a9=_0x54806d;try{const _0x597ebb=await this['configEntity'][_0x4e55a9(0x152)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x4e55a9(0x12b),_0x4e55a9(0x1a8),'registerSendModel4Count','registerSendDrawMjCount',_0x4e55a9(0x125),'firstRegisterSendRank',_0x4e55a9(0x179),_0x4e55a9(0x1b8),'firstRregisterSendDrawMjCount','inviteSendStatus',_0x4e55a9(0x1ad),_0x4e55a9(0x1c3),_0x4e55a9(0x19a),'invitedGuestSendModel3Count',_0x4e55a9(0x163),_0x4e55a9(0x1cb)])}}),_0x2fbf99=_0x597ebb[_0x4e55a9(0x17c)]((_0x375c91,_0x471a3e)=>{const _0x495d9a=_0x4e55a9,_0x2ad264=Number(_0x471a3e[_0x495d9a(0x194)]),_0x2c70a1=Number[_0x495d9a(0x173)](_0x2ad264)&&_0x2ad264>0x0?_0x2ad264:0x0;return _0x375c91[_0x471a3e[_0x495d9a(0x121)]]=_0x2c70a1,_0x375c91;},{});let _0x3410e5=0x0,_0xa57651=0x0,_0x549d67=0x0;_0x2fbf99[_0x4e55a9(0x12b)]===0x1&&(_0x3410e5=_0x3410e5+_0x2fbf99[_0x4e55a9(0x1a8)],_0xa57651=_0xa57651+_0x2fbf99['registerSendModel4Count'],_0x549d67=_0x549d67+_0x2fbf99['registerSendDrawMjCount']),_0x2fbf99[_0x4e55a9(0x12b)]===0x1&&_0x2fbf99[_0x4e55a9(0x125)]===0x1&&_0x318789<=_0x2fbf99[_0x4e55a9(0x15b)]&&(_0x3410e5=_0x3410e5+_0x2fbf99[_0x4e55a9(0x179)],_0xa57651=_0xa57651+_0x2fbf99[_0x4e55a9(0x1b8)],_0x549d67=_0x549d67+_0x2fbf99['firstRregisterSendDrawMjCount']),await this[_0x4e55a9(0x180)]({'userId':_0x318789,'rechargeType':balance_constant_1[_0x4e55a9(0x181)]['REG_GIFT'],'model3Count':_0x3410e5,'drawMjCount':_0x549d67,'model4Count':_0xa57651}),_0x50d235&&(Number(_0x2fbf99['inviteSendStatus'])===0x1&&(_0x3410e5=_0x3410e5+Number(_0x2fbf99[_0x4e55a9(0x1b4)]),_0xa57651=_0xa57651+Number(_0x2fbf99[_0x4e55a9(0x1cb)]),_0x549d67=_0x549d67+Number(_0x2fbf99['invitedGuestSendDrawMjCount']),await this[_0x4e55a9(0x180)]({'userId':_0x318789,'rechargeType':balance_constant_1[_0x4e55a9(0x181)]['INVITE_GIFT'],'model3Count':_0x2fbf99[_0x4e55a9(0x1b4)],'model4Count':_0x2fbf99[_0x4e55a9(0x1cb)],'drawMjCount':_0x2fbf99[_0x4e55a9(0x163)]}),await this[_0x4e55a9(0x174)](_0x50d235,{'model3Count':_0x2fbf99[_0x4e55a9(0x1ad)],'model4Count':_0x2fbf99['inviteGiveSendModel4Count'],'drawMjCount':_0x2fbf99[_0x4e55a9(0x19a)]}),await this[_0x4e55a9(0x180)]({'userId':_0x50d235,'rechargeType':balance_constant_1[_0x4e55a9(0x181)][_0x4e55a9(0x157)],'model3Count':_0x2fbf99[_0x4e55a9(0x1ad)],'model4Count':_0x2fbf99[_0x4e55a9(0x1c3)],'drawMjCount':_0x2fbf99[_0x4e55a9(0x19a)]}))),await this[_0x4e55a9(0x16b)]['save']({'userId':_0x318789,'model3Count':_0x3410e5,'model4Count':_0xa57651,'drawMjCount':_0x549d67,'useTokens':0x0});}catch(_0x9603b0){console[_0x4e55a9(0x1c6)](_0x4e55a9(0x199),_0x9603b0);throw new common_1[(_0x4e55a9(0x167))]('注册赠送失败,请联系管理员！',common_1[_0x4e55a9(0x15d)][_0x4e55a9(0x15c)]);}}async[_0x54806d(0x1c8)](_0x457741,_0x27445c,_0x5f1259){const _0xe0520a=_0x54806d,{id:_0x2df723,role:_0x18dfd7}=_0x457741['user'];let _0x2351f7=await this[_0xe0520a(0x16b)][_0xe0520a(0x13a)]({'where':{'userId':_0x2df723}});!_0x2351f7&&(_0x2351f7=await this[_0xe0520a(0x1c5)](_0x2df723));if(_0x18dfd7===_0xe0520a(0x12c))return this[_0xe0520a(0x117)](_0x457741,_0x27445c,_0x5f1259);const _0x2056fc=await this[_0xe0520a(0x168)][_0xe0520a(0x13a)]({'where':{'configKey':_0xe0520a(0x119)}}),_0xe84882=_0x2056fc?_0x2056fc[_0xe0520a(0x194)]:_0xe0520a(0x10f),_0xddba0e=_0x27445c===_0xe0520a(0x12e)?_0xe0520a(0x18a):_0x27445c===_0xe0520a(0x17e)?'memberModel4Count':_0x27445c===_0xe0520a(0x1bb)?'memberDrawMjCount':null,_0x4f772b=_0x27445c===_0xe0520a(0x12e)?_0xe0520a(0x129):_0x27445c===_0xe0520a(0x17e)?'model4Count':_0x27445c===_0xe0520a(0x1bb)?_0xe0520a(0x1a5):null;if(_0x2351f7['packageId']&&_0x2351f7[_0xddba0e]<_0x5f1259){if(_0x2351f7[_0x4f772b]<_0x5f1259)throw new common_1['HttpException'](_0xe0520a(0x191)+_0xe84882+_0xe0520a(0x1bf),common_1['HttpStatus']['PAYMENT_REQUIRED']);}if(!_0x2351f7[_0xe0520a(0x1ba)]&&_0x2351f7[_0x4f772b]<_0x5f1259)throw new common_1[(_0xe0520a(0x167))](_0xe0520a(0x191)+_0xe84882+'>\x20或购买专属套餐\x20！',common_1[_0xe0520a(0x15d)][_0xe0520a(0x1c7)]);return _0x2351f7;}async['validateVisitorBalance'](_0x5d5ca5,_0x54f617,_0x2a8008){const _0x1c5e89=_0x54806d,{id:_0x445cb4}=_0x5d5ca5[_0x1c5e89(0x1c4)],_0x48db8d=_0x54f617===_0x1c5e89(0x12e)?_0x1c5e89(0x129):_0x54f617===_0x1c5e89(0x17e)?'model4Count':_0x54f617===_0x1c5e89(0x1bb)?_0x1c5e89(0x1a5):null,_0x28f488=new Date(),_0x3a34c8=await this['fingerprintLogEntity'][_0x1c5e89(0x13a)]({'where':{'fingerprint':_0x445cb4}}),{visitorModel3Num:_0x25e6f4,visitorModel4Num:_0xec44cf,visitorMJNum:_0x1f63fb}=await this[_0x1c5e89(0x138)]['getConfigs']([_0x1c5e89(0x162),_0x1c5e89(0x1a1),_0x1c5e89(0x123)]),_0x5411ea={'model3Count':_0x25e6f4?Number(_0x25e6f4):0x0,'model4Count':_0xec44cf?Number(_0xec44cf):0x0,'drawMjCount':_0x1f63fb?Number(_0x1f63fb):0x0};if(!_0x3a34c8){const _0x49a582={'fingerprint':_0x445cb4,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x49a582[_0x48db8d]=_0x49a582[_0x48db8d]+_0x2a8008;if(_0x49a582[_0x48db8d]>_0x5411ea[_0x48db8d])throw new common_1['HttpException'](_0x1c5e89(0x120),common_1['HttpStatus'][_0x1c5e89(0x1c7)]);else return await this[_0x1c5e89(0x153)]['save'](_0x49a582),!![];}else{const {model3Count:_0xbfaea4,model4Count:_0x975588,drawMjCount:_0x432b57}=_0x3a34c8;let _0x5ce1d4={'model3Count':_0xbfaea4,'model4Count':_0x975588,'drawMjCount':_0x432b57};const _0x55a02d=Number(new Date(_0x3a34c8[_0x1c5e89(0x114)])),_0x729761=this['isUpdatedToday'](_0x55a02d);_0x729761?_0x5ce1d4[_0x48db8d]=_0x5ce1d4[_0x48db8d]+_0x2a8008:(_0x5ce1d4={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x5ce1d4[_0x48db8d]=_0x5ce1d4[_0x48db8d]+_0x2a8008);if(_0x5ce1d4[_0x48db8d]>_0x5411ea[_0x48db8d])throw new common_1['HttpException']('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1[_0x1c5e89(0x15d)][_0x1c5e89(0x1c7)]);else return await this[_0x1c5e89(0x153)][_0x1c5e89(0x1bd)]({'fingerprint':_0x445cb4},_0x5ce1d4),!![];}}['isUpdatedToday'](_0xd849c3){const _0x54e9f8=_0x54806d,_0x1abf78=new Date(),_0x446092=new Date(_0x1abf78['getFullYear'](),_0x1abf78[_0x54e9f8(0x141)](),_0x1abf78['getDate']());return _0xd849c3>=_0x446092;}async[_0x54806d(0x11a)](_0x2f5e6b,_0x213af6,_0x493999,_0x3496e5=0x0){const _0x36f33d=_0x54806d,_0x55de2a=await this[_0x36f33d(0x16b)][_0x36f33d(0x13a)]({'where':{'userId':_0x2f5e6b}});if(!_0x55de2a)throw new common_1[(_0x36f33d(0x167))](_0x36f33d(0x144),common_1['HttpStatus']['BAD_REQUEST']);const _0x5690b6=_0x213af6==='model3'?_0x36f33d(0x18a):_0x213af6==='model4'?_0x36f33d(0x1a3):_0x213af6===_0x36f33d(0x1bb)?_0x36f33d(0x109):null,_0x53824d=_0x213af6===_0x36f33d(0x12e)?_0x36f33d(0x129):_0x213af6===_0x36f33d(0x17e)?_0x36f33d(0x186):_0x213af6===_0x36f33d(0x1bb)?_0x36f33d(0x1a5):null,_0x19cb0f=_0x55de2a['packageId']&&_0x55de2a[_0x5690b6]<_0x493999?_0x53824d:_0x55de2a[_0x36f33d(0x1ba)]?_0x5690b6:_0x53824d;let _0x1148b6=null;_0x19cb0f[_0x36f33d(0x16c)](_0x36f33d(0x1b6))&&(_0x1148b6=_0x36f33d(0x146));_0x19cb0f[_0x36f33d(0x16c)](_0x36f33d(0x130))&&(_0x1148b6=_0x36f33d(0x14b));_0x19cb0f[_0x36f33d(0x16c)](_0x36f33d(0x1a4))&&(_0x1148b6=_0x36f33d(0x187));const _0x13ee4f={[_0x19cb0f]:_0x55de2a[_0x19cb0f]-_0x493999<0x0?0x0:_0x55de2a[_0x19cb0f]-_0x493999,[_0x1148b6]:_0x55de2a[_0x1148b6]+_0x3496e5};_0x1148b6==='useModel3Token'&&(_0x13ee4f['useModel3Count']=_0x55de2a[_0x36f33d(0x14d)]+_0x493999),_0x1148b6==='useModel4Token'&&(_0x13ee4f['useModel4Count']=_0x55de2a[_0x36f33d(0x16f)]+_0x493999);const _0x59e1ce=await this[_0x36f33d(0x16b)]['update']({'userId':_0x2f5e6b},_0x13ee4f);if(_0x59e1ce['affected']===0x0)throw new common_1[(_0x36f33d(0x167))](_0x36f33d(0x19d),common_1[_0x36f33d(0x15d)][_0x36f33d(0x15c)]);}async['queryUserBalance'](_0x3a90dc){const _0x154a7d=_0x54806d;try{const _0x5e4836=await this[_0x154a7d(0x16b)][_0x154a7d(0x13a)]({'where':{'userId':_0x3a90dc},'select':[_0x154a7d(0x1ba),_0x154a7d(0x129),'model4Count',_0x154a7d(0x1a5),_0x154a7d(0x18a),_0x154a7d(0x1a3),_0x154a7d(0x109),_0x154a7d(0x14d),_0x154a7d(0x16f),_0x154a7d(0x146),_0x154a7d(0x14b),_0x154a7d(0x187),_0x154a7d(0x184)]});if(!_0x5e4836){const _0x24b2f2=await this['createBaseUserBalance'](_0x3a90dc);if(_0x24b2f2)return await this[_0x154a7d(0x165)](_0x3a90dc);else throw new common_1[(_0x154a7d(0x167))](_0x154a7d(0x10d),common_1['HttpStatus']['BAD_REQUEST']);}return _0x5e4836['sumModel3Count']=_0x5e4836[_0x154a7d(0x1ba)]?_0x5e4836[_0x154a7d(0x129)]+_0x5e4836['memberModel3Count']:_0x5e4836[_0x154a7d(0x129)],_0x5e4836[_0x154a7d(0x19b)]=_0x5e4836[_0x154a7d(0x1ba)]?_0x5e4836['model4Count']+_0x5e4836[_0x154a7d(0x1a3)]:_0x5e4836[_0x154a7d(0x186)],_0x5e4836[_0x154a7d(0x127)]=_0x5e4836[_0x154a7d(0x1ba)]?_0x5e4836[_0x154a7d(0x1a5)]+_0x5e4836[_0x154a7d(0x109)]:_0x5e4836[_0x154a7d(0x1a5)],_0x5e4836[_0x154a7d(0x184)]=_0x5e4836[_0x154a7d(0x184)]?(0x0,date_1[_0x154a7d(0x18c)])(_0x5e4836['expirationTime'],_0x154a7d(0x175)):null,_0x5e4836;}catch(_0x36bd7d){console[_0x154a7d(0x1c6)]('error:\x20',_0x36bd7d);}}async[_0x54806d(0x180)](_0x5bbfbc){const _0x457520=_0x54806d,{userId:_0x342afd,rechargeType:_0x583513,model3Count:_0x12cbac,model4Count:_0x220a24,drawMjCount:_0x4e6de5,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x5bbfbc;if(!_0x342afd)throw new common_1[(_0x457520(0x167))](_0x457520(0x19c),common_1[_0x457520(0x15d)][_0x457520(0x15c)]);const _0x4aa2c8=(0x0,utils_1[_0x457520(0x150)])();return await this[_0x457520(0x155)][_0x457520(0x15a)]({'userId':_0x342afd,'rechargeType':_0x583513,'model3Count':_0x12cbac,'model4Count':_0x220a24,'drawMjCount':_0x4e6de5,'days':days,'extent':extent,'uid':_0x4aa2c8,'pkgName':pkgName});}async[_0x54806d(0x1c5)](_0x4f6c55,_0x50fe53={}){const _0x5a0d80=_0x54806d,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x50fe53,_0x2ece7b=await this[_0x5a0d80(0x16b)][_0x5a0d80(0x13a)]({'where':{'userId':_0x4f6c55}});if(_0x2ece7b)throw new common_1[(_0x5a0d80(0x167))](_0x5a0d80(0x17d),common_1[_0x5a0d80(0x15d)][_0x5a0d80(0x15c)]);return await this[_0x5a0d80(0x16b)]['save']({'userId':_0x4f6c55,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x54806d(0x174)](_0x4c66e7,_0x1f3f4a,_0x4e994e=-0x1){const _0x1d488e=_0x54806d;try{const _0x4e39e0=await this[_0x1d488e(0x16b)][_0x1d488e(0x13a)]({'where':{'userId':_0x4c66e7}})||await this[_0x1d488e(0x1c5)](_0x4c66e7);if(!_0x4e39e0)throw new common_1[(_0x1d488e(0x167))]('查询用户账户信息失败！',common_1[_0x1d488e(0x15d)]['BAD_REQUEST']);const {model3Count:_0x2bacce,model4Count:_0x4e8db9,drawMjCount:_0x5a8c7a,memberModel3Count:_0xbd64bc,memberModel4Count:_0x147b21,memberDrawMjCount:_0x418d95}=_0x4e39e0;let _0x3c162b={};if(_0x4e994e>0x0){const {packageId:_0xba2d22}=_0x1f3f4a;if(!_0xba2d22)throw new common_1[(_0x1d488e(0x167))](_0x1d488e(0x111),common_1[_0x1d488e(0x15d)][_0x1d488e(0x15c)]);const _0x77a6f3=await this[_0x1d488e(0x1b3)][_0x1d488e(0x13a)]({'where':{'id':_0xba2d22}});if(!_0x77a6f3)throw new common_1[(_0x1d488e(0x167))](_0x1d488e(0x18e),common_1[_0x1d488e(0x15d)][_0x1d488e(0x15c)]);const {weight:_0x2059d9}=_0x77a6f3;if(!_0x4e39e0[_0x1d488e(0x1ba)])_0x3c162b={'memberModel3Count':_0x2bacce+_0x1f3f4a[_0x1d488e(0x129)],'memberModel4Count':_0x4e8db9+_0x1f3f4a[_0x1d488e(0x186)],'memberDrawMjCount':_0x5a8c7a+_0x1f3f4a[_0x1d488e(0x1a5)],'expirationTime':(0x0,date_1[_0x1d488e(0x12d)])()[_0x1d488e(0x18d)](_0x4e994e>0x0?_0x4e994e:0x0,_0x1d488e(0x197))['format'](_0x1d488e(0x170)),'packageId':_0xba2d22};else{const _0x1cf64c=await this[_0x1d488e(0x1b3)][_0x1d488e(0x13a)]({'where':{'id':_0x4e39e0['packageId']}});_0x2059d9>=_0x1cf64c[_0x1d488e(0x196)]&&(_0x3c162b={'memberModel3Count':_0xbd64bc+_0x1f3f4a[_0x1d488e(0x129)],'memberModel4Count':_0x147b21+_0x1f3f4a[_0x1d488e(0x186)],'memberDrawMjCount':_0x418d95+_0x1f3f4a['drawMjCount'],'expirationTime':(0x0,date_1[_0x1d488e(0x12d)])(_0x4e39e0['expirationTime'])[_0x1d488e(0x18d)](_0x4e994e>0x0?_0x4e994e:0x0,'day')[_0x1d488e(0x13b)](_0x1d488e(0x170)),'packageId':_0xba2d22}),_0x2059d9<_0x1cf64c[_0x1d488e(0x196)]&&(_0x3c162b={'memberModel3Count':_0xbd64bc+_0x1f3f4a['model3Count'],'memberModel4Count':_0x147b21+_0x1f3f4a[_0x1d488e(0x186)],'memberDrawMjCount':_0x418d95+_0x1f3f4a['drawMjCount']});}}_0x4e994e<=0x0&&(_0x3c162b={'model3Count':_0x2bacce+_0x1f3f4a['model3Count'],'model4Count':_0x4e8db9+_0x1f3f4a[_0x1d488e(0x186)],'drawMjCount':_0x5a8c7a+_0x1f3f4a[_0x1d488e(0x1a5)]});const _0x15a669=await this[_0x1d488e(0x16b)]['update']({'userId':_0x4c66e7},_0x3c162b);if(_0x15a669[_0x1d488e(0x192)]===0x0)throw new common_1[(_0x1d488e(0x167))](_0x4c66e7+'充值失败',common_1[_0x1d488e(0x15d)][_0x1d488e(0x15c)]);}catch(_0x31a4a8){console[_0x1d488e(0x1c6)](_0x1d488e(0x199),_0x31a4a8);throw new common_1[(_0x1d488e(0x167))]('用户充值失败！',common_1[_0x1d488e(0x15d)]['BAD_REQUEST']);}}async[_0x54806d(0x122)](_0x257257){const _0x5e31f4=_0x54806d;console[_0x5e31f4(0x1c6)]('充值的工单信息:',_0x257257);try{const {userId:_0x46926b,goodsId:_0x5b7cd9}=_0x257257,_0x5384a9=await this[_0x5e31f4(0x1b3)][_0x5e31f4(0x13a)]({'where':{'id':_0x257257['goodsId'],'status':0x1}});if(!_0x5384a9)throw new common_1['HttpException']('非法操作、当前充值套餐暂不存在！',common_1[_0x5e31f4(0x15d)][_0x5e31f4(0x15c)]);const {model3Count:_0x300d14,model4Count:_0x4f9b44,drawMjCount:_0x3bf297,days:_0x2e8036,name:_0x10488d}=_0x5384a9,_0x895bf4={'model3Count':_0x300d14,'model4Count':_0x4f9b44,'drawMjCount':_0x3bf297,'days':_0x2e8036,'packageId':_0x257257[_0x5e31f4(0x1b7)]};await this['addBalanceToUser'](_0x46926b,_0x895bf4,_0x2e8036),await this['saveRecordRechargeLog']({'userId':_0x46926b,'rechargeType':balance_constant_1[_0x5e31f4(0x181)][_0x5e31f4(0x1b1)],'model3Count':_0x300d14,'model4Count':_0x4f9b44,'drawMjCount':_0x3bf297,'pkgName':_0x10488d,'days':_0x2e8036});const _0x408cb4=await this[_0x5e31f4(0x14f)][_0x5e31f4(0x13a)]({'where':{'id':_0x46926b}}),{invitedBy:_0x362bca}=_0x408cb4;if(_0x362bca){const _0x4f6329=await this[_0x5e31f4(0x14f)]['findOne']({'where':{'inviteCode':_0x362bca}}),_0x5e5792=await this[_0x5e31f4(0x12f)][_0x5e31f4(0x13a)]({'where':{'userId':_0x4f6329['id']}});if(!_0x4f6329)return;const {id:_0x12a187}=_0x4f6329,{performanceRatio:_0x567524}=_0x5e5792,_0x10dc10={'inviterUserId':_0x12a187,'inviteeUserId':_0x46926b,'orderId':_0x257257['id'],'orderPrice':_0x257257['total'],'commissionPercentage':_0x567524,'commissionAmount':(_0x257257[_0x5e31f4(0x14c)]*_0x567524/0x64)[_0x5e31f4(0x1b2)](0x2)};await this[_0x5e31f4(0x136)][_0x5e31f4(0x11d)](_0x10dc10),await this[_0x5e31f4(0x136)]['saveCommissionAmount'](_0x12a187,_0x10dc10[_0x5e31f4(0x159)]);}}catch(_0x51a982){console['log']('error:\x20',_0x51a982);throw new common_1[(_0x5e31f4(0x167))](_0x5e31f4(0x1c1),common_1['HttpStatus'][_0x5e31f4(0x15c)]);}}async[_0x54806d(0x18b)](_0x510b19,_0x5a9523){const _0x1c0df8=_0x54806d,{page:page=0x1,size:size=0x14}=_0x5a9523,{id:_0x5db086}=_0x510b19[_0x1c0df8(0x1c4)],[_0x2edb99,_0x3aa99d]=await this[_0x1c0df8(0x155)]['findAndCount']({'where':{'userId':_0x5db086},'order':{'id':_0x1c0df8(0x14e)},'skip':(page-0x1)*size,'take':size});return _0x2edb99['forEach'](_0x263f38=>{const _0x8f6d97=_0x1c0df8;_0x263f38[_0x8f6d97(0x1b5)]=_0x263f38[_0x8f6d97(0x176)]>0x0?_0x263f38[_0x8f6d97(0x176)]+'天':'永久';}),{'rows':(0x0,date_1[_0x1c0df8(0x151)])(_0x2edb99),'count':_0x3aa99d};}async['getAccountLog'](_0x1cd0e2,_0x4dca92){const _0x2bc4ff=_0x54806d;try{const {page:page=0x1,size:size=0xa,userId:_0x3bd3ad,rechargeType:_0x5ebcd9,packageId:_0x2c196b}=_0x4dca92,{role:_0x32f2b4}=_0x1cd0e2[_0x2bc4ff(0x1c4)],_0x5b43d7={};_0x5ebcd9&&(_0x5b43d7['rechargeType']=_0x5ebcd9),_0x5b43d7[_0x2bc4ff(0x1ab)]=_0x3bd3ad||(0x0,typeorm_2[_0x2bc4ff(0x12a)])(0x186a0),_0x2c196b&&(_0x5b43d7[_0x2bc4ff(0x1ba)]={'$like':'%'+_0x2c196b+'%'});const [_0x815018,_0xdedb83]=await this[_0x2bc4ff(0x155)]['findAndCount']({'where':_0x5b43d7,'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size}),_0x3f8c51=_0x815018['map'](_0x422f34=>_0x422f34['userId']),_0x3a239c=await this['userEntity'][_0x2bc4ff(0x152)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3f8c51)}});return _0x815018[_0x2bc4ff(0x13f)](_0x135977=>{const _0x410da4=_0x2bc4ff,_0xaec732=_0x3a239c[_0x410da4(0x152)](_0x1f3ee0=>_0x1f3ee0['id']===_0x135977['userId']);_0x135977[_0x410da4(0x1bc)]=_0xaec732===null||_0xaec732===void 0x0?void 0x0:_0xaec732[_0x410da4(0x1bc)],_0x135977[_0x410da4(0x139)]=_0xaec732===null||_0xaec732===void 0x0?void 0x0:_0xaec732['email'],_0x135977[_0x410da4(0x1a6)]=_0xaec732===null||_0xaec732===void 0x0?void 0x0:_0xaec732[_0x410da4(0x1a6)],_0x135977[_0x410da4(0x1aa)]=_0xaec732===null||_0xaec732===void 0x0?void 0x0:_0xaec732['status'],_0x135977[_0x410da4(0x1c9)]=_0xaec732===null||_0xaec732===void 0x0?void 0x0:_0xaec732[_0x410da4(0x1c9)];}),_0x32f2b4!==_0x2bc4ff(0x161)&&_0x815018['forEach'](_0xc5c26f=>{const _0xfe0605=_0x2bc4ff;_0xc5c26f['email']=_0xc5c26f[_0xfe0605(0x139)]?(0x0,utils_1[_0xfe0605(0x193)])(_0xc5c26f[_0xfe0605(0x139)]):'',_0xc5c26f[_0xfe0605(0x1a6)]=_0xc5c26f[_0xfe0605(0x1a6)]?(0x0,utils_1[_0xfe0605(0x193)])(_0xc5c26f[_0xfe0605(0x1a6)]):'';}),{'rows':_0x815018,'count':_0xdedb83};}catch(_0x59148a){console[_0x2bc4ff(0x1c6)]('error:\x20',_0x59148a);throw new common_1[(_0x2bc4ff(0x167))](_0x2bc4ff(0x17f),common_1[_0x2bc4ff(0x15d)]['BAD_REQUEST']);}}async[_0x54806d(0x143)](_0xe74122){const _0x6932e2=_0x54806d;return await this[_0x6932e2(0x16b)][_0x6932e2(0x152)]({'where':{'userId':(0x0,typeorm_2['In'])(_0xe74122)}});}async[_0x54806d(0x113)](_0xb089f7,_0x2df539){const _0x2da856=_0x54806d;return await this[_0x2da856(0x11a)](_0xb089f7,_0x2da856(0x1bb),-_0x2df539);}async['upgradeBalance'](){const _0x56bed2=_0x54806d,_0x364fa4=await this[_0x56bed2(0x14f)][_0x56bed2(0x152)]();if(!_0x364fa4[_0x56bed2(0x1c0)])return;const _0x46230d=await this[_0x56bed2(0x138)]['getConfigs']([_0x56bed2(0x11c)]);if(!_0x46230d)await this[_0x56bed2(0x138)]['setConfig']({'settings':[{'configKey':_0x56bed2(0x11c),'configVal':'1'}]});else throw new common_1[(_0x56bed2(0x167))]('您已经升级过了、请勿重复操作！',common_1[_0x56bed2(0x15d)][_0x56bed2(0x15c)]);_0x364fa4[_0x56bed2(0x13f)](_0x52b016=>{const _0x7475dc=_0x56bed2,{id:_0xbb90e5}=_0x52b016;this['balanceEntity'][_0x7475dc(0x13a)]({'where':{'userId':_0xbb90e5}})[_0x7475dc(0x171)](_0x4471aa=>{const _0x49060e=_0x7475dc;if(!_0x4471aa)return;this[_0x49060e(0x13d)](_0xbb90e5,_0x4471aa);});});}async[_0x54806d(0x13d)](_0x1e74dc,_0x270c99){const _0x1dda48=_0x54806d,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x270c99,_0x4047bc=await this[_0x1dda48(0x1a9)][_0x1dda48(0x13a)]({'where':{'userId':_0x1e74dc}}),_0x33ea4d={'userId':_0x1e74dc,'model3Count':Number(usesLeft),'model4Count':(_0x4047bc===null||_0x4047bc===void 0x0?void 0x0:_0x4047bc[_0x1dda48(0x1a2)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x4047bc===null||_0x4047bc===void 0x0?void 0x0:_0x4047bc[_0x1dda48(0x128)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x1182a4=await this[_0x1dda48(0x16b)][_0x1dda48(0x13a)]({'where':{'userId':_0x1e74dc}});_0x1182a4?common_1[_0x1dda48(0x185)][_0x1dda48(0x10b)]('用户'+_0x1e74dc+'账户信息已经存在、迁移无效','BalanceService'):this[_0x1dda48(0x16b)]['save'](_0x33ea4d)[_0x1dda48(0x171)](_0x1dc765=>{const _0x1fef0a=_0x1dda48;common_1[_0x1fef0a(0x185)][_0x1fef0a(0x10b)]('用户'+_0x1e74dc+_0x1fef0a(0x134),_0x1fef0a(0x13e));})[_0x1dda48(0x15f)](_0x38144f=>{const _0x21092d=_0x1dda48;console[_0x21092d(0x1c6)]('error:\x20',_0x38144f),common_1[_0x21092d(0x185)][_0x21092d(0x10b)]('用户'+_0x1e74dc+'旧账户信息迁移失败',_0x21092d(0x13e));});}async[_0x54806d(0x115)](_0xea4fee){const _0x40ee60=_0x54806d,{fingerprint:_0x4edf16}=_0xea4fee[_0x40ee60(0x183)],{id:_0x273715}=_0xea4fee[_0x40ee60(0x1c4)];return await this[_0x40ee60(0x145)]['update']({'userId':Number(_0x4edf16)},{'userId':_0x273715}),await this['chatGroupEntity'][_0x40ee60(0x1bd)]({'userId':Number(_0x4edf16)},{'userId':_0x273715}),await this[_0x40ee60(0x11e)]['update']({'userId':Number(_0x4edf16)},{'userId':_0x273715}),0x1;}async[_0x54806d(0x182)](_0x3e71a6){const _0x470102=_0x54806d,{fingerprint:_0x1e176b}=_0x3e71a6[_0x470102(0x183)],_0x2eb7fa=await this[_0x470102(0x145)][_0x470102(0x1a2)]({'where':{'userId':_0x1e176b}}),_0x4d42af=await this['chatGroupEntity'][_0x470102(0x1a2)]({'where':{'userId':_0x1e176b}}),_0x1aa2cf=await this[_0x470102(0x11e)]['count']({'where':{'userId':_0x1e176b}});return _0x2eb7fa||_0x4d42af||_0x1aa2cf||0x0;}};function _0x5d90(_0x307ba1,_0x8e1472){const _0x391c78=_0x391c();return _0x5d90=function(_0x5d9038,_0x3e7b6f){_0x5d9038=_0x5d9038-0x109;let _0x47bb6e=_0x391c78[_0x5d9038];return _0x47bb6e;},_0x5d90(_0x307ba1,_0x8e1472);}function _0x391c(){const _0x1718db=['sumModel4Count','当前用户不存在,记录充值日志异常','消费余额失败！','__param','metadata','__metadata','visitorModel4Num','count','memberModel4Count','MjCount','drawMjCount','phone','BalanceEntity','registerSendModel3Count','whiteListEntity','status','userId','4094320DBEXaF','inviteGiveSendModel3Count','../midjourney/midjourney.entity','AccountLogEntity','../globalConfig/config.entity','SCAN_PAY','toFixed','cramiPackageEntity','invitedGuestSendModel3Count','expireDateCn','odel3','goodsId','firstRregisterSendModel4Count','4QaSCFL','packageId','mjDraw','username','update','../chatgpt/whiteList.entity','>\x20或购买专属套餐\x20！','length','充值失败！','20bMqKfx','inviteGiveSendModel4Count','user','createBaseUserBalance','log','PAYMENT_REQUIRED','validateBalance','avatar','addBalanceToNewUser','invitedGuestSendModel4Count','memberDrawMjCount','Repository','debug','function','查询当前用户余额失败！','WhiteListEntity','---','3971060QCyFCp','缺失当前套餐ID、充值失败！','MidjourneyEntity','refundMjBalance','updatedAt','inheritVisitorData','1425523ncucIq','validateVisitorBalance','FingerprintLogEntity','vxNumber','deductFromBalance','Injectable','upgradeStatus','createSalesRecords','midjourneyEntity','decorate','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','configKey','addBalanceToOrder','visitorMJNum','typeorm','firstRegisterSendStatus','getOwnPropertyDescriptor','sumDrawMjCount','useCount','model3Count','LessThan','registerSendStatus','visitor','default','model3','salesUsersEntity','odel4','object','UserEntity','UserBalanceEntity','旧账户信息迁移成功','14819RxWCdW','salesService','design:paramtypes','globalConfigService','email','findOne','format','@nestjs/typeorm','writeOldBalanceToNewTable','BalanceService','forEach','../chatLog/chatLog.entity','getMonth','CramiPackageEntity','queryUserBalanceByIds','缺失当前用户账户记录！','chatLogEntity','useModel3Token','__decorate','SalesUsersEntity','../chatGroup/chatGroup.entity','264WOyqJU','useModel4Token','total','useModel3Count','DESC','userEntity','createRandomUid','formatCreateOrUpdateDate','find','fingerprintLogEntity','@nestjs/common','accountLogEntity','UserBalanceService','REFER_GIFT','ChatLogEntity','commissionAmount','save','firstRegisterSendRank','BAD_REQUEST','HttpStatus','../user/user.entity','catch','__esModule','super','visitorModel3Num','invitedGuestSendDrawMjCount','ConfigEntity','queryUserBalance','./accountLog.entity','HttpException','configEntity','./fingerprint.entity','../../common/utils/date','userBalanceEntity','includes','../crami/cramiPackage.entity','./userBalance.entity','useModel4Count','YYYY-MM-DD\x20HH:mm:ss','then','chatGroupEntity','isInteger','addBalanceToUser','YYYY-MM-DD','days','balanceEntity','168189koVBuJ','firstRregisterSendModel3Count','defineProperty','./balance.entity','reduce','当前用户无需创建账户信息！','model4','查询用户账户失败！','saveRecordRechargeLog','RechargeType','getVisitorCount','headers','expirationTime','Logger','model4Count','useDrawMjToken','../sales/salesUsers.entity','18688CzLZMS','memberModel3Count','getRechargeLog','formatDate','add','当前套餐不存在！','InjectRepository','4166100TEnQnO','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','affected','hideString','configVal','../../common/constants/balance.constant','weight','day','222GUucxl','error:\x20','inviteGiveSendDrawMjCount'];_0x391c=function(){return _0x1718db;};return _0x391c();}UserBalanceService=__decorate([(0x0,common_1[_0x54806d(0x11b)])(),__param(0x0,(0x0,typeorm_1[_0x54806d(0x18f)])(balance_entity_1[_0x54806d(0x1a7)])),__param(0x1,(0x0,typeorm_1[_0x54806d(0x18f)])(userBalance_entity_1[_0x54806d(0x133)])),__param(0x2,(0x0,typeorm_1[_0x54806d(0x18f)])(accountLog_entity_1[_0x54806d(0x1af)])),__param(0x3,(0x0,typeorm_1[_0x54806d(0x18f)])(cramiPackage_entity_1[_0x54806d(0x142)])),__param(0x4,(0x0,typeorm_1[_0x54806d(0x18f)])(config_entity_1[_0x54806d(0x164)])),__param(0x5,(0x0,typeorm_1[_0x54806d(0x18f)])(user_entity_1[_0x54806d(0x132)])),__param(0x6,(0x0,typeorm_1[_0x54806d(0x18f)])(salesUsers_entity_1[_0x54806d(0x148)])),__param(0x7,(0x0,typeorm_1[_0x54806d(0x18f)])(whiteList_entity_1[_0x54806d(0x10e)])),__param(0x8,(0x0,typeorm_1[_0x54806d(0x18f)])(fingerprint_entity_1[_0x54806d(0x118)])),__param(0x9,(0x0,typeorm_1[_0x54806d(0x18f)])(chatGroup_entity_1['ChatGroupEntity'])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x54806d(0x158)])),__param(0xb,(0x0,typeorm_1[_0x54806d(0x18f)])(midjourney_entity_1[_0x54806d(0x112)])),__metadata(_0x54806d(0x137),[typeorm_2[_0x54806d(0x10a)],typeorm_2['Repository'],typeorm_2[_0x54806d(0x10a)],typeorm_2[_0x54806d(0x10a)],typeorm_2[_0x54806d(0x10a)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x54806d(0x10a)],typeorm_2['Repository'],typeorm_2[_0x54806d(0x10a)],typeorm_2[_0x54806d(0x10a)],typeorm_2[_0x54806d(0x10a)],sales_service_1['SalesService'],globalConfig_service_1['GlobalConfigService']])],UserBalanceService),exports[_0x54806d(0x156)]=UserBalanceService;