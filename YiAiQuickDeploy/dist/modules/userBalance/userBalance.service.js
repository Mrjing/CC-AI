'use strict';const _0x581fe7=_0x5298;(function(_0x2fc2a2,_0x42fa05){const _0x5c9b0b=_0x5298,_0x264365=_0x2fc2a2();while(!![]){try{const _0x283336=-parseInt(_0x5c9b0b(0x1ea))/0x1+-parseInt(_0x5c9b0b(0x21d))/0x2*(-parseInt(_0x5c9b0b(0x1c5))/0x3)+-parseInt(_0x5c9b0b(0x23b))/0x4+-parseInt(_0x5c9b0b(0x244))/0x5+-parseInt(_0x5c9b0b(0x1c1))/0x6+parseInt(_0x5c9b0b(0x1dc))/0x7+parseInt(_0x5c9b0b(0x25f))/0x8;if(_0x283336===_0x42fa05)break;else _0x264365['push'](_0x264365['shift']());}catch(_0x15b942){_0x264365['push'](_0x264365['shift']());}}}(_0xad94,0x780ac));var __decorate=this&&this['__decorate']||function(_0x53c139,_0xacd24,_0x237a36,_0x4dab04){const _0x375a93=_0x5298;var _0x4a12f0=arguments[_0x375a93(0x258)],_0x57e62d=_0x4a12f0<0x3?_0xacd24:_0x4dab04===null?_0x4dab04=Object[_0x375a93(0x1af)](_0xacd24,_0x237a36):_0x4dab04,_0x21c9b5;if(typeof Reflect==='object'&&typeof Reflect[_0x375a93(0x1df)]===_0x375a93(0x1f2))_0x57e62d=Reflect[_0x375a93(0x1df)](_0x53c139,_0xacd24,_0x237a36,_0x4dab04);else{for(var _0x4cd3ac=_0x53c139[_0x375a93(0x258)]-0x1;_0x4cd3ac>=0x0;_0x4cd3ac--)if(_0x21c9b5=_0x53c139[_0x4cd3ac])_0x57e62d=(_0x4a12f0<0x3?_0x21c9b5(_0x57e62d):_0x4a12f0>0x3?_0x21c9b5(_0xacd24,_0x237a36,_0x57e62d):_0x21c9b5(_0xacd24,_0x237a36))||_0x57e62d;}return _0x4a12f0>0x3&&_0x57e62d&&Object[_0x375a93(0x1b5)](_0xacd24,_0x237a36,_0x57e62d),_0x57e62d;},__metadata=this&&this['__metadata']||function(_0x40e19c,_0x2f7f4f){const _0x414400=_0x5298;if(typeof Reflect===_0x414400(0x23f)&&typeof Reflect[_0x414400(0x1ae)]===_0x414400(0x1f2))return Reflect[_0x414400(0x1ae)](_0x40e19c,_0x2f7f4f);},__param=this&&this['__param']||function(_0x1dbdf9,_0x25d9a8){return function(_0x5ec79a,_0x1ca98e){_0x25d9a8(_0x5ec79a,_0x1ca98e,_0x1dbdf9);};};Object[_0x581fe7(0x1b5)](exports,'__esModule',{'value':!![]}),exports[_0x581fe7(0x1cf)]=void 0x0;function _0x5298(_0x1939fd,_0x5eefa3){const _0xad9439=_0xad94();return _0x5298=function(_0x529832,_0x39df16){_0x529832=_0x529832-0x19e;let _0x1db262=_0xad9439[_0x529832];return _0x1db262;},_0x5298(_0x1939fd,_0x5eefa3);}const globalConfig_service_1=require(_0x581fe7(0x205)),typeorm_1=require(_0x581fe7(0x221)),balance_entity_1=require('./balance.entity'),common_1=require(_0x581fe7(0x1a4)),typeorm_2=require(_0x581fe7(0x1ed)),balance_constant_1=require(_0x581fe7(0x20b)),accountLog_entity_1=require(_0x581fe7(0x261)),utils_1=require(_0x581fe7(0x25c)),config_entity_1=require('../globalConfig/config.entity'),cramiPackage_entity_1=require(_0x581fe7(0x213)),userBalance_entity_1=require(_0x581fe7(0x1c4)),date_1=require(_0x581fe7(0x239)),user_entity_1=require('../user/user.entity'),salesUsers_entity_1=require('../sales/salesUsers.entity'),sales_service_1=require(_0x581fe7(0x1a6)),whiteList_entity_1=require(_0x581fe7(0x21b)),fingerprint_entity_1=require(_0x581fe7(0x232)),chatLog_entity_1=require(_0x581fe7(0x209)),chatGroup_entity_1=require(_0x581fe7(0x1b9)),midjourney_entity_1=require(_0x581fe7(0x1db));let UserBalanceService=class UserBalanceService{constructor(_0x1e412d,_0x795752,_0x4d9837,_0x516ed6,_0x52eee5,_0x44a781,_0x150f99,_0x4e5043,_0x29538c,_0x58c685,_0x46d583,_0x40a47a,_0x3e274a,_0x559839){const _0x33e204=_0x581fe7;this[_0x33e204(0x203)]=_0x1e412d,this[_0x33e204(0x24e)]=_0x795752,this[_0x33e204(0x204)]=_0x4d9837,this[_0x33e204(0x224)]=_0x516ed6,this[_0x33e204(0x1d5)]=_0x52eee5,this['userEntity']=_0x44a781,this[_0x33e204(0x225)]=_0x150f99,this['whiteListEntity']=_0x4e5043,this['fingerprintLogEntity']=_0x29538c,this[_0x33e204(0x233)]=_0x58c685,this[_0x33e204(0x20a)]=_0x46d583,this[_0x33e204(0x1c7)]=_0x40a47a,this['salesService']=_0x3e274a,this[_0x33e204(0x1a0)]=_0x559839;}async[_0x581fe7(0x21f)](_0x5db5e4,_0x927f55){const _0x2a2c40=_0x581fe7;try{const _0x821d07=await this[_0x2a2c40(0x1d5)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x2a2c40(0x248),_0x2a2c40(0x1a9),'registerSendModel4Count',_0x2a2c40(0x236),_0x2a2c40(0x1e4),_0x2a2c40(0x1dd),'firstRregisterSendModel3Count','firstRregisterSendModel4Count','firstRregisterSendDrawMjCount','inviteSendStatus',_0x2a2c40(0x25a),_0x2a2c40(0x229),'inviteGiveSendDrawMjCount',_0x2a2c40(0x1e7),'invitedGuestSendDrawMjCount',_0x2a2c40(0x208)])}}),_0x1d050c=_0x821d07['reduce']((_0x2310e7,_0x60e169)=>{const _0x2b7f60=_0x2a2c40,_0x1a92aa=Number(_0x60e169[_0x2b7f60(0x1c6)]),_0x504724=Number[_0x2b7f60(0x1bb)](_0x1a92aa)&&_0x1a92aa>0x0?_0x1a92aa:0x0;return _0x2310e7[_0x60e169['configKey']]=_0x504724,_0x2310e7;},{});let _0x2e72f1=0x0,_0x5b1c55=0x0,_0x1913a5=0x0;_0x1d050c[_0x2a2c40(0x248)]===0x1&&(_0x2e72f1=_0x2e72f1+_0x1d050c['registerSendModel3Count'],_0x5b1c55=_0x5b1c55+_0x1d050c[_0x2a2c40(0x1ec)],_0x1913a5=_0x1913a5+_0x1d050c[_0x2a2c40(0x236)]),_0x1d050c[_0x2a2c40(0x248)]===0x1&&_0x1d050c['firstRegisterSendStatus']===0x1&&_0x5db5e4<=_0x1d050c[_0x2a2c40(0x1dd)]&&(_0x2e72f1=_0x2e72f1+_0x1d050c[_0x2a2c40(0x216)],_0x5b1c55=_0x5b1c55+_0x1d050c['firstRregisterSendModel4Count'],_0x1913a5=_0x1913a5+_0x1d050c[_0x2a2c40(0x1cb)]),await this[_0x2a2c40(0x22a)]({'userId':_0x5db5e4,'rechargeType':balance_constant_1[_0x2a2c40(0x1fa)][_0x2a2c40(0x237)],'model3Count':_0x2e72f1,'drawMjCount':_0x1913a5,'model4Count':_0x5b1c55}),_0x927f55&&(Number(_0x1d050c[_0x2a2c40(0x20e)])===0x1&&(_0x2e72f1=_0x2e72f1+Number(_0x1d050c[_0x2a2c40(0x1e7)]),_0x5b1c55=_0x5b1c55+Number(_0x1d050c['invitedGuestSendModel4Count']),_0x1913a5=_0x1913a5+Number(_0x1d050c[_0x2a2c40(0x1a2)]),await this[_0x2a2c40(0x22a)]({'userId':_0x5db5e4,'rechargeType':balance_constant_1['RechargeType'][_0x2a2c40(0x1da)],'model3Count':_0x1d050c['invitedGuestSendModel3Count'],'model4Count':_0x1d050c[_0x2a2c40(0x208)],'drawMjCount':_0x1d050c[_0x2a2c40(0x1a2)]}),await this[_0x2a2c40(0x20c)](_0x927f55,{'model3Count':_0x1d050c[_0x2a2c40(0x25a)],'model4Count':_0x1d050c[_0x2a2c40(0x229)],'drawMjCount':_0x1d050c[_0x2a2c40(0x24a)]}),await this['saveRecordRechargeLog']({'userId':_0x927f55,'rechargeType':balance_constant_1['RechargeType'][_0x2a2c40(0x253)],'model3Count':_0x1d050c[_0x2a2c40(0x25a)],'model4Count':_0x1d050c[_0x2a2c40(0x229)],'drawMjCount':_0x1d050c[_0x2a2c40(0x24a)]}))),await this[_0x2a2c40(0x24e)][_0x2a2c40(0x1d2)]({'userId':_0x5db5e4,'model3Count':_0x2e72f1,'model4Count':_0x5b1c55,'drawMjCount':_0x1913a5,'useTokens':0x0});}catch(_0x3deefc){console[_0x2a2c40(0x1d1)](_0x2a2c40(0x1c3),_0x3deefc);throw new common_1[(_0x2a2c40(0x200))]('注册赠送失败,请联系管理员！',common_1[_0x2a2c40(0x22f)][_0x2a2c40(0x1cd)]);}}async[_0x581fe7(0x1ee)](_0x2e4004,_0x392799,_0xaefc05){const _0x146bdb=_0x581fe7,{id:_0x2cc4bf,role:_0x5b1f31}=_0x2e4004[_0x146bdb(0x257)];let _0x1b1e8c=await this[_0x146bdb(0x24e)][_0x146bdb(0x231)]({'where':{'userId':_0x2cc4bf}});!_0x1b1e8c&&(_0x1b1e8c=await this[_0x146bdb(0x1f0)](_0x2cc4bf));if(_0x5b1f31==='visitor')return this[_0x146bdb(0x1fb)](_0x2e4004,_0x392799,_0xaefc05);const _0x21ff49=await this[_0x146bdb(0x1d5)][_0x146bdb(0x231)]({'where':{'configKey':_0x146bdb(0x246)}}),_0x445ca7=_0x21ff49?_0x21ff49['configVal']:_0x146bdb(0x1e5),_0x49158e=_0x392799===_0x146bdb(0x1c9)?'memberModel3Count':_0x392799===_0x146bdb(0x215)?_0x146bdb(0x241):_0x392799===_0x146bdb(0x1eb)?_0x146bdb(0x219):null,_0x235874=_0x392799===_0x146bdb(0x1c9)?_0x146bdb(0x240):_0x392799===_0x146bdb(0x215)?_0x146bdb(0x256):_0x392799===_0x146bdb(0x1eb)?'drawMjCount':null;if(_0x1b1e8c['packageId']&&_0x1b1e8c[_0x49158e]<_0xaefc05){if(_0x1b1e8c[_0x235874]<_0xaefc05)throw new common_1[(_0x146bdb(0x200))]('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x445ca7+_0x146bdb(0x1ce),common_1['HttpStatus'][_0x146bdb(0x222)]);}if(!_0x1b1e8c[_0x146bdb(0x250)]&&_0x1b1e8c[_0x235874]<_0xaefc05)throw new common_1[(_0x146bdb(0x200))](_0x146bdb(0x1de)+_0x445ca7+_0x146bdb(0x1ce),common_1['HttpStatus'][_0x146bdb(0x222)]);return _0x1b1e8c;}async[_0x581fe7(0x1fb)](_0x49a85a,_0x29a573,_0x76e5c){const _0x1768c2=_0x581fe7,{id:_0x341634}=_0x49a85a[_0x1768c2(0x257)],_0x16ba57=_0x29a573===_0x1768c2(0x1c9)?'model3Count':_0x29a573===_0x1768c2(0x215)?_0x1768c2(0x256):_0x29a573==='mjDraw'?_0x1768c2(0x262):null,_0x1fc7e7=new Date(),_0x5b3cda=await this[_0x1768c2(0x22b)][_0x1768c2(0x231)]({'where':{'fingerprint':_0x341634}}),{visitorModel3Num:_0x5e086e,visitorModel4Num:_0x49b731,visitorMJNum:_0x469ef5}=await this[_0x1768c2(0x1a0)][_0x1768c2(0x1ad)]([_0x1768c2(0x1d8),_0x1768c2(0x21e),_0x1768c2(0x255)]),_0x45fd07={'model3Count':_0x5e086e?Number(_0x5e086e):0x0,'model4Count':_0x49b731?Number(_0x49b731):0x0,'drawMjCount':_0x469ef5?Number(_0x469ef5):0x0};if(!_0x5b3cda){const _0x7f600d={'fingerprint':_0x341634,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x7f600d[_0x16ba57]=_0x7f600d[_0x16ba57]+_0x76e5c;if(_0x7f600d[_0x16ba57]>_0x45fd07[_0x16ba57])throw new common_1[(_0x1768c2(0x200))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1[_0x1768c2(0x22f)][_0x1768c2(0x222)]);else return await this[_0x1768c2(0x22b)][_0x1768c2(0x1d2)](_0x7f600d),!![];}else{const {model3Count:_0x10253e,model4Count:_0x147822,drawMjCount:_0x27f49c}=_0x5b3cda;let _0x52a7d0={'model3Count':_0x10253e,'model4Count':_0x147822,'drawMjCount':_0x27f49c};const _0x99e36=Number(new Date(_0x5b3cda[_0x1768c2(0x260)])),_0x476339=this[_0x1768c2(0x23a)](_0x99e36);_0x476339?_0x52a7d0[_0x16ba57]=_0x52a7d0[_0x16ba57]+_0x76e5c:(_0x52a7d0={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x52a7d0[_0x16ba57]=_0x52a7d0[_0x16ba57]+_0x76e5c);if(_0x52a7d0[_0x16ba57]>_0x45fd07[_0x16ba57])throw new common_1['HttpException'](_0x1768c2(0x25b),common_1['HttpStatus']['PAYMENT_REQUIRED']);else return await this[_0x1768c2(0x22b)]['update']({'fingerprint':_0x341634},_0x52a7d0),!![];}}[_0x581fe7(0x23a)](_0x6d3702){const _0x1143dc=_0x581fe7,_0x2150b7=new Date(),_0x53afc8=new Date(_0x2150b7[_0x1143dc(0x1e6)](),_0x2150b7[_0x1143dc(0x1be)](),_0x2150b7[_0x1143dc(0x1b4)]());return _0x6d3702>=_0x53afc8;}async['deductFromBalance'](_0x4a4ee3,_0x189538,_0x4d3611,_0x31b681=0x0){const _0x1c417a=_0x581fe7,_0xe17017=await this[_0x1c417a(0x24e)][_0x1c417a(0x231)]({'where':{'userId':_0x4a4ee3}});if(!_0xe17017)throw new common_1[(_0x1c417a(0x200))](_0x1c417a(0x25d),common_1[_0x1c417a(0x22f)][_0x1c417a(0x1cd)]);const _0x3952a9=_0x189538===_0x1c417a(0x1c9)?'memberModel3Count':_0x189538==='model4'?_0x1c417a(0x241):_0x189538==='mjDraw'?_0x1c417a(0x219):null,_0x1ed737=_0x189538==='model3'?_0x1c417a(0x240):_0x189538==='model4'?_0x1c417a(0x256):_0x189538===_0x1c417a(0x1eb)?_0x1c417a(0x262):null,_0x5c021f=_0xe17017[_0x1c417a(0x250)]&&_0xe17017[_0x3952a9]<_0x4d3611?_0x1ed737:_0xe17017[_0x1c417a(0x250)]?_0x3952a9:_0x1ed737;let _0x585b50=null;_0x5c021f[_0x1c417a(0x1a7)](_0x1c417a(0x1ef))&&(_0x585b50=_0x1c417a(0x21c));_0x5c021f['includes']('odel4')&&(_0x585b50=_0x1c417a(0x21a));_0x5c021f[_0x1c417a(0x1a7)](_0x1c417a(0x1bd))&&(_0x585b50='useDrawMjToken');const _0x5ca4c8={[_0x5c021f]:_0xe17017[_0x5c021f]-_0x4d3611<0x0?0x0:_0xe17017[_0x5c021f]-_0x4d3611,[_0x585b50]:_0xe17017[_0x585b50]+_0x31b681};_0x585b50===_0x1c417a(0x21c)&&(_0x5ca4c8[_0x1c417a(0x1c2)]=_0xe17017[_0x1c417a(0x1c2)]+_0x4d3611),_0x585b50===_0x1c417a(0x21a)&&(_0x5ca4c8['useModel4Count']=_0xe17017[_0x1c417a(0x252)]+_0x4d3611);const _0x165ad5=await this[_0x1c417a(0x24e)][_0x1c417a(0x242)]({'userId':_0x4a4ee3},_0x5ca4c8);if(_0x165ad5[_0x1c417a(0x251)]===0x0)throw new common_1[(_0x1c417a(0x200))](_0x1c417a(0x220),common_1[_0x1c417a(0x22f)][_0x1c417a(0x1cd)]);}async['queryUserBalance'](_0x360e27){const _0xcc423d=_0x581fe7;try{const _0x30445f=await this[_0xcc423d(0x24e)]['findOne']({'where':{'userId':_0x360e27},'select':[_0xcc423d(0x250),_0xcc423d(0x240),'model4Count',_0xcc423d(0x262),_0xcc423d(0x1f9),_0xcc423d(0x241),_0xcc423d(0x219),_0xcc423d(0x1c2),_0xcc423d(0x252),_0xcc423d(0x21c),'useModel4Token','useDrawMjToken','expirationTime']});if(!_0x30445f){const _0x22d927=await this[_0xcc423d(0x1f0)](_0x360e27);if(_0x22d927)return await this[_0xcc423d(0x1d7)](_0x360e27);else throw new common_1['HttpException'](_0xcc423d(0x259),common_1[_0xcc423d(0x22f)]['BAD_REQUEST']);}return _0x30445f[_0xcc423d(0x20d)]=_0x30445f[_0xcc423d(0x250)]?_0x30445f['model3Count']+_0x30445f[_0xcc423d(0x1f9)]:_0x30445f[_0xcc423d(0x240)],_0x30445f[_0xcc423d(0x1e3)]=_0x30445f[_0xcc423d(0x250)]?_0x30445f[_0xcc423d(0x256)]+_0x30445f[_0xcc423d(0x241)]:_0x30445f[_0xcc423d(0x256)],_0x30445f[_0xcc423d(0x1a8)]=_0x30445f[_0xcc423d(0x250)]?_0x30445f[_0xcc423d(0x262)]+_0x30445f[_0xcc423d(0x219)]:_0x30445f[_0xcc423d(0x262)],_0x30445f['expirationTime']=_0x30445f[_0xcc423d(0x19f)]?(0x0,date_1[_0xcc423d(0x1aa)])(_0x30445f['expirationTime'],'YYYY-MM-DD'):null,_0x30445f;}catch(_0x5a61b0){console[_0xcc423d(0x1d1)](_0xcc423d(0x1c3),_0x5a61b0);}}async[_0x581fe7(0x22a)](_0x394bae){const _0x430b2d=_0x581fe7,{userId:_0x181f58,rechargeType:_0x55a24f,model3Count:_0x47ff1a,model4Count:_0x52989a,drawMjCount:_0x24e9da,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x394bae;if(!_0x181f58)throw new common_1[(_0x430b2d(0x200))](_0x430b2d(0x22c),common_1[_0x430b2d(0x22f)][_0x430b2d(0x1cd)]);const _0x511aa4=(0x0,utils_1[_0x430b2d(0x1f3)])();return await this['accountLogEntity'][_0x430b2d(0x1d2)]({'userId':_0x181f58,'rechargeType':_0x55a24f,'model3Count':_0x47ff1a,'model4Count':_0x52989a,'drawMjCount':_0x24e9da,'days':days,'extent':extent,'uid':_0x511aa4,'pkgName':pkgName});}async['createBaseUserBalance'](_0x1dd82b,_0x5aa817={}){const _0x1a8bc3=_0x581fe7,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x5aa817,_0x1ee37a=await this['userBalanceEntity'][_0x1a8bc3(0x231)]({'where':{'userId':_0x1dd82b}});if(_0x1ee37a)throw new common_1[(_0x1a8bc3(0x200))]('当前用户无需创建账户信息！',common_1['HttpStatus'][_0x1a8bc3(0x1cd)]);return await this['userBalanceEntity'][_0x1a8bc3(0x1d2)]({'userId':_0x1dd82b,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x581fe7(0x20c)](_0x36d973,_0x5f4b4a,_0x4f4f21=-0x1){const _0x52c752=_0x581fe7;try{const _0x2e4c06=await this[_0x52c752(0x24e)][_0x52c752(0x231)]({'where':{'userId':_0x36d973}})||await this['createBaseUserBalance'](_0x36d973);if(!_0x2e4c06)throw new common_1[(_0x52c752(0x200))](_0x52c752(0x1f8),common_1[_0x52c752(0x22f)][_0x52c752(0x1cd)]);const {model3Count:_0x44edcb,model4Count:_0x29f4ff,drawMjCount:_0x52b120,memberModel3Count:_0x42e380,memberModel4Count:_0x3595a6,memberDrawMjCount:_0x1c5f57}=_0x2e4c06;let _0x1e2ff7={};if(_0x4f4f21>0x0){const {packageId:_0x1f4399}=_0x5f4b4a;if(!_0x1f4399)throw new common_1[(_0x52c752(0x200))]('缺失当前套餐ID、充值失败！',common_1[_0x52c752(0x22f)][_0x52c752(0x1cd)]);const _0x3089df=await this[_0x52c752(0x224)]['findOne']({'where':{'id':_0x1f4399}});if(!_0x3089df)throw new common_1[(_0x52c752(0x200))](_0x52c752(0x238),common_1[_0x52c752(0x22f)]['BAD_REQUEST']);const {weight:_0x176348}=_0x3089df;if(!_0x2e4c06[_0x52c752(0x250)])_0x1e2ff7={'memberModel3Count':_0x44edcb+_0x5f4b4a['model3Count'],'memberModel4Count':_0x29f4ff+_0x5f4b4a[_0x52c752(0x256)],'memberDrawMjCount':_0x52b120+_0x5f4b4a[_0x52c752(0x262)],'expirationTime':(0x0,date_1[_0x52c752(0x1f1)])()['add'](_0x4f4f21>0x0?_0x4f4f21:0x0,_0x52c752(0x1d4))[_0x52c752(0x23e)](_0x52c752(0x1f4)),'packageId':_0x1f4399};else{const _0xff8e=await this[_0x52c752(0x224)][_0x52c752(0x231)]({'where':{'id':_0x2e4c06[_0x52c752(0x250)]}});_0x176348>=_0xff8e[_0x52c752(0x210)]&&(_0x1e2ff7={'memberModel3Count':_0x42e380+_0x5f4b4a[_0x52c752(0x240)],'memberModel4Count':_0x3595a6+_0x5f4b4a[_0x52c752(0x256)],'memberDrawMjCount':_0x1c5f57+_0x5f4b4a[_0x52c752(0x262)],'expirationTime':(0x0,date_1[_0x52c752(0x1f1)])(_0x2e4c06['expirationTime'])[_0x52c752(0x1d9)](_0x4f4f21>0x0?_0x4f4f21:0x0,_0x52c752(0x1d4))[_0x52c752(0x23e)](_0x52c752(0x1f4)),'packageId':_0x1f4399}),_0x176348<_0xff8e[_0x52c752(0x210)]&&(_0x1e2ff7={'memberModel3Count':_0x42e380+_0x5f4b4a[_0x52c752(0x240)],'memberModel4Count':_0x3595a6+_0x5f4b4a[_0x52c752(0x256)],'memberDrawMjCount':_0x1c5f57+_0x5f4b4a[_0x52c752(0x262)]});}}_0x4f4f21<=0x0&&(_0x1e2ff7={'model3Count':_0x44edcb+_0x5f4b4a[_0x52c752(0x240)],'model4Count':_0x29f4ff+_0x5f4b4a[_0x52c752(0x256)],'drawMjCount':_0x52b120+_0x5f4b4a[_0x52c752(0x262)]});const _0x504170=await this[_0x52c752(0x24e)][_0x52c752(0x242)]({'userId':_0x36d973},_0x1e2ff7);if(_0x504170['affected']===0x0)throw new common_1[(_0x52c752(0x200))](_0x36d973+_0x52c752(0x1f6),common_1['HttpStatus'][_0x52c752(0x1cd)]);}catch(_0x673d6f){console['log']('error:\x20',_0x673d6f);throw new common_1[(_0x52c752(0x200))](_0x52c752(0x20f),common_1[_0x52c752(0x22f)]['BAD_REQUEST']);}}async[_0x581fe7(0x24f)](_0x4edf07){const _0x37681f=_0x581fe7;console[_0x37681f(0x1d1)](_0x37681f(0x243),_0x4edf07);try{const {userId:_0x34c74f,goodsId:_0x580a29}=_0x4edf07,_0x330c51=await this[_0x37681f(0x224)][_0x37681f(0x231)]({'where':{'id':_0x4edf07['goodsId'],'status':0x1}});if(!_0x330c51)throw new common_1[(_0x37681f(0x200))]('非法操作、当前充值套餐暂不存在！',common_1[_0x37681f(0x22f)][_0x37681f(0x1cd)]);const {model3Count:_0x3a603e,model4Count:_0x51d3d3,drawMjCount:_0x28de0d,days:_0x3c1163,name:_0x4bf0ac}=_0x330c51,_0x3f2011={'model3Count':_0x3a603e,'model4Count':_0x51d3d3,'drawMjCount':_0x28de0d,'days':_0x3c1163,'packageId':_0x4edf07[_0x37681f(0x1c8)]};await this['addBalanceToUser'](_0x34c74f,_0x3f2011,_0x3c1163),await this[_0x37681f(0x22a)]({'userId':_0x34c74f,'rechargeType':balance_constant_1[_0x37681f(0x1fa)][_0x37681f(0x1e9)],'model3Count':_0x3a603e,'model4Count':_0x51d3d3,'drawMjCount':_0x28de0d,'pkgName':_0x4bf0ac,'days':_0x3c1163});const _0x165059=await this[_0x37681f(0x22e)][_0x37681f(0x231)]({'where':{'id':_0x34c74f}}),{invitedBy:_0x54dd11}=_0x165059;if(_0x54dd11){const _0x5d2d95=await this[_0x37681f(0x22e)]['findOne']({'where':{'inviteCode':_0x54dd11}}),_0xc0503c=await this[_0x37681f(0x225)][_0x37681f(0x231)]({'where':{'userId':_0x5d2d95['id']}});if(!_0x5d2d95)return;const {id:_0xf6d886}=_0x5d2d95,{performanceRatio:_0x4113ab}=_0xc0503c,_0x51b303={'inviterUserId':_0xf6d886,'inviteeUserId':_0x34c74f,'orderId':_0x4edf07['id'],'orderPrice':_0x4edf07[_0x37681f(0x201)],'commissionPercentage':_0x4113ab,'commissionAmount':(_0x4edf07[_0x37681f(0x201)]*_0x4113ab/0x64)[_0x37681f(0x1fd)](0x2)};await this[_0x37681f(0x1b7)][_0x37681f(0x245)](_0x51b303),await this[_0x37681f(0x1b7)][_0x37681f(0x1b1)](_0xf6d886,_0x51b303[_0x37681f(0x1fe)]);}}catch(_0x45a9b8){console[_0x37681f(0x1d1)](_0x37681f(0x1c3),_0x45a9b8);throw new common_1[(_0x37681f(0x200))](_0x37681f(0x1a3),common_1[_0x37681f(0x22f)][_0x37681f(0x1cd)]);}}async['getRechargeLog'](_0x131709,_0x3a8128){const _0x543728=_0x581fe7,{page:page=0x1,size:size=0x14}=_0x3a8128,{id:_0x27b82e}=_0x131709[_0x543728(0x257)],[_0x429731,_0x16e5b5]=await this[_0x543728(0x204)][_0x543728(0x19e)]({'where':{'userId':_0x27b82e},'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size});return _0x429731['forEach'](_0x52abf2=>{const _0x4f7159=_0x543728;_0x52abf2[_0x4f7159(0x1b6)]=_0x52abf2[_0x4f7159(0x1fc)]>0x0?_0x52abf2[_0x4f7159(0x1fc)]+'天':'永久';}),{'rows':(0x0,date_1[_0x543728(0x235)])(_0x429731),'count':_0x16e5b5};}async[_0x581fe7(0x1e1)](_0xc04470,_0x5661a8){const _0x4aed4b=_0x581fe7;try{const {page:page=0x1,size:size=0xa,userId:_0x3ef633,rechargeType:_0x249cf2,packageId:_0x3d042b}=_0x5661a8,{role:_0x3f0c11}=_0xc04470[_0x4aed4b(0x257)],_0x1589d4={};_0x249cf2&&(_0x1589d4[_0x4aed4b(0x227)]=_0x249cf2),_0x1589d4[_0x4aed4b(0x1c0)]=_0x3ef633||(0x0,typeorm_2[_0x4aed4b(0x1ca)])(0x186a0),_0x3d042b&&(_0x1589d4['packageId']={'$like':'%'+_0x3d042b+'%'});const [_0x73fcab,_0x4f64a1]=await this[_0x4aed4b(0x204)][_0x4aed4b(0x19e)]({'where':_0x1589d4,'order':{'id':_0x4aed4b(0x214)},'skip':(page-0x1)*size,'take':size}),_0x1568a0=_0x73fcab[_0x4aed4b(0x247)](_0x11b69c=>_0x11b69c[_0x4aed4b(0x1c0)]),_0x24dcff=await this[_0x4aed4b(0x22e)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x1568a0)}});return _0x73fcab[_0x4aed4b(0x1d3)](_0x22f0a9=>{const _0x3a08e6=_0x4aed4b,_0x550510=_0x24dcff[_0x3a08e6(0x249)](_0x200ebf=>_0x200ebf['id']===_0x22f0a9[_0x3a08e6(0x1c0)]);_0x22f0a9[_0x3a08e6(0x1b8)]=_0x550510===null||_0x550510===void 0x0?void 0x0:_0x550510[_0x3a08e6(0x1b8)],_0x22f0a9[_0x3a08e6(0x207)]=_0x550510===null||_0x550510===void 0x0?void 0x0:_0x550510[_0x3a08e6(0x207)],_0x22f0a9[_0x3a08e6(0x1bc)]=_0x550510===null||_0x550510===void 0x0?void 0x0:_0x550510['phone'],_0x22f0a9[_0x3a08e6(0x1f7)]=_0x550510===null||_0x550510===void 0x0?void 0x0:_0x550510[_0x3a08e6(0x1f7)],_0x22f0a9['avatar']=_0x550510===null||_0x550510===void 0x0?void 0x0:_0x550510['avatar'];}),_0x3f0c11!==_0x4aed4b(0x24b)&&_0x73fcab[_0x4aed4b(0x1d3)](_0x16f67c=>{const _0x33500e=_0x4aed4b;_0x16f67c['email']=_0x16f67c['email']?(0x0,utils_1[_0x33500e(0x1d6)])(_0x16f67c[_0x33500e(0x207)]):'',_0x16f67c[_0x33500e(0x1bc)]=_0x16f67c[_0x33500e(0x1bc)]?(0x0,utils_1[_0x33500e(0x1d6)])(_0x16f67c['phone']):'';}),{'rows':_0x73fcab,'count':_0x4f64a1};}catch(_0x190a34){console['log'](_0x4aed4b(0x1c3),_0x190a34);throw new common_1['HttpException'](_0x4aed4b(0x1b2),common_1[_0x4aed4b(0x22f)][_0x4aed4b(0x1cd)]);}}async[_0x581fe7(0x1bf)](_0x29ef9b){const _0x80b61d=_0x581fe7;return await this[_0x80b61d(0x24e)][_0x80b61d(0x249)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x29ef9b)}});}async[_0x581fe7(0x1b0)](_0x516650,_0xfad12c){const _0xb71962=_0x581fe7;return await this[_0xb71962(0x212)](_0x516650,_0xb71962(0x1eb),-_0xfad12c);}async[_0x581fe7(0x1a1)](){const _0x3b95c8=_0x581fe7,_0x13cfa8=await this[_0x3b95c8(0x22e)][_0x3b95c8(0x249)]();if(!_0x13cfa8['length'])return;const _0x20760a=await this[_0x3b95c8(0x1a0)][_0x3b95c8(0x1ad)]([_0x3b95c8(0x1f5)]);if(!_0x20760a)await this[_0x3b95c8(0x1a0)][_0x3b95c8(0x1b3)]({'settings':[{'configKey':'upgradeStatus','configVal':'1'}]});else throw new common_1[(_0x3b95c8(0x200))](_0x3b95c8(0x24c),common_1[_0x3b95c8(0x22f)]['BAD_REQUEST']);_0x13cfa8['forEach'](_0xa7375e=>{const _0xc0fc14=_0x3b95c8,{id:_0x49a0a1}=_0xa7375e;this[_0xc0fc14(0x203)]['findOne']({'where':{'userId':_0x49a0a1}})[_0xc0fc14(0x23c)](_0x159019=>{const _0x391ced=_0xc0fc14;if(!_0x159019)return;this[_0x391ced(0x1ff)](_0x49a0a1,_0x159019);});});}async[_0x581fe7(0x1ff)](_0x37fb73,_0x21e6e9){const _0x406b41=_0x581fe7,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x21e6e9,_0x5b75a5=await this[_0x406b41(0x223)]['findOne']({'where':{'userId':_0x37fb73}}),_0x3da669={'userId':_0x37fb73,'model3Count':Number(usesLeft),'model4Count':(_0x5b75a5===null||_0x5b75a5===void 0x0?void 0x0:_0x5b75a5[_0x406b41(0x1cc)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x5b75a5===null||_0x5b75a5===void 0x0?void 0x0:_0x5b75a5[_0x406b41(0x1e0)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x39c469=await this['userBalanceEntity'][_0x406b41(0x231)]({'where':{'userId':_0x37fb73}});_0x39c469?common_1[_0x406b41(0x226)][_0x406b41(0x24d)]('用户'+_0x37fb73+_0x406b41(0x1d0),_0x406b41(0x230)):this[_0x406b41(0x24e)]['save'](_0x3da669)[_0x406b41(0x23c)](_0x555bef=>{const _0x539774=_0x406b41;common_1[_0x539774(0x226)][_0x539774(0x24d)]('用户'+_0x37fb73+_0x539774(0x234),'BalanceService');})[_0x406b41(0x218)](_0x4bca3a=>{const _0x308dab=_0x406b41;console[_0x308dab(0x1d1)](_0x308dab(0x1c3),_0x4bca3a),common_1[_0x308dab(0x226)]['debug']('用户'+_0x37fb73+_0x308dab(0x228),_0x308dab(0x230));});}async[_0x581fe7(0x22d)](_0x3b6bf0){const _0x6c959f=_0x581fe7,{fingerprint:_0x358942}=_0x3b6bf0[_0x6c959f(0x23d)],{id:_0xa35196}=_0x3b6bf0[_0x6c959f(0x257)];return await this[_0x6c959f(0x20a)][_0x6c959f(0x242)]({'userId':Number(_0x358942)},{'userId':_0xa35196}),await this[_0x6c959f(0x233)][_0x6c959f(0x242)]({'userId':Number(_0x358942)},{'userId':_0xa35196}),await this['midjourneyEntity'][_0x6c959f(0x242)]({'userId':Number(_0x358942)},{'userId':_0xa35196}),0x1;}async['getVisitorCount'](_0x1a0521){const _0x388907=_0x581fe7,{fingerprint:_0x495da5}=_0x1a0521[_0x388907(0x23d)],_0x62da3e=await this[_0x388907(0x20a)][_0x388907(0x1cc)]({'where':{'userId':_0x495da5}}),_0x2c41a7=await this['chatGroupEntity']['count']({'where':{'userId':_0x495da5}}),_0x3563aa=await this[_0x388907(0x1c7)][_0x388907(0x1cc)]({'where':{'userId':_0x495da5}});return _0x62da3e||_0x2c41a7||_0x3563aa||0x0;}};function _0xad94(){const _0x3a6179=['queryUserBalance','visitorModel3Num','add','INVITE_GIFT','../midjourney/midjourney.entity','6650427sBvnOB','firstRegisterSendRank','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','decorate','useCount','getAccountLog','UserEntity','sumModel4Count','firstRegisterSendStatus','---','getFullYear','invitedGuestSendModel3Count','Repository','SCAN_PAY','40697upLGZE','mjDraw','registerSendModel4Count','typeorm','validateBalance','odel3','createBaseUserBalance','default','function','createRandomUid','YYYY-MM-DD\x20HH:mm:ss','upgradeStatus','充值失败','status','查询用户账户信息失败！','memberModel3Count','RechargeType','validateVisitorBalance','days','toFixed','commissionAmount','writeOldBalanceToNewTable','HttpException','total','BalanceEntity','balanceEntity','accountLogEntity','../globalConfig/globalConfig.service','design:paramtypes','email','invitedGuestSendModel4Count','../chatLog/chatLog.entity','chatLogEntity','../../common/constants/balance.constant','addBalanceToUser','sumModel3Count','inviteSendStatus','用户充值失败！','weight','SalesUsersEntity','deductFromBalance','../crami/cramiPackage.entity','DESC','model4','firstRregisterSendModel3Count','CramiPackageEntity','catch','memberDrawMjCount','useModel4Token','../chatgpt/whiteList.entity','useModel3Token','3680NAJbMn','visitorModel4Num','addBalanceToNewUser','消费余额失败！','@nestjs/typeorm','PAYMENT_REQUIRED','whiteListEntity','cramiPackageEntity','salesUsersEntity','Logger','rechargeType','旧账户信息迁移失败','inviteGiveSendModel4Count','saveRecordRechargeLog','fingerprintLogEntity','当前用户不存在,记录充值日志异常','inheritVisitorData','userEntity','HttpStatus','BalanceService','findOne','./fingerprint.entity','chatGroupEntity','旧账户信息迁移成功','formatCreateOrUpdateDate','registerSendDrawMjCount','REG_GIFT','当前套餐不存在！','../../common/utils/date','isUpdatedToday','2208968sUCMsA','then','headers','format','object','model3Count','memberModel4Count','update','充值的工单信息:','4645adHigD','createSalesRecords','vxNumber','map','registerSendStatus','find','inviteGiveSendDrawMjCount','super','您已经升级过了、请勿重复操作！','debug','userBalanceEntity','addBalanceToOrder','packageId','affected','useModel4Count','REFER_GIFT','WhiteListEntity','visitorMJNum','model4Count','user','length','查询当前用户余额失败！','inviteGiveSendModel3Count','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','../../common/utils','缺失当前用户账户记录！','SalesService','5373624jomMVS','updatedAt','./accountLog.entity','drawMjCount','ConfigEntity','AccountLogEntity','FingerprintLogEntity','findAndCount','expirationTime','globalConfigService','upgradeBalance','invitedGuestSendDrawMjCount','充值失败！','@nestjs/common','GlobalConfigService','../sales/sales.service','includes','sumDrawMjCount','registerSendModel3Count','formatDate','InjectRepository','ChatGroupEntity','getConfigs','metadata','getOwnPropertyDescriptor','refundMjBalance','saveCommissionAmount','查询用户账户失败！','setConfig','getDate','defineProperty','expireDateCn','salesService','username','../chatGroup/chatGroup.entity','ChatLogEntity','isInteger','phone','MjCount','getMonth','queryUserBalanceByIds','userId','4254984oXpQXC','useModel3Count','error:\x20','./userBalance.entity','282BeCYGG','configVal','midjourneyEntity','goodsId','model3','LessThan','firstRregisterSendDrawMjCount','count','BAD_REQUEST','>\x20或购买专属套餐\x20！','UserBalanceService','账户信息已经存在、迁移无效','log','save','forEach','day','configEntity','hideString'];_0xad94=function(){return _0x3a6179;};return _0xad94();}UserBalanceService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x581fe7(0x1ab)])(balance_entity_1[_0x581fe7(0x202)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1['UserBalanceEntity'])),__param(0x2,(0x0,typeorm_1[_0x581fe7(0x1ab)])(accountLog_entity_1[_0x581fe7(0x264)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x581fe7(0x217)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x581fe7(0x263)])),__param(0x5,(0x0,typeorm_1[_0x581fe7(0x1ab)])(user_entity_1[_0x581fe7(0x1e2)])),__param(0x6,(0x0,typeorm_1[_0x581fe7(0x1ab)])(salesUsers_entity_1[_0x581fe7(0x211)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1[_0x581fe7(0x254)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0x581fe7(0x265)])),__param(0x9,(0x0,typeorm_1[_0x581fe7(0x1ab)])(chatGroup_entity_1[_0x581fe7(0x1ac)])),__param(0xa,(0x0,typeorm_1[_0x581fe7(0x1ab)])(chatLog_entity_1[_0x581fe7(0x1ba)])),__param(0xb,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1['MidjourneyEntity'])),__metadata(_0x581fe7(0x206),[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x581fe7(0x1e8)],typeorm_2[_0x581fe7(0x1e8)],typeorm_2[_0x581fe7(0x1e8)],typeorm_2[_0x581fe7(0x1e8)],typeorm_2[_0x581fe7(0x1e8)],typeorm_2['Repository'],typeorm_2[_0x581fe7(0x1e8)],typeorm_2['Repository'],typeorm_2[_0x581fe7(0x1e8)],typeorm_2['Repository'],sales_service_1[_0x581fe7(0x25e)],globalConfig_service_1[_0x581fe7(0x1a5)]])],UserBalanceService),exports[_0x581fe7(0x1cf)]=UserBalanceService;