'use strict';const _0x388870=_0x3b4e;function _0x3b4e(_0x3334d3,_0x365a49){const _0x45ba5e=_0x45ba();return _0x3b4e=function(_0x3b4e63,_0x5243e4){_0x3b4e63=_0x3b4e63-0xcb;let _0xce5db9=_0x45ba5e[_0x3b4e63];return _0xce5db9;},_0x3b4e(_0x3334d3,_0x365a49);}function _0x45ba(){const _0x4bea5a=['expirationTime','CramiPackageEntity','saveRecordRechargeLog','debug','9331194cJqqWa','firstRegisterSendStatus','您已经升级过了、请勿重复操作！','../globalConfig/config.entity','chatLogEntity','commissionAmount','metadata','createBaseUserBalance','days','avatar','userEntity','visitorMJNum','validateBalance','whiteListEntity','format','hideString','invitedGuestSendModel3Count','InjectRepository','includes','headers','1033840TroMWZ','salesUsersEntity','HttpException','createSalesRecords','inviteGiveSendModel3Count','inheritVisitorData','SCAN_PAY','UserEntity','invitedGuestSendModel4Count','sumModel4Count','DESC','WhiteListEntity','log','./accountLog.entity','userBalanceEntity','then','findOne','odel3','旧账户信息迁移成功','save','../../common/utils/date','packageId','RechargeType','catch','map','object','super','useModel4Token','configEntity','用户充值失败！','error:\x20','model4Count','getConfigs','saveCommissionAmount','ChatLogEntity','MjCount','getVisitorCount','goodsId','../user/user.entity','default','167870cJZVxJ','606003KLJJHF','inviteGiveSendModel4Count','expireDateCn','registerSendDrawMjCount','day','findAndCount','isInteger','registerSendModel4Count','当前用户无需创建账户信息！','addBalanceToOrder','odel4','sumModel3Count','../../common/constants/balance.constant','HttpStatus','../midjourney/midjourney.entity','typeorm','setConfig','缺失当前用户账户记录！','salesService','注册赠送失败,请联系管理员！','model3Count','useDrawMjToken','./fingerprint.entity','mjDraw','查询用户账户信息失败！','GlobalConfigService','955100gcKxUw','useCount','getAccountLog','---','./userBalance.entity','accountLogEntity','registerSendModel3Count','MidjourneyEntity','9vKdzoN','toFixed','writeOldBalanceToNewTable','addBalanceToNewUser','Logger','affected','weight','midjourneyEntity','AccountLogEntity','registerSendStatus','defineProperty','memberModel3Count','getOwnPropertyDescriptor','balanceEntity','BAD_REQUEST','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','firstRregisterSendModel4Count','Repository','cramiPackageEntity','total','inviteSendStatus','fingerprintLogEntity','globalConfigService','user','../../common/utils','firstRegisterSendRank','@nestjs/typeorm','../sales/sales.service','账户信息已经存在、迁移无效','__metadata','status','../chatLog/chatLog.entity','充值失败！','firstRregisterSendDrawMjCount','validateVisitorBalance','FingerprintLogEntity','upgradeStatus','getFullYear','formatCreateOrUpdateDate','update','BalanceEntity','memberDrawMjCount','phone','../chatgpt/whiteList.entity','configVal','INVITE_GIFT','userId','./balance.entity','旧账户信息迁移失败','invitedGuestSendDrawMjCount','@nestjs/common','find','消费余额失败！','chatGroupEntity','forEach','../globalConfig/globalConfig.service','LessThan','8164585jkKnLz','263256LtCVHq','PAYMENT_REQUIRED','formatDate','77QwBCgD','SalesUsersEntity','../crami/cramiPackage.entity','非法操作、当前充值套餐暂不存在！','vxNumber','useModel4Count','ChatGroupEntity','firstRregisterSendModel3Count','refundMjBalance','UserBalanceService','UserBalanceEntity','YYYY-MM-DD','useModel3Token','12gpQCEZ','inviteGiveSendDrawMjCount','useModel3Count','visitorModel4Num','model3','getMonth','BalanceService','7iVXfMp','memberModel4Count','deductFromBalance','design:paramtypes','drawMjCount','email','../chatGroup/chatGroup.entity','sumDrawMjCount','username','count','function','addBalanceToUser','getDate','decorate','length','model4','缺失当前套餐ID、充值失败！'];_0x45ba=function(){return _0x4bea5a;};return _0x45ba();}(function(_0x53dcff,_0xbf889e){const _0x20bf49=_0x3b4e,_0x4d86c9=_0x53dcff();while(!![]){try{const _0x2b06d5=-parseInt(_0x20bf49(0xf2))/0x1+-parseInt(_0x20bf49(0x174))/0x2+parseInt(_0x20bf49(0xd8))/0x3*(-parseInt(_0x20bf49(0x144))/0x4)+parseInt(_0x20bf49(0x133))/0x5+parseInt(_0x20bf49(0x160))/0x6*(parseInt(_0x20bf49(0x14b))/0x7)+-parseInt(_0x20bf49(0x134))/0x8*(parseInt(_0x20bf49(0xfa))/0x9)+-parseInt(_0x20bf49(0xd7))/0xa*(parseInt(_0x20bf49(0x137))/0xb);if(_0x2b06d5===_0xbf889e)break;else _0x4d86c9['push'](_0x4d86c9['shift']());}catch(_0x161251){_0x4d86c9['push'](_0x4d86c9['shift']());}}}(_0x45ba,0xea4bd));var __decorate=this&&this['__decorate']||function(_0x4c9468,_0x507c87,_0x268404,_0xd4b3e7){const _0x1fcf6d=_0x3b4e;var _0x31d8cd=arguments[_0x1fcf6d(0x159)],_0x254012=_0x31d8cd<0x3?_0x507c87:_0xd4b3e7===null?_0xd4b3e7=Object[_0x1fcf6d(0x106)](_0x507c87,_0x268404):_0xd4b3e7,_0x2da179;if(typeof Reflect===_0x1fcf6d(0x18d)&&typeof Reflect[_0x1fcf6d(0x158)]===_0x1fcf6d(0x155))_0x254012=Reflect[_0x1fcf6d(0x158)](_0x4c9468,_0x507c87,_0x268404,_0xd4b3e7);else{for(var _0x220204=_0x4c9468['length']-0x1;_0x220204>=0x0;_0x220204--)if(_0x2da179=_0x4c9468[_0x220204])_0x254012=(_0x31d8cd<0x3?_0x2da179(_0x254012):_0x31d8cd>0x3?_0x2da179(_0x507c87,_0x268404,_0x254012):_0x2da179(_0x507c87,_0x268404))||_0x254012;}return _0x31d8cd>0x3&&_0x254012&&Object[_0x1fcf6d(0x104)](_0x507c87,_0x268404,_0x254012),_0x254012;},__metadata=this&&this[_0x388870(0x117)]||function(_0x81849,_0x3317ad){const _0x3a484f=_0x388870;if(typeof Reflect==='object'&&typeof Reflect[_0x3a484f(0x166)]===_0x3a484f(0x155))return Reflect[_0x3a484f(0x166)](_0x81849,_0x3317ad);},__param=this&&this['__param']||function(_0x19d5a0,_0x2e70a9){return function(_0x5c5f52,_0x59b1a9){_0x2e70a9(_0x5c5f52,_0x59b1a9,_0x19d5a0);};};Object[_0x388870(0x104)](exports,'__esModule',{'value':!![]}),exports['UserBalanceService']=void 0x0;const globalConfig_service_1=require(_0x388870(0x131)),typeorm_1=require(_0x388870(0x114)),balance_entity_1=require(_0x388870(0x129)),common_1=require(_0x388870(0x12c)),typeorm_2=require(_0x388870(0xe7)),balance_constant_1=require(_0x388870(0xe4)),accountLog_entity_1=require(_0x388870(0x181)),utils_1=require(_0x388870(0x112)),config_entity_1=require(_0x388870(0x163)),cramiPackage_entity_1=require(_0x388870(0x139)),userBalance_entity_1=require(_0x388870(0xf6)),date_1=require(_0x388870(0x188)),user_entity_1=require(_0x388870(0xd5)),salesUsers_entity_1=require('../sales/salesUsers.entity'),sales_service_1=require(_0x388870(0x115)),whiteList_entity_1=require(_0x388870(0x125)),fingerprint_entity_1=require(_0x388870(0xee)),chatLog_entity_1=require(_0x388870(0x119)),chatGroup_entity_1=require(_0x388870(0x151)),midjourney_entity_1=require(_0x388870(0xe6));let UserBalanceService=class UserBalanceService{constructor(_0x39baa5,_0x297021,_0x3f46a3,_0x297e77,_0xea5e67,_0xe53a84,_0x17ba04,_0x2e2c0a,_0x4ea09b,_0x3ceb38,_0x54b939,_0x1a0b88,_0x322082,_0x44c42f){const _0x236c2b=_0x388870;this[_0x236c2b(0x107)]=_0x39baa5,this[_0x236c2b(0x182)]=_0x297021,this[_0x236c2b(0xf7)]=_0x3f46a3,this[_0x236c2b(0x10c)]=_0x297e77,this[_0x236c2b(0xcb)]=_0xea5e67,this['userEntity']=_0xe53a84,this[_0x236c2b(0x175)]=_0x17ba04,this['whiteListEntity']=_0x2e2c0a,this[_0x236c2b(0x10f)]=_0x4ea09b,this[_0x236c2b(0x12f)]=_0x3ceb38,this[_0x236c2b(0x164)]=_0x54b939,this[_0x236c2b(0x101)]=_0x1a0b88,this[_0x236c2b(0xea)]=_0x322082,this[_0x236c2b(0x110)]=_0x44c42f;}async[_0x388870(0xfd)](_0x1a4869,_0xd6d504){const _0x142f39=_0x388870;try{const _0x1a9071=await this[_0x142f39(0xcb)][_0x142f39(0x12d)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x142f39(0x103),_0x142f39(0xf8),_0x142f39(0xdf),_0x142f39(0xdb),_0x142f39(0x161),'firstRegisterSendRank',_0x142f39(0x13e),'firstRregisterSendModel4Count','firstRregisterSendDrawMjCount',_0x142f39(0x10e),'inviteGiveSendModel3Count','inviteGiveSendModel4Count',_0x142f39(0x145),_0x142f39(0x170),'invitedGuestSendDrawMjCount',_0x142f39(0x17c)])}}),_0x52f857=_0x1a9071['reduce']((_0x5c0ff7,_0x38f5a9)=>{const _0x145952=_0x142f39,_0x36e78d=Number(_0x38f5a9[_0x145952(0x126)]),_0x56d190=Number[_0x145952(0xde)](_0x36e78d)&&_0x36e78d>0x0?_0x36e78d:0x0;return _0x5c0ff7[_0x38f5a9['configKey']]=_0x56d190,_0x5c0ff7;},{});let _0x7b69c7=0x0,_0x311ca9=0x0,_0x334db2=0x0;_0x52f857[_0x142f39(0x103)]===0x1&&(_0x7b69c7=_0x7b69c7+_0x52f857[_0x142f39(0xf8)],_0x311ca9=_0x311ca9+_0x52f857[_0x142f39(0xdf)],_0x334db2=_0x334db2+_0x52f857[_0x142f39(0xdb)]),_0x52f857[_0x142f39(0x103)]===0x1&&_0x52f857[_0x142f39(0x161)]===0x1&&_0x1a4869<=_0x52f857[_0x142f39(0x113)]&&(_0x7b69c7=_0x7b69c7+_0x52f857[_0x142f39(0x13e)],_0x311ca9=_0x311ca9+_0x52f857[_0x142f39(0x10a)],_0x334db2=_0x334db2+_0x52f857[_0x142f39(0x11b)]),await this[_0x142f39(0x15e)]({'userId':_0x1a4869,'rechargeType':balance_constant_1[_0x142f39(0x18a)]['REG_GIFT'],'model3Count':_0x7b69c7,'drawMjCount':_0x334db2,'model4Count':_0x311ca9}),_0xd6d504&&(Number(_0x52f857[_0x142f39(0x10e)])===0x1&&(_0x7b69c7=_0x7b69c7+Number(_0x52f857[_0x142f39(0x170)]),_0x311ca9=_0x311ca9+Number(_0x52f857[_0x142f39(0x17c)]),_0x334db2=_0x334db2+Number(_0x52f857[_0x142f39(0x12b)]),await this[_0x142f39(0x15e)]({'userId':_0x1a4869,'rechargeType':balance_constant_1['RechargeType'][_0x142f39(0x127)],'model3Count':_0x52f857[_0x142f39(0x170)],'model4Count':_0x52f857[_0x142f39(0x17c)],'drawMjCount':_0x52f857[_0x142f39(0x12b)]}),await this[_0x142f39(0x156)](_0xd6d504,{'model3Count':_0x52f857['inviteGiveSendModel3Count'],'model4Count':_0x52f857[_0x142f39(0xd9)],'drawMjCount':_0x52f857['inviteGiveSendDrawMjCount']}),await this['saveRecordRechargeLog']({'userId':_0xd6d504,'rechargeType':balance_constant_1[_0x142f39(0x18a)]['REFER_GIFT'],'model3Count':_0x52f857[_0x142f39(0x178)],'model4Count':_0x52f857[_0x142f39(0xd9)],'drawMjCount':_0x52f857[_0x142f39(0x145)]}))),await this[_0x142f39(0x182)]['save']({'userId':_0x1a4869,'model3Count':_0x7b69c7,'model4Count':_0x311ca9,'drawMjCount':_0x334db2,'useTokens':0x0});}catch(_0x5d70f0){console[_0x142f39(0x180)](_0x142f39(0xcd),_0x5d70f0);throw new common_1[(_0x142f39(0x176))](_0x142f39(0xeb),common_1['HttpStatus'][_0x142f39(0x108)]);}}async[_0x388870(0x16c)](_0x557841,_0x13807c,_0xfadb7d){const _0x532b10=_0x388870,{id:_0x4c86df,role:_0x4249d9}=_0x557841['user'];let _0x1b6ebc=await this[_0x532b10(0x182)][_0x532b10(0x184)]({'where':{'userId':_0x4c86df}});!_0x1b6ebc&&(_0x1b6ebc=await this[_0x532b10(0x167)](_0x4c86df));if(_0x4249d9==='visitor')return this['validateVisitorBalance'](_0x557841,_0x13807c,_0xfadb7d);const _0x5d398c=await this['configEntity']['findOne']({'where':{'configKey':_0x532b10(0x13b)}}),_0x3bd69c=_0x5d398c?_0x5d398c[_0x532b10(0x126)]:_0x532b10(0xf5),_0x3243d5=_0x13807c===_0x532b10(0x148)?'memberModel3Count':_0x13807c===_0x532b10(0x15a)?_0x532b10(0x14c):_0x13807c===_0x532b10(0xef)?_0x532b10(0x123):null,_0x2b9545=_0x13807c==='model3'?_0x532b10(0xec):_0x13807c==='model4'?_0x532b10(0xce):_0x13807c==='mjDraw'?'drawMjCount':null;if(_0x1b6ebc['packageId']&&_0x1b6ebc[_0x3243d5]<_0xfadb7d){if(_0x1b6ebc[_0x2b9545]<_0xfadb7d)throw new common_1[(_0x532b10(0x176))](_0x532b10(0x109)+_0x3bd69c+'>\x20或购买专属套餐\x20！',common_1[_0x532b10(0xe5)][_0x532b10(0x135)]);}if(!_0x1b6ebc['packageId']&&_0x1b6ebc[_0x2b9545]<_0xfadb7d)throw new common_1[(_0x532b10(0x176))](_0x532b10(0x109)+_0x3bd69c+'>\x20或购买专属套餐\x20！',common_1[_0x532b10(0xe5)][_0x532b10(0x135)]);return _0x1b6ebc;}async[_0x388870(0x11c)](_0xc28d0e,_0x2cb2f8,_0x256c95){const _0x291afa=_0x388870,{id:_0x31bffd}=_0xc28d0e[_0x291afa(0x111)],_0x1f0510=_0x2cb2f8===_0x291afa(0x148)?_0x291afa(0xec):_0x2cb2f8===_0x291afa(0x15a)?_0x291afa(0xce):_0x2cb2f8===_0x291afa(0xef)?_0x291afa(0x14f):null,_0x3086c7=new Date(),_0x5710ef=await this[_0x291afa(0x10f)][_0x291afa(0x184)]({'where':{'fingerprint':_0x31bffd}}),{visitorModel3Num:_0x3338cc,visitorModel4Num:_0x170cf1,visitorMJNum:_0x297670}=await this[_0x291afa(0x110)][_0x291afa(0xcf)](['visitorModel3Num',_0x291afa(0x147),_0x291afa(0x16b)]),_0x4595bd={'model3Count':_0x3338cc?Number(_0x3338cc):0x0,'model4Count':_0x170cf1?Number(_0x170cf1):0x0,'drawMjCount':_0x297670?Number(_0x297670):0x0};if(!_0x5710ef){const _0x1f3ee4={'fingerprint':_0x31bffd,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x1f3ee4[_0x1f0510]=_0x1f3ee4[_0x1f0510]+_0x256c95;if(_0x1f3ee4[_0x1f0510]>_0x4595bd[_0x1f0510])throw new common_1[(_0x291afa(0x176))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1[_0x291afa(0xe5)][_0x291afa(0x135)]);else return await this[_0x291afa(0x10f)]['save'](_0x1f3ee4),!![];}else{const {model3Count:_0x5c34f5,model4Count:_0x4ca855,drawMjCount:_0x20d161}=_0x5710ef;let _0x43ce2e={'model3Count':_0x5c34f5,'model4Count':_0x4ca855,'drawMjCount':_0x20d161};const _0x524657=Number(new Date(_0x5710ef['updatedAt'])),_0x5dcf68=this['isUpdatedToday'](_0x524657);_0x5dcf68?_0x43ce2e[_0x1f0510]=_0x43ce2e[_0x1f0510]+_0x256c95:(_0x43ce2e={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x43ce2e[_0x1f0510]=_0x43ce2e[_0x1f0510]+_0x256c95);if(_0x43ce2e[_0x1f0510]>_0x4595bd[_0x1f0510])throw new common_1[(_0x291afa(0x176))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1[_0x291afa(0xe5)]['PAYMENT_REQUIRED']);else return await this[_0x291afa(0x10f)][_0x291afa(0x121)]({'fingerprint':_0x31bffd},_0x43ce2e),!![];}}['isUpdatedToday'](_0x193748){const _0x957cf1=_0x388870,_0x16b131=new Date(),_0x58999a=new Date(_0x16b131[_0x957cf1(0x11f)](),_0x16b131[_0x957cf1(0x149)](),_0x16b131[_0x957cf1(0x157)]());return _0x193748>=_0x58999a;}async[_0x388870(0x14d)](_0x3dad2b,_0x30cbbf,_0x7f82f6,_0xd6cee0=0x0){const _0x270b95=_0x388870,_0x43971f=await this['userBalanceEntity'][_0x270b95(0x184)]({'where':{'userId':_0x3dad2b}});if(!_0x43971f)throw new common_1[(_0x270b95(0x176))](_0x270b95(0xe9),common_1[_0x270b95(0xe5)][_0x270b95(0x108)]);const _0x4dd3c9=_0x30cbbf===_0x270b95(0x148)?_0x270b95(0x105):_0x30cbbf===_0x270b95(0x15a)?_0x270b95(0x14c):_0x30cbbf===_0x270b95(0xef)?'memberDrawMjCount':null,_0x46b0c4=_0x30cbbf==='model3'?_0x270b95(0xec):_0x30cbbf===_0x270b95(0x15a)?'model4Count':_0x30cbbf===_0x270b95(0xef)?'drawMjCount':null,_0x5efbba=_0x43971f[_0x270b95(0x189)]&&_0x43971f[_0x4dd3c9]<_0x7f82f6?_0x46b0c4:_0x43971f['packageId']?_0x4dd3c9:_0x46b0c4;let _0x1307f1=null;_0x5efbba[_0x270b95(0x172)](_0x270b95(0x185))&&(_0x1307f1=_0x270b95(0x143));_0x5efbba[_0x270b95(0x172)](_0x270b95(0xe2))&&(_0x1307f1=_0x270b95(0x18f));_0x5efbba[_0x270b95(0x172)](_0x270b95(0xd2))&&(_0x1307f1=_0x270b95(0xed));const _0x3bc2e2={[_0x5efbba]:_0x43971f[_0x5efbba]-_0x7f82f6<0x0?0x0:_0x43971f[_0x5efbba]-_0x7f82f6,[_0x1307f1]:_0x43971f[_0x1307f1]+_0xd6cee0};_0x1307f1===_0x270b95(0x143)&&(_0x3bc2e2[_0x270b95(0x146)]=_0x43971f[_0x270b95(0x146)]+_0x7f82f6),_0x1307f1===_0x270b95(0x18f)&&(_0x3bc2e2['useModel4Count']=_0x43971f[_0x270b95(0x13c)]+_0x7f82f6);const _0x5acebf=await this[_0x270b95(0x182)][_0x270b95(0x121)]({'userId':_0x3dad2b},_0x3bc2e2);if(_0x5acebf['affected']===0x0)throw new common_1[(_0x270b95(0x176))](_0x270b95(0x12e),common_1[_0x270b95(0xe5)][_0x270b95(0x108)]);}async['queryUserBalance'](_0x43b6ab){const _0x333cd8=_0x388870;try{const _0x223e70=await this[_0x333cd8(0x182)][_0x333cd8(0x184)]({'where':{'userId':_0x43b6ab},'select':[_0x333cd8(0x189),'model3Count','model4Count',_0x333cd8(0x14f),_0x333cd8(0x105),_0x333cd8(0x14c),_0x333cd8(0x123),_0x333cd8(0x146),_0x333cd8(0x13c),_0x333cd8(0x143),'useModel4Token','useDrawMjToken',_0x333cd8(0x15c)]});if(!_0x223e70){const _0x13368f=await this[_0x333cd8(0x167)](_0x43b6ab);if(_0x13368f)return await this['queryUserBalance'](_0x43b6ab);else throw new common_1['HttpException']('查询当前用户余额失败！',common_1[_0x333cd8(0xe5)][_0x333cd8(0x108)]);}return _0x223e70[_0x333cd8(0xe3)]=_0x223e70[_0x333cd8(0x189)]?_0x223e70[_0x333cd8(0xec)]+_0x223e70[_0x333cd8(0x105)]:_0x223e70['model3Count'],_0x223e70[_0x333cd8(0x17d)]=_0x223e70[_0x333cd8(0x189)]?_0x223e70[_0x333cd8(0xce)]+_0x223e70['memberModel4Count']:_0x223e70[_0x333cd8(0xce)],_0x223e70[_0x333cd8(0x152)]=_0x223e70[_0x333cd8(0x189)]?_0x223e70[_0x333cd8(0x14f)]+_0x223e70[_0x333cd8(0x123)]:_0x223e70[_0x333cd8(0x14f)],_0x223e70[_0x333cd8(0x15c)]=_0x223e70[_0x333cd8(0x15c)]?(0x0,date_1[_0x333cd8(0x136)])(_0x223e70[_0x333cd8(0x15c)],_0x333cd8(0x142)):null,_0x223e70;}catch(_0x58b8ef){console['log']('error:\x20',_0x58b8ef);}}async['saveRecordRechargeLog'](_0x5effc8){const _0x87350e=_0x388870,{userId:_0xbfcd17,rechargeType:_0x517611,model3Count:_0x33c750,model4Count:_0x5943d0,drawMjCount:_0x167a56,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x5effc8;if(!_0xbfcd17)throw new common_1[(_0x87350e(0x176))]('当前用户不存在,记录充值日志异常',common_1['HttpStatus'][_0x87350e(0x108)]);const _0x50c1fc=(0x0,utils_1['createRandomUid'])();return await this['accountLogEntity'][_0x87350e(0x187)]({'userId':_0xbfcd17,'rechargeType':_0x517611,'model3Count':_0x33c750,'model4Count':_0x5943d0,'drawMjCount':_0x167a56,'days':days,'extent':extent,'uid':_0x50c1fc,'pkgName':pkgName});}async[_0x388870(0x167)](_0x26242e,_0x135b1d={}){const _0x163427=_0x388870,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x135b1d,_0x25e80a=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x26242e}});if(_0x25e80a)throw new common_1[(_0x163427(0x176))](_0x163427(0xe0),common_1[_0x163427(0xe5)][_0x163427(0x108)]);return await this[_0x163427(0x182)][_0x163427(0x187)]({'userId':_0x26242e,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x388870(0x156)](_0x44ec23,_0x5145ce,_0x501ebf=-0x1){const _0x2b1465=_0x388870;try{const _0x5c6c75=await this[_0x2b1465(0x182)][_0x2b1465(0x184)]({'where':{'userId':_0x44ec23}})||await this[_0x2b1465(0x167)](_0x44ec23);if(!_0x5c6c75)throw new common_1['HttpException'](_0x2b1465(0xf0),common_1[_0x2b1465(0xe5)]['BAD_REQUEST']);const {model3Count:_0x1b99e8,model4Count:_0x55e1b6,drawMjCount:_0x4c7f52,memberModel3Count:_0x8ee15c,memberModel4Count:_0x5cbf7a,memberDrawMjCount:_0x4c5ef9}=_0x5c6c75;let _0x30ab50={};if(_0x501ebf>0x0){const {packageId:_0x329881}=_0x5145ce;if(!_0x329881)throw new common_1['HttpException'](_0x2b1465(0x15b),common_1['HttpStatus']['BAD_REQUEST']);const _0x457fed=await this[_0x2b1465(0x10c)]['findOne']({'where':{'id':_0x329881}});if(!_0x457fed)throw new common_1[(_0x2b1465(0x176))]('当前套餐不存在！',common_1[_0x2b1465(0xe5)]['BAD_REQUEST']);const {weight:_0x4672ab}=_0x457fed;if(!_0x5c6c75[_0x2b1465(0x189)])_0x30ab50={'memberModel3Count':_0x1b99e8+_0x5145ce[_0x2b1465(0xec)],'memberModel4Count':_0x55e1b6+_0x5145ce[_0x2b1465(0xce)],'memberDrawMjCount':_0x4c7f52+_0x5145ce[_0x2b1465(0x14f)],'expirationTime':(0x0,date_1[_0x2b1465(0xd6)])()['add'](_0x501ebf>0x0?_0x501ebf:0x0,_0x2b1465(0xdc))[_0x2b1465(0x16e)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x329881};else{const _0x3f35ab=await this[_0x2b1465(0x10c)][_0x2b1465(0x184)]({'where':{'id':_0x5c6c75[_0x2b1465(0x189)]}});_0x4672ab>=_0x3f35ab[_0x2b1465(0x100)]&&(_0x30ab50={'memberModel3Count':_0x8ee15c+_0x5145ce[_0x2b1465(0xec)],'memberModel4Count':_0x5cbf7a+_0x5145ce[_0x2b1465(0xce)],'memberDrawMjCount':_0x4c5ef9+_0x5145ce[_0x2b1465(0x14f)],'expirationTime':(0x0,date_1[_0x2b1465(0xd6)])(_0x5c6c75['expirationTime'])['add'](_0x501ebf>0x0?_0x501ebf:0x0,_0x2b1465(0xdc))['format']('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x329881}),_0x4672ab<_0x3f35ab[_0x2b1465(0x100)]&&(_0x30ab50={'memberModel3Count':_0x8ee15c+_0x5145ce[_0x2b1465(0xec)],'memberModel4Count':_0x5cbf7a+_0x5145ce[_0x2b1465(0xce)],'memberDrawMjCount':_0x4c5ef9+_0x5145ce['drawMjCount']});}}_0x501ebf<=0x0&&(_0x30ab50={'model3Count':_0x1b99e8+_0x5145ce[_0x2b1465(0xec)],'model4Count':_0x55e1b6+_0x5145ce['model4Count'],'drawMjCount':_0x4c7f52+_0x5145ce[_0x2b1465(0x14f)]});const _0xe4199f=await this[_0x2b1465(0x182)][_0x2b1465(0x121)]({'userId':_0x44ec23},_0x30ab50);if(_0xe4199f[_0x2b1465(0xff)]===0x0)throw new common_1[(_0x2b1465(0x176))](_0x44ec23+'充值失败',common_1['HttpStatus'][_0x2b1465(0x108)]);}catch(_0x3b2737){console[_0x2b1465(0x180)](_0x2b1465(0xcd),_0x3b2737);throw new common_1['HttpException'](_0x2b1465(0xcc),common_1[_0x2b1465(0xe5)][_0x2b1465(0x108)]);}}async[_0x388870(0xe1)](_0x503475){const _0x1223a6=_0x388870;console['log']('充值的工单信息:',_0x503475);try{const {userId:_0x22d881,goodsId:_0x3ed53d}=_0x503475,_0x3e47ed=await this[_0x1223a6(0x10c)][_0x1223a6(0x184)]({'where':{'id':_0x503475[_0x1223a6(0xd4)],'status':0x1}});if(!_0x3e47ed)throw new common_1[(_0x1223a6(0x176))](_0x1223a6(0x13a),common_1[_0x1223a6(0xe5)]['BAD_REQUEST']);const {model3Count:_0x270aa3,model4Count:_0x372e9e,drawMjCount:_0x2f72a2,days:_0x58bbe7,name:_0x1b687b}=_0x3e47ed,_0x2a44c0={'model3Count':_0x270aa3,'model4Count':_0x372e9e,'drawMjCount':_0x2f72a2,'days':_0x58bbe7,'packageId':_0x503475[_0x1223a6(0xd4)]};await this['addBalanceToUser'](_0x22d881,_0x2a44c0,_0x58bbe7),await this[_0x1223a6(0x15e)]({'userId':_0x22d881,'rechargeType':balance_constant_1[_0x1223a6(0x18a)][_0x1223a6(0x17a)],'model3Count':_0x270aa3,'model4Count':_0x372e9e,'drawMjCount':_0x2f72a2,'pkgName':_0x1b687b,'days':_0x58bbe7});const _0x3f5d06=await this[_0x1223a6(0x16a)][_0x1223a6(0x184)]({'where':{'id':_0x22d881}}),{invitedBy:_0xcccd67}=_0x3f5d06;if(_0xcccd67){const _0x2d41fe=await this[_0x1223a6(0x16a)][_0x1223a6(0x184)]({'where':{'inviteCode':_0xcccd67}}),_0x510f0f=await this['salesUsersEntity'][_0x1223a6(0x184)]({'where':{'userId':_0x2d41fe['id']}});if(!_0x2d41fe)return;const {id:_0x2935bd}=_0x2d41fe,{performanceRatio:_0x69ec83}=_0x510f0f,_0x595526={'inviterUserId':_0x2935bd,'inviteeUserId':_0x22d881,'orderId':_0x503475['id'],'orderPrice':_0x503475[_0x1223a6(0x10d)],'commissionPercentage':_0x69ec83,'commissionAmount':(_0x503475[_0x1223a6(0x10d)]*_0x69ec83/0x64)[_0x1223a6(0xfb)](0x2)};await this[_0x1223a6(0xea)][_0x1223a6(0x177)](_0x595526),await this[_0x1223a6(0xea)][_0x1223a6(0xd0)](_0x2935bd,_0x595526[_0x1223a6(0x165)]);}}catch(_0x1b72b4){console[_0x1223a6(0x180)]('error:\x20',_0x1b72b4);throw new common_1['HttpException'](_0x1223a6(0x11a),common_1[_0x1223a6(0xe5)][_0x1223a6(0x108)]);}}async['getRechargeLog'](_0x37e8b5,_0x5c6cba){const _0x16176e=_0x388870,{page:page=0x1,size:size=0x14}=_0x5c6cba,{id:_0x474687}=_0x37e8b5[_0x16176e(0x111)],[_0x1d59b2,_0x26152d]=await this['accountLogEntity'][_0x16176e(0xdd)]({'where':{'userId':_0x474687},'order':{'id':_0x16176e(0x17e)},'skip':(page-0x1)*size,'take':size});return _0x1d59b2[_0x16176e(0x130)](_0x5d54b7=>{const _0x3abf39=_0x16176e;_0x5d54b7[_0x3abf39(0xda)]=_0x5d54b7['days']>0x0?_0x5d54b7[_0x3abf39(0x168)]+'天':'永久';}),{'rows':(0x0,date_1[_0x16176e(0x120)])(_0x1d59b2),'count':_0x26152d};}async[_0x388870(0xf4)](_0x506116,_0xb4eb1a){const _0x302a99=_0x388870;try{const {page:page=0x1,size:size=0xa,userId:_0x5b6c25,rechargeType:_0xec15d7,packageId:_0x1cf3e6}=_0xb4eb1a,{role:_0x443def}=_0x506116[_0x302a99(0x111)],_0x2a126f={};_0xec15d7&&(_0x2a126f['rechargeType']=_0xec15d7),_0x2a126f[_0x302a99(0x128)]=_0x5b6c25||(0x0,typeorm_2[_0x302a99(0x132)])(0x186a0),_0x1cf3e6&&(_0x2a126f['packageId']={'$like':'%'+_0x1cf3e6+'%'});const [_0x55ed51,_0x422d6f]=await this['accountLogEntity'][_0x302a99(0xdd)]({'where':_0x2a126f,'order':{'id':_0x302a99(0x17e)},'skip':(page-0x1)*size,'take':size}),_0x1b15c1=_0x55ed51[_0x302a99(0x18c)](_0x14cf1b=>_0x14cf1b[_0x302a99(0x128)]),_0x2887d2=await this[_0x302a99(0x16a)][_0x302a99(0x12d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1b15c1)}});return _0x55ed51[_0x302a99(0x130)](_0x501e98=>{const _0xec5225=_0x302a99,_0x1fcb57=_0x2887d2['find'](_0x7e5cdd=>_0x7e5cdd['id']===_0x501e98['userId']);_0x501e98[_0xec5225(0x153)]=_0x1fcb57===null||_0x1fcb57===void 0x0?void 0x0:_0x1fcb57['username'],_0x501e98[_0xec5225(0x150)]=_0x1fcb57===null||_0x1fcb57===void 0x0?void 0x0:_0x1fcb57[_0xec5225(0x150)],_0x501e98['phone']=_0x1fcb57===null||_0x1fcb57===void 0x0?void 0x0:_0x1fcb57[_0xec5225(0x124)],_0x501e98[_0xec5225(0x118)]=_0x1fcb57===null||_0x1fcb57===void 0x0?void 0x0:_0x1fcb57['status'],_0x501e98[_0xec5225(0x169)]=_0x1fcb57===null||_0x1fcb57===void 0x0?void 0x0:_0x1fcb57[_0xec5225(0x169)];}),_0x443def!==_0x302a99(0x18e)&&_0x55ed51[_0x302a99(0x130)](_0x493d44=>{const _0x776827=_0x302a99;_0x493d44[_0x776827(0x150)]=_0x493d44[_0x776827(0x150)]?(0x0,utils_1[_0x776827(0x16f)])(_0x493d44[_0x776827(0x150)]):'',_0x493d44['phone']=_0x493d44[_0x776827(0x124)]?(0x0,utils_1[_0x776827(0x16f)])(_0x493d44[_0x776827(0x124)]):'';}),{'rows':_0x55ed51,'count':_0x422d6f};}catch(_0x3d868b){console['log']('error:\x20',_0x3d868b);throw new common_1[(_0x302a99(0x176))]('查询用户账户失败！',common_1['HttpStatus'][_0x302a99(0x108)]);}}async['queryUserBalanceByIds'](_0x232f01){const _0x1f35e4=_0x388870;return await this[_0x1f35e4(0x182)]['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x232f01)}});}async[_0x388870(0x13f)](_0x2afd6a,_0x1196f7){const _0x34d258=_0x388870;return await this[_0x34d258(0x14d)](_0x2afd6a,_0x34d258(0xef),-_0x1196f7);}async['upgradeBalance'](){const _0x2ab8bf=_0x388870,_0x309920=await this['userEntity'][_0x2ab8bf(0x12d)]();if(!_0x309920[_0x2ab8bf(0x159)])return;const _0x4d90b6=await this[_0x2ab8bf(0x110)][_0x2ab8bf(0xcf)]([_0x2ab8bf(0x11e)]);if(!_0x4d90b6)await this[_0x2ab8bf(0x110)][_0x2ab8bf(0xe8)]({'settings':[{'configKey':_0x2ab8bf(0x11e),'configVal':'1'}]});else throw new common_1[(_0x2ab8bf(0x176))](_0x2ab8bf(0x162),common_1['HttpStatus'][_0x2ab8bf(0x108)]);_0x309920['forEach'](_0x373acb=>{const _0x533f4c=_0x2ab8bf,{id:_0x68d453}=_0x373acb;this[_0x533f4c(0x107)][_0x533f4c(0x184)]({'where':{'userId':_0x68d453}})[_0x533f4c(0x183)](_0x150c07=>{if(!_0x150c07)return;this['writeOldBalanceToNewTable'](_0x68d453,_0x150c07);});});}async[_0x388870(0xfc)](_0x53378c,_0x3e0b1){const _0x40d375=_0x388870,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x3e0b1,_0x3bccb6=await this[_0x40d375(0x16d)]['findOne']({'where':{'userId':_0x53378c}}),_0x240403={'userId':_0x53378c,'model3Count':Number(usesLeft),'model4Count':(_0x3bccb6===null||_0x3bccb6===void 0x0?void 0x0:_0x3bccb6[_0x40d375(0x154)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x3bccb6===null||_0x3bccb6===void 0x0?void 0x0:_0x3bccb6[_0x40d375(0xf3)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x320c0e=await this[_0x40d375(0x182)][_0x40d375(0x184)]({'where':{'userId':_0x53378c}});_0x320c0e?common_1['Logger'][_0x40d375(0x15f)]('用户'+_0x53378c+_0x40d375(0x116),_0x40d375(0x14a)):this[_0x40d375(0x182)][_0x40d375(0x187)](_0x240403)[_0x40d375(0x183)](_0x2b725c=>{const _0xf53f7d=_0x40d375;common_1['Logger'][_0xf53f7d(0x15f)]('用户'+_0x53378c+_0xf53f7d(0x186),_0xf53f7d(0x14a));})[_0x40d375(0x18b)](_0x4eaba4=>{const _0x143d86=_0x40d375;console[_0x143d86(0x180)](_0x143d86(0xcd),_0x4eaba4),common_1[_0x143d86(0xfe)][_0x143d86(0x15f)]('用户'+_0x53378c+_0x143d86(0x12a),_0x143d86(0x14a));});}async[_0x388870(0x179)](_0x182d9d){const _0x16bf01=_0x388870,{fingerprint:_0x4600ee}=_0x182d9d[_0x16bf01(0x173)],{id:_0x24e636}=_0x182d9d[_0x16bf01(0x111)];return await this['chatLogEntity'][_0x16bf01(0x121)]({'userId':Number(_0x4600ee)},{'userId':_0x24e636}),await this[_0x16bf01(0x12f)][_0x16bf01(0x121)]({'userId':Number(_0x4600ee)},{'userId':_0x24e636}),await this['midjourneyEntity'][_0x16bf01(0x121)]({'userId':Number(_0x4600ee)},{'userId':_0x24e636}),0x1;}async[_0x388870(0xd3)](_0x58efe8){const _0x454873=_0x388870,{fingerprint:_0x1bce0f}=_0x58efe8[_0x454873(0x173)],_0x545cf8=await this[_0x454873(0x164)][_0x454873(0x154)]({'where':{'userId':_0x1bce0f}}),_0x10ddff=await this['chatGroupEntity']['count']({'where':{'userId':_0x1bce0f}}),_0x2a514a=await this[_0x454873(0x101)]['count']({'where':{'userId':_0x1bce0f}});return _0x545cf8||_0x10ddff||_0x2a514a||0x0;}};UserBalanceService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x388870(0x171)])(balance_entity_1[_0x388870(0x122)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x388870(0x141)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1[_0x388870(0x102)])),__param(0x3,(0x0,typeorm_1[_0x388870(0x171)])(cramiPackage_entity_1[_0x388870(0x15d)])),__param(0x4,(0x0,typeorm_1[_0x388870(0x171)])(config_entity_1['ConfigEntity'])),__param(0x5,(0x0,typeorm_1[_0x388870(0x171)])(user_entity_1[_0x388870(0x17b)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1[_0x388870(0x138)])),__param(0x7,(0x0,typeorm_1[_0x388870(0x171)])(whiteList_entity_1[_0x388870(0x17f)])),__param(0x8,(0x0,typeorm_1[_0x388870(0x171)])(fingerprint_entity_1[_0x388870(0x11d)])),__param(0x9,(0x0,typeorm_1[_0x388870(0x171)])(chatGroup_entity_1[_0x388870(0x13d)])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x388870(0xd1)])),__param(0xb,(0x0,typeorm_1[_0x388870(0x171)])(midjourney_entity_1[_0x388870(0xf9)])),__metadata(_0x388870(0x14e),[typeorm_2[_0x388870(0x10b)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x388870(0x10b)],typeorm_2[_0x388870(0x10b)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x388870(0x10b)],typeorm_2[_0x388870(0x10b)],typeorm_2[_0x388870(0x10b)],typeorm_2[_0x388870(0x10b)],sales_service_1['SalesService'],globalConfig_service_1[_0x388870(0xf1)]])],UserBalanceService),exports[_0x388870(0x140)]=UserBalanceService;