'use strict';const _0x2cb6dd=_0x38e4;(function(_0x9269d0,_0x1b58e5){const _0x42ec9a=_0x38e4,_0x178c1e=_0x9269d0();while(!![]){try{const _0x5483b3=-parseInt(_0x42ec9a(0x123))/0x1+-parseInt(_0x42ec9a(0xf3))/0x2+parseInt(_0x42ec9a(0xf0))/0x3+-parseInt(_0x42ec9a(0x158))/0x4*(-parseInt(_0x42ec9a(0x118))/0x5)+-parseInt(_0x42ec9a(0x113))/0x6*(parseInt(_0x42ec9a(0xe8))/0x7)+-parseInt(_0x42ec9a(0x12d))/0x8+parseInt(_0x42ec9a(0x10d))/0x9;if(_0x5483b3===_0x1b58e5)break;else _0x178c1e['push'](_0x178c1e['shift']());}catch(_0xcf015e){_0x178c1e['push'](_0x178c1e['shift']());}}}(_0x2610,0x714c2));var __decorate=this&&this['__decorate']||function(_0x137843,_0x264596,_0x43dc17,_0x36df7d){const _0x2a8c1f=_0x38e4;var _0x446009=arguments[_0x2a8c1f(0x18b)],_0x53ab8c=_0x446009<0x3?_0x264596:_0x36df7d===null?_0x36df7d=Object[_0x2a8c1f(0x17d)](_0x264596,_0x43dc17):_0x36df7d,_0x5ed435;if(typeof Reflect==='object'&&typeof Reflect[_0x2a8c1f(0xf2)]===_0x2a8c1f(0x137))_0x53ab8c=Reflect['decorate'](_0x137843,_0x264596,_0x43dc17,_0x36df7d);else{for(var _0x2606b7=_0x137843['length']-0x1;_0x2606b7>=0x0;_0x2606b7--)if(_0x5ed435=_0x137843[_0x2606b7])_0x53ab8c=(_0x446009<0x3?_0x5ed435(_0x53ab8c):_0x446009>0x3?_0x5ed435(_0x264596,_0x43dc17,_0x53ab8c):_0x5ed435(_0x264596,_0x43dc17))||_0x53ab8c;}return _0x446009>0x3&&_0x53ab8c&&Object[_0x2a8c1f(0x144)](_0x264596,_0x43dc17,_0x53ab8c),_0x53ab8c;},__metadata=this&&this[_0x2cb6dd(0x114)]||function(_0x2ea9d9,_0x53f489){const _0x32f364=_0x2cb6dd;if(typeof Reflect==='object'&&typeof Reflect['metadata']==='function')return Reflect[_0x32f364(0x122)](_0x2ea9d9,_0x53f489);},__param=this&&this['__param']||function(_0x4c8282,_0x384ec2){return function(_0x187c48,_0xed6c93){_0x384ec2(_0x187c48,_0xed6c93,_0x4c8282);};};Object[_0x2cb6dd(0x144)](exports,_0x2cb6dd(0x176),{'value':!![]}),exports[_0x2cb6dd(0x132)]=void 0x0;function _0x2610(){const _0x95d139=['includes','design:paramtypes','./fingerprint.entity','当前用户无需创建账户信息！','UserBalanceEntity','packageId','invitedGuestSendModel4Count','model3Count','email','day','查询用户账户失败！','useModel4Token','forEach','inviteGiveSendDrawMjCount','3472002XNsGoD','您已经升级过了、请勿重复操作！','odel3','format','invitedGuestSendModel3Count','queryUserBalance','6xsiEtg','__metadata','充值的工单信息:','configVal','updatedAt','2084905GKHjhl','chatGroupEntity','addBalanceToOrder','LessThan','firstRregisterSendModel3Count','sumModel3Count','salesService','globalConfigService','REFER_GIFT','Logger','metadata','167227SizHyV','validateBalance','@nestjs/common','whiteListEntity','GlobalConfigService','salesUsersEntity','phone','getVisitorCount','userBalanceEntity','log','318400oasqVl','查询用户账户信息失败！','odel4','rechargeType','缺失当前用户账户记录！','UserBalanceService','debug','reduce','../sales/salesUsers.entity','registerSendDrawMjCount','function','writeOldBalanceToNewTable','../../common/utils','../midjourney/midjourney.entity','YYYY-MM-DD\x20HH:mm:ss','default','RechargeType','visitorMJNum','userId','addBalanceToUser','expirationTime','inviteSendStatus','formatDate','defineProperty','sumDrawMjCount','当前套餐不存在！','inviteGiveSendModel4Count','fingerprintLogEntity','SalesService','addBalanceToNewUser','SalesUsersEntity','../../common/utils/date','HttpStatus','memberDrawMjCount','expireDateCn','memberModel3Count','drawMjCount','../globalConfig/globalConfig.service','useModel3Count','旧账户信息迁移失败','getRechargeLog','setConfig','update','4FTljjN','ConfigEntity','validateVisitorBalance','getMonth','registerSendModel3Count','visitor','goodsId','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','useModel3Token','createBaseUserBalance','CramiPackageEntity','inviteGiveSendModel3Count','getConfigs','commissionAmount','findOne','accountLogEntity','FingerprintLogEntity','查询当前用户余额失败！','getDate','weight','error:\x20','days','BalanceEntity','configKey','REG_GIFT','firstRregisterSendModel4Count','useModel4Count','model4Count','UserEntity','balanceEntity','__esModule','memberModel4Count','../sales/sales.service','saveCommissionAmount','getAccountLog','充值失败！','当前用户不存在,记录充值日志异常','getOwnPropertyDescriptor','firstRegisterSendRank','firstRegisterSendStatus','cramiPackageEntity','then','../chatLog/chatLog.entity','../crami/cramiPackage.entity','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','deductFromBalance','./userBalance.entity','BalanceService','注册赠送失败,请联系管理员！','./accountLog.entity','save','length','user','firstRregisterSendDrawMjCount','map','InjectRepository','configEntity','saveRecordRechargeLog','midjourneyEntity','add','充值失败','mjDraw','userEntity','hideString','useCount','find','../../common/constants/balance.constant','status','../chatGroup/chatGroup.entity','ChatLogEntity','createRandomUid','count','PAYMENT_REQUIRED','Injectable','upgradeStatus','registerSendModel4Count','sumModel4Count','DESC','catch','用户充值失败！','106001mQmnIz','model4','invitedGuestSendDrawMjCount','chatLogEntity','createSalesRecords','INVITE_GIFT','model3','Repository','817659JLXzBX','total','decorate','778152IWdTyD','../user/user.entity','isUpdatedToday','username','typeorm','toFixed','BAD_REQUEST','avatar','findAndCount','HttpException','旧账户信息迁移成功','refundMjBalance'];_0x2610=function(){return _0x95d139;};return _0x2610();}function _0x38e4(_0x39941e,_0xb91c55){const _0x26106b=_0x2610();return _0x38e4=function(_0x38e489,_0x233f28){_0x38e489=_0x38e489-0xdd;let _0x28043c=_0x26106b[_0x38e489];return _0x28043c;},_0x38e4(_0x39941e,_0xb91c55);}const globalConfig_service_1=require(_0x2cb6dd(0x152)),typeorm_1=require('@nestjs/typeorm'),balance_entity_1=require('./balance.entity'),common_1=require(_0x2cb6dd(0x125)),typeorm_2=require(_0x2cb6dd(0xf7)),balance_constant_1=require(_0x2cb6dd(0x19a)),accountLog_entity_1=require(_0x2cb6dd(0x189)),utils_1=require(_0x2cb6dd(0x139)),config_entity_1=require('../globalConfig/config.entity'),cramiPackage_entity_1=require(_0x2cb6dd(0x183)),userBalance_entity_1=require(_0x2cb6dd(0x186)),date_1=require(_0x2cb6dd(0x14c)),user_entity_1=require(_0x2cb6dd(0xf4)),salesUsers_entity_1=require(_0x2cb6dd(0x135)),sales_service_1=require(_0x2cb6dd(0x178)),whiteList_entity_1=require('../chatgpt/whiteList.entity'),fingerprint_entity_1=require(_0x2cb6dd(0x101)),chatLog_entity_1=require(_0x2cb6dd(0x182)),chatGroup_entity_1=require(_0x2cb6dd(0x19c)),midjourney_entity_1=require(_0x2cb6dd(0x13a));let UserBalanceService=class UserBalanceService{constructor(_0x298267,_0x5ea038,_0x5933fe,_0x3a188b,_0x5ecae6,_0x166ecc,_0xf00595,_0x5bbbfb,_0x46f79b,_0x57e4a,_0x120ad9,_0x5a6a01,_0xb94523,_0x2acce4){const _0x404b99=_0x2cb6dd;this[_0x404b99(0x175)]=_0x298267,this[_0x404b99(0x12b)]=_0x5ea038,this['accountLogEntity']=_0x5933fe,this[_0x404b99(0x180)]=_0x3a188b,this[_0x404b99(0x190)]=_0x5ecae6,this[_0x404b99(0x196)]=_0x166ecc,this[_0x404b99(0x128)]=_0xf00595,this[_0x404b99(0x126)]=_0x5bbbfb,this[_0x404b99(0x148)]=_0x46f79b,this[_0x404b99(0x119)]=_0x57e4a,this[_0x404b99(0xeb)]=_0x120ad9,this[_0x404b99(0x192)]=_0x5a6a01,this[_0x404b99(0x11e)]=_0xb94523,this[_0x404b99(0x11f)]=_0x2acce4;}async[_0x2cb6dd(0x14a)](_0xd44f66,_0x27ccbf){const _0x407fbd=_0x2cb6dd;try{const _0x29cfdc=await this['configEntity'][_0x407fbd(0x199)]({'where':{'configKey':(0x0,typeorm_2['In'])(['registerSendStatus','registerSendModel3Count',_0x407fbd(0xe3),_0x407fbd(0x136),_0x407fbd(0x17f),_0x407fbd(0x17e),_0x407fbd(0x11c),_0x407fbd(0x171),_0x407fbd(0x18d),_0x407fbd(0x142),_0x407fbd(0x163),_0x407fbd(0x147),_0x407fbd(0x10c),_0x407fbd(0x111),_0x407fbd(0xea),_0x407fbd(0x105)])}}),_0x5da50b=_0x29cfdc[_0x407fbd(0x134)]((_0x217190,_0x44a85b)=>{const _0x5a898b=_0x407fbd,_0x42ea07=Number(_0x44a85b[_0x5a898b(0x116)]),_0x4708e2=Number['isInteger'](_0x42ea07)&&_0x42ea07>0x0?_0x42ea07:0x0;return _0x217190[_0x44a85b[_0x5a898b(0x16f)]]=_0x4708e2,_0x217190;},{});let _0x44d0d2=0x0,_0x1f5057=0x0,_0xa0c029=0x0;_0x5da50b['registerSendStatus']===0x1&&(_0x44d0d2=_0x44d0d2+_0x5da50b[_0x407fbd(0x15c)],_0x1f5057=_0x1f5057+_0x5da50b[_0x407fbd(0xe3)],_0xa0c029=_0xa0c029+_0x5da50b['registerSendDrawMjCount']),_0x5da50b['registerSendStatus']===0x1&&_0x5da50b['firstRegisterSendStatus']===0x1&&_0xd44f66<=_0x5da50b[_0x407fbd(0x17e)]&&(_0x44d0d2=_0x44d0d2+_0x5da50b['firstRregisterSendModel3Count'],_0x1f5057=_0x1f5057+_0x5da50b[_0x407fbd(0x171)],_0xa0c029=_0xa0c029+_0x5da50b[_0x407fbd(0x18d)]),await this[_0x407fbd(0x191)]({'userId':_0xd44f66,'rechargeType':balance_constant_1['RechargeType'][_0x407fbd(0x170)],'model3Count':_0x44d0d2,'drawMjCount':_0xa0c029,'model4Count':_0x1f5057}),_0x27ccbf&&(Number(_0x5da50b['inviteSendStatus'])===0x1&&(_0x44d0d2=_0x44d0d2+Number(_0x5da50b['invitedGuestSendModel3Count']),_0x1f5057=_0x1f5057+Number(_0x5da50b[_0x407fbd(0x105)]),_0xa0c029=_0xa0c029+Number(_0x5da50b[_0x407fbd(0xea)]),await this[_0x407fbd(0x191)]({'userId':_0xd44f66,'rechargeType':balance_constant_1[_0x407fbd(0x13d)][_0x407fbd(0xed)],'model3Count':_0x5da50b[_0x407fbd(0x111)],'model4Count':_0x5da50b[_0x407fbd(0x105)],'drawMjCount':_0x5da50b[_0x407fbd(0xea)]}),await this[_0x407fbd(0x140)](_0x27ccbf,{'model3Count':_0x5da50b[_0x407fbd(0x163)],'model4Count':_0x5da50b['inviteGiveSendModel4Count'],'drawMjCount':_0x5da50b[_0x407fbd(0x10c)]}),await this[_0x407fbd(0x191)]({'userId':_0x27ccbf,'rechargeType':balance_constant_1[_0x407fbd(0x13d)][_0x407fbd(0x120)],'model3Count':_0x5da50b['inviteGiveSendModel3Count'],'model4Count':_0x5da50b[_0x407fbd(0x147)],'drawMjCount':_0x5da50b[_0x407fbd(0x10c)]}))),await this[_0x407fbd(0x12b)][_0x407fbd(0x18a)]({'userId':_0xd44f66,'model3Count':_0x44d0d2,'model4Count':_0x1f5057,'drawMjCount':_0xa0c029,'useTokens':0x0});}catch(_0x2c2855){console[_0x407fbd(0x12c)](_0x407fbd(0x16c),_0x2c2855);throw new common_1['HttpException'](_0x407fbd(0x188),common_1[_0x407fbd(0x14d)][_0x407fbd(0xf9)]);}}async[_0x2cb6dd(0x124)](_0x398380,_0x44a3a9,_0xbabd86){const _0x436639=_0x2cb6dd,{id:_0x2fbfee,role:_0x1e12e3}=_0x398380[_0x436639(0x18c)];let _0x230089=await this[_0x436639(0x12b)]['findOne']({'where':{'userId':_0x2fbfee}});!_0x230089&&(_0x230089=await this['createBaseUserBalance'](_0x2fbfee));if(_0x1e12e3===_0x436639(0x15d))return this[_0x436639(0x15a)](_0x398380,_0x44a3a9,_0xbabd86);const _0xb6b489=await this['configEntity']['findOne']({'where':{'configKey':'vxNumber'}}),_0x34afec=_0xb6b489?_0xb6b489[_0x436639(0x116)]:'---',_0x5f28fc=_0x44a3a9===_0x436639(0xee)?'memberModel3Count':_0x44a3a9===_0x436639(0xe9)?_0x436639(0x177):_0x44a3a9===_0x436639(0x195)?_0x436639(0x14e):null,_0x2e782e=_0x44a3a9===_0x436639(0xee)?_0x436639(0x106):_0x44a3a9===_0x436639(0xe9)?'model4Count':_0x44a3a9===_0x436639(0x195)?_0x436639(0x151):null;if(_0x230089[_0x436639(0x104)]&&_0x230089[_0x5f28fc]<_0xbabd86){if(_0x230089[_0x2e782e]<_0xbabd86)throw new common_1['HttpException'](_0x436639(0x184)+_0x34afec+'>\x20或购买专属套餐\x20！',common_1[_0x436639(0x14d)][_0x436639(0xe0)]);}if(!_0x230089['packageId']&&_0x230089[_0x2e782e]<_0xbabd86)throw new common_1[(_0x436639(0xfc))](_0x436639(0x184)+_0x34afec+'>\x20或购买专属套餐\x20！',common_1[_0x436639(0x14d)]['PAYMENT_REQUIRED']);return _0x230089;}async['validateVisitorBalance'](_0x5eaad9,_0x138c6e,_0x375522){const _0x37e97b=_0x2cb6dd,{id:_0x4efac8}=_0x5eaad9[_0x37e97b(0x18c)],_0x5e3fb3=_0x138c6e==='model3'?'model3Count':_0x138c6e===_0x37e97b(0xe9)?'model4Count':_0x138c6e==='mjDraw'?'drawMjCount':null,_0x541308=new Date(),_0xe33c61=await this[_0x37e97b(0x148)][_0x37e97b(0x166)]({'where':{'fingerprint':_0x4efac8}}),{visitorModel3Num:_0x23fbc2,visitorModel4Num:_0x4a5ee1,visitorMJNum:_0x15f635}=await this[_0x37e97b(0x11f)][_0x37e97b(0x164)](['visitorModel3Num','visitorModel4Num',_0x37e97b(0x13e)]),_0x170bd1={'model3Count':_0x23fbc2?Number(_0x23fbc2):0x0,'model4Count':_0x4a5ee1?Number(_0x4a5ee1):0x0,'drawMjCount':_0x15f635?Number(_0x15f635):0x0};if(!_0xe33c61){const _0x39e841={'fingerprint':_0x4efac8,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x39e841[_0x5e3fb3]=_0x39e841[_0x5e3fb3]+_0x375522;if(_0x39e841[_0x5e3fb3]>_0x170bd1[_0x5e3fb3])throw new common_1[(_0x37e97b(0xfc))](_0x37e97b(0x15f),common_1['HttpStatus'][_0x37e97b(0xe0)]);else return await this[_0x37e97b(0x148)][_0x37e97b(0x18a)](_0x39e841),!![];}else{const {model3Count:_0x2f8dc5,model4Count:_0x35b83b,drawMjCount:_0x56a4cd}=_0xe33c61;let _0x34d9d4={'model3Count':_0x2f8dc5,'model4Count':_0x35b83b,'drawMjCount':_0x56a4cd};const _0x377fef=Number(new Date(_0xe33c61[_0x37e97b(0x117)])),_0x560538=this[_0x37e97b(0xf5)](_0x377fef);_0x560538?_0x34d9d4[_0x5e3fb3]=_0x34d9d4[_0x5e3fb3]+_0x375522:(_0x34d9d4={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x34d9d4[_0x5e3fb3]=_0x34d9d4[_0x5e3fb3]+_0x375522);if(_0x34d9d4[_0x5e3fb3]>_0x170bd1[_0x5e3fb3])throw new common_1[(_0x37e97b(0xfc))](_0x37e97b(0x15f),common_1[_0x37e97b(0x14d)][_0x37e97b(0xe0)]);else return await this[_0x37e97b(0x148)][_0x37e97b(0x157)]({'fingerprint':_0x4efac8},_0x34d9d4),!![];}}[_0x2cb6dd(0xf5)](_0x523b14){const _0x314278=_0x2cb6dd,_0x39230b=new Date(),_0xd134fa=new Date(_0x39230b['getFullYear'](),_0x39230b[_0x314278(0x15b)](),_0x39230b[_0x314278(0x16a)]());return _0x523b14>=_0xd134fa;}async[_0x2cb6dd(0x185)](_0x229f83,_0xc561ca,_0x41780a,_0x351248=0x0){const _0x3dd9fd=_0x2cb6dd,_0x1bc976=await this[_0x3dd9fd(0x12b)]['findOne']({'where':{'userId':_0x229f83}});if(!_0x1bc976)throw new common_1[(_0x3dd9fd(0xfc))](_0x3dd9fd(0x131),common_1[_0x3dd9fd(0x14d)][_0x3dd9fd(0xf9)]);const _0x1204c8=_0xc561ca===_0x3dd9fd(0xee)?_0x3dd9fd(0x150):_0xc561ca===_0x3dd9fd(0xe9)?_0x3dd9fd(0x177):_0xc561ca===_0x3dd9fd(0x195)?_0x3dd9fd(0x14e):null,_0x38ab9c=_0xc561ca==='model3'?'model3Count':_0xc561ca==='model4'?'model4Count':_0xc561ca==='mjDraw'?_0x3dd9fd(0x151):null,_0x7c15c4=_0x1bc976[_0x3dd9fd(0x104)]&&_0x1bc976[_0x1204c8]<_0x41780a?_0x38ab9c:_0x1bc976[_0x3dd9fd(0x104)]?_0x1204c8:_0x38ab9c;let _0x4ff5c7=null;_0x7c15c4['includes'](_0x3dd9fd(0x10f))&&(_0x4ff5c7=_0x3dd9fd(0x160));_0x7c15c4[_0x3dd9fd(0xff)](_0x3dd9fd(0x12f))&&(_0x4ff5c7='useModel4Token');_0x7c15c4[_0x3dd9fd(0xff)]('MjCount')&&(_0x4ff5c7='useDrawMjToken');const _0x3bdf36={[_0x7c15c4]:_0x1bc976[_0x7c15c4]-_0x41780a<0x0?0x0:_0x1bc976[_0x7c15c4]-_0x41780a,[_0x4ff5c7]:_0x1bc976[_0x4ff5c7]+_0x351248};_0x4ff5c7==='useModel3Token'&&(_0x3bdf36[_0x3dd9fd(0x153)]=_0x1bc976[_0x3dd9fd(0x153)]+_0x41780a),_0x4ff5c7===_0x3dd9fd(0x10a)&&(_0x3bdf36[_0x3dd9fd(0x172)]=_0x1bc976[_0x3dd9fd(0x172)]+_0x41780a);const _0x1900c1=await this[_0x3dd9fd(0x12b)][_0x3dd9fd(0x157)]({'userId':_0x229f83},_0x3bdf36);if(_0x1900c1['affected']===0x0)throw new common_1[(_0x3dd9fd(0xfc))]('消费余额失败！',common_1[_0x3dd9fd(0x14d)][_0x3dd9fd(0xf9)]);}async[_0x2cb6dd(0x112)](_0x49bd18){const _0x5ce4e3=_0x2cb6dd;try{const _0x20c587=await this['userBalanceEntity'][_0x5ce4e3(0x166)]({'where':{'userId':_0x49bd18},'select':[_0x5ce4e3(0x104),_0x5ce4e3(0x106),_0x5ce4e3(0x173),_0x5ce4e3(0x151),'memberModel3Count',_0x5ce4e3(0x177),_0x5ce4e3(0x14e),_0x5ce4e3(0x153),_0x5ce4e3(0x172),'useModel3Token',_0x5ce4e3(0x10a),'useDrawMjToken',_0x5ce4e3(0x141)]});if(!_0x20c587){const _0x2147d3=await this[_0x5ce4e3(0x161)](_0x49bd18);if(_0x2147d3)return await this[_0x5ce4e3(0x112)](_0x49bd18);else throw new common_1[(_0x5ce4e3(0xfc))](_0x5ce4e3(0x169),common_1[_0x5ce4e3(0x14d)][_0x5ce4e3(0xf9)]);}return _0x20c587[_0x5ce4e3(0x11d)]=_0x20c587[_0x5ce4e3(0x104)]?_0x20c587[_0x5ce4e3(0x106)]+_0x20c587['memberModel3Count']:_0x20c587[_0x5ce4e3(0x106)],_0x20c587[_0x5ce4e3(0xe4)]=_0x20c587[_0x5ce4e3(0x104)]?_0x20c587[_0x5ce4e3(0x173)]+_0x20c587[_0x5ce4e3(0x177)]:_0x20c587[_0x5ce4e3(0x173)],_0x20c587[_0x5ce4e3(0x145)]=_0x20c587[_0x5ce4e3(0x104)]?_0x20c587['drawMjCount']+_0x20c587[_0x5ce4e3(0x14e)]:_0x20c587['drawMjCount'],_0x20c587[_0x5ce4e3(0x141)]=_0x20c587[_0x5ce4e3(0x141)]?(0x0,date_1[_0x5ce4e3(0x143)])(_0x20c587['expirationTime'],'YYYY-MM-DD'):null,_0x20c587;}catch(_0x4da686){console[_0x5ce4e3(0x12c)](_0x5ce4e3(0x16c),_0x4da686);}}async[_0x2cb6dd(0x191)](_0x1f6452){const _0x189bde=_0x2cb6dd,{userId:_0x101ed8,rechargeType:_0x4487ce,model3Count:_0x4d8be1,model4Count:_0x122e34,drawMjCount:_0x5f678,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x1f6452;if(!_0x101ed8)throw new common_1[(_0x189bde(0xfc))](_0x189bde(0x17c),common_1[_0x189bde(0x14d)][_0x189bde(0xf9)]);const _0x3efa60=(0x0,utils_1[_0x189bde(0xde)])();return await this['accountLogEntity']['save']({'userId':_0x101ed8,'rechargeType':_0x4487ce,'model3Count':_0x4d8be1,'model4Count':_0x122e34,'drawMjCount':_0x5f678,'days':days,'extent':extent,'uid':_0x3efa60,'pkgName':pkgName});}async[_0x2cb6dd(0x161)](_0x536771,_0x2bc041={}){const _0x19e26c=_0x2cb6dd,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2bc041,_0x221bd7=await this[_0x19e26c(0x12b)][_0x19e26c(0x166)]({'where':{'userId':_0x536771}});if(_0x221bd7)throw new common_1[(_0x19e26c(0xfc))](_0x19e26c(0x102),common_1['HttpStatus'][_0x19e26c(0xf9)]);return await this[_0x19e26c(0x12b)]['save']({'userId':_0x536771,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x2cb6dd(0x140)](_0x32df68,_0x503adb,_0x1b1a8a=-0x1){const _0x4f8155=_0x2cb6dd;try{const _0x1d9208=await this[_0x4f8155(0x12b)][_0x4f8155(0x166)]({'where':{'userId':_0x32df68}})||await this[_0x4f8155(0x161)](_0x32df68);if(!_0x1d9208)throw new common_1[(_0x4f8155(0xfc))](_0x4f8155(0x12e),common_1[_0x4f8155(0x14d)]['BAD_REQUEST']);const {model3Count:_0xe00366,model4Count:_0x93771d,drawMjCount:_0x3b568e,memberModel3Count:_0xe22602,memberModel4Count:_0x17d1f6,memberDrawMjCount:_0x1bb5bb}=_0x1d9208;let _0x23edae={};if(_0x1b1a8a>0x0){const {packageId:_0x32552a}=_0x503adb;if(!_0x32552a)throw new common_1[(_0x4f8155(0xfc))]('缺失当前套餐ID、充值失败！',common_1[_0x4f8155(0x14d)][_0x4f8155(0xf9)]);const _0x54478e=await this['cramiPackageEntity'][_0x4f8155(0x166)]({'where':{'id':_0x32552a}});if(!_0x54478e)throw new common_1[(_0x4f8155(0xfc))](_0x4f8155(0x146),common_1['HttpStatus'][_0x4f8155(0xf9)]);const {weight:_0xc79ff3}=_0x54478e;if(!_0x1d9208[_0x4f8155(0x104)])_0x23edae={'memberModel3Count':_0xe00366+_0x503adb[_0x4f8155(0x106)],'memberModel4Count':_0x93771d+_0x503adb[_0x4f8155(0x173)],'memberDrawMjCount':_0x3b568e+_0x503adb['drawMjCount'],'expirationTime':(0x0,date_1['default'])()[_0x4f8155(0x193)](_0x1b1a8a>0x0?_0x1b1a8a:0x0,_0x4f8155(0x108))[_0x4f8155(0x110)](_0x4f8155(0x13b)),'packageId':_0x32552a};else{const _0x3427b4=await this['cramiPackageEntity'][_0x4f8155(0x166)]({'where':{'id':_0x1d9208['packageId']}});_0xc79ff3>=_0x3427b4['weight']&&(_0x23edae={'memberModel3Count':_0xe22602+_0x503adb[_0x4f8155(0x106)],'memberModel4Count':_0x17d1f6+_0x503adb[_0x4f8155(0x173)],'memberDrawMjCount':_0x1bb5bb+_0x503adb[_0x4f8155(0x151)],'expirationTime':(0x0,date_1[_0x4f8155(0x13c)])(_0x1d9208[_0x4f8155(0x141)])[_0x4f8155(0x193)](_0x1b1a8a>0x0?_0x1b1a8a:0x0,'day')[_0x4f8155(0x110)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x32552a}),_0xc79ff3<_0x3427b4[_0x4f8155(0x16b)]&&(_0x23edae={'memberModel3Count':_0xe22602+_0x503adb[_0x4f8155(0x106)],'memberModel4Count':_0x17d1f6+_0x503adb['model4Count'],'memberDrawMjCount':_0x1bb5bb+_0x503adb['drawMjCount']});}}_0x1b1a8a<=0x0&&(_0x23edae={'model3Count':_0xe00366+_0x503adb['model3Count'],'model4Count':_0x93771d+_0x503adb[_0x4f8155(0x173)],'drawMjCount':_0x3b568e+_0x503adb[_0x4f8155(0x151)]});const _0x2a5471=await this['userBalanceEntity']['update']({'userId':_0x32df68},_0x23edae);if(_0x2a5471['affected']===0x0)throw new common_1[(_0x4f8155(0xfc))](_0x32df68+_0x4f8155(0x194),common_1['HttpStatus'][_0x4f8155(0xf9)]);}catch(_0x3ea99a){console[_0x4f8155(0x12c)](_0x4f8155(0x16c),_0x3ea99a);throw new common_1[(_0x4f8155(0xfc))](_0x4f8155(0xe7),common_1[_0x4f8155(0x14d)][_0x4f8155(0xf9)]);}}async[_0x2cb6dd(0x11a)](_0x1c1265){const _0x2ef1d5=_0x2cb6dd;console[_0x2ef1d5(0x12c)](_0x2ef1d5(0x115),_0x1c1265);try{const {userId:_0x9287a1,goodsId:_0x37ed7f}=_0x1c1265,_0x4d50c0=await this[_0x2ef1d5(0x180)][_0x2ef1d5(0x166)]({'where':{'id':_0x1c1265[_0x2ef1d5(0x15e)],'status':0x1}});if(!_0x4d50c0)throw new common_1[(_0x2ef1d5(0xfc))]('非法操作、当前充值套餐暂不存在！',common_1[_0x2ef1d5(0x14d)]['BAD_REQUEST']);const {model3Count:_0x52f0b0,model4Count:_0x44d7b2,drawMjCount:_0x2548f4,days:_0x440606,name:_0x58895a}=_0x4d50c0,_0x1e2a04={'model3Count':_0x52f0b0,'model4Count':_0x44d7b2,'drawMjCount':_0x2548f4,'days':_0x440606,'packageId':_0x1c1265['goodsId']};await this[_0x2ef1d5(0x140)](_0x9287a1,_0x1e2a04,_0x440606),await this['saveRecordRechargeLog']({'userId':_0x9287a1,'rechargeType':balance_constant_1[_0x2ef1d5(0x13d)]['SCAN_PAY'],'model3Count':_0x52f0b0,'model4Count':_0x44d7b2,'drawMjCount':_0x2548f4,'pkgName':_0x58895a,'days':_0x440606});const _0x54fa32=await this[_0x2ef1d5(0x196)]['findOne']({'where':{'id':_0x9287a1}}),{invitedBy:_0x4a68d9}=_0x54fa32;if(_0x4a68d9){const _0x757064=await this[_0x2ef1d5(0x196)][_0x2ef1d5(0x166)]({'where':{'inviteCode':_0x4a68d9}}),_0x513448=await this[_0x2ef1d5(0x128)][_0x2ef1d5(0x166)]({'where':{'userId':_0x757064['id']}});if(!_0x757064)return;const {id:_0x13c502}=_0x757064,{performanceRatio:_0x192fe8}=_0x513448,_0x3a4512={'inviterUserId':_0x13c502,'inviteeUserId':_0x9287a1,'orderId':_0x1c1265['id'],'orderPrice':_0x1c1265[_0x2ef1d5(0xf1)],'commissionPercentage':_0x192fe8,'commissionAmount':(_0x1c1265[_0x2ef1d5(0xf1)]*_0x192fe8/0x64)[_0x2ef1d5(0xf8)](0x2)};await this[_0x2ef1d5(0x11e)][_0x2ef1d5(0xec)](_0x3a4512),await this[_0x2ef1d5(0x11e)][_0x2ef1d5(0x179)](_0x13c502,_0x3a4512[_0x2ef1d5(0x165)]);}}catch(_0x570850){console[_0x2ef1d5(0x12c)]('error:\x20',_0x570850);throw new common_1[(_0x2ef1d5(0xfc))](_0x2ef1d5(0x17b),common_1[_0x2ef1d5(0x14d)][_0x2ef1d5(0xf9)]);}}async[_0x2cb6dd(0x155)](_0x55057d,_0x1e5983){const _0x66c625=_0x2cb6dd,{page:page=0x1,size:size=0x14}=_0x1e5983,{id:_0x2ef0bd}=_0x55057d['user'],[_0x361cef,_0x8c7058]=await this[_0x66c625(0x167)][_0x66c625(0xfb)]({'where':{'userId':_0x2ef0bd},'order':{'id':_0x66c625(0xe5)},'skip':(page-0x1)*size,'take':size});return _0x361cef['forEach'](_0x1ade1d=>{const _0x3ceeb2=_0x66c625;_0x1ade1d[_0x3ceeb2(0x14f)]=_0x1ade1d[_0x3ceeb2(0x16d)]>0x0?_0x1ade1d[_0x3ceeb2(0x16d)]+'天':'永久';}),{'rows':(0x0,date_1['formatCreateOrUpdateDate'])(_0x361cef),'count':_0x8c7058};}async[_0x2cb6dd(0x17a)](_0x4b9f1c,_0x41930b){const _0x15cd45=_0x2cb6dd;try{const {page:page=0x1,size:size=0xa,userId:_0x232298,rechargeType:_0x2b12f7,packageId:_0x5c4e15}=_0x41930b,{role:_0x5175bd}=_0x4b9f1c[_0x15cd45(0x18c)],_0x52e4ba={};_0x2b12f7&&(_0x52e4ba[_0x15cd45(0x130)]=_0x2b12f7),_0x52e4ba[_0x15cd45(0x13f)]=_0x232298||(0x0,typeorm_2[_0x15cd45(0x11b)])(0x186a0),_0x5c4e15&&(_0x52e4ba[_0x15cd45(0x104)]={'$like':'%'+_0x5c4e15+'%'});const [_0x47efcd,_0x56a63b]=await this[_0x15cd45(0x167)][_0x15cd45(0xfb)]({'where':_0x52e4ba,'order':{'id':_0x15cd45(0xe5)},'skip':(page-0x1)*size,'take':size}),_0x30dd73=_0x47efcd[_0x15cd45(0x18e)](_0x221898=>_0x221898[_0x15cd45(0x13f)]),_0x3fdf9b=await this[_0x15cd45(0x196)][_0x15cd45(0x199)]({'where':{'id':(0x0,typeorm_2['In'])(_0x30dd73)}});return _0x47efcd[_0x15cd45(0x10b)](_0x491b58=>{const _0x3c6918=_0x15cd45,_0x4d2250=_0x3fdf9b[_0x3c6918(0x199)](_0x1d481d=>_0x1d481d['id']===_0x491b58[_0x3c6918(0x13f)]);_0x491b58[_0x3c6918(0xf6)]=_0x4d2250===null||_0x4d2250===void 0x0?void 0x0:_0x4d2250[_0x3c6918(0xf6)],_0x491b58[_0x3c6918(0x107)]=_0x4d2250===null||_0x4d2250===void 0x0?void 0x0:_0x4d2250[_0x3c6918(0x107)],_0x491b58['phone']=_0x4d2250===null||_0x4d2250===void 0x0?void 0x0:_0x4d2250['phone'],_0x491b58['status']=_0x4d2250===null||_0x4d2250===void 0x0?void 0x0:_0x4d2250[_0x3c6918(0x19b)],_0x491b58[_0x3c6918(0xfa)]=_0x4d2250===null||_0x4d2250===void 0x0?void 0x0:_0x4d2250[_0x3c6918(0xfa)];}),_0x5175bd!=='super'&&_0x47efcd[_0x15cd45(0x10b)](_0x35f7f8=>{const _0x447b43=_0x15cd45;_0x35f7f8[_0x447b43(0x107)]=_0x35f7f8[_0x447b43(0x107)]?(0x0,utils_1[_0x447b43(0x197)])(_0x35f7f8[_0x447b43(0x107)]):'',_0x35f7f8['phone']=_0x35f7f8[_0x447b43(0x129)]?(0x0,utils_1[_0x447b43(0x197)])(_0x35f7f8[_0x447b43(0x129)]):'';}),{'rows':_0x47efcd,'count':_0x56a63b};}catch(_0x12c760){console[_0x15cd45(0x12c)](_0x15cd45(0x16c),_0x12c760);throw new common_1[(_0x15cd45(0xfc))](_0x15cd45(0x109),common_1[_0x15cd45(0x14d)][_0x15cd45(0xf9)]);}}async['queryUserBalanceByIds'](_0x589aee){const _0xa6364d=_0x2cb6dd;return await this[_0xa6364d(0x12b)][_0xa6364d(0x199)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x589aee)}});}async[_0x2cb6dd(0xfe)](_0x1fc020,_0x4f328b){const _0x2e624b=_0x2cb6dd;return await this[_0x2e624b(0x185)](_0x1fc020,_0x2e624b(0x195),-_0x4f328b);}async['upgradeBalance'](){const _0x1e2892=_0x2cb6dd,_0x2cdcb4=await this[_0x1e2892(0x196)][_0x1e2892(0x199)]();if(!_0x2cdcb4[_0x1e2892(0x18b)])return;const _0x2d3e5f=await this['globalConfigService'][_0x1e2892(0x164)]([_0x1e2892(0xe2)]);if(!_0x2d3e5f)await this[_0x1e2892(0x11f)][_0x1e2892(0x156)]({'settings':[{'configKey':'upgradeStatus','configVal':'1'}]});else throw new common_1[(_0x1e2892(0xfc))](_0x1e2892(0x10e),common_1['HttpStatus'][_0x1e2892(0xf9)]);_0x2cdcb4['forEach'](_0x3e293d=>{const _0x4ace1e=_0x1e2892,{id:_0x56d628}=_0x3e293d;this['balanceEntity'][_0x4ace1e(0x166)]({'where':{'userId':_0x56d628}})['then'](_0x5d12d1=>{const _0x4e527e=_0x4ace1e;if(!_0x5d12d1)return;this[_0x4e527e(0x138)](_0x56d628,_0x5d12d1);});});}async['writeOldBalanceToNewTable'](_0x324dcf,_0x4424a7){const _0x4ce450=_0x2cb6dd,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x4424a7,_0x133fd7=await this[_0x4ce450(0x126)][_0x4ce450(0x166)]({'where':{'userId':_0x324dcf}}),_0x1637e3={'userId':_0x324dcf,'model3Count':Number(usesLeft),'model4Count':(_0x133fd7===null||_0x133fd7===void 0x0?void 0x0:_0x133fd7[_0x4ce450(0xdf)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x133fd7===null||_0x133fd7===void 0x0?void 0x0:_0x133fd7[_0x4ce450(0x198)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x4f541b=await this[_0x4ce450(0x12b)]['findOne']({'where':{'userId':_0x324dcf}});_0x4f541b?common_1[_0x4ce450(0x121)]['debug']('用户'+_0x324dcf+'账户信息已经存在、迁移无效',_0x4ce450(0x187)):this[_0x4ce450(0x12b)][_0x4ce450(0x18a)](_0x1637e3)[_0x4ce450(0x181)](_0x3002b6=>{const _0x3ea660=_0x4ce450;common_1[_0x3ea660(0x121)][_0x3ea660(0x133)]('用户'+_0x324dcf+_0x3ea660(0xfd),_0x3ea660(0x187));})[_0x4ce450(0xe6)](_0x16fb3e=>{const _0x115ee4=_0x4ce450;console[_0x115ee4(0x12c)](_0x115ee4(0x16c),_0x16fb3e),common_1[_0x115ee4(0x121)][_0x115ee4(0x133)]('用户'+_0x324dcf+_0x115ee4(0x154),'BalanceService');});}async['inheritVisitorData'](_0x37e00a){const _0x5b7b78=_0x2cb6dd,{fingerprint:_0x359847}=_0x37e00a['headers'],{id:_0x422628}=_0x37e00a[_0x5b7b78(0x18c)];return await this[_0x5b7b78(0xeb)][_0x5b7b78(0x157)]({'userId':Number(_0x359847)},{'userId':_0x422628}),await this[_0x5b7b78(0x119)][_0x5b7b78(0x157)]({'userId':Number(_0x359847)},{'userId':_0x422628}),await this[_0x5b7b78(0x192)][_0x5b7b78(0x157)]({'userId':Number(_0x359847)},{'userId':_0x422628}),0x1;}async[_0x2cb6dd(0x12a)](_0x124bb7){const _0x30f208=_0x2cb6dd,{fingerprint:_0x3f66b8}=_0x124bb7['headers'],_0x57b083=await this[_0x30f208(0xeb)][_0x30f208(0xdf)]({'where':{'userId':_0x3f66b8}}),_0x210ea7=await this[_0x30f208(0x119)][_0x30f208(0xdf)]({'where':{'userId':_0x3f66b8}}),_0x1c398f=await this[_0x30f208(0x192)][_0x30f208(0xdf)]({'where':{'userId':_0x3f66b8}});return _0x57b083||_0x210ea7||_0x1c398f||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x2cb6dd(0xe1)])(),__param(0x0,(0x0,typeorm_1[_0x2cb6dd(0x18f)])(balance_entity_1[_0x2cb6dd(0x16e)])),__param(0x1,(0x0,typeorm_1[_0x2cb6dd(0x18f)])(userBalance_entity_1[_0x2cb6dd(0x103)])),__param(0x2,(0x0,typeorm_1[_0x2cb6dd(0x18f)])(accountLog_entity_1['AccountLogEntity'])),__param(0x3,(0x0,typeorm_1[_0x2cb6dd(0x18f)])(cramiPackage_entity_1[_0x2cb6dd(0x162)])),__param(0x4,(0x0,typeorm_1[_0x2cb6dd(0x18f)])(config_entity_1[_0x2cb6dd(0x159)])),__param(0x5,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x2cb6dd(0x174)])),__param(0x6,(0x0,typeorm_1[_0x2cb6dd(0x18f)])(salesUsers_entity_1[_0x2cb6dd(0x14b)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1['WhiteListEntity'])),__param(0x8,(0x0,typeorm_1[_0x2cb6dd(0x18f)])(fingerprint_entity_1[_0x2cb6dd(0x168)])),__param(0x9,(0x0,typeorm_1[_0x2cb6dd(0x18f)])(chatGroup_entity_1['ChatGroupEntity'])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x2cb6dd(0xdd)])),__param(0xb,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1['MidjourneyEntity'])),__metadata(_0x2cb6dd(0x100),[typeorm_2[_0x2cb6dd(0xef)],typeorm_2[_0x2cb6dd(0xef)],typeorm_2[_0x2cb6dd(0xef)],typeorm_2['Repository'],typeorm_2[_0x2cb6dd(0xef)],typeorm_2[_0x2cb6dd(0xef)],typeorm_2[_0x2cb6dd(0xef)],typeorm_2[_0x2cb6dd(0xef)],typeorm_2[_0x2cb6dd(0xef)],typeorm_2[_0x2cb6dd(0xef)],typeorm_2['Repository'],typeorm_2[_0x2cb6dd(0xef)],sales_service_1[_0x2cb6dd(0x149)],globalConfig_service_1[_0x2cb6dd(0x127)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;