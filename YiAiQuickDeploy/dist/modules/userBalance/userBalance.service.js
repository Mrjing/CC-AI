'use strict';const _0x1546c9=_0x523d;function _0xfc00(){const _0x3bbf8c=['odel4','accountLogEntity','commissionAmount','catch','__decorate','toFixed','您已经升级过了、请勿重复操作！','inviteGiveSendDrawMjCount','UserEntity','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','isInteger','upgradeBalance','getOwnPropertyDescriptor','memberModel3Count','旧账户信息迁移成功','getFullYear','packageId','消费余额失败！','1021120QsTfAl','./accountLog.entity','find','sumModel3Count','712840FLspKo','username','DESC','days','whiteListEntity','status','当前套餐不存在！','goodsId','useModel3Count','day','memberModel4Count','@nestjs/typeorm','saveRecordRechargeLog','当前用户无需创建账户信息！','validateBalance','RechargeType','2530720HonZpn','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','PAYMENT_REQUIRED','formatCreateOrUpdateDate','SalesService','user','>\x20或购买专属套餐\x20！','MjCount','ChatLogEntity','upgradeStatus','invitedGuestSendModel4Count','INVITE_GIFT','inheritVisitorData','useModel3Token','InjectRepository','add','GlobalConfigService','LessThan','updatedAt','BalanceEntity','../../common/utils','vxNumber','registerSendModel3Count','firstRregisterSendDrawMjCount','ChatGroupEntity','充值失败','useModel4Token','phone','getRechargeLog','inviteGiveSendModel3Count','queryUserBalance','12ocjjcY','log','model4','getDate','__param','invitedGuestSendModel3Count','includes','缺失当前套餐ID、充值失败！','writeOldBalanceToNewTable','debug','../chatgpt/whiteList.entity','default','CramiPackageEntity','MidjourneyEntity','查询用户账户信息失败！','firstRegisterSendRank','userId','reduce','globalConfigService','configVal','2210cXjPzY','memberDrawMjCount','6084KIxued','firstRregisterSendModel3Count','BAD_REQUEST','findAndCount','salesService','Repository','count','rechargeType','headers','./balance.entity','isUpdatedToday','addBalanceToUser','账户信息已经存在、迁移无效','save','fingerprintLogEntity','../globalConfig/globalConfig.service','@nestjs/common','cramiPackageEntity','chatGroupEntity','userBalanceEntity','object','REG_GIFT','visitorModel3Num','model4Count','queryUserBalanceByIds','userEntity','createBaseUserBalance','chatLogEntity','format','refundMjBalance','invitedGuestSendDrawMjCount','242791qcaXoc','getMonth','deductFromBalance','6otcgFt','update','../crami/cramiPackage.entity','saveCommissionAmount','41920hThjpE','../chatLog/chatLog.entity','../globalConfig/config.entity','getConfigs','缺失当前用户账户记录！','SalesUsersEntity','__esModule','configEntity','mjDraw','当前用户不存在,记录充值日志异常','design:paramtypes','function','useDrawMjToken','registerSendModel4Count','FingerprintLogEntity','odel3','salesUsersEntity','YYYY-MM-DD\x20HH:mm:ss','formatDate','drawMjCount','useModel4Count','balanceEntity','visitorModel4Num','UserBalanceService','getVisitorCount','configKey','metadata','Logger','length','expireDateCn','../../common/utils/date','error:\x20','createRandomUid','inviteGiveSendModel4Count','forEach','YYYY-MM-DD','497091lQJOTL','midjourneyEntity','ConfigEntity','旧账户信息迁移失败','weight','用户充值失败！','expirationTime','findOne','充值的工单信息:','getAccountLog','./userBalance.entity','查询当前用户余额失败！','../midjourney/midjourney.entity','email','then','../user/user.entity','BalanceService','firstRegisterSendStatus','createSalesRecords','map','avatar','firstRregisterSendModel4Count','./fingerprint.entity','HttpException','decorate','defineProperty','affected','SCAN_PAY','Injectable','total','WhiteListEntity','inviteSendStatus','model3Count','HttpStatus','model3','registerSendDrawMjCount','__metadata'];_0xfc00=function(){return _0x3bbf8c;};return _0xfc00();}(function(_0x3ed499,_0x18569d){const _0x1918ff=_0x523d,_0x239813=_0x3ed499();while(!![]){try{const _0x5cbb0d=parseInt(_0x1918ff(0x140))/0x1+parseInt(_0x1918ff(0x147))/0x2*(parseInt(_0x1918ff(0x143))/0x3)+parseInt(_0x1918ff(0xd8))/0x4+-parseInt(_0x1918ff(0xdc))/0x5*(parseInt(_0x1918ff(0x10b))/0x6)+parseInt(_0x1918ff(0xa1))/0x7+-parseInt(_0x1918ff(0xec))/0x8+parseInt(_0x1918ff(0x121))/0x9*(parseInt(_0x1918ff(0x11f))/0xa);if(_0x5cbb0d===_0x18569d)break;else _0x239813['push'](_0x239813['shift']());}catch(_0x1e2a12){_0x239813['push'](_0x239813['shift']());}}}(_0xfc00,0x26ccc));function _0x523d(_0x4a3535,_0x3d0005){const _0xfc0087=_0xfc00();return _0x523d=function(_0x523db5,_0x557182){_0x523db5=_0x523db5-0x92;let _0x54a0ad=_0xfc0087[_0x523db5];return _0x54a0ad;},_0x523d(_0x4a3535,_0x3d0005);}var __decorate=this&&this[_0x1546c9(0xca)]||function(_0xb773b3,_0xbe33b8,_0x24e66a,_0x12ea0b){const _0x1e7222=_0x1546c9;var _0x26ab6a=arguments['length'],_0x11205e=_0x26ab6a<0x3?_0xbe33b8:_0x12ea0b===null?_0x12ea0b=Object[_0x1e7222(0xd2)](_0xbe33b8,_0x24e66a):_0x12ea0b,_0x19238c;if(typeof Reflect===_0x1e7222(0x135)&&typeof Reflect['decorate']===_0x1e7222(0x152))_0x11205e=Reflect[_0x1e7222(0xb9)](_0xb773b3,_0xbe33b8,_0x24e66a,_0x12ea0b);else{for(var _0x1a999a=_0xb773b3[_0x1e7222(0x99)]-0x1;_0x1a999a>=0x0;_0x1a999a--)if(_0x19238c=_0xb773b3[_0x1a999a])_0x11205e=(_0x26ab6a<0x3?_0x19238c(_0x11205e):_0x26ab6a>0x3?_0x19238c(_0xbe33b8,_0x24e66a,_0x11205e):_0x19238c(_0xbe33b8,_0x24e66a))||_0x11205e;}return _0x26ab6a>0x3&&_0x11205e&&Object[_0x1e7222(0xba)](_0xbe33b8,_0x24e66a,_0x11205e),_0x11205e;},__metadata=this&&this[_0x1546c9(0xc5)]||function(_0x1f8579,_0x3e69b3){const _0x27b2bc=_0x1546c9;if(typeof Reflect===_0x27b2bc(0x135)&&typeof Reflect[_0x27b2bc(0x97)]===_0x27b2bc(0x152))return Reflect['metadata'](_0x1f8579,_0x3e69b3);},__param=this&&this[_0x1546c9(0x10f)]||function(_0x1754bf,_0xab43bc){return function(_0xf93d9c,_0x1d212a){_0xab43bc(_0xf93d9c,_0x1d212a,_0x1754bf);};};Object[_0x1546c9(0xba)](exports,_0x1546c9(0x14d),{'value':!![]}),exports['UserBalanceService']=void 0x0;const globalConfig_service_1=require(_0x1546c9(0x130)),typeorm_1=require(_0x1546c9(0xe7)),balance_entity_1=require(_0x1546c9(0x12a)),common_1=require(_0x1546c9(0x131)),typeorm_2=require('typeorm'),balance_constant_1=require('../../common/constants/balance.constant'),accountLog_entity_1=require(_0x1546c9(0xd9)),utils_1=require(_0x1546c9(0x100)),config_entity_1=require(_0x1546c9(0x149)),cramiPackage_entity_1=require(_0x1546c9(0x145)),userBalance_entity_1=require(_0x1546c9(0xab)),date_1=require(_0x1546c9(0x9b)),user_entity_1=require(_0x1546c9(0xb0)),salesUsers_entity_1=require('../sales/salesUsers.entity'),sales_service_1=require('../sales/sales.service'),whiteList_entity_1=require(_0x1546c9(0x115)),fingerprint_entity_1=require(_0x1546c9(0xb7)),chatLog_entity_1=require(_0x1546c9(0x148)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),midjourney_entity_1=require(_0x1546c9(0xad));let UserBalanceService=class UserBalanceService{constructor(_0x574ddc,_0x543629,_0x3a0f0a,_0x1cefee,_0x55f635,_0x15d067,_0x11d7e6,_0x5be4f3,_0x4958cb,_0x4d526c,_0x5a7dc1,_0x1c5389,_0x43687c,_0x42e73e){const _0x103b24=_0x1546c9;this[_0x103b24(0x92)]=_0x574ddc,this[_0x103b24(0x134)]=_0x543629,this['accountLogEntity']=_0x3a0f0a,this[_0x103b24(0x132)]=_0x1cefee,this[_0x103b24(0x14e)]=_0x55f635,this[_0x103b24(0x13a)]=_0x15d067,this[_0x103b24(0x157)]=_0x11d7e6,this['whiteListEntity']=_0x5be4f3,this[_0x103b24(0x12f)]=_0x4958cb,this['chatGroupEntity']=_0x4d526c,this[_0x103b24(0x13c)]=_0x5a7dc1,this['midjourneyEntity']=_0x1c5389,this[_0x103b24(0x125)]=_0x43687c,this[_0x103b24(0x11d)]=_0x42e73e;}async['addBalanceToNewUser'](_0x2d908e,_0x51a495){const _0x20bc68=_0x1546c9;try{const _0x2cf70c=await this[_0x20bc68(0x14e)][_0x20bc68(0xda)]({'where':{'configKey':(0x0,typeorm_2['In'])(['registerSendStatus',_0x20bc68(0x102),_0x20bc68(0x154),_0x20bc68(0xc4),_0x20bc68(0xb2),_0x20bc68(0x11a),_0x20bc68(0x122),'firstRregisterSendModel4Count',_0x20bc68(0x103),_0x20bc68(0xc0),'inviteGiveSendModel3Count',_0x20bc68(0x9e),_0x20bc68(0xcd),'invitedGuestSendModel3Count',_0x20bc68(0x13f),_0x20bc68(0xf6)])}}),_0x525304=_0x2cf70c[_0x20bc68(0x11c)]((_0x3afc43,_0x2c88ed)=>{const _0x425fcb=_0x20bc68,_0x7d2f9d=Number(_0x2c88ed['configVal']),_0xc89cbd=Number[_0x425fcb(0xd0)](_0x7d2f9d)&&_0x7d2f9d>0x0?_0x7d2f9d:0x0;return _0x3afc43[_0x2c88ed[_0x425fcb(0x96)]]=_0xc89cbd,_0x3afc43;},{});let _0x16cb37=0x0,_0x1a1fd6=0x0,_0x30e2fb=0x0;_0x525304['registerSendStatus']===0x1&&(_0x16cb37=_0x16cb37+_0x525304[_0x20bc68(0x102)],_0x1a1fd6=_0x1a1fd6+_0x525304[_0x20bc68(0x154)],_0x30e2fb=_0x30e2fb+_0x525304[_0x20bc68(0xc4)]),_0x525304['registerSendStatus']===0x1&&_0x525304[_0x20bc68(0xb2)]===0x1&&_0x2d908e<=_0x525304['firstRegisterSendRank']&&(_0x16cb37=_0x16cb37+_0x525304[_0x20bc68(0x122)],_0x1a1fd6=_0x1a1fd6+_0x525304[_0x20bc68(0xb6)],_0x30e2fb=_0x30e2fb+_0x525304[_0x20bc68(0x103)]),await this[_0x20bc68(0xe8)]({'userId':_0x2d908e,'rechargeType':balance_constant_1[_0x20bc68(0xeb)][_0x20bc68(0x136)],'model3Count':_0x16cb37,'drawMjCount':_0x30e2fb,'model4Count':_0x1a1fd6}),_0x51a495&&(Number(_0x525304[_0x20bc68(0xc0)])===0x1&&(_0x16cb37=_0x16cb37+Number(_0x525304[_0x20bc68(0x110)]),_0x1a1fd6=_0x1a1fd6+Number(_0x525304['invitedGuestSendModel4Count']),_0x30e2fb=_0x30e2fb+Number(_0x525304[_0x20bc68(0x13f)]),await this['saveRecordRechargeLog']({'userId':_0x2d908e,'rechargeType':balance_constant_1[_0x20bc68(0xeb)][_0x20bc68(0xf7)],'model3Count':_0x525304[_0x20bc68(0x110)],'model4Count':_0x525304[_0x20bc68(0xf6)],'drawMjCount':_0x525304[_0x20bc68(0x13f)]}),await this[_0x20bc68(0x12c)](_0x51a495,{'model3Count':_0x525304[_0x20bc68(0x109)],'model4Count':_0x525304['inviteGiveSendModel4Count'],'drawMjCount':_0x525304[_0x20bc68(0xcd)]}),await this[_0x20bc68(0xe8)]({'userId':_0x51a495,'rechargeType':balance_constant_1['RechargeType']['REFER_GIFT'],'model3Count':_0x525304[_0x20bc68(0x109)],'model4Count':_0x525304[_0x20bc68(0x9e)],'drawMjCount':_0x525304['inviteGiveSendDrawMjCount']}))),await this[_0x20bc68(0x134)][_0x20bc68(0x12e)]({'userId':_0x2d908e,'model3Count':_0x16cb37,'model4Count':_0x1a1fd6,'drawMjCount':_0x30e2fb,'useTokens':0x0});}catch(_0x385974){console['log']('error:\x20',_0x385974);throw new common_1['HttpException']('注册赠送失败,请联系管理员！',common_1[_0x20bc68(0xc2)][_0x20bc68(0x123)]);}}async[_0x1546c9(0xea)](_0x40b1fb,_0x48d6cd,_0xcb5c95){const _0x4cc085=_0x1546c9,{id:_0x5d1712,role:_0x4868b0}=_0x40b1fb[_0x4cc085(0xf1)];let _0x117a23=await this[_0x4cc085(0x134)][_0x4cc085(0xa8)]({'where':{'userId':_0x5d1712}});!_0x117a23&&(_0x117a23=await this['createBaseUserBalance'](_0x5d1712));if(_0x4868b0==='visitor')return this['validateVisitorBalance'](_0x40b1fb,_0x48d6cd,_0xcb5c95);const _0x2a9011=await this[_0x4cc085(0x14e)][_0x4cc085(0xa8)]({'where':{'configKey':_0x4cc085(0x101)}}),_0x5e4fa0=_0x2a9011?_0x2a9011[_0x4cc085(0x11e)]:'---',_0x4b5e52=_0x48d6cd===_0x4cc085(0xc3)?_0x4cc085(0xd3):_0x48d6cd==='model4'?_0x4cc085(0xe6):_0x48d6cd===_0x4cc085(0x14f)?_0x4cc085(0x120):null,_0x5a96ec=_0x48d6cd===_0x4cc085(0xc3)?_0x4cc085(0xc1):_0x48d6cd===_0x4cc085(0x10d)?'model4Count':_0x48d6cd===_0x4cc085(0x14f)?_0x4cc085(0x15a):null;if(_0x117a23['packageId']&&_0x117a23[_0x4b5e52]<_0xcb5c95){if(_0x117a23[_0x5a96ec]<_0xcb5c95)throw new common_1['HttpException']('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x5e4fa0+'>\x20或购买专属套餐\x20！',common_1[_0x4cc085(0xc2)]['PAYMENT_REQUIRED']);}if(!_0x117a23['packageId']&&_0x117a23[_0x5a96ec]<_0xcb5c95)throw new common_1[(_0x4cc085(0xb8))](_0x4cc085(0xcf)+_0x5e4fa0+_0x4cc085(0xf2),common_1[_0x4cc085(0xc2)][_0x4cc085(0xee)]);return _0x117a23;}async['validateVisitorBalance'](_0x2ddc59,_0x2832af,_0xd62ca4){const _0x4f366a=_0x1546c9,{id:_0x250176}=_0x2ddc59[_0x4f366a(0xf1)],_0x4499dc=_0x2832af===_0x4f366a(0xc3)?_0x4f366a(0xc1):_0x2832af===_0x4f366a(0x10d)?_0x4f366a(0x138):_0x2832af==='mjDraw'?'drawMjCount':null,_0x190df4=new Date(),_0x4512d3=await this[_0x4f366a(0x12f)][_0x4f366a(0xa8)]({'where':{'fingerprint':_0x250176}}),{visitorModel3Num:_0x2cf7da,visitorModel4Num:_0x1a51f4,visitorMJNum:_0x32fb60}=await this['globalConfigService'][_0x4f366a(0x14a)]([_0x4f366a(0x137),_0x4f366a(0x93),'visitorMJNum']),_0xb26015={'model3Count':_0x2cf7da?Number(_0x2cf7da):0x0,'model4Count':_0x1a51f4?Number(_0x1a51f4):0x0,'drawMjCount':_0x32fb60?Number(_0x32fb60):0x0};if(!_0x4512d3){const _0x1b55b6={'fingerprint':_0x250176,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x1b55b6[_0x4499dc]=_0x1b55b6[_0x4499dc]+_0xd62ca4;if(_0x1b55b6[_0x4499dc]>_0xb26015[_0x4499dc])throw new common_1[(_0x4f366a(0xb8))](_0x4f366a(0xed),common_1[_0x4f366a(0xc2)][_0x4f366a(0xee)]);else return await this[_0x4f366a(0x12f)][_0x4f366a(0x12e)](_0x1b55b6),!![];}else{const {model3Count:_0xb4083c,model4Count:_0x1d7470,drawMjCount:_0x49eb4a}=_0x4512d3;let _0x1b4d16={'model3Count':_0xb4083c,'model4Count':_0x1d7470,'drawMjCount':_0x49eb4a};const _0x4c4b08=Number(new Date(_0x4512d3[_0x4f366a(0xfe)])),_0x10530b=this['isUpdatedToday'](_0x4c4b08);_0x10530b?_0x1b4d16[_0x4499dc]=_0x1b4d16[_0x4499dc]+_0xd62ca4:(_0x1b4d16={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x1b4d16[_0x4499dc]=_0x1b4d16[_0x4499dc]+_0xd62ca4);if(_0x1b4d16[_0x4499dc]>_0xb26015[_0x4499dc])throw new common_1[(_0x4f366a(0xb8))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1['HttpStatus']['PAYMENT_REQUIRED']);else return await this[_0x4f366a(0x12f)][_0x4f366a(0x144)]({'fingerprint':_0x250176},_0x1b4d16),!![];}}[_0x1546c9(0x12b)](_0xb6cddb){const _0x323815=_0x1546c9,_0x37151c=new Date(),_0x370787=new Date(_0x37151c[_0x323815(0xd5)](),_0x37151c[_0x323815(0x141)](),_0x37151c[_0x323815(0x10e)]());return _0xb6cddb>=_0x370787;}async[_0x1546c9(0x142)](_0x15a6d6,_0x12e9a9,_0x41ee95,_0x4271be=0x0){const _0x115f1f=_0x1546c9,_0x5b600a=await this[_0x115f1f(0x134)][_0x115f1f(0xa8)]({'where':{'userId':_0x15a6d6}});if(!_0x5b600a)throw new common_1[(_0x115f1f(0xb8))](_0x115f1f(0x14b),common_1[_0x115f1f(0xc2)]['BAD_REQUEST']);const _0x1e8b8e=_0x12e9a9==='model3'?'memberModel3Count':_0x12e9a9===_0x115f1f(0x10d)?_0x115f1f(0xe6):_0x12e9a9===_0x115f1f(0x14f)?_0x115f1f(0x120):null,_0x4e03c3=_0x12e9a9===_0x115f1f(0xc3)?_0x115f1f(0xc1):_0x12e9a9===_0x115f1f(0x10d)?_0x115f1f(0x138):_0x12e9a9===_0x115f1f(0x14f)?_0x115f1f(0x15a):null,_0xd9e5e7=_0x5b600a[_0x115f1f(0xd6)]&&_0x5b600a[_0x1e8b8e]<_0x41ee95?_0x4e03c3:_0x5b600a[_0x115f1f(0xd6)]?_0x1e8b8e:_0x4e03c3;let _0x115932=null;_0xd9e5e7['includes'](_0x115f1f(0x156))&&(_0x115932=_0x115f1f(0xf9));_0xd9e5e7[_0x115f1f(0x111)](_0x115f1f(0xc6))&&(_0x115932='useModel4Token');_0xd9e5e7[_0x115f1f(0x111)](_0x115f1f(0xf3))&&(_0x115932='useDrawMjToken');const _0x1a3c0d={[_0xd9e5e7]:_0x5b600a[_0xd9e5e7]-_0x41ee95<0x0?0x0:_0x5b600a[_0xd9e5e7]-_0x41ee95,[_0x115932]:_0x5b600a[_0x115932]+_0x4271be};_0x115932===_0x115f1f(0xf9)&&(_0x1a3c0d[_0x115f1f(0xe4)]=_0x5b600a[_0x115f1f(0xe4)]+_0x41ee95),_0x115932===_0x115f1f(0x106)&&(_0x1a3c0d[_0x115f1f(0x15b)]=_0x5b600a['useModel4Count']+_0x41ee95);const _0x45bdf8=await this[_0x115f1f(0x134)]['update']({'userId':_0x15a6d6},_0x1a3c0d);if(_0x45bdf8[_0x115f1f(0xbb)]===0x0)throw new common_1[(_0x115f1f(0xb8))](_0x115f1f(0xd7),common_1[_0x115f1f(0xc2)][_0x115f1f(0x123)]);}async[_0x1546c9(0x10a)](_0xa51b7a){const _0x40a811=_0x1546c9;try{const _0x39dd82=await this[_0x40a811(0x134)]['findOne']({'where':{'userId':_0xa51b7a},'select':[_0x40a811(0xd6),_0x40a811(0xc1),'model4Count','drawMjCount',_0x40a811(0xd3),_0x40a811(0xe6),_0x40a811(0x120),'useModel3Count',_0x40a811(0x15b),_0x40a811(0xf9),_0x40a811(0x106),_0x40a811(0x153),_0x40a811(0xa7)]});if(!_0x39dd82){const _0x4a1f61=await this['createBaseUserBalance'](_0xa51b7a);if(_0x4a1f61)return await this[_0x40a811(0x10a)](_0xa51b7a);else throw new common_1[(_0x40a811(0xb8))](_0x40a811(0xac),common_1[_0x40a811(0xc2)]['BAD_REQUEST']);}return _0x39dd82[_0x40a811(0xdb)]=_0x39dd82['packageId']?_0x39dd82[_0x40a811(0xc1)]+_0x39dd82[_0x40a811(0xd3)]:_0x39dd82[_0x40a811(0xc1)],_0x39dd82['sumModel4Count']=_0x39dd82[_0x40a811(0xd6)]?_0x39dd82[_0x40a811(0x138)]+_0x39dd82[_0x40a811(0xe6)]:_0x39dd82[_0x40a811(0x138)],_0x39dd82['sumDrawMjCount']=_0x39dd82['packageId']?_0x39dd82[_0x40a811(0x15a)]+_0x39dd82[_0x40a811(0x120)]:_0x39dd82[_0x40a811(0x15a)],_0x39dd82[_0x40a811(0xa7)]=_0x39dd82[_0x40a811(0xa7)]?(0x0,date_1[_0x40a811(0x159)])(_0x39dd82[_0x40a811(0xa7)],_0x40a811(0xa0)):null,_0x39dd82;}catch(_0x103c0f){console[_0x40a811(0x10c)](_0x40a811(0x9c),_0x103c0f);}}async[_0x1546c9(0xe8)](_0x48286a){const _0x5ad9d1=_0x1546c9,{userId:_0x2fc033,rechargeType:_0x29e704,model3Count:_0x419a45,model4Count:_0x2840cf,drawMjCount:_0x5e1ee1,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x48286a;if(!_0x2fc033)throw new common_1[(_0x5ad9d1(0xb8))](_0x5ad9d1(0x150),common_1[_0x5ad9d1(0xc2)][_0x5ad9d1(0x123)]);const _0x218666=(0x0,utils_1[_0x5ad9d1(0x9d)])();return await this[_0x5ad9d1(0xc7)][_0x5ad9d1(0x12e)]({'userId':_0x2fc033,'rechargeType':_0x29e704,'model3Count':_0x419a45,'model4Count':_0x2840cf,'drawMjCount':_0x5e1ee1,'days':days,'extent':extent,'uid':_0x218666,'pkgName':pkgName});}async[_0x1546c9(0x13b)](_0x5b1410,_0x649252={}){const _0x2f907e=_0x1546c9,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x649252,_0x2d429a=await this[_0x2f907e(0x134)][_0x2f907e(0xa8)]({'where':{'userId':_0x5b1410}});if(_0x2d429a)throw new common_1[(_0x2f907e(0xb8))](_0x2f907e(0xe9),common_1[_0x2f907e(0xc2)][_0x2f907e(0x123)]);return await this[_0x2f907e(0x134)][_0x2f907e(0x12e)]({'userId':_0x5b1410,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x1546c9(0x12c)](_0x44c553,_0x308b43,_0x51a5ad=-0x1){const _0x56eb24=_0x1546c9;try{const _0x2c4224=await this['userBalanceEntity'][_0x56eb24(0xa8)]({'where':{'userId':_0x44c553}})||await this['createBaseUserBalance'](_0x44c553);if(!_0x2c4224)throw new common_1[(_0x56eb24(0xb8))](_0x56eb24(0x119),common_1[_0x56eb24(0xc2)][_0x56eb24(0x123)]);const {model3Count:_0x1eae3d,model4Count:_0x440202,drawMjCount:_0x5e50dc,memberModel3Count:_0x530b48,memberModel4Count:_0x2bbe17,memberDrawMjCount:_0x404169}=_0x2c4224;let _0x4205a3={};if(_0x51a5ad>0x0){const {packageId:_0x55801b}=_0x308b43;if(!_0x55801b)throw new common_1['HttpException'](_0x56eb24(0x112),common_1[_0x56eb24(0xc2)]['BAD_REQUEST']);const _0x5bc2d7=await this[_0x56eb24(0x132)][_0x56eb24(0xa8)]({'where':{'id':_0x55801b}});if(!_0x5bc2d7)throw new common_1[(_0x56eb24(0xb8))](_0x56eb24(0xe2),common_1['HttpStatus']['BAD_REQUEST']);const {weight:_0x1ecc77}=_0x5bc2d7;if(!_0x2c4224[_0x56eb24(0xd6)])_0x4205a3={'memberModel3Count':_0x1eae3d+_0x308b43['model3Count'],'memberModel4Count':_0x440202+_0x308b43[_0x56eb24(0x138)],'memberDrawMjCount':_0x5e50dc+_0x308b43[_0x56eb24(0x15a)],'expirationTime':(0x0,date_1[_0x56eb24(0x116)])()[_0x56eb24(0xfb)](_0x51a5ad>0x0?_0x51a5ad:0x0,_0x56eb24(0xe5))[_0x56eb24(0x13d)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x55801b};else{const _0x1f31ae=await this['cramiPackageEntity'][_0x56eb24(0xa8)]({'where':{'id':_0x2c4224[_0x56eb24(0xd6)]}});_0x1ecc77>=_0x1f31ae[_0x56eb24(0xa5)]&&(_0x4205a3={'memberModel3Count':_0x530b48+_0x308b43[_0x56eb24(0xc1)],'memberModel4Count':_0x2bbe17+_0x308b43[_0x56eb24(0x138)],'memberDrawMjCount':_0x404169+_0x308b43[_0x56eb24(0x15a)],'expirationTime':(0x0,date_1[_0x56eb24(0x116)])(_0x2c4224[_0x56eb24(0xa7)])[_0x56eb24(0xfb)](_0x51a5ad>0x0?_0x51a5ad:0x0,_0x56eb24(0xe5))[_0x56eb24(0x13d)](_0x56eb24(0x158)),'packageId':_0x55801b}),_0x1ecc77<_0x1f31ae[_0x56eb24(0xa5)]&&(_0x4205a3={'memberModel3Count':_0x530b48+_0x308b43[_0x56eb24(0xc1)],'memberModel4Count':_0x2bbe17+_0x308b43[_0x56eb24(0x138)],'memberDrawMjCount':_0x404169+_0x308b43[_0x56eb24(0x15a)]});}}_0x51a5ad<=0x0&&(_0x4205a3={'model3Count':_0x1eae3d+_0x308b43['model3Count'],'model4Count':_0x440202+_0x308b43[_0x56eb24(0x138)],'drawMjCount':_0x5e50dc+_0x308b43[_0x56eb24(0x15a)]});const _0x21290c=await this[_0x56eb24(0x134)][_0x56eb24(0x144)]({'userId':_0x44c553},_0x4205a3);if(_0x21290c[_0x56eb24(0xbb)]===0x0)throw new common_1['HttpException'](_0x44c553+_0x56eb24(0x105),common_1[_0x56eb24(0xc2)][_0x56eb24(0x123)]);}catch(_0x21dbc0){console[_0x56eb24(0x10c)]('error:\x20',_0x21dbc0);throw new common_1[(_0x56eb24(0xb8))](_0x56eb24(0xa6),common_1[_0x56eb24(0xc2)][_0x56eb24(0x123)]);}}async['addBalanceToOrder'](_0x2b34fa){const _0x99e77b=_0x1546c9;console[_0x99e77b(0x10c)](_0x99e77b(0xa9),_0x2b34fa);try{const {userId:_0x2851b4,goodsId:_0x31ec52}=_0x2b34fa,_0x20e3c7=await this[_0x99e77b(0x132)]['findOne']({'where':{'id':_0x2b34fa[_0x99e77b(0xe3)],'status':0x1}});if(!_0x20e3c7)throw new common_1[(_0x99e77b(0xb8))]('非法操作、当前充值套餐暂不存在！',common_1[_0x99e77b(0xc2)][_0x99e77b(0x123)]);const {model3Count:_0x446cec,model4Count:_0x2b07e7,drawMjCount:_0x1fc5aa,days:_0x21c565,name:_0x378137}=_0x20e3c7,_0x3c72d9={'model3Count':_0x446cec,'model4Count':_0x2b07e7,'drawMjCount':_0x1fc5aa,'days':_0x21c565,'packageId':_0x2b34fa[_0x99e77b(0xe3)]};await this[_0x99e77b(0x12c)](_0x2851b4,_0x3c72d9,_0x21c565),await this['saveRecordRechargeLog']({'userId':_0x2851b4,'rechargeType':balance_constant_1['RechargeType'][_0x99e77b(0xbc)],'model3Count':_0x446cec,'model4Count':_0x2b07e7,'drawMjCount':_0x1fc5aa,'pkgName':_0x378137,'days':_0x21c565});const _0x3fcbec=await this[_0x99e77b(0x13a)][_0x99e77b(0xa8)]({'where':{'id':_0x2851b4}}),{invitedBy:_0xdb3f60}=_0x3fcbec;if(_0xdb3f60){const _0x4f4c19=await this[_0x99e77b(0x13a)]['findOne']({'where':{'inviteCode':_0xdb3f60}}),_0x2d7d64=await this[_0x99e77b(0x157)]['findOne']({'where':{'userId':_0x4f4c19['id']}});if(!_0x4f4c19)return;const {id:_0x515fed}=_0x4f4c19,{performanceRatio:_0x53f9e7}=_0x2d7d64,_0x9413e={'inviterUserId':_0x515fed,'inviteeUserId':_0x2851b4,'orderId':_0x2b34fa['id'],'orderPrice':_0x2b34fa[_0x99e77b(0xbe)],'commissionPercentage':_0x53f9e7,'commissionAmount':(_0x2b34fa[_0x99e77b(0xbe)]*_0x53f9e7/0x64)[_0x99e77b(0xcb)](0x2)};await this[_0x99e77b(0x125)][_0x99e77b(0xb3)](_0x9413e),await this[_0x99e77b(0x125)][_0x99e77b(0x146)](_0x515fed,_0x9413e[_0x99e77b(0xc8)]);}}catch(_0x374dfe){console[_0x99e77b(0x10c)]('error:\x20',_0x374dfe);throw new common_1['HttpException']('充值失败！',common_1['HttpStatus'][_0x99e77b(0x123)]);}}async[_0x1546c9(0x108)](_0x559936,_0x2273aa){const _0x226b9f=_0x1546c9,{page:page=0x1,size:size=0x14}=_0x2273aa,{id:_0x40503f}=_0x559936[_0x226b9f(0xf1)],[_0x1fc428,_0x54a2fb]=await this[_0x226b9f(0xc7)][_0x226b9f(0x124)]({'where':{'userId':_0x40503f},'order':{'id':_0x226b9f(0xde)},'skip':(page-0x1)*size,'take':size});return _0x1fc428[_0x226b9f(0x9f)](_0x63f71f=>{const _0x4081b1=_0x226b9f;_0x63f71f[_0x4081b1(0x9a)]=_0x63f71f[_0x4081b1(0xdf)]>0x0?_0x63f71f[_0x4081b1(0xdf)]+'天':'永久';}),{'rows':(0x0,date_1[_0x226b9f(0xef)])(_0x1fc428),'count':_0x54a2fb};}async[_0x1546c9(0xaa)](_0x1e8cde,_0x365f5d){const _0x1fb9b0=_0x1546c9;try{const {page:page=0x1,size:size=0xa,userId:_0x577e98,rechargeType:_0x525f41,packageId:_0x286d7f}=_0x365f5d,{role:_0x375df4}=_0x1e8cde[_0x1fb9b0(0xf1)],_0x485731={};_0x525f41&&(_0x485731[_0x1fb9b0(0x128)]=_0x525f41),_0x485731['userId']=_0x577e98||(0x0,typeorm_2[_0x1fb9b0(0xfd)])(0x186a0),_0x286d7f&&(_0x485731['packageId']={'$like':'%'+_0x286d7f+'%'});const [_0x2c529a,_0x1ef339]=await this[_0x1fb9b0(0xc7)][_0x1fb9b0(0x124)]({'where':_0x485731,'order':{'id':_0x1fb9b0(0xde)},'skip':(page-0x1)*size,'take':size}),_0x2e3d78=_0x2c529a[_0x1fb9b0(0xb4)](_0x53c87c=>_0x53c87c[_0x1fb9b0(0x11b)]),_0x1da1c0=await this[_0x1fb9b0(0x13a)][_0x1fb9b0(0xda)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2e3d78)}});return _0x2c529a[_0x1fb9b0(0x9f)](_0x12b289=>{const _0x238b77=_0x1fb9b0,_0x27762f=_0x1da1c0[_0x238b77(0xda)](_0xb11a9a=>_0xb11a9a['id']===_0x12b289[_0x238b77(0x11b)]);_0x12b289[_0x238b77(0xdd)]=_0x27762f===null||_0x27762f===void 0x0?void 0x0:_0x27762f[_0x238b77(0xdd)],_0x12b289['email']=_0x27762f===null||_0x27762f===void 0x0?void 0x0:_0x27762f[_0x238b77(0xae)],_0x12b289[_0x238b77(0x107)]=_0x27762f===null||_0x27762f===void 0x0?void 0x0:_0x27762f[_0x238b77(0x107)],_0x12b289[_0x238b77(0xe1)]=_0x27762f===null||_0x27762f===void 0x0?void 0x0:_0x27762f[_0x238b77(0xe1)],_0x12b289['avatar']=_0x27762f===null||_0x27762f===void 0x0?void 0x0:_0x27762f[_0x238b77(0xb5)];}),_0x375df4!=='super'&&_0x2c529a[_0x1fb9b0(0x9f)](_0x27ca1a=>{const _0x561c69=_0x1fb9b0;_0x27ca1a[_0x561c69(0xae)]=_0x27ca1a[_0x561c69(0xae)]?(0x0,utils_1['hideString'])(_0x27ca1a['email']):'',_0x27ca1a[_0x561c69(0x107)]=_0x27ca1a['phone']?(0x0,utils_1['hideString'])(_0x27ca1a[_0x561c69(0x107)]):'';}),{'rows':_0x2c529a,'count':_0x1ef339};}catch(_0x41e67a){console['log']('error:\x20',_0x41e67a);throw new common_1[(_0x1fb9b0(0xb8))]('查询用户账户失败！',common_1['HttpStatus'][_0x1fb9b0(0x123)]);}}async[_0x1546c9(0x139)](_0x1cfe5f){const _0xf8df01=_0x1546c9;return await this[_0xf8df01(0x134)]['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x1cfe5f)}});}async[_0x1546c9(0x13e)](_0x46bb00,_0x4abebe){const _0x474eaf=_0x1546c9;return await this['deductFromBalance'](_0x46bb00,_0x474eaf(0x14f),-_0x4abebe);}async[_0x1546c9(0xd1)](){const _0x5b90c4=_0x1546c9,_0xafc9df=await this[_0x5b90c4(0x13a)]['find']();if(!_0xafc9df['length'])return;const _0x1d6b89=await this[_0x5b90c4(0x11d)][_0x5b90c4(0x14a)]([_0x5b90c4(0xf5)]);if(!_0x1d6b89)await this[_0x5b90c4(0x11d)]['setConfig']({'settings':[{'configKey':_0x5b90c4(0xf5),'configVal':'1'}]});else throw new common_1[(_0x5b90c4(0xb8))](_0x5b90c4(0xcc),common_1['HttpStatus'][_0x5b90c4(0x123)]);_0xafc9df[_0x5b90c4(0x9f)](_0x453ed0=>{const _0x2635cf=_0x5b90c4,{id:_0x45c24d}=_0x453ed0;this['balanceEntity'][_0x2635cf(0xa8)]({'where':{'userId':_0x45c24d}})[_0x2635cf(0xaf)](_0x147db3=>{const _0x28bfc5=_0x2635cf;if(!_0x147db3)return;this[_0x28bfc5(0x113)](_0x45c24d,_0x147db3);});});}async[_0x1546c9(0x113)](_0x2546a6,_0x4c4fd9){const _0x304eea=_0x1546c9,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x4c4fd9,_0x55e4f1=await this[_0x304eea(0xe0)][_0x304eea(0xa8)]({'where':{'userId':_0x2546a6}}),_0x561650={'userId':_0x2546a6,'model3Count':Number(usesLeft),'model4Count':(_0x55e4f1===null||_0x55e4f1===void 0x0?void 0x0:_0x55e4f1[_0x304eea(0x127)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x55e4f1===null||_0x55e4f1===void 0x0?void 0x0:_0x55e4f1['useCount'])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x194517=await this[_0x304eea(0x134)]['findOne']({'where':{'userId':_0x2546a6}});_0x194517?common_1[_0x304eea(0x98)][_0x304eea(0x114)]('用户'+_0x2546a6+_0x304eea(0x12d),_0x304eea(0xb1)):this['userBalanceEntity'][_0x304eea(0x12e)](_0x561650)[_0x304eea(0xaf)](_0x45077a=>{const _0x542e73=_0x304eea;common_1[_0x542e73(0x98)][_0x542e73(0x114)]('用户'+_0x2546a6+_0x542e73(0xd4),'BalanceService');})[_0x304eea(0xc9)](_0x1e26b2=>{const _0x548246=_0x304eea;console[_0x548246(0x10c)]('error:\x20',_0x1e26b2),common_1[_0x548246(0x98)]['debug']('用户'+_0x2546a6+_0x548246(0xa4),_0x548246(0xb1));});}async[_0x1546c9(0xf8)](_0x45a447){const _0x52725d=_0x1546c9,{fingerprint:_0x1faa2a}=_0x45a447[_0x52725d(0x129)],{id:_0x56aab9}=_0x45a447[_0x52725d(0xf1)];return await this[_0x52725d(0x13c)]['update']({'userId':Number(_0x1faa2a)},{'userId':_0x56aab9}),await this['chatGroupEntity'][_0x52725d(0x144)]({'userId':Number(_0x1faa2a)},{'userId':_0x56aab9}),await this[_0x52725d(0xa2)][_0x52725d(0x144)]({'userId':Number(_0x1faa2a)},{'userId':_0x56aab9}),0x1;}async[_0x1546c9(0x95)](_0x2a2672){const _0x16f56c=_0x1546c9,{fingerprint:_0x2c381a}=_0x2a2672[_0x16f56c(0x129)],_0x8ed082=await this[_0x16f56c(0x13c)][_0x16f56c(0x127)]({'where':{'userId':_0x2c381a}}),_0x437766=await this[_0x16f56c(0x133)][_0x16f56c(0x127)]({'where':{'userId':_0x2c381a}}),_0x2a15b0=await this[_0x16f56c(0xa2)][_0x16f56c(0x127)]({'where':{'userId':_0x2c381a}});return _0x8ed082||_0x437766||_0x2a15b0||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x1546c9(0xbd)])(),__param(0x0,(0x0,typeorm_1[_0x1546c9(0xfa)])(balance_entity_1[_0x1546c9(0xff)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1['UserBalanceEntity'])),__param(0x2,(0x0,typeorm_1[_0x1546c9(0xfa)])(accountLog_entity_1['AccountLogEntity'])),__param(0x3,(0x0,typeorm_1[_0x1546c9(0xfa)])(cramiPackage_entity_1[_0x1546c9(0x117)])),__param(0x4,(0x0,typeorm_1[_0x1546c9(0xfa)])(config_entity_1[_0x1546c9(0xa3)])),__param(0x5,(0x0,typeorm_1[_0x1546c9(0xfa)])(user_entity_1[_0x1546c9(0xce)])),__param(0x6,(0x0,typeorm_1[_0x1546c9(0xfa)])(salesUsers_entity_1[_0x1546c9(0x14c)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1[_0x1546c9(0xbf)])),__param(0x8,(0x0,typeorm_1[_0x1546c9(0xfa)])(fingerprint_entity_1[_0x1546c9(0x155)])),__param(0x9,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x1546c9(0x104)])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x1546c9(0xf4)])),__param(0xb,(0x0,typeorm_1[_0x1546c9(0xfa)])(midjourney_entity_1[_0x1546c9(0x118)])),__metadata(_0x1546c9(0x151),[typeorm_2[_0x1546c9(0x126)],typeorm_2[_0x1546c9(0x126)],typeorm_2[_0x1546c9(0x126)],typeorm_2[_0x1546c9(0x126)],typeorm_2[_0x1546c9(0x126)],typeorm_2[_0x1546c9(0x126)],typeorm_2[_0x1546c9(0x126)],typeorm_2[_0x1546c9(0x126)],typeorm_2[_0x1546c9(0x126)],typeorm_2['Repository'],typeorm_2[_0x1546c9(0x126)],typeorm_2[_0x1546c9(0x126)],sales_service_1[_0x1546c9(0xf0)],globalConfig_service_1[_0x1546c9(0xfc)]])],UserBalanceService),exports[_0x1546c9(0x94)]=UserBalanceService;