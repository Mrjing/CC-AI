'use strict';const _0xaeb8a5=_0x3e17;function _0x3e17(_0x2ed2b4,_0x2ce661){const _0x2d4410=_0x2d44();return _0x3e17=function(_0x3e1768,_0x5688bc){_0x3e1768=_0x3e1768-0xa6;let _0x26b4c1=_0x2d4410[_0x3e1768];return _0x26b4c1;},_0x3e17(_0x2ed2b4,_0x2ce661);}(function(_0x4233a2,_0x269e55){const _0x1c0e28=_0x3e17,_0x299eac=_0x4233a2();while(!![]){try{const _0x42ca08=parseInt(_0x1c0e28(0x123))/0x1*(parseInt(_0x1c0e28(0xdd))/0x2)+parseInt(_0x1c0e28(0x109))/0x3*(parseInt(_0x1c0e28(0xd8))/0x4)+-parseInt(_0x1c0e28(0x156))/0x5+-parseInt(_0x1c0e28(0xe8))/0x6*(-parseInt(_0x1c0e28(0x141))/0x7)+parseInt(_0x1c0e28(0xb7))/0x8+parseInt(_0x1c0e28(0x102))/0x9*(parseInt(_0x1c0e28(0x158))/0xa)+parseInt(_0x1c0e28(0xe7))/0xb*(-parseInt(_0x1c0e28(0x160))/0xc);if(_0x42ca08===_0x269e55)break;else _0x299eac['push'](_0x299eac['shift']());}catch(_0x4d7a4c){_0x299eac['push'](_0x299eac['shift']());}}}(_0x2d44,0x19f0b));function _0x2d44(){const _0x290cda=['REFER_GIFT','reduce','addBalanceToOrder','getConfigs','model4Count','ConfigEntity','days','visitor','addBalanceToUser','当前套餐不存在！','invitedGuestSendModel3Count','count','salesService','object','旧账户信息迁移失败','headers','metadata','weight','registerSendDrawMjCount','includes','../chatgpt/whiteList.entity','用户充值失败！','useModel3Token','useCount','fingerprintLogEntity','salesUsersEntity','WhiteListEntity','inviteGiveSendDrawMjCount','userId','12GPefVd','debug','RechargeType','find','../chatGroup/chatGroup.entity','4WUCAnA','InjectRepository','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','visitorModel4Num','update','formatCreateOrUpdateDate','drawMjCount','HttpException','function','configKey','802109RuDWVd','213390BjzWzK','__decorate','chatGroupEntity','add','registerSendModel4Count','__param','decorate','forEach','ChatGroupEntity','旧账户信息迁移成功','midjourneyEntity','Repository','AccountLogEntity','validateBalance','MidjourneyEntity','../chatLog/chatLog.entity','accountLogEntity','DESC','../globalConfig/globalConfig.service','affected','UserEntity','getMonth','firstRregisterSendModel3Count','Injectable','expirationTime','./fingerprint.entity','1161yVHTKg','isUpdatedToday','defineProperty','day','缺失当前套餐ID、充值失败！','registerSendModel3Count','length','131403pDGLtM','vxNumber','username','inviteGiveSendModel4Count','../midjourney/midjourney.entity','memberModel3Count','../../common/utils','then','error:\x20','invitedGuestSendModel4Count','queryUserBalance','firstRegisterSendRank','当前用户无需创建账户信息！','---','firstRegisterSendStatus','sumDrawMjCount','balanceEntity','invitedGuestSendDrawMjCount','inviteGiveSendModel3Count','../sales/sales.service','inviteSendStatus','odel3','REG_GIFT','memberDrawMjCount','registerSendStatus','updatedAt','49135HAKmlG','getRechargeLog','design:paramtypes','../sales/salesUsers.entity','visitorModel3Num','userEntity','createSalesRecords','super','./balance.entity','useDrawMjToken','save','useModel3Count','configVal','>\x20或购买专属套餐\x20！','./accountLog.entity','hideString','消费余额失败！','注册赠送失败,请联系管理员！','UserBalanceService','configEntity','total','createRandomUid','查询当前用户余额失败！','BAD_REQUEST','inheritVisitorData','BalanceService','chatLogEntity','phone','userBalanceEntity','getOwnPropertyDescriptor','28hGgaIe','saveRecordRechargeLog','findOne','PAYMENT_REQUIRED','../crami/cramiPackage.entity','BalanceEntity','deductFromBalance','visitorMJNum','查询用户账户信息失败！','email','您已经升级过了、请勿重复操作！','odel4','YYYY-MM-DD\x20HH:mm:ss','default','findAndCount','upgradeStatus','./userBalance.entity','MjCount','GlobalConfigService','__metadata','SalesService','344135AmDaCE','FingerprintLogEntity','11260xlXHSQ','validateVisitorBalance','__esModule','SalesUsersEntity','sumModel3Count','packageId','账户信息已经存在、迁移无效','model3','84aBOzMW','useModel4Token','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','Logger','充值的工单信息:','globalConfigService','YYYY-MM-DD','useModel4Count','firstRregisterSendModel4Count','mjDraw','user','memberModel4Count','typeorm','CramiPackageEntity','writeOldBalanceToNewTable','UserBalanceEntity','refundMjBalance','HttpStatus','INVITE_GIFT','缺失当前用户账户记录！','model4','firstRregisterSendDrawMjCount','format','setConfig','model3Count','1346592oFwJoy','log','goodsId','cramiPackageEntity'];_0x2d44=function(){return _0x290cda;};return _0x2d44();}var __decorate=this&&this[_0xaeb8a5(0xe9)]||function(_0x568a93,_0x219806,_0x1445ee,_0x331217){const _0x1884c5=_0xaeb8a5;var _0x61fe26=arguments['length'],_0xba9323=_0x61fe26<0x3?_0x219806:_0x331217===null?_0x331217=Object[_0x1884c5(0x140)](_0x219806,_0x1445ee):_0x331217,_0x1443a8;if(typeof Reflect===_0x1884c5(0xc8)&&typeof Reflect[_0x1884c5(0xee)]===_0x1884c5(0xe5))_0xba9323=Reflect[_0x1884c5(0xee)](_0x568a93,_0x219806,_0x1445ee,_0x331217);else{for(var _0x137481=_0x568a93[_0x1884c5(0x108)]-0x1;_0x137481>=0x0;_0x137481--)if(_0x1443a8=_0x568a93[_0x137481])_0xba9323=(_0x61fe26<0x3?_0x1443a8(_0xba9323):_0x61fe26>0x3?_0x1443a8(_0x219806,_0x1445ee,_0xba9323):_0x1443a8(_0x219806,_0x1445ee))||_0xba9323;}return _0x61fe26>0x3&&_0xba9323&&Object[_0x1884c5(0x104)](_0x219806,_0x1445ee,_0xba9323),_0xba9323;},__metadata=this&&this[_0xaeb8a5(0x154)]||function(_0x5747cd,_0x979e43){const _0x5d611b=_0xaeb8a5;if(typeof Reflect===_0x5d611b(0xc8)&&typeof Reflect[_0x5d611b(0xcb)]===_0x5d611b(0xe5))return Reflect['metadata'](_0x5747cd,_0x979e43);},__param=this&&this[_0xaeb8a5(0xed)]||function(_0x130a61,_0x1c6e66){return function(_0xb652f2,_0x20ce80){_0x1c6e66(_0xb652f2,_0x20ce80,_0x130a61);};};Object[_0xaeb8a5(0x104)](exports,_0xaeb8a5(0x15a),{'value':!![]}),exports[_0xaeb8a5(0x135)]=void 0x0;const globalConfig_service_1=require(_0xaeb8a5(0xfa)),typeorm_1=require('@nestjs/typeorm'),balance_entity_1=require(_0xaeb8a5(0x12b)),common_1=require('@nestjs/common'),typeorm_2=require(_0xaeb8a5(0xaa)),balance_constant_1=require('../../common/constants/balance.constant'),accountLog_entity_1=require(_0xaeb8a5(0x131)),utils_1=require(_0xaeb8a5(0x10f)),config_entity_1=require('../globalConfig/config.entity'),cramiPackage_entity_1=require(_0xaeb8a5(0x145)),userBalance_entity_1=require(_0xaeb8a5(0x151)),date_1=require('../../common/utils/date'),user_entity_1=require('../user/user.entity'),salesUsers_entity_1=require(_0xaeb8a5(0x126)),sales_service_1=require(_0xaeb8a5(0x11c)),whiteList_entity_1=require(_0xaeb8a5(0xcf)),fingerprint_entity_1=require(_0xaeb8a5(0x101)),chatLog_entity_1=require(_0xaeb8a5(0xf7)),chatGroup_entity_1=require(_0xaeb8a5(0xdc)),midjourney_entity_1=require(_0xaeb8a5(0x10d));let UserBalanceService=class UserBalanceService{constructor(_0x5e7812,_0x476c35,_0x195e8c,_0x14d0f2,_0x54800e,_0x1aec9c,_0x275f3d,_0x43337c,_0x45e2fa,_0x513417,_0x576fa4,_0x3690ad,_0x448ac5,_0x4902d2){const _0xc6679b=_0xaeb8a5;this[_0xc6679b(0x119)]=_0x5e7812,this['userBalanceEntity']=_0x476c35,this[_0xc6679b(0xf8)]=_0x195e8c,this[_0xc6679b(0xba)]=_0x14d0f2,this[_0xc6679b(0x136)]=_0x54800e,this['userEntity']=_0x1aec9c,this[_0xc6679b(0xd4)]=_0x275f3d,this['whiteListEntity']=_0x43337c,this['fingerprintLogEntity']=_0x45e2fa,this[_0xc6679b(0xea)]=_0x513417,this[_0xc6679b(0x13d)]=_0x576fa4,this[_0xc6679b(0xf2)]=_0x3690ad,this[_0xc6679b(0xc7)]=_0x448ac5,this[_0xc6679b(0x165)]=_0x4902d2;}async['addBalanceToNewUser'](_0x2da628,_0x53088c){const _0x1c435b=_0xaeb8a5;try{const _0x1cccde=await this[_0x1c435b(0x136)][_0x1c435b(0xdb)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x1c435b(0x121),_0x1c435b(0x107),'registerSendModel4Count',_0x1c435b(0xcd),_0x1c435b(0x117),'firstRegisterSendRank',_0x1c435b(0xfe),_0x1c435b(0xa6),'firstRregisterSendDrawMjCount',_0x1c435b(0x11d),_0x1c435b(0x11b),_0x1c435b(0x10c),_0x1c435b(0xd6),_0x1c435b(0xc5),_0x1c435b(0x11a),_0x1c435b(0x112)])}}),_0x4351a5=_0x1cccde[_0x1c435b(0xbc)]((_0x58c704,_0x123bb8)=>{const _0x3e6fec=_0x1c435b,_0x444a22=Number(_0x123bb8[_0x3e6fec(0x12f)]),_0x2a2154=Number['isInteger'](_0x444a22)&&_0x444a22>0x0?_0x444a22:0x0;return _0x58c704[_0x123bb8[_0x3e6fec(0xe6)]]=_0x2a2154,_0x58c704;},{});let _0x334bea=0x0,_0x7de7c=0x0,_0x553b6a=0x0;_0x4351a5[_0x1c435b(0x121)]===0x1&&(_0x334bea=_0x334bea+_0x4351a5[_0x1c435b(0x107)],_0x7de7c=_0x7de7c+_0x4351a5[_0x1c435b(0xec)],_0x553b6a=_0x553b6a+_0x4351a5[_0x1c435b(0xcd)]),_0x4351a5['registerSendStatus']===0x1&&_0x4351a5[_0x1c435b(0x117)]===0x1&&_0x2da628<=_0x4351a5[_0x1c435b(0x114)]&&(_0x334bea=_0x334bea+_0x4351a5['firstRregisterSendModel3Count'],_0x7de7c=_0x7de7c+_0x4351a5[_0x1c435b(0xa6)],_0x553b6a=_0x553b6a+_0x4351a5[_0x1c435b(0xb3)]),await this[_0x1c435b(0x142)]({'userId':_0x2da628,'rechargeType':balance_constant_1[_0x1c435b(0xda)][_0x1c435b(0x11f)],'model3Count':_0x334bea,'drawMjCount':_0x553b6a,'model4Count':_0x7de7c}),_0x53088c&&(Number(_0x4351a5[_0x1c435b(0x11d)])===0x1&&(_0x334bea=_0x334bea+Number(_0x4351a5[_0x1c435b(0xc5)]),_0x7de7c=_0x7de7c+Number(_0x4351a5[_0x1c435b(0x112)]),_0x553b6a=_0x553b6a+Number(_0x4351a5[_0x1c435b(0x11a)]),await this[_0x1c435b(0x142)]({'userId':_0x2da628,'rechargeType':balance_constant_1['RechargeType'][_0x1c435b(0xb0)],'model3Count':_0x4351a5[_0x1c435b(0xc5)],'model4Count':_0x4351a5[_0x1c435b(0x112)],'drawMjCount':_0x4351a5[_0x1c435b(0x11a)]}),await this[_0x1c435b(0xc3)](_0x53088c,{'model3Count':_0x4351a5[_0x1c435b(0x11b)],'model4Count':_0x4351a5['inviteGiveSendModel4Count'],'drawMjCount':_0x4351a5[_0x1c435b(0xd6)]}),await this[_0x1c435b(0x142)]({'userId':_0x53088c,'rechargeType':balance_constant_1[_0x1c435b(0xda)][_0x1c435b(0xbb)],'model3Count':_0x4351a5[_0x1c435b(0x11b)],'model4Count':_0x4351a5['inviteGiveSendModel4Count'],'drawMjCount':_0x4351a5[_0x1c435b(0xd6)]}))),await this[_0x1c435b(0x13f)][_0x1c435b(0x12d)]({'userId':_0x2da628,'model3Count':_0x334bea,'model4Count':_0x7de7c,'drawMjCount':_0x553b6a,'useTokens':0x0});}catch(_0x21b7f4){console[_0x1c435b(0xb8)](_0x1c435b(0x111),_0x21b7f4);throw new common_1[(_0x1c435b(0xe4))](_0x1c435b(0x134),common_1[_0x1c435b(0xaf)][_0x1c435b(0x13a)]);}}async[_0xaeb8a5(0xf5)](_0x167845,_0x13044c,_0xaa816){const _0xea758b=_0xaeb8a5,{id:_0x23cda4,role:_0x790c3}=_0x167845['user'];let _0x54d800=await this['userBalanceEntity'][_0xea758b(0x143)]({'where':{'userId':_0x23cda4}});!_0x54d800&&(_0x54d800=await this['createBaseUserBalance'](_0x23cda4));if(_0x790c3===_0xea758b(0xc2))return this['validateVisitorBalance'](_0x167845,_0x13044c,_0xaa816);const _0x435827=await this['configEntity'][_0xea758b(0x143)]({'where':{'configKey':_0xea758b(0x10a)}}),_0x171b7a=_0x435827?_0x435827[_0xea758b(0x12f)]:_0xea758b(0x116),_0x654e5b=_0x13044c===_0xea758b(0x15f)?_0xea758b(0x10e):_0x13044c===_0xea758b(0xb2)?_0xea758b(0xa9):_0x13044c===_0xea758b(0xa7)?_0xea758b(0x120):null,_0x55eb27=_0x13044c==='model3'?_0xea758b(0xb6):_0x13044c===_0xea758b(0xb2)?'model4Count':_0x13044c==='mjDraw'?_0xea758b(0xe3):null;if(_0x54d800['packageId']&&_0x54d800[_0x654e5b]<_0xaa816){if(_0x54d800[_0x55eb27]<_0xaa816)throw new common_1[(_0xea758b(0xe4))](_0xea758b(0xdf)+_0x171b7a+_0xea758b(0x130),common_1['HttpStatus']['PAYMENT_REQUIRED']);}if(!_0x54d800[_0xea758b(0x15d)]&&_0x54d800[_0x55eb27]<_0xaa816)throw new common_1[(_0xea758b(0xe4))](_0xea758b(0xdf)+_0x171b7a+_0xea758b(0x130),common_1[_0xea758b(0xaf)][_0xea758b(0x144)]);return _0x54d800;}async[_0xaeb8a5(0x159)](_0x2845fe,_0x346a71,_0x2d3a97){const _0x40e87e=_0xaeb8a5,{id:_0x26834d}=_0x2845fe[_0x40e87e(0xa8)],_0xcbedda=_0x346a71===_0x40e87e(0x15f)?_0x40e87e(0xb6):_0x346a71===_0x40e87e(0xb2)?_0x40e87e(0xbf):_0x346a71===_0x40e87e(0xa7)?_0x40e87e(0xe3):null,_0xbb6db2=new Date(),_0x1f46a5=await this['fingerprintLogEntity']['findOne']({'where':{'fingerprint':_0x26834d}}),{visitorModel3Num:_0x4ceb18,visitorModel4Num:_0x53b1b5,visitorMJNum:_0x3dce84}=await this[_0x40e87e(0x165)][_0x40e87e(0xbe)]([_0x40e87e(0x127),_0x40e87e(0xe0),_0x40e87e(0x148)]),_0x2696c3={'model3Count':_0x4ceb18?Number(_0x4ceb18):0x0,'model4Count':_0x53b1b5?Number(_0x53b1b5):0x0,'drawMjCount':_0x3dce84?Number(_0x3dce84):0x0};if(!_0x1f46a5){const _0xbe1c2a={'fingerprint':_0x26834d,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0xbe1c2a[_0xcbedda]=_0xbe1c2a[_0xcbedda]+_0x2d3a97;if(_0xbe1c2a[_0xcbedda]>_0x2696c3[_0xcbedda])throw new common_1[(_0x40e87e(0xe4))](_0x40e87e(0x162),common_1[_0x40e87e(0xaf)]['PAYMENT_REQUIRED']);else return await this['fingerprintLogEntity'][_0x40e87e(0x12d)](_0xbe1c2a),!![];}else{const {model3Count:_0x373938,model4Count:_0x3a8688,drawMjCount:_0x35d18a}=_0x1f46a5;let _0x55f5a2={'model3Count':_0x373938,'model4Count':_0x3a8688,'drawMjCount':_0x35d18a};const _0x153715=Number(new Date(_0x1f46a5[_0x40e87e(0x122)])),_0x2240f0=this[_0x40e87e(0x103)](_0x153715);_0x2240f0?_0x55f5a2[_0xcbedda]=_0x55f5a2[_0xcbedda]+_0x2d3a97:(_0x55f5a2={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x55f5a2[_0xcbedda]=_0x55f5a2[_0xcbedda]+_0x2d3a97);if(_0x55f5a2[_0xcbedda]>_0x2696c3[_0xcbedda])throw new common_1['HttpException'](_0x40e87e(0x162),common_1[_0x40e87e(0xaf)]['PAYMENT_REQUIRED']);else return await this[_0x40e87e(0xd3)][_0x40e87e(0xe1)]({'fingerprint':_0x26834d},_0x55f5a2),!![];}}['isUpdatedToday'](_0xdc7726){const _0x1757bb=_0xaeb8a5,_0x1974f1=new Date(),_0x575afb=new Date(_0x1974f1['getFullYear'](),_0x1974f1[_0x1757bb(0xfd)](),_0x1974f1['getDate']());return _0xdc7726>=_0x575afb;}async[_0xaeb8a5(0x147)](_0x720fd6,_0x2407cf,_0x21d6f8,_0x4d5bc4=0x0){const _0x2fca77=_0xaeb8a5,_0x304509=await this[_0x2fca77(0x13f)][_0x2fca77(0x143)]({'where':{'userId':_0x720fd6}});if(!_0x304509)throw new common_1[(_0x2fca77(0xe4))](_0x2fca77(0xb1),common_1[_0x2fca77(0xaf)][_0x2fca77(0x13a)]);const _0x5c014e=_0x2407cf==='model3'?_0x2fca77(0x10e):_0x2407cf===_0x2fca77(0xb2)?'memberModel4Count':_0x2407cf==='mjDraw'?'memberDrawMjCount':null,_0x8d7ed9=_0x2407cf==='model3'?'model3Count':_0x2407cf===_0x2fca77(0xb2)?'model4Count':_0x2407cf===_0x2fca77(0xa7)?_0x2fca77(0xe3):null,_0x3744fd=_0x304509[_0x2fca77(0x15d)]&&_0x304509[_0x5c014e]<_0x21d6f8?_0x8d7ed9:_0x304509[_0x2fca77(0x15d)]?_0x5c014e:_0x8d7ed9;let _0x45cc8e=null;_0x3744fd[_0x2fca77(0xce)](_0x2fca77(0x11e))&&(_0x45cc8e='useModel3Token');_0x3744fd[_0x2fca77(0xce)](_0x2fca77(0x14c))&&(_0x45cc8e=_0x2fca77(0x161));_0x3744fd[_0x2fca77(0xce)](_0x2fca77(0x152))&&(_0x45cc8e=_0x2fca77(0x12c));const _0x2d30d3={[_0x3744fd]:_0x304509[_0x3744fd]-_0x21d6f8<0x0?0x0:_0x304509[_0x3744fd]-_0x21d6f8,[_0x45cc8e]:_0x304509[_0x45cc8e]+_0x4d5bc4};_0x45cc8e===_0x2fca77(0xd1)&&(_0x2d30d3[_0x2fca77(0x12e)]=_0x304509[_0x2fca77(0x12e)]+_0x21d6f8),_0x45cc8e===_0x2fca77(0x161)&&(_0x2d30d3[_0x2fca77(0x167)]=_0x304509[_0x2fca77(0x167)]+_0x21d6f8);const _0x4ae05d=await this[_0x2fca77(0x13f)][_0x2fca77(0xe1)]({'userId':_0x720fd6},_0x2d30d3);if(_0x4ae05d['affected']===0x0)throw new common_1[(_0x2fca77(0xe4))](_0x2fca77(0x133),common_1[_0x2fca77(0xaf)][_0x2fca77(0x13a)]);}async[_0xaeb8a5(0x113)](_0x23408c){const _0x298435=_0xaeb8a5;try{const _0x162485=await this[_0x298435(0x13f)][_0x298435(0x143)]({'where':{'userId':_0x23408c},'select':[_0x298435(0x15d),_0x298435(0xb6),_0x298435(0xbf),'drawMjCount','memberModel3Count',_0x298435(0xa9),_0x298435(0x120),'useModel3Count',_0x298435(0x167),_0x298435(0xd1),_0x298435(0x161),_0x298435(0x12c),_0x298435(0x100)]});if(!_0x162485){const _0x20542c=await this['createBaseUserBalance'](_0x23408c);if(_0x20542c)return await this[_0x298435(0x113)](_0x23408c);else throw new common_1['HttpException'](_0x298435(0x139),common_1[_0x298435(0xaf)][_0x298435(0x13a)]);}return _0x162485[_0x298435(0x15c)]=_0x162485[_0x298435(0x15d)]?_0x162485[_0x298435(0xb6)]+_0x162485['memberModel3Count']:_0x162485[_0x298435(0xb6)],_0x162485['sumModel4Count']=_0x162485['packageId']?_0x162485['model4Count']+_0x162485['memberModel4Count']:_0x162485[_0x298435(0xbf)],_0x162485[_0x298435(0x118)]=_0x162485[_0x298435(0x15d)]?_0x162485[_0x298435(0xe3)]+_0x162485['memberDrawMjCount']:_0x162485[_0x298435(0xe3)],_0x162485[_0x298435(0x100)]=_0x162485['expirationTime']?(0x0,date_1['formatDate'])(_0x162485['expirationTime'],_0x298435(0x166)):null,_0x162485;}catch(_0x1ad932){console['log'](_0x298435(0x111),_0x1ad932);}}async[_0xaeb8a5(0x142)](_0x219e77){const _0x4e4197=_0xaeb8a5,{userId:_0x1e50e8,rechargeType:_0x1c9910,model3Count:_0x3a7522,model4Count:_0x76c558,drawMjCount:_0xcad4a2,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x219e77;if(!_0x1e50e8)throw new common_1[(_0x4e4197(0xe4))]('当前用户不存在,记录充值日志异常',common_1[_0x4e4197(0xaf)][_0x4e4197(0x13a)]);const _0x5b3060=(0x0,utils_1[_0x4e4197(0x138)])();return await this[_0x4e4197(0xf8)]['save']({'userId':_0x1e50e8,'rechargeType':_0x1c9910,'model3Count':_0x3a7522,'model4Count':_0x76c558,'drawMjCount':_0xcad4a2,'days':days,'extent':extent,'uid':_0x5b3060,'pkgName':pkgName});}async['createBaseUserBalance'](_0x27a569,_0x4d0fcf={}){const _0x3af06e=_0xaeb8a5,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4d0fcf,_0x1181ce=await this[_0x3af06e(0x13f)][_0x3af06e(0x143)]({'where':{'userId':_0x27a569}});if(_0x1181ce)throw new common_1[(_0x3af06e(0xe4))](_0x3af06e(0x115),common_1[_0x3af06e(0xaf)]['BAD_REQUEST']);return await this[_0x3af06e(0x13f)][_0x3af06e(0x12d)]({'userId':_0x27a569,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async['addBalanceToUser'](_0x5e59ec,_0x4488c8,_0x20ac27=-0x1){const _0x24551a=_0xaeb8a5;try{const _0x58a725=await this['userBalanceEntity'][_0x24551a(0x143)]({'where':{'userId':_0x5e59ec}})||await this['createBaseUserBalance'](_0x5e59ec);if(!_0x58a725)throw new common_1[(_0x24551a(0xe4))](_0x24551a(0x149),common_1[_0x24551a(0xaf)][_0x24551a(0x13a)]);const {model3Count:_0x3e7097,model4Count:_0x19f603,drawMjCount:_0x5577f7,memberModel3Count:_0x4cba4a,memberModel4Count:_0x2576cc,memberDrawMjCount:_0x17f82d}=_0x58a725;let _0x5efbf4={};if(_0x20ac27>0x0){const {packageId:_0x23d339}=_0x4488c8;if(!_0x23d339)throw new common_1['HttpException'](_0x24551a(0x106),common_1[_0x24551a(0xaf)]['BAD_REQUEST']);const _0x1bacd7=await this[_0x24551a(0xba)][_0x24551a(0x143)]({'where':{'id':_0x23d339}});if(!_0x1bacd7)throw new common_1[(_0x24551a(0xe4))](_0x24551a(0xc4),common_1[_0x24551a(0xaf)][_0x24551a(0x13a)]);const {weight:_0x44bc8c}=_0x1bacd7;if(!_0x58a725[_0x24551a(0x15d)])_0x5efbf4={'memberModel3Count':_0x3e7097+_0x4488c8[_0x24551a(0xb6)],'memberModel4Count':_0x19f603+_0x4488c8[_0x24551a(0xbf)],'memberDrawMjCount':_0x5577f7+_0x4488c8[_0x24551a(0xe3)],'expirationTime':(0x0,date_1[_0x24551a(0x14e)])()[_0x24551a(0xeb)](_0x20ac27>0x0?_0x20ac27:0x0,_0x24551a(0x105))[_0x24551a(0xb4)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x23d339};else{const _0xcf15b0=await this[_0x24551a(0xba)][_0x24551a(0x143)]({'where':{'id':_0x58a725[_0x24551a(0x15d)]}});_0x44bc8c>=_0xcf15b0[_0x24551a(0xcc)]&&(_0x5efbf4={'memberModel3Count':_0x4cba4a+_0x4488c8[_0x24551a(0xb6)],'memberModel4Count':_0x2576cc+_0x4488c8[_0x24551a(0xbf)],'memberDrawMjCount':_0x17f82d+_0x4488c8['drawMjCount'],'expirationTime':(0x0,date_1[_0x24551a(0x14e)])(_0x58a725[_0x24551a(0x100)])[_0x24551a(0xeb)](_0x20ac27>0x0?_0x20ac27:0x0,_0x24551a(0x105))[_0x24551a(0xb4)](_0x24551a(0x14d)),'packageId':_0x23d339}),_0x44bc8c<_0xcf15b0[_0x24551a(0xcc)]&&(_0x5efbf4={'memberModel3Count':_0x4cba4a+_0x4488c8[_0x24551a(0xb6)],'memberModel4Count':_0x2576cc+_0x4488c8[_0x24551a(0xbf)],'memberDrawMjCount':_0x17f82d+_0x4488c8[_0x24551a(0xe3)]});}}_0x20ac27<=0x0&&(_0x5efbf4={'model3Count':_0x3e7097+_0x4488c8[_0x24551a(0xb6)],'model4Count':_0x19f603+_0x4488c8[_0x24551a(0xbf)],'drawMjCount':_0x5577f7+_0x4488c8[_0x24551a(0xe3)]});const _0x39c32a=await this['userBalanceEntity'][_0x24551a(0xe1)]({'userId':_0x5e59ec},_0x5efbf4);if(_0x39c32a[_0x24551a(0xfb)]===0x0)throw new common_1['HttpException'](_0x5e59ec+'充值失败',common_1[_0x24551a(0xaf)][_0x24551a(0x13a)]);}catch(_0x471e8a){console[_0x24551a(0xb8)](_0x24551a(0x111),_0x471e8a);throw new common_1[(_0x24551a(0xe4))](_0x24551a(0xd0),common_1['HttpStatus'][_0x24551a(0x13a)]);}}async[_0xaeb8a5(0xbd)](_0x2754a1){const _0x3a8cfb=_0xaeb8a5;console[_0x3a8cfb(0xb8)](_0x3a8cfb(0x164),_0x2754a1);try{const {userId:_0x516af8,goodsId:_0x3e9388}=_0x2754a1,_0x267e27=await this[_0x3a8cfb(0xba)][_0x3a8cfb(0x143)]({'where':{'id':_0x2754a1[_0x3a8cfb(0xb9)],'status':0x1}});if(!_0x267e27)throw new common_1[(_0x3a8cfb(0xe4))]('非法操作、当前充值套餐暂不存在！',common_1[_0x3a8cfb(0xaf)][_0x3a8cfb(0x13a)]);const {model3Count:_0x45482d,model4Count:_0x4f4ed1,drawMjCount:_0x5b916b,days:_0x216812,name:_0x5563cc}=_0x267e27,_0x2ea134={'model3Count':_0x45482d,'model4Count':_0x4f4ed1,'drawMjCount':_0x5b916b,'days':_0x216812,'packageId':_0x2754a1[_0x3a8cfb(0xb9)]};await this['addBalanceToUser'](_0x516af8,_0x2ea134,_0x216812),await this[_0x3a8cfb(0x142)]({'userId':_0x516af8,'rechargeType':balance_constant_1['RechargeType']['SCAN_PAY'],'model3Count':_0x45482d,'model4Count':_0x4f4ed1,'drawMjCount':_0x5b916b,'pkgName':_0x5563cc,'days':_0x216812});const _0x113f63=await this[_0x3a8cfb(0x128)][_0x3a8cfb(0x143)]({'where':{'id':_0x516af8}}),{invitedBy:_0x2b42cc}=_0x113f63;if(_0x2b42cc){const _0x1f7752=await this[_0x3a8cfb(0x128)][_0x3a8cfb(0x143)]({'where':{'inviteCode':_0x2b42cc}}),_0x18a156=await this[_0x3a8cfb(0xd4)][_0x3a8cfb(0x143)]({'where':{'userId':_0x1f7752['id']}});if(!_0x1f7752)return;const {id:_0x57e0a3}=_0x1f7752,{performanceRatio:_0x64b8b0}=_0x18a156,_0x33a6b1={'inviterUserId':_0x57e0a3,'inviteeUserId':_0x516af8,'orderId':_0x2754a1['id'],'orderPrice':_0x2754a1[_0x3a8cfb(0x137)],'commissionPercentage':_0x64b8b0,'commissionAmount':(_0x2754a1['total']*_0x64b8b0/0x64)['toFixed'](0x2)};await this[_0x3a8cfb(0xc7)][_0x3a8cfb(0x129)](_0x33a6b1),await this[_0x3a8cfb(0xc7)]['saveCommissionAmount'](_0x57e0a3,_0x33a6b1['commissionAmount']);}}catch(_0x21d970){console[_0x3a8cfb(0xb8)]('error:\x20',_0x21d970);throw new common_1['HttpException']('充值失败！',common_1[_0x3a8cfb(0xaf)][_0x3a8cfb(0x13a)]);}}async[_0xaeb8a5(0x124)](_0x54c364,_0xc0e4a4){const _0x5f4e06=_0xaeb8a5,{page:page=0x1,size:size=0x14}=_0xc0e4a4,{id:_0x54e663}=_0x54c364['user'],[_0x5c77e1,_0x2245ba]=await this[_0x5f4e06(0xf8)][_0x5f4e06(0x14f)]({'where':{'userId':_0x54e663},'order':{'id':_0x5f4e06(0xf9)},'skip':(page-0x1)*size,'take':size});return _0x5c77e1[_0x5f4e06(0xef)](_0x1d8de7=>{const _0x446153=_0x5f4e06;_0x1d8de7['expireDateCn']=_0x1d8de7[_0x446153(0xc1)]>0x0?_0x1d8de7[_0x446153(0xc1)]+'天':'永久';}),{'rows':(0x0,date_1[_0x5f4e06(0xe2)])(_0x5c77e1),'count':_0x2245ba};}async['getAccountLog'](_0x388192,_0x4ef364){const _0x15597c=_0xaeb8a5;try{const {page:page=0x1,size:size=0xa,userId:_0x2fa3d3,rechargeType:_0x43b1d8,packageId:_0x1d4139}=_0x4ef364,{role:_0x55b555}=_0x388192[_0x15597c(0xa8)],_0x2fe845={};_0x43b1d8&&(_0x2fe845['rechargeType']=_0x43b1d8),_0x2fe845[_0x15597c(0xd7)]=_0x2fa3d3||(0x0,typeorm_2['LessThan'])(0x186a0),_0x1d4139&&(_0x2fe845[_0x15597c(0x15d)]={'$like':'%'+_0x1d4139+'%'});const [_0x4b4f74,_0x1655c7]=await this['accountLogEntity'][_0x15597c(0x14f)]({'where':_0x2fe845,'order':{'id':_0x15597c(0xf9)},'skip':(page-0x1)*size,'take':size}),_0x9e9f9f=_0x4b4f74['map'](_0x2f4864=>_0x2f4864[_0x15597c(0xd7)]),_0x35c8dc=await this[_0x15597c(0x128)][_0x15597c(0xdb)]({'where':{'id':(0x0,typeorm_2['In'])(_0x9e9f9f)}});return _0x4b4f74[_0x15597c(0xef)](_0x2e0156=>{const _0x40974d=_0x15597c,_0x476c4c=_0x35c8dc['find'](_0x326d05=>_0x326d05['id']===_0x2e0156[_0x40974d(0xd7)]);_0x2e0156['username']=_0x476c4c===null||_0x476c4c===void 0x0?void 0x0:_0x476c4c[_0x40974d(0x10b)],_0x2e0156['email']=_0x476c4c===null||_0x476c4c===void 0x0?void 0x0:_0x476c4c['email'],_0x2e0156[_0x40974d(0x13e)]=_0x476c4c===null||_0x476c4c===void 0x0?void 0x0:_0x476c4c[_0x40974d(0x13e)],_0x2e0156['status']=_0x476c4c===null||_0x476c4c===void 0x0?void 0x0:_0x476c4c['status'],_0x2e0156['avatar']=_0x476c4c===null||_0x476c4c===void 0x0?void 0x0:_0x476c4c['avatar'];}),_0x55b555!==_0x15597c(0x12a)&&_0x4b4f74['forEach'](_0x54f00a=>{const _0x50eda6=_0x15597c;_0x54f00a[_0x50eda6(0x14a)]=_0x54f00a[_0x50eda6(0x14a)]?(0x0,utils_1[_0x50eda6(0x132)])(_0x54f00a[_0x50eda6(0x14a)]):'',_0x54f00a['phone']=_0x54f00a[_0x50eda6(0x13e)]?(0x0,utils_1['hideString'])(_0x54f00a[_0x50eda6(0x13e)]):'';}),{'rows':_0x4b4f74,'count':_0x1655c7};}catch(_0x28b39c){console[_0x15597c(0xb8)]('error:\x20',_0x28b39c);throw new common_1['HttpException']('查询用户账户失败！',common_1['HttpStatus']['BAD_REQUEST']);}}async['queryUserBalanceByIds'](_0x1a09d4){const _0x285536=_0xaeb8a5;return await this[_0x285536(0x13f)]['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x1a09d4)}});}async[_0xaeb8a5(0xae)](_0x86de92,_0x3b6d66){const _0x1d5df3=_0xaeb8a5;return await this[_0x1d5df3(0x147)](_0x86de92,_0x1d5df3(0xa7),-_0x3b6d66);}async['upgradeBalance'](){const _0x181055=_0xaeb8a5,_0x550358=await this[_0x181055(0x128)][_0x181055(0xdb)]();if(!_0x550358['length'])return;const _0x2490b4=await this[_0x181055(0x165)][_0x181055(0xbe)]([_0x181055(0x150)]);if(!_0x2490b4)await this[_0x181055(0x165)][_0x181055(0xb5)]({'settings':[{'configKey':_0x181055(0x150),'configVal':'1'}]});else throw new common_1['HttpException'](_0x181055(0x14b),common_1[_0x181055(0xaf)]['BAD_REQUEST']);_0x550358[_0x181055(0xef)](_0x4cec7c=>{const _0x39e75a=_0x181055,{id:_0x335531}=_0x4cec7c;this['balanceEntity'][_0x39e75a(0x143)]({'where':{'userId':_0x335531}})[_0x39e75a(0x110)](_0x371c4a=>{const _0x2d6fb8=_0x39e75a;if(!_0x371c4a)return;this[_0x2d6fb8(0xac)](_0x335531,_0x371c4a);});});}async[_0xaeb8a5(0xac)](_0xb37c22,_0x1a8590){const _0x47aa57=_0xaeb8a5,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x1a8590,_0x11cbaf=await this['whiteListEntity']['findOne']({'where':{'userId':_0xb37c22}}),_0x104a99={'userId':_0xb37c22,'model3Count':Number(usesLeft),'model4Count':(_0x11cbaf===null||_0x11cbaf===void 0x0?void 0x0:_0x11cbaf[_0x47aa57(0xc6)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x11cbaf===null||_0x11cbaf===void 0x0?void 0x0:_0x11cbaf[_0x47aa57(0xd2)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x1c3e5c=await this[_0x47aa57(0x13f)][_0x47aa57(0x143)]({'where':{'userId':_0xb37c22}});_0x1c3e5c?common_1[_0x47aa57(0x163)][_0x47aa57(0xd9)]('用户'+_0xb37c22+_0x47aa57(0x15e),_0x47aa57(0x13c)):this[_0x47aa57(0x13f)][_0x47aa57(0x12d)](_0x104a99)[_0x47aa57(0x110)](_0x41b161=>{const _0x1d4462=_0x47aa57;common_1[_0x1d4462(0x163)]['debug']('用户'+_0xb37c22+_0x1d4462(0xf1),_0x1d4462(0x13c));})['catch'](_0x2a89d5=>{const _0x1851e7=_0x47aa57;console['log'](_0x1851e7(0x111),_0x2a89d5),common_1[_0x1851e7(0x163)][_0x1851e7(0xd9)]('用户'+_0xb37c22+_0x1851e7(0xc9),'BalanceService');});}async[_0xaeb8a5(0x13b)](_0x5c24aa){const _0x44af5d=_0xaeb8a5,{fingerprint:_0x18e606}=_0x5c24aa[_0x44af5d(0xca)],{id:_0x4661fc}=_0x5c24aa[_0x44af5d(0xa8)];return await this[_0x44af5d(0x13d)][_0x44af5d(0xe1)]({'userId':Number(_0x18e606)},{'userId':_0x4661fc}),await this[_0x44af5d(0xea)]['update']({'userId':Number(_0x18e606)},{'userId':_0x4661fc}),await this['midjourneyEntity']['update']({'userId':Number(_0x18e606)},{'userId':_0x4661fc}),0x1;}async['getVisitorCount'](_0x4f5b8f){const _0x1791cb=_0xaeb8a5,{fingerprint:_0x2a5cf6}=_0x4f5b8f['headers'],_0x4705d5=await this[_0x1791cb(0x13d)][_0x1791cb(0xc6)]({'where':{'userId':_0x2a5cf6}}),_0x3cfd99=await this['chatGroupEntity']['count']({'where':{'userId':_0x2a5cf6}}),_0x522130=await this[_0x1791cb(0xf2)]['count']({'where':{'userId':_0x2a5cf6}});return _0x4705d5||_0x3cfd99||_0x522130||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0xaeb8a5(0xff)])(),__param(0x0,(0x0,typeorm_1[_0xaeb8a5(0xde)])(balance_entity_1[_0xaeb8a5(0x146)])),__param(0x1,(0x0,typeorm_1[_0xaeb8a5(0xde)])(userBalance_entity_1[_0xaeb8a5(0xad)])),__param(0x2,(0x0,typeorm_1[_0xaeb8a5(0xde)])(accountLog_entity_1[_0xaeb8a5(0xf4)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0xaeb8a5(0xab)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0xaeb8a5(0xc0)])),__param(0x5,(0x0,typeorm_1[_0xaeb8a5(0xde)])(user_entity_1[_0xaeb8a5(0xfc)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1[_0xaeb8a5(0x15b)])),__param(0x7,(0x0,typeorm_1[_0xaeb8a5(0xde)])(whiteList_entity_1[_0xaeb8a5(0xd5)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0xaeb8a5(0x157)])),__param(0x9,(0x0,typeorm_1[_0xaeb8a5(0xde)])(chatGroup_entity_1[_0xaeb8a5(0xf0)])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0xb,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1[_0xaeb8a5(0xf6)])),__metadata(_0xaeb8a5(0x125),[typeorm_2['Repository'],typeorm_2[_0xaeb8a5(0xf3)],typeorm_2[_0xaeb8a5(0xf3)],typeorm_2[_0xaeb8a5(0xf3)],typeorm_2[_0xaeb8a5(0xf3)],typeorm_2['Repository'],typeorm_2[_0xaeb8a5(0xf3)],typeorm_2[_0xaeb8a5(0xf3)],typeorm_2[_0xaeb8a5(0xf3)],typeorm_2[_0xaeb8a5(0xf3)],typeorm_2['Repository'],typeorm_2[_0xaeb8a5(0xf3)],sales_service_1[_0xaeb8a5(0x155)],globalConfig_service_1[_0xaeb8a5(0x153)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;