'use strict';function _0x4d88(_0x1a50ee,_0x1a9cc6){const _0x43aed0=_0x43ae();return _0x4d88=function(_0x4d8823,_0xa0db81){_0x4d8823=_0x4d8823-0x1e5;let _0x1da04b=_0x43aed0[_0x4d8823];return _0x1da04b;},_0x4d88(_0x1a50ee,_0x1a9cc6);}function _0x43ae(){const _0xbf644=['REG_GIFT','invitedGuestSendModel3Count','非法操作、当前充值套餐暂不存在！','UserBalanceEntity','memberModel3Count','CramiPackageEntity','addBalanceToNewUser','firstRegisterSendRank','createBaseUserBalance','sumModel4Count','您已经升级过了、请勿重复操作！','128826zmKdKX','queryUserBalance','firstRregisterSendDrawMjCount','formatCreateOrUpdateDate','map','super','账户信息已经存在、迁移无效','firstRregisterSendModel3Count','queryUserBalanceByIds','function','充值失败','inheritVisitorData','useDrawMjToken','invitedGuestSendModel4Count','model4Count','visitorModel3Num','../chatgpt/whiteList.entity','ChatGroupEntity','PAYMENT_REQUIRED','globalConfigService','days','Repository','updatedAt','forEach','whiteListEntity','addBalanceToUser','visitorMJNum','salesUsersEntity','firstRegisterSendStatus','12980RoqGQJ','midjourneyEntity','userId','log','14WewBPN','upgradeBalance','memberDrawMjCount','__metadata','avatar','vxNumber','2198790lWPloo','useCount','WhiteListEntity','email','MidjourneyEntity','InjectRepository','odel3','./fingerprint.entity','INVITE_GIFT','useModel3Token','packageId','useModel4Token','mjDraw','>\x20或购买专属套餐\x20！','format','inviteGiveSendModel3Count','__param','HttpException','YYYY-MM-DD\x20HH:mm:ss','find','查询用户账户信息失败！','getAccountLog','701980hSHjAf','refundMjBalance','fingerprintLogEntity','../chatGroup/chatGroup.entity','UserBalanceService','REFER_GIFT','registerSendStatus','headers','LessThan','save','add','object','getDate','count','day','defineProperty','drawMjCount','registerSendDrawMjCount','length','metadata','model4','balanceEntity','../globalConfig/config.entity','includes','sumModel3Count','BAD_REQUEST','registerSendModel4Count','total','model3Count','user','findAndCount','HttpStatus','../user/user.entity','error:\x20','../../common/utils','validateVisitorBalance','inviteGiveSendModel4Count','default','configVal','username','expirationTime','deductFromBalance','AccountLogEntity','cramiPackageEntity','debug','../midjourney/midjourney.entity','saveCommissionAmount','configKey','findOne','旧账户信息迁移失败','ConfigEntity','firstRregisterSendModel4Count','validateBalance','commissionAmount','../globalConfig/globalConfig.service','RechargeType','status','2180790RfYvmq','用户充值失败！','MjCount','visitor','reduce','查询当前用户余额失败！','3086680IEQkEW','writeOldBalanceToNewTable','userEntity','invitedGuestSendDrawMjCount','当前套餐不存在！','inviteGiveSendDrawMjCount','../sales/salesUsers.entity','accountLogEntity','./userBalance.entity','6nyaBqF','缺失当前套餐ID、充值失败！','useModel3Count','saveRecordRechargeLog','GlobalConfigService','phone','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','inviteSendStatus','249013hUpNwI','chatGroupEntity','@nestjs/typeorm','then','Logger','addBalanceToOrder','SCAN_PAY','configEntity','memberModel4Count','getMonth','chatLogEntity','DESC','缺失当前用户账户记录！','ChatLogEntity','update','model3','YYYY-MM-DD','weight','__esModule','salesService','goodsId','注册赠送失败,请联系管理员！','useModel4Count','upgradeStatus','userBalanceEntity','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','---','UserEntity','hideString','decorate','registerSendModel3Count','1135igcGlY'];_0x43ae=function(){return _0xbf644;};return _0x43ae();}const _0x431568=_0x4d88;(function(_0x47094b,_0x2d13d7){const _0x250620=_0x4d88,_0x417a18=_0x47094b();while(!![]){try{const _0x360561=-parseInt(_0x250620(0x22a))/0x1+parseInt(_0x250620(0x292))/0x2*(parseInt(_0x250620(0x222))/0x3)+-parseInt(_0x250620(0x272))/0x4*(-parseInt(_0x250620(0x249))/0x5)+parseInt(_0x250620(0x27c))/0x6+parseInt(_0x250620(0x276))/0x7*(-parseInt(_0x250620(0x219))/0x8)+-parseInt(_0x250620(0x255))/0x9+-parseInt(_0x250620(0x213))/0xa;if(_0x360561===_0x2d13d7)break;else _0x417a18['push'](_0x417a18['shift']());}catch(_0xfdd6d6){_0x417a18['push'](_0x417a18['shift']());}}}(_0x43ae,0x86c30));var __decorate=this&&this['__decorate']||function(_0x231628,_0x2c747f,_0x4a54ea,_0x3d5e10){const _0x325dae=_0x4d88;var _0x402cf2=arguments['length'],_0x3f0c4a=_0x402cf2<0x3?_0x2c747f:_0x3d5e10===null?_0x3d5e10=Object['getOwnPropertyDescriptor'](_0x2c747f,_0x4a54ea):_0x3d5e10,_0x1aaa45;if(typeof Reflect===_0x325dae(0x1e5)&&typeof Reflect['decorate']==='function')_0x3f0c4a=Reflect[_0x325dae(0x247)](_0x231628,_0x2c747f,_0x4a54ea,_0x3d5e10);else{for(var _0x13702d=_0x231628[_0x325dae(0x1ec)]-0x1;_0x13702d>=0x0;_0x13702d--)if(_0x1aaa45=_0x231628[_0x13702d])_0x3f0c4a=(_0x402cf2<0x3?_0x1aaa45(_0x3f0c4a):_0x402cf2>0x3?_0x1aaa45(_0x2c747f,_0x4a54ea,_0x3f0c4a):_0x1aaa45(_0x2c747f,_0x4a54ea))||_0x3f0c4a;}return _0x402cf2>0x3&&_0x3f0c4a&&Object[_0x325dae(0x1e9)](_0x2c747f,_0x4a54ea,_0x3f0c4a),_0x3f0c4a;},__metadata=this&&this[_0x431568(0x279)]||function(_0x13dc54,_0x1b3172){const _0x2fa50a=_0x431568;if(typeof Reflect===_0x2fa50a(0x1e5)&&typeof Reflect[_0x2fa50a(0x1ed)]===_0x2fa50a(0x25e))return Reflect[_0x2fa50a(0x1ed)](_0x13dc54,_0x1b3172);},__param=this&&this[_0x431568(0x28c)]||function(_0x4c4f19,_0x146d2e){return function(_0x33b3fc,_0x4105da){_0x146d2e(_0x33b3fc,_0x4105da,_0x4c4f19);};};Object[_0x431568(0x1e9)](exports,_0x431568(0x23c),{'value':!![]}),exports[_0x431568(0x296)]=void 0x0;const globalConfig_service_1=require(_0x431568(0x210)),typeorm_1=require(_0x431568(0x22c)),balance_entity_1=require('./balance.entity'),common_1=require('@nestjs/common'),typeorm_2=require('typeorm'),balance_constant_1=require('../../common/constants/balance.constant'),accountLog_entity_1=require('./accountLog.entity'),utils_1=require(_0x431568(0x1fc)),config_entity_1=require(_0x431568(0x1f0)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_entity_1=require(_0x431568(0x221)),date_1=require('../../common/utils/date'),user_entity_1=require(_0x431568(0x1fa)),salesUsers_entity_1=require(_0x431568(0x21f)),sales_service_1=require('../sales/sales.service'),whiteList_entity_1=require(_0x431568(0x265)),fingerprint_entity_1=require(_0x431568(0x283)),chatLog_entity_1=require('../chatLog/chatLog.entity'),chatGroup_entity_1=require(_0x431568(0x295)),midjourney_entity_1=require(_0x431568(0x207));let UserBalanceService=class UserBalanceService{constructor(_0x2bb7d8,_0x3b2a99,_0x5d59b4,_0x432241,_0x3857b9,_0x263766,_0x161a61,_0x72bc2e,_0x1974ae,_0x469186,_0x42902a,_0x47a717,_0x10f7d0,_0x205a0e){const _0x3d6021=_0x431568;this[_0x3d6021(0x1ef)]=_0x2bb7d8,this[_0x3d6021(0x242)]=_0x3b2a99,this[_0x3d6021(0x220)]=_0x5d59b4,this['cramiPackageEntity']=_0x432241,this['configEntity']=_0x3857b9,this[_0x3d6021(0x21b)]=_0x263766,this[_0x3d6021(0x270)]=_0x161a61,this[_0x3d6021(0x26d)]=_0x72bc2e,this[_0x3d6021(0x294)]=_0x1974ae,this[_0x3d6021(0x22b)]=_0x469186,this['chatLogEntity']=_0x42902a,this[_0x3d6021(0x273)]=_0x47a717,this['salesService']=_0x10f7d0,this[_0x3d6021(0x268)]=_0x205a0e;}async[_0x431568(0x250)](_0x93e9,_0x3cba23){const _0x4ee5c2=_0x431568;try{const _0x4c3ae9=await this[_0x4ee5c2(0x231)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x4ee5c2(0x298),_0x4ee5c2(0x248),'registerSendModel4Count','registerSendDrawMjCount',_0x4ee5c2(0x271),_0x4ee5c2(0x251),_0x4ee5c2(0x25c),_0x4ee5c2(0x20d),_0x4ee5c2(0x257),'inviteSendStatus',_0x4ee5c2(0x28b),'inviteGiveSendModel4Count',_0x4ee5c2(0x21e),_0x4ee5c2(0x24b),_0x4ee5c2(0x21c),_0x4ee5c2(0x262)])}}),_0x5256c7=_0x4c3ae9[_0x4ee5c2(0x217)]((_0x397457,_0x3da554)=>{const _0x4ccaef=_0x4ee5c2,_0x538955=Number(_0x3da554[_0x4ccaef(0x200)]),_0x2b3703=Number['isInteger'](_0x538955)&&_0x538955>0x0?_0x538955:0x0;return _0x397457[_0x3da554[_0x4ccaef(0x209)]]=_0x2b3703,_0x397457;},{});let _0x30f633=0x0,_0x56093c=0x0,_0x7b67ca=0x0;_0x5256c7[_0x4ee5c2(0x298)]===0x1&&(_0x30f633=_0x30f633+_0x5256c7['registerSendModel3Count'],_0x56093c=_0x56093c+_0x5256c7[_0x4ee5c2(0x1f4)],_0x7b67ca=_0x7b67ca+_0x5256c7[_0x4ee5c2(0x1eb)]),_0x5256c7['registerSendStatus']===0x1&&_0x5256c7['firstRegisterSendStatus']===0x1&&_0x93e9<=_0x5256c7[_0x4ee5c2(0x251)]&&(_0x30f633=_0x30f633+_0x5256c7[_0x4ee5c2(0x25c)],_0x56093c=_0x56093c+_0x5256c7[_0x4ee5c2(0x20d)],_0x7b67ca=_0x7b67ca+_0x5256c7[_0x4ee5c2(0x257)]),await this[_0x4ee5c2(0x225)]({'userId':_0x93e9,'rechargeType':balance_constant_1[_0x4ee5c2(0x211)][_0x4ee5c2(0x24a)],'model3Count':_0x30f633,'drawMjCount':_0x7b67ca,'model4Count':_0x56093c}),_0x3cba23&&(Number(_0x5256c7[_0x4ee5c2(0x229)])===0x1&&(_0x30f633=_0x30f633+Number(_0x5256c7['invitedGuestSendModel3Count']),_0x56093c=_0x56093c+Number(_0x5256c7[_0x4ee5c2(0x262)]),_0x7b67ca=_0x7b67ca+Number(_0x5256c7[_0x4ee5c2(0x21c)]),await this[_0x4ee5c2(0x225)]({'userId':_0x93e9,'rechargeType':balance_constant_1['RechargeType'][_0x4ee5c2(0x284)],'model3Count':_0x5256c7[_0x4ee5c2(0x24b)],'model4Count':_0x5256c7['invitedGuestSendModel4Count'],'drawMjCount':_0x5256c7[_0x4ee5c2(0x21c)]}),await this['addBalanceToUser'](_0x3cba23,{'model3Count':_0x5256c7[_0x4ee5c2(0x28b)],'model4Count':_0x5256c7[_0x4ee5c2(0x1fe)],'drawMjCount':_0x5256c7[_0x4ee5c2(0x21e)]}),await this[_0x4ee5c2(0x225)]({'userId':_0x3cba23,'rechargeType':balance_constant_1[_0x4ee5c2(0x211)][_0x4ee5c2(0x297)],'model3Count':_0x5256c7[_0x4ee5c2(0x28b)],'model4Count':_0x5256c7['inviteGiveSendModel4Count'],'drawMjCount':_0x5256c7[_0x4ee5c2(0x21e)]}))),await this['userBalanceEntity'][_0x4ee5c2(0x29b)]({'userId':_0x93e9,'model3Count':_0x30f633,'model4Count':_0x56093c,'drawMjCount':_0x7b67ca,'useTokens':0x0});}catch(_0x42c215){console[_0x4ee5c2(0x275)](_0x4ee5c2(0x1fb),_0x42c215);throw new common_1[(_0x4ee5c2(0x28d))](_0x4ee5c2(0x23f),common_1[_0x4ee5c2(0x1f9)][_0x4ee5c2(0x1f3)]);}}async[_0x431568(0x20e)](_0x4217d8,_0x3133be,_0x56774f){const _0x3ecf3e=_0x431568,{id:_0x5bc864,role:_0x2e63f3}=_0x4217d8['user'];let _0x23245b=await this[_0x3ecf3e(0x242)][_0x3ecf3e(0x20a)]({'where':{'userId':_0x5bc864}});!_0x23245b&&(_0x23245b=await this['createBaseUserBalance'](_0x5bc864));if(_0x2e63f3===_0x3ecf3e(0x216))return this[_0x3ecf3e(0x1fd)](_0x4217d8,_0x3133be,_0x56774f);const _0x40f912=await this[_0x3ecf3e(0x231)][_0x3ecf3e(0x20a)]({'where':{'configKey':_0x3ecf3e(0x27b)}}),_0x54834c=_0x40f912?_0x40f912[_0x3ecf3e(0x200)]:_0x3ecf3e(0x244),_0x58f12b=_0x3133be===_0x3ecf3e(0x239)?'memberModel3Count':_0x3133be===_0x3ecf3e(0x1ee)?_0x3ecf3e(0x232):_0x3133be===_0x3ecf3e(0x288)?'memberDrawMjCount':null,_0x57d5b4=_0x3133be==='model3'?'model3Count':_0x3133be===_0x3ecf3e(0x1ee)?_0x3ecf3e(0x263):_0x3133be===_0x3ecf3e(0x288)?'drawMjCount':null;if(_0x23245b['packageId']&&_0x23245b[_0x58f12b]<_0x56774f){if(_0x23245b[_0x57d5b4]<_0x56774f)throw new common_1[(_0x3ecf3e(0x28d))](_0x3ecf3e(0x243)+_0x54834c+_0x3ecf3e(0x289),common_1[_0x3ecf3e(0x1f9)][_0x3ecf3e(0x267)]);}if(!_0x23245b[_0x3ecf3e(0x286)]&&_0x23245b[_0x57d5b4]<_0x56774f)throw new common_1[(_0x3ecf3e(0x28d))](_0x3ecf3e(0x243)+_0x54834c+'>\x20或购买专属套餐\x20！',common_1[_0x3ecf3e(0x1f9)]['PAYMENT_REQUIRED']);return _0x23245b;}async[_0x431568(0x1fd)](_0x25f81a,_0x68164f,_0x53dead){const _0x241b98=_0x431568,{id:_0x5ef0d3}=_0x25f81a[_0x241b98(0x1f7)],_0x1587eb=_0x68164f===_0x241b98(0x239)?_0x241b98(0x1f6):_0x68164f===_0x241b98(0x1ee)?_0x241b98(0x263):_0x68164f===_0x241b98(0x288)?_0x241b98(0x1ea):null,_0x1976f9=new Date(),_0x531219=await this[_0x241b98(0x294)][_0x241b98(0x20a)]({'where':{'fingerprint':_0x5ef0d3}}),{visitorModel3Num:_0x3cb67f,visitorModel4Num:_0x516aaf,visitorMJNum:_0x2fc235}=await this[_0x241b98(0x268)]['getConfigs']([_0x241b98(0x264),'visitorModel4Num',_0x241b98(0x26f)]),_0x30027d={'model3Count':_0x3cb67f?Number(_0x3cb67f):0x0,'model4Count':_0x516aaf?Number(_0x516aaf):0x0,'drawMjCount':_0x2fc235?Number(_0x2fc235):0x0};if(!_0x531219){const _0x2bbc93={'fingerprint':_0x5ef0d3,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x2bbc93[_0x1587eb]=_0x2bbc93[_0x1587eb]+_0x53dead;if(_0x2bbc93[_0x1587eb]>_0x30027d[_0x1587eb])throw new common_1[(_0x241b98(0x28d))](_0x241b98(0x228),common_1[_0x241b98(0x1f9)][_0x241b98(0x267)]);else return await this[_0x241b98(0x294)][_0x241b98(0x29b)](_0x2bbc93),!![];}else{const {model3Count:_0x3e0242,model4Count:_0x108f8e,drawMjCount:_0x310f96}=_0x531219;let _0x5739db={'model3Count':_0x3e0242,'model4Count':_0x108f8e,'drawMjCount':_0x310f96};const _0x8d0d75=Number(new Date(_0x531219[_0x241b98(0x26b)])),_0x315424=this['isUpdatedToday'](_0x8d0d75);_0x315424?_0x5739db[_0x1587eb]=_0x5739db[_0x1587eb]+_0x53dead:(_0x5739db={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x5739db[_0x1587eb]=_0x5739db[_0x1587eb]+_0x53dead);if(_0x5739db[_0x1587eb]>_0x30027d[_0x1587eb])throw new common_1['HttpException'](_0x241b98(0x228),common_1[_0x241b98(0x1f9)][_0x241b98(0x267)]);else return await this['fingerprintLogEntity']['update']({'fingerprint':_0x5ef0d3},_0x5739db),!![];}}['isUpdatedToday'](_0x30a9a1){const _0x3a1d32=_0x431568,_0x5b2249=new Date(),_0x10d880=new Date(_0x5b2249['getFullYear'](),_0x5b2249[_0x3a1d32(0x233)](),_0x5b2249[_0x3a1d32(0x1e6)]());return _0x30a9a1>=_0x10d880;}async[_0x431568(0x203)](_0x565981,_0x6158b0,_0x5c8369,_0x25f047=0x0){const _0x226f9d=_0x431568,_0x34b18d=await this[_0x226f9d(0x242)]['findOne']({'where':{'userId':_0x565981}});if(!_0x34b18d)throw new common_1[(_0x226f9d(0x28d))](_0x226f9d(0x236),common_1['HttpStatus'][_0x226f9d(0x1f3)]);const _0x2ec228=_0x6158b0==='model3'?'memberModel3Count':_0x6158b0===_0x226f9d(0x1ee)?_0x226f9d(0x232):_0x6158b0===_0x226f9d(0x288)?'memberDrawMjCount':null,_0x319613=_0x6158b0===_0x226f9d(0x239)?_0x226f9d(0x1f6):_0x6158b0===_0x226f9d(0x1ee)?_0x226f9d(0x263):_0x6158b0===_0x226f9d(0x288)?_0x226f9d(0x1ea):null,_0x139080=_0x34b18d[_0x226f9d(0x286)]&&_0x34b18d[_0x2ec228]<_0x5c8369?_0x319613:_0x34b18d[_0x226f9d(0x286)]?_0x2ec228:_0x319613;let _0x54bfc2=null;_0x139080[_0x226f9d(0x1f1)](_0x226f9d(0x282))&&(_0x54bfc2=_0x226f9d(0x285));_0x139080[_0x226f9d(0x1f1)]('odel4')&&(_0x54bfc2=_0x226f9d(0x287));_0x139080[_0x226f9d(0x1f1)](_0x226f9d(0x215))&&(_0x54bfc2=_0x226f9d(0x261));const _0x5e929b={[_0x139080]:_0x34b18d[_0x139080]-_0x5c8369<0x0?0x0:_0x34b18d[_0x139080]-_0x5c8369,[_0x54bfc2]:_0x34b18d[_0x54bfc2]+_0x25f047};_0x54bfc2===_0x226f9d(0x285)&&(_0x5e929b[_0x226f9d(0x224)]=_0x34b18d[_0x226f9d(0x224)]+_0x5c8369),_0x54bfc2===_0x226f9d(0x287)&&(_0x5e929b[_0x226f9d(0x240)]=_0x34b18d['useModel4Count']+_0x5c8369);const _0x3202bc=await this[_0x226f9d(0x242)][_0x226f9d(0x238)]({'userId':_0x565981},_0x5e929b);if(_0x3202bc['affected']===0x0)throw new common_1[(_0x226f9d(0x28d))]('消费余额失败！',common_1[_0x226f9d(0x1f9)][_0x226f9d(0x1f3)]);}async[_0x431568(0x256)](_0x101f62){const _0xb5a47e=_0x431568;try{const _0x45b520=await this[_0xb5a47e(0x242)][_0xb5a47e(0x20a)]({'where':{'userId':_0x101f62},'select':[_0xb5a47e(0x286),_0xb5a47e(0x1f6),_0xb5a47e(0x263),_0xb5a47e(0x1ea),_0xb5a47e(0x24e),_0xb5a47e(0x232),_0xb5a47e(0x278),'useModel3Count','useModel4Count',_0xb5a47e(0x285),_0xb5a47e(0x287),_0xb5a47e(0x261),'expirationTime']});if(!_0x45b520){const _0x26b1bc=await this[_0xb5a47e(0x252)](_0x101f62);if(_0x26b1bc)return await this['queryUserBalance'](_0x101f62);else throw new common_1[(_0xb5a47e(0x28d))](_0xb5a47e(0x218),common_1[_0xb5a47e(0x1f9)][_0xb5a47e(0x1f3)]);}return _0x45b520[_0xb5a47e(0x1f2)]=_0x45b520[_0xb5a47e(0x286)]?_0x45b520[_0xb5a47e(0x1f6)]+_0x45b520[_0xb5a47e(0x24e)]:_0x45b520[_0xb5a47e(0x1f6)],_0x45b520[_0xb5a47e(0x253)]=_0x45b520[_0xb5a47e(0x286)]?_0x45b520[_0xb5a47e(0x263)]+_0x45b520[_0xb5a47e(0x232)]:_0x45b520[_0xb5a47e(0x263)],_0x45b520['sumDrawMjCount']=_0x45b520[_0xb5a47e(0x286)]?_0x45b520[_0xb5a47e(0x1ea)]+_0x45b520[_0xb5a47e(0x278)]:_0x45b520[_0xb5a47e(0x1ea)],_0x45b520[_0xb5a47e(0x202)]=_0x45b520[_0xb5a47e(0x202)]?(0x0,date_1['formatDate'])(_0x45b520[_0xb5a47e(0x202)],_0xb5a47e(0x23a)):null,_0x45b520;}catch(_0x4bab3f){console[_0xb5a47e(0x275)](_0xb5a47e(0x1fb),_0x4bab3f);}}async[_0x431568(0x225)](_0x33da3c){const _0x1fea50=_0x431568,{userId:_0x354b6f,rechargeType:_0x429b1c,model3Count:_0x6b0f3b,model4Count:_0x33d154,drawMjCount:_0x1d698a,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x33da3c;if(!_0x354b6f)throw new common_1[(_0x1fea50(0x28d))]('当前用户不存在,记录充值日志异常',common_1[_0x1fea50(0x1f9)][_0x1fea50(0x1f3)]);const _0x30bf1b=(0x0,utils_1['createRandomUid'])();return await this[_0x1fea50(0x220)][_0x1fea50(0x29b)]({'userId':_0x354b6f,'rechargeType':_0x429b1c,'model3Count':_0x6b0f3b,'model4Count':_0x33d154,'drawMjCount':_0x1d698a,'days':days,'extent':extent,'uid':_0x30bf1b,'pkgName':pkgName});}async['createBaseUserBalance'](_0x28913f,_0x3f9d25={}){const _0x285203=_0x431568,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3f9d25,_0x518930=await this[_0x285203(0x242)][_0x285203(0x20a)]({'where':{'userId':_0x28913f}});if(_0x518930)throw new common_1[(_0x285203(0x28d))]('当前用户无需创建账户信息！',common_1[_0x285203(0x1f9)]['BAD_REQUEST']);return await this[_0x285203(0x242)][_0x285203(0x29b)]({'userId':_0x28913f,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x431568(0x26e)](_0xd10882,_0x379235,_0x51f0cd=-0x1){const _0x40207f=_0x431568;try{const _0x8920a3=await this[_0x40207f(0x242)][_0x40207f(0x20a)]({'where':{'userId':_0xd10882}})||await this[_0x40207f(0x252)](_0xd10882);if(!_0x8920a3)throw new common_1['HttpException'](_0x40207f(0x290),common_1[_0x40207f(0x1f9)]['BAD_REQUEST']);const {model3Count:_0x835a34,model4Count:_0x2a9beb,drawMjCount:_0x5b1bc8,memberModel3Count:_0x3fcf4b,memberModel4Count:_0x4bc403,memberDrawMjCount:_0x5bf64c}=_0x8920a3;let _0x4c7e9a={};if(_0x51f0cd>0x0){const {packageId:_0x5e2ff3}=_0x379235;if(!_0x5e2ff3)throw new common_1[(_0x40207f(0x28d))](_0x40207f(0x223),common_1[_0x40207f(0x1f9)][_0x40207f(0x1f3)]);const _0x193276=await this[_0x40207f(0x205)][_0x40207f(0x20a)]({'where':{'id':_0x5e2ff3}});if(!_0x193276)throw new common_1['HttpException'](_0x40207f(0x21d),common_1[_0x40207f(0x1f9)][_0x40207f(0x1f3)]);const {weight:_0x97bb7d}=_0x193276;if(!_0x8920a3[_0x40207f(0x286)])_0x4c7e9a={'memberModel3Count':_0x835a34+_0x379235[_0x40207f(0x1f6)],'memberModel4Count':_0x2a9beb+_0x379235[_0x40207f(0x263)],'memberDrawMjCount':_0x5b1bc8+_0x379235[_0x40207f(0x1ea)],'expirationTime':(0x0,date_1[_0x40207f(0x1ff)])()['add'](_0x51f0cd>0x0?_0x51f0cd:0x0,_0x40207f(0x1e8))[_0x40207f(0x28a)](_0x40207f(0x28e)),'packageId':_0x5e2ff3};else{const _0x288790=await this[_0x40207f(0x205)][_0x40207f(0x20a)]({'where':{'id':_0x8920a3['packageId']}});_0x97bb7d>=_0x288790[_0x40207f(0x23b)]&&(_0x4c7e9a={'memberModel3Count':_0x3fcf4b+_0x379235[_0x40207f(0x1f6)],'memberModel4Count':_0x4bc403+_0x379235[_0x40207f(0x263)],'memberDrawMjCount':_0x5bf64c+_0x379235[_0x40207f(0x1ea)],'expirationTime':(0x0,date_1[_0x40207f(0x1ff)])(_0x8920a3[_0x40207f(0x202)])[_0x40207f(0x29c)](_0x51f0cd>0x0?_0x51f0cd:0x0,_0x40207f(0x1e8))[_0x40207f(0x28a)](_0x40207f(0x28e)),'packageId':_0x5e2ff3}),_0x97bb7d<_0x288790[_0x40207f(0x23b)]&&(_0x4c7e9a={'memberModel3Count':_0x3fcf4b+_0x379235[_0x40207f(0x1f6)],'memberModel4Count':_0x4bc403+_0x379235[_0x40207f(0x263)],'memberDrawMjCount':_0x5bf64c+_0x379235[_0x40207f(0x1ea)]});}}_0x51f0cd<=0x0&&(_0x4c7e9a={'model3Count':_0x835a34+_0x379235[_0x40207f(0x1f6)],'model4Count':_0x2a9beb+_0x379235[_0x40207f(0x263)],'drawMjCount':_0x5b1bc8+_0x379235[_0x40207f(0x1ea)]});const _0x2ff526=await this['userBalanceEntity'][_0x40207f(0x238)]({'userId':_0xd10882},_0x4c7e9a);if(_0x2ff526['affected']===0x0)throw new common_1[(_0x40207f(0x28d))](_0xd10882+_0x40207f(0x25f),common_1[_0x40207f(0x1f9)][_0x40207f(0x1f3)]);}catch(_0x5631e2){console[_0x40207f(0x275)](_0x40207f(0x1fb),_0x5631e2);throw new common_1['HttpException'](_0x40207f(0x214),common_1[_0x40207f(0x1f9)][_0x40207f(0x1f3)]);}}async[_0x431568(0x22f)](_0x44d19a){const _0x2e0571=_0x431568;console[_0x2e0571(0x275)]('充值的工单信息:',_0x44d19a);try{const {userId:_0x54d2a5,goodsId:_0x174cf5}=_0x44d19a,_0x277304=await this[_0x2e0571(0x205)][_0x2e0571(0x20a)]({'where':{'id':_0x44d19a[_0x2e0571(0x23e)],'status':0x1}});if(!_0x277304)throw new common_1[(_0x2e0571(0x28d))](_0x2e0571(0x24c),common_1['HttpStatus']['BAD_REQUEST']);const {model3Count:_0xd74b54,model4Count:_0x12929c,drawMjCount:_0x1e417e,days:_0x297a27,name:_0x47d6e7}=_0x277304,_0x36f638={'model3Count':_0xd74b54,'model4Count':_0x12929c,'drawMjCount':_0x1e417e,'days':_0x297a27,'packageId':_0x44d19a['goodsId']};await this[_0x2e0571(0x26e)](_0x54d2a5,_0x36f638,_0x297a27),await this[_0x2e0571(0x225)]({'userId':_0x54d2a5,'rechargeType':balance_constant_1[_0x2e0571(0x211)][_0x2e0571(0x230)],'model3Count':_0xd74b54,'model4Count':_0x12929c,'drawMjCount':_0x1e417e,'pkgName':_0x47d6e7,'days':_0x297a27});const _0x410f59=await this[_0x2e0571(0x21b)][_0x2e0571(0x20a)]({'where':{'id':_0x54d2a5}}),{invitedBy:_0x392993}=_0x410f59;if(_0x392993){const _0x40ef5f=await this[_0x2e0571(0x21b)][_0x2e0571(0x20a)]({'where':{'inviteCode':_0x392993}}),_0x1a545f=await this[_0x2e0571(0x270)][_0x2e0571(0x20a)]({'where':{'userId':_0x40ef5f['id']}});if(!_0x40ef5f)return;const {id:_0x55c12e}=_0x40ef5f,{performanceRatio:_0x3fd53f}=_0x1a545f,_0x5e7232={'inviterUserId':_0x55c12e,'inviteeUserId':_0x54d2a5,'orderId':_0x44d19a['id'],'orderPrice':_0x44d19a[_0x2e0571(0x1f5)],'commissionPercentage':_0x3fd53f,'commissionAmount':(_0x44d19a[_0x2e0571(0x1f5)]*_0x3fd53f/0x64)['toFixed'](0x2)};await this[_0x2e0571(0x23d)]['createSalesRecords'](_0x5e7232),await this['salesService'][_0x2e0571(0x208)](_0x55c12e,_0x5e7232[_0x2e0571(0x20f)]);}}catch(_0x20a7dd){console['log'](_0x2e0571(0x1fb),_0x20a7dd);throw new common_1[(_0x2e0571(0x28d))]('充值失败！',common_1[_0x2e0571(0x1f9)][_0x2e0571(0x1f3)]);}}async['getRechargeLog'](_0x892957,_0x40df43){const _0x1c8208=_0x431568,{page:page=0x1,size:size=0x14}=_0x40df43,{id:_0x4ba156}=_0x892957[_0x1c8208(0x1f7)],[_0x4992c4,_0x2d5467]=await this[_0x1c8208(0x220)][_0x1c8208(0x1f8)]({'where':{'userId':_0x4ba156},'order':{'id':_0x1c8208(0x235)},'skip':(page-0x1)*size,'take':size});return _0x4992c4[_0x1c8208(0x26c)](_0x3612a1=>{const _0x541aa1=_0x1c8208;_0x3612a1['expireDateCn']=_0x3612a1[_0x541aa1(0x269)]>0x0?_0x3612a1['days']+'天':'永久';}),{'rows':(0x0,date_1[_0x1c8208(0x258)])(_0x4992c4),'count':_0x2d5467};}async[_0x431568(0x291)](_0x476fd1,_0x2f3df6){const _0x454e04=_0x431568;try{const {page:page=0x1,size:size=0xa,userId:_0x3f39d6,rechargeType:_0x1ca349,packageId:_0x5f3bb6}=_0x2f3df6,{role:_0x4db33b}=_0x476fd1[_0x454e04(0x1f7)],_0x2b22f3={};_0x1ca349&&(_0x2b22f3['rechargeType']=_0x1ca349),_0x2b22f3[_0x454e04(0x274)]=_0x3f39d6||(0x0,typeorm_2[_0x454e04(0x29a)])(0x186a0),_0x5f3bb6&&(_0x2b22f3[_0x454e04(0x286)]={'$like':'%'+_0x5f3bb6+'%'});const [_0x810e17,_0x4361b5]=await this[_0x454e04(0x220)]['findAndCount']({'where':_0x2b22f3,'order':{'id':_0x454e04(0x235)},'skip':(page-0x1)*size,'take':size}),_0x461abd=_0x810e17[_0x454e04(0x259)](_0x2e1ca7=>_0x2e1ca7['userId']),_0x47d540=await this[_0x454e04(0x21b)][_0x454e04(0x28f)]({'where':{'id':(0x0,typeorm_2['In'])(_0x461abd)}});return _0x810e17[_0x454e04(0x26c)](_0x103914=>{const _0x401a3c=_0x454e04,_0x4e8633=_0x47d540[_0x401a3c(0x28f)](_0x1a8a3f=>_0x1a8a3f['id']===_0x103914[_0x401a3c(0x274)]);_0x103914[_0x401a3c(0x201)]=_0x4e8633===null||_0x4e8633===void 0x0?void 0x0:_0x4e8633[_0x401a3c(0x201)],_0x103914[_0x401a3c(0x27f)]=_0x4e8633===null||_0x4e8633===void 0x0?void 0x0:_0x4e8633[_0x401a3c(0x27f)],_0x103914[_0x401a3c(0x227)]=_0x4e8633===null||_0x4e8633===void 0x0?void 0x0:_0x4e8633[_0x401a3c(0x227)],_0x103914['status']=_0x4e8633===null||_0x4e8633===void 0x0?void 0x0:_0x4e8633[_0x401a3c(0x212)],_0x103914['avatar']=_0x4e8633===null||_0x4e8633===void 0x0?void 0x0:_0x4e8633[_0x401a3c(0x27a)];}),_0x4db33b!==_0x454e04(0x25a)&&_0x810e17['forEach'](_0x46c5a6=>{const _0x6a13c1=_0x454e04;_0x46c5a6[_0x6a13c1(0x27f)]=_0x46c5a6[_0x6a13c1(0x27f)]?(0x0,utils_1[_0x6a13c1(0x246)])(_0x46c5a6['email']):'',_0x46c5a6[_0x6a13c1(0x227)]=_0x46c5a6['phone']?(0x0,utils_1[_0x6a13c1(0x246)])(_0x46c5a6[_0x6a13c1(0x227)]):'';}),{'rows':_0x810e17,'count':_0x4361b5};}catch(_0x310bdb){console[_0x454e04(0x275)](_0x454e04(0x1fb),_0x310bdb);throw new common_1['HttpException']('查询用户账户失败！',common_1['HttpStatus'][_0x454e04(0x1f3)]);}}async[_0x431568(0x25d)](_0x2a80cd){const _0x31a917=_0x431568;return await this[_0x31a917(0x242)][_0x31a917(0x28f)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x2a80cd)}});}async[_0x431568(0x293)](_0x483f1b,_0x5cf261){const _0x471b49=_0x431568;return await this[_0x471b49(0x203)](_0x483f1b,_0x471b49(0x288),-_0x5cf261);}async[_0x431568(0x277)](){const _0x22be16=_0x431568,_0x40e380=await this[_0x22be16(0x21b)][_0x22be16(0x28f)]();if(!_0x40e380['length'])return;const _0x1bdc97=await this[_0x22be16(0x268)]['getConfigs']([_0x22be16(0x241)]);if(!_0x1bdc97)await this['globalConfigService']['setConfig']({'settings':[{'configKey':_0x22be16(0x241),'configVal':'1'}]});else throw new common_1[(_0x22be16(0x28d))](_0x22be16(0x254),common_1['HttpStatus'][_0x22be16(0x1f3)]);_0x40e380['forEach'](_0x25f7f5=>{const _0x4a942e=_0x22be16,{id:_0x303394}=_0x25f7f5;this[_0x4a942e(0x1ef)]['findOne']({'where':{'userId':_0x303394}})[_0x4a942e(0x22d)](_0x494b48=>{const _0x11c72f=_0x4a942e;if(!_0x494b48)return;this[_0x11c72f(0x21a)](_0x303394,_0x494b48);});});}async[_0x431568(0x21a)](_0x77c0c,_0x3c576c){const _0x29aa73=_0x431568,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x3c576c,_0x59abf8=await this[_0x29aa73(0x26d)][_0x29aa73(0x20a)]({'where':{'userId':_0x77c0c}}),_0x1ae714={'userId':_0x77c0c,'model3Count':Number(usesLeft),'model4Count':(_0x59abf8===null||_0x59abf8===void 0x0?void 0x0:_0x59abf8['count'])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x59abf8===null||_0x59abf8===void 0x0?void 0x0:_0x59abf8[_0x29aa73(0x27d)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x5502c8=await this[_0x29aa73(0x242)]['findOne']({'where':{'userId':_0x77c0c}});_0x5502c8?common_1['Logger'][_0x29aa73(0x206)]('用户'+_0x77c0c+_0x29aa73(0x25b),'BalanceService'):this[_0x29aa73(0x242)][_0x29aa73(0x29b)](_0x1ae714)['then'](_0x1c2e61=>{const _0x3a1859=_0x29aa73;common_1[_0x3a1859(0x22e)][_0x3a1859(0x206)]('用户'+_0x77c0c+'旧账户信息迁移成功','BalanceService');})['catch'](_0x486628=>{const _0x1f376d=_0x29aa73;console['log']('error:\x20',_0x486628),common_1['Logger'][_0x1f376d(0x206)]('用户'+_0x77c0c+_0x1f376d(0x20b),'BalanceService');});}async[_0x431568(0x260)](_0x49f9d4){const _0x40eb5a=_0x431568,{fingerprint:_0x2cacf7}=_0x49f9d4[_0x40eb5a(0x299)],{id:_0x33b221}=_0x49f9d4[_0x40eb5a(0x1f7)];return await this[_0x40eb5a(0x234)][_0x40eb5a(0x238)]({'userId':Number(_0x2cacf7)},{'userId':_0x33b221}),await this['chatGroupEntity'][_0x40eb5a(0x238)]({'userId':Number(_0x2cacf7)},{'userId':_0x33b221}),await this[_0x40eb5a(0x273)][_0x40eb5a(0x238)]({'userId':Number(_0x2cacf7)},{'userId':_0x33b221}),0x1;}async['getVisitorCount'](_0x2bd191){const _0x4d7e71=_0x431568,{fingerprint:_0x1cebbd}=_0x2bd191['headers'],_0x1e7343=await this[_0x4d7e71(0x234)][_0x4d7e71(0x1e7)]({'where':{'userId':_0x1cebbd}}),_0x299c19=await this[_0x4d7e71(0x22b)][_0x4d7e71(0x1e7)]({'where':{'userId':_0x1cebbd}}),_0x4c42e6=await this['midjourneyEntity'][_0x4d7e71(0x1e7)]({'where':{'userId':_0x1cebbd}});return _0x1e7343||_0x299c19||_0x4c42e6||0x0;}};UserBalanceService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x431568(0x281)])(balance_entity_1['BalanceEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x431568(0x24d)])),__param(0x2,(0x0,typeorm_1[_0x431568(0x281)])(accountLog_entity_1[_0x431568(0x204)])),__param(0x3,(0x0,typeorm_1[_0x431568(0x281)])(cramiPackage_entity_1[_0x431568(0x24f)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x431568(0x20c)])),__param(0x5,(0x0,typeorm_1[_0x431568(0x281)])(user_entity_1[_0x431568(0x245)])),__param(0x6,(0x0,typeorm_1[_0x431568(0x281)])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x7,(0x0,typeorm_1[_0x431568(0x281)])(whiteList_entity_1[_0x431568(0x27e)])),__param(0x8,(0x0,typeorm_1[_0x431568(0x281)])(fingerprint_entity_1['FingerprintLogEntity'])),__param(0x9,(0x0,typeorm_1[_0x431568(0x281)])(chatGroup_entity_1[_0x431568(0x266)])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x431568(0x237)])),__param(0xb,(0x0,typeorm_1[_0x431568(0x281)])(midjourney_entity_1[_0x431568(0x280)])),__metadata('design:paramtypes',[typeorm_2[_0x431568(0x26a)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x431568(0x26a)],typeorm_2['Repository'],typeorm_2[_0x431568(0x26a)],typeorm_2['Repository'],typeorm_2[_0x431568(0x26a)],typeorm_2[_0x431568(0x26a)],typeorm_2[_0x431568(0x26a)],typeorm_2['Repository'],typeorm_2['Repository'],sales_service_1['SalesService'],globalConfig_service_1[_0x431568(0x226)]])],UserBalanceService),exports[_0x431568(0x296)]=UserBalanceService;