'use strict';const _0x3ffb0c=_0x1e51;(function(_0x36e406,_0x232805){const _0x20dccb=_0x1e51,_0x1e4a5a=_0x36e406();while(!![]){try{const _0x47a2b8=parseInt(_0x20dccb(0x16a))/0x1+-parseInt(_0x20dccb(0x147))/0x2+parseInt(_0x20dccb(0x178))/0x3*(-parseInt(_0x20dccb(0x130))/0x4)+parseInt(_0x20dccb(0x13e))/0x5*(parseInt(_0x20dccb(0x16f))/0x6)+-parseInt(_0x20dccb(0x1c0))/0x7*(-parseInt(_0x20dccb(0x126))/0x8)+-parseInt(_0x20dccb(0x185))/0x9*(parseInt(_0x20dccb(0x15b))/0xa)+parseInt(_0x20dccb(0x11e))/0xb;if(_0x47a2b8===_0x232805)break;else _0x1e4a5a['push'](_0x1e4a5a['shift']());}catch(_0x573329){_0x1e4a5a['push'](_0x1e4a5a['shift']());}}}(_0x1803,0xb3c58));var __decorate=this&&this[_0x3ffb0c(0x15a)]||function(_0x5ac62b,_0x4f6476,_0x46ec96,_0x5a0192){const _0x2df751=_0x3ffb0c;var _0x46cef9=arguments[_0x2df751(0x174)],_0x246f06=_0x46cef9<0x3?_0x4f6476:_0x5a0192===null?_0x5a0192=Object[_0x2df751(0x143)](_0x4f6476,_0x46ec96):_0x5a0192,_0x31db8c;if(typeof Reflect===_0x2df751(0x16b)&&typeof Reflect['decorate']===_0x2df751(0x162))_0x246f06=Reflect['decorate'](_0x5ac62b,_0x4f6476,_0x46ec96,_0x5a0192);else{for(var _0x29ce81=_0x5ac62b[_0x2df751(0x174)]-0x1;_0x29ce81>=0x0;_0x29ce81--)if(_0x31db8c=_0x5ac62b[_0x29ce81])_0x246f06=(_0x46cef9<0x3?_0x31db8c(_0x246f06):_0x46cef9>0x3?_0x31db8c(_0x4f6476,_0x46ec96,_0x246f06):_0x31db8c(_0x4f6476,_0x46ec96))||_0x246f06;}return _0x46cef9>0x3&&_0x246f06&&Object[_0x2df751(0x1b2)](_0x4f6476,_0x46ec96,_0x246f06),_0x246f06;},__metadata=this&&this[_0x3ffb0c(0x17f)]||function(_0x1023e3,_0x14f7b9){const _0x4cb258=_0x3ffb0c;if(typeof Reflect===_0x4cb258(0x16b)&&typeof Reflect[_0x4cb258(0x1af)]==='function')return Reflect[_0x4cb258(0x1af)](_0x1023e3,_0x14f7b9);},__param=this&&this[_0x3ffb0c(0x194)]||function(_0xbfab9c,_0x1d094c){return function(_0x3701a2,_0x31b089){_0x1d094c(_0x3701a2,_0x31b089,_0xbfab9c);};};Object[_0x3ffb0c(0x1b2)](exports,_0x3ffb0c(0x116),{'value':!![]}),exports[_0x3ffb0c(0x180)]=void 0x0;function _0x1803(){const _0x2a64fa=['10067827cJWjcd','注册赠送失败,请联系管理员！','model3','invitedGuestSendDrawMjCount','phone','log','status','validateBalance','584LTZcWt','salesUsersEntity','rechargeType','isInteger','design:paramtypes','inviteGiveSendModel4Count','FingerprintLogEntity','缺失当前用户账户记录！','MidjourneyEntity','invitedGuestSendModel3Count','4cBgjfM','affected','includes','firstRegisterSendRank','../sales/sales.service','upgradeStatus','user','refundMjBalance','../midjourney/midjourney.entity','Repository','sumModel4Count','chatLogEntity','../chatGroup/chatGroup.entity','账户信息已经存在、迁移无效','89195gWGLLT','getVisitorCount','registerSendDrawMjCount','YYYY-MM-DD\x20HH:mm:ss','firstRegisterSendStatus','getOwnPropertyDescriptor','odel4','userId','InjectRepository','667960yUXBRh','super','userEntity','查询用户账户失败！','RechargeType','mjDraw','SCAN_PAY','find','saveRecordRechargeLog','LessThan','firstRregisterSendModel3Count','balanceEntity','useModel4Token','format','充值失败','avatar','PAYMENT_REQUIRED','useModel4Count','../sales/salesUsers.entity','__decorate','1449550LxGpxQ','UserEntity','useDrawMjToken','BalanceService','firstRregisterSendDrawMjCount','username','saveCommissionAmount','function','YYYY-MM-DD','inviteGiveSendModel3Count','whiteListEntity','configVal','ChatLogEntity','total','旧账户信息迁移失败','311829jNzEkP','object','>\x20或购买专属套餐\x20！','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','add','306CkPGEb','缺失当前套餐ID、充值失败！','findOne','CramiPackageEntity','odel3','length','accountLogEntity','memberDrawMjCount','useModel3Count','2212827PSGGFd','sumModel3Count','cramiPackageEntity','goodsId','UserBalanceEntity','AccountLogEntity','addBalanceToNewUser','__metadata','UserBalanceService','headers','default','DESC','createBaseUserBalance','27tPTfDe','error:\x20','REG_GIFT','registerSendModel4Count','globalConfigService','registerSendModel3Count','typeorm','map','commissionAmount','email','findAndCount','./fingerprint.entity','invitedGuestSendModel4Count','../../common/utils','upgradeBalance','__param','userBalanceEntity','消费余额失败！','getAccountLog','查询当前用户余额失败！','您已经升级过了、请勿重复操作！','visitorModel3Num','../globalConfig/config.entity','fingerprintLogEntity','configKey','model4','weight','useModel3Token','firstRregisterSendModel4Count','chatGroupEntity','HttpStatus','充值的工单信息:','expirationTime','forEach','validateVisitorBalance','getRechargeLog','configEntity','getConfigs','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','createRandomUid','packageId','BAD_REQUEST','metadata','formatDate','Injectable','defineProperty','registerSendStatus','./accountLog.entity','addBalanceToUser','Logger','toFixed','writeOldBalanceToNewTable','../../common/utils/date','ChatGroupEntity','update','debug','getMonth','salesService','days','10157vmhhfB','非法操作、当前充值套餐暂不存在！','save','../chatLog/chatLog.entity','查询用户账户信息失败！','model3Count','vxNumber','visitor','addBalanceToOrder','deductFromBalance','SalesUsersEntity','../globalConfig/globalConfig.service','memberModel3Count','model4Count','inviteSendStatus','then','inheritVisitorData','MjCount','../user/user.entity','midjourneyEntity','createSalesRecords','inviteGiveSendDrawMjCount','isUpdatedToday','drawMjCount','updatedAt','HttpException','useCount','__esModule','../chatgpt/whiteList.entity','SalesService','hideString','catch','count','day','memberModel4Count'];_0x1803=function(){return _0x2a64fa;};return _0x1803();}const globalConfig_service_1=require(_0x3ffb0c(0x1cb)),typeorm_1=require('@nestjs/typeorm'),balance_entity_1=require('./balance.entity'),common_1=require('@nestjs/common'),typeorm_2=require(_0x3ffb0c(0x18b)),balance_constant_1=require('../../common/constants/balance.constant'),accountLog_entity_1=require(_0x3ffb0c(0x1b4)),utils_1=require(_0x3ffb0c(0x192)),config_entity_1=require(_0x3ffb0c(0x19b)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_entity_1=require('./userBalance.entity'),date_1=require(_0x3ffb0c(0x1b9)),user_entity_1=require(_0x3ffb0c(0x1d2)),salesUsers_entity_1=require(_0x3ffb0c(0x159)),sales_service_1=require(_0x3ffb0c(0x134)),whiteList_entity_1=require(_0x3ffb0c(0x117)),fingerprint_entity_1=require(_0x3ffb0c(0x190)),chatLog_entity_1=require(_0x3ffb0c(0x1c3)),chatGroup_entity_1=require(_0x3ffb0c(0x13c)),midjourney_entity_1=require(_0x3ffb0c(0x138));function _0x1e51(_0x1ee3aa,_0x225ef7){const _0x180353=_0x1803();return _0x1e51=function(_0x1e51df,_0x12ce21){_0x1e51df=_0x1e51df-0x114;let _0x58dd70=_0x180353[_0x1e51df];return _0x58dd70;},_0x1e51(_0x1ee3aa,_0x225ef7);}let UserBalanceService=class UserBalanceService{constructor(_0x1666fd,_0x521db6,_0x1aef4a,_0x1c3853,_0x552316,_0x2cd5dd,_0x2afd87,_0x523e4b,_0x3521d1,_0x4e3f13,_0x3c12d1,_0x1bc7ed,_0x29433f,_0x18a6e0){const _0x4d4e35=_0x3ffb0c;this[_0x4d4e35(0x152)]=_0x1666fd,this[_0x4d4e35(0x195)]=_0x521db6,this['accountLogEntity']=_0x1aef4a,this[_0x4d4e35(0x17a)]=_0x1c3853,this[_0x4d4e35(0x1a9)]=_0x552316,this[_0x4d4e35(0x149)]=_0x2cd5dd,this[_0x4d4e35(0x127)]=_0x2afd87,this[_0x4d4e35(0x165)]=_0x523e4b,this[_0x4d4e35(0x19c)]=_0x3521d1,this['chatGroupEntity']=_0x4e3f13,this['chatLogEntity']=_0x3c12d1,this[_0x4d4e35(0x1d3)]=_0x1bc7ed,this['salesService']=_0x29433f,this['globalConfigService']=_0x18a6e0;}async[_0x3ffb0c(0x17e)](_0x5034a0,_0x3bf64a){const _0x229327=_0x3ffb0c;try{const _0x20edf7=await this[_0x229327(0x1a9)][_0x229327(0x14e)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x229327(0x1b3),_0x229327(0x18a),_0x229327(0x188),'registerSendDrawMjCount',_0x229327(0x142),_0x229327(0x133),'firstRregisterSendModel3Count',_0x229327(0x1a1),_0x229327(0x15f),_0x229327(0x1ce),_0x229327(0x164),'inviteGiveSendModel4Count','inviteGiveSendDrawMjCount',_0x229327(0x12f),_0x229327(0x121),'invitedGuestSendModel4Count'])}}),_0xd3577c=_0x20edf7['reduce']((_0x1581fa,_0x4d586a)=>{const _0x2aa4fe=_0x229327,_0x4afa3e=Number(_0x4d586a[_0x2aa4fe(0x166)]),_0x168206=Number[_0x2aa4fe(0x129)](_0x4afa3e)&&_0x4afa3e>0x0?_0x4afa3e:0x0;return _0x1581fa[_0x4d586a[_0x2aa4fe(0x19d)]]=_0x168206,_0x1581fa;},{});let _0x12391a=0x0,_0x674a76=0x0,_0x3a10a3=0x0;_0xd3577c['registerSendStatus']===0x1&&(_0x12391a=_0x12391a+_0xd3577c[_0x229327(0x18a)],_0x674a76=_0x674a76+_0xd3577c[_0x229327(0x188)],_0x3a10a3=_0x3a10a3+_0xd3577c[_0x229327(0x140)]),_0xd3577c[_0x229327(0x1b3)]===0x1&&_0xd3577c[_0x229327(0x142)]===0x1&&_0x5034a0<=_0xd3577c['firstRegisterSendRank']&&(_0x12391a=_0x12391a+_0xd3577c[_0x229327(0x151)],_0x674a76=_0x674a76+_0xd3577c[_0x229327(0x1a1)],_0x3a10a3=_0x3a10a3+_0xd3577c[_0x229327(0x15f)]),await this[_0x229327(0x14f)]({'userId':_0x5034a0,'rechargeType':balance_constant_1[_0x229327(0x14b)][_0x229327(0x187)],'model3Count':_0x12391a,'drawMjCount':_0x3a10a3,'model4Count':_0x674a76}),_0x3bf64a&&(Number(_0xd3577c[_0x229327(0x1ce)])===0x1&&(_0x12391a=_0x12391a+Number(_0xd3577c['invitedGuestSendModel3Count']),_0x674a76=_0x674a76+Number(_0xd3577c[_0x229327(0x191)]),_0x3a10a3=_0x3a10a3+Number(_0xd3577c[_0x229327(0x121)]),await this[_0x229327(0x14f)]({'userId':_0x5034a0,'rechargeType':balance_constant_1['RechargeType']['INVITE_GIFT'],'model3Count':_0xd3577c[_0x229327(0x12f)],'model4Count':_0xd3577c[_0x229327(0x191)],'drawMjCount':_0xd3577c[_0x229327(0x121)]}),await this['addBalanceToUser'](_0x3bf64a,{'model3Count':_0xd3577c[_0x229327(0x164)],'model4Count':_0xd3577c[_0x229327(0x12b)],'drawMjCount':_0xd3577c[_0x229327(0x1d5)]}),await this[_0x229327(0x14f)]({'userId':_0x3bf64a,'rechargeType':balance_constant_1[_0x229327(0x14b)]['REFER_GIFT'],'model3Count':_0xd3577c[_0x229327(0x164)],'model4Count':_0xd3577c[_0x229327(0x12b)],'drawMjCount':_0xd3577c['inviteGiveSendDrawMjCount']}))),await this['userBalanceEntity']['save']({'userId':_0x5034a0,'model3Count':_0x12391a,'model4Count':_0x674a76,'drawMjCount':_0x3a10a3,'useTokens':0x0});}catch(_0xa3a7fb){console[_0x229327(0x123)](_0x229327(0x186),_0xa3a7fb);throw new common_1[(_0x229327(0x114))](_0x229327(0x11f),common_1[_0x229327(0x1a3)][_0x229327(0x1ae)]);}}async[_0x3ffb0c(0x125)](_0x3990a2,_0x1d7c81,_0x2a054d){const _0x31b697=_0x3ffb0c,{id:_0x215421,role:_0x35a59a}=_0x3990a2[_0x31b697(0x136)];let _0x4d0c07=await this[_0x31b697(0x195)][_0x31b697(0x171)]({'where':{'userId':_0x215421}});!_0x4d0c07&&(_0x4d0c07=await this[_0x31b697(0x184)](_0x215421));if(_0x35a59a===_0x31b697(0x1c7))return this[_0x31b697(0x1a7)](_0x3990a2,_0x1d7c81,_0x2a054d);const _0x2f6956=await this[_0x31b697(0x1a9)]['findOne']({'where':{'configKey':_0x31b697(0x1c6)}}),_0x4921a7=_0x2f6956?_0x2f6956['configVal']:'---',_0x4ef978=_0x1d7c81===_0x31b697(0x120)?'memberModel3Count':_0x1d7c81===_0x31b697(0x19e)?_0x31b697(0x11d):_0x1d7c81==='mjDraw'?_0x31b697(0x176):null,_0x532cab=_0x1d7c81===_0x31b697(0x120)?_0x31b697(0x1c5):_0x1d7c81==='model4'?_0x31b697(0x1cd):_0x1d7c81===_0x31b697(0x14c)?'drawMjCount':null;if(_0x4d0c07[_0x31b697(0x1ad)]&&_0x4d0c07[_0x4ef978]<_0x2a054d){if(_0x4d0c07[_0x532cab]<_0x2a054d)throw new common_1[(_0x31b697(0x114))](_0x31b697(0x16d)+_0x4921a7+_0x31b697(0x16c),common_1[_0x31b697(0x1a3)][_0x31b697(0x157)]);}if(!_0x4d0c07[_0x31b697(0x1ad)]&&_0x4d0c07[_0x532cab]<_0x2a054d)throw new common_1['HttpException']('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x4921a7+_0x31b697(0x16c),common_1[_0x31b697(0x1a3)][_0x31b697(0x157)]);return _0x4d0c07;}async[_0x3ffb0c(0x1a7)](_0x47cb20,_0x49a50e,_0x4b5ab3){const _0x3bc930=_0x3ffb0c,{id:_0x158c72}=_0x47cb20['user'],_0x3a9cea=_0x49a50e===_0x3bc930(0x120)?_0x3bc930(0x1c5):_0x49a50e==='model4'?'model4Count':_0x49a50e===_0x3bc930(0x14c)?'drawMjCount':null,_0x51c71e=new Date(),_0x43eae1=await this[_0x3bc930(0x19c)][_0x3bc930(0x171)]({'where':{'fingerprint':_0x158c72}}),{visitorModel3Num:_0x34f580,visitorModel4Num:_0x129776,visitorMJNum:_0x40ccb1}=await this[_0x3bc930(0x189)]['getConfigs']([_0x3bc930(0x19a),'visitorModel4Num','visitorMJNum']),_0x3bac05={'model3Count':_0x34f580?Number(_0x34f580):0x0,'model4Count':_0x129776?Number(_0x129776):0x0,'drawMjCount':_0x40ccb1?Number(_0x40ccb1):0x0};if(!_0x43eae1){const _0x1488cc={'fingerprint':_0x158c72,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x1488cc[_0x3a9cea]=_0x1488cc[_0x3a9cea]+_0x4b5ab3;if(_0x1488cc[_0x3a9cea]>_0x3bac05[_0x3a9cea])throw new common_1[(_0x3bc930(0x114))](_0x3bc930(0x1ab),common_1[_0x3bc930(0x1a3)][_0x3bc930(0x157)]);else return await this[_0x3bc930(0x19c)][_0x3bc930(0x1c2)](_0x1488cc),!![];}else{const {model3Count:_0x206791,model4Count:_0x4d9506,drawMjCount:_0x44abcc}=_0x43eae1;let _0x2048ee={'model3Count':_0x206791,'model4Count':_0x4d9506,'drawMjCount':_0x44abcc};const _0x3583e3=Number(new Date(_0x43eae1[_0x3bc930(0x1d8)])),_0x13f84b=this[_0x3bc930(0x1d6)](_0x3583e3);_0x13f84b?_0x2048ee[_0x3a9cea]=_0x2048ee[_0x3a9cea]+_0x4b5ab3:(_0x2048ee={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x2048ee[_0x3a9cea]=_0x2048ee[_0x3a9cea]+_0x4b5ab3);if(_0x2048ee[_0x3a9cea]>_0x3bac05[_0x3a9cea])throw new common_1[(_0x3bc930(0x114))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1[_0x3bc930(0x1a3)][_0x3bc930(0x157)]);else return await this[_0x3bc930(0x19c)][_0x3bc930(0x1bb)]({'fingerprint':_0x158c72},_0x2048ee),!![];}}[_0x3ffb0c(0x1d6)](_0x40f340){const _0x5b75fd=_0x3ffb0c,_0x2945ba=new Date(),_0x5a23fc=new Date(_0x2945ba['getFullYear'](),_0x2945ba[_0x5b75fd(0x1bd)](),_0x2945ba['getDate']());return _0x40f340>=_0x5a23fc;}async[_0x3ffb0c(0x1c9)](_0x34312c,_0x3155d2,_0x4b753d,_0x2ecdd6=0x0){const _0x1e5a10=_0x3ffb0c,_0x4ead83=await this[_0x1e5a10(0x195)][_0x1e5a10(0x171)]({'where':{'userId':_0x34312c}});if(!_0x4ead83)throw new common_1[(_0x1e5a10(0x114))](_0x1e5a10(0x12d),common_1[_0x1e5a10(0x1a3)][_0x1e5a10(0x1ae)]);const _0x5201dc=_0x3155d2===_0x1e5a10(0x120)?_0x1e5a10(0x1cc):_0x3155d2===_0x1e5a10(0x19e)?_0x1e5a10(0x11d):_0x3155d2===_0x1e5a10(0x14c)?_0x1e5a10(0x176):null,_0x590e79=_0x3155d2===_0x1e5a10(0x120)?'model3Count':_0x3155d2===_0x1e5a10(0x19e)?_0x1e5a10(0x1cd):_0x3155d2===_0x1e5a10(0x14c)?_0x1e5a10(0x1d7):null,_0x3d972d=_0x4ead83[_0x1e5a10(0x1ad)]&&_0x4ead83[_0x5201dc]<_0x4b753d?_0x590e79:_0x4ead83[_0x1e5a10(0x1ad)]?_0x5201dc:_0x590e79;let _0x42adae=null;_0x3d972d[_0x1e5a10(0x132)](_0x1e5a10(0x173))&&(_0x42adae=_0x1e5a10(0x1a0));_0x3d972d['includes'](_0x1e5a10(0x144))&&(_0x42adae=_0x1e5a10(0x153));_0x3d972d['includes'](_0x1e5a10(0x1d1))&&(_0x42adae=_0x1e5a10(0x15d));const _0x31489b={[_0x3d972d]:_0x4ead83[_0x3d972d]-_0x4b753d<0x0?0x0:_0x4ead83[_0x3d972d]-_0x4b753d,[_0x42adae]:_0x4ead83[_0x42adae]+_0x2ecdd6};_0x42adae==='useModel3Token'&&(_0x31489b[_0x1e5a10(0x177)]=_0x4ead83['useModel3Count']+_0x4b753d),_0x42adae===_0x1e5a10(0x153)&&(_0x31489b['useModel4Count']=_0x4ead83[_0x1e5a10(0x158)]+_0x4b753d);const _0x337b85=await this['userBalanceEntity'][_0x1e5a10(0x1bb)]({'userId':_0x34312c},_0x31489b);if(_0x337b85[_0x1e5a10(0x131)]===0x0)throw new common_1[(_0x1e5a10(0x114))](_0x1e5a10(0x196),common_1[_0x1e5a10(0x1a3)][_0x1e5a10(0x1ae)]);}async['queryUserBalance'](_0x394b2e){const _0x334b4a=_0x3ffb0c;try{const _0x1a98d5=await this[_0x334b4a(0x195)][_0x334b4a(0x171)]({'where':{'userId':_0x394b2e},'select':[_0x334b4a(0x1ad),_0x334b4a(0x1c5),_0x334b4a(0x1cd),_0x334b4a(0x1d7),_0x334b4a(0x1cc),'memberModel4Count',_0x334b4a(0x176),_0x334b4a(0x177),_0x334b4a(0x158),_0x334b4a(0x1a0),_0x334b4a(0x153),'useDrawMjToken','expirationTime']});if(!_0x1a98d5){const _0x4b5e3a=await this[_0x334b4a(0x184)](_0x394b2e);if(_0x4b5e3a)return await this['queryUserBalance'](_0x394b2e);else throw new common_1['HttpException'](_0x334b4a(0x198),common_1[_0x334b4a(0x1a3)][_0x334b4a(0x1ae)]);}return _0x1a98d5[_0x334b4a(0x179)]=_0x1a98d5[_0x334b4a(0x1ad)]?_0x1a98d5['model3Count']+_0x1a98d5[_0x334b4a(0x1cc)]:_0x1a98d5['model3Count'],_0x1a98d5[_0x334b4a(0x13a)]=_0x1a98d5[_0x334b4a(0x1ad)]?_0x1a98d5[_0x334b4a(0x1cd)]+_0x1a98d5[_0x334b4a(0x11d)]:_0x1a98d5['model4Count'],_0x1a98d5['sumDrawMjCount']=_0x1a98d5['packageId']?_0x1a98d5[_0x334b4a(0x1d7)]+_0x1a98d5[_0x334b4a(0x176)]:_0x1a98d5[_0x334b4a(0x1d7)],_0x1a98d5[_0x334b4a(0x1a5)]=_0x1a98d5[_0x334b4a(0x1a5)]?(0x0,date_1[_0x334b4a(0x1b0)])(_0x1a98d5['expirationTime'],_0x334b4a(0x163)):null,_0x1a98d5;}catch(_0x3a00ed){console[_0x334b4a(0x123)](_0x334b4a(0x186),_0x3a00ed);}}async[_0x3ffb0c(0x14f)](_0x4a6189){const _0x111dfd=_0x3ffb0c,{userId:_0x2ba99e,rechargeType:_0x161643,model3Count:_0x2e05c8,model4Count:_0x48aec6,drawMjCount:_0x220f7e,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x4a6189;if(!_0x2ba99e)throw new common_1[(_0x111dfd(0x114))]('当前用户不存在,记录充值日志异常',common_1[_0x111dfd(0x1a3)][_0x111dfd(0x1ae)]);const _0x3209aa=(0x0,utils_1[_0x111dfd(0x1ac)])();return await this[_0x111dfd(0x175)][_0x111dfd(0x1c2)]({'userId':_0x2ba99e,'rechargeType':_0x161643,'model3Count':_0x2e05c8,'model4Count':_0x48aec6,'drawMjCount':_0x220f7e,'days':days,'extent':extent,'uid':_0x3209aa,'pkgName':pkgName});}async['createBaseUserBalance'](_0x10af5e,_0xa4f7e1={}){const _0x1f4359=_0x3ffb0c,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0xa4f7e1,_0xf5deff=await this[_0x1f4359(0x195)][_0x1f4359(0x171)]({'where':{'userId':_0x10af5e}});if(_0xf5deff)throw new common_1[(_0x1f4359(0x114))]('当前用户无需创建账户信息！',common_1[_0x1f4359(0x1a3)]['BAD_REQUEST']);return await this[_0x1f4359(0x195)][_0x1f4359(0x1c2)]({'userId':_0x10af5e,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x3ffb0c(0x1b5)](_0x5b8709,_0x5958e8,_0x4dc881=-0x1){const _0x411e79=_0x3ffb0c;try{const _0x5a85b6=await this[_0x411e79(0x195)][_0x411e79(0x171)]({'where':{'userId':_0x5b8709}})||await this[_0x411e79(0x184)](_0x5b8709);if(!_0x5a85b6)throw new common_1[(_0x411e79(0x114))](_0x411e79(0x1c4),common_1[_0x411e79(0x1a3)]['BAD_REQUEST']);const {model3Count:_0x1ae4e9,model4Count:_0x3603b1,drawMjCount:_0x1b3093,memberModel3Count:_0x2cf2c9,memberModel4Count:_0x1d63ff,memberDrawMjCount:_0x205a95}=_0x5a85b6;let _0x354cda={};if(_0x4dc881>0x0){const {packageId:_0x236243}=_0x5958e8;if(!_0x236243)throw new common_1[(_0x411e79(0x114))](_0x411e79(0x170),common_1[_0x411e79(0x1a3)][_0x411e79(0x1ae)]);const _0x236087=await this['cramiPackageEntity'][_0x411e79(0x171)]({'where':{'id':_0x236243}});if(!_0x236087)throw new common_1[(_0x411e79(0x114))]('当前套餐不存在！',common_1['HttpStatus']['BAD_REQUEST']);const {weight:_0x50199d}=_0x236087;if(!_0x5a85b6[_0x411e79(0x1ad)])_0x354cda={'memberModel3Count':_0x1ae4e9+_0x5958e8[_0x411e79(0x1c5)],'memberModel4Count':_0x3603b1+_0x5958e8[_0x411e79(0x1cd)],'memberDrawMjCount':_0x1b3093+_0x5958e8[_0x411e79(0x1d7)],'expirationTime':(0x0,date_1[_0x411e79(0x182)])()[_0x411e79(0x16e)](_0x4dc881>0x0?_0x4dc881:0x0,_0x411e79(0x11c))[_0x411e79(0x154)](_0x411e79(0x141)),'packageId':_0x236243};else{const _0x4084cb=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x5a85b6[_0x411e79(0x1ad)]}});_0x50199d>=_0x4084cb[_0x411e79(0x19f)]&&(_0x354cda={'memberModel3Count':_0x2cf2c9+_0x5958e8[_0x411e79(0x1c5)],'memberModel4Count':_0x1d63ff+_0x5958e8[_0x411e79(0x1cd)],'memberDrawMjCount':_0x205a95+_0x5958e8[_0x411e79(0x1d7)],'expirationTime':(0x0,date_1[_0x411e79(0x182)])(_0x5a85b6[_0x411e79(0x1a5)])[_0x411e79(0x16e)](_0x4dc881>0x0?_0x4dc881:0x0,_0x411e79(0x11c))['format']('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x236243}),_0x50199d<_0x4084cb['weight']&&(_0x354cda={'memberModel3Count':_0x2cf2c9+_0x5958e8[_0x411e79(0x1c5)],'memberModel4Count':_0x1d63ff+_0x5958e8[_0x411e79(0x1cd)],'memberDrawMjCount':_0x205a95+_0x5958e8['drawMjCount']});}}_0x4dc881<=0x0&&(_0x354cda={'model3Count':_0x1ae4e9+_0x5958e8[_0x411e79(0x1c5)],'model4Count':_0x3603b1+_0x5958e8[_0x411e79(0x1cd)],'drawMjCount':_0x1b3093+_0x5958e8[_0x411e79(0x1d7)]});const _0x46fdf0=await this[_0x411e79(0x195)][_0x411e79(0x1bb)]({'userId':_0x5b8709},_0x354cda);if(_0x46fdf0[_0x411e79(0x131)]===0x0)throw new common_1[(_0x411e79(0x114))](_0x5b8709+_0x411e79(0x155),common_1[_0x411e79(0x1a3)]['BAD_REQUEST']);}catch(_0x5eeeaa){console[_0x411e79(0x123)]('error:\x20',_0x5eeeaa);throw new common_1['HttpException']('用户充值失败！',common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x3ffb0c(0x1c8)](_0x4b0233){const _0x1a4eee=_0x3ffb0c;console[_0x1a4eee(0x123)](_0x1a4eee(0x1a4),_0x4b0233);try{const {userId:_0x6f8c07,goodsId:_0x451e62}=_0x4b0233,_0xffed1e=await this[_0x1a4eee(0x17a)][_0x1a4eee(0x171)]({'where':{'id':_0x4b0233[_0x1a4eee(0x17b)],'status':0x1}});if(!_0xffed1e)throw new common_1[(_0x1a4eee(0x114))](_0x1a4eee(0x1c1),common_1[_0x1a4eee(0x1a3)][_0x1a4eee(0x1ae)]);const {model3Count:_0x2dc244,model4Count:_0xdb6f61,drawMjCount:_0x3ca0f2,days:_0x3a8f16,name:_0x1a0214}=_0xffed1e,_0x118a7e={'model3Count':_0x2dc244,'model4Count':_0xdb6f61,'drawMjCount':_0x3ca0f2,'days':_0x3a8f16,'packageId':_0x4b0233[_0x1a4eee(0x17b)]};await this['addBalanceToUser'](_0x6f8c07,_0x118a7e,_0x3a8f16),await this[_0x1a4eee(0x14f)]({'userId':_0x6f8c07,'rechargeType':balance_constant_1[_0x1a4eee(0x14b)][_0x1a4eee(0x14d)],'model3Count':_0x2dc244,'model4Count':_0xdb6f61,'drawMjCount':_0x3ca0f2,'pkgName':_0x1a0214,'days':_0x3a8f16});const _0x304333=await this[_0x1a4eee(0x149)][_0x1a4eee(0x171)]({'where':{'id':_0x6f8c07}}),{invitedBy:_0x27de33}=_0x304333;if(_0x27de33){const _0x155ca7=await this[_0x1a4eee(0x149)]['findOne']({'where':{'inviteCode':_0x27de33}}),_0x5136db=await this['salesUsersEntity'][_0x1a4eee(0x171)]({'where':{'userId':_0x155ca7['id']}});if(!_0x155ca7)return;const {id:_0x4cf688}=_0x155ca7,{performanceRatio:_0x36f226}=_0x5136db,_0x577d1c={'inviterUserId':_0x4cf688,'inviteeUserId':_0x6f8c07,'orderId':_0x4b0233['id'],'orderPrice':_0x4b0233[_0x1a4eee(0x168)],'commissionPercentage':_0x36f226,'commissionAmount':(_0x4b0233[_0x1a4eee(0x168)]*_0x36f226/0x64)[_0x1a4eee(0x1b7)](0x2)};await this[_0x1a4eee(0x1be)][_0x1a4eee(0x1d4)](_0x577d1c),await this['salesService'][_0x1a4eee(0x161)](_0x4cf688,_0x577d1c[_0x1a4eee(0x18d)]);}}catch(_0x2769bf){console[_0x1a4eee(0x123)](_0x1a4eee(0x186),_0x2769bf);throw new common_1[(_0x1a4eee(0x114))]('充值失败！',common_1[_0x1a4eee(0x1a3)][_0x1a4eee(0x1ae)]);}}async[_0x3ffb0c(0x1a8)](_0x503b4b,_0x4bae30){const _0x5d32c2=_0x3ffb0c,{page:page=0x1,size:size=0x14}=_0x4bae30,{id:_0x3fe9c1}=_0x503b4b[_0x5d32c2(0x136)],[_0x56a610,_0x3ffa7a]=await this[_0x5d32c2(0x175)][_0x5d32c2(0x18f)]({'where':{'userId':_0x3fe9c1},'order':{'id':_0x5d32c2(0x183)},'skip':(page-0x1)*size,'take':size});return _0x56a610['forEach'](_0x5b2a03=>{const _0x210074=_0x5d32c2;_0x5b2a03['expireDateCn']=_0x5b2a03[_0x210074(0x1bf)]>0x0?_0x5b2a03[_0x210074(0x1bf)]+'天':'永久';}),{'rows':(0x0,date_1['formatCreateOrUpdateDate'])(_0x56a610),'count':_0x3ffa7a};}async[_0x3ffb0c(0x197)](_0x194848,_0xc3557e){const _0x320be5=_0x3ffb0c;try{const {page:page=0x1,size:size=0xa,userId:_0x103760,rechargeType:_0x5530d9,packageId:_0x45b279}=_0xc3557e,{role:_0x382e34}=_0x194848[_0x320be5(0x136)],_0x11f14f={};_0x5530d9&&(_0x11f14f[_0x320be5(0x128)]=_0x5530d9),_0x11f14f[_0x320be5(0x145)]=_0x103760||(0x0,typeorm_2[_0x320be5(0x150)])(0x186a0),_0x45b279&&(_0x11f14f[_0x320be5(0x1ad)]={'$like':'%'+_0x45b279+'%'});const [_0x38fc39,_0x3411c6]=await this[_0x320be5(0x175)][_0x320be5(0x18f)]({'where':_0x11f14f,'order':{'id':_0x320be5(0x183)},'skip':(page-0x1)*size,'take':size}),_0x3aaef2=_0x38fc39[_0x320be5(0x18c)](_0x52e5c9=>_0x52e5c9[_0x320be5(0x145)]),_0x3ad0eb=await this[_0x320be5(0x149)][_0x320be5(0x14e)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3aaef2)}});return _0x38fc39[_0x320be5(0x1a6)](_0x393397=>{const _0x5adca5=_0x320be5,_0x245c26=_0x3ad0eb[_0x5adca5(0x14e)](_0x936de7=>_0x936de7['id']===_0x393397['userId']);_0x393397[_0x5adca5(0x160)]=_0x245c26===null||_0x245c26===void 0x0?void 0x0:_0x245c26[_0x5adca5(0x160)],_0x393397[_0x5adca5(0x18e)]=_0x245c26===null||_0x245c26===void 0x0?void 0x0:_0x245c26[_0x5adca5(0x18e)],_0x393397[_0x5adca5(0x122)]=_0x245c26===null||_0x245c26===void 0x0?void 0x0:_0x245c26[_0x5adca5(0x122)],_0x393397['status']=_0x245c26===null||_0x245c26===void 0x0?void 0x0:_0x245c26[_0x5adca5(0x124)],_0x393397[_0x5adca5(0x156)]=_0x245c26===null||_0x245c26===void 0x0?void 0x0:_0x245c26[_0x5adca5(0x156)];}),_0x382e34!==_0x320be5(0x148)&&_0x38fc39[_0x320be5(0x1a6)](_0x44d710=>{const _0xda66b3=_0x320be5;_0x44d710[_0xda66b3(0x18e)]=_0x44d710['email']?(0x0,utils_1[_0xda66b3(0x119)])(_0x44d710[_0xda66b3(0x18e)]):'',_0x44d710[_0xda66b3(0x122)]=_0x44d710[_0xda66b3(0x122)]?(0x0,utils_1[_0xda66b3(0x119)])(_0x44d710[_0xda66b3(0x122)]):'';}),{'rows':_0x38fc39,'count':_0x3411c6};}catch(_0x5b6e81){console[_0x320be5(0x123)](_0x320be5(0x186),_0x5b6e81);throw new common_1[(_0x320be5(0x114))](_0x320be5(0x14a),common_1[_0x320be5(0x1a3)][_0x320be5(0x1ae)]);}}async['queryUserBalanceByIds'](_0x3df69d){const _0x52bac3=_0x3ffb0c;return await this[_0x52bac3(0x195)][_0x52bac3(0x14e)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x3df69d)}});}async[_0x3ffb0c(0x137)](_0x571b20,_0x18514e){const _0x4f3981=_0x3ffb0c;return await this[_0x4f3981(0x1c9)](_0x571b20,'mjDraw',-_0x18514e);}async[_0x3ffb0c(0x193)](){const _0x58705f=_0x3ffb0c,_0x4181c8=await this[_0x58705f(0x149)]['find']();if(!_0x4181c8['length'])return;const _0x53d890=await this['globalConfigService'][_0x58705f(0x1aa)]([_0x58705f(0x135)]);if(!_0x53d890)await this['globalConfigService']['setConfig']({'settings':[{'configKey':_0x58705f(0x135),'configVal':'1'}]});else throw new common_1[(_0x58705f(0x114))](_0x58705f(0x199),common_1['HttpStatus'][_0x58705f(0x1ae)]);_0x4181c8[_0x58705f(0x1a6)](_0x36d26c=>{const _0x51892e=_0x58705f,{id:_0x1c319c}=_0x36d26c;this[_0x51892e(0x152)][_0x51892e(0x171)]({'where':{'userId':_0x1c319c}})[_0x51892e(0x1cf)](_0x2941ac=>{const _0x39644c=_0x51892e;if(!_0x2941ac)return;this[_0x39644c(0x1b8)](_0x1c319c,_0x2941ac);});});}async[_0x3ffb0c(0x1b8)](_0x2f6b4a,_0x347c89){const _0x4a4617=_0x3ffb0c,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x347c89,_0x750ea=await this[_0x4a4617(0x165)][_0x4a4617(0x171)]({'where':{'userId':_0x2f6b4a}}),_0xcb8c1a={'userId':_0x2f6b4a,'model3Count':Number(usesLeft),'model4Count':(_0x750ea===null||_0x750ea===void 0x0?void 0x0:_0x750ea['count'])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x750ea===null||_0x750ea===void 0x0?void 0x0:_0x750ea[_0x4a4617(0x115)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x1553bc=await this[_0x4a4617(0x195)][_0x4a4617(0x171)]({'where':{'userId':_0x2f6b4a}});_0x1553bc?common_1[_0x4a4617(0x1b6)][_0x4a4617(0x1bc)]('用户'+_0x2f6b4a+_0x4a4617(0x13d),_0x4a4617(0x15e)):this['userBalanceEntity'][_0x4a4617(0x1c2)](_0xcb8c1a)[_0x4a4617(0x1cf)](_0x230198=>{const _0x140210=_0x4a4617;common_1[_0x140210(0x1b6)][_0x140210(0x1bc)]('用户'+_0x2f6b4a+'旧账户信息迁移成功','BalanceService');})[_0x4a4617(0x11a)](_0x580353=>{const _0x2d4d06=_0x4a4617;console[_0x2d4d06(0x123)](_0x2d4d06(0x186),_0x580353),common_1['Logger']['debug']('用户'+_0x2f6b4a+_0x2d4d06(0x169),_0x2d4d06(0x15e));});}async[_0x3ffb0c(0x1d0)](_0x33f554){const _0x43c617=_0x3ffb0c,{fingerprint:_0x19cc90}=_0x33f554[_0x43c617(0x181)],{id:_0x3b5cfe}=_0x33f554[_0x43c617(0x136)];return await this[_0x43c617(0x13b)]['update']({'userId':Number(_0x19cc90)},{'userId':_0x3b5cfe}),await this[_0x43c617(0x1a2)][_0x43c617(0x1bb)]({'userId':Number(_0x19cc90)},{'userId':_0x3b5cfe}),await this[_0x43c617(0x1d3)][_0x43c617(0x1bb)]({'userId':Number(_0x19cc90)},{'userId':_0x3b5cfe}),0x1;}async[_0x3ffb0c(0x13f)](_0x11f7ac){const _0x58b0f3=_0x3ffb0c,{fingerprint:_0x1757aa}=_0x11f7ac[_0x58b0f3(0x181)],_0x2d5c48=await this['chatLogEntity'][_0x58b0f3(0x11b)]({'where':{'userId':_0x1757aa}}),_0x498408=await this[_0x58b0f3(0x1a2)][_0x58b0f3(0x11b)]({'where':{'userId':_0x1757aa}}),_0x18e577=await this[_0x58b0f3(0x1d3)]['count']({'where':{'userId':_0x1757aa}});return _0x2d5c48||_0x498408||_0x18e577||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x3ffb0c(0x1b1)])(),__param(0x0,(0x0,typeorm_1[_0x3ffb0c(0x146)])(balance_entity_1['BalanceEntity'])),__param(0x1,(0x0,typeorm_1[_0x3ffb0c(0x146)])(userBalance_entity_1[_0x3ffb0c(0x17c)])),__param(0x2,(0x0,typeorm_1[_0x3ffb0c(0x146)])(accountLog_entity_1[_0x3ffb0c(0x17d)])),__param(0x3,(0x0,typeorm_1[_0x3ffb0c(0x146)])(cramiPackage_entity_1[_0x3ffb0c(0x172)])),__param(0x4,(0x0,typeorm_1[_0x3ffb0c(0x146)])(config_entity_1['ConfigEntity'])),__param(0x5,(0x0,typeorm_1[_0x3ffb0c(0x146)])(user_entity_1[_0x3ffb0c(0x15c)])),__param(0x6,(0x0,typeorm_1[_0x3ffb0c(0x146)])(salesUsers_entity_1[_0x3ffb0c(0x1ca)])),__param(0x7,(0x0,typeorm_1[_0x3ffb0c(0x146)])(whiteList_entity_1['WhiteListEntity'])),__param(0x8,(0x0,typeorm_1[_0x3ffb0c(0x146)])(fingerprint_entity_1[_0x3ffb0c(0x12c)])),__param(0x9,(0x0,typeorm_1[_0x3ffb0c(0x146)])(chatGroup_entity_1[_0x3ffb0c(0x1ba)])),__param(0xa,(0x0,typeorm_1[_0x3ffb0c(0x146)])(chatLog_entity_1[_0x3ffb0c(0x167)])),__param(0xb,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1[_0x3ffb0c(0x12e)])),__metadata(_0x3ffb0c(0x12a),[typeorm_2[_0x3ffb0c(0x139)],typeorm_2[_0x3ffb0c(0x139)],typeorm_2[_0x3ffb0c(0x139)],typeorm_2[_0x3ffb0c(0x139)],typeorm_2[_0x3ffb0c(0x139)],typeorm_2['Repository'],typeorm_2[_0x3ffb0c(0x139)],typeorm_2['Repository'],typeorm_2[_0x3ffb0c(0x139)],typeorm_2['Repository'],typeorm_2[_0x3ffb0c(0x139)],typeorm_2[_0x3ffb0c(0x139)],sales_service_1[_0x3ffb0c(0x118)],globalConfig_service_1['GlobalConfigService']])],UserBalanceService),exports[_0x3ffb0c(0x180)]=UserBalanceService;