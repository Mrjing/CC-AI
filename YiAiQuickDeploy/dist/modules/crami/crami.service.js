'use strict';const _0x23f4d5=_0xf069;(function(_0x450e68,_0x1ccae9){const _0x11d5e5=_0xf069,_0x2f9ae4=_0x450e68();while(!![]){try{const _0x486ee7=parseInt(_0x11d5e5(0x225))/0x1+-parseInt(_0x11d5e5(0x228))/0x2*(-parseInt(_0x11d5e5(0x22f))/0x3)+parseInt(_0x11d5e5(0x22b))/0x4*(parseInt(_0x11d5e5(0x250))/0x5)+parseInt(_0x11d5e5(0x200))/0x6*(-parseInt(_0x11d5e5(0x220))/0x7)+parseInt(_0x11d5e5(0x21c))/0x8+parseInt(_0x11d5e5(0x251))/0x9*(-parseInt(_0x11d5e5(0x23b))/0xa)+-parseInt(_0x11d5e5(0x239))/0xb*(parseInt(_0x11d5e5(0x20a))/0xc);if(_0x486ee7===_0x1ccae9)break;else _0x2f9ae4['push'](_0x2f9ae4['shift']());}catch(_0x1bcc7a){_0x2f9ae4['push'](_0x2f9ae4['shift']());}}}(_0x31a9,0x34fe2));function _0x31a9(){const _0x2a156e=['useCrami','map','BAD_REQUEST','MoreThan','createPackage','../userBalance/userBalance.service','26470LnFtqz','9VqVguf','object','PACKAGE_GIFT','length','findOne','username','role','generateCrami','../../common/constants/balance.constant','metadata','forEach','push','useId','batchDelCrami','当前卡密已被使用、请确认您输入的卡密是否正确！','super','addBalanceToUser','90hNIZCy','save','套餐名称或套餐等级重复、请检查！','LessThanOrEqual','删除卡密成功！','create','queryAllCrami','every','saveRecordRechargeLog','__param','1157196JaBIEX','decorate','__esModule','HttpException','createCrami','@nestjs/typeorm','InjectRepository','email','count','getOwnPropertyDescriptor','更新套餐成功！','当前卡密不存在、请确认您输入的卡密是否正确！','userBalanceService','code','updatePackage','delete','user','log','715816MtnBwR','DESC','delPackage','packageName','59927KkqxWE','queryAllPackage','CramiService','generateCramiCode','../user/user.entity','315341sfpfGD','CramiPackageEntity','cramiPackageEntity','2CyCFvA','find','findAndCount','212NwCVHG','maskEmail','删除卡密失败、请重试！','CramiEntity','280365AeiFZj','typeorm','当前卡密已被使用、已使用的卡密禁止删除！','当前卡密不存在、请确认您要删除的卡密是否存在！','cramiEntity','defineProperty','更新套餐失败、请重试！','Not','name','error:\x20','11kTMNsT','__decorate','3369490ilHGws','assign','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','update','__metadata','function','affected','Repository','Like','queryOnePackage','userEntity','HttpStatus','./crami.entity','./cramiPackage.entity','packageId'];_0x31a9=function(){return _0x2a156e;};return _0x31a9();}function _0xf069(_0x16981b,_0x23fd67){const _0x31a9c9=_0x31a9();return _0xf069=function(_0xf06920,_0x5419da){_0xf06920=_0xf06920-0x1f4;let _0x4585b1=_0x31a9c9[_0xf06920];return _0x4585b1;},_0xf069(_0x16981b,_0x23fd67);}var __decorate=this&&this[_0x23f4d5(0x23a)]||function(_0x4e4b4e,_0x37c602,_0x3196a0,_0x867d3c){const _0x3eb461=_0x23f4d5;var _0x40fbce=arguments[_0x3eb461(0x254)],_0x40305=_0x40fbce<0x3?_0x37c602:_0x867d3c===null?_0x867d3c=Object[_0x3eb461(0x213)](_0x37c602,_0x3196a0):_0x867d3c,_0x292861;if(typeof Reflect===_0x3eb461(0x252)&&typeof Reflect[_0x3eb461(0x20b)]==='function')_0x40305=Reflect[_0x3eb461(0x20b)](_0x4e4b4e,_0x37c602,_0x3196a0,_0x867d3c);else{for(var _0x375237=_0x4e4b4e['length']-0x1;_0x375237>=0x0;_0x375237--)if(_0x292861=_0x4e4b4e[_0x375237])_0x40305=(_0x40fbce<0x3?_0x292861(_0x40305):_0x40fbce>0x3?_0x292861(_0x37c602,_0x3196a0,_0x40305):_0x292861(_0x37c602,_0x3196a0))||_0x40305;}return _0x40fbce>0x3&&_0x40305&&Object[_0x3eb461(0x234)](_0x37c602,_0x3196a0,_0x40305),_0x40305;},__metadata=this&&this[_0x23f4d5(0x23f)]||function(_0x1c3e98,_0x31f8b4){const _0x38b944=_0x23f4d5;if(typeof Reflect===_0x38b944(0x252)&&typeof Reflect[_0x38b944(0x1f8)]===_0x38b944(0x240))return Reflect[_0x38b944(0x1f8)](_0x1c3e98,_0x31f8b4);},__param=this&&this[_0x23f4d5(0x209)]||function(_0x31d10a,_0x55895c){return function(_0x5c1eaf,_0x37f29c){_0x55895c(_0x5c1eaf,_0x37f29c,_0x31d10a);};};Object['defineProperty'](exports,_0x23f4d5(0x20c),{'value':!![]}),exports['CramiService']=void 0x0;const common_1=require('@nestjs/common'),crami_entity_1=require(_0x23f4d5(0x247)),typeorm_1=require(_0x23f4d5(0x20f)),typeorm_2=require(_0x23f4d5(0x230)),cramiPackage_entity_1=require(_0x23f4d5(0x248)),utils_1=require('../../common/utils'),user_entity_1=require(_0x23f4d5(0x224)),userBalance_service_1=require(_0x23f4d5(0x24f)),balance_constant_1=require(_0x23f4d5(0x1f7));let CramiService=class CramiService{constructor(_0x4a98df,_0x5155a1,_0x13ef27,_0x470cc2){const _0x258f5e=_0x23f4d5;this['cramiEntity']=_0x4a98df,this[_0x258f5e(0x227)]=_0x5155a1,this[_0x258f5e(0x245)]=_0x13ef27,this['userBalanceService']=_0x470cc2;}async[_0x23f4d5(0x244)](_0x1164dc){const _0xba68b3=_0x23f4d5;return await this[_0xba68b3(0x227)][_0xba68b3(0x255)]({'where':{'id':_0x1164dc}});}async[_0x23f4d5(0x221)](_0x5c430e){const _0x42aa3f=_0x23f4d5;try{const {page:page=0x1,size:size=0xa,name:_0x272e58,status:_0x1900ad,type:_0x56bea3}=_0x5c430e,_0xc16667={};_0x272e58&&Object[_0x42aa3f(0x23c)](_0xc16667,{'name':(0x0,typeorm_2[_0x42aa3f(0x243)])('%'+_0x272e58+'%')}),_0x1900ad&&Object[_0x42aa3f(0x23c)](_0xc16667,{'status':_0x1900ad});_0x56bea3&&(_0x56bea3>0x0?Object[_0x42aa3f(0x23c)](_0xc16667,{'days':(0x0,typeorm_2[_0x42aa3f(0x24d)])(0x0)}):Object[_0x42aa3f(0x23c)](_0xc16667,{'days':(0x0,typeorm_2[_0x42aa3f(0x203)])(0x0)}));const [_0x5390cf,_0x3b284b]=await this[_0x42aa3f(0x227)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0xc16667,'order':{'order':_0x42aa3f(0x21d)}});return{'rows':_0x5390cf,'count':_0x3b284b};}catch(_0x5a81b3){console[_0x42aa3f(0x21b)](_0x42aa3f(0x238),_0x5a81b3);}}async[_0x23f4d5(0x24e)](_0x2f7a62){const _0x57ebb2=_0x23f4d5,{name:_0x46387b,weight:_0x239fcb}=_0x2f7a62,_0x32be7a=await this[_0x57ebb2(0x227)][_0x57ebb2(0x255)]({'where':[{'name':_0x46387b},{'weight':_0x239fcb}]});if(_0x32be7a)throw new common_1[(_0x57ebb2(0x20d))]('套餐名称或套餐等级重复、请检查！',common_1[_0x57ebb2(0x246)][_0x57ebb2(0x24c)]);try{return await this[_0x57ebb2(0x227)][_0x57ebb2(0x201)](_0x2f7a62);}catch(_0x386e92){console[_0x57ebb2(0x21b)](_0x57ebb2(0x238),_0x386e92);throw new common_1[(_0x57ebb2(0x20d))](_0x386e92,common_1[_0x57ebb2(0x246)][_0x57ebb2(0x24c)]);}}async[_0x23f4d5(0x218)](_0x256b9f){const _0x11fcfd=_0x23f4d5,{id:_0x313b64,name:_0x20eb11,weight:_0x101f88}=_0x256b9f,_0x41c04f=await this[_0x11fcfd(0x227)][_0x11fcfd(0x255)]({'where':{'id':_0x313b64}});if(!_0x41c04f)throw new common_1[(_0x11fcfd(0x20d))]('当前套餐不存在、请检查你的输入参数！',common_1[_0x11fcfd(0x246)][_0x11fcfd(0x24c)]);const _0x516838=await this[_0x11fcfd(0x227)][_0x11fcfd(0x212)]({'where':[{'name':_0x20eb11,'id':(0x0,typeorm_2[_0x11fcfd(0x236)])(_0x313b64)},{'weight':_0x101f88,'id':(0x0,typeorm_2['Not'])(_0x313b64)}]});if(_0x516838)throw new common_1['HttpException'](_0x11fcfd(0x202),common_1[_0x11fcfd(0x246)][_0x11fcfd(0x24c)]);const _0x59c655=await this[_0x11fcfd(0x227)][_0x11fcfd(0x23e)]({'id':_0x313b64},_0x256b9f);if(_0x59c655['affected']>0x0)return _0x11fcfd(0x214);else throw new common_1[(_0x11fcfd(0x20d))](_0x11fcfd(0x235),common_1['HttpStatus'][_0x11fcfd(0x24c)]);}async[_0x23f4d5(0x21e)](_0x1b118e){const _0x56d82e=_0x23f4d5,{id:_0x3a822f}=_0x1b118e,_0x2e8cc3=await this[_0x56d82e(0x233)][_0x56d82e(0x212)]({'where':{'packageId':_0x3a822f}});if(_0x2e8cc3)throw new common_1['HttpException'](_0x56d82e(0x23d),common_1[_0x56d82e(0x246)][_0x56d82e(0x24c)]);return await this[_0x56d82e(0x227)][_0x56d82e(0x219)]({'id':_0x3a822f});}async[_0x23f4d5(0x20e)](_0xb8e05){const _0x187033=_0x23f4d5,{packageId:_0x40faa6,count:count=0x1}=_0xb8e05;if(_0x40faa6){const _0x191549=await this[_0x187033(0x227)]['findOne']({'where':{'id':_0x40faa6}});if(!_0x191549)throw new common_1[(_0x187033(0x20d))]('当前套餐不存在、请确认您选择的套餐是否存在！',common_1[_0x187033(0x246)]['BAD_REQUEST']);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x191549,_0x40bd29={'packageId':_0x40faa6,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x187033(0x1f6)](_0x40bd29,count);}if(!_0x40faa6){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0xb8e05;if([model3Count,model4Count,drawMjCount][_0x187033(0x207)](_0x86b56a=>!_0x86b56a))throw new common_1[(_0x187033(0x20d))]('自定义卡密必须至少一项余额不为0️零！',common_1[_0x187033(0x246)]['BAD_REQUEST']);const _0x30f678={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x187033(0x1f6)](_0x30f678,count);}}async[_0x23f4d5(0x1f6)](_0x490593,_0x219e76){const _0x4e15d0=_0x23f4d5,_0x35a4a6=[];for(let _0xb1a506=0x0;_0xb1a506<_0x219e76;_0xb1a506++){const _0x4f1fa1=(0x0,utils_1[_0x4e15d0(0x223)])(),_0x38ef27=this[_0x4e15d0(0x233)][_0x4e15d0(0x205)](Object[_0x4e15d0(0x23c)](Object['assign']({},_0x490593),{'code':_0x4f1fa1}));_0x35a4a6[_0x4e15d0(0x1fa)](_0x38ef27);}return await this[_0x4e15d0(0x233)][_0x4e15d0(0x201)](_0x35a4a6);}async[_0x23f4d5(0x24a)](_0x163e4c,_0x44ea0f){const _0xa444d1=_0x23f4d5,{id:_0x6e38dc}=_0x163e4c[_0xa444d1(0x21a)],_0x5a6f99=await this['cramiEntity'][_0xa444d1(0x255)]({'where':{'code':_0x44ea0f[_0xa444d1(0x217)]}});if(!_0x5a6f99)throw new common_1[(_0xa444d1(0x20d))](_0xa444d1(0x215),common_1['HttpStatus'][_0xa444d1(0x24c)]);const {status:_0x365be2,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x3bb62d}=_0x5a6f99;if(_0x365be2===0x1)throw new common_1[(_0xa444d1(0x20d))](_0xa444d1(0x1fd),common_1[_0xa444d1(0x246)][_0xa444d1(0x24c)]);const _0x32bb9f={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x3bb62d};return await this[_0xa444d1(0x216)][_0xa444d1(0x1ff)](_0x6e38dc,Object[_0xa444d1(0x23c)]({},_0x32bb9f),days),await this[_0xa444d1(0x216)][_0xa444d1(0x208)]({'userId':_0x6e38dc,'rechargeType':balance_constant_1['RechargeType'][_0xa444d1(0x253)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this['cramiEntity']['update']({'code':_0x44ea0f['code']},{'useId':_0x6e38dc,'status':0x1}),'使用卡密成功';}async[_0x23f4d5(0x206)](_0x22d86e,_0x2c5138){const _0x473156=_0x23f4d5,{page:page=0x1,size:size=0xa,status:_0x54d2fd,useId:_0x456057}=_0x22d86e,_0x91522b={};_0x54d2fd&&Object['assign'](_0x91522b,{'status':_0x54d2fd}),_0x456057&&Object[_0x473156(0x23c)](_0x91522b,{'useId':_0x456057});const [_0x5f36be,_0x107480]=await this[_0x473156(0x233)][_0x473156(0x22a)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':_0x473156(0x21d)},'where':_0x91522b}),_0x43e18f=_0x5f36be[_0x473156(0x24b)](_0x53d969=>_0x53d969[_0x473156(0x1fb)]),_0x3ea325=_0x5f36be[_0x473156(0x24b)](_0xa41f0c=>_0xa41f0c[_0x473156(0x249)]),_0x1e58e4=await this[_0x473156(0x245)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x43e18f)}}),_0x298374=await this['cramiPackageEntity'][_0x473156(0x229)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3ea325)}});return _0x5f36be[_0x473156(0x1f9)](_0x532abf=>{const _0x2b3d32=_0x473156;var _0x533119,_0x3929cf,_0x1e70b6;_0x532abf[_0x2b3d32(0x1f4)]=(_0x533119=_0x1e58e4[_0x2b3d32(0x229)](_0x3eb9cb=>_0x3eb9cb['id']===_0x532abf[_0x2b3d32(0x1fb)]))===null||_0x533119===void 0x0?void 0x0:_0x533119[_0x2b3d32(0x1f4)],_0x532abf['email']=(_0x3929cf=_0x1e58e4['find'](_0x160195=>_0x160195['id']===_0x532abf[_0x2b3d32(0x1fb)]))===null||_0x3929cf===void 0x0?void 0x0:_0x3929cf['email'],_0x532abf[_0x2b3d32(0x21f)]=(_0x1e70b6=_0x298374[_0x2b3d32(0x229)](_0x1895f7=>_0x1895f7['id']===_0x532abf[_0x2b3d32(0x249)]))===null||_0x1e70b6===void 0x0?void 0x0:_0x1e70b6[_0x2b3d32(0x237)];}),_0x2c5138[_0x473156(0x21a)][_0x473156(0x1f5)]!=='super'&&_0x5f36be[_0x473156(0x1f9)](_0x4b7453=>_0x4b7453[_0x473156(0x211)]=(0x0,utils_1[_0x473156(0x22c)])(_0x4b7453['email'])),_0x2c5138['user'][_0x473156(0x1f5)]!==_0x473156(0x1fe)&&_0x5f36be[_0x473156(0x1f9)](_0x14bd98=>_0x14bd98[_0x473156(0x217)]=(0x0,utils_1['maskCrami'])(_0x14bd98[_0x473156(0x217)])),{'rows':_0x5f36be,'count':_0x107480};}async['delCrami'](_0x2ae9a4){const _0x55b955=_0x23f4d5,_0x28cf9e=await this[_0x55b955(0x233)][_0x55b955(0x255)]({'where':{'id':_0x2ae9a4}});if(!_0x28cf9e)throw new common_1['HttpException'](_0x55b955(0x232),common_1[_0x55b955(0x246)][_0x55b955(0x24c)]);if(_0x28cf9e['status']===0x1)throw new common_1[(_0x55b955(0x20d))](_0x55b955(0x231),common_1[_0x55b955(0x246)][_0x55b955(0x24c)]);return await this[_0x55b955(0x233)][_0x55b955(0x219)]({'id':_0x2ae9a4});}async[_0x23f4d5(0x1fc)](_0x1527e7){const _0x39c5cf=_0x23f4d5,{ids:_0xae6b91}=_0x1527e7,_0x503c38=await this['cramiEntity'][_0x39c5cf(0x219)](_0xae6b91);if(_0x503c38[_0x39c5cf(0x241)]>0x0)return _0x39c5cf(0x204);else throw new common_1[(_0x39c5cf(0x20d))](_0x39c5cf(0x22d),common_1['HttpStatus'][_0x39c5cf(0x24c)]);}};CramiService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x23f4d5(0x210)])(crami_entity_1[_0x23f4d5(0x22e)])),__param(0x1,(0x0,typeorm_1[_0x23f4d5(0x210)])(cramiPackage_entity_1[_0x23f4d5(0x226)])),__param(0x2,(0x0,typeorm_1[_0x23f4d5(0x210)])(user_entity_1['UserEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x23f4d5(0x242)],typeorm_2[_0x23f4d5(0x242)],typeorm_2[_0x23f4d5(0x242)],userBalance_service_1['UserBalanceService']])],CramiService),exports[_0x23f4d5(0x222)]=CramiService;