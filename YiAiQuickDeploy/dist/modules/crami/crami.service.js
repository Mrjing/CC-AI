'use strict';const _0x968f4e=_0x182c;(function(_0x1539f0,_0x974e95){const _0x129839=_0x182c,_0x16a4da=_0x1539f0();while(!![]){try{const _0x202a11=parseInt(_0x129839(0x11f))/0x1*(parseInt(_0x129839(0x139))/0x2)+parseInt(_0x129839(0x13b))/0x3*(parseInt(_0x129839(0x154))/0x4)+-parseInt(_0x129839(0x124))/0x5*(-parseInt(_0x129839(0x140))/0x6)+parseInt(_0x129839(0x12c))/0x7*(parseInt(_0x129839(0x131))/0x8)+-parseInt(_0x129839(0x10d))/0x9*(parseInt(_0x129839(0x136))/0xa)+parseInt(_0x129839(0x146))/0xb+parseInt(_0x129839(0x159))/0xc*(-parseInt(_0x129839(0x117))/0xd);if(_0x202a11===_0x974e95)break;else _0x16a4da['push'](_0x16a4da['shift']());}catch(_0x3da720){_0x16a4da['push'](_0x16a4da['shift']());}}}(_0x6d2d,0x74f7e));var __decorate=this&&this[_0x968f4e(0x15e)]||function(_0x1ee909,_0x3dc0e2,_0x1e77b3,_0x2653e8){const _0x589b11=_0x968f4e;var _0x4b3439=arguments[_0x589b11(0x14f)],_0x2f0b88=_0x4b3439<0x3?_0x3dc0e2:_0x2653e8===null?_0x2653e8=Object[_0x589b11(0x135)](_0x3dc0e2,_0x1e77b3):_0x2653e8,_0x24863b;if(typeof Reflect===_0x589b11(0x10e)&&typeof Reflect[_0x589b11(0x129)]===_0x589b11(0x134))_0x2f0b88=Reflect[_0x589b11(0x129)](_0x1ee909,_0x3dc0e2,_0x1e77b3,_0x2653e8);else{for(var _0x23b63e=_0x1ee909['length']-0x1;_0x23b63e>=0x0;_0x23b63e--)if(_0x24863b=_0x1ee909[_0x23b63e])_0x2f0b88=(_0x4b3439<0x3?_0x24863b(_0x2f0b88):_0x4b3439>0x3?_0x24863b(_0x3dc0e2,_0x1e77b3,_0x2f0b88):_0x24863b(_0x3dc0e2,_0x1e77b3))||_0x2f0b88;}return _0x4b3439>0x3&&_0x2f0b88&&Object['defineProperty'](_0x3dc0e2,_0x1e77b3,_0x2f0b88),_0x2f0b88;},__metadata=this&&this['__metadata']||function(_0x19a4dd,_0x58bbcc){const _0x182908=_0x968f4e;if(typeof Reflect===_0x182908(0x10e)&&typeof Reflect[_0x182908(0x116)]===_0x182908(0x134))return Reflect[_0x182908(0x116)](_0x19a4dd,_0x58bbcc);},__param=this&&this[_0x968f4e(0x128)]||function(_0x4716c1,_0xa7d597){return function(_0x6b054,_0x11521f){_0xa7d597(_0x6b054,_0x11521f,_0x4716c1);};};Object['defineProperty'](exports,_0x968f4e(0x12f),{'value':!![]}),exports['CramiService']=void 0x0;const common_1=require('@nestjs/common'),crami_entity_1=require(_0x968f4e(0x123)),typeorm_1=require(_0x968f4e(0x144)),typeorm_2=require(_0x968f4e(0x119)),cramiPackage_entity_1=require('./cramiPackage.entity'),utils_1=require(_0x968f4e(0x150)),user_entity_1=require(_0x968f4e(0x120)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require(_0x968f4e(0x118));let CramiService=class CramiService{constructor(_0x21fa62,_0x4a9428,_0x558c5c,_0x5ccc85){const _0x4d0d61=_0x968f4e;this[_0x4d0d61(0x11b)]=_0x21fa62,this['cramiPackageEntity']=_0x4a9428,this[_0x4d0d61(0x158)]=_0x558c5c,this[_0x4d0d61(0x113)]=_0x5ccc85;}async[_0x968f4e(0x166)](_0x148f93){const _0x6023bb=_0x968f4e;return await this['cramiPackageEntity'][_0x6023bb(0x14b)]({'where':{'id':_0x148f93}});}async[_0x968f4e(0x14d)](_0x522116){const _0x566bd4=_0x968f4e;try{const {page:page=0x1,size:size=0xa,name:_0x42201d,status:_0x42737f,type:_0x4637e2}=_0x522116,_0xb1a491={};_0x42201d&&Object[_0x566bd4(0x109)](_0xb1a491,{'name':(0x0,typeorm_2[_0x566bd4(0x12d)])('%'+_0x42201d+'%')}),_0x42737f&&Object[_0x566bd4(0x109)](_0xb1a491,{'status':_0x42737f});_0x4637e2&&(_0x4637e2>0x0?Object[_0x566bd4(0x109)](_0xb1a491,{'days':(0x0,typeorm_2[_0x566bd4(0x163)])(0x0)}):Object[_0x566bd4(0x109)](_0xb1a491,{'days':(0x0,typeorm_2['LessThanOrEqual'])(0x0)}));const [_0x51072b,_0x4c0dd8]=await this[_0x566bd4(0x162)][_0x566bd4(0x12e)]({'skip':(page-0x1)*size,'take':size,'where':_0xb1a491,'order':{'order':_0x566bd4(0x15c)}});return{'rows':_0x51072b,'count':_0x4c0dd8};}catch(_0x3fa87a){console[_0x566bd4(0x112)](_0x566bd4(0x10b),_0x3fa87a);}}async[_0x968f4e(0x13d)](_0x3d83ad){const _0x3ba98a=_0x968f4e,{name:_0xba13da,weight:_0x78af08}=_0x3d83ad,_0x51a200=await this[_0x3ba98a(0x162)][_0x3ba98a(0x14b)]({'where':[{'name':_0xba13da},{'weight':_0x78af08}]});if(_0x51a200)throw new common_1[(_0x3ba98a(0x142))]('套餐名称或套餐等级重复、请检查！',common_1[_0x3ba98a(0x13a)][_0x3ba98a(0x133)]);try{return await this['cramiPackageEntity'][_0x3ba98a(0x153)](_0x3d83ad);}catch(_0x392bf9){console['log']('error:\x20',_0x392bf9);throw new common_1[(_0x3ba98a(0x142))](_0x392bf9,common_1['HttpStatus'][_0x3ba98a(0x133)]);}}async[_0x968f4e(0x15d)](_0x12f50f){const _0x598e6c=_0x968f4e,{id:_0xcf1dc0,name:_0x44fdfe,weight:_0x48bc98}=_0x12f50f,_0x45c4e4=await this[_0x598e6c(0x162)][_0x598e6c(0x14b)]({'where':{'id':_0xcf1dc0}});if(!_0x45c4e4)throw new common_1[(_0x598e6c(0x142))]('当前套餐不存在、请检查你的输入参数！',common_1[_0x598e6c(0x13a)][_0x598e6c(0x133)]);const _0x2a03f2=await this['cramiPackageEntity'][_0x598e6c(0x114)]({'where':[{'name':_0x44fdfe,'id':(0x0,typeorm_2[_0x598e6c(0x111)])(_0xcf1dc0)},{'weight':_0x48bc98,'id':(0x0,typeorm_2[_0x598e6c(0x111)])(_0xcf1dc0)}]});if(_0x2a03f2)throw new common_1[(_0x598e6c(0x142))]('套餐名称或套餐等级重复、请检查！',common_1[_0x598e6c(0x13a)][_0x598e6c(0x133)]);const _0x313948=await this[_0x598e6c(0x162)][_0x598e6c(0x125)]({'id':_0xcf1dc0},_0x12f50f);if(_0x313948[_0x598e6c(0x10a)]>0x0)return _0x598e6c(0x149);else throw new common_1[(_0x598e6c(0x142))]('更新套餐失败、请重试！',common_1[_0x598e6c(0x13a)][_0x598e6c(0x133)]);}async[_0x968f4e(0x115)](_0x53d1fe){const _0x3fa33e=_0x968f4e,{id:_0x89bf9a}=_0x53d1fe,_0x1b7b05=await this['cramiEntity'][_0x3fa33e(0x114)]({'where':{'packageId':_0x89bf9a}});if(_0x1b7b05)throw new common_1['HttpException'](_0x3fa33e(0x15b),common_1[_0x3fa33e(0x13a)][_0x3fa33e(0x133)]);return await this[_0x3fa33e(0x162)][_0x3fa33e(0x12b)]({'id':_0x89bf9a});}async[_0x968f4e(0x148)](_0x1fb2b6){const _0x471116=_0x968f4e,{packageId:_0x18a21b,count:count=0x1}=_0x1fb2b6;if(_0x18a21b){const _0x2bc6c2=await this['cramiPackageEntity'][_0x471116(0x14b)]({'where':{'id':_0x18a21b}});if(!_0x2bc6c2)throw new common_1[(_0x471116(0x142))](_0x471116(0x127),common_1['HttpStatus'][_0x471116(0x133)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2bc6c2,_0x5d817b={'packageId':_0x18a21b,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x471116(0x13e)](_0x5d817b,count);}if(!_0x18a21b){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x1fb2b6;if([model3Count,model4Count,drawMjCount][_0x471116(0x10f)](_0x4b0eb0=>!_0x4b0eb0))throw new common_1[(_0x471116(0x142))](_0x471116(0x122),common_1[_0x471116(0x13a)][_0x471116(0x133)]);const _0x311cf8={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x471116(0x13e)](_0x311cf8,count);}}async['generateCrami'](_0x4d95cc,_0x5e330b){const _0x3eaa44=_0x968f4e,_0x28e60f=[];for(let _0x3859a6=0x0;_0x3859a6<_0x5e330b;_0x3859a6++){const _0x4835f8=(0x0,utils_1[_0x3eaa44(0x160)])(),_0x158523=this[_0x3eaa44(0x11b)][_0x3eaa44(0x161)](Object[_0x3eaa44(0x109)](Object[_0x3eaa44(0x109)]({},_0x4d95cc),{'code':_0x4835f8}));_0x28e60f[_0x3eaa44(0x14e)](_0x158523);}return await this['cramiEntity'][_0x3eaa44(0x153)](_0x28e60f);}async[_0x968f4e(0x11d)](_0x335e7d,_0x1412ad){const _0x228791=_0x968f4e,{id:_0x5c95cc}=_0x335e7d['user'],_0x34a369=await this['cramiEntity'][_0x228791(0x14b)]({'where':{'code':_0x1412ad[_0x228791(0x132)]}});if(!_0x34a369)throw new common_1[(_0x228791(0x142))](_0x228791(0x138),common_1[_0x228791(0x13a)][_0x228791(0x133)]);const {status:_0x4a0290,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x28e8f7}=_0x34a369;if(_0x4a0290===0x1)throw new common_1[(_0x228791(0x142))](_0x228791(0x164),common_1['HttpStatus']['BAD_REQUEST']);const _0x25c84c={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x28e8f7};return await this[_0x228791(0x113)]['addBalanceToUser'](_0x5c95cc,Object[_0x228791(0x109)]({},_0x25c84c),days),await this['userBalanceService']['saveRecordRechargeLog']({'userId':_0x5c95cc,'rechargeType':balance_constant_1['RechargeType'][_0x228791(0x121)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this['cramiEntity'][_0x228791(0x125)]({'code':_0x1412ad[_0x228791(0x132)]},{'useId':_0x5c95cc,'status':0x1}),'使用卡密成功';}async[_0x968f4e(0x141)](_0x311a8f,_0x597e7d){const _0x223c20=_0x968f4e,{page:page=0x1,size:size=0xa,status:_0x59e4a7,useId:_0x59735c}=_0x311a8f,_0x3d66f6={};_0x59e4a7&&Object[_0x223c20(0x109)](_0x3d66f6,{'status':_0x59e4a7}),_0x59735c&&Object['assign'](_0x3d66f6,{'useId':_0x59735c});const [_0x56c882,_0x1cede5]=await this['cramiEntity'][_0x223c20(0x12e)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':_0x223c20(0x15c)},'where':_0x3d66f6}),_0x26ed8b=_0x56c882[_0x223c20(0x156)](_0x586fd8=>_0x586fd8[_0x223c20(0x137)]),_0x1db70d=_0x56c882[_0x223c20(0x156)](_0x2e2ba1=>_0x2e2ba1[_0x223c20(0x10c)]),_0x2ba79f=await this[_0x223c20(0x158)][_0x223c20(0x13f)]({'where':{'id':(0x0,typeorm_2['In'])(_0x26ed8b)}}),_0xc5637e=await this[_0x223c20(0x162)][_0x223c20(0x13f)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1db70d)}});return _0x56c882['forEach'](_0x405508=>{const _0x2cf9ed=_0x223c20;var _0x4912f3,_0x3733a6,_0x268f4b;_0x405508[_0x2cf9ed(0x15a)]=(_0x4912f3=_0x2ba79f[_0x2cf9ed(0x13f)](_0xf0af87=>_0xf0af87['id']===_0x405508['useId']))===null||_0x4912f3===void 0x0?void 0x0:_0x4912f3[_0x2cf9ed(0x15a)],_0x405508[_0x2cf9ed(0x11c)]=(_0x3733a6=_0x2ba79f['find'](_0x8be09c=>_0x8be09c['id']===_0x405508[_0x2cf9ed(0x137)]))===null||_0x3733a6===void 0x0?void 0x0:_0x3733a6[_0x2cf9ed(0x11c)],_0x405508[_0x2cf9ed(0x155)]=(_0x268f4b=_0xc5637e[_0x2cf9ed(0x13f)](_0x4d7806=>_0x4d7806['id']===_0x405508[_0x2cf9ed(0x10c)]))===null||_0x268f4b===void 0x0?void 0x0:_0x268f4b[_0x2cf9ed(0x152)];}),_0x597e7d[_0x223c20(0x130)]['role']!==_0x223c20(0x165)&&_0x56c882[_0x223c20(0x11e)](_0x4e70a0=>_0x4e70a0[_0x223c20(0x11c)]=(0x0,utils_1[_0x223c20(0x13c)])(_0x4e70a0[_0x223c20(0x11c)])),_0x597e7d[_0x223c20(0x130)]['role']!==_0x223c20(0x165)&&_0x56c882['forEach'](_0x542004=>_0x542004[_0x223c20(0x132)]=(0x0,utils_1[_0x223c20(0x151)])(_0x542004[_0x223c20(0x132)])),{'rows':_0x56c882,'count':_0x1cede5};}async['delCrami'](_0x2b9914){const _0x43abf9=_0x968f4e,_0x5106fc=await this['cramiEntity'][_0x43abf9(0x14b)]({'where':{'id':_0x2b9914}});if(!_0x5106fc)throw new common_1[(_0x43abf9(0x142))]('当前卡密不存在、请确认您要删除的卡密是否存在！',common_1['HttpStatus'][_0x43abf9(0x133)]);if(_0x5106fc[_0x43abf9(0x147)]===0x1)throw new common_1['HttpException']('当前卡密已被使用、已使用的卡密禁止删除！',common_1[_0x43abf9(0x13a)]['BAD_REQUEST']);return await this[_0x43abf9(0x11b)][_0x43abf9(0x12b)]({'id':_0x2b9914});}async['batchDelCrami'](_0x3ddb0f){const _0x4be261=_0x968f4e,{ids:_0x2dcfb1}=_0x3ddb0f,_0x3fe889=await this[_0x4be261(0x11b)]['delete'](_0x2dcfb1);if(_0x3fe889['affected']>0x0)return _0x4be261(0x143);else throw new common_1['HttpException'](_0x4be261(0x145),common_1[_0x4be261(0x13a)][_0x4be261(0x133)]);}};CramiService=__decorate([(0x0,common_1[_0x968f4e(0x14a)])(),__param(0x0,(0x0,typeorm_1[_0x968f4e(0x126)])(crami_entity_1[_0x968f4e(0x15f)])),__param(0x1,(0x0,typeorm_1[_0x968f4e(0x126)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1[_0x968f4e(0x126)])(user_entity_1[_0x968f4e(0x11a)])),__metadata(_0x968f4e(0x110),[typeorm_2[_0x968f4e(0x12a)],typeorm_2['Repository'],typeorm_2[_0x968f4e(0x12a)],userBalance_service_1[_0x968f4e(0x14c)]])],CramiService),exports[_0x968f4e(0x157)]=CramiService;function _0x182c(_0x440d7e,_0x3354b8){const _0x6d2db5=_0x6d2d();return _0x182c=function(_0x182c5d,_0xb18d24){_0x182c5d=_0x182c5d-0x109;let _0x2ab60e=_0x6d2db5[_0x182c5d];return _0x2ab60e;},_0x182c(_0x440d7e,_0x3354b8);}function _0x6d2d(){const _0x21087b=['../user/user.entity','PACKAGE_GIFT','自定义卡密必须至少一项余额不为0️零！','./crami.entity','5EcyMgQ','update','InjectRepository','当前套餐不存在、请确认您选择的套餐是否存在！','__param','decorate','Repository','delete','77cgqyMb','Like','findAndCount','__esModule','user','2328OWZtiK','code','BAD_REQUEST','function','getOwnPropertyDescriptor','100keetFp','useId','当前卡密不存在、请确认您输入的卡密是否正确！','303306JMFVOV','HttpStatus','807159tdySiP','maskEmail','createPackage','generateCrami','find','218280fQPTuB','queryAllCrami','HttpException','删除卡密成功！','@nestjs/typeorm','删除卡密失败、请重试！','7496511Cgxzqd','status','createCrami','更新套餐成功！','Injectable','findOne','UserBalanceService','queryAllPackage','push','length','../../common/utils','maskCrami','name','save','12nlwNDo','packageName','map','CramiService','userEntity','24DyRkSn','username','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','DESC','updatePackage','__decorate','CramiEntity','generateCramiCode','create','cramiPackageEntity','MoreThan','当前卡密已被使用、请确认您输入的卡密是否正确！','super','queryOnePackage','assign','affected','error:\x20','packageId','290583IQtsMk','object','every','design:paramtypes','Not','log','userBalanceService','count','delPackage','metadata','5706493vFBuzC','../../common/constants/balance.constant','typeorm','UserEntity','cramiEntity','email','useCrami','forEach','1SzLugY'];_0x6d2d=function(){return _0x21087b;};return _0x6d2d();}