'use strict';function _0x152e(){const _0x465525=['更新套餐成功！','packageId','当前套餐不存在、请检查你的输入参数！','51678cqpKRA','CramiPackageEntity','useId','createPackage','length','2370OMMimR','UserEntity','code','create','queryOnePackage','./cramiPackage.entity','HttpStatus','__esModule','Injectable','object','queryAllCrami','forEach','自定义卡密必须至少一项余额不为0️零！','使用卡密成功','当前套餐不存在、请确认您选择的套餐是否存在！','2nLmGvd','name','update','role','user','maskCrami','707OhOtOg','210973tVuxlH','当前卡密不存在、请确认您输入的卡密是否正确！','1608216reGQPf','更新套餐失败、请重试！','save','./crami.entity','userEntity','function','../user/user.entity','delete','find','findOne','every','Repository','删除卡密失败、请重试！','map','generateCramiCode','username','__decorate','cramiPackageEntity','套餐名称或套餐等级重复、请检查！','delCrami','80296XbvCsB','../userBalance/userBalance.service','generateCrami','cramiEntity','assign','userBalanceService','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','../../common/utils','push','DESC','metadata','packageName','InjectRepository','log','Like','3653560bcGOKb','__metadata','LessThanOrEqual','count','defineProperty','HttpException','design:paramtypes','typeorm','BAD_REQUEST','当前卡密不存在、请确认您要删除的卡密是否存在！','error:\x20','../../common/constants/balance.constant','useCrami','addBalanceToUser','Not','affected','当前卡密已被使用、请确认您输入的卡密是否正确！','batchDelCrami','CramiService','super','删除卡密成功！','findAndCount','1205610DHWxcn','queryAllPackage','email','PACKAGE_GIFT','5952558QrUsSB','__param'];_0x152e=function(){return _0x465525;};return _0x152e();}const _0x1f2c71=_0x150b;(function(_0x6e90de,_0x2f0a15){const _0x40579e=_0x150b,_0xb8c759=_0x6e90de();while(!![]){try{const _0x23edd2=parseInt(_0x40579e(0x12f))/0x1*(parseInt(_0x40579e(0x128))/0x2)+parseInt(_0x40579e(0x131))/0x3+parseInt(_0x40579e(0xf5))/0x4+parseInt(_0x40579e(0x10b))/0x5+-parseInt(_0x40579e(0x10f))/0x6+parseInt(_0x40579e(0x12e))/0x7*(parseInt(_0x40579e(0xe6))/0x8)+parseInt(_0x40579e(0x114))/0x9*(-parseInt(_0x40579e(0x119))/0xa);if(_0x23edd2===_0x2f0a15)break;else _0xb8c759['push'](_0xb8c759['shift']());}catch(_0x28ab5f){_0xb8c759['push'](_0xb8c759['shift']());}}}(_0x152e,0x894ab));var __decorate=this&&this[_0x1f2c71(0xe2)]||function(_0x4a2f68,_0x1ed883,_0x3ce1ec,_0x47c4d6){const _0x47d9e5=_0x1f2c71;var _0x11d661=arguments[_0x47d9e5(0x118)],_0x40a685=_0x11d661<0x3?_0x1ed883:_0x47c4d6===null?_0x47c4d6=Object['getOwnPropertyDescriptor'](_0x1ed883,_0x3ce1ec):_0x47c4d6,_0x5864f7;if(typeof Reflect===_0x47d9e5(0x122)&&typeof Reflect['decorate']===_0x47d9e5(0x136))_0x40a685=Reflect['decorate'](_0x4a2f68,_0x1ed883,_0x3ce1ec,_0x47c4d6);else{for(var _0xf4e618=_0x4a2f68[_0x47d9e5(0x118)]-0x1;_0xf4e618>=0x0;_0xf4e618--)if(_0x5864f7=_0x4a2f68[_0xf4e618])_0x40a685=(_0x11d661<0x3?_0x5864f7(_0x40a685):_0x11d661>0x3?_0x5864f7(_0x1ed883,_0x3ce1ec,_0x40a685):_0x5864f7(_0x1ed883,_0x3ce1ec))||_0x40a685;}return _0x11d661>0x3&&_0x40a685&&Object['defineProperty'](_0x1ed883,_0x3ce1ec,_0x40a685),_0x40a685;},__metadata=this&&this[_0x1f2c71(0xf6)]||function(_0x399f7a,_0x475c0a){const _0x2f5cc1=_0x1f2c71;if(typeof Reflect===_0x2f5cc1(0x122)&&typeof Reflect[_0x2f5cc1(0xf0)]===_0x2f5cc1(0x136))return Reflect[_0x2f5cc1(0xf0)](_0x399f7a,_0x475c0a);},__param=this&&this[_0x1f2c71(0x110)]||function(_0x5a932b,_0xd2e318){return function(_0x510b2d,_0x126471){_0xd2e318(_0x510b2d,_0x126471,_0x5a932b);};};Object[_0x1f2c71(0xf9)](exports,_0x1f2c71(0x120),{'value':!![]}),exports[_0x1f2c71(0x107)]=void 0x0;function _0x150b(_0x46a8d0,_0x4426e0){const _0x152ede=_0x152e();return _0x150b=function(_0x150b0e,_0x281cee){_0x150b0e=_0x150b0e-0xe2;let _0x90953b=_0x152ede[_0x150b0e];return _0x90953b;},_0x150b(_0x46a8d0,_0x4426e0);}const common_1=require('@nestjs/common'),crami_entity_1=require(_0x1f2c71(0x134)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x1f2c71(0xfc)),cramiPackage_entity_1=require(_0x1f2c71(0x11e)),utils_1=require(_0x1f2c71(0xed)),user_entity_1=require(_0x1f2c71(0x137)),userBalance_service_1=require(_0x1f2c71(0xe7)),balance_constant_1=require(_0x1f2c71(0x100));let CramiService=class CramiService{constructor(_0x98624f,_0x1059f6,_0x49e85d,_0x29789e){const _0x57bcc2=_0x1f2c71;this[_0x57bcc2(0xe9)]=_0x98624f,this['cramiPackageEntity']=_0x1059f6,this['userEntity']=_0x49e85d,this['userBalanceService']=_0x29789e;}async[_0x1f2c71(0x11d)](_0x58c01c){const _0x200d58=_0x1f2c71;return await this[_0x200d58(0xe3)][_0x200d58(0x13a)]({'where':{'id':_0x58c01c}});}async[_0x1f2c71(0x10c)](_0x36e3ec){const _0x40f968=_0x1f2c71;try{const {page:page=0x1,size:size=0xa,name:_0x392dc3,status:_0x3ca61d,type:_0x4e8ff1}=_0x36e3ec,_0xcd40ba={};_0x392dc3&&Object[_0x40f968(0xea)](_0xcd40ba,{'name':(0x0,typeorm_2[_0x40f968(0xf4)])('%'+_0x392dc3+'%')}),_0x3ca61d&&Object[_0x40f968(0xea)](_0xcd40ba,{'status':_0x3ca61d});_0x4e8ff1&&(_0x4e8ff1>0x0?Object[_0x40f968(0xea)](_0xcd40ba,{'days':(0x0,typeorm_2['MoreThan'])(0x0)}):Object['assign'](_0xcd40ba,{'days':(0x0,typeorm_2[_0x40f968(0xf7)])(0x0)}));const [_0x2fe5f2,_0x5ccf78]=await this[_0x40f968(0xe3)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0xcd40ba,'order':{'order':_0x40f968(0xef)}});return{'rows':_0x2fe5f2,'count':_0x5ccf78};}catch(_0x200057){console[_0x40f968(0xf3)](_0x40f968(0xff),_0x200057);}}async[_0x1f2c71(0x117)](_0xa59676){const _0x41f46f=_0x1f2c71,{name:_0x48a9b5,weight:_0x1cff8a}=_0xa59676,_0x3fe972=await this[_0x41f46f(0xe3)]['findOne']({'where':[{'name':_0x48a9b5},{'weight':_0x1cff8a}]});if(_0x3fe972)throw new common_1[(_0x41f46f(0xfa))](_0x41f46f(0xe4),common_1[_0x41f46f(0x11f)]['BAD_REQUEST']);try{return await this[_0x41f46f(0xe3)]['save'](_0xa59676);}catch(_0x5e8529){console[_0x41f46f(0xf3)]('error:\x20',_0x5e8529);throw new common_1[(_0x41f46f(0xfa))](_0x5e8529,common_1[_0x41f46f(0x11f)][_0x41f46f(0xfd)]);}}async['updatePackage'](_0x40d2aa){const _0x3d3b49=_0x1f2c71,{id:_0x2eaa48,name:_0x2c9a9b,weight:_0x29181b}=_0x40d2aa,_0x5a396=await this[_0x3d3b49(0xe3)]['findOne']({'where':{'id':_0x2eaa48}});if(!_0x5a396)throw new common_1[(_0x3d3b49(0xfa))](_0x3d3b49(0x113),common_1[_0x3d3b49(0x11f)][_0x3d3b49(0xfd)]);const _0x54d443=await this[_0x3d3b49(0xe3)][_0x3d3b49(0xf8)]({'where':[{'name':_0x2c9a9b,'id':(0x0,typeorm_2[_0x3d3b49(0x103)])(_0x2eaa48)},{'weight':_0x29181b,'id':(0x0,typeorm_2['Not'])(_0x2eaa48)}]});if(_0x54d443)throw new common_1['HttpException'](_0x3d3b49(0xe4),common_1[_0x3d3b49(0x11f)]['BAD_REQUEST']);const _0x247e6e=await this['cramiPackageEntity']['update']({'id':_0x2eaa48},_0x40d2aa);if(_0x247e6e['affected']>0x0)return _0x3d3b49(0x111);else throw new common_1[(_0x3d3b49(0xfa))](_0x3d3b49(0x132),common_1[_0x3d3b49(0x11f)][_0x3d3b49(0xfd)]);}async['delPackage'](_0x3df0c4){const _0x15d37e=_0x1f2c71,{id:_0xdb0f31}=_0x3df0c4,_0x31106d=await this[_0x15d37e(0xe9)][_0x15d37e(0xf8)]({'where':{'packageId':_0xdb0f31}});if(_0x31106d)throw new common_1[(_0x15d37e(0xfa))](_0x15d37e(0xec),common_1[_0x15d37e(0x11f)][_0x15d37e(0xfd)]);return await this['cramiPackageEntity'][_0x15d37e(0x138)]({'id':_0xdb0f31});}async['createCrami'](_0x2226e9){const _0xb9ea73=_0x1f2c71,{packageId:_0x126269,count:count=0x1}=_0x2226e9;if(_0x126269){const _0x2ab723=await this[_0xb9ea73(0xe3)][_0xb9ea73(0x13a)]({'where':{'id':_0x126269}});if(!_0x2ab723)throw new common_1[(_0xb9ea73(0xfa))](_0xb9ea73(0x127),common_1['HttpStatus'][_0xb9ea73(0xfd)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2ab723,_0x5c9004={'packageId':_0x126269,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0xb9ea73(0xe8)](_0x5c9004,count);}if(!_0x126269){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2226e9;if([model3Count,model4Count,drawMjCount][_0xb9ea73(0x13b)](_0x210bf3=>!_0x210bf3))throw new common_1[(_0xb9ea73(0xfa))](_0xb9ea73(0x125),common_1['HttpStatus'][_0xb9ea73(0xfd)]);const _0x59e400={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this['generateCrami'](_0x59e400,count);}}async[_0x1f2c71(0xe8)](_0xe7b6a7,_0x4b085b){const _0x1b7d99=_0x1f2c71,_0x3196ae=[];for(let _0x4b0522=0x0;_0x4b0522<_0x4b085b;_0x4b0522++){const _0x1f8136=(0x0,utils_1[_0x1b7d99(0x13f)])(),_0x58182d=this[_0x1b7d99(0xe9)][_0x1b7d99(0x11c)](Object[_0x1b7d99(0xea)](Object['assign']({},_0xe7b6a7),{'code':_0x1f8136}));_0x3196ae[_0x1b7d99(0xee)](_0x58182d);}return await this[_0x1b7d99(0xe9)][_0x1b7d99(0x133)](_0x3196ae);}async[_0x1f2c71(0x101)](_0x32614,_0x1228b5){const _0x78c5b0=_0x1f2c71,{id:_0x10991a}=_0x32614[_0x78c5b0(0x12c)],_0x57b68c=await this[_0x78c5b0(0xe9)][_0x78c5b0(0x13a)]({'where':{'code':_0x1228b5[_0x78c5b0(0x11b)]}});if(!_0x57b68c)throw new common_1[(_0x78c5b0(0xfa))](_0x78c5b0(0x130),common_1['HttpStatus'][_0x78c5b0(0xfd)]);const {status:_0x58c69f,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x140d49}=_0x57b68c;if(_0x58c69f===0x1)throw new common_1['HttpException'](_0x78c5b0(0x105),common_1['HttpStatus'][_0x78c5b0(0xfd)]);const _0x76f541={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x140d49};return await this[_0x78c5b0(0xeb)][_0x78c5b0(0x102)](_0x10991a,Object[_0x78c5b0(0xea)]({},_0x76f541),days),await this[_0x78c5b0(0xeb)]['saveRecordRechargeLog']({'userId':_0x10991a,'rechargeType':balance_constant_1['RechargeType'][_0x78c5b0(0x10e)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this['cramiEntity'][_0x78c5b0(0x12a)]({'code':_0x1228b5[_0x78c5b0(0x11b)]},{'useId':_0x10991a,'status':0x1}),_0x78c5b0(0x126);}async[_0x1f2c71(0x123)](_0x1c15a2,_0x559f0e){const _0x1e2940=_0x1f2c71,{page:page=0x1,size:size=0xa,status:_0x33cf24,useId:_0x3826ea}=_0x1c15a2,_0x3a8138={};_0x33cf24&&Object[_0x1e2940(0xea)](_0x3a8138,{'status':_0x33cf24}),_0x3826ea&&Object[_0x1e2940(0xea)](_0x3a8138,{'useId':_0x3826ea});const [_0x41f58b,_0x3e6050]=await this['cramiEntity'][_0x1e2940(0x10a)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':'DESC'},'where':_0x3a8138}),_0x1fafbc=_0x41f58b['map'](_0x481a4a=>_0x481a4a[_0x1e2940(0x116)]),_0x1c45da=_0x41f58b[_0x1e2940(0x13e)](_0x2f8a4c=>_0x2f8a4c[_0x1e2940(0x112)]),_0x40fbc9=await this[_0x1e2940(0x135)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x1fafbc)}}),_0x4be5b5=await this['cramiPackageEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x1c45da)}});return _0x41f58b[_0x1e2940(0x124)](_0x502ca8=>{const _0x1b5b24=_0x1e2940;var _0x2874b0,_0x5cc7ea,_0x2a5b5b;_0x502ca8['username']=(_0x2874b0=_0x40fbc9[_0x1b5b24(0x139)](_0x195696=>_0x195696['id']===_0x502ca8[_0x1b5b24(0x116)]))===null||_0x2874b0===void 0x0?void 0x0:_0x2874b0[_0x1b5b24(0x140)],_0x502ca8[_0x1b5b24(0x10d)]=(_0x5cc7ea=_0x40fbc9[_0x1b5b24(0x139)](_0x43d23c=>_0x43d23c['id']===_0x502ca8[_0x1b5b24(0x116)]))===null||_0x5cc7ea===void 0x0?void 0x0:_0x5cc7ea[_0x1b5b24(0x10d)],_0x502ca8[_0x1b5b24(0xf1)]=(_0x2a5b5b=_0x4be5b5[_0x1b5b24(0x139)](_0x1ee4b4=>_0x1ee4b4['id']===_0x502ca8['packageId']))===null||_0x2a5b5b===void 0x0?void 0x0:_0x2a5b5b[_0x1b5b24(0x129)];}),_0x559f0e[_0x1e2940(0x12c)][_0x1e2940(0x12b)]!==_0x1e2940(0x108)&&_0x41f58b[_0x1e2940(0x124)](_0x469b9b=>_0x469b9b['email']=(0x0,utils_1['maskEmail'])(_0x469b9b['email'])),_0x559f0e['user'][_0x1e2940(0x12b)]!==_0x1e2940(0x108)&&_0x41f58b[_0x1e2940(0x124)](_0x33cbd3=>_0x33cbd3[_0x1e2940(0x11b)]=(0x0,utils_1[_0x1e2940(0x12d)])(_0x33cbd3[_0x1e2940(0x11b)])),{'rows':_0x41f58b,'count':_0x3e6050};}async[_0x1f2c71(0xe5)](_0x563c5e){const _0x468cbb=_0x1f2c71,_0x49305a=await this['cramiEntity'][_0x468cbb(0x13a)]({'where':{'id':_0x563c5e}});if(!_0x49305a)throw new common_1['HttpException'](_0x468cbb(0xfe),common_1[_0x468cbb(0x11f)][_0x468cbb(0xfd)]);if(_0x49305a['status']===0x1)throw new common_1[(_0x468cbb(0xfa))]('当前卡密已被使用、已使用的卡密禁止删除！',common_1[_0x468cbb(0x11f)][_0x468cbb(0xfd)]);return await this[_0x468cbb(0xe9)][_0x468cbb(0x138)]({'id':_0x563c5e});}async[_0x1f2c71(0x106)](_0x24118d){const _0x9fd6b7=_0x1f2c71,{ids:_0x2d259d}=_0x24118d,_0x473440=await this['cramiEntity'][_0x9fd6b7(0x138)](_0x2d259d);if(_0x473440[_0x9fd6b7(0x104)]>0x0)return _0x9fd6b7(0x109);else throw new common_1[(_0x9fd6b7(0xfa))](_0x9fd6b7(0x13d),common_1[_0x9fd6b7(0x11f)][_0x9fd6b7(0xfd)]);}};CramiService=__decorate([(0x0,common_1[_0x1f2c71(0x121)])(),__param(0x0,(0x0,typeorm_1[_0x1f2c71(0xf2)])(crami_entity_1['CramiEntity'])),__param(0x1,(0x0,typeorm_1[_0x1f2c71(0xf2)])(cramiPackage_entity_1[_0x1f2c71(0x115)])),__param(0x2,(0x0,typeorm_1[_0x1f2c71(0xf2)])(user_entity_1[_0x1f2c71(0x11a)])),__metadata(_0x1f2c71(0xfb),[typeorm_2[_0x1f2c71(0x13c)],typeorm_2[_0x1f2c71(0x13c)],typeorm_2['Repository'],userBalance_service_1['UserBalanceService']])],CramiService),exports[_0x1f2c71(0x107)]=CramiService;