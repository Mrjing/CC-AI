'use strict';const _0x564e9b=_0x11ed;(function(_0x4a7c3c,_0xd3a5f1){const _0x3faaf6=_0x11ed,_0x57bdf0=_0x4a7c3c();while(!![]){try{const _0x49c70c=parseInt(_0x3faaf6(0xab))/0x1+parseInt(_0x3faaf6(0xa0))/0x2*(-parseInt(_0x3faaf6(0x96))/0x3)+-parseInt(_0x3faaf6(0xb4))/0x4*(-parseInt(_0x3faaf6(0xa8))/0x5)+-parseInt(_0x3faaf6(0xa2))/0x6*(parseInt(_0x3faaf6(0x8a))/0x7)+parseInt(_0x3faaf6(0xb8))/0x8+parseInt(_0x3faaf6(0xd3))/0x9+-parseInt(_0x3faaf6(0x94))/0xa;if(_0x49c70c===_0xd3a5f1)break;else _0x57bdf0['push'](_0x57bdf0['shift']());}catch(_0x316ba8){_0x57bdf0['push'](_0x57bdf0['shift']());}}}(_0x4649,0x44422));var __decorate=this&&this[_0x564e9b(0x87)]||function(_0x205b52,_0x4ce149,_0x3d66b7,_0xc68a1e){const _0x215bbc=_0x564e9b;var _0xecfd1c=arguments[_0x215bbc(0xbb)],_0x316e9a=_0xecfd1c<0x3?_0x4ce149:_0xc68a1e===null?_0xc68a1e=Object[_0x215bbc(0xa5)](_0x4ce149,_0x3d66b7):_0xc68a1e,_0x4490fc;if(typeof Reflect===_0x215bbc(0xda)&&typeof Reflect[_0x215bbc(0x91)]===_0x215bbc(0x9e))_0x316e9a=Reflect['decorate'](_0x205b52,_0x4ce149,_0x3d66b7,_0xc68a1e);else{for(var _0x7369bd=_0x205b52[_0x215bbc(0xbb)]-0x1;_0x7369bd>=0x0;_0x7369bd--)if(_0x4490fc=_0x205b52[_0x7369bd])_0x316e9a=(_0xecfd1c<0x3?_0x4490fc(_0x316e9a):_0xecfd1c>0x3?_0x4490fc(_0x4ce149,_0x3d66b7,_0x316e9a):_0x4490fc(_0x4ce149,_0x3d66b7))||_0x316e9a;}return _0xecfd1c>0x3&&_0x316e9a&&Object[_0x215bbc(0xa9)](_0x4ce149,_0x3d66b7,_0x316e9a),_0x316e9a;},__metadata=this&&this[_0x564e9b(0x8e)]||function(_0xbe8028,_0x96e917){const _0x3e595e=_0x564e9b;if(typeof Reflect==='object'&&typeof Reflect[_0x3e595e(0xc6)]===_0x3e595e(0x9e))return Reflect[_0x3e595e(0xc6)](_0xbe8028,_0x96e917);},__param=this&&this[_0x564e9b(0xdd)]||function(_0x22c583,_0x54c974){return function(_0x3cbc12,_0x2f4bd7){_0x54c974(_0x3cbc12,_0x2f4bd7,_0x22c583);};};Object[_0x564e9b(0xa9)](exports,'__esModule',{'value':!![]}),exports[_0x564e9b(0xc5)]=void 0x0;const common_1=require(_0x564e9b(0x8b)),crami_entity_1=require('./crami.entity'),typeorm_1=require(_0x564e9b(0xb3)),typeorm_2=require('typeorm'),cramiPackage_entity_1=require(_0x564e9b(0x92)),utils_1=require('../../common/utils'),user_entity_1=require(_0x564e9b(0xb7)),userBalance_service_1=require(_0x564e9b(0xaa)),balance_constant_1=require(_0x564e9b(0xa6));function _0x4649(){const _0x4feadd=['log','__decorate','createCrami','every','7dciksZ','@nestjs/common','当前套餐不存在、请检查你的输入参数！','InjectRepository','__metadata','套餐名称或套餐等级重复、请检查！','更新套餐成功！','decorate','./cramiPackage.entity','cramiEntity','4094560LsplFr','affected','3EQjTFR','createPackage','save','Injectable','当前套餐不存在、请确认您选择的套餐是否存在！','delCrami','status','find','function','role','578646gRibcd','BAD_REQUEST','2773146RGHeWV','DESC','PACKAGE_GIFT','getOwnPropertyDescriptor','../../common/constants/balance.constant','delPackage','5GvCIXs','defineProperty','../userBalance/userBalance.service','168577lmZHHo','create','update','assign','packageName','MoreThan','当前卡密已被使用、请确认您输入的卡密是否正确！','Not','@nestjs/typeorm','1016376dIGUGv','userEntity','当前卡密不存在、请确认您要删除的卡密是否存在！','../user/user.entity','4164856AhKfrQ','当前卡密不存在、请确认您输入的卡密是否正确！','design:paramtypes','length','HttpException','email','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','RechargeType','maskEmail','generateCrami','删除卡密成功！','super','packageId','CramiService','metadata','更新套餐失败、请重试！','updatePackage','saveRecordRechargeLog','username','generateCramiCode','LessThanOrEqual','user','map','Like','name','forEach','queryOnePackage','4475502fgDlNs','UserBalanceService','count','findOne','userBalanceService','push','Repository','object','HttpStatus','queryAllPackage','__param','batchDelCrami','使用卡密成功','code','findAndCount','delete','useId','cramiPackageEntity','maskCrami','error:\x20','CramiEntity'];_0x4649=function(){return _0x4feadd;};return _0x4649();}let CramiService=class CramiService{constructor(_0x3df9d8,_0x4c94e0,_0x4c173d,_0x52c748){const _0x162ed8=_0x564e9b;this['cramiEntity']=_0x3df9d8,this[_0x162ed8(0x82)]=_0x4c94e0,this[_0x162ed8(0xb5)]=_0x4c173d,this[_0x162ed8(0xd7)]=_0x52c748;}async[_0x564e9b(0xd2)](_0x3f0e00){const _0x3032d3=_0x564e9b;return await this[_0x3032d3(0x82)]['findOne']({'where':{'id':_0x3f0e00}});}async[_0x564e9b(0xdc)](_0x3f9d6d){const _0x1afa3=_0x564e9b;try{const {page:page=0x1,size:size=0xa,name:_0x12d08b,status:_0x35059c,type:_0x4af584}=_0x3f9d6d,_0xa55bc7={};_0x12d08b&&Object[_0x1afa3(0xae)](_0xa55bc7,{'name':(0x0,typeorm_2[_0x1afa3(0xcf)])('%'+_0x12d08b+'%')}),_0x35059c&&Object[_0x1afa3(0xae)](_0xa55bc7,{'status':_0x35059c});_0x4af584&&(_0x4af584>0x0?Object['assign'](_0xa55bc7,{'days':(0x0,typeorm_2[_0x1afa3(0xb0)])(0x0)}):Object[_0x1afa3(0xae)](_0xa55bc7,{'days':(0x0,typeorm_2[_0x1afa3(0xcc)])(0x0)}));const [_0xafae3d,_0x38ac0f]=await this[_0x1afa3(0x82)][_0x1afa3(0x7f)]({'skip':(page-0x1)*size,'take':size,'where':_0xa55bc7,'order':{'order':_0x1afa3(0xa3)}});return{'rows':_0xafae3d,'count':_0x38ac0f};}catch(_0x4e502f){console[_0x1afa3(0x86)](_0x1afa3(0x84),_0x4e502f);}}async[_0x564e9b(0x97)](_0x3224cf){const _0x3a1480=_0x564e9b,{name:_0x7f773,weight:_0x269f31}=_0x3224cf,_0x6b4295=await this[_0x3a1480(0x82)]['findOne']({'where':[{'name':_0x7f773},{'weight':_0x269f31}]});if(_0x6b4295)throw new common_1[(_0x3a1480(0xbc))](_0x3a1480(0x8f),common_1[_0x3a1480(0xdb)][_0x3a1480(0xa1)]);try{return await this[_0x3a1480(0x82)][_0x3a1480(0x98)](_0x3224cf);}catch(_0x47d939){console[_0x3a1480(0x86)](_0x3a1480(0x84),_0x47d939);throw new common_1[(_0x3a1480(0xbc))](_0x47d939,common_1[_0x3a1480(0xdb)][_0x3a1480(0xa1)]);}}async[_0x564e9b(0xc8)](_0x59b16f){const _0x5d934b=_0x564e9b,{id:_0x2ebb10,name:_0xc7f26d,weight:_0x44ea70}=_0x59b16f,_0x55a3ca=await this[_0x5d934b(0x82)][_0x5d934b(0xd6)]({'where':{'id':_0x2ebb10}});if(!_0x55a3ca)throw new common_1[(_0x5d934b(0xbc))](_0x5d934b(0x8c),common_1['HttpStatus'][_0x5d934b(0xa1)]);const _0x1b67e4=await this['cramiPackageEntity'][_0x5d934b(0xd5)]({'where':[{'name':_0xc7f26d,'id':(0x0,typeorm_2[_0x5d934b(0xb2)])(_0x2ebb10)},{'weight':_0x44ea70,'id':(0x0,typeorm_2[_0x5d934b(0xb2)])(_0x2ebb10)}]});if(_0x1b67e4)throw new common_1['HttpException'](_0x5d934b(0x8f),common_1[_0x5d934b(0xdb)][_0x5d934b(0xa1)]);const _0x1243f2=await this['cramiPackageEntity']['update']({'id':_0x2ebb10},_0x59b16f);if(_0x1243f2[_0x5d934b(0x95)]>0x0)return _0x5d934b(0x90);else throw new common_1[(_0x5d934b(0xbc))](_0x5d934b(0xc7),common_1[_0x5d934b(0xdb)][_0x5d934b(0xa1)]);}async[_0x564e9b(0xa7)](_0xfeeffa){const _0x1dab45=_0x564e9b,{id:_0x5e5f63}=_0xfeeffa,_0x546b8f=await this[_0x1dab45(0x93)][_0x1dab45(0xd5)]({'where':{'packageId':_0x5e5f63}});if(_0x546b8f)throw new common_1[(_0x1dab45(0xbc))](_0x1dab45(0xbe),common_1[_0x1dab45(0xdb)][_0x1dab45(0xa1)]);return await this[_0x1dab45(0x82)][_0x1dab45(0x80)]({'id':_0x5e5f63});}async[_0x564e9b(0x88)](_0x1a24dc){const _0x2c41ee=_0x564e9b,{packageId:_0x421cd5,count:count=0x1}=_0x1a24dc;if(_0x421cd5){const _0x126e42=await this[_0x2c41ee(0x82)]['findOne']({'where':{'id':_0x421cd5}});if(!_0x126e42)throw new common_1[(_0x2c41ee(0xbc))](_0x2c41ee(0x9a),common_1[_0x2c41ee(0xdb)]['BAD_REQUEST']);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x126e42,_0x5ebdd0={'packageId':_0x421cd5,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this['generateCrami'](_0x5ebdd0,count);}if(!_0x421cd5){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x1a24dc;if([model3Count,model4Count,drawMjCount][_0x2c41ee(0x89)](_0x313dc9=>!_0x313dc9))throw new common_1[(_0x2c41ee(0xbc))]('自定义卡密必须至少一项余额不为0️零！',common_1[_0x2c41ee(0xdb)][_0x2c41ee(0xa1)]);const _0x12679f={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x2c41ee(0xc1)](_0x12679f,count);}}async['generateCrami'](_0x4e58bf,_0x32c00b){const _0x4b7c44=_0x564e9b,_0x46c809=[];for(let _0x36afd0=0x0;_0x36afd0<_0x32c00b;_0x36afd0++){const _0x38f6bd=(0x0,utils_1[_0x4b7c44(0xcb)])(),_0x5d9e0b=this['cramiEntity'][_0x4b7c44(0xac)](Object[_0x4b7c44(0xae)](Object[_0x4b7c44(0xae)]({},_0x4e58bf),{'code':_0x38f6bd}));_0x46c809[_0x4b7c44(0xd8)](_0x5d9e0b);}return await this[_0x4b7c44(0x93)][_0x4b7c44(0x98)](_0x46c809);}async['useCrami'](_0x9814dd,_0x16e251){const _0x208293=_0x564e9b,{id:_0x506891}=_0x9814dd['user'],_0x18424b=await this[_0x208293(0x93)][_0x208293(0xd6)]({'where':{'code':_0x16e251[_0x208293(0x7e)]}});if(!_0x18424b)throw new common_1[(_0x208293(0xbc))](_0x208293(0xb9),common_1[_0x208293(0xdb)][_0x208293(0xa1)]);const {status:_0x26cbb3,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x235a3d}=_0x18424b;if(_0x26cbb3===0x1)throw new common_1[(_0x208293(0xbc))](_0x208293(0xb1),common_1[_0x208293(0xdb)][_0x208293(0xa1)]);const _0x28fa1e={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x235a3d};return await this['userBalanceService']['addBalanceToUser'](_0x506891,Object['assign']({},_0x28fa1e),days),await this[_0x208293(0xd7)][_0x208293(0xc9)]({'userId':_0x506891,'rechargeType':balance_constant_1[_0x208293(0xbf)][_0x208293(0xa4)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this[_0x208293(0x93)][_0x208293(0xad)]({'code':_0x16e251['code']},{'useId':_0x506891,'status':0x1}),_0x208293(0xdf);}async['queryAllCrami'](_0x2f2c04,_0x51f0ad){const _0x129698=_0x564e9b,{page:page=0x1,size:size=0xa,status:_0x3ce11c,useId:_0x2cf47e}=_0x2f2c04,_0x550190={};_0x3ce11c&&Object[_0x129698(0xae)](_0x550190,{'status':_0x3ce11c}),_0x2cf47e&&Object[_0x129698(0xae)](_0x550190,{'useId':_0x2cf47e});const [_0x5937e8,_0x5e6031]=await this[_0x129698(0x93)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':_0x129698(0xa3)},'where':_0x550190}),_0x34a436=_0x5937e8[_0x129698(0xce)](_0x5447de=>_0x5447de[_0x129698(0x81)]),_0x5ab60b=_0x5937e8[_0x129698(0xce)](_0x5b1503=>_0x5b1503['packageId']),_0x18177a=await this['userEntity'][_0x129698(0x9d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x34a436)}}),_0x4eb6c4=await this['cramiPackageEntity'][_0x129698(0x9d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5ab60b)}});return _0x5937e8[_0x129698(0xd1)](_0x5e727e=>{const _0x3725db=_0x129698;var _0x2f5f77,_0x3d7dc7,_0x35753b;_0x5e727e[_0x3725db(0xca)]=(_0x2f5f77=_0x18177a[_0x3725db(0x9d)](_0x197dec=>_0x197dec['id']===_0x5e727e[_0x3725db(0x81)]))===null||_0x2f5f77===void 0x0?void 0x0:_0x2f5f77[_0x3725db(0xca)],_0x5e727e[_0x3725db(0xbd)]=(_0x3d7dc7=_0x18177a[_0x3725db(0x9d)](_0x3d0d08=>_0x3d0d08['id']===_0x5e727e['useId']))===null||_0x3d7dc7===void 0x0?void 0x0:_0x3d7dc7[_0x3725db(0xbd)],_0x5e727e[_0x3725db(0xaf)]=(_0x35753b=_0x4eb6c4[_0x3725db(0x9d)](_0x46ba2e=>_0x46ba2e['id']===_0x5e727e[_0x3725db(0xc4)]))===null||_0x35753b===void 0x0?void 0x0:_0x35753b[_0x3725db(0xd0)];}),_0x51f0ad[_0x129698(0xcd)]['role']!=='super'&&_0x5937e8[_0x129698(0xd1)](_0x308155=>_0x308155[_0x129698(0xbd)]=(0x0,utils_1[_0x129698(0xc0)])(_0x308155[_0x129698(0xbd)])),_0x51f0ad[_0x129698(0xcd)][_0x129698(0x9f)]!==_0x129698(0xc3)&&_0x5937e8[_0x129698(0xd1)](_0x5ffecd=>_0x5ffecd[_0x129698(0x7e)]=(0x0,utils_1[_0x129698(0x83)])(_0x5ffecd[_0x129698(0x7e)])),{'rows':_0x5937e8,'count':_0x5e6031};}async[_0x564e9b(0x9b)](_0x4b12a3){const _0x2cfd0f=_0x564e9b,_0x26b13f=await this['cramiEntity']['findOne']({'where':{'id':_0x4b12a3}});if(!_0x26b13f)throw new common_1[(_0x2cfd0f(0xbc))](_0x2cfd0f(0xb6),common_1[_0x2cfd0f(0xdb)][_0x2cfd0f(0xa1)]);if(_0x26b13f[_0x2cfd0f(0x9c)]===0x1)throw new common_1[(_0x2cfd0f(0xbc))]('当前卡密已被使用、已使用的卡密禁止删除！',common_1['HttpStatus']['BAD_REQUEST']);return await this[_0x2cfd0f(0x93)][_0x2cfd0f(0x80)]({'id':_0x4b12a3});}async[_0x564e9b(0xde)](_0x5a8457){const _0x48de17=_0x564e9b,{ids:_0xfb9821}=_0x5a8457,_0xfaa6fa=await this[_0x48de17(0x93)][_0x48de17(0x80)](_0xfb9821);if(_0xfaa6fa[_0x48de17(0x95)]>0x0)return _0x48de17(0xc2);else throw new common_1[(_0x48de17(0xbc))]('删除卡密失败、请重试！',common_1[_0x48de17(0xdb)]['BAD_REQUEST']);}};function _0x11ed(_0x2900ba,_0x4c85da){const _0x4649c3=_0x4649();return _0x11ed=function(_0x11eddf,_0x3d3d9d){_0x11eddf=_0x11eddf-0x7e;let _0x362ae6=_0x4649c3[_0x11eddf];return _0x362ae6;},_0x11ed(_0x2900ba,_0x4c85da);}CramiService=__decorate([(0x0,common_1[_0x564e9b(0x99)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(crami_entity_1[_0x564e9b(0x85)])),__param(0x1,(0x0,typeorm_1[_0x564e9b(0x8d)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__metadata(_0x564e9b(0xba),[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x564e9b(0xd9)],userBalance_service_1[_0x564e9b(0xd4)]])],CramiService),exports['CramiService']=CramiService;