'use strict';const _0x534063=_0x4d45;function _0x1638(){const _0x1fac32=['47718820DKbZOi','object','packageName','MoreThan','username','update','generateCramiCode','create','userEntity','useId','email','maskEmail','使用卡密成功','find','userBalanceService','createCrami','4319256QNSiyc','createPackage','更新套餐成功！','当前套餐不存在、请检查你的输入参数！','HttpStatus','defineProperty','../../common/utils','length','name','当前卡密不存在、请确认您要删除的卡密是否存在！','generateCrami','delCrami','code','6568JhuPcs','__metadata','status','CramiEntity','UserBalanceService','DESC','maskCrami','queryOnePackage','forEach','5653554TVYEcx','Repository','自定义卡密必须至少一项余额不为0️零！','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','InjectRepository','cramiPackageEntity','cramiEntity','function','findAndCount','findOne','518ApaatI','log','batchDelCrami','更新套餐失败、请重试！','PACKAGE_GIFT','37576hBTfoX','metadata','CramiService','count','96eOhWnK','getOwnPropertyDescriptor','save','packageId','error:\x20','@nestjs/common','当前套餐不存在、请确认您选择的套餐是否存在！','affected','super','删除卡密成功！','20605kdMBDf','delete','BAD_REQUEST','当前卡密不存在、请确认您输入的卡密是否正确！','role','typeorm','queryAllPackage','assign','every','saveRecordRechargeLog','__param','push','queryAllCrami','../../common/constants/balance.constant','当前卡密已被使用、已使用的卡密禁止删除！','Not','decorate','RechargeType','LessThanOrEqual','套餐名称或套餐等级重复、请检查！','user','Injectable','CramiPackageEntity','14938875RIyqGg','3395ClAgKI','HttpException','addBalanceToUser'];_0x1638=function(){return _0x1fac32;};return _0x1638();}(function(_0xea3e6f,_0xad0905){const _0x42192a=_0x4d45,_0x19f63e=_0xea3e6f();while(!![]){try{const _0x2c4e68=-parseInt(_0x42192a(0x190))/0x1*(parseInt(_0x42192a(0x186))/0x2)+-parseInt(_0x42192a(0x1d1))/0x3+parseInt(_0x42192a(0x1c8))/0x4*(parseInt(_0x42192a(0x1a8))/0x5)+-parseInt(_0x42192a(0x1bb))/0x6+-parseInt(_0x42192a(0x17d))/0x7*(-parseInt(_0x42192a(0x182))/0x8)+-parseInt(_0x42192a(0x1a7))/0x9+parseInt(_0x42192a(0x1ab))/0xa;if(_0x2c4e68===_0xad0905)break;else _0x19f63e['push'](_0x19f63e['shift']());}catch(_0x1e03a5){_0x19f63e['push'](_0x19f63e['shift']());}}}(_0x1638,0xef84d));var __decorate=this&&this['__decorate']||function(_0x21f811,_0x476b0f,_0x2a6fc8,_0x1f255c){const _0xe23f14=_0x4d45;var _0x53c483=arguments['length'],_0x51b42d=_0x53c483<0x3?_0x476b0f:_0x1f255c===null?_0x1f255c=Object[_0xe23f14(0x187)](_0x476b0f,_0x2a6fc8):_0x1f255c,_0x2117fa;if(typeof Reflect===_0xe23f14(0x1ac)&&typeof Reflect[_0xe23f14(0x1a0)]===_0xe23f14(0x17a))_0x51b42d=Reflect[_0xe23f14(0x1a0)](_0x21f811,_0x476b0f,_0x2a6fc8,_0x1f255c);else{for(var _0x4c0275=_0x21f811[_0xe23f14(0x1c2)]-0x1;_0x4c0275>=0x0;_0x4c0275--)if(_0x2117fa=_0x21f811[_0x4c0275])_0x51b42d=(_0x53c483<0x3?_0x2117fa(_0x51b42d):_0x53c483>0x3?_0x2117fa(_0x476b0f,_0x2a6fc8,_0x51b42d):_0x2117fa(_0x476b0f,_0x2a6fc8))||_0x51b42d;}return _0x53c483>0x3&&_0x51b42d&&Object[_0xe23f14(0x1c0)](_0x476b0f,_0x2a6fc8,_0x51b42d),_0x51b42d;},__metadata=this&&this[_0x534063(0x1c9)]||function(_0x16b06e,_0x1802c2){const _0x3e43b9=_0x534063;if(typeof Reflect==='object'&&typeof Reflect[_0x3e43b9(0x183)]===_0x3e43b9(0x17a))return Reflect[_0x3e43b9(0x183)](_0x16b06e,_0x1802c2);},__param=this&&this[_0x534063(0x19a)]||function(_0x3069cf,_0x260bdb){return function(_0x59d4ca,_0x3939d5){_0x260bdb(_0x59d4ca,_0x3939d5,_0x3069cf);};};Object[_0x534063(0x1c0)](exports,'__esModule',{'value':!![]}),exports[_0x534063(0x184)]=void 0x0;function _0x4d45(_0x1d83aa,_0x400fbc){const _0x16380d=_0x1638();return _0x4d45=function(_0x4d4555,_0x595eb2){_0x4d4555=_0x4d4555-0x175;let _0x2bb844=_0x16380d[_0x4d4555];return _0x2bb844;},_0x4d45(_0x1d83aa,_0x400fbc);}const common_1=require(_0x534063(0x18b)),crami_entity_1=require('./crami.entity'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x534063(0x195)),cramiPackage_entity_1=require('./cramiPackage.entity'),utils_1=require(_0x534063(0x1c1)),user_entity_1=require('../user/user.entity'),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require(_0x534063(0x19d));let CramiService=class CramiService{constructor(_0x5b71e9,_0x4959a0,_0x3db425,_0x27ff15){const _0x141e96=_0x534063;this[_0x141e96(0x179)]=_0x5b71e9,this[_0x141e96(0x178)]=_0x4959a0,this[_0x141e96(0x1b3)]=_0x3db425,this[_0x141e96(0x1b9)]=_0x27ff15;}async[_0x534063(0x1cf)](_0x248cfc){const _0x423e3e=_0x534063;return await this['cramiPackageEntity'][_0x423e3e(0x17c)]({'where':{'id':_0x248cfc}});}async[_0x534063(0x196)](_0xac8d42){const _0x3d60ad=_0x534063;try{const {page:page=0x1,size:size=0xa,name:_0x590bec,status:_0x558fc5,type:_0x2ba8ed}=_0xac8d42,_0x1f044a={};_0x590bec&&Object[_0x3d60ad(0x197)](_0x1f044a,{'name':(0x0,typeorm_2['Like'])('%'+_0x590bec+'%')}),_0x558fc5&&Object['assign'](_0x1f044a,{'status':_0x558fc5});_0x2ba8ed&&(_0x2ba8ed>0x0?Object[_0x3d60ad(0x197)](_0x1f044a,{'days':(0x0,typeorm_2[_0x3d60ad(0x1ae)])(0x0)}):Object[_0x3d60ad(0x197)](_0x1f044a,{'days':(0x0,typeorm_2[_0x3d60ad(0x1a2)])(0x0)}));const [_0x25f741,_0x254797]=await this[_0x3d60ad(0x178)][_0x3d60ad(0x17b)]({'skip':(page-0x1)*size,'take':size,'where':_0x1f044a,'order':{'order':_0x3d60ad(0x1cd)}});return{'rows':_0x25f741,'count':_0x254797};}catch(_0x31b639){console['log'](_0x3d60ad(0x18a),_0x31b639);}}async[_0x534063(0x1bc)](_0x10261f){const _0x14ad85=_0x534063,{name:_0x24a539,weight:_0x1b13e8}=_0x10261f,_0x43241b=await this['cramiPackageEntity'][_0x14ad85(0x17c)]({'where':[{'name':_0x24a539},{'weight':_0x1b13e8}]});if(_0x43241b)throw new common_1[(_0x14ad85(0x1a9))](_0x14ad85(0x1a3),common_1[_0x14ad85(0x1bf)][_0x14ad85(0x192)]);try{return await this[_0x14ad85(0x178)]['save'](_0x10261f);}catch(_0x539d5b){console[_0x14ad85(0x17e)]('error:\x20',_0x539d5b);throw new common_1[(_0x14ad85(0x1a9))](_0x539d5b,common_1['HttpStatus']['BAD_REQUEST']);}}async['updatePackage'](_0x53812b){const _0x570981=_0x534063,{id:_0x320fb0,name:_0x4e3318,weight:_0x928f68}=_0x53812b,_0x3a79b5=await this[_0x570981(0x178)][_0x570981(0x17c)]({'where':{'id':_0x320fb0}});if(!_0x3a79b5)throw new common_1[(_0x570981(0x1a9))](_0x570981(0x1be),common_1[_0x570981(0x1bf)]['BAD_REQUEST']);const _0x5026ec=await this[_0x570981(0x178)][_0x570981(0x185)]({'where':[{'name':_0x4e3318,'id':(0x0,typeorm_2['Not'])(_0x320fb0)},{'weight':_0x928f68,'id':(0x0,typeorm_2[_0x570981(0x19f)])(_0x320fb0)}]});if(_0x5026ec)throw new common_1[(_0x570981(0x1a9))]('套餐名称或套餐等级重复、请检查！',common_1[_0x570981(0x1bf)]['BAD_REQUEST']);const _0xe9ffe=await this['cramiPackageEntity'][_0x570981(0x1b0)]({'id':_0x320fb0},_0x53812b);if(_0xe9ffe[_0x570981(0x18d)]>0x0)return _0x570981(0x1bd);else throw new common_1[(_0x570981(0x1a9))](_0x570981(0x180),common_1[_0x570981(0x1bf)][_0x570981(0x192)]);}async['delPackage'](_0x460053){const _0x39e17e=_0x534063,{id:_0x2f8e15}=_0x460053,_0x1a42b5=await this[_0x39e17e(0x179)]['count']({'where':{'packageId':_0x2f8e15}});if(_0x1a42b5)throw new common_1['HttpException'](_0x39e17e(0x176),common_1[_0x39e17e(0x1bf)][_0x39e17e(0x192)]);return await this[_0x39e17e(0x178)]['delete']({'id':_0x2f8e15});}async[_0x534063(0x1ba)](_0x32b290){const _0x30fed3=_0x534063,{packageId:_0x3861a0,count:count=0x1}=_0x32b290;if(_0x3861a0){const _0x38ab21=await this[_0x30fed3(0x178)][_0x30fed3(0x17c)]({'where':{'id':_0x3861a0}});if(!_0x38ab21)throw new common_1[(_0x30fed3(0x1a9))](_0x30fed3(0x18c),common_1[_0x30fed3(0x1bf)][_0x30fed3(0x192)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x38ab21,_0x24dbc2={'packageId':_0x3861a0,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x30fed3(0x1c5)](_0x24dbc2,count);}if(!_0x3861a0){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x32b290;if([model3Count,model4Count,drawMjCount][_0x30fed3(0x198)](_0x580667=>!_0x580667))throw new common_1[(_0x30fed3(0x1a9))](_0x30fed3(0x175),common_1[_0x30fed3(0x1bf)][_0x30fed3(0x192)]);const _0x15b7e8={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x30fed3(0x1c5)](_0x15b7e8,count);}}async['generateCrami'](_0x1e8a87,_0x3871af){const _0x14e8c9=_0x534063,_0x7b17a5=[];for(let _0x5d894f=0x0;_0x5d894f<_0x3871af;_0x5d894f++){const _0x5d55fc=(0x0,utils_1[_0x14e8c9(0x1b1)])(),_0x5b69c5=this[_0x14e8c9(0x179)][_0x14e8c9(0x1b2)](Object['assign'](Object[_0x14e8c9(0x197)]({},_0x1e8a87),{'code':_0x5d55fc}));_0x7b17a5[_0x14e8c9(0x19b)](_0x5b69c5);}return await this[_0x14e8c9(0x179)][_0x14e8c9(0x188)](_0x7b17a5);}async['useCrami'](_0x3b6daf,_0x18bcd4){const _0x5dc317=_0x534063,{id:_0x3c488e}=_0x3b6daf[_0x5dc317(0x1a4)],_0x310ff6=await this[_0x5dc317(0x179)][_0x5dc317(0x17c)]({'where':{'code':_0x18bcd4[_0x5dc317(0x1c7)]}});if(!_0x310ff6)throw new common_1[(_0x5dc317(0x1a9))](_0x5dc317(0x193),common_1[_0x5dc317(0x1bf)][_0x5dc317(0x192)]);const {status:_0x3c5404,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x468d9e}=_0x310ff6;if(_0x3c5404===0x1)throw new common_1[(_0x5dc317(0x1a9))]('当前卡密已被使用、请确认您输入的卡密是否正确！',common_1[_0x5dc317(0x1bf)]['BAD_REQUEST']);const _0x1b718={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x468d9e};return await this['userBalanceService'][_0x5dc317(0x1aa)](_0x3c488e,Object[_0x5dc317(0x197)]({},_0x1b718),days),await this[_0x5dc317(0x1b9)][_0x5dc317(0x199)]({'userId':_0x3c488e,'rechargeType':balance_constant_1[_0x5dc317(0x1a1)][_0x5dc317(0x181)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this[_0x5dc317(0x179)]['update']({'code':_0x18bcd4[_0x5dc317(0x1c7)]},{'useId':_0x3c488e,'status':0x1}),_0x5dc317(0x1b7);}async[_0x534063(0x19c)](_0x295dd5,_0x15b06a){const _0x2ddeaa=_0x534063,{page:page=0x1,size:size=0xa,status:_0x36103b,useId:_0x29219e}=_0x295dd5,_0x50ce86={};_0x36103b&&Object[_0x2ddeaa(0x197)](_0x50ce86,{'status':_0x36103b}),_0x29219e&&Object['assign'](_0x50ce86,{'useId':_0x29219e});const [_0x333bda,_0x393189]=await this[_0x2ddeaa(0x179)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':_0x2ddeaa(0x1cd)},'where':_0x50ce86}),_0x4a0dfa=_0x333bda['map'](_0x54d7e2=>_0x54d7e2[_0x2ddeaa(0x1b4)]),_0xc045e=_0x333bda['map'](_0x55febc=>_0x55febc[_0x2ddeaa(0x189)]),_0x368b7d=await this['userEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x4a0dfa)}}),_0x35818e=await this['cramiPackageEntity'][_0x2ddeaa(0x1b8)]({'where':{'id':(0x0,typeorm_2['In'])(_0xc045e)}});return _0x333bda[_0x2ddeaa(0x1d0)](_0x106a1d=>{const _0x4559a6=_0x2ddeaa;var _0x31cfe9,_0x5d5b2b,_0x43aa0a;_0x106a1d[_0x4559a6(0x1af)]=(_0x31cfe9=_0x368b7d[_0x4559a6(0x1b8)](_0x3e1f0c=>_0x3e1f0c['id']===_0x106a1d[_0x4559a6(0x1b4)]))===null||_0x31cfe9===void 0x0?void 0x0:_0x31cfe9['username'],_0x106a1d[_0x4559a6(0x1b5)]=(_0x5d5b2b=_0x368b7d['find'](_0x8c4bee=>_0x8c4bee['id']===_0x106a1d[_0x4559a6(0x1b4)]))===null||_0x5d5b2b===void 0x0?void 0x0:_0x5d5b2b[_0x4559a6(0x1b5)],_0x106a1d[_0x4559a6(0x1ad)]=(_0x43aa0a=_0x35818e[_0x4559a6(0x1b8)](_0x79c8b1=>_0x79c8b1['id']===_0x106a1d[_0x4559a6(0x189)]))===null||_0x43aa0a===void 0x0?void 0x0:_0x43aa0a[_0x4559a6(0x1c3)];}),_0x15b06a[_0x2ddeaa(0x1a4)][_0x2ddeaa(0x194)]!==_0x2ddeaa(0x18e)&&_0x333bda[_0x2ddeaa(0x1d0)](_0x400237=>_0x400237[_0x2ddeaa(0x1b5)]=(0x0,utils_1[_0x2ddeaa(0x1b6)])(_0x400237[_0x2ddeaa(0x1b5)])),_0x15b06a['user'][_0x2ddeaa(0x194)]!==_0x2ddeaa(0x18e)&&_0x333bda[_0x2ddeaa(0x1d0)](_0x4799ea=>_0x4799ea[_0x2ddeaa(0x1c7)]=(0x0,utils_1[_0x2ddeaa(0x1ce)])(_0x4799ea[_0x2ddeaa(0x1c7)])),{'rows':_0x333bda,'count':_0x393189};}async[_0x534063(0x1c6)](_0x1ca0cc){const _0x1d8c0d=_0x534063,_0x38e886=await this[_0x1d8c0d(0x179)][_0x1d8c0d(0x17c)]({'where':{'id':_0x1ca0cc}});if(!_0x38e886)throw new common_1['HttpException'](_0x1d8c0d(0x1c4),common_1['HttpStatus']['BAD_REQUEST']);if(_0x38e886[_0x1d8c0d(0x1ca)]===0x1)throw new common_1[(_0x1d8c0d(0x1a9))](_0x1d8c0d(0x19e),common_1[_0x1d8c0d(0x1bf)][_0x1d8c0d(0x192)]);return await this['cramiEntity']['delete']({'id':_0x1ca0cc});}async[_0x534063(0x17f)](_0xdf3ea4){const _0x4cac49=_0x534063,{ids:_0x38a4ee}=_0xdf3ea4,_0x5287f4=await this[_0x4cac49(0x179)][_0x4cac49(0x191)](_0x38a4ee);if(_0x5287f4['affected']>0x0)return _0x4cac49(0x18f);else throw new common_1[(_0x4cac49(0x1a9))]('删除卡密失败、请重试！',common_1['HttpStatus'][_0x4cac49(0x192)]);}};CramiService=__decorate([(0x0,common_1[_0x534063(0x1a5)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(crami_entity_1[_0x534063(0x1cb)])),__param(0x1,(0x0,typeorm_1[_0x534063(0x177)])(cramiPackage_entity_1[_0x534063(0x1a6)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x534063(0x1d2)],typeorm_2[_0x534063(0x1d2)],userBalance_service_1[_0x534063(0x1cc)]])],CramiService),exports['CramiService']=CramiService;