'use strict';const _0x344a5a=_0x3f07;function _0x3f07(_0x532a39,_0x4b4d8d){const _0x24d644=_0x24d6();return _0x3f07=function(_0x3f07e5,_0x138afc){_0x3f07e5=_0x3f07e5-0x1dd;let _0x5e2a89=_0x24d644[_0x3f07e5];return _0x5e2a89;},_0x3f07(_0x532a39,_0x4b4d8d);}(function(_0x359855,_0x132cd6){const _0x1755b8=_0x3f07,_0x45bc02=_0x359855();while(!![]){try{const _0x5e0e38=parseInt(_0x1755b8(0x224))/0x1+parseInt(_0x1755b8(0x22c))/0x2+-parseInt(_0x1755b8(0x20a))/0x3+parseInt(_0x1755b8(0x217))/0x4+-parseInt(_0x1755b8(0x1f0))/0x5+-parseInt(_0x1755b8(0x1fd))/0x6*(-parseInt(_0x1755b8(0x212))/0x7)+-parseInt(_0x1755b8(0x237))/0x8*(parseInt(_0x1755b8(0x1fb))/0x9);if(_0x5e0e38===_0x132cd6)break;else _0x45bc02['push'](_0x45bc02['shift']());}catch(_0x49c4f0){_0x45bc02['push'](_0x45bc02['shift']());}}}(_0x24d6,0x6dad1));var __decorate=this&&this[_0x344a5a(0x1e8)]||function(_0x6fa36,_0x3b2c6d,_0x29dfcd,_0x1d0c8a){const _0x464001=_0x344a5a;var _0x403ed1=arguments[_0x464001(0x1e4)],_0x4d3eaa=_0x403ed1<0x3?_0x3b2c6d:_0x1d0c8a===null?_0x1d0c8a=Object[_0x464001(0x1f1)](_0x3b2c6d,_0x29dfcd):_0x1d0c8a,_0x4329ef;if(typeof Reflect===_0x464001(0x1e6)&&typeof Reflect[_0x464001(0x1ef)]===_0x464001(0x1e0))_0x4d3eaa=Reflect[_0x464001(0x1ef)](_0x6fa36,_0x3b2c6d,_0x29dfcd,_0x1d0c8a);else{for(var _0xaea3f1=_0x6fa36[_0x464001(0x1e4)]-0x1;_0xaea3f1>=0x0;_0xaea3f1--)if(_0x4329ef=_0x6fa36[_0xaea3f1])_0x4d3eaa=(_0x403ed1<0x3?_0x4329ef(_0x4d3eaa):_0x403ed1>0x3?_0x4329ef(_0x3b2c6d,_0x29dfcd,_0x4d3eaa):_0x4329ef(_0x3b2c6d,_0x29dfcd))||_0x4d3eaa;}return _0x403ed1>0x3&&_0x4d3eaa&&Object[_0x464001(0x207)](_0x3b2c6d,_0x29dfcd,_0x4d3eaa),_0x4d3eaa;},__metadata=this&&this['__metadata']||function(_0x1998d0,_0x421983){const _0x1d3dbc=_0x344a5a;if(typeof Reflect==='object'&&typeof Reflect[_0x1d3dbc(0x21d)]===_0x1d3dbc(0x1e0))return Reflect[_0x1d3dbc(0x21d)](_0x1998d0,_0x421983);},__param=this&&this['__param']||function(_0x54b20a,_0x2802a7){return function(_0x23ac12,_0x4b33e3){_0x2802a7(_0x23ac12,_0x4b33e3,_0x54b20a);};};Object[_0x344a5a(0x207)](exports,_0x344a5a(0x219),{'value':!![]}),exports[_0x344a5a(0x1f4)]=void 0x0;function _0x24d6(){const _0x18bbe6=['HttpException','findAndCount','save','generateCrami','packageName','role','@nestjs/common','当前套餐不存在、请检查你的输入参数！','BAD_REQUEST','2078936WtXPxh','name','assign','InjectRepository','error:\x20','count','update','function','batchDelCrami','super','generateCramiCode','length','PACKAGE_GIFT','object','code','__decorate','./crami.entity','Injectable','create','UserEntity','push','queryOnePackage','decorate','4434390TcqIQM','getOwnPropertyDescriptor','queryAllPackage','log','CramiService','map','Not','status','delCrami','findOne','delPackage','9TVZiUw','delete','68088APFyLu','userEntity','当前套餐不存在、请确认您选择的套餐是否存在！','typeorm','addBalanceToUser','删除卡密成功！','RechargeType','find','CramiPackageEntity','使用卡密成功','defineProperty','userBalanceService','affected','2071041jjufYL','username','删除卡密失败、请重试！','UserBalanceService','useCrami','email','当前卡密已被使用、已使用的卡密禁止删除！','createCrami','427vAgThm','useId','../../common/utils','更新套餐失败、请重试！','cramiPackageEntity','1690856svRJQW','CramiEntity','__esModule','当前卡密不存在、请确认您输入的卡密是否正确！','every','cramiEntity','metadata','DESC','forEach','LessThanOrEqual','packageId','Repository','../../common/constants/balance.constant','367186bDxhMB','../user/user.entity','Like','maskCrami','HttpStatus','../userBalance/userBalance.service','user','maskEmail','1608394GnlqpJ','@nestjs/typeorm'];_0x24d6=function(){return _0x18bbe6;};return _0x24d6();}const common_1=require(_0x344a5a(0x234)),crami_entity_1=require(_0x344a5a(0x1e9)),typeorm_1=require(_0x344a5a(0x22d)),typeorm_2=require(_0x344a5a(0x200)),cramiPackage_entity_1=require('./cramiPackage.entity'),utils_1=require(_0x344a5a(0x214)),user_entity_1=require(_0x344a5a(0x225)),userBalance_service_1=require(_0x344a5a(0x229)),balance_constant_1=require(_0x344a5a(0x223));let CramiService=class CramiService{constructor(_0x366b46,_0x550666,_0x1c30ef,_0x473b68){const _0x480367=_0x344a5a;this[_0x480367(0x21c)]=_0x366b46,this['cramiPackageEntity']=_0x550666,this[_0x480367(0x1fe)]=_0x1c30ef,this[_0x480367(0x208)]=_0x473b68;}async[_0x344a5a(0x1ee)](_0x271f38){const _0x5b062f=_0x344a5a;return await this[_0x5b062f(0x216)]['findOne']({'where':{'id':_0x271f38}});}async[_0x344a5a(0x1f2)](_0x4d0e25){const _0x2f6c1b=_0x344a5a;try{const {page:page=0x1,size:size=0xa,name:_0x2402b2,status:_0xd28450,type:_0x434fb5}=_0x4d0e25,_0x41da73={};_0x2402b2&&Object[_0x2f6c1b(0x239)](_0x41da73,{'name':(0x0,typeorm_2[_0x2f6c1b(0x226)])('%'+_0x2402b2+'%')}),_0xd28450&&Object[_0x2f6c1b(0x239)](_0x41da73,{'status':_0xd28450});_0x434fb5&&(_0x434fb5>0x0?Object['assign'](_0x41da73,{'days':(0x0,typeorm_2['MoreThan'])(0x0)}):Object[_0x2f6c1b(0x239)](_0x41da73,{'days':(0x0,typeorm_2[_0x2f6c1b(0x220)])(0x0)}));const [_0x2366bf,_0x51c502]=await this[_0x2f6c1b(0x216)][_0x2f6c1b(0x22f)]({'skip':(page-0x1)*size,'take':size,'where':_0x41da73,'order':{'order':_0x2f6c1b(0x21e)}});return{'rows':_0x2366bf,'count':_0x51c502};}catch(_0x460f9f){console[_0x2f6c1b(0x1f3)](_0x2f6c1b(0x1dd),_0x460f9f);}}async['createPackage'](_0x28aa6d){const _0x1e2d09=_0x344a5a,{name:_0x27606c,weight:_0x4a8bd8}=_0x28aa6d,_0x802d34=await this['cramiPackageEntity']['findOne']({'where':[{'name':_0x27606c},{'weight':_0x4a8bd8}]});if(_0x802d34)throw new common_1['HttpException']('套餐名称或套餐等级重复、请检查！',common_1['HttpStatus'][_0x1e2d09(0x236)]);try{return await this['cramiPackageEntity']['save'](_0x28aa6d);}catch(_0x545c89){console['log'](_0x1e2d09(0x1dd),_0x545c89);throw new common_1[(_0x1e2d09(0x22e))](_0x545c89,common_1[_0x1e2d09(0x228)][_0x1e2d09(0x236)]);}}async['updatePackage'](_0x2ca8d7){const _0x302f22=_0x344a5a,{id:_0x2e95d9,name:_0x3e2b69,weight:_0x355320}=_0x2ca8d7,_0x1a712f=await this[_0x302f22(0x216)]['findOne']({'where':{'id':_0x2e95d9}});if(!_0x1a712f)throw new common_1[(_0x302f22(0x22e))](_0x302f22(0x235),common_1['HttpStatus'][_0x302f22(0x236)]);const _0x2d9dd3=await this[_0x302f22(0x216)]['count']({'where':[{'name':_0x3e2b69,'id':(0x0,typeorm_2[_0x302f22(0x1f6)])(_0x2e95d9)},{'weight':_0x355320,'id':(0x0,typeorm_2[_0x302f22(0x1f6)])(_0x2e95d9)}]});if(_0x2d9dd3)throw new common_1[(_0x302f22(0x22e))]('套餐名称或套餐等级重复、请检查！',common_1['HttpStatus'][_0x302f22(0x236)]);const _0x3550bf=await this[_0x302f22(0x216)][_0x302f22(0x1df)]({'id':_0x2e95d9},_0x2ca8d7);if(_0x3550bf['affected']>0x0)return'更新套餐成功！';else throw new common_1[(_0x302f22(0x22e))](_0x302f22(0x215),common_1[_0x302f22(0x228)][_0x302f22(0x236)]);}async[_0x344a5a(0x1fa)](_0x3f7b8c){const _0x1c0ede=_0x344a5a,{id:_0x2bfcc2}=_0x3f7b8c,_0x5856f9=await this['cramiEntity'][_0x1c0ede(0x1de)]({'where':{'packageId':_0x2bfcc2}});if(_0x5856f9)throw new common_1[(_0x1c0ede(0x22e))]('当前套餐下存在卡密、请先删除卡密后才可删除套餐！',common_1[_0x1c0ede(0x228)]['BAD_REQUEST']);return await this['cramiPackageEntity'][_0x1c0ede(0x1fc)]({'id':_0x2bfcc2});}async[_0x344a5a(0x211)](_0x3fface){const _0x2c5cef=_0x344a5a,{packageId:_0x436abf,count:count=0x1}=_0x3fface;if(_0x436abf){const _0x3beb8e=await this['cramiPackageEntity'][_0x2c5cef(0x1f9)]({'where':{'id':_0x436abf}});if(!_0x3beb8e)throw new common_1[(_0x2c5cef(0x22e))](_0x2c5cef(0x1ff),common_1[_0x2c5cef(0x228)][_0x2c5cef(0x236)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3beb8e,_0x22f05f={'packageId':_0x436abf,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x2c5cef(0x231)](_0x22f05f,count);}if(!_0x436abf){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3fface;if([model3Count,model4Count,drawMjCount][_0x2c5cef(0x21b)](_0x2f831f=>!_0x2f831f))throw new common_1[(_0x2c5cef(0x22e))]('自定义卡密必须至少一项余额不为0️零！',common_1['HttpStatus'][_0x2c5cef(0x236)]);const _0x53382d={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x2c5cef(0x231)](_0x53382d,count);}}async[_0x344a5a(0x231)](_0x516794,_0x182d8d){const _0x364517=_0x344a5a,_0x50b440=[];for(let _0x202963=0x0;_0x202963<_0x182d8d;_0x202963++){const _0x451180=(0x0,utils_1[_0x364517(0x1e3)])(),_0x2fc102=this[_0x364517(0x21c)][_0x364517(0x1eb)](Object[_0x364517(0x239)](Object[_0x364517(0x239)]({},_0x516794),{'code':_0x451180}));_0x50b440[_0x364517(0x1ed)](_0x2fc102);}return await this['cramiEntity'][_0x364517(0x230)](_0x50b440);}async[_0x344a5a(0x20e)](_0x3d9dae,_0x4c8cf2){const _0x36a064=_0x344a5a,{id:_0x5a6978}=_0x3d9dae[_0x36a064(0x22a)],_0x2c2e5c=await this[_0x36a064(0x21c)][_0x36a064(0x1f9)]({'where':{'code':_0x4c8cf2[_0x36a064(0x1e7)]}});if(!_0x2c2e5c)throw new common_1['HttpException'](_0x36a064(0x21a),common_1['HttpStatus'][_0x36a064(0x236)]);const {status:_0x101989,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x44d672}=_0x2c2e5c;if(_0x101989===0x1)throw new common_1[(_0x36a064(0x22e))]('当前卡密已被使用、请确认您输入的卡密是否正确！',common_1['HttpStatus'][_0x36a064(0x236)]);const _0x4dc018={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x44d672};return await this[_0x36a064(0x208)][_0x36a064(0x201)](_0x5a6978,Object[_0x36a064(0x239)]({},_0x4dc018),days),await this[_0x36a064(0x208)]['saveRecordRechargeLog']({'userId':_0x5a6978,'rechargeType':balance_constant_1[_0x36a064(0x203)][_0x36a064(0x1e5)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this[_0x36a064(0x21c)][_0x36a064(0x1df)]({'code':_0x4c8cf2[_0x36a064(0x1e7)]},{'useId':_0x5a6978,'status':0x1}),_0x36a064(0x206);}async['queryAllCrami'](_0x35940d,_0xc14a3f){const _0x5eab1d=_0x344a5a,{page:page=0x1,size:size=0xa,status:_0x103f7b,useId:_0x401cdf}=_0x35940d,_0x418105={};_0x103f7b&&Object[_0x5eab1d(0x239)](_0x418105,{'status':_0x103f7b}),_0x401cdf&&Object[_0x5eab1d(0x239)](_0x418105,{'useId':_0x401cdf});const [_0x45809f,_0x1ddbf8]=await this[_0x5eab1d(0x21c)][_0x5eab1d(0x22f)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':_0x5eab1d(0x21e)},'where':_0x418105}),_0x3275e4=_0x45809f[_0x5eab1d(0x1f5)](_0x5f3f8d=>_0x5f3f8d[_0x5eab1d(0x213)]),_0x1a2aaf=_0x45809f[_0x5eab1d(0x1f5)](_0x2028dd=>_0x2028dd[_0x5eab1d(0x221)]),_0x44e127=await this[_0x5eab1d(0x1fe)][_0x5eab1d(0x204)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3275e4)}}),_0x5c7057=await this[_0x5eab1d(0x216)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x1a2aaf)}});return _0x45809f['forEach'](_0xf07ba8=>{const _0x9cec73=_0x5eab1d;var _0x319360,_0x3799b2,_0x1db5bd;_0xf07ba8[_0x9cec73(0x20b)]=(_0x319360=_0x44e127[_0x9cec73(0x204)](_0x52a5a5=>_0x52a5a5['id']===_0xf07ba8['useId']))===null||_0x319360===void 0x0?void 0x0:_0x319360[_0x9cec73(0x20b)],_0xf07ba8['email']=(_0x3799b2=_0x44e127[_0x9cec73(0x204)](_0x3058a1=>_0x3058a1['id']===_0xf07ba8['useId']))===null||_0x3799b2===void 0x0?void 0x0:_0x3799b2['email'],_0xf07ba8[_0x9cec73(0x232)]=(_0x1db5bd=_0x5c7057[_0x9cec73(0x204)](_0x4ff660=>_0x4ff660['id']===_0xf07ba8[_0x9cec73(0x221)]))===null||_0x1db5bd===void 0x0?void 0x0:_0x1db5bd[_0x9cec73(0x238)];}),_0xc14a3f['user'][_0x5eab1d(0x233)]!=='super'&&_0x45809f[_0x5eab1d(0x21f)](_0x1b5361=>_0x1b5361[_0x5eab1d(0x20f)]=(0x0,utils_1[_0x5eab1d(0x22b)])(_0x1b5361[_0x5eab1d(0x20f)])),_0xc14a3f[_0x5eab1d(0x22a)][_0x5eab1d(0x233)]!==_0x5eab1d(0x1e2)&&_0x45809f[_0x5eab1d(0x21f)](_0x23744a=>_0x23744a[_0x5eab1d(0x1e7)]=(0x0,utils_1[_0x5eab1d(0x227)])(_0x23744a['code'])),{'rows':_0x45809f,'count':_0x1ddbf8};}async[_0x344a5a(0x1f8)](_0x38c7da){const _0xaa6d26=_0x344a5a,_0x336b74=await this[_0xaa6d26(0x21c)][_0xaa6d26(0x1f9)]({'where':{'id':_0x38c7da}});if(!_0x336b74)throw new common_1[(_0xaa6d26(0x22e))]('当前卡密不存在、请确认您要删除的卡密是否存在！',common_1[_0xaa6d26(0x228)][_0xaa6d26(0x236)]);if(_0x336b74[_0xaa6d26(0x1f7)]===0x1)throw new common_1[(_0xaa6d26(0x22e))](_0xaa6d26(0x210),common_1[_0xaa6d26(0x228)][_0xaa6d26(0x236)]);return await this[_0xaa6d26(0x21c)][_0xaa6d26(0x1fc)]({'id':_0x38c7da});}async[_0x344a5a(0x1e1)](_0x34e6b1){const _0x24971c=_0x344a5a,{ids:_0x4eb9f9}=_0x34e6b1,_0x207d11=await this[_0x24971c(0x21c)][_0x24971c(0x1fc)](_0x4eb9f9);if(_0x207d11[_0x24971c(0x209)]>0x0)return _0x24971c(0x202);else throw new common_1['HttpException'](_0x24971c(0x20c),common_1[_0x24971c(0x228)]['BAD_REQUEST']);}};CramiService=__decorate([(0x0,common_1[_0x344a5a(0x1ea)])(),__param(0x0,(0x0,typeorm_1[_0x344a5a(0x23a)])(crami_entity_1[_0x344a5a(0x218)])),__param(0x1,(0x0,typeorm_1[_0x344a5a(0x23a)])(cramiPackage_entity_1[_0x344a5a(0x205)])),__param(0x2,(0x0,typeorm_1[_0x344a5a(0x23a)])(user_entity_1[_0x344a5a(0x1ec)])),__metadata('design:paramtypes',[typeorm_2[_0x344a5a(0x222)],typeorm_2[_0x344a5a(0x222)],typeorm_2['Repository'],userBalance_service_1[_0x344a5a(0x20d)]])],CramiService),exports[_0x344a5a(0x1f4)]=CramiService;