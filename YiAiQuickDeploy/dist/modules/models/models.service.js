'use strict';const _0xcde858=_0x12f3;(function(_0x301c87,_0x26d28e){const _0x1d55e1=_0x12f3,_0x5cd9a=_0x301c87();while(!![]){try{const _0xcc61b1=parseInt(_0x1d55e1(0x101))/0x1+-parseInt(_0x1d55e1(0xe0))/0x2*(-parseInt(_0x1d55e1(0xde))/0x3)+-parseInt(_0x1d55e1(0xf7))/0x4*(-parseInt(_0x1d55e1(0x10d))/0x5)+-parseInt(_0x1d55e1(0xfe))/0x6+parseInt(_0x1d55e1(0xcf))/0x7+parseInt(_0x1d55e1(0xec))/0x8+-parseInt(_0x1d55e1(0xf1))/0x9;if(_0xcc61b1===_0x26d28e)break;else _0x5cd9a['push'](_0x5cd9a['shift']());}catch(_0x3bb948){_0x5cd9a['push'](_0x5cd9a['shift']());}}}(_0x435d,0x570ca));function _0x12f3(_0x2e8b1e,_0x3ff96a){const _0x435dd5=_0x435d();return _0x12f3=function(_0x12f353,_0x4e37c8){_0x12f353=_0x12f353-0xb7;let _0x2894c9=_0x435dd5[_0x12f353];return _0x2894c9;},_0x12f3(_0x2e8b1e,_0x3ff96a);}var __decorate=this&&this[_0xcde858(0x104)]||function(_0xb8f26c,_0x2b0bdb,_0x5b0176,_0x2bceb2){const _0x2b7569=_0xcde858;var _0x594f99=arguments['length'],_0x1cd6f0=_0x594f99<0x3?_0x2b0bdb:_0x2bceb2===null?_0x2bceb2=Object[_0x2b7569(0x102)](_0x2b0bdb,_0x5b0176):_0x2bceb2,_0x298855;if(typeof Reflect===_0x2b7569(0xcd)&&typeof Reflect[_0x2b7569(0xdd)]==='function')_0x1cd6f0=Reflect[_0x2b7569(0xdd)](_0xb8f26c,_0x2b0bdb,_0x5b0176,_0x2bceb2);else{for(var _0x220662=_0xb8f26c[_0x2b7569(0xe9)]-0x1;_0x220662>=0x0;_0x220662--)if(_0x298855=_0xb8f26c[_0x220662])_0x1cd6f0=(_0x594f99<0x3?_0x298855(_0x1cd6f0):_0x594f99>0x3?_0x298855(_0x2b0bdb,_0x5b0176,_0x1cd6f0):_0x298855(_0x2b0bdb,_0x5b0176))||_0x1cd6f0;}return _0x594f99>0x3&&_0x1cd6f0&&Object['defineProperty'](_0x2b0bdb,_0x5b0176,_0x1cd6f0),_0x1cd6f0;},__metadata=this&&this[_0xcde858(0xf3)]||function(_0x2b59ee,_0x12f4f2){const _0x59a2ce=_0xcde858;if(typeof Reflect==='object'&&typeof Reflect[_0x59a2ce(0xc8)]==='function')return Reflect['metadata'](_0x2b59ee,_0x12f4f2);},__param=this&&this[_0xcde858(0xbd)]||function(_0x111245,_0x457188){return function(_0x13e704,_0x335877){_0x457188(_0x13e704,_0x335877,_0x111245);};};function _0x435d(){const _0x34e2a3=['getCurrentModelKeyInfo','delModel','InjectRepository','stringify','getRandomDrawKey','setModel','forEach','__esModule','save','HttpStatus','Logger','secret','__param','delete','keyStatus','useToken\x20+\x20','design:paramtypes','当前账号不存在！','push','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','parse','queryModelType','execute','metadata','Injectable','./models.entity','hideString','from','object','setModelType','4436796FFwYTr','../../common/constants/status.constant','keyPoolMap','sort','reduce','status','super','modelsEntity','typeorm','keys','modelMaps','parse\x20error:\x20','BAD_REQUEST','findAndCount','decorate','27VkPsoy','values','126054IkmZtu','key:\x20','keyType','map','set','当前调用模型已经被移除、请重新选择模型！','error','modelOrder','id\x20=\x20:id','length','getRandomItemFromArray','defineProperty','2685448LwPqpl','Like','saveUseLog','queryModels','affected','15778827fnOTlA','ModelsEntity','__metadata','modelTypes','model','../../common/utils','4RjZlGB','keyPoolIndexMap','where','./modelType.entity','initCalcKey','ModelsService','modelsList','764100GyHMPg','Repository','find','392532blazwG','getOwnPropertyDescriptor','findOne','__decorate','log','ASC','error:\x20','key','HttpException','keyList','lockKey','update','1539115HiPYBT'];_0x435d=function(){return _0x34e2a3;};return _0x435d();}Object[_0xcde858(0xeb)](exports,_0xcde858(0xb8),{'value':!![]}),exports['ModelsService']=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0xcde858(0xd7)),models_entity_1=require(_0xcde858(0xca)),status_constant_1=require(_0xcde858(0xd0)),utils_1=require(_0xcde858(0xf6)),modelType_entity_1=require(_0xcde858(0xfa));let ModelsService=class ModelsService{constructor(_0x3eeb50,_0x2dc8ee){const _0x18ab26=_0xcde858;this['modelsEntity']=_0x3eeb50,this['modelsTypeEntity']=_0x2dc8ee,this[_0x18ab26(0xf4)]=[],this[_0x18ab26(0xd9)]={},this[_0x18ab26(0x10a)]={},this['keyPoolMap']={},this[_0x18ab26(0xf8)]={};}async['onModuleInit'](){const _0x3165da=_0xcde858;await this[_0x3165da(0xfb)]();}async['initCalcKey'](){const _0x496ebf=_0xcde858;this['keyPoolMap']={},this[_0x496ebf(0xf8)]={},this['keyList']={},this[_0x496ebf(0xd9)]={},this['modelTypes']=[];const _0x892317=await this['modelsEntity']['find']({'where':{'status':!![]}}),_0x35b6bc=_0x892317['reduce']((_0x421fdb,_0x19b954)=>{const _0x36bf14=_0x496ebf;return!_0x421fdb[_0x19b954[_0x36bf14(0xe2)]]?_0x421fdb[_0x19b954['keyType']]=[_0x19b954]:_0x421fdb[_0x19b954['keyType']][_0x36bf14(0xc3)](_0x19b954),_0x421fdb;},{});this[_0x496ebf(0xf4)]=Object[_0x496ebf(0xd8)](_0x35b6bc)['map'](_0x584a6b=>{return{'label':status_constant_1['ModelsMapCn'][_0x584a6b],'val':_0x584a6b};}),this[_0x496ebf(0xd9)]=_0x35b6bc,this['keyList']={},_0x892317[_0x496ebf(0xb7)](_0x1c07dc=>{const _0x4217d4=_0x496ebf,{keyType:_0xb143ef,model:_0x548f58,keyWeight:_0x5cb25e}=_0x1c07dc;if(!this[_0x4217d4(0xd1)][_0x548f58])this[_0x4217d4(0xd1)][_0x548f58]=[];for(let _0xd6ab88=0x0;_0xd6ab88<_0x5cb25e;_0xd6ab88++){this[_0x4217d4(0xd1)][_0x548f58]['push'](_0x1c07dc);}if(!this[_0x4217d4(0xf8)][_0x548f58])this[_0x4217d4(0xf8)][_0x548f58]=0x0;if(!this[_0x4217d4(0x10a)][_0xb143ef])this[_0x4217d4(0x10a)][_0xb143ef]={};if(!this[_0x4217d4(0x10a)][_0xb143ef][_0x548f58])this[_0x4217d4(0x10a)][_0xb143ef][_0x548f58]=[];this['keyList'][_0xb143ef][_0x548f58][_0x4217d4(0xc3)](_0x1c07dc);});}async[_0xcde858(0x10b)](_0x2b3676,_0x1a5388,_0x5b66ec=-0x1){const _0x31c1c5=_0xcde858,_0x2b6f21=await this[_0x31c1c5(0xd6)]['update']({'id':_0x2b3676},{'status':![],'keyStatus':_0x5b66ec,'remark':_0x1a5388});common_1[_0x31c1c5(0xbb)][_0x31c1c5(0xe6)](_0x31c1c5(0xe1)+_0x2b3676+_0x31c1c5(0xc4)),this[_0x31c1c5(0xfb)]();}async[_0xcde858(0x10e)](_0x2cc105){const _0xd87b2b=_0xcde858;if(!this[_0xd87b2b(0xd1)][_0x2cc105])throw new common_1[(_0xd87b2b(0x109))](_0xd87b2b(0xe5),common_1[_0xd87b2b(0xba)][_0xd87b2b(0xdb)]);this['keyPoolIndexMap'][_0x2cc105]++;const _0x1992c4=this[_0xd87b2b(0xf8)][_0x2cc105];if(_0x1992c4>=this[_0xd87b2b(0xd1)][_0x2cc105][_0xd87b2b(0xe9)])this['keyPoolIndexMap'][_0x2cc105]=0x0;const _0x4374ec=this[_0xd87b2b(0xd1)][_0x2cc105][this['keyPoolIndexMap'][_0x2cc105]];return _0x4374ec;}async['getBaseConfig'](_0x1841dd){const _0x2cd678=_0xcde858;if(!this[_0x2cd678(0xf4)]['length']||!Object[_0x2cd678(0xd8)](this[_0x2cd678(0xd9)])[_0x2cd678(0xe9)])return;const _0x396da6=_0x1841dd?this['modelTypes'][_0x2cd678(0x100)](_0x37f317=>Number(_0x37f317['val'])===0x1):this[_0x2cd678(0xf4)][0x0];if(!_0x396da6)return;const {keyType:_0x563174,modelName:_0x4e0439,model:_0x3a8983,maxModelTokens:_0x346603,maxResponseTokens:_0xed3fc,deductType:_0x5f1f45,deduct:_0xbdf63e,maxRounds:_0x38a52b}=this[_0x2cd678(0xd9)][_0x396da6['val']][0x0];return{'modelTypeInfo':_0x396da6,'modelInfo':{'keyType':_0x563174,'modelName':_0x4e0439,'model':_0x3a8983,'maxModelTokens':_0x346603,'maxResponseTokens':_0xed3fc,'topN':0.8,'systemMessage':'','deductType':_0x5f1f45,'deduct':_0xbdf63e,'maxRounds':_0x38a52b,'rounds':0x8}};}async[_0xcde858(0x113)](_0x39571e){const _0xa14002=_0xcde858;try{const {id:_0x4daee2}=_0x39571e;_0x39571e[_0xa14002(0xd4)]&&(_0x39571e[_0xa14002(0xbf)]=0x1);if(_0x4daee2){const _0xdf6985=await this[_0xa14002(0xd6)]['update']({'id':_0x4daee2},_0x39571e);return await this[_0xa14002(0xfb)](),_0xdf6985[_0xa14002(0xf0)]>0x0;}else{const {keyType:_0xb927ca,key:_0x351fb8}=_0x39571e;if(Number(_0xb927ca!==0x1)){const _0x36f409=await this[_0xa14002(0xd6)][_0xa14002(0xb9)](_0x39571e);return await this[_0xa14002(0xfb)](),_0x36f409;}else{const _0x490aa9=_0x351fb8[_0xa14002(0xe3)](_0x57599d=>{const _0x5e2731=_0xa14002;try{const _0x53e983=JSON[_0x5e2731(0xc5)](JSON[_0x5e2731(0x111)](_0x39571e));return _0x53e983[_0x5e2731(0x108)]=_0x57599d,_0x53e983;}catch(_0x1d9661){console[_0x5e2731(0x105)](_0x5e2731(0xda),_0x1d9661);}}),_0x3d698e=await this['modelsEntity'][_0xa14002(0xb9)](_0x490aa9);return await this[_0xa14002(0xfb)](),_0x3d698e;}}}catch(_0x28df83){console['log'](_0xa14002(0x107),_0x28df83);}}async[_0xcde858(0x10f)]({id:_0x59d0d4}){const _0x3d655a=_0xcde858;if(!_0x59d0d4)throw new common_1[(_0x3d655a(0x109))]('缺失必要参数！',common_1[_0x3d655a(0xba)][_0x3d655a(0xdb)]);const _0x2d7a1c=await this[_0x3d655a(0xd6)][_0x3d655a(0x103)]({'where':{'id':_0x59d0d4}});if(!_0x2d7a1c)throw new common_1[(_0x3d655a(0x109))](_0x3d655a(0xc2),common_1[_0x3d655a(0xba)][_0x3d655a(0xdb)]);const _0x3c1aa6=await this[_0x3d655a(0xd6)][_0x3d655a(0xbe)]({'id':_0x59d0d4});return await this[_0x3d655a(0xfb)](),_0x3c1aa6;}async[_0xcde858(0xef)](_0x5bafd7,_0x78fa80){const _0x4125ee=_0xcde858,{role:_0x4ad576}=_0x5bafd7['user'],{keyType:_0x54df31,key:_0x30b4f8,status:_0x8f7e1b,model:_0x373f32,page:page=0x1,size:size=0xa}=_0x78fa80;let _0x210201={};_0x54df31&&(_0x210201[_0x4125ee(0xe2)]=_0x54df31),_0x373f32&&(_0x210201[_0x4125ee(0xf5)]=_0x373f32),_0x8f7e1b&&(_0x210201[_0x4125ee(0xd4)]=Number(_0x8f7e1b)===0x1?!![]:![]),_0x30b4f8&&(_0x210201['key']=(0x0,typeorm_2[_0x4125ee(0xed)])('%'+_0x30b4f8+'%'));const [_0xd90d,_0x47ec53]=await this[_0x4125ee(0xd6)][_0x4125ee(0xdc)]({'where':_0x210201,'order':{'modelOrder':_0x4125ee(0x106)},'skip':(page-0x1)*size,'take':size});return _0x4ad576!==_0x4125ee(0xd5)&&_0xd90d[_0x4125ee(0xb7)](_0x388db6=>{const _0xbd2711=_0x4125ee;_0x388db6['key']&&(_0x388db6[_0xbd2711(0x108)]=(0x0,utils_1[_0xbd2711(0xcb)])(_0x388db6[_0xbd2711(0x108)])),_0x388db6[_0xbd2711(0xbc)]&&(_0x388db6[_0xbd2711(0xbc)]=(0x0,utils_1['hideString'])(_0x388db6[_0xbd2711(0xbc)]));}),{'rows':_0xd90d,'count':_0x47ec53};}async[_0xcde858(0xfd)](){const _0x13bd42=_0xcde858,_0x370d23=JSON[_0x13bd42(0xc5)](JSON[_0x13bd42(0x111)](this[_0x13bd42(0xd9)]));return Object[_0x13bd42(0xd8)](_0x370d23)['forEach'](_0xfb0a8=>{const _0x282a01=_0x13bd42;_0x370d23[_0xfb0a8]=_0x370d23[_0xfb0a8][_0x282a01(0xd2)]((_0xf19da2,_0x5eafb7)=>_0xf19da2[_0x282a01(0xe7)]-_0x5eafb7[_0x282a01(0xe7)]),_0x370d23[_0xfb0a8]=Array[_0x282a01(0xcc)](_0x370d23[_0xfb0a8][_0x282a01(0xe3)](_0x13e7ad=>{const {modelName:_0x1dbd5a,model:_0x66af83,deduct:_0xec09be,deductType:_0x136fe0,maxRounds:_0x339899}=_0x13e7ad;return{'modelName':_0x1dbd5a,'model':_0x66af83,'deduct':_0xec09be,'deductType':_0x136fe0,'maxRounds':_0x339899};})[_0x282a01(0xd3)]((_0x1b2790,_0x1ae217)=>_0x1b2790[_0x282a01(0xe4)](_0x1ae217['modelName'],_0x1ae217),new Map())[_0x282a01(0xdf)]());}),{'modelTypeList':this[_0x13bd42(0xf4)],'modelMaps':_0x370d23};}async[_0xcde858(0xee)](_0x361ebc,_0x459993){const _0x4af414=_0xcde858;await this[_0x4af414(0xd6)]['createQueryBuilder']()[_0x4af414(0x10c)](models_entity_1[_0x4af414(0xf2)])[_0x4af414(0xe4)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>_0x4af414(0xc0)+_0x459993})[_0x4af414(0xf9)](_0x4af414(0xe8),{'id':_0x361ebc})[_0x4af414(0xc7)]();}async[_0xcde858(0x112)](){const _0x525b48=_0xcde858,_0x29f028=await this[_0x525b48(0xd6)]['find']({'where':{'isDraw':!![],'status':!![]}});if(!_0x29f028[_0x525b48(0xe9)])throw new common_1[(_0x525b48(0x109))]('当前未指定特殊模型KEY、前往后台模型池设置吧！',common_1['HttpStatus']['BAD_REQUEST']);return(0x0,utils_1[_0x525b48(0xea)])(_0x29f028);}async['getAllKey'](){const _0x5ea718=_0xcde858;return await this[_0x5ea718(0xd6)]['find']();}async[_0xcde858(0xc6)](_0x34082f){return 0x1;}async[_0xcde858(0xce)](_0x5c7bc4){return 0x1;}async['delModelType'](_0x3c032d){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0xcde858(0xc9)])(),__param(0x0,(0x0,typeorm_1[_0xcde858(0x110)])(models_entity_1[_0xcde858(0xf2)])),__param(0x1,(0x0,typeorm_1[_0xcde858(0x110)])(modelType_entity_1['ModelsTypeEntity'])),__metadata(_0xcde858(0xc1),[typeorm_2[_0xcde858(0xff)],typeorm_2[_0xcde858(0xff)]])],ModelsService),exports[_0xcde858(0xfc)]=ModelsService;