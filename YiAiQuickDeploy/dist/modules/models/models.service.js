'use strict';function _0x429f(_0x10fe1b,_0x564a0c){const _0x54a805=_0x54a8();return _0x429f=function(_0x429f30,_0x12a29c){_0x429f30=_0x429f30-0x17b;let _0x531c1a=_0x54a805[_0x429f30];return _0x531c1a;},_0x429f(_0x10fe1b,_0x564a0c);}const _0x56c146=_0x429f;(function(_0x309fc1,_0x54ee8a){const _0x355792=_0x429f,_0x3aad26=_0x309fc1();while(!![]){try{const _0x8aa540=-parseInt(_0x355792(0x199))/0x1*(parseInt(_0x355792(0x1b2))/0x2)+-parseInt(_0x355792(0x1bb))/0x3*(parseInt(_0x355792(0x188))/0x4)+-parseInt(_0x355792(0x194))/0x5+parseInt(_0x355792(0x181))/0x6*(-parseInt(_0x355792(0x1d7))/0x7)+-parseInt(_0x355792(0x193))/0x8+-parseInt(_0x355792(0x17b))/0x9*(-parseInt(_0x355792(0x1c2))/0xa)+-parseInt(_0x355792(0x1b8))/0xb*(-parseInt(_0x355792(0x17f))/0xc);if(_0x8aa540===_0x54ee8a)break;else _0x3aad26['push'](_0x3aad26['shift']());}catch(_0x15bbad){_0x3aad26['push'](_0x3aad26['shift']());}}}(_0x54a8,0xc0430));var __decorate=this&&this['__decorate']||function(_0x48d780,_0x4b3938,_0x30f2e6,_0x864e44){const _0x252bca=_0x429f;var _0x1ed23e=arguments[_0x252bca(0x19c)],_0x24b713=_0x1ed23e<0x3?_0x4b3938:_0x864e44===null?_0x864e44=Object['getOwnPropertyDescriptor'](_0x4b3938,_0x30f2e6):_0x864e44,_0x44f22b;if(typeof Reflect===_0x252bca(0x190)&&typeof Reflect[_0x252bca(0x19a)]===_0x252bca(0x198))_0x24b713=Reflect['decorate'](_0x48d780,_0x4b3938,_0x30f2e6,_0x864e44);else{for(var _0x48c25f=_0x48d780[_0x252bca(0x19c)]-0x1;_0x48c25f>=0x0;_0x48c25f--)if(_0x44f22b=_0x48d780[_0x48c25f])_0x24b713=(_0x1ed23e<0x3?_0x44f22b(_0x24b713):_0x1ed23e>0x3?_0x44f22b(_0x4b3938,_0x30f2e6,_0x24b713):_0x44f22b(_0x4b3938,_0x30f2e6))||_0x24b713;}return _0x1ed23e>0x3&&_0x24b713&&Object[_0x252bca(0x17d)](_0x4b3938,_0x30f2e6,_0x24b713),_0x24b713;},__metadata=this&&this[_0x56c146(0x17e)]||function(_0x484f24,_0x78b69f){const _0x42f52b=_0x56c146;if(typeof Reflect===_0x42f52b(0x190)&&typeof Reflect[_0x42f52b(0x1d1)]==='function')return Reflect[_0x42f52b(0x1d1)](_0x484f24,_0x78b69f);},__param=this&&this[_0x56c146(0x1a1)]||function(_0x2a4ed4,_0x30e2d9){return function(_0x2328c5,_0x4c0498){_0x30e2d9(_0x2328c5,_0x4c0498,_0x2a4ed4);};};Object['defineProperty'](exports,_0x56c146(0x1a4),{'value':!![]}),exports[_0x56c146(0x1ba)]=void 0x0;const common_1=require(_0x56c146(0x1bf)),typeorm_1=require(_0x56c146(0x1ca)),typeorm_2=require('typeorm'),models_entity_1=require('./models.entity'),status_constant_1=require(_0x56c146(0x1d4)),utils_1=require('../../common/utils'),modelType_entity_1=require(_0x56c146(0x17c));let ModelsService=class ModelsService{constructor(_0x58a9e6,_0x701e7d){const _0x1e44e9=_0x56c146;this[_0x1e44e9(0x1cb)]=_0x58a9e6,this[_0x1e44e9(0x1b4)]=_0x701e7d,this[_0x1e44e9(0x192)]=[],this['modelMaps']={},this[_0x1e44e9(0x1d0)]={},this['keyPoolMap']={},this['keyPoolIndexMap']={};}async['onModuleInit'](){await this['initCalcKey']();}async[_0x56c146(0x189)](){const _0x2ceda8=_0x56c146;this[_0x2ceda8(0x1aa)]={},this[_0x2ceda8(0x1d3)]={},this[_0x2ceda8(0x1d0)]={},this[_0x2ceda8(0x185)]={},this[_0x2ceda8(0x192)]=[];const _0x15e668=await this[_0x2ceda8(0x1cb)][_0x2ceda8(0x191)]({'where':{'status':!![]}}),_0x271db8=_0x15e668[_0x2ceda8(0x183)]((_0x37960a,_0x9bd64)=>{const _0x340875=_0x2ceda8;return!_0x37960a[_0x9bd64[_0x340875(0x1af)]]?_0x37960a[_0x9bd64['keyType']]=[_0x9bd64]:_0x37960a[_0x9bd64[_0x340875(0x1af)]][_0x340875(0x1a9)](_0x9bd64),_0x37960a;},{});this[_0x2ceda8(0x192)]=Object['keys'](_0x271db8)[_0x2ceda8(0x1bc)](_0x3aef8c=>{const _0x70ce8c=_0x2ceda8;return{'label':status_constant_1[_0x70ce8c(0x1c6)][_0x3aef8c],'val':_0x3aef8c};}),this['modelMaps']=_0x271db8,this['keyList']={},_0x15e668[_0x2ceda8(0x1cd)](_0x5f2937=>{const _0x27f252=_0x2ceda8,{keyType:_0x44bfb6,model:_0x71ba52,keyWeight:_0x372c9e}=_0x5f2937;if(!this[_0x27f252(0x1aa)][_0x71ba52])this['keyPoolMap'][_0x71ba52]=[];for(let _0x40faa3=0x0;_0x40faa3<_0x372c9e;_0x40faa3++){this[_0x27f252(0x1aa)][_0x71ba52][_0x27f252(0x1a9)](_0x5f2937);}if(!this[_0x27f252(0x1d3)][_0x71ba52])this[_0x27f252(0x1d3)][_0x71ba52]=0x0;if(!this[_0x27f252(0x1d0)][_0x44bfb6])this[_0x27f252(0x1d0)][_0x44bfb6]={};if(!this[_0x27f252(0x1d0)][_0x44bfb6][_0x71ba52])this['keyList'][_0x44bfb6][_0x71ba52]=[];this[_0x27f252(0x1d0)][_0x44bfb6][_0x71ba52]['push'](_0x5f2937);});}async[_0x56c146(0x1c1)](_0x30605f,_0x4ccccc,_0x2de386=-0x1){const _0x3de8fe=_0x56c146,_0x49c2c5=await this['modelsEntity'][_0x3de8fe(0x1b5)]({'id':_0x30605f},{'status':![],'keyStatus':_0x2de386,'remark':_0x4ccccc});common_1['Logger'][_0x3de8fe(0x1a3)](_0x3de8fe(0x19b)+_0x30605f+_0x3de8fe(0x184)),this['initCalcKey']();}async[_0x56c146(0x19f)](_0x23dea8){const _0x39c53a=_0x56c146;if(!this[_0x39c53a(0x1aa)][_0x23dea8])throw new common_1[(_0x39c53a(0x1b7))](_0x39c53a(0x18c),common_1[_0x39c53a(0x1c8)][_0x39c53a(0x18b)]);this[_0x39c53a(0x1d3)][_0x23dea8]++;const _0x520beb=this[_0x39c53a(0x1d3)][_0x23dea8];if(_0x520beb>=this[_0x39c53a(0x1aa)][_0x23dea8][_0x39c53a(0x19c)])this[_0x39c53a(0x1d3)][_0x23dea8]=0x0;const _0x184023=this[_0x39c53a(0x1aa)][_0x23dea8][this[_0x39c53a(0x1d3)][_0x23dea8]];return _0x184023;}async[_0x56c146(0x1cc)](_0x306904){const _0x543517=_0x56c146;if(!this[_0x543517(0x192)][_0x543517(0x19c)]||!Object['keys'](this[_0x543517(0x185)])[_0x543517(0x19c)])return;const _0x3efe2e=_0x306904?this[_0x543517(0x192)]['find'](_0x4038f0=>Number(_0x4038f0[_0x543517(0x1c7)])===0x1):this[_0x543517(0x192)][0x0];if(!_0x3efe2e)return;const {keyType:_0x10af42,modelName:_0x2aa0f2,model:_0x2cd119,maxModelTokens:_0x4f50bc,maxResponseTokens:_0x3d634d,deductType:_0x4f9398,deduct:_0x467b60,maxRounds:_0x3be0de}=this['modelMaps'][_0x3efe2e[_0x543517(0x1c7)]][0x0];return{'modelTypeInfo':_0x3efe2e,'modelInfo':{'keyType':_0x10af42,'modelName':_0x2aa0f2,'model':_0x2cd119,'maxModelTokens':_0x4f50bc,'maxResponseTokens':_0x3d634d,'topN':0.8,'systemMessage':'','deductType':_0x4f9398,'deduct':_0x467b60,'maxRounds':_0x3be0de,'rounds':0x8}};}async[_0x56c146(0x18a)](_0x4ea4ee){const _0x13ca12=_0x56c146;try{const {id:_0x3d7d8a}=_0x4ea4ee;_0x4ea4ee[_0x13ca12(0x1c5)]&&(_0x4ea4ee[_0x13ca12(0x18d)]=0x1);if(_0x3d7d8a){const _0x2be425=await this['modelsEntity'][_0x13ca12(0x1b5)]({'id':_0x3d7d8a},_0x4ea4ee);return await this['initCalcKey'](),_0x2be425[_0x13ca12(0x196)]>0x0;}else{const {keyType:_0x12293d,key:_0x288750}=_0x4ea4ee;if(Number(_0x12293d!==0x1)){const _0xe1694=await this[_0x13ca12(0x1cb)][_0x13ca12(0x180)](_0x4ea4ee);return await this['initCalcKey'](),_0xe1694;}else{const _0x5bb1b2=_0x288750[_0x13ca12(0x1bc)](_0x520a1f=>{const _0x1499e6=_0x13ca12;try{const _0x3fd5da=JSON['parse'](JSON['stringify'](_0x4ea4ee));return _0x3fd5da[_0x1499e6(0x1a5)]=_0x520a1f,_0x3fd5da;}catch(_0x167c8c){console['log']('parse\x20error:\x20',_0x167c8c);}}),_0x467a43=await this[_0x13ca12(0x1cb)][_0x13ca12(0x180)](_0x5bb1b2);return await this['initCalcKey'](),_0x467a43;}}}catch(_0x75516e){console[_0x13ca12(0x1c3)](_0x13ca12(0x1b6),_0x75516e);}}async[_0x56c146(0x1cf)]({id:_0x57b9fa}){const _0x4d4fee=_0x56c146;if(!_0x57b9fa)throw new common_1[(_0x4d4fee(0x1b7))](_0x4d4fee(0x195),common_1['HttpStatus'][_0x4d4fee(0x18b)]);const _0x439958=await this[_0x4d4fee(0x1cb)][_0x4d4fee(0x1c0)]({'where':{'id':_0x57b9fa}});if(!_0x439958)throw new common_1[(_0x4d4fee(0x1b7))]('当前账号不存在！',common_1[_0x4d4fee(0x1c8)][_0x4d4fee(0x18b)]);const _0x5a9d94=await this['modelsEntity'][_0x4d4fee(0x1ae)]({'id':_0x57b9fa});return await this['initCalcKey'](),_0x5a9d94;}async[_0x56c146(0x1c4)](_0xcdd332,_0x1ad33c){const _0x148c27=_0x56c146,{role:_0xfa00a5}=_0xcdd332[_0x148c27(0x197)],{keyType:_0x418312,key:_0x6155ca,status:_0xea121d,model:_0x40ea9f,page:page=0x1,size:size=0xa}=_0x1ad33c;let _0x46b8e6={};_0x418312&&(_0x46b8e6['keyType']=_0x418312),_0x40ea9f&&(_0x46b8e6[_0x148c27(0x1a8)]=_0x40ea9f),_0xea121d&&(_0x46b8e6['status']=Number(_0xea121d)===0x1?!![]:![]),_0x6155ca&&(_0x46b8e6[_0x148c27(0x1a5)]=(0x0,typeorm_2[_0x148c27(0x1a2)])('%'+_0x6155ca+'%'));const [_0xf0e309,_0x3fe661]=await this[_0x148c27(0x1cb)][_0x148c27(0x187)]({'where':_0x46b8e6,'order':{'modelOrder':_0x148c27(0x19e)},'skip':(page-0x1)*size,'take':size});return _0xfa00a5!=='super'&&_0xf0e309[_0x148c27(0x1cd)](_0xcb1856=>{const _0x2a5386=_0x148c27;_0xcb1856[_0x2a5386(0x1a5)]&&(_0xcb1856['key']=(0x0,utils_1[_0x2a5386(0x1b0)])(_0xcb1856[_0x2a5386(0x1a5)])),_0xcb1856['secret']&&(_0xcb1856[_0x2a5386(0x18e)]=(0x0,utils_1[_0x2a5386(0x1b0)])(_0xcb1856[_0x2a5386(0x18e)]));}),{'rows':_0xf0e309,'count':_0x3fe661};}async[_0x56c146(0x1ab)](){const _0x4dfabf=_0x56c146,_0x2a0f13=JSON[_0x4dfabf(0x1d2)](JSON['stringify'](this['modelMaps']));return Object[_0x4dfabf(0x1d6)](_0x2a0f13)[_0x4dfabf(0x1cd)](_0x26e619=>{const _0x29c316=_0x4dfabf;_0x2a0f13[_0x26e619]=_0x2a0f13[_0x26e619]['sort']((_0x4c74c3,_0x1101ad)=>_0x4c74c3['modelOrder']-_0x1101ad[_0x29c316(0x182)]),_0x2a0f13[_0x26e619]=Array['from'](_0x2a0f13[_0x26e619][_0x29c316(0x1bc)](_0x173be2=>{const {modelName:_0x50ddc1,model:_0x3d69c2,deduct:_0x51d8ac,deductType:_0x3a9b8b,maxRounds:_0x4f710d}=_0x173be2;return{'modelName':_0x50ddc1,'model':_0x3d69c2,'deduct':_0x51d8ac,'deductType':_0x3a9b8b,'maxRounds':_0x4f710d};})[_0x29c316(0x183)]((_0x180878,_0x5cfe47)=>_0x180878[_0x29c316(0x1b9)](_0x5cfe47[_0x29c316(0x1ac)],_0x5cfe47),new Map())['values']());}),{'modelTypeList':this[_0x4dfabf(0x192)],'modelMaps':_0x2a0f13};}async[_0x56c146(0x1bd)](_0x23c5ef,_0x1bfe8b){const _0xfe673a=_0x56c146;await this['modelsEntity']['createQueryBuilder']()[_0xfe673a(0x1b5)](models_entity_1[_0xfe673a(0x1a6)])[_0xfe673a(0x1b9)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>'useToken\x20+\x20'+_0x1bfe8b})[_0xfe673a(0x1ad)]('id\x20=\x20:id',{'id':_0x23c5ef})[_0xfe673a(0x1ce)]();}async[_0x56c146(0x1a0)](){const _0x20bd28=_0x56c146,_0x5db0eb=await this[_0x20bd28(0x1cb)]['find']({'where':{'isDraw':!![],'status':!![]}});if(!_0x5db0eb[_0x20bd28(0x19c)])throw new common_1[(_0x20bd28(0x1b7))](_0x20bd28(0x1b3),common_1[_0x20bd28(0x1c8)][_0x20bd28(0x18b)]);return(0x0,utils_1[_0x20bd28(0x1d5)])(_0x5db0eb);}async[_0x56c146(0x1c9)](){const _0xc3d977=_0x56c146;return await this[_0xc3d977(0x1cb)][_0xc3d977(0x191)]();}async['queryModelType'](_0x152682){return 0x1;}async[_0x56c146(0x19d)](_0x329ddc){return 0x1;}async[_0x56c146(0x1a7)](_0x3dae08){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0x56c146(0x1b1)])(),__param(0x0,(0x0,typeorm_1[_0x56c146(0x1be)])(models_entity_1[_0x56c146(0x1a6)])),__param(0x1,(0x0,typeorm_1[_0x56c146(0x1be)])(modelType_entity_1[_0x56c146(0x186)])),__metadata('design:paramtypes',[typeorm_2[_0x56c146(0x18f)],typeorm_2['Repository']])],ModelsService),exports['ModelsService']=ModelsService;function _0x54a8(){const _0x239f99=['push','keyPoolMap','modelsList','modelName','where','delete','keyType','hideString','Injectable','2cvfKpu','当前未指定特殊模型KEY、前往后台模型池设置吧！','modelsTypeEntity','update','error:\x20','HttpException','187TCgTzf','set','ModelsService','177FsiSJL','map','saveUseLog','InjectRepository','@nestjs/common','findOne','lockKey','10SBABIm','log','queryModels','status','ModelsMapCn','val','HttpStatus','getAllKey','@nestjs/typeorm','modelsEntity','getBaseConfig','forEach','execute','delModel','keyList','metadata','parse','keyPoolIndexMap','../../common/constants/status.constant','getRandomItemFromArray','keys','938XCPWna','10992987OxDeFT','./modelType.entity','defineProperty','__metadata','1238268TEDJeP','save','5664pAMHoJ','modelOrder','reduce','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','modelMaps','ModelsTypeEntity','findAndCount','23068culgNX','initCalcKey','setModel','BAD_REQUEST','当前调用模型已经被移除、请重新选择模型！','keyStatus','secret','Repository','object','find','modelTypes','3058120BhECuF','2840645wGjFFV','缺失必要参数！','affected','user','function','771009ATMWUC','decorate','key:\x20','length','setModelType','ASC','getCurrentModelKeyInfo','getRandomDrawKey','__param','Like','error','__esModule','key','ModelsEntity','delModelType','model'];_0x54a8=function(){return _0x239f99;};return _0x54a8();}