'use strict';const _0x17f7d3=_0x1b08;(function(_0x30fc07,_0x2d3d6f){const _0x49f4d1=_0x1b08,_0x4c0bfa=_0x30fc07();while(!![]){try{const _0x3d483a=parseInt(_0x49f4d1(0x1c8))/0x1+parseInt(_0x49f4d1(0x1e8))/0x2*(parseInt(_0x49f4d1(0x1b7))/0x3)+parseInt(_0x49f4d1(0x1cb))/0x4+-parseInt(_0x49f4d1(0x1db))/0x5*(-parseInt(_0x49f4d1(0x1dd))/0x6)+-parseInt(_0x49f4d1(0x1b3))/0x7*(-parseInt(_0x49f4d1(0x1bb))/0x8)+-parseInt(_0x49f4d1(0x1ac))/0x9+-parseInt(_0x49f4d1(0x1eb))/0xa;if(_0x3d483a===_0x2d3d6f)break;else _0x4c0bfa['push'](_0x4c0bfa['shift']());}catch(_0x17dd12){_0x4c0bfa['push'](_0x4c0bfa['shift']());}}}(_0x5051,0x594d0));var __decorate=this&&this[_0x17f7d3(0x1ce)]||function(_0xcdd47d,_0x26f7a4,_0xec815e,_0x460272){const _0xc24a42=_0x17f7d3;var _0x5e2daa=arguments[_0xc24a42(0x1e1)],_0x28eade=_0x5e2daa<0x3?_0x26f7a4:_0x460272===null?_0x460272=Object['getOwnPropertyDescriptor'](_0x26f7a4,_0xec815e):_0x460272,_0x319aed;if(typeof Reflect===_0xc24a42(0x1e4)&&typeof Reflect[_0xc24a42(0x1f9)]===_0xc24a42(0x1ae))_0x28eade=Reflect[_0xc24a42(0x1f9)](_0xcdd47d,_0x26f7a4,_0xec815e,_0x460272);else{for(var _0xa91176=_0xcdd47d[_0xc24a42(0x1e1)]-0x1;_0xa91176>=0x0;_0xa91176--)if(_0x319aed=_0xcdd47d[_0xa91176])_0x28eade=(_0x5e2daa<0x3?_0x319aed(_0x28eade):_0x5e2daa>0x3?_0x319aed(_0x26f7a4,_0xec815e,_0x28eade):_0x319aed(_0x26f7a4,_0xec815e))||_0x28eade;}return _0x5e2daa>0x3&&_0x28eade&&Object[_0xc24a42(0x1e6)](_0x26f7a4,_0xec815e,_0x28eade),_0x28eade;},__metadata=this&&this[_0x17f7d3(0x1a7)]||function(_0x42c2f2,_0x31d2b6){const _0x48afb6=_0x17f7d3;if(typeof Reflect===_0x48afb6(0x1e4)&&typeof Reflect[_0x48afb6(0x1e0)]===_0x48afb6(0x1ae))return Reflect[_0x48afb6(0x1e0)](_0x42c2f2,_0x31d2b6);},__param=this&&this[_0x17f7d3(0x1f3)]||function(_0x36ab19,_0x3559ce){return function(_0x5b3626,_0x3bbc78){_0x3559ce(_0x5b3626,_0x3bbc78,_0x36ab19);};};Object[_0x17f7d3(0x1e6)](exports,_0x17f7d3(0x1f7),{'value':!![]}),exports['ModelsService']=void 0x0;function _0x1b08(_0xd9a54b,_0x2cab67){const _0x5051a0=_0x5051();return _0x1b08=function(_0x1b0887,_0xa86fc){_0x1b0887=_0x1b0887-0x1a4;let _0x3b2bb8=_0x5051a0[_0x1b0887];return _0x3b2bb8;},_0x1b08(_0xd9a54b,_0x2cab67);}const common_1=require(_0x17f7d3(0x1ea)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x17f7d3(0x1b9)),models_entity_1=require(_0x17f7d3(0x1b0)),status_constant_1=require('../../common/constants/status.constant'),utils_1=require(_0x17f7d3(0x1dc)),modelType_entity_1=require('./modelType.entity');let ModelsService=class ModelsService{constructor(_0x59690b,_0x1a768f){const _0x5bbfd7=_0x17f7d3;this[_0x5bbfd7(0x1e7)]=_0x59690b,this[_0x5bbfd7(0x1ed)]=_0x1a768f,this[_0x5bbfd7(0x1ba)]=[],this[_0x5bbfd7(0x1c5)]={},this['keyList']={},this['keyPoolMap']={},this[_0x5bbfd7(0x1cd)]={};}async[_0x17f7d3(0x1d0)](){const _0x500c53=_0x17f7d3;await this[_0x500c53(0x1c3)]();}async[_0x17f7d3(0x1c3)](){const _0x319359=_0x17f7d3;this[_0x319359(0x1c6)]={},this[_0x319359(0x1cd)]={},this['keyList']={},this[_0x319359(0x1c5)]={},this[_0x319359(0x1ba)]=[];const _0x11e1ba=await this[_0x319359(0x1e7)][_0x319359(0x1b6)]({'where':{'status':!![]}}),_0x50cfa1=_0x11e1ba[_0x319359(0x1c4)]((_0x7c85a1,_0x146873)=>{const _0x2a2f14=_0x319359;return!_0x7c85a1[_0x146873[_0x2a2f14(0x1f6)]]?_0x7c85a1[_0x146873['keyType']]=[_0x146873]:_0x7c85a1[_0x146873['keyType']]['push'](_0x146873),_0x7c85a1;},{});this[_0x319359(0x1ba)]=Object[_0x319359(0x1cc)](_0x50cfa1)[_0x319359(0x1da)](_0x4e52be=>{const _0x2c9679=_0x319359;return{'label':status_constant_1[_0x2c9679(0x1d7)][_0x4e52be],'val':_0x4e52be};}),this[_0x319359(0x1c5)]=_0x50cfa1,this[_0x319359(0x1e9)]={},_0x11e1ba['forEach'](_0x52ded0=>{const _0x3ba171=_0x319359,{keyType:_0x3a455c,model:_0x57e431,keyWeight:_0x9b9f2}=_0x52ded0;if(!this[_0x3ba171(0x1c6)][_0x57e431])this[_0x3ba171(0x1c6)][_0x57e431]=[];for(let _0xdb2255=0x0;_0xdb2255<_0x9b9f2;_0xdb2255++){this[_0x3ba171(0x1c6)][_0x57e431][_0x3ba171(0x1ef)](_0x52ded0);}if(!this['keyPoolIndexMap'][_0x57e431])this[_0x3ba171(0x1cd)][_0x57e431]=0x0;if(!this['keyList'][_0x3a455c])this['keyList'][_0x3a455c]={};if(!this[_0x3ba171(0x1e9)][_0x3a455c][_0x57e431])this[_0x3ba171(0x1e9)][_0x3a455c][_0x57e431]=[];this[_0x3ba171(0x1e9)][_0x3a455c][_0x57e431]['push'](_0x52ded0);});}async[_0x17f7d3(0x1d5)](_0x18f671,_0x4b1f43,_0x5727ec=-0x1){const _0x42ffed=_0x17f7d3,_0x3c6214=await this[_0x42ffed(0x1e7)][_0x42ffed(0x1f8)]({'id':_0x18f671},{'status':![],'keyStatus':_0x5727ec,'remark':_0x4b1f43});common_1[_0x42ffed(0x1a9)][_0x42ffed(0x1be)](_0x42ffed(0x1a5)+_0x18f671+_0x42ffed(0x1ec)),this[_0x42ffed(0x1c3)]();}async['getCurrentModelKeyInfo'](_0x3eb4eb){const _0x4141b1=_0x17f7d3;if(!this['keyPoolMap'][_0x3eb4eb])throw new common_1[(_0x4141b1(0x1c7))](_0x4141b1(0x1b2),common_1[_0x4141b1(0x1b5)][_0x4141b1(0x1b8)]);this['keyPoolIndexMap'][_0x3eb4eb]++;const _0x2cf3ce=this['keyPoolIndexMap'][_0x3eb4eb];if(_0x2cf3ce>=this['keyPoolMap'][_0x3eb4eb][_0x4141b1(0x1e1)])this[_0x4141b1(0x1cd)][_0x3eb4eb]=0x0;const _0x5f34e3=this[_0x4141b1(0x1c6)][_0x3eb4eb][this[_0x4141b1(0x1cd)][_0x3eb4eb]];return _0x5f34e3;}async['getBaseConfig'](_0x5ea6c9){const _0x2ff548=_0x17f7d3;if(!this[_0x2ff548(0x1ba)]['length']||!Object['keys'](this[_0x2ff548(0x1c5)])[_0x2ff548(0x1e1)])return;const _0x1925d5=_0x5ea6c9?this['modelTypes'][_0x2ff548(0x1b6)](_0x23a862=>Number(_0x23a862[_0x2ff548(0x1e3)])===0x1):this[_0x2ff548(0x1ba)][0x0];if(!_0x1925d5)return;const {keyType:_0x32de9a,modelName:_0x3a3d06,model:_0xe7320d,maxModelTokens:_0x289819,maxResponseTokens:_0x2d8099,deductType:_0x4ae4f0,deduct:_0x2b3175,maxRounds:_0x38d446}=this[_0x2ff548(0x1c5)][_0x1925d5[_0x2ff548(0x1e3)]][0x0];return{'modelTypeInfo':_0x1925d5,'modelInfo':{'keyType':_0x32de9a,'modelName':_0x3a3d06,'model':_0xe7320d,'maxModelTokens':_0x289819,'maxResponseTokens':_0x2d8099,'topN':0.8,'systemMessage':'','deductType':_0x4ae4f0,'deduct':_0x2b3175,'maxRounds':_0x38d446,'rounds':0x8}};}async['setModel'](_0xdd445c){const _0x575184=_0x17f7d3;try{const {id:_0x23e344}=_0xdd445c;_0xdd445c['status']&&(_0xdd445c[_0x575184(0x1fd)]=0x1);if(_0x23e344){const _0x3ff7af=await this['modelsEntity']['update']({'id':_0x23e344},_0xdd445c);return await this['initCalcKey'](),_0x3ff7af[_0x575184(0x1a8)]>0x0;}else{const {keyType:_0x5d10df,key:_0x58bd6f}=_0xdd445c;if(Number(_0x5d10df!==0x1)){const _0x5355a4=await this[_0x575184(0x1e7)][_0x575184(0x1ad)](_0xdd445c);return await this[_0x575184(0x1c3)](),_0x5355a4;}else{const _0x264585=_0x58bd6f[_0x575184(0x1da)](_0x3ce8d0=>{const _0x28a403=_0x575184;try{const _0x2921d6=JSON[_0x28a403(0x1d3)](JSON[_0x28a403(0x1f5)](_0xdd445c));return _0x2921d6[_0x28a403(0x1bc)]=_0x3ce8d0,_0x2921d6;}catch(_0x5eb765){console[_0x28a403(0x1c0)](_0x28a403(0x1d9),_0x5eb765);}}),_0x3ee0f1=await this['modelsEntity'][_0x575184(0x1ad)](_0x264585);return await this[_0x575184(0x1c3)](),_0x3ee0f1;}}}catch(_0x4aff0a){console[_0x575184(0x1c0)]('error:\x20',_0x4aff0a);}}async['delModel']({id:_0x584eac}){const _0xd3aaef=_0x17f7d3;if(!_0x584eac)throw new common_1[(_0xd3aaef(0x1c7))](_0xd3aaef(0x1aa),common_1[_0xd3aaef(0x1b5)][_0xd3aaef(0x1b8)]);const _0x3d8539=await this[_0xd3aaef(0x1e7)][_0xd3aaef(0x1d1)]({'where':{'id':_0x584eac}});if(!_0x3d8539)throw new common_1[(_0xd3aaef(0x1c7))](_0xd3aaef(0x1d2),common_1['HttpStatus'][_0xd3aaef(0x1b8)]);const _0x262b89=await this[_0xd3aaef(0x1e7)][_0xd3aaef(0x1f4)]({'id':_0x584eac});return await this[_0xd3aaef(0x1c3)](),_0x262b89;}async[_0x17f7d3(0x1de)](_0x448f05,_0x48c8d7){const _0x5952eb=_0x17f7d3,{role:_0x1179a6}=_0x448f05['user'],{keyType:_0x1214e2,key:_0x3bbc00,status:_0xb5615e,model:_0x22b8d3,page:page=0x1,size:size=0xa}=_0x48c8d7;let _0x462bcf={};_0x1214e2&&(_0x462bcf[_0x5952eb(0x1f6)]=_0x1214e2),_0x22b8d3&&(_0x462bcf[_0x5952eb(0x1df)]=_0x22b8d3),_0xb5615e&&(_0x462bcf[_0x5952eb(0x1c9)]=Number(_0xb5615e)===0x1?!![]:![]),_0x3bbc00&&(_0x462bcf[_0x5952eb(0x1bc)]=(0x0,typeorm_2[_0x5952eb(0x1fb)])('%'+_0x3bbc00+'%'));const [_0x27a97c,_0x2e6398]=await this[_0x5952eb(0x1e7)][_0x5952eb(0x1d6)]({'where':_0x462bcf,'order':{'modelOrder':'ASC'},'skip':(page-0x1)*size,'take':size});return _0x1179a6!==_0x5952eb(0x1f1)&&_0x27a97c[_0x5952eb(0x1a6)](_0x231496=>{const _0x485bc6=_0x5952eb;_0x231496[_0x485bc6(0x1bc)]&&(_0x231496[_0x485bc6(0x1bc)]=(0x0,utils_1['hideString'])(_0x231496[_0x485bc6(0x1bc)])),_0x231496[_0x485bc6(0x1b1)]&&(_0x231496['secret']=(0x0,utils_1[_0x485bc6(0x1e2)])(_0x231496[_0x485bc6(0x1b1)]));}),{'rows':_0x27a97c,'count':_0x2e6398};}async[_0x17f7d3(0x1e5)](){const _0x525046=_0x17f7d3,_0x2f33d6=JSON[_0x525046(0x1d3)](JSON[_0x525046(0x1f5)](this[_0x525046(0x1c5)]));return Object[_0x525046(0x1cc)](_0x2f33d6)[_0x525046(0x1a6)](_0x2fec9e=>{const _0x1c89b2=_0x525046;_0x2f33d6[_0x2fec9e]=_0x2f33d6[_0x2fec9e]['sort']((_0x5f50a,_0x3575ab)=>_0x5f50a[_0x1c89b2(0x1cf)]-_0x3575ab['modelOrder']),_0x2f33d6[_0x2fec9e]=Array[_0x1c89b2(0x1b4)](_0x2f33d6[_0x2fec9e][_0x1c89b2(0x1da)](_0x17a5ed=>{const {modelName:_0x42de76,model:_0x1f4f0e,deduct:_0x34b513,deductType:_0x2edad2,maxRounds:_0xfb83f2}=_0x17a5ed;return{'modelName':_0x42de76,'model':_0x1f4f0e,'deduct':_0x34b513,'deductType':_0x2edad2,'maxRounds':_0xfb83f2};})[_0x1c89b2(0x1c4)]((_0x2c84e6,_0x404d67)=>_0x2c84e6[_0x1c89b2(0x1ee)](_0x404d67['modelName'],_0x404d67),new Map())['values']());}),{'modelTypeList':this[_0x525046(0x1ba)],'modelMaps':_0x2f33d6};}async[_0x17f7d3(0x1c1)](_0x5b3314,_0x57ef06){const _0x44a674=_0x17f7d3;await this[_0x44a674(0x1e7)][_0x44a674(0x1ca)]()['update'](models_entity_1['ModelsEntity'])[_0x44a674(0x1ee)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>_0x44a674(0x1ab)+_0x57ef06})['where']('id\x20=\x20:id',{'id':_0x5b3314})[_0x44a674(0x1bd)]();}async[_0x17f7d3(0x1f0)](){const _0x5ed125=_0x17f7d3,_0x43450d=await this[_0x5ed125(0x1e7)][_0x5ed125(0x1b6)]({'where':{'isDraw':!![],'status':!![]}});if(!_0x43450d[_0x5ed125(0x1e1)])throw new common_1[(_0x5ed125(0x1c7))]('当前未指定特殊模型KEY、前往后台模型池设置吧！',common_1[_0x5ed125(0x1b5)][_0x5ed125(0x1b8)]);return(0x0,utils_1[_0x5ed125(0x1a4)])(_0x43450d);}async[_0x17f7d3(0x1d4)](){return await this['modelsEntity']['find']();}async[_0x17f7d3(0x1c2)](_0x5338f6){return 0x1;}async[_0x17f7d3(0x1d8)](_0x4dd909){return 0x1;}async[_0x17f7d3(0x1bf)](_0x19ba59){return 0x1;}};ModelsService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(models_entity_1['ModelsEntity'])),__param(0x1,(0x0,typeorm_1[_0x17f7d3(0x1f2)])(modelType_entity_1['ModelsTypeEntity'])),__metadata(_0x17f7d3(0x1fa),[typeorm_2[_0x17f7d3(0x1fc)],typeorm_2[_0x17f7d3(0x1fc)]])],ModelsService),exports[_0x17f7d3(0x1af)]=ModelsService;function _0x5051(){const _0x5a12bf=['当前账号不存在！','parse','getAllKey','lockKey','findAndCount','ModelsMapCn','setModelType','parse\x20error:\x20','map','801270XSDeMH','../../common/utils','12PUSByP','queryModels','model','metadata','length','hideString','val','object','modelsList','defineProperty','modelsEntity','159046VSPCzw','keyList','@nestjs/common','9419110dnMaMy','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','modelsTypeEntity','set','push','getRandomDrawKey','super','InjectRepository','__param','delete','stringify','keyType','__esModule','update','decorate','design:paramtypes','Like','Repository','keyStatus','getRandomItemFromArray','key:\x20','forEach','__metadata','affected','Logger','缺失必要参数！','useToken\x20+\x20','4587984peRgHI','save','function','ModelsService','./models.entity','secret','当前调用模型已经被移除、请重新选择模型！','645001olOhmv','from','HttpStatus','find','15cfgvoe','BAD_REQUEST','typeorm','modelTypes','40jAvmSt','key','execute','error','delModelType','log','saveUseLog','queryModelType','initCalcKey','reduce','modelMaps','keyPoolMap','HttpException','222887kLTnXt','status','createQueryBuilder','1662952CPzGZS','keys','keyPoolIndexMap','__decorate','modelOrder','onModuleInit','findOne'];_0x5051=function(){return _0x5a12bf;};return _0x5051();}