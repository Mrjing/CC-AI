'use strict';const _0x14d035=_0x32be;(function(_0x4cb043,_0x28b46a){const _0x3a9dcb=_0x32be,_0x4806f3=_0x4cb043();while(!![]){try{const _0x127afe=parseInt(_0x3a9dcb(0x1e4))/0x1*(-parseInt(_0x3a9dcb(0x1ef))/0x2)+-parseInt(_0x3a9dcb(0x207))/0x3+-parseInt(_0x3a9dcb(0x212))/0x4+-parseInt(_0x3a9dcb(0x202))/0x5*(parseInt(_0x3a9dcb(0x219))/0x6)+parseInt(_0x3a9dcb(0x1c1))/0x7*(parseInt(_0x3a9dcb(0x215))/0x8)+-parseInt(_0x3a9dcb(0x21e))/0x9*(parseInt(_0x3a9dcb(0x1c9))/0xa)+parseInt(_0x3a9dcb(0x1f4))/0xb*(parseInt(_0x3a9dcb(0x20d))/0xc);if(_0x127afe===_0x28b46a)break;else _0x4806f3['push'](_0x4806f3['shift']());}catch(_0x491a35){_0x4806f3['push'](_0x4806f3['shift']());}}}(_0x4a19,0x54570));var __decorate=this&&this[_0x14d035(0x1cb)]||function(_0x176b98,_0x30c885,_0x57faf2,_0x608e1a){const _0x215523=_0x14d035;var _0x5c089c=arguments['length'],_0xdd8994=_0x5c089c<0x3?_0x30c885:_0x608e1a===null?_0x608e1a=Object[_0x215523(0x1c8)](_0x30c885,_0x57faf2):_0x608e1a,_0x209bd0;if(typeof Reflect==='object'&&typeof Reflect[_0x215523(0x1e9)]===_0x215523(0x1dd))_0xdd8994=Reflect['decorate'](_0x176b98,_0x30c885,_0x57faf2,_0x608e1a);else{for(var _0x32322c=_0x176b98[_0x215523(0x1ff)]-0x1;_0x32322c>=0x0;_0x32322c--)if(_0x209bd0=_0x176b98[_0x32322c])_0xdd8994=(_0x5c089c<0x3?_0x209bd0(_0xdd8994):_0x5c089c>0x3?_0x209bd0(_0x30c885,_0x57faf2,_0xdd8994):_0x209bd0(_0x30c885,_0x57faf2))||_0xdd8994;}return _0x5c089c>0x3&&_0xdd8994&&Object['defineProperty'](_0x30c885,_0x57faf2,_0xdd8994),_0xdd8994;},__metadata=this&&this[_0x14d035(0x218)]||function(_0x4547f6,_0x1ac882){const _0x2ce7a8=_0x14d035;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x2ce7a8(0x1dd))return Reflect[_0x2ce7a8(0x1fa)](_0x4547f6,_0x1ac882);},__param=this&&this[_0x14d035(0x1e3)]||function(_0x5ae186,_0xe11234){return function(_0x5736a3,_0x569970){_0xe11234(_0x5736a3,_0x569970,_0x5ae186);};};Object[_0x14d035(0x205)](exports,_0x14d035(0x1f8),{'value':!![]}),exports[_0x14d035(0x1cf)]=void 0x0;const common_1=require(_0x14d035(0x21c)),typeorm_1=require(_0x14d035(0x220)),typeorm_2=require('typeorm'),models_entity_1=require(_0x14d035(0x1e0)),status_constant_1=require(_0x14d035(0x1fd)),utils_1=require(_0x14d035(0x1dc)),modelType_entity_1=require('./modelType.entity');function _0x32be(_0x1c4f3f,_0x461405){const _0x4a1919=_0x4a19();return _0x32be=function(_0x32bef1,_0x5eed7d){_0x32bef1=_0x32bef1-0x1c1;let _0x155dc0=_0x4a1919[_0x32bef1];return _0x155dc0;},_0x32be(_0x1c4f3f,_0x461405);}let ModelsService=class ModelsService{constructor(_0x3584c4,_0x5170a3){const _0x431da3=_0x14d035;this['modelsEntity']=_0x3584c4,this['modelsTypeEntity']=_0x5170a3,this[_0x431da3(0x213)]=[],this['modelMaps']={},this['keyList']={},this[_0x431da3(0x1f1)]={},this[_0x431da3(0x1d4)]={};}async[_0x14d035(0x203)](){const _0x3bf469=_0x14d035;await this[_0x3bf469(0x1d2)]();}async[_0x14d035(0x1d2)](){const _0x5dd53f=_0x14d035;this[_0x5dd53f(0x1f1)]={},this['keyPoolIndexMap']={},this[_0x5dd53f(0x21b)]={},this[_0x5dd53f(0x1e7)]={},this[_0x5dd53f(0x213)]=[];const _0x39ec95=await this[_0x5dd53f(0x1f0)][_0x5dd53f(0x20e)]({'where':{'status':!![]}}),_0x34c798=_0x39ec95['reduce']((_0x1f10aa,_0x477694)=>{const _0x1dfe66=_0x5dd53f;return!_0x1f10aa[_0x477694[_0x1dfe66(0x201)]]?_0x1f10aa[_0x477694[_0x1dfe66(0x201)]]=[_0x477694]:_0x1f10aa[_0x477694[_0x1dfe66(0x201)]][_0x1dfe66(0x1de)](_0x477694),_0x1f10aa;},{});this[_0x5dd53f(0x213)]=Object['keys'](_0x34c798)[_0x5dd53f(0x1c5)](_0x4b0f14=>{const _0x5a0a09=_0x5dd53f;return{'label':status_constant_1[_0x5a0a09(0x209)][_0x4b0f14],'val':_0x4b0f14};}),this[_0x5dd53f(0x1e7)]=_0x34c798,this[_0x5dd53f(0x21b)]={},_0x39ec95[_0x5dd53f(0x1e2)](_0x2e7dbb=>{const _0x1f8c71=_0x5dd53f,{keyType:_0x2bf674,model:_0x26bb1c,keyWeight:_0x11c4fc}=_0x2e7dbb;if(!this[_0x1f8c71(0x1f1)][_0x26bb1c])this[_0x1f8c71(0x1f1)][_0x26bb1c]=[];for(let _0x143851=0x0;_0x143851<_0x11c4fc;_0x143851++){this[_0x1f8c71(0x1f1)][_0x26bb1c][_0x1f8c71(0x1de)](_0x2e7dbb);}if(!this[_0x1f8c71(0x1d4)][_0x26bb1c])this[_0x1f8c71(0x1d4)][_0x26bb1c]=0x0;if(!this[_0x1f8c71(0x21b)][_0x2bf674])this['keyList'][_0x2bf674]={};if(!this[_0x1f8c71(0x21b)][_0x2bf674][_0x26bb1c])this['keyList'][_0x2bf674][_0x26bb1c]=[];this[_0x1f8c71(0x21b)][_0x2bf674][_0x26bb1c]['push'](_0x2e7dbb);});}async[_0x14d035(0x1d5)](_0x2d99a4,_0x7b9597,_0x2b0525=-0x1){const _0x3df5ad=_0x14d035,_0x1abd18=await this[_0x3df5ad(0x1f0)][_0x3df5ad(0x1fb)]({'id':_0x2d99a4},{'status':![],'keyStatus':_0x2b0525,'remark':_0x7b9597});common_1[_0x3df5ad(0x1f7)][_0x3df5ad(0x1d9)](_0x3df5ad(0x1f6)+_0x2d99a4+'\x20欠费或被官方封禁导致不可用，已被系统自动锁定'),this[_0x3df5ad(0x1d2)]();}async['getCurrentModelKeyInfo'](_0xc97e83){const _0x31583e=_0x14d035;if(!this[_0x31583e(0x1f1)][_0xc97e83])throw new common_1[(_0x31583e(0x214))](_0x31583e(0x217),common_1[_0x31583e(0x1ca)][_0x31583e(0x1cd)]);this[_0x31583e(0x1d4)][_0xc97e83]++;const _0x239122=this[_0x31583e(0x1d4)][_0xc97e83];if(_0x239122>=this[_0x31583e(0x1f1)][_0xc97e83]['length'])this[_0x31583e(0x1d4)][_0xc97e83]=0x0;const _0x214a46=this['keyPoolMap'][_0xc97e83][this[_0x31583e(0x1d4)][_0xc97e83]];return _0x214a46;}async[_0x14d035(0x1c3)](_0x30a070){const _0x1134a9=_0x14d035;if(!this['modelTypes'][_0x1134a9(0x1ff)]||!Object['keys'](this[_0x1134a9(0x1e7)])[_0x1134a9(0x1ff)])return;const _0x1bb1f0=_0x30a070?this[_0x1134a9(0x213)][_0x1134a9(0x20e)](_0x1b74a0=>Number(_0x1b74a0['val'])===0x1):this[_0x1134a9(0x213)][0x0];if(!_0x1bb1f0)return;const {keyType:_0x2260c6,modelName:_0x96895,model:_0x1ac3d2,maxModelTokens:_0x17dcf6,maxResponseTokens:_0x43e1f0,deductType:_0x24d1e8,deduct:_0x580615,maxRounds:_0xfb57b0}=this[_0x1134a9(0x1e7)][_0x1bb1f0[_0x1134a9(0x216)]][0x0];return{'modelTypeInfo':_0x1bb1f0,'modelInfo':{'keyType':_0x2260c6,'modelName':_0x96895,'model':_0x1ac3d2,'maxModelTokens':_0x17dcf6,'maxResponseTokens':_0x43e1f0,'topN':0.8,'systemMessage':'','deductType':_0x24d1e8,'deduct':_0x580615,'maxRounds':_0xfb57b0,'rounds':0x8}};}async[_0x14d035(0x1ee)](_0x4300e5){const _0x257504=_0x14d035;try{const {id:_0x2dc4df}=_0x4300e5;_0x4300e5[_0x257504(0x1ea)]&&(_0x4300e5[_0x257504(0x1f3)]=0x1);if(_0x2dc4df){const _0x53ed8b=await this[_0x257504(0x1f0)]['update']({'id':_0x2dc4df},_0x4300e5);return await this['initCalcKey'](),_0x53ed8b[_0x257504(0x1fe)]>0x0;}else{const {keyType:_0x1205d3,key:_0x58265d}=_0x4300e5;if(Number(_0x1205d3!==0x1)){const _0x3c003d=await this[_0x257504(0x1f0)][_0x257504(0x211)](_0x4300e5);return await this['initCalcKey'](),_0x3c003d;}else{const _0x4514e7=_0x58265d[_0x257504(0x1c5)](_0x5c006c=>{const _0x18e3ce=_0x257504;try{const _0x27d500=JSON[_0x18e3ce(0x1ec)](JSON['stringify'](_0x4300e5));return _0x27d500[_0x18e3ce(0x1e5)]=_0x5c006c,_0x27d500;}catch(_0x32ef3e){console[_0x18e3ce(0x208)](_0x18e3ce(0x1d8),_0x32ef3e);}}),_0x519add=await this['modelsEntity']['save'](_0x4514e7);return await this[_0x257504(0x1d2)](),_0x519add;}}}catch(_0x361615){console['log'](_0x257504(0x1e1),_0x361615);}}async['delModel']({id:_0x598261}){const _0x5d5d9a=_0x14d035;if(!_0x598261)throw new common_1['HttpException'](_0x5d5d9a(0x21d),common_1[_0x5d5d9a(0x1ca)][_0x5d5d9a(0x1cd)]);const _0x4f09c1=await this[_0x5d5d9a(0x1f0)]['findOne']({'where':{'id':_0x598261}});if(!_0x4f09c1)throw new common_1['HttpException']('当前账号不存在！',common_1[_0x5d5d9a(0x1ca)][_0x5d5d9a(0x1cd)]);const _0x4c5830=await this[_0x5d5d9a(0x1f0)][_0x5d5d9a(0x221)]({'id':_0x598261});return await this[_0x5d5d9a(0x1d2)](),_0x4c5830;}async[_0x14d035(0x21a)](_0x2f0da8,_0x2f3dde){const _0xde5d42=_0x14d035,{role:_0x892e30}=_0x2f0da8[_0xde5d42(0x1f2)],{keyType:_0x294be9,key:_0xd7bcd7,status:_0x52a79e,model:_0x328204,page:page=0x1,size:size=0xa}=_0x2f3dde;let _0x208652={};_0x294be9&&(_0x208652['keyType']=_0x294be9),_0x328204&&(_0x208652['model']=_0x328204),_0x52a79e&&(_0x208652['status']=Number(_0x52a79e)===0x1?!![]:![]),_0xd7bcd7&&(_0x208652[_0xde5d42(0x1e5)]=(0x0,typeorm_2[_0xde5d42(0x1d6)])('%'+_0xd7bcd7+'%'));const [_0x2ad056,_0x44fa1c]=await this[_0xde5d42(0x1f0)][_0xde5d42(0x222)]({'where':_0x208652,'order':{'modelOrder':_0xde5d42(0x1c4)},'skip':(page-0x1)*size,'take':size});return _0x892e30!==_0xde5d42(0x1c7)&&_0x2ad056[_0xde5d42(0x1e2)](_0x12344c=>{const _0x4048a6=_0xde5d42;_0x12344c['key']&&(_0x12344c[_0x4048a6(0x1e5)]=(0x0,utils_1[_0x4048a6(0x206)])(_0x12344c[_0x4048a6(0x1e5)])),_0x12344c['secret']&&(_0x12344c[_0x4048a6(0x1da)]=(0x0,utils_1[_0x4048a6(0x206)])(_0x12344c['secret']));}),{'rows':_0x2ad056,'count':_0x44fa1c};}async[_0x14d035(0x1c6)](){const _0x361211=_0x14d035,_0x39177d=JSON[_0x361211(0x1ec)](JSON[_0x361211(0x1c2)](this[_0x361211(0x1e7)]));return Object[_0x361211(0x1ce)](_0x39177d)[_0x361211(0x1e2)](_0x58e836=>{const _0xa22592=_0x361211;_0x39177d[_0x58e836]=_0x39177d[_0x58e836][_0xa22592(0x1d3)]((_0x1077e5,_0x4b8015)=>_0x1077e5[_0xa22592(0x1eb)]-_0x4b8015[_0xa22592(0x1eb)]),_0x39177d[_0x58e836]=Array[_0xa22592(0x20f)](_0x39177d[_0x58e836][_0xa22592(0x1c5)](_0x43797a=>{const {modelName:_0x1884fa,model:_0x56e333,deduct:_0x1014b8,deductType:_0x132aa1,maxRounds:_0x56c86c}=_0x43797a;return{'modelName':_0x1884fa,'model':_0x56e333,'deduct':_0x1014b8,'deductType':_0x132aa1,'maxRounds':_0x56c86c};})[_0xa22592(0x1df)]((_0x2bf078,_0x22a616)=>_0x2bf078[_0xa22592(0x1f5)](_0x22a616[_0xa22592(0x1d0)],_0x22a616),new Map())['values']());}),{'modelTypeList':this[_0x361211(0x213)],'modelMaps':_0x39177d};}async[_0x14d035(0x1e8)](_0x50e615,_0x9f58d5){const _0x44825e=_0x14d035;await this[_0x44825e(0x1f0)][_0x44825e(0x1e6)]()[_0x44825e(0x1fb)](models_entity_1[_0x44825e(0x1d7)])[_0x44825e(0x1f5)]({'useCount':()=>_0x44825e(0x1fc),'useToken':()=>'useToken\x20+\x20'+_0x9f58d5})[_0x44825e(0x200)]('id\x20=\x20:id',{'id':_0x50e615})[_0x44825e(0x21f)]();}async[_0x14d035(0x1cc)](){const _0x34229b=_0x14d035,_0x46d0ee=await this[_0x34229b(0x1f0)][_0x34229b(0x20e)]({'where':{'isDraw':!![],'status':!![]}});if(!_0x46d0ee[_0x34229b(0x1ff)])throw new common_1[(_0x34229b(0x214))]('当前未指定特殊模型KEY、前往后台模型池设置吧！',common_1[_0x34229b(0x1ca)][_0x34229b(0x1cd)]);return(0x0,utils_1[_0x34229b(0x1db)])(_0x46d0ee);}async[_0x14d035(0x1ed)](){const _0xe6893e=_0x14d035;return await this[_0xe6893e(0x1f0)][_0xe6893e(0x20e)]();}async[_0x14d035(0x204)](_0x4b0b63){return 0x1;}async[_0x14d035(0x1d1)](_0x10ac05){return 0x1;}async[_0x14d035(0x20b)](_0x17914e){return 0x1;}};ModelsService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x14d035(0x1f9)])(models_entity_1[_0x14d035(0x1d7)])),__param(0x1,(0x0,typeorm_1[_0x14d035(0x1f9)])(modelType_entity_1[_0x14d035(0x20a)])),__metadata(_0x14d035(0x210),[typeorm_2[_0x14d035(0x20c)],typeorm_2[_0x14d035(0x20c)]])],ModelsService),exports['ModelsService']=ModelsService;function _0x4a19(){const _0x4b119f=['save','741272IVoFYh','modelTypes','HttpException','100400fYemKH','val','当前调用模型已经被移除、请重新选择模型！','__metadata','90gajtht','queryModels','keyList','@nestjs/common','缺失必要参数！','128133taosQL','execute','@nestjs/typeorm','delete','findAndCount','385RCGKVZ','stringify','getBaseConfig','ASC','map','modelsList','super','getOwnPropertyDescriptor','290EVggYq','HttpStatus','__decorate','getRandomDrawKey','BAD_REQUEST','keys','ModelsService','modelName','setModelType','initCalcKey','sort','keyPoolIndexMap','lockKey','Like','ModelsEntity','parse\x20error:\x20','error','secret','getRandomItemFromArray','../../common/utils','function','push','reduce','./models.entity','error:\x20','forEach','__param','3313bmgTuX','key','createQueryBuilder','modelMaps','saveUseLog','decorate','status','modelOrder','parse','getAllKey','setModel','346YKtlpC','modelsEntity','keyPoolMap','user','keyStatus','11WSiPxk','set','key:\x20','Logger','__esModule','InjectRepository','metadata','update','useCount\x20+\x201','../../common/constants/status.constant','affected','length','where','keyType','10665TQhfTO','onModuleInit','queryModelType','defineProperty','hideString','1141623WdYLqT','log','ModelsMapCn','ModelsTypeEntity','delModelType','Repository','14868984RDigSU','find','from','design:paramtypes'];_0x4a19=function(){return _0x4b119f;};return _0x4a19();}