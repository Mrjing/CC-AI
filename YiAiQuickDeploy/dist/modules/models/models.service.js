'use strict';const _0x1961d9=_0x3ec3;(function(_0xe17f01,_0x475f87){const _0x120840=_0x3ec3,_0x383d4b=_0xe17f01();while(!![]){try{const _0x2d9681=-parseInt(_0x120840(0x10e))/0x1+-parseInt(_0x120840(0x129))/0x2*(-parseInt(_0x120840(0x11a))/0x3)+-parseInt(_0x120840(0x11f))/0x4+parseInt(_0x120840(0x156))/0x5*(-parseInt(_0x120840(0x134))/0x6)+-parseInt(_0x120840(0x126))/0x7*(parseInt(_0x120840(0x15a))/0x8)+-parseInt(_0x120840(0x15b))/0x9+parseInt(_0x120840(0x127))/0xa;if(_0x2d9681===_0x475f87)break;else _0x383d4b['push'](_0x383d4b['shift']());}catch(_0x44e3d3){_0x383d4b['push'](_0x383d4b['shift']());}}}(_0x2301,0x92be8));function _0x3ec3(_0x2da4d5,_0x4a565a){const _0x2301ac=_0x2301();return _0x3ec3=function(_0x3ec345,_0x23f338){_0x3ec345=_0x3ec345-0x10e;let _0x3383fa=_0x2301ac[_0x3ec345];return _0x3383fa;},_0x3ec3(_0x2da4d5,_0x4a565a);}var __decorate=this&&this[_0x1961d9(0x165)]||function(_0x4d570f,_0xe8b484,_0xf5471c,_0x2700da){const _0x358807=_0x1961d9;var _0x4d9d25=arguments['length'],_0x54c316=_0x4d9d25<0x3?_0xe8b484:_0x2700da===null?_0x2700da=Object[_0x358807(0x13c)](_0xe8b484,_0xf5471c):_0x2700da,_0x10f5b9;if(typeof Reflect===_0x358807(0x15d)&&typeof Reflect['decorate']==='function')_0x54c316=Reflect['decorate'](_0x4d570f,_0xe8b484,_0xf5471c,_0x2700da);else{for(var _0x1d3cc4=_0x4d570f['length']-0x1;_0x1d3cc4>=0x0;_0x1d3cc4--)if(_0x10f5b9=_0x4d570f[_0x1d3cc4])_0x54c316=(_0x4d9d25<0x3?_0x10f5b9(_0x54c316):_0x4d9d25>0x3?_0x10f5b9(_0xe8b484,_0xf5471c,_0x54c316):_0x10f5b9(_0xe8b484,_0xf5471c))||_0x54c316;}return _0x4d9d25>0x3&&_0x54c316&&Object['defineProperty'](_0xe8b484,_0xf5471c,_0x54c316),_0x54c316;},__metadata=this&&this[_0x1961d9(0x115)]||function(_0x1c98ab,_0x5aa281){const _0x27771f=_0x1961d9;if(typeof Reflect===_0x27771f(0x15d)&&typeof Reflect[_0x27771f(0x13a)]===_0x27771f(0x123))return Reflect['metadata'](_0x1c98ab,_0x5aa281);},__param=this&&this[_0x1961d9(0x141)]||function(_0x3d7706,_0x286062){return function(_0x1f5ab5,_0x2be286){_0x286062(_0x1f5ab5,_0x2be286,_0x3d7706);};};Object[_0x1961d9(0x13f)](exports,'__esModule',{'value':!![]}),exports['ModelsService']=void 0x0;const common_1=require(_0x1961d9(0x122)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x1961d9(0x144)),models_entity_1=require(_0x1961d9(0x10f)),status_constant_1=require(_0x1961d9(0x14b)),utils_1=require('../../common/utils'),modelType_entity_1=require(_0x1961d9(0x12a));function _0x2301(){const _0x19f15d=['lockKey','stringify','metadata','user','getOwnPropertyDescriptor','ModelsEntity','sort','defineProperty','queryModels','__param','modelsList','length','typeorm','parse\x20error:\x20','saveUseLog','execute','save','keyList','useToken\x20+\x20','../../common/constants/status.constant','from','key','update','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','reduce','modelOrder','ASC','parse','ModelsMapCn','当前调用模型已经被移除、请重新选择模型！','171705zpoSjP','delete','BAD_REQUEST','forEach','4796504lHuLAc','2047284fmIMlO','modelsEntity','object','model','set','hideString','缺失必要参数！','findAndCount','createQueryBuilder','HttpException','__decorate','HttpStatus','604703dUGskl','./models.entity','design:paramtypes','map','initCalcKey','delModelType','Logger','__metadata','affected','val','log','setModel','3zYTiuQ','key:\x20','Repository','queryModelType','find','2484288yiSrsn','modelTypes','status','@nestjs/common','function','keys','secret','14hKfAzP','28567240YKHKhJ','InjectRepository','999480zWSJxi','./modelType.entity','push','error','ModelsTypeEntity','modelName','where','keyPoolIndexMap','keyPoolMap','super','keyStatus','18wtzwVF','modelMaps','keyType','modelsTypeEntity'];_0x2301=function(){return _0x19f15d;};return _0x2301();}let ModelsService=class ModelsService{constructor(_0x5ad703,_0x3b94e4){const _0x2665dc=_0x1961d9;this['modelsEntity']=_0x5ad703,this[_0x2665dc(0x137)]=_0x3b94e4,this['modelTypes']=[],this['modelMaps']={},this[_0x2665dc(0x149)]={},this[_0x2665dc(0x131)]={},this[_0x2665dc(0x130)]={};}async['onModuleInit'](){await this['initCalcKey']();}async[_0x1961d9(0x112)](){const _0x472151=_0x1961d9;this['keyPoolMap']={},this[_0x472151(0x130)]={},this[_0x472151(0x149)]={},this[_0x472151(0x135)]={},this[_0x472151(0x120)]=[];const _0x2073e7=await this[_0x472151(0x15c)]['find']({'where':{'status':!![]}}),_0x28adf0=_0x2073e7[_0x472151(0x150)]((_0x4e2a12,_0x155795)=>{const _0x4d99c3=_0x472151;return!_0x4e2a12[_0x155795[_0x4d99c3(0x136)]]?_0x4e2a12[_0x155795['keyType']]=[_0x155795]:_0x4e2a12[_0x155795[_0x4d99c3(0x136)]][_0x4d99c3(0x12b)](_0x155795),_0x4e2a12;},{});this[_0x472151(0x120)]=Object['keys'](_0x28adf0)[_0x472151(0x111)](_0x3ee955=>{const _0x5053d1=_0x472151;return{'label':status_constant_1[_0x5053d1(0x154)][_0x3ee955],'val':_0x3ee955};}),this[_0x472151(0x135)]=_0x28adf0,this['keyList']={},_0x2073e7[_0x472151(0x159)](_0x256285=>{const _0x354c3d=_0x472151,{keyType:_0x28ccd0,model:_0x591f50,keyWeight:_0x27e58e}=_0x256285;if(!this[_0x354c3d(0x131)][_0x591f50])this[_0x354c3d(0x131)][_0x591f50]=[];for(let _0x2ea091=0x0;_0x2ea091<_0x27e58e;_0x2ea091++){this['keyPoolMap'][_0x591f50]['push'](_0x256285);}if(!this[_0x354c3d(0x130)][_0x591f50])this[_0x354c3d(0x130)][_0x591f50]=0x0;if(!this[_0x354c3d(0x149)][_0x28ccd0])this[_0x354c3d(0x149)][_0x28ccd0]={};if(!this[_0x354c3d(0x149)][_0x28ccd0][_0x591f50])this['keyList'][_0x28ccd0][_0x591f50]=[];this[_0x354c3d(0x149)][_0x28ccd0][_0x591f50][_0x354c3d(0x12b)](_0x256285);});}async[_0x1961d9(0x138)](_0x3a5cf8,_0x10d87d,_0x290094=-0x1){const _0x208c70=_0x1961d9,_0x412610=await this['modelsEntity'][_0x208c70(0x14e)]({'id':_0x3a5cf8},{'status':![],'keyStatus':_0x290094,'remark':_0x10d87d});common_1[_0x208c70(0x114)][_0x208c70(0x12c)](_0x208c70(0x11b)+_0x3a5cf8+_0x208c70(0x14f)),this['initCalcKey']();}async['getCurrentModelKeyInfo'](_0x5aeed3){const _0x48d2a4=_0x1961d9;if(!this[_0x48d2a4(0x131)][_0x5aeed3])throw new common_1[(_0x48d2a4(0x164))](_0x48d2a4(0x155),common_1['HttpStatus']['BAD_REQUEST']);this[_0x48d2a4(0x130)][_0x5aeed3]++;const _0x312427=this[_0x48d2a4(0x130)][_0x5aeed3];if(_0x312427>=this['keyPoolMap'][_0x5aeed3][_0x48d2a4(0x143)])this[_0x48d2a4(0x130)][_0x5aeed3]=0x0;const _0x1431d3=this[_0x48d2a4(0x131)][_0x5aeed3][this[_0x48d2a4(0x130)][_0x5aeed3]];return _0x1431d3;}async['getBaseConfig'](_0x3336d9){const _0x38d20a=_0x1961d9;if(!this['modelTypes']['length']||!Object[_0x38d20a(0x124)](this['modelMaps'])['length'])return;const _0x342732=_0x3336d9?this[_0x38d20a(0x120)]['find'](_0x4af493=>Number(_0x4af493[_0x38d20a(0x117)])===0x1):this[_0x38d20a(0x120)][0x0];if(!_0x342732)return;const {keyType:_0x4eb485,modelName:_0x48b653,model:_0x57c54d,maxModelTokens:_0x461067,maxResponseTokens:_0x58ef37,deductType:_0x2486d3,deduct:_0x577ea7,maxRounds:_0x552475}=this[_0x38d20a(0x135)][_0x342732[_0x38d20a(0x117)]][0x0];return{'modelTypeInfo':_0x342732,'modelInfo':{'keyType':_0x4eb485,'modelName':_0x48b653,'model':_0x57c54d,'maxModelTokens':_0x461067,'maxResponseTokens':_0x58ef37,'topN':0.8,'systemMessage':'','deductType':_0x2486d3,'deduct':_0x577ea7,'maxRounds':_0x552475,'rounds':0x8}};}async[_0x1961d9(0x119)](_0x345eee){const _0x346b0c=_0x1961d9;try{const {id:_0x1a8921}=_0x345eee;_0x345eee[_0x346b0c(0x121)]&&(_0x345eee[_0x346b0c(0x133)]=0x1);if(_0x1a8921){const _0x229765=await this[_0x346b0c(0x15c)][_0x346b0c(0x14e)]({'id':_0x1a8921},_0x345eee);return await this[_0x346b0c(0x112)](),_0x229765[_0x346b0c(0x116)]>0x0;}else{const {keyType:_0x28abd,key:_0x3068b5}=_0x345eee;if(Number(_0x28abd!==0x1)){const _0x5941d7=await this[_0x346b0c(0x15c)][_0x346b0c(0x148)](_0x345eee);return await this[_0x346b0c(0x112)](),_0x5941d7;}else{const _0x20131a=_0x3068b5[_0x346b0c(0x111)](_0x130123=>{const _0x554082=_0x346b0c;try{const _0x4e89bf=JSON[_0x554082(0x153)](JSON[_0x554082(0x139)](_0x345eee));return _0x4e89bf[_0x554082(0x14d)]=_0x130123,_0x4e89bf;}catch(_0x4b8a4a){console['log'](_0x554082(0x145),_0x4b8a4a);}}),_0x15f92e=await this[_0x346b0c(0x15c)][_0x346b0c(0x148)](_0x20131a);return await this[_0x346b0c(0x112)](),_0x15f92e;}}}catch(_0x4c6c9c){console[_0x346b0c(0x118)]('error:\x20',_0x4c6c9c);}}async['delModel']({id:_0x4c73e7}){const _0x478ee7=_0x1961d9;if(!_0x4c73e7)throw new common_1[(_0x478ee7(0x164))](_0x478ee7(0x161),common_1[_0x478ee7(0x166)][_0x478ee7(0x158)]);const _0x2555bf=await this[_0x478ee7(0x15c)]['findOne']({'where':{'id':_0x4c73e7}});if(!_0x2555bf)throw new common_1[(_0x478ee7(0x164))]('当前账号不存在！',common_1[_0x478ee7(0x166)][_0x478ee7(0x158)]);const _0x3cbd44=await this[_0x478ee7(0x15c)][_0x478ee7(0x157)]({'id':_0x4c73e7});return await this[_0x478ee7(0x112)](),_0x3cbd44;}async[_0x1961d9(0x140)](_0x33f58b,_0x4dadd9){const _0x46abb4=_0x1961d9,{role:_0x2e64cb}=_0x33f58b[_0x46abb4(0x13b)],{keyType:_0x1c9b46,key:_0xf10036,status:_0xb7e210,model:_0x4162ce,page:page=0x1,size:size=0xa}=_0x4dadd9;let _0xf4c83f={};_0x1c9b46&&(_0xf4c83f['keyType']=_0x1c9b46),_0x4162ce&&(_0xf4c83f[_0x46abb4(0x15e)]=_0x4162ce),_0xb7e210&&(_0xf4c83f['status']=Number(_0xb7e210)===0x1?!![]:![]),_0xf10036&&(_0xf4c83f[_0x46abb4(0x14d)]=(0x0,typeorm_2['Like'])('%'+_0xf10036+'%'));const [_0x287fa1,_0x46b477]=await this[_0x46abb4(0x15c)][_0x46abb4(0x162)]({'where':_0xf4c83f,'order':{'modelOrder':_0x46abb4(0x152)},'skip':(page-0x1)*size,'take':size});return _0x2e64cb!==_0x46abb4(0x132)&&_0x287fa1['forEach'](_0x52f4b8=>{const _0x21b91d=_0x46abb4;_0x52f4b8[_0x21b91d(0x14d)]&&(_0x52f4b8[_0x21b91d(0x14d)]=(0x0,utils_1[_0x21b91d(0x160)])(_0x52f4b8['key'])),_0x52f4b8[_0x21b91d(0x125)]&&(_0x52f4b8[_0x21b91d(0x125)]=(0x0,utils_1[_0x21b91d(0x160)])(_0x52f4b8[_0x21b91d(0x125)]));}),{'rows':_0x287fa1,'count':_0x46b477};}async[_0x1961d9(0x142)](){const _0x47541a=_0x1961d9,_0x1a42c8=JSON[_0x47541a(0x153)](JSON['stringify'](this['modelMaps']));return Object[_0x47541a(0x124)](_0x1a42c8)[_0x47541a(0x159)](_0xb30f=>{const _0x36f11a=_0x47541a;_0x1a42c8[_0xb30f]=_0x1a42c8[_0xb30f][_0x36f11a(0x13e)]((_0x1bdcaa,_0x24648c)=>_0x1bdcaa[_0x36f11a(0x151)]-_0x24648c[_0x36f11a(0x151)]),_0x1a42c8[_0xb30f]=Array[_0x36f11a(0x14c)](_0x1a42c8[_0xb30f]['map'](_0x378b92=>{const {modelName:_0x45ab8f,model:_0x58e274,deduct:_0x3fdaf9,deductType:_0x4ab3ea,maxRounds:_0x10c815}=_0x378b92;return{'modelName':_0x45ab8f,'model':_0x58e274,'deduct':_0x3fdaf9,'deductType':_0x4ab3ea,'maxRounds':_0x10c815};})['reduce']((_0x48f743,_0x15b6fb)=>_0x48f743[_0x36f11a(0x15f)](_0x15b6fb[_0x36f11a(0x12e)],_0x15b6fb),new Map())['values']());}),{'modelTypeList':this[_0x47541a(0x120)],'modelMaps':_0x1a42c8};}async[_0x1961d9(0x146)](_0x399005,_0x50f0b7){const _0x337628=_0x1961d9;await this['modelsEntity'][_0x337628(0x163)]()[_0x337628(0x14e)](models_entity_1['ModelsEntity'])[_0x337628(0x15f)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>_0x337628(0x14a)+_0x50f0b7})[_0x337628(0x12f)]('id\x20=\x20:id',{'id':_0x399005})[_0x337628(0x147)]();}async['getRandomDrawKey'](){const _0x340774=_0x1961d9,_0xbecc30=await this['modelsEntity'][_0x340774(0x11e)]({'where':{'isDraw':!![],'status':!![]}});if(!_0xbecc30[_0x340774(0x143)])throw new common_1['HttpException']('当前未指定特殊模型KEY、前往后台模型池设置吧！',common_1[_0x340774(0x166)]['BAD_REQUEST']);return(0x0,utils_1['getRandomItemFromArray'])(_0xbecc30);}async['getAllKey'](){const _0x495467=_0x1961d9;return await this[_0x495467(0x15c)][_0x495467(0x11e)]();}async[_0x1961d9(0x11d)](_0x31d761){return 0x1;}async['setModelType'](_0x55d1c7){return 0x1;}async[_0x1961d9(0x113)](_0x52416e){return 0x1;}};ModelsService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x1961d9(0x128)])(models_entity_1[_0x1961d9(0x13d)])),__param(0x1,(0x0,typeorm_1[_0x1961d9(0x128)])(modelType_entity_1[_0x1961d9(0x12d)])),__metadata(_0x1961d9(0x110),[typeorm_2[_0x1961d9(0x11c)],typeorm_2[_0x1961d9(0x11c)]])],ModelsService),exports['ModelsService']=ModelsService;