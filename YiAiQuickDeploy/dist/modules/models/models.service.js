'use strict';const _0x5de981=_0x6707;(function(_0xb4e9e2,_0x10fd6c){const _0x393bcf=_0x6707,_0x47b47e=_0xb4e9e2();while(!![]){try{const _0x548973=parseInt(_0x393bcf(0x1b0))/0x1+parseInt(_0x393bcf(0x1aa))/0x2+-parseInt(_0x393bcf(0x1b7))/0x3+parseInt(_0x393bcf(0x1d0))/0x4+parseInt(_0x393bcf(0x1ca))/0x5+-parseInt(_0x393bcf(0x193))/0x6+-parseInt(_0x393bcf(0x1af))/0x7*(parseInt(_0x393bcf(0x1bd))/0x8);if(_0x548973===_0x10fd6c)break;else _0x47b47e['push'](_0x47b47e['shift']());}catch(_0x5857f3){_0x47b47e['push'](_0x47b47e['shift']());}}}(_0x477e,0xe072c));var __decorate=this&&this[_0x5de981(0x1e5)]||function(_0xebe847,_0x2301ce,_0x1adce5,_0x2b3de7){const _0x567efe=_0x5de981;var _0xc40b1=arguments[_0x567efe(0x1d6)],_0x24b49d=_0xc40b1<0x3?_0x2301ce:_0x2b3de7===null?_0x2b3de7=Object[_0x567efe(0x1ab)](_0x2301ce,_0x1adce5):_0x2b3de7,_0x1c611a;if(typeof Reflect===_0x567efe(0x1d8)&&typeof Reflect[_0x567efe(0x1c6)]===_0x567efe(0x1b4))_0x24b49d=Reflect[_0x567efe(0x1c6)](_0xebe847,_0x2301ce,_0x1adce5,_0x2b3de7);else{for(var _0x2a91a7=_0xebe847['length']-0x1;_0x2a91a7>=0x0;_0x2a91a7--)if(_0x1c611a=_0xebe847[_0x2a91a7])_0x24b49d=(_0xc40b1<0x3?_0x1c611a(_0x24b49d):_0xc40b1>0x3?_0x1c611a(_0x2301ce,_0x1adce5,_0x24b49d):_0x1c611a(_0x2301ce,_0x1adce5))||_0x24b49d;}return _0xc40b1>0x3&&_0x24b49d&&Object[_0x567efe(0x192)](_0x2301ce,_0x1adce5,_0x24b49d),_0x24b49d;},__metadata=this&&this[_0x5de981(0x1e1)]||function(_0x316e95,_0x5ed6ef){const _0xa219ca=_0x5de981;if(typeof Reflect==='object'&&typeof Reflect[_0xa219ca(0x1cd)]==='function')return Reflect[_0xa219ca(0x1cd)](_0x316e95,_0x5ed6ef);},__param=this&&this['__param']||function(_0x13ff14,_0x2e0e64){return function(_0x5c1fea,_0x38a815){_0x2e0e64(_0x5c1fea,_0x38a815,_0x13ff14);};};function _0x477e(){const _0x2e1d0c=['当前账号不存在！','keyType','./modelType.entity','from','ModelsTypeEntity','error:\x20','keyStatus','__esModule','id\x20=\x20:id','ASC','当前未指定特殊模型KEY、前往后台模型池设置吧！','stringify','@nestjs/common','keys','defineProperty','10403316KNqUOx','secret','@nestjs/typeorm','createQueryBuilder','当前调用模型已经被移除、请重新选择模型！','queryModels','execute','../../common/utils','key:\x20','reduce','ModelsMapCn','values','setModel','InjectRepository','modelsList','hideString','design:paramtypes','val','error','Injectable','setModelType','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','status','3104520uhZgEE','getOwnPropertyDescriptor','delModelType','findAndCount','log','21FoiTam','675728mFwxfa','modelsEntity','Repository','find','function','lockKey','where','358533HXNphX','queryModelType','keyList','map','modelOrder','parse','3970360FqyHTn','getAllKey','save','affected','ModelsEntity','delete','modelsTypeEntity','set','user','decorate','getRandomDrawKey','HttpException','keyPoolMap','2966195wDjinL','useCount\x20+\x201','key','metadata','BAD_REQUEST','push','5761580kYVDyY','Logger','update','initCalcKey','Like','HttpStatus','length','parse\x20error:\x20','object','keyPoolIndexMap','modelTypes','forEach','ModelsService','modelMaps','model','findOne','delModel','__metadata','../../common/constants/status.constant','getBaseConfig','useToken\x20+\x20','__decorate'];_0x477e=function(){return _0x2e1d0c;};return _0x477e();}function _0x6707(_0x161f8f,_0x2fcd6c){const _0x477ecb=_0x477e();return _0x6707=function(_0x6707a6,_0x1a63b8){_0x6707a6=_0x6707a6-0x18b;let _0x1743f5=_0x477ecb[_0x6707a6];return _0x1743f5;},_0x6707(_0x161f8f,_0x2fcd6c);}Object['defineProperty'](exports,_0x5de981(0x18b),{'value':!![]}),exports['ModelsService']=void 0x0;const common_1=require(_0x5de981(0x190)),typeorm_1=require(_0x5de981(0x195)),typeorm_2=require('typeorm'),models_entity_1=require('./models.entity'),status_constant_1=require(_0x5de981(0x1e2)),utils_1=require(_0x5de981(0x19a)),modelType_entity_1=require(_0x5de981(0x1e8));let ModelsService=class ModelsService{constructor(_0x40ec9f,_0x19b35d){const _0x1320fd=_0x5de981;this['modelsEntity']=_0x40ec9f,this[_0x1320fd(0x1c3)]=_0x19b35d,this['modelTypes']=[],this[_0x1320fd(0x1dd)]={},this[_0x1320fd(0x1b9)]={},this[_0x1320fd(0x1c9)]={},this[_0x1320fd(0x1d9)]={};}async['onModuleInit'](){const _0x2dad03=_0x5de981;await this[_0x2dad03(0x1d3)]();}async[_0x5de981(0x1d3)](){const _0x40047e=_0x5de981;this[_0x40047e(0x1c9)]={},this['keyPoolIndexMap']={},this[_0x40047e(0x1b9)]={},this[_0x40047e(0x1dd)]={},this['modelTypes']=[];const _0x2884d0=await this[_0x40047e(0x1b1)][_0x40047e(0x1b3)]({'where':{'status':!![]}}),_0x3ebafd=_0x2884d0['reduce']((_0x3e1b15,_0x91d445)=>{const _0x172a0b=_0x40047e;return!_0x3e1b15[_0x91d445[_0x172a0b(0x1e7)]]?_0x3e1b15[_0x91d445[_0x172a0b(0x1e7)]]=[_0x91d445]:_0x3e1b15[_0x91d445[_0x172a0b(0x1e7)]][_0x172a0b(0x1cf)](_0x91d445),_0x3e1b15;},{});this[_0x40047e(0x1da)]=Object['keys'](_0x3ebafd)[_0x40047e(0x1ba)](_0x4b7ef4=>{const _0x11ca30=_0x40047e;return{'label':status_constant_1[_0x11ca30(0x19d)][_0x4b7ef4],'val':_0x4b7ef4};}),this[_0x40047e(0x1dd)]=_0x3ebafd,this[_0x40047e(0x1b9)]={},_0x2884d0['forEach'](_0x1430bb=>{const _0x560680=_0x40047e,{keyType:_0x5918f7,model:_0x434e7d,keyWeight:_0x1530fa}=_0x1430bb;if(!this[_0x560680(0x1c9)][_0x434e7d])this[_0x560680(0x1c9)][_0x434e7d]=[];for(let _0x17d759=0x0;_0x17d759<_0x1530fa;_0x17d759++){this['keyPoolMap'][_0x434e7d][_0x560680(0x1cf)](_0x1430bb);}if(!this['keyPoolIndexMap'][_0x434e7d])this[_0x560680(0x1d9)][_0x434e7d]=0x0;if(!this[_0x560680(0x1b9)][_0x5918f7])this['keyList'][_0x5918f7]={};if(!this[_0x560680(0x1b9)][_0x5918f7][_0x434e7d])this[_0x560680(0x1b9)][_0x5918f7][_0x434e7d]=[];this['keyList'][_0x5918f7][_0x434e7d]['push'](_0x1430bb);});}async[_0x5de981(0x1b5)](_0x14a420,_0x36527b,_0x3da290=-0x1){const _0x294c3b=_0x5de981,_0x32cc4e=await this[_0x294c3b(0x1b1)][_0x294c3b(0x1d2)]({'id':_0x14a420},{'status':![],'keyStatus':_0x3da290,'remark':_0x36527b});common_1[_0x294c3b(0x1d1)][_0x294c3b(0x1a5)](_0x294c3b(0x19b)+_0x14a420+_0x294c3b(0x1a8)),this['initCalcKey']();}async['getCurrentModelKeyInfo'](_0x14f623){const _0x16415e=_0x5de981;if(!this[_0x16415e(0x1c9)][_0x14f623])throw new common_1['HttpException'](_0x16415e(0x197),common_1[_0x16415e(0x1d5)][_0x16415e(0x1ce)]);this[_0x16415e(0x1d9)][_0x14f623]++;const _0x570b80=this['keyPoolIndexMap'][_0x14f623];if(_0x570b80>=this[_0x16415e(0x1c9)][_0x14f623]['length'])this[_0x16415e(0x1d9)][_0x14f623]=0x0;const _0x338fea=this[_0x16415e(0x1c9)][_0x14f623][this[_0x16415e(0x1d9)][_0x14f623]];return _0x338fea;}async[_0x5de981(0x1e3)](_0x48e263){const _0x341510=_0x5de981;if(!this[_0x341510(0x1da)][_0x341510(0x1d6)]||!Object[_0x341510(0x191)](this[_0x341510(0x1dd)])['length'])return;const _0x20df4c=_0x48e263?this[_0x341510(0x1da)][_0x341510(0x1b3)](_0x255f7f=>Number(_0x255f7f[_0x341510(0x1a4)])===0x1):this[_0x341510(0x1da)][0x0];if(!_0x20df4c)return;const {keyType:_0x541a8e,modelName:_0x26601c,model:_0x37d3f4,maxModelTokens:_0x1ba26f,maxResponseTokens:_0x217f9b,deductType:_0x157c30,deduct:_0x1d4b7a,maxRounds:_0x2a8f10}=this[_0x341510(0x1dd)][_0x20df4c['val']][0x0];return{'modelTypeInfo':_0x20df4c,'modelInfo':{'keyType':_0x541a8e,'modelName':_0x26601c,'model':_0x37d3f4,'maxModelTokens':_0x1ba26f,'maxResponseTokens':_0x217f9b,'topN':0.8,'systemMessage':'','deductType':_0x157c30,'deduct':_0x1d4b7a,'maxRounds':_0x2a8f10,'rounds':0x8}};}async[_0x5de981(0x19f)](_0xf32bbf){const _0x4ad037=_0x5de981;try{const {id:_0x19b9e8}=_0xf32bbf;_0xf32bbf[_0x4ad037(0x1a9)]&&(_0xf32bbf[_0x4ad037(0x1ec)]=0x1);if(_0x19b9e8){const _0xf0c405=await this[_0x4ad037(0x1b1)][_0x4ad037(0x1d2)]({'id':_0x19b9e8},_0xf32bbf);return await this[_0x4ad037(0x1d3)](),_0xf0c405[_0x4ad037(0x1c0)]>0x0;}else{const {keyType:_0x1e03d8,key:_0x28d187}=_0xf32bbf;if(Number(_0x1e03d8!==0x1)){const _0x2ed785=await this[_0x4ad037(0x1b1)][_0x4ad037(0x1bf)](_0xf32bbf);return await this[_0x4ad037(0x1d3)](),_0x2ed785;}else{const _0x17514e=_0x28d187['map'](_0x2c2269=>{const _0x2dde3a=_0x4ad037;try{const _0x442b71=JSON['parse'](JSON['stringify'](_0xf32bbf));return _0x442b71[_0x2dde3a(0x1cc)]=_0x2c2269,_0x442b71;}catch(_0x5b5109){console[_0x2dde3a(0x1ae)](_0x2dde3a(0x1d7),_0x5b5109);}}),_0x34438c=await this[_0x4ad037(0x1b1)][_0x4ad037(0x1bf)](_0x17514e);return await this[_0x4ad037(0x1d3)](),_0x34438c;}}}catch(_0x4abe82){console[_0x4ad037(0x1ae)](_0x4ad037(0x1eb),_0x4abe82);}}async[_0x5de981(0x1e0)]({id:_0x1753d5}){const _0x45ead0=_0x5de981;if(!_0x1753d5)throw new common_1[(_0x45ead0(0x1c8))]('缺失必要参数！',common_1[_0x45ead0(0x1d5)][_0x45ead0(0x1ce)]);const _0x31d63f=await this[_0x45ead0(0x1b1)][_0x45ead0(0x1df)]({'where':{'id':_0x1753d5}});if(!_0x31d63f)throw new common_1[(_0x45ead0(0x1c8))](_0x45ead0(0x1e6),common_1['HttpStatus'][_0x45ead0(0x1ce)]);const _0x16d2a5=await this[_0x45ead0(0x1b1)][_0x45ead0(0x1c2)]({'id':_0x1753d5});return await this['initCalcKey'](),_0x16d2a5;}async[_0x5de981(0x198)](_0x104d3f,_0x8a722a){const _0x53032c=_0x5de981,{role:_0x34da1b}=_0x104d3f[_0x53032c(0x1c5)],{keyType:_0x3f7677,key:_0x59301b,status:_0x12a598,model:_0x56cf72,page:page=0x1,size:size=0xa}=_0x8a722a;let _0x169745={};_0x3f7677&&(_0x169745[_0x53032c(0x1e7)]=_0x3f7677),_0x56cf72&&(_0x169745[_0x53032c(0x1de)]=_0x56cf72),_0x12a598&&(_0x169745[_0x53032c(0x1a9)]=Number(_0x12a598)===0x1?!![]:![]),_0x59301b&&(_0x169745[_0x53032c(0x1cc)]=(0x0,typeorm_2[_0x53032c(0x1d4)])('%'+_0x59301b+'%'));const [_0x5982b5,_0x152167]=await this['modelsEntity'][_0x53032c(0x1ad)]({'where':_0x169745,'order':{'modelOrder':_0x53032c(0x18d)},'skip':(page-0x1)*size,'take':size});return _0x34da1b!=='super'&&_0x5982b5[_0x53032c(0x1db)](_0x20ec0f=>{const _0x38816c=_0x53032c;_0x20ec0f[_0x38816c(0x1cc)]&&(_0x20ec0f['key']=(0x0,utils_1['hideString'])(_0x20ec0f[_0x38816c(0x1cc)])),_0x20ec0f['secret']&&(_0x20ec0f[_0x38816c(0x194)]=(0x0,utils_1[_0x38816c(0x1a2)])(_0x20ec0f['secret']));}),{'rows':_0x5982b5,'count':_0x152167};}async[_0x5de981(0x1a1)](){const _0xf2a69f=_0x5de981,_0x59c78e=JSON[_0xf2a69f(0x1bc)](JSON[_0xf2a69f(0x18f)](this[_0xf2a69f(0x1dd)]));return Object[_0xf2a69f(0x191)](_0x59c78e)[_0xf2a69f(0x1db)](_0x11f895=>{const _0x1e567f=_0xf2a69f;_0x59c78e[_0x11f895]=_0x59c78e[_0x11f895]['sort']((_0x24998f,_0x5d4aba)=>_0x24998f[_0x1e567f(0x1bb)]-_0x5d4aba['modelOrder']),_0x59c78e[_0x11f895]=Array[_0x1e567f(0x1e9)](_0x59c78e[_0x11f895]['map'](_0x47cc82=>{const {modelName:_0x249a2d,model:_0x18393a,deduct:_0x16d230,deductType:_0x1b96f0,maxRounds:_0x486514}=_0x47cc82;return{'modelName':_0x249a2d,'model':_0x18393a,'deduct':_0x16d230,'deductType':_0x1b96f0,'maxRounds':_0x486514};})[_0x1e567f(0x19c)]((_0x5a6f92,_0x594a10)=>_0x5a6f92[_0x1e567f(0x1c4)](_0x594a10['modelName'],_0x594a10),new Map())[_0x1e567f(0x19e)]());}),{'modelTypeList':this[_0xf2a69f(0x1da)],'modelMaps':_0x59c78e};}async['saveUseLog'](_0x187952,_0x3f6de5){const _0x35fbf9=_0x5de981;await this[_0x35fbf9(0x1b1)][_0x35fbf9(0x196)]()[_0x35fbf9(0x1d2)](models_entity_1[_0x35fbf9(0x1c1)])[_0x35fbf9(0x1c4)]({'useCount':()=>_0x35fbf9(0x1cb),'useToken':()=>_0x35fbf9(0x1e4)+_0x3f6de5})[_0x35fbf9(0x1b6)](_0x35fbf9(0x18c),{'id':_0x187952})[_0x35fbf9(0x199)]();}async[_0x5de981(0x1c7)](){const _0xcf5c85=_0x5de981,_0x46eeed=await this[_0xcf5c85(0x1b1)]['find']({'where':{'isDraw':!![],'status':!![]}});if(!_0x46eeed[_0xcf5c85(0x1d6)])throw new common_1[(_0xcf5c85(0x1c8))](_0xcf5c85(0x18e),common_1[_0xcf5c85(0x1d5)]['BAD_REQUEST']);return(0x0,utils_1['getRandomItemFromArray'])(_0x46eeed);}async[_0x5de981(0x1be)](){const _0x2973f2=_0x5de981;return await this['modelsEntity'][_0x2973f2(0x1b3)]();}async[_0x5de981(0x1b8)](_0x420b34){return 0x1;}async[_0x5de981(0x1a7)](_0x1b1366){return 0x1;}async[_0x5de981(0x1ac)](_0x181209){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0x5de981(0x1a6)])(),__param(0x0,(0x0,typeorm_1[_0x5de981(0x1a0)])(models_entity_1[_0x5de981(0x1c1)])),__param(0x1,(0x0,typeorm_1[_0x5de981(0x1a0)])(modelType_entity_1[_0x5de981(0x1ea)])),__metadata(_0x5de981(0x1a3),[typeorm_2['Repository'],typeorm_2[_0x5de981(0x1b2)]])],ModelsService),exports[_0x5de981(0x1dc)]=ModelsService;