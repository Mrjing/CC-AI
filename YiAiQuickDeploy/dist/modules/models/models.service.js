'use strict';const _0x36ff69=_0x15cb;function _0x15cb(_0x80c33f,_0x122709){const _0x8e3c0d=_0x8e3c();return _0x15cb=function(_0x15cb1a,_0x39541d){_0x15cb1a=_0x15cb1a-0x10a;let _0x1148f9=_0x8e3c0d[_0x15cb1a];return _0x1148f9;},_0x15cb(_0x80c33f,_0x122709);}(function(_0x108d14,_0x2bd159){const _0x389531=_0x15cb,_0x22eb61=_0x108d14();while(!![]){try{const _0x40d4f6=-parseInt(_0x389531(0x12a))/0x1*(parseInt(_0x389531(0x157))/0x2)+-parseInt(_0x389531(0x144))/0x3+-parseInt(_0x389531(0x112))/0x4*(-parseInt(_0x389531(0x10a))/0x5)+-parseInt(_0x389531(0x15d))/0x6+parseInt(_0x389531(0x158))/0x7*(parseInt(_0x389531(0x13e))/0x8)+-parseInt(_0x389531(0x13a))/0x9*(parseInt(_0x389531(0x12b))/0xa)+-parseInt(_0x389531(0x159))/0xb*(-parseInt(_0x389531(0x166))/0xc);if(_0x40d4f6===_0x2bd159)break;else _0x22eb61['push'](_0x22eb61['shift']());}catch(_0x1f4610){_0x22eb61['push'](_0x22eb61['shift']());}}}(_0x8e3c,0xca174));function _0x8e3c(){const _0x10fb98=['length','__esModule','16GdWsQN','./modelType.entity','secret','delete','ModelsEntity','sort','93567LwOqgl','modelTypes','set','createQueryBuilder','Repository','parse','__decorate','Injectable','super','decorate','keys','find','forEach','BAD_REQUEST','function','where','map','modelsTypeEntity','onModuleInit','6uQEXeE','540967jkjwKl','11TLKpCX','values','setModel','useToken\x20+\x20','3942588QZhJqG','from','modelsEntity','hideString','stringify','val','keyPoolIndexMap','key','affected','28647084FhBpgY','HttpException','../../common/constants/status.constant','metadata','5BOGAWu','@nestjs/common','model','modelMaps','当前调用模型已经被移除、请重新选择模型！','initCalcKey','update','keyType','5125752bbMUPR','id\x20=\x20:id','keyList','useCount\x20+\x201','getRandomItemFromArray','getBaseConfig','parse\x20error:\x20','lockKey','Logger','__metadata','push','缺失必要参数！','log','reduce','saveUseLog','@nestjs/typeorm','ModelsTypeEntity','setModelType','__param','user','error','getCurrentModelKeyInfo','getAllKey','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','242167navTdb','350jPkImV','modelsList','InjectRepository','keyPoolMap','ModelsService','status','HttpStatus','ASC','当前未指定特殊模型KEY、前往后台模型池设置吧！','typeorm','object','delModel','findOne','queryModels','当前账号不存在！','406467YoZXmZ','./models.entity'];_0x8e3c=function(){return _0x10fb98;};return _0x8e3c();}var __decorate=this&&this[_0x36ff69(0x14a)]||function(_0x3fffbb,_0xe2802d,_0x22ec2b,_0x3a334c){const _0x17a453=_0x36ff69;var _0xbee357=arguments[_0x17a453(0x13c)],_0x296643=_0xbee357<0x3?_0xe2802d:_0x3a334c===null?_0x3a334c=Object['getOwnPropertyDescriptor'](_0xe2802d,_0x22ec2b):_0x3a334c,_0x90208f;if(typeof Reflect===_0x17a453(0x135)&&typeof Reflect[_0x17a453(0x14d)]===_0x17a453(0x152))_0x296643=Reflect[_0x17a453(0x14d)](_0x3fffbb,_0xe2802d,_0x22ec2b,_0x3a334c);else{for(var _0x191e13=_0x3fffbb[_0x17a453(0x13c)]-0x1;_0x191e13>=0x0;_0x191e13--)if(_0x90208f=_0x3fffbb[_0x191e13])_0x296643=(_0xbee357<0x3?_0x90208f(_0x296643):_0xbee357>0x3?_0x90208f(_0xe2802d,_0x22ec2b,_0x296643):_0x90208f(_0xe2802d,_0x22ec2b))||_0x296643;}return _0xbee357>0x3&&_0x296643&&Object['defineProperty'](_0xe2802d,_0x22ec2b,_0x296643),_0x296643;},__metadata=this&&this[_0x36ff69(0x11b)]||function(_0x584c57,_0x4a70cc){const _0x17ad8f=_0x36ff69;if(typeof Reflect===_0x17ad8f(0x135)&&typeof Reflect['metadata']===_0x17ad8f(0x152))return Reflect[_0x17ad8f(0x169)](_0x584c57,_0x4a70cc);},__param=this&&this[_0x36ff69(0x124)]||function(_0x3b650e,_0x3cc981){return function(_0x571e52,_0x1f56c2){_0x3cc981(_0x571e52,_0x1f56c2,_0x3b650e);};};Object['defineProperty'](exports,_0x36ff69(0x13d),{'value':!![]}),exports[_0x36ff69(0x12f)]=void 0x0;const common_1=require(_0x36ff69(0x10b)),typeorm_1=require(_0x36ff69(0x121)),typeorm_2=require(_0x36ff69(0x134)),models_entity_1=require(_0x36ff69(0x13b)),status_constant_1=require(_0x36ff69(0x168)),utils_1=require('../../common/utils'),modelType_entity_1=require(_0x36ff69(0x13f));let ModelsService=class ModelsService{constructor(_0x25a0b2,_0x170bd2){const _0x2cd8d6=_0x36ff69;this[_0x2cd8d6(0x15f)]=_0x25a0b2,this[_0x2cd8d6(0x155)]=_0x170bd2,this['modelTypes']=[],this['modelMaps']={},this[_0x2cd8d6(0x114)]={},this[_0x2cd8d6(0x12e)]={},this[_0x2cd8d6(0x163)]={};}async[_0x36ff69(0x156)](){const _0x1ea34e=_0x36ff69;await this[_0x1ea34e(0x10f)]();}async[_0x36ff69(0x10f)](){const _0x4af8fa=_0x36ff69;this[_0x4af8fa(0x12e)]={},this[_0x4af8fa(0x163)]={},this['keyList']={},this[_0x4af8fa(0x10d)]={},this[_0x4af8fa(0x145)]=[];const _0xf2bee9=await this['modelsEntity'][_0x4af8fa(0x14f)]({'where':{'status':!![]}}),_0x39fd42=_0xf2bee9[_0x4af8fa(0x11f)]((_0x55b208,_0x35bdd0)=>{const _0x52807d=_0x4af8fa;return!_0x55b208[_0x35bdd0[_0x52807d(0x111)]]?_0x55b208[_0x35bdd0[_0x52807d(0x111)]]=[_0x35bdd0]:_0x55b208[_0x35bdd0[_0x52807d(0x111)]][_0x52807d(0x11c)](_0x35bdd0),_0x55b208;},{});this[_0x4af8fa(0x145)]=Object['keys'](_0x39fd42)[_0x4af8fa(0x154)](_0x5eecb4=>{return{'label':status_constant_1['ModelsMapCn'][_0x5eecb4],'val':_0x5eecb4};}),this[_0x4af8fa(0x10d)]=_0x39fd42,this['keyList']={},_0xf2bee9[_0x4af8fa(0x150)](_0x1d61d1=>{const _0x3e81f6=_0x4af8fa,{keyType:_0x99bd72,model:_0x34c616,keyWeight:_0x53a91e}=_0x1d61d1;if(!this[_0x3e81f6(0x12e)][_0x34c616])this[_0x3e81f6(0x12e)][_0x34c616]=[];for(let _0x4de31e=0x0;_0x4de31e<_0x53a91e;_0x4de31e++){this[_0x3e81f6(0x12e)][_0x34c616]['push'](_0x1d61d1);}if(!this['keyPoolIndexMap'][_0x34c616])this[_0x3e81f6(0x163)][_0x34c616]=0x0;if(!this[_0x3e81f6(0x114)][_0x99bd72])this[_0x3e81f6(0x114)][_0x99bd72]={};if(!this[_0x3e81f6(0x114)][_0x99bd72][_0x34c616])this[_0x3e81f6(0x114)][_0x99bd72][_0x34c616]=[];this['keyList'][_0x99bd72][_0x34c616]['push'](_0x1d61d1);});}async[_0x36ff69(0x119)](_0xde214a,_0x3d5662,_0xc33f96=-0x1){const _0x36aca4=_0x36ff69,_0x450e14=await this[_0x36aca4(0x15f)][_0x36aca4(0x110)]({'id':_0xde214a},{'status':![],'keyStatus':_0xc33f96,'remark':_0x3d5662});common_1[_0x36aca4(0x11a)][_0x36aca4(0x126)]('key:\x20'+_0xde214a+_0x36aca4(0x129)),this[_0x36aca4(0x10f)]();}async[_0x36ff69(0x127)](_0x16c020){const _0x1dfbf9=_0x36ff69;if(!this[_0x1dfbf9(0x12e)][_0x16c020])throw new common_1['HttpException'](_0x1dfbf9(0x10e),common_1[_0x1dfbf9(0x131)][_0x1dfbf9(0x151)]);this[_0x1dfbf9(0x163)][_0x16c020]++;const _0x2f3cff=this[_0x1dfbf9(0x163)][_0x16c020];if(_0x2f3cff>=this[_0x1dfbf9(0x12e)][_0x16c020][_0x1dfbf9(0x13c)])this['keyPoolIndexMap'][_0x16c020]=0x0;const _0x2aaeff=this[_0x1dfbf9(0x12e)][_0x16c020][this[_0x1dfbf9(0x163)][_0x16c020]];return _0x2aaeff;}async[_0x36ff69(0x117)](_0xf221d2){const _0x11a221=_0x36ff69;if(!this['modelTypes'][_0x11a221(0x13c)]||!Object[_0x11a221(0x14e)](this['modelMaps'])['length'])return;const _0x459466=_0xf221d2?this[_0x11a221(0x145)][_0x11a221(0x14f)](_0x304bf6=>Number(_0x304bf6[_0x11a221(0x162)])===0x1):this[_0x11a221(0x145)][0x0];if(!_0x459466)return;const {keyType:_0x5abb6a,modelName:_0x1d5e13,model:_0x326501,maxModelTokens:_0x5f2968,maxResponseTokens:_0x1a9354,deductType:_0x13564e,deduct:_0x20d106,maxRounds:_0x5b5da3}=this['modelMaps'][_0x459466[_0x11a221(0x162)]][0x0];return{'modelTypeInfo':_0x459466,'modelInfo':{'keyType':_0x5abb6a,'modelName':_0x1d5e13,'model':_0x326501,'maxModelTokens':_0x5f2968,'maxResponseTokens':_0x1a9354,'topN':0.8,'systemMessage':'','deductType':_0x13564e,'deduct':_0x20d106,'maxRounds':_0x5b5da3,'rounds':0x8}};}async[_0x36ff69(0x15b)](_0x692de4){const _0x5537c7=_0x36ff69;try{const {id:_0x1350f4}=_0x692de4;_0x692de4['status']&&(_0x692de4['keyStatus']=0x1);if(_0x1350f4){const _0x179550=await this[_0x5537c7(0x15f)][_0x5537c7(0x110)]({'id':_0x1350f4},_0x692de4);return await this['initCalcKey'](),_0x179550[_0x5537c7(0x165)]>0x0;}else{const {keyType:_0xb9010b,key:_0x286a4f}=_0x692de4;if(Number(_0xb9010b!==0x1)){const _0x1d4741=await this[_0x5537c7(0x15f)]['save'](_0x692de4);return await this[_0x5537c7(0x10f)](),_0x1d4741;}else{const _0x1aedf2=_0x286a4f[_0x5537c7(0x154)](_0x254b6d=>{const _0x21e18f=_0x5537c7;try{const _0x1d457e=JSON[_0x21e18f(0x149)](JSON[_0x21e18f(0x161)](_0x692de4));return _0x1d457e['key']=_0x254b6d,_0x1d457e;}catch(_0x69e326){console[_0x21e18f(0x11e)](_0x21e18f(0x118),_0x69e326);}}),_0xaf50e6=await this[_0x5537c7(0x15f)]['save'](_0x1aedf2);return await this['initCalcKey'](),_0xaf50e6;}}}catch(_0x76df1f){console[_0x5537c7(0x11e)]('error:\x20',_0x76df1f);}}async[_0x36ff69(0x136)]({id:_0x52d785}){const _0x3ce8ad=_0x36ff69;if(!_0x52d785)throw new common_1[(_0x3ce8ad(0x167))](_0x3ce8ad(0x11d),common_1[_0x3ce8ad(0x131)][_0x3ce8ad(0x151)]);const _0x36e810=await this[_0x3ce8ad(0x15f)][_0x3ce8ad(0x137)]({'where':{'id':_0x52d785}});if(!_0x36e810)throw new common_1[(_0x3ce8ad(0x167))](_0x3ce8ad(0x139),common_1['HttpStatus']['BAD_REQUEST']);const _0x345dd4=await this[_0x3ce8ad(0x15f)][_0x3ce8ad(0x141)]({'id':_0x52d785});return await this[_0x3ce8ad(0x10f)](),_0x345dd4;}async[_0x36ff69(0x138)](_0x5c7459,_0x57775c){const _0x138678=_0x36ff69,{role:_0x3421ca}=_0x5c7459[_0x138678(0x125)],{keyType:_0x4ed670,key:_0x1e9414,status:_0x2e65f3,model:_0x49f4c1,page:page=0x1,size:size=0xa}=_0x57775c;let _0x3993f6={};_0x4ed670&&(_0x3993f6['keyType']=_0x4ed670),_0x49f4c1&&(_0x3993f6[_0x138678(0x10c)]=_0x49f4c1),_0x2e65f3&&(_0x3993f6[_0x138678(0x130)]=Number(_0x2e65f3)===0x1?!![]:![]),_0x1e9414&&(_0x3993f6[_0x138678(0x164)]=(0x0,typeorm_2['Like'])('%'+_0x1e9414+'%'));const [_0x2a76c6,_0xf09038]=await this[_0x138678(0x15f)]['findAndCount']({'where':_0x3993f6,'order':{'modelOrder':_0x138678(0x132)},'skip':(page-0x1)*size,'take':size});return _0x3421ca!==_0x138678(0x14c)&&_0x2a76c6[_0x138678(0x150)](_0x567108=>{const _0xcfffa3=_0x138678;_0x567108[_0xcfffa3(0x164)]&&(_0x567108[_0xcfffa3(0x164)]=(0x0,utils_1[_0xcfffa3(0x160)])(_0x567108[_0xcfffa3(0x164)])),_0x567108[_0xcfffa3(0x140)]&&(_0x567108[_0xcfffa3(0x140)]=(0x0,utils_1[_0xcfffa3(0x160)])(_0x567108[_0xcfffa3(0x140)]));}),{'rows':_0x2a76c6,'count':_0xf09038};}async[_0x36ff69(0x12c)](){const _0x5be796=_0x36ff69,_0x548d3a=JSON['parse'](JSON[_0x5be796(0x161)](this[_0x5be796(0x10d)]));return Object[_0x5be796(0x14e)](_0x548d3a)[_0x5be796(0x150)](_0x3e4814=>{const _0x57b84d=_0x5be796;_0x548d3a[_0x3e4814]=_0x548d3a[_0x3e4814][_0x57b84d(0x143)]((_0x4bfccf,_0xffa8)=>_0x4bfccf['modelOrder']-_0xffa8['modelOrder']),_0x548d3a[_0x3e4814]=Array[_0x57b84d(0x15e)](_0x548d3a[_0x3e4814]['map'](_0x1e6ed7=>{const {modelName:_0x3d0892,model:_0x4a7601,deduct:_0x27aee0,deductType:_0x4a4d2a,maxRounds:_0x1ad321}=_0x1e6ed7;return{'modelName':_0x3d0892,'model':_0x4a7601,'deduct':_0x27aee0,'deductType':_0x4a4d2a,'maxRounds':_0x1ad321};})[_0x57b84d(0x11f)]((_0x9092d5,_0x57e010)=>_0x9092d5[_0x57b84d(0x146)](_0x57e010['modelName'],_0x57e010),new Map())[_0x57b84d(0x15a)]());}),{'modelTypeList':this[_0x5be796(0x145)],'modelMaps':_0x548d3a};}async[_0x36ff69(0x120)](_0x2cc66d,_0x442a2a){const _0x1e6430=_0x36ff69;await this[_0x1e6430(0x15f)][_0x1e6430(0x147)]()[_0x1e6430(0x110)](models_entity_1['ModelsEntity'])['set']({'useCount':()=>_0x1e6430(0x115),'useToken':()=>_0x1e6430(0x15c)+_0x442a2a})[_0x1e6430(0x153)](_0x1e6430(0x113),{'id':_0x2cc66d})['execute']();}async['getRandomDrawKey'](){const _0x341df6=_0x36ff69,_0x38c89=await this[_0x341df6(0x15f)][_0x341df6(0x14f)]({'where':{'isDraw':!![],'status':!![]}});if(!_0x38c89[_0x341df6(0x13c)])throw new common_1['HttpException'](_0x341df6(0x133),common_1[_0x341df6(0x131)]['BAD_REQUEST']);return(0x0,utils_1[_0x341df6(0x116)])(_0x38c89);}async[_0x36ff69(0x128)](){const _0x350307=_0x36ff69;return await this[_0x350307(0x15f)][_0x350307(0x14f)]();}async['queryModelType'](_0x3f8e07){return 0x1;}async[_0x36ff69(0x123)](_0x2865a8){return 0x1;}async['delModelType'](_0x189cdd){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0x36ff69(0x14b)])(),__param(0x0,(0x0,typeorm_1[_0x36ff69(0x12d)])(models_entity_1[_0x36ff69(0x142)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(modelType_entity_1[_0x36ff69(0x122)])),__metadata('design:paramtypes',[typeorm_2[_0x36ff69(0x148)],typeorm_2[_0x36ff69(0x148)]])],ModelsService),exports[_0x36ff69(0x12f)]=ModelsService;