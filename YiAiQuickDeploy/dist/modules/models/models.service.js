'use strict';const _0x1558cf=_0x3e57;(function(_0x633a90,_0x5e947f){const _0x5e5c93=_0x3e57,_0x2c33cd=_0x633a90();while(!![]){try{const _0xd5d0ce=parseInt(_0x5e5c93(0x6a))/0x1*(parseInt(_0x5e5c93(0x7a))/0x2)+-parseInt(_0x5e5c93(0x82))/0x3+parseInt(_0x5e5c93(0xab))/0x4+parseInt(_0x5e5c93(0x6d))/0x5+-parseInt(_0x5e5c93(0x9a))/0x6*(parseInt(_0x5e5c93(0x85))/0x7)+parseInt(_0x5e5c93(0x73))/0x8*(parseInt(_0x5e5c93(0x86))/0x9)+-parseInt(_0x5e5c93(0x96))/0xa;if(_0xd5d0ce===_0x5e947f)break;else _0x2c33cd['push'](_0x2c33cd['shift']());}catch(_0xfb0253){_0x2c33cd['push'](_0x2c33cd['shift']());}}}(_0x2e48,0x41f77));var __decorate=this&&this[_0x1558cf(0x97)]||function(_0x5c553e,_0x38f453,_0x2d3e53,_0x1f0df6){const _0x3376e8=_0x1558cf;var _0x29939f=arguments['length'],_0x53f37e=_0x29939f<0x3?_0x38f453:_0x1f0df6===null?_0x1f0df6=Object['getOwnPropertyDescriptor'](_0x38f453,_0x2d3e53):_0x1f0df6,_0x19e13d;if(typeof Reflect===_0x3376e8(0x89)&&typeof Reflect[_0x3376e8(0xa7)]==='function')_0x53f37e=Reflect[_0x3376e8(0xa7)](_0x5c553e,_0x38f453,_0x2d3e53,_0x1f0df6);else{for(var _0x3c1f5f=_0x5c553e[_0x3376e8(0x87)]-0x1;_0x3c1f5f>=0x0;_0x3c1f5f--)if(_0x19e13d=_0x5c553e[_0x3c1f5f])_0x53f37e=(_0x29939f<0x3?_0x19e13d(_0x53f37e):_0x29939f>0x3?_0x19e13d(_0x38f453,_0x2d3e53,_0x53f37e):_0x19e13d(_0x38f453,_0x2d3e53))||_0x53f37e;}return _0x29939f>0x3&&_0x53f37e&&Object[_0x3376e8(0x92)](_0x38f453,_0x2d3e53,_0x53f37e),_0x53f37e;},__metadata=this&&this[_0x1558cf(0xc3)]||function(_0x4d54d6,_0x388d35){const _0x540bc5=_0x1558cf;if(typeof Reflect==='object'&&typeof Reflect[_0x540bc5(0xbd)]==='function')return Reflect[_0x540bc5(0xbd)](_0x4d54d6,_0x388d35);},__param=this&&this[_0x1558cf(0x71)]||function(_0x3fbd31,_0x3639f7){return function(_0x3619e3,_0x462ab1){_0x3639f7(_0x3619e3,_0x462ab1,_0x3fbd31);};};Object[_0x1558cf(0x92)](exports,'__esModule',{'value':!![]}),exports['ModelsService']=void 0x0;function _0x2e48(){const _0x3d843a=['@nestjs/common','8dUPQLp','setModelType','delete','user','modelOrder','hideString','delModel','useToken\x20+\x20','476028XXvioe','modelName','当前账号不存在！','287QQkXQP','884097FkeYBv','length','ModelsTypeEntity','object','values','modelsEntity','keyPoolMap','ModelsEntity','push','ModelsMapCn','getCurrentModelKeyInfo','where','defineProperty','parse\x20error:\x20','modelsTypeEntity','keyType','6203650UhXtDk','__decorate','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','modelsList','18150toGngf','modelMaps','stringify','error','delModelType','keyStatus','findOne','useCount\x20+\x201','status','缺失必要参数！','sort','save','affected','decorate','getRandomItemFromArray','ASC','onModuleInit','312652qQiSpQ','setModel','keys','set','val','parse','typeorm','keyPoolIndexMap','find','getRandomDrawKey','forEach','model','InjectRepository','../../common/constants/status.constant','reduce','BAD_REQUEST','ModelsService','./models.entity','metadata','execute','queryModels','design:paramtypes','当前调用模型已经被移除、请重新选择模型！','secret','__metadata','queryModelType','key','@nestjs/typeorm','update','initCalcKey','Logger','HttpException','modelTypes','133999zQMPZE','getBaseConfig','Repository','1322035TKhBTI','Injectable','map','keyList','__param','log','24bxcGSi','findAndCount','HttpStatus','lockKey','key:\x20','from'];_0x2e48=function(){return _0x3d843a;};return _0x2e48();}const common_1=require(_0x1558cf(0x79)),typeorm_1=require(_0x1558cf(0xc6)),typeorm_2=require(_0x1558cf(0xb1)),models_entity_1=require(_0x1558cf(0xbc)),status_constant_1=require(_0x1558cf(0xb8)),utils_1=require('../../common/utils'),modelType_entity_1=require('./modelType.entity');let ModelsService=class ModelsService{constructor(_0x140940,_0x3cf57d){const _0x47b21c=_0x1558cf;this[_0x47b21c(0x8b)]=_0x140940,this[_0x47b21c(0x94)]=_0x3cf57d,this['modelTypes']=[],this['modelMaps']={},this['keyList']={},this[_0x47b21c(0x8c)]={},this[_0x47b21c(0xb2)]={};}async[_0x1558cf(0xaa)](){const _0x5042fc=_0x1558cf;await this[_0x5042fc(0x66)]();}async[_0x1558cf(0x66)](){const _0x73d149=_0x1558cf;this[_0x73d149(0x8c)]={},this[_0x73d149(0xb2)]={},this[_0x73d149(0x70)]={},this[_0x73d149(0x9b)]={},this[_0x73d149(0x69)]=[];const _0x1952bb=await this[_0x73d149(0x8b)][_0x73d149(0xb3)]({'where':{'status':!![]}}),_0x7a79d6=_0x1952bb[_0x73d149(0xb9)]((_0x3fd927,_0x1ce8f8)=>{const _0x183811=_0x73d149;return!_0x3fd927[_0x1ce8f8[_0x183811(0x95)]]?_0x3fd927[_0x1ce8f8[_0x183811(0x95)]]=[_0x1ce8f8]:_0x3fd927[_0x1ce8f8[_0x183811(0x95)]][_0x183811(0x8e)](_0x1ce8f8),_0x3fd927;},{});this[_0x73d149(0x69)]=Object[_0x73d149(0xad)](_0x7a79d6)['map'](_0x15e929=>{const _0xd8dc80=_0x73d149;return{'label':status_constant_1[_0xd8dc80(0x8f)][_0x15e929],'val':_0x15e929};}),this[_0x73d149(0x9b)]=_0x7a79d6,this[_0x73d149(0x70)]={},_0x1952bb[_0x73d149(0xb5)](_0x47c8af=>{const _0x2499ad=_0x73d149,{keyType:_0x3be461,model:_0x17a6df,keyWeight:_0x3933c9}=_0x47c8af;if(!this[_0x2499ad(0x8c)][_0x17a6df])this[_0x2499ad(0x8c)][_0x17a6df]=[];for(let _0x2b2edb=0x0;_0x2b2edb<_0x3933c9;_0x2b2edb++){this[_0x2499ad(0x8c)][_0x17a6df][_0x2499ad(0x8e)](_0x47c8af);}if(!this[_0x2499ad(0xb2)][_0x17a6df])this[_0x2499ad(0xb2)][_0x17a6df]=0x0;if(!this[_0x2499ad(0x70)][_0x3be461])this[_0x2499ad(0x70)][_0x3be461]={};if(!this['keyList'][_0x3be461][_0x17a6df])this[_0x2499ad(0x70)][_0x3be461][_0x17a6df]=[];this[_0x2499ad(0x70)][_0x3be461][_0x17a6df][_0x2499ad(0x8e)](_0x47c8af);});}async[_0x1558cf(0x76)](_0x3fee26,_0x24f58a,_0x45dd2b=-0x1){const _0x1a7159=_0x1558cf,_0x39bdbf=await this['modelsEntity'][_0x1a7159(0xc7)]({'id':_0x3fee26},{'status':![],'keyStatus':_0x45dd2b,'remark':_0x24f58a});common_1[_0x1a7159(0x67)][_0x1a7159(0x9d)](_0x1a7159(0x77)+_0x3fee26+_0x1a7159(0x98)),this[_0x1a7159(0x66)]();}async[_0x1558cf(0x90)](_0x1d11f4){const _0x526af2=_0x1558cf;if(!this[_0x526af2(0x8c)][_0x1d11f4])throw new common_1['HttpException'](_0x526af2(0xc1),common_1[_0x526af2(0x75)][_0x526af2(0xba)]);this[_0x526af2(0xb2)][_0x1d11f4]++;const _0x4b571b=this[_0x526af2(0xb2)][_0x1d11f4];if(_0x4b571b>=this[_0x526af2(0x8c)][_0x1d11f4][_0x526af2(0x87)])this[_0x526af2(0xb2)][_0x1d11f4]=0x0;const _0x41cc7d=this[_0x526af2(0x8c)][_0x1d11f4][this[_0x526af2(0xb2)][_0x1d11f4]];return _0x41cc7d;}async[_0x1558cf(0x6b)](_0x551265){const _0x50edf1=_0x1558cf;if(!this[_0x50edf1(0x69)]['length']||!Object[_0x50edf1(0xad)](this[_0x50edf1(0x9b)])[_0x50edf1(0x87)])return;const _0x2cfe0e=_0x551265?this['modelTypes'][_0x50edf1(0xb3)](_0x5ba3b9=>Number(_0x5ba3b9[_0x50edf1(0xaf)])===0x1):this[_0x50edf1(0x69)][0x0];if(!_0x2cfe0e)return;const {keyType:_0x27123c,modelName:_0x54c3e8,model:_0x186bd9,maxModelTokens:_0x1ecaaa,maxResponseTokens:_0x437585,deductType:_0x19fb25,deduct:_0x3e0946,maxRounds:_0x12b57b}=this['modelMaps'][_0x2cfe0e[_0x50edf1(0xaf)]][0x0];return{'modelTypeInfo':_0x2cfe0e,'modelInfo':{'keyType':_0x27123c,'modelName':_0x54c3e8,'model':_0x186bd9,'maxModelTokens':_0x1ecaaa,'maxResponseTokens':_0x437585,'topN':0.8,'systemMessage':'','deductType':_0x19fb25,'deduct':_0x3e0946,'maxRounds':_0x12b57b,'rounds':0x8}};}async[_0x1558cf(0xac)](_0x1d428c){const _0x431404=_0x1558cf;try{const {id:_0x4f72b3}=_0x1d428c;_0x1d428c[_0x431404(0xa2)]&&(_0x1d428c[_0x431404(0x9f)]=0x1);if(_0x4f72b3){const _0x371e4b=await this[_0x431404(0x8b)][_0x431404(0xc7)]({'id':_0x4f72b3},_0x1d428c);return await this[_0x431404(0x66)](),_0x371e4b[_0x431404(0xa6)]>0x0;}else{const {keyType:_0xfcfd9a,key:_0x2e8019}=_0x1d428c;if(Number(_0xfcfd9a!==0x1)){const _0x48637d=await this[_0x431404(0x8b)][_0x431404(0xa5)](_0x1d428c);return await this['initCalcKey'](),_0x48637d;}else{const _0x32a21b=_0x2e8019['map'](_0x2ddcae=>{const _0x7aedfd=_0x431404;try{const _0xd054bb=JSON['parse'](JSON[_0x7aedfd(0x9c)](_0x1d428c));return _0xd054bb[_0x7aedfd(0xc5)]=_0x2ddcae,_0xd054bb;}catch(_0x59d986){console[_0x7aedfd(0x72)](_0x7aedfd(0x93),_0x59d986);}}),_0x2d116d=await this[_0x431404(0x8b)][_0x431404(0xa5)](_0x32a21b);return await this[_0x431404(0x66)](),_0x2d116d;}}}catch(_0x43ef24){console[_0x431404(0x72)]('error:\x20',_0x43ef24);}}async[_0x1558cf(0x80)]({id:_0x418642}){const _0x405bf7=_0x1558cf;if(!_0x418642)throw new common_1['HttpException'](_0x405bf7(0xa3),common_1[_0x405bf7(0x75)]['BAD_REQUEST']);const _0x1378be=await this[_0x405bf7(0x8b)][_0x405bf7(0xa0)]({'where':{'id':_0x418642}});if(!_0x1378be)throw new common_1[(_0x405bf7(0x68))](_0x405bf7(0x84),common_1[_0x405bf7(0x75)][_0x405bf7(0xba)]);const _0x10f5ca=await this[_0x405bf7(0x8b)][_0x405bf7(0x7c)]({'id':_0x418642});return await this[_0x405bf7(0x66)](),_0x10f5ca;}async[_0x1558cf(0xbf)](_0x3763e5,_0x1142be){const _0x3fcb2a=_0x1558cf,{role:_0x5a93d7}=_0x3763e5[_0x3fcb2a(0x7d)],{keyType:_0x4be316,key:_0x311867,status:_0xcaa99b,model:_0x203dd4,page:page=0x1,size:size=0xa}=_0x1142be;let _0x20eb75={};_0x4be316&&(_0x20eb75[_0x3fcb2a(0x95)]=_0x4be316),_0x203dd4&&(_0x20eb75[_0x3fcb2a(0xb6)]=_0x203dd4),_0xcaa99b&&(_0x20eb75[_0x3fcb2a(0xa2)]=Number(_0xcaa99b)===0x1?!![]:![]),_0x311867&&(_0x20eb75[_0x3fcb2a(0xc5)]=(0x0,typeorm_2['Like'])('%'+_0x311867+'%'));const [_0x56f128,_0x2a0a98]=await this[_0x3fcb2a(0x8b)][_0x3fcb2a(0x74)]({'where':_0x20eb75,'order':{'modelOrder':_0x3fcb2a(0xa9)},'skip':(page-0x1)*size,'take':size});return _0x5a93d7!=='super'&&_0x56f128['forEach'](_0x2858c6=>{const _0x1784de=_0x3fcb2a;_0x2858c6[_0x1784de(0xc5)]&&(_0x2858c6[_0x1784de(0xc5)]=(0x0,utils_1[_0x1784de(0x7f)])(_0x2858c6[_0x1784de(0xc5)])),_0x2858c6[_0x1784de(0xc2)]&&(_0x2858c6[_0x1784de(0xc2)]=(0x0,utils_1['hideString'])(_0x2858c6[_0x1784de(0xc2)]));}),{'rows':_0x56f128,'count':_0x2a0a98};}async[_0x1558cf(0x99)](){const _0x55f604=_0x1558cf,_0x2f1413=JSON[_0x55f604(0xb0)](JSON[_0x55f604(0x9c)](this[_0x55f604(0x9b)]));return Object[_0x55f604(0xad)](_0x2f1413)[_0x55f604(0xb5)](_0x29b44e=>{const _0x264539=_0x55f604;_0x2f1413[_0x29b44e]=_0x2f1413[_0x29b44e][_0x264539(0xa4)]((_0xc0ae49,_0x2ff85e)=>_0xc0ae49[_0x264539(0x7e)]-_0x2ff85e[_0x264539(0x7e)]),_0x2f1413[_0x29b44e]=Array[_0x264539(0x78)](_0x2f1413[_0x29b44e][_0x264539(0x6f)](_0x54c9b2=>{const {modelName:_0x49a924,model:_0x17cedc,deduct:_0x99e1e1,deductType:_0x4d2748,maxRounds:_0x41a3a7}=_0x54c9b2;return{'modelName':_0x49a924,'model':_0x17cedc,'deduct':_0x99e1e1,'deductType':_0x4d2748,'maxRounds':_0x41a3a7};})[_0x264539(0xb9)]((_0x551630,_0x1b29e9)=>_0x551630[_0x264539(0xae)](_0x1b29e9[_0x264539(0x83)],_0x1b29e9),new Map())[_0x264539(0x8a)]());}),{'modelTypeList':this[_0x55f604(0x69)],'modelMaps':_0x2f1413};}async['saveUseLog'](_0x122150,_0x579492){const _0x459191=_0x1558cf;await this[_0x459191(0x8b)]['createQueryBuilder']()[_0x459191(0xc7)](models_entity_1[_0x459191(0x8d)])['set']({'useCount':()=>_0x459191(0xa1),'useToken':()=>_0x459191(0x81)+_0x579492})[_0x459191(0x91)]('id\x20=\x20:id',{'id':_0x122150})[_0x459191(0xbe)]();}async[_0x1558cf(0xb4)](){const _0xec5337=_0x1558cf,_0x4135eb=await this[_0xec5337(0x8b)]['find']({'where':{'isDraw':!![],'status':!![]}});if(!_0x4135eb[_0xec5337(0x87)])throw new common_1[(_0xec5337(0x68))]('当前未指定特殊模型KEY、前往后台模型池设置吧！',common_1[_0xec5337(0x75)][_0xec5337(0xba)]);return(0x0,utils_1[_0xec5337(0xa8)])(_0x4135eb);}async['getAllKey'](){const _0x208738=_0x1558cf;return await this[_0x208738(0x8b)][_0x208738(0xb3)]();}async[_0x1558cf(0xc4)](_0x39165b){return 0x1;}async[_0x1558cf(0x7b)](_0x182b5c){return 0x1;}async[_0x1558cf(0x9e)](_0x9480a4){return 0x1;}};function _0x3e57(_0x46929c,_0x3149ef){const _0x2e4882=_0x2e48();return _0x3e57=function(_0x3e57e0,_0x3369a0){_0x3e57e0=_0x3e57e0-0x66;let _0x43c2a9=_0x2e4882[_0x3e57e0];return _0x43c2a9;},_0x3e57(_0x46929c,_0x3149ef);}ModelsService=__decorate([(0x0,common_1[_0x1558cf(0x6e)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(models_entity_1[_0x1558cf(0x8d)])),__param(0x1,(0x0,typeorm_1[_0x1558cf(0xb7)])(modelType_entity_1[_0x1558cf(0x88)])),__metadata(_0x1558cf(0xc0),[typeorm_2[_0x1558cf(0x6c)],typeorm_2['Repository']])],ModelsService),exports[_0x1558cf(0xbb)]=ModelsService;