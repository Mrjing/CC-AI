'use strict';const _0x206f1b=_0x359b;(function(_0x16bd90,_0x1ac05a){const _0x26947d=_0x359b,_0x4c1c73=_0x16bd90();while(!![]){try{const _0x3b00de=parseInt(_0x26947d(0xc6))/0x1+parseInt(_0x26947d(0xd6))/0x2*(parseInt(_0x26947d(0xd3))/0x3)+parseInt(_0x26947d(0xd4))/0x4+parseInt(_0x26947d(0xd1))/0x5*(-parseInt(_0x26947d(0xc8))/0x6)+parseInt(_0x26947d(0xb8))/0x7*(-parseInt(_0x26947d(0xd2))/0x8)+parseInt(_0x26947d(0xb7))/0x9*(-parseInt(_0x26947d(0xc3))/0xa)+parseInt(_0x26947d(0x91))/0xb;if(_0x3b00de===_0x1ac05a)break;else _0x4c1c73['push'](_0x4c1c73['shift']());}catch(_0x51774e){_0x4c1c73['push'](_0x4c1c73['shift']());}}}(_0x4e85,0x592c5));var __decorate=this&&this[_0x206f1b(0xdc)]||function(_0x23f577,_0x384d24,_0x2e1b0e,_0x452787){const _0x370232=_0x206f1b;var _0x3af324=arguments['length'],_0x548786=_0x3af324<0x3?_0x384d24:_0x452787===null?_0x452787=Object['getOwnPropertyDescriptor'](_0x384d24,_0x2e1b0e):_0x452787,_0x50faa3;if(typeof Reflect===_0x370232(0xac)&&typeof Reflect['decorate']===_0x370232(0xce))_0x548786=Reflect[_0x370232(0x88)](_0x23f577,_0x384d24,_0x2e1b0e,_0x452787);else{for(var _0x331f47=_0x23f577[_0x370232(0xae)]-0x1;_0x331f47>=0x0;_0x331f47--)if(_0x50faa3=_0x23f577[_0x331f47])_0x548786=(_0x3af324<0x3?_0x50faa3(_0x548786):_0x3af324>0x3?_0x50faa3(_0x384d24,_0x2e1b0e,_0x548786):_0x50faa3(_0x384d24,_0x2e1b0e))||_0x548786;}return _0x3af324>0x3&&_0x548786&&Object['defineProperty'](_0x384d24,_0x2e1b0e,_0x548786),_0x548786;},__metadata=this&&this['__metadata']||function(_0x17208c,_0x29f952){const _0x30d747=_0x206f1b;if(typeof Reflect===_0x30d747(0xac)&&typeof Reflect['metadata']==='function')return Reflect['metadata'](_0x17208c,_0x29f952);},__param=this&&this[_0x206f1b(0x8c)]||function(_0x239104,_0x914c0e){return function(_0x2c9f66,_0x23e03a){_0x914c0e(_0x2c9f66,_0x23e03a,_0x239104);};};Object[_0x206f1b(0x92)](exports,'__esModule',{'value':!![]}),exports['ModelsService']=void 0x0;function _0x4e85(){const _0x5ca8f7=['当前账号不存在！','typeorm','map','where','HttpException','ModelsMapCn','from','hideString','keyType','keyList','./modelType.entity','val','@nestjs/common','reduce','queryModelType','id\x20=\x20:id','set','ModelsTypeEntity','stringify','status','find','initCalcKey','object','findAndCount','length','缺失必要参数！','ModelsService','log','delete','getRandomItemFromArray','modelsEntity','getAllKey','keyPoolIndexMap','9zFpjUo','14917EVyGYu','save','queryModels','modelsTypeEntity','@nestjs/typeorm','key:\x20','update','modelOrder','Like','execute','onModuleInit','684910HtFuPo','keys','modelMaps','653125BHKdDX','Injectable','11322VWhETJ','../../common/constants/status.constant','getCurrentModelKeyInfo','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','super','./models.entity','function','lockKey','error:\x20','1635pQqmhn','1672vGSCml','22107aYhysf','71848IMbmTC','values','2qmFQTe','model','ModelsEntity','parse','useToken\x20+\x20','HttpStatus','__decorate','key','user','forEach','Logger','Repository','push','keyPoolMap','modelTypes','ASC','decorate','createQueryBuilder','当前未指定特殊模型KEY、前往后台模型池设置吧！','affected','__param','saveUseLog','sort','BAD_REQUEST','keyStatus','8994876ulAxSz','defineProperty','error','design:paramtypes','InjectRepository'];_0x4e85=function(){return _0x5ca8f7;};return _0x4e85();}const common_1=require(_0x206f1b(0xa2)),typeorm_1=require(_0x206f1b(0xbc)),typeorm_2=require(_0x206f1b(0x97)),models_entity_1=require(_0x206f1b(0xcd)),status_constant_1=require(_0x206f1b(0xc9)),utils_1=require('../../common/utils'),modelType_entity_1=require(_0x206f1b(0xa0));function _0x359b(_0xb5ca29,_0x33f6e7){const _0x4e8503=_0x4e85();return _0x359b=function(_0x359b60,_0x58a2ae){_0x359b60=_0x359b60-0x81;let _0x468b60=_0x4e8503[_0x359b60];return _0x468b60;},_0x359b(_0xb5ca29,_0x33f6e7);}let ModelsService=class ModelsService{constructor(_0x427a87,_0x1b60f1){const _0x594a1a=_0x206f1b;this[_0x594a1a(0xb4)]=_0x427a87,this[_0x594a1a(0xbb)]=_0x1b60f1,this[_0x594a1a(0x86)]=[],this['modelMaps']={},this[_0x594a1a(0x9f)]={},this[_0x594a1a(0x85)]={},this['keyPoolIndexMap']={};}async[_0x206f1b(0xc2)](){await this['initCalcKey']();}async['initCalcKey'](){const _0x43c5d2=_0x206f1b;this[_0x43c5d2(0x85)]={},this['keyPoolIndexMap']={},this['keyList']={},this[_0x43c5d2(0xc5)]={},this['modelTypes']=[];const _0x162c50=await this[_0x43c5d2(0xb4)][_0x43c5d2(0xaa)]({'where':{'status':!![]}}),_0x543d70=_0x162c50['reduce']((_0x4c347d,_0x3caeab)=>{const _0x4e685=_0x43c5d2;return!_0x4c347d[_0x3caeab[_0x4e685(0x9e)]]?_0x4c347d[_0x3caeab[_0x4e685(0x9e)]]=[_0x3caeab]:_0x4c347d[_0x3caeab['keyType']][_0x4e685(0x84)](_0x3caeab),_0x4c347d;},{});this[_0x43c5d2(0x86)]=Object['keys'](_0x543d70)[_0x43c5d2(0x98)](_0x54734e=>{const _0x5dac14=_0x43c5d2;return{'label':status_constant_1[_0x5dac14(0x9b)][_0x54734e],'val':_0x54734e};}),this[_0x43c5d2(0xc5)]=_0x543d70,this[_0x43c5d2(0x9f)]={},_0x162c50[_0x43c5d2(0x81)](_0x131ad2=>{const _0x3cc159=_0x43c5d2,{keyType:_0x5222f4,model:_0x6fad52,keyWeight:_0x382816}=_0x131ad2;if(!this[_0x3cc159(0x85)][_0x6fad52])this['keyPoolMap'][_0x6fad52]=[];for(let _0x4bc865=0x0;_0x4bc865<_0x382816;_0x4bc865++){this[_0x3cc159(0x85)][_0x6fad52][_0x3cc159(0x84)](_0x131ad2);}if(!this[_0x3cc159(0xb6)][_0x6fad52])this[_0x3cc159(0xb6)][_0x6fad52]=0x0;if(!this['keyList'][_0x5222f4])this[_0x3cc159(0x9f)][_0x5222f4]={};if(!this[_0x3cc159(0x9f)][_0x5222f4][_0x6fad52])this['keyList'][_0x5222f4][_0x6fad52]=[];this[_0x3cc159(0x9f)][_0x5222f4][_0x6fad52][_0x3cc159(0x84)](_0x131ad2);});}async[_0x206f1b(0xcf)](_0x242454,_0x27c588,_0x2649d7=-0x1){const _0x29946d=_0x206f1b,_0x440ab8=await this[_0x29946d(0xb4)]['update']({'id':_0x242454},{'status':![],'keyStatus':_0x2649d7,'remark':_0x27c588});common_1[_0x29946d(0x82)][_0x29946d(0x93)](_0x29946d(0xbd)+_0x242454+_0x29946d(0xcb)),this[_0x29946d(0xab)]();}async[_0x206f1b(0xca)](_0x5a4457){const _0x52ee8b=_0x206f1b;if(!this['keyPoolMap'][_0x5a4457])throw new common_1[(_0x52ee8b(0x9a))]('当前调用模型已经被移除、请重新选择模型！',common_1['HttpStatus'][_0x52ee8b(0x8f)]);this[_0x52ee8b(0xb6)][_0x5a4457]++;const _0x5c70e5=this['keyPoolIndexMap'][_0x5a4457];if(_0x5c70e5>=this[_0x52ee8b(0x85)][_0x5a4457][_0x52ee8b(0xae)])this[_0x52ee8b(0xb6)][_0x5a4457]=0x0;const _0x14e5ac=this[_0x52ee8b(0x85)][_0x5a4457][this[_0x52ee8b(0xb6)][_0x5a4457]];return _0x14e5ac;}async['getBaseConfig'](_0x44c7ca){const _0x267703=_0x206f1b;if(!this[_0x267703(0x86)][_0x267703(0xae)]||!Object['keys'](this[_0x267703(0xc5)])[_0x267703(0xae)])return;const _0x2b80d0=_0x44c7ca?this[_0x267703(0x86)][_0x267703(0xaa)](_0x146bbc=>Number(_0x146bbc['val'])===0x1):this[_0x267703(0x86)][0x0];if(!_0x2b80d0)return;const {keyType:_0x413499,modelName:_0x530285,model:_0xbba8ab,maxModelTokens:_0x3db912,maxResponseTokens:_0x3f1f93,deductType:_0x52f1f6,deduct:_0x156a73,maxRounds:_0x57bc6b}=this['modelMaps'][_0x2b80d0[_0x267703(0xa1)]][0x0];return{'modelTypeInfo':_0x2b80d0,'modelInfo':{'keyType':_0x413499,'modelName':_0x530285,'model':_0xbba8ab,'maxModelTokens':_0x3db912,'maxResponseTokens':_0x3f1f93,'topN':0.8,'systemMessage':'','deductType':_0x52f1f6,'deduct':_0x156a73,'maxRounds':_0x57bc6b,'rounds':0x8}};}async['setModel'](_0x48c3c0){const _0x373259=_0x206f1b;try{const {id:_0x54ca0e}=_0x48c3c0;_0x48c3c0[_0x373259(0xa9)]&&(_0x48c3c0[_0x373259(0x90)]=0x1);if(_0x54ca0e){const _0x246aa7=await this[_0x373259(0xb4)][_0x373259(0xbe)]({'id':_0x54ca0e},_0x48c3c0);return await this[_0x373259(0xab)](),_0x246aa7[_0x373259(0x8b)]>0x0;}else{const {keyType:_0x2c7720,key:_0x23669c}=_0x48c3c0;if(Number(_0x2c7720!==0x1)){const _0xc3850b=await this[_0x373259(0xb4)][_0x373259(0xb9)](_0x48c3c0);return await this['initCalcKey'](),_0xc3850b;}else{const _0x291d20=_0x23669c['map'](_0xbfced4=>{const _0x1c3453=_0x373259;try{const _0x4713d9=JSON[_0x1c3453(0xd9)](JSON[_0x1c3453(0xa8)](_0x48c3c0));return _0x4713d9[_0x1c3453(0xdd)]=_0xbfced4,_0x4713d9;}catch(_0x181132){console['log']('parse\x20error:\x20',_0x181132);}}),_0x398b40=await this[_0x373259(0xb4)][_0x373259(0xb9)](_0x291d20);return await this[_0x373259(0xab)](),_0x398b40;}}}catch(_0x250a41){console[_0x373259(0xb1)](_0x373259(0xd0),_0x250a41);}}async['delModel']({id:_0x44a508}){const _0x2b90f6=_0x206f1b;if(!_0x44a508)throw new common_1[(_0x2b90f6(0x9a))](_0x2b90f6(0xaf),common_1[_0x2b90f6(0xdb)][_0x2b90f6(0x8f)]);const _0x4bc72a=await this[_0x2b90f6(0xb4)]['findOne']({'where':{'id':_0x44a508}});if(!_0x4bc72a)throw new common_1[(_0x2b90f6(0x9a))](_0x2b90f6(0x96),common_1[_0x2b90f6(0xdb)][_0x2b90f6(0x8f)]);const _0x140fcd=await this[_0x2b90f6(0xb4)][_0x2b90f6(0xb2)]({'id':_0x44a508});return await this['initCalcKey'](),_0x140fcd;}async[_0x206f1b(0xba)](_0x2ec25b,_0x58728a){const _0x3f85de=_0x206f1b,{role:_0x57e41a}=_0x2ec25b[_0x3f85de(0xde)],{keyType:_0x5137b3,key:_0x3318d4,status:_0x1aa0c1,model:_0x33aaf8,page:page=0x1,size:size=0xa}=_0x58728a;let _0x2d60ce={};_0x5137b3&&(_0x2d60ce[_0x3f85de(0x9e)]=_0x5137b3),_0x33aaf8&&(_0x2d60ce[_0x3f85de(0xd7)]=_0x33aaf8),_0x1aa0c1&&(_0x2d60ce[_0x3f85de(0xa9)]=Number(_0x1aa0c1)===0x1?!![]:![]),_0x3318d4&&(_0x2d60ce[_0x3f85de(0xdd)]=(0x0,typeorm_2[_0x3f85de(0xc0)])('%'+_0x3318d4+'%'));const [_0x161b2b,_0x4e2acb]=await this[_0x3f85de(0xb4)][_0x3f85de(0xad)]({'where':_0x2d60ce,'order':{'modelOrder':_0x3f85de(0x87)},'skip':(page-0x1)*size,'take':size});return _0x57e41a!==_0x3f85de(0xcc)&&_0x161b2b[_0x3f85de(0x81)](_0x145d3f=>{const _0x24d776=_0x3f85de;_0x145d3f[_0x24d776(0xdd)]&&(_0x145d3f['key']=(0x0,utils_1[_0x24d776(0x9d)])(_0x145d3f[_0x24d776(0xdd)])),_0x145d3f['secret']&&(_0x145d3f['secret']=(0x0,utils_1[_0x24d776(0x9d)])(_0x145d3f['secret']));}),{'rows':_0x161b2b,'count':_0x4e2acb};}async['modelsList'](){const _0x4f90ae=_0x206f1b,_0x532f50=JSON[_0x4f90ae(0xd9)](JSON['stringify'](this[_0x4f90ae(0xc5)]));return Object[_0x4f90ae(0xc4)](_0x532f50)[_0x4f90ae(0x81)](_0x2c3d3b=>{const _0x5088c0=_0x4f90ae;_0x532f50[_0x2c3d3b]=_0x532f50[_0x2c3d3b][_0x5088c0(0x8e)]((_0x56b9c7,_0x213d9b)=>_0x56b9c7['modelOrder']-_0x213d9b[_0x5088c0(0xbf)]),_0x532f50[_0x2c3d3b]=Array[_0x5088c0(0x9c)](_0x532f50[_0x2c3d3b][_0x5088c0(0x98)](_0x361308=>{const {modelName:_0x4ff1d0,model:_0x451d15,deduct:_0x2a90fa,deductType:_0x530909,maxRounds:_0x5328ae}=_0x361308;return{'modelName':_0x4ff1d0,'model':_0x451d15,'deduct':_0x2a90fa,'deductType':_0x530909,'maxRounds':_0x5328ae};})[_0x5088c0(0xa3)]((_0x5e844f,_0x484078)=>_0x5e844f[_0x5088c0(0xa6)](_0x484078['modelName'],_0x484078),new Map())[_0x5088c0(0xd5)]());}),{'modelTypeList':this['modelTypes'],'modelMaps':_0x532f50};}async[_0x206f1b(0x8d)](_0x583a92,_0x31b8bb){const _0x3e2059=_0x206f1b;await this[_0x3e2059(0xb4)][_0x3e2059(0x89)]()[_0x3e2059(0xbe)](models_entity_1[_0x3e2059(0xd8)])[_0x3e2059(0xa6)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>_0x3e2059(0xda)+_0x31b8bb})[_0x3e2059(0x99)](_0x3e2059(0xa5),{'id':_0x583a92})[_0x3e2059(0xc1)]();}async['getRandomDrawKey'](){const _0x152a2b=_0x206f1b,_0x31ff55=await this['modelsEntity'][_0x152a2b(0xaa)]({'where':{'isDraw':!![],'status':!![]}});if(!_0x31ff55['length'])throw new common_1[(_0x152a2b(0x9a))](_0x152a2b(0x8a),common_1[_0x152a2b(0xdb)][_0x152a2b(0x8f)]);return(0x0,utils_1[_0x152a2b(0xb3)])(_0x31ff55);}async[_0x206f1b(0xb5)](){const _0x2a96b8=_0x206f1b;return await this[_0x2a96b8(0xb4)][_0x2a96b8(0xaa)]();}async[_0x206f1b(0xa4)](_0x4aceda){return 0x1;}async['setModelType'](_0x314349){return 0x1;}async['delModelType'](_0x1c24a2){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0x206f1b(0xc7)])(),__param(0x0,(0x0,typeorm_1[_0x206f1b(0x95)])(models_entity_1['ModelsEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(modelType_entity_1[_0x206f1b(0xa7)])),__metadata(_0x206f1b(0x94),[typeorm_2[_0x206f1b(0x83)],typeorm_2[_0x206f1b(0x83)]])],ModelsService),exports[_0x206f1b(0xb0)]=ModelsService;