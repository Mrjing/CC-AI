'use strict';function _0x1fbd(_0x545fa8,_0xab5404){const _0x2c0455=_0x2c04();return _0x1fbd=function(_0x1fbd25,_0x310a3c){_0x1fbd25=_0x1fbd25-0x91;let _0x54beee=_0x2c0455[_0x1fbd25];return _0x54beee;},_0x1fbd(_0x545fa8,_0xab5404);}const _0x157686=_0x1fbd;(function(_0x1de3b4,_0x5b5bfa){const _0x2d7512=_0x1fbd,_0x435ebe=_0x1de3b4();while(!![]){try{const _0x5cf8c0=-parseInt(_0x2d7512(0xb0))/0x1+-parseInt(_0x2d7512(0xe4))/0x2+-parseInt(_0x2d7512(0xe7))/0x3*(parseInt(_0x2d7512(0x9a))/0x4)+parseInt(_0x2d7512(0xa1))/0x5*(parseInt(_0x2d7512(0xc9))/0x6)+-parseInt(_0x2d7512(0xbf))/0x7*(parseInt(_0x2d7512(0xec))/0x8)+parseInt(_0x2d7512(0xac))/0x9+parseInt(_0x2d7512(0xa3))/0xa;if(_0x5cf8c0===_0x5b5bfa)break;else _0x435ebe['push'](_0x435ebe['shift']());}catch(_0x5b3461){_0x435ebe['push'](_0x435ebe['shift']());}}}(_0x2c04,0x4de28));function _0x2c04(){const _0x26bdbb=['object','modelsEntity','BAD_REQUEST','85062ZhTVcK','update','modelTypes','HttpStatus','execute','model','error:\x20','../../common/utils','key','./models.entity','getAllKey','id\x20=\x20:id','status','keyList','getRandomDrawKey','findOne','saveUseLog','ModelsTypeEntity','modelName','lockKey','function','delete','ModelsEntity','hideString','Logger','__metadata','__param','858310AzbWAe','decorate','setModelType','8376TyCCVb','modelsList','push','map','当前账号不存在！','552536qumSDb','reduce','ASC','key:\x20','getRandomItemFromArray','当前调用模型已经被移除、请重新选择模型！','keyType','metadata','initCalcKey','modelOrder','useToken\x20+\x20','stringify','set','ModelsService','getOwnPropertyDescriptor','Injectable','92PAwzfv','delModelType','queryModels','defineProperty','@nestjs/common','modelMaps','delModel','115nrgmmg','./modelType.entity','8101200CkumbE','Repository','parse','log','modelsTypeEntity','@nestjs/typeorm','queryModelType','design:paramtypes','keyPoolIndexMap','3577806hPZPAt','values','__esModule','find','514137rZrrRS','__decorate','InjectRepository','keys','createQueryBuilder','onModuleInit','parse\x20error:\x20','where','forEach','getBaseConfig','val','keyPoolMap','HttpException','save','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','21UMiJGM','super','length','keyStatus','secret','getCurrentModelKeyInfo','../../common/constants/status.constant'];_0x2c04=function(){return _0x26bdbb;};return _0x2c04();}var __decorate=this&&this[_0x157686(0xb1)]||function(_0x19380e,_0x25939a,_0xfa6f6a,_0x4b52fb){const _0x335391=_0x157686;var _0x44547d=arguments[_0x335391(0xc1)],_0x3714f7=_0x44547d<0x3?_0x25939a:_0x4b52fb===null?_0x4b52fb=Object[_0x335391(0x98)](_0x25939a,_0xfa6f6a):_0x4b52fb,_0x2e7219;if(typeof Reflect===_0x335391(0xc6)&&typeof Reflect[_0x335391(0xe5)]===_0x335391(0xdd))_0x3714f7=Reflect[_0x335391(0xe5)](_0x19380e,_0x25939a,_0xfa6f6a,_0x4b52fb);else{for(var _0x2fc23c=_0x19380e['length']-0x1;_0x2fc23c>=0x0;_0x2fc23c--)if(_0x2e7219=_0x19380e[_0x2fc23c])_0x3714f7=(_0x44547d<0x3?_0x2e7219(_0x3714f7):_0x44547d>0x3?_0x2e7219(_0x25939a,_0xfa6f6a,_0x3714f7):_0x2e7219(_0x25939a,_0xfa6f6a))||_0x3714f7;}return _0x44547d>0x3&&_0x3714f7&&Object['defineProperty'](_0x25939a,_0xfa6f6a,_0x3714f7),_0x3714f7;},__metadata=this&&this[_0x157686(0xe2)]||function(_0x31be9c,_0x468f96){const _0x567636=_0x157686;if(typeof Reflect===_0x567636(0xc6)&&typeof Reflect['metadata']===_0x567636(0xdd))return Reflect[_0x567636(0x91)](_0x31be9c,_0x468f96);},__param=this&&this[_0x157686(0xe3)]||function(_0x3fe71d,_0xd8fc1c){return function(_0x21d859,_0x5437a3){_0xd8fc1c(_0x21d859,_0x5437a3,_0x3fe71d);};};Object[_0x157686(0x9d)](exports,_0x157686(0xae),{'value':!![]}),exports['ModelsService']=void 0x0;const common_1=require(_0x157686(0x9e)),typeorm_1=require(_0x157686(0xa8)),typeorm_2=require('typeorm'),models_entity_1=require(_0x157686(0xd2)),status_constant_1=require(_0x157686(0xc5)),utils_1=require(_0x157686(0xd0)),modelType_entity_1=require(_0x157686(0xa2));let ModelsService=class ModelsService{constructor(_0x4f4625,_0x41513b){const _0x5f005c=_0x157686;this['modelsEntity']=_0x4f4625,this[_0x5f005c(0xa7)]=_0x41513b,this[_0x5f005c(0xcb)]=[],this[_0x5f005c(0x9f)]={},this['keyList']={},this[_0x5f005c(0xbb)]={},this['keyPoolIndexMap']={};}async[_0x157686(0xb5)](){await this['initCalcKey']();}async['initCalcKey'](){const _0x45975c=_0x157686;this[_0x45975c(0xbb)]={},this[_0x45975c(0xab)]={},this[_0x45975c(0xd6)]={},this[_0x45975c(0x9f)]={},this[_0x45975c(0xcb)]=[];const _0x6b6598=await this[_0x45975c(0xc7)][_0x45975c(0xaf)]({'where':{'status':!![]}}),_0x4181e3=_0x6b6598[_0x45975c(0xed)]((_0x55c1b8,_0x3a3cbc)=>{const _0x5acef5=_0x45975c;return!_0x55c1b8[_0x3a3cbc['keyType']]?_0x55c1b8[_0x3a3cbc['keyType']]=[_0x3a3cbc]:_0x55c1b8[_0x3a3cbc[_0x5acef5(0xf2)]]['push'](_0x3a3cbc),_0x55c1b8;},{});this[_0x45975c(0xcb)]=Object[_0x45975c(0xb3)](_0x4181e3)['map'](_0x432a94=>{return{'label':status_constant_1['ModelsMapCn'][_0x432a94],'val':_0x432a94};}),this[_0x45975c(0x9f)]=_0x4181e3,this['keyList']={},_0x6b6598[_0x45975c(0xb8)](_0x4bba04=>{const _0x696260=_0x45975c,{keyType:_0x15ec85,model:_0x5d4453,keyWeight:_0x5b4633}=_0x4bba04;if(!this[_0x696260(0xbb)][_0x5d4453])this[_0x696260(0xbb)][_0x5d4453]=[];for(let _0x1e8185=0x0;_0x1e8185<_0x5b4633;_0x1e8185++){this[_0x696260(0xbb)][_0x5d4453][_0x696260(0xe9)](_0x4bba04);}if(!this[_0x696260(0xab)][_0x5d4453])this[_0x696260(0xab)][_0x5d4453]=0x0;if(!this[_0x696260(0xd6)][_0x15ec85])this[_0x696260(0xd6)][_0x15ec85]={};if(!this[_0x696260(0xd6)][_0x15ec85][_0x5d4453])this[_0x696260(0xd6)][_0x15ec85][_0x5d4453]=[];this['keyList'][_0x15ec85][_0x5d4453][_0x696260(0xe9)](_0x4bba04);});}async[_0x157686(0xdc)](_0x48794f,_0x48d03f,_0xf0f2e4=-0x1){const _0x1a00f2=_0x157686,_0xbb6ae3=await this['modelsEntity'][_0x1a00f2(0xca)]({'id':_0x48794f},{'status':![],'keyStatus':_0xf0f2e4,'remark':_0x48d03f});common_1[_0x1a00f2(0xe1)]['error'](_0x1a00f2(0xef)+_0x48794f+_0x1a00f2(0xbe)),this[_0x1a00f2(0x92)]();}async[_0x157686(0xc4)](_0x248b3c){const _0xceb9e7=_0x157686;if(!this[_0xceb9e7(0xbb)][_0x248b3c])throw new common_1['HttpException'](_0xceb9e7(0xf1),common_1[_0xceb9e7(0xcc)][_0xceb9e7(0xc8)]);this['keyPoolIndexMap'][_0x248b3c]++;const _0x32d52e=this['keyPoolIndexMap'][_0x248b3c];if(_0x32d52e>=this[_0xceb9e7(0xbb)][_0x248b3c][_0xceb9e7(0xc1)])this[_0xceb9e7(0xab)][_0x248b3c]=0x0;const _0x2d0071=this[_0xceb9e7(0xbb)][_0x248b3c][this[_0xceb9e7(0xab)][_0x248b3c]];return _0x2d0071;}async[_0x157686(0xb9)](_0x2fd84b){const _0x56abfa=_0x157686;if(!this[_0x56abfa(0xcb)][_0x56abfa(0xc1)]||!Object[_0x56abfa(0xb3)](this[_0x56abfa(0x9f)])[_0x56abfa(0xc1)])return;const _0x10cf6b=_0x2fd84b?this[_0x56abfa(0xcb)][_0x56abfa(0xaf)](_0x598b0b=>Number(_0x598b0b[_0x56abfa(0xba)])===0x1):this[_0x56abfa(0xcb)][0x0];if(!_0x10cf6b)return;const {keyType:_0x1990c8,modelName:_0x22310d,model:_0x56021e,maxModelTokens:_0x5fb6c8,maxResponseTokens:_0x1d50bb,deductType:_0xd3b9b1,deduct:_0xa93960,maxRounds:_0xdd4673}=this['modelMaps'][_0x10cf6b[_0x56abfa(0xba)]][0x0];return{'modelTypeInfo':_0x10cf6b,'modelInfo':{'keyType':_0x1990c8,'modelName':_0x22310d,'model':_0x56021e,'maxModelTokens':_0x5fb6c8,'maxResponseTokens':_0x1d50bb,'topN':0.8,'systemMessage':'','deductType':_0xd3b9b1,'deduct':_0xa93960,'maxRounds':_0xdd4673,'rounds':0x8}};}async['setModel'](_0x399f3b){const _0x35dc3a=_0x157686;try{const {id:_0x1fdc6c}=_0x399f3b;_0x399f3b[_0x35dc3a(0xd5)]&&(_0x399f3b[_0x35dc3a(0xc2)]=0x1);if(_0x1fdc6c){const _0x4be0ef=await this['modelsEntity'][_0x35dc3a(0xca)]({'id':_0x1fdc6c},_0x399f3b);return await this[_0x35dc3a(0x92)](),_0x4be0ef['affected']>0x0;}else{const {keyType:_0x4db13c,key:_0x316f1c}=_0x399f3b;if(Number(_0x4db13c!==0x1)){const _0xc4c1b2=await this[_0x35dc3a(0xc7)][_0x35dc3a(0xbd)](_0x399f3b);return await this[_0x35dc3a(0x92)](),_0xc4c1b2;}else{const _0x257054=_0x316f1c[_0x35dc3a(0xea)](_0x3e5304=>{const _0x275aa7=_0x35dc3a;try{const _0x4c31ef=JSON['parse'](JSON[_0x275aa7(0x95)](_0x399f3b));return _0x4c31ef[_0x275aa7(0xd1)]=_0x3e5304,_0x4c31ef;}catch(_0x3291f1){console[_0x275aa7(0xa6)](_0x275aa7(0xb6),_0x3291f1);}}),_0x5495c5=await this[_0x35dc3a(0xc7)][_0x35dc3a(0xbd)](_0x257054);return await this['initCalcKey'](),_0x5495c5;}}}catch(_0x509073){console[_0x35dc3a(0xa6)](_0x35dc3a(0xcf),_0x509073);}}async[_0x157686(0xa0)]({id:_0x9aba44}){const _0x2ce900=_0x157686;if(!_0x9aba44)throw new common_1['HttpException']('缺失必要参数！',common_1[_0x2ce900(0xcc)][_0x2ce900(0xc8)]);const _0x42f449=await this[_0x2ce900(0xc7)][_0x2ce900(0xd8)]({'where':{'id':_0x9aba44}});if(!_0x42f449)throw new common_1[(_0x2ce900(0xbc))](_0x2ce900(0xeb),common_1[_0x2ce900(0xcc)][_0x2ce900(0xc8)]);const _0x25146b=await this[_0x2ce900(0xc7)][_0x2ce900(0xde)]({'id':_0x9aba44});return await this[_0x2ce900(0x92)](),_0x25146b;}async[_0x157686(0x9c)](_0x45379d,_0x1cb5eb){const _0x32f85f=_0x157686,{role:_0x4f93e2}=_0x45379d['user'],{keyType:_0x38d574,key:_0x2b5d38,status:_0x1c34f7,model:_0x5d41a4,page:page=0x1,size:size=0xa}=_0x1cb5eb;let _0x5b3600={};_0x38d574&&(_0x5b3600[_0x32f85f(0xf2)]=_0x38d574),_0x5d41a4&&(_0x5b3600[_0x32f85f(0xce)]=_0x5d41a4),_0x1c34f7&&(_0x5b3600['status']=Number(_0x1c34f7)===0x1?!![]:![]),_0x2b5d38&&(_0x5b3600[_0x32f85f(0xd1)]=(0x0,typeorm_2['Like'])('%'+_0x2b5d38+'%'));const [_0x59f093,_0x58b022]=await this[_0x32f85f(0xc7)]['findAndCount']({'where':_0x5b3600,'order':{'modelOrder':_0x32f85f(0xee)},'skip':(page-0x1)*size,'take':size});return _0x4f93e2!==_0x32f85f(0xc0)&&_0x59f093[_0x32f85f(0xb8)](_0x57608a=>{const _0x178fa6=_0x32f85f;_0x57608a[_0x178fa6(0xd1)]&&(_0x57608a[_0x178fa6(0xd1)]=(0x0,utils_1[_0x178fa6(0xe0)])(_0x57608a[_0x178fa6(0xd1)])),_0x57608a[_0x178fa6(0xc3)]&&(_0x57608a['secret']=(0x0,utils_1[_0x178fa6(0xe0)])(_0x57608a['secret']));}),{'rows':_0x59f093,'count':_0x58b022};}async[_0x157686(0xe8)](){const _0x555336=_0x157686,_0x475bd6=JSON[_0x555336(0xa5)](JSON[_0x555336(0x95)](this['modelMaps']));return Object[_0x555336(0xb3)](_0x475bd6)[_0x555336(0xb8)](_0x1d6be5=>{const _0x16d7e8=_0x555336;_0x475bd6[_0x1d6be5]=_0x475bd6[_0x1d6be5]['sort']((_0x2938ec,_0x284479)=>_0x2938ec[_0x16d7e8(0x93)]-_0x284479[_0x16d7e8(0x93)]),_0x475bd6[_0x1d6be5]=Array['from'](_0x475bd6[_0x1d6be5][_0x16d7e8(0xea)](_0x51f115=>{const {modelName:_0x7fd67c,model:_0x32799d,deduct:_0x1055b9,deductType:_0x2b90cd,maxRounds:_0x5254d8}=_0x51f115;return{'modelName':_0x7fd67c,'model':_0x32799d,'deduct':_0x1055b9,'deductType':_0x2b90cd,'maxRounds':_0x5254d8};})[_0x16d7e8(0xed)]((_0x193a3b,_0x86c390)=>_0x193a3b[_0x16d7e8(0x96)](_0x86c390[_0x16d7e8(0xdb)],_0x86c390),new Map())[_0x16d7e8(0xad)]());}),{'modelTypeList':this[_0x555336(0xcb)],'modelMaps':_0x475bd6};}async[_0x157686(0xd9)](_0x3d4d42,_0x476197){const _0x8ab1fa=_0x157686;await this['modelsEntity'][_0x8ab1fa(0xb4)]()['update'](models_entity_1[_0x8ab1fa(0xdf)])[_0x8ab1fa(0x96)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>_0x8ab1fa(0x94)+_0x476197})[_0x8ab1fa(0xb7)](_0x8ab1fa(0xd4),{'id':_0x3d4d42})[_0x8ab1fa(0xcd)]();}async[_0x157686(0xd7)](){const _0x597027=_0x157686,_0x2ef44d=await this['modelsEntity'][_0x597027(0xaf)]({'where':{'isDraw':!![],'status':!![]}});if(!_0x2ef44d[_0x597027(0xc1)])throw new common_1[(_0x597027(0xbc))]('当前未指定特殊模型KEY、前往后台模型池设置吧！',common_1[_0x597027(0xcc)][_0x597027(0xc8)]);return(0x0,utils_1[_0x597027(0xf0)])(_0x2ef44d);}async[_0x157686(0xd3)](){const _0x5252e4=_0x157686;return await this[_0x5252e4(0xc7)][_0x5252e4(0xaf)]();}async[_0x157686(0xa9)](_0x34b42b){return 0x1;}async[_0x157686(0xe6)](_0x28e4f8){return 0x1;}async[_0x157686(0x9b)](_0x173b49){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0x157686(0x99)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(models_entity_1['ModelsEntity'])),__param(0x1,(0x0,typeorm_1[_0x157686(0xb2)])(modelType_entity_1[_0x157686(0xda)])),__metadata(_0x157686(0xaa),[typeorm_2[_0x157686(0xa4)],typeorm_2[_0x157686(0xa4)]])],ModelsService),exports[_0x157686(0x97)]=ModelsService;