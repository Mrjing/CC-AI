'use strict';const _0x5ad642=_0x209b;function _0x34c3(){const _0x1bbaaf=['error:\x20','20965770ymjxLX','val','execute','20104xbtOko','model','length','modelMaps','当前账号不存在！','getRandomDrawKey','onModuleInit','sort','keyType','update','modelsEntity','keys','push','setModelType','getAllKey','132644ONhvEO','modelsList','getCurrentModelKeyInfo','keyList','InjectRepository','delModel','keyPoolIndexMap','getRandomItemFromArray','6196832qpxGFI','function','115jBtlHT','modelName','Like','initCalcKey','createQueryBuilder','design:paramtypes','secret','ModelsEntity','affected','ModelsMapCn','delete','modelsTypeEntity','Injectable','map','status','log','HttpException','getOwnPropertyDescriptor','__metadata','@nestjs/common','key','parse\x20error:\x20','缺失必要参数！','460800fDRFJm','modelTypes','object','forEach','972sCZHSa','findAndCount','defineProperty','error','hideString','Repository','HttpStatus','__param','keyPoolMap','getBaseConfig','2644150SSaJEp','save','key:\x20','1061451KmBbuW','delModelType','ModelsService','useToken\x20+\x20','../../common/constants/status.constant','BAD_REQUEST','reduce','find','setModel','parse','./models.entity','ModelsTypeEntity','useCount\x20+\x201','saveUseLog','from','modelOrder','set','findOne','stringify','values','keyStatus','Logger','@nestjs/typeorm','__esModule','decorate'];_0x34c3=function(){return _0x1bbaaf;};return _0x34c3();}(function(_0x3be810,_0x436ab5){const _0x1467c4=_0x209b,_0x54068e=_0x3be810();while(!![]){try{const _0x56e573=parseInt(_0x1467c4(0x1f3))/0x1+-parseInt(_0x1467c4(0x201))/0x2+-parseInt(_0x1467c4(0x204))/0x3+parseInt(_0x1467c4(0x1d2))/0x4*(-parseInt(_0x1467c4(0x1dc))/0x5)+parseInt(_0x1467c4(0x1f7))/0x6*(-parseInt(_0x1467c4(0x221))/0x7)+parseInt(_0x1467c4(0x1da))/0x8+parseInt(_0x1467c4(0x21e))/0x9;if(_0x56e573===_0x436ab5)break;else _0x54068e['push'](_0x54068e['shift']());}catch(_0x945a8f){_0x54068e['push'](_0x54068e['shift']());}}}(_0x34c3,0xa1653));var __decorate=this&&this['__decorate']||function(_0x4f52ec,_0x46db4a,_0x3dac6b,_0x4b342b){const _0x1b4f36=_0x209b;var _0x6d56c2=arguments[_0x1b4f36(0x223)],_0x3de0f7=_0x6d56c2<0x3?_0x46db4a:_0x4b342b===null?_0x4b342b=Object[_0x1b4f36(0x1ed)](_0x46db4a,_0x3dac6b):_0x4b342b,_0x20f701;if(typeof Reflect===_0x1b4f36(0x1f5)&&typeof Reflect['decorate']===_0x1b4f36(0x1db))_0x3de0f7=Reflect[_0x1b4f36(0x21c)](_0x4f52ec,_0x46db4a,_0x3dac6b,_0x4b342b);else{for(var _0x4b110d=_0x4f52ec[_0x1b4f36(0x223)]-0x1;_0x4b110d>=0x0;_0x4b110d--)if(_0x20f701=_0x4f52ec[_0x4b110d])_0x3de0f7=(_0x6d56c2<0x3?_0x20f701(_0x3de0f7):_0x6d56c2>0x3?_0x20f701(_0x46db4a,_0x3dac6b,_0x3de0f7):_0x20f701(_0x46db4a,_0x3dac6b))||_0x3de0f7;}return _0x6d56c2>0x3&&_0x3de0f7&&Object[_0x1b4f36(0x1f9)](_0x46db4a,_0x3dac6b,_0x3de0f7),_0x3de0f7;},__metadata=this&&this[_0x5ad642(0x1ee)]||function(_0x318a33,_0x2fb7e0){const _0x3bce57=_0x5ad642;if(typeof Reflect===_0x3bce57(0x1f5)&&typeof Reflect['metadata']==='function')return Reflect['metadata'](_0x318a33,_0x2fb7e0);},__param=this&&this[_0x5ad642(0x1fe)]||function(_0x5a8290,_0x7328e5){return function(_0x1c8adb,_0x179f51){_0x7328e5(_0x1c8adb,_0x179f51,_0x5a8290);};};Object[_0x5ad642(0x1f9)](exports,_0x5ad642(0x21b),{'value':!![]}),exports['ModelsService']=void 0x0;const common_1=require(_0x5ad642(0x1ef)),typeorm_1=require(_0x5ad642(0x21a)),typeorm_2=require('typeorm'),models_entity_1=require(_0x5ad642(0x20e)),status_constant_1=require(_0x5ad642(0x208)),utils_1=require('../../common/utils'),modelType_entity_1=require('./modelType.entity');function _0x209b(_0x210a9e,_0xe974ba){const _0x34c3fe=_0x34c3();return _0x209b=function(_0x209b48,_0x1ac56d){_0x209b48=_0x209b48-0x1d2;let _0xda8e4c=_0x34c3fe[_0x209b48];return _0xda8e4c;},_0x209b(_0x210a9e,_0xe974ba);}let ModelsService=class ModelsService{constructor(_0x1897f2,_0xadaac8){const _0x5065fb=_0x5ad642;this['modelsEntity']=_0x1897f2,this[_0x5065fb(0x1e7)]=_0xadaac8,this['modelTypes']=[],this['modelMaps']={},this[_0x5065fb(0x1d5)]={},this[_0x5065fb(0x1ff)]={},this[_0x5065fb(0x1d8)]={};}async[_0x5ad642(0x227)](){const _0x1f3945=_0x5ad642;await this[_0x1f3945(0x1df)]();}async[_0x5ad642(0x1df)](){const _0x2fa094=_0x5ad642;this[_0x2fa094(0x1ff)]={},this[_0x2fa094(0x1d8)]={},this[_0x2fa094(0x1d5)]={},this[_0x2fa094(0x224)]={},this[_0x2fa094(0x1f4)]=[];const _0x245164=await this[_0x2fa094(0x22b)][_0x2fa094(0x20b)]({'where':{'status':!![]}}),_0x1ba1ee=_0x245164[_0x2fa094(0x20a)]((_0x870adc,_0x150461)=>{const _0x29f726=_0x2fa094;return!_0x870adc[_0x150461[_0x29f726(0x229)]]?_0x870adc[_0x150461[_0x29f726(0x229)]]=[_0x150461]:_0x870adc[_0x150461[_0x29f726(0x229)]][_0x29f726(0x22d)](_0x150461),_0x870adc;},{});this[_0x2fa094(0x1f4)]=Object[_0x2fa094(0x22c)](_0x1ba1ee)[_0x2fa094(0x1e9)](_0x37eaaf=>{const _0x35b635=_0x2fa094;return{'label':status_constant_1[_0x35b635(0x1e5)][_0x37eaaf],'val':_0x37eaaf};}),this['modelMaps']=_0x1ba1ee,this[_0x2fa094(0x1d5)]={},_0x245164[_0x2fa094(0x1f6)](_0x2d790b=>{const _0x3d1432=_0x2fa094,{keyType:_0x785821,model:_0x36f0be,keyWeight:_0x323c58}=_0x2d790b;if(!this[_0x3d1432(0x1ff)][_0x36f0be])this[_0x3d1432(0x1ff)][_0x36f0be]=[];for(let _0x505fe2=0x0;_0x505fe2<_0x323c58;_0x505fe2++){this['keyPoolMap'][_0x36f0be][_0x3d1432(0x22d)](_0x2d790b);}if(!this['keyPoolIndexMap'][_0x36f0be])this[_0x3d1432(0x1d8)][_0x36f0be]=0x0;if(!this[_0x3d1432(0x1d5)][_0x785821])this['keyList'][_0x785821]={};if(!this[_0x3d1432(0x1d5)][_0x785821][_0x36f0be])this[_0x3d1432(0x1d5)][_0x785821][_0x36f0be]=[];this[_0x3d1432(0x1d5)][_0x785821][_0x36f0be][_0x3d1432(0x22d)](_0x2d790b);});}async['lockKey'](_0x3d00f4,_0x368c74,_0x4d4bb9=-0x1){const _0x2f0ece=_0x5ad642,_0x2b1794=await this['modelsEntity']['update']({'id':_0x3d00f4},{'status':![],'keyStatus':_0x4d4bb9,'remark':_0x368c74});common_1[_0x2f0ece(0x219)][_0x2f0ece(0x1fa)](_0x2f0ece(0x203)+_0x3d00f4+'\x20欠费或被官方封禁导致不可用，已被系统自动锁定'),this[_0x2f0ece(0x1df)]();}async[_0x5ad642(0x1d4)](_0x109b73){const _0x4c1d51=_0x5ad642;if(!this['keyPoolMap'][_0x109b73])throw new common_1['HttpException']('当前调用模型已经被移除、请重新选择模型！',common_1[_0x4c1d51(0x1fd)][_0x4c1d51(0x209)]);this[_0x4c1d51(0x1d8)][_0x109b73]++;const _0x1588f7=this[_0x4c1d51(0x1d8)][_0x109b73];if(_0x1588f7>=this[_0x4c1d51(0x1ff)][_0x109b73]['length'])this[_0x4c1d51(0x1d8)][_0x109b73]=0x0;const _0x23e0b7=this[_0x4c1d51(0x1ff)][_0x109b73][this[_0x4c1d51(0x1d8)][_0x109b73]];return _0x23e0b7;}async[_0x5ad642(0x200)](_0xae9af7){const _0x2c5f0d=_0x5ad642;if(!this[_0x2c5f0d(0x1f4)]['length']||!Object[_0x2c5f0d(0x22c)](this[_0x2c5f0d(0x224)])[_0x2c5f0d(0x223)])return;const _0x59a226=_0xae9af7?this['modelTypes'][_0x2c5f0d(0x20b)](_0x3de200=>Number(_0x3de200[_0x2c5f0d(0x21f)])===0x1):this[_0x2c5f0d(0x1f4)][0x0];if(!_0x59a226)return;const {keyType:_0x3c08d5,modelName:_0x4f8858,model:_0xc13b4e,maxModelTokens:_0x4b3604,maxResponseTokens:_0x799726,deductType:_0x4662a6,deduct:_0x5be6d9,maxRounds:_0x4c1b9b}=this[_0x2c5f0d(0x224)][_0x59a226['val']][0x0];return{'modelTypeInfo':_0x59a226,'modelInfo':{'keyType':_0x3c08d5,'modelName':_0x4f8858,'model':_0xc13b4e,'maxModelTokens':_0x4b3604,'maxResponseTokens':_0x799726,'topN':0.8,'systemMessage':'','deductType':_0x4662a6,'deduct':_0x5be6d9,'maxRounds':_0x4c1b9b,'rounds':0x8}};}async[_0x5ad642(0x20c)](_0x15440b){const _0x19d782=_0x5ad642;try{const {id:_0x335661}=_0x15440b;_0x15440b[_0x19d782(0x1ea)]&&(_0x15440b[_0x19d782(0x218)]=0x1);if(_0x335661){const _0x2f1be3=await this[_0x19d782(0x22b)][_0x19d782(0x22a)]({'id':_0x335661},_0x15440b);return await this['initCalcKey'](),_0x2f1be3[_0x19d782(0x1e4)]>0x0;}else{const {keyType:_0x57e8a2,key:_0x54119f}=_0x15440b;if(Number(_0x57e8a2!==0x1)){const _0x1500a7=await this[_0x19d782(0x22b)][_0x19d782(0x202)](_0x15440b);return await this['initCalcKey'](),_0x1500a7;}else{const _0x3fa42e=_0x54119f[_0x19d782(0x1e9)](_0x51a121=>{const _0x4f42d0=_0x19d782;try{const _0x374856=JSON['parse'](JSON[_0x4f42d0(0x216)](_0x15440b));return _0x374856[_0x4f42d0(0x1f0)]=_0x51a121,_0x374856;}catch(_0x49c53a){console[_0x4f42d0(0x1eb)](_0x4f42d0(0x1f1),_0x49c53a);}}),_0x5b973e=await this[_0x19d782(0x22b)][_0x19d782(0x202)](_0x3fa42e);return await this[_0x19d782(0x1df)](),_0x5b973e;}}}catch(_0x24df2f){console['log'](_0x19d782(0x21d),_0x24df2f);}}async[_0x5ad642(0x1d7)]({id:_0x3f3ebd}){const _0x173e87=_0x5ad642;if(!_0x3f3ebd)throw new common_1[(_0x173e87(0x1ec))](_0x173e87(0x1f2),common_1[_0x173e87(0x1fd)][_0x173e87(0x209)]);const _0x925c8f=await this[_0x173e87(0x22b)][_0x173e87(0x215)]({'where':{'id':_0x3f3ebd}});if(!_0x925c8f)throw new common_1[(_0x173e87(0x1ec))](_0x173e87(0x225),common_1[_0x173e87(0x1fd)][_0x173e87(0x209)]);const _0x50d20e=await this['modelsEntity'][_0x173e87(0x1e6)]({'id':_0x3f3ebd});return await this[_0x173e87(0x1df)](),_0x50d20e;}async['queryModels'](_0x1297fc,_0x49a900){const _0x5a1b0e=_0x5ad642,{role:_0xa81f3a}=_0x1297fc['user'],{keyType:_0x5570aa,key:_0x928230,status:_0x56c26a,model:_0x45a37f,page:page=0x1,size:size=0xa}=_0x49a900;let _0x5cc839={};_0x5570aa&&(_0x5cc839['keyType']=_0x5570aa),_0x45a37f&&(_0x5cc839[_0x5a1b0e(0x222)]=_0x45a37f),_0x56c26a&&(_0x5cc839['status']=Number(_0x56c26a)===0x1?!![]:![]),_0x928230&&(_0x5cc839[_0x5a1b0e(0x1f0)]=(0x0,typeorm_2[_0x5a1b0e(0x1de)])('%'+_0x928230+'%'));const [_0x57fc72,_0x3600bf]=await this[_0x5a1b0e(0x22b)][_0x5a1b0e(0x1f8)]({'where':_0x5cc839,'order':{'modelOrder':'ASC'},'skip':(page-0x1)*size,'take':size});return _0xa81f3a!=='super'&&_0x57fc72[_0x5a1b0e(0x1f6)](_0x42949f=>{const _0x20ac2e=_0x5a1b0e;_0x42949f[_0x20ac2e(0x1f0)]&&(_0x42949f['key']=(0x0,utils_1[_0x20ac2e(0x1fb)])(_0x42949f[_0x20ac2e(0x1f0)])),_0x42949f[_0x20ac2e(0x1e2)]&&(_0x42949f[_0x20ac2e(0x1e2)]=(0x0,utils_1[_0x20ac2e(0x1fb)])(_0x42949f[_0x20ac2e(0x1e2)]));}),{'rows':_0x57fc72,'count':_0x3600bf};}async[_0x5ad642(0x1d3)](){const _0x5919ff=_0x5ad642,_0x1cbbda=JSON[_0x5919ff(0x20d)](JSON[_0x5919ff(0x216)](this[_0x5919ff(0x224)]));return Object[_0x5919ff(0x22c)](_0x1cbbda)[_0x5919ff(0x1f6)](_0x52fe4f=>{const _0x29ce04=_0x5919ff;_0x1cbbda[_0x52fe4f]=_0x1cbbda[_0x52fe4f][_0x29ce04(0x228)]((_0x5eef5a,_0x3340af)=>_0x5eef5a[_0x29ce04(0x213)]-_0x3340af[_0x29ce04(0x213)]),_0x1cbbda[_0x52fe4f]=Array[_0x29ce04(0x212)](_0x1cbbda[_0x52fe4f][_0x29ce04(0x1e9)](_0x567d23=>{const {modelName:_0x18da66,model:_0x8c6bd5,deduct:_0x3828c2,deductType:_0x418083,maxRounds:_0x3a97a9}=_0x567d23;return{'modelName':_0x18da66,'model':_0x8c6bd5,'deduct':_0x3828c2,'deductType':_0x418083,'maxRounds':_0x3a97a9};})[_0x29ce04(0x20a)]((_0x650636,_0x3674fb)=>_0x650636[_0x29ce04(0x214)](_0x3674fb[_0x29ce04(0x1dd)],_0x3674fb),new Map())[_0x29ce04(0x217)]());}),{'modelTypeList':this[_0x5919ff(0x1f4)],'modelMaps':_0x1cbbda};}async[_0x5ad642(0x211)](_0x402ba1,_0x317df5){const _0x581bb1=_0x5ad642;await this['modelsEntity'][_0x581bb1(0x1e0)]()[_0x581bb1(0x22a)](models_entity_1[_0x581bb1(0x1e3)])[_0x581bb1(0x214)]({'useCount':()=>_0x581bb1(0x210),'useToken':()=>_0x581bb1(0x207)+_0x317df5})['where']('id\x20=\x20:id',{'id':_0x402ba1})[_0x581bb1(0x220)]();}async[_0x5ad642(0x226)](){const _0x46faa=_0x5ad642,_0x35a212=await this[_0x46faa(0x22b)][_0x46faa(0x20b)]({'where':{'isDraw':!![],'status':!![]}});if(!_0x35a212[_0x46faa(0x223)])throw new common_1[(_0x46faa(0x1ec))]('当前未指定特殊模型KEY、前往后台模型池设置吧！',common_1[_0x46faa(0x1fd)][_0x46faa(0x209)]);return(0x0,utils_1[_0x46faa(0x1d9)])(_0x35a212);}async[_0x5ad642(0x22f)](){return await this['modelsEntity']['find']();}async['queryModelType'](_0x449c7b){return 0x1;}async[_0x5ad642(0x22e)](_0x12324f){return 0x1;}async[_0x5ad642(0x205)](_0x1323f6){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0x5ad642(0x1e8)])(),__param(0x0,(0x0,typeorm_1[_0x5ad642(0x1d6)])(models_entity_1[_0x5ad642(0x1e3)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(modelType_entity_1[_0x5ad642(0x20f)])),__metadata(_0x5ad642(0x1e1),[typeorm_2['Repository'],typeorm_2[_0x5ad642(0x1fc)]])],ModelsService),exports[_0x5ad642(0x206)]=ModelsService;