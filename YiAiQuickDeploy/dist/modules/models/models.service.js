'use strict';const _0x3f6d5a=_0x57c3;(function(_0x25268a,_0x4734fb){const _0xa580ef=_0x57c3,_0x2f37c8=_0x25268a();while(!![]){try{const _0x724a82=parseInt(_0xa580ef(0x1e8))/0x1+parseInt(_0xa580ef(0x1db))/0x2*(parseInt(_0xa580ef(0x1fb))/0x3)+parseInt(_0xa580ef(0x1e3))/0x4+-parseInt(_0xa580ef(0x20f))/0x5*(-parseInt(_0xa580ef(0x20c))/0x6)+parseInt(_0xa580ef(0x203))/0x7*(-parseInt(_0xa580ef(0x220))/0x8)+parseInt(_0xa580ef(0x1f8))/0x9+-parseInt(_0xa580ef(0x224))/0xa;if(_0x724a82===_0x4734fb)break;else _0x2f37c8['push'](_0x2f37c8['shift']());}catch(_0x53c20c){_0x2f37c8['push'](_0x2f37c8['shift']());}}}(_0x3eef,0x75f3c));function _0x57c3(_0x1a5c30,_0x3dcf9a){const _0x3eefad=_0x3eef();return _0x57c3=function(_0x57c330,_0x6d38aa){_0x57c330=_0x57c330-0x1ce;let _0xf24de3=_0x3eefad[_0x57c330];return _0xf24de3;},_0x57c3(_0x1a5c30,_0x3dcf9a);}function _0x3eef(){const _0x248d58=['\x20欠费或被官方封禁导致不可用，已被系统自动锁定','2440816UOOshk','user','modelName','super','keyPoolIndexMap','721159YUcZsz','ModelsService','keyList','ModelsMapCn','initCalcKey','keys','error','../../common/utils','Injectable','HttpException','InjectRepository','delModelType','execute','BAD_REQUEST','modelsTypeEntity','delete','4008654udlkGP','@nestjs/common','keyStatus','141936gOgpOQ','status','forEach','getRandomItemFromArray','__decorate','modelsEntity','useCount\x20+\x201','当前账号不存在！','7MpnQRQ','hideString','typeorm','getOwnPropertyDescriptor','affected','update','length','getBaseConfig','val','36lGjxZY','modelTypes','../../common/constants/status.constant','20740FoYgKW','getAllKey','save','当前调用模型已经被移除、请重新选择模型！','function','stringify','where','当前未指定特殊模型KEY、前往后台模型池设置吧！','saveUseLog','log','setModel','__esModule','getCurrentModelKeyInfo','findAndCount','onModuleInit','HttpStatus','modelOrder','1781432nLtJOJ','metadata','id\x20=\x20:id','delModel','15216540vBVCTz','design:paramtypes','lockKey','keyType','ModelsEntity','defineProperty','parse','keyPoolMap','__metadata','ASC','find','Like','Repository','set','key:\x20','reduce','ModelsTypeEntity','modelsList','key','push','map','18jJcynY','values','./modelType.entity','decorate','modelMaps','useToken\x20+\x20','secret'];_0x3eef=function(){return _0x248d58;};return _0x3eef();}var __decorate=this&&this[_0x3f6d5a(0x1ff)]||function(_0xbe943a,_0x48f8a4,_0x1dcc3,_0x122f85){const _0x522e59=_0x3f6d5a;var _0x1e2e38=arguments[_0x522e59(0x209)],_0x59a17e=_0x1e2e38<0x3?_0x48f8a4:_0x122f85===null?_0x122f85=Object[_0x522e59(0x206)](_0x48f8a4,_0x1dcc3):_0x122f85,_0x3526c3;if(typeof Reflect==='object'&&typeof Reflect[_0x522e59(0x1de)]==='function')_0x59a17e=Reflect[_0x522e59(0x1de)](_0xbe943a,_0x48f8a4,_0x1dcc3,_0x122f85);else{for(var _0x318588=_0xbe943a[_0x522e59(0x209)]-0x1;_0x318588>=0x0;_0x318588--)if(_0x3526c3=_0xbe943a[_0x318588])_0x59a17e=(_0x1e2e38<0x3?_0x3526c3(_0x59a17e):_0x1e2e38>0x3?_0x3526c3(_0x48f8a4,_0x1dcc3,_0x59a17e):_0x3526c3(_0x48f8a4,_0x1dcc3))||_0x59a17e;}return _0x1e2e38>0x3&&_0x59a17e&&Object[_0x522e59(0x229)](_0x48f8a4,_0x1dcc3,_0x59a17e),_0x59a17e;},__metadata=this&&this[_0x3f6d5a(0x1ce)]||function(_0x1d97e3,_0x578520){const _0x9bd80f=_0x3f6d5a;if(typeof Reflect==='object'&&typeof Reflect[_0x9bd80f(0x221)]===_0x9bd80f(0x213))return Reflect[_0x9bd80f(0x221)](_0x1d97e3,_0x578520);},__param=this&&this['__param']||function(_0x253528,_0x1a3e80){return function(_0x2a3e6d,_0x4833db){_0x1a3e80(_0x2a3e6d,_0x4833db,_0x253528);};};Object[_0x3f6d5a(0x229)](exports,_0x3f6d5a(0x21a),{'value':!![]}),exports[_0x3f6d5a(0x1e9)]=void 0x0;const common_1=require(_0x3f6d5a(0x1f9)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x3f6d5a(0x205)),models_entity_1=require('./models.entity'),status_constant_1=require(_0x3f6d5a(0x20e)),utils_1=require(_0x3f6d5a(0x1ef)),modelType_entity_1=require(_0x3f6d5a(0x1dd));let ModelsService=class ModelsService{constructor(_0x43afef,_0x48fd50){const _0x458eb1=_0x3f6d5a;this[_0x458eb1(0x200)]=_0x43afef,this[_0x458eb1(0x1f6)]=_0x48fd50,this[_0x458eb1(0x20d)]=[],this[_0x458eb1(0x1df)]={},this[_0x458eb1(0x1ea)]={},this[_0x458eb1(0x22b)]={},this['keyPoolIndexMap']={};}async[_0x3f6d5a(0x21d)](){const _0x1564bb=_0x3f6d5a;await this[_0x1564bb(0x1ec)]();}async[_0x3f6d5a(0x1ec)](){const _0x389b5f=_0x3f6d5a;this[_0x389b5f(0x22b)]={},this[_0x389b5f(0x1e7)]={},this[_0x389b5f(0x1ea)]={},this['modelMaps']={},this[_0x389b5f(0x20d)]=[];const _0x313a45=await this[_0x389b5f(0x200)][_0x389b5f(0x1d0)]({'where':{'status':!![]}}),_0x335721=_0x313a45['reduce']((_0x5682d4,_0x270c61)=>{const _0x235e9f=_0x389b5f;return!_0x5682d4[_0x270c61['keyType']]?_0x5682d4[_0x270c61[_0x235e9f(0x227)]]=[_0x270c61]:_0x5682d4[_0x270c61[_0x235e9f(0x227)]][_0x235e9f(0x1d9)](_0x270c61),_0x5682d4;},{});this[_0x389b5f(0x20d)]=Object[_0x389b5f(0x1ed)](_0x335721)['map'](_0x44c465=>{const _0x54bd4f=_0x389b5f;return{'label':status_constant_1[_0x54bd4f(0x1eb)][_0x44c465],'val':_0x44c465};}),this[_0x389b5f(0x1df)]=_0x335721,this[_0x389b5f(0x1ea)]={},_0x313a45['forEach'](_0x2cc202=>{const _0x471d3f=_0x389b5f,{keyType:_0x505ea5,model:_0x1f4689,keyWeight:_0x25fce2}=_0x2cc202;if(!this[_0x471d3f(0x22b)][_0x1f4689])this[_0x471d3f(0x22b)][_0x1f4689]=[];for(let _0x12c6cf=0x0;_0x12c6cf<_0x25fce2;_0x12c6cf++){this[_0x471d3f(0x22b)][_0x1f4689]['push'](_0x2cc202);}if(!this[_0x471d3f(0x1e7)][_0x1f4689])this[_0x471d3f(0x1e7)][_0x1f4689]=0x0;if(!this[_0x471d3f(0x1ea)][_0x505ea5])this['keyList'][_0x505ea5]={};if(!this[_0x471d3f(0x1ea)][_0x505ea5][_0x1f4689])this[_0x471d3f(0x1ea)][_0x505ea5][_0x1f4689]=[];this[_0x471d3f(0x1ea)][_0x505ea5][_0x1f4689][_0x471d3f(0x1d9)](_0x2cc202);});}async[_0x3f6d5a(0x226)](_0x405f14,_0x2cfce8,_0x9e38dc=-0x1){const _0x7f4795=_0x3f6d5a,_0x98492e=await this['modelsEntity'][_0x7f4795(0x208)]({'id':_0x405f14},{'status':![],'keyStatus':_0x9e38dc,'remark':_0x2cfce8});common_1['Logger'][_0x7f4795(0x1ee)](_0x7f4795(0x1d4)+_0x405f14+_0x7f4795(0x1e2)),this[_0x7f4795(0x1ec)]();}async[_0x3f6d5a(0x21b)](_0x32d203){const _0x540f49=_0x3f6d5a;if(!this[_0x540f49(0x22b)][_0x32d203])throw new common_1['HttpException'](_0x540f49(0x212),common_1['HttpStatus'][_0x540f49(0x1f5)]);this[_0x540f49(0x1e7)][_0x32d203]++;const _0x10359a=this[_0x540f49(0x1e7)][_0x32d203];if(_0x10359a>=this['keyPoolMap'][_0x32d203][_0x540f49(0x209)])this[_0x540f49(0x1e7)][_0x32d203]=0x0;const _0x35076f=this[_0x540f49(0x22b)][_0x32d203][this[_0x540f49(0x1e7)][_0x32d203]];return _0x35076f;}async[_0x3f6d5a(0x20a)](_0x33b362){const _0x645eeb=_0x3f6d5a;if(!this[_0x645eeb(0x20d)][_0x645eeb(0x209)]||!Object[_0x645eeb(0x1ed)](this[_0x645eeb(0x1df)])[_0x645eeb(0x209)])return;const _0x2c1670=_0x33b362?this[_0x645eeb(0x20d)][_0x645eeb(0x1d0)](_0xca7df=>Number(_0xca7df[_0x645eeb(0x20b)])===0x1):this[_0x645eeb(0x20d)][0x0];if(!_0x2c1670)return;const {keyType:_0x13fe26,modelName:_0x136b12,model:_0x4bb13f,maxModelTokens:_0x550f66,maxResponseTokens:_0x59b5b9,deductType:_0x1f91a5,deduct:_0x2bdefe,maxRounds:_0x29139}=this[_0x645eeb(0x1df)][_0x2c1670[_0x645eeb(0x20b)]][0x0];return{'modelTypeInfo':_0x2c1670,'modelInfo':{'keyType':_0x13fe26,'modelName':_0x136b12,'model':_0x4bb13f,'maxModelTokens':_0x550f66,'maxResponseTokens':_0x59b5b9,'topN':0.8,'systemMessage':'','deductType':_0x1f91a5,'deduct':_0x2bdefe,'maxRounds':_0x29139,'rounds':0x8}};}async[_0x3f6d5a(0x219)](_0xcc636c){const _0x5d02be=_0x3f6d5a;try{const {id:_0x13a531}=_0xcc636c;_0xcc636c[_0x5d02be(0x1fc)]&&(_0xcc636c[_0x5d02be(0x1fa)]=0x1);if(_0x13a531){const _0x546a98=await this[_0x5d02be(0x200)][_0x5d02be(0x208)]({'id':_0x13a531},_0xcc636c);return await this[_0x5d02be(0x1ec)](),_0x546a98[_0x5d02be(0x207)]>0x0;}else{const {keyType:_0x5e2cf0,key:_0x1a0cc2}=_0xcc636c;if(Number(_0x5e2cf0!==0x1)){const _0x26e880=await this[_0x5d02be(0x200)][_0x5d02be(0x211)](_0xcc636c);return await this[_0x5d02be(0x1ec)](),_0x26e880;}else{const _0x42794f=_0x1a0cc2[_0x5d02be(0x1da)](_0x849dc4=>{const _0x189535=_0x5d02be;try{const _0x3f18c3=JSON[_0x189535(0x22a)](JSON[_0x189535(0x214)](_0xcc636c));return _0x3f18c3[_0x189535(0x1d8)]=_0x849dc4,_0x3f18c3;}catch(_0x2cefd3){console['log']('parse\x20error:\x20',_0x2cefd3);}}),_0x203736=await this['modelsEntity'][_0x5d02be(0x211)](_0x42794f);return await this[_0x5d02be(0x1ec)](),_0x203736;}}}catch(_0x3f9215){console[_0x5d02be(0x218)]('error:\x20',_0x3f9215);}}async[_0x3f6d5a(0x223)]({id:_0x3919a}){const _0x33944a=_0x3f6d5a;if(!_0x3919a)throw new common_1[(_0x33944a(0x1f1))]('缺失必要参数！',common_1['HttpStatus']['BAD_REQUEST']);const _0x1b58c5=await this[_0x33944a(0x200)]['findOne']({'where':{'id':_0x3919a}});if(!_0x1b58c5)throw new common_1[(_0x33944a(0x1f1))](_0x33944a(0x202),common_1[_0x33944a(0x21e)]['BAD_REQUEST']);const _0x3a99cb=await this[_0x33944a(0x200)][_0x33944a(0x1f7)]({'id':_0x3919a});return await this['initCalcKey'](),_0x3a99cb;}async['queryModels'](_0x52fde5,_0x13e731){const _0x161a76=_0x3f6d5a,{role:_0x55b945}=_0x52fde5[_0x161a76(0x1e4)],{keyType:_0x5df7dc,key:_0x29ff7d,status:_0x1f6d15,model:_0x4fe843,page:page=0x1,size:size=0xa}=_0x13e731;let _0x5db8ad={};_0x5df7dc&&(_0x5db8ad['keyType']=_0x5df7dc),_0x4fe843&&(_0x5db8ad['model']=_0x4fe843),_0x1f6d15&&(_0x5db8ad[_0x161a76(0x1fc)]=Number(_0x1f6d15)===0x1?!![]:![]),_0x29ff7d&&(_0x5db8ad[_0x161a76(0x1d8)]=(0x0,typeorm_2[_0x161a76(0x1d1)])('%'+_0x29ff7d+'%'));const [_0x4fdd86,_0x5ee39e]=await this[_0x161a76(0x200)][_0x161a76(0x21c)]({'where':_0x5db8ad,'order':{'modelOrder':_0x161a76(0x1cf)},'skip':(page-0x1)*size,'take':size});return _0x55b945!==_0x161a76(0x1e6)&&_0x4fdd86[_0x161a76(0x1fd)](_0x4954b7=>{const _0x3e221a=_0x161a76;_0x4954b7[_0x3e221a(0x1d8)]&&(_0x4954b7['key']=(0x0,utils_1['hideString'])(_0x4954b7[_0x3e221a(0x1d8)])),_0x4954b7[_0x3e221a(0x1e1)]&&(_0x4954b7[_0x3e221a(0x1e1)]=(0x0,utils_1[_0x3e221a(0x204)])(_0x4954b7[_0x3e221a(0x1e1)]));}),{'rows':_0x4fdd86,'count':_0x5ee39e};}async[_0x3f6d5a(0x1d7)](){const _0x48554d=_0x3f6d5a,_0x29aa28=JSON[_0x48554d(0x22a)](JSON[_0x48554d(0x214)](this[_0x48554d(0x1df)]));return Object[_0x48554d(0x1ed)](_0x29aa28)[_0x48554d(0x1fd)](_0x30a821=>{const _0x34ceff=_0x48554d;_0x29aa28[_0x30a821]=_0x29aa28[_0x30a821]['sort']((_0xe52956,_0x4e99df)=>_0xe52956[_0x34ceff(0x21f)]-_0x4e99df[_0x34ceff(0x21f)]),_0x29aa28[_0x30a821]=Array['from'](_0x29aa28[_0x30a821]['map'](_0x47c74b=>{const {modelName:_0x599779,model:_0x1861c5,deduct:_0x55735a,deductType:_0x4b47dc,maxRounds:_0x42d521}=_0x47c74b;return{'modelName':_0x599779,'model':_0x1861c5,'deduct':_0x55735a,'deductType':_0x4b47dc,'maxRounds':_0x42d521};})[_0x34ceff(0x1d5)]((_0x242814,_0x2df333)=>_0x242814['set'](_0x2df333[_0x34ceff(0x1e5)],_0x2df333),new Map())[_0x34ceff(0x1dc)]());}),{'modelTypeList':this[_0x48554d(0x20d)],'modelMaps':_0x29aa28};}async[_0x3f6d5a(0x217)](_0x2d2473,_0x413375){const _0x2e8df8=_0x3f6d5a;await this[_0x2e8df8(0x200)]['createQueryBuilder']()[_0x2e8df8(0x208)](models_entity_1[_0x2e8df8(0x228)])[_0x2e8df8(0x1d3)]({'useCount':()=>_0x2e8df8(0x201),'useToken':()=>_0x2e8df8(0x1e0)+_0x413375})[_0x2e8df8(0x215)](_0x2e8df8(0x222),{'id':_0x2d2473})[_0x2e8df8(0x1f4)]();}async['getRandomDrawKey'](){const _0x2777f1=_0x3f6d5a,_0x345284=await this[_0x2777f1(0x200)][_0x2777f1(0x1d0)]({'where':{'isDraw':!![],'status':!![]}});if(!_0x345284[_0x2777f1(0x209)])throw new common_1['HttpException'](_0x2777f1(0x216),common_1[_0x2777f1(0x21e)][_0x2777f1(0x1f5)]);return(0x0,utils_1[_0x2777f1(0x1fe)])(_0x345284);}async[_0x3f6d5a(0x210)](){const _0x17e2da=_0x3f6d5a;return await this['modelsEntity'][_0x17e2da(0x1d0)]();}async['queryModelType'](_0x361034){return 0x1;}async['setModelType'](_0x384f7f){return 0x1;}async[_0x3f6d5a(0x1f3)](_0x386f52){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0x3f6d5a(0x1f0)])(),__param(0x0,(0x0,typeorm_1[_0x3f6d5a(0x1f2)])(models_entity_1['ModelsEntity'])),__param(0x1,(0x0,typeorm_1[_0x3f6d5a(0x1f2)])(modelType_entity_1[_0x3f6d5a(0x1d6)])),__metadata(_0x3f6d5a(0x225),[typeorm_2[_0x3f6d5a(0x1d2)],typeorm_2[_0x3f6d5a(0x1d2)]])],ModelsService),exports['ModelsService']=ModelsService;