'use strict';function _0x3dc3(_0x7ea560,_0x30a733){const _0x2648b5=_0x2648();return _0x3dc3=function(_0x3dc376,_0x4f988d){_0x3dc376=_0x3dc376-0x6d;let _0x165588=_0x2648b5[_0x3dc376];return _0x165588;},_0x3dc3(_0x7ea560,_0x30a733);}const _0x1a0063=_0x3dc3;(function(_0x5e0a47,_0x5db1ae){const _0x43d02c=_0x3dc3,_0x4acc58=_0x5e0a47();while(!![]){try{const _0xbedc07=-parseInt(_0x43d02c(0xcc))/0x1+parseInt(_0x43d02c(0xa0))/0x2*(-parseInt(_0x43d02c(0x86))/0x3)+parseInt(_0x43d02c(0x92))/0x4+-parseInt(_0x43d02c(0xc2))/0x5+parseInt(_0x43d02c(0x72))/0x6*(parseInt(_0x43d02c(0xc9))/0x7)+parseInt(_0x43d02c(0xb9))/0x8+parseInt(_0x43d02c(0x74))/0x9*(parseInt(_0x43d02c(0x83))/0xa);if(_0xbedc07===_0x5db1ae)break;else _0x4acc58['push'](_0x4acc58['shift']());}catch(_0x5d93af){_0x4acc58['push'](_0x4acc58['shift']());}}}(_0x2648,0x9b92f));function _0x2648(){const _0x3fd0f1=['queryModels','super','values','keys','design:paramtypes','__metadata','1865560NEIqsC','ModelsTypeEntity','keyStatus','3nPMCDJ','ASC','../../common/constants/status.constant','find','HttpException','hideString','findAndCount','keyType','typeorm','当前未指定特殊模型KEY、前往后台模型池设置吧！','setModelType','useToken\x20+\x20','811052OozYIU','length','model','decorate','object','getRandomDrawKey','@nestjs/typeorm','getAllKey','update','user','__esModule','keyPoolMap','parse\x20error:\x20','where','1665652rioQFJ','lockKey','@nestjs/common','stringify','createQueryBuilder','modelMaps','push','parse','keyPoolIndexMap','ModelsEntity','getOwnPropertyDescriptor','ModelsService','当前账号不存在！','Logger','modelsEntity','sort','../../common/utils','ModelsMapCn','__param','key:\x20','execute','id\x20=\x20:id','error','setModel','metadata','2303040eDvlbM','forEach','getRandomItemFromArray','modelTypes','__decorate','Injectable','map','modelsTypeEntity','set','5019480HWSZsz','getBaseConfig','key','delete','Repository','function','val','41314wnaCBc','InjectRepository','error:\x20','967196oWigsp','initCalcKey','./modelType.entity','BAD_REQUEST','HttpStatus','log','缺失必要参数！','keyList','534srpIpW','defineProperty','117kQjHIh','modelOrder','saveUseLog','reduce','secret','status','Like','affected','useCount\x20+\x201'];_0x2648=function(){return _0x3fd0f1;};return _0x2648();}var __decorate=this&&this[_0x1a0063(0xbd)]||function(_0x39b1b5,_0xd3d959,_0x486677,_0x2fe970){const _0x26fd46=_0x1a0063;var _0x1e90d8=arguments[_0x26fd46(0x93)],_0x5d28ff=_0x1e90d8<0x3?_0xd3d959:_0x2fe970===null?_0x2fe970=Object[_0x26fd46(0xaa)](_0xd3d959,_0x486677):_0x2fe970,_0x346d51;if(typeof Reflect===_0x26fd46(0x96)&&typeof Reflect[_0x26fd46(0x95)]===_0x26fd46(0xc7))_0x5d28ff=Reflect[_0x26fd46(0x95)](_0x39b1b5,_0xd3d959,_0x486677,_0x2fe970);else{for(var _0x240aa7=_0x39b1b5[_0x26fd46(0x93)]-0x1;_0x240aa7>=0x0;_0x240aa7--)if(_0x346d51=_0x39b1b5[_0x240aa7])_0x5d28ff=(_0x1e90d8<0x3?_0x346d51(_0x5d28ff):_0x1e90d8>0x3?_0x346d51(_0xd3d959,_0x486677,_0x5d28ff):_0x346d51(_0xd3d959,_0x486677))||_0x5d28ff;}return _0x1e90d8>0x3&&_0x5d28ff&&Object['defineProperty'](_0xd3d959,_0x486677,_0x5d28ff),_0x5d28ff;},__metadata=this&&this[_0x1a0063(0x82)]||function(_0xcc4b3c,_0x2fab27){const _0xa16b7c=_0x1a0063;if(typeof Reflect===_0xa16b7c(0x96)&&typeof Reflect[_0xa16b7c(0xb8)]===_0xa16b7c(0xc7))return Reflect[_0xa16b7c(0xb8)](_0xcc4b3c,_0x2fab27);},__param=this&&this[_0x1a0063(0xb2)]||function(_0x453c6a,_0x49e645){return function(_0x305326,_0x5bd534){_0x49e645(_0x305326,_0x5bd534,_0x453c6a);};};Object[_0x1a0063(0x73)](exports,_0x1a0063(0x9c),{'value':!![]}),exports[_0x1a0063(0xab)]=void 0x0;const common_1=require(_0x1a0063(0xa2)),typeorm_1=require(_0x1a0063(0x98)),typeorm_2=require(_0x1a0063(0x8e)),models_entity_1=require('./models.entity'),status_constant_1=require(_0x1a0063(0x88)),utils_1=require(_0x1a0063(0xb0)),modelType_entity_1=require(_0x1a0063(0xce));let ModelsService=class ModelsService{constructor(_0x1f8c2c,_0x43822d){const _0x1bdf19=_0x1a0063;this[_0x1bdf19(0xae)]=_0x1f8c2c,this[_0x1bdf19(0xc0)]=_0x43822d,this[_0x1bdf19(0xbc)]=[],this['modelMaps']={},this[_0x1bdf19(0x71)]={},this[_0x1bdf19(0x9d)]={},this[_0x1bdf19(0xa8)]={};}async['onModuleInit'](){await this['initCalcKey']();}async[_0x1a0063(0xcd)](){const _0x292122=_0x1a0063;this[_0x292122(0x9d)]={},this[_0x292122(0xa8)]={},this[_0x292122(0x71)]={},this['modelMaps']={},this[_0x292122(0xbc)]=[];const _0x4bda15=await this[_0x292122(0xae)][_0x292122(0x89)]({'where':{'status':!![]}}),_0x131877=_0x4bda15[_0x292122(0x77)]((_0x42caf9,_0x27a1f3)=>{const _0x1e860c=_0x292122;return!_0x42caf9[_0x27a1f3[_0x1e860c(0x8d)]]?_0x42caf9[_0x27a1f3[_0x1e860c(0x8d)]]=[_0x27a1f3]:_0x42caf9[_0x27a1f3['keyType']][_0x1e860c(0xa6)](_0x27a1f3),_0x42caf9;},{});this[_0x292122(0xbc)]=Object[_0x292122(0x80)](_0x131877)[_0x292122(0xbf)](_0x553277=>{const _0x3166fd=_0x292122;return{'label':status_constant_1[_0x3166fd(0xb1)][_0x553277],'val':_0x553277};}),this[_0x292122(0xa5)]=_0x131877,this[_0x292122(0x71)]={},_0x4bda15[_0x292122(0xba)](_0x5bc542=>{const _0x5b3502=_0x292122,{keyType:_0x5b6fd1,model:_0x296627,keyWeight:_0x4bc0ea}=_0x5bc542;if(!this['keyPoolMap'][_0x296627])this[_0x5b3502(0x9d)][_0x296627]=[];for(let _0x326466=0x0;_0x326466<_0x4bc0ea;_0x326466++){this['keyPoolMap'][_0x296627][_0x5b3502(0xa6)](_0x5bc542);}if(!this[_0x5b3502(0xa8)][_0x296627])this[_0x5b3502(0xa8)][_0x296627]=0x0;if(!this[_0x5b3502(0x71)][_0x5b6fd1])this[_0x5b3502(0x71)][_0x5b6fd1]={};if(!this['keyList'][_0x5b6fd1][_0x296627])this[_0x5b3502(0x71)][_0x5b6fd1][_0x296627]=[];this[_0x5b3502(0x71)][_0x5b6fd1][_0x296627]['push'](_0x5bc542);});}async[_0x1a0063(0xa1)](_0x187a10,_0x454260,_0x17a131=-0x1){const _0x4f5dd4=_0x1a0063,_0x31d2be=await this[_0x4f5dd4(0xae)][_0x4f5dd4(0x9a)]({'id':_0x187a10},{'status':![],'keyStatus':_0x17a131,'remark':_0x454260});common_1[_0x4f5dd4(0xad)][_0x4f5dd4(0xb6)](_0x4f5dd4(0xb3)+_0x187a10+'\x20欠费或被官方封禁导致不可用，已被系统自动锁定'),this[_0x4f5dd4(0xcd)]();}async['getCurrentModelKeyInfo'](_0x531fd0){const _0xa378e2=_0x1a0063;if(!this[_0xa378e2(0x9d)][_0x531fd0])throw new common_1[(_0xa378e2(0x8a))]('当前调用模型已经被移除、请重新选择模型！',common_1[_0xa378e2(0x6e)][_0xa378e2(0x6d)]);this[_0xa378e2(0xa8)][_0x531fd0]++;const _0x387615=this['keyPoolIndexMap'][_0x531fd0];if(_0x387615>=this[_0xa378e2(0x9d)][_0x531fd0]['length'])this[_0xa378e2(0xa8)][_0x531fd0]=0x0;const _0x6a4a8f=this['keyPoolMap'][_0x531fd0][this[_0xa378e2(0xa8)][_0x531fd0]];return _0x6a4a8f;}async[_0x1a0063(0xc3)](_0x526c56){const _0x113b11=_0x1a0063;if(!this[_0x113b11(0xbc)][_0x113b11(0x93)]||!Object[_0x113b11(0x80)](this[_0x113b11(0xa5)])[_0x113b11(0x93)])return;const _0x3de17c=_0x526c56?this[_0x113b11(0xbc)][_0x113b11(0x89)](_0x5a9915=>Number(_0x5a9915[_0x113b11(0xc8)])===0x1):this[_0x113b11(0xbc)][0x0];if(!_0x3de17c)return;const {keyType:_0x2518da,modelName:_0x5d5b05,model:_0x52bbde,maxModelTokens:_0x17b654,maxResponseTokens:_0x47be84,deductType:_0x2b3055,deduct:_0x1ca711,maxRounds:_0x4336bf}=this['modelMaps'][_0x3de17c['val']][0x0];return{'modelTypeInfo':_0x3de17c,'modelInfo':{'keyType':_0x2518da,'modelName':_0x5d5b05,'model':_0x52bbde,'maxModelTokens':_0x17b654,'maxResponseTokens':_0x47be84,'topN':0.8,'systemMessage':'','deductType':_0x2b3055,'deduct':_0x1ca711,'maxRounds':_0x4336bf,'rounds':0x8}};}async[_0x1a0063(0xb7)](_0x4a47fa){const _0x128438=_0x1a0063;try{const {id:_0x4f4b6c}=_0x4a47fa;_0x4a47fa[_0x128438(0x79)]&&(_0x4a47fa[_0x128438(0x85)]=0x1);if(_0x4f4b6c){const _0x408b02=await this[_0x128438(0xae)][_0x128438(0x9a)]({'id':_0x4f4b6c},_0x4a47fa);return await this['initCalcKey'](),_0x408b02[_0x128438(0x7b)]>0x0;}else{const {keyType:_0x36050e,key:_0x4edc9d}=_0x4a47fa;if(Number(_0x36050e!==0x1)){const _0x4de011=await this[_0x128438(0xae)]['save'](_0x4a47fa);return await this[_0x128438(0xcd)](),_0x4de011;}else{const _0x3f4079=_0x4edc9d[_0x128438(0xbf)](_0x47fbc8=>{const _0x3da5f7=_0x128438;try{const _0x4f330b=JSON['parse'](JSON[_0x3da5f7(0xa3)](_0x4a47fa));return _0x4f330b[_0x3da5f7(0xc4)]=_0x47fbc8,_0x4f330b;}catch(_0x1bebb6){console[_0x3da5f7(0x6f)](_0x3da5f7(0x9e),_0x1bebb6);}}),_0x502d26=await this[_0x128438(0xae)]['save'](_0x3f4079);return await this['initCalcKey'](),_0x502d26;}}}catch(_0x254e5e){console['log'](_0x128438(0xcb),_0x254e5e);}}async['delModel']({id:_0x1c80c6}){const _0x51c772=_0x1a0063;if(!_0x1c80c6)throw new common_1[(_0x51c772(0x8a))](_0x51c772(0x70),common_1['HttpStatus'][_0x51c772(0x6d)]);const _0x394394=await this[_0x51c772(0xae)]['findOne']({'where':{'id':_0x1c80c6}});if(!_0x394394)throw new common_1[(_0x51c772(0x8a))](_0x51c772(0xac),common_1[_0x51c772(0x6e)][_0x51c772(0x6d)]);const _0xa920c2=await this[_0x51c772(0xae)][_0x51c772(0xc5)]({'id':_0x1c80c6});return await this[_0x51c772(0xcd)](),_0xa920c2;}async[_0x1a0063(0x7d)](_0x56053f,_0x3d7bd4){const _0x12bdee=_0x1a0063,{role:_0x4b94e7}=_0x56053f[_0x12bdee(0x9b)],{keyType:_0x3f6df1,key:_0x59bde8,status:_0x498df2,model:_0x519e7f,page:page=0x1,size:size=0xa}=_0x3d7bd4;let _0x1b498f={};_0x3f6df1&&(_0x1b498f['keyType']=_0x3f6df1),_0x519e7f&&(_0x1b498f[_0x12bdee(0x94)]=_0x519e7f),_0x498df2&&(_0x1b498f[_0x12bdee(0x79)]=Number(_0x498df2)===0x1?!![]:![]),_0x59bde8&&(_0x1b498f[_0x12bdee(0xc4)]=(0x0,typeorm_2[_0x12bdee(0x7a)])('%'+_0x59bde8+'%'));const [_0x23229d,_0x3d1f35]=await this['modelsEntity'][_0x12bdee(0x8c)]({'where':_0x1b498f,'order':{'modelOrder':_0x12bdee(0x87)},'skip':(page-0x1)*size,'take':size});return _0x4b94e7!==_0x12bdee(0x7e)&&_0x23229d[_0x12bdee(0xba)](_0x2387b7=>{const _0x1e94ea=_0x12bdee;_0x2387b7[_0x1e94ea(0xc4)]&&(_0x2387b7[_0x1e94ea(0xc4)]=(0x0,utils_1[_0x1e94ea(0x8b)])(_0x2387b7['key'])),_0x2387b7[_0x1e94ea(0x78)]&&(_0x2387b7[_0x1e94ea(0x78)]=(0x0,utils_1[_0x1e94ea(0x8b)])(_0x2387b7['secret']));}),{'rows':_0x23229d,'count':_0x3d1f35};}async['modelsList'](){const _0x6ebc9f=_0x1a0063,_0x467c53=JSON[_0x6ebc9f(0xa7)](JSON[_0x6ebc9f(0xa3)](this[_0x6ebc9f(0xa5)]));return Object[_0x6ebc9f(0x80)](_0x467c53)['forEach'](_0x5c8066=>{const _0x2fd9de=_0x6ebc9f;_0x467c53[_0x5c8066]=_0x467c53[_0x5c8066][_0x2fd9de(0xaf)]((_0x2527f1,_0x331efd)=>_0x2527f1[_0x2fd9de(0x75)]-_0x331efd[_0x2fd9de(0x75)]),_0x467c53[_0x5c8066]=Array['from'](_0x467c53[_0x5c8066][_0x2fd9de(0xbf)](_0x4bcf02=>{const {modelName:_0x55d9d7,model:_0x5635b5,deduct:_0x1f663b,deductType:_0x1d8a9d,maxRounds:_0x11c045}=_0x4bcf02;return{'modelName':_0x55d9d7,'model':_0x5635b5,'deduct':_0x1f663b,'deductType':_0x1d8a9d,'maxRounds':_0x11c045};})['reduce']((_0x16437e,_0x2389c8)=>_0x16437e['set'](_0x2389c8['modelName'],_0x2389c8),new Map())[_0x2fd9de(0x7f)]());}),{'modelTypeList':this[_0x6ebc9f(0xbc)],'modelMaps':_0x467c53};}async[_0x1a0063(0x76)](_0x1cb301,_0x10fb02){const _0xb5dc7d=_0x1a0063;await this['modelsEntity'][_0xb5dc7d(0xa4)]()[_0xb5dc7d(0x9a)](models_entity_1[_0xb5dc7d(0xa9)])[_0xb5dc7d(0xc1)]({'useCount':()=>_0xb5dc7d(0x7c),'useToken':()=>_0xb5dc7d(0x91)+_0x10fb02})[_0xb5dc7d(0x9f)](_0xb5dc7d(0xb5),{'id':_0x1cb301})[_0xb5dc7d(0xb4)]();}async[_0x1a0063(0x97)](){const _0x20d7cb=_0x1a0063,_0x1d6c84=await this['modelsEntity'][_0x20d7cb(0x89)]({'where':{'isDraw':!![],'status':!![]}});if(!_0x1d6c84[_0x20d7cb(0x93)])throw new common_1[(_0x20d7cb(0x8a))](_0x20d7cb(0x8f),common_1[_0x20d7cb(0x6e)][_0x20d7cb(0x6d)]);return(0x0,utils_1[_0x20d7cb(0xbb)])(_0x1d6c84);}async[_0x1a0063(0x99)](){const _0x47df03=_0x1a0063;return await this[_0x47df03(0xae)]['find']();}async['queryModelType'](_0x38d180){return 0x1;}async[_0x1a0063(0x90)](_0x345616){return 0x1;}async['delModelType'](_0x114724){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0x1a0063(0xbe)])(),__param(0x0,(0x0,typeorm_1[_0x1a0063(0xca)])(models_entity_1[_0x1a0063(0xa9)])),__param(0x1,(0x0,typeorm_1[_0x1a0063(0xca)])(modelType_entity_1[_0x1a0063(0x84)])),__metadata(_0x1a0063(0x81),[typeorm_2[_0x1a0063(0xc6)],typeorm_2[_0x1a0063(0xc6)]])],ModelsService),exports[_0x1a0063(0xab)]=ModelsService;