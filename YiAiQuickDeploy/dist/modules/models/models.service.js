'use strict';function _0x5df2(_0x4541cb,_0x1c6d86){const _0x2a7f30=_0x2a7f();return _0x5df2=function(_0x5df287,_0x335015){_0x5df287=_0x5df287-0x1b6;let _0x199291=_0x2a7f30[_0x5df287];return _0x199291;},_0x5df2(_0x4541cb,_0x1c6d86);}const _0x34ffc3=_0x5df2;function _0x2a7f(){const _0x2068af=['4nJFtBI','modelTypes','log','Like','modelOrder','function','typeorm','Injectable','values','keyPoolIndexMap','../../common/utils','hideString','delModelType','keyType','852642MjMxWO','val','HttpException','modelMaps','stringify','setModelType','decorate','where','useCount\x20+\x201','1332559knNdrt','__esModule','../../common/constants/status.constant','ModelsMapCn','getOwnPropertyDescriptor','length','delModel','@nestjs/typeorm','delete','onModuleInit','findOne','BAD_REQUEST','./modelType.entity','map','reduce','__param','@nestjs/common','505640hcZcrr','execute','Repository','key:\x20','affected','80GwcheD','当前未指定特殊模型KEY、前往后台模型池设置吧！','__metadata','getBaseConfig','error:\x20','saveUseLog','InjectRepository','useToken\x20+\x20','find','defineProperty','getCurrentModelKeyInfo','ModelsEntity','__decorate','save','keyStatus','metadata','id\x20=\x20:id','user','design:paramtypes','setModel','createQueryBuilder','2559168HoxnTT','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','getRandomDrawKey','queryModelType','keys','3210702YjxjRD','2142489aLUcoU','initCalcKey','key','forEach','HttpStatus','secret','keyPoolMap','from','modelsEntity','ModelsTypeEntity','7447OToAPW','set','modelsList','update','ModelsService','14810vLhIHT','status','parse','lockKey','12rXNwRP','keyList','push'];_0x2a7f=function(){return _0x2068af;};return _0x2a7f();}(function(_0x24e4c6,_0x2a626d){const _0x5bd264=_0x5df2,_0x1f5e66=_0x24e4c6();while(!![]){try{const _0x2cdaed=parseInt(_0x5bd264(0x1ba))/0x1+parseInt(_0x5bd264(0x1ea))/0x2+parseInt(_0x5bd264(0x1eb))/0x3*(parseInt(_0x5bd264(0x201))/0x4)+parseInt(_0x5bd264(0x1cb))/0x5*(-parseInt(_0x5bd264(0x1fe))/0x6)+-parseInt(_0x5bd264(0x20f))/0x7*(parseInt(_0x5bd264(0x1d0))/0x8)+-parseInt(_0x5bd264(0x1e5))/0x9+-parseInt(_0x5bd264(0x1fa))/0xa*(parseInt(_0x5bd264(0x1f5))/0xb);if(_0x2cdaed===_0x2a626d)break;else _0x1f5e66['push'](_0x1f5e66['shift']());}catch(_0x3f2acc){_0x1f5e66['push'](_0x1f5e66['shift']());}}}(_0x2a7f,0xe6a80));var __decorate=this&&this[_0x34ffc3(0x1dc)]||function(_0x7e5bd5,_0x29536e,_0x1ad360,_0x487407){const _0x39a68a=_0x34ffc3;var _0x52f5da=arguments['length'],_0x3b58c6=_0x52f5da<0x3?_0x29536e:_0x487407===null?_0x487407=Object[_0x39a68a(0x1be)](_0x29536e,_0x1ad360):_0x487407,_0x47a3f4;if(typeof Reflect==='object'&&typeof Reflect[_0x39a68a(0x1b7)]===_0x39a68a(0x206))_0x3b58c6=Reflect[_0x39a68a(0x1b7)](_0x7e5bd5,_0x29536e,_0x1ad360,_0x487407);else{for(var _0x11d519=_0x7e5bd5[_0x39a68a(0x1bf)]-0x1;_0x11d519>=0x0;_0x11d519--)if(_0x47a3f4=_0x7e5bd5[_0x11d519])_0x3b58c6=(_0x52f5da<0x3?_0x47a3f4(_0x3b58c6):_0x52f5da>0x3?_0x47a3f4(_0x29536e,_0x1ad360,_0x3b58c6):_0x47a3f4(_0x29536e,_0x1ad360))||_0x3b58c6;}return _0x52f5da>0x3&&_0x3b58c6&&Object[_0x39a68a(0x1d9)](_0x29536e,_0x1ad360,_0x3b58c6),_0x3b58c6;},__metadata=this&&this[_0x34ffc3(0x1d2)]||function(_0x867778,_0x548903){const _0x34cfd1=_0x34ffc3;if(typeof Reflect==='object'&&typeof Reflect[_0x34cfd1(0x1df)]==='function')return Reflect[_0x34cfd1(0x1df)](_0x867778,_0x548903);},__param=this&&this[_0x34ffc3(0x1c9)]||function(_0x4be6f8,_0x33ef1f){return function(_0x5628c6,_0x940c7b){_0x33ef1f(_0x5628c6,_0x940c7b,_0x4be6f8);};};Object[_0x34ffc3(0x1d9)](exports,_0x34ffc3(0x1bb),{'value':!![]}),exports[_0x34ffc3(0x1f9)]=void 0x0;const common_1=require(_0x34ffc3(0x1ca)),typeorm_1=require(_0x34ffc3(0x1c1)),typeorm_2=require(_0x34ffc3(0x207)),models_entity_1=require('./models.entity'),status_constant_1=require(_0x34ffc3(0x1bc)),utils_1=require(_0x34ffc3(0x20b)),modelType_entity_1=require(_0x34ffc3(0x1c6));let ModelsService=class ModelsService{constructor(_0x53b5e0,_0x5126ed){const _0x1a52d0=_0x34ffc3;this['modelsEntity']=_0x53b5e0,this['modelsTypeEntity']=_0x5126ed,this[_0x1a52d0(0x202)]=[],this[_0x1a52d0(0x212)]={},this['keyList']={},this[_0x1a52d0(0x1f1)]={},this['keyPoolIndexMap']={};}async[_0x34ffc3(0x1c3)](){const _0x3bafdc=_0x34ffc3;await this[_0x3bafdc(0x1ec)]();}async[_0x34ffc3(0x1ec)](){const _0x55a18e=_0x34ffc3;this[_0x55a18e(0x1f1)]={},this[_0x55a18e(0x20a)]={},this[_0x55a18e(0x1ff)]={},this[_0x55a18e(0x212)]={},this['modelTypes']=[];const _0x573520=await this['modelsEntity']['find']({'where':{'status':!![]}}),_0x2a7ed8=_0x573520[_0x55a18e(0x1c8)]((_0x44f57b,_0x360501)=>{const _0x218de9=_0x55a18e;return!_0x44f57b[_0x360501[_0x218de9(0x20e)]]?_0x44f57b[_0x360501[_0x218de9(0x20e)]]=[_0x360501]:_0x44f57b[_0x360501[_0x218de9(0x20e)]]['push'](_0x360501),_0x44f57b;},{});this[_0x55a18e(0x202)]=Object[_0x55a18e(0x1e9)](_0x2a7ed8)[_0x55a18e(0x1c7)](_0x5b4456=>{const _0x17dc31=_0x55a18e;return{'label':status_constant_1[_0x17dc31(0x1bd)][_0x5b4456],'val':_0x5b4456};}),this['modelMaps']=_0x2a7ed8,this[_0x55a18e(0x1ff)]={},_0x573520[_0x55a18e(0x1ee)](_0x5dbf59=>{const _0xc91061=_0x55a18e,{keyType:_0x400668,model:_0x123ec7,keyWeight:_0x52d05b}=_0x5dbf59;if(!this[_0xc91061(0x1f1)][_0x123ec7])this[_0xc91061(0x1f1)][_0x123ec7]=[];for(let _0xae366d=0x0;_0xae366d<_0x52d05b;_0xae366d++){this['keyPoolMap'][_0x123ec7]['push'](_0x5dbf59);}if(!this[_0xc91061(0x20a)][_0x123ec7])this[_0xc91061(0x20a)][_0x123ec7]=0x0;if(!this['keyList'][_0x400668])this['keyList'][_0x400668]={};if(!this[_0xc91061(0x1ff)][_0x400668][_0x123ec7])this[_0xc91061(0x1ff)][_0x400668][_0x123ec7]=[];this[_0xc91061(0x1ff)][_0x400668][_0x123ec7][_0xc91061(0x200)](_0x5dbf59);});}async[_0x34ffc3(0x1fd)](_0x378d62,_0x582e67,_0x150a03=-0x1){const _0xbb018f=_0x34ffc3,_0x3a344d=await this[_0xbb018f(0x1f3)]['update']({'id':_0x378d62},{'status':![],'keyStatus':_0x150a03,'remark':_0x582e67});common_1['Logger']['error'](_0xbb018f(0x1ce)+_0x378d62+_0xbb018f(0x1e6)),this[_0xbb018f(0x1ec)]();}async[_0x34ffc3(0x1da)](_0x57c925){const _0x40f17d=_0x34ffc3;if(!this[_0x40f17d(0x1f1)][_0x57c925])throw new common_1[(_0x40f17d(0x211))]('当前调用模型已经被移除、请重新选择模型！',common_1[_0x40f17d(0x1ef)][_0x40f17d(0x1c5)]);this[_0x40f17d(0x20a)][_0x57c925]++;const _0x55efef=this[_0x40f17d(0x20a)][_0x57c925];if(_0x55efef>=this[_0x40f17d(0x1f1)][_0x57c925][_0x40f17d(0x1bf)])this[_0x40f17d(0x20a)][_0x57c925]=0x0;const _0x480a7b=this['keyPoolMap'][_0x57c925][this[_0x40f17d(0x20a)][_0x57c925]];return _0x480a7b;}async[_0x34ffc3(0x1d3)](_0x589507){const _0xf1687=_0x34ffc3;if(!this[_0xf1687(0x202)][_0xf1687(0x1bf)]||!Object[_0xf1687(0x1e9)](this[_0xf1687(0x212)])[_0xf1687(0x1bf)])return;const _0x56d7c5=_0x589507?this[_0xf1687(0x202)][_0xf1687(0x1d8)](_0x579287=>Number(_0x579287['val'])===0x1):this[_0xf1687(0x202)][0x0];if(!_0x56d7c5)return;const {keyType:_0x4a89ae,modelName:_0x11b298,model:_0x42c15f,maxModelTokens:_0x18fcee,maxResponseTokens:_0x274907,deductType:_0x270b56,deduct:_0x1f396c,maxRounds:_0x76fb1e}=this[_0xf1687(0x212)][_0x56d7c5[_0xf1687(0x210)]][0x0];return{'modelTypeInfo':_0x56d7c5,'modelInfo':{'keyType':_0x4a89ae,'modelName':_0x11b298,'model':_0x42c15f,'maxModelTokens':_0x18fcee,'maxResponseTokens':_0x274907,'topN':0.8,'systemMessage':'','deductType':_0x270b56,'deduct':_0x1f396c,'maxRounds':_0x76fb1e,'rounds':0x8}};}async[_0x34ffc3(0x1e3)](_0x426617){const _0x5b9688=_0x34ffc3;try{const {id:_0x2ac619}=_0x426617;_0x426617[_0x5b9688(0x1fb)]&&(_0x426617[_0x5b9688(0x1de)]=0x1);if(_0x2ac619){const _0x10eacf=await this['modelsEntity'][_0x5b9688(0x1f8)]({'id':_0x2ac619},_0x426617);return await this[_0x5b9688(0x1ec)](),_0x10eacf[_0x5b9688(0x1cf)]>0x0;}else{const {keyType:_0x54cda5,key:_0x414ac5}=_0x426617;if(Number(_0x54cda5!==0x1)){const _0x34a8db=await this['modelsEntity']['save'](_0x426617);return await this[_0x5b9688(0x1ec)](),_0x34a8db;}else{const _0x32299d=_0x414ac5[_0x5b9688(0x1c7)](_0x3bc4d3=>{const _0x2c4a46=_0x5b9688;try{const _0x12750f=JSON[_0x2c4a46(0x1fc)](JSON[_0x2c4a46(0x213)](_0x426617));return _0x12750f[_0x2c4a46(0x1ed)]=_0x3bc4d3,_0x12750f;}catch(_0x3fb243){console[_0x2c4a46(0x203)]('parse\x20error:\x20',_0x3fb243);}}),_0x51b378=await this[_0x5b9688(0x1f3)][_0x5b9688(0x1dd)](_0x32299d);return await this['initCalcKey'](),_0x51b378;}}}catch(_0x33a5dc){console['log'](_0x5b9688(0x1d4),_0x33a5dc);}}async[_0x34ffc3(0x1c0)]({id:_0x3da9ba}){const _0x4e4544=_0x34ffc3;if(!_0x3da9ba)throw new common_1[(_0x4e4544(0x211))]('缺失必要参数！',common_1[_0x4e4544(0x1ef)]['BAD_REQUEST']);const _0x9eb571=await this[_0x4e4544(0x1f3)][_0x4e4544(0x1c4)]({'where':{'id':_0x3da9ba}});if(!_0x9eb571)throw new common_1['HttpException']('当前账号不存在！',common_1[_0x4e4544(0x1ef)][_0x4e4544(0x1c5)]);const _0x3ea0a9=await this['modelsEntity'][_0x4e4544(0x1c2)]({'id':_0x3da9ba});return await this[_0x4e4544(0x1ec)](),_0x3ea0a9;}async['queryModels'](_0x34d931,_0x374b5a){const _0x191b43=_0x34ffc3,{role:_0x3ead9d}=_0x34d931[_0x191b43(0x1e1)],{keyType:_0x534873,key:_0x22b428,status:_0x55552d,model:_0x26ec98,page:page=0x1,size:size=0xa}=_0x374b5a;let _0x18d329={};_0x534873&&(_0x18d329[_0x191b43(0x20e)]=_0x534873),_0x26ec98&&(_0x18d329['model']=_0x26ec98),_0x55552d&&(_0x18d329[_0x191b43(0x1fb)]=Number(_0x55552d)===0x1?!![]:![]),_0x22b428&&(_0x18d329[_0x191b43(0x1ed)]=(0x0,typeorm_2[_0x191b43(0x204)])('%'+_0x22b428+'%'));const [_0x5f0cf9,_0x31302e]=await this['modelsEntity']['findAndCount']({'where':_0x18d329,'order':{'modelOrder':'ASC'},'skip':(page-0x1)*size,'take':size});return _0x3ead9d!=='super'&&_0x5f0cf9[_0x191b43(0x1ee)](_0x4de090=>{const _0x5f0c59=_0x191b43;_0x4de090[_0x5f0c59(0x1ed)]&&(_0x4de090[_0x5f0c59(0x1ed)]=(0x0,utils_1[_0x5f0c59(0x20c)])(_0x4de090[_0x5f0c59(0x1ed)])),_0x4de090[_0x5f0c59(0x1f0)]&&(_0x4de090[_0x5f0c59(0x1f0)]=(0x0,utils_1['hideString'])(_0x4de090[_0x5f0c59(0x1f0)]));}),{'rows':_0x5f0cf9,'count':_0x31302e};}async[_0x34ffc3(0x1f7)](){const _0x2d7d73=_0x34ffc3,_0x4e2fd9=JSON[_0x2d7d73(0x1fc)](JSON['stringify'](this[_0x2d7d73(0x212)]));return Object[_0x2d7d73(0x1e9)](_0x4e2fd9)[_0x2d7d73(0x1ee)](_0x4649fe=>{const _0x161f6f=_0x2d7d73;_0x4e2fd9[_0x4649fe]=_0x4e2fd9[_0x4649fe]['sort']((_0x211742,_0x15617f)=>_0x211742[_0x161f6f(0x205)]-_0x15617f[_0x161f6f(0x205)]),_0x4e2fd9[_0x4649fe]=Array[_0x161f6f(0x1f2)](_0x4e2fd9[_0x4649fe]['map'](_0x334224=>{const {modelName:_0x1c2136,model:_0x164f00,deduct:_0x383ca9,deductType:_0xd2d14b,maxRounds:_0x386476}=_0x334224;return{'modelName':_0x1c2136,'model':_0x164f00,'deduct':_0x383ca9,'deductType':_0xd2d14b,'maxRounds':_0x386476};})[_0x161f6f(0x1c8)]((_0xc0b5d5,_0x3bb94a)=>_0xc0b5d5[_0x161f6f(0x1f6)](_0x3bb94a['modelName'],_0x3bb94a),new Map())[_0x161f6f(0x209)]());}),{'modelTypeList':this['modelTypes'],'modelMaps':_0x4e2fd9};}async[_0x34ffc3(0x1d5)](_0x6a046b,_0x189775){const _0x54b0a6=_0x34ffc3;await this[_0x54b0a6(0x1f3)][_0x54b0a6(0x1e4)]()[_0x54b0a6(0x1f8)](models_entity_1[_0x54b0a6(0x1db)])[_0x54b0a6(0x1f6)]({'useCount':()=>_0x54b0a6(0x1b9),'useToken':()=>_0x54b0a6(0x1d7)+_0x189775})[_0x54b0a6(0x1b8)](_0x54b0a6(0x1e0),{'id':_0x6a046b})[_0x54b0a6(0x1cc)]();}async[_0x34ffc3(0x1e7)](){const _0x634903=_0x34ffc3,_0x2d5371=await this['modelsEntity'][_0x634903(0x1d8)]({'where':{'isDraw':!![],'status':!![]}});if(!_0x2d5371['length'])throw new common_1[(_0x634903(0x211))](_0x634903(0x1d1),common_1['HttpStatus'][_0x634903(0x1c5)]);return(0x0,utils_1['getRandomItemFromArray'])(_0x2d5371);}async['getAllKey'](){const _0x14e2e8=_0x34ffc3;return await this['modelsEntity'][_0x14e2e8(0x1d8)]();}async[_0x34ffc3(0x1e8)](_0x3c0351){return 0x1;}async[_0x34ffc3(0x1b6)](_0x37ef4a){return 0x1;}async[_0x34ffc3(0x20d)](_0x4cb94c){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0x34ffc3(0x208)])(),__param(0x0,(0x0,typeorm_1[_0x34ffc3(0x1d6)])(models_entity_1[_0x34ffc3(0x1db)])),__param(0x1,(0x0,typeorm_1[_0x34ffc3(0x1d6)])(modelType_entity_1[_0x34ffc3(0x1f4)])),__metadata(_0x34ffc3(0x1e2),[typeorm_2[_0x34ffc3(0x1cd)],typeorm_2[_0x34ffc3(0x1cd)]])],ModelsService),exports[_0x34ffc3(0x1f9)]=ModelsService;