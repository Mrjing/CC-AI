'use strict';const _0x2331bd=_0x227b;function _0x3ac7(){const _0xa58128=['ModelsMapCn','HttpStatus','typeorm','keyList','object','119nhOnfw','metadata','delModelType','BAD_REQUEST','当前账号不存在！','affected','modelsList','forEach','2584kJmheU','user','update','340710XHTjWR','getAllKey','map','setModel','modelsTypeEntity','@nestjs/typeorm','super','ModelsEntity','../../common/utils','queryModelType','design:paramtypes','reduce','find','stringify','4180190wjkgXd','modelMaps','getOwnPropertyDescriptor','__param','当前未指定特殊模型KEY、前往后台模型池设置吧！','290SRKvRX','id\x20=\x20:id','14392OvAoGs','./modelType.entity','modelsEntity','__decorate','push','key','keyPoolMap','1137129YRuLdq','length','function','Repository','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','key:\x20','lockKey','keyPoolIndexMap','defineProperty','setModelType','keys','decorate','InjectRepository','1181844ixXrxf','onModuleInit','modelName','HttpException','set','saveUseLog','hideString','from','sort','parse','model','getBaseConfig','secret','Like','缺失必要参数！','save','107991OmGeEP','parse\x20error:\x20','ModelsService','findOne','34MyVrfb','../../common/constants/status.constant','modelTypes','keyType','./models.entity','initCalcKey','useCount\x20+\x201','__metadata','queryModels','val','modelOrder','delModel','getRandomDrawKey','ModelsTypeEntity','useToken\x20+\x20','log','ASC','__esModule','keyStatus'];_0x3ac7=function(){return _0xa58128;};return _0x3ac7();}(function(_0x8da9f9,_0x2cdae4){const _0x363a1f=_0x227b,_0x2b1d95=_0x8da9f9();while(!![]){try{const _0x2e60b1=parseInt(_0x363a1f(0x1cf))/0x1*(-parseInt(_0x363a1f(0x1af))/0x2)+-parseInt(_0x363a1f(0x18e))/0x3+parseInt(_0x363a1f(0x19b))/0x4+parseInt(_0x363a1f(0x1e0))/0x5+parseInt(_0x363a1f(0x1d2))/0x6+-parseInt(_0x363a1f(0x1c7))/0x7*(-parseInt(_0x363a1f(0x187))/0x8)+-parseInt(_0x363a1f(0x1ab))/0x9*(parseInt(_0x363a1f(0x185))/0xa);if(_0x2e60b1===_0x2cdae4)break;else _0x2b1d95['push'](_0x2b1d95['shift']());}catch(_0x582979){_0x2b1d95['push'](_0x2b1d95['shift']());}}}(_0x3ac7,0x6d5b5));var __decorate=this&&this[_0x2331bd(0x18a)]||function(_0x14ad37,_0xdfbf08,_0x456c8e,_0x25bda6){const _0x279d26=_0x2331bd;var _0x3da3d3=arguments[_0x279d26(0x18f)],_0x3ac596=_0x3da3d3<0x3?_0xdfbf08:_0x25bda6===null?_0x25bda6=Object[_0x279d26(0x182)](_0xdfbf08,_0x456c8e):_0x25bda6,_0x396e38;if(typeof Reflect===_0x279d26(0x1c6)&&typeof Reflect[_0x279d26(0x199)]==='function')_0x3ac596=Reflect[_0x279d26(0x199)](_0x14ad37,_0xdfbf08,_0x456c8e,_0x25bda6);else{for(var _0x4a1bbd=_0x14ad37[_0x279d26(0x18f)]-0x1;_0x4a1bbd>=0x0;_0x4a1bbd--)if(_0x396e38=_0x14ad37[_0x4a1bbd])_0x3ac596=(_0x3da3d3<0x3?_0x396e38(_0x3ac596):_0x3da3d3>0x3?_0x396e38(_0xdfbf08,_0x456c8e,_0x3ac596):_0x396e38(_0xdfbf08,_0x456c8e))||_0x3ac596;}return _0x3da3d3>0x3&&_0x3ac596&&Object['defineProperty'](_0xdfbf08,_0x456c8e,_0x3ac596),_0x3ac596;},__metadata=this&&this[_0x2331bd(0x1b6)]||function(_0x50642f,_0x991458){const _0x35af7e=_0x2331bd;if(typeof Reflect===_0x35af7e(0x1c6)&&typeof Reflect[_0x35af7e(0x1c8)]===_0x35af7e(0x190))return Reflect['metadata'](_0x50642f,_0x991458);},__param=this&&this[_0x2331bd(0x183)]||function(_0x11428e,_0x24ab94){return function(_0x434d2c,_0x778981){_0x24ab94(_0x434d2c,_0x778981,_0x11428e);};};Object[_0x2331bd(0x196)](exports,_0x2331bd(0x1c0),{'value':!![]}),exports[_0x2331bd(0x1ad)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x2331bd(0x1d7)),typeorm_2=require(_0x2331bd(0x1c4)),models_entity_1=require(_0x2331bd(0x1b3)),status_constant_1=require(_0x2331bd(0x1b0)),utils_1=require(_0x2331bd(0x1da)),modelType_entity_1=require(_0x2331bd(0x188));function _0x227b(_0x596209,_0xac0737){const _0x3ac7c3=_0x3ac7();return _0x227b=function(_0x227b39,_0x1a4cef){_0x227b39=_0x227b39-0x182;let _0x36ec4a=_0x3ac7c3[_0x227b39];return _0x36ec4a;},_0x227b(_0x596209,_0xac0737);}let ModelsService=class ModelsService{constructor(_0x272401,_0x34ce18){const _0x46e27c=_0x2331bd;this[_0x46e27c(0x189)]=_0x272401,this[_0x46e27c(0x1d6)]=_0x34ce18,this[_0x46e27c(0x1b1)]=[],this[_0x46e27c(0x1e1)]={},this[_0x46e27c(0x1c5)]={},this[_0x46e27c(0x18d)]={},this['keyPoolIndexMap']={};}async[_0x2331bd(0x19c)](){await this['initCalcKey']();}async[_0x2331bd(0x1b4)](){const _0x276969=_0x2331bd;this[_0x276969(0x18d)]={},this[_0x276969(0x195)]={},this['keyList']={},this[_0x276969(0x1e1)]={},this[_0x276969(0x1b1)]=[];const _0x228640=await this['modelsEntity'][_0x276969(0x1de)]({'where':{'status':!![]}}),_0x4597be=_0x228640[_0x276969(0x1dd)]((_0x3e7ed5,_0x208850)=>{const _0x44d62d=_0x276969;return!_0x3e7ed5[_0x208850['keyType']]?_0x3e7ed5[_0x208850[_0x44d62d(0x1b2)]]=[_0x208850]:_0x3e7ed5[_0x208850[_0x44d62d(0x1b2)]][_0x44d62d(0x18b)](_0x208850),_0x3e7ed5;},{});this['modelTypes']=Object[_0x276969(0x198)](_0x4597be)['map'](_0x5beb21=>{const _0x46e9c4=_0x276969;return{'label':status_constant_1[_0x46e9c4(0x1c2)][_0x5beb21],'val':_0x5beb21};}),this[_0x276969(0x1e1)]=_0x4597be,this['keyList']={},_0x228640[_0x276969(0x1ce)](_0x18c853=>{const _0x545e7d=_0x276969,{keyType:_0x27e021,model:_0x10c703,keyWeight:_0x433e2f}=_0x18c853;if(!this[_0x545e7d(0x18d)][_0x10c703])this[_0x545e7d(0x18d)][_0x10c703]=[];for(let _0x466148=0x0;_0x466148<_0x433e2f;_0x466148++){this[_0x545e7d(0x18d)][_0x10c703]['push'](_0x18c853);}if(!this[_0x545e7d(0x195)][_0x10c703])this[_0x545e7d(0x195)][_0x10c703]=0x0;if(!this[_0x545e7d(0x1c5)][_0x27e021])this[_0x545e7d(0x1c5)][_0x27e021]={};if(!this['keyList'][_0x27e021][_0x10c703])this[_0x545e7d(0x1c5)][_0x27e021][_0x10c703]=[];this[_0x545e7d(0x1c5)][_0x27e021][_0x10c703][_0x545e7d(0x18b)](_0x18c853);});}async[_0x2331bd(0x194)](_0x5dfb54,_0x5d92ad,_0x225f05=-0x1){const _0x2be63a=_0x2331bd,_0x161d30=await this[_0x2be63a(0x189)][_0x2be63a(0x1d1)]({'id':_0x5dfb54},{'status':![],'keyStatus':_0x225f05,'remark':_0x5d92ad});common_1['Logger']['error'](_0x2be63a(0x193)+_0x5dfb54+_0x2be63a(0x192)),this['initCalcKey']();}async['getCurrentModelKeyInfo'](_0x336532){const _0x561b5c=_0x2331bd;if(!this[_0x561b5c(0x18d)][_0x336532])throw new common_1['HttpException']('当前调用模型已经被移除、请重新选择模型！',common_1[_0x561b5c(0x1c3)][_0x561b5c(0x1ca)]);this[_0x561b5c(0x195)][_0x336532]++;const _0x3f88c9=this[_0x561b5c(0x195)][_0x336532];if(_0x3f88c9>=this['keyPoolMap'][_0x336532][_0x561b5c(0x18f)])this[_0x561b5c(0x195)][_0x336532]=0x0;const _0x145c3f=this[_0x561b5c(0x18d)][_0x336532][this['keyPoolIndexMap'][_0x336532]];return _0x145c3f;}async[_0x2331bd(0x1a6)](_0x347646){const _0x438aee=_0x2331bd;if(!this[_0x438aee(0x1b1)][_0x438aee(0x18f)]||!Object[_0x438aee(0x198)](this[_0x438aee(0x1e1)])[_0x438aee(0x18f)])return;const _0x214771=_0x347646?this[_0x438aee(0x1b1)]['find'](_0x5485e7=>Number(_0x5485e7[_0x438aee(0x1b8)])===0x1):this[_0x438aee(0x1b1)][0x0];if(!_0x214771)return;const {keyType:_0x11bf61,modelName:_0x5a42ec,model:_0x542595,maxModelTokens:_0x4d7c14,maxResponseTokens:_0x11a8ae,deductType:_0x2d308a,deduct:_0x5a681d,maxRounds:_0x944b91}=this[_0x438aee(0x1e1)][_0x214771[_0x438aee(0x1b8)]][0x0];return{'modelTypeInfo':_0x214771,'modelInfo':{'keyType':_0x11bf61,'modelName':_0x5a42ec,'model':_0x542595,'maxModelTokens':_0x4d7c14,'maxResponseTokens':_0x11a8ae,'topN':0.8,'systemMessage':'','deductType':_0x2d308a,'deduct':_0x5a681d,'maxRounds':_0x944b91,'rounds':0x8}};}async[_0x2331bd(0x1d5)](_0xdbf20f){const _0x412ef8=_0x2331bd;try{const {id:_0x41a3be}=_0xdbf20f;_0xdbf20f['status']&&(_0xdbf20f[_0x412ef8(0x1c1)]=0x1);if(_0x41a3be){const _0x5c952e=await this[_0x412ef8(0x189)][_0x412ef8(0x1d1)]({'id':_0x41a3be},_0xdbf20f);return await this[_0x412ef8(0x1b4)](),_0x5c952e[_0x412ef8(0x1cc)]>0x0;}else{const {keyType:_0xba8871,key:_0x3d8d1e}=_0xdbf20f;if(Number(_0xba8871!==0x1)){const _0x1648bc=await this[_0x412ef8(0x189)][_0x412ef8(0x1aa)](_0xdbf20f);return await this[_0x412ef8(0x1b4)](),_0x1648bc;}else{const _0x449ff0=_0x3d8d1e[_0x412ef8(0x1d4)](_0x364f7b=>{const _0x26b34f=_0x412ef8;try{const _0x5bf412=JSON[_0x26b34f(0x1a4)](JSON[_0x26b34f(0x1df)](_0xdbf20f));return _0x5bf412[_0x26b34f(0x18c)]=_0x364f7b,_0x5bf412;}catch(_0x4d9641){console[_0x26b34f(0x1be)](_0x26b34f(0x1ac),_0x4d9641);}}),_0x9305f0=await this[_0x412ef8(0x189)][_0x412ef8(0x1aa)](_0x449ff0);return await this[_0x412ef8(0x1b4)](),_0x9305f0;}}}catch(_0x5a1871){console[_0x412ef8(0x1be)]('error:\x20',_0x5a1871);}}async[_0x2331bd(0x1ba)]({id:_0x2a60b5}){const _0x389062=_0x2331bd;if(!_0x2a60b5)throw new common_1[(_0x389062(0x19e))](_0x389062(0x1a9),common_1['HttpStatus']['BAD_REQUEST']);const _0x23fb0d=await this[_0x389062(0x189)][_0x389062(0x1ae)]({'where':{'id':_0x2a60b5}});if(!_0x23fb0d)throw new common_1['HttpException'](_0x389062(0x1cb),common_1[_0x389062(0x1c3)][_0x389062(0x1ca)]);const _0x417205=await this[_0x389062(0x189)]['delete']({'id':_0x2a60b5});return await this[_0x389062(0x1b4)](),_0x417205;}async[_0x2331bd(0x1b7)](_0x1c62fc,_0x58c33e){const _0x108fce=_0x2331bd,{role:_0xcb1f85}=_0x1c62fc[_0x108fce(0x1d0)],{keyType:_0x5b9383,key:_0x31646e,status:_0x408ac5,model:_0x108345,page:page=0x1,size:size=0xa}=_0x58c33e;let _0x4c9c56={};_0x5b9383&&(_0x4c9c56[_0x108fce(0x1b2)]=_0x5b9383),_0x108345&&(_0x4c9c56[_0x108fce(0x1a5)]=_0x108345),_0x408ac5&&(_0x4c9c56['status']=Number(_0x408ac5)===0x1?!![]:![]),_0x31646e&&(_0x4c9c56[_0x108fce(0x18c)]=(0x0,typeorm_2[_0x108fce(0x1a8)])('%'+_0x31646e+'%'));const [_0x25d8b1,_0x1bbcea]=await this[_0x108fce(0x189)]['findAndCount']({'where':_0x4c9c56,'order':{'modelOrder':_0x108fce(0x1bf)},'skip':(page-0x1)*size,'take':size});return _0xcb1f85!==_0x108fce(0x1d8)&&_0x25d8b1['forEach'](_0x4f366f=>{const _0x30049a=_0x108fce;_0x4f366f[_0x30049a(0x18c)]&&(_0x4f366f[_0x30049a(0x18c)]=(0x0,utils_1[_0x30049a(0x1a1)])(_0x4f366f[_0x30049a(0x18c)])),_0x4f366f['secret']&&(_0x4f366f[_0x30049a(0x1a7)]=(0x0,utils_1['hideString'])(_0x4f366f[_0x30049a(0x1a7)]));}),{'rows':_0x25d8b1,'count':_0x1bbcea};}async[_0x2331bd(0x1cd)](){const _0x194372=_0x2331bd,_0x3ec761=JSON[_0x194372(0x1a4)](JSON[_0x194372(0x1df)](this[_0x194372(0x1e1)]));return Object[_0x194372(0x198)](_0x3ec761)[_0x194372(0x1ce)](_0x21750e=>{const _0xe6dfd3=_0x194372;_0x3ec761[_0x21750e]=_0x3ec761[_0x21750e][_0xe6dfd3(0x1a3)]((_0x185b73,_0x4281fb)=>_0x185b73[_0xe6dfd3(0x1b9)]-_0x4281fb[_0xe6dfd3(0x1b9)]),_0x3ec761[_0x21750e]=Array[_0xe6dfd3(0x1a2)](_0x3ec761[_0x21750e]['map'](_0x4c5d03=>{const {modelName:_0x44db4f,model:_0x3f4288,deduct:_0x6d2e0f,deductType:_0x25b361,maxRounds:_0x345e2e}=_0x4c5d03;return{'modelName':_0x44db4f,'model':_0x3f4288,'deduct':_0x6d2e0f,'deductType':_0x25b361,'maxRounds':_0x345e2e};})[_0xe6dfd3(0x1dd)]((_0x393566,_0x1ad980)=>_0x393566[_0xe6dfd3(0x19f)](_0x1ad980[_0xe6dfd3(0x19d)],_0x1ad980),new Map())['values']());}),{'modelTypeList':this['modelTypes'],'modelMaps':_0x3ec761};}async[_0x2331bd(0x1a0)](_0x2e80fb,_0x8dd4db){const _0x580eb5=_0x2331bd;await this['modelsEntity']['createQueryBuilder']()[_0x580eb5(0x1d1)](models_entity_1[_0x580eb5(0x1d9)])[_0x580eb5(0x19f)]({'useCount':()=>_0x580eb5(0x1b5),'useToken':()=>_0x580eb5(0x1bd)+_0x8dd4db})['where'](_0x580eb5(0x186),{'id':_0x2e80fb})['execute']();}async[_0x2331bd(0x1bb)](){const _0x17489b=_0x2331bd,_0x48574e=await this[_0x17489b(0x189)][_0x17489b(0x1de)]({'where':{'isDraw':!![],'status':!![]}});if(!_0x48574e[_0x17489b(0x18f)])throw new common_1[(_0x17489b(0x19e))](_0x17489b(0x184),common_1['HttpStatus'][_0x17489b(0x1ca)]);return(0x0,utils_1['getRandomItemFromArray'])(_0x48574e);}async[_0x2331bd(0x1d3)](){const _0xc637b5=_0x2331bd;return await this[_0xc637b5(0x189)][_0xc637b5(0x1de)]();}async[_0x2331bd(0x1db)](_0x4c1c12){return 0x1;}async[_0x2331bd(0x197)](_0x20676c){return 0x1;}async[_0x2331bd(0x1c9)](_0x51cefa){return 0x1;}};ModelsService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x2331bd(0x19a)])(models_entity_1[_0x2331bd(0x1d9)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(modelType_entity_1[_0x2331bd(0x1bc)])),__metadata(_0x2331bd(0x1dc),[typeorm_2[_0x2331bd(0x191)],typeorm_2[_0x2331bd(0x191)]])],ModelsService),exports['ModelsService']=ModelsService;