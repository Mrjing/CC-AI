'use strict';const _0x466ff4=_0x2a56;(function(_0xc6e6a2,_0x24f28e){const _0xf832d0=_0x2a56,_0x4b86e3=_0xc6e6a2();while(!![]){try{const _0x35fd32=parseInt(_0xf832d0(0x17d))/0x1+parseInt(_0xf832d0(0x1a6))/0x2*(-parseInt(_0xf832d0(0x19c))/0x3)+parseInt(_0xf832d0(0x16d))/0x4+parseInt(_0xf832d0(0x178))/0x5+parseInt(_0xf832d0(0x166))/0x6+-parseInt(_0xf832d0(0x198))/0x7+-parseInt(_0xf832d0(0x1a0))/0x8;if(_0x35fd32===_0x24f28e)break;else _0x4b86e3['push'](_0x4b86e3['shift']());}catch(_0x1c93ff){_0x4b86e3['push'](_0x4b86e3['shift']());}}}(_0x1214,0x2d751));function _0x2a56(_0x5e49e8,_0x2a7af0){const _0x1214f4=_0x1214();return _0x2a56=function(_0x2a561c,_0x5958fa){_0x2a561c=_0x2a561c-0x15d;let _0x192b33=_0x1214f4[_0x2a561c];return _0x192b33;},_0x2a56(_0x5e49e8,_0x2a7af0);}function _0x1214(){const _0xdc5999=['day','decorate','findOne','default','sign','typeorm','SIGN_IN','function','SigninEntity','update','save','setDate','HttpStatus','__esModule','../../common/constants/balance.constant','昨天没签到、今天重置天数！','andWhere','GlobalConfigService','length','762825NujKmO','log','defineProperty','@nestjs/typeorm','3hYqjzG','debug','Injectable','addBalanceToUser','4835200WzrVop','signin.signInTime\x20<=\x20:lastDay','RechargeType','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','../user/user.entity','./signIn.entity','711114KHmoXw','@nestjs/common','Repository','UserEntity','format','push','今日已签到、改天再来吧!.','Logger','signin','createQueryBuilder','__param','2130534CSEbLL','SigninService','YYYY-MM-DD','signin.userId\x20=\x20:userId','../userBalance/userBalance.service','YYYY-MM-DD\x20HH:mm:ss','error:\x20','1274576zQhCOJ','userBalanceService','BAD_REQUEST','../globalConfig/globalConfig.service','metadata','../../common/utils/date','userEntity','signInDate','getSignatureGiftConfig','month','object','1469820XvJSar','getSigninLog','globalConfigService','getDate','getRawMany','287428KRlfHD','design:paramtypes','__decorate','user','signinEntity','HttpException','getOwnPropertyDescriptor','__metadata'];_0x1214=function(){return _0xdc5999;};return _0x1214();}var __decorate=this&&this[_0x466ff4(0x17f)]||function(_0x466c51,_0x456238,_0x31a5fa,_0x4d1156){const _0x3af8df=_0x466ff4;var _0x4a106a=arguments[_0x3af8df(0x197)],_0x453c5a=_0x4a106a<0x3?_0x456238:_0x4d1156===null?_0x4d1156=Object[_0x3af8df(0x183)](_0x456238,_0x31a5fa):_0x4d1156,_0x849595;if(typeof Reflect===_0x3af8df(0x177)&&typeof Reflect['decorate']===_0x3af8df(0x18c))_0x453c5a=Reflect[_0x3af8df(0x186)](_0x466c51,_0x456238,_0x31a5fa,_0x4d1156);else{for(var _0x4f1fe6=_0x466c51['length']-0x1;_0x4f1fe6>=0x0;_0x4f1fe6--)if(_0x849595=_0x466c51[_0x4f1fe6])_0x453c5a=(_0x4a106a<0x3?_0x849595(_0x453c5a):_0x4a106a>0x3?_0x849595(_0x456238,_0x31a5fa,_0x453c5a):_0x849595(_0x456238,_0x31a5fa))||_0x453c5a;}return _0x4a106a>0x3&&_0x453c5a&&Object[_0x3af8df(0x19a)](_0x456238,_0x31a5fa,_0x453c5a),_0x453c5a;},__metadata=this&&this[_0x466ff4(0x184)]||function(_0x394517,_0x54f5e4){const _0x1f7bb8=_0x466ff4;if(typeof Reflect===_0x1f7bb8(0x177)&&typeof Reflect[_0x1f7bb8(0x171)]===_0x1f7bb8(0x18c))return Reflect['metadata'](_0x394517,_0x54f5e4);},__param=this&&this[_0x466ff4(0x165)]||function(_0x50d59d,_0x123765){return function(_0x248b92,_0x38e0b8){_0x123765(_0x248b92,_0x38e0b8,_0x50d59d);};};Object[_0x466ff4(0x19a)](exports,_0x466ff4(0x192),{'value':!![]}),exports[_0x466ff4(0x167)]=void 0x0;const globalConfig_service_1=require(_0x466ff4(0x170)),userBalance_service_1=require(_0x466ff4(0x16a)),common_1=require(_0x466ff4(0x1a7)),signIn_entity_1=require(_0x466ff4(0x1a5)),typeorm_1=require(_0x466ff4(0x19b)),typeorm_2=require(_0x466ff4(0x18a)),date_1=require(_0x466ff4(0x172)),user_entity_1=require(_0x466ff4(0x1a4)),balance_constant_1=require(_0x466ff4(0x193));let SigninService=class SigninService{constructor(_0x9f9a6a,_0x3698af,_0x4ef6b3,_0x354d98){const _0x434785=_0x466ff4;this[_0x434785(0x181)]=_0x9f9a6a,this[_0x434785(0x173)]=_0x3698af,this[_0x434785(0x16e)]=_0x4ef6b3,this[_0x434785(0x17a)]=_0x354d98;}async[_0x466ff4(0x189)](_0x87e8c1){const _0x436b61=_0x466ff4,{id:_0x33b47d}=_0x87e8c1[_0x436b61(0x180)],_0x5c3eb6=(0x0,date_1['default'])(new Date())['format']('YYYY-MM-DD'),_0x5452ff=await this[_0x436b61(0x181)][_0x436b61(0x187)]({'where':{'userId':_0x33b47d,'signInDate':_0x5c3eb6}});if(_0x5452ff)throw new common_1[(_0x436b61(0x182))](_0x436b61(0x161),common_1['HttpStatus']['BAD_REQUEST']);const {model3Count:_0x49618c,model4Count:_0x3bbd8e,drawMjCount:_0x1a5719}=await this['globalConfigService'][_0x436b61(0x175)]();await this[_0x436b61(0x181)][_0x436b61(0x18f)]({'userId':_0x33b47d,'signInTime':new Date(),'signInDate':_0x5c3eb6,'isSigned':!![]}),await this[_0x436b61(0x16e)][_0x436b61(0x19f)](_0x33b47d,{'model3Count':_0x49618c,'model4Count':_0x3bbd8e,'drawMjCount':_0x1a5719}),await this['userBalanceService']['saveRecordRechargeLog']({'userId':_0x33b47d,'rechargeType':balance_constant_1[_0x436b61(0x1a2)][_0x436b61(0x18b)],'model3Count':_0x49618c,'model4Count':_0x3bbd8e,'drawMjCount':_0x1a5719});const _0x4a8c93=(0x0,date_1[_0x436b61(0x188)])(new Date())['subtract'](0x1,_0x436b61(0x185))['format'](_0x436b61(0x168)),_0x54a19a=await this[_0x436b61(0x181)]['findOne']({'where':{'userId':_0x33b47d,'signInDate':_0x4a8c93}});if(_0x54a19a){common_1[_0x436b61(0x162)]['debug']('用户'+_0x33b47d+'昨天签到了、今天是连续签到！',_0x436b61(0x167));const _0x42ca60=await this[_0x436b61(0x173)][_0x436b61(0x187)]({'where':{'id':_0x33b47d}});if(!_0x42ca60)throw new common_1[(_0x436b61(0x182))]('用户不存在',common_1[_0x436b61(0x191)]['BAD_REQUEST']);const {consecutiveDays:consecutiveDays=0x0}=_0x42ca60;await this['userEntity'][_0x436b61(0x18e)]({'id':_0x33b47d},{'consecutiveDays':consecutiveDays+0x1});}else common_1['Logger'][_0x436b61(0x19d)]('用户'+_0x33b47d+_0x436b61(0x194),_0x436b61(0x167)),await this[_0x436b61(0x173)][_0x436b61(0x18e)]({'id':_0x33b47d},{'consecutiveDays':0x1});return'Sign\x20in\x20successful.';}async[_0x466ff4(0x179)](_0x38992a){const _0x5e22e2=_0x466ff4;try{const {id:_0x1bad43}=_0x38992a[_0x5e22e2(0x180)],_0x134ca0=(0x0,date_1[_0x5e22e2(0x188)])()['startOf'](_0x5e22e2(0x176))[_0x5e22e2(0x15f)]('YYYY-MM-DD\x20HH:mm:ss'),_0x2b3d4d=(0x0,date_1['default'])()['endOf']('month')[_0x5e22e2(0x15f)](_0x5e22e2(0x16b)),_0x5e241a=this[_0x5e22e2(0x181)][_0x5e22e2(0x164)](_0x5e22e2(0x163)),_0x5ee112=await _0x5e241a['select'](_0x5e22e2(0x1a3))[_0x5e22e2(0x195)](_0x5e22e2(0x169),{'userId':_0x38992a[_0x5e22e2(0x180)]['id']})[_0x5e22e2(0x195)]('signin.signInTime\x20>=\x20:firstDay',{'firstDay':_0x134ca0})[_0x5e22e2(0x195)](_0x5e22e2(0x1a1),{'lastDay':_0x2b3d4d})[_0x5e22e2(0x17c)](),_0x221a2e=new Date(_0x134ca0),_0x1b99a6=new Date(_0x2b3d4d),_0x3fce58=[],_0x37d5ec=new Date(_0x221a2e);while(_0x37d5ec<=_0x1b99a6){_0x3fce58['push']((0x0,date_1[_0x5e22e2(0x188)])(new Date(_0x37d5ec))[_0x5e22e2(0x15f)](_0x5e22e2(0x168))),_0x37d5ec[_0x5e22e2(0x190)](_0x37d5ec[_0x5e22e2(0x17b)]()+0x1);}const _0x265b68=[];for(const _0x4b3848 of _0x3fce58){const _0x2feb66=_0x5ee112['find'](_0x13e428=>_0x13e428[_0x5e22e2(0x174)]===_0x4b3848);!_0x2feb66?_0x265b68[_0x5e22e2(0x160)]({'signInDate':_0x4b3848,'isSigned':![]}):(_0x2feb66['isSigned']=!![],_0x265b68['push'](_0x2feb66));}return _0x265b68;}catch(_0x24268a){console[_0x5e22e2(0x199)](_0x5e22e2(0x16c),_0x24268a);throw new common_1[(_0x5e22e2(0x182))]('获取签到数据失败！',common_1[_0x5e22e2(0x191)][_0x5e22e2(0x16f)]);}}};SigninService=__decorate([(0x0,common_1[_0x466ff4(0x19e)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(signIn_entity_1[_0x466ff4(0x18d)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x466ff4(0x15e)])),__metadata(_0x466ff4(0x17e),[typeorm_2[_0x466ff4(0x15d)],typeorm_2[_0x466ff4(0x15d)],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x466ff4(0x196)]])],SigninService),exports[_0x466ff4(0x167)]=SigninService;