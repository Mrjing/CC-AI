'use strict';function _0x5328(_0x5645be,_0x977850){const _0x509698=_0x5096();return _0x5328=function(_0x5328aa,_0x539444){_0x5328aa=_0x5328aa-0x1a6;let _0x43f8dd=_0x509698[_0x5328aa];return _0x43f8dd;},_0x5328(_0x5645be,_0x977850);}const _0x3f60b1=_0x5328;(function(_0x50e726,_0x24e761){const _0x36e1af=_0x5328,_0x43a2b6=_0x50e726();while(!![]){try{const _0x305e03=parseInt(_0x36e1af(0x1bd))/0x1*(-parseInt(_0x36e1af(0x1dc))/0x2)+parseInt(_0x36e1af(0x1a7))/0x3*(-parseInt(_0x36e1af(0x1e3))/0x4)+-parseInt(_0x36e1af(0x1ab))/0x5*(parseInt(_0x36e1af(0x1b2))/0x6)+parseInt(_0x36e1af(0x1e1))/0x7*(parseInt(_0x36e1af(0x1c5))/0x8)+-parseInt(_0x36e1af(0x1a6))/0x9*(-parseInt(_0x36e1af(0x1af))/0xa)+-parseInt(_0x36e1af(0x1a8))/0xb+parseInt(_0x36e1af(0x1c2))/0xc;if(_0x305e03===_0x24e761)break;else _0x43a2b6['push'](_0x43a2b6['shift']());}catch(_0x4a402f){_0x43a2b6['push'](_0x43a2b6['shift']());}}}(_0x5096,0xb0594));var __decorate=this&&this[_0x3f60b1(0x1cc)]||function(_0x235e34,_0x1a79b0,_0x4f7e16,_0x40253f){const _0x192a04=_0x3f60b1;var _0x3b0480=arguments[_0x192a04(0x1e8)],_0x2e6b32=_0x3b0480<0x3?_0x1a79b0:_0x40253f===null?_0x40253f=Object['getOwnPropertyDescriptor'](_0x1a79b0,_0x4f7e16):_0x40253f,_0x430a11;if(typeof Reflect==='object'&&typeof Reflect[_0x192a04(0x1d2)]==='function')_0x2e6b32=Reflect[_0x192a04(0x1d2)](_0x235e34,_0x1a79b0,_0x4f7e16,_0x40253f);else{for(var _0x24aff3=_0x235e34[_0x192a04(0x1e8)]-0x1;_0x24aff3>=0x0;_0x24aff3--)if(_0x430a11=_0x235e34[_0x24aff3])_0x2e6b32=(_0x3b0480<0x3?_0x430a11(_0x2e6b32):_0x3b0480>0x3?_0x430a11(_0x1a79b0,_0x4f7e16,_0x2e6b32):_0x430a11(_0x1a79b0,_0x4f7e16))||_0x2e6b32;}return _0x3b0480>0x3&&_0x2e6b32&&Object[_0x192a04(0x1d4)](_0x1a79b0,_0x4f7e16,_0x2e6b32),_0x2e6b32;},__metadata=this&&this['__metadata']||function(_0x9b3db,_0xe10764){const _0x49b92d=_0x3f60b1;if(typeof Reflect===_0x49b92d(0x1c9)&&typeof Reflect[_0x49b92d(0x1c4)]==='function')return Reflect[_0x49b92d(0x1c4)](_0x9b3db,_0xe10764);},__param=this&&this['__param']||function(_0x266405,_0x3bbe12){return function(_0x2369f7,_0x5191ca){_0x3bbe12(_0x2369f7,_0x5191ca,_0x266405);};};Object[_0x3f60b1(0x1d4)](exports,'__esModule',{'value':!![]}),exports[_0x3f60b1(0x1ea)]=void 0x0;const globalConfig_service_1=require(_0x3f60b1(0x1dd)),userBalance_service_1=require('../userBalance/userBalance.service'),common_1=require(_0x3f60b1(0x1db)),signIn_entity_1=require(_0x3f60b1(0x1c3)),typeorm_1=require(_0x3f60b1(0x1ce)),typeorm_2=require('typeorm'),date_1=require('../../common/utils/date'),user_entity_1=require(_0x3f60b1(0x1e5)),balance_constant_1=require('../../common/constants/balance.constant');let SigninService=class SigninService{constructor(_0x58f7e7,_0x4a0401,_0xd56079,_0x5cdf5f){const _0x5f2a21=_0x3f60b1;this['signinEntity']=_0x58f7e7,this[_0x5f2a21(0x1b8)]=_0x4a0401,this[_0x5f2a21(0x1bb)]=_0xd56079,this[_0x5f2a21(0x1e7)]=_0x5cdf5f;}async[_0x3f60b1(0x1d7)](_0x503576){const _0x2cb000=_0x3f60b1,{id:_0x5520ab}=_0x503576['user'],_0x565af7=(0x0,date_1[_0x2cb000(0x1e4)])(new Date())[_0x2cb000(0x1c8)](_0x2cb000(0x1de)),_0x5c577c=await this['signinEntity']['findOne']({'where':{'userId':_0x5520ab,'signInDate':_0x565af7}});if(_0x5c577c)throw new common_1[(_0x2cb000(0x1d6))]('今日已签到、改天再来吧!.',common_1[_0x2cb000(0x1d3)][_0x2cb000(0x1ac)]);const {model3Count:_0xd43d66,model4Count:_0x4f0461,drawMjCount:_0x5f3d44}=await this[_0x2cb000(0x1e7)]['getSignatureGiftConfig']();await this[_0x2cb000(0x1e2)][_0x2cb000(0x1b5)]({'userId':_0x5520ab,'signInTime':new Date(),'signInDate':_0x565af7,'isSigned':!![]}),await this[_0x2cb000(0x1bb)]['addBalanceToUser'](_0x5520ab,{'model3Count':_0xd43d66,'model4Count':_0x4f0461,'drawMjCount':_0x5f3d44}),await this['userBalanceService']['saveRecordRechargeLog']({'userId':_0x5520ab,'rechargeType':balance_constant_1['RechargeType'][_0x2cb000(0x1c1)],'model3Count':_0xd43d66,'model4Count':_0x4f0461,'drawMjCount':_0x5f3d44});const _0x5a1cd9=(0x0,date_1[_0x2cb000(0x1e4)])(new Date())[_0x2cb000(0x1d8)](0x1,'day')['format'](_0x2cb000(0x1de)),_0x1d3cca=await this['signinEntity']['findOne']({'where':{'userId':_0x5520ab,'signInDate':_0x5a1cd9}});if(_0x1d3cca){common_1[_0x2cb000(0x1e0)][_0x2cb000(0x1a9)]('用户'+_0x5520ab+'昨天签到了、今天是连续签到！','SigninService');const _0x23e398=await this[_0x2cb000(0x1b8)][_0x2cb000(0x1b0)]({'where':{'id':_0x5520ab}});if(!_0x23e398)throw new common_1[(_0x2cb000(0x1d6))](_0x2cb000(0x1b6),common_1[_0x2cb000(0x1d3)][_0x2cb000(0x1ac)]);const {consecutiveDays:consecutiveDays=0x0}=_0x23e398;await this['userEntity'][_0x2cb000(0x1e9)]({'id':_0x5520ab},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x2cb000(0x1e0)]['debug']('用户'+_0x5520ab+_0x2cb000(0x1ae),'SigninService'),await this[_0x2cb000(0x1b8)][_0x2cb000(0x1e9)]({'id':_0x5520ab},{'consecutiveDays':0x1});return'Sign\x20in\x20successful.';}async[_0x3f60b1(0x1e6)](_0x5732da){const _0x13400b=_0x3f60b1;try{const {id:_0x57c1d0}=_0x5732da['user'],_0xdde868=(0x0,date_1[_0x13400b(0x1e4)])()[_0x13400b(0x1aa)](_0x13400b(0x1b7))[_0x13400b(0x1c8)](_0x13400b(0x1d0)),_0x117eec=(0x0,date_1['default'])()['endOf'](_0x13400b(0x1b7))[_0x13400b(0x1c8)](_0x13400b(0x1d0)),_0x4b2393=this['signinEntity'][_0x13400b(0x1b1)](_0x13400b(0x1da)),_0x1077c6=await _0x4b2393[_0x13400b(0x1bc)](_0x13400b(0x1ad))['andWhere'](_0x13400b(0x1c6),{'userId':_0x5732da['user']['id']})[_0x13400b(0x1ca)](_0x13400b(0x1b9),{'firstDay':_0xdde868})[_0x13400b(0x1ca)]('signin.signInTime\x20<=\x20:lastDay',{'lastDay':_0x117eec})[_0x13400b(0x1cb)](),_0x1b2737=new Date(_0xdde868),_0x4ee31a=new Date(_0x117eec),_0x188a66=[],_0x1b26ba=new Date(_0x1b2737);while(_0x1b26ba<=_0x4ee31a){_0x188a66[_0x13400b(0x1c7)]((0x0,date_1[_0x13400b(0x1e4)])(new Date(_0x1b26ba))[_0x13400b(0x1c8)](_0x13400b(0x1de))),_0x1b26ba[_0x13400b(0x1be)](_0x1b26ba['getDate']()+0x1);}const _0x263faa=[];for(const _0x292419 of _0x188a66){const _0x12efbb=_0x1077c6[_0x13400b(0x1d1)](_0x36f9be=>_0x36f9be[_0x13400b(0x1cd)]===_0x292419);!_0x12efbb?_0x263faa[_0x13400b(0x1c7)]({'signInDate':_0x292419,'isSigned':![]}):(_0x12efbb[_0x13400b(0x1bf)]=!![],_0x263faa[_0x13400b(0x1c7)](_0x12efbb));}return _0x263faa;}catch(_0x3c063b){console['log'](_0x13400b(0x1c0),_0x3c063b);throw new common_1[(_0x13400b(0x1d6))]('获取签到数据失败！',common_1[_0x13400b(0x1d3)][_0x13400b(0x1ac)]);}}};function _0x5096(){const _0x5307b0=['3525790EJOqMk','findOne','createQueryBuilder','492oESJwW','UserEntity','GlobalConfigService','save','用户不存在','month','userEntity','signin.signInTime\x20>=\x20:firstDay','UserBalanceService','userBalanceService','select','559363ihpWVt','setDate','isSigned','error:\x20','SIGN_IN','21539832ReluLR','./signIn.entity','metadata','5655568ShMgcW','signin.userId\x20=\x20:userId','push','format','object','andWhere','getRawMany','__decorate','signInDate','@nestjs/typeorm','Injectable','YYYY-MM-DD\x20HH:mm:ss','find','decorate','HttpStatus','defineProperty','SigninEntity','HttpException','sign','subtract','InjectRepository','signin','@nestjs/common','2tkhbRe','../globalConfig/globalConfig.service','YYYY-MM-DD','Repository','Logger','7INVmUd','signinEntity','759776qiPDXX','default','../user/user.entity','getSigninLog','globalConfigService','length','update','SigninService','18bFWhJn','3iqswRl','14792019WuMJTf','debug','startOf','23825TFZIOx','BAD_REQUEST','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','昨天没签到、今天重置天数！'];_0x5096=function(){return _0x5307b0;};return _0x5096();}SigninService=__decorate([(0x0,common_1[_0x3f60b1(0x1cf)])(),__param(0x0,(0x0,typeorm_1[_0x3f60b1(0x1d9)])(signIn_entity_1[_0x3f60b1(0x1d5)])),__param(0x1,(0x0,typeorm_1[_0x3f60b1(0x1d9)])(user_entity_1[_0x3f60b1(0x1b3)])),__metadata('design:paramtypes',[typeorm_2[_0x3f60b1(0x1df)],typeorm_2[_0x3f60b1(0x1df)],userBalance_service_1[_0x3f60b1(0x1ba)],globalConfig_service_1[_0x3f60b1(0x1b4)]])],SigninService),exports['SigninService']=SigninService;