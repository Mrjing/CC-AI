'use strict';const _0x1a6696=_0x5e1c;(function(_0xee7795,_0x20dd96){const _0x25ebc6=_0x5e1c,_0x1b4fa0=_0xee7795();while(!![]){try{const _0x1f9737=-parseInt(_0x25ebc6(0xaf))/0x1+-parseInt(_0x25ebc6(0xc1))/0x2*(-parseInt(_0x25ebc6(0x83))/0x3)+parseInt(_0x25ebc6(0xb6))/0x4+parseInt(_0x25ebc6(0x94))/0x5+-parseInt(_0x25ebc6(0x9e))/0x6*(parseInt(_0x25ebc6(0xb3))/0x7)+parseInt(_0x25ebc6(0xa5))/0x8+parseInt(_0x25ebc6(0xc0))/0x9*(-parseInt(_0x25ebc6(0xa0))/0xa);if(_0x1f9737===_0x20dd96)break;else _0x1b4fa0['push'](_0x1b4fa0['shift']());}catch(_0x25f5cd){_0x1b4fa0['push'](_0x1b4fa0['shift']());}}}(_0x5cf7,0x89e48));var __decorate=this&&this['__decorate']||function(_0x34d520,_0x51a5bc,_0x31c92e,_0x270a8b){const _0x43e423=_0x5e1c;var _0x2b950a=arguments[_0x43e423(0xae)],_0x4554e8=_0x2b950a<0x3?_0x51a5bc:_0x270a8b===null?_0x270a8b=Object[_0x43e423(0x9a)](_0x51a5bc,_0x31c92e):_0x270a8b,_0xd55cb6;if(typeof Reflect===_0x43e423(0x86)&&typeof Reflect['decorate']===_0x43e423(0xbd))_0x4554e8=Reflect['decorate'](_0x34d520,_0x51a5bc,_0x31c92e,_0x270a8b);else{for(var _0x4a0c0c=_0x34d520['length']-0x1;_0x4a0c0c>=0x0;_0x4a0c0c--)if(_0xd55cb6=_0x34d520[_0x4a0c0c])_0x4554e8=(_0x2b950a<0x3?_0xd55cb6(_0x4554e8):_0x2b950a>0x3?_0xd55cb6(_0x51a5bc,_0x31c92e,_0x4554e8):_0xd55cb6(_0x51a5bc,_0x31c92e))||_0x4554e8;}return _0x2b950a>0x3&&_0x4554e8&&Object['defineProperty'](_0x51a5bc,_0x31c92e,_0x4554e8),_0x4554e8;},__metadata=this&&this[_0x1a6696(0xa8)]||function(_0x38ab4e,_0x1a8b9c){const _0x4a48ca=_0x1a6696;if(typeof Reflect==='object'&&typeof Reflect[_0x4a48ca(0x82)]===_0x4a48ca(0xbd))return Reflect[_0x4a48ca(0x82)](_0x38ab4e,_0x1a8b9c);},__param=this&&this[_0x1a6696(0x88)]||function(_0x561376,_0x249e5a){return function(_0x5e1c23,_0x29e637){_0x249e5a(_0x5e1c23,_0x29e637,_0x561376);};};Object[_0x1a6696(0x9f)](exports,_0x1a6696(0xa9),{'value':!![]}),exports[_0x1a6696(0xc6)]=void 0x0;function _0x5cf7(){const _0x1fe862=['month','SigninService','format','metadata','366729ZrmwZU','HttpStatus','saveRecordRechargeLog','object','InjectRepository','__param','signInDate','debug','andWhere','select','setDate','../../common/utils/date','BAD_REQUEST','Logger','getRawMany','findOne','signin.userId\x20=\x20:userId','1673935LPSHmo','typeorm','GlobalConfigService','default','user','RechargeType','getOwnPropertyDescriptor','userEntity','@nestjs/common','../../common/constants/balance.constant','48Nkuqzv','defineProperty','7118610sCKXrg','design:paramtypes','save','signinEntity','find','7007624oDIeaV','YYYY-MM-DD','YYYY-MM-DD\x20HH:mm:ss','__metadata','__esModule','获取签到数据失败！','../globalConfig/globalConfig.service','@nestjs/typeorm','Sign\x20in\x20successful.','length','87668KfLuoU','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','SIGN_IN','error:\x20','419916wsJZaS','用户不存在','createQueryBuilder','3828144ImhayS','昨天没签到、今天重置天数！','昨天签到了、今天是连续签到！','getSigninLog','UserBalanceService','sign','HttpException','function','userBalanceService','getSignatureGiftConfig','27qeBqcV','18Yrpebd','push','signin','globalConfigService'];_0x5cf7=function(){return _0x1fe862;};return _0x5cf7();}const globalConfig_service_1=require(_0x1a6696(0xab)),userBalance_service_1=require('../userBalance/userBalance.service'),common_1=require(_0x1a6696(0x9c)),signIn_entity_1=require('./signIn.entity'),typeorm_1=require(_0x1a6696(0xac)),typeorm_2=require(_0x1a6696(0x95)),date_1=require(_0x1a6696(0x8e)),user_entity_1=require('../user/user.entity'),balance_constant_1=require(_0x1a6696(0x9d));let SigninService=class SigninService{constructor(_0x5ce392,_0x340cfb,_0x5e5187,_0x1f19c5){const _0x304960=_0x1a6696;this[_0x304960(0xa3)]=_0x5ce392,this[_0x304960(0x9b)]=_0x340cfb,this['userBalanceService']=_0x5e5187,this[_0x304960(0xc4)]=_0x1f19c5;}async[_0x1a6696(0xbb)](_0x1362a8){const _0x4c1a71=_0x1a6696,{id:_0x1a8303}=_0x1362a8[_0x4c1a71(0x98)],_0xcae72e=(0x0,date_1['default'])(new Date())[_0x4c1a71(0xc7)](_0x4c1a71(0xa6)),_0x1183bd=await this[_0x4c1a71(0xa3)][_0x4c1a71(0x92)]({'where':{'userId':_0x1a8303,'signInDate':_0xcae72e}});if(_0x1183bd)throw new common_1[(_0x4c1a71(0xbc))]('今日已签到、改天再来吧!.',common_1[_0x4c1a71(0x84)][_0x4c1a71(0x8f)]);const {model3Count:_0x4e7ae6,model4Count:_0x962b55,drawMjCount:_0x4af9bc}=await this[_0x4c1a71(0xc4)][_0x4c1a71(0xbf)]();await this[_0x4c1a71(0xa3)][_0x4c1a71(0xa2)]({'userId':_0x1a8303,'signInTime':new Date(),'signInDate':_0xcae72e,'isSigned':!![]}),await this[_0x4c1a71(0xbe)]['addBalanceToUser'](_0x1a8303,{'model3Count':_0x4e7ae6,'model4Count':_0x962b55,'drawMjCount':_0x4af9bc}),await this[_0x4c1a71(0xbe)][_0x4c1a71(0x85)]({'userId':_0x1a8303,'rechargeType':balance_constant_1[_0x4c1a71(0x99)][_0x4c1a71(0xb1)],'model3Count':_0x4e7ae6,'model4Count':_0x962b55,'drawMjCount':_0x4af9bc});const _0xb25a1c=(0x0,date_1['default'])(new Date())['subtract'](0x1,'day')[_0x4c1a71(0xc7)](_0x4c1a71(0xa6)),_0x13de0d=await this[_0x4c1a71(0xa3)][_0x4c1a71(0x92)]({'where':{'userId':_0x1a8303,'signInDate':_0xb25a1c}});if(_0x13de0d){common_1[_0x4c1a71(0x90)]['debug']('用户'+_0x1a8303+_0x4c1a71(0xb8),_0x4c1a71(0xc6));const _0x494511=await this['userEntity'][_0x4c1a71(0x92)]({'where':{'id':_0x1a8303}});if(!_0x494511)throw new common_1['HttpException'](_0x4c1a71(0xb4),common_1[_0x4c1a71(0x84)][_0x4c1a71(0x8f)]);const {consecutiveDays:consecutiveDays=0x0}=_0x494511;await this[_0x4c1a71(0x9b)]['update']({'id':_0x1a8303},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x4c1a71(0x90)][_0x4c1a71(0x8a)]('用户'+_0x1a8303+_0x4c1a71(0xb7),_0x4c1a71(0xc6)),await this['userEntity']['update']({'id':_0x1a8303},{'consecutiveDays':0x1});return _0x4c1a71(0xad);}async[_0x1a6696(0xb9)](_0x4a21b6){const _0x5efe37=_0x1a6696;try{const {id:_0x34936c}=_0x4a21b6[_0x5efe37(0x98)],_0xaf8b0c=(0x0,date_1[_0x5efe37(0x97)])()['startOf'](_0x5efe37(0xc5))[_0x5efe37(0xc7)](_0x5efe37(0xa7)),_0x455e59=(0x0,date_1['default'])()['endOf'](_0x5efe37(0xc5))[_0x5efe37(0xc7)](_0x5efe37(0xa7)),_0x189285=this[_0x5efe37(0xa3)][_0x5efe37(0xb5)](_0x5efe37(0xc3)),_0x5d6e57=await _0x189285[_0x5efe37(0x8c)](_0x5efe37(0xb0))[_0x5efe37(0x8b)](_0x5efe37(0x93),{'userId':_0x4a21b6[_0x5efe37(0x98)]['id']})['andWhere']('signin.signInTime\x20>=\x20:firstDay',{'firstDay':_0xaf8b0c})[_0x5efe37(0x8b)]('signin.signInTime\x20<=\x20:lastDay',{'lastDay':_0x455e59})[_0x5efe37(0x91)](),_0x149e29=new Date(_0xaf8b0c),_0x3dfde6=new Date(_0x455e59),_0x266cdd=[],_0x1e575f=new Date(_0x149e29);while(_0x1e575f<=_0x3dfde6){_0x266cdd['push']((0x0,date_1[_0x5efe37(0x97)])(new Date(_0x1e575f))[_0x5efe37(0xc7)](_0x5efe37(0xa6))),_0x1e575f[_0x5efe37(0x8d)](_0x1e575f['getDate']()+0x1);}const _0x360b82=[];for(const _0x2e535d of _0x266cdd){const _0x4ee2e6=_0x5d6e57[_0x5efe37(0xa4)](_0x4b4275=>_0x4b4275[_0x5efe37(0x89)]===_0x2e535d);!_0x4ee2e6?_0x360b82[_0x5efe37(0xc2)]({'signInDate':_0x2e535d,'isSigned':![]}):(_0x4ee2e6['isSigned']=!![],_0x360b82['push'](_0x4ee2e6));}return _0x360b82;}catch(_0x274e7e){console['log'](_0x5efe37(0xb2),_0x274e7e);throw new common_1[(_0x5efe37(0xbc))](_0x5efe37(0xaa),common_1[_0x5efe37(0x84)]['BAD_REQUEST']);}}};function _0x5e1c(_0x4f37e6,_0x4a7466){const _0x5cf750=_0x5cf7();return _0x5e1c=function(_0x5e1caf,_0x492b0c){_0x5e1caf=_0x5e1caf-0x82;let _0x32d254=_0x5cf750[_0x5e1caf];return _0x32d254;},_0x5e1c(_0x4f37e6,_0x4a7466);}SigninService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x1a6696(0x87)])(signIn_entity_1['SigninEntity'])),__param(0x1,(0x0,typeorm_1[_0x1a6696(0x87)])(user_entity_1['UserEntity'])),__metadata(_0x1a6696(0xa1),[typeorm_2['Repository'],typeorm_2['Repository'],userBalance_service_1[_0x1a6696(0xba)],globalConfig_service_1[_0x1a6696(0x96)]])],SigninService),exports['SigninService']=SigninService;