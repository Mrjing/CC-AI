'use strict';function _0x1244(_0x41e25c,_0x482e64){const _0x123a48=_0x123a();return _0x1244=function(_0x124484,_0x16ef14){_0x124484=_0x124484-0xca;let _0x208a36=_0x123a48[_0x124484];return _0x208a36;},_0x1244(_0x41e25c,_0x482e64);}const _0x4c6ab8=_0x1244;(function(_0x68a283,_0x5e9ddf){const _0x12406f=_0x1244,_0x572aca=_0x68a283();while(!![]){try{const _0x16dd7b=parseInt(_0x12406f(0xf5))/0x1+-parseInt(_0x12406f(0xf1))/0x2*(parseInt(_0x12406f(0x104))/0x3)+parseInt(_0x12406f(0xea))/0x4+parseInt(_0x12406f(0xe5))/0x5*(parseInt(_0x12406f(0xd4))/0x6)+parseInt(_0x12406f(0xff))/0x7*(parseInt(_0x12406f(0x10d))/0x8)+parseInt(_0x12406f(0xe7))/0x9*(-parseInt(_0x12406f(0xe4))/0xa)+-parseInt(_0x12406f(0xfa))/0xb;if(_0x16dd7b===_0x5e9ddf)break;else _0x572aca['push'](_0x572aca['shift']());}catch(_0x47aa5a){_0x572aca['push'](_0x572aca['shift']());}}}(_0x123a,0x1ad80));var __decorate=this&&this[_0x4c6ab8(0xe8)]||function(_0x4d2d54,_0x55ce67,_0x53b9f2,_0x150171){const _0x22d3b1=_0x4c6ab8;var _0x57cd3d=arguments[_0x22d3b1(0xe3)],_0x3ca80a=_0x57cd3d<0x3?_0x55ce67:_0x150171===null?_0x150171=Object['getOwnPropertyDescriptor'](_0x55ce67,_0x53b9f2):_0x150171,_0xe6164c;if(typeof Reflect==='object'&&typeof Reflect[_0x22d3b1(0xec)]===_0x22d3b1(0xef))_0x3ca80a=Reflect[_0x22d3b1(0xec)](_0x4d2d54,_0x55ce67,_0x53b9f2,_0x150171);else{for(var _0x2dee42=_0x4d2d54[_0x22d3b1(0xe3)]-0x1;_0x2dee42>=0x0;_0x2dee42--)if(_0xe6164c=_0x4d2d54[_0x2dee42])_0x3ca80a=(_0x57cd3d<0x3?_0xe6164c(_0x3ca80a):_0x57cd3d>0x3?_0xe6164c(_0x55ce67,_0x53b9f2,_0x3ca80a):_0xe6164c(_0x55ce67,_0x53b9f2))||_0x3ca80a;}return _0x57cd3d>0x3&&_0x3ca80a&&Object[_0x22d3b1(0xd6)](_0x55ce67,_0x53b9f2,_0x3ca80a),_0x3ca80a;},__metadata=this&&this[_0x4c6ab8(0xe9)]||function(_0x59bf23,_0x4d6565){const _0x41dabd=_0x4c6ab8;if(typeof Reflect===_0x41dabd(0xd1)&&typeof Reflect[_0x41dabd(0xe2)]===_0x41dabd(0xef))return Reflect['metadata'](_0x59bf23,_0x4d6565);},__param=this&&this['__param']||function(_0x53ce8a,_0x39d626){return function(_0x3c17d3,_0x4ce874){_0x39d626(_0x3c17d3,_0x4ce874,_0x53ce8a);};};Object['defineProperty'](exports,_0x4c6ab8(0x10e),{'value':!![]}),exports[_0x4c6ab8(0x110)]=void 0x0;const globalConfig_service_1=require(_0x4c6ab8(0x108)),userBalance_service_1=require('../userBalance/userBalance.service'),common_1=require(_0x4c6ab8(0xdd)),signIn_entity_1=require(_0x4c6ab8(0x106)),typeorm_1=require(_0x4c6ab8(0xd9)),typeorm_2=require('typeorm'),date_1=require(_0x4c6ab8(0xd2)),user_entity_1=require('../user/user.entity'),balance_constant_1=require('../../common/constants/balance.constant');function _0x123a(){const _0xf79d9f=['SigninService','day','signInDate','Logger','UserBalanceService','HttpException','HttpStatus','SigninEntity','object','../../common/utils/date','user','587364rBZcxS','Sign\x20in\x20successful.','defineProperty','InjectRepository','UserEntity','@nestjs/typeorm','SIGN_IN','log','default','@nestjs/common','subtract','saveRecordRechargeLog','userBalanceService','globalConfigService','metadata','length','30970SLwpNf','10iwpclT','今日已签到、改天再来吧!.','45aaOMhe','__decorate','__metadata','494228cxpphT','endOf','decorate','BAD_REQUEST','createQueryBuilder','function','andWhere','32lisnZn','getRawMany','signin.signInTime\x20<=\x20:lastDay','debug','94834otlEwN','YYYY-MM-DD','find','isSigned','design:paramtypes','3164172GUsKnh','用户不存在','昨天没签到、今天重置天数！','Injectable','YYYY-MM-DD\x20HH:mm:ss','94262IruQat','getSigninLog','getSignatureGiftConfig','format','month','7779yFJnXn','push','./signIn.entity','userEntity','../globalConfig/globalConfig.service','findOne','update','Repository','select','24aHyDaO','__esModule','signinEntity'];_0x123a=function(){return _0xf79d9f;};return _0x123a();}let SigninService=class SigninService{constructor(_0x363cb7,_0x4b78b2,_0x1a1e31,_0x27d26e){const _0x5bdfcb=_0x4c6ab8;this[_0x5bdfcb(0x10f)]=_0x363cb7,this['userEntity']=_0x4b78b2,this[_0x5bdfcb(0xe0)]=_0x1a1e31,this[_0x5bdfcb(0xe1)]=_0x27d26e;}async['sign'](_0x36b6ce){const _0x4a442e=_0x4c6ab8,{id:_0x508471}=_0x36b6ce['user'],_0x72d68b=(0x0,date_1['default'])(new Date())['format'](_0x4a442e(0xf6)),_0x204f7d=await this['signinEntity']['findOne']({'where':{'userId':_0x508471,'signInDate':_0x72d68b}});if(_0x204f7d)throw new common_1[(_0x4a442e(0xce))](_0x4a442e(0xe6),common_1[_0x4a442e(0xcf)][_0x4a442e(0xed)]);const {model3Count:_0x13be3e,model4Count:_0x950d4f,drawMjCount:_0x2b77c0}=await this[_0x4a442e(0xe1)][_0x4a442e(0x101)]();await this[_0x4a442e(0x10f)]['save']({'userId':_0x508471,'signInTime':new Date(),'signInDate':_0x72d68b,'isSigned':!![]}),await this['userBalanceService']['addBalanceToUser'](_0x508471,{'model3Count':_0x13be3e,'model4Count':_0x950d4f,'drawMjCount':_0x2b77c0}),await this[_0x4a442e(0xe0)][_0x4a442e(0xdf)]({'userId':_0x508471,'rechargeType':balance_constant_1['RechargeType'][_0x4a442e(0xda)],'model3Count':_0x13be3e,'model4Count':_0x950d4f,'drawMjCount':_0x2b77c0});const _0x284c09=(0x0,date_1[_0x4a442e(0xdc)])(new Date())[_0x4a442e(0xde)](0x1,_0x4a442e(0xca))[_0x4a442e(0x102)](_0x4a442e(0xf6)),_0x5bcb97=await this[_0x4a442e(0x10f)][_0x4a442e(0x109)]({'where':{'userId':_0x508471,'signInDate':_0x284c09}});if(_0x5bcb97){common_1[_0x4a442e(0xcc)][_0x4a442e(0xf4)]('用户'+_0x508471+'昨天签到了、今天是连续签到！',_0x4a442e(0x110));const _0x381c55=await this[_0x4a442e(0x107)][_0x4a442e(0x109)]({'where':{'id':_0x508471}});if(!_0x381c55)throw new common_1[(_0x4a442e(0xce))](_0x4a442e(0xfb),common_1['HttpStatus'][_0x4a442e(0xed)]);const {consecutiveDays:consecutiveDays=0x0}=_0x381c55;await this[_0x4a442e(0x107)][_0x4a442e(0x10a)]({'id':_0x508471},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x4a442e(0xcc)][_0x4a442e(0xf4)]('用户'+_0x508471+_0x4a442e(0xfc),_0x4a442e(0x110)),await this[_0x4a442e(0x107)][_0x4a442e(0x10a)]({'id':_0x508471},{'consecutiveDays':0x1});return _0x4a442e(0xd5);}async[_0x4c6ab8(0x100)](_0x42f906){const _0x4a63c1=_0x4c6ab8;try{const {id:_0xb9fd83}=_0x42f906[_0x4a63c1(0xd3)],_0x1d7de8=(0x0,date_1[_0x4a63c1(0xdc)])()['startOf'](_0x4a63c1(0x103))[_0x4a63c1(0x102)](_0x4a63c1(0xfe)),_0x2ccfb2=(0x0,date_1[_0x4a63c1(0xdc)])()[_0x4a63c1(0xeb)](_0x4a63c1(0x103))[_0x4a63c1(0x102)]('YYYY-MM-DD\x20HH:mm:ss'),_0x3375e0=this[_0x4a63c1(0x10f)][_0x4a63c1(0xee)]('signin'),_0x5efaf3=await _0x3375e0[_0x4a63c1(0x10c)]('signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned')['andWhere']('signin.userId\x20=\x20:userId',{'userId':_0x42f906[_0x4a63c1(0xd3)]['id']})[_0x4a63c1(0xf0)]('signin.signInTime\x20>=\x20:firstDay',{'firstDay':_0x1d7de8})[_0x4a63c1(0xf0)](_0x4a63c1(0xf3),{'lastDay':_0x2ccfb2})[_0x4a63c1(0xf2)](),_0x4413f1=new Date(_0x1d7de8),_0x29af05=new Date(_0x2ccfb2),_0x2426a8=[],_0x260f2b=new Date(_0x4413f1);while(_0x260f2b<=_0x29af05){_0x2426a8[_0x4a63c1(0x105)]((0x0,date_1['default'])(new Date(_0x260f2b))['format'](_0x4a63c1(0xf6))),_0x260f2b['setDate'](_0x260f2b['getDate']()+0x1);}const _0x108cd8=[];for(const _0x30a28c of _0x2426a8){const _0x3fca5a=_0x5efaf3[_0x4a63c1(0xf7)](_0xc84a00=>_0xc84a00[_0x4a63c1(0xcb)]===_0x30a28c);!_0x3fca5a?_0x108cd8['push']({'signInDate':_0x30a28c,'isSigned':![]}):(_0x3fca5a[_0x4a63c1(0xf8)]=!![],_0x108cd8[_0x4a63c1(0x105)](_0x3fca5a));}return _0x108cd8;}catch(_0x4748dd){console[_0x4a63c1(0xdb)]('error:\x20',_0x4748dd);throw new common_1[(_0x4a63c1(0xce))]('获取签到数据失败！',common_1[_0x4a63c1(0xcf)][_0x4a63c1(0xed)]);}}};SigninService=__decorate([(0x0,common_1[_0x4c6ab8(0xfd)])(),__param(0x0,(0x0,typeorm_1[_0x4c6ab8(0xd7)])(signIn_entity_1[_0x4c6ab8(0xd0)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x4c6ab8(0xd8)])),__metadata(_0x4c6ab8(0xf9),[typeorm_2[_0x4c6ab8(0x10b)],typeorm_2['Repository'],userBalance_service_1[_0x4c6ab8(0xcd)],globalConfig_service_1['GlobalConfigService']])],SigninService),exports[_0x4c6ab8(0x110)]=SigninService;