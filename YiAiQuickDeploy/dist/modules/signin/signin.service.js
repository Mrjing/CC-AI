'use strict';const _0x125c97=_0x3f2b;(function(_0x38e7c0,_0x4ec4eb){const _0x2394cd=_0x3f2b,_0x496c52=_0x38e7c0();while(!![]){try{const _0x1b29f4=parseInt(_0x2394cd(0x14b))/0x1*(parseInt(_0x2394cd(0x105))/0x2)+-parseInt(_0x2394cd(0x125))/0x3+-parseInt(_0x2394cd(0x11b))/0x4+parseInt(_0x2394cd(0x11a))/0x5*(parseInt(_0x2394cd(0x148))/0x6)+-parseInt(_0x2394cd(0x104))/0x7+-parseInt(_0x2394cd(0x106))/0x8+parseInt(_0x2394cd(0x144))/0x9*(parseInt(_0x2394cd(0x143))/0xa);if(_0x1b29f4===_0x4ec4eb)break;else _0x496c52['push'](_0x496c52['shift']());}catch(_0x4267ac){_0x496c52['push'](_0x496c52['shift']());}}}(_0xa8c8,0x60291));var __decorate=this&&this[_0x125c97(0x108)]||function(_0x19886f,_0x473f76,_0x5a2f56,_0x308f19){const _0x447bfe=_0x125c97;var _0x547511=arguments[_0x447bfe(0x126)],_0x341f23=_0x547511<0x3?_0x473f76:_0x308f19===null?_0x308f19=Object[_0x447bfe(0x150)](_0x473f76,_0x5a2f56):_0x308f19,_0x5406be;if(typeof Reflect===_0x447bfe(0x11e)&&typeof Reflect[_0x447bfe(0x139)]===_0x447bfe(0x13a))_0x341f23=Reflect[_0x447bfe(0x139)](_0x19886f,_0x473f76,_0x5a2f56,_0x308f19);else{for(var _0x417101=_0x19886f['length']-0x1;_0x417101>=0x0;_0x417101--)if(_0x5406be=_0x19886f[_0x417101])_0x341f23=(_0x547511<0x3?_0x5406be(_0x341f23):_0x547511>0x3?_0x5406be(_0x473f76,_0x5a2f56,_0x341f23):_0x5406be(_0x473f76,_0x5a2f56))||_0x341f23;}return _0x547511>0x3&&_0x341f23&&Object['defineProperty'](_0x473f76,_0x5a2f56,_0x341f23),_0x341f23;},__metadata=this&&this[_0x125c97(0x13b)]||function(_0x2bf0f0,_0x47eb16){const _0x2a3857=_0x125c97;if(typeof Reflect===_0x2a3857(0x11e)&&typeof Reflect['metadata']===_0x2a3857(0x13a))return Reflect[_0x2a3857(0x132)](_0x2bf0f0,_0x47eb16);},__param=this&&this['__param']||function(_0x24cfdc,_0x5b8f4c){return function(_0xae09c6,_0x18b8f9){_0x5b8f4c(_0xae09c6,_0x18b8f9,_0x24cfdc);};};Object[_0x125c97(0x118)](exports,_0x125c97(0x137),{'value':!![]}),exports[_0x125c97(0x13e)]=void 0x0;const globalConfig_service_1=require(_0x125c97(0x135)),userBalance_service_1=require(_0x125c97(0x141)),common_1=require('@nestjs/common'),signIn_entity_1=require('./signIn.entity'),typeorm_1=require(_0x125c97(0x103)),typeorm_2=require(_0x125c97(0x136)),date_1=require('../../common/utils/date'),user_entity_1=require(_0x125c97(0x12a)),balance_constant_1=require('../../common/constants/balance.constant');function _0xa8c8(){const _0x5414e9=['subtract','sign','../userBalance/userBalance.service','UserEntity','10wsovUI','3548772gIYAwm','signinEntity','Logger','debug','18UMguIy','day','昨天签到了、今天是连续签到！','77138aVjALV','YYYY-MM-DD\x20HH:mm:ss','YYYY-MM-DD','signInDate','HttpException','getOwnPropertyDescriptor','@nestjs/typeorm','5271287xbhIuK','20uDriHa','3363032fVLnQN','昨天没签到、今天重置天数！','__decorate','signin','signin.signInTime\x20<=\x20:lastDay','isSigned','HttpStatus','userBalanceService','InjectRepository','GlobalConfigService','UserBalanceService','globalConfigService','getSigninLog','setDate','default','user','format','save','defineProperty','createQueryBuilder','1053365EuEfBm','250900ovQuXJ','getSignatureGiftConfig','find','object','log','Repository','addBalanceToUser','update','BAD_REQUEST','Sign\x20in\x20successful.','503067JlvdzV','length','SigninEntity','RechargeType','push','../user/user.entity','今日已签到、改天再来吧!.','Injectable','saveRecordRechargeLog','userEntity','select','andWhere','design:paramtypes','metadata','month','getRawMany','../globalConfig/globalConfig.service','typeorm','__esModule','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','decorate','function','__metadata','用户不存在','findOne','SigninService'];_0xa8c8=function(){return _0x5414e9;};return _0xa8c8();}let SigninService=class SigninService{constructor(_0x2096fa,_0x1f4827,_0x393659,_0x273b2d){const _0x31f5a0=_0x125c97;this[_0x31f5a0(0x145)]=_0x2096fa,this[_0x31f5a0(0x12e)]=_0x1f4827,this['userBalanceService']=_0x393659,this[_0x31f5a0(0x111)]=_0x273b2d;}async[_0x125c97(0x140)](_0x6f0e96){const _0x18b09c=_0x125c97,{id:_0x4059d6}=_0x6f0e96['user'],_0x12e572=(0x0,date_1[_0x18b09c(0x114)])(new Date())['format'](_0x18b09c(0x14d)),_0x42e993=await this['signinEntity']['findOne']({'where':{'userId':_0x4059d6,'signInDate':_0x12e572}});if(_0x42e993)throw new common_1[(_0x18b09c(0x14f))](_0x18b09c(0x12b),common_1[_0x18b09c(0x10c)]['BAD_REQUEST']);const {model3Count:_0x3429fd,model4Count:_0x235bba,drawMjCount:_0xfc280d}=await this[_0x18b09c(0x111)][_0x18b09c(0x11c)]();await this['signinEntity'][_0x18b09c(0x117)]({'userId':_0x4059d6,'signInTime':new Date(),'signInDate':_0x12e572,'isSigned':!![]}),await this[_0x18b09c(0x10d)][_0x18b09c(0x121)](_0x4059d6,{'model3Count':_0x3429fd,'model4Count':_0x235bba,'drawMjCount':_0xfc280d}),await this[_0x18b09c(0x10d)][_0x18b09c(0x12d)]({'userId':_0x4059d6,'rechargeType':balance_constant_1[_0x18b09c(0x128)]['SIGN_IN'],'model3Count':_0x3429fd,'model4Count':_0x235bba,'drawMjCount':_0xfc280d});const _0x5a9a8a=(0x0,date_1['default'])(new Date())[_0x18b09c(0x13f)](0x1,_0x18b09c(0x149))[_0x18b09c(0x116)](_0x18b09c(0x14d)),_0x3912ca=await this[_0x18b09c(0x145)][_0x18b09c(0x13d)]({'where':{'userId':_0x4059d6,'signInDate':_0x5a9a8a}});if(_0x3912ca){common_1[_0x18b09c(0x146)]['debug']('用户'+_0x4059d6+_0x18b09c(0x14a),_0x18b09c(0x13e));const _0x287e47=await this[_0x18b09c(0x12e)][_0x18b09c(0x13d)]({'where':{'id':_0x4059d6}});if(!_0x287e47)throw new common_1[(_0x18b09c(0x14f))](_0x18b09c(0x13c),common_1[_0x18b09c(0x10c)][_0x18b09c(0x123)]);const {consecutiveDays:consecutiveDays=0x0}=_0x287e47;await this[_0x18b09c(0x12e)][_0x18b09c(0x122)]({'id':_0x4059d6},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x18b09c(0x146)][_0x18b09c(0x147)]('用户'+_0x4059d6+_0x18b09c(0x107),'SigninService'),await this[_0x18b09c(0x12e)][_0x18b09c(0x122)]({'id':_0x4059d6},{'consecutiveDays':0x1});return _0x18b09c(0x124);}async[_0x125c97(0x112)](_0x5616ba){const _0x46b8b6=_0x125c97;try{const {id:_0x272604}=_0x5616ba[_0x46b8b6(0x115)],_0x54d3b4=(0x0,date_1[_0x46b8b6(0x114)])()['startOf'](_0x46b8b6(0x133))[_0x46b8b6(0x116)](_0x46b8b6(0x14c)),_0x1b1508=(0x0,date_1[_0x46b8b6(0x114)])()['endOf'](_0x46b8b6(0x133))['format'](_0x46b8b6(0x14c)),_0x25c746=this[_0x46b8b6(0x145)][_0x46b8b6(0x119)](_0x46b8b6(0x109)),_0x5ef1d0=await _0x25c746[_0x46b8b6(0x12f)](_0x46b8b6(0x138))[_0x46b8b6(0x130)]('signin.userId\x20=\x20:userId',{'userId':_0x5616ba[_0x46b8b6(0x115)]['id']})[_0x46b8b6(0x130)]('signin.signInTime\x20>=\x20:firstDay',{'firstDay':_0x54d3b4})[_0x46b8b6(0x130)](_0x46b8b6(0x10a),{'lastDay':_0x1b1508})[_0x46b8b6(0x134)](),_0xdfdf5a=new Date(_0x54d3b4),_0xb92d45=new Date(_0x1b1508),_0x4cb214=[],_0x3075dd=new Date(_0xdfdf5a);while(_0x3075dd<=_0xb92d45){_0x4cb214[_0x46b8b6(0x129)]((0x0,date_1[_0x46b8b6(0x114)])(new Date(_0x3075dd))[_0x46b8b6(0x116)]('YYYY-MM-DD')),_0x3075dd[_0x46b8b6(0x113)](_0x3075dd['getDate']()+0x1);}const _0x70b8f=[];for(const _0x3074a6 of _0x4cb214){const _0x4b770a=_0x5ef1d0[_0x46b8b6(0x11d)](_0x267737=>_0x267737[_0x46b8b6(0x14e)]===_0x3074a6);!_0x4b770a?_0x70b8f['push']({'signInDate':_0x3074a6,'isSigned':![]}):(_0x4b770a[_0x46b8b6(0x10b)]=!![],_0x70b8f[_0x46b8b6(0x129)](_0x4b770a));}return _0x70b8f;}catch(_0x59512a){console[_0x46b8b6(0x11f)]('error:\x20',_0x59512a);throw new common_1[(_0x46b8b6(0x14f))]('获取签到数据失败！',common_1['HttpStatus'][_0x46b8b6(0x123)]);}}};function _0x3f2b(_0x2a71ab,_0x348e42){const _0xa8c87=_0xa8c8();return _0x3f2b=function(_0x3f2b8b,_0x38d187){_0x3f2b8b=_0x3f2b8b-0x103;let _0x3afeba=_0xa8c87[_0x3f2b8b];return _0x3afeba;},_0x3f2b(_0x2a71ab,_0x348e42);}SigninService=__decorate([(0x0,common_1[_0x125c97(0x12c)])(),__param(0x0,(0x0,typeorm_1[_0x125c97(0x10e)])(signIn_entity_1[_0x125c97(0x127)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x125c97(0x142)])),__metadata(_0x125c97(0x131),[typeorm_2[_0x125c97(0x120)],typeorm_2[_0x125c97(0x120)],userBalance_service_1[_0x125c97(0x110)],globalConfig_service_1[_0x125c97(0x10f)]])],SigninService),exports[_0x125c97(0x13e)]=SigninService;