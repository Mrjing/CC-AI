'use strict';const _0x462569=_0x1cf5;function _0x1cf5(_0x36aa43,_0x20ee8c){const _0x450115=_0x4501();return _0x1cf5=function(_0x1cf535,_0x56d385){_0x1cf535=_0x1cf535-0x152;let _0x1851b8=_0x450115[_0x1cf535];return _0x1851b8;},_0x1cf5(_0x36aa43,_0x20ee8c);}(function(_0x9157e4,_0x1e7e3a){const _0x1a02b2=_0x1cf5,_0x3ce76d=_0x9157e4();while(!![]){try{const _0x41a71b=parseInt(_0x1a02b2(0x179))/0x1+parseInt(_0x1a02b2(0x15a))/0x2*(-parseInt(_0x1a02b2(0x180))/0x3)+parseInt(_0x1a02b2(0x152))/0x4*(parseInt(_0x1a02b2(0x159))/0x5)+-parseInt(_0x1a02b2(0x17f))/0x6*(-parseInt(_0x1a02b2(0x16e))/0x7)+-parseInt(_0x1a02b2(0x172))/0x8*(parseInt(_0x1a02b2(0x166))/0x9)+-parseInt(_0x1a02b2(0x186))/0xa+-parseInt(_0x1a02b2(0x156))/0xb*(-parseInt(_0x1a02b2(0x16f))/0xc);if(_0x41a71b===_0x1e7e3a)break;else _0x3ce76d['push'](_0x3ce76d['shift']());}catch(_0x2a21cf){_0x3ce76d['push'](_0x3ce76d['shift']());}}}(_0x4501,0xcf974));var __decorate=this&&this[_0x462569(0x15d)]||function(_0x526e82,_0x1a8961,_0x27c226,_0x4b55aa){const _0x49fb5d=_0x462569;var _0xb8e143=arguments[_0x49fb5d(0x187)],_0x8b3fa2=_0xb8e143<0x3?_0x1a8961:_0x4b55aa===null?_0x4b55aa=Object['getOwnPropertyDescriptor'](_0x1a8961,_0x27c226):_0x4b55aa,_0x36e96f;if(typeof Reflect==='object'&&typeof Reflect[_0x49fb5d(0x183)]==='function')_0x8b3fa2=Reflect[_0x49fb5d(0x183)](_0x526e82,_0x1a8961,_0x27c226,_0x4b55aa);else{for(var _0x402ab6=_0x526e82[_0x49fb5d(0x187)]-0x1;_0x402ab6>=0x0;_0x402ab6--)if(_0x36e96f=_0x526e82[_0x402ab6])_0x8b3fa2=(_0xb8e143<0x3?_0x36e96f(_0x8b3fa2):_0xb8e143>0x3?_0x36e96f(_0x1a8961,_0x27c226,_0x8b3fa2):_0x36e96f(_0x1a8961,_0x27c226))||_0x8b3fa2;}return _0xb8e143>0x3&&_0x8b3fa2&&Object[_0x49fb5d(0x169)](_0x1a8961,_0x27c226,_0x8b3fa2),_0x8b3fa2;},__metadata=this&&this[_0x462569(0x182)]||function(_0x1093e7,_0x5917a6){const _0x55f7c1=_0x462569;if(typeof Reflect===_0x55f7c1(0x17c)&&typeof Reflect[_0x55f7c1(0x15e)]==='function')return Reflect[_0x55f7c1(0x15e)](_0x1093e7,_0x5917a6);},__param=this&&this[_0x462569(0x198)]||function(_0x419182,_0x2dc0ff){return function(_0x29196f,_0x6419c2){_0x2dc0ff(_0x29196f,_0x6419c2,_0x419182);};};Object[_0x462569(0x169)](exports,'__esModule',{'value':!![]}),exports[_0x462569(0x19b)]=void 0x0;const globalConfig_service_1=require(_0x462569(0x18c)),userBalance_service_1=require(_0x462569(0x19a)),common_1=require(_0x462569(0x171)),signIn_entity_1=require('./signIn.entity'),typeorm_1=require(_0x462569(0x17e)),typeorm_2=require(_0x462569(0x19e)),date_1=require('../../common/utils/date'),user_entity_1=require('../user/user.entity'),balance_constant_1=require(_0x462569(0x190));function _0x4501(){const _0x337780=['decorate','昨天签到了、今天是连续签到！','format','11020750mTOPpd','length','signinEntity','用户不存在','HttpStatus','userEntity','../globalConfig/globalConfig.service','YYYY-MM-DD\x20HH:mm:ss','InjectRepository','signin.signInTime\x20>=\x20:firstDay','../../common/constants/balance.constant','signin.signInTime\x20<=\x20:lastDay','UserEntity','Injectable','saveRecordRechargeLog','signin.userId\x20=\x20:userId','getRawMany','user','__param','RechargeType','../userBalance/userBalance.service','SigninService','endOf','createQueryBuilder','typeorm','28ILZOFH','update','BAD_REQUEST','andWhere','2987589LNZtxT','getSigninLog','signin','310985WqqwRP','10ynruDg','save','find','__decorate','metadata','GlobalConfigService','getDate','select','globalConfigService','default','Sign\x20in\x20successful.','获取签到数据失败！','6590061YGnFbV','Logger','isSigned','defineProperty','month','昨天没签到、今天重置天数！','SigninEntity','findOne','14IPmAGW','84hoUReX','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','@nestjs/common','8xzLYTe','subtract','setDate','SIGN_IN','getSignatureGiftConfig','sign','HttpException','272062usXnOO','Repository','userBalanceService','object','push','@nestjs/typeorm','910866DniobV','136596YWXacG','YYYY-MM-DD','__metadata'];_0x4501=function(){return _0x337780;};return _0x4501();}let SigninService=class SigninService{constructor(_0x3a94ec,_0x47ba41,_0x162161,_0x581ea0){const _0x932563=_0x462569;this['signinEntity']=_0x3a94ec,this[_0x932563(0x18b)]=_0x47ba41,this[_0x932563(0x17b)]=_0x162161,this['globalConfigService']=_0x581ea0;}async[_0x462569(0x177)](_0x19a464){const _0x5c8d3c=_0x462569,{id:_0x1374cc}=_0x19a464['user'],_0x340e5f=(0x0,date_1[_0x5c8d3c(0x163)])(new Date())[_0x5c8d3c(0x185)](_0x5c8d3c(0x181)),_0x4f37eb=await this[_0x5c8d3c(0x188)][_0x5c8d3c(0x16d)]({'where':{'userId':_0x1374cc,'signInDate':_0x340e5f}});if(_0x4f37eb)throw new common_1['HttpException']('今日已签到、改天再来吧!.',common_1[_0x5c8d3c(0x18a)][_0x5c8d3c(0x154)]);const {model3Count:_0x21cd40,model4Count:_0x5d18be,drawMjCount:_0x1d2379}=await this[_0x5c8d3c(0x162)][_0x5c8d3c(0x176)]();await this[_0x5c8d3c(0x188)][_0x5c8d3c(0x15b)]({'userId':_0x1374cc,'signInTime':new Date(),'signInDate':_0x340e5f,'isSigned':!![]}),await this[_0x5c8d3c(0x17b)]['addBalanceToUser'](_0x1374cc,{'model3Count':_0x21cd40,'model4Count':_0x5d18be,'drawMjCount':_0x1d2379}),await this[_0x5c8d3c(0x17b)][_0x5c8d3c(0x194)]({'userId':_0x1374cc,'rechargeType':balance_constant_1[_0x5c8d3c(0x199)][_0x5c8d3c(0x175)],'model3Count':_0x21cd40,'model4Count':_0x5d18be,'drawMjCount':_0x1d2379});const _0x33d859=(0x0,date_1[_0x5c8d3c(0x163)])(new Date())[_0x5c8d3c(0x173)](0x1,'day')[_0x5c8d3c(0x185)](_0x5c8d3c(0x181)),_0x3aa9=await this['signinEntity'][_0x5c8d3c(0x16d)]({'where':{'userId':_0x1374cc,'signInDate':_0x33d859}});if(_0x3aa9){common_1[_0x5c8d3c(0x167)]['debug']('用户'+_0x1374cc+_0x5c8d3c(0x184),_0x5c8d3c(0x19b));const _0x59cef2=await this[_0x5c8d3c(0x18b)][_0x5c8d3c(0x16d)]({'where':{'id':_0x1374cc}});if(!_0x59cef2)throw new common_1['HttpException'](_0x5c8d3c(0x189),common_1['HttpStatus'][_0x5c8d3c(0x154)]);const {consecutiveDays:consecutiveDays=0x0}=_0x59cef2;await this[_0x5c8d3c(0x18b)][_0x5c8d3c(0x153)]({'id':_0x1374cc},{'consecutiveDays':consecutiveDays+0x1});}else common_1['Logger']['debug']('用户'+_0x1374cc+_0x5c8d3c(0x16b),_0x5c8d3c(0x19b)),await this[_0x5c8d3c(0x18b)][_0x5c8d3c(0x153)]({'id':_0x1374cc},{'consecutiveDays':0x1});return _0x5c8d3c(0x164);}async[_0x462569(0x157)](_0x285f93){const _0x42a72e=_0x462569;try{const {id:_0x5e7dcb}=_0x285f93['user'],_0x46b9fe=(0x0,date_1[_0x42a72e(0x163)])()['startOf'](_0x42a72e(0x16a))['format'](_0x42a72e(0x18d)),_0x420f83=(0x0,date_1[_0x42a72e(0x163)])()[_0x42a72e(0x19c)](_0x42a72e(0x16a))[_0x42a72e(0x185)](_0x42a72e(0x18d)),_0x183c18=this[_0x42a72e(0x188)][_0x42a72e(0x19d)](_0x42a72e(0x158)),_0x9700eb=await _0x183c18[_0x42a72e(0x161)](_0x42a72e(0x170))['andWhere'](_0x42a72e(0x195),{'userId':_0x285f93[_0x42a72e(0x197)]['id']})[_0x42a72e(0x155)](_0x42a72e(0x18f),{'firstDay':_0x46b9fe})[_0x42a72e(0x155)](_0x42a72e(0x191),{'lastDay':_0x420f83})[_0x42a72e(0x196)](),_0x19ec04=new Date(_0x46b9fe),_0x217d04=new Date(_0x420f83),_0x39986d=[],_0x289a2e=new Date(_0x19ec04);while(_0x289a2e<=_0x217d04){_0x39986d[_0x42a72e(0x17d)]((0x0,date_1[_0x42a72e(0x163)])(new Date(_0x289a2e))[_0x42a72e(0x185)]('YYYY-MM-DD')),_0x289a2e[_0x42a72e(0x174)](_0x289a2e[_0x42a72e(0x160)]()+0x1);}const _0x59aae5=[];for(const _0x4c8822 of _0x39986d){const _0x272b07=_0x9700eb[_0x42a72e(0x15c)](_0xa4b5b9=>_0xa4b5b9['signInDate']===_0x4c8822);!_0x272b07?_0x59aae5[_0x42a72e(0x17d)]({'signInDate':_0x4c8822,'isSigned':![]}):(_0x272b07[_0x42a72e(0x168)]=!![],_0x59aae5[_0x42a72e(0x17d)](_0x272b07));}return _0x59aae5;}catch(_0xf1997f){console['log']('error:\x20',_0xf1997f);throw new common_1[(_0x42a72e(0x178))](_0x42a72e(0x165),common_1[_0x42a72e(0x18a)][_0x42a72e(0x154)]);}}};SigninService=__decorate([(0x0,common_1[_0x462569(0x193)])(),__param(0x0,(0x0,typeorm_1[_0x462569(0x18e)])(signIn_entity_1[_0x462569(0x16c)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x462569(0x192)])),__metadata('design:paramtypes',[typeorm_2[_0x462569(0x17a)],typeorm_2[_0x462569(0x17a)],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x462569(0x15f)]])],SigninService),exports[_0x462569(0x19b)]=SigninService;