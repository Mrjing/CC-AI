'use strict';const _0xbcf55e=_0x282c;function _0x282c(_0x8e348f,_0x1d2d52){const _0x59d0f0=_0x59d0();return _0x282c=function(_0x282ce8,_0x76ea9f){_0x282ce8=_0x282ce8-0x1dd;let _0x28e860=_0x59d0f0[_0x282ce8];return _0x28e860;},_0x282c(_0x8e348f,_0x1d2d52);}(function(_0x39cf71,_0x5c9769){const _0x599098=_0x282c,_0x1c97ef=_0x39cf71();while(!![]){try{const _0x448052=parseInt(_0x599098(0x1f3))/0x1+parseInt(_0x599098(0x1f9))/0x2+parseInt(_0x599098(0x20a))/0x3+parseInt(_0x599098(0x222))/0x4*(-parseInt(_0x599098(0x201))/0x5)+parseInt(_0x599098(0x212))/0x6+-parseInt(_0x599098(0x225))/0x7*(parseInt(_0x599098(0x22c))/0x8)+-parseInt(_0x599098(0x1e4))/0x9;if(_0x448052===_0x5c9769)break;else _0x1c97ef['push'](_0x1c97ef['shift']());}catch(_0x59e629){_0x1c97ef['push'](_0x1c97ef['shift']());}}}(_0x59d0,0x74bfe));var __decorate=this&&this[_0xbcf55e(0x1e1)]||function(_0x19cb16,_0x405198,_0x253d00,_0x2b6368){const _0x221c82=_0xbcf55e;var _0x3b79c2=arguments[_0x221c82(0x1e5)],_0x2286fc=_0x3b79c2<0x3?_0x405198:_0x2b6368===null?_0x2b6368=Object[_0x221c82(0x226)](_0x405198,_0x253d00):_0x2b6368,_0x498447;if(typeof Reflect===_0x221c82(0x217)&&typeof Reflect[_0x221c82(0x219)]==='function')_0x2286fc=Reflect[_0x221c82(0x219)](_0x19cb16,_0x405198,_0x253d00,_0x2b6368);else{for(var _0x2b296a=_0x19cb16[_0x221c82(0x1e5)]-0x1;_0x2b296a>=0x0;_0x2b296a--)if(_0x498447=_0x19cb16[_0x2b296a])_0x2286fc=(_0x3b79c2<0x3?_0x498447(_0x2286fc):_0x3b79c2>0x3?_0x498447(_0x405198,_0x253d00,_0x2286fc):_0x498447(_0x405198,_0x253d00))||_0x2286fc;}return _0x3b79c2>0x3&&_0x2286fc&&Object[_0x221c82(0x1f1)](_0x405198,_0x253d00,_0x2286fc),_0x2286fc;},__metadata=this&&this[_0xbcf55e(0x21b)]||function(_0x3a6f4c,_0x2387a7){const _0x22334e=_0xbcf55e;if(typeof Reflect===_0x22334e(0x217)&&typeof Reflect[_0x22334e(0x21e)]===_0x22334e(0x1fc))return Reflect['metadata'](_0x3a6f4c,_0x2387a7);},__param=this&&this[_0xbcf55e(0x1fa)]||function(_0x50e720,_0x296714){return function(_0x165281,_0x31d6d5){_0x296714(_0x165281,_0x31d6d5,_0x50e720);};};Object[_0xbcf55e(0x1f1)](exports,_0xbcf55e(0x1e2),{'value':!![]}),exports[_0xbcf55e(0x205)]=void 0x0;function _0x59d0(){const _0x5cd139=['find','昨天没签到、今天重置天数！','setDate','defineProperty','@nestjs/common','755409NPIXND','getRawMany','signin.userId\x20=\x20:userId','getSigninLog','isSigned','Repository','427416juqkDr','__param','../globalConfig/globalConfig.service','function','HttpStatus','signin.signInTime\x20>=\x20:firstDay','findOne','log','10ePbILm','UserEntity','../user/user.entity','昨天签到了、今天是连续签到！','SigninService','../userBalance/userBalance.service','month','startOf','BAD_REQUEST','1457103NJlDHQ','default','RechargeType','今日已签到、改天再来吧!.','Injectable','select','createQueryBuilder','SIGN_IN','4461522ZFKdfQ','InjectRepository','push','update','save','object','SigninEntity','decorate','signinEntity','__metadata','getSignatureGiftConfig','GlobalConfigService','metadata','YYYY-MM-DD\x20HH:mm:ss','debug','format','1097140FwIXrL','user','userBalanceService','443485vykmuK','getOwnPropertyDescriptor','YYYY-MM-DD','../../common/utils/date','andWhere','design:paramtypes','UserBalanceService','104jqHQJk','addBalanceToUser','sign','userEntity','Sign\x20in\x20successful.','__decorate','__esModule','globalConfigService','3132126NaoLyA','length','../../common/constants/balance.constant','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','用户不存在','Logger','subtract','HttpException','获取签到数据失败！','day'];_0x59d0=function(){return _0x5cd139;};return _0x59d0();}const globalConfig_service_1=require(_0xbcf55e(0x1fb)),userBalance_service_1=require(_0xbcf55e(0x206)),common_1=require(_0xbcf55e(0x1f2)),signIn_entity_1=require('./signIn.entity'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),date_1=require(_0xbcf55e(0x228)),user_entity_1=require(_0xbcf55e(0x203)),balance_constant_1=require(_0xbcf55e(0x1e6));let SigninService=class SigninService{constructor(_0x1d1def,_0x41e27f,_0x37623a,_0x45ac77){const _0x509fac=_0xbcf55e;this[_0x509fac(0x21a)]=_0x1d1def,this['userEntity']=_0x41e27f,this[_0x509fac(0x224)]=_0x37623a,this[_0x509fac(0x1e3)]=_0x45ac77;}async[_0xbcf55e(0x1de)](_0x5e518a){const _0x355723=_0xbcf55e,{id:_0x2f734d}=_0x5e518a[_0x355723(0x223)],_0x2b890d=(0x0,date_1[_0x355723(0x20b)])(new Date())[_0x355723(0x221)](_0x355723(0x227)),_0x560a0e=await this[_0x355723(0x21a)][_0x355723(0x1ff)]({'where':{'userId':_0x2f734d,'signInDate':_0x2b890d}});if(_0x560a0e)throw new common_1['HttpException'](_0x355723(0x20d),common_1[_0x355723(0x1fd)][_0x355723(0x209)]);const {model3Count:_0x103247,model4Count:_0x17ff03,drawMjCount:_0x10e135}=await this[_0x355723(0x1e3)][_0x355723(0x21c)]();await this[_0x355723(0x21a)][_0x355723(0x216)]({'userId':_0x2f734d,'signInTime':new Date(),'signInDate':_0x2b890d,'isSigned':!![]}),await this['userBalanceService'][_0x355723(0x1dd)](_0x2f734d,{'model3Count':_0x103247,'model4Count':_0x17ff03,'drawMjCount':_0x10e135}),await this[_0x355723(0x224)]['saveRecordRechargeLog']({'userId':_0x2f734d,'rechargeType':balance_constant_1[_0x355723(0x20c)][_0x355723(0x211)],'model3Count':_0x103247,'model4Count':_0x17ff03,'drawMjCount':_0x10e135});const _0x44c450=(0x0,date_1[_0x355723(0x20b)])(new Date())[_0x355723(0x1ea)](0x1,_0x355723(0x1ed))[_0x355723(0x221)](_0x355723(0x227)),_0x2f279b=await this['signinEntity']['findOne']({'where':{'userId':_0x2f734d,'signInDate':_0x44c450}});if(_0x2f279b){common_1[_0x355723(0x1e9)][_0x355723(0x220)]('用户'+_0x2f734d+_0x355723(0x204),_0x355723(0x205));const _0x3ff9d6=await this[_0x355723(0x1df)][_0x355723(0x1ff)]({'where':{'id':_0x2f734d}});if(!_0x3ff9d6)throw new common_1[(_0x355723(0x1eb))](_0x355723(0x1e8),common_1['HttpStatus'][_0x355723(0x209)]);const {consecutiveDays:consecutiveDays=0x0}=_0x3ff9d6;await this[_0x355723(0x1df)][_0x355723(0x215)]({'id':_0x2f734d},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x355723(0x1e9)][_0x355723(0x220)]('用户'+_0x2f734d+_0x355723(0x1ef),'SigninService'),await this[_0x355723(0x1df)]['update']({'id':_0x2f734d},{'consecutiveDays':0x1});return _0x355723(0x1e0);}async[_0xbcf55e(0x1f6)](_0x9eb700){const _0x121cad=_0xbcf55e;try{const {id:_0x18289c}=_0x9eb700['user'],_0x54c44a=(0x0,date_1[_0x121cad(0x20b)])()[_0x121cad(0x208)](_0x121cad(0x207))[_0x121cad(0x221)](_0x121cad(0x21f)),_0x1b30f7=(0x0,date_1[_0x121cad(0x20b)])()['endOf'](_0x121cad(0x207))[_0x121cad(0x221)](_0x121cad(0x21f)),_0x5064af=this[_0x121cad(0x21a)][_0x121cad(0x210)]('signin'),_0x377cb2=await _0x5064af[_0x121cad(0x20f)](_0x121cad(0x1e7))['andWhere'](_0x121cad(0x1f5),{'userId':_0x9eb700[_0x121cad(0x223)]['id']})['andWhere'](_0x121cad(0x1fe),{'firstDay':_0x54c44a})[_0x121cad(0x229)]('signin.signInTime\x20<=\x20:lastDay',{'lastDay':_0x1b30f7})[_0x121cad(0x1f4)](),_0x5ab417=new Date(_0x54c44a),_0x17a68a=new Date(_0x1b30f7),_0x16b0e9=[],_0x5757a7=new Date(_0x5ab417);while(_0x5757a7<=_0x17a68a){_0x16b0e9['push']((0x0,date_1[_0x121cad(0x20b)])(new Date(_0x5757a7))['format']('YYYY-MM-DD')),_0x5757a7[_0x121cad(0x1f0)](_0x5757a7['getDate']()+0x1);}const _0x131802=[];for(const _0x1267b3 of _0x16b0e9){const _0x267503=_0x377cb2[_0x121cad(0x1ee)](_0x33c2a0=>_0x33c2a0['signInDate']===_0x1267b3);!_0x267503?_0x131802[_0x121cad(0x214)]({'signInDate':_0x1267b3,'isSigned':![]}):(_0x267503[_0x121cad(0x1f7)]=!![],_0x131802['push'](_0x267503));}return _0x131802;}catch(_0x12b440){console[_0x121cad(0x200)]('error:\x20',_0x12b440);throw new common_1[(_0x121cad(0x1eb))](_0x121cad(0x1ec),common_1[_0x121cad(0x1fd)]['BAD_REQUEST']);}}};SigninService=__decorate([(0x0,common_1[_0xbcf55e(0x20e)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(signIn_entity_1[_0xbcf55e(0x218)])),__param(0x1,(0x0,typeorm_1[_0xbcf55e(0x213)])(user_entity_1[_0xbcf55e(0x202)])),__metadata(_0xbcf55e(0x22a),[typeorm_2[_0xbcf55e(0x1f8)],typeorm_2['Repository'],userBalance_service_1[_0xbcf55e(0x22b)],globalConfig_service_1[_0xbcf55e(0x21d)]])],SigninService),exports[_0xbcf55e(0x205)]=SigninService;