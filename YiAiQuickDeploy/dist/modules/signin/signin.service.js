'use strict';const _0x33c6ec=_0x457a;(function(_0x55caf8,_0x1c4f15){const _0x53b240=_0x457a,_0x2ba0bf=_0x55caf8();while(!![]){try{const _0x251963=-parseInt(_0x53b240(0x92))/0x1*(parseInt(_0x53b240(0x73))/0x2)+parseInt(_0x53b240(0x8c))/0x3*(-parseInt(_0x53b240(0x87))/0x4)+parseInt(_0x53b240(0x8b))/0x5+-parseInt(_0x53b240(0x68))/0x6*(-parseInt(_0x53b240(0x82))/0x7)+-parseInt(_0x53b240(0x72))/0x8+parseInt(_0x53b240(0x84))/0x9+-parseInt(_0x53b240(0x9e))/0xa*(-parseInt(_0x53b240(0x97))/0xb);if(_0x251963===_0x1c4f15)break;else _0x2ba0bf['push'](_0x2ba0bf['shift']());}catch(_0x1ae2b5){_0x2ba0bf['push'](_0x2ba0bf['shift']());}}}(_0x5ca1,0x3a4ce));function _0x5ca1(){const _0x3bb2c2=['937895NLYNbu','141RJTpdu','signInDate','InjectRepository','BAD_REQUEST','YYYY-MM-DD\x20HH:mm:ss','./signIn.entity','1slGocL','昨天签到了、今天是连续签到！','昨天没签到、今天重置天数！','metadata','object','3097644dNjSuO','@nestjs/typeorm','SigninEntity','save','saveRecordRechargeLog','@nestjs/common','isSigned','10jztNVa','../userBalance/userBalance.service','setDate','../globalConfig/globalConfig.service','signin','month','UserBalanceService','subtract','UserEntity','globalConfigService','__param','用户不存在','SigninService','HttpStatus','format','andWhere','Injectable','length','RechargeType','../../common/constants/balance.constant','getDate','userBalanceService','12gXeSRp','SIGN_IN','YYYY-MM-DD','getRawMany','signin.signInTime\x20<=\x20:lastDay','push','Logger','signin.userId\x20=\x20:userId','HttpException','GlobalConfigService','1789800VkZOHr','315122HEwdKW','signinEntity','__metadata','sign','Repository','user','../../common/utils/date','../user/user.entity','startOf','update','findOne','getOwnPropertyDescriptor','default','__esModule','getSignatureGiftConfig','403396YzAvUB','debug','3843972FMSZgl','userEntity','defineProperty','33316ChOvkc','endOf','今日已签到、改天再来吧!.','function'];_0x5ca1=function(){return _0x3bb2c2;};return _0x5ca1();}function _0x457a(_0x520e99,_0x17333d){const _0x5ca1e5=_0x5ca1();return _0x457a=function(_0x457a95,_0xcb6362){_0x457a95=_0x457a95-0x64;let _0x59e956=_0x5ca1e5[_0x457a95];return _0x59e956;},_0x457a(_0x520e99,_0x17333d);}var __decorate=this&&this['__decorate']||function(_0x2c957d,_0x5d9c9d,_0x161709,_0x350dc9){const _0x5a8fbf=_0x457a;var _0x3dba6b=arguments[_0x5a8fbf(0xaf)],_0x44a0f0=_0x3dba6b<0x3?_0x5d9c9d:_0x350dc9===null?_0x350dc9=Object[_0x5a8fbf(0x7e)](_0x5d9c9d,_0x161709):_0x350dc9,_0x4532c1;if(typeof Reflect===_0x5a8fbf(0x96)&&typeof Reflect['decorate']===_0x5a8fbf(0x8a))_0x44a0f0=Reflect['decorate'](_0x2c957d,_0x5d9c9d,_0x161709,_0x350dc9);else{for(var _0x2bbf95=_0x2c957d[_0x5a8fbf(0xaf)]-0x1;_0x2bbf95>=0x0;_0x2bbf95--)if(_0x4532c1=_0x2c957d[_0x2bbf95])_0x44a0f0=(_0x3dba6b<0x3?_0x4532c1(_0x44a0f0):_0x3dba6b>0x3?_0x4532c1(_0x5d9c9d,_0x161709,_0x44a0f0):_0x4532c1(_0x5d9c9d,_0x161709))||_0x44a0f0;}return _0x3dba6b>0x3&&_0x44a0f0&&Object[_0x5a8fbf(0x86)](_0x5d9c9d,_0x161709,_0x44a0f0),_0x44a0f0;},__metadata=this&&this[_0x33c6ec(0x75)]||function(_0x465b92,_0x5d7ac7){const _0x24f05c=_0x33c6ec;if(typeof Reflect===_0x24f05c(0x96)&&typeof Reflect[_0x24f05c(0x95)]===_0x24f05c(0x8a))return Reflect['metadata'](_0x465b92,_0x5d7ac7);},__param=this&&this[_0x33c6ec(0xa8)]||function(_0x5ec9a4,_0x43159e){return function(_0x31de0a,_0x4b7b07){_0x43159e(_0x31de0a,_0x4b7b07,_0x5ec9a4);};};Object[_0x33c6ec(0x86)](exports,_0x33c6ec(0x80),{'value':!![]}),exports[_0x33c6ec(0xaa)]=void 0x0;const globalConfig_service_1=require(_0x33c6ec(0xa1)),userBalance_service_1=require(_0x33c6ec(0x9f)),common_1=require(_0x33c6ec(0x9c)),signIn_entity_1=require(_0x33c6ec(0x91)),typeorm_1=require(_0x33c6ec(0x98)),typeorm_2=require('typeorm'),date_1=require(_0x33c6ec(0x79)),user_entity_1=require(_0x33c6ec(0x7a)),balance_constant_1=require(_0x33c6ec(0x65));let SigninService=class SigninService{constructor(_0x5e8e30,_0x54ca87,_0x2e4c01,_0x26a832){const _0x2a627f=_0x33c6ec;this['signinEntity']=_0x5e8e30,this['userEntity']=_0x54ca87,this[_0x2a627f(0x67)]=_0x2e4c01,this['globalConfigService']=_0x26a832;}async[_0x33c6ec(0x76)](_0x126c59){const _0x14c1c0=_0x33c6ec,{id:_0x4cd907}=_0x126c59[_0x14c1c0(0x78)],_0x1384a8=(0x0,date_1[_0x14c1c0(0x7f)])(new Date())['format']('YYYY-MM-DD'),_0x3efa31=await this[_0x14c1c0(0x74)][_0x14c1c0(0x7d)]({'where':{'userId':_0x4cd907,'signInDate':_0x1384a8}});if(_0x3efa31)throw new common_1[(_0x14c1c0(0x70))](_0x14c1c0(0x89),common_1[_0x14c1c0(0xab)][_0x14c1c0(0x8f)]);const {model3Count:_0xb4c4b2,model4Count:_0x46681d,drawMjCount:_0x70ff07}=await this[_0x14c1c0(0xa7)][_0x14c1c0(0x81)]();await this['signinEntity'][_0x14c1c0(0x9a)]({'userId':_0x4cd907,'signInTime':new Date(),'signInDate':_0x1384a8,'isSigned':!![]}),await this['userBalanceService']['addBalanceToUser'](_0x4cd907,{'model3Count':_0xb4c4b2,'model4Count':_0x46681d,'drawMjCount':_0x70ff07}),await this[_0x14c1c0(0x67)][_0x14c1c0(0x9b)]({'userId':_0x4cd907,'rechargeType':balance_constant_1[_0x14c1c0(0x64)][_0x14c1c0(0x69)],'model3Count':_0xb4c4b2,'model4Count':_0x46681d,'drawMjCount':_0x70ff07});const _0x22af6b=(0x0,date_1[_0x14c1c0(0x7f)])(new Date())[_0x14c1c0(0xa5)](0x1,'day')[_0x14c1c0(0xac)](_0x14c1c0(0x6a)),_0x4ecfa7=await this[_0x14c1c0(0x74)][_0x14c1c0(0x7d)]({'where':{'userId':_0x4cd907,'signInDate':_0x22af6b}});if(_0x4ecfa7){common_1[_0x14c1c0(0x6e)][_0x14c1c0(0x83)]('用户'+_0x4cd907+_0x14c1c0(0x93),_0x14c1c0(0xaa));const _0x1999dc=await this[_0x14c1c0(0x85)][_0x14c1c0(0x7d)]({'where':{'id':_0x4cd907}});if(!_0x1999dc)throw new common_1[(_0x14c1c0(0x70))](_0x14c1c0(0xa9),common_1[_0x14c1c0(0xab)][_0x14c1c0(0x8f)]);const {consecutiveDays:consecutiveDays=0x0}=_0x1999dc;await this[_0x14c1c0(0x85)][_0x14c1c0(0x7c)]({'id':_0x4cd907},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x14c1c0(0x6e)]['debug']('用户'+_0x4cd907+_0x14c1c0(0x94),_0x14c1c0(0xaa)),await this[_0x14c1c0(0x85)][_0x14c1c0(0x7c)]({'id':_0x4cd907},{'consecutiveDays':0x1});return'Sign\x20in\x20successful.';}async['getSigninLog'](_0x4ed947){const _0x28885e=_0x33c6ec;try{const {id:_0x3ad619}=_0x4ed947['user'],_0x554ac7=(0x0,date_1[_0x28885e(0x7f)])()[_0x28885e(0x7b)]('month')[_0x28885e(0xac)](_0x28885e(0x90)),_0x534446=(0x0,date_1[_0x28885e(0x7f)])()[_0x28885e(0x88)](_0x28885e(0xa3))[_0x28885e(0xac)]('YYYY-MM-DD\x20HH:mm:ss'),_0x572159=this[_0x28885e(0x74)]['createQueryBuilder'](_0x28885e(0xa2)),_0x4cfd91=await _0x572159['select']('signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned')[_0x28885e(0xad)](_0x28885e(0x6f),{'userId':_0x4ed947['user']['id']})[_0x28885e(0xad)]('signin.signInTime\x20>=\x20:firstDay',{'firstDay':_0x554ac7})['andWhere'](_0x28885e(0x6c),{'lastDay':_0x534446})[_0x28885e(0x6b)](),_0x44d193=new Date(_0x554ac7),_0x33020f=new Date(_0x534446),_0x571bcf=[],_0xc6568b=new Date(_0x44d193);while(_0xc6568b<=_0x33020f){_0x571bcf[_0x28885e(0x6d)]((0x0,date_1[_0x28885e(0x7f)])(new Date(_0xc6568b))['format'](_0x28885e(0x6a))),_0xc6568b[_0x28885e(0xa0)](_0xc6568b[_0x28885e(0x66)]()+0x1);}const _0x4bec00=[];for(const _0x1387f2 of _0x571bcf){const _0x5337ad=_0x4cfd91['find'](_0x1b5c0a=>_0x1b5c0a[_0x28885e(0x8d)]===_0x1387f2);!_0x5337ad?_0x4bec00[_0x28885e(0x6d)]({'signInDate':_0x1387f2,'isSigned':![]}):(_0x5337ad[_0x28885e(0x9d)]=!![],_0x4bec00[_0x28885e(0x6d)](_0x5337ad));}return _0x4bec00;}catch(_0xeabcdf){console['log']('error:\x20',_0xeabcdf);throw new common_1['HttpException']('获取签到数据失败！',common_1[_0x28885e(0xab)]['BAD_REQUEST']);}}};SigninService=__decorate([(0x0,common_1[_0x33c6ec(0xae)])(),__param(0x0,(0x0,typeorm_1[_0x33c6ec(0x8e)])(signIn_entity_1[_0x33c6ec(0x99)])),__param(0x1,(0x0,typeorm_1[_0x33c6ec(0x8e)])(user_entity_1[_0x33c6ec(0xa6)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x33c6ec(0x77)],userBalance_service_1[_0x33c6ec(0xa4)],globalConfig_service_1[_0x33c6ec(0x71)]])],SigninService),exports[_0x33c6ec(0xaa)]=SigninService;