'use strict';const _0x3ca03d=_0xe85b;(function(_0x9af811,_0x149dd2){const _0x3aab85=_0xe85b,_0x29f769=_0x9af811();while(!![]){try{const _0x4ec4a4=-parseInt(_0x3aab85(0x200))/0x1+parseInt(_0x3aab85(0x1de))/0x2*(-parseInt(_0x3aab85(0x219))/0x3)+parseInt(_0x3aab85(0x20d))/0x4+parseInt(_0x3aab85(0x203))/0x5+-parseInt(_0x3aab85(0x1da))/0x6*(parseInt(_0x3aab85(0x1e8))/0x7)+parseInt(_0x3aab85(0x21b))/0x8*(-parseInt(_0x3aab85(0x1ec))/0x9)+parseInt(_0x3aab85(0x21e))/0xa*(parseInt(_0x3aab85(0x20f))/0xb);if(_0x4ec4a4===_0x149dd2)break;else _0x29f769['push'](_0x29f769['shift']());}catch(_0xec5ce5){_0x29f769['push'](_0x29f769['shift']());}}}(_0x4fd2,0x3ce59));function _0xe85b(_0x52937c,_0x1bdf02){const _0x4fd299=_0x4fd2();return _0xe85b=function(_0xe85bee,_0x5a2803){_0xe85bee=_0xe85bee-0x1d7;let _0x125018=_0x4fd299[_0xe85bee];return _0x125018;},_0xe85b(_0x52937c,_0x1bdf02);}var __decorate=this&&this['__decorate']||function(_0x59a6c6,_0x111d0c,_0x161f61,_0x3833f3){const _0xa862ef=_0xe85b;var _0x1c7ec4=arguments[_0xa862ef(0x207)],_0x1d4493=_0x1c7ec4<0x3?_0x111d0c:_0x3833f3===null?_0x3833f3=Object[_0xa862ef(0x208)](_0x111d0c,_0x161f61):_0x3833f3,_0x58d5da;if(typeof Reflect==='object'&&typeof Reflect[_0xa862ef(0x21a)]==='function')_0x1d4493=Reflect[_0xa862ef(0x21a)](_0x59a6c6,_0x111d0c,_0x161f61,_0x3833f3);else{for(var _0x350a8d=_0x59a6c6['length']-0x1;_0x350a8d>=0x0;_0x350a8d--)if(_0x58d5da=_0x59a6c6[_0x350a8d])_0x1d4493=(_0x1c7ec4<0x3?_0x58d5da(_0x1d4493):_0x1c7ec4>0x3?_0x58d5da(_0x111d0c,_0x161f61,_0x1d4493):_0x58d5da(_0x111d0c,_0x161f61))||_0x1d4493;}return _0x1c7ec4>0x3&&_0x1d4493&&Object[_0xa862ef(0x214)](_0x111d0c,_0x161f61,_0x1d4493),_0x1d4493;},__metadata=this&&this[_0x3ca03d(0x1ef)]||function(_0x2836df,_0x34e71e){const _0x533353=_0x3ca03d;if(typeof Reflect===_0x533353(0x220)&&typeof Reflect[_0x533353(0x1e9)]==='function')return Reflect['metadata'](_0x2836df,_0x34e71e);},__param=this&&this[_0x3ca03d(0x1eb)]||function(_0x48dd89,_0x5e1f9c){return function(_0x3458ba,_0x269753){_0x5e1f9c(_0x3458ba,_0x269753,_0x48dd89);};};Object[_0x3ca03d(0x214)](exports,_0x3ca03d(0x1fe),{'value':!![]}),exports[_0x3ca03d(0x202)]=void 0x0;function _0x4fd2(){const _0x27cdb9=['YYYY-MM-DD\x20HH:mm:ss','Sign\x20in\x20successful.','typeorm','294IHrtjj','metadata','error:\x20','__param','3457863JQkfsE','signin.signInTime\x20<=\x20:lastDay','../../common/constants/balance.constant','__metadata','debug','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','userEntity','user','../globalConfig/globalConfig.service','globalConfigService','InjectRepository','SIGN_IN','find','day','SigninEntity','getSignatureGiftConfig','HttpException','用户不存在','__esModule','createQueryBuilder','295366aGgxjx','saveRecordRechargeLog','SigninService','2108735CbMWMy','../../common/utils/date','昨天签到了、今天是连续签到！','../user/user.entity','length','getOwnPropertyDescriptor','findOne','log','@nestjs/typeorm','getSigninLog','1687508MnocGG','YYYY-MM-DD','2844061AVIDkM','Repository','BAD_REQUEST','sign','HttpStatus','defineProperty','signInDate','design:paramtypes','GlobalConfigService','subtract','291AmklGL','decorate','8rAoWrO','format','signinEntity','20YEMcgx','isSigned','object','andWhere','getDate','./signIn.entity','save','UserEntity','push','7188yknwaP','signin.signInTime\x20>=\x20:firstDay','userBalanceService','default','7864aDnYbN','Injectable','startOf','addBalanceToUser','../userBalance/userBalance.service','update','getRawMany'];_0x4fd2=function(){return _0x27cdb9;};return _0x4fd2();}const globalConfig_service_1=require(_0x3ca03d(0x1f4)),userBalance_service_1=require(_0x3ca03d(0x1e2)),common_1=require('@nestjs/common'),signIn_entity_1=require(_0x3ca03d(0x223)),typeorm_1=require(_0x3ca03d(0x20b)),typeorm_2=require(_0x3ca03d(0x1e7)),date_1=require(_0x3ca03d(0x204)),user_entity_1=require(_0x3ca03d(0x206)),balance_constant_1=require(_0x3ca03d(0x1ee));let SigninService=class SigninService{constructor(_0xa57126,_0xdd2795,_0x3bc7e4,_0x38bfa6){const _0x9c1859=_0x3ca03d;this[_0x9c1859(0x21d)]=_0xa57126,this[_0x9c1859(0x1f2)]=_0xdd2795,this['userBalanceService']=_0x3bc7e4,this[_0x9c1859(0x1f5)]=_0x38bfa6;}async[_0x3ca03d(0x212)](_0x438d64){const _0x329721=_0x3ca03d,{id:_0x44fc61}=_0x438d64[_0x329721(0x1f3)],_0x49a678=(0x0,date_1[_0x329721(0x1dd)])(new Date())[_0x329721(0x21c)](_0x329721(0x20e)),_0x2af780=await this[_0x329721(0x21d)][_0x329721(0x209)]({'where':{'userId':_0x44fc61,'signInDate':_0x49a678}});if(_0x2af780)throw new common_1['HttpException']('今日已签到、改天再来吧!.',common_1['HttpStatus'][_0x329721(0x211)]);const {model3Count:_0x532d2b,model4Count:_0x583614,drawMjCount:_0x3748ff}=await this['globalConfigService'][_0x329721(0x1fb)]();await this[_0x329721(0x21d)][_0x329721(0x1d7)]({'userId':_0x44fc61,'signInTime':new Date(),'signInDate':_0x49a678,'isSigned':!![]}),await this['userBalanceService'][_0x329721(0x1e1)](_0x44fc61,{'model3Count':_0x532d2b,'model4Count':_0x583614,'drawMjCount':_0x3748ff}),await this[_0x329721(0x1dc)][_0x329721(0x201)]({'userId':_0x44fc61,'rechargeType':balance_constant_1['RechargeType'][_0x329721(0x1f7)],'model3Count':_0x532d2b,'model4Count':_0x583614,'drawMjCount':_0x3748ff});const _0x13bcb6=(0x0,date_1[_0x329721(0x1dd)])(new Date())[_0x329721(0x218)](0x1,_0x329721(0x1f9))[_0x329721(0x21c)](_0x329721(0x20e)),_0x4949b9=await this[_0x329721(0x21d)][_0x329721(0x209)]({'where':{'userId':_0x44fc61,'signInDate':_0x13bcb6}});if(_0x4949b9){common_1['Logger'][_0x329721(0x1f0)]('用户'+_0x44fc61+_0x329721(0x205),_0x329721(0x202));const _0x2bd7c4=await this[_0x329721(0x1f2)]['findOne']({'where':{'id':_0x44fc61}});if(!_0x2bd7c4)throw new common_1[(_0x329721(0x1fc))](_0x329721(0x1fd),common_1[_0x329721(0x213)][_0x329721(0x211)]);const {consecutiveDays:consecutiveDays=0x0}=_0x2bd7c4;await this[_0x329721(0x1f2)]['update']({'id':_0x44fc61},{'consecutiveDays':consecutiveDays+0x1});}else common_1['Logger']['debug']('用户'+_0x44fc61+'昨天没签到、今天重置天数！',_0x329721(0x202)),await this[_0x329721(0x1f2)][_0x329721(0x1e3)]({'id':_0x44fc61},{'consecutiveDays':0x1});return _0x329721(0x1e6);}async[_0x3ca03d(0x20c)](_0xed0418){const _0x578dcb=_0x3ca03d;try{const {id:_0x25d289}=_0xed0418[_0x578dcb(0x1f3)],_0x301f22=(0x0,date_1[_0x578dcb(0x1dd)])()[_0x578dcb(0x1e0)]('month')['format'](_0x578dcb(0x1e5)),_0xdcbb8e=(0x0,date_1['default'])()['endOf']('month')[_0x578dcb(0x21c)](_0x578dcb(0x1e5)),_0xaafd20=this[_0x578dcb(0x21d)][_0x578dcb(0x1ff)]('signin'),_0x439919=await _0xaafd20['select'](_0x578dcb(0x1f1))['andWhere']('signin.userId\x20=\x20:userId',{'userId':_0xed0418[_0x578dcb(0x1f3)]['id']})[_0x578dcb(0x221)](_0x578dcb(0x1db),{'firstDay':_0x301f22})[_0x578dcb(0x221)](_0x578dcb(0x1ed),{'lastDay':_0xdcbb8e})[_0x578dcb(0x1e4)](),_0x300cb6=new Date(_0x301f22),_0x4049ef=new Date(_0xdcbb8e),_0x84a96f=[],_0x3a7197=new Date(_0x300cb6);while(_0x3a7197<=_0x4049ef){_0x84a96f[_0x578dcb(0x1d9)]((0x0,date_1[_0x578dcb(0x1dd)])(new Date(_0x3a7197))[_0x578dcb(0x21c)]('YYYY-MM-DD')),_0x3a7197['setDate'](_0x3a7197[_0x578dcb(0x222)]()+0x1);}const _0x502aff=[];for(const _0x34bcb1 of _0x84a96f){const _0x21f9b5=_0x439919[_0x578dcb(0x1f8)](_0x139b23=>_0x139b23[_0x578dcb(0x215)]===_0x34bcb1);!_0x21f9b5?_0x502aff[_0x578dcb(0x1d9)]({'signInDate':_0x34bcb1,'isSigned':![]}):(_0x21f9b5[_0x578dcb(0x21f)]=!![],_0x502aff[_0x578dcb(0x1d9)](_0x21f9b5));}return _0x502aff;}catch(_0x105bff){console[_0x578dcb(0x20a)](_0x578dcb(0x1ea),_0x105bff);throw new common_1['HttpException']('获取签到数据失败！',common_1[_0x578dcb(0x213)][_0x578dcb(0x211)]);}}};SigninService=__decorate([(0x0,common_1[_0x3ca03d(0x1df)])(),__param(0x0,(0x0,typeorm_1[_0x3ca03d(0x1f6)])(signIn_entity_1[_0x3ca03d(0x1fa)])),__param(0x1,(0x0,typeorm_1[_0x3ca03d(0x1f6)])(user_entity_1[_0x3ca03d(0x1d8)])),__metadata(_0x3ca03d(0x216),[typeorm_2[_0x3ca03d(0x210)],typeorm_2['Repository'],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x3ca03d(0x217)]])],SigninService),exports[_0x3ca03d(0x202)]=SigninService;