'use strict';const _0x24fcd4=_0x4f89;(function(_0x1e1775,_0x48b2cb){const _0x2111ad=_0x4f89,_0x482e0a=_0x1e1775();while(!![]){try{const _0x58c1ec=parseInt(_0x2111ad(0xb8))/0x1+-parseInt(_0x2111ad(0xcc))/0x2*(-parseInt(_0x2111ad(0xce))/0x3)+parseInt(_0x2111ad(0x95))/0x4+-parseInt(_0x2111ad(0xc6))/0x5*(parseInt(_0x2111ad(0xbc))/0x6)+parseInt(_0x2111ad(0xbb))/0x7*(-parseInt(_0x2111ad(0xc2))/0x8)+parseInt(_0x2111ad(0xcf))/0x9+-parseInt(_0x2111ad(0xc9))/0xa;if(_0x58c1ec===_0x48b2cb)break;else _0x482e0a['push'](_0x482e0a['shift']());}catch(_0x18ea88){_0x482e0a['push'](_0x482e0a['shift']());}}}(_0x3d4b,0xa26c1));function _0x3d4b(){const _0x4dc940=['1516092orhJyp','find','defineProperty','decorate','GlobalConfigService','error:\x20','31624MVJNvn','format','../user/user.entity','log','20PaHMzd','andWhere','HttpException','4880450vNGiSf','function','signin','42qdbsZs','YYYY-MM-DD','160923kyCHxS','11388186HajnVI','Logger','subtract','typeorm','今日已签到、改天再来吧!.','获取签到数据失败！','update','@nestjs/typeorm','BAD_REQUEST','user','signin.signInTime\x20>=\x20:firstDay','昨天签到了、今天是连续签到！','Injectable','endOf','debug','用户不存在','getOwnPropertyDescriptor','__esModule','design:paramtypes','909328hmAmrt','Repository','HttpStatus','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','setDate','InjectRepository','RechargeType','SigninService','__metadata','getDate','day','metadata','userEntity','__param','../../common/constants/balance.constant','save','default','sign','Sign\x20in\x20successful.','signinEntity','month','findOne','createQueryBuilder','globalConfigService','UserBalanceService','YYYY-MM-DD\x20HH:mm:ss','userBalanceService','getRawMany','addBalanceToUser','SigninEntity','startOf','signin.signInTime\x20<=\x20:lastDay','object','@nestjs/common','push','766384vElSba','signInDate','../../common/utils/date','2163QRrtQF'];_0x3d4b=function(){return _0x4dc940;};return _0x3d4b();}var __decorate=this&&this['__decorate']||function(_0x1eb360,_0x998ef7,_0x5a1970,_0x37857e){const _0x404ea9=_0x4f89;var _0x1b0a48=arguments['length'],_0x30d116=_0x1b0a48<0x3?_0x998ef7:_0x37857e===null?_0x37857e=Object[_0x404ea9(0x92)](_0x998ef7,_0x5a1970):_0x37857e,_0x718c21;if(typeof Reflect===_0x404ea9(0xb5)&&typeof Reflect[_0x404ea9(0xbf)]===_0x404ea9(0xca))_0x30d116=Reflect[_0x404ea9(0xbf)](_0x1eb360,_0x998ef7,_0x5a1970,_0x37857e);else{for(var _0x221375=_0x1eb360['length']-0x1;_0x221375>=0x0;_0x221375--)if(_0x718c21=_0x1eb360[_0x221375])_0x30d116=(_0x1b0a48<0x3?_0x718c21(_0x30d116):_0x1b0a48>0x3?_0x718c21(_0x998ef7,_0x5a1970,_0x30d116):_0x718c21(_0x998ef7,_0x5a1970))||_0x30d116;}return _0x1b0a48>0x3&&_0x30d116&&Object[_0x404ea9(0xbe)](_0x998ef7,_0x5a1970,_0x30d116),_0x30d116;},__metadata=this&&this[_0x24fcd4(0x9d)]||function(_0x7bbeec,_0x347ba0){const _0x4b6e47=_0x24fcd4;if(typeof Reflect===_0x4b6e47(0xb5)&&typeof Reflect[_0x4b6e47(0xa0)]===_0x4b6e47(0xca))return Reflect['metadata'](_0x7bbeec,_0x347ba0);},__param=this&&this[_0x24fcd4(0xa2)]||function(_0x8bac6b,_0x1a7023){return function(_0x149e64,_0x5c89f3){_0x1a7023(_0x149e64,_0x5c89f3,_0x8bac6b);};};Object[_0x24fcd4(0xbe)](exports,_0x24fcd4(0x93),{'value':!![]}),exports[_0x24fcd4(0x9c)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),userBalance_service_1=require('../userBalance/userBalance.service'),common_1=require(_0x24fcd4(0xb6)),signIn_entity_1=require('./signIn.entity'),typeorm_1=require(_0x24fcd4(0x89)),typeorm_2=require(_0x24fcd4(0x85)),date_1=require(_0x24fcd4(0xba)),user_entity_1=require(_0x24fcd4(0xc4)),balance_constant_1=require(_0x24fcd4(0xa3));let SigninService=class SigninService{constructor(_0x45e50d,_0x5061f4,_0x18a823,_0x18291b){const _0x37973f=_0x24fcd4;this[_0x37973f(0xa8)]=_0x45e50d,this['userEntity']=_0x5061f4,this[_0x37973f(0xaf)]=_0x18a823,this[_0x37973f(0xac)]=_0x18291b;}async[_0x24fcd4(0xa6)](_0x961abd){const _0x1252f0=_0x24fcd4,{id:_0x43eee1}=_0x961abd[_0x1252f0(0x8b)],_0x19a406=(0x0,date_1[_0x1252f0(0xa5)])(new Date())['format'](_0x1252f0(0xcd)),_0x49ee76=await this[_0x1252f0(0xa8)][_0x1252f0(0xaa)]({'where':{'userId':_0x43eee1,'signInDate':_0x19a406}});if(_0x49ee76)throw new common_1['HttpException'](_0x1252f0(0x86),common_1[_0x1252f0(0x97)]['BAD_REQUEST']);const {model3Count:_0x404d2b,model4Count:_0x4f9559,drawMjCount:_0x1271e9}=await this['globalConfigService']['getSignatureGiftConfig']();await this[_0x1252f0(0xa8)][_0x1252f0(0xa4)]({'userId':_0x43eee1,'signInTime':new Date(),'signInDate':_0x19a406,'isSigned':!![]}),await this[_0x1252f0(0xaf)][_0x1252f0(0xb1)](_0x43eee1,{'model3Count':_0x404d2b,'model4Count':_0x4f9559,'drawMjCount':_0x1271e9}),await this[_0x1252f0(0xaf)]['saveRecordRechargeLog']({'userId':_0x43eee1,'rechargeType':balance_constant_1[_0x1252f0(0x9b)]['SIGN_IN'],'model3Count':_0x404d2b,'model4Count':_0x4f9559,'drawMjCount':_0x1271e9});const _0x53b2b1=(0x0,date_1[_0x1252f0(0xa5)])(new Date())[_0x1252f0(0xd1)](0x1,_0x1252f0(0x9f))[_0x1252f0(0xc3)](_0x1252f0(0xcd)),_0x55bf42=await this[_0x1252f0(0xa8)]['findOne']({'where':{'userId':_0x43eee1,'signInDate':_0x53b2b1}});if(_0x55bf42){common_1[_0x1252f0(0xd0)][_0x1252f0(0x90)]('用户'+_0x43eee1+_0x1252f0(0x8d),_0x1252f0(0x9c));const _0x1ae26d=await this['userEntity'][_0x1252f0(0xaa)]({'where':{'id':_0x43eee1}});if(!_0x1ae26d)throw new common_1[(_0x1252f0(0xc8))](_0x1252f0(0x91),common_1['HttpStatus'][_0x1252f0(0x8a)]);const {consecutiveDays:consecutiveDays=0x0}=_0x1ae26d;await this[_0x1252f0(0xa1)][_0x1252f0(0x88)]({'id':_0x43eee1},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x1252f0(0xd0)][_0x1252f0(0x90)]('用户'+_0x43eee1+'昨天没签到、今天重置天数！',_0x1252f0(0x9c)),await this['userEntity']['update']({'id':_0x43eee1},{'consecutiveDays':0x1});return _0x1252f0(0xa7);}async['getSigninLog'](_0x2bf286){const _0x3fdda6=_0x24fcd4;try{const {id:_0x21b4ce}=_0x2bf286['user'],_0x16b123=(0x0,date_1[_0x3fdda6(0xa5)])()[_0x3fdda6(0xb3)](_0x3fdda6(0xa9))[_0x3fdda6(0xc3)](_0x3fdda6(0xae)),_0x2f7ec3=(0x0,date_1['default'])()[_0x3fdda6(0x8f)]('month')[_0x3fdda6(0xc3)](_0x3fdda6(0xae)),_0x133a68=this[_0x3fdda6(0xa8)][_0x3fdda6(0xab)](_0x3fdda6(0xcb)),_0x81e1cd=await _0x133a68['select'](_0x3fdda6(0x98))[_0x3fdda6(0xc7)]('signin.userId\x20=\x20:userId',{'userId':_0x2bf286['user']['id']})[_0x3fdda6(0xc7)](_0x3fdda6(0x8c),{'firstDay':_0x16b123})['andWhere'](_0x3fdda6(0xb4),{'lastDay':_0x2f7ec3})[_0x3fdda6(0xb0)](),_0x4a80ee=new Date(_0x16b123),_0x34df97=new Date(_0x2f7ec3),_0x134a8c=[],_0x17cd47=new Date(_0x4a80ee);while(_0x17cd47<=_0x34df97){_0x134a8c[_0x3fdda6(0xb7)]((0x0,date_1[_0x3fdda6(0xa5)])(new Date(_0x17cd47))[_0x3fdda6(0xc3)](_0x3fdda6(0xcd))),_0x17cd47[_0x3fdda6(0x99)](_0x17cd47[_0x3fdda6(0x9e)]()+0x1);}const _0x2fff38=[];for(const _0x2a6640 of _0x134a8c){const _0x1d0e8c=_0x81e1cd[_0x3fdda6(0xbd)](_0x1e832f=>_0x1e832f[_0x3fdda6(0xb9)]===_0x2a6640);!_0x1d0e8c?_0x2fff38[_0x3fdda6(0xb7)]({'signInDate':_0x2a6640,'isSigned':![]}):(_0x1d0e8c['isSigned']=!![],_0x2fff38['push'](_0x1d0e8c));}return _0x2fff38;}catch(_0x242cd6){console[_0x3fdda6(0xc5)](_0x3fdda6(0xc1),_0x242cd6);throw new common_1[(_0x3fdda6(0xc8))](_0x3fdda6(0x87),common_1[_0x3fdda6(0x97)]['BAD_REQUEST']);}}};function _0x4f89(_0x28a361,_0x4c0e2a){const _0x3d4bce=_0x3d4b();return _0x4f89=function(_0x4f8954,_0x43eebc){_0x4f8954=_0x4f8954-0x85;let _0x53ddb5=_0x3d4bce[_0x4f8954];return _0x53ddb5;},_0x4f89(_0x28a361,_0x4c0e2a);}SigninService=__decorate([(0x0,common_1[_0x24fcd4(0x8e)])(),__param(0x0,(0x0,typeorm_1[_0x24fcd4(0x9a)])(signIn_entity_1[_0x24fcd4(0xb2)])),__param(0x1,(0x0,typeorm_1[_0x24fcd4(0x9a)])(user_entity_1['UserEntity'])),__metadata(_0x24fcd4(0x94),[typeorm_2['Repository'],typeorm_2[_0x24fcd4(0x96)],userBalance_service_1[_0x24fcd4(0xad)],globalConfig_service_1[_0x24fcd4(0xc0)]])],SigninService),exports[_0x24fcd4(0x9c)]=SigninService;