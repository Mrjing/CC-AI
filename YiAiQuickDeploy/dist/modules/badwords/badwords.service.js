'use strict';function _0x1f46(_0x2a1dab,_0x2ac086){const _0x25444e=_0x2544();return _0x1f46=function(_0x1f4648,_0x152b76){_0x1f4648=_0x1f4648-0x1cd;let _0x4c4e0e=_0x25444e[_0x1f4648];return _0x4c4e0e;},_0x1f46(_0x2a1dab,_0x2ac086);}const _0x2b9b3d=_0x1f46;(function(_0x3ec5b1,_0x175d27){const _0x2d6ad5=_0x1f46,_0x35c3a0=_0x3ec5b1();while(!![]){try{const _0x3024f6=-parseInt(_0x2d6ad5(0x1d0))/0x1+parseInt(_0x2d6ad5(0x208))/0x2+parseInt(_0x2d6ad5(0x1de))/0x3+-parseInt(_0x2d6ad5(0x22d))/0x4*(-parseInt(_0x2d6ad5(0x234))/0x5)+-parseInt(_0x2d6ad5(0x22f))/0x6*(-parseInt(_0x2d6ad5(0x20a))/0x7)+-parseInt(_0x2d6ad5(0x1dc))/0x8+-parseInt(_0x2d6ad5(0x206))/0x9;if(_0x3024f6===_0x175d27)break;else _0x35c3a0['push'](_0x35c3a0['shift']());}catch(_0x5b84d5){_0x35c3a0['push'](_0x35c3a0['shift']());}}}(_0x2544,0x58eca));var __decorate=this&&this[_0x2b9b3d(0x1e9)]||function(_0x2d339a,_0x4a793b,_0x417ab8,_0x702937){const _0x2ce17c=_0x2b9b3d;var _0x225ab5=arguments['length'],_0x54e18b=_0x225ab5<0x3?_0x4a793b:_0x702937===null?_0x702937=Object[_0x2ce17c(0x213)](_0x4a793b,_0x417ab8):_0x702937,_0x50eae2;if(typeof Reflect===_0x2ce17c(0x229)&&typeof Reflect[_0x2ce17c(0x1e3)]===_0x2ce17c(0x1fa))_0x54e18b=Reflect['decorate'](_0x2d339a,_0x4a793b,_0x417ab8,_0x702937);else{for(var _0x2f3cf2=_0x2d339a[_0x2ce17c(0x1eb)]-0x1;_0x2f3cf2>=0x0;_0x2f3cf2--)if(_0x50eae2=_0x2d339a[_0x2f3cf2])_0x54e18b=(_0x225ab5<0x3?_0x50eae2(_0x54e18b):_0x225ab5>0x3?_0x50eae2(_0x4a793b,_0x417ab8,_0x54e18b):_0x50eae2(_0x4a793b,_0x417ab8))||_0x54e18b;}return _0x225ab5>0x3&&_0x54e18b&&Object[_0x2ce17c(0x1e8)](_0x4a793b,_0x417ab8,_0x54e18b),_0x54e18b;},__metadata=this&&this[_0x2b9b3d(0x215)]||function(_0x57d45d,_0x5cb815){const _0x52737f=_0x2b9b3d;if(typeof Reflect===_0x52737f(0x229)&&typeof Reflect[_0x52737f(0x218)]===_0x52737f(0x1fa))return Reflect[_0x52737f(0x218)](_0x57d45d,_0x5cb815);},__param=this&&this[_0x2b9b3d(0x1dd)]||function(_0x5c7933,_0x41985f){return function(_0x575147,_0x29c381){_0x41985f(_0x575147,_0x29c381,_0x5c7933);};};Object[_0x2b9b3d(0x1e8)](exports,_0x2b9b3d(0x1ee),{'value':!![]}),exports[_0x2b9b3d(0x21f)]=void 0x0;function _0x2544(){const _0x428b0c=['Repository','findOne','__esModule','stringify','敏感词已经存在了、请勿重复添加','find','添加敏感词成功','敏感词检测\x20|\x20','word','execute','update','error:\x20','id\x20=\x20:userId','updateBadWords','function','post','NineAi检测','includes','DESC','code','affected','ASC','avatar','getSensitiveConfig','@nestjs/typeorm','HttpException','4223466YsVQvk','./badwords.entity','893160ELFBLA','recordUserBadWords','320369RWDHKV','badWordsEntity','typeorm','checkBadWords','自定义','typeOriginCn','status','InjectRepository','map','getOwnPropertyDescriptor','customSensitiveWords','__metadata','log','../../common/utils','metadata','globalConfigService','BAD_REQUEST','data','violationCount','baidu','百度云检测','BadwordsService','Injectable','badWords','formarTips','更新敏感词成功','../user/user.entity','join','violation','application/json','delete','object','HttpStatus','design:paramtypes','../globalConfig/globalConfig.service','4GeMLgF','addBadWord','36qmwUgJ','baiduTextAccessToken','的内容、我们已对您的账户进行标记、请合规使用！','更新敏感词失败','hideString','3390365LGkfHg','delBadWords','extractContent','nineaiCheckBadWords','***','userId','UserEntity','470896nzbBTk','百度文本检测出现错误、请查看配置信息:\x20','email','violationCount\x20+\x201','GlobalConfigService','application/x-www-form-urlencoded','loadBadWords','onModuleInit','createQueryBuilder','baiduCheckBadWords','自定义检测','save','4501600ajLytc','__param','1403547VyWAuy','where','https://aip.baidubce.com/rest/2.0/solution/v1/text_censor/v2/user_defined?access_token=','word_list','checkBadWordsByConfig','decorate','敏感词不存在,请检查您的提交信息','category','findAndCount','nineai','defineProperty','__decorate','default','length'];_0x2544=function(){return _0x428b0c;};return _0x2544();}const globalConfig_service_1=require(_0x2b9b3d(0x22c)),common_1=require('@nestjs/common'),badwords_entity_1=require(_0x2b9b3d(0x207)),typeorm_1=require(_0x2b9b3d(0x20c)),typeorm_2=require(_0x2b9b3d(0x204)),axios_1=require('axios'),violationLog_entity_1=require('./violationLog.entity'),user_entity_1=require(_0x2b9b3d(0x224)),utils_1=require(_0x2b9b3d(0x217));let BadwordsService=class BadwordsService{constructor(_0x4498f1,_0x45812d,_0x12a148,_0x3dd3c0){const _0x5f0f3d=_0x2b9b3d;this[_0x5f0f3d(0x20b)]=_0x4498f1,this['violationLogEntity']=_0x45812d,this['userEntity']=_0x12a148,this[_0x5f0f3d(0x219)]=_0x3dd3c0,this['badWords']=[];}async[_0x2b9b3d(0x1d7)](){this['loadBadWords']();}async[_0x2b9b3d(0x214)](_0x2e6ad5,_0x2211d2){const _0x4224b6=_0x2b9b3d,_0x562a46=[];for(let _0x23350a=0x0;_0x23350a<this[_0x4224b6(0x221)][_0x4224b6(0x1eb)];_0x23350a++){const _0x391b9a=this['badWords'][_0x23350a];_0x2e6ad5[_0x4224b6(0x1fd)](_0x391b9a)&&_0x562a46['push'](_0x391b9a);}if(_0x562a46[_0x4224b6(0x1eb)]){await this[_0x4224b6(0x209)](_0x2211d2,_0x2e6ad5,_0x562a46,[_0x4224b6(0x20e)],_0x4224b6(0x1da));const _0x5909b3='您提交的信息中包含违规的内容、我们已对您的账户进行标记、请合规使用！';throw new common_1[(_0x4224b6(0x205))](_0x5909b3,common_1[_0x4224b6(0x22a)][_0x4224b6(0x21a)]);}}async[_0x2b9b3d(0x20d)](_0x1e18d4,_0x47efa5){const _0x2d0cca=_0x2b9b3d,_0x246c57=await this['globalConfigService'][_0x2d0cca(0x203)]();_0x246c57&&await this[_0x2d0cca(0x1e2)](_0x1e18d4,_0x246c57,_0x47efa5),await this[_0x2d0cca(0x214)](_0x1e18d4,_0x47efa5);}async[_0x2b9b3d(0x1e2)](_0x3ff9e7,_0x447299,_0x3ed535){const _0x2c9c11=_0x2b9b3d,{useType:_0x53a4fa}=_0x447299;_0x53a4fa===_0x2c9c11(0x21d)&&await this[_0x2c9c11(0x1d9)](_0x3ff9e7,_0x447299[_0x2c9c11(0x230)],_0x3ed535),_0x53a4fa===_0x2c9c11(0x1e7)&&await this[_0x2c9c11(0x237)](_0x3ff9e7,_0x447299,_0x3ed535);}[_0x2b9b3d(0x236)](_0x3a4081){const _0x498e6f=/存在(.*?)不合规/,_0x3e3c37=_0x3a4081['match'](_0x498e6f);return _0x3e3c37?_0x3e3c37[0x1]:'';}async[_0x2b9b3d(0x1d9)](_0x588e72,_0x48d3a0,_0x357d6a){const _0x20874c=_0x2b9b3d;if(!_0x48d3a0)return;const _0x2ebed6=_0x20874c(0x1e0)+_0x48d3a0+'}',_0x46411c={'Content-Type':_0x20874c(0x1d5),'Accept':_0x20874c(0x227)},_0x27ba72=await axios_1['default'][_0x20874c(0x1fb)](_0x2ebed6,{'text':_0x588e72},{'headers':_0x46411c}),{conclusion:_0x88f3e1,error_code:_0x4945eb,error_msg:_0x7e864d,conclusionType:_0x353cd8,data:_0x30eb92}=_0x27ba72[_0x20874c(0x21b)];_0x4945eb&&console[_0x20874c(0x216)](_0x20874c(0x1d1),_0x7e864d);if(_0x353cd8!==0x1){const _0x5aafbb=[...new Set(_0x30eb92[_0x20874c(0x212)](_0xe1b83e=>this['extractContent'](_0xe1b83e['msg'])))];await this['recordUserBadWords'](_0x357d6a,_0x588e72,[_0x20874c(0x1cd)],_0x5aafbb,_0x20874c(0x21e));const _0x5eccd9='您提交的信息中包含'+_0x5aafbb['join'](',')+_0x20874c(0x231);throw new common_1[(_0x20874c(0x205))](_0x5eccd9,common_1[_0x20874c(0x22a)][_0x20874c(0x21a)]);}}async['nineaiCheckBadWords'](_0x39c8f1,_0x2e4461,_0x274eb8){const _0x5d8372=_0x2b9b3d;var _0x2a394e;const {nineaiBuiltInSensitiveApiBase:_0x57a218,nineaiBuiltInSensitiveAuthKey:_0xa6f992}=_0x2e4461;if(!_0x57a218||!_0xa6f992)return;const _0x4094f6=await axios_1[_0x5d8372(0x1ea)][_0x5d8372(0x1fb)](_0x57a218,{'content':_0x39c8f1},{'headers':{'Content-Type':_0x5d8372(0x227),'Authorization':_0xa6f992}});if(!_0x4094f6[_0x5d8372(0x21b)])return;if(_0x4094f6[_0x5d8372(0x21b)][_0x5d8372(0x1ff)]!=='0'){const {msg:msg='检测失败'}=_0x4094f6[_0x5d8372(0x21b)];throw new common_1[(_0x5d8372(0x205))](_0x5d8372(0x1f3)+msg,common_1['HttpStatus'][_0x5d8372(0x21a)]);}if(_0x4094f6[_0x5d8372(0x21b)]['word_list']&&((_0x2a394e=_0x4094f6['data']['word_list'])===null||_0x2a394e===void 0x0?void 0x0:_0x2a394e[_0x5d8372(0x1eb)])){const _0x42c783=[...new Set(_0x4094f6[_0x5d8372(0x21b)]['word_list']['map'](_0x4893ef=>_0x4893ef['keyword']))],_0xac766c=[...new Set(_0x4094f6[_0x5d8372(0x21b)][_0x5d8372(0x1e1)][_0x5d8372(0x212)](_0x30ea4d=>_0x30ea4d[_0x5d8372(0x1e5)]))];await this['recordUserBadWords'](_0x274eb8,_0x39c8f1,_0x42c783,_0xac766c,_0x5d8372(0x1fc));const _0x460f48=this[_0x5d8372(0x222)](_0x4094f6[_0x5d8372(0x21b)]['word_list']);throw new common_1['HttpException'](_0x460f48,common_1['HttpStatus']['BAD_REQUEST']);}}[_0x2b9b3d(0x222)](_0x251a10){const _0x334098=_0x2b9b3d,_0x3f59a2=_0x251a10[_0x334098(0x212)](_0x2cd21c=>_0x2cd21c[_0x334098(0x1e5)]),_0x2418ea=[...new Set(_0x3f59a2)];return'您提交的内容中包含'+_0x2418ea[_0x334098(0x225)](',')+'的信息、我们已对您账号进行标记、请合规使用！';}async[_0x2b9b3d(0x1d6)](){const _0xd4b296=_0x2b9b3d,_0x1f9739=await this[_0xd4b296(0x20b)][_0xd4b296(0x1f1)]({'where':{'status':0x1},'select':['word']});this[_0xd4b296(0x221)]=_0x1f9739[_0xd4b296(0x212)](_0x1568d8=>_0x1568d8['word']);}async['queryBadWords'](_0x1c7328){const _0x253477=_0x2b9b3d,{page:page=0x1,size:size=0x1f4,word:_0x264840,status:_0x45f205}=_0x1c7328,_0x9538dc={};[0x0,0x1,'0','1']['includes'](_0x45f205)&&(_0x9538dc[_0x253477(0x210)]=_0x45f205),_0x264840&&(_0x9538dc[_0x253477(0x1f4)]=(0x0,typeorm_1['Like'])('%'+_0x264840+'%'));const [_0x493cf8,_0x2df9b8]=await this[_0x253477(0x20b)][_0x253477(0x1e6)]({'where':_0x9538dc,'skip':(page-0x1)*size,'take':size,'order':{'id':_0x253477(0x201)}});return{'rows':_0x493cf8,'count':_0x2df9b8};}async[_0x2b9b3d(0x235)](_0x28a06f){const _0x29f1e0=_0x2b9b3d,_0x2721a4=await this['badWordsEntity'][_0x29f1e0(0x1ed)]({'where':{'id':_0x28a06f['id']}});if(!_0x2721a4)throw new common_1['HttpException'](_0x29f1e0(0x1e4),common_1[_0x29f1e0(0x22a)]['BAD_REQUEST']);const _0x2e4c71=await this[_0x29f1e0(0x20b)][_0x29f1e0(0x228)]({'id':_0x28a06f['id']});if(_0x2e4c71['affected']>0x0)return await this[_0x29f1e0(0x1d6)](),'删除敏感词成功';else throw new common_1[(_0x29f1e0(0x205))]('删除敏感词失败',common_1[_0x29f1e0(0x22a)][_0x29f1e0(0x21a)]);}async[_0x2b9b3d(0x1f9)](_0x4323c3){const _0x5c08f6=_0x2b9b3d,{id:_0x391ac7,word:_0x457eac,status:_0xdc1d64}=_0x4323c3,_0x2322f3=await this[_0x5c08f6(0x20b)][_0x5c08f6(0x1ed)]({'where':{'word':_0x457eac}});if(_0x2322f3)throw new common_1[(_0x5c08f6(0x205))](_0x5c08f6(0x1f0),common_1['HttpStatus'][_0x5c08f6(0x21a)]);const _0x18c571=await this[_0x5c08f6(0x20b)][_0x5c08f6(0x1f6)]({'id':_0x391ac7},{'word':_0x457eac,'status':_0xdc1d64});if(_0x18c571[_0x5c08f6(0x200)]>0x0)return await this[_0x5c08f6(0x1d6)](),_0x5c08f6(0x223);else throw new common_1['HttpException'](_0x5c08f6(0x232),common_1[_0x5c08f6(0x22a)][_0x5c08f6(0x21a)]);}async[_0x2b9b3d(0x22e)](_0x43fe3b){const _0x5795fe=_0x2b9b3d,{word:_0x11db71}=_0x43fe3b,_0x1d092f=await this[_0x5795fe(0x20b)]['findOne']({'where':{'word':_0x11db71}});if(_0x1d092f)throw new common_1[(_0x5795fe(0x205))]('敏感词已存在,请检查您的提交信息',common_1[_0x5795fe(0x22a)][_0x5795fe(0x21a)]);return await this['badWordsEntity'][_0x5795fe(0x1db)]({'word':_0x11db71}),await this[_0x5795fe(0x1d6)](),_0x5795fe(0x1f2);}async[_0x2b9b3d(0x209)](_0xc8dc32,_0x54eaa5,_0x106b60,_0xb150da,_0x299669){const _0x2f74c7=_0x2b9b3d,_0x3785d8={'userId':_0xc8dc32,'content':_0x54eaa5,'words':JSON[_0x2f74c7(0x1ef)](_0x106b60),'typeCn':JSON[_0x2f74c7(0x1ef)](_0xb150da),'typeOriginCn':_0x299669};try{await this['userEntity'][_0x2f74c7(0x1d8)]()[_0x2f74c7(0x1f6)](user_entity_1[_0x2f74c7(0x1cf)])['set']({'violationCount':()=>_0x2f74c7(0x1d3)})[_0x2f74c7(0x1df)](_0x2f74c7(0x1f8),{'userId':_0xc8dc32})[_0x2f74c7(0x1f5)](),await this['violationLogEntity'][_0x2f74c7(0x1db)](_0x3785d8);}catch(_0x1e8fbe){console[_0x2f74c7(0x216)](_0x2f74c7(0x1f7),_0x1e8fbe);}}async[_0x2b9b3d(0x226)](_0x149c34,_0x3bc46d){const _0x3e72a4=_0x2b9b3d,{role:_0x5c1009}=_0x149c34['user'],{page:page=0x1,size:size=0xa,userId:_0x20018e,typeOriginCn:_0x225973}=_0x3bc46d,_0x552c84={};_0x20018e&&(_0x552c84[_0x3e72a4(0x1ce)]=_0x20018e),_0x225973&&(_0x552c84[_0x3e72a4(0x20f)]=_0x225973);const [_0x2869c7,_0x357efb]=await this['violationLogEntity'][_0x3e72a4(0x1e6)]({'where':_0x552c84,'skip':(page-0x1)*size,'take':size,'order':{'id':_0x3e72a4(0x1fe)}}),_0x3c320f=[...new Set(_0x2869c7[_0x3e72a4(0x212)](_0x20142b=>_0x20142b[_0x3e72a4(0x1ce)]))],_0x13595b=await this['userEntity'][_0x3e72a4(0x1f1)]({'where':{'id':(0x0,typeorm_1['In'])(_0x3c320f)},'select':['id',_0x3e72a4(0x202),'username',_0x3e72a4(0x1d2),_0x3e72a4(0x21c),_0x3e72a4(0x210)]});return _0x2869c7['forEach'](_0x4bd5e2=>{const _0x32ed71=_0x3e72a4,_0x2e9c29=_0x13595b['find'](_0x1ead48=>_0x1ead48['id']===_0x4bd5e2['userId']);_0x5c1009!=='super'&&(_0x2e9c29[_0x32ed71(0x1d2)]=(0x0,utils_1[_0x32ed71(0x233)])(_0x2e9c29[_0x32ed71(0x1d2)])),_0x4bd5e2['userInfo']=_0x2e9c29;}),{'rows':_0x2869c7,'count':_0x357efb};}};BadwordsService=__decorate([(0x0,common_1[_0x2b9b3d(0x220)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(badwords_entity_1['BadWordsEntity'])),__param(0x1,(0x0,typeorm_2[_0x2b9b3d(0x211)])(violationLog_entity_1['ViolationLogEntity'])),__param(0x2,(0x0,typeorm_2[_0x2b9b3d(0x211)])(user_entity_1['UserEntity'])),__metadata(_0x2b9b3d(0x22b),[typeorm_1['Repository'],typeorm_1[_0x2b9b3d(0x1ec)],typeorm_1[_0x2b9b3d(0x1ec)],globalConfig_service_1[_0x2b9b3d(0x1d4)]])],BadwordsService),exports[_0x2b9b3d(0x21f)]=BadwordsService;