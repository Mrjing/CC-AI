'use strict';const _0x50db9b=_0x3bff;function _0x3bff(_0x34cd8b,_0x367b3d){const _0x1ff9df=_0x1ff9();return _0x3bff=function(_0x3bff41,_0x27a671){_0x3bff41=_0x3bff41-0x1d7;let _0x41e9a9=_0x1ff9df[_0x3bff41];return _0x41e9a9;},_0x3bff(_0x34cd8b,_0x367b3d);}(function(_0x43bc7b,_0x3cb8b4){const _0x71c0af=_0x3bff,_0x3a1bca=_0x43bc7b();while(!![]){try{const _0x3557f8=parseInt(_0x71c0af(0x214))/0x1*(-parseInt(_0x71c0af(0x1e6))/0x2)+-parseInt(_0x71c0af(0x1df))/0x3*(parseInt(_0x71c0af(0x207))/0x4)+parseInt(_0x71c0af(0x224))/0x5+-parseInt(_0x71c0af(0x211))/0x6+parseInt(_0x71c0af(0x204))/0x7+parseInt(_0x71c0af(0x221))/0x8*(-parseInt(_0x71c0af(0x1f2))/0x9)+-parseInt(_0x71c0af(0x1d9))/0xa*(-parseInt(_0x71c0af(0x20c))/0xb);if(_0x3557f8===_0x3cb8b4)break;else _0x3a1bca['push'](_0x3a1bca['shift']());}catch(_0x17f8a9){_0x3a1bca['push'](_0x3a1bca['shift']());}}}(_0x1ff9,0xc9331));function _0x1ff9(){const _0x5844a5=[':CAPTCHA:','3729342GjuvMq','Message','DESC','233023YEaGDO','Injectable','verifyCode','验证码已过期','BAD_REQUEST','S内不得重新发送','save','update','length','VerificationUseStatusEnum','log','function','HttpStatus','584tEUDIX','验证码不存在','redisCacheService','5766280NETJjW','code','now','getNamespace','../../common/utils','../globalConfig/globalConfig.service','expiresAt','9880mwSdUe','验证码发送失败！','verifycationEntity','object','stringify','typeorm','12oRWlii','error','__param','decorate','ceil','../../common/constants/status.constant','ap-beijing','4jyUveB','get','createVerification','used','HttpException','Client','USED','./verifycation.entity','defineProperty','VerifycationEntity','getTime','sms','90135OFobng','@alicloud/pop-core','sendPhoneCode','createdAt','getQcloudPhoneVerifyConfig','metadata','确实必要参数错误！','sendPhoneCodeWithQcloud','createRandomCode','https://dysmsapi.aliyuncs.com','findOne','../redisCache/redisCache.service','__esModule','验证码错误','request','SendSms','图形验证码错误、请检查填写!','@nestjs/common','11200637IJhHWr','del','globalConfigService','364452rubUed','__decorate','2017-05-25','verifyCaptcha','POST','2827oeRyDa','design:paramtypes','@nestjs/typeorm','VerificationService'];_0x1ff9=function(){return _0x5844a5;};return _0x1ff9();}var __decorate=this&&this[_0x50db9b(0x208)]||function(_0x3af452,_0x1127bb,_0x7fad25,_0x49f88d){const _0x177e3d=_0x50db9b;var _0x1c4427=arguments['length'],_0x2055a5=_0x1c4427<0x3?_0x1127bb:_0x49f88d===null?_0x49f88d=Object['getOwnPropertyDescriptor'](_0x1127bb,_0x7fad25):_0x49f88d,_0x5a9f62;if(typeof Reflect==='object'&&typeof Reflect[_0x177e3d(0x1e2)]===_0x177e3d(0x21f))_0x2055a5=Reflect[_0x177e3d(0x1e2)](_0x3af452,_0x1127bb,_0x7fad25,_0x49f88d);else{for(var _0x1eef81=_0x3af452[_0x177e3d(0x21c)]-0x1;_0x1eef81>=0x0;_0x1eef81--)if(_0x5a9f62=_0x3af452[_0x1eef81])_0x2055a5=(_0x1c4427<0x3?_0x5a9f62(_0x2055a5):_0x1c4427>0x3?_0x5a9f62(_0x1127bb,_0x7fad25,_0x2055a5):_0x5a9f62(_0x1127bb,_0x7fad25))||_0x2055a5;}return _0x1c4427>0x3&&_0x2055a5&&Object[_0x177e3d(0x1ee)](_0x1127bb,_0x7fad25,_0x2055a5),_0x2055a5;},__metadata=this&&this['__metadata']||function(_0x2fcf36,_0x2215f8){const _0x51d0e7=_0x50db9b;if(typeof Reflect===_0x51d0e7(0x1dc)&&typeof Reflect[_0x51d0e7(0x1f7)]==='function')return Reflect[_0x51d0e7(0x1f7)](_0x2fcf36,_0x2215f8);},__param=this&&this[_0x50db9b(0x1e1)]||function(_0x47a37e,_0x13c3ff){return function(_0x2a584e,_0x3f58a4){_0x13c3ff(_0x2a584e,_0x3f58a4,_0x47a37e);};};Object['defineProperty'](exports,_0x50db9b(0x1fe),{'value':!![]}),exports[_0x50db9b(0x20f)]=void 0x0;const globalConfig_service_1=require(_0x50db9b(0x1d7)),status_constant_1=require(_0x50db9b(0x1e4)),typeorm_1=require(_0x50db9b(0x20e)),typeorm_2=require(_0x50db9b(0x1de)),verifycation_entity_1=require(_0x50db9b(0x1ed)),common_1=require(_0x50db9b(0x203)),utils_1=require(_0x50db9b(0x228)),redisCache_service_1=require(_0x50db9b(0x1fd)),smsSDK=require('tencentcloud-sdk-nodejs-sms'),Core=require(_0x50db9b(0x1f3)),smsClient=smsSDK[_0x50db9b(0x1f1)]['v20210111'][_0x50db9b(0x1eb)];let VerificationService=class VerificationService{constructor(_0x5ee841,_0x34c90a,_0x104ded){const _0x5b93a1=_0x50db9b;this[_0x5b93a1(0x1db)]=_0x5ee841,this[_0x5b93a1(0x206)]=_0x34c90a,this[_0x5b93a1(0x223)]=_0x104ded;}async[_0x50db9b(0x1e8)](_0x36ba1f,_0xf583f5,_0x21e502=0x1e*0x3c){const _0x9f607e=_0x50db9b,_0x20e1c9=await this[_0x9f607e(0x1db)][_0x9f607e(0x1fc)]({'where':{'userId':_0x36ba1f['id'],'type':_0xf583f5},'order':{'createdAt':'DESC'}});if(_0x20e1c9&&_0x20e1c9[_0x9f607e(0x1f5)][_0x9f607e(0x1f0)]()+0x1*0x3c*0x3e8>Date[_0x9f607e(0x226)]()){const _0x278791=Math[_0x9f607e(0x1e3)]((_0x20e1c9[_0x9f607e(0x1f5)]['getTime']()+0x1*0x3c*0x3e8-Date[_0x9f607e(0x226)]())/0x3e8);throw new common_1[(_0x9f607e(0x1ea))](_0x278791+_0x9f607e(0x219),common_1[_0x9f607e(0x220)][_0x9f607e(0x218)]);}const _0x362198=(0x0,utils_1[_0x9f607e(0x1fa)])(),_0x264908=new Date(Date[_0x9f607e(0x226)]()+_0x21e502*0x3e8),{id:_0x49f3ff,email:_0x3549be}=_0x36ba1f,_0x175f85={'userId':_0x49f3ff,'type':_0xf583f5,'code':_0x362198,'expiresAt':_0x264908,'email':_0x3549be};return await this[_0x9f607e(0x1db)][_0x9f607e(0x21a)](_0x175f85);}async[_0x50db9b(0x216)]({code:_0x3ac057,id:_0x5a8ce6},_0x1f2b56){const _0x4f1547=_0x50db9b,_0x4fc6d0=await this[_0x4f1547(0x1db)][_0x4f1547(0x1fc)]({'where':{'id':_0x5a8ce6,'type':_0x1f2b56},'order':{'createdAt':_0x4f1547(0x213)}});if(!_0x4fc6d0)throw new common_1['HttpException'](_0x4f1547(0x222),common_1['HttpStatus'][_0x4f1547(0x218)]);if(_0x4fc6d0[_0x4f1547(0x1e9)]===status_constant_1[_0x4f1547(0x21d)][_0x4f1547(0x1ec)])throw new common_1[(_0x4f1547(0x1ea))]('当前验证码已被使用！',common_1[_0x4f1547(0x220)][_0x4f1547(0x218)]);else _0x4fc6d0[_0x4f1547(0x1e9)]=status_constant_1[_0x4f1547(0x21d)][_0x4f1547(0x1ec)],await this['verifycationEntity'][_0x4f1547(0x21b)]({'id':_0x5a8ce6},_0x4fc6d0);if(Number(_0x4fc6d0[_0x4f1547(0x225)])!==Number(_0x3ac057))throw new common_1[(_0x4f1547(0x1ea))](_0x4f1547(0x1ff),common_1[_0x4f1547(0x220)][_0x4f1547(0x218)]);if(_0x4fc6d0[_0x4f1547(0x1d8)]<new Date())throw new common_1['HttpException'](_0x4f1547(0x217),common_1['HttpStatus']['BAD_REQUEST']);return _0x4fc6d0;}async[_0x50db9b(0x20a)](_0x4adcd3){const _0xea298e=_0x50db9b,{captchaId:_0x529073,captchaCode:_0x1d7b72}=_0x4adcd3,_0x319b8b=await this[_0xea298e(0x206)][_0xea298e(0x227)](),_0xee3ca6=_0x319b8b+_0xea298e(0x210)+_0x529073,_0x304477=await this[_0xea298e(0x223)][_0xea298e(0x1e7)]({'key':_0xee3ca6});await this[_0xea298e(0x223)][_0xea298e(0x205)]({'key':_0xee3ca6});if(!_0x304477)throw new common_1[(_0xea298e(0x1ea))]('图形验证码已过期、请重新输入!',common_1['HttpStatus'][_0xea298e(0x218)]);if(!_0x304477||_0x304477!==_0x1d7b72)throw new common_1[(_0xea298e(0x1ea))](_0xea298e(0x202),common_1['HttpStatus'][_0xea298e(0x218)]);}async[_0x50db9b(0x1f4)](_0x2e1fb0){const _0x36ae48=_0x50db9b;var _0x3f2d70;const {accessKeyId:_0x4a287e,accessKeySecret:_0x157064,SignName:_0x18ad9a,TemplateCode:_0x39e560}=await this['globalConfigService']['getPhoneVerifyConfig'](),{phone:_0x29344f,code:_0x14976b}=_0x2e1fb0;if(!_0x29344f||!_0x14976b)throw new common_1[(_0x36ae48(0x1ea))](_0x36ae48(0x1f8),common_1[_0x36ae48(0x220)][_0x36ae48(0x218)]);const _0x4ebd83=new Core({'accessKeyId':_0x4a287e,'accessKeySecret':_0x157064,'endpoint':_0x36ae48(0x1fb),'apiVersion':_0x36ae48(0x209)}),_0x3ee6a0={'PhoneNumbers':_0x29344f,'SignName':_0x18ad9a,'TemplateCode':_0x39e560,'TemplateParam':JSON[_0x36ae48(0x1dd)]({'code':_0x14976b})},_0xc0d987={'method':_0x36ae48(0x20b),'formatParams':![]};try{const _0x246fea=await _0x4ebd83[_0x36ae48(0x200)](_0x36ae48(0x201),_0x3ee6a0,_0xc0d987);if(_0x246fea['Code']==='OK')return!![];else throw new common_1['HttpException'](_0x246fea[_0x36ae48(0x212)]||_0x36ae48(0x1da),common_1['HttpStatus']['BAD_REQUEST']);}catch(_0x24726d){throw new common_1['HttpException'](((_0x3f2d70=_0x24726d===null||_0x24726d===void 0x0?void 0x0:_0x24726d['data'])===null||_0x3f2d70===void 0x0?void 0x0:_0x3f2d70[_0x36ae48(0x212)])||_0x36ae48(0x1da),common_1[_0x36ae48(0x220)]['BAD_REQUEST']);}}async[_0x50db9b(0x1f9)](_0x1b3cb4){const _0x4b0c3c=_0x50db9b;var _0x468b3d;const {secretId:_0x214d94,secretKey:_0x1cb096,signName:_0x2dea47,templateId:_0x3bf856,sdkAppId:_0x1f0c13}=await this[_0x4b0c3c(0x206)][_0x4b0c3c(0x1f6)](),{phone:_0xad8726,code:_0x3076f9}=_0x1b3cb4;if(!_0xad8726||!_0x3076f9)throw new common_1[(_0x4b0c3c(0x1ea))](_0x4b0c3c(0x1f8),common_1[_0x4b0c3c(0x220)][_0x4b0c3c(0x218)]);const _0x2243c2=new smsClient({'credential':{'secretId':_0x214d94,'secretKey':_0x1cb096},'region':_0x4b0c3c(0x1e5),'profile':{'httpProfile':{'endpoint':'sms.tencentcloudapi.com'}}}),_0x2e8518={'PhoneNumberSet':[_0xad8726],'SmsSdkAppId':_0x1f0c13,'TemplateId':_0x3bf856,'SignName':_0x2dea47,'TemplateParamSet':[_0x3076f9+'','2']};try{const _0x40d8ba=await _0x2243c2['SendSms'](_0x2e8518);console[_0x4b0c3c(0x21e)](_0x40d8ba);}catch(_0x374251){console[_0x4b0c3c(0x21e)](_0x4b0c3c(0x1e0),_0x374251);throw new common_1[(_0x4b0c3c(0x1ea))](((_0x468b3d=_0x374251===null||_0x374251===void 0x0?void 0x0:_0x374251['data'])===null||_0x468b3d===void 0x0?void 0x0:_0x468b3d[_0x4b0c3c(0x212)])||_0x4b0c3c(0x1da),common_1[_0x4b0c3c(0x220)]['BAD_REQUEST']);}}};VerificationService=__decorate([(0x0,common_1[_0x50db9b(0x215)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(verifycation_entity_1[_0x50db9b(0x1ef)])),__metadata(_0x50db9b(0x20d),[typeorm_2['Repository'],globalConfig_service_1['GlobalConfigService'],redisCache_service_1['RedisCacheService']])],VerificationService),exports[_0x50db9b(0x20f)]=VerificationService;