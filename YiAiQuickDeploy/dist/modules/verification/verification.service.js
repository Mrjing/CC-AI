'use strict';const _0xf7b5b5=_0x583d;(function(_0xb09d50,_0x15f9e3){const _0x40c600=_0x583d,_0x373273=_0xb09d50();while(!![]){try{const _0x33e09b=parseInt(_0x40c600(0x16f))/0x1*(-parseInt(_0x40c600(0x181))/0x2)+-parseInt(_0x40c600(0x172))/0x3*(parseInt(_0x40c600(0x18b))/0x4)+parseInt(_0x40c600(0x18e))/0x5*(-parseInt(_0x40c600(0x16e))/0x6)+parseInt(_0x40c600(0x17c))/0x7*(parseInt(_0x40c600(0x191))/0x8)+-parseInt(_0x40c600(0x17f))/0x9+-parseInt(_0x40c600(0x187))/0xa+-parseInt(_0x40c600(0x166))/0xb*(-parseInt(_0x40c600(0x1a1))/0xc);if(_0x33e09b===_0x15f9e3)break;else _0x373273['push'](_0x373273['shift']());}catch(_0x38a5d4){_0x373273['push'](_0x373273['shift']());}}}(_0x573f,0xc53fa));function _0x573f(){const _0x306ed5=['getPhoneVerifyConfig','verifycationEntity','确实必要参数错误！','Client',':CAPTCHA:','findOne','HttpStatus','stringify','../globalConfig/globalConfig.service','del','sendPhoneCode','design:paramtypes','function','71731wVrDtz','当前验证码已被使用！','VerificationService','POST','RedisCacheService','getNamespace','metadata','验证码不存在','1788414dIuDsj','41273ceuAIH','sendPhoneCodeWithQcloud','verifyCaptcha','176784wezsPy','sms.tencentcloudapi.com','getQcloudPhoneVerifyConfig','getTime','v20210111','decorate','USED','globalConfigService','expiresAt','Code','14FXwOuV','图形验证码错误、请检查填写!','__param','12149928YjTATt','length','12kevoVR','Repository','../../common/utils','createdAt','createRandomCode','__decorate','4263440yYTcRo','__metadata','BAD_REQUEST','code','12dRPYKn','redisCacheService','Injectable','25iESHeg','SendSms','验证码发送失败！','6336584fWllqB','InjectRepository','request','@nestjs/common','object','GlobalConfigService','DESC','update','sms','defineProperty','used','get','VerificationUseStatusEnum','@alicloud/pop-core','ap-beijing','./verifycation.entity','5364TbIBob','tencentcloud-sdk-nodejs-sms','log','VerifycationEntity','now','HttpException','验证码已过期','getOwnPropertyDescriptor','../redisCache/redisCache.service','verifyCode','data'];_0x573f=function(){return _0x306ed5;};return _0x573f();}var __decorate=this&&this[_0xf7b5b5(0x186)]||function(_0x58c4af,_0xa2c411,_0x1cbb4f,_0x39f311){const _0x30697a=_0xf7b5b5;var _0x17f220=arguments[_0x30697a(0x180)],_0xfc5151=_0x17f220<0x3?_0xa2c411:_0x39f311===null?_0x39f311=Object[_0x30697a(0x155)](_0xa2c411,_0x1cbb4f):_0x39f311,_0x313e87;if(typeof Reflect===_0x30697a(0x195)&&typeof Reflect[_0x30697a(0x177)]===_0x30697a(0x165))_0xfc5151=Reflect['decorate'](_0x58c4af,_0xa2c411,_0x1cbb4f,_0x39f311);else{for(var _0x5eede2=_0x58c4af['length']-0x1;_0x5eede2>=0x0;_0x5eede2--)if(_0x313e87=_0x58c4af[_0x5eede2])_0xfc5151=(_0x17f220<0x3?_0x313e87(_0xfc5151):_0x17f220>0x3?_0x313e87(_0xa2c411,_0x1cbb4f,_0xfc5151):_0x313e87(_0xa2c411,_0x1cbb4f))||_0xfc5151;}return _0x17f220>0x3&&_0xfc5151&&Object[_0x30697a(0x19a)](_0xa2c411,_0x1cbb4f,_0xfc5151),_0xfc5151;},__metadata=this&&this[_0xf7b5b5(0x188)]||function(_0x424f44,_0x3984a3){const _0x3855ff=_0xf7b5b5;if(typeof Reflect==='object'&&typeof Reflect[_0x3855ff(0x16c)]===_0x3855ff(0x165))return Reflect['metadata'](_0x424f44,_0x3984a3);},__param=this&&this[_0xf7b5b5(0x17e)]||function(_0x4eb7d8,_0x3c7b46){return function(_0x41dcdd,_0x138022){_0x3c7b46(_0x41dcdd,_0x138022,_0x4eb7d8);};};Object[_0xf7b5b5(0x19a)](exports,'__esModule',{'value':!![]}),exports[_0xf7b5b5(0x168)]=void 0x0;const globalConfig_service_1=require(_0xf7b5b5(0x161)),status_constant_1=require('../../common/constants/status.constant'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),verifycation_entity_1=require(_0xf7b5b5(0x1a0)),common_1=require(_0xf7b5b5(0x194)),utils_1=require(_0xf7b5b5(0x183)),redisCache_service_1=require(_0xf7b5b5(0x156)),smsSDK=require(_0xf7b5b5(0x14f)),Core=require(_0xf7b5b5(0x19e)),smsClient=smsSDK[_0xf7b5b5(0x199)][_0xf7b5b5(0x176)][_0xf7b5b5(0x15c)];let VerificationService=class VerificationService{constructor(_0x5fc175,_0x4a20a3,_0x4d5651){const _0x58ddb7=_0xf7b5b5;this[_0x58ddb7(0x15a)]=_0x5fc175,this['globalConfigService']=_0x4a20a3,this['redisCacheService']=_0x4d5651;}async['createVerification'](_0x6be2d2,_0x16b849,_0x3d2a10=0x1e*0x3c){const _0x26b252=_0xf7b5b5,_0x598632=await this['verifycationEntity']['findOne']({'where':{'userId':_0x6be2d2['id'],'type':_0x16b849},'order':{'createdAt':_0x26b252(0x197)}});if(_0x598632&&_0x598632[_0x26b252(0x184)][_0x26b252(0x175)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x46f858=Math['ceil']((_0x598632[_0x26b252(0x184)][_0x26b252(0x175)]()+0x1*0x3c*0x3e8-Date[_0x26b252(0x152)]())/0x3e8);throw new common_1[(_0x26b252(0x153))](_0x46f858+'S内不得重新发送',common_1[_0x26b252(0x15f)][_0x26b252(0x189)]);}const _0x2149d4=(0x0,utils_1[_0x26b252(0x185)])(),_0x54ef31=new Date(Date['now']()+_0x3d2a10*0x3e8),{id:_0xc5ccf8,email:_0x95833f}=_0x6be2d2,_0x3d66c4={'userId':_0xc5ccf8,'type':_0x16b849,'code':_0x2149d4,'expiresAt':_0x54ef31,'email':_0x95833f};return await this['verifycationEntity']['save'](_0x3d66c4);}async[_0xf7b5b5(0x157)]({code:_0x2d3903,id:_0x1400f8},_0x2a8fb7){const _0x1679fd=_0xf7b5b5,_0x186ebf=await this[_0x1679fd(0x15a)][_0x1679fd(0x15e)]({'where':{'id':_0x1400f8,'type':_0x2a8fb7},'order':{'createdAt':_0x1679fd(0x197)}});if(!_0x186ebf)throw new common_1[(_0x1679fd(0x153))](_0x1679fd(0x16d),common_1[_0x1679fd(0x15f)][_0x1679fd(0x189)]);if(_0x186ebf[_0x1679fd(0x19b)]===status_constant_1[_0x1679fd(0x19d)]['USED'])throw new common_1[(_0x1679fd(0x153))](_0x1679fd(0x167),common_1[_0x1679fd(0x15f)][_0x1679fd(0x189)]);else _0x186ebf[_0x1679fd(0x19b)]=status_constant_1['VerificationUseStatusEnum'][_0x1679fd(0x178)],await this[_0x1679fd(0x15a)][_0x1679fd(0x198)]({'id':_0x1400f8},_0x186ebf);if(Number(_0x186ebf[_0x1679fd(0x18a)])!==Number(_0x2d3903))throw new common_1[(_0x1679fd(0x153))]('验证码错误',common_1[_0x1679fd(0x15f)][_0x1679fd(0x189)]);if(_0x186ebf[_0x1679fd(0x17a)]<new Date())throw new common_1[(_0x1679fd(0x153))](_0x1679fd(0x154),common_1[_0x1679fd(0x15f)][_0x1679fd(0x189)]);return _0x186ebf;}async[_0xf7b5b5(0x171)](_0x2eb210){const _0x2c287a=_0xf7b5b5,{captchaId:_0x221a43,captchaCode:_0x3d67b2}=_0x2eb210,_0x14f871=await this['globalConfigService'][_0x2c287a(0x16b)](),_0x4b23f9=_0x14f871+_0x2c287a(0x15d)+_0x221a43,_0x1ca0ed=await this['redisCacheService'][_0x2c287a(0x19c)]({'key':_0x4b23f9});await this[_0x2c287a(0x18c)][_0x2c287a(0x162)]({'key':_0x4b23f9});if(!_0x1ca0ed)throw new common_1[(_0x2c287a(0x153))]('图形验证码已过期、请重新输入!',common_1[_0x2c287a(0x15f)]['BAD_REQUEST']);if(!_0x1ca0ed||_0x1ca0ed!==_0x3d67b2)throw new common_1[(_0x2c287a(0x153))](_0x2c287a(0x17d),common_1['HttpStatus']['BAD_REQUEST']);}async[_0xf7b5b5(0x163)](_0x1f163f){const _0x58391b=_0xf7b5b5;var _0x1a579f;const {accessKeyId:_0xb6144d,accessKeySecret:_0x17202e,SignName:_0x5a3c40,TemplateCode:_0x4cce39}=await this[_0x58391b(0x179)][_0x58391b(0x159)](),{phone:_0x417990,code:_0x5bc293}=_0x1f163f;if(!_0x417990||!_0x5bc293)throw new common_1['HttpException'](_0x58391b(0x15b),common_1[_0x58391b(0x15f)][_0x58391b(0x189)]);const _0x55bc56=new Core({'accessKeyId':_0xb6144d,'accessKeySecret':_0x17202e,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':'2017-05-25'}),_0x5482b5={'PhoneNumbers':_0x417990,'SignName':_0x5a3c40,'TemplateCode':_0x4cce39,'TemplateParam':JSON[_0x58391b(0x160)]({'code':_0x5bc293})},_0x1aed86={'method':_0x58391b(0x169),'formatParams':![]};try{const _0x37cf85=await _0x55bc56[_0x58391b(0x193)]('SendSms',_0x5482b5,_0x1aed86);if(_0x37cf85[_0x58391b(0x17b)]==='OK')return!![];else throw new common_1[(_0x58391b(0x153))](_0x37cf85['Message']||_0x58391b(0x190),common_1[_0x58391b(0x15f)][_0x58391b(0x189)]);}catch(_0x1262a2){throw new common_1['HttpException'](((_0x1a579f=_0x1262a2===null||_0x1262a2===void 0x0?void 0x0:_0x1262a2[_0x58391b(0x158)])===null||_0x1a579f===void 0x0?void 0x0:_0x1a579f['Message'])||_0x58391b(0x190),common_1['HttpStatus'][_0x58391b(0x189)]);}}async[_0xf7b5b5(0x170)](_0x12ee42){const _0x17b844=_0xf7b5b5;var _0x7a6b86;const {secretId:_0x34718e,secretKey:_0x47cded,signName:_0x4bd0cd,templateId:_0x4f6c3d,sdkAppId:_0x2c29c7}=await this[_0x17b844(0x179)][_0x17b844(0x174)](),{phone:_0x2836fb,code:_0x185341}=_0x12ee42;if(!_0x2836fb||!_0x185341)throw new common_1[(_0x17b844(0x153))]('确实必要参数错误！',common_1['HttpStatus'][_0x17b844(0x189)]);const _0x537445=new smsClient({'credential':{'secretId':_0x34718e,'secretKey':_0x47cded},'region':_0x17b844(0x19f),'profile':{'httpProfile':{'endpoint':_0x17b844(0x173)}}}),_0x4a40dc={'PhoneNumberSet':[_0x2836fb],'SmsSdkAppId':_0x2c29c7,'TemplateId':_0x4f6c3d,'SignName':_0x4bd0cd,'TemplateParamSet':[_0x185341+'','2']};try{const _0x4d265f=await _0x537445[_0x17b844(0x18f)](_0x4a40dc);console[_0x17b844(0x150)](_0x4d265f);}catch(_0x5b6b36){console[_0x17b844(0x150)]('error',_0x5b6b36);throw new common_1[(_0x17b844(0x153))](((_0x7a6b86=_0x5b6b36===null||_0x5b6b36===void 0x0?void 0x0:_0x5b6b36['data'])===null||_0x7a6b86===void 0x0?void 0x0:_0x7a6b86['Message'])||_0x17b844(0x190),common_1[_0x17b844(0x15f)][_0x17b844(0x189)]);}}};function _0x583d(_0x340451,_0x5aa9ac){const _0x573ff1=_0x573f();return _0x583d=function(_0x583d17,_0x5619fc){_0x583d17=_0x583d17-0x14f;let _0x9cbc46=_0x573ff1[_0x583d17];return _0x9cbc46;},_0x583d(_0x340451,_0x5aa9ac);}VerificationService=__decorate([(0x0,common_1[_0xf7b5b5(0x18d)])(),__param(0x0,(0x0,typeorm_1[_0xf7b5b5(0x192)])(verifycation_entity_1[_0xf7b5b5(0x151)])),__metadata(_0xf7b5b5(0x164),[typeorm_2[_0xf7b5b5(0x182)],globalConfig_service_1[_0xf7b5b5(0x196)],redisCache_service_1[_0xf7b5b5(0x16a)]])],VerificationService),exports[_0xf7b5b5(0x168)]=VerificationService;