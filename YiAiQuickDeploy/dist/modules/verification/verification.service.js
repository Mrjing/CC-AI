'use strict';function _0x5663(){const _0x42db7e=['VerificationUseStatusEnum','1354932bxpmjf','request','del','__decorate','Repository','sms','decorate','图形验证码错误、请检查填写!','11886399AKNflK','globalConfigService','redisCacheService','RedisCacheService','stringify',':CAPTCHA:','2017-05-25','log','findOne','SendSms','data','update','160525ByVVmC','length','v20210111','getTime','GlobalConfigService','../../common/utils','verifyCode','BAD_REQUEST','error','Code','VerificationService','createdAt','metadata','1011162xBBuIc','验证码发送失败！','getOwnPropertyDescriptor','验证码错误','ceil','Client','../../common/constants/status.constant','tencentcloud-sdk-nodejs-sms','246jrEpPP','typeorm','defineProperty','VerifycationEntity','6021000luDMay','now','当前验证码已被使用！','../globalConfig/globalConfig.service','code','HttpStatus','sms.tencentcloudapi.com','DESC','https://dysmsapi.aliyuncs.com','function','sendPhoneCode','25604550jzeCZT','InjectRepository','createVerification','verifyCaptcha','__metadata','Injectable','4226052YSqlyE','design:paramtypes','object','@alicloud/pop-core','sendPhoneCodeWithQcloud','8gGlyOD','get','verifycationEntity','验证码已过期','确实必要参数错误！','HttpException','USED','Message'];_0x5663=function(){return _0x42db7e;};return _0x5663();}const _0x1b53d8=_0x153a;(function(_0x1304ab,_0x125585){const _0x334eb3=_0x153a,_0x5ae8b4=_0x1304ab();while(!![]){try{const _0x58a9c9=-parseInt(_0x334eb3(0x135))/0x1+-parseInt(_0x334eb3(0x10a))/0x2+parseInt(_0x334eb3(0x127))/0x3+parseInt(_0x334eb3(0x116))/0x4+parseInt(_0x334eb3(0x149))/0x5*(-parseInt(_0x334eb3(0x112))/0x6)+-parseInt(_0x334eb3(0x13d))/0x7+parseInt(_0x334eb3(0x12c))/0x8*(parseInt(_0x334eb3(0x121))/0x9);if(_0x58a9c9===_0x125585)break;else _0x5ae8b4['push'](_0x5ae8b4['shift']());}catch(_0x3e8346){_0x5ae8b4['push'](_0x5ae8b4['shift']());}}}(_0x5663,0xd7d29));function _0x153a(_0x21f15b,_0x590571){const _0x56633a=_0x5663();return _0x153a=function(_0x153a92,_0x1d6c9e){_0x153a92=_0x153a92-0x101;let _0x5ab101=_0x56633a[_0x153a92];return _0x5ab101;},_0x153a(_0x21f15b,_0x590571);}var __decorate=this&&this[_0x1b53d8(0x138)]||function(_0x2374e0,_0xc6f37d,_0x419979,_0x2e59a2){const _0x247c73=_0x1b53d8;var _0x439f43=arguments[_0x247c73(0x14a)],_0x46ea4d=_0x439f43<0x3?_0xc6f37d:_0x2e59a2===null?_0x2e59a2=Object[_0x247c73(0x10c)](_0xc6f37d,_0x419979):_0x2e59a2,_0x4e1102;if(typeof Reflect===_0x247c73(0x129)&&typeof Reflect[_0x247c73(0x13b)]===_0x247c73(0x11f))_0x46ea4d=Reflect[_0x247c73(0x13b)](_0x2374e0,_0xc6f37d,_0x419979,_0x2e59a2);else{for(var _0x56efd6=_0x2374e0[_0x247c73(0x14a)]-0x1;_0x56efd6>=0x0;_0x56efd6--)if(_0x4e1102=_0x2374e0[_0x56efd6])_0x46ea4d=(_0x439f43<0x3?_0x4e1102(_0x46ea4d):_0x439f43>0x3?_0x4e1102(_0xc6f37d,_0x419979,_0x46ea4d):_0x4e1102(_0xc6f37d,_0x419979))||_0x46ea4d;}return _0x439f43>0x3&&_0x46ea4d&&Object[_0x247c73(0x114)](_0xc6f37d,_0x419979,_0x46ea4d),_0x46ea4d;},__metadata=this&&this[_0x1b53d8(0x125)]||function(_0x46aed7,_0x12bf20){const _0x14da10=_0x1b53d8;if(typeof Reflect===_0x14da10(0x129)&&typeof Reflect[_0x14da10(0x109)]==='function')return Reflect['metadata'](_0x46aed7,_0x12bf20);},__param=this&&this['__param']||function(_0xf1733a,_0x3500c3){return function(_0x190ad5,_0x41682d){_0x3500c3(_0x190ad5,_0x41682d,_0xf1733a);};};Object[_0x1b53d8(0x114)](exports,'__esModule',{'value':!![]}),exports[_0x1b53d8(0x107)]=void 0x0;const globalConfig_service_1=require(_0x1b53d8(0x119)),status_constant_1=require(_0x1b53d8(0x110)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x1b53d8(0x113)),verifycation_entity_1=require('./verifycation.entity'),common_1=require('@nestjs/common'),utils_1=require(_0x1b53d8(0x102)),redisCache_service_1=require('../redisCache/redisCache.service'),smsSDK=require(_0x1b53d8(0x111)),Core=require(_0x1b53d8(0x12a)),smsClient=smsSDK[_0x1b53d8(0x13a)][_0x1b53d8(0x14b)][_0x1b53d8(0x10f)];let VerificationService=class VerificationService{constructor(_0xf32555,_0x541034,_0x413784){const _0x4ae4e5=_0x1b53d8;this[_0x4ae4e5(0x12e)]=_0xf32555,this[_0x4ae4e5(0x13e)]=_0x541034,this['redisCacheService']=_0x413784;}async[_0x1b53d8(0x123)](_0x736c5d,_0x4e18f3,_0x4e2053=0x1e*0x3c){const _0x4efc15=_0x1b53d8,_0x5f5916=await this[_0x4efc15(0x12e)][_0x4efc15(0x145)]({'where':{'userId':_0x736c5d['id'],'type':_0x4e18f3},'order':{'createdAt':_0x4efc15(0x11d)}});if(_0x5f5916&&_0x5f5916[_0x4efc15(0x108)][_0x4efc15(0x14c)]()+0x1*0x3c*0x3e8>Date[_0x4efc15(0x117)]()){const _0x4a2875=Math[_0x4efc15(0x10e)]((_0x5f5916[_0x4efc15(0x108)][_0x4efc15(0x14c)]()+0x1*0x3c*0x3e8-Date[_0x4efc15(0x117)]())/0x3e8);throw new common_1[(_0x4efc15(0x131))](_0x4a2875+'S内不得重新发送',common_1[_0x4efc15(0x11b)][_0x4efc15(0x104)]);}const _0x9794fe=(0x0,utils_1['createRandomCode'])(),_0x55434a=new Date(Date[_0x4efc15(0x117)]()+_0x4e2053*0x3e8),{id:_0x36abf1,email:_0x351f39}=_0x736c5d,_0x5ddaa1={'userId':_0x36abf1,'type':_0x4e18f3,'code':_0x9794fe,'expiresAt':_0x55434a,'email':_0x351f39};return await this['verifycationEntity']['save'](_0x5ddaa1);}async[_0x1b53d8(0x103)]({code:_0xf9e2cb,id:_0x5e3d40},_0x1ab9c1){const _0x3a3916=_0x1b53d8,_0x38e2c3=await this[_0x3a3916(0x12e)]['findOne']({'where':{'id':_0x5e3d40,'type':_0x1ab9c1},'order':{'createdAt':_0x3a3916(0x11d)}});if(!_0x38e2c3)throw new common_1[(_0x3a3916(0x131))]('验证码不存在',common_1[_0x3a3916(0x11b)][_0x3a3916(0x104)]);if(_0x38e2c3['used']===status_constant_1[_0x3a3916(0x134)][_0x3a3916(0x132)])throw new common_1[(_0x3a3916(0x131))](_0x3a3916(0x118),common_1['HttpStatus'][_0x3a3916(0x104)]);else _0x38e2c3['used']=status_constant_1[_0x3a3916(0x134)][_0x3a3916(0x132)],await this['verifycationEntity'][_0x3a3916(0x148)]({'id':_0x5e3d40},_0x38e2c3);if(Number(_0x38e2c3[_0x3a3916(0x11a)])!==Number(_0xf9e2cb))throw new common_1[(_0x3a3916(0x131))](_0x3a3916(0x10d),common_1[_0x3a3916(0x11b)][_0x3a3916(0x104)]);if(_0x38e2c3['expiresAt']<new Date())throw new common_1[(_0x3a3916(0x131))](_0x3a3916(0x12f),common_1['HttpStatus'][_0x3a3916(0x104)]);return _0x38e2c3;}async[_0x1b53d8(0x124)](_0xf60d82){const _0x3dd39b=_0x1b53d8,{captchaId:_0x57902e,captchaCode:_0x1f84be}=_0xf60d82,_0x4ccf90=await this[_0x3dd39b(0x13e)]['getNamespace'](),_0x49ee27=_0x4ccf90+_0x3dd39b(0x142)+_0x57902e,_0x5530f9=await this[_0x3dd39b(0x13f)][_0x3dd39b(0x12d)]({'key':_0x49ee27});await this['redisCacheService'][_0x3dd39b(0x137)]({'key':_0x49ee27});if(!_0x5530f9)throw new common_1[(_0x3dd39b(0x131))]('图形验证码已过期、请重新输入!',common_1[_0x3dd39b(0x11b)]['BAD_REQUEST']);if(!_0x5530f9||_0x5530f9!==_0x1f84be)throw new common_1[(_0x3dd39b(0x131))](_0x3dd39b(0x13c),common_1[_0x3dd39b(0x11b)][_0x3dd39b(0x104)]);}async[_0x1b53d8(0x120)](_0x3a25e5){const _0x114ec3=_0x1b53d8;var _0x2540a2;const {accessKeyId:_0x5b1016,accessKeySecret:_0x17b9ca,SignName:_0x94ea8,TemplateCode:_0xc62d12}=await this['globalConfigService']['getPhoneVerifyConfig'](),{phone:_0x2d3a8a,code:_0x58cf60}=_0x3a25e5;if(!_0x2d3a8a||!_0x58cf60)throw new common_1['HttpException'](_0x114ec3(0x130),common_1['HttpStatus'][_0x114ec3(0x104)]);const _0x3b5504=new Core({'accessKeyId':_0x5b1016,'accessKeySecret':_0x17b9ca,'endpoint':_0x114ec3(0x11e),'apiVersion':_0x114ec3(0x143)}),_0x46e7ef={'PhoneNumbers':_0x2d3a8a,'SignName':_0x94ea8,'TemplateCode':_0xc62d12,'TemplateParam':JSON[_0x114ec3(0x141)]({'code':_0x58cf60})},_0x4cebf1={'method':'POST','formatParams':![]};try{const _0x35ce48=await _0x3b5504[_0x114ec3(0x136)]('SendSms',_0x46e7ef,_0x4cebf1);if(_0x35ce48[_0x114ec3(0x106)]==='OK')return!![];else throw new common_1[(_0x114ec3(0x131))](_0x35ce48[_0x114ec3(0x133)]||'验证码发送失败！',common_1[_0x114ec3(0x11b)][_0x114ec3(0x104)]);}catch(_0x2e5514){throw new common_1[(_0x114ec3(0x131))](((_0x2540a2=_0x2e5514===null||_0x2e5514===void 0x0?void 0x0:_0x2e5514[_0x114ec3(0x147)])===null||_0x2540a2===void 0x0?void 0x0:_0x2540a2['Message'])||_0x114ec3(0x10b),common_1[_0x114ec3(0x11b)][_0x114ec3(0x104)]);}}async[_0x1b53d8(0x12b)](_0xdc01fa){const _0x1afc2d=_0x1b53d8;var _0x410974;const {secretId:_0x21ef4d,secretKey:_0x232162,signName:_0x42904a,templateId:_0x5035cc,sdkAppId:_0x310c5b}=await this[_0x1afc2d(0x13e)]['getQcloudPhoneVerifyConfig'](),{phone:_0xa43c6d,code:_0x209aa7}=_0xdc01fa;if(!_0xa43c6d||!_0x209aa7)throw new common_1[(_0x1afc2d(0x131))](_0x1afc2d(0x130),common_1[_0x1afc2d(0x11b)][_0x1afc2d(0x104)]);const _0x5b4456=new smsClient({'credential':{'secretId':_0x21ef4d,'secretKey':_0x232162},'region':'ap-beijing','profile':{'httpProfile':{'endpoint':_0x1afc2d(0x11c)}}}),_0x35be32={'PhoneNumberSet':[_0xa43c6d],'SmsSdkAppId':_0x310c5b,'TemplateId':_0x5035cc,'SignName':_0x42904a,'TemplateParamSet':[_0x209aa7+'','2']};try{const _0x500545=await _0x5b4456[_0x1afc2d(0x146)](_0x35be32);console['log'](_0x500545);}catch(_0x3e075d){console[_0x1afc2d(0x144)](_0x1afc2d(0x105),_0x3e075d);throw new common_1['HttpException'](((_0x410974=_0x3e075d===null||_0x3e075d===void 0x0?void 0x0:_0x3e075d[_0x1afc2d(0x147)])===null||_0x410974===void 0x0?void 0x0:_0x410974['Message'])||_0x1afc2d(0x10b),common_1[_0x1afc2d(0x11b)][_0x1afc2d(0x104)]);}}};VerificationService=__decorate([(0x0,common_1[_0x1b53d8(0x126)])(),__param(0x0,(0x0,typeorm_1[_0x1b53d8(0x122)])(verifycation_entity_1[_0x1b53d8(0x115)])),__metadata(_0x1b53d8(0x128),[typeorm_2[_0x1b53d8(0x139)],globalConfig_service_1[_0x1b53d8(0x101)],redisCache_service_1[_0x1b53d8(0x140)]])],VerificationService),exports['VerificationService']=VerificationService;