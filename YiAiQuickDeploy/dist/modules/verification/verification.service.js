'use strict';const _0x5eb2f7=_0x419d;function _0x419d(_0x4aa3f3,_0x184328){const _0x440eed=_0x440e();return _0x419d=function(_0x419d84,_0x476c61){_0x419d84=_0x419d84-0x128;let _0x4e55de=_0x440eed[_0x419d84];return _0x4e55de;},_0x419d(_0x4aa3f3,_0x184328);}(function(_0x208ea0,_0x51816a){const _0x4b2347=_0x419d,_0x4d8fb0=_0x208ea0();while(!![]){try{const _0x12d834=-parseInt(_0x4b2347(0x15b))/0x1*(parseInt(_0x4b2347(0x13e))/0x2)+parseInt(_0x4b2347(0x13f))/0x3*(-parseInt(_0x4b2347(0x133))/0x4)+parseInt(_0x4b2347(0x12e))/0x5*(parseInt(_0x4b2347(0x12c))/0x6)+-parseInt(_0x4b2347(0x137))/0x7*(-parseInt(_0x4b2347(0x136))/0x8)+parseInt(_0x4b2347(0x16e))/0x9*(parseInt(_0x4b2347(0x16d))/0xa)+parseInt(_0x4b2347(0x128))/0xb*(-parseInt(_0x4b2347(0x160))/0xc)+parseInt(_0x4b2347(0x139))/0xd;if(_0x12d834===_0x51816a)break;else _0x4d8fb0['push'](_0x4d8fb0['shift']());}catch(_0x235190){_0x4d8fb0['push'](_0x4d8fb0['shift']());}}}(_0x440e,0x79924));var __decorate=this&&this[_0x5eb2f7(0x153)]||function(_0xea6ee0,_0x4d7cb9,_0x5c9574,_0x3a3379){const _0x1759a6=_0x5eb2f7;var _0x445f79=arguments['length'],_0x3477b7=_0x445f79<0x3?_0x4d7cb9:_0x3a3379===null?_0x3a3379=Object[_0x1759a6(0x168)](_0x4d7cb9,_0x5c9574):_0x3a3379,_0x3c2731;if(typeof Reflect===_0x1759a6(0x173)&&typeof Reflect['decorate']===_0x1759a6(0x169))_0x3477b7=Reflect[_0x1759a6(0x15d)](_0xea6ee0,_0x4d7cb9,_0x5c9574,_0x3a3379);else{for(var _0x9767e9=_0xea6ee0[_0x1759a6(0x145)]-0x1;_0x9767e9>=0x0;_0x9767e9--)if(_0x3c2731=_0xea6ee0[_0x9767e9])_0x3477b7=(_0x445f79<0x3?_0x3c2731(_0x3477b7):_0x445f79>0x3?_0x3c2731(_0x4d7cb9,_0x5c9574,_0x3477b7):_0x3c2731(_0x4d7cb9,_0x5c9574))||_0x3477b7;}return _0x445f79>0x3&&_0x3477b7&&Object['defineProperty'](_0x4d7cb9,_0x5c9574,_0x3477b7),_0x3477b7;},__metadata=this&&this[_0x5eb2f7(0x14a)]||function(_0x3ed562,_0x49a5a2){const _0x4f576c=_0x5eb2f7;if(typeof Reflect===_0x4f576c(0x173)&&typeof Reflect[_0x4f576c(0x16b)]===_0x4f576c(0x169))return Reflect[_0x4f576c(0x16b)](_0x3ed562,_0x49a5a2);},__param=this&&this['__param']||function(_0x294c2a,_0x583976){return function(_0x3892f4,_0x2bc528){_0x583976(_0x3892f4,_0x2bc528,_0x294c2a);};};Object[_0x5eb2f7(0x14f)](exports,_0x5eb2f7(0x164),{'value':!![]}),exports['VerificationService']=void 0x0;const globalConfig_service_1=require(_0x5eb2f7(0x162)),status_constant_1=require('../../common/constants/status.constant'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x5eb2f7(0x161)),verifycation_entity_1=require('./verifycation.entity'),common_1=require(_0x5eb2f7(0x149)),utils_1=require('../../common/utils'),redisCache_service_1=require(_0x5eb2f7(0x171)),smsSDK=require(_0x5eb2f7(0x15f)),Core=require('@alicloud/pop-core'),smsClient=smsSDK['sms']['v20210111'][_0x5eb2f7(0x14e)];let VerificationService=class VerificationService{constructor(_0x2184c7,_0x3045f9,_0x4ba672){const _0xc562ce=_0x5eb2f7;this[_0xc562ce(0x14c)]=_0x2184c7,this['globalConfigService']=_0x3045f9,this['redisCacheService']=_0x4ba672;}async[_0x5eb2f7(0x148)](_0x7f5ebc,_0x54207d,_0x4f4d2c=0x1e*0x3c){const _0x58e1a3=_0x5eb2f7,_0x1dfa06=await this[_0x58e1a3(0x14c)][_0x58e1a3(0x174)]({'where':{'userId':_0x7f5ebc['id'],'type':_0x54207d},'order':{'createdAt':_0x58e1a3(0x154)}});if(_0x1dfa06&&_0x1dfa06[_0x58e1a3(0x129)][_0x58e1a3(0x155)]()+0x1*0x3c*0x3e8>Date[_0x58e1a3(0x12a)]()){const _0x125ad3=Math[_0x58e1a3(0x159)]((_0x1dfa06[_0x58e1a3(0x129)]['getTime']()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1[(_0x58e1a3(0x152))](_0x125ad3+'S内不得重新发送',common_1[_0x58e1a3(0x150)][_0x58e1a3(0x158)]);}const _0x93faf3=(0x0,utils_1[_0x58e1a3(0x15e)])(),_0x3eb1dc=new Date(Date['now']()+_0x4f4d2c*0x3e8),{id:_0x25fcc4,email:_0x2629cc}=_0x7f5ebc,_0x11dd0e={'userId':_0x25fcc4,'type':_0x54207d,'code':_0x93faf3,'expiresAt':_0x3eb1dc,'email':_0x2629cc};return await this[_0x58e1a3(0x14c)][_0x58e1a3(0x147)](_0x11dd0e);}async[_0x5eb2f7(0x140)]({code:_0x4f9a97,id:_0x1dd046},_0x84efab){const _0x1d7f93=_0x5eb2f7,_0x33a8f2=await this[_0x1d7f93(0x14c)][_0x1d7f93(0x174)]({'where':{'id':_0x1dd046,'type':_0x84efab},'order':{'createdAt':_0x1d7f93(0x154)}});if(!_0x33a8f2)throw new common_1['HttpException'](_0x1d7f93(0x165),common_1[_0x1d7f93(0x150)][_0x1d7f93(0x158)]);if(_0x33a8f2[_0x1d7f93(0x167)]===status_constant_1['VerificationUseStatusEnum'][_0x1d7f93(0x156)])throw new common_1[(_0x1d7f93(0x152))]('当前验证码已被使用！',common_1[_0x1d7f93(0x150)][_0x1d7f93(0x158)]);else _0x33a8f2['used']=status_constant_1[_0x1d7f93(0x130)]['USED'],await this[_0x1d7f93(0x14c)][_0x1d7f93(0x12b)]({'id':_0x1dd046},_0x33a8f2);if(Number(_0x33a8f2[_0x1d7f93(0x15a)])!==Number(_0x4f9a97))throw new common_1[(_0x1d7f93(0x152))](_0x1d7f93(0x13a),common_1[_0x1d7f93(0x150)][_0x1d7f93(0x158)]);if(_0x33a8f2[_0x1d7f93(0x170)]<new Date())throw new common_1['HttpException'](_0x1d7f93(0x14b),common_1['HttpStatus'][_0x1d7f93(0x158)]);return _0x33a8f2;}async['verifyCaptcha'](_0x4bbc5d){const _0x5014fb=_0x5eb2f7,{captchaId:_0x35f2e5,captchaCode:_0x229739}=_0x4bbc5d,_0x213139=await this[_0x5014fb(0x144)][_0x5014fb(0x146)](),_0x1dff69=_0x213139+':CAPTCHA:'+_0x35f2e5,_0x3c649b=await this['redisCacheService'][_0x5014fb(0x157)]({'key':_0x1dff69});await this['redisCacheService'][_0x5014fb(0x172)]({'key':_0x1dff69});if(!_0x3c649b)throw new common_1[(_0x5014fb(0x152))](_0x5014fb(0x16a),common_1['HttpStatus'][_0x5014fb(0x158)]);if(!_0x3c649b||_0x3c649b!==_0x229739)throw new common_1[(_0x5014fb(0x152))](_0x5014fb(0x12f),common_1['HttpStatus'][_0x5014fb(0x158)]);}async[_0x5eb2f7(0x15c)](_0x185685){const _0x27d0bf=_0x5eb2f7;var _0x3f1f90;const {accessKeyId:_0x20ff53,accessKeySecret:_0x1eb681,SignName:_0x113537,TemplateCode:_0x28e540}=await this[_0x27d0bf(0x144)]['getPhoneVerifyConfig'](),{phone:_0x20cd73,code:_0x5846ba}=_0x185685;if(!_0x20cd73||!_0x5846ba)throw new common_1[(_0x27d0bf(0x152))]('确实必要参数错误！',common_1[_0x27d0bf(0x150)][_0x27d0bf(0x158)]);const _0x363b29=new Core({'accessKeyId':_0x20ff53,'accessKeySecret':_0x1eb681,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0x27d0bf(0x163)}),_0x5a090c={'PhoneNumbers':_0x20cd73,'SignName':_0x113537,'TemplateCode':_0x28e540,'TemplateParam':JSON[_0x27d0bf(0x142)]({'code':_0x5846ba})},_0x40b327={'method':_0x27d0bf(0x132),'formatParams':![]};try{const _0x3d793a=await _0x363b29[_0x27d0bf(0x138)](_0x27d0bf(0x166),_0x5a090c,_0x40b327);if(_0x3d793a[_0x27d0bf(0x141)]==='OK')return!![];else throw new common_1[(_0x27d0bf(0x152))](_0x3d793a['Message']||_0x27d0bf(0x14d),common_1[_0x27d0bf(0x150)][_0x27d0bf(0x158)]);}catch(_0x3b0764){throw new common_1['HttpException'](((_0x3f1f90=_0x3b0764===null||_0x3b0764===void 0x0?void 0x0:_0x3b0764[_0x27d0bf(0x131)])===null||_0x3f1f90===void 0x0?void 0x0:_0x3f1f90['Message'])||_0x27d0bf(0x14d),common_1['HttpStatus'][_0x27d0bf(0x158)]);}}async['sendPhoneCodeWithQcloud'](_0x17dc4e){const _0x4d4f09=_0x5eb2f7;var _0x23f6e0;const {secretId:_0x26e83d,secretKey:_0x1a00cc,signName:_0x108afa,templateId:_0x472702,sdkAppId:_0x2e00c9}=await this[_0x4d4f09(0x144)]['getQcloudPhoneVerifyConfig'](),{phone:_0x1b2db1,code:_0x33bf80}=_0x17dc4e;if(!_0x1b2db1||!_0x33bf80)throw new common_1['HttpException'](_0x4d4f09(0x134),common_1[_0x4d4f09(0x150)][_0x4d4f09(0x158)]);const _0x18ead8=new smsClient({'credential':{'secretId':_0x26e83d,'secretKey':_0x1a00cc},'region':_0x4d4f09(0x12d),'profile':{'httpProfile':{'endpoint':_0x4d4f09(0x151)}}}),_0x446293={'PhoneNumberSet':[_0x1b2db1],'SmsSdkAppId':_0x2e00c9,'TemplateId':_0x472702,'SignName':_0x108afa,'TemplateParamSet':[_0x33bf80+'','2']};try{const _0x398f51=await _0x18ead8[_0x4d4f09(0x166)](_0x446293);console[_0x4d4f09(0x16f)](_0x4d4f09(0x135),_0x398f51);}catch(_0x32e11c){console['log']('error',_0x32e11c);throw new common_1[(_0x4d4f09(0x152))](((_0x23f6e0=_0x32e11c===null||_0x32e11c===void 0x0?void 0x0:_0x32e11c[_0x4d4f09(0x131)])===null||_0x23f6e0===void 0x0?void 0x0:_0x23f6e0[_0x4d4f09(0x13b)])||_0x4d4f09(0x14d),common_1[_0x4d4f09(0x150)][_0x4d4f09(0x158)]);}}};function _0x440e(){const _0x4d803b=['VerificationUseStatusEnum','data','POST','666856JFtuks','确实必要参数错误！','sendsms','40jOpxCR','554309igLKac','request','7381218WJAaNj','验证码错误','Message','InjectRepository','GlobalConfigService','2Okfzzc','6GkDJeX','verifyCode','Code','stringify','RedisCacheService','globalConfigService','length','getNamespace','save','createVerification','@nestjs/common','__metadata','验证码已过期','verifycationEntity','验证码发送失败！','Client','defineProperty','HttpStatus','sms.tencentcloudapi.com','HttpException','__decorate','DESC','getTime','USED','get','BAD_REQUEST','ceil','code','875504YrFZzV','sendPhoneCode','decorate','createRandomCode','tencentcloud-sdk-nodejs-sms','444EKikkz','typeorm','../globalConfig/globalConfig.service','2017-05-25','__esModule','验证码不存在','SendSms','used','getOwnPropertyDescriptor','function','图形验证码已过期、请重新输入!','metadata','VerificationService','80TYYotg','451332zLAvRB','log','expiresAt','../redisCache/redisCache.service','del','object','findOne','184349PjWNWb','createdAt','now','update','6vZIbHx','ap-beijing','4810330DCfJxL','图形验证码错误、请检查填写!'];_0x440e=function(){return _0x4d803b;};return _0x440e();}VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x5eb2f7(0x13c)])(verifycation_entity_1['VerifycationEntity'])),__metadata('design:paramtypes',[typeorm_2['Repository'],globalConfig_service_1[_0x5eb2f7(0x13d)],redisCache_service_1[_0x5eb2f7(0x143)]])],VerificationService),exports[_0x5eb2f7(0x16c)]=VerificationService;