'use strict';const _0x282dcf=_0x17bd;(function(_0x757ac5,_0x522b77){const _0x128504=_0x17bd,_0xa3b3bf=_0x757ac5();while(!![]){try{const _0x5995c4=parseInt(_0x128504(0xe5))/0x1+parseInt(_0x128504(0xb9))/0x2+parseInt(_0x128504(0xdd))/0x3*(parseInt(_0x128504(0xb6))/0x4)+-parseInt(_0x128504(0xb4))/0x5*(-parseInt(_0x128504(0xe9))/0x6)+-parseInt(_0x128504(0xcf))/0x7*(parseInt(_0x128504(0xd4))/0x8)+parseInt(_0x128504(0xc0))/0x9+-parseInt(_0x128504(0xd0))/0xa;if(_0x5995c4===_0x522b77)break;else _0xa3b3bf['push'](_0xa3b3bf['shift']());}catch(_0x28434b){_0xa3b3bf['push'](_0xa3b3bf['shift']());}}}(_0x7cec,0x2e018));var __decorate=this&&this[_0x282dcf(0xd2)]||function(_0x17eeb0,_0x46d288,_0x556101,_0x205385){const _0x326330=_0x282dcf;var _0x1dd949=arguments[_0x326330(0xd6)],_0x442c92=_0x1dd949<0x3?_0x46d288:_0x205385===null?_0x205385=Object['getOwnPropertyDescriptor'](_0x46d288,_0x556101):_0x205385,_0x3e75e5;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x326330(0xbe))_0x442c92=Reflect[_0x326330(0xd9)](_0x17eeb0,_0x46d288,_0x556101,_0x205385);else{for(var _0x3ab020=_0x17eeb0['length']-0x1;_0x3ab020>=0x0;_0x3ab020--)if(_0x3e75e5=_0x17eeb0[_0x3ab020])_0x442c92=(_0x1dd949<0x3?_0x3e75e5(_0x442c92):_0x1dd949>0x3?_0x3e75e5(_0x46d288,_0x556101,_0x442c92):_0x3e75e5(_0x46d288,_0x556101))||_0x442c92;}return _0x1dd949>0x3&&_0x442c92&&Object[_0x326330(0xed)](_0x46d288,_0x556101,_0x442c92),_0x442c92;},__metadata=this&&this[_0x282dcf(0xfa)]||function(_0x4aa7d6,_0x10bb32){const _0x3841f0=_0x282dcf;if(typeof Reflect===_0x3841f0(0xde)&&typeof Reflect[_0x3841f0(0xf2)]===_0x3841f0(0xbe))return Reflect[_0x3841f0(0xf2)](_0x4aa7d6,_0x10bb32);},__param=this&&this['__param']||function(_0x30701e,_0x1a07f8){return function(_0x2a8b9c,_0x282652){_0x1a07f8(_0x2a8b9c,_0x282652,_0x30701e);};};Object['defineProperty'](exports,_0x282dcf(0xda),{'value':!![]}),exports[_0x282dcf(0xe3)]=void 0x0;const globalConfig_service_1=require(_0x282dcf(0xca)),status_constant_1=require(_0x282dcf(0xc3)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),verifycation_entity_1=require(_0x282dcf(0xe0)),common_1=require(_0x282dcf(0xdb)),utils_1=require(_0x282dcf(0xd3)),redisCache_service_1=require(_0x282dcf(0xe4)),smsSDK=require(_0x282dcf(0xec)),Core=require(_0x282dcf(0xfe)),smsClient=smsSDK[_0x282dcf(0xcc)]['v20210111'][_0x282dcf(0xd5)];let VerificationService=class VerificationService{constructor(_0x28f284,_0x2288d8,_0x2de99b){const _0x25749f=_0x282dcf;this[_0x25749f(0xfc)]=_0x28f284,this['globalConfigService']=_0x2288d8,this[_0x25749f(0xcd)]=_0x2de99b;}async[_0x282dcf(0xe1)](_0x5f4044,_0x56b3fa,_0x4961a7=0x1e*0x3c){const _0x2373c8=_0x282dcf,_0x4bac09=await this[_0x2373c8(0xfc)][_0x2373c8(0xf8)]({'where':{'userId':_0x5f4044['id'],'type':_0x56b3fa},'order':{'createdAt':_0x2373c8(0xbf)}});if(_0x4bac09&&_0x4bac09[_0x2373c8(0xd8)][_0x2373c8(0xc6)]()+0x1*0x3c*0x3e8>Date[_0x2373c8(0xd7)]()){const _0x31f451=Math[_0x2373c8(0xf7)]((_0x4bac09['createdAt'][_0x2373c8(0xc6)]()+0x1*0x3c*0x3e8-Date[_0x2373c8(0xd7)]())/0x3e8);throw new common_1[(_0x2373c8(0xc7))](_0x31f451+'S内不得重新发送',common_1[_0x2373c8(0xd1)][_0x2373c8(0xdc)]);}const _0x139984=(0x0,utils_1[_0x2373c8(0xc5)])(),_0x2c6b1d=new Date(Date[_0x2373c8(0xd7)]()+_0x4961a7*0x3e8),{id:_0x499ae6,email:_0x8dd9ab}=_0x5f4044,_0x580d67={'userId':_0x499ae6,'type':_0x56b3fa,'code':_0x139984,'expiresAt':_0x2c6b1d,'email':_0x8dd9ab};return await this[_0x2373c8(0xfc)][_0x2373c8(0xff)](_0x580d67);}async['verifyCode']({code:_0x1d8aec,id:_0x26c1c9},_0x4ac8df){const _0x2da3e9=_0x282dcf,_0x3e198d=await this[_0x2da3e9(0xfc)][_0x2da3e9(0xf8)]({'where':{'id':_0x26c1c9,'type':_0x4ac8df},'order':{'createdAt':_0x2da3e9(0xbf)}});if(!_0x3e198d)throw new common_1[(_0x2da3e9(0xc7))](_0x2da3e9(0xf6),common_1[_0x2da3e9(0xd1)]['BAD_REQUEST']);if(_0x3e198d[_0x2da3e9(0xeb)]===status_constant_1[_0x2da3e9(0xdf)][_0x2da3e9(0xc9)])throw new common_1['HttpException'](_0x2da3e9(0xee),common_1[_0x2da3e9(0xd1)]['BAD_REQUEST']);else _0x3e198d[_0x2da3e9(0xeb)]=status_constant_1[_0x2da3e9(0xdf)][_0x2da3e9(0xc9)],await this[_0x2da3e9(0xfc)]['update']({'id':_0x26c1c9},_0x3e198d);if(Number(_0x3e198d[_0x2da3e9(0xce)])!==Number(_0x1d8aec))throw new common_1['HttpException'](_0x2da3e9(0xbd),common_1['HttpStatus']['BAD_REQUEST']);if(_0x3e198d[_0x2da3e9(0xf1)]<new Date())throw new common_1[(_0x2da3e9(0xc7))](_0x2da3e9(0xc4),common_1[_0x2da3e9(0xd1)][_0x2da3e9(0xdc)]);return _0x3e198d;}async[_0x282dcf(0xfd)](_0xbd5905){const _0x5774af=_0x282dcf,{captchaId:_0x2d7949,captchaCode:_0xa218aa}=_0xbd5905,_0x2a0bc9=await this['globalConfigService'][_0x5774af(0xef)](),_0x46fef6=_0x2a0bc9+':CAPTCHA:'+_0x2d7949,_0x1bcd80=await this['redisCacheService']['get']({'key':_0x46fef6});await this[_0x5774af(0xcd)][_0x5774af(0xcb)]({'key':_0x46fef6});if(!_0x1bcd80)throw new common_1[(_0x5774af(0xc7))]('图形验证码已过期、请重新输入!',common_1['HttpStatus']['BAD_REQUEST']);if(!_0x1bcd80||_0x1bcd80!==_0xa218aa)throw new common_1[(_0x5774af(0xc7))](_0x5774af(0xc2),common_1['HttpStatus'][_0x5774af(0xdc)]);}async[_0x282dcf(0xe7)](_0x43d9e4){const _0x6b651c=_0x282dcf;var _0x29acfe;const {accessKeyId:_0x3f8973,accessKeySecret:_0x45011f,SignName:_0x14e220,TemplateCode:_0x21a44a}=await this['globalConfigService'][_0x6b651c(0xf9)](),{phone:_0x49ba57,code:_0x1a50a8}=_0x43d9e4;if(!_0x49ba57||!_0x1a50a8)throw new common_1[(_0x6b651c(0xc7))](_0x6b651c(0xb7),common_1[_0x6b651c(0xd1)][_0x6b651c(0xdc)]);const _0x202bd6=new Core({'accessKeyId':_0x3f8973,'accessKeySecret':_0x45011f,'endpoint':_0x6b651c(0xf3),'apiVersion':_0x6b651c(0xc1)}),_0x450d70={'PhoneNumbers':_0x49ba57,'SignName':_0x14e220,'TemplateCode':_0x21a44a,'TemplateParam':JSON['stringify']({'code':_0x1a50a8})},_0x4016b1={'method':_0x6b651c(0xb2),'formatParams':![]};try{const _0xeca0d1=await _0x202bd6['request']('SendSms',_0x450d70,_0x4016b1);if(_0xeca0d1['Code']==='OK')return!![];else throw new common_1[(_0x6b651c(0xc7))](_0xeca0d1[_0x6b651c(0xf4)]||_0x6b651c(0xc8),common_1[_0x6b651c(0xd1)][_0x6b651c(0xdc)]);}catch(_0x5d07fe){throw new common_1['HttpException'](((_0x29acfe=_0x5d07fe===null||_0x5d07fe===void 0x0?void 0x0:_0x5d07fe[_0x6b651c(0xbb)])===null||_0x29acfe===void 0x0?void 0x0:_0x29acfe[_0x6b651c(0xf4)])||'验证码发送失败！',common_1[_0x6b651c(0xd1)][_0x6b651c(0xdc)]);}}async[_0x282dcf(0xba)](_0x92ddcf){const _0x2e9a4d=_0x282dcf;var _0x444531;const {secretId:_0x43a316,secretKey:_0x1cdbf9,signName:_0x299ad3,templateId:_0xe7170d,sdkAppId:_0x19be0e}=await this[_0x2e9a4d(0xea)][_0x2e9a4d(0xe6)](),{phone:_0x43efbd,code:_0x3e655a}=_0x92ddcf;if(!_0x43efbd||!_0x3e655a)throw new common_1[(_0x2e9a4d(0xc7))](_0x2e9a4d(0xb7),common_1[_0x2e9a4d(0xd1)][_0x2e9a4d(0xdc)]);const _0x21e5e0=new smsClient({'credential':{'secretId':_0x43a316,'secretKey':_0x1cdbf9},'region':_0x2e9a4d(0xb5),'profile':{'httpProfile':{'endpoint':'sms.tencentcloudapi.com'}}}),_0x709c7b={'PhoneNumberSet':[_0x43efbd],'SmsSdkAppId':_0x19be0e,'TemplateId':_0xe7170d,'SignName':_0x299ad3,'TemplateParamSet':[_0x3e655a+'','2']};try{const _0x13c6a7=await _0x21e5e0[_0x2e9a4d(0xb8)](_0x709c7b);console[_0x2e9a4d(0xf5)](_0x13c6a7);}catch(_0x1ed44c){console[_0x2e9a4d(0xf5)](_0x2e9a4d(0xe8),_0x1ed44c);throw new common_1[(_0x2e9a4d(0xc7))](((_0x444531=_0x1ed44c===null||_0x1ed44c===void 0x0?void 0x0:_0x1ed44c['data'])===null||_0x444531===void 0x0?void 0x0:_0x444531[_0x2e9a4d(0xf4)])||'验证码发送失败！',common_1[_0x2e9a4d(0xd1)]['BAD_REQUEST']);}}};function _0x17bd(_0x48e31d,_0x3eca64){const _0x7cec29=_0x7cec();return _0x17bd=function(_0x17bd68,_0x15ea6e){_0x17bd68=_0x17bd68-0xb2;let _0x4cec85=_0x7cec29[_0x17bd68];return _0x4cec85;},_0x17bd(_0x48e31d,_0x3eca64);}function _0x7cec(){const _0x1af00b=['DESC','873666yJAofN','2017-05-25','图形验证码错误、请检查填写!','../../common/constants/status.constant','验证码已过期','createRandomCode','getTime','HttpException','验证码发送失败！','USED','../globalConfig/globalConfig.service','del','sms','redisCacheService','code','13279xNuRjD','9355530iFZmsE','HttpStatus','__decorate','../../common/utils','56pfglBf','Client','length','now','createdAt','decorate','__esModule','@nestjs/common','BAD_REQUEST','1009929mMsPyV','object','VerificationUseStatusEnum','./verifycation.entity','createVerification','RedisCacheService','VerificationService','../redisCache/redisCache.service','335733ipoXca','getQcloudPhoneVerifyConfig','sendPhoneCode','error','672MnhgXy','globalConfigService','used','tencentcloud-sdk-nodejs-sms','defineProperty','当前验证码已被使用！','getNamespace','Repository','expiresAt','metadata','https://dysmsapi.aliyuncs.com','Message','log','验证码不存在','ceil','findOne','getPhoneVerifyConfig','__metadata','GlobalConfigService','verifycationEntity','verifyCaptcha','@alicloud/pop-core','save','POST','Injectable','10445JAtuDm','ap-beijing','4uzSvYb','确实必要参数错误！','SendSms','267708ODocKK','sendPhoneCodeWithQcloud','data','VerifycationEntity','验证码错误','function'];_0x7cec=function(){return _0x1af00b;};return _0x7cec();}VerificationService=__decorate([(0x0,common_1[_0x282dcf(0xb3)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(verifycation_entity_1[_0x282dcf(0xbc)])),__metadata('design:paramtypes',[typeorm_2[_0x282dcf(0xf0)],globalConfig_service_1[_0x282dcf(0xfb)],redisCache_service_1[_0x282dcf(0xe2)]])],VerificationService),exports[_0x282dcf(0xe3)]=VerificationService;