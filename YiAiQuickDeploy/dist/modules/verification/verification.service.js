'use strict';const _0x4d383e=_0x4bf1;(function(_0x4e658a,_0x553491){const _0x341b1e=_0x4bf1,_0x57cbef=_0x4e658a();while(!![]){try{const _0x5e5704=parseInt(_0x341b1e(0x174))/0x1*(-parseInt(_0x341b1e(0x1b9))/0x2)+-parseInt(_0x341b1e(0x1a3))/0x3+parseInt(_0x341b1e(0x172))/0x4*(parseInt(_0x341b1e(0x19f))/0x5)+-parseInt(_0x341b1e(0x17f))/0x6*(parseInt(_0x341b1e(0x18d))/0x7)+parseInt(_0x341b1e(0x18f))/0x8*(parseInt(_0x341b1e(0x1ad))/0x9)+parseInt(_0x341b1e(0x188))/0xa+parseInt(_0x341b1e(0x171))/0xb*(-parseInt(_0x341b1e(0x18a))/0xc);if(_0x5e5704===_0x553491)break;else _0x57cbef['push'](_0x57cbef['shift']());}catch(_0x20d97a){_0x57cbef['push'](_0x57cbef['shift']());}}}(_0x57d6,0x7c0a4));var __decorate=this&&this[_0x4d383e(0x1b0)]||function(_0x246ddc,_0x4b8482,_0x2ee866,_0x5ce2ea){const _0x4eb44d=_0x4d383e;var _0xc1dcb6=arguments[_0x4eb44d(0x1a1)],_0x1b5d0e=_0xc1dcb6<0x3?_0x4b8482:_0x5ce2ea===null?_0x5ce2ea=Object['getOwnPropertyDescriptor'](_0x4b8482,_0x2ee866):_0x5ce2ea,_0x50565c;if(typeof Reflect===_0x4eb44d(0x197)&&typeof Reflect[_0x4eb44d(0x196)]===_0x4eb44d(0x176))_0x1b5d0e=Reflect['decorate'](_0x246ddc,_0x4b8482,_0x2ee866,_0x5ce2ea);else{for(var _0x394f7a=_0x246ddc[_0x4eb44d(0x1a1)]-0x1;_0x394f7a>=0x0;_0x394f7a--)if(_0x50565c=_0x246ddc[_0x394f7a])_0x1b5d0e=(_0xc1dcb6<0x3?_0x50565c(_0x1b5d0e):_0xc1dcb6>0x3?_0x50565c(_0x4b8482,_0x2ee866,_0x1b5d0e):_0x50565c(_0x4b8482,_0x2ee866))||_0x1b5d0e;}return _0xc1dcb6>0x3&&_0x1b5d0e&&Object[_0x4eb44d(0x191)](_0x4b8482,_0x2ee866,_0x1b5d0e),_0x1b5d0e;},__metadata=this&&this['__metadata']||function(_0x4bd551,_0x4f6144){const _0x1deba8=_0x4d383e;if(typeof Reflect===_0x1deba8(0x197)&&typeof Reflect[_0x1deba8(0x1ae)]===_0x1deba8(0x176))return Reflect['metadata'](_0x4bd551,_0x4f6144);},__param=this&&this[_0x4d383e(0x18c)]||function(_0x3d5dc1,_0x17a079){return function(_0xc0b31c,_0x21e72e){_0x17a079(_0xc0b31c,_0x21e72e,_0x3d5dc1);};};Object['defineProperty'](exports,_0x4d383e(0x19c),{'value':!![]}),exports['VerificationService']=void 0x0;const globalConfig_service_1=require(_0x4d383e(0x1a4)),status_constant_1=require('../../common/constants/status.constant'),typeorm_1=require(_0x4d383e(0x179)),typeorm_2=require(_0x4d383e(0x19a)),verifycation_entity_1=require(_0x4d383e(0x190)),common_1=require('@nestjs/common'),utils_1=require(_0x4d383e(0x192)),redisCache_service_1=require('../redisCache/redisCache.service'),smsSDK=require('tencentcloud-sdk-nodejs-sms'),Core=require(_0x4d383e(0x1b5)),smsClient=smsSDK['sms']['v20210111'][_0x4d383e(0x16b)];let VerificationService=class VerificationService{constructor(_0x53792f,_0x4a7538,_0x174362){const _0x585d53=_0x4d383e;this[_0x585d53(0x1a7)]=_0x53792f,this[_0x585d53(0x1b1)]=_0x4a7538,this[_0x585d53(0x1a0)]=_0x174362;}async[_0x4d383e(0x177)](_0x3ba2db,_0x391904,_0x22018b=0x1e*0x3c){const _0x4350cd=_0x4d383e,_0x11c729=await this['verifycationEntity'][_0x4350cd(0x194)]({'where':{'userId':_0x3ba2db['id'],'type':_0x391904},'order':{'createdAt':_0x4350cd(0x178)}});if(_0x11c729&&_0x11c729[_0x4350cd(0x186)][_0x4350cd(0x184)]()+0x1*0x3c*0x3e8>Date[_0x4350cd(0x1b4)]()){const _0x2c5d88=Math[_0x4350cd(0x175)]((_0x11c729['createdAt']['getTime']()+0x1*0x3c*0x3e8-Date[_0x4350cd(0x1b4)]())/0x3e8);throw new common_1[(_0x4350cd(0x1ab))](_0x2c5d88+'S内不得重新发送',common_1[_0x4350cd(0x1b2)][_0x4350cd(0x16d)]);}const _0xc7544=(0x0,utils_1[_0x4350cd(0x1a9)])(),_0x1744c2=new Date(Date['now']()+_0x22018b*0x3e8),{id:_0x124bb0,email:_0x3a19c3}=_0x3ba2db,_0x5cde13={'userId':_0x124bb0,'type':_0x391904,'code':_0xc7544,'expiresAt':_0x1744c2,'email':_0x3a19c3};return await this[_0x4350cd(0x1a7)][_0x4350cd(0x17c)](_0x5cde13);}async[_0x4d383e(0x16e)]({code:_0xc1919d,id:_0x100463},_0x56bf6c){const _0x46adbf=_0x4d383e,_0x46048c=await this['verifycationEntity'][_0x46adbf(0x194)]({'where':{'id':_0x100463,'type':_0x56bf6c},'order':{'createdAt':_0x46adbf(0x178)}});if(!_0x46048c)throw new common_1[(_0x46adbf(0x1ab))](_0x46adbf(0x183),common_1[_0x46adbf(0x1b2)][_0x46adbf(0x16d)]);if(_0x46048c[_0x46adbf(0x195)]===status_constant_1[_0x46adbf(0x1b7)][_0x46adbf(0x1a2)])throw new common_1['HttpException'](_0x46adbf(0x1a5),common_1[_0x46adbf(0x1b2)][_0x46adbf(0x16d)]);else _0x46048c[_0x46adbf(0x195)]=status_constant_1[_0x46adbf(0x1b7)][_0x46adbf(0x1a2)],await this[_0x46adbf(0x1a7)][_0x46adbf(0x181)]({'id':_0x100463},_0x46048c);if(Number(_0x46048c[_0x46adbf(0x193)])!==Number(_0xc1919d))throw new common_1['HttpException'](_0x46adbf(0x198),common_1['HttpStatus'][_0x46adbf(0x16d)]);if(_0x46048c['expiresAt']<new Date())throw new common_1[(_0x46adbf(0x1ab))]('验证码已过期',common_1[_0x46adbf(0x1b2)][_0x46adbf(0x16d)]);return _0x46048c;}async['verifyCaptcha'](_0x2c63d9){const _0x2fbc38=_0x4d383e,{captchaId:_0x50166e,captchaCode:_0x13be14}=_0x2c63d9,_0x4731b6=await this[_0x2fbc38(0x1b1)][_0x2fbc38(0x1b6)](),_0x5aaa0f=_0x4731b6+_0x2fbc38(0x182)+_0x50166e,_0x9fe50f=await this[_0x2fbc38(0x1a0)][_0x2fbc38(0x1b3)]({'key':_0x5aaa0f});await this[_0x2fbc38(0x1a0)][_0x2fbc38(0x199)]({'key':_0x5aaa0f});if(!_0x9fe50f)throw new common_1[(_0x2fbc38(0x1ab))]('图形验证码已过期、请重新输入!',common_1[_0x2fbc38(0x1b2)]['BAD_REQUEST']);if(!_0x9fe50f||_0x9fe50f!==_0x13be14)throw new common_1[(_0x2fbc38(0x1ab))](_0x2fbc38(0x173),common_1[_0x2fbc38(0x1b2)]['BAD_REQUEST']);}async[_0x4d383e(0x16f)](_0x1e0728){const _0x2f3455=_0x4d383e;var _0x3b2242;const {accessKeyId:_0x11e4ac,accessKeySecret:_0x524c16,SignName:_0x1ccb9e,TemplateCode:_0x498da3}=await this[_0x2f3455(0x1b1)][_0x2f3455(0x185)](),{phone:_0x100d01,code:_0x4e2dad}=_0x1e0728;if(!_0x100d01||!_0x4e2dad)throw new common_1[(_0x2f3455(0x1ab))]('确实必要参数错误！',common_1[_0x2f3455(0x1b2)]['BAD_REQUEST']);const _0x59071e=new Core({'accessKeyId':_0x11e4ac,'accessKeySecret':_0x524c16,'endpoint':_0x2f3455(0x18b),'apiVersion':_0x2f3455(0x180)}),_0xbbb82b={'PhoneNumbers':_0x100d01,'SignName':_0x1ccb9e,'TemplateCode':_0x498da3,'TemplateParam':JSON['stringify']({'code':_0x4e2dad})},_0x2058bb={'method':_0x2f3455(0x187),'formatParams':![]};try{const _0x3f08dc=await _0x59071e['request'](_0x2f3455(0x17b),_0xbbb82b,_0x2058bb);if(_0x3f08dc[_0x2f3455(0x18e)]==='OK')return!![];else throw new common_1[(_0x2f3455(0x1ab))](_0x3f08dc[_0x2f3455(0x189)]||_0x2f3455(0x19d),common_1['HttpStatus'][_0x2f3455(0x16d)]);}catch(_0x44756e){throw new common_1[(_0x2f3455(0x1ab))](((_0x3b2242=_0x44756e===null||_0x44756e===void 0x0?void 0x0:_0x44756e[_0x2f3455(0x17a)])===null||_0x3b2242===void 0x0?void 0x0:_0x3b2242['Message'])||_0x2f3455(0x19d),common_1[_0x2f3455(0x1b2)]['BAD_REQUEST']);}}async[_0x4d383e(0x17e)](_0x4597c9){const _0x26aee3=_0x4d383e;var _0x40be49;const {secretId:_0x45b9cf,secretKey:_0x53e1e8,signName:_0x46d023,templateId:_0x2b94c7,sdkAppId:_0x4b4a3f}=await this[_0x26aee3(0x1b1)][_0x26aee3(0x1aa)](),{phone:_0xc8ffea,code:_0x21a578}=_0x4597c9;if(!_0xc8ffea||!_0x21a578)throw new common_1[(_0x26aee3(0x1ab))](_0x26aee3(0x170),common_1[_0x26aee3(0x1b2)][_0x26aee3(0x16d)]);const _0x7d9c60=new smsClient({'credential':{'secretId':_0x45b9cf,'secretKey':_0x53e1e8},'region':_0x26aee3(0x16c),'profile':{'httpProfile':{'endpoint':'sms.tencentcloudapi.com'}}}),_0x549239={'PhoneNumberSet':[_0xc8ffea],'SmsSdkAppId':_0x4b4a3f,'TemplateId':_0x2b94c7,'SignName':_0x46d023,'TemplateParamSet':[_0x21a578+'','2']};try{const _0x32c4f5=await _0x7d9c60[_0x26aee3(0x17b)](_0x549239);console[_0x26aee3(0x1ac)](_0x32c4f5);}catch(_0x51950c){console[_0x26aee3(0x1ac)](_0x26aee3(0x1b8),_0x51950c);throw new common_1[(_0x26aee3(0x1ab))](((_0x40be49=_0x51950c===null||_0x51950c===void 0x0?void 0x0:_0x51950c[_0x26aee3(0x17a)])===null||_0x40be49===void 0x0?void 0x0:_0x40be49[_0x26aee3(0x189)])||_0x26aee3(0x19d),common_1[_0x26aee3(0x1b2)]['BAD_REQUEST']);}}};function _0x4bf1(_0x48b315,_0x541542){const _0x57d6b9=_0x57d6();return _0x4bf1=function(_0x4bf1c5,_0x297976){_0x4bf1c5=_0x4bf1c5-0x16b;let _0x2185b1=_0x57d6b9[_0x4bf1c5];return _0x2185b1;},_0x4bf1(_0x48b315,_0x541542);}function _0x57d6(){const _0x1e0232=['used','decorate','object','验证码错误','del','typeorm','VerifycationEntity','__esModule','验证码发送失败！','InjectRepository','325310BcepKF','redisCacheService','length','USED','375822WrFGvA','../globalConfig/globalConfig.service','当前验证码已被使用！','design:paramtypes','verifycationEntity','GlobalConfigService','createRandomCode','getQcloudPhoneVerifyConfig','HttpException','log','528435HJhFMq','metadata','VerificationService','__decorate','globalConfigService','HttpStatus','get','now','@alicloud/pop-core','getNamespace','VerificationUseStatusEnum','error','560RaRNKU','Client','ap-beijing','BAD_REQUEST','verifyCode','sendPhoneCode','确实必要参数错误！','99aNudSE','60NlLBYd','图形验证码错误、请检查填写!','2235ifieEi','ceil','function','createVerification','DESC','@nestjs/typeorm','data','SendSms','save','Injectable','sendPhoneCodeWithQcloud','36pnSQpk','2017-05-25','update',':CAPTCHA:','验证码不存在','getTime','getPhoneVerifyConfig','createdAt','POST','3758890dzhbwc','Message','57744uaWdqO','https://dysmsapi.aliyuncs.com','__param','948108YuvDFW','Code','104UKzmDY','./verifycation.entity','defineProperty','../../common/utils','code','findOne'];_0x57d6=function(){return _0x1e0232;};return _0x57d6();}VerificationService=__decorate([(0x0,common_1[_0x4d383e(0x17d)])(),__param(0x0,(0x0,typeorm_1[_0x4d383e(0x19e)])(verifycation_entity_1[_0x4d383e(0x19b)])),__metadata(_0x4d383e(0x1a6),[typeorm_2['Repository'],globalConfig_service_1[_0x4d383e(0x1a8)],redisCache_service_1['RedisCacheService']])],VerificationService),exports[_0x4d383e(0x1af)]=VerificationService;