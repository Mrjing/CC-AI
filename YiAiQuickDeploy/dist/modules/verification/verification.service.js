'use strict';const _0x14f633=_0x3ffe;(function(_0x1250c3,_0xa10ac8){const _0x276a6b=_0x3ffe,_0x42617a=_0x1250c3();while(!![]){try{const _0x545901=parseInt(_0x276a6b(0x15a))/0x1+-parseInt(_0x276a6b(0x14b))/0x2*(parseInt(_0x276a6b(0x158))/0x3)+-parseInt(_0x276a6b(0x155))/0x4+-parseInt(_0x276a6b(0x150))/0x5+-parseInt(_0x276a6b(0x143))/0x6*(parseInt(_0x276a6b(0x183))/0x7)+-parseInt(_0x276a6b(0x173))/0x8*(parseInt(_0x276a6b(0x162))/0x9)+parseInt(_0x276a6b(0x17d))/0xa;if(_0x545901===_0xa10ac8)break;else _0x42617a['push'](_0x42617a['shift']());}catch(_0xfd16bd){_0x42617a['push'](_0x42617a['shift']());}}}(_0x53df,0xeb90f));var __decorate=this&&this['__decorate']||function(_0xaae5,_0x162384,_0x77f63f,_0x3315e7){const _0x4449bb=_0x3ffe;var _0x3ff1d5=arguments['length'],_0x2e0e4c=_0x3ff1d5<0x3?_0x162384:_0x3315e7===null?_0x3315e7=Object[_0x4449bb(0x177)](_0x162384,_0x77f63f):_0x3315e7,_0x21e437;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x4449bb(0x170))_0x2e0e4c=Reflect[_0x4449bb(0x186)](_0xaae5,_0x162384,_0x77f63f,_0x3315e7);else{for(var _0x19eda5=_0xaae5['length']-0x1;_0x19eda5>=0x0;_0x19eda5--)if(_0x21e437=_0xaae5[_0x19eda5])_0x2e0e4c=(_0x3ff1d5<0x3?_0x21e437(_0x2e0e4c):_0x3ff1d5>0x3?_0x21e437(_0x162384,_0x77f63f,_0x2e0e4c):_0x21e437(_0x162384,_0x77f63f))||_0x2e0e4c;}return _0x3ff1d5>0x3&&_0x2e0e4c&&Object['defineProperty'](_0x162384,_0x77f63f,_0x2e0e4c),_0x2e0e4c;},__metadata=this&&this['__metadata']||function(_0xd8e1be,_0x2460ed){const _0x4fba87=_0x3ffe;if(typeof Reflect===_0x4fba87(0x152)&&typeof Reflect['metadata']==='function')return Reflect[_0x4fba87(0x156)](_0xd8e1be,_0x2460ed);},__param=this&&this[_0x14f633(0x15c)]||function(_0x5d2578,_0x24c646){return function(_0x3cf173,_0x3bb5dd){_0x24c646(_0x3cf173,_0x3bb5dd,_0x5d2578);};};Object[_0x14f633(0x16c)](exports,'__esModule',{'value':!![]}),exports['VerificationService']=void 0x0;const globalConfig_service_1=require(_0x14f633(0x15b)),status_constant_1=require(_0x14f633(0x14d)),typeorm_1=require(_0x14f633(0x14e)),typeorm_2=require(_0x14f633(0x160)),verifycation_entity_1=require(_0x14f633(0x180)),common_1=require(_0x14f633(0x188)),utils_1=require(_0x14f633(0x148)),redisCache_service_1=require('../redisCache/redisCache.service'),smsSDK=require('tencentcloud-sdk-nodejs-sms'),Core=require('@alicloud/pop-core'),smsClient=smsSDK[_0x14f633(0x140)]['v20210111'][_0x14f633(0x16d)];let VerificationService=class VerificationService{constructor(_0xd5ad30,_0x27e8ea,_0x4cd747){const _0x257481=_0x14f633;this[_0x257481(0x151)]=_0xd5ad30,this['globalConfigService']=_0x27e8ea,this['redisCacheService']=_0x4cd747;}async['createVerification'](_0x212d26,_0x5da459,_0x574daa=0x1e*0x3c){const _0x5a5742=_0x14f633,_0x4b4584=await this[_0x5a5742(0x151)][_0x5a5742(0x16e)]({'where':{'userId':_0x212d26['id'],'type':_0x5da459},'order':{'createdAt':'DESC'}});if(_0x4b4584&&_0x4b4584[_0x5a5742(0x166)][_0x5a5742(0x17e)]()+0x1*0x3c*0x3e8>Date[_0x5a5742(0x181)]()){const _0x1fff45=Math[_0x5a5742(0x147)]((_0x4b4584[_0x5a5742(0x166)][_0x5a5742(0x17e)]()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1[(_0x5a5742(0x17a))](_0x1fff45+'S内不得重新发送',common_1[_0x5a5742(0x153)][_0x5a5742(0x17b)]);}const _0x19e59e=(0x0,utils_1[_0x5a5742(0x164)])(),_0x1bef23=new Date(Date[_0x5a5742(0x181)]()+_0x574daa*0x3e8),{id:_0x23137c,email:_0xfff099}=_0x212d26,_0x69e7c8={'userId':_0x23137c,'type':_0x5da459,'code':_0x19e59e,'expiresAt':_0x1bef23,'email':_0xfff099};return await this[_0x5a5742(0x151)][_0x5a5742(0x159)](_0x69e7c8);}async['verifyCode']({code:_0xcf48c5,id:_0x503d0b},_0x1ca804){const _0x4fbe8b=_0x14f633,_0x3cebea=await this['verifycationEntity']['findOne']({'where':{'id':_0x503d0b,'type':_0x1ca804},'order':{'createdAt':'DESC'}});if(!_0x3cebea)throw new common_1['HttpException'](_0x4fbe8b(0x169),common_1[_0x4fbe8b(0x153)][_0x4fbe8b(0x17b)]);if(_0x3cebea['used']===status_constant_1[_0x4fbe8b(0x17f)]['USED'])throw new common_1['HttpException'](_0x4fbe8b(0x16a),common_1[_0x4fbe8b(0x153)][_0x4fbe8b(0x17b)]);else _0x3cebea[_0x4fbe8b(0x176)]=status_constant_1[_0x4fbe8b(0x17f)][_0x4fbe8b(0x17c)],await this[_0x4fbe8b(0x151)]['update']({'id':_0x503d0b},_0x3cebea);if(Number(_0x3cebea[_0x4fbe8b(0x142)])!==Number(_0xcf48c5))throw new common_1[(_0x4fbe8b(0x17a))](_0x4fbe8b(0x168),common_1[_0x4fbe8b(0x153)][_0x4fbe8b(0x17b)]);if(_0x3cebea[_0x4fbe8b(0x179)]<new Date())throw new common_1['HttpException'](_0x4fbe8b(0x15f),common_1[_0x4fbe8b(0x153)][_0x4fbe8b(0x17b)]);return _0x3cebea;}async['verifyCaptcha'](_0x462f29){const _0xd17471=_0x14f633,{captchaId:_0xf346b1,captchaCode:_0x30e333}=_0x462f29,_0x281241=await this['globalConfigService'][_0xd17471(0x13e)](),_0x30c22d=_0x281241+_0xd17471(0x145)+_0xf346b1,_0x1e7d44=await this[_0xd17471(0x144)][_0xd17471(0x175)]({'key':_0x30c22d});await this[_0xd17471(0x144)][_0xd17471(0x184)]({'key':_0x30c22d});if(!_0x1e7d44)throw new common_1[(_0xd17471(0x17a))]('图形验证码已过期、请重新输入!',common_1[_0xd17471(0x153)][_0xd17471(0x17b)]);if(!_0x1e7d44||_0x1e7d44!==_0x30e333)throw new common_1['HttpException']('图形验证码错误、请检查填写!',common_1[_0xd17471(0x153)][_0xd17471(0x17b)]);}async[_0x14f633(0x174)](_0x4e6f70){const _0x3fa11d=_0x14f633;var _0x34d355;const {accessKeyId:_0x14146c,accessKeySecret:_0x547f1b,SignName:_0x38877d,TemplateCode:_0xe52cc5}=await this['globalConfigService'][_0x3fa11d(0x15e)](),{phone:_0xa5e820,code:_0x49c9c8}=_0x4e6f70;if(!_0xa5e820||!_0x49c9c8)throw new common_1[(_0x3fa11d(0x17a))]('确实必要参数错误！',common_1[_0x3fa11d(0x153)]['BAD_REQUEST']);const _0x2f3db9=new Core({'accessKeyId':_0x14146c,'accessKeySecret':_0x547f1b,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0x3fa11d(0x187)}),_0x21e275={'PhoneNumbers':_0xa5e820,'SignName':_0x38877d,'TemplateCode':_0xe52cc5,'TemplateParam':JSON[_0x3fa11d(0x146)]({'code':_0x49c9c8})},_0x26a85c={'method':_0x3fa11d(0x154),'formatParams':![]};try{const _0x1f2499=await _0x2f3db9[_0x3fa11d(0x167)]('SendSms',_0x21e275,_0x26a85c);if(_0x1f2499[_0x3fa11d(0x14f)]==='OK')return!![];else throw new common_1['HttpException'](_0x1f2499[_0x3fa11d(0x182)]||_0x3fa11d(0x157),common_1[_0x3fa11d(0x153)][_0x3fa11d(0x17b)]);}catch(_0x2463b0){throw new common_1['HttpException'](((_0x34d355=_0x2463b0===null||_0x2463b0===void 0x0?void 0x0:_0x2463b0[_0x3fa11d(0x149)])===null||_0x34d355===void 0x0?void 0x0:_0x34d355['Message'])||_0x3fa11d(0x157),common_1[_0x3fa11d(0x153)][_0x3fa11d(0x17b)]);}}async[_0x14f633(0x15d)](_0x492f5a){const _0x41735c=_0x14f633;var _0x58e270;const {secretId:_0x5bfb68,secretKey:_0x5b3963,signName:_0x1170bc,templateId:_0x33d7ad,sdkAppId:_0x10a992}=await this[_0x41735c(0x14c)]['getQcloudPhoneVerifyConfig'](),{phone:_0x45db7a,code:_0x2fb929}=_0x492f5a;if(!_0x45db7a||!_0x2fb929)throw new common_1[(_0x41735c(0x17a))](_0x41735c(0x14a),common_1[_0x41735c(0x153)]['BAD_REQUEST']);const _0x24950c=new smsClient({'credential':{'secretId':_0x5bfb68,'secretKey':_0x5b3963},'region':_0x41735c(0x185),'profile':{'httpProfile':{'endpoint':_0x41735c(0x163)}}}),_0xbc299c={'PhoneNumberSet':[_0x45db7a],'SmsSdkAppId':_0x10a992,'TemplateId':_0x33d7ad,'SignName':_0x1170bc,'TemplateParamSet':[_0x2fb929+'','2']};try{const _0xc7f256=await _0x24950c[_0x41735c(0x189)](_0xbc299c);console[_0x41735c(0x165)](_0x41735c(0x172),_0xc7f256);}catch(_0x52fb1a){console['log']('error',_0x52fb1a);throw new common_1['HttpException'](((_0x58e270=_0x52fb1a===null||_0x52fb1a===void 0x0?void 0x0:_0x52fb1a['data'])===null||_0x58e270===void 0x0?void 0x0:_0x58e270[_0x41735c(0x182)])||_0x41735c(0x157),common_1[_0x41735c(0x153)]['BAD_REQUEST']);}}};function _0x3ffe(_0x567920,_0x43c165){const _0x53df29=_0x53df();return _0x3ffe=function(_0x3ffec5,_0x3ff34e){_0x3ffec5=_0x3ffec5-0x13e;let _0x17442e=_0x53df29[_0x3ffec5];return _0x17442e;},_0x3ffe(_0x567920,_0x43c165);}VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x14f633(0x16b)])(verifycation_entity_1[_0x14f633(0x141)])),__metadata(_0x14f633(0x16f),[typeorm_2[_0x14f633(0x13f)],globalConfig_service_1[_0x14f633(0x171)],redisCache_service_1[_0x14f633(0x178)]])],VerificationService),exports[_0x14f633(0x161)]=VerificationService;function _0x53df(){const _0x191d7c=['typeorm','VerificationService','141291DicxdF','sms.tencentcloudapi.com','createRandomCode','log','createdAt','request','验证码错误','验证码不存在','当前验证码已被使用！','InjectRepository','defineProperty','Client','findOne','design:paramtypes','function','GlobalConfigService','sendsms','392WCJbni','sendPhoneCode','get','used','getOwnPropertyDescriptor','RedisCacheService','expiresAt','HttpException','BAD_REQUEST','USED','51524950jLsLkt','getTime','VerificationUseStatusEnum','./verifycation.entity','now','Message','328195NpElIQ','del','ap-beijing','decorate','2017-05-25','@nestjs/common','SendSms','getNamespace','Repository','sms','VerifycationEntity','code','102emsCfp','redisCacheService',':CAPTCHA:','stringify','ceil','../../common/utils','data','确实必要参数错误！','1066962fkVxzq','globalConfigService','../../common/constants/status.constant','@nestjs/typeorm','Code','7701955QlPeCc','verifycationEntity','object','HttpStatus','POST','160048CjUGtu','metadata','验证码发送失败！','9TPbnQK','save','559526qjUuUW','../globalConfig/globalConfig.service','__param','sendPhoneCodeWithQcloud','getPhoneVerifyConfig','验证码已过期'];_0x53df=function(){return _0x191d7c;};return _0x53df();}