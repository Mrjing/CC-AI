'use strict';function _0x8e7f(_0x58dc14,_0x44c904){const _0x56ec89=_0x56ec();return _0x8e7f=function(_0x8e7ff4,_0x48fe56){_0x8e7ff4=_0x8e7ff4-0x174;let _0x43099c=_0x56ec89[_0x8e7ff4];return _0x43099c;},_0x8e7f(_0x58dc14,_0x44c904);}const _0x25bb8f=_0x8e7f;(function(_0x5d10e8,_0x3506a4){const _0x2d646e=_0x8e7f,_0x5bbfa8=_0x5d10e8();while(!![]){try{const _0x195127=parseInt(_0x2d646e(0x1bd))/0x1*(-parseInt(_0x2d646e(0x18f))/0x2)+parseInt(_0x2d646e(0x183))/0x3+parseInt(_0x2d646e(0x1c0))/0x4*(-parseInt(_0x2d646e(0x1aa))/0x5)+parseInt(_0x2d646e(0x1bc))/0x6+parseInt(_0x2d646e(0x17c))/0x7+-parseInt(_0x2d646e(0x1a7))/0x8*(-parseInt(_0x2d646e(0x1c1))/0x9)+-parseInt(_0x2d646e(0x1ac))/0xa;if(_0x195127===_0x3506a4)break;else _0x5bbfa8['push'](_0x5bbfa8['shift']());}catch(_0x4b2da3){_0x5bbfa8['push'](_0x5bbfa8['shift']());}}}(_0x56ec,0xca679));var __decorate=this&&this['__decorate']||function(_0x3bfbf5,_0x3a0935,_0x286b9f,_0x41720d){const _0x547b6b=_0x8e7f;var _0x7e2144=arguments[_0x547b6b(0x17d)],_0x4da38a=_0x7e2144<0x3?_0x3a0935:_0x41720d===null?_0x41720d=Object['getOwnPropertyDescriptor'](_0x3a0935,_0x286b9f):_0x41720d,_0x2f136f;if(typeof Reflect==='object'&&typeof Reflect[_0x547b6b(0x1b8)]==='function')_0x4da38a=Reflect['decorate'](_0x3bfbf5,_0x3a0935,_0x286b9f,_0x41720d);else{for(var _0x29a902=_0x3bfbf5[_0x547b6b(0x17d)]-0x1;_0x29a902>=0x0;_0x29a902--)if(_0x2f136f=_0x3bfbf5[_0x29a902])_0x4da38a=(_0x7e2144<0x3?_0x2f136f(_0x4da38a):_0x7e2144>0x3?_0x2f136f(_0x3a0935,_0x286b9f,_0x4da38a):_0x2f136f(_0x3a0935,_0x286b9f))||_0x4da38a;}return _0x7e2144>0x3&&_0x4da38a&&Object['defineProperty'](_0x3a0935,_0x286b9f,_0x4da38a),_0x4da38a;},__metadata=this&&this['__metadata']||function(_0x3e6792,_0x3c2e6b){const _0x16d25c=_0x8e7f;if(typeof Reflect===_0x16d25c(0x184)&&typeof Reflect[_0x16d25c(0x19f)]===_0x16d25c(0x182))return Reflect[_0x16d25c(0x19f)](_0x3e6792,_0x3c2e6b);},__param=this&&this[_0x25bb8f(0x1a0)]||function(_0x4a663c,_0x4aa0ae){return function(_0x4dd1a4,_0x575983){_0x4aa0ae(_0x4dd1a4,_0x575983,_0x4a663c);};};Object[_0x25bb8f(0x180)](exports,_0x25bb8f(0x1a9),{'value':!![]}),exports[_0x25bb8f(0x18a)]=void 0x0;const globalConfig_service_1=require(_0x25bb8f(0x1b0)),status_constant_1=require('../../common/constants/status.constant'),typeorm_1=require(_0x25bb8f(0x199)),typeorm_2=require(_0x25bb8f(0x18c)),verifycation_entity_1=require(_0x25bb8f(0x195)),common_1=require(_0x25bb8f(0x1bb)),utils_1=require(_0x25bb8f(0x1ae)),redisCache_service_1=require('../redisCache/redisCache.service'),smsSDK=require(_0x25bb8f(0x176)),Core=require(_0x25bb8f(0x17e)),smsClient=smsSDK['sms'][_0x25bb8f(0x1a4)]['Client'];let VerificationService=class VerificationService{constructor(_0x5da628,_0x365095,_0x2fc019){const _0x364f35=_0x25bb8f;this[_0x364f35(0x193)]=_0x5da628,this[_0x364f35(0x19a)]=_0x365095,this[_0x364f35(0x1a3)]=_0x2fc019;}async[_0x25bb8f(0x1b1)](_0x11bffc,_0x287a83,_0x5884a5=0x1e*0x3c){const _0x27f1da=_0x25bb8f,_0x5d933f=await this[_0x27f1da(0x193)][_0x27f1da(0x179)]({'where':{'userId':_0x11bffc['id'],'type':_0x287a83},'order':{'createdAt':_0x27f1da(0x187)}});if(_0x5d933f&&_0x5d933f[_0x27f1da(0x17f)]['getTime']()+0x1*0x3c*0x3e8>Date[_0x27f1da(0x18d)]()){const _0x56cc1a=Math['ceil']((_0x5d933f['createdAt'][_0x27f1da(0x1a6)]()+0x1*0x3c*0x3e8-Date[_0x27f1da(0x18d)]())/0x3e8);throw new common_1[(_0x27f1da(0x19e))](_0x56cc1a+_0x27f1da(0x17a),common_1[_0x27f1da(0x189)][_0x27f1da(0x1af)]);}const _0x59ed77=(0x0,utils_1['createRandomCode'])(),_0x3863aa=new Date(Date[_0x27f1da(0x18d)]()+_0x5884a5*0x3e8),{id:_0x2aa544,email:_0x144908}=_0x11bffc,_0x2b33a4={'userId':_0x2aa544,'type':_0x287a83,'code':_0x59ed77,'expiresAt':_0x3863aa,'email':_0x144908};return await this[_0x27f1da(0x193)][_0x27f1da(0x1a1)](_0x2b33a4);}async[_0x25bb8f(0x188)]({code:_0x5be72e,id:_0x145ea0},_0x3c543e){const _0x5419aa=_0x25bb8f,_0x6b3fad=await this['verifycationEntity'][_0x5419aa(0x179)]({'where':{'id':_0x145ea0,'type':_0x3c543e},'order':{'createdAt':_0x5419aa(0x187)}});if(!_0x6b3fad)throw new common_1['HttpException'](_0x5419aa(0x1b9),common_1['HttpStatus'][_0x5419aa(0x1af)]);if(_0x6b3fad[_0x5419aa(0x185)]===status_constant_1['VerificationUseStatusEnum'][_0x5419aa(0x178)])throw new common_1[(_0x5419aa(0x19e))](_0x5419aa(0x175),common_1[_0x5419aa(0x189)]['BAD_REQUEST']);else _0x6b3fad[_0x5419aa(0x185)]=status_constant_1[_0x5419aa(0x1bf)]['USED'],await this['verifycationEntity'][_0x5419aa(0x1a8)]({'id':_0x145ea0},_0x6b3fad);if(Number(_0x6b3fad[_0x5419aa(0x191)])!==Number(_0x5be72e))throw new common_1[(_0x5419aa(0x19e))]('验证码错误',common_1['HttpStatus'][_0x5419aa(0x1af)]);if(_0x6b3fad[_0x5419aa(0x198)]<new Date())throw new common_1[(_0x5419aa(0x19e))](_0x5419aa(0x17b),common_1[_0x5419aa(0x189)][_0x5419aa(0x1af)]);return _0x6b3fad;}async[_0x25bb8f(0x194)](_0x47e985){const _0x4dd3d3=_0x25bb8f,{captchaId:_0x5df277,captchaCode:_0x1a2c62}=_0x47e985,_0x54ea8a=await this[_0x4dd3d3(0x19a)][_0x4dd3d3(0x1b2)](),_0xd58492=_0x54ea8a+_0x4dd3d3(0x18b)+_0x5df277,_0x38e3e0=await this['redisCacheService'][_0x4dd3d3(0x1b5)]({'key':_0xd58492});await this[_0x4dd3d3(0x1a3)]['del']({'key':_0xd58492});if(!_0x38e3e0)throw new common_1[(_0x4dd3d3(0x19e))](_0x4dd3d3(0x190),common_1[_0x4dd3d3(0x189)][_0x4dd3d3(0x1af)]);if(!_0x38e3e0||_0x38e3e0!==_0x1a2c62)throw new common_1[(_0x4dd3d3(0x19e))](_0x4dd3d3(0x1a5),common_1[_0x4dd3d3(0x189)]['BAD_REQUEST']);}async[_0x25bb8f(0x19c)](_0x4cbfac){const _0x536622=_0x25bb8f;var _0x267be4;const {accessKeyId:_0x35fa4a,accessKeySecret:_0x4c6b2b,SignName:_0x3b2c71,TemplateCode:_0x1db497}=await this[_0x536622(0x19a)][_0x536622(0x1ba)](),{phone:_0x549b3d,code:_0x5de292}=_0x4cbfac;if(!_0x549b3d||!_0x5de292)throw new common_1[(_0x536622(0x19e))](_0x536622(0x1b6),common_1[_0x536622(0x189)][_0x536622(0x1af)]);const _0x3ff5f7=new Core({'accessKeyId':_0x35fa4a,'accessKeySecret':_0x4c6b2b,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0x536622(0x1b3)}),_0x3c6a2e={'PhoneNumbers':_0x549b3d,'SignName':_0x3b2c71,'TemplateCode':_0x1db497,'TemplateParam':JSON['stringify']({'code':_0x5de292})},_0x409e1f={'method':_0x536622(0x19d),'formatParams':![]};try{const _0x245355=await _0x3ff5f7['request'](_0x536622(0x192),_0x3c6a2e,_0x409e1f);if(_0x245355[_0x536622(0x196)]==='OK')return!![];else throw new common_1[(_0x536622(0x19e))](_0x245355[_0x536622(0x1be)]||'验证码发送失败！',common_1[_0x536622(0x189)][_0x536622(0x1af)]);}catch(_0x38e411){throw new common_1[(_0x536622(0x19e))](((_0x267be4=_0x38e411===null||_0x38e411===void 0x0?void 0x0:_0x38e411[_0x536622(0x1b4)])===null||_0x267be4===void 0x0?void 0x0:_0x267be4[_0x536622(0x1be)])||_0x536622(0x1ad),common_1[_0x536622(0x189)][_0x536622(0x1af)]);}}async['sendPhoneCodeWithQcloud'](_0x3f8c49){const _0x41df25=_0x25bb8f;var _0x1575b4;const {secretId:_0x29ba9f,secretKey:_0x381f7d,signName:_0x18f37b,templateId:_0x16eb08,sdkAppId:_0x42063b}=await this[_0x41df25(0x19a)][_0x41df25(0x181)](),{phone:_0x2dc327,code:_0x4f930c}=_0x3f8c49;if(!_0x2dc327||!_0x4f930c)throw new common_1[(_0x41df25(0x19e))](_0x41df25(0x1b6),common_1[_0x41df25(0x189)][_0x41df25(0x1af)]);const _0x12729e=new smsClient({'credential':{'secretId':_0x29ba9f,'secretKey':_0x381f7d},'region':'ap-beijing','profile':{'httpProfile':{'endpoint':_0x41df25(0x18e)}}}),_0x422c29={'PhoneNumberSet':[_0x2dc327],'SmsSdkAppId':_0x42063b,'TemplateId':_0x16eb08,'SignName':_0x18f37b,'TemplateParamSet':[_0x4f930c+'','2']};try{const _0x4018ca=await _0x12729e[_0x41df25(0x192)](_0x422c29);console[_0x41df25(0x1b7)](_0x4018ca);}catch(_0x874b3c){console['log'](_0x41df25(0x186),_0x874b3c);throw new common_1['HttpException'](((_0x1575b4=_0x874b3c===null||_0x874b3c===void 0x0?void 0x0:_0x874b3c[_0x41df25(0x1b4)])===null||_0x1575b4===void 0x0?void 0x0:_0x1575b4[_0x41df25(0x1be)])||_0x41df25(0x1ad),common_1['HttpStatus'][_0x41df25(0x1af)]);}}};function _0x56ec(){const _0x490a1a=['__param','save','Repository','redisCacheService','v20210111','图形验证码错误、请检查填写!','getTime','8DZPWYW','update','__esModule','2065bVMAEX','VerifycationEntity','21490140gTrxvS','验证码发送失败！','../../common/utils','BAD_REQUEST','../globalConfig/globalConfig.service','createVerification','getNamespace','2017-05-25','data','get','确实必要参数错误！','log','decorate','验证码不存在','getPhoneVerifyConfig','@nestjs/common','8889060pQEzOr','188338hZGfsp','Message','VerificationUseStatusEnum','7496jkuHDL','6003153RKGALF','RedisCacheService','当前验证码已被使用！','tencentcloud-sdk-nodejs-sms','InjectRepository','USED','findOne','S内不得重新发送','验证码已过期','4315136JdxkBI','length','@alicloud/pop-core','createdAt','defineProperty','getQcloudPhoneVerifyConfig','function','3526164oxtihQ','object','used','error','DESC','verifyCode','HttpStatus','VerificationService',':CAPTCHA:','typeorm','now','sms.tencentcloudapi.com','2bJlzZV','图形验证码已过期、请重新输入!','code','SendSms','verifycationEntity','verifyCaptcha','./verifycation.entity','Code','design:paramtypes','expiresAt','@nestjs/typeorm','globalConfigService','GlobalConfigService','sendPhoneCode','POST','HttpException','metadata'];_0x56ec=function(){return _0x490a1a;};return _0x56ec();}VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x25bb8f(0x177)])(verifycation_entity_1[_0x25bb8f(0x1ab)])),__metadata(_0x25bb8f(0x197),[typeorm_2[_0x25bb8f(0x1a2)],globalConfig_service_1[_0x25bb8f(0x19b)],redisCache_service_1[_0x25bb8f(0x174)]])],VerificationService),exports['VerificationService']=VerificationService;