'use strict';const _0x1127cc=_0x4a00;(function(_0x12524f,_0x38f264){const _0x5c0859=_0x4a00,_0x1975b3=_0x12524f();while(!![]){try{const _0x2429ae=-parseInt(_0x5c0859(0x13e))/0x1+parseInt(_0x5c0859(0x13b))/0x2*(parseInt(_0x5c0859(0x123))/0x3)+parseInt(_0x5c0859(0x148))/0x4+parseInt(_0x5c0859(0x154))/0x5+-parseInt(_0x5c0859(0x11e))/0x6*(parseInt(_0x5c0859(0x12e))/0x7)+parseInt(_0x5c0859(0x144))/0x8+parseInt(_0x5c0859(0x13c))/0x9*(-parseInt(_0x5c0859(0x142))/0xa);if(_0x2429ae===_0x38f264)break;else _0x1975b3['push'](_0x1975b3['shift']());}catch(_0x1e1490){_0x1975b3['push'](_0x1975b3['shift']());}}}(_0x77a2,0xb88bb));function _0x77a2(){const _0x1d5c20=['1192115KCoIjj','update','function','globalConfigService','299920cMjrQX','../redisCache/redisCache.service','8057856ogGMDs','2017-05-25','POST','__esModule','1718068FcGVEi','redisCacheService','now','findOne','验证码已过期','del','GlobalConfigService','used','Message','createRandomCode','Repository','code','5536380NGkgqd','验证码发送失败！','../../common/constants/status.constant','tencentcloud-sdk-nodejs-sms','getPhoneVerifyConfig','Code','VerificationService','error','确实必要参数错误！','Client','createdAt','defineProperty','data','../../common/utils','USED','sms.tencentcloudapi.com','@alicloud/pop-core','../globalConfig/globalConfig.service','log','metadata','decorate','getQcloudPhoneVerifyConfig','480CyMxfG','getNamespace','verifyCaptcha','@nestjs/typeorm','object','59493Ugntxo',':CAPTCHA:','sms','VerificationUseStatusEnum','图形验证码错误、请检查填写!','getTime','sendPhoneCodeWithQcloud','HttpStatus','S内不得重新发送','RedisCacheService','__param','42371NRbQkN','InjectRepository','当前验证码已被使用！','VerifycationEntity','验证码不存在','typeorm','验证码错误','length','图形验证码已过期、请重新输入!','verifycationEntity','BAD_REQUEST','save','design:paramtypes','22pnGSIr','99EtLmIa','HttpException'];_0x77a2=function(){return _0x1d5c20;};return _0x77a2();}var __decorate=this&&this['__decorate']||function(_0x1b0e96,_0x4bddc4,_0x393429,_0x3f6cca){const _0x242995=_0x4a00;var _0x2595b3=arguments[_0x242995(0x135)],_0xca1f6a=_0x2595b3<0x3?_0x4bddc4:_0x3f6cca===null?_0x3f6cca=Object['getOwnPropertyDescriptor'](_0x4bddc4,_0x393429):_0x3f6cca,_0x2bcfc6;if(typeof Reflect===_0x242995(0x122)&&typeof Reflect[_0x242995(0x11c)]===_0x242995(0x140))_0xca1f6a=Reflect['decorate'](_0x1b0e96,_0x4bddc4,_0x393429,_0x3f6cca);else{for(var _0xf803f0=_0x1b0e96['length']-0x1;_0xf803f0>=0x0;_0xf803f0--)if(_0x2bcfc6=_0x1b0e96[_0xf803f0])_0xca1f6a=(_0x2595b3<0x3?_0x2bcfc6(_0xca1f6a):_0x2595b3>0x3?_0x2bcfc6(_0x4bddc4,_0x393429,_0xca1f6a):_0x2bcfc6(_0x4bddc4,_0x393429))||_0xca1f6a;}return _0x2595b3>0x3&&_0xca1f6a&&Object[_0x242995(0x15f)](_0x4bddc4,_0x393429,_0xca1f6a),_0xca1f6a;},__metadata=this&&this['__metadata']||function(_0x5ae216,_0x41400b){const _0x4531f3=_0x4a00;if(typeof Reflect===_0x4531f3(0x122)&&typeof Reflect['metadata']===_0x4531f3(0x140))return Reflect[_0x4531f3(0x167)](_0x5ae216,_0x41400b);},__param=this&&this[_0x1127cc(0x12d)]||function(_0x394bc3,_0x350873){return function(_0x4dc1ba,_0x43c458){_0x350873(_0x4dc1ba,_0x43c458,_0x394bc3);};};Object[_0x1127cc(0x15f)](exports,_0x1127cc(0x147),{'value':!![]}),exports[_0x1127cc(0x15a)]=void 0x0;const globalConfig_service_1=require(_0x1127cc(0x165)),status_constant_1=require(_0x1127cc(0x156)),typeorm_1=require(_0x1127cc(0x121)),typeorm_2=require(_0x1127cc(0x133)),verifycation_entity_1=require('./verifycation.entity'),common_1=require('@nestjs/common'),utils_1=require(_0x1127cc(0x161)),redisCache_service_1=require(_0x1127cc(0x143)),smsSDK=require(_0x1127cc(0x157)),Core=require(_0x1127cc(0x164)),smsClient=smsSDK[_0x1127cc(0x125)]['v20210111'][_0x1127cc(0x15d)];let VerificationService=class VerificationService{constructor(_0x4895a8,_0x51d192,_0x7af237){const _0x20107d=_0x1127cc;this[_0x20107d(0x137)]=_0x4895a8,this[_0x20107d(0x141)]=_0x51d192,this[_0x20107d(0x149)]=_0x7af237;}async['createVerification'](_0x32db05,_0x2f8b22,_0x173786=0x1e*0x3c){const _0xca9184=_0x1127cc,_0x187a02=await this[_0xca9184(0x137)][_0xca9184(0x14b)]({'where':{'userId':_0x32db05['id'],'type':_0x2f8b22},'order':{'createdAt':'DESC'}});if(_0x187a02&&_0x187a02[_0xca9184(0x15e)][_0xca9184(0x128)]()+0x1*0x3c*0x3e8>Date[_0xca9184(0x14a)]()){const _0x4b313e=Math['ceil']((_0x187a02[_0xca9184(0x15e)][_0xca9184(0x128)]()+0x1*0x3c*0x3e8-Date[_0xca9184(0x14a)]())/0x3e8);throw new common_1[(_0xca9184(0x13d))](_0x4b313e+_0xca9184(0x12b),common_1[_0xca9184(0x12a)][_0xca9184(0x138)]);}const _0xff5cb7=(0x0,utils_1[_0xca9184(0x151)])(),_0x1ba714=new Date(Date[_0xca9184(0x14a)]()+_0x173786*0x3e8),{id:_0x238fd0,email:_0x5558e7}=_0x32db05,_0xa7cb92={'userId':_0x238fd0,'type':_0x2f8b22,'code':_0xff5cb7,'expiresAt':_0x1ba714,'email':_0x5558e7};return await this[_0xca9184(0x137)][_0xca9184(0x139)](_0xa7cb92);}async['verifyCode']({code:_0x205d9f,id:_0x336ca0},_0x3a39f3){const _0x35eae5=_0x1127cc,_0x1725d6=await this[_0x35eae5(0x137)][_0x35eae5(0x14b)]({'where':{'id':_0x336ca0,'type':_0x3a39f3},'order':{'createdAt':'DESC'}});if(!_0x1725d6)throw new common_1[(_0x35eae5(0x13d))](_0x35eae5(0x132),common_1['HttpStatus'][_0x35eae5(0x138)]);if(_0x1725d6[_0x35eae5(0x14f)]===status_constant_1[_0x35eae5(0x126)][_0x35eae5(0x162)])throw new common_1[(_0x35eae5(0x13d))](_0x35eae5(0x130),common_1[_0x35eae5(0x12a)]['BAD_REQUEST']);else _0x1725d6[_0x35eae5(0x14f)]=status_constant_1[_0x35eae5(0x126)][_0x35eae5(0x162)],await this[_0x35eae5(0x137)][_0x35eae5(0x13f)]({'id':_0x336ca0},_0x1725d6);if(Number(_0x1725d6[_0x35eae5(0x153)])!==Number(_0x205d9f))throw new common_1[(_0x35eae5(0x13d))](_0x35eae5(0x134),common_1[_0x35eae5(0x12a)][_0x35eae5(0x138)]);if(_0x1725d6['expiresAt']<new Date())throw new common_1[(_0x35eae5(0x13d))](_0x35eae5(0x14c),common_1[_0x35eae5(0x12a)]['BAD_REQUEST']);return _0x1725d6;}async[_0x1127cc(0x120)](_0x169f39){const _0x36b06f=_0x1127cc,{captchaId:_0x2d96e7,captchaCode:_0x155fe2}=_0x169f39,_0x21940d=await this[_0x36b06f(0x141)][_0x36b06f(0x11f)](),_0x11b147=_0x21940d+_0x36b06f(0x124)+_0x2d96e7,_0x12399e=await this[_0x36b06f(0x149)]['get']({'key':_0x11b147});await this['redisCacheService'][_0x36b06f(0x14d)]({'key':_0x11b147});if(!_0x12399e)throw new common_1[(_0x36b06f(0x13d))](_0x36b06f(0x136),common_1[_0x36b06f(0x12a)][_0x36b06f(0x138)]);if(!_0x12399e||_0x12399e!==_0x155fe2)throw new common_1[(_0x36b06f(0x13d))](_0x36b06f(0x127),common_1[_0x36b06f(0x12a)][_0x36b06f(0x138)]);}async['sendPhoneCode'](_0x405f29){const _0x3fa2fc=_0x1127cc;var _0x2d77c5;const {accessKeyId:_0x4f15af,accessKeySecret:_0x5cc9d3,SignName:_0x27334d,TemplateCode:_0x21cd25}=await this[_0x3fa2fc(0x141)][_0x3fa2fc(0x158)](),{phone:_0x594b22,code:_0x21ca77}=_0x405f29;if(!_0x594b22||!_0x21ca77)throw new common_1[(_0x3fa2fc(0x13d))]('确实必要参数错误！',common_1['HttpStatus'][_0x3fa2fc(0x138)]);const _0x542631=new Core({'accessKeyId':_0x4f15af,'accessKeySecret':_0x5cc9d3,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0x3fa2fc(0x145)}),_0x1271dc={'PhoneNumbers':_0x594b22,'SignName':_0x27334d,'TemplateCode':_0x21cd25,'TemplateParam':JSON['stringify']({'code':_0x21ca77})},_0x4bdad4={'method':_0x3fa2fc(0x146),'formatParams':![]};try{const _0x421dda=await _0x542631['request']('SendSms',_0x1271dc,_0x4bdad4);if(_0x421dda[_0x3fa2fc(0x159)]==='OK')return!![];else throw new common_1[(_0x3fa2fc(0x13d))](_0x421dda['Message']||_0x3fa2fc(0x155),common_1[_0x3fa2fc(0x12a)][_0x3fa2fc(0x138)]);}catch(_0x3f883d){throw new common_1[(_0x3fa2fc(0x13d))](((_0x2d77c5=_0x3f883d===null||_0x3f883d===void 0x0?void 0x0:_0x3f883d[_0x3fa2fc(0x160)])===null||_0x2d77c5===void 0x0?void 0x0:_0x2d77c5[_0x3fa2fc(0x150)])||'验证码发送失败！',common_1['HttpStatus'][_0x3fa2fc(0x138)]);}}async[_0x1127cc(0x129)](_0x2eda8c){const _0x2e8163=_0x1127cc;var _0x5df5f1;const {secretId:_0x7a64d9,secretKey:_0x350286,signName:_0x78ea8c,templateId:_0x5e7dd0,sdkAppId:_0x543e20}=await this['globalConfigService'][_0x2e8163(0x11d)](),{phone:_0x26f0b3,code:_0x5753ff}=_0x2eda8c;if(!_0x26f0b3||!_0x5753ff)throw new common_1['HttpException'](_0x2e8163(0x15c),common_1[_0x2e8163(0x12a)][_0x2e8163(0x138)]);const _0x3e38e9=new smsClient({'credential':{'secretId':_0x7a64d9,'secretKey':_0x350286},'region':'ap-beijing','profile':{'httpProfile':{'endpoint':_0x2e8163(0x163)}}}),_0xa158c2={'PhoneNumberSet':[_0x26f0b3],'SmsSdkAppId':_0x543e20,'TemplateId':_0x5e7dd0,'SignName':_0x78ea8c,'TemplateParamSet':[_0x5753ff+'','2']};try{const _0x2d61ec=await _0x3e38e9['SendSms'](_0xa158c2);console['log']('sendsms',_0x2d61ec);}catch(_0x1d7cfd){console[_0x2e8163(0x166)](_0x2e8163(0x15b),_0x1d7cfd);throw new common_1[(_0x2e8163(0x13d))](((_0x5df5f1=_0x1d7cfd===null||_0x1d7cfd===void 0x0?void 0x0:_0x1d7cfd[_0x2e8163(0x160)])===null||_0x5df5f1===void 0x0?void 0x0:_0x5df5f1[_0x2e8163(0x150)])||_0x2e8163(0x155),common_1[_0x2e8163(0x12a)][_0x2e8163(0x138)]);}}};function _0x4a00(_0x50a96b,_0x29ac80){const _0x77a25c=_0x77a2();return _0x4a00=function(_0x4a00a0,_0x1c1763){_0x4a00a0=_0x4a00a0-0x11c;let _0x2fa0d6=_0x77a25c[_0x4a00a0];return _0x2fa0d6;},_0x4a00(_0x50a96b,_0x29ac80);}VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x1127cc(0x12f)])(verifycation_entity_1[_0x1127cc(0x131)])),__metadata(_0x1127cc(0x13a),[typeorm_2[_0x1127cc(0x152)],globalConfig_service_1[_0x1127cc(0x14e)],redisCache_service_1[_0x1127cc(0x12c)]])],VerificationService),exports[_0x1127cc(0x15a)]=VerificationService;