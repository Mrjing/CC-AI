'use strict';const _0x3ff5a2=_0x2b60;(function(_0x27d0b2,_0xb72e58){const _0x25f167=_0x2b60,_0x3ad4f9=_0x27d0b2();while(!![]){try{const _0x209de5=parseInt(_0x25f167(0x184))/0x1+-parseInt(_0x25f167(0x196))/0x2+-parseInt(_0x25f167(0x18b))/0x3*(-parseInt(_0x25f167(0x16a))/0x4)+parseInt(_0x25f167(0x175))/0x5+parseInt(_0x25f167(0x163))/0x6+parseInt(_0x25f167(0x1a0))/0x7+-parseInt(_0x25f167(0x164))/0x8;if(_0x209de5===_0xb72e58)break;else _0x3ad4f9['push'](_0x3ad4f9['shift']());}catch(_0x3ede8a){_0x3ad4f9['push'](_0x3ad4f9['shift']());}}}(_0x4143,0x63293));function _0x4143(){const _0x469a52=['__metadata','decorate','stringify','sendPhoneCode','__esModule','createRandomCode','Repository','typeorm','ap-beijing','getPhoneVerifyConfig','771247IAkoCi','verifycationEntity','DESC','createdAt','https://dysmsapi.aliyuncs.com','object','log','138AIaXRb','Client','../globalConfig/globalConfig.service','../redisCache/redisCache.service','@alicloud/pop-core','S内不得重新发送','__param','ceil','function','2017-05-25','save','827472otfRDS','used','HttpException','createVerification','@nestjs/common','BAD_REQUEST','now','findOne','../../common/utils','图形验证码已过期、请重新输入!','4115202CVbwCa','Code','getQcloudPhoneVerifyConfig','getTime','RedisCacheService','HttpStatus','defineProperty','验证码发送失败！','getNamespace','del','data','@nestjs/typeorm','Message','23604szoehc','9323768MHmNhb','SendSms','GlobalConfigService','length','v20210111','验证码不存在','44420zqAZQj','verifyCode','VerificationUseStatusEnum','error','code','./verifycation.entity','验证码已过期','VerificationService','确实必要参数错误！','expiresAt','验证码错误','557365EGNuMV','sendPhoneCodeWithQcloud','globalConfigService','redisCacheService','USED'];_0x4143=function(){return _0x469a52;};return _0x4143();}var __decorate=this&&this['__decorate']||function(_0x565283,_0x582abf,_0x2ff814,_0x58f401){const _0x3ce58c=_0x2b60;var _0x5400c1=arguments['length'],_0xb20b5a=_0x5400c1<0x3?_0x582abf:_0x58f401===null?_0x58f401=Object['getOwnPropertyDescriptor'](_0x582abf,_0x2ff814):_0x58f401,_0xd4d5ce;if(typeof Reflect==='object'&&typeof Reflect[_0x3ce58c(0x17b)]===_0x3ce58c(0x193))_0xb20b5a=Reflect[_0x3ce58c(0x17b)](_0x565283,_0x582abf,_0x2ff814,_0x58f401);else{for(var _0xced183=_0x565283[_0x3ce58c(0x167)]-0x1;_0xced183>=0x0;_0xced183--)if(_0xd4d5ce=_0x565283[_0xced183])_0xb20b5a=(_0x5400c1<0x3?_0xd4d5ce(_0xb20b5a):_0x5400c1>0x3?_0xd4d5ce(_0x582abf,_0x2ff814,_0xb20b5a):_0xd4d5ce(_0x582abf,_0x2ff814))||_0xb20b5a;}return _0x5400c1>0x3&&_0xb20b5a&&Object[_0x3ce58c(0x1a6)](_0x582abf,_0x2ff814,_0xb20b5a),_0xb20b5a;},__metadata=this&&this[_0x3ff5a2(0x17a)]||function(_0x23187d,_0x256fe9){const _0x2ae2fa=_0x3ff5a2;if(typeof Reflect===_0x2ae2fa(0x189)&&typeof Reflect['metadata']===_0x2ae2fa(0x193))return Reflect['metadata'](_0x23187d,_0x256fe9);},__param=this&&this[_0x3ff5a2(0x191)]||function(_0x3d8214,_0x259a46){return function(_0x553771,_0x5e7ae8){_0x259a46(_0x553771,_0x5e7ae8,_0x3d8214);};};function _0x2b60(_0x3b239b,_0x28fec5){const _0x414363=_0x4143();return _0x2b60=function(_0x2b60f5,_0x4893d2){_0x2b60f5=_0x2b60f5-0x161;let _0x976ed6=_0x414363[_0x2b60f5];return _0x976ed6;},_0x2b60(_0x3b239b,_0x28fec5);}Object[_0x3ff5a2(0x1a6)](exports,_0x3ff5a2(0x17e),{'value':!![]}),exports[_0x3ff5a2(0x171)]=void 0x0;const globalConfig_service_1=require(_0x3ff5a2(0x18d)),status_constant_1=require('../../common/constants/status.constant'),typeorm_1=require(_0x3ff5a2(0x161)),typeorm_2=require(_0x3ff5a2(0x181)),verifycation_entity_1=require(_0x3ff5a2(0x16f)),common_1=require(_0x3ff5a2(0x19a)),utils_1=require(_0x3ff5a2(0x19e)),redisCache_service_1=require(_0x3ff5a2(0x18e)),smsSDK=require('tencentcloud-sdk-nodejs-sms'),Core=require(_0x3ff5a2(0x18f)),smsClient=smsSDK['sms'][_0x3ff5a2(0x168)][_0x3ff5a2(0x18c)];let VerificationService=class VerificationService{constructor(_0x2735e1,_0x363204,_0x49b2f7){const _0x16a7a6=_0x3ff5a2;this[_0x16a7a6(0x185)]=_0x2735e1,this['globalConfigService']=_0x363204,this[_0x16a7a6(0x178)]=_0x49b2f7;}async[_0x3ff5a2(0x199)](_0x1149f8,_0x9245c9,_0x5ef908=0x1e*0x3c){const _0x2d18ed=_0x3ff5a2,_0x1b9614=await this[_0x2d18ed(0x185)][_0x2d18ed(0x19d)]({'where':{'userId':_0x1149f8['id'],'type':_0x9245c9},'order':{'createdAt':_0x2d18ed(0x186)}});if(_0x1b9614&&_0x1b9614[_0x2d18ed(0x187)][_0x2d18ed(0x1a3)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x4165ba=Math[_0x2d18ed(0x192)]((_0x1b9614[_0x2d18ed(0x187)][_0x2d18ed(0x1a3)]()+0x1*0x3c*0x3e8-Date[_0x2d18ed(0x19c)]())/0x3e8);throw new common_1[(_0x2d18ed(0x198))](_0x4165ba+_0x2d18ed(0x190),common_1[_0x2d18ed(0x1a5)][_0x2d18ed(0x19b)]);}const _0xa7c727=(0x0,utils_1[_0x2d18ed(0x17f)])(),_0x15390a=new Date(Date['now']()+_0x5ef908*0x3e8),{id:_0x413f53,email:_0x538fc3}=_0x1149f8,_0x5ce5fd={'userId':_0x413f53,'type':_0x9245c9,'code':_0xa7c727,'expiresAt':_0x15390a,'email':_0x538fc3};return await this[_0x2d18ed(0x185)][_0x2d18ed(0x195)](_0x5ce5fd);}async[_0x3ff5a2(0x16b)]({code:_0x12804f,id:_0x58cb5f},_0x1f34d9){const _0x332ed4=_0x3ff5a2,_0x3f42ff=await this[_0x332ed4(0x185)][_0x332ed4(0x19d)]({'where':{'id':_0x58cb5f,'type':_0x1f34d9},'order':{'createdAt':_0x332ed4(0x186)}});if(!_0x3f42ff)throw new common_1[(_0x332ed4(0x198))](_0x332ed4(0x169),common_1[_0x332ed4(0x1a5)][_0x332ed4(0x19b)]);if(_0x3f42ff[_0x332ed4(0x197)]===status_constant_1['VerificationUseStatusEnum']['USED'])throw new common_1[(_0x332ed4(0x198))]('当前验证码已被使用！',common_1[_0x332ed4(0x1a5)]['BAD_REQUEST']);else _0x3f42ff['used']=status_constant_1[_0x332ed4(0x16c)][_0x332ed4(0x179)],await this[_0x332ed4(0x185)]['update']({'id':_0x58cb5f},_0x3f42ff);if(Number(_0x3f42ff[_0x332ed4(0x16e)])!==Number(_0x12804f))throw new common_1[(_0x332ed4(0x198))](_0x332ed4(0x174),common_1[_0x332ed4(0x1a5)][_0x332ed4(0x19b)]);if(_0x3f42ff[_0x332ed4(0x173)]<new Date())throw new common_1[(_0x332ed4(0x198))](_0x332ed4(0x170),common_1[_0x332ed4(0x1a5)][_0x332ed4(0x19b)]);return _0x3f42ff;}async['verifyCaptcha'](_0xbf4027){const _0x1b3459=_0x3ff5a2,{captchaId:_0x5a8528,captchaCode:_0x237409}=_0xbf4027,_0x2f35e6=await this[_0x1b3459(0x177)][_0x1b3459(0x1a8)](),_0x187e96=_0x2f35e6+':CAPTCHA:'+_0x5a8528,_0xf40b0d=await this['redisCacheService']['get']({'key':_0x187e96});await this[_0x1b3459(0x178)][_0x1b3459(0x1a9)]({'key':_0x187e96});if(!_0xf40b0d)throw new common_1[(_0x1b3459(0x198))](_0x1b3459(0x19f),common_1['HttpStatus']['BAD_REQUEST']);if(!_0xf40b0d||_0xf40b0d!==_0x237409)throw new common_1[(_0x1b3459(0x198))]('图形验证码错误、请检查填写!',common_1[_0x1b3459(0x1a5)][_0x1b3459(0x19b)]);}async[_0x3ff5a2(0x17d)](_0x3e14ba){const _0x97e39d=_0x3ff5a2;var _0x5c5b11;const {accessKeyId:_0x354024,accessKeySecret:_0xda736,SignName:_0x3dcc6d,TemplateCode:_0x573ec1}=await this[_0x97e39d(0x177)][_0x97e39d(0x183)](),{phone:_0x276ee2,code:_0x56ba0a}=_0x3e14ba;if(!_0x276ee2||!_0x56ba0a)throw new common_1[(_0x97e39d(0x198))]('确实必要参数错误！',common_1[_0x97e39d(0x1a5)]['BAD_REQUEST']);const _0x410f04=new Core({'accessKeyId':_0x354024,'accessKeySecret':_0xda736,'endpoint':_0x97e39d(0x188),'apiVersion':_0x97e39d(0x194)}),_0x370d1b={'PhoneNumbers':_0x276ee2,'SignName':_0x3dcc6d,'TemplateCode':_0x573ec1,'TemplateParam':JSON[_0x97e39d(0x17c)]({'code':_0x56ba0a})},_0x4415fe={'method':'POST','formatParams':![]};try{const _0x281e9e=await _0x410f04['request']('SendSms',_0x370d1b,_0x4415fe);if(_0x281e9e[_0x97e39d(0x1a1)]==='OK')return!![];else throw new common_1[(_0x97e39d(0x198))](_0x281e9e[_0x97e39d(0x162)]||_0x97e39d(0x1a7),common_1[_0x97e39d(0x1a5)]['BAD_REQUEST']);}catch(_0x4a0b9a){throw new common_1[(_0x97e39d(0x198))](((_0x5c5b11=_0x4a0b9a===null||_0x4a0b9a===void 0x0?void 0x0:_0x4a0b9a['data'])===null||_0x5c5b11===void 0x0?void 0x0:_0x5c5b11[_0x97e39d(0x162)])||_0x97e39d(0x1a7),common_1[_0x97e39d(0x1a5)]['BAD_REQUEST']);}}async[_0x3ff5a2(0x176)](_0x221814){const _0x3be7e2=_0x3ff5a2;var _0x5005f1;const {secretId:_0x313963,secretKey:_0x1c0f8a,signName:_0x7078b8,templateId:_0x7f07c3,sdkAppId:_0x5f59b4}=await this[_0x3be7e2(0x177)][_0x3be7e2(0x1a2)](),{phone:_0x6e66e8,code:_0x52a4b8}=_0x221814;if(!_0x6e66e8||!_0x52a4b8)throw new common_1[(_0x3be7e2(0x198))](_0x3be7e2(0x172),common_1[_0x3be7e2(0x1a5)]['BAD_REQUEST']);const _0x545e51=new smsClient({'credential':{'secretId':_0x313963,'secretKey':_0x1c0f8a},'region':_0x3be7e2(0x182),'profile':{'httpProfile':{'endpoint':'sms.tencentcloudapi.com'}}}),_0x4ceea8={'PhoneNumberSet':[_0x6e66e8],'SmsSdkAppId':_0x5f59b4,'TemplateId':_0x7f07c3,'SignName':_0x7078b8,'TemplateParamSet':[_0x52a4b8+'','2']};try{const _0x376fc1=await _0x545e51[_0x3be7e2(0x165)](_0x4ceea8);console[_0x3be7e2(0x18a)](_0x376fc1);}catch(_0xf5c581){console[_0x3be7e2(0x18a)](_0x3be7e2(0x16d),_0xf5c581);throw new common_1[(_0x3be7e2(0x198))](((_0x5005f1=_0xf5c581===null||_0xf5c581===void 0x0?void 0x0:_0xf5c581[_0x3be7e2(0x1aa)])===null||_0x5005f1===void 0x0?void 0x0:_0x5005f1[_0x3be7e2(0x162)])||_0x3be7e2(0x1a7),common_1[_0x3be7e2(0x1a5)][_0x3be7e2(0x19b)]);}}};VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(verifycation_entity_1['VerifycationEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x3ff5a2(0x180)],globalConfig_service_1[_0x3ff5a2(0x166)],redisCache_service_1[_0x3ff5a2(0x1a4)]])],VerificationService),exports[_0x3ff5a2(0x171)]=VerificationService;