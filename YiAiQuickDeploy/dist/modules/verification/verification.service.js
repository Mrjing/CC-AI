'use strict';const _0xa82fd9=_0x2e47;(function(_0x369ad5,_0x32279d){const _0x4c7f7a=_0x2e47,_0x1a42b5=_0x369ad5();while(!![]){try{const _0x3dc9e0=parseInt(_0x4c7f7a(0x1d6))/0x1*(-parseInt(_0x4c7f7a(0x1e5))/0x2)+-parseInt(_0x4c7f7a(0x1e7))/0x3*(parseInt(_0x4c7f7a(0x1cf))/0x4)+-parseInt(_0x4c7f7a(0x1d1))/0x5*(-parseInt(_0x4c7f7a(0x1e0))/0x6)+-parseInt(_0x4c7f7a(0x1d3))/0x7+-parseInt(_0x4c7f7a(0x1e8))/0x8*(parseInt(_0x4c7f7a(0x20e))/0x9)+-parseInt(_0x4c7f7a(0x1de))/0xa+parseInt(_0x4c7f7a(0x1ff))/0xb;if(_0x3dc9e0===_0x32279d)break;else _0x1a42b5['push'](_0x1a42b5['shift']());}catch(_0x3fe865){_0x1a42b5['push'](_0x1a42b5['shift']());}}}(_0x4ec9,0xcfc3c));function _0x2e47(_0x2e6792,_0x558f65){const _0x4ec96c=_0x4ec9();return _0x2e47=function(_0x2e472d,_0x234350){_0x2e472d=_0x2e472d-0x1c6;let _0xe06c=_0x4ec96c[_0x2e472d];return _0xe06c;},_0x2e47(_0x2e6792,_0x558f65);}var __decorate=this&&this[_0xa82fd9(0x1ea)]||function(_0x199f3e,_0x1d4422,_0x2244d7,_0xee275b){const _0x58ecc3=_0xa82fd9;var _0x568b41=arguments[_0x58ecc3(0x210)],_0x114c34=_0x568b41<0x3?_0x1d4422:_0xee275b===null?_0xee275b=Object['getOwnPropertyDescriptor'](_0x1d4422,_0x2244d7):_0xee275b,_0x1eba3b;if(typeof Reflect===_0x58ecc3(0x1e6)&&typeof Reflect['decorate']===_0x58ecc3(0x209))_0x114c34=Reflect[_0x58ecc3(0x205)](_0x199f3e,_0x1d4422,_0x2244d7,_0xee275b);else{for(var _0x217d64=_0x199f3e[_0x58ecc3(0x210)]-0x1;_0x217d64>=0x0;_0x217d64--)if(_0x1eba3b=_0x199f3e[_0x217d64])_0x114c34=(_0x568b41<0x3?_0x1eba3b(_0x114c34):_0x568b41>0x3?_0x1eba3b(_0x1d4422,_0x2244d7,_0x114c34):_0x1eba3b(_0x1d4422,_0x2244d7))||_0x114c34;}return _0x568b41>0x3&&_0x114c34&&Object[_0x58ecc3(0x1dc)](_0x1d4422,_0x2244d7,_0x114c34),_0x114c34;},__metadata=this&&this[_0xa82fd9(0x207)]||function(_0x5ac439,_0x5d2cc9){const _0x4b6c1a=_0xa82fd9;if(typeof Reflect===_0x4b6c1a(0x1e6)&&typeof Reflect[_0x4b6c1a(0x204)]===_0x4b6c1a(0x209))return Reflect[_0x4b6c1a(0x204)](_0x5ac439,_0x5d2cc9);},__param=this&&this['__param']||function(_0x50e7c6,_0x3ad6eb){return function(_0x233d29,_0x190cab){_0x3ad6eb(_0x233d29,_0x190cab,_0x50e7c6);};};Object['defineProperty'](exports,_0xa82fd9(0x1d4),{'value':!![]}),exports['VerificationService']=void 0x0;const globalConfig_service_1=require(_0xa82fd9(0x1d5)),status_constant_1=require(_0xa82fd9(0x1cc)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0xa82fd9(0x1db)),verifycation_entity_1=require('./verifycation.entity'),common_1=require(_0xa82fd9(0x1ce)),utils_1=require(_0xa82fd9(0x200)),redisCache_service_1=require(_0xa82fd9(0x201)),smsSDK=require(_0xa82fd9(0x1ec)),Core=require('@alicloud/pop-core'),smsClient=smsSDK[_0xa82fd9(0x1fb)][_0xa82fd9(0x1cb)]['Client'];function _0x4ec9(){const _0x2c5e8c=['4TLIJGr','sendPhoneCodeWithQcloud','25Ydsmug','design:paramtypes','6706098czHZhn','__esModule','../globalConfig/globalConfig.service','1172627YOkEQK','Message','验证码发送失败！','code','ap-beijing','typeorm','defineProperty','data','800850qRQITh','SendSms','669792LCryXV','now','验证码错误','图形验证码错误、请检查填写!',':CAPTCHA:','2sdnXTs','object','3732309XoaGVR','2299376IRxNRP','当前验证码已被使用！','__decorate','globalConfigService','tencentcloud-sdk-nodejs-sms','stringify','2017-05-25','error','getNamespace','InjectRepository','确实必要参数错误！','USED','createVerification','getPhoneVerifyConfig','get','VerifycationEntity','verifycationEntity','verifyCode','HttpException','sms','Injectable','BAD_REQUEST','sms.tencentcloudapi.com','47547687MagzaK','../../common/utils','../redisCache/redisCache.service','VerificationService','Code','metadata','decorate','del','__metadata','VerificationUseStatusEnum','function','DESC','getQcloudPhoneVerifyConfig','log','POST','18FvEocm','getTime','length','redisCacheService','findOne','used','createdAt','HttpStatus','v20210111','../../common/constants/status.constant','verifyCaptcha','@nestjs/common'];_0x4ec9=function(){return _0x2c5e8c;};return _0x4ec9();}let VerificationService=class VerificationService{constructor(_0x2dbcb3,_0x524df6,_0x24605d){const _0x105cea=_0xa82fd9;this[_0x105cea(0x1f8)]=_0x2dbcb3,this[_0x105cea(0x1eb)]=_0x524df6,this[_0x105cea(0x1c6)]=_0x24605d;}async[_0xa82fd9(0x1f4)](_0x4de483,_0x4f2c14,_0x182320=0x1e*0x3c){const _0x555330=_0xa82fd9,_0x49f4b5=await this[_0x555330(0x1f8)][_0x555330(0x1c7)]({'where':{'userId':_0x4de483['id'],'type':_0x4f2c14},'order':{'createdAt':'DESC'}});if(_0x49f4b5&&_0x49f4b5[_0x555330(0x1c9)][_0x555330(0x20f)]()+0x1*0x3c*0x3e8>Date[_0x555330(0x1e1)]()){const _0x267604=Math['ceil']((_0x49f4b5['createdAt'][_0x555330(0x20f)]()+0x1*0x3c*0x3e8-Date[_0x555330(0x1e1)]())/0x3e8);throw new common_1[(_0x555330(0x1fa))](_0x267604+'S内不得重新发送',common_1[_0x555330(0x1ca)][_0x555330(0x1fd)]);}const _0x3f394e=(0x0,utils_1['createRandomCode'])(),_0xed90fa=new Date(Date[_0x555330(0x1e1)]()+_0x182320*0x3e8),{id:_0x43fc2f,email:_0x109601}=_0x4de483,_0x1ed288={'userId':_0x43fc2f,'type':_0x4f2c14,'code':_0x3f394e,'expiresAt':_0xed90fa,'email':_0x109601};return await this['verifycationEntity']['save'](_0x1ed288);}async[_0xa82fd9(0x1f9)]({code:_0x5b86e,id:_0x2d962e},_0x48aa79){const _0x439f9d=_0xa82fd9,_0x1d238f=await this['verifycationEntity'][_0x439f9d(0x1c7)]({'where':{'id':_0x2d962e,'type':_0x48aa79},'order':{'createdAt':_0x439f9d(0x20a)}});if(!_0x1d238f)throw new common_1[(_0x439f9d(0x1fa))]('验证码不存在',common_1['HttpStatus'][_0x439f9d(0x1fd)]);if(_0x1d238f[_0x439f9d(0x1c8)]===status_constant_1[_0x439f9d(0x208)][_0x439f9d(0x1f3)])throw new common_1[(_0x439f9d(0x1fa))](_0x439f9d(0x1e9),common_1[_0x439f9d(0x1ca)][_0x439f9d(0x1fd)]);else _0x1d238f[_0x439f9d(0x1c8)]=status_constant_1[_0x439f9d(0x208)][_0x439f9d(0x1f3)],await this['verifycationEntity']['update']({'id':_0x2d962e},_0x1d238f);if(Number(_0x1d238f[_0x439f9d(0x1d9)])!==Number(_0x5b86e))throw new common_1[(_0x439f9d(0x1fa))](_0x439f9d(0x1e2),common_1[_0x439f9d(0x1ca)][_0x439f9d(0x1fd)]);if(_0x1d238f['expiresAt']<new Date())throw new common_1[(_0x439f9d(0x1fa))]('验证码已过期',common_1['HttpStatus'][_0x439f9d(0x1fd)]);return _0x1d238f;}async[_0xa82fd9(0x1cd)](_0x21688f){const _0x5c4c47=_0xa82fd9,{captchaId:_0x8dfd5a,captchaCode:_0x2010f8}=_0x21688f,_0x2c0be6=await this[_0x5c4c47(0x1eb)][_0x5c4c47(0x1f0)](),_0x190c3e=_0x2c0be6+_0x5c4c47(0x1e4)+_0x8dfd5a,_0x1d2763=await this[_0x5c4c47(0x1c6)][_0x5c4c47(0x1f6)]({'key':_0x190c3e});await this[_0x5c4c47(0x1c6)][_0x5c4c47(0x206)]({'key':_0x190c3e});if(!_0x1d2763)throw new common_1[(_0x5c4c47(0x1fa))]('图形验证码已过期、请重新输入!',common_1[_0x5c4c47(0x1ca)]['BAD_REQUEST']);if(!_0x1d2763||_0x1d2763!==_0x2010f8)throw new common_1[(_0x5c4c47(0x1fa))](_0x5c4c47(0x1e3),common_1['HttpStatus'][_0x5c4c47(0x1fd)]);}async['sendPhoneCode'](_0x2f2b92){const _0x2c9c51=_0xa82fd9;var _0x1d0b58;const {accessKeyId:_0x50d282,accessKeySecret:_0xc7e62b,SignName:_0x53d3e0,TemplateCode:_0x449134}=await this[_0x2c9c51(0x1eb)][_0x2c9c51(0x1f5)](),{phone:_0x52f225,code:_0xf54725}=_0x2f2b92;if(!_0x52f225||!_0xf54725)throw new common_1[(_0x2c9c51(0x1fa))](_0x2c9c51(0x1f2),common_1[_0x2c9c51(0x1ca)]['BAD_REQUEST']);const _0x4f2b00=new Core({'accessKeyId':_0x50d282,'accessKeySecret':_0xc7e62b,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0x2c9c51(0x1ee)}),_0x53df59={'PhoneNumbers':_0x52f225,'SignName':_0x53d3e0,'TemplateCode':_0x449134,'TemplateParam':JSON[_0x2c9c51(0x1ed)]({'code':_0xf54725})},_0x5bbcee={'method':_0x2c9c51(0x20d),'formatParams':![]};try{const _0x1570b7=await _0x4f2b00['request']('SendSms',_0x53df59,_0x5bbcee);if(_0x1570b7[_0x2c9c51(0x203)]==='OK')return!![];else throw new common_1['HttpException'](_0x1570b7[_0x2c9c51(0x1d7)]||_0x2c9c51(0x1d8),common_1[_0x2c9c51(0x1ca)][_0x2c9c51(0x1fd)]);}catch(_0x2aec85){throw new common_1[(_0x2c9c51(0x1fa))](((_0x1d0b58=_0x2aec85===null||_0x2aec85===void 0x0?void 0x0:_0x2aec85['data'])===null||_0x1d0b58===void 0x0?void 0x0:_0x1d0b58[_0x2c9c51(0x1d7)])||_0x2c9c51(0x1d8),common_1[_0x2c9c51(0x1ca)][_0x2c9c51(0x1fd)]);}}async[_0xa82fd9(0x1d0)](_0x2606eb){const _0x1c7d23=_0xa82fd9;var _0x1a19bb;const {secretId:_0x4e7fe8,secretKey:_0x12cd13,signName:_0x3c80e4,templateId:_0x585a04,sdkAppId:_0x496862}=await this[_0x1c7d23(0x1eb)][_0x1c7d23(0x20b)](),{phone:_0x87094f,code:_0x215755}=_0x2606eb;if(!_0x87094f||!_0x215755)throw new common_1[(_0x1c7d23(0x1fa))](_0x1c7d23(0x1f2),common_1[_0x1c7d23(0x1ca)]['BAD_REQUEST']);const _0x303a75=new smsClient({'credential':{'secretId':_0x4e7fe8,'secretKey':_0x12cd13},'region':_0x1c7d23(0x1da),'profile':{'httpProfile':{'endpoint':_0x1c7d23(0x1fe)}}}),_0x28dcd4={'PhoneNumberSet':[_0x87094f],'SmsSdkAppId':_0x496862,'TemplateId':_0x585a04,'SignName':_0x3c80e4,'TemplateParamSet':[_0x215755+'','2']};try{const _0x1aa8c4=await _0x303a75[_0x1c7d23(0x1df)](_0x28dcd4);console[_0x1c7d23(0x20c)](_0x1aa8c4);}catch(_0x1baa95){console[_0x1c7d23(0x20c)](_0x1c7d23(0x1ef),_0x1baa95);throw new common_1[(_0x1c7d23(0x1fa))](((_0x1a19bb=_0x1baa95===null||_0x1baa95===void 0x0?void 0x0:_0x1baa95[_0x1c7d23(0x1dd)])===null||_0x1a19bb===void 0x0?void 0x0:_0x1a19bb[_0x1c7d23(0x1d7)])||_0x1c7d23(0x1d8),common_1[_0x1c7d23(0x1ca)][_0x1c7d23(0x1fd)]);}}};VerificationService=__decorate([(0x0,common_1[_0xa82fd9(0x1fc)])(),__param(0x0,(0x0,typeorm_1[_0xa82fd9(0x1f1)])(verifycation_entity_1[_0xa82fd9(0x1f7)])),__metadata(_0xa82fd9(0x1d2),[typeorm_2['Repository'],globalConfig_service_1['GlobalConfigService'],redisCache_service_1['RedisCacheService']])],VerificationService),exports[_0xa82fd9(0x202)]=VerificationService;