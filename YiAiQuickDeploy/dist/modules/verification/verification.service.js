'use strict';const _0x4f0487=_0x2e76;(function(_0x2f3d07,_0x5b72c7){const _0x1812e0=_0x2e76,_0x148942=_0x2f3d07();while(!![]){try{const _0x5c65a3=parseInt(_0x1812e0(0x1cb))/0x1*(-parseInt(_0x1812e0(0x1d9))/0x2)+parseInt(_0x1812e0(0x1ce))/0x3+parseInt(_0x1812e0(0x1e5))/0x4+-parseInt(_0x1812e0(0x1f0))/0x5+-parseInt(_0x1812e0(0x1de))/0x6+parseInt(_0x1812e0(0x1dd))/0x7*(-parseInt(_0x1812e0(0x1c5))/0x8)+parseInt(_0x1812e0(0x1da))/0x9*(-parseInt(_0x1812e0(0x1ba))/0xa);if(_0x5c65a3===_0x5b72c7)break;else _0x148942['push'](_0x148942['shift']());}catch(_0x5b2ccc){_0x148942['push'](_0x148942['shift']());}}}(_0x392d,0x46726));var __decorate=this&&this[_0x4f0487(0x1f8)]||function(_0x396a56,_0x4ce14d,_0x122718,_0x3c17ab){const _0x345da2=_0x4f0487;var _0x30695c=arguments[_0x345da2(0x1fc)],_0x436dc2=_0x30695c<0x3?_0x4ce14d:_0x3c17ab===null?_0x3c17ab=Object[_0x345da2(0x1f7)](_0x4ce14d,_0x122718):_0x3c17ab,_0x5769e2;if(typeof Reflect===_0x345da2(0x1f9)&&typeof Reflect[_0x345da2(0x1c8)]===_0x345da2(0x1bf))_0x436dc2=Reflect[_0x345da2(0x1c8)](_0x396a56,_0x4ce14d,_0x122718,_0x3c17ab);else{for(var _0x48aa74=_0x396a56[_0x345da2(0x1fc)]-0x1;_0x48aa74>=0x0;_0x48aa74--)if(_0x5769e2=_0x396a56[_0x48aa74])_0x436dc2=(_0x30695c<0x3?_0x5769e2(_0x436dc2):_0x30695c>0x3?_0x5769e2(_0x4ce14d,_0x122718,_0x436dc2):_0x5769e2(_0x4ce14d,_0x122718))||_0x436dc2;}return _0x30695c>0x3&&_0x436dc2&&Object[_0x345da2(0x1c0)](_0x4ce14d,_0x122718,_0x436dc2),_0x436dc2;},__metadata=this&&this['__metadata']||function(_0xcbfe91,_0x2ab63b){const _0x511ce3=_0x4f0487;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x511ce3(0x1bf))return Reflect[_0x511ce3(0x1d4)](_0xcbfe91,_0x2ab63b);},__param=this&&this[_0x4f0487(0x1e8)]||function(_0x198863,_0xf1d595){return function(_0x2f6202,_0x256152){_0xf1d595(_0x2f6202,_0x256152,_0x198863);};};function _0x2e76(_0x579af3,_0x2f7589){const _0x392db7=_0x392d();return _0x2e76=function(_0x2e766f,_0x343b92){_0x2e766f=_0x2e766f-0x1b4;let _0x2716ed=_0x392db7[_0x2e766f];return _0x2716ed;},_0x2e76(_0x579af3,_0x2f7589);}function _0x392d(){const _0x53178e=['验证码已过期','save','BAD_REQUEST','expiresAt','10vcIclN','request','findOne','createVerification','data','function','defineProperty','verifycationEntity','typeorm','verifyCode','VerifycationEntity','359864OVBEDv','../globalConfig/globalConfig.service','验证码错误','decorate','HttpException','log','5rJilQr','验证码不存在','used','1577652rVqsRA','InjectRepository','createdAt','Message','now','Repository','metadata','createRandomCode','sendPhoneCode','./verifycation.entity','del','45562VysUSH','2585133wjdMUi','../../common/constants/status.constant','../redisCache/redisCache.service','21pbPeHk','466926IGOXUy','verifyCaptcha','USED','redisCacheService','确实必要参数错误！','../../common/utils','Code','2232096BScRcd','HttpStatus','ap-beijing','__param','验证码发送失败！','S内不得重新发送','@nestjs/common','图形验证码已过期、请重新输入!','图形验证码错误、请检查填写!','get','__esModule','907230HZWkWu','getQcloudPhoneVerifyConfig','sms','当前验证码已被使用！','SendSms','https://dysmsapi.aliyuncs.com','getPhoneVerifyConfig','getOwnPropertyDescriptor','__decorate','object','2017-05-25','RedisCacheService','length','DESC','v20210111','sms.tencentcloudapi.com','sendPhoneCodeWithQcloud','VerificationService','getTime','getNamespace','globalConfigService','VerificationUseStatusEnum','POST'];_0x392d=function(){return _0x53178e;};return _0x392d();}Object['defineProperty'](exports,_0x4f0487(0x1ef),{'value':!![]}),exports[_0x4f0487(0x201)]=void 0x0;const globalConfig_service_1=require(_0x4f0487(0x1c6)),status_constant_1=require(_0x4f0487(0x1db)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x4f0487(0x1c2)),verifycation_entity_1=require(_0x4f0487(0x1d7)),common_1=require(_0x4f0487(0x1eb)),utils_1=require(_0x4f0487(0x1e3)),redisCache_service_1=require(_0x4f0487(0x1dc)),smsSDK=require('tencentcloud-sdk-nodejs-sms'),Core=require('@alicloud/pop-core'),smsClient=smsSDK[_0x4f0487(0x1f2)][_0x4f0487(0x1fe)]['Client'];let VerificationService=class VerificationService{constructor(_0x157916,_0x12a2b0,_0x29da21){const _0x3eaf5a=_0x4f0487;this[_0x3eaf5a(0x1c1)]=_0x157916,this[_0x3eaf5a(0x204)]=_0x12a2b0,this[_0x3eaf5a(0x1e1)]=_0x29da21;}async[_0x4f0487(0x1bd)](_0x2481a2,_0x244701,_0x564e1e=0x1e*0x3c){const _0x5ef96b=_0x4f0487,_0x4fbc87=await this[_0x5ef96b(0x1c1)][_0x5ef96b(0x1bc)]({'where':{'userId':_0x2481a2['id'],'type':_0x244701},'order':{'createdAt':'DESC'}});if(_0x4fbc87&&_0x4fbc87[_0x5ef96b(0x1d0)][_0x5ef96b(0x202)]()+0x1*0x3c*0x3e8>Date[_0x5ef96b(0x1d2)]()){const _0xcb9c2c=Math['ceil']((_0x4fbc87[_0x5ef96b(0x1d0)][_0x5ef96b(0x202)]()+0x1*0x3c*0x3e8-Date[_0x5ef96b(0x1d2)]())/0x3e8);throw new common_1['HttpException'](_0xcb9c2c+_0x5ef96b(0x1ea),common_1['HttpStatus']['BAD_REQUEST']);}const _0x1f5326=(0x0,utils_1[_0x5ef96b(0x1d5)])(),_0x1eae49=new Date(Date[_0x5ef96b(0x1d2)]()+_0x564e1e*0x3e8),{id:_0x4bef86,email:_0x43c8be}=_0x2481a2,_0x59712b={'userId':_0x4bef86,'type':_0x244701,'code':_0x1f5326,'expiresAt':_0x1eae49,'email':_0x43c8be};return await this[_0x5ef96b(0x1c1)][_0x5ef96b(0x1b7)](_0x59712b);}async[_0x4f0487(0x1c3)]({code:_0xdcc9c9,id:_0x566c2f},_0x3bcfca){const _0x5234e2=_0x4f0487,_0x227053=await this['verifycationEntity']['findOne']({'where':{'id':_0x566c2f,'type':_0x3bcfca},'order':{'createdAt':_0x5234e2(0x1fd)}});if(!_0x227053)throw new common_1[(_0x5234e2(0x1c9))](_0x5234e2(0x1cc),common_1['HttpStatus'][_0x5234e2(0x1b8)]);if(_0x227053['used']===status_constant_1[_0x5234e2(0x1b4)]['USED'])throw new common_1[(_0x5234e2(0x1c9))](_0x5234e2(0x1f3),common_1[_0x5234e2(0x1e6)][_0x5234e2(0x1b8)]);else _0x227053[_0x5234e2(0x1cd)]=status_constant_1[_0x5234e2(0x1b4)][_0x5234e2(0x1e0)],await this['verifycationEntity']['update']({'id':_0x566c2f},_0x227053);if(Number(_0x227053['code'])!==Number(_0xdcc9c9))throw new common_1['HttpException'](_0x5234e2(0x1c7),common_1[_0x5234e2(0x1e6)]['BAD_REQUEST']);if(_0x227053[_0x5234e2(0x1b9)]<new Date())throw new common_1[(_0x5234e2(0x1c9))](_0x5234e2(0x1b6),common_1[_0x5234e2(0x1e6)][_0x5234e2(0x1b8)]);return _0x227053;}async[_0x4f0487(0x1df)](_0x464f21){const _0x106b59=_0x4f0487,{captchaId:_0x2abdf6,captchaCode:_0x3c60c8}=_0x464f21,_0x22a52e=await this[_0x106b59(0x204)][_0x106b59(0x203)](),_0x2609d3=_0x22a52e+':CAPTCHA:'+_0x2abdf6,_0x497420=await this[_0x106b59(0x1e1)][_0x106b59(0x1ee)]({'key':_0x2609d3});await this['redisCacheService'][_0x106b59(0x1d8)]({'key':_0x2609d3});if(!_0x497420)throw new common_1[(_0x106b59(0x1c9))](_0x106b59(0x1ec),common_1['HttpStatus'][_0x106b59(0x1b8)]);if(!_0x497420||_0x497420!==_0x3c60c8)throw new common_1[(_0x106b59(0x1c9))](_0x106b59(0x1ed),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x4f0487(0x1d6)](_0x42b7a1){const _0x1ead58=_0x4f0487;var _0x2df970;const {accessKeyId:_0x88e078,accessKeySecret:_0x102961,SignName:_0x5f07ca,TemplateCode:_0x3e69d9}=await this[_0x1ead58(0x204)][_0x1ead58(0x1f6)](),{phone:_0x386b0b,code:_0x43d2bf}=_0x42b7a1;if(!_0x386b0b||!_0x43d2bf)throw new common_1[(_0x1ead58(0x1c9))](_0x1ead58(0x1e2),common_1[_0x1ead58(0x1e6)][_0x1ead58(0x1b8)]);const _0x288802=new Core({'accessKeyId':_0x88e078,'accessKeySecret':_0x102961,'endpoint':_0x1ead58(0x1f5),'apiVersion':_0x1ead58(0x1fa)}),_0x41da3a={'PhoneNumbers':_0x386b0b,'SignName':_0x5f07ca,'TemplateCode':_0x3e69d9,'TemplateParam':JSON['stringify']({'code':_0x43d2bf})},_0x1488ee={'method':_0x1ead58(0x1b5),'formatParams':![]};try{const _0x3613d1=await _0x288802[_0x1ead58(0x1bb)](_0x1ead58(0x1f4),_0x41da3a,_0x1488ee);if(_0x3613d1[_0x1ead58(0x1e4)]==='OK')return!![];else throw new common_1[(_0x1ead58(0x1c9))](_0x3613d1[_0x1ead58(0x1d1)]||_0x1ead58(0x1e9),common_1['HttpStatus'][_0x1ead58(0x1b8)]);}catch(_0x25f0c3){throw new common_1[(_0x1ead58(0x1c9))](((_0x2df970=_0x25f0c3===null||_0x25f0c3===void 0x0?void 0x0:_0x25f0c3['data'])===null||_0x2df970===void 0x0?void 0x0:_0x2df970[_0x1ead58(0x1d1)])||'验证码发送失败！',common_1[_0x1ead58(0x1e6)][_0x1ead58(0x1b8)]);}}async[_0x4f0487(0x200)](_0x398775){const _0x28edd0=_0x4f0487;var _0x24ca37;const {secretId:_0x1e7a41,secretKey:_0x1256f3,signName:_0x39f0d6,templateId:_0x34df18,sdkAppId:_0x57c540}=await this[_0x28edd0(0x204)][_0x28edd0(0x1f1)](),{phone:_0x390c6a,code:_0x1ccc53}=_0x398775;if(!_0x390c6a||!_0x1ccc53)throw new common_1[(_0x28edd0(0x1c9))](_0x28edd0(0x1e2),common_1[_0x28edd0(0x1e6)]['BAD_REQUEST']);const _0x40a7d3=new smsClient({'credential':{'secretId':_0x1e7a41,'secretKey':_0x1256f3},'region':_0x28edd0(0x1e7),'profile':{'httpProfile':{'endpoint':_0x28edd0(0x1ff)}}}),_0x39e6={'PhoneNumberSet':[_0x390c6a],'SmsSdkAppId':_0x57c540,'TemplateId':_0x34df18,'SignName':_0x39f0d6,'TemplateParamSet':[_0x1ccc53+'','2']};try{const _0x2d243e=await _0x40a7d3[_0x28edd0(0x1f4)](_0x39e6);console[_0x28edd0(0x1ca)](_0x2d243e);}catch(_0x602891){console[_0x28edd0(0x1ca)]('error',_0x602891);throw new common_1[(_0x28edd0(0x1c9))](((_0x24ca37=_0x602891===null||_0x602891===void 0x0?void 0x0:_0x602891[_0x28edd0(0x1be)])===null||_0x24ca37===void 0x0?void 0x0:_0x24ca37[_0x28edd0(0x1d1)])||'验证码发送失败！',common_1[_0x28edd0(0x1e6)][_0x28edd0(0x1b8)]);}}};VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x4f0487(0x1cf)])(verifycation_entity_1[_0x4f0487(0x1c4)])),__metadata('design:paramtypes',[typeorm_2[_0x4f0487(0x1d3)],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x4f0487(0x1fb)]])],VerificationService),exports[_0x4f0487(0x201)]=VerificationService;