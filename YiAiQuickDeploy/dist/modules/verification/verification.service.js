'use strict';const _0x2ee81e=_0x4469;function _0x4469(_0x2465b1,_0x1c955c){const _0xd00a25=_0xd00a();return _0x4469=function(_0x446920,_0x277720){_0x446920=_0x446920-0x68;let _0x24b2f3=_0xd00a25[_0x446920];return _0x24b2f3;},_0x4469(_0x2465b1,_0x1c955c);}(function(_0x469e66,_0x2becf5){const _0x32d4b1=_0x4469,_0x1516b8=_0x469e66();while(!![]){try{const _0x16034c=parseInt(_0x32d4b1(0x7f))/0x1*(parseInt(_0x32d4b1(0x96))/0x2)+-parseInt(_0x32d4b1(0xae))/0x3*(parseInt(_0x32d4b1(0x94))/0x4)+-parseInt(_0x32d4b1(0x71))/0x5+parseInt(_0x32d4b1(0x88))/0x6*(-parseInt(_0x32d4b1(0x68))/0x7)+-parseInt(_0x32d4b1(0x76))/0x8*(-parseInt(_0x32d4b1(0x97))/0x9)+parseInt(_0x32d4b1(0xa1))/0xa+-parseInt(_0x32d4b1(0x85))/0xb;if(_0x16034c===_0x2becf5)break;else _0x1516b8['push'](_0x1516b8['shift']());}catch(_0x12186e){_0x1516b8['push'](_0x1516b8['shift']());}}}(_0xd00a,0x5cd6e));var __decorate=this&&this[_0x2ee81e(0x6d)]||function(_0x3faf69,_0x385fdf,_0x3a3af1,_0x3d532a){const _0x46bf3e=_0x2ee81e;var _0xeb2522=arguments['length'],_0x3aecc9=_0xeb2522<0x3?_0x385fdf:_0x3d532a===null?_0x3d532a=Object['getOwnPropertyDescriptor'](_0x385fdf,_0x3a3af1):_0x3d532a,_0x3c053d;if(typeof Reflect==='object'&&typeof Reflect[_0x46bf3e(0x73)]===_0x46bf3e(0x7b))_0x3aecc9=Reflect[_0x46bf3e(0x73)](_0x3faf69,_0x385fdf,_0x3a3af1,_0x3d532a);else{for(var _0xde9008=_0x3faf69[_0x46bf3e(0xab)]-0x1;_0xde9008>=0x0;_0xde9008--)if(_0x3c053d=_0x3faf69[_0xde9008])_0x3aecc9=(_0xeb2522<0x3?_0x3c053d(_0x3aecc9):_0xeb2522>0x3?_0x3c053d(_0x385fdf,_0x3a3af1,_0x3aecc9):_0x3c053d(_0x385fdf,_0x3a3af1))||_0x3aecc9;}return _0xeb2522>0x3&&_0x3aecc9&&Object['defineProperty'](_0x385fdf,_0x3a3af1,_0x3aecc9),_0x3aecc9;},__metadata=this&&this[_0x2ee81e(0x87)]||function(_0x48eae2,_0x191320){const _0x5ca355=_0x2ee81e;if(typeof Reflect===_0x5ca355(0x86)&&typeof Reflect[_0x5ca355(0x92)]==='function')return Reflect['metadata'](_0x48eae2,_0x191320);},__param=this&&this['__param']||function(_0x4ebaa4,_0x58664d){return function(_0x27053c,_0x336fce){_0x58664d(_0x27053c,_0x336fce,_0x4ebaa4);};};function _0xd00a(){const _0x2afd83=['HttpException','getPhoneVerifyConfig','VerifycationEntity','__decorate','USED','request','DESC','963385SPfAJe','GlobalConfigService','decorate','VerificationUseStatusEnum','VerificationService','1040RyxCpB','../globalConfig/globalConfig.service','get','findOne','验证码已过期','function','POST','Message','https://dysmsapi.aliyuncs.com','62766KIvCuN','@nestjs/typeorm','createVerification','@alicloud/pop-core','Repository','data','96283ZDgbqI','object','__metadata','12TifesC','v20210111','sms','typeorm','验证码发送失败！','globalConfigService','sendPhoneCodeWithQcloud','getQcloudPhoneVerifyConfig','stringify','redisCacheService','metadata','verifycationEntity','1558396BVjpaf','图形验证码错误、请检查填写!','16HRElDj','17181yFlqkr','HttpStatus','log','verifyCaptcha','sendPhoneCode','BAD_REQUEST','ap-beijing','确实必要参数错误！','RedisCacheService','design:paramtypes','5699530taOfvh','defineProperty','code','./verifycation.entity','sms.tencentcloudapi.com','../../common/constants/status.constant','getNamespace','createdAt','InjectRepository','../../common/utils','length','S内不得重新发送','createRandomCode','3FbKPZR','verifyCode','../redisCache/redisCache.service','del','getTime','save','1221332CKYpWr','Injectable'];_0xd00a=function(){return _0x2afd83;};return _0xd00a();}Object[_0x2ee81e(0xa2)](exports,'__esModule',{'value':!![]}),exports[_0x2ee81e(0x75)]=void 0x0;const globalConfig_service_1=require(_0x2ee81e(0x77)),status_constant_1=require(_0x2ee81e(0xa6)),typeorm_1=require(_0x2ee81e(0x80)),typeorm_2=require(_0x2ee81e(0x8b)),verifycation_entity_1=require(_0x2ee81e(0xa4)),common_1=require('@nestjs/common'),utils_1=require(_0x2ee81e(0xaa)),redisCache_service_1=require(_0x2ee81e(0xb0)),smsSDK=require('tencentcloud-sdk-nodejs-sms'),Core=require(_0x2ee81e(0x82)),smsClient=smsSDK[_0x2ee81e(0x8a)][_0x2ee81e(0x89)]['Client'];let VerificationService=class VerificationService{constructor(_0x43731a,_0x560d7a,_0x2cb1e9){const _0x75da7f=_0x2ee81e;this['verifycationEntity']=_0x43731a,this[_0x75da7f(0x8d)]=_0x560d7a,this[_0x75da7f(0x91)]=_0x2cb1e9;}async[_0x2ee81e(0x81)](_0xc1b2e3,_0x2d2a1c,_0x2eb49a=0x1e*0x3c){const _0x4b03cd=_0x2ee81e,_0x152b6c=await this[_0x4b03cd(0x93)][_0x4b03cd(0x79)]({'where':{'userId':_0xc1b2e3['id'],'type':_0x2d2a1c},'order':{'createdAt':'DESC'}});if(_0x152b6c&&_0x152b6c['createdAt'][_0x4b03cd(0xb2)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x1510c9=Math['ceil']((_0x152b6c[_0x4b03cd(0xa8)][_0x4b03cd(0xb2)]()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1['HttpException'](_0x1510c9+_0x4b03cd(0xac),common_1['HttpStatus']['BAD_REQUEST']);}const _0x49f65a=(0x0,utils_1[_0x4b03cd(0xad)])(),_0x149e5a=new Date(Date['now']()+_0x2eb49a*0x3e8),{id:_0x29add7,email:_0x54703e}=_0xc1b2e3,_0x2cb948={'userId':_0x29add7,'type':_0x2d2a1c,'code':_0x49f65a,'expiresAt':_0x149e5a,'email':_0x54703e};return await this[_0x4b03cd(0x93)][_0x4b03cd(0xb3)](_0x2cb948);}async[_0x2ee81e(0xaf)]({code:_0x22709f,id:_0x28a65b},_0x46c139){const _0xecce=_0x2ee81e,_0x291b0c=await this[_0xecce(0x93)]['findOne']({'where':{'id':_0x28a65b,'type':_0x46c139},'order':{'createdAt':_0xecce(0x70)}});if(!_0x291b0c)throw new common_1[(_0xecce(0x6a))]('验证码不存在',common_1['HttpStatus'][_0xecce(0x9c)]);if(_0x291b0c['used']===status_constant_1[_0xecce(0x74)]['USED'])throw new common_1['HttpException']('当前验证码已被使用！',common_1['HttpStatus']['BAD_REQUEST']);else _0x291b0c['used']=status_constant_1[_0xecce(0x74)][_0xecce(0x6e)],await this[_0xecce(0x93)]['update']({'id':_0x28a65b},_0x291b0c);if(Number(_0x291b0c[_0xecce(0xa3)])!==Number(_0x22709f))throw new common_1[(_0xecce(0x6a))]('验证码错误',common_1[_0xecce(0x98)]['BAD_REQUEST']);if(_0x291b0c['expiresAt']<new Date())throw new common_1[(_0xecce(0x6a))](_0xecce(0x7a),common_1[_0xecce(0x98)][_0xecce(0x9c)]);return _0x291b0c;}async[_0x2ee81e(0x9a)](_0x5e84cb){const _0x1fa697=_0x2ee81e,{captchaId:_0x1fa451,captchaCode:_0x165c5b}=_0x5e84cb,_0x285bb7=await this[_0x1fa697(0x8d)][_0x1fa697(0xa7)](),_0x2b684d=_0x285bb7+':CAPTCHA:'+_0x1fa451,_0x4d1589=await this[_0x1fa697(0x91)][_0x1fa697(0x78)]({'key':_0x2b684d});await this[_0x1fa697(0x91)][_0x1fa697(0xb1)]({'key':_0x2b684d});if(!_0x4d1589)throw new common_1[(_0x1fa697(0x6a))]('图形验证码已过期、请重新输入!',common_1[_0x1fa697(0x98)][_0x1fa697(0x9c)]);if(!_0x4d1589||_0x4d1589!==_0x165c5b)throw new common_1[(_0x1fa697(0x6a))](_0x1fa697(0x95),common_1[_0x1fa697(0x98)][_0x1fa697(0x9c)]);}async[_0x2ee81e(0x9b)](_0x326331){const _0x4862c4=_0x2ee81e;var _0x204d30;const {accessKeyId:_0x368545,accessKeySecret:_0xdc39ca,SignName:_0x13f1b9,TemplateCode:_0x5805d7}=await this[_0x4862c4(0x8d)][_0x4862c4(0x6b)](),{phone:_0x59c079,code:_0x54e655}=_0x326331;if(!_0x59c079||!_0x54e655)throw new common_1[(_0x4862c4(0x6a))](_0x4862c4(0x9e),common_1['HttpStatus'][_0x4862c4(0x9c)]);const _0x2678b2=new Core({'accessKeyId':_0x368545,'accessKeySecret':_0xdc39ca,'endpoint':_0x4862c4(0x7e),'apiVersion':'2017-05-25'}),_0x1f85c9={'PhoneNumbers':_0x59c079,'SignName':_0x13f1b9,'TemplateCode':_0x5805d7,'TemplateParam':JSON[_0x4862c4(0x90)]({'code':_0x54e655})},_0x497c08={'method':_0x4862c4(0x7c),'formatParams':![]};try{const _0x4831aa=await _0x2678b2[_0x4862c4(0x6f)]('SendSms',_0x1f85c9,_0x497c08);if(_0x4831aa['Code']==='OK')return!![];else throw new common_1[(_0x4862c4(0x6a))](_0x4831aa[_0x4862c4(0x7d)]||_0x4862c4(0x8c),common_1[_0x4862c4(0x98)][_0x4862c4(0x9c)]);}catch(_0x20ae6a){throw new common_1[(_0x4862c4(0x6a))](((_0x204d30=_0x20ae6a===null||_0x20ae6a===void 0x0?void 0x0:_0x20ae6a[_0x4862c4(0x84)])===null||_0x204d30===void 0x0?void 0x0:_0x204d30['Message'])||_0x4862c4(0x8c),common_1[_0x4862c4(0x98)][_0x4862c4(0x9c)]);}}async[_0x2ee81e(0x8e)](_0x5e5809){const _0x14a7e7=_0x2ee81e;var _0x3708f6;const {secretId:_0x346eda,secretKey:_0xf39681,signName:_0x3150bd,templateId:_0x4d543a,sdkAppId:_0x1ad6f9}=await this[_0x14a7e7(0x8d)][_0x14a7e7(0x8f)](),{phone:_0x5ae62d,code:_0xd5e088}=_0x5e5809;if(!_0x5ae62d||!_0xd5e088)throw new common_1[(_0x14a7e7(0x6a))](_0x14a7e7(0x9e),common_1[_0x14a7e7(0x98)][_0x14a7e7(0x9c)]);const _0x1c593e=new smsClient({'credential':{'secretId':_0x346eda,'secretKey':_0xf39681},'region':_0x14a7e7(0x9d),'profile':{'httpProfile':{'endpoint':_0x14a7e7(0xa5)}}}),_0xa44d86={'PhoneNumberSet':[_0x5ae62d],'SmsSdkAppId':_0x1ad6f9,'TemplateId':_0x4d543a,'SignName':_0x3150bd,'TemplateParamSet':[_0xd5e088+'','2']};try{const _0x10fa99=await _0x1c593e['SendSms'](_0xa44d86);console[_0x14a7e7(0x99)](_0x10fa99);}catch(_0x241ea5){console[_0x14a7e7(0x99)]('error',_0x241ea5);throw new common_1[(_0x14a7e7(0x6a))](((_0x3708f6=_0x241ea5===null||_0x241ea5===void 0x0?void 0x0:_0x241ea5[_0x14a7e7(0x84)])===null||_0x3708f6===void 0x0?void 0x0:_0x3708f6[_0x14a7e7(0x7d)])||_0x14a7e7(0x8c),common_1['HttpStatus'][_0x14a7e7(0x9c)]);}}};VerificationService=__decorate([(0x0,common_1[_0x2ee81e(0x69)])(),__param(0x0,(0x0,typeorm_1[_0x2ee81e(0xa9)])(verifycation_entity_1[_0x2ee81e(0x6c)])),__metadata(_0x2ee81e(0xa0),[typeorm_2[_0x2ee81e(0x83)],globalConfig_service_1[_0x2ee81e(0x72)],redisCache_service_1[_0x2ee81e(0x9f)]])],VerificationService),exports[_0x2ee81e(0x75)]=VerificationService;