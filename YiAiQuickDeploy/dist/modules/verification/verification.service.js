'use strict';const _0xc8e76=_0x4b98;function _0x4b98(_0x3d955f,_0x1fa33e){const _0x158cad=_0x158c();return _0x4b98=function(_0x4b98be,_0x5e40e2){_0x4b98be=_0x4b98be-0x8c;let _0x245154=_0x158cad[_0x4b98be];return _0x245154;},_0x4b98(_0x3d955f,_0x1fa33e);}(function(_0x56594c,_0x37a527){const _0x2d9813=_0x4b98,_0x5cc295=_0x56594c();while(!![]){try{const _0x457690=parseInt(_0x2d9813(0x93))/0x1+parseInt(_0x2d9813(0x92))/0x2*(parseInt(_0x2d9813(0xbe))/0x3)+-parseInt(_0x2d9813(0x97))/0x4+parseInt(_0x2d9813(0xbc))/0x5*(-parseInt(_0x2d9813(0xcf))/0x6)+-parseInt(_0x2d9813(0x98))/0x7+parseInt(_0x2d9813(0xad))/0x8*(-parseInt(_0x2d9813(0xc1))/0x9)+parseInt(_0x2d9813(0x8c))/0xa*(parseInt(_0x2d9813(0xbb))/0xb);if(_0x457690===_0x37a527)break;else _0x5cc295['push'](_0x5cc295['shift']());}catch(_0x29fd2d){_0x5cc295['push'](_0x5cc295['shift']());}}}(_0x158c,0x77c0e));var __decorate=this&&this[_0xc8e76(0xb2)]||function(_0x33688d,_0x3c5e15,_0x4238f9,_0x5a2115){const _0x243490=_0xc8e76;var _0x5452ef=arguments[_0x243490(0xd5)],_0x25673d=_0x5452ef<0x3?_0x3c5e15:_0x5a2115===null?_0x5a2115=Object[_0x243490(0x9e)](_0x3c5e15,_0x4238f9):_0x5a2115,_0x1cab5b;if(typeof Reflect==='object'&&typeof Reflect[_0x243490(0xdb)]===_0x243490(0xc3))_0x25673d=Reflect['decorate'](_0x33688d,_0x3c5e15,_0x4238f9,_0x5a2115);else{for(var _0x130f6f=_0x33688d[_0x243490(0xd5)]-0x1;_0x130f6f>=0x0;_0x130f6f--)if(_0x1cab5b=_0x33688d[_0x130f6f])_0x25673d=(_0x5452ef<0x3?_0x1cab5b(_0x25673d):_0x5452ef>0x3?_0x1cab5b(_0x3c5e15,_0x4238f9,_0x25673d):_0x1cab5b(_0x3c5e15,_0x4238f9))||_0x25673d;}return _0x5452ef>0x3&&_0x25673d&&Object[_0x243490(0xd9)](_0x3c5e15,_0x4238f9,_0x25673d),_0x25673d;},__metadata=this&&this[_0xc8e76(0xb8)]||function(_0x3dd1b9,_0x4a1550){const _0x2ac046=_0xc8e76;if(typeof Reflect===_0x2ac046(0xd0)&&typeof Reflect[_0x2ac046(0x9c)]==='function')return Reflect[_0x2ac046(0x9c)](_0x3dd1b9,_0x4a1550);},__param=this&&this['__param']||function(_0x7852bd,_0x3ba61a){return function(_0x3e1ca4,_0x25a64b){_0x3ba61a(_0x3e1ca4,_0x25a64b,_0x7852bd);};};Object['defineProperty'](exports,_0xc8e76(0xa5),{'value':!![]}),exports[_0xc8e76(0xba)]=void 0x0;function _0x158c(){const _0x21642f=['redisCacheService','sendPhoneCode','update','VerificationUseStatusEnum','25224Oaaiqm','VerifycationEntity','ap-beijing','2017-05-25','verifyCode','__decorate','tencentcloud-sdk-nodejs-sms','../../common/utils','InjectRepository','save','确实必要参数错误！','__metadata','v20210111','VerificationService','246664aeRqFM','130uniHlk','HttpException','194871xRwwdL','globalConfigService','getTime','738iBHEdX','@nestjs/common','function','verifycationEntity','SendSms','createVerification','RedisCacheService','sms.tencentcloudapi.com','验证码发送失败！','data','HttpStatus','BAD_REQUEST','当前验证码已被使用！',':CAPTCHA:','12084uasIzu','object','POST','图形验证码已过期、请重新输入!','../../common/constants/status.constant','@alicloud/pop-core','length','log','now','验证码错误','defineProperty','stringify','decorate','1030FUgkoc','expiresAt','Message','getPhoneVerifyConfig','验证码已过期','GlobalConfigService','4EYkszZ','157535elcxZb','../redisCache/redisCache.service','findOne','design:paramtypes','3283440sGCktK','6823887KZnvnl','getNamespace','../globalConfig/globalConfig.service','Injectable','metadata','图形验证码错误、请检查填写!','getOwnPropertyDescriptor','S内不得重新发送','sms','createdAt','used','USED','DESC','__esModule','typeorm','./verifycation.entity','@nestjs/typeorm'];_0x158c=function(){return _0x21642f;};return _0x158c();}const globalConfig_service_1=require(_0xc8e76(0x9a)),status_constant_1=require(_0xc8e76(0xd3)),typeorm_1=require(_0xc8e76(0xa8)),typeorm_2=require(_0xc8e76(0xa6)),verifycation_entity_1=require(_0xc8e76(0xa7)),common_1=require(_0xc8e76(0xc2)),utils_1=require(_0xc8e76(0xb4)),redisCache_service_1=require(_0xc8e76(0x94)),smsSDK=require(_0xc8e76(0xb3)),Core=require(_0xc8e76(0xd4)),smsClient=smsSDK[_0xc8e76(0xa0)][_0xc8e76(0xb9)]['Client'];let VerificationService=class VerificationService{constructor(_0x1414fa,_0x53eb11,_0x195e13){const _0x5b1a0a=_0xc8e76;this['verifycationEntity']=_0x1414fa,this[_0x5b1a0a(0xbf)]=_0x53eb11,this[_0x5b1a0a(0xa9)]=_0x195e13;}async[_0xc8e76(0xc6)](_0x21a990,_0x1b7259,_0x2d194a=0x1e*0x3c){const _0x242468=_0xc8e76,_0x5b9afb=await this[_0x242468(0xc4)][_0x242468(0x95)]({'where':{'userId':_0x21a990['id'],'type':_0x1b7259},'order':{'createdAt':'DESC'}});if(_0x5b9afb&&_0x5b9afb[_0x242468(0xa1)][_0x242468(0xc0)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x2dee6f=Math['ceil']((_0x5b9afb['createdAt'][_0x242468(0xc0)]()+0x1*0x3c*0x3e8-Date[_0x242468(0xd7)]())/0x3e8);throw new common_1['HttpException'](_0x2dee6f+_0x242468(0x9f),common_1[_0x242468(0xcb)][_0x242468(0xcc)]);}const _0x50c9cc=(0x0,utils_1['createRandomCode'])(),_0x52b3be=new Date(Date[_0x242468(0xd7)]()+_0x2d194a*0x3e8),{id:_0xdfe7dd,email:_0xe4cbd5}=_0x21a990,_0x52d371={'userId':_0xdfe7dd,'type':_0x1b7259,'code':_0x50c9cc,'expiresAt':_0x52b3be,'email':_0xe4cbd5};return await this['verifycationEntity'][_0x242468(0xb6)](_0x52d371);}async[_0xc8e76(0xb1)]({code:_0x38d6cb,id:_0x124bce},_0x408aa3){const _0x301c6a=_0xc8e76,_0x1705f1=await this[_0x301c6a(0xc4)][_0x301c6a(0x95)]({'where':{'id':_0x124bce,'type':_0x408aa3},'order':{'createdAt':_0x301c6a(0xa4)}});if(!_0x1705f1)throw new common_1['HttpException']('验证码不存在',common_1[_0x301c6a(0xcb)][_0x301c6a(0xcc)]);if(_0x1705f1[_0x301c6a(0xa2)]===status_constant_1[_0x301c6a(0xac)][_0x301c6a(0xa3)])throw new common_1[(_0x301c6a(0xbd))](_0x301c6a(0xcd),common_1[_0x301c6a(0xcb)][_0x301c6a(0xcc)]);else _0x1705f1[_0x301c6a(0xa2)]=status_constant_1[_0x301c6a(0xac)][_0x301c6a(0xa3)],await this[_0x301c6a(0xc4)][_0x301c6a(0xab)]({'id':_0x124bce},_0x1705f1);if(Number(_0x1705f1['code'])!==Number(_0x38d6cb))throw new common_1[(_0x301c6a(0xbd))](_0x301c6a(0xd8),common_1['HttpStatus']['BAD_REQUEST']);if(_0x1705f1[_0x301c6a(0x8d)]<new Date())throw new common_1[(_0x301c6a(0xbd))](_0x301c6a(0x90),common_1[_0x301c6a(0xcb)][_0x301c6a(0xcc)]);return _0x1705f1;}async['verifyCaptcha'](_0x4a24c7){const _0x3de155=_0xc8e76,{captchaId:_0x3d5550,captchaCode:_0x241820}=_0x4a24c7,_0x3db785=await this['globalConfigService'][_0x3de155(0x99)](),_0x3fdad9=_0x3db785+_0x3de155(0xce)+_0x3d5550,_0x147c75=await this['redisCacheService']['get']({'key':_0x3fdad9});await this[_0x3de155(0xa9)]['del']({'key':_0x3fdad9});if(!_0x147c75)throw new common_1[(_0x3de155(0xbd))](_0x3de155(0xd2),common_1[_0x3de155(0xcb)]['BAD_REQUEST']);if(!_0x147c75||_0x147c75!==_0x241820)throw new common_1[(_0x3de155(0xbd))](_0x3de155(0x9d),common_1[_0x3de155(0xcb)][_0x3de155(0xcc)]);}async[_0xc8e76(0xaa)](_0x1f383d){const _0xdb50da=_0xc8e76;var _0x4f164b;const {accessKeyId:_0x523d6d,accessKeySecret:_0x4ab630,SignName:_0x402b15,TemplateCode:_0x4c0242}=await this[_0xdb50da(0xbf)][_0xdb50da(0x8f)](),{phone:_0x25bdb9,code:_0x1c9f6d}=_0x1f383d;if(!_0x25bdb9||!_0x1c9f6d)throw new common_1[(_0xdb50da(0xbd))](_0xdb50da(0xb7),common_1[_0xdb50da(0xcb)][_0xdb50da(0xcc)]);const _0x4df0f2=new Core({'accessKeyId':_0x523d6d,'accessKeySecret':_0x4ab630,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0xdb50da(0xb0)}),_0xc9f3df={'PhoneNumbers':_0x25bdb9,'SignName':_0x402b15,'TemplateCode':_0x4c0242,'TemplateParam':JSON[_0xdb50da(0xda)]({'code':_0x1c9f6d})},_0x211b4f={'method':_0xdb50da(0xd1),'formatParams':![]};try{const _0x494f02=await _0x4df0f2['request'](_0xdb50da(0xc5),_0xc9f3df,_0x211b4f);if(_0x494f02['Code']==='OK')return!![];else throw new common_1[(_0xdb50da(0xbd))](_0x494f02['Message']||'验证码发送失败！',common_1[_0xdb50da(0xcb)][_0xdb50da(0xcc)]);}catch(_0x5de22b){throw new common_1[(_0xdb50da(0xbd))](((_0x4f164b=_0x5de22b===null||_0x5de22b===void 0x0?void 0x0:_0x5de22b[_0xdb50da(0xca)])===null||_0x4f164b===void 0x0?void 0x0:_0x4f164b[_0xdb50da(0x8e)])||'验证码发送失败！',common_1[_0xdb50da(0xcb)][_0xdb50da(0xcc)]);}}async['sendPhoneCodeWithQcloud'](_0x15cd1f){const _0x53d465=_0xc8e76;var _0x272a4d;const {secretId:_0x4fa3e4,secretKey:_0x33230d,signName:_0x32c403,templateId:_0xce5d6,sdkAppId:_0x54b436}=await this[_0x53d465(0xbf)]['getQcloudPhoneVerifyConfig'](),{phone:_0x2dc468,code:_0xda1819}=_0x15cd1f;if(!_0x2dc468||!_0xda1819)throw new common_1['HttpException'](_0x53d465(0xb7),common_1[_0x53d465(0xcb)][_0x53d465(0xcc)]);const _0x595968=new smsClient({'credential':{'secretId':_0x4fa3e4,'secretKey':_0x33230d},'region':_0x53d465(0xaf),'profile':{'httpProfile':{'endpoint':_0x53d465(0xc8)}}}),_0x5aaaef={'PhoneNumberSet':[_0x2dc468],'SmsSdkAppId':_0x54b436,'TemplateId':_0xce5d6,'SignName':_0x32c403,'TemplateParamSet':[_0xda1819+'','2']};try{const _0x18d890=await _0x595968[_0x53d465(0xc5)](_0x5aaaef);console[_0x53d465(0xd6)](_0x18d890);}catch(_0x256b37){console['log']('error',_0x256b37);throw new common_1['HttpException'](((_0x272a4d=_0x256b37===null||_0x256b37===void 0x0?void 0x0:_0x256b37[_0x53d465(0xca)])===null||_0x272a4d===void 0x0?void 0x0:_0x272a4d['Message'])||_0x53d465(0xc9),common_1[_0x53d465(0xcb)][_0x53d465(0xcc)]);}}};VerificationService=__decorate([(0x0,common_1[_0xc8e76(0x9b)])(),__param(0x0,(0x0,typeorm_1[_0xc8e76(0xb5)])(verifycation_entity_1[_0xc8e76(0xae)])),__metadata(_0xc8e76(0x96),[typeorm_2['Repository'],globalConfig_service_1[_0xc8e76(0x91)],redisCache_service_1[_0xc8e76(0xc7)]])],VerificationService),exports[_0xc8e76(0xba)]=VerificationService;