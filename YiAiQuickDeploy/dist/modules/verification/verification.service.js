'use strict';const _0x3786bd=_0x2dd1;(function(_0x48fc55,_0x580396){const _0x5bc979=_0x2dd1,_0x16d02f=_0x48fc55();while(!![]){try{const _0x2548e4=parseInt(_0x5bc979(0x1ca))/0x1+-parseInt(_0x5bc979(0x1e3))/0x2*(-parseInt(_0x5bc979(0x1cc))/0x3)+parseInt(_0x5bc979(0x1dd))/0x4+-parseInt(_0x5bc979(0x1b9))/0x5*(-parseInt(_0x5bc979(0x1d8))/0x6)+parseInt(_0x5bc979(0x1ae))/0x7*(-parseInt(_0x5bc979(0x1d5))/0x8)+-parseInt(_0x5bc979(0x1e2))/0x9+-parseInt(_0x5bc979(0x1e4))/0xa*(parseInt(_0x5bc979(0x1e5))/0xb);if(_0x2548e4===_0x580396)break;else _0x16d02f['push'](_0x16d02f['shift']());}catch(_0x15117e){_0x16d02f['push'](_0x16d02f['shift']());}}}(_0x2146,0x8d2e6));var __decorate=this&&this[_0x3786bd(0x1b2)]||function(_0x6c8463,_0x15e8e0,_0x183d4a,_0x2d8525){const _0x33c2cb=_0x3786bd;var _0x4d01ae=arguments[_0x33c2cb(0x1cd)],_0x440007=_0x4d01ae<0x3?_0x15e8e0:_0x2d8525===null?_0x2d8525=Object[_0x33c2cb(0x1df)](_0x15e8e0,_0x183d4a):_0x2d8525,_0x153dc2;if(typeof Reflect==='object'&&typeof Reflect[_0x33c2cb(0x1f8)]===_0x33c2cb(0x1f1))_0x440007=Reflect[_0x33c2cb(0x1f8)](_0x6c8463,_0x15e8e0,_0x183d4a,_0x2d8525);else{for(var _0x30075d=_0x6c8463['length']-0x1;_0x30075d>=0x0;_0x30075d--)if(_0x153dc2=_0x6c8463[_0x30075d])_0x440007=(_0x4d01ae<0x3?_0x153dc2(_0x440007):_0x4d01ae>0x3?_0x153dc2(_0x15e8e0,_0x183d4a,_0x440007):_0x153dc2(_0x15e8e0,_0x183d4a))||_0x440007;}return _0x4d01ae>0x3&&_0x440007&&Object[_0x33c2cb(0x1b1)](_0x15e8e0,_0x183d4a,_0x440007),_0x440007;},__metadata=this&&this[_0x3786bd(0x1ad)]||function(_0x2cbe40,_0x100a17){const _0x40b49c=_0x3786bd;if(typeof Reflect===_0x40b49c(0x1db)&&typeof Reflect[_0x40b49c(0x1e1)]===_0x40b49c(0x1f1))return Reflect[_0x40b49c(0x1e1)](_0x2cbe40,_0x100a17);},__param=this&&this[_0x3786bd(0x1b0)]||function(_0x36b7d7,_0x5e132e){return function(_0x41f83b,_0x3aa5f9){_0x5e132e(_0x41f83b,_0x3aa5f9,_0x36b7d7);};};Object[_0x3786bd(0x1b1)](exports,_0x3786bd(0x1aa),{'value':!![]}),exports[_0x3786bd(0x1f5)]=void 0x0;function _0x2dd1(_0x29176b,_0x3eb0b6){const _0x2146ed=_0x2146();return _0x2dd1=function(_0x2dd1bf,_0x3fcf5e){_0x2dd1bf=_0x2dd1bf-0x1a5;let _0xb6dbad=_0x2146ed[_0x2dd1bf];return _0xb6dbad;},_0x2dd1(_0x29176b,_0x3eb0b6);}const globalConfig_service_1=require(_0x3786bd(0x1c6)),status_constant_1=require(_0x3786bd(0x1f6)),typeorm_1=require(_0x3786bd(0x1d3)),typeorm_2=require(_0x3786bd(0x1f9)),verifycation_entity_1=require(_0x3786bd(0x1ec)),common_1=require(_0x3786bd(0x1c5)),utils_1=require(_0x3786bd(0x1b5)),redisCache_service_1=require(_0x3786bd(0x1c2)),smsSDK=require(_0x3786bd(0x1de)),Core=require(_0x3786bd(0x1d4)),smsClient=smsSDK[_0x3786bd(0x1da)][_0x3786bd(0x1ee)][_0x3786bd(0x1ac)];let VerificationService=class VerificationService{constructor(_0x54b2d6,_0x3c9d05,_0x2f683b){const _0x31d0d5=_0x3786bd;this[_0x31d0d5(0x1d7)]=_0x54b2d6,this[_0x31d0d5(0x1f4)]=_0x3c9d05,this[_0x31d0d5(0x1d6)]=_0x2f683b;}async['createVerification'](_0x5abfa7,_0xc69f10,_0x3ca2f9=0x1e*0x3c){const _0xfce1fd=_0x3786bd,_0x416f4d=await this[_0xfce1fd(0x1d7)][_0xfce1fd(0x1d0)]({'where':{'userId':_0x5abfa7['id'],'type':_0xc69f10},'order':{'createdAt':_0xfce1fd(0x1f2)}});if(_0x416f4d&&_0x416f4d[_0xfce1fd(0x1cb)][_0xfce1fd(0x1af)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x31143f=Math[_0xfce1fd(0x1be)]((_0x416f4d[_0xfce1fd(0x1cb)][_0xfce1fd(0x1af)]()+0x1*0x3c*0x3e8-Date[_0xfce1fd(0x1b6)]())/0x3e8);throw new common_1['HttpException'](_0x31143f+'S内不得重新发送',common_1[_0xfce1fd(0x1c0)][_0xfce1fd(0x1b8)]);}const _0x575cd7=(0x0,utils_1[_0xfce1fd(0x1bf)])(),_0x57e184=new Date(Date[_0xfce1fd(0x1b6)]()+_0x3ca2f9*0x3e8),{id:_0xb08909,email:_0x3d9707}=_0x5abfa7,_0x3ec067={'userId':_0xb08909,'type':_0xc69f10,'code':_0x575cd7,'expiresAt':_0x57e184,'email':_0x3d9707};return await this[_0xfce1fd(0x1d7)][_0xfce1fd(0x1bc)](_0x3ec067);}async[_0x3786bd(0x1e0)]({code:_0x115bac,id:_0x47ce23},_0x51ecac){const _0x14aa67=_0x3786bd,_0x3a72f6=await this['verifycationEntity'][_0x14aa67(0x1d0)]({'where':{'id':_0x47ce23,'type':_0x51ecac},'order':{'createdAt':_0x14aa67(0x1f2)}});if(!_0x3a72f6)throw new common_1['HttpException'](_0x14aa67(0x1e6),common_1[_0x14aa67(0x1c0)]['BAD_REQUEST']);if(_0x3a72f6[_0x14aa67(0x1c4)]===status_constant_1['VerificationUseStatusEnum']['USED'])throw new common_1[(_0x14aa67(0x1b7))](_0x14aa67(0x1c3),common_1[_0x14aa67(0x1c0)][_0x14aa67(0x1b8)]);else _0x3a72f6[_0x14aa67(0x1c4)]=status_constant_1['VerificationUseStatusEnum'][_0x14aa67(0x1d9)],await this[_0x14aa67(0x1d7)][_0x14aa67(0x1ba)]({'id':_0x47ce23},_0x3a72f6);if(Number(_0x3a72f6[_0x14aa67(0x1eb)])!==Number(_0x115bac))throw new common_1['HttpException'](_0x14aa67(0x1ea),common_1['HttpStatus'][_0x14aa67(0x1b8)]);if(_0x3a72f6[_0x14aa67(0x1f3)]<new Date())throw new common_1[(_0x14aa67(0x1b7))]('验证码已过期',common_1[_0x14aa67(0x1c0)]['BAD_REQUEST']);return _0x3a72f6;}async[_0x3786bd(0x1c7)](_0x1afbb0){const _0x44a23b=_0x3786bd,{captchaId:_0x1d9c34,captchaCode:_0xfc186f}=_0x1afbb0,_0x410c1d=await this['globalConfigService']['getNamespace'](),_0x4765c8=_0x410c1d+_0x44a23b(0x1b3)+_0x1d9c34,_0x574bc9=await this[_0x44a23b(0x1d6)][_0x44a23b(0x1bd)]({'key':_0x4765c8});await this['redisCacheService']['del']({'key':_0x4765c8});if(!_0x574bc9)throw new common_1['HttpException'](_0x44a23b(0x1d2),common_1[_0x44a23b(0x1c0)][_0x44a23b(0x1b8)]);if(!_0x574bc9||_0x574bc9!==_0xfc186f)throw new common_1[(_0x44a23b(0x1b7))](_0x44a23b(0x1a8),common_1[_0x44a23b(0x1c0)][_0x44a23b(0x1b8)]);}async['sendPhoneCode'](_0x35de83){const _0x3dff72=_0x3786bd;var _0x29ef47;const {accessKeyId:_0x17ed96,accessKeySecret:_0x135dea,SignName:_0x339a46,TemplateCode:_0x39a6c3}=await this[_0x3dff72(0x1f4)]['getPhoneVerifyConfig'](),{phone:_0xef145,code:_0x10aa9b}=_0x35de83;if(!_0xef145||!_0x10aa9b)throw new common_1[(_0x3dff72(0x1b7))](_0x3dff72(0x1a9),common_1[_0x3dff72(0x1c0)][_0x3dff72(0x1b8)]);const _0x1a660e=new Core({'accessKeyId':_0x17ed96,'accessKeySecret':_0x135dea,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0x3dff72(0x1ef)}),_0x5a7cc6={'PhoneNumbers':_0xef145,'SignName':_0x339a46,'TemplateCode':_0x39a6c3,'TemplateParam':JSON['stringify']({'code':_0x10aa9b})},_0x4d9b5e={'method':_0x3dff72(0x1ab),'formatParams':![]};try{const _0x281991=await _0x1a660e[_0x3dff72(0x1f0)](_0x3dff72(0x1e8),_0x5a7cc6,_0x4d9b5e);if(_0x281991['Code']==='OK')return!![];else throw new common_1[(_0x3dff72(0x1b7))](_0x281991[_0x3dff72(0x1c9)]||_0x3dff72(0x1a6),common_1[_0x3dff72(0x1c0)][_0x3dff72(0x1b8)]);}catch(_0x406c11){throw new common_1[(_0x3dff72(0x1b7))](((_0x29ef47=_0x406c11===null||_0x406c11===void 0x0?void 0x0:_0x406c11[_0x3dff72(0x1a5)])===null||_0x29ef47===void 0x0?void 0x0:_0x29ef47[_0x3dff72(0x1c9)])||_0x3dff72(0x1a6),common_1[_0x3dff72(0x1c0)][_0x3dff72(0x1b8)]);}}async[_0x3786bd(0x1a7)](_0x486538){const _0x397566=_0x3786bd;var _0x19bcb0;const {secretId:_0x1549ad,secretKey:_0x1ed099,signName:_0x292743,templateId:_0x367620,sdkAppId:_0x1197b2}=await this[_0x397566(0x1f4)][_0x397566(0x1dc)](),{phone:_0x19b527,code:_0x53c974}=_0x486538;if(!_0x19b527||!_0x53c974)throw new common_1[(_0x397566(0x1b7))](_0x397566(0x1a9),common_1[_0x397566(0x1c0)][_0x397566(0x1b8)]);const _0x3f8b0a=new smsClient({'credential':{'secretId':_0x1549ad,'secretKey':_0x1ed099},'region':_0x397566(0x1e9),'profile':{'httpProfile':{'endpoint':_0x397566(0x1bb)}}}),_0x4a51e0={'PhoneNumberSet':[_0x19b527],'SmsSdkAppId':_0x1197b2,'TemplateId':_0x367620,'SignName':_0x292743,'TemplateParamSet':[_0x53c974+'','2']};try{const _0xe5ec1b=await _0x3f8b0a['SendSms'](_0x4a51e0);console[_0x397566(0x1ed)](_0xe5ec1b);}catch(_0x284fb5){console[_0x397566(0x1ed)](_0x397566(0x1c1),_0x284fb5);throw new common_1[(_0x397566(0x1b7))](((_0x19bcb0=_0x284fb5===null||_0x284fb5===void 0x0?void 0x0:_0x284fb5[_0x397566(0x1a5)])===null||_0x19bcb0===void 0x0?void 0x0:_0x19bcb0[_0x397566(0x1c9)])||_0x397566(0x1a6),common_1[_0x397566(0x1c0)][_0x397566(0x1b8)]);}}};function _0x2146(){const _0x8e3765=['redisCacheService','verifycationEntity','30lQpdFl','USED','sms','object','getQcloudPhoneVerifyConfig','140824tykyle','tencentcloud-sdk-nodejs-sms','getOwnPropertyDescriptor','verifyCode','metadata','6276033uspgwD','1119122gpLIDF','520bIkgft','78485pLKrQv','验证码不存在','RedisCacheService','SendSms','ap-beijing','验证码错误','code','./verifycation.entity','log','v20210111','2017-05-25','request','function','DESC','expiresAt','globalConfigService','VerificationService','../../common/constants/status.constant','InjectRepository','decorate','typeorm','data','验证码发送失败！','sendPhoneCodeWithQcloud','图形验证码错误、请检查填写!','确实必要参数错误！','__esModule','POST','Client','__metadata','1196377ETmdGL','getTime','__param','defineProperty','__decorate',':CAPTCHA:','Repository','../../common/utils','now','HttpException','BAD_REQUEST','821735nXgeaW','update','sms.tencentcloudapi.com','save','get','ceil','createRandomCode','HttpStatus','error','../redisCache/redisCache.service','当前验证码已被使用！','used','@nestjs/common','../globalConfig/globalConfig.service','verifyCaptcha','Injectable','Message','742866WitUhE','createdAt','3aKlhHl','length','design:paramtypes','GlobalConfigService','findOne','VerifycationEntity','图形验证码已过期、请重新输入!','@nestjs/typeorm','@alicloud/pop-core','24zyWPia'];_0x2146=function(){return _0x8e3765;};return _0x2146();}VerificationService=__decorate([(0x0,common_1[_0x3786bd(0x1c8)])(),__param(0x0,(0x0,typeorm_1[_0x3786bd(0x1f7)])(verifycation_entity_1[_0x3786bd(0x1d1)])),__metadata(_0x3786bd(0x1ce),[typeorm_2[_0x3786bd(0x1b4)],globalConfig_service_1[_0x3786bd(0x1cf)],redisCache_service_1[_0x3786bd(0x1e7)]])],VerificationService),exports['VerificationService']=VerificationService;