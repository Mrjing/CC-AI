'use strict';const _0x9ed404=_0x27a7;function _0x27a7(_0x3d1e08,_0x6e4ada){const _0x553cb7=_0x553c();return _0x27a7=function(_0x27a744,_0x36e01e){_0x27a744=_0x27a744-0x9c;let _0x36360f=_0x553cb7[_0x27a744];return _0x36360f;},_0x27a7(_0x3d1e08,_0x6e4ada);}(function(_0x1714ea,_0x29bf2c){const _0x1320a3=_0x27a7,_0x4f51bf=_0x1714ea();while(!![]){try{const _0x290748=parseInt(_0x1320a3(0xd3))/0x1*(-parseInt(_0x1320a3(0xa1))/0x2)+-parseInt(_0x1320a3(0x11b))/0x3+parseInt(_0x1320a3(0xa6))/0x4*(parseInt(_0x1320a3(0x10f))/0x5)+-parseInt(_0x1320a3(0xe4))/0x6*(parseInt(_0x1320a3(0x9e))/0x7)+parseInt(_0x1320a3(0x133))/0x8*(-parseInt(_0x1320a3(0x14e))/0x9)+parseInt(_0x1320a3(0x117))/0xa+-parseInt(_0x1320a3(0xde))/0xb*(-parseInt(_0x1320a3(0x125))/0xc);if(_0x290748===_0x29bf2c)break;else _0x4f51bf['push'](_0x4f51bf['shift']());}catch(_0x4c195d){_0x4f51bf['push'](_0x4f51bf['shift']());}}}(_0x553c,0x39016));function _0x553c(){const _0x4ff78a=['当前账户不存在！','当前用户信息失效、请重新登录！','$2y$','affected','length','updateInfo','error:\x20','getUserById','../userBalance/userBalance.service','email\x20response\x20\x20->\x20:\x20','用户名或者邮箱已被注册！','PENDING','修改用户信息成功！','client','当前用户不存在！','configMap:\x20','HttpException','balanceInfo','UserEntity','inviteCode','function','createUser','registerVerifyExpir','UserStatusEnum','11gqTclo','Injectable','username','修改用户信息失败！','UNAUTHORIZED','register','verifyUserCredentials','queryAll','checkUserStatus','user','queryUserInfoById','11QsyoZF','status','saveRecordRechargeLog','Registration','WhiteListEntity','configEntity','17946AQPSIm','__decorate','email','decorate','createHash','$2b$','hex','用户不存在！','lastLoginIp','queryOneUserInfo','lodash','role','log','configVal','../../common/constants/user.constant','userDefautlAvatar','ADMIN_GIFT','formatCreateOrUpdateDate','verifyUserRegisterByPhone','globalConfigService','userBalanceService','VerificationService','phone','queryUserBalance','bcryptjs','addBalanceToNewUser','getOpenIdByUserId','ACTIVE','avatar','updateUserPassword','../globalConfig/globalConfig.service','createdAt','digest','userId','userEntity','connection','BAD_REQUEST','未激活用户不可手动变更状态！','save','../verification/verification.service','object','InjectRepository','reduce','75235dVRllh','super','Like','的账号激活','updateUserStatus','isVerifyEmail','当前手机号已注册、请勿重复注册！','forEach','3484940yhgzhI','恭喜您绑定成功、后续可直接扫码登录了！','getUserFromOpenId','createUserFromOpenId','4806IilUAk','password','超级管理员不可被操作！','design:paramtypes','UserBalanceService','用户名已存在、请更换用户名！','ConfigEntity','compareSync','@default.com','Repository','3988404zlOXCF','mailerService','map','@nestjs-modules/mailer','Connection','../../common/utils','startsWith','getSuper','getInviteRecord','createVerification','createUserAndVerifycation','__metadata','updateStatus','DESC','11272cwXGsG','savaLoginIp','md5','defineProperty','getClientIp','修改用户状态失败！','isBindWx','split','当前绑定用户不存在！','registerBaseUrl','重置密码失败！','修改密码失败、请重新试试吧。','createRandomUid','find','registerVerifyEmailDesc','consecutiveDays','getConfigs','openId','assign','用户名已存在！','crypto','UserService','findAndCount','addBalanceToUser','UserStatusErrMsg','HttpStatus','findOne','2637bVuwXZ','qureyUserInfoByInviteCode','sign','resetUserPass','生成邀请码失败，请重新试一次吧！','Not','typeorm','123456','35wSDsPM','update','inviteLink','30626fJrWCY','BLACKLISTED','getUserInfo','./user.entity','VerificationEnum','40GpRCRu','../../common/constants/balance.constant','registerIp','bindWx','registerVerifyEmailTitle','LOCKED','无效的邀请码！','当前密码错误！','../chatgpt/whiteList.entity','$2a$','----,','绑定微信失败、请联系管理员！','获取邀请记录失败！','queryUserBalanceByIds','hashSync','genInviteCode','../globalConfig/config.entity','没有变更，无需更改！','visitor','verificationService','metadata'];_0x553c=function(){return _0x4ff78a;};return _0x553c();}var __decorate=this&&this[_0x9ed404(0xe5)]||function(_0x5e4e65,_0x25b89c,_0x1a5f18,_0x754323){const _0x5f1f6b=_0x9ed404;var _0x1e7250=arguments[_0x5f1f6b(0xbf)],_0xd22481=_0x1e7250<0x3?_0x25b89c:_0x754323===null?_0x754323=Object['getOwnPropertyDescriptor'](_0x25b89c,_0x1a5f18):_0x754323,_0x2f8450;if(typeof Reflect===_0x5f1f6b(0x10c)&&typeof Reflect[_0x5f1f6b(0xe7)]===_0x5f1f6b(0xcf))_0xd22481=Reflect[_0x5f1f6b(0xe7)](_0x5e4e65,_0x25b89c,_0x1a5f18,_0x754323);else{for(var _0x213a02=_0x5e4e65[_0x5f1f6b(0xbf)]-0x1;_0x213a02>=0x0;_0x213a02--)if(_0x2f8450=_0x5e4e65[_0x213a02])_0xd22481=(_0x1e7250<0x3?_0x2f8450(_0xd22481):_0x1e7250>0x3?_0x2f8450(_0x25b89c,_0x1a5f18,_0xd22481):_0x2f8450(_0x25b89c,_0x1a5f18))||_0xd22481;}return _0x1e7250>0x3&&_0xd22481&&Object[_0x5f1f6b(0x136)](_0x25b89c,_0x1a5f18,_0xd22481),_0xd22481;},__metadata=this&&this[_0x9ed404(0x130)]||function(_0x4be6ad,_0x3e8c4b){const _0x5861ef=_0x9ed404;if(typeof Reflect===_0x5861ef(0x10c)&&typeof Reflect[_0x5861ef(0xba)]===_0x5861ef(0xcf))return Reflect['metadata'](_0x4be6ad,_0x3e8c4b);},__param=this&&this['__param']||function(_0x139228,_0x5df71c){return function(_0x55b026,_0x57dde0){_0x5df71c(_0x55b026,_0x57dde0,_0x139228);};};Object[_0x9ed404(0x136)](exports,'__esModule',{'value':!![]}),exports[_0x9ed404(0x148)]=void 0x0;const globalConfig_service_1=require(_0x9ed404(0x102)),user_constant_1=require(_0x9ed404(0xf2)),mailer_1=require(_0x9ed404(0x128)),verification_service_1=require(_0x9ed404(0x10b)),common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x9ed404(0x9c)),user_entity_1=require(_0x9ed404(0xa4)),bcrypt=require(_0x9ed404(0xfc)),crypto=require(_0x9ed404(0x147)),_=require(_0x9ed404(0xee)),verification_constant_1=require('../../common/constants/verification.constant'),userBalance_service_1=require(_0x9ed404(0xc3)),utils_1=require(_0x9ed404(0x12a)),balance_constant_1=require(_0x9ed404(0xa7)),config_entity_1=require(_0x9ed404(0xb6)),whiteList_entity_1=require(_0x9ed404(0xae));let UserService=class UserService{constructor(_0x1ff399,_0x15acc2,_0x3ee626,_0x3d4ba6,_0x309b72,_0x20ce15,_0x99e26f,_0x264cc3){const _0xc28e49=_0x9ed404;this[_0xc28e49(0x106)]=_0x1ff399,this['whiteListEntity']=_0x15acc2,this[_0xc28e49(0x107)]=_0x3ee626,this[_0xc28e49(0xb9)]=_0x3d4ba6,this[_0xc28e49(0x126)]=_0x309b72,this[_0xc28e49(0xf8)]=_0x20ce15,this[_0xc28e49(0xf7)]=_0x99e26f,this[_0xc28e49(0xe3)]=_0x264cc3;}async[_0x9ed404(0x12f)](_0x16f63f,_0x43185d){const _0x316f33=_0x9ed404,{username:_0x40c278,email:_0x5b7e04,password:_0x357105,invitedBy:_0x4e3ca7,client:client=0x0}=_0x16f63f;if(_0x4e3ca7){const _0x50ebbd=await this['userEntity'][_0x316f33(0x14d)]({'where':{'inviteCode':_0x4e3ca7}});if(!_0x50ebbd)throw new common_1[(_0x316f33(0xcb))](_0x316f33(0xac),common_1[_0x316f33(0x14c)][_0x316f33(0x108)]);}const _0x145165=[{'username':_0x40c278},{'email':_0x5b7e04}],_0x23eb46=await this[_0x316f33(0x106)]['findOne']({'where':_0x145165});if(_0x23eb46&&_0x23eb46[_0x316f33(0xdf)]!==user_constant_1[_0x316f33(0xd2)][_0x316f33(0xc6)])throw new common_1[(_0x316f33(0xcb))](_0x316f33(0xc5),common_1[_0x316f33(0x14c)][_0x316f33(0x108)]);try{const _0x4c5620=_['cloneDeep'](_0x16f63f),_0x1af15a=bcrypt[_0x316f33(0xb4)](_0x357105,0xa),_0x4266b4=(0x0,utils_1[_0x316f33(0x137)])(_0x43185d);_0x4c5620[_0x316f33(0x11c)]=_0x1af15a,_0x4c5620[_0x316f33(0xa8)]=_0x4266b4,_0x4c5620[_0x316f33(0xc8)]=client;let _0x25df7a;if(!_0x23eb46){const _0x5e8ee9=await this[_0x316f33(0xf7)][_0x316f33(0x143)]([_0x316f33(0xf3)]);_0x4c5620[_0x316f33(0x100)]=_0x5e8ee9,_0x25df7a=await this['userEntity'][_0x316f33(0x10a)](_0x4c5620);}else _0x25df7a=_0x23eb46;const _0x4f18ff=await this[_0x316f33(0xe3)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x316f33(0x114),_0x316f33(0x13c),_0x316f33(0xaa),_0x316f33(0x141),'registerVerifyEmailFrom',_0x316f33(0xd1)])}}),_0x11d84b=_0x4f18ff[_0x316f33(0x10e)]((_0x1d44df,_0x583be9)=>{const _0x16e949=_0x316f33;return _0x1d44df[_0x583be9['configKey']]=_0x583be9[_0x16e949(0xf1)],_0x1d44df;},{}),_0x2b9564=_0x11d84b[_0x316f33(0x114)]?Number(_0x11d84b[_0x316f33(0x114)]):0x1;if(_0x2b9564){const _0x317e94=_0x11d84b[_0x316f33(0xd1)]?Number(_0x11d84b[_0x316f33(0xd1)]):0x1e*0x3c,_0x5f50f5=await this[_0x316f33(0xb9)][_0x316f33(0x12e)](_0x25df7a,verification_constant_1[_0x316f33(0xa5)][_0x316f33(0xe1)],_0x317e94),{code:_0x394cd0,email:_0x34dd52,id:_0x59a372}=_0x5f50f5,{registerVerifyEmailFrom:_0x4491ad}=_0x11d84b;console['log'](_0x316f33(0xca),_0x11d84b);const _0x4651c7=await this[_0x316f33(0x126)]['sendMail']({'to':_0x34dd52,'subject':'来自'+_0x4491ad+_0x316f33(0x112),'template':_0x316f33(0xd8),'context':Object[_0x316f33(0x145)]({'baseUrl':_0x11d84b[_0x316f33(0x13c)],'code':_0x394cd0,'id':_0x59a372},_0x11d84b)});console[_0x316f33(0xf0)](_0x316f33(0xc4),_0x4651c7);}else{const {username:_0x54ecf9,email:_0x7beab2,id:_0xfd4487,invitedBy:_0x93a67b}=_0x25df7a;await this[_0x316f33(0x113)](_0xfd4487,user_constant_1[_0x316f33(0xd2)][_0x316f33(0xff)]);let _0x2cf385;_0x93a67b&&(_0x2cf385=await this[_0x316f33(0x14f)](_0x93a67b)),await this[_0x316f33(0xf8)]['addBalanceToNewUser'](_0xfd4487,_0x2cf385===null||_0x2cf385===void 0x0?void 0x0:_0x2cf385['id']);}return _0x25df7a;}catch(_0xa4f11c){console[_0x316f33(0xf0)](_0x316f33(0xc1),_0xa4f11c);throw _0xa4f11c;}}async[_0x9ed404(0x12c)](){const _0x17dc11=_0x9ed404,_0x16bde6=await this['userEntity']['findOne']({'where':{'role':_0x17dc11(0x110)}});return _0x16bde6;}async[_0x9ed404(0xd9)](_0x2326d7){const _0x5f58b3=_0x9ed404,{username:_0x14e155,password:_0x56f24b,uid:uid=0x0,phone:_0x46aef8}=_0x2326d7;let _0x505982=null;if(uid>0x0){_0x505982=await this['userEntity'][_0x5f58b3(0x14d)]({'where':{'id':uid}});if(!_0x505982)throw new common_1[(_0x5f58b3(0xcb))](_0x5f58b3(0xbb),common_1['HttpStatus']['BAD_REQUEST']);if(_0x505982[_0x5f58b3(0x11c)][_0x5f58b3(0x12b)](_0x5f58b3(0xaf))||_0x505982['password'][_0x5f58b3(0x12b)](_0x5f58b3(0xe9))||_0x505982[_0x5f58b3(0x11c)][_0x5f58b3(0x12b)]('$2y$')){if(!bcrypt[_0x5f58b3(0x122)](_0x56f24b,_0x505982[_0x5f58b3(0x11c)]))throw new common_1['HttpException'](_0x5f58b3(0xad),common_1[_0x5f58b3(0x14c)][_0x5f58b3(0x108)]);}else{console[_0x5f58b3(0xf0)](_0x5f58b3(0xb0));const _0x351ca3=crypto[_0x5f58b3(0xe8)](_0x5f58b3(0x135))[_0x5f58b3(0x9f)](_0x56f24b)[_0x5f58b3(0x104)](_0x5f58b3(0xea));console[_0x5f58b3(0xf0)]('----,',_0x351ca3);if(_0x351ca3!==_0x505982[_0x5f58b3(0x11c)])throw new common_1[(_0x5f58b3(0xcb))](_0x5f58b3(0xad),common_1[_0x5f58b3(0x14c)][_0x5f58b3(0x108)]);}}if(_0x14e155&&_0x56f24b){const _0x8f24c7=[{'username':_0x14e155},{'email':_0x14e155}];_0x505982=await this['userEntity'][_0x5f58b3(0x14d)]({'where':_0x8f24c7});if(!_0x505982)throw new common_1[(_0x5f58b3(0xcb))]('当前账户不存在！',common_1[_0x5f58b3(0x14c)][_0x5f58b3(0x108)]);if(_0x505982[_0x5f58b3(0x11c)][_0x5f58b3(0x12b)](_0x5f58b3(0xaf))||_0x505982[_0x5f58b3(0x11c)]['startsWith'](_0x5f58b3(0xe9))||_0x505982['password'][_0x5f58b3(0x12b)](_0x5f58b3(0xbd))){if(!bcrypt['compareSync'](_0x56f24b,_0x505982[_0x5f58b3(0x11c)]))throw new common_1[(_0x5f58b3(0xcb))](_0x5f58b3(0xad),common_1['HttpStatus'][_0x5f58b3(0x108)]);}else{console[_0x5f58b3(0xf0)](_0x5f58b3(0xb0));const _0x25e7d5=crypto['createHash'](_0x5f58b3(0x135))[_0x5f58b3(0x9f)](_0x56f24b)[_0x5f58b3(0x104)](_0x5f58b3(0xea));console[_0x5f58b3(0xf0)]('----,',_0x25e7d5);if(_0x25e7d5!==_0x505982[_0x5f58b3(0x11c)])throw new common_1[(_0x5f58b3(0xcb))](_0x5f58b3(0xad),common_1[_0x5f58b3(0x14c)][_0x5f58b3(0x108)]);}}if(_0x46aef8&&_0x56f24b){const _0x514e10=[{'phone':_0x46aef8}];_0x505982=await this[_0x5f58b3(0x106)]['findOne']({'where':_0x514e10});if(!_0x505982)throw new common_1[(_0x5f58b3(0xcb))]('当前账户不存在！',common_1['HttpStatus']['BAD_REQUEST']);if(_0x505982[_0x5f58b3(0x11c)][_0x5f58b3(0x12b)]('$2a$')||_0x505982[_0x5f58b3(0x11c)][_0x5f58b3(0x12b)]('$2b$')||_0x505982[_0x5f58b3(0x11c)][_0x5f58b3(0x12b)](_0x5f58b3(0xbd))){if(!bcrypt[_0x5f58b3(0x122)](_0x56f24b,_0x505982[_0x5f58b3(0x11c)]))throw new common_1['HttpException'](_0x5f58b3(0xad),common_1['HttpStatus']['BAD_REQUEST']);}else{console[_0x5f58b3(0xf0)]('----,');const _0x3e3cbc=crypto[_0x5f58b3(0xe8)](_0x5f58b3(0x135))[_0x5f58b3(0x9f)](_0x56f24b)['digest'](_0x5f58b3(0xea));console[_0x5f58b3(0xf0)](_0x5f58b3(0xb0),_0x3e3cbc);if(_0x3e3cbc!==_0x505982['password'])throw new common_1[(_0x5f58b3(0xcb))](_0x5f58b3(0xad),common_1['HttpStatus'][_0x5f58b3(0x108)]);}}if(!_0x505982)throw new common_1[(_0x5f58b3(0xcb))](_0x5f58b3(0xbb),common_1[_0x5f58b3(0x14c)][_0x5f58b3(0x108)]);if(_0x505982[_0x5f58b3(0xdf)]!==user_constant_1[_0x5f58b3(0xd2)][_0x5f58b3(0xff)])throw new common_1[(_0x5f58b3(0xcb))](user_constant_1[_0x5f58b3(0x14b)][_0x505982[_0x5f58b3(0xdf)]],common_1['HttpStatus'][_0x5f58b3(0x108)]);return _0x505982;}async['verifyUserPassword'](_0x7f07a0,_0x18dc1f){const _0x30fab3=_0x9ed404,_0x2281ba=await this[_0x30fab3(0x106)][_0x30fab3(0x14d)]({'where':{'id':_0x7f07a0}});if(_0x2281ba['password'][_0x30fab3(0x12b)](_0x30fab3(0xaf))||_0x2281ba[_0x30fab3(0x11c)][_0x30fab3(0x12b)](_0x30fab3(0xe9))||_0x2281ba[_0x30fab3(0x11c)][_0x30fab3(0x12b)]('$2y$'))return bcrypt[_0x30fab3(0x122)](_0x18dc1f,_0x2281ba['password']);else{const _0xbbe414=crypto[_0x30fab3(0xe8)](_0x30fab3(0x135))[_0x30fab3(0x9f)](_0x18dc1f)[_0x30fab3(0x104)]('hex');return console[_0x30fab3(0xf0)](_0x30fab3(0xb0),_0xbbe414),_0xbbe414===_0x2281ba[_0x30fab3(0x11c)];}}async[_0x9ed404(0x113)](_0x15fc0a,_0x2b2963){const _0x54c178=_0x9ed404,_0x46d8f2=await this[_0x54c178(0x106)]['update']({'id':_0x15fc0a},{'status':_0x2b2963});return _0x46d8f2[_0x54c178(0xbe)]>0x0;}async['getUserStatus'](_0x38a86c){const _0x54c60b=_0x9ed404,_0x514f35=await this[_0x54c60b(0x106)][_0x54c60b(0x14d)]({'where':{'id':_0x38a86c}});return _0x514f35['status'];}async[_0x9ed404(0xdd)](_0x4db3d9){const _0x19d810=_0x9ed404;return await this[_0x19d810(0x106)][_0x19d810(0x14d)]({'where':{'id':_0x4db3d9}});}async[_0x9ed404(0xed)](_0x44dead){const _0x6380c4=_0x9ed404;return await this[_0x6380c4(0x106)]['findOne']({'where':{'id':_0x44dead}});}async[_0x9ed404(0xdb)](_0x483b08){const _0x52718c=_0x9ed404,{id:_0x2ce121,role:_0x4ea04c}=_0x483b08;if(_0x4ea04c===_0x52718c(0xb8))return!![];const _0x51c15a=await this['userEntity'][_0x52718c(0x14d)]({'where':{'id':_0x2ce121}});if(!_0x51c15a)throw new common_1[(_0x52718c(0xcb))](_0x52718c(0xbc),common_1[_0x52718c(0x14c)][_0x52718c(0xd7)]);if(_0x51c15a[_0x52718c(0xdf)]===user_constant_1['UserStatusEnum'][_0x52718c(0xa2)])throw new common_1[(_0x52718c(0xcb))]('您的账户已被永久加入黑名单、如有疑问、请联系管理员！',common_1[_0x52718c(0x14c)][_0x52718c(0x108)]);if(_0x51c15a[_0x52718c(0xdf)]===user_constant_1[_0x52718c(0xd2)][_0x52718c(0xab)])throw new common_1[(_0x52718c(0xcb))]('您的账户已被封禁、如有疑问、请联系管理员！',common_1[_0x52718c(0x14c)][_0x52718c(0x108)]);}async[_0x9ed404(0xa3)](_0x82702e){const _0x1ae064=_0x9ed404,_0x32c639=await this['userEntity'][_0x1ae064(0x14d)]({'where':{'id':_0x82702e},'select':[_0x1ae064(0xd5),_0x1ae064(0x100),_0x1ae064(0xef),_0x1ae064(0xe6),_0x1ae064(0x150),_0x1ae064(0xce),'openId',_0x1ae064(0x142)]});if(!_0x32c639)throw new common_1[(_0x1ae064(0xcb))](_0x1ae064(0xbc),common_1[_0x1ae064(0x14c)][_0x1ae064(0xd7)]);_0x32c639[_0x1ae064(0x139)]=!!(_0x32c639===null||_0x32c639===void 0x0?void 0x0:_0x32c639['openId']),delete _0x32c639[_0x1ae064(0x144)];const _0xf8dfd6=await this[_0x1ae064(0xf8)][_0x1ae064(0xfb)](_0x82702e);return{'userInfo':_0x32c639,'userBalance':Object['assign']({},_0xf8dfd6)};}async[_0x9ed404(0xc2)](_0xaacd8){const _0x23a843=_0x9ed404;return await this[_0x23a843(0x106)][_0x23a843(0x14d)]({'where':{'id':_0xaacd8}});}async['getUserOpenId'](_0x48bfb2){const _0x48c80c=_0x9ed404;return await this[_0x48c80c(0x106)][_0x48c80c(0x14d)]({'where':{'openId':_0x48bfb2}});}async[_0x9ed404(0xc0)](_0x5ccd87,_0x4a9593){const _0x1447c7=_0x9ed404,{id:_0x244411}=_0x4a9593['user'],_0x293284=await this[_0x1447c7(0x106)]['findOne']({'where':{'id':_0x244411}});if(!_0x293284)throw new common_1[(_0x1447c7(0xcb))](_0x1447c7(0xc9),common_1[_0x1447c7(0x14c)][_0x1447c7(0x108)]);if(_0x5ccd87[_0x1447c7(0xd5)]&&_0x293284['username']===_0x5ccd87['username'])throw new common_1[(_0x1447c7(0xcb))](_0x1447c7(0xb7),common_1['HttpStatus'][_0x1447c7(0x108)]);if(_0x5ccd87[_0x1447c7(0xd5)]){const _0x21fbd3=await this['userEntity'][_0x1447c7(0x14d)]({'where':{'username':_0x5ccd87[_0x1447c7(0xd5)],'id':(0x0,typeorm_2[_0x1447c7(0x153)])(_0x244411)}});if(_0x21fbd3)throw new common_1[(_0x1447c7(0xcb))](_0x1447c7(0x146),common_1['HttpStatus'][_0x1447c7(0x108)]);}const _0x1ac41a=await this[_0x1447c7(0x106)][_0x1447c7(0x9f)]({'id':_0x244411},_0x5ccd87);if(_0x1ac41a['affected']<=0x0)throw new common_1['HttpException'](_0x1447c7(0xd6),common_1['HttpStatus']['BAD_REQUEST']);return _0x1447c7(0xc7);}async[_0x9ed404(0x101)](_0x5b6734,_0x23d53d){const _0x101382=_0x9ed404,_0x458bb2=bcrypt[_0x101382(0xb4)](_0x23d53d,0xa),_0x46fcef=await this[_0x101382(0x106)][_0x101382(0x9f)]({'id':_0x5b6734},{'password':_0x458bb2});if(_0x46fcef[_0x101382(0xbe)]<=0x0)throw new common_1['HttpException'](_0x101382(0x13e),common_1[_0x101382(0x14c)][_0x101382(0x108)]);}async[_0x9ed404(0xb5)](_0x3effa4){const _0xc1963e=_0x9ed404,{id:_0x5020b4}=_0x3effa4[_0xc1963e(0xdc)],_0x5bcae4=await this[_0xc1963e(0x106)][_0xc1963e(0x14d)]({'where':{'id':_0x5020b4}});if(!_0x5bcae4||_0x5bcae4[_0xc1963e(0xce)])throw new common_1[(_0xc1963e(0xcb))]('已生成过邀请码、请勿重复生成',common_1[_0xc1963e(0x14c)][_0xc1963e(0x108)]);const _0x4dedc9=(0x0,utils_1['generateRandomString'])(),_0xf94364=await this['userEntity']['findOne']({'where':{'inviteCode':_0x4dedc9}});if(_0xf94364)throw new common_1[(_0xc1963e(0xcb))](_0xc1963e(0x152),common_1[_0xc1963e(0x14c)][_0xc1963e(0x108)]);const _0xdb8e62=await this[_0xc1963e(0x106)][_0xc1963e(0x9f)]({'id':_0x5020b4},{'inviteCode':_0x4dedc9});if(_0xdb8e62[_0xc1963e(0xbe)]<=0x0)throw new common_1['HttpException'](_0xc1963e(0x152),common_1[_0xc1963e(0x14c)][_0xc1963e(0x108)]);return _0x4dedc9;}async[_0x9ed404(0x12d)](_0x1277fe,_0x7ddcb9){const _0x253c95=_0x9ed404;try{const {id:_0x30c4b8}=_0x1277fe[_0x253c95(0xdc)],{page:page=0x1,size:size=0xa}=_0x7ddcb9,_0x52931f=await this[_0x253c95(0x106)][_0x253c95(0x14d)]({'where':{'id':_0x30c4b8}}),{inviteCode:_0x508cdd}=_0x52931f;if(!_0x508cdd)return[];const [_0x4a8693,_0x3f4cf7]=await this[_0x253c95(0x106)][_0x253c95(0x149)]({'where':{'inviteCode':_0x508cdd},'order':{'id':_0x253c95(0x132)},'select':['username','email','createdAt','status',_0x253c95(0x100)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x253c95(0xf5)])(_0x4a8693)[_0x253c95(0x127)](_0x23abb0=>{const _0x46c360=_0x253c95;return _0x23abb0[_0x46c360(0xe6)]=(0x0,utils_1['maskEmail'])(_0x23abb0[_0x46c360(0xe6)]),_0x23abb0;}),{'rows':_0x4a8693,'count':_0x3f4cf7};}catch(_0x50ca7c){console['log'](_0x253c95(0xc1),_0x50ca7c);throw new common_1['HttpException'](_0x253c95(0xb2),common_1[_0x253c95(0x14c)][_0x253c95(0x108)]);}}async[_0x9ed404(0xa0)](_0x84cdd4){const _0x1d73a8=_0x9ed404,_0x3c6fad=await this[_0x1d73a8(0x106)][_0x1d73a8(0x14d)]({'where':{'inviteCode':_0x84cdd4}});if(!_0x3c6fad)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x3c6fad,_0x52e650=await this['userEntity']['update']({'inviteCode':_0x84cdd4},{'inviteLinkCount':inviteLinkCount+0x1});return _0x52e650[_0x1d73a8(0xbe)]?0x1:0x0;}async[_0x9ed404(0x14f)](_0x49aba2){const _0x121503=_0x9ed404;return await this[_0x121503(0x106)]['findOne']({'where':{'inviteCode':_0x49aba2}});}async['userRecharge'](_0xa7ec60){const _0x523718=_0x9ed404,{userId:_0xe0d7e,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0xa7ec60;await this['userBalanceService'][_0x523718(0x14a)](_0xe0d7e,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x26eefb=await this[_0x523718(0xf8)][_0x523718(0xe0)]({'userId':_0xe0d7e,'rechargeType':balance_constant_1['RechargeType'][_0x523718(0xf4)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x26eefb;}async[_0x9ed404(0xda)](_0x136500,_0x36e3ec){const _0xa538cc=_0x9ed404,{page:page=0x1,size:size=0xa,username:_0x354c7b,email:_0x3f1203,status:_0x4c2dd6,keyword:_0x4398bb,phone:_0x43ef35}=_0x136500;let _0x500902={};_0x354c7b&&Object[_0xa538cc(0x145)](_0x500902,{'username':(0x0,typeorm_2[_0xa538cc(0x111)])('%'+_0x354c7b+'%')}),_0x3f1203&&Object[_0xa538cc(0x145)](_0x500902,{'email':(0x0,typeorm_2[_0xa538cc(0x111)])('%'+_0x3f1203+'%')}),_0x43ef35&&Object[_0xa538cc(0x145)](_0x500902,{'phone':(0x0,typeorm_2[_0xa538cc(0x111)])('%'+_0x43ef35+'%')}),_0x4c2dd6&&Object['assign'](_0x500902,{'status':_0x4c2dd6});_0x4398bb&&(_0x500902=[{'username':(0x0,typeorm_2['Like'])('%'+_0x4398bb+'%')},{'email':(0x0,typeorm_2[_0xa538cc(0x111)])('%'+_0x4398bb+'%')},{'phone':(0x0,typeorm_2['Like'])('%'+_0x4398bb+'%')}]);const [_0x3219af,_0xb73eb8]=await this[_0xa538cc(0x106)]['findAndCount']({'skip':(page-0x1)*size,'where':_0x500902,'take':size,'order':{'createdAt':_0xa538cc(0x132)},'cache':!![],'select':[_0xa538cc(0xd5),_0xa538cc(0x100),'inviteCode',_0xa538cc(0xef),_0xa538cc(0x150),_0xa538cc(0xdf),'id',_0xa538cc(0xe6),_0xa538cc(0x103),_0xa538cc(0xec),_0xa538cc(0xfa)]}),_0x51b534=_0x3219af[_0xa538cc(0x127)](_0x106cfa=>_0x106cfa['id']),_0xc21d0c=await this[_0xa538cc(0xf8)][_0xa538cc(0xb3)](_0x51b534);return _0x3219af['forEach'](_0x47eaeb=>_0x47eaeb[_0xa538cc(0xcc)]=_0xc21d0c[_0xa538cc(0x140)](_0x1c7287=>_0x1c7287[_0xa538cc(0x105)]===_0x47eaeb['id'])),_0x36e3ec[_0xa538cc(0xdc)][_0xa538cc(0xef)]!==_0xa538cc(0x110)&&_0x3219af[_0xa538cc(0x116)](_0x7756b1=>_0x7756b1[_0xa538cc(0xe6)]=(0x0,utils_1['maskEmail'])(_0x7756b1[_0xa538cc(0xe6)])),_0x36e3ec[_0xa538cc(0xdc)][_0xa538cc(0xef)]!==_0xa538cc(0x110)&&_0x3219af[_0xa538cc(0x116)](_0x5a36cb=>_0x5a36cb[_0xa538cc(0xec)]=(0x0,utils_1['maskIpAddress'])(_0x5a36cb[_0xa538cc(0xec)])),_0x36e3ec[_0xa538cc(0xdc)][_0xa538cc(0xef)]!==_0xa538cc(0x110)&&_0x3219af[_0xa538cc(0x116)](_0x66ee2d=>_0x66ee2d[_0xa538cc(0xfa)]=(0x0,utils_1['maskIpAddress'])(_0x66ee2d[_0xa538cc(0xfa)])),{'rows':_0x3219af,'count':_0xb73eb8};}async['queryOne']({id:_0x11ad39}){const _0x4b5af2=_0x9ed404;return await this['userEntity'][_0x4b5af2(0x14d)]({'where':{'id':_0x11ad39},'select':[_0x4b5af2(0xd5),_0x4b5af2(0x100),_0x4b5af2(0xce),_0x4b5af2(0xef),_0x4b5af2(0x150),_0x4b5af2(0xdf)]});}async[_0x9ed404(0x131)](_0x2e0552){const _0x377fd6=_0x9ed404,{id:_0x1c4bd0,status:_0xa349b4}=_0x2e0552,_0x2d0b99=await this['userEntity'][_0x377fd6(0x14d)]({'where':{'id':_0x1c4bd0}});if(!_0x2d0b99)throw new common_1['HttpException'](_0x377fd6(0xeb),common_1['HttpStatus'][_0x377fd6(0x108)]);if(_0x2d0b99[_0x377fd6(0xef)]==='super')throw new common_1[(_0x377fd6(0xcb))](_0x377fd6(0x11d),common_1[_0x377fd6(0x14c)][_0x377fd6(0x108)]);if(_0x2d0b99['status']===user_constant_1['UserStatusEnum']['PENDING'])throw new common_1[(_0x377fd6(0xcb))](_0x377fd6(0x109),common_1[_0x377fd6(0x14c)][_0x377fd6(0x108)]);if(_0x2d0b99['role']===_0x377fd6(0x110))throw new common_1[(_0x377fd6(0xcb))](_0x377fd6(0x11d),common_1['HttpStatus'][_0x377fd6(0x108)]);if(_0xa349b4===user_constant_1[_0x377fd6(0xd2)][_0x377fd6(0xc6)])throw new common_1[(_0x377fd6(0xcb))]('不可将用户置为未激活状态！',common_1[_0x377fd6(0x14c)][_0x377fd6(0x108)]);const _0x3746d9=await this[_0x377fd6(0x106)][_0x377fd6(0x9f)]({'id':_0x1c4bd0},{'status':_0xa349b4});if(_0x3746d9[_0x377fd6(0xbe)]<=0x0)throw new common_1[(_0x377fd6(0xcb))](_0x377fd6(0x138),common_1[_0x377fd6(0x14c)][_0x377fd6(0x108)]);return'修改用户状态成功！';}async[_0x9ed404(0x151)](_0x512dd5){const _0x9a4192=_0x9ed404,{id:_0x21f097}=_0x512dd5,_0x5c168a=await this[_0x9a4192(0x106)][_0x9a4192(0x14d)]({'where':{'id':_0x21f097}});if(!_0x5c168a)throw new common_1[(_0x9a4192(0xcb))]('用户不存在！',common_1[_0x9a4192(0x14c)][_0x9a4192(0x108)]);const _0x1010c0=_0x9a4192(0x9d),_0x4eb8f9=bcrypt[_0x9a4192(0xb4)](_0x1010c0,0xa),_0x4e48e5=await this[_0x9a4192(0x106)][_0x9a4192(0x9f)]({'id':_0x21f097},{'password':_0x4eb8f9});if(_0x4e48e5[_0x9a4192(0xbe)]<=0x0)throw new common_1[(_0x9a4192(0xcb))](_0x9a4192(0x13d),common_1[_0x9a4192(0x14c)][_0x9a4192(0x108)]);return'密码重置为['+_0x1010c0+']成功!';}async[_0x9ed404(0x134)](_0x5e7ea9,_0x26c5a4){const _0x4a375e=_0x9ed404;return await this[_0x4a375e(0x106)][_0x4a375e(0x9f)]({'id':_0x5e7ea9},{'lastLoginIp':_0x26c5a4});}async[_0x9ed404(0x119)](_0x5747eb,_0x30b984){const _0x2b14e3=_0x9ed404,_0x38b233=await this['userEntity'][_0x2b14e3(0x14d)]({'where':{'openId':_0x5747eb}});if(!_0x38b233){const _0x50f955=_0x30b984?_0x30b984[_0x2b14e3(0x13a)](':')[0x1]:'',_0x28a880=await this[_0x2b14e3(0x14f)](_0x50f955),_0x2262cc=await this[_0x2b14e3(0x11a)](_0x5747eb,_0x50f955);return await this['userBalanceService'][_0x2b14e3(0xfd)](_0x2262cc['id'],_0x50f955?_0x28a880===null||_0x28a880===void 0x0?void 0x0:_0x28a880['id']:null),_0x2262cc;}return _0x38b233;}async['createUserFromOpenId'](_0x266723,_0x5d2cdb){const _0x35e3d7=_0x9ed404,_0x45fa7b=await this[_0x35e3d7(0xf7)][_0x35e3d7(0x143)]([_0x35e3d7(0xf3)]),_0x2638d4={'avatar':_0x45fa7b,'username':'用户'+(0x0,utils_1[_0x35e3d7(0x13f)])(),'status':user_constant_1[_0x35e3d7(0xd2)][_0x35e3d7(0xff)],'sex':0x0,'email':(0x0,utils_1[_0x35e3d7(0x13f)])()+_0x35e3d7(0x123),'invitedBy':_0x5d2cdb,'openId':_0x266723},_0x11d559=await this['userEntity']['save'](_0x2638d4);return _0x11d559;}async[_0x9ed404(0xa9)](_0x570e39,_0x95deb6){const _0x11742e=_0x9ed404;try{const _0x4ea84a=await this[_0x11742e(0x106)][_0x11742e(0x14d)]({'where':{'id':_0x95deb6}});if(!_0x4ea84a)return{'status':![],'msg':_0x11742e(0x13b)};const _0x4b764c=await this[_0x11742e(0x106)]['findOne']({'where':{'openId':_0x570e39}});if(_0x4b764c)return{'status':![],'msg':'该微信已绑定其他账号！'};const _0x4b8718=await this[_0x11742e(0x106)][_0x11742e(0x9f)]({'id':_0x95deb6},{'openId':_0x570e39});if(_0x4b8718[_0x11742e(0xbe)]<=0x0)return{'status':![],'msg':_0x11742e(0xb1)};return{'status':!![],'msg':_0x11742e(0x118)};}catch(_0x17ab27){return{'status':![],'msg':_0x11742e(0xb1)};}}async[_0x9ed404(0xfe)](_0x41491a){const _0x3f7cf3=_0x9ed404,_0x3049d9=await this[_0x3f7cf3(0x106)]['findOne']({'where':{'id':_0x41491a}});return _0x3049d9===null||_0x3049d9===void 0x0?void 0x0:_0x3049d9[_0x3f7cf3(0x144)];}async[_0x9ed404(0xf6)](_0x571153){const _0x5b2c68=_0x9ed404,{username:_0x376df1,password:_0x43959c,phone:_0x45f598,phoneCode:_0x169580}=_0x571153,_0x2dee7f=await this[_0x5b2c68(0x106)]['findOne']({'where':[{'username':_0x376df1},{'phone':_0x45f598}]});if(_0x2dee7f&&_0x2dee7f[_0x5b2c68(0xd5)]===_0x376df1)throw new common_1[(_0x5b2c68(0xcb))](_0x5b2c68(0x120),common_1['HttpStatus']['BAD_REQUEST']);if(_0x2dee7f&&_0x2dee7f[_0x5b2c68(0xfa)]===_0x45f598)throw new common_1[(_0x5b2c68(0xcb))](_0x5b2c68(0x115),common_1[_0x5b2c68(0x14c)][_0x5b2c68(0x108)]);}async[_0x9ed404(0xd0)](_0x103ad3){const _0x107533=_0x9ed404;return await this[_0x107533(0x106)][_0x107533(0x10a)](_0x103ad3);}};UserService=__decorate([(0x0,common_1[_0x9ed404(0xd4)])(),__param(0x0,(0x0,typeorm_1[_0x9ed404(0x10d)])(user_entity_1[_0x9ed404(0xcd)])),__param(0x1,(0x0,typeorm_1[_0x9ed404(0x10d)])(whiteList_entity_1[_0x9ed404(0xe2)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x9ed404(0x121)])),__metadata(_0x9ed404(0x11e),[typeorm_2[_0x9ed404(0x124)],typeorm_2[_0x9ed404(0x124)],typeorm_2[_0x9ed404(0x129)],verification_service_1[_0x9ed404(0xf9)],mailer_1['MailerService'],userBalance_service_1[_0x9ed404(0x11f)],globalConfig_service_1['GlobalConfigService'],typeorm_2[_0x9ed404(0x124)]])],UserService),exports[_0x9ed404(0x148)]=UserService;