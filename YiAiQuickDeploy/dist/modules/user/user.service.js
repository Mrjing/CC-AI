'use strict';const _0x762547=_0x4815;(function(_0x1c2585,_0x4dd08f){const _0x338598=_0x4815,_0x4ed9ce=_0x1c2585();while(!![]){try{const _0x54de59=-parseInt(_0x338598(0x137))/0x1*(parseInt(_0x338598(0x97))/0x2)+-parseInt(_0x338598(0xcf))/0x3*(-parseInt(_0x338598(0x111))/0x4)+parseInt(_0x338598(0xb8))/0x5+parseInt(_0x338598(0xbf))/0x6*(parseInt(_0x338598(0x11d))/0x7)+-parseInt(_0x338598(0xd5))/0x8+parseInt(_0x338598(0xeb))/0x9*(-parseInt(_0x338598(0x9d))/0xa)+-parseInt(_0x338598(0xf8))/0xb*(parseInt(_0x338598(0xb9))/0xc);if(_0x54de59===_0x4dd08f)break;else _0x4ed9ce['push'](_0x4ed9ce['shift']());}catch(_0x304dee){_0x4ed9ce['push'](_0x4ed9ce['shift']());}}}(_0x4596,0xbfdbe));var __decorate=this&&this[_0x762547(0x10c)]||function(_0x1d63d4,_0x254368,_0x2d878c,_0x1fc12e){const _0x58aeaf=_0x762547;var _0x2ba0f8=arguments['length'],_0xaf59a5=_0x2ba0f8<0x3?_0x254368:_0x1fc12e===null?_0x1fc12e=Object[_0x58aeaf(0x11f)](_0x254368,_0x2d878c):_0x1fc12e,_0x35c3b4;if(typeof Reflect==='object'&&typeof Reflect[_0x58aeaf(0xdd)]==='function')_0xaf59a5=Reflect['decorate'](_0x1d63d4,_0x254368,_0x2d878c,_0x1fc12e);else{for(var _0x2448ea=_0x1d63d4['length']-0x1;_0x2448ea>=0x0;_0x2448ea--)if(_0x35c3b4=_0x1d63d4[_0x2448ea])_0xaf59a5=(_0x2ba0f8<0x3?_0x35c3b4(_0xaf59a5):_0x2ba0f8>0x3?_0x35c3b4(_0x254368,_0x2d878c,_0xaf59a5):_0x35c3b4(_0x254368,_0x2d878c))||_0xaf59a5;}return _0x2ba0f8>0x3&&_0xaf59a5&&Object[_0x58aeaf(0x9c)](_0x254368,_0x2d878c,_0xaf59a5),_0xaf59a5;},__metadata=this&&this[_0x762547(0x117)]||function(_0x334200,_0xff4e51){const _0x31393a=_0x762547;if(typeof Reflect===_0x31393a(0x106)&&typeof Reflect[_0x31393a(0xfb)]===_0x31393a(0x130))return Reflect['metadata'](_0x334200,_0xff4e51);},__param=this&&this[_0x762547(0xf9)]||function(_0x17d988,_0x187d91){return function(_0x18894f,_0x5c1e25){_0x187d91(_0x18894f,_0x5c1e25,_0x17d988);};};Object[_0x762547(0x9c)](exports,_0x762547(0x123),{'value':!![]}),exports[_0x762547(0xf3)]=void 0x0;const globalConfig_service_1=require(_0x762547(0xed)),user_constant_1=require('../../common/constants/user.constant'),mailer_1=require(_0x762547(0x98)),verification_service_1=require(_0x762547(0xd3)),common_1=require(_0x762547(0x128)),typeorm_1=require(_0x762547(0xa5)),typeorm_2=require(_0x762547(0xef)),user_entity_1=require(_0x762547(0xe0)),bcrypt=require(_0x762547(0x120)),crypto=require(_0x762547(0x132)),_=require('lodash'),verification_constant_1=require('../../common/constants/verification.constant'),userBalance_service_1=require('../userBalance/userBalance.service'),utils_1=require(_0x762547(0xec)),balance_constant_1=require('../../common/constants/balance.constant'),config_entity_1=require('../globalConfig/config.entity'),whiteList_entity_1=require(_0x762547(0xee));let UserService=class UserService{constructor(_0x3f7f6c,_0x338aa3,_0x59cbef,_0x129f1f,_0x45cb1a,_0x12470f,_0xa35dab,_0x251a11){const _0xbe7b54=_0x762547;this[_0xbe7b54(0xb0)]=_0x3f7f6c,this['whiteListEntity']=_0x338aa3,this[_0xbe7b54(0xca)]=_0x59cbef,this[_0xbe7b54(0xd6)]=_0x129f1f,this[_0xbe7b54(0xf1)]=_0x45cb1a,this['userBalanceService']=_0x12470f,this[_0xbe7b54(0x90)]=_0xa35dab,this[_0xbe7b54(0x129)]=_0x251a11;}async[_0x762547(0xfd)](_0x568cc1,_0x289ba1){const _0x389e86=_0x762547,{username:_0x233a7a,email:_0x1cdabf,password:_0x1220b7,invitedBy:_0x3113a0,client:client=0x0}=_0x568cc1;if(_0x3113a0){const _0x61d679=await this[_0x389e86(0xb0)]['findOne']({'where':{'inviteCode':_0x3113a0}});if(!_0x61d679)throw new common_1[(_0x389e86(0xc5))](_0x389e86(0x103),common_1[_0x389e86(0xd4)][_0x389e86(0x92)]);}const _0xbac962=[{'username':_0x233a7a},{'email':_0x1cdabf}],_0x4725cd=await this[_0x389e86(0xb0)][_0x389e86(0x13b)]({'where':_0xbac962});if(_0x4725cd&&_0x4725cd[_0x389e86(0xfa)]!==user_constant_1[_0x389e86(0xac)]['PENDING'])throw new common_1['HttpException'](_0x389e86(0x9e),common_1['HttpStatus'][_0x389e86(0x92)]);try{const _0x1a69a0=_['cloneDeep'](_0x568cc1),_0xcfda9=bcrypt[_0x389e86(0xbe)](_0x1220b7,0xa),_0x578491=(0x0,utils_1[_0x389e86(0xe5)])(_0x289ba1);_0x1a69a0[_0x389e86(0x138)]=_0xcfda9,_0x1a69a0[_0x389e86(0xff)]=_0x578491,_0x1a69a0[_0x389e86(0x105)]=client;let _0x2a2780;if(!_0x4725cd){const _0x3831b7=await this[_0x389e86(0x90)][_0x389e86(0xf2)]([_0x389e86(0x8d)]);_0x1a69a0[_0x389e86(0xd9)]=_0x3831b7,_0x2a2780=await this[_0x389e86(0xb0)]['save'](_0x1a69a0);}else _0x2a2780=_0x4725cd;const _0x836574=await this['configEntity']['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x389e86(0xaa),'registerBaseUrl',_0x389e86(0xbc),'registerVerifyEmailDesc',_0x389e86(0xfe),_0x389e86(0x139)])}}),_0x4bdca1=_0x836574['reduce']((_0x4fddff,_0x5e74fe)=>{const _0x3f0bac=_0x389e86;return _0x4fddff[_0x5e74fe[_0x3f0bac(0xa6)]]=_0x5e74fe[_0x3f0bac(0x9a)],_0x4fddff;},{}),_0x4ff6be=_0x4bdca1['isVerifyEmail']?Number(_0x4bdca1[_0x389e86(0xaa)]):0x1;if(_0x4ff6be){const _0x3101c4=_0x4bdca1['registerVerifyExpir']?Number(_0x4bdca1['registerVerifyExpir']):0x1e*0x3c,_0x3c4819=await this['verificationService']['createVerification'](_0x2a2780,verification_constant_1[_0x389e86(0xda)][_0x389e86(0xd2)],_0x3101c4),{code:_0xce1d8a,email:_0x369f97,id:_0x544ee1}=_0x3c4819,{registerVerifyEmailFrom:_0x3d610b}=_0x4bdca1;console[_0x389e86(0x135)](_0x389e86(0x127),_0x4bdca1);const _0x370cc6=await this[_0x389e86(0xf1)][_0x389e86(0xcb)]({'to':_0x369f97,'subject':'来自'+_0x3d610b+_0x389e86(0xfc),'template':_0x389e86(0x13e),'context':Object[_0x389e86(0x93)]({'baseUrl':_0x4bdca1[_0x389e86(0x126)],'code':_0xce1d8a,'id':_0x544ee1},_0x4bdca1)});console[_0x389e86(0x135)](_0x389e86(0xc6),_0x370cc6);}else{const {username:_0xa1a89e,email:_0x5bb639,id:_0x2f1f44,invitedBy:_0xa723f}=_0x2a2780;await this['updateUserStatus'](_0x2f1f44,user_constant_1[_0x389e86(0xac)][_0x389e86(0x10a)]);let _0x3aa04f;_0xa723f&&(_0x3aa04f=await this['qureyUserInfoByInviteCode'](_0xa723f)),await this[_0x389e86(0xe9)][_0x389e86(0x95)](_0x2f1f44,_0x3aa04f===null||_0x3aa04f===void 0x0?void 0x0:_0x3aa04f['id']);}return _0x2a2780;}catch(_0x5124c5){console[_0x389e86(0x135)](_0x389e86(0xb3),_0x5124c5);throw _0x5124c5;}}async[_0x762547(0x94)](){const _0xbffe98=_0x762547,_0x57898e=await this[_0xbffe98(0xb0)][_0xbffe98(0x13b)]({'where':{'role':_0xbffe98(0xd0)}});return _0x57898e;}async[_0x762547(0xf5)](_0x3a4693){const _0x15d437=_0x762547,{username:_0x3c2d68,password:_0x285bda,uid:uid=0x0,phone:_0xe95b61}=_0x3a4693;let _0xdb0238=null;if(uid>0x0){_0xdb0238=await this[_0x15d437(0xb0)][_0x15d437(0x13b)]({'where':{'id':uid}});if(!_0xdb0238)throw new common_1[(_0x15d437(0xc5))](_0x15d437(0xd7),common_1[_0x15d437(0xd4)][_0x15d437(0x92)]);if(_0xdb0238['password'][_0x15d437(0xe3)](_0x15d437(0x114))||_0xdb0238['password'][_0x15d437(0xe3)](_0x15d437(0x140))||_0xdb0238[_0x15d437(0x138)][_0x15d437(0xe3)](_0x15d437(0x108))){if(!bcrypt[_0x15d437(0x12c)](_0x285bda,_0xdb0238['password']))throw new common_1[(_0x15d437(0xc5))](_0x15d437(0xc8),common_1[_0x15d437(0xd4)][_0x15d437(0x92)]);}else{console[_0x15d437(0x135)](_0x15d437(0x125));const _0x3d4421=crypto[_0x15d437(0x115)]('md5')[_0x15d437(0x11c)](_0x285bda)[_0x15d437(0xe1)]('hex');console['log']('----,',_0x3d4421);if(_0x3d4421!==_0xdb0238[_0x15d437(0x138)])throw new common_1[(_0x15d437(0xc5))](_0x15d437(0xc8),common_1[_0x15d437(0xd4)][_0x15d437(0x92)]);}}if(_0x3c2d68&&_0x285bda){const _0x16d53d=[{'username':_0x3c2d68},{'email':_0x3c2d68}];_0xdb0238=await this[_0x15d437(0xb0)][_0x15d437(0x13b)]({'where':_0x16d53d});if(!_0xdb0238)throw new common_1[(_0x15d437(0xc5))]('当前账户不存在！',common_1['HttpStatus'][_0x15d437(0x92)]);if(_0xdb0238['password'][_0x15d437(0xe3)](_0x15d437(0x114))||_0xdb0238[_0x15d437(0x138)][_0x15d437(0xe3)](_0x15d437(0x140))||_0xdb0238[_0x15d437(0x138)][_0x15d437(0xe3)](_0x15d437(0x108))){if(!bcrypt[_0x15d437(0x12c)](_0x285bda,_0xdb0238[_0x15d437(0x138)]))throw new common_1[(_0x15d437(0xc5))](_0x15d437(0xc8),common_1[_0x15d437(0xd4)][_0x15d437(0x92)]);}else{console['log']('----,');const _0x194a87=crypto['createHash']('md5')[_0x15d437(0x11c)](_0x285bda)[_0x15d437(0xe1)](_0x15d437(0x8e));console[_0x15d437(0x135)](_0x15d437(0x125),_0x194a87);if(_0x194a87!==_0xdb0238[_0x15d437(0x138)])throw new common_1[(_0x15d437(0xc5))](_0x15d437(0xc8),common_1[_0x15d437(0xd4)][_0x15d437(0x92)]);}}if(_0xe95b61&&_0x285bda){const _0x554ac1=[{'phone':_0xe95b61}];_0xdb0238=await this[_0x15d437(0xb0)][_0x15d437(0x13b)]({'where':_0x554ac1});if(!_0xdb0238)throw new common_1[(_0x15d437(0xc5))](_0x15d437(0xd7),common_1[_0x15d437(0xd4)]['BAD_REQUEST']);if(_0xdb0238[_0x15d437(0x138)][_0x15d437(0xe3)](_0x15d437(0x114))||_0xdb0238[_0x15d437(0x138)][_0x15d437(0xe3)](_0x15d437(0x140))||_0xdb0238['password'][_0x15d437(0xe3)](_0x15d437(0x108))){if(!bcrypt[_0x15d437(0x12c)](_0x285bda,_0xdb0238['password']))throw new common_1[(_0x15d437(0xc5))](_0x15d437(0xc8),common_1[_0x15d437(0xd4)][_0x15d437(0x92)]);}else{console[_0x15d437(0x135)](_0x15d437(0x125));const _0x39bada=crypto[_0x15d437(0x115)](_0x15d437(0xa4))[_0x15d437(0x11c)](_0x285bda)[_0x15d437(0xe1)](_0x15d437(0x8e));console[_0x15d437(0x135)](_0x15d437(0x125),_0x39bada);if(_0x39bada!==_0xdb0238['password'])throw new common_1[(_0x15d437(0xc5))]('当前密码错误！',common_1['HttpStatus']['BAD_REQUEST']);}}if(!_0xdb0238)throw new common_1[(_0x15d437(0xc5))](_0x15d437(0xd7),common_1[_0x15d437(0xd4)][_0x15d437(0x92)]);if(_0xdb0238[_0x15d437(0xfa)]!==user_constant_1[_0x15d437(0xac)][_0x15d437(0x10a)])throw new common_1[(_0x15d437(0xc5))](user_constant_1[_0x15d437(0x134)][_0xdb0238[_0x15d437(0xfa)]],common_1['HttpStatus']['BAD_REQUEST']);return _0xdb0238;}async['verifyUserPassword'](_0x394103,_0xd515d3){const _0x59d079=_0x762547,_0x16f508=await this[_0x59d079(0xb0)][_0x59d079(0x13b)]({'where':{'id':_0x394103}});if(_0x16f508[_0x59d079(0x138)][_0x59d079(0xe3)](_0x59d079(0x114))||_0x16f508[_0x59d079(0x138)][_0x59d079(0xe3)](_0x59d079(0x140))||_0x16f508[_0x59d079(0x138)][_0x59d079(0xe3)](_0x59d079(0x108)))return bcrypt[_0x59d079(0x12c)](_0xd515d3,_0x16f508[_0x59d079(0x138)]);else{const _0x1af1f7=crypto[_0x59d079(0x115)](_0x59d079(0xa4))['update'](_0xd515d3)[_0x59d079(0xe1)]('hex');return console[_0x59d079(0x135)](_0x59d079(0x125),_0x1af1f7),_0x1af1f7===_0x16f508['password'];}}async[_0x762547(0xf6)](_0xddd88b,_0xdb6c9c){const _0x347faf=_0x762547,_0x2d98b9=await this['userEntity'][_0x347faf(0x11c)]({'id':_0xddd88b},{'status':_0xdb6c9c});return _0x2d98b9[_0x347faf(0x13a)]>0x0;}async[_0x762547(0x110)](_0x28cf80){const _0x912e16=_0x762547,_0x1e9ffa=await this[_0x912e16(0xb0)][_0x912e16(0x13b)]({'where':{'id':_0x28cf80}});return _0x1e9ffa[_0x912e16(0xfa)];}async[_0x762547(0xf4)](_0x1f94a3){const _0xa3ea8b=_0x762547;return await this[_0xa3ea8b(0xb0)][_0xa3ea8b(0x13b)]({'where':{'id':_0x1f94a3}});}async[_0x762547(0xb6)](_0x125903){const _0x579e36=_0x762547;return await this['userEntity'][_0x579e36(0x13b)]({'where':{'id':_0x125903}});}async[_0x762547(0x10d)](_0x5e5b7a){const _0x2bd8f0=_0x762547,{id:_0x3839bf,role:_0x4f1c2f}=_0x5e5b7a;if(_0x4f1c2f===_0x2bd8f0(0xb7))return!![];const _0x5e0d87=await this[_0x2bd8f0(0xb0)][_0x2bd8f0(0x13b)]({'where':{'id':_0x3839bf}});if(!_0x5e0d87)throw new common_1['HttpException'](_0x2bd8f0(0xaf),common_1[_0x2bd8f0(0xd4)][_0x2bd8f0(0x119)]);if(_0x5e0d87[_0x2bd8f0(0xfa)]===user_constant_1[_0x2bd8f0(0xac)]['BLACKLISTED'])throw new common_1[(_0x2bd8f0(0xc5))](_0x2bd8f0(0xa7),common_1[_0x2bd8f0(0xd4)][_0x2bd8f0(0x92)]);if(_0x5e0d87[_0x2bd8f0(0xfa)]===user_constant_1[_0x2bd8f0(0xac)][_0x2bd8f0(0x9f)])throw new common_1[(_0x2bd8f0(0xc5))](_0x2bd8f0(0xb5),common_1['HttpStatus'][_0x2bd8f0(0x92)]);}async[_0x762547(0xdc)](_0x3dfa0c){const _0x443707=_0x762547,_0x4feb26=await this[_0x443707(0xb0)][_0x443707(0x13b)]({'where':{'id':_0x3dfa0c},'select':['username',_0x443707(0xd9),_0x443707(0x13f),_0x443707(0xa1),_0x443707(0x99),_0x443707(0xc0),_0x443707(0xb4),_0x443707(0x109)]});if(!_0x4feb26)throw new common_1['HttpException'](_0x443707(0xaf),common_1['HttpStatus'][_0x443707(0x119)]);_0x4feb26[_0x443707(0x118)]=!!(_0x4feb26===null||_0x4feb26===void 0x0?void 0x0:_0x4feb26[_0x443707(0xb4)]),delete _0x4feb26[_0x443707(0xb4)];const _0x3ce5ca=await this[_0x443707(0xe9)][_0x443707(0x101)](_0x3dfa0c);return{'userInfo':_0x4feb26,'userBalance':Object[_0x443707(0x93)]({},_0x3ce5ca)};}async[_0x762547(0xba)](_0x46da23){const _0x1a1291=_0x762547;return await this[_0x1a1291(0xb0)]['findOne']({'where':{'id':_0x46da23}});}async[_0x762547(0x112)](_0x4a515c){const _0x56110d=_0x762547;return await this['userEntity'][_0x56110d(0x13b)]({'where':{'openId':_0x4a515c}});}async['updateInfo'](_0x21fa49,_0x5dadb2){const _0x3efb28=_0x762547,{id:_0x30ccbf}=_0x5dadb2[_0x3efb28(0xd1)],_0x5ad021=await this[_0x3efb28(0xb0)][_0x3efb28(0x13b)]({'where':{'id':_0x30ccbf}});if(!_0x5ad021)throw new common_1[(_0x3efb28(0xc5))](_0x3efb28(0x8c),common_1[_0x3efb28(0xd4)][_0x3efb28(0x92)]);if(_0x21fa49[_0x3efb28(0xcc)]&&_0x5ad021[_0x3efb28(0xcc)]===_0x21fa49[_0x3efb28(0xcc)])throw new common_1['HttpException'](_0x3efb28(0xe6),common_1[_0x3efb28(0xd4)][_0x3efb28(0x92)]);if(_0x21fa49[_0x3efb28(0xcc)]){const _0x48495d=await this[_0x3efb28(0xb0)][_0x3efb28(0x13b)]({'where':{'username':_0x21fa49['username'],'id':(0x0,typeorm_2['Not'])(_0x30ccbf)}});if(_0x48495d)throw new common_1[(_0x3efb28(0xc5))](_0x3efb28(0xe2),common_1[_0x3efb28(0xd4)]['BAD_REQUEST']);}const _0x264850=await this[_0x3efb28(0xb0)][_0x3efb28(0x11c)]({'id':_0x30ccbf},_0x21fa49);if(_0x264850[_0x3efb28(0x13a)]<=0x0)throw new common_1['HttpException']('修改用户信息失败！',common_1[_0x3efb28(0xd4)][_0x3efb28(0x92)]);return _0x3efb28(0xce);}async[_0x762547(0xad)](_0x2908d1,_0x50acef){const _0x417850=_0x762547,_0x299da1=bcrypt[_0x417850(0xbe)](_0x50acef,0xa),_0xb7758a=await this[_0x417850(0xb0)]['update']({'id':_0x2908d1},{'password':_0x299da1});if(_0xb7758a[_0x417850(0x13a)]<=0x0)throw new common_1['HttpException'](_0x417850(0xc3),common_1[_0x417850(0xd4)][_0x417850(0x92)]);}async[_0x762547(0x10e)](_0x2f1912){const _0x134e89=_0x762547,{id:_0x3d569d}=_0x2f1912['user'],_0x526752=await this[_0x134e89(0xb0)][_0x134e89(0x13b)]({'where':{'id':_0x3d569d}});if(!_0x526752||_0x526752[_0x134e89(0xc0)])throw new common_1['HttpException'](_0x134e89(0x12a),common_1[_0x134e89(0xd4)][_0x134e89(0x92)]);const _0x34d233=(0x0,utils_1['generateRandomString'])(),_0x437ea4=await this['userEntity'][_0x134e89(0x13b)]({'where':{'inviteCode':_0x34d233}});if(_0x437ea4)throw new common_1['HttpException'](_0x134e89(0xcd),common_1[_0x134e89(0xd4)][_0x134e89(0x92)]);const _0x5981fa=await this[_0x134e89(0xb0)][_0x134e89(0x11c)]({'id':_0x3d569d},{'inviteCode':_0x34d233});if(_0x5981fa[_0x134e89(0x13a)]<=0x0)throw new common_1[(_0x134e89(0xc5))](_0x134e89(0xcd),common_1[_0x134e89(0xd4)]['BAD_REQUEST']);return _0x34d233;}async[_0x762547(0x9b)](_0x24c1f5,_0x1c08ce){const _0x33c5fa=_0x762547;try{const {id:_0x5d7199}=_0x24c1f5['user'],{page:page=0x1,size:size=0xa}=_0x1c08ce,_0x20a6dc=await this[_0x33c5fa(0xb0)]['findOne']({'where':{'id':_0x5d7199}}),{inviteCode:_0x2dba00}=_0x20a6dc;if(!_0x2dba00)return[];const [_0x5b414f,_0xde24b5]=await this[_0x33c5fa(0xb0)]['findAndCount']({'where':{'inviteCode':_0x2dba00},'order':{'id':_0x33c5fa(0xd8)},'select':[_0x33c5fa(0xcc),_0x33c5fa(0xa1),'createdAt','status','avatar'],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x33c5fa(0x11e)])(_0x5b414f)[_0x33c5fa(0x141)](_0x127f1e=>{const _0xf3cc3b=_0x33c5fa;return _0x127f1e[_0xf3cc3b(0xa1)]=(0x0,utils_1[_0xf3cc3b(0x131)])(_0x127f1e['email']),_0x127f1e;}),{'rows':_0x5b414f,'count':_0xde24b5};}catch(_0x351c05){console[_0x33c5fa(0x135)](_0x33c5fa(0xb3),_0x351c05);throw new common_1[(_0x33c5fa(0xc5))](_0x33c5fa(0xc7),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x762547(0x113)](_0x975513){const _0x19b559=_0x762547,_0x11bad7=await this[_0x19b559(0xb0)]['findOne']({'where':{'inviteCode':_0x975513}});if(!_0x11bad7)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x11bad7,_0x4c5370=await this[_0x19b559(0xb0)][_0x19b559(0x11c)]({'inviteCode':_0x975513},{'inviteLinkCount':inviteLinkCount+0x1});return _0x4c5370[_0x19b559(0x13a)]?0x1:0x0;}async[_0x762547(0x12d)](_0x2b0465){const _0x4b65c1=_0x762547;return await this[_0x4b65c1(0xb0)][_0x4b65c1(0x13b)]({'where':{'inviteCode':_0x2b0465}});}async[_0x762547(0xa0)](_0x3f813f){const _0x1f0611=_0x762547,{userId:_0x389ba2,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3f813f;await this[_0x1f0611(0xe9)][_0x1f0611(0x100)](_0x389ba2,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x48f994=await this['userBalanceService'][_0x1f0611(0x10b)]({'userId':_0x389ba2,'rechargeType':balance_constant_1[_0x1f0611(0xbb)][_0x1f0611(0xa8)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x48f994;}async[_0x762547(0xea)](_0x434b8e,_0x185a2e){const _0x8d42c4=_0x762547,{page:page=0x1,size:size=0xa,username:_0x4a0bd5,email:_0x4af790,status:_0xec9ded,keyword:_0x35ca28,phone:_0x9c588c}=_0x434b8e;let _0x48ef9d={};_0x4a0bd5&&Object[_0x8d42c4(0x93)](_0x48ef9d,{'username':(0x0,typeorm_2['Like'])('%'+_0x4a0bd5+'%')}),_0x4af790&&Object[_0x8d42c4(0x93)](_0x48ef9d,{'email':(0x0,typeorm_2[_0x8d42c4(0x11a)])('%'+_0x4af790+'%')}),_0x9c588c&&Object['assign'](_0x48ef9d,{'phone':(0x0,typeorm_2['Like'])('%'+_0x9c588c+'%')}),_0xec9ded&&Object[_0x8d42c4(0x93)](_0x48ef9d,{'status':_0xec9ded});_0x35ca28&&(_0x48ef9d=[{'username':(0x0,typeorm_2[_0x8d42c4(0x11a)])('%'+_0x35ca28+'%')},{'email':(0x0,typeorm_2['Like'])('%'+_0x35ca28+'%')},{'phone':(0x0,typeorm_2['Like'])('%'+_0x35ca28+'%')}]);const [_0x522804,_0xef91b8]=await this[_0x8d42c4(0xb0)][_0x8d42c4(0xb2)]({'skip':(page-0x1)*size,'where':_0x48ef9d,'take':size,'order':{'createdAt':'DESC'},'cache':!![],'select':['username',_0x8d42c4(0xd9),'inviteCode',_0x8d42c4(0x13f),'sign',_0x8d42c4(0xfa),'id',_0x8d42c4(0xa1),_0x8d42c4(0xe7),_0x8d42c4(0x12b),_0x8d42c4(0xdf)]}),_0x4fa120=_0x522804[_0x8d42c4(0x141)](_0x280fa0=>_0x280fa0['id']),_0x2527e7=await this[_0x8d42c4(0xe9)]['queryUserBalanceByIds'](_0x4fa120);return _0x522804[_0x8d42c4(0xc4)](_0x2ac81a=>_0x2ac81a['balanceInfo']=_0x2527e7[_0x8d42c4(0x107)](_0x1e4d0b=>_0x1e4d0b[_0x8d42c4(0xc1)]===_0x2ac81a['id'])),_0x185a2e['user'][_0x8d42c4(0x13f)]!==_0x8d42c4(0xd0)&&_0x522804[_0x8d42c4(0xc4)](_0x5e9166=>_0x5e9166[_0x8d42c4(0xa1)]=(0x0,utils_1[_0x8d42c4(0x131)])(_0x5e9166['email'])),_0x185a2e['user']['role']!==_0x8d42c4(0xd0)&&_0x522804['forEach'](_0x32defe=>_0x32defe[_0x8d42c4(0x12b)]=(0x0,utils_1['maskIpAddress'])(_0x32defe[_0x8d42c4(0x12b)])),_0x185a2e[_0x8d42c4(0xd1)][_0x8d42c4(0x13f)]!=='super'&&_0x522804[_0x8d42c4(0xc4)](_0x5b5d25=>_0x5b5d25[_0x8d42c4(0xdf)]=(0x0,utils_1['maskIpAddress'])(_0x5b5d25['phone'])),{'rows':_0x522804,'count':_0xef91b8};}async[_0x762547(0xbd)]({id:_0x4db52b}){const _0x574b4b=_0x762547;return await this[_0x574b4b(0xb0)]['findOne']({'where':{'id':_0x4db52b},'select':[_0x574b4b(0xcc),_0x574b4b(0xd9),_0x574b4b(0xc0),_0x574b4b(0x13f),'sign',_0x574b4b(0xfa)]});}async['updateStatus'](_0x339bad){const _0x4e231d=_0x762547,{id:_0x5b135b,status:_0x452105}=_0x339bad,_0x5509d3=await this[_0x4e231d(0xb0)][_0x4e231d(0x13b)]({'where':{'id':_0x5b135b}});if(!_0x5509d3)throw new common_1[(_0x4e231d(0xc5))](_0x4e231d(0x12e),common_1['HttpStatus'][_0x4e231d(0x92)]);if(_0x5509d3['role']===_0x4e231d(0xd0))throw new common_1[(_0x4e231d(0xc5))](_0x4e231d(0x91),common_1[_0x4e231d(0xd4)][_0x4e231d(0x92)]);if(_0x5509d3[_0x4e231d(0xfa)]===user_constant_1[_0x4e231d(0xac)][_0x4e231d(0xa9)])throw new common_1[(_0x4e231d(0xc5))](_0x4e231d(0xb1),common_1[_0x4e231d(0xd4)][_0x4e231d(0x92)]);if(_0x5509d3['role']==='super')throw new common_1[(_0x4e231d(0xc5))]('超级管理员不可被操作！',common_1[_0x4e231d(0xd4)]['BAD_REQUEST']);if(_0x452105===user_constant_1['UserStatusEnum']['PENDING'])throw new common_1[(_0x4e231d(0xc5))]('不可将用户置为未激活状态！',common_1[_0x4e231d(0xd4)][_0x4e231d(0x92)]);const _0xc12aaf=await this['userEntity']['update']({'id':_0x5b135b},{'status':_0x452105});if(_0xc12aaf[_0x4e231d(0x13a)]<=0x0)throw new common_1['HttpException']('修改用户状态失败！',common_1['HttpStatus'][_0x4e231d(0x92)]);return _0x4e231d(0xe8);}async['resetUserPass'](_0x518a82){const _0xf62ebc=_0x762547,{id:_0x3fd313}=_0x518a82,_0xb1d9f4=await this[_0xf62ebc(0xb0)][_0xf62ebc(0x13b)]({'where':{'id':_0x3fd313}});if(!_0xb1d9f4)throw new common_1[(_0xf62ebc(0xc5))](_0xf62ebc(0x12e),common_1['HttpStatus'][_0xf62ebc(0x92)]);const _0x5c3603=_0xf62ebc(0xae),_0xd1843=bcrypt['hashSync'](_0x5c3603,0xa),_0x2cc198=await this['userEntity'][_0xf62ebc(0x11c)]({'id':_0x3fd313},{'password':_0xd1843});if(_0x2cc198['affected']<=0x0)throw new common_1[(_0xf62ebc(0xc5))](_0xf62ebc(0x133),common_1[_0xf62ebc(0xd4)][_0xf62ebc(0x92)]);return _0xf62ebc(0x13d)+_0x5c3603+_0xf62ebc(0xc9);}async[_0x762547(0x136)](_0x355882,_0x11ad7b){const _0x39e024=_0x762547;return await this[_0x39e024(0xb0)][_0x39e024(0x11c)]({'id':_0x355882},{'lastLoginIp':_0x11ad7b});}async['getUserFromOpenId'](_0x38cf54,_0x3718a9){const _0x205c2d=_0x762547,_0x13ca5c=await this[_0x205c2d(0xb0)][_0x205c2d(0x13b)]({'where':{'openId':_0x38cf54}});if(!_0x13ca5c){const _0x5576bd=_0x3718a9?_0x3718a9[_0x205c2d(0x12f)](':')[0x1]:'',_0x4cb26b=await this[_0x205c2d(0x12d)](_0x5576bd),_0x4a44d0=await this[_0x205c2d(0xe4)](_0x38cf54,_0x5576bd);return await this[_0x205c2d(0xe9)]['addBalanceToNewUser'](_0x4a44d0['id'],_0x5576bd?_0x4cb26b===null||_0x4cb26b===void 0x0?void 0x0:_0x4cb26b['id']:null),_0x4a44d0;}return _0x13ca5c;}async['createUserFromOpenId'](_0x5149df,_0x2f039a){const _0x3494fb=_0x762547,_0x5ad6a7=await this['globalConfigService'][_0x3494fb(0xf2)](['userDefautlAvatar']),_0x5b61c4={'avatar':_0x5ad6a7,'username':'用户'+(0x0,utils_1['createRandomUid'])(),'status':user_constant_1['UserStatusEnum']['ACTIVE'],'sex':0x0,'email':(0x0,utils_1[_0x3494fb(0xa3)])()+_0x3494fb(0xf0),'invitedBy':_0x2f039a,'openId':_0x5149df},_0x4db4c5=await this[_0x3494fb(0xb0)][_0x3494fb(0x104)](_0x5b61c4);return _0x4db4c5;}async[_0x762547(0xa2)](_0x11461b,_0x349096){const _0x1381dd=_0x762547;try{const _0x6502d0=await this[_0x1381dd(0xb0)][_0x1381dd(0x13b)]({'where':{'id':_0x349096}});if(!_0x6502d0)return{'status':![],'msg':'当前绑定用户不存在！'};const _0x1cb249=await this['userEntity'][_0x1381dd(0x13b)]({'where':{'openId':_0x11461b}});if(_0x1cb249)return{'status':![],'msg':'该微信已绑定其他账号！'};const _0x3fb05a=await this['userEntity']['update']({'id':_0x349096},{'openId':_0x11461b});if(_0x3fb05a[_0x1381dd(0x13a)]<=0x0)return{'status':![],'msg':_0x1381dd(0x10f)};return{'status':!![],'msg':_0x1381dd(0xf7)};}catch(_0x14d5cc){return{'status':![],'msg':_0x1381dd(0x10f)};}}async['getOpenIdByUserId'](_0x3a4d01){const _0x2247f2=_0x762547,_0x36a9e3=await this['userEntity'][_0x2247f2(0x13b)]({'where':{'id':_0x3a4d01}});return _0x36a9e3===null||_0x36a9e3===void 0x0?void 0x0:_0x36a9e3[_0x2247f2(0xb4)];}async[_0x762547(0x13c)](_0x2593cb){const _0xdd6bce=_0x762547,{username:_0x24d569,password:_0x1c702d,phone:_0x2ab9e5,phoneCode:_0x4884ed}=_0x2593cb,_0x5176a6=await this['userEntity'][_0xdd6bce(0x13b)]({'where':[{'username':_0x24d569},{'phone':_0x2ab9e5}]});if(_0x5176a6&&_0x5176a6['username']===_0x24d569)throw new common_1[(_0xdd6bce(0xc5))](_0xdd6bce(0xab),common_1[_0xdd6bce(0xd4)]['BAD_REQUEST']);if(_0x5176a6&&_0x5176a6['phone']===_0x2ab9e5)throw new common_1[(_0xdd6bce(0xc5))](_0xdd6bce(0x102),common_1[_0xdd6bce(0xd4)][_0xdd6bce(0x92)]);}async[_0x762547(0x116)](_0x41189f){const _0x197b63=_0x762547;return await this[_0x197b63(0xb0)]['save'](_0x41189f);}};function _0x4596(){const _0x5f0239=['8825803ScfanN','formatCreateOrUpdateDate','getOwnPropertyDescriptor','bcryptjs','ConfigEntity','Connection','__esModule','InjectRepository','----,','registerBaseUrl','configMap:\x20','@nestjs/common','configEntity','已生成过邀请码、请勿重复生成','lastLoginIp','compareSync','qureyUserInfoByInviteCode','用户不存在！','split','function','maskEmail','crypto','重置密码失败！','UserStatusErrMsg','log','savaLoginIp','5393vmjTid','password','registerVerifyExpir','affected','findOne','verifyUserRegisterByPhone','密码重置为[','register','role','$2b$','map','当前用户不存在！','userDefautlAvatar','hex','design:paramtypes','globalConfigService','超级管理员不可被操作！','BAD_REQUEST','assign','getSuper','addBalanceToNewUser','WhiteListEntity','162UAeNUQ','@nestjs-modules/mailer','sign','configVal','getInviteRecord','defineProperty','580ROiDXC','用户名或者邮箱已被注册！','LOCKED','userRecharge','email','bindWx','createRandomUid','md5','@nestjs/typeorm','configKey','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','ADMIN_GIFT','PENDING','isVerifyEmail','用户名已存在、请更换用户名！','UserStatusEnum','updateUserPassword','123456','当前用户信息失效、请重新登录！','userEntity','未激活用户不可手动变更状态！','findAndCount','error:\x20','openId','您的账户已被封禁、如有疑问、请联系管理员！','queryOneUserInfo','visitor','7746300ieUrfJ','1644uDhawQ','getUserById','RechargeType','registerVerifyEmailTitle','queryOne','hashSync','6TaFKop','inviteCode','userId','VerificationService','修改密码失败、请重新试试吧。','forEach','HttpException','email\x20response\x20\x20->\x20:\x20','获取邀请记录失败！','当前密码错误！',']成功!','connection','sendMail','username','生成邀请码失败，请重新试一次吧！','修改用户信息成功！','50154dTNAKc','super','user','Registration','../verification/verification.service','HttpStatus','3067904sUSgYt','verificationService','当前账户不存在！','DESC','avatar','VerificationEnum','Repository','getUserInfo','decorate','GlobalConfigService','phone','./user.entity','digest','用户名已存在！','startsWith','createUserFromOpenId','getClientIp','没有变更，无需更改！','createdAt','修改用户状态成功！','userBalanceService','queryAll','162711COGXmH','../../common/utils','../globalConfig/globalConfig.service','../chatgpt/whiteList.entity','typeorm','@default.com','mailerService','getConfigs','UserService','queryUserInfoById','verifyUserCredentials','updateUserStatus','恭喜您绑定成功、后续可直接扫码登录了！','113146BjVAtK','__param','status','metadata','的账号激活','createUserAndVerifycation','registerVerifyEmailFrom','registerIp','addBalanceToUser','queryUserBalance','当前手机号已注册、请勿重复注册！','无效的邀请码！','save','client','object','find','$2y$','consecutiveDays','ACTIVE','saveRecordRechargeLog','__decorate','checkUserStatus','genInviteCode','绑定微信失败、请联系管理员！','getUserStatus','300QaoAQc','getUserOpenId','inviteLink','$2a$','createHash','createUser','__metadata','isBindWx','UNAUTHORIZED','Like','Injectable','update'];_0x4596=function(){return _0x5f0239;};return _0x4596();}function _0x4815(_0x5de086,_0x216d25){const _0x4596f3=_0x4596();return _0x4815=function(_0x481593,_0x355ca7){_0x481593=_0x481593-0x8c;let _0x33b307=_0x4596f3[_0x481593];return _0x33b307;},_0x4815(_0x5de086,_0x216d25);}UserService=__decorate([(0x0,common_1[_0x762547(0x11b)])(),__param(0x0,(0x0,typeorm_1[_0x762547(0x124)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1[_0x762547(0x96)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x762547(0x121)])),__metadata(_0x762547(0x8f),[typeorm_2[_0x762547(0xdb)],typeorm_2['Repository'],typeorm_2[_0x762547(0x122)],verification_service_1[_0x762547(0xc2)],mailer_1['MailerService'],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x762547(0xde)],typeorm_2[_0x762547(0xdb)]])],UserService),exports[_0x762547(0xf3)]=UserService;