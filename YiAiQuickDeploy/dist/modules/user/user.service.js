'use strict';function _0x5e97(_0x112da9,_0x5d3188){const _0x3adcd5=_0x3adc();return _0x5e97=function(_0x5e978e,_0x3f9162){_0x5e978e=_0x5e978e-0x1dc;let _0x985e98=_0x3adcd5[_0x5e978e];return _0x985e98;},_0x5e97(_0x112da9,_0x5d3188);}const _0x4d9a7c=_0x5e97;(function(_0x3a0701,_0x25f1c0){const _0x643f53=_0x5e97,_0x45c9a3=_0x3a0701();while(!![]){try{const _0x359176=parseInt(_0x643f53(0x20c))/0x1+parseInt(_0x643f53(0x284))/0x2+-parseInt(_0x643f53(0x1ee))/0x3+-parseInt(_0x643f53(0x254))/0x4+parseInt(_0x643f53(0x212))/0x5*(-parseInt(_0x643f53(0x266))/0x6)+parseInt(_0x643f53(0x1ff))/0x7+-parseInt(_0x643f53(0x236))/0x8;if(_0x359176===_0x25f1c0)break;else _0x45c9a3['push'](_0x45c9a3['shift']());}catch(_0x3bd66b){_0x45c9a3['push'](_0x45c9a3['shift']());}}}(_0x3adc,0x23974));var __decorate=this&&this[_0x4d9a7c(0x22d)]||function(_0x26c3bb,_0x472c9f,_0x1a587a,_0x4800c0){const _0x3d4938=_0x4d9a7c;var _0x4d46c4=arguments['length'],_0x447b05=_0x4d46c4<0x3?_0x472c9f:_0x4800c0===null?_0x4800c0=Object['getOwnPropertyDescriptor'](_0x472c9f,_0x1a587a):_0x4800c0,_0x4961dd;if(typeof Reflect===_0x3d4938(0x275)&&typeof Reflect[_0x3d4938(0x229)]===_0x3d4938(0x239))_0x447b05=Reflect[_0x3d4938(0x229)](_0x26c3bb,_0x472c9f,_0x1a587a,_0x4800c0);else{for(var _0x98bc86=_0x26c3bb['length']-0x1;_0x98bc86>=0x0;_0x98bc86--)if(_0x4961dd=_0x26c3bb[_0x98bc86])_0x447b05=(_0x4d46c4<0x3?_0x4961dd(_0x447b05):_0x4d46c4>0x3?_0x4961dd(_0x472c9f,_0x1a587a,_0x447b05):_0x4961dd(_0x472c9f,_0x1a587a))||_0x447b05;}return _0x4d46c4>0x3&&_0x447b05&&Object[_0x3d4938(0x286)](_0x472c9f,_0x1a587a,_0x447b05),_0x447b05;},__metadata=this&&this[_0x4d9a7c(0x231)]||function(_0x26094b,_0xe742a8){const _0x15b7ab=_0x4d9a7c;if(typeof Reflect===_0x15b7ab(0x275)&&typeof Reflect[_0x15b7ab(0x20a)]==='function')return Reflect['metadata'](_0x26094b,_0xe742a8);},__param=this&&this[_0x4d9a7c(0x25e)]||function(_0x48b789,_0x378ccb){return function(_0x32fbfa,_0x13e339){_0x378ccb(_0x32fbfa,_0x13e339,_0x48b789);};};Object['defineProperty'](exports,_0x4d9a7c(0x21f),{'value':!![]}),exports[_0x4d9a7c(0x1dc)]=void 0x0;const globalConfig_service_1=require(_0x4d9a7c(0x256)),user_constant_1=require('../../common/constants/user.constant'),mailer_1=require(_0x4d9a7c(0x210)),verification_service_1=require(_0x4d9a7c(0x27e)),common_1=require(_0x4d9a7c(0x250)),typeorm_1=require(_0x4d9a7c(0x1fc)),typeorm_2=require(_0x4d9a7c(0x27c)),user_entity_1=require(_0x4d9a7c(0x279)),bcrypt=require(_0x4d9a7c(0x267)),crypto=require(_0x4d9a7c(0x220)),_=require(_0x4d9a7c(0x1f2)),verification_constant_1=require(_0x4d9a7c(0x277)),userBalance_service_1=require(_0x4d9a7c(0x27f)),utils_1=require(_0x4d9a7c(0x27b)),balance_constant_1=require(_0x4d9a7c(0x204)),config_entity_1=require(_0x4d9a7c(0x23a)),whiteList_entity_1=require(_0x4d9a7c(0x262));function _0x3adc(){const _0x174101=['sign','该微信已绑定其他账号！','lastLoginIp','已生成过邀请码、请勿重复生成','password','queryOneUserInfo','sendMail','Registration','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','HttpStatus','balanceInfo','RechargeType','$2b$','PENDING','没有变更，无需更改！','bindWx','hashSync','avatar','@nestjs/common','whiteListEntity','queryUserInfoById','@default.com','489084LZVyaz','修改用户状态成功！','../globalConfig/globalConfig.service','registerVerifyExpir','getUserFromOpenId','formatCreateOrUpdateDate','getConfigs','status','email','修改密码失败、请重新试试吧。','__param','inviteCode','hex','当前密码错误！','../chatgpt/whiteList.entity','client','log','queryUserBalanceByIds','2946UzTtSS','bcryptjs','digest','userId','findOne','maskIpAddress','您的账户已被封禁、如有疑问、请联系管理员！','mailerService','md5','未激活用户不可手动变更状态！','VerificationService','userEntity','verifyUserPassword','cloneDeep','当前手机号已注册、请勿重复注册！','object','getClientIp','../../common/constants/verification.constant','当前绑定用户不存在！','./user.entity','registerVerifyEmailTitle','../../common/utils','typeorm','role','../verification/verification.service','../userBalance/userBalance.service','getInviteRecord','重置密码失败！','phone','修改用户信息失败！','389774KFdlyQ','qureyUserInfoByInviteCode','defineProperty','LOCKED','密码重置为[','save','checkUserStatus','verificationService','UserService','split','registerBaseUrl','不可将用户置为未激活状态！','inviteLink','getUserOpenId','configKey','ConfigEntity','Repository','Not','configEntity','createVerification','getSuper','无效的邀请码！','createRandomUid','connection','BAD_REQUEST','findAndCount','67680NQFnyO','updateStatus','addBalanceToNewUser','map','lodash','startsWith','Injectable','userBalanceService','maskEmail','username','globalConfigService','saveRecordRechargeLog','绑定微信失败、请联系管理员！','resetUserPass','@nestjs/typeorm','isBindWx','Connection','2031925wMAAiR','configVal','openId','error:\x20','ACTIVE','../../common/constants/balance.constant','当前账户不存在！','register','DESC','updateUserPassword','forEach','metadata','configMap:\x20','159782FsehjZ','updateUserStatus','update','getOpenIdByUserId','@nestjs-modules/mailer','生成邀请码失败，请重新试一次吧！','1220sGmgeh','verifyUserCredentials','getUserStatus','super','UNAUTHORIZED','$2a$','createUser','VerificationEnum','用户不存在！','affected','HttpException','genInviteCode','InjectRepository','__esModule','crypto','registerVerifyEmailFrom','UserStatusEnum','createHash','updateInfo','compareSync','当前用户信息失效、请重新登录！','WhiteListEntity','createUserAndVerifycation','decorate','createUserFromOpenId','修改用户信息成功！','createdAt','__decorate','consecutiveDays','generateRandomString','assign','__metadata','Like','的账号激活','用户名已存在！','123456','1876232VsVaEO','user','----,','function','../globalConfig/config.entity','恭喜您绑定成功、后续可直接扫码登录了！','$2y$','userDefautlAvatar'];_0x3adc=function(){return _0x174101;};return _0x3adc();}let UserService=class UserService{constructor(_0x40babc,_0x2e23d1,_0xa422d0,_0x493607,_0x23d63a,_0x80168f,_0x9f0c24,_0x49d0f9){const _0x308435=_0x4d9a7c;this[_0x308435(0x271)]=_0x40babc,this[_0x308435(0x251)]=_0x2e23d1,this[_0x308435(0x1eb)]=_0xa422d0,this[_0x308435(0x28b)]=_0x493607,this[_0x308435(0x26d)]=_0x23d63a,this[_0x308435(0x1f5)]=_0x80168f,this[_0x308435(0x1f8)]=_0x9f0c24,this[_0x308435(0x1e6)]=_0x49d0f9;}async[_0x4d9a7c(0x228)](_0x2a5462,_0x11028c){const _0x351f1b=_0x4d9a7c,{username:_0x4df21e,email:_0x158690,password:_0x4d46e1,invitedBy:_0x5d898e,client:client=0x0}=_0x2a5462;if(_0x5d898e){const _0x31bc10=await this[_0x351f1b(0x271)][_0x351f1b(0x26a)]({'where':{'inviteCode':_0x5d898e}});if(!_0x31bc10)throw new common_1['HttpException'](_0x351f1b(0x1e9),common_1[_0x351f1b(0x247)]['BAD_REQUEST']);}const _0x2ca8af=[{'username':_0x4df21e},{'email':_0x158690}],_0x3b741c=await this[_0x351f1b(0x271)]['findOne']({'where':_0x2ca8af});if(_0x3b741c&&_0x3b741c[_0x351f1b(0x25b)]!==user_constant_1[_0x351f1b(0x222)][_0x351f1b(0x24b)])throw new common_1[(_0x351f1b(0x21c))]('用户名或者邮箱已被注册！',common_1[_0x351f1b(0x247)][_0x351f1b(0x1ec)]);try{const _0x5eb097=_[_0x351f1b(0x273)](_0x2a5462),_0x40ac78=bcrypt[_0x351f1b(0x24e)](_0x4d46e1,0xa),_0x49e6cf=(0x0,utils_1[_0x351f1b(0x276)])(_0x11028c);_0x5eb097[_0x351f1b(0x242)]=_0x40ac78,_0x5eb097['registerIp']=_0x49e6cf,_0x5eb097[_0x351f1b(0x263)]=client;let _0x383053;if(!_0x3b741c){const _0x48fbdc=await this[_0x351f1b(0x1f8)][_0x351f1b(0x25a)]([_0x351f1b(0x23d)]);_0x5eb097[_0x351f1b(0x24f)]=_0x48fbdc,_0x383053=await this[_0x351f1b(0x271)][_0x351f1b(0x289)](_0x5eb097);}else _0x383053=_0x3b741c;const _0x3fd896=await this['configEntity']['find']({'where':{'configKey':(0x0,typeorm_2['In'])(['isVerifyEmail',_0x351f1b(0x1de),_0x351f1b(0x27a),'registerVerifyEmailDesc',_0x351f1b(0x221),'registerVerifyExpir'])}}),_0x2aecb0=_0x3fd896['reduce']((_0x5112ab,_0x1a58e3)=>{const _0x52c189=_0x351f1b;return _0x5112ab[_0x1a58e3[_0x52c189(0x1e2)]]=_0x1a58e3[_0x52c189(0x200)],_0x5112ab;},{}),_0x9e12c4=_0x2aecb0['isVerifyEmail']?Number(_0x2aecb0['isVerifyEmail']):0x1;if(_0x9e12c4){const _0xa8a49f=_0x2aecb0['registerVerifyExpir']?Number(_0x2aecb0[_0x351f1b(0x257)]):0x1e*0x3c,_0x34a33d=await this[_0x351f1b(0x28b)][_0x351f1b(0x1e7)](_0x383053,verification_constant_1[_0x351f1b(0x219)][_0x351f1b(0x245)],_0xa8a49f),{code:_0x531fb1,email:_0x4d7e00,id:_0x4ca8e5}=_0x34a33d,{registerVerifyEmailFrom:_0x3bdac5}=_0x2aecb0;console[_0x351f1b(0x264)](_0x351f1b(0x20b),_0x2aecb0);const _0x1ebec5=await this[_0x351f1b(0x26d)][_0x351f1b(0x244)]({'to':_0x4d7e00,'subject':'来自'+_0x3bdac5+_0x351f1b(0x233),'template':_0x351f1b(0x206),'context':Object[_0x351f1b(0x230)]({'baseUrl':_0x2aecb0[_0x351f1b(0x1de)],'code':_0x531fb1,'id':_0x4ca8e5},_0x2aecb0)});console[_0x351f1b(0x264)]('email\x20response\x20\x20->\x20:\x20',_0x1ebec5);}else{const {username:_0xc03e11,email:_0x25f3a4,id:_0x6df2c6,invitedBy:_0xa68ac0}=_0x383053;await this[_0x351f1b(0x20d)](_0x6df2c6,user_constant_1[_0x351f1b(0x222)][_0x351f1b(0x203)]);let _0x3d25bb;_0xa68ac0&&(_0x3d25bb=await this[_0x351f1b(0x285)](_0xa68ac0)),await this[_0x351f1b(0x1f5)][_0x351f1b(0x1f0)](_0x6df2c6,_0x3d25bb===null||_0x3d25bb===void 0x0?void 0x0:_0x3d25bb['id']);}return _0x383053;}catch(_0x47ca95){console['log'](_0x351f1b(0x202),_0x47ca95);throw _0x47ca95;}}async[_0x4d9a7c(0x1e8)](){const _0x50b88e=_0x4d9a7c,_0x314d10=await this[_0x50b88e(0x271)][_0x50b88e(0x26a)]({'where':{'role':_0x50b88e(0x215)}});return _0x314d10;}async[_0x4d9a7c(0x213)](_0x4f62f1){const _0x4a91ea=_0x4d9a7c,{username:_0x5364c9,password:_0x1dd25b,uid:uid=0x0,phone:_0x3858dd}=_0x4f62f1;let _0x536fb5=null;if(uid>0x0){_0x536fb5=await this[_0x4a91ea(0x271)][_0x4a91ea(0x26a)]({'where':{'id':uid}});if(!_0x536fb5)throw new common_1[(_0x4a91ea(0x21c))](_0x4a91ea(0x205),common_1[_0x4a91ea(0x247)]['BAD_REQUEST']);if(_0x536fb5[_0x4a91ea(0x242)][_0x4a91ea(0x1f3)](_0x4a91ea(0x217))||_0x536fb5[_0x4a91ea(0x242)][_0x4a91ea(0x1f3)](_0x4a91ea(0x24a))||_0x536fb5[_0x4a91ea(0x242)][_0x4a91ea(0x1f3)]('$2y$')){if(!bcrypt[_0x4a91ea(0x225)](_0x1dd25b,_0x536fb5[_0x4a91ea(0x242)]))throw new common_1[(_0x4a91ea(0x21c))](_0x4a91ea(0x261),common_1['HttpStatus']['BAD_REQUEST']);}else{console['log']('----,');const _0x304914=crypto['createHash'](_0x4a91ea(0x26e))[_0x4a91ea(0x20e)](_0x1dd25b)['digest'](_0x4a91ea(0x260));console[_0x4a91ea(0x264)](_0x4a91ea(0x238),_0x304914);if(_0x304914!==_0x536fb5['password'])throw new common_1[(_0x4a91ea(0x21c))]('当前密码错误！',common_1[_0x4a91ea(0x247)][_0x4a91ea(0x1ec)]);}}if(_0x5364c9&&_0x1dd25b){const _0x52cdec=[{'username':_0x5364c9},{'email':_0x5364c9}];_0x536fb5=await this['userEntity'][_0x4a91ea(0x26a)]({'where':_0x52cdec});if(!_0x536fb5)throw new common_1[(_0x4a91ea(0x21c))](_0x4a91ea(0x205),common_1[_0x4a91ea(0x247)][_0x4a91ea(0x1ec)]);if(_0x536fb5[_0x4a91ea(0x242)][_0x4a91ea(0x1f3)](_0x4a91ea(0x217))||_0x536fb5[_0x4a91ea(0x242)]['startsWith']('$2b$')||_0x536fb5[_0x4a91ea(0x242)][_0x4a91ea(0x1f3)]('$2y$')){if(!bcrypt[_0x4a91ea(0x225)](_0x1dd25b,_0x536fb5[_0x4a91ea(0x242)]))throw new common_1[(_0x4a91ea(0x21c))](_0x4a91ea(0x261),common_1[_0x4a91ea(0x247)]['BAD_REQUEST']);}else{console[_0x4a91ea(0x264)](_0x4a91ea(0x238));const _0x229f88=crypto[_0x4a91ea(0x223)](_0x4a91ea(0x26e))[_0x4a91ea(0x20e)](_0x1dd25b)['digest']('hex');console[_0x4a91ea(0x264)]('----,',_0x229f88);if(_0x229f88!==_0x536fb5['password'])throw new common_1[(_0x4a91ea(0x21c))](_0x4a91ea(0x261),common_1[_0x4a91ea(0x247)][_0x4a91ea(0x1ec)]);}}if(_0x3858dd&&_0x1dd25b){const _0x4e4c87=[{'phone':_0x3858dd}];_0x536fb5=await this[_0x4a91ea(0x271)][_0x4a91ea(0x26a)]({'where':_0x4e4c87});if(!_0x536fb5)throw new common_1[(_0x4a91ea(0x21c))](_0x4a91ea(0x205),common_1['HttpStatus'][_0x4a91ea(0x1ec)]);if(_0x536fb5[_0x4a91ea(0x242)]['startsWith'](_0x4a91ea(0x217))||_0x536fb5[_0x4a91ea(0x242)][_0x4a91ea(0x1f3)]('$2b$')||_0x536fb5[_0x4a91ea(0x242)][_0x4a91ea(0x1f3)](_0x4a91ea(0x23c))){if(!bcrypt['compareSync'](_0x1dd25b,_0x536fb5['password']))throw new common_1['HttpException'](_0x4a91ea(0x261),common_1['HttpStatus'][_0x4a91ea(0x1ec)]);}else{console[_0x4a91ea(0x264)](_0x4a91ea(0x238));const _0x131e50=crypto[_0x4a91ea(0x223)](_0x4a91ea(0x26e))[_0x4a91ea(0x20e)](_0x1dd25b)['digest'](_0x4a91ea(0x260));console['log']('----,',_0x131e50);if(_0x131e50!==_0x536fb5['password'])throw new common_1['HttpException']('当前密码错误！',common_1['HttpStatus']['BAD_REQUEST']);}}if(!_0x536fb5)throw new common_1[(_0x4a91ea(0x21c))](_0x4a91ea(0x205),common_1[_0x4a91ea(0x247)][_0x4a91ea(0x1ec)]);if(_0x536fb5[_0x4a91ea(0x25b)]!==user_constant_1[_0x4a91ea(0x222)]['ACTIVE'])throw new common_1[(_0x4a91ea(0x21c))](user_constant_1['UserStatusErrMsg'][_0x536fb5[_0x4a91ea(0x25b)]],common_1[_0x4a91ea(0x247)][_0x4a91ea(0x1ec)]);return _0x536fb5;}async[_0x4d9a7c(0x272)](_0x3a8e0f,_0x4335c2){const _0x2bff27=_0x4d9a7c,_0x12351e=await this[_0x2bff27(0x271)][_0x2bff27(0x26a)]({'where':{'id':_0x3a8e0f}});if(_0x12351e[_0x2bff27(0x242)][_0x2bff27(0x1f3)](_0x2bff27(0x217))||_0x12351e[_0x2bff27(0x242)][_0x2bff27(0x1f3)](_0x2bff27(0x24a))||_0x12351e[_0x2bff27(0x242)][_0x2bff27(0x1f3)](_0x2bff27(0x23c)))return bcrypt[_0x2bff27(0x225)](_0x4335c2,_0x12351e['password']);else{const _0x58b630=crypto[_0x2bff27(0x223)](_0x2bff27(0x26e))['update'](_0x4335c2)[_0x2bff27(0x268)]('hex');return console['log']('----,',_0x58b630),_0x58b630===_0x12351e[_0x2bff27(0x242)];}}async['updateUserStatus'](_0x4c9adc,_0x3913d0){const _0x219bc6=_0x4d9a7c,_0x672a65=await this[_0x219bc6(0x271)][_0x219bc6(0x20e)]({'id':_0x4c9adc},{'status':_0x3913d0});return _0x672a65['affected']>0x0;}async[_0x4d9a7c(0x214)](_0x133369){const _0x3ac19c=_0x4d9a7c,_0x3bfc81=await this[_0x3ac19c(0x271)][_0x3ac19c(0x26a)]({'where':{'id':_0x133369}});return _0x3bfc81['status'];}async[_0x4d9a7c(0x252)](_0x5c5e23){const _0x56e5da=_0x4d9a7c;return await this[_0x56e5da(0x271)][_0x56e5da(0x26a)]({'where':{'id':_0x5c5e23}});}async[_0x4d9a7c(0x243)](_0x2724b4){const _0x1fc970=_0x4d9a7c;return await this[_0x1fc970(0x271)][_0x1fc970(0x26a)]({'where':{'id':_0x2724b4}});}async[_0x4d9a7c(0x28a)](_0x47a27c){const _0x13f081=_0x4d9a7c,{id:_0x17e071,role:_0x4ff7cc}=_0x47a27c;if(_0x4ff7cc==='visitor')return!![];const _0x57a2ef=await this[_0x13f081(0x271)][_0x13f081(0x26a)]({'where':{'id':_0x17e071}});if(!_0x57a2ef)throw new common_1['HttpException'](_0x13f081(0x226),common_1[_0x13f081(0x247)]['UNAUTHORIZED']);if(_0x57a2ef[_0x13f081(0x25b)]===user_constant_1[_0x13f081(0x222)]['BLACKLISTED'])throw new common_1[(_0x13f081(0x21c))](_0x13f081(0x246),common_1[_0x13f081(0x247)][_0x13f081(0x1ec)]);if(_0x57a2ef['status']===user_constant_1[_0x13f081(0x222)][_0x13f081(0x287)])throw new common_1[(_0x13f081(0x21c))](_0x13f081(0x26c),common_1['HttpStatus'][_0x13f081(0x1ec)]);}async['getUserInfo'](_0x554252){const _0x3f37d6=_0x4d9a7c,_0x37bcfe=await this[_0x3f37d6(0x271)][_0x3f37d6(0x26a)]({'where':{'id':_0x554252},'select':[_0x3f37d6(0x1f7),_0x3f37d6(0x24f),'role',_0x3f37d6(0x25c),_0x3f37d6(0x23e),_0x3f37d6(0x25f),'openId',_0x3f37d6(0x22e)]});if(!_0x37bcfe)throw new common_1[(_0x3f37d6(0x21c))]('当前用户信息失效、请重新登录！',common_1[_0x3f37d6(0x247)][_0x3f37d6(0x216)]);_0x37bcfe[_0x3f37d6(0x1fd)]=!!(_0x37bcfe===null||_0x37bcfe===void 0x0?void 0x0:_0x37bcfe[_0x3f37d6(0x201)]),delete _0x37bcfe[_0x3f37d6(0x201)];const _0x537c90=await this[_0x3f37d6(0x1f5)]['queryUserBalance'](_0x554252);return{'userInfo':_0x37bcfe,'userBalance':Object[_0x3f37d6(0x230)]({},_0x537c90)};}async['getUserById'](_0x4b180e){const _0x30588d=_0x4d9a7c;return await this['userEntity'][_0x30588d(0x26a)]({'where':{'id':_0x4b180e}});}async[_0x4d9a7c(0x1e1)](_0xb76eb1){const _0x60dbcb=_0x4d9a7c;return await this['userEntity'][_0x60dbcb(0x26a)]({'where':{'openId':_0xb76eb1}});}async[_0x4d9a7c(0x224)](_0xa21dd2,_0xb1540c){const _0x2c3680=_0x4d9a7c,{id:_0x8b311b}=_0xb1540c[_0x2c3680(0x237)],_0xcc7831=await this['userEntity'][_0x2c3680(0x26a)]({'where':{'id':_0x8b311b}});if(!_0xcc7831)throw new common_1['HttpException']('当前用户不存在！',common_1[_0x2c3680(0x247)][_0x2c3680(0x1ec)]);if(_0xa21dd2[_0x2c3680(0x1f7)]&&_0xcc7831[_0x2c3680(0x1f7)]===_0xa21dd2[_0x2c3680(0x1f7)])throw new common_1[(_0x2c3680(0x21c))](_0x2c3680(0x24c),common_1[_0x2c3680(0x247)][_0x2c3680(0x1ec)]);if(_0xa21dd2[_0x2c3680(0x1f7)]){const _0x30ba20=await this['userEntity'][_0x2c3680(0x26a)]({'where':{'username':_0xa21dd2['username'],'id':(0x0,typeorm_2[_0x2c3680(0x1e5)])(_0x8b311b)}});if(_0x30ba20)throw new common_1[(_0x2c3680(0x21c))](_0x2c3680(0x234),common_1[_0x2c3680(0x247)][_0x2c3680(0x1ec)]);}const _0x465608=await this[_0x2c3680(0x271)][_0x2c3680(0x20e)]({'id':_0x8b311b},_0xa21dd2);if(_0x465608['affected']<=0x0)throw new common_1[(_0x2c3680(0x21c))](_0x2c3680(0x283),common_1['HttpStatus']['BAD_REQUEST']);return _0x2c3680(0x22b);}async[_0x4d9a7c(0x208)](_0x3c4b79,_0x2dfb25){const _0x12183d=_0x4d9a7c,_0x4bf092=bcrypt['hashSync'](_0x2dfb25,0xa),_0x511071=await this[_0x12183d(0x271)]['update']({'id':_0x3c4b79},{'password':_0x4bf092});if(_0x511071['affected']<=0x0)throw new common_1[(_0x12183d(0x21c))](_0x12183d(0x25d),common_1[_0x12183d(0x247)][_0x12183d(0x1ec)]);}async[_0x4d9a7c(0x21d)](_0x55ffd6){const _0x2be442=_0x4d9a7c,{id:_0x2d0842}=_0x55ffd6[_0x2be442(0x237)],_0x58c724=await this[_0x2be442(0x271)][_0x2be442(0x26a)]({'where':{'id':_0x2d0842}});if(!_0x58c724||_0x58c724[_0x2be442(0x25f)])throw new common_1[(_0x2be442(0x21c))](_0x2be442(0x241),common_1['HttpStatus']['BAD_REQUEST']);const _0x37d0af=(0x0,utils_1[_0x2be442(0x22f)])(),_0x370224=await this[_0x2be442(0x271)][_0x2be442(0x26a)]({'where':{'inviteCode':_0x37d0af}});if(_0x370224)throw new common_1[(_0x2be442(0x21c))](_0x2be442(0x211),common_1['HttpStatus'][_0x2be442(0x1ec)]);const _0x25c76b=await this[_0x2be442(0x271)][_0x2be442(0x20e)]({'id':_0x2d0842},{'inviteCode':_0x37d0af});if(_0x25c76b[_0x2be442(0x21b)]<=0x0)throw new common_1[(_0x2be442(0x21c))](_0x2be442(0x211),common_1[_0x2be442(0x247)][_0x2be442(0x1ec)]);return _0x37d0af;}async[_0x4d9a7c(0x280)](_0x1c585c,_0x42ae2b){const _0x5b3bc5=_0x4d9a7c;try{const {id:_0x507dea}=_0x1c585c['user'],{page:page=0x1,size:size=0xa}=_0x42ae2b,_0x2305f2=await this['userEntity']['findOne']({'where':{'id':_0x507dea}}),{inviteCode:_0xeecb06}=_0x2305f2;if(!_0xeecb06)return[];const [_0x288355,_0x4ceef0]=await this[_0x5b3bc5(0x271)][_0x5b3bc5(0x1ed)]({'where':{'inviteCode':_0xeecb06},'order':{'id':_0x5b3bc5(0x207)},'select':[_0x5b3bc5(0x1f7),_0x5b3bc5(0x25c),_0x5b3bc5(0x22c),'status','avatar'],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x5b3bc5(0x259)])(_0x288355)[_0x5b3bc5(0x1f1)](_0x21ddc4=>{const _0x3153ea=_0x5b3bc5;return _0x21ddc4[_0x3153ea(0x25c)]=(0x0,utils_1['maskEmail'])(_0x21ddc4['email']),_0x21ddc4;}),{'rows':_0x288355,'count':_0x4ceef0};}catch(_0x53c43c){console[_0x5b3bc5(0x264)](_0x5b3bc5(0x202),_0x53c43c);throw new common_1[(_0x5b3bc5(0x21c))]('获取邀请记录失败！',common_1[_0x5b3bc5(0x247)][_0x5b3bc5(0x1ec)]);}}async[_0x4d9a7c(0x1e0)](_0x3a0c97){const _0x3d84a3=_0x4d9a7c,_0x3f9f02=await this[_0x3d84a3(0x271)]['findOne']({'where':{'inviteCode':_0x3a0c97}});if(!_0x3f9f02)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x3f9f02,_0x2728b0=await this[_0x3d84a3(0x271)]['update']({'inviteCode':_0x3a0c97},{'inviteLinkCount':inviteLinkCount+0x1});return _0x2728b0[_0x3d84a3(0x21b)]?0x1:0x0;}async[_0x4d9a7c(0x285)](_0x3a964d){const _0x259796=_0x4d9a7c;return await this[_0x259796(0x271)]['findOne']({'where':{'inviteCode':_0x3a964d}});}async['userRecharge'](_0x3dbf88){const _0x14e084=_0x4d9a7c,{userId:_0x157ae4,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3dbf88;await this[_0x14e084(0x1f5)]['addBalanceToUser'](_0x157ae4,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x581ea9=await this[_0x14e084(0x1f5)][_0x14e084(0x1f9)]({'userId':_0x157ae4,'rechargeType':balance_constant_1[_0x14e084(0x249)]['ADMIN_GIFT'],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x581ea9;}async['queryAll'](_0xa9e3d2,_0x5bd9c1){const _0x581e12=_0x4d9a7c,{page:page=0x1,size:size=0xa,username:_0x43eae0,email:_0x3a9ca5,status:_0x5952d4,keyword:_0x16c546,phone:_0x5548b5}=_0xa9e3d2;let _0x531bfe={};_0x43eae0&&Object[_0x581e12(0x230)](_0x531bfe,{'username':(0x0,typeorm_2[_0x581e12(0x232)])('%'+_0x43eae0+'%')}),_0x3a9ca5&&Object[_0x581e12(0x230)](_0x531bfe,{'email':(0x0,typeorm_2[_0x581e12(0x232)])('%'+_0x3a9ca5+'%')}),_0x5548b5&&Object['assign'](_0x531bfe,{'phone':(0x0,typeorm_2[_0x581e12(0x232)])('%'+_0x5548b5+'%')}),_0x5952d4&&Object['assign'](_0x531bfe,{'status':_0x5952d4});_0x16c546&&(_0x531bfe=[{'username':(0x0,typeorm_2[_0x581e12(0x232)])('%'+_0x16c546+'%')},{'email':(0x0,typeorm_2['Like'])('%'+_0x16c546+'%')},{'phone':(0x0,typeorm_2[_0x581e12(0x232)])('%'+_0x16c546+'%')}]);const [_0x2c4685,_0x281275]=await this[_0x581e12(0x271)][_0x581e12(0x1ed)]({'skip':(page-0x1)*size,'where':_0x531bfe,'take':size,'order':{'createdAt':'DESC'},'cache':!![],'select':[_0x581e12(0x1f7),_0x581e12(0x24f),_0x581e12(0x25f),'role',_0x581e12(0x23e),_0x581e12(0x25b),'id',_0x581e12(0x25c),_0x581e12(0x22c),_0x581e12(0x240),'phone']}),_0x4ac34a=_0x2c4685[_0x581e12(0x1f1)](_0x2bca12=>_0x2bca12['id']),_0x56523b=await this[_0x581e12(0x1f5)][_0x581e12(0x265)](_0x4ac34a);return _0x2c4685[_0x581e12(0x209)](_0x11ef96=>_0x11ef96[_0x581e12(0x248)]=_0x56523b['find'](_0x413be6=>_0x413be6[_0x581e12(0x269)]===_0x11ef96['id'])),_0x5bd9c1[_0x581e12(0x237)]['role']!==_0x581e12(0x215)&&_0x2c4685[_0x581e12(0x209)](_0x135ef8=>_0x135ef8[_0x581e12(0x25c)]=(0x0,utils_1[_0x581e12(0x1f6)])(_0x135ef8['email'])),_0x5bd9c1[_0x581e12(0x237)]['role']!=='super'&&_0x2c4685[_0x581e12(0x209)](_0x5ce042=>_0x5ce042[_0x581e12(0x240)]=(0x0,utils_1[_0x581e12(0x26b)])(_0x5ce042[_0x581e12(0x240)])),_0x5bd9c1[_0x581e12(0x237)][_0x581e12(0x27d)]!==_0x581e12(0x215)&&_0x2c4685['forEach'](_0x3df8d8=>_0x3df8d8[_0x581e12(0x282)]=(0x0,utils_1[_0x581e12(0x26b)])(_0x3df8d8['phone'])),{'rows':_0x2c4685,'count':_0x281275};}async['queryOne']({id:_0xdcf014}){const _0x247fcf=_0x4d9a7c;return await this[_0x247fcf(0x271)][_0x247fcf(0x26a)]({'where':{'id':_0xdcf014},'select':['username',_0x247fcf(0x24f),_0x247fcf(0x25f),_0x247fcf(0x27d),'sign',_0x247fcf(0x25b)]});}async[_0x4d9a7c(0x1ef)](_0x565d78){const _0x444305=_0x4d9a7c,{id:_0x506e3f,status:_0x4be6f8}=_0x565d78,_0x558ba0=await this[_0x444305(0x271)]['findOne']({'where':{'id':_0x506e3f}});if(!_0x558ba0)throw new common_1[(_0x444305(0x21c))](_0x444305(0x21a),common_1['HttpStatus'][_0x444305(0x1ec)]);if(_0x558ba0[_0x444305(0x27d)]===_0x444305(0x215))throw new common_1[(_0x444305(0x21c))]('超级管理员不可被操作！',common_1[_0x444305(0x247)][_0x444305(0x1ec)]);if(_0x558ba0[_0x444305(0x25b)]===user_constant_1[_0x444305(0x222)]['PENDING'])throw new common_1[(_0x444305(0x21c))](_0x444305(0x26f),common_1['HttpStatus'][_0x444305(0x1ec)]);if(_0x558ba0[_0x444305(0x27d)]===_0x444305(0x215))throw new common_1['HttpException']('超级管理员不可被操作！',common_1['HttpStatus']['BAD_REQUEST']);if(_0x4be6f8===user_constant_1[_0x444305(0x222)][_0x444305(0x24b)])throw new common_1[(_0x444305(0x21c))](_0x444305(0x1df),common_1['HttpStatus'][_0x444305(0x1ec)]);const _0x4eeeb8=await this[_0x444305(0x271)][_0x444305(0x20e)]({'id':_0x506e3f},{'status':_0x4be6f8});if(_0x4eeeb8[_0x444305(0x21b)]<=0x0)throw new common_1[(_0x444305(0x21c))]('修改用户状态失败！',common_1['HttpStatus'][_0x444305(0x1ec)]);return _0x444305(0x255);}async[_0x4d9a7c(0x1fb)](_0x53e49b){const _0x3e9aff=_0x4d9a7c,{id:_0x391f28}=_0x53e49b,_0x2f6179=await this[_0x3e9aff(0x271)][_0x3e9aff(0x26a)]({'where':{'id':_0x391f28}});if(!_0x2f6179)throw new common_1['HttpException'](_0x3e9aff(0x21a),common_1['HttpStatus'][_0x3e9aff(0x1ec)]);const _0x5b36c3=_0x3e9aff(0x235),_0x45fb09=bcrypt[_0x3e9aff(0x24e)](_0x5b36c3,0xa),_0x66a9ba=await this['userEntity'][_0x3e9aff(0x20e)]({'id':_0x391f28},{'password':_0x45fb09});if(_0x66a9ba[_0x3e9aff(0x21b)]<=0x0)throw new common_1[(_0x3e9aff(0x21c))](_0x3e9aff(0x281),common_1[_0x3e9aff(0x247)][_0x3e9aff(0x1ec)]);return _0x3e9aff(0x288)+_0x5b36c3+']成功!';}async['savaLoginIp'](_0x5d8a14,_0x125cb3){const _0x8e4b5d=_0x4d9a7c;return await this['userEntity'][_0x8e4b5d(0x20e)]({'id':_0x5d8a14},{'lastLoginIp':_0x125cb3});}async[_0x4d9a7c(0x258)](_0x198be9,_0x5e62bb){const _0x291795=_0x4d9a7c,_0x40b27a=await this[_0x291795(0x271)]['findOne']({'where':{'openId':_0x198be9}});if(!_0x40b27a){const _0xf9147a=_0x5e62bb?_0x5e62bb[_0x291795(0x1dd)](':')[0x1]:'',_0x26eb22=await this['qureyUserInfoByInviteCode'](_0xf9147a),_0x1913db=await this[_0x291795(0x22a)](_0x198be9,_0xf9147a);return await this[_0x291795(0x1f5)][_0x291795(0x1f0)](_0x1913db['id'],_0xf9147a?_0x26eb22===null||_0x26eb22===void 0x0?void 0x0:_0x26eb22['id']:null),_0x1913db;}return _0x40b27a;}async[_0x4d9a7c(0x22a)](_0x5b661d,_0x5d2a32){const _0x271bc0=_0x4d9a7c,_0x18e2a7=await this[_0x271bc0(0x1f8)][_0x271bc0(0x25a)]([_0x271bc0(0x23d)]),_0x45fe92={'avatar':_0x18e2a7,'username':'用户'+(0x0,utils_1[_0x271bc0(0x1ea)])(),'status':user_constant_1[_0x271bc0(0x222)]['ACTIVE'],'sex':0x0,'email':(0x0,utils_1[_0x271bc0(0x1ea)])()+_0x271bc0(0x253),'invitedBy':_0x5d2a32,'openId':_0x5b661d},_0x41ef4b=await this[_0x271bc0(0x271)][_0x271bc0(0x289)](_0x45fe92);return _0x41ef4b;}async[_0x4d9a7c(0x24d)](_0x2ca3d2,_0x284c0b){const _0x280992=_0x4d9a7c;try{const _0x31304d=await this['userEntity']['findOne']({'where':{'id':_0x284c0b}});if(!_0x31304d)return{'status':![],'msg':_0x280992(0x278)};const _0x5401c8=await this[_0x280992(0x271)][_0x280992(0x26a)]({'where':{'openId':_0x2ca3d2}});if(_0x5401c8)return{'status':![],'msg':_0x280992(0x23f)};const _0x4d931d=await this[_0x280992(0x271)]['update']({'id':_0x284c0b},{'openId':_0x2ca3d2});if(_0x4d931d[_0x280992(0x21b)]<=0x0)return{'status':![],'msg':'绑定微信失败、请联系管理员！'};return{'status':!![],'msg':_0x280992(0x23b)};}catch(_0x4acbd){return{'status':![],'msg':_0x280992(0x1fa)};}}async[_0x4d9a7c(0x20f)](_0x4fa6f5){const _0x357bea=_0x4d9a7c,_0x1383fc=await this[_0x357bea(0x271)][_0x357bea(0x26a)]({'where':{'id':_0x4fa6f5}});return _0x1383fc===null||_0x1383fc===void 0x0?void 0x0:_0x1383fc[_0x357bea(0x201)];}async['verifyUserRegisterByPhone'](_0x55a55f){const _0x1c60b0=_0x4d9a7c,{username:_0x1679ea,password:_0x151b1e,phone:_0xbe1d43,phoneCode:_0x187b02}=_0x55a55f,_0x108df9=await this[_0x1c60b0(0x271)][_0x1c60b0(0x26a)]({'where':[{'username':_0x1679ea},{'phone':_0xbe1d43}]});if(_0x108df9&&_0x108df9['username']===_0x1679ea)throw new common_1['HttpException']('用户名已存在、请更换用户名！',common_1[_0x1c60b0(0x247)][_0x1c60b0(0x1ec)]);if(_0x108df9&&_0x108df9['phone']===_0xbe1d43)throw new common_1[(_0x1c60b0(0x21c))](_0x1c60b0(0x274),common_1[_0x1c60b0(0x247)]['BAD_REQUEST']);}async[_0x4d9a7c(0x218)](_0x3c50a8){const _0x51c222=_0x4d9a7c;return await this[_0x51c222(0x271)][_0x51c222(0x289)](_0x3c50a8);}};UserService=__decorate([(0x0,common_1[_0x4d9a7c(0x1f4)])(),__param(0x0,(0x0,typeorm_1[_0x4d9a7c(0x21e)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x4d9a7c(0x21e)])(whiteList_entity_1[_0x4d9a7c(0x227)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x4d9a7c(0x1e3)])),__metadata('design:paramtypes',[typeorm_2[_0x4d9a7c(0x1e4)],typeorm_2[_0x4d9a7c(0x1e4)],typeorm_2[_0x4d9a7c(0x1fe)],verification_service_1[_0x4d9a7c(0x270)],mailer_1['MailerService'],userBalance_service_1['UserBalanceService'],globalConfig_service_1['GlobalConfigService'],typeorm_2[_0x4d9a7c(0x1e4)]])],UserService),exports[_0x4d9a7c(0x1dc)]=UserService;