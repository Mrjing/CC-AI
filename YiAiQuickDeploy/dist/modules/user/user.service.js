'use strict';const _0x5463e2=_0x3e14;function _0x3e14(_0x59e0b8,_0x458441){const _0x590e34=_0x590e();return _0x3e14=function(_0x3e1499,_0x30223f){_0x3e1499=_0x3e1499-0xeb;let _0x2c6a5d=_0x590e34[_0x3e1499];return _0x2c6a5d;},_0x3e14(_0x59e0b8,_0x458441);}(function(_0x1ac5be,_0x1f5a1e){const _0x564a24=_0x3e14,_0x14356f=_0x1ac5be();while(!![]){try{const _0x174346=parseInt(_0x564a24(0x147))/0x1+parseInt(_0x564a24(0x176))/0x2+-parseInt(_0x564a24(0x118))/0x3+-parseInt(_0x564a24(0x180))/0x4*(-parseInt(_0x564a24(0x149))/0x5)+parseInt(_0x564a24(0x159))/0x6*(parseInt(_0x564a24(0x175))/0x7)+-parseInt(_0x564a24(0x14b))/0x8+-parseInt(_0x564a24(0x14f))/0x9;if(_0x174346===_0x1f5a1e)break;else _0x14356f['push'](_0x14356f['shift']());}catch(_0x20cf8e){_0x14356f['push'](_0x14356f['shift']());}}}(_0x590e,0x2104a));var __decorate=this&&this['__decorate']||function(_0x52ef8f,_0x4ac83e,_0x363a15,_0x32c958){const _0x3bfc23=_0x3e14;var _0x2183b3=arguments['length'],_0x243120=_0x2183b3<0x3?_0x4ac83e:_0x32c958===null?_0x32c958=Object[_0x3bfc23(0x13c)](_0x4ac83e,_0x363a15):_0x32c958,_0x58a7f6;if(typeof Reflect===_0x3bfc23(0x11b)&&typeof Reflect['decorate']==='function')_0x243120=Reflect[_0x3bfc23(0x151)](_0x52ef8f,_0x4ac83e,_0x363a15,_0x32c958);else{for(var _0x121740=_0x52ef8f[_0x3bfc23(0x154)]-0x1;_0x121740>=0x0;_0x121740--)if(_0x58a7f6=_0x52ef8f[_0x121740])_0x243120=(_0x2183b3<0x3?_0x58a7f6(_0x243120):_0x2183b3>0x3?_0x58a7f6(_0x4ac83e,_0x363a15,_0x243120):_0x58a7f6(_0x4ac83e,_0x363a15))||_0x243120;}return _0x2183b3>0x3&&_0x243120&&Object[_0x3bfc23(0x12d)](_0x4ac83e,_0x363a15,_0x243120),_0x243120;},__metadata=this&&this[_0x5463e2(0xf0)]||function(_0x396489,_0x5a20a9){const _0x4e7161=_0x5463e2;if(typeof Reflect===_0x4e7161(0x11b)&&typeof Reflect['metadata']===_0x4e7161(0xff))return Reflect['metadata'](_0x396489,_0x5a20a9);},__param=this&&this[_0x5463e2(0x16a)]||function(_0xdd89f,_0xd9985b){return function(_0x2edaea,_0x4b0902){_0xd9985b(_0x2edaea,_0x4b0902,_0xdd89f);};};Object[_0x5463e2(0x12d)](exports,_0x5463e2(0x127),{'value':!![]}),exports[_0x5463e2(0x17d)]=void 0x0;const globalConfig_service_1=require(_0x5463e2(0x141)),user_constant_1=require('../../common/constants/user.constant'),mailer_1=require(_0x5463e2(0x190)),verification_service_1=require(_0x5463e2(0x114)),common_1=require(_0x5463e2(0x134)),typeorm_1=require(_0x5463e2(0x160)),typeorm_2=require(_0x5463e2(0x110)),user_entity_1=require(_0x5463e2(0x125)),bcrypt=require(_0x5463e2(0x152)),crypto=require(_0x5463e2(0xfa)),_=require(_0x5463e2(0x10e)),verification_constant_1=require(_0x5463e2(0x13e)),userBalance_service_1=require(_0x5463e2(0x137)),utils_1=require(_0x5463e2(0x166)),balance_constant_1=require(_0x5463e2(0x12f)),config_entity_1=require(_0x5463e2(0x150)),whiteList_entity_1=require('../chatgpt/whiteList.entity');let UserService=class UserService{constructor(_0x12d671,_0x29a171,_0x52cf8c,_0x5f1072,_0x1a86f3,_0x1065f8,_0x111710,_0x77c360){const _0x4a541e=_0x5463e2;this[_0x4a541e(0x10a)]=_0x12d671,this[_0x4a541e(0x194)]=_0x29a171,this[_0x4a541e(0x101)]=_0x52cf8c,this[_0x4a541e(0x196)]=_0x5f1072,this['mailerService']=_0x1a86f3,this[_0x4a541e(0x16d)]=_0x1065f8,this['globalConfigService']=_0x111710,this[_0x4a541e(0x135)]=_0x77c360;}async['createUserAndVerifycation'](_0x2fcd89,_0x19c0ea){const _0x233a18=_0x5463e2,{username:_0x2d7946,email:_0x569206,password:_0x2c2567,invitedBy:_0x47c010,client:client=0x0}=_0x2fcd89;if(_0x47c010){const _0x3579fc=await this[_0x233a18(0x10a)][_0x233a18(0xf1)]({'where':{'inviteCode':_0x47c010}});if(!_0x3579fc)throw new common_1[(_0x233a18(0x153))](_0x233a18(0x117),common_1[_0x233a18(0x187)][_0x233a18(0x193)]);}const _0x51f0db=[{'username':_0x2d7946},{'email':_0x569206}],_0x2cec45=await this[_0x233a18(0x10a)][_0x233a18(0xf1)]({'where':_0x51f0db});if(_0x2cec45&&_0x2cec45[_0x233a18(0x198)]!==user_constant_1['UserStatusEnum']['PENDING'])throw new common_1[(_0x233a18(0x153))]('用户名或者邮箱已被注册！',common_1[_0x233a18(0x187)]['BAD_REQUEST']);try{const _0xf4dc5e=_[_0x233a18(0x157)](_0x2fcd89),_0x2bfc54=bcrypt['hashSync'](_0x2c2567,0xa),_0x1b7a97=(0x0,utils_1[_0x233a18(0x100)])(_0x19c0ea);_0xf4dc5e[_0x233a18(0x11e)]=_0x2bfc54,_0xf4dc5e[_0x233a18(0x156)]=_0x1b7a97,_0xf4dc5e[_0x233a18(0x15a)]=client;let _0x37dbaf;if(!_0x2cec45){const _0x49bb26=await this[_0x233a18(0x16b)]['getConfigs'](['userDefautlAvatar']);_0xf4dc5e['avatar']=_0x49bb26,_0x37dbaf=await this['userEntity'][_0x233a18(0x186)](_0xf4dc5e);}else _0x37dbaf=_0x2cec45;const _0x31779b=await this[_0x233a18(0x135)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x233a18(0x155),_0x233a18(0x188),'registerVerifyEmailTitle','registerVerifyEmailDesc',_0x233a18(0x103),_0x233a18(0x182)])}}),_0x13d373=_0x31779b[_0x233a18(0x16e)]((_0x4e19ed,_0x122186)=>{return _0x4e19ed[_0x122186['configKey']]=_0x122186['configVal'],_0x4e19ed;},{}),_0x189884=_0x13d373[_0x233a18(0x155)]?Number(_0x13d373[_0x233a18(0x155)]):0x1;if(_0x189884){const _0x3afd8=_0x13d373['registerVerifyExpir']?Number(_0x13d373['registerVerifyExpir']):0x1e*0x3c,_0x219092=await this[_0x233a18(0x196)][_0x233a18(0x126)](_0x37dbaf,verification_constant_1[_0x233a18(0x184)][_0x233a18(0x11f)],_0x3afd8),{code:_0x58c0b1,email:_0x21edcb,id:_0x12a829}=_0x219092,{registerVerifyEmailFrom:_0x38a5f8}=_0x13d373;console[_0x233a18(0x189)](_0x233a18(0x124),_0x13d373);const _0x40403c=await this[_0x233a18(0x15d)]['sendMail']({'to':_0x21edcb,'subject':'来自'+_0x38a5f8+_0x233a18(0x191),'template':_0x233a18(0x15f),'context':Object[_0x233a18(0x178)]({'baseUrl':_0x13d373[_0x233a18(0x188)],'code':_0x58c0b1,'id':_0x12a829},_0x13d373)});console[_0x233a18(0x189)]('email\x20response\x20\x20->\x20:\x20',_0x40403c);}else{const {username:_0xc47d7e,email:_0x3d06b2,id:_0x863388,invitedBy:_0x36f6bd}=_0x37dbaf;await this[_0x233a18(0x12b)](_0x863388,user_constant_1[_0x233a18(0x145)]['ACTIVE']);let _0x15d413;_0x36f6bd&&(_0x15d413=await this[_0x233a18(0x18d)](_0x36f6bd)),await this[_0x233a18(0x16d)][_0x233a18(0x11c)](_0x863388,_0x15d413===null||_0x15d413===void 0x0?void 0x0:_0x15d413['id']);}return _0x37dbaf;}catch(_0x539e57){console[_0x233a18(0x189)](_0x233a18(0x11d),_0x539e57);throw _0x539e57;}}async[_0x5463e2(0x111)](){const _0x2c8798=_0x5463e2,_0x451d70=await this[_0x2c8798(0x10a)]['findOne']({'where':{'role':_0x2c8798(0xf8)}});return _0x451d70;}async[_0x5463e2(0x136)](_0x504c80){const _0x36b953=_0x5463e2,{username:_0x50ca73,password:_0xb6943f,uid:uid=0x0,phone:_0x2b9c40}=_0x504c80;let _0x2d62aa=null;if(uid>0x0){_0x2d62aa=await this[_0x36b953(0x10a)]['findOne']({'where':{'id':uid}});if(!_0x2d62aa)throw new common_1[(_0x36b953(0x153))](_0x36b953(0x146),common_1[_0x36b953(0x187)]['BAD_REQUEST']);if(_0x2d62aa[_0x36b953(0x11e)][_0x36b953(0x148)](_0x36b953(0x133))||_0x2d62aa[_0x36b953(0x11e)][_0x36b953(0x148)](_0x36b953(0x18a))||_0x2d62aa[_0x36b953(0x11e)]['startsWith'](_0x36b953(0x112))){if(!bcrypt['compareSync'](_0xb6943f,_0x2d62aa[_0x36b953(0x11e)]))throw new common_1[(_0x36b953(0x153))]('当前密码错误！',common_1[_0x36b953(0x187)]['BAD_REQUEST']);}else{console['log'](_0x36b953(0x17c));const _0x19b24f=crypto['createHash'](_0x36b953(0x181))[_0x36b953(0x170)](_0xb6943f)[_0x36b953(0x195)](_0x36b953(0x113));console[_0x36b953(0x189)](_0x36b953(0x17c),_0x19b24f);if(_0x19b24f!==_0x2d62aa[_0x36b953(0x11e)])throw new common_1['HttpException']('当前密码错误！',common_1[_0x36b953(0x187)]['BAD_REQUEST']);}}if(_0x50ca73&&_0xb6943f){const _0x46a0aa=[{'username':_0x50ca73},{'email':_0x50ca73}];_0x2d62aa=await this[_0x36b953(0x10a)][_0x36b953(0xf1)]({'where':_0x46a0aa});if(!_0x2d62aa)throw new common_1['HttpException'](_0x36b953(0x146),common_1[_0x36b953(0x187)][_0x36b953(0x193)]);if(_0x2d62aa[_0x36b953(0x11e)][_0x36b953(0x148)](_0x36b953(0x133))||_0x2d62aa[_0x36b953(0x11e)][_0x36b953(0x148)](_0x36b953(0x18a))||_0x2d62aa[_0x36b953(0x11e)][_0x36b953(0x148)](_0x36b953(0x112))){if(!bcrypt[_0x36b953(0x140)](_0xb6943f,_0x2d62aa[_0x36b953(0x11e)]))throw new common_1[(_0x36b953(0x153))](_0x36b953(0xf6),common_1[_0x36b953(0x187)]['BAD_REQUEST']);}else{console[_0x36b953(0x189)](_0x36b953(0x17c));const _0x5272ce=crypto[_0x36b953(0x18b)](_0x36b953(0x181))['update'](_0xb6943f)[_0x36b953(0x195)]('hex');console['log'](_0x36b953(0x17c),_0x5272ce);if(_0x5272ce!==_0x2d62aa[_0x36b953(0x11e)])throw new common_1[(_0x36b953(0x153))]('当前密码错误！',common_1[_0x36b953(0x187)][_0x36b953(0x193)]);}}if(_0x2b9c40&&_0xb6943f){const _0x195398=[{'phone':_0x2b9c40}];_0x2d62aa=await this['userEntity'][_0x36b953(0xf1)]({'where':_0x195398});if(!_0x2d62aa)throw new common_1['HttpException'](_0x36b953(0x146),common_1[_0x36b953(0x187)][_0x36b953(0x193)]);if(_0x2d62aa[_0x36b953(0x11e)][_0x36b953(0x148)](_0x36b953(0x133))||_0x2d62aa[_0x36b953(0x11e)][_0x36b953(0x148)]('$2b$')||_0x2d62aa[_0x36b953(0x11e)][_0x36b953(0x148)]('$2y$')){if(!bcrypt['compareSync'](_0xb6943f,_0x2d62aa[_0x36b953(0x11e)]))throw new common_1['HttpException'](_0x36b953(0xf6),common_1[_0x36b953(0x187)][_0x36b953(0x193)]);}else{console[_0x36b953(0x189)]('----,');const _0x16cdf5=crypto[_0x36b953(0x18b)](_0x36b953(0x181))[_0x36b953(0x170)](_0xb6943f)['digest'](_0x36b953(0x113));console['log'](_0x36b953(0x17c),_0x16cdf5);if(_0x16cdf5!==_0x2d62aa[_0x36b953(0x11e)])throw new common_1[(_0x36b953(0x153))](_0x36b953(0xf6),common_1[_0x36b953(0x187)]['BAD_REQUEST']);}}if(!_0x2d62aa)throw new common_1[(_0x36b953(0x153))]('当前账户不存在！',common_1['HttpStatus']['BAD_REQUEST']);if(_0x2d62aa[_0x36b953(0x198)]!==user_constant_1[_0x36b953(0x145)][_0x36b953(0x129)])throw new common_1[(_0x36b953(0x153))](user_constant_1[_0x36b953(0x106)][_0x2d62aa['status']],common_1[_0x36b953(0x187)][_0x36b953(0x193)]);return _0x2d62aa;}async[_0x5463e2(0x12c)](_0x3cc056,_0x368b35){const _0x4d0ddc=_0x5463e2,_0x1fa9c5=await this[_0x4d0ddc(0x10a)][_0x4d0ddc(0xf1)]({'where':{'id':_0x3cc056}});if(_0x1fa9c5[_0x4d0ddc(0x11e)][_0x4d0ddc(0x148)](_0x4d0ddc(0x133))||_0x1fa9c5['password']['startsWith'](_0x4d0ddc(0x18a))||_0x1fa9c5[_0x4d0ddc(0x11e)][_0x4d0ddc(0x148)](_0x4d0ddc(0x112)))return bcrypt[_0x4d0ddc(0x140)](_0x368b35,_0x1fa9c5[_0x4d0ddc(0x11e)]);else{const _0x5c0b0f=crypto[_0x4d0ddc(0x18b)]('md5')[_0x4d0ddc(0x170)](_0x368b35)[_0x4d0ddc(0x195)](_0x4d0ddc(0x113));return console[_0x4d0ddc(0x189)](_0x4d0ddc(0x17c),_0x5c0b0f),_0x5c0b0f===_0x1fa9c5['password'];}}async[_0x5463e2(0x12b)](_0x448baf,_0x43d84e){const _0x1311b5=_0x5463e2,_0x2ed29c=await this[_0x1311b5(0x10a)][_0x1311b5(0x170)]({'id':_0x448baf},{'status':_0x43d84e});return _0x2ed29c[_0x1311b5(0x171)]>0x0;}async[_0x5463e2(0x144)](_0x553e45){const _0x2cfa08=_0x5463e2,_0x13f732=await this[_0x2cfa08(0x10a)]['findOne']({'where':{'id':_0x553e45}});return _0x13f732[_0x2cfa08(0x198)];}async[_0x5463e2(0x16c)](_0x35d0c5){const _0x13d8b0=_0x5463e2;return await this[_0x13d8b0(0x10a)]['findOne']({'where':{'id':_0x35d0c5}});}async['queryOneUserInfo'](_0x5962a0){const _0xd5e77=_0x5463e2;return await this[_0xd5e77(0x10a)]['findOne']({'where':{'id':_0x5962a0}});}async[_0x5463e2(0x139)](_0x57f3d4){const _0x22065e=_0x5463e2,{id:_0x252a9c,role:_0x2f6f62}=_0x57f3d4;if(_0x2f6f62===_0x22065e(0x15e))return!![];const _0x80976a=await this[_0x22065e(0x10a)][_0x22065e(0xf1)]({'where':{'id':_0x252a9c}});if(!_0x80976a)throw new common_1['HttpException'](_0x22065e(0x15c),common_1['HttpStatus'][_0x22065e(0xf9)]);if(_0x80976a['status']===user_constant_1[_0x22065e(0x145)][_0x22065e(0x109)])throw new common_1[(_0x22065e(0x153))](_0x22065e(0x119),common_1['HttpStatus']['BAD_REQUEST']);if(_0x80976a[_0x22065e(0x198)]===user_constant_1[_0x22065e(0x145)]['LOCKED'])throw new common_1[(_0x22065e(0x153))](_0x22065e(0x18f),common_1['HttpStatus'][_0x22065e(0x193)]);}async[_0x5463e2(0x17f)](_0x1a54e1){const _0x477ab2=_0x5463e2,_0x204184=await this[_0x477ab2(0x10a)][_0x477ab2(0xf1)]({'where':{'id':_0x1a54e1},'select':[_0x477ab2(0xfc),_0x477ab2(0x132),_0x477ab2(0xf4),_0x477ab2(0x104),_0x477ab2(0x11a),'inviteCode',_0x477ab2(0x17b),_0x477ab2(0x16f)]});if(!_0x204184)throw new common_1[(_0x477ab2(0x153))](_0x477ab2(0x15c),common_1[_0x477ab2(0x187)][_0x477ab2(0xf9)]);_0x204184['isBindWx']=!!(_0x204184===null||_0x204184===void 0x0?void 0x0:_0x204184[_0x477ab2(0x17b)]),delete _0x204184[_0x477ab2(0x17b)];const _0x2e8b34=await this[_0x477ab2(0x16d)][_0x477ab2(0x172)](_0x1a54e1);return{'userInfo':_0x204184,'userBalance':Object[_0x477ab2(0x178)]({},_0x2e8b34)};}async[_0x5463e2(0x12a)](_0x403a75){const _0x49d997=_0x5463e2;return await this[_0x49d997(0x10a)][_0x49d997(0xf1)]({'where':{'id':_0x403a75}});}async['getUserOpenId'](_0x50fac7){const _0x1762c2=_0x5463e2;return await this[_0x1762c2(0x10a)][_0x1762c2(0xf1)]({'where':{'openId':_0x50fac7}});}async[_0x5463e2(0x108)](_0x1caed0,_0x36e656){const _0x104a4b=_0x5463e2,{id:_0x10d97e}=_0x36e656[_0x104a4b(0x13f)],_0x4c7d81=await this[_0x104a4b(0x10a)]['findOne']({'where':{'id':_0x10d97e}});if(!_0x4c7d81)throw new common_1[(_0x104a4b(0x153))]('当前用户不存在！',common_1['HttpStatus']['BAD_REQUEST']);if(_0x1caed0[_0x104a4b(0xfc)]&&_0x4c7d81['username']===_0x1caed0[_0x104a4b(0xfc)])throw new common_1['HttpException'](_0x104a4b(0x163),common_1[_0x104a4b(0x187)]['BAD_REQUEST']);if(_0x1caed0[_0x104a4b(0xfc)]){const _0x1f993a=await this[_0x104a4b(0x10a)][_0x104a4b(0xf1)]({'where':{'username':_0x1caed0[_0x104a4b(0xfc)],'id':(0x0,typeorm_2['Not'])(_0x10d97e)}});if(_0x1f993a)throw new common_1['HttpException'](_0x104a4b(0xf7),common_1[_0x104a4b(0x187)][_0x104a4b(0x193)]);}const _0x50df62=await this[_0x104a4b(0x10a)][_0x104a4b(0x170)]({'id':_0x10d97e},_0x1caed0);if(_0x50df62['affected']<=0x0)throw new common_1[(_0x104a4b(0x153))](_0x104a4b(0x168),common_1[_0x104a4b(0x187)][_0x104a4b(0x193)]);return _0x104a4b(0xf5);}async[_0x5463e2(0x14a)](_0x1fbe63,_0x3b0790){const _0x50babf=_0x5463e2,_0x1dbd88=bcrypt[_0x50babf(0xfb)](_0x3b0790,0xa),_0x2316ab=await this[_0x50babf(0x10a)][_0x50babf(0x170)]({'id':_0x1fbe63},{'password':_0x1dbd88});if(_0x2316ab[_0x50babf(0x171)]<=0x0)throw new common_1[(_0x50babf(0x153))]('修改密码失败、请重新试试吧。',common_1['HttpStatus'][_0x50babf(0x193)]);}async[_0x5463e2(0x143)](_0x20cf5b){const _0x1832ca=_0x5463e2,{id:_0x4e7d02}=_0x20cf5b[_0x1832ca(0x13f)],_0x18fb4d=await this[_0x1832ca(0x10a)][_0x1832ca(0xf1)]({'where':{'id':_0x4e7d02}});if(!_0x18fb4d||_0x18fb4d['inviteCode'])throw new common_1[(_0x1832ca(0x153))](_0x1832ca(0x192),common_1[_0x1832ca(0x187)][_0x1832ca(0x193)]);const _0x289452=(0x0,utils_1[_0x1832ca(0x14c)])(),_0x20b9ae=await this[_0x1832ca(0x10a)]['findOne']({'where':{'inviteCode':_0x289452}});if(_0x20b9ae)throw new common_1[(_0x1832ca(0x153))]('生成邀请码失败，请重新试一次吧！',common_1[_0x1832ca(0x187)][_0x1832ca(0x193)]);const _0x51cfdf=await this['userEntity']['update']({'id':_0x4e7d02},{'inviteCode':_0x289452});if(_0x51cfdf['affected']<=0x0)throw new common_1[(_0x1832ca(0x153))](_0x1832ca(0x177),common_1[_0x1832ca(0x187)][_0x1832ca(0x193)]);return _0x289452;}async['getInviteRecord'](_0x2cc790,_0x54cf43){const _0x2f8859=_0x5463e2;try{const {id:_0x26a91c}=_0x2cc790[_0x2f8859(0x13f)],{page:page=0x1,size:size=0xa}=_0x54cf43,_0x135533=await this[_0x2f8859(0x10a)]['findOne']({'where':{'id':_0x26a91c}}),{inviteCode:_0x4bbd34}=_0x135533;if(!_0x4bbd34)return[];const [_0x38f511,_0x1f5e76]=await this[_0x2f8859(0x10a)]['findAndCount']({'where':{'inviteCode':_0x4bbd34},'order':{'id':_0x2f8859(0x173)},'select':['username','email',_0x2f8859(0x165),'status',_0x2f8859(0x132)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1['formatCreateOrUpdateDate'])(_0x38f511)['map'](_0x231728=>{const _0x3cd720=_0x2f8859;return _0x231728[_0x3cd720(0x104)]=(0x0,utils_1[_0x3cd720(0x17a)])(_0x231728['email']),_0x231728;}),{'rows':_0x38f511,'count':_0x1f5e76};}catch(_0x5e25d0){console[_0x2f8859(0x189)](_0x2f8859(0x11d),_0x5e25d0);throw new common_1[(_0x2f8859(0x153))]('获取邀请记录失败！',common_1[_0x2f8859(0x187)][_0x2f8859(0x193)]);}}async[_0x5463e2(0x10b)](_0x490a45){const _0x1a69ad=_0x5463e2,_0x3efe75=await this[_0x1a69ad(0x10a)][_0x1a69ad(0xf1)]({'where':{'inviteCode':_0x490a45}});if(!_0x3efe75)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x3efe75,_0x5925e6=await this[_0x1a69ad(0x10a)][_0x1a69ad(0x170)]({'inviteCode':_0x490a45},{'inviteLinkCount':inviteLinkCount+0x1});return _0x5925e6['affected']?0x1:0x0;}async[_0x5463e2(0x18d)](_0x2ecafc){const _0x245d30=_0x5463e2;return await this[_0x245d30(0x10a)][_0x245d30(0xf1)]({'where':{'inviteCode':_0x2ecafc}});}async[_0x5463e2(0x13a)](_0x5ed7ea){const _0x2072f9=_0x5463e2,{userId:_0x30fce8,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x5ed7ea;await this[_0x2072f9(0x16d)][_0x2072f9(0x102)](_0x30fce8,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x455f96=await this['userBalanceService'][_0x2072f9(0x120)]({'userId':_0x30fce8,'rechargeType':balance_constant_1[_0x2072f9(0x131)][_0x2072f9(0x10f)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x455f96;}async[_0x5463e2(0x12e)](_0x1a3999,_0x47b17e){const _0x415428=_0x5463e2,{page:page=0x1,size:size=0xa,username:_0x5dc4e8,email:_0x1ac7af,status:_0x2bbc56,keyword:_0x4cd5b0,phone:_0xe09773}=_0x1a3999;let _0x26cf6d={};_0x5dc4e8&&Object[_0x415428(0x178)](_0x26cf6d,{'username':(0x0,typeorm_2[_0x415428(0x14d)])('%'+_0x5dc4e8+'%')}),_0x1ac7af&&Object['assign'](_0x26cf6d,{'email':(0x0,typeorm_2[_0x415428(0x14d)])('%'+_0x1ac7af+'%')}),_0xe09773&&Object[_0x415428(0x178)](_0x26cf6d,{'phone':(0x0,typeorm_2[_0x415428(0x14d)])('%'+_0xe09773+'%')}),_0x2bbc56&&Object[_0x415428(0x178)](_0x26cf6d,{'status':_0x2bbc56});_0x4cd5b0&&(_0x26cf6d=[{'username':(0x0,typeorm_2[_0x415428(0x14d)])('%'+_0x4cd5b0+'%')},{'email':(0x0,typeorm_2[_0x415428(0x14d)])('%'+_0x4cd5b0+'%')},{'phone':(0x0,typeorm_2['Like'])('%'+_0x4cd5b0+'%')}]);const [_0x599aaf,_0x5aa338]=await this[_0x415428(0x10a)]['findAndCount']({'skip':(page-0x1)*size,'where':_0x26cf6d,'take':size,'order':{'createdAt':_0x415428(0x173)},'cache':!![],'select':[_0x415428(0xfc),'avatar',_0x415428(0x115),_0x415428(0xf4),'sign','status','id',_0x415428(0x104),_0x415428(0x165),_0x415428(0x123),_0x415428(0x174)]}),_0x4e4b81=_0x599aaf[_0x415428(0x107)](_0x3db869=>_0x3db869['id']),_0x1ed0b7=await this[_0x415428(0x16d)][_0x415428(0x13d)](_0x4e4b81);return _0x599aaf[_0x415428(0x121)](_0x5194f5=>_0x5194f5[_0x415428(0xf2)]=_0x1ed0b7['find'](_0x7f6e6e=>_0x7f6e6e[_0x415428(0x164)]===_0x5194f5['id'])),_0x47b17e[_0x415428(0x13f)][_0x415428(0xf4)]!=='super'&&_0x599aaf['forEach'](_0x51fa48=>_0x51fa48[_0x415428(0x104)]=(0x0,utils_1['maskEmail'])(_0x51fa48[_0x415428(0x104)])),_0x47b17e['user'][_0x415428(0xf4)]!=='super'&&_0x599aaf[_0x415428(0x121)](_0x3da123=>_0x3da123[_0x415428(0x123)]=(0x0,utils_1[_0x415428(0x128)])(_0x3da123['lastLoginIp'])),_0x47b17e[_0x415428(0x13f)]['role']!==_0x415428(0xf8)&&_0x599aaf[_0x415428(0x121)](_0x16ff4c=>_0x16ff4c[_0x415428(0x174)]=(0x0,utils_1[_0x415428(0x128)])(_0x16ff4c[_0x415428(0x174)])),{'rows':_0x599aaf,'count':_0x5aa338};}async[_0x5463e2(0x185)]({id:_0x462d7e}){const _0x18c635=_0x5463e2;return await this[_0x18c635(0x10a)]['findOne']({'where':{'id':_0x462d7e},'select':[_0x18c635(0xfc),_0x18c635(0x132),_0x18c635(0x115),_0x18c635(0xf4),_0x18c635(0x11a),_0x18c635(0x198)]});}async['updateStatus'](_0x328716){const _0x3972e3=_0x5463e2,{id:_0x120dce,status:_0x452de0}=_0x328716,_0x52c568=await this['userEntity'][_0x3972e3(0xf1)]({'where':{'id':_0x120dce}});if(!_0x52c568)throw new common_1[(_0x3972e3(0x153))]('用户不存在！',common_1[_0x3972e3(0x187)][_0x3972e3(0x193)]);if(_0x52c568[_0x3972e3(0xf4)]===_0x3972e3(0xf8))throw new common_1[(_0x3972e3(0x153))]('超级管理员不可被操作！',common_1['HttpStatus'][_0x3972e3(0x193)]);if(_0x52c568[_0x3972e3(0x198)]===user_constant_1[_0x3972e3(0x145)][_0x3972e3(0x10d)])throw new common_1['HttpException'](_0x3972e3(0x19a),common_1['HttpStatus'][_0x3972e3(0x193)]);if(_0x52c568[_0x3972e3(0xf4)]===_0x3972e3(0xf8))throw new common_1[(_0x3972e3(0x153))](_0x3972e3(0xee),common_1['HttpStatus'][_0x3972e3(0x193)]);if(_0x452de0===user_constant_1['UserStatusEnum'][_0x3972e3(0x10d)])throw new common_1[(_0x3972e3(0x153))](_0x3972e3(0x19b),common_1[_0x3972e3(0x187)][_0x3972e3(0x193)]);const _0x3736f1=await this[_0x3972e3(0x10a)][_0x3972e3(0x170)]({'id':_0x120dce},{'status':_0x452de0});if(_0x3736f1[_0x3972e3(0x171)]<=0x0)throw new common_1['HttpException']('修改用户状态失败！',common_1[_0x3972e3(0x187)]['BAD_REQUEST']);return _0x3972e3(0x161);}async[_0x5463e2(0x130)](_0x32501c){const _0x368f3b=_0x5463e2,{id:_0x533709}=_0x32501c,_0xe0a75b=await this[_0x368f3b(0x10a)][_0x368f3b(0xf1)]({'where':{'id':_0x533709}});if(!_0xe0a75b)throw new common_1['HttpException']('用户不存在！',common_1[_0x368f3b(0x187)][_0x368f3b(0x193)]);const _0x143bd4=_0x368f3b(0xfe),_0x3f8148=bcrypt[_0x368f3b(0xfb)](_0x143bd4,0xa),_0x59ff45=await this[_0x368f3b(0x10a)][_0x368f3b(0x170)]({'id':_0x533709},{'password':_0x3f8148});if(_0x59ff45['affected']<=0x0)throw new common_1[(_0x368f3b(0x153))](_0x368f3b(0x10c),common_1['HttpStatus'][_0x368f3b(0x193)]);return _0x368f3b(0x179)+_0x143bd4+']成功!';}async[_0x5463e2(0x14e)](_0xaa04a1,_0x49e0a7){const _0x4fbc7c=_0x5463e2;return await this['userEntity'][_0x4fbc7c(0x170)]({'id':_0xaa04a1},{'lastLoginIp':_0x49e0a7});}async[_0x5463e2(0x15b)](_0x46a90d,_0x51f107){const _0x228b5e=_0x5463e2,_0x1344d2=await this[_0x228b5e(0x10a)][_0x228b5e(0xf1)]({'where':{'openId':_0x46a90d}});if(!_0x1344d2){const _0x4d5249=_0x51f107?_0x51f107['split'](':')[0x1]:'',_0x48af7d=await this[_0x228b5e(0x18d)](_0x4d5249),_0x266aa1=await this['createUserFromOpenId'](_0x46a90d,_0x4d5249);return await this[_0x228b5e(0x16d)][_0x228b5e(0x11c)](_0x266aa1['id'],_0x4d5249?_0x48af7d===null||_0x48af7d===void 0x0?void 0x0:_0x48af7d['id']:null),_0x266aa1;}return _0x1344d2;}async[_0x5463e2(0x122)](_0x33ceab,_0x450fc4){const _0x44bf86=_0x5463e2,_0x20d7df=await this[_0x44bf86(0x16b)][_0x44bf86(0xef)]([_0x44bf86(0xeb)]),_0x29594b={'avatar':_0x20d7df,'username':'用户'+(0x0,utils_1[_0x44bf86(0x167)])(),'status':user_constant_1[_0x44bf86(0x145)][_0x44bf86(0x129)],'sex':0x0,'email':(0x0,utils_1[_0x44bf86(0x167)])()+'@default.com','invitedBy':_0x450fc4,'openId':_0x33ceab},_0x16a511=await this[_0x44bf86(0x10a)][_0x44bf86(0x186)](_0x29594b);return _0x16a511;}async[_0x5463e2(0x197)](_0xabdbef,_0x53a8c2){const _0x5558c0=_0x5463e2;try{const _0x50d62c=await this['userEntity'][_0x5558c0(0xf1)]({'where':{'id':_0x53a8c2}});if(!_0x50d62c)return{'status':![],'msg':_0x5558c0(0x162)};const _0x51675f=await this[_0x5558c0(0x10a)][_0x5558c0(0xf1)]({'where':{'openId':_0xabdbef}});if(_0x51675f)return{'status':![],'msg':_0x5558c0(0x199)};const _0x226731=await this['userEntity'][_0x5558c0(0x170)]({'id':_0x53a8c2},{'openId':_0xabdbef});if(_0x226731[_0x5558c0(0x171)]<=0x0)return{'status':![],'msg':'绑定微信失败、请联系管理员！'};return{'status':!![],'msg':_0x5558c0(0x105)};}catch(_0x5ccc62){return{'status':![],'msg':'绑定微信失败、请联系管理员！'};}}async[_0x5463e2(0x183)](_0xd921fb){const _0x1f03e1=_0x5463e2,_0x1a1d7b=await this[_0x1f03e1(0x10a)][_0x1f03e1(0xf1)]({'where':{'id':_0xd921fb}});return _0x1a1d7b===null||_0x1a1d7b===void 0x0?void 0x0:_0x1a1d7b['openId'];}async[_0x5463e2(0x116)](_0x265dd2){const _0x10d5f4=_0x5463e2,{username:_0x4e0e86,password:_0x244a7e,phone:_0x2e32aa,phoneCode:_0x2e8b5a}=_0x265dd2,_0x53ef73=await this[_0x10d5f4(0x10a)][_0x10d5f4(0xf1)]({'where':[{'username':_0x4e0e86},{'phone':_0x2e32aa}]});if(_0x53ef73&&_0x53ef73['username']===_0x4e0e86)throw new common_1[(_0x10d5f4(0x153))](_0x10d5f4(0xfd),common_1['HttpStatus'][_0x10d5f4(0x193)]);if(_0x53ef73&&_0x53ef73[_0x10d5f4(0x174)]===_0x2e32aa)throw new common_1[(_0x10d5f4(0x153))](_0x10d5f4(0xec),common_1[_0x10d5f4(0x187)][_0x10d5f4(0x193)]);}async[_0x5463e2(0x142)](_0x5a88d8){const _0xd0a204=_0x5463e2;return await this['userEntity'][_0xd0a204(0x186)](_0x5a88d8);}};function _0x590e(){const _0x798ffe=['Injectable','超级管理员不可被操作！','getConfigs','__metadata','findOne','balanceInfo','UserEntity','role','修改用户信息成功！','当前密码错误！','用户名已存在！','super','UNAUTHORIZED','crypto','hashSync','username','用户名已存在、请更换用户名！','123456','function','getClientIp','connection','addBalanceToUser','registerVerifyEmailFrom','email','恭喜您绑定成功、后续可直接扫码登录了！','UserStatusErrMsg','map','updateInfo','BLACKLISTED','userEntity','inviteLink','重置密码失败！','PENDING','lodash','ADMIN_GIFT','typeorm','getSuper','$2y$','hex','../verification/verification.service','inviteCode','verifyUserRegisterByPhone','无效的邀请码！','514860CNlPTn','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','sign','object','addBalanceToNewUser','error:\x20','password','Registration','saveRecordRechargeLog','forEach','createUserFromOpenId','lastLoginIp','configMap:\x20','./user.entity','createVerification','__esModule','maskIpAddress','ACTIVE','getUserById','updateUserStatus','verifyUserPassword','defineProperty','queryAll','../../common/constants/balance.constant','resetUserPass','RechargeType','avatar','$2a$','@nestjs/common','configEntity','verifyUserCredentials','../userBalance/userBalance.service','UserBalanceService','checkUserStatus','userRecharge','MailerService','getOwnPropertyDescriptor','queryUserBalanceByIds','../../common/constants/verification.constant','user','compareSync','../globalConfig/globalConfig.service','createUser','genInviteCode','getUserStatus','UserStatusEnum','当前账户不存在！','203261UQDplP','startsWith','2225FEEQoo','updateUserPassword','1549776mrWvUC','generateRandomString','Like','savaLoginIp','607257YqTJks','../globalConfig/config.entity','decorate','bcryptjs','HttpException','length','isVerifyEmail','registerIp','cloneDeep','Repository','2610wIGMuo','client','getUserFromOpenId','当前用户信息失效、请重新登录！','mailerService','visitor','register','@nestjs/typeorm','修改用户状态成功！','当前绑定用户不存在！','没有变更，无需更改！','userId','createdAt','../../common/utils','createRandomUid','修改用户信息失败！','GlobalConfigService','__param','globalConfigService','queryUserInfoById','userBalanceService','reduce','consecutiveDays','update','affected','queryUserBalance','DESC','phone','1491QtNsCG','340472IFRUxy','生成邀请码失败，请重新试一次吧！','assign','密码重置为[','maskEmail','openId','----,','UserService','Connection','getUserInfo','916XcDvJi','md5','registerVerifyExpir','getOpenIdByUserId','VerificationEnum','queryOne','save','HttpStatus','registerBaseUrl','log','$2b$','createHash','InjectRepository','qureyUserInfoByInviteCode','WhiteListEntity','您的账户已被封禁、如有疑问、请联系管理员！','@nestjs-modules/mailer','的账号激活','已生成过邀请码、请勿重复生成','BAD_REQUEST','whiteListEntity','digest','verificationService','bindWx','status','该微信已绑定其他账号！','未激活用户不可手动变更状态！','不可将用户置为未激活状态！','userDefautlAvatar','当前手机号已注册、请勿重复注册！'];_0x590e=function(){return _0x798ffe;};return _0x590e();}UserService=__decorate([(0x0,common_1[_0x5463e2(0xed)])(),__param(0x0,(0x0,typeorm_1[_0x5463e2(0x18c)])(user_entity_1[_0x5463e2(0xf3)])),__param(0x1,(0x0,typeorm_1[_0x5463e2(0x18c)])(whiteList_entity_1[_0x5463e2(0x18e)])),__param(0x7,(0x0,typeorm_1[_0x5463e2(0x18c)])(config_entity_1['ConfigEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x5463e2(0x158)],typeorm_2[_0x5463e2(0x158)],typeorm_2[_0x5463e2(0x17e)],verification_service_1['VerificationService'],mailer_1[_0x5463e2(0x13b)],userBalance_service_1[_0x5463e2(0x138)],globalConfig_service_1[_0x5463e2(0x169)],typeorm_2[_0x5463e2(0x158)]])],UserService),exports[_0x5463e2(0x17d)]=UserService;