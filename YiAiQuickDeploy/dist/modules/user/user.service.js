'use strict';function _0x1b7d(_0xf88625,_0x32e8b5){const _0x29ef50=_0x29ef();return _0x1b7d=function(_0x1b7d97,_0x2c914e){_0x1b7d97=_0x1b7d97-0x16c;let _0x4aedf5=_0x29ef50[_0x1b7d97];return _0x4aedf5;},_0x1b7d(_0xf88625,_0x32e8b5);}const _0x5be414=_0x1b7d;function _0x29ef(){const _0x36d96b=['ADMIN_GIFT','defineProperty','role','BAD_REQUEST','Injectable','connection','savaLoginIp','queryUserInfoById','@nestjs/common','formatCreateOrUpdateDate','当前用户信息失效、请重新登录！','Like','UNAUTHORIZED','用户不存在！','addBalanceToUser','registerVerifyEmailFrom','queryUserBalanceByIds','registerVerifyEmailTitle','registerVerifyExpir','verifyUserPassword','isBindWx','balanceInfo','getClientIp','split','length','forEach','1660442Vjspea','getConfigs','userId','@nestjs-modules/mailer','$2a$','createdAt','resetUserPass','修改用户信息成功！','addBalanceToNewUser','__metadata','super','生成邀请码失败，请重新试一次吧！','18294080jCOBnT','createUserAndVerifycation','update','object','InjectRepository','重置密码失败！','verifyUserRegisterByPhone','$2b$','updateUserStatus','maskIpAddress','sendMail','metadata','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','getOpenIdByUserId','assign','createUserFromOpenId','getInviteRecord','configEntity','getUserById','checkUserStatus','createRandomUid','generateRandomString','35unBFJL','hex','consecutiveDays','bcryptjs','register','../chatgpt/whiteList.entity','已生成过邀请码、请勿重复生成','修改密码失败、请重新试试吧。','findOne','../globalConfig/globalConfig.service','../../common/utils','design:paramtypes','decorate','function','queryOneUserInfo','UserService','Connection','11183022bNDKJl','md5','hashSync','userBalanceService','visitor','updateUserPassword','295632XYwvrU','用户名已存在、请更换用户名！','status','reduce','BLACKLISTED','registerVerifyEmailDesc','maskEmail','userEntity','mailerService','startsWith','HttpException','WhiteListEntity','affected','../../common/constants/user.constant','openId','email\x20response\x20\x20->\x20:\x20','您的账户已被封禁、如有疑问、请联系管理员！','lodash','genInviteCode','UserEntity','用户名已存在！','registerBaseUrl','密码重置为[','恭喜您绑定成功、后续可直接扫码登录了！','Repository','email','VerificationEnum','$2y$','save','compareSync','user','queryOne','123456','553401LYgCpq','不可将用户置为未激活状态！','map','未激活用户不可手动变更状态！','1bUanZf','ACTIVE','MailerService','phone','getOwnPropertyDescriptor','@nestjs/typeorm','updateInfo','9082010oMbXHz','findAndCount','verificationService','createHash','../verification/verification.service','的账号激活','VerificationService','avatar','queryUserBalance','userRecharge','bindWx','queryAll','无效的邀请码！','PENDING','__esModule','当前绑定用户不存在！','Not','configKey','4BVJifv','sign','updateStatus','digest','UserStatusEnum','log','queryUserInfoByPhone','当前密码错误！','userDefautlAvatar','qureyUserInfoByInviteCode','createUser','----,','HttpStatus','cloneDeep','当前账户不存在！','超级管理员不可被操作！','inviteCode','isVerifyEmail','typeorm','username','getUserOpenId','lastLoginIp','获取邀请记录失败！','find','password','inviteLink','../globalConfig/config.entity','当前手机号已注册、请勿重复注册！','@default.com','1415608wHbSVV','LOCKED','修改用户状态成功！','__decorate'];_0x29ef=function(){return _0x36d96b;};return _0x29ef();}(function(_0xa18bc,_0x1ea4b0){const _0xfb8441=_0x1b7d,_0x3ca9e2=_0xa18bc();while(!![]){try{const _0x48cda1=parseInt(_0xfb8441(0x210))/0x1*(parseInt(_0xfb8441(0x1b2))/0x2)+-parseInt(_0xfb8441(0x20c))/0x3*(parseInt(_0xfb8441(0x177))/0x4)+-parseInt(_0xfb8441(0x217))/0x5+-parseInt(_0xfb8441(0x1eb))/0x6+parseInt(_0xfb8441(0x1d4))/0x7*(-parseInt(_0xfb8441(0x194))/0x8)+parseInt(_0xfb8441(0x1e5))/0x9+parseInt(_0xfb8441(0x1be))/0xa;if(_0x48cda1===_0x1ea4b0)break;else _0x3ca9e2['push'](_0x3ca9e2['shift']());}catch(_0x49574f){_0x3ca9e2['push'](_0x3ca9e2['shift']());}}}(_0x29ef,0xec27b));var __decorate=this&&this[_0x5be414(0x197)]||function(_0x59574e,_0x2435e4,_0x4ce66c,_0x3d6f7d){const _0xaadb7b=_0x5be414;var _0x35515c=arguments[_0xaadb7b(0x1b0)],_0x2c5f9f=_0x35515c<0x3?_0x2435e4:_0x3d6f7d===null?_0x3d6f7d=Object[_0xaadb7b(0x214)](_0x2435e4,_0x4ce66c):_0x3d6f7d,_0x318160;if(typeof Reflect===_0xaadb7b(0x1c1)&&typeof Reflect[_0xaadb7b(0x1e0)]===_0xaadb7b(0x1e1))_0x2c5f9f=Reflect[_0xaadb7b(0x1e0)](_0x59574e,_0x2435e4,_0x4ce66c,_0x3d6f7d);else{for(var _0x3c629f=_0x59574e[_0xaadb7b(0x1b0)]-0x1;_0x3c629f>=0x0;_0x3c629f--)if(_0x318160=_0x59574e[_0x3c629f])_0x2c5f9f=(_0x35515c<0x3?_0x318160(_0x2c5f9f):_0x35515c>0x3?_0x318160(_0x2435e4,_0x4ce66c,_0x2c5f9f):_0x318160(_0x2435e4,_0x4ce66c))||_0x2c5f9f;}return _0x35515c>0x3&&_0x2c5f9f&&Object[_0xaadb7b(0x199)](_0x2435e4,_0x4ce66c,_0x2c5f9f),_0x2c5f9f;},__metadata=this&&this[_0x5be414(0x1bb)]||function(_0x1f3ec6,_0xb405f2){const _0x334a1a=_0x5be414;if(typeof Reflect==='object'&&typeof Reflect[_0x334a1a(0x1c9)]===_0x334a1a(0x1e1))return Reflect['metadata'](_0x1f3ec6,_0xb405f2);},__param=this&&this['__param']||function(_0x289421,_0x17fd11){return function(_0x1723d0,_0x119889){_0x17fd11(_0x1723d0,_0x119889,_0x289421);};};Object[_0x5be414(0x199)](exports,_0x5be414(0x173),{'value':!![]}),exports[_0x5be414(0x1e3)]=void 0x0;const globalConfig_service_1=require(_0x5be414(0x1dd)),user_constant_1=require(_0x5be414(0x1f8)),mailer_1=require(_0x5be414(0x1b5)),verification_service_1=require(_0x5be414(0x21b)),common_1=require(_0x5be414(0x1a0)),typeorm_1=require(_0x5be414(0x215)),typeorm_2=require(_0x5be414(0x189)),user_entity_1=require('./user.entity'),bcrypt=require(_0x5be414(0x1d7)),crypto=require('crypto'),_=require(_0x5be414(0x1fc)),verification_constant_1=require('../../common/constants/verification.constant'),userBalance_service_1=require('../userBalance/userBalance.service'),utils_1=require(_0x5be414(0x1de)),balance_constant_1=require('../../common/constants/balance.constant'),config_entity_1=require(_0x5be414(0x191)),whiteList_entity_1=require(_0x5be414(0x1d9));let UserService=class UserService{constructor(_0x14f895,_0x45dbe1,_0x7118d6,_0x212a10,_0x28b0d6,_0x38845a,_0x47b052,_0xf07a12){const _0x137a10=_0x5be414;this['userEntity']=_0x14f895,this['whiteListEntity']=_0x45dbe1,this[_0x137a10(0x19d)]=_0x7118d6,this[_0x137a10(0x219)]=_0x212a10,this['mailerService']=_0x28b0d6,this[_0x137a10(0x1e8)]=_0x38845a,this['globalConfigService']=_0x47b052,this[_0x137a10(0x1cf)]=_0xf07a12;}async[_0x5be414(0x1bf)](_0x24b2f5,_0xebbca7){const _0x24bcb9=_0x5be414,{username:_0x35931d,email:_0xf8b7a6,password:_0x90685a,invitedBy:_0x14d822,client:client=0x0}=_0x24b2f5;if(_0x14d822){const _0x249a9e=await this[_0x24bcb9(0x1f2)][_0x24bcb9(0x1dc)]({'where':{'inviteCode':_0x14d822}});if(!_0x249a9e)throw new common_1[(_0x24bcb9(0x1f5))](_0x24bcb9(0x171),common_1['HttpStatus']['BAD_REQUEST']);}const _0x550511=[{'username':_0x35931d},{'email':_0xf8b7a6}],_0x3cd721=await this[_0x24bcb9(0x1f2)]['findOne']({'where':_0x550511});if(_0x3cd721&&_0x3cd721['status']!==user_constant_1['UserStatusEnum'][_0x24bcb9(0x172)])throw new common_1[(_0x24bcb9(0x1f5))]('用户名或者邮箱已被注册！',common_1[_0x24bcb9(0x183)]['BAD_REQUEST']);try{const _0x196a6c=_[_0x24bcb9(0x184)](_0x24b2f5),_0x170e77=bcrypt[_0x24bcb9(0x1e7)](_0x90685a,0xa),_0xb3a724=(0x0,utils_1[_0x24bcb9(0x1ae)])(_0xebbca7);_0x196a6c[_0x24bcb9(0x18f)]=_0x170e77,_0x196a6c['registerIp']=_0xb3a724,_0x196a6c['client']=client;let _0x7f5658;if(!_0x3cd721){const _0x4c2f9e=await this['globalConfigService'][_0x24bcb9(0x1b3)](['userDefautlAvatar']);_0x196a6c[_0x24bcb9(0x16c)]=_0x4c2f9e,_0x7f5658=await this[_0x24bcb9(0x1f2)][_0x24bcb9(0x207)](_0x196a6c);}else _0x7f5658=_0x3cd721;const _0x55f2b0=await this[_0x24bcb9(0x1cf)][_0x24bcb9(0x18e)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x24bcb9(0x188),'registerBaseUrl',_0x24bcb9(0x1a9),_0x24bcb9(0x1f0),_0x24bcb9(0x1a7),_0x24bcb9(0x1aa)])}}),_0x19c044=_0x55f2b0[_0x24bcb9(0x1ee)]((_0x2014d7,_0x3de2f4)=>{const _0x458ca1=_0x24bcb9;return _0x2014d7[_0x3de2f4[_0x458ca1(0x176)]]=_0x3de2f4['configVal'],_0x2014d7;},{}),_0x158234=_0x19c044['isVerifyEmail']?Number(_0x19c044[_0x24bcb9(0x188)]):0x1;if(_0x158234){const _0x1c6f48=_0x19c044[_0x24bcb9(0x1aa)]?Number(_0x19c044[_0x24bcb9(0x1aa)]):0x1e*0x3c,_0x3620ac=await this[_0x24bcb9(0x219)]['createVerification'](_0x7f5658,verification_constant_1[_0x24bcb9(0x205)]['Registration'],_0x1c6f48),{code:_0xa8df06,email:_0x5e8cd3,id:_0x396f64}=_0x3620ac,{registerVerifyEmailFrom:_0x1bd5d6}=_0x19c044;console[_0x24bcb9(0x17c)]('configMap:\x20',_0x19c044);const _0x49f8fb=await this[_0x24bcb9(0x1f3)][_0x24bcb9(0x1c8)]({'to':_0x5e8cd3,'subject':'来自'+_0x1bd5d6+_0x24bcb9(0x21c),'template':_0x24bcb9(0x1d8),'context':Object[_0x24bcb9(0x1cc)]({'baseUrl':_0x19c044[_0x24bcb9(0x200)],'code':_0xa8df06,'id':_0x396f64},_0x19c044)});console[_0x24bcb9(0x17c)](_0x24bcb9(0x1fa),_0x49f8fb);}else{const {username:_0x329a1d,email:_0x28e936,id:_0x24a315,invitedBy:_0x9969fd}=_0x7f5658;await this[_0x24bcb9(0x1c6)](_0x24a315,user_constant_1[_0x24bcb9(0x17b)][_0x24bcb9(0x211)]);let _0x217649;_0x9969fd&&(_0x217649=await this[_0x24bcb9(0x180)](_0x9969fd)),await this[_0x24bcb9(0x1e8)][_0x24bcb9(0x1ba)](_0x24a315,_0x217649===null||_0x217649===void 0x0?void 0x0:_0x217649['id']);}return _0x7f5658;}catch(_0x4db216){console[_0x24bcb9(0x17c)]('error:\x20',_0x4db216);throw _0x4db216;}}async['getSuper'](){const _0x2c21f3=_0x5be414,_0x46a82a=await this['userEntity'][_0x2c21f3(0x1dc)]({'where':{'role':'super'}});return _0x46a82a;}async['verifyUserCredentials'](_0x5c2494){const _0x145693=_0x5be414,{username:_0x3408ab,password:_0x4a5712,uid:uid=0x0,phone:_0x48c2a5}=_0x5c2494;let _0x282b9f=null;if(uid>0x0){_0x282b9f=await this[_0x145693(0x1f2)][_0x145693(0x1dc)]({'where':{'id':uid}});if(!_0x282b9f)throw new common_1[(_0x145693(0x1f5))](_0x145693(0x185),common_1[_0x145693(0x183)][_0x145693(0x19b)]);if(_0x282b9f[_0x145693(0x18f)][_0x145693(0x1f4)](_0x145693(0x1b6))||_0x282b9f[_0x145693(0x18f)][_0x145693(0x1f4)](_0x145693(0x1c5))||_0x282b9f[_0x145693(0x18f)]['startsWith'](_0x145693(0x206))){if(!bcrypt[_0x145693(0x208)](_0x4a5712,_0x282b9f['password']))throw new common_1[(_0x145693(0x1f5))](_0x145693(0x17e),common_1[_0x145693(0x183)][_0x145693(0x19b)]);}else{console[_0x145693(0x17c)]('----,');const _0x2fcfc9=crypto[_0x145693(0x21a)]('md5')[_0x145693(0x1c0)](_0x4a5712)['digest'](_0x145693(0x1d5));console[_0x145693(0x17c)](_0x145693(0x182),_0x2fcfc9);if(_0x2fcfc9!==_0x282b9f[_0x145693(0x18f)])throw new common_1[(_0x145693(0x1f5))](_0x145693(0x17e),common_1[_0x145693(0x183)][_0x145693(0x19b)]);}}if(_0x3408ab&&_0x4a5712){const _0x1b0e28=[{'username':_0x3408ab},{'email':_0x3408ab}];_0x282b9f=await this[_0x145693(0x1f2)][_0x145693(0x1dc)]({'where':_0x1b0e28});if(!_0x282b9f)throw new common_1[(_0x145693(0x1f5))](_0x145693(0x185),common_1[_0x145693(0x183)][_0x145693(0x19b)]);if(_0x282b9f[_0x145693(0x18f)][_0x145693(0x1f4)](_0x145693(0x1b6))||_0x282b9f['password'][_0x145693(0x1f4)](_0x145693(0x1c5))||_0x282b9f[_0x145693(0x18f)][_0x145693(0x1f4)](_0x145693(0x206))){if(!bcrypt['compareSync'](_0x4a5712,_0x282b9f[_0x145693(0x18f)]))throw new common_1[(_0x145693(0x1f5))](_0x145693(0x17e),common_1[_0x145693(0x183)][_0x145693(0x19b)]);}else{console['log'](_0x145693(0x182));const _0x3e3448=crypto[_0x145693(0x21a)](_0x145693(0x1e6))[_0x145693(0x1c0)](_0x4a5712)[_0x145693(0x17a)](_0x145693(0x1d5));console[_0x145693(0x17c)]('----,',_0x3e3448);if(_0x3e3448!==_0x282b9f[_0x145693(0x18f)])throw new common_1[(_0x145693(0x1f5))]('当前密码错误！',common_1[_0x145693(0x183)][_0x145693(0x19b)]);}}if(_0x48c2a5&&_0x4a5712){const _0x207472=[{'phone':_0x48c2a5}];_0x282b9f=await this['userEntity'][_0x145693(0x1dc)]({'where':_0x207472});if(!_0x282b9f)throw new common_1[(_0x145693(0x1f5))]('当前账户不存在！',common_1[_0x145693(0x183)][_0x145693(0x19b)]);if(_0x282b9f[_0x145693(0x18f)]['startsWith'](_0x145693(0x1b6))||_0x282b9f[_0x145693(0x18f)][_0x145693(0x1f4)](_0x145693(0x1c5))||_0x282b9f[_0x145693(0x18f)]['startsWith'](_0x145693(0x206))){if(!bcrypt[_0x145693(0x208)](_0x4a5712,_0x282b9f[_0x145693(0x18f)]))throw new common_1[(_0x145693(0x1f5))]('当前密码错误！',common_1[_0x145693(0x183)]['BAD_REQUEST']);}else{console[_0x145693(0x17c)]('----,');const _0x34bb74=crypto['createHash'](_0x145693(0x1e6))[_0x145693(0x1c0)](_0x4a5712)[_0x145693(0x17a)]('hex');console[_0x145693(0x17c)](_0x145693(0x182),_0x34bb74);if(_0x34bb74!==_0x282b9f[_0x145693(0x18f)])throw new common_1[(_0x145693(0x1f5))](_0x145693(0x17e),common_1['HttpStatus']['BAD_REQUEST']);}}if(!_0x282b9f)throw new common_1[(_0x145693(0x1f5))](_0x145693(0x185),common_1[_0x145693(0x183)][_0x145693(0x19b)]);if(_0x282b9f['status']!==user_constant_1[_0x145693(0x17b)][_0x145693(0x211)])throw new common_1[(_0x145693(0x1f5))](user_constant_1['UserStatusErrMsg'][_0x282b9f['status']],common_1[_0x145693(0x183)]['BAD_REQUEST']);return _0x282b9f;}async[_0x5be414(0x1ab)](_0x440a7f,_0x2c6844){const _0x536bb6=_0x5be414,_0xec2594=await this[_0x536bb6(0x1f2)][_0x536bb6(0x1dc)]({'where':{'id':_0x440a7f}});if(_0xec2594[_0x536bb6(0x18f)][_0x536bb6(0x1f4)](_0x536bb6(0x1b6))||_0xec2594[_0x536bb6(0x18f)][_0x536bb6(0x1f4)](_0x536bb6(0x1c5))||_0xec2594[_0x536bb6(0x18f)][_0x536bb6(0x1f4)](_0x536bb6(0x206)))return bcrypt[_0x536bb6(0x208)](_0x2c6844,_0xec2594[_0x536bb6(0x18f)]);else{const _0x4aed18=crypto[_0x536bb6(0x21a)]('md5')[_0x536bb6(0x1c0)](_0x2c6844)[_0x536bb6(0x17a)]('hex');return console[_0x536bb6(0x17c)]('----,',_0x4aed18),_0x4aed18===_0xec2594[_0x536bb6(0x18f)];}}async[_0x5be414(0x1c6)](_0x4e2279,_0x3f4058){const _0x22c2f1=_0x5be414,_0x162bd8=await this[_0x22c2f1(0x1f2)]['update']({'id':_0x4e2279},{'status':_0x3f4058});return _0x162bd8['affected']>0x0;}async['getUserStatus'](_0x13f2c8){const _0xf3db54=await this['userEntity']['findOne']({'where':{'id':_0x13f2c8}});return _0xf3db54['status'];}async[_0x5be414(0x19f)](_0x56814c){const _0xae5bba=_0x5be414;return await this[_0xae5bba(0x1f2)]['findOne']({'where':{'id':_0x56814c}});}async[_0x5be414(0x17d)](_0x2da8f4){const _0x10ce8c=_0x5be414;return await this[_0x10ce8c(0x1f2)][_0x10ce8c(0x1dc)]({'where':{'phone':_0x2da8f4}});}async[_0x5be414(0x1e2)](_0x54122e){const _0x2e8654=_0x5be414;return await this[_0x2e8654(0x1f2)][_0x2e8654(0x1dc)]({'where':{'id':_0x54122e}});}async[_0x5be414(0x1d1)](_0x3c3516){const _0x510687=_0x5be414,{id:_0x179444,role:_0x5baf80}=_0x3c3516;if(_0x5baf80===_0x510687(0x1e9))return!![];const _0x532a54=await this['userEntity']['findOne']({'where':{'id':_0x179444}});if(!_0x532a54)throw new common_1[(_0x510687(0x1f5))](_0x510687(0x1a2),common_1[_0x510687(0x183)]['UNAUTHORIZED']);if(_0x532a54['status']===user_constant_1[_0x510687(0x17b)][_0x510687(0x1ef)])throw new common_1[(_0x510687(0x1f5))](_0x510687(0x1ca),common_1['HttpStatus'][_0x510687(0x19b)]);if(_0x532a54['status']===user_constant_1['UserStatusEnum'][_0x510687(0x195)])throw new common_1[(_0x510687(0x1f5))](_0x510687(0x1fb),common_1['HttpStatus'][_0x510687(0x19b)]);}async['getUserInfo'](_0x58eefc){const _0x53d74b=_0x5be414,_0xb67efd=await this[_0x53d74b(0x1f2)]['findOne']({'where':{'id':_0x58eefc},'select':[_0x53d74b(0x18a),'avatar','role',_0x53d74b(0x204),_0x53d74b(0x178),_0x53d74b(0x187),'openId',_0x53d74b(0x1d6)]});if(!_0xb67efd)throw new common_1[(_0x53d74b(0x1f5))](_0x53d74b(0x1a2),common_1[_0x53d74b(0x183)][_0x53d74b(0x1a4)]);_0xb67efd[_0x53d74b(0x1ac)]=!!(_0xb67efd===null||_0xb67efd===void 0x0?void 0x0:_0xb67efd['openId']),delete _0xb67efd[_0x53d74b(0x1f9)];const _0x489286=await this[_0x53d74b(0x1e8)][_0x53d74b(0x16d)](_0x58eefc);return{'userInfo':_0xb67efd,'userBalance':Object[_0x53d74b(0x1cc)]({},_0x489286)};}async[_0x5be414(0x1d0)](_0x3e4d01){const _0x357f17=_0x5be414;return await this[_0x357f17(0x1f2)]['findOne']({'where':{'id':_0x3e4d01}});}async[_0x5be414(0x18b)](_0x3ee4c5){const _0x31c6ae=_0x5be414;return await this[_0x31c6ae(0x1f2)][_0x31c6ae(0x1dc)]({'where':{'openId':_0x3ee4c5}});}async[_0x5be414(0x216)](_0x6c7103,_0x5d1cd1){const _0x39b8d5=_0x5be414,{id:_0xe824b1}=_0x5d1cd1[_0x39b8d5(0x209)],_0x3e2055=await this[_0x39b8d5(0x1f2)][_0x39b8d5(0x1dc)]({'where':{'id':_0xe824b1}});if(!_0x3e2055)throw new common_1[(_0x39b8d5(0x1f5))]('当前用户不存在！',common_1[_0x39b8d5(0x183)][_0x39b8d5(0x19b)]);if(_0x6c7103[_0x39b8d5(0x18a)]&&_0x3e2055[_0x39b8d5(0x18a)]===_0x6c7103['username'])throw new common_1[(_0x39b8d5(0x1f5))]('没有变更，无需更改！',common_1[_0x39b8d5(0x183)][_0x39b8d5(0x19b)]);if(_0x6c7103['username']){const _0x1b7247=await this[_0x39b8d5(0x1f2)][_0x39b8d5(0x1dc)]({'where':{'username':_0x6c7103[_0x39b8d5(0x18a)],'id':(0x0,typeorm_2[_0x39b8d5(0x175)])(_0xe824b1)}});if(_0x1b7247)throw new common_1[(_0x39b8d5(0x1f5))](_0x39b8d5(0x1ff),common_1['HttpStatus']['BAD_REQUEST']);}const _0x2390c0=await this[_0x39b8d5(0x1f2)][_0x39b8d5(0x1c0)]({'id':_0xe824b1},_0x6c7103);if(_0x2390c0[_0x39b8d5(0x1f7)]<=0x0)throw new common_1[(_0x39b8d5(0x1f5))]('修改用户信息失败！',common_1[_0x39b8d5(0x183)][_0x39b8d5(0x19b)]);return _0x39b8d5(0x1b9);}async[_0x5be414(0x1ea)](_0x1c788f,_0xa939e0){const _0x2bf204=_0x5be414,_0xd96f66=bcrypt['hashSync'](_0xa939e0,0xa),_0x48c9a4=await this[_0x2bf204(0x1f2)][_0x2bf204(0x1c0)]({'id':_0x1c788f},{'password':_0xd96f66});if(_0x48c9a4[_0x2bf204(0x1f7)]<=0x0)throw new common_1[(_0x2bf204(0x1f5))](_0x2bf204(0x1db),common_1[_0x2bf204(0x183)][_0x2bf204(0x19b)]);}async[_0x5be414(0x1fd)](_0x4dbb4){const _0x2ab778=_0x5be414,{id:_0x47c072}=_0x4dbb4[_0x2ab778(0x209)],_0x2a7d5b=await this['userEntity']['findOne']({'where':{'id':_0x47c072}});if(!_0x2a7d5b||_0x2a7d5b[_0x2ab778(0x187)])throw new common_1[(_0x2ab778(0x1f5))](_0x2ab778(0x1da),common_1['HttpStatus'][_0x2ab778(0x19b)]);const _0x5daa87=(0x0,utils_1[_0x2ab778(0x1d3)])(),_0x2ccdbb=await this[_0x2ab778(0x1f2)][_0x2ab778(0x1dc)]({'where':{'inviteCode':_0x5daa87}});if(_0x2ccdbb)throw new common_1['HttpException'](_0x2ab778(0x1bd),common_1[_0x2ab778(0x183)][_0x2ab778(0x19b)]);const _0x71b1ba=await this[_0x2ab778(0x1f2)][_0x2ab778(0x1c0)]({'id':_0x47c072},{'inviteCode':_0x5daa87});if(_0x71b1ba[_0x2ab778(0x1f7)]<=0x0)throw new common_1['HttpException']('生成邀请码失败，请重新试一次吧！',common_1[_0x2ab778(0x183)][_0x2ab778(0x19b)]);return _0x5daa87;}async[_0x5be414(0x1ce)](_0x9c6e3,_0x261e6f){const _0x15e966=_0x5be414;try{const {id:_0x11db7e}=_0x9c6e3[_0x15e966(0x209)],{page:page=0x1,size:size=0xa}=_0x261e6f,_0xcebfe0=await this[_0x15e966(0x1f2)][_0x15e966(0x1dc)]({'where':{'id':_0x11db7e}}),{inviteCode:_0x1c0cdf}=_0xcebfe0;if(!_0x1c0cdf)return[];const [_0x46674c,_0x18c44b]=await this[_0x15e966(0x1f2)]['findAndCount']({'where':{'inviteCode':_0x1c0cdf},'order':{'id':'DESC'},'select':[_0x15e966(0x18a),_0x15e966(0x204),_0x15e966(0x1b7),_0x15e966(0x1ed),_0x15e966(0x16c)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x15e966(0x1a1)])(_0x46674c)[_0x15e966(0x20e)](_0x349957=>{const _0x5820fb=_0x15e966;return _0x349957[_0x5820fb(0x204)]=(0x0,utils_1[_0x5820fb(0x1f1)])(_0x349957[_0x5820fb(0x204)]),_0x349957;}),{'rows':_0x46674c,'count':_0x18c44b};}catch(_0x5d23ab){console[_0x15e966(0x17c)]('error:\x20',_0x5d23ab);throw new common_1['HttpException'](_0x15e966(0x18d),common_1[_0x15e966(0x183)][_0x15e966(0x19b)]);}}async[_0x5be414(0x190)](_0x433b3f){const _0x37ef04=_0x5be414,_0x402253=await this['userEntity']['findOne']({'where':{'inviteCode':_0x433b3f}});if(!_0x402253)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x402253,_0x3725d9=await this[_0x37ef04(0x1f2)][_0x37ef04(0x1c0)]({'inviteCode':_0x433b3f},{'inviteLinkCount':inviteLinkCount+0x1});return _0x3725d9['affected']?0x1:0x0;}async[_0x5be414(0x180)](_0x331c30){const _0x25c8c1=_0x5be414;return await this[_0x25c8c1(0x1f2)]['findOne']({'where':{'inviteCode':_0x331c30}});}async[_0x5be414(0x16e)](_0x12f894){const _0xd69ec1=_0x5be414,{userId:_0x23847d,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x12f894;await this['userBalanceService'][_0xd69ec1(0x1a6)](_0x23847d,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x16f2f1=await this['userBalanceService']['saveRecordRechargeLog']({'userId':_0x23847d,'rechargeType':balance_constant_1['RechargeType'][_0xd69ec1(0x198)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x16f2f1;}async[_0x5be414(0x170)](_0xaa9b95,_0x348721){const _0x17c2df=_0x5be414,{page:page=0x1,size:size=0xa,username:_0x5c70ce,email:_0x15f4da,status:_0x380a1a,keyword:_0x4604db,phone:_0x895ebe}=_0xaa9b95;let _0x103fe7={};_0x5c70ce&&Object['assign'](_0x103fe7,{'username':(0x0,typeorm_2[_0x17c2df(0x1a3)])('%'+_0x5c70ce+'%')}),_0x15f4da&&Object[_0x17c2df(0x1cc)](_0x103fe7,{'email':(0x0,typeorm_2['Like'])('%'+_0x15f4da+'%')}),_0x895ebe&&Object[_0x17c2df(0x1cc)](_0x103fe7,{'phone':(0x0,typeorm_2[_0x17c2df(0x1a3)])('%'+_0x895ebe+'%')}),_0x380a1a&&Object[_0x17c2df(0x1cc)](_0x103fe7,{'status':_0x380a1a});_0x4604db&&(_0x103fe7=[{'username':(0x0,typeorm_2['Like'])('%'+_0x4604db+'%')},{'email':(0x0,typeorm_2[_0x17c2df(0x1a3)])('%'+_0x4604db+'%')},{'phone':(0x0,typeorm_2[_0x17c2df(0x1a3)])('%'+_0x4604db+'%')}]);const [_0x49c07a,_0x2ffa72]=await this[_0x17c2df(0x1f2)][_0x17c2df(0x218)]({'skip':(page-0x1)*size,'where':_0x103fe7,'take':size,'order':{'createdAt':'DESC'},'cache':!![],'select':[_0x17c2df(0x18a),_0x17c2df(0x16c),_0x17c2df(0x187),_0x17c2df(0x19a),_0x17c2df(0x178),'status','id',_0x17c2df(0x204),_0x17c2df(0x1b7),_0x17c2df(0x18c),_0x17c2df(0x213)]}),_0x3ee7cf=_0x49c07a[_0x17c2df(0x20e)](_0x58718a=>_0x58718a['id']),_0x53620c=await this[_0x17c2df(0x1e8)][_0x17c2df(0x1a8)](_0x3ee7cf);return _0x49c07a[_0x17c2df(0x1b1)](_0x103107=>_0x103107[_0x17c2df(0x1ad)]=_0x53620c[_0x17c2df(0x18e)](_0x366e84=>_0x366e84[_0x17c2df(0x1b4)]===_0x103107['id'])),_0x348721['user'][_0x17c2df(0x19a)]!==_0x17c2df(0x1bc)&&_0x49c07a[_0x17c2df(0x1b1)](_0x5c354c=>_0x5c354c[_0x17c2df(0x204)]=(0x0,utils_1[_0x17c2df(0x1f1)])(_0x5c354c[_0x17c2df(0x204)])),_0x348721[_0x17c2df(0x209)][_0x17c2df(0x19a)]!==_0x17c2df(0x1bc)&&_0x49c07a[_0x17c2df(0x1b1)](_0x2fd254=>_0x2fd254[_0x17c2df(0x18c)]=(0x0,utils_1[_0x17c2df(0x1c7)])(_0x2fd254['lastLoginIp'])),_0x348721[_0x17c2df(0x209)][_0x17c2df(0x19a)]!==_0x17c2df(0x1bc)&&_0x49c07a['forEach'](_0x4252fd=>_0x4252fd[_0x17c2df(0x213)]=(0x0,utils_1['maskIpAddress'])(_0x4252fd['phone'])),{'rows':_0x49c07a,'count':_0x2ffa72};}async[_0x5be414(0x20a)]({id:_0x532874}){const _0x5dce1b=_0x5be414;return await this[_0x5dce1b(0x1f2)][_0x5dce1b(0x1dc)]({'where':{'id':_0x532874},'select':[_0x5dce1b(0x18a),_0x5dce1b(0x16c),'inviteCode','role',_0x5dce1b(0x178),_0x5dce1b(0x1ed)]});}async[_0x5be414(0x179)](_0x1ced20){const _0x484b89=_0x5be414,{id:_0x18e657,status:_0x5ce60b}=_0x1ced20,_0xa77dbe=await this[_0x484b89(0x1f2)][_0x484b89(0x1dc)]({'where':{'id':_0x18e657}});if(!_0xa77dbe)throw new common_1[(_0x484b89(0x1f5))](_0x484b89(0x1a5),common_1[_0x484b89(0x183)][_0x484b89(0x19b)]);if(_0xa77dbe[_0x484b89(0x19a)]===_0x484b89(0x1bc))throw new common_1['HttpException'](_0x484b89(0x186),common_1[_0x484b89(0x183)][_0x484b89(0x19b)]);if(_0xa77dbe['status']===user_constant_1[_0x484b89(0x17b)][_0x484b89(0x172)])throw new common_1[(_0x484b89(0x1f5))](_0x484b89(0x20f),common_1[_0x484b89(0x183)][_0x484b89(0x19b)]);if(_0xa77dbe[_0x484b89(0x19a)]==='super')throw new common_1[(_0x484b89(0x1f5))](_0x484b89(0x186),common_1[_0x484b89(0x183)][_0x484b89(0x19b)]);if(_0x5ce60b===user_constant_1[_0x484b89(0x17b)][_0x484b89(0x172)])throw new common_1[(_0x484b89(0x1f5))](_0x484b89(0x20d),common_1['HttpStatus'][_0x484b89(0x19b)]);const _0x1b5413=await this[_0x484b89(0x1f2)][_0x484b89(0x1c0)]({'id':_0x18e657},{'status':_0x5ce60b});if(_0x1b5413['affected']<=0x0)throw new common_1['HttpException']('修改用户状态失败！',common_1['HttpStatus']['BAD_REQUEST']);return _0x484b89(0x196);}async[_0x5be414(0x1b8)](_0x4968d9){const _0x53ba8a=_0x5be414,{id:_0x4c8d04}=_0x4968d9,_0x1cc8d8=await this[_0x53ba8a(0x1f2)]['findOne']({'where':{'id':_0x4c8d04}});if(!_0x1cc8d8)throw new common_1['HttpException'](_0x53ba8a(0x1a5),common_1['HttpStatus']['BAD_REQUEST']);const _0x4168d4=_0x53ba8a(0x20b),_0x44a7af=bcrypt[_0x53ba8a(0x1e7)](_0x4168d4,0xa),_0xf8ae93=await this['userEntity'][_0x53ba8a(0x1c0)]({'id':_0x4c8d04},{'password':_0x44a7af});if(_0xf8ae93[_0x53ba8a(0x1f7)]<=0x0)throw new common_1[(_0x53ba8a(0x1f5))](_0x53ba8a(0x1c3),common_1[_0x53ba8a(0x183)][_0x53ba8a(0x19b)]);return _0x53ba8a(0x201)+_0x4168d4+']成功!';}async[_0x5be414(0x19e)](_0x4b3aad,_0x2f2036){const _0x237af6=_0x5be414;return await this[_0x237af6(0x1f2)][_0x237af6(0x1c0)]({'id':_0x4b3aad},{'lastLoginIp':_0x2f2036});}async['getUserFromOpenId'](_0x13ba19,_0x250334){const _0x3a6314=_0x5be414,_0x3db644=await this['userEntity'][_0x3a6314(0x1dc)]({'where':{'openId':_0x13ba19}});if(!_0x3db644){const _0x4716eb=_0x250334?_0x250334[_0x3a6314(0x1af)](':')[0x1]:'',_0x215e32=await this[_0x3a6314(0x180)](_0x4716eb),_0x2fca0d=await this[_0x3a6314(0x1cd)](_0x13ba19,_0x4716eb);return await this[_0x3a6314(0x1e8)][_0x3a6314(0x1ba)](_0x2fca0d['id'],_0x4716eb?_0x215e32===null||_0x215e32===void 0x0?void 0x0:_0x215e32['id']:null),_0x2fca0d;}return _0x3db644;}async['createUserFromOpenId'](_0x22d080,_0x1cdb85){const _0x58e11a=_0x5be414,_0x22564a=await this['globalConfigService'][_0x58e11a(0x1b3)]([_0x58e11a(0x17f)]),_0xc81c8f={'avatar':_0x22564a,'username':'用户'+(0x0,utils_1[_0x58e11a(0x1d2)])(),'status':user_constant_1[_0x58e11a(0x17b)][_0x58e11a(0x211)],'sex':0x0,'email':(0x0,utils_1['createRandomUid'])()+_0x58e11a(0x193),'invitedBy':_0x1cdb85,'openId':_0x22d080},_0x57ca4c=await this[_0x58e11a(0x1f2)]['save'](_0xc81c8f);return _0x57ca4c;}async[_0x5be414(0x16f)](_0x5612e4,_0x596b75){const _0x2e8e83=_0x5be414;try{const _0x5a0cd1=await this[_0x2e8e83(0x1f2)][_0x2e8e83(0x1dc)]({'where':{'id':_0x596b75}});if(!_0x5a0cd1)return{'status':![],'msg':_0x2e8e83(0x174)};const _0x5702a6=await this['userEntity'][_0x2e8e83(0x1dc)]({'where':{'openId':_0x5612e4}});if(_0x5702a6)return{'status':![],'msg':'该微信已绑定其他账号！'};const _0x5e07dd=await this[_0x2e8e83(0x1f2)][_0x2e8e83(0x1c0)]({'id':_0x596b75},{'openId':_0x5612e4});if(_0x5e07dd[_0x2e8e83(0x1f7)]<=0x0)return{'status':![],'msg':'绑定微信失败、请联系管理员！'};return{'status':!![],'msg':_0x2e8e83(0x202)};}catch(_0x3f6139){return{'status':![],'msg':'绑定微信失败、请联系管理员！'};}}async[_0x5be414(0x1cb)](_0x5dc8c2){const _0x2ad49b=_0x5be414,_0x588b8a=await this[_0x2ad49b(0x1f2)][_0x2ad49b(0x1dc)]({'where':{'id':_0x5dc8c2}});return _0x588b8a===null||_0x588b8a===void 0x0?void 0x0:_0x588b8a[_0x2ad49b(0x1f9)];}async[_0x5be414(0x1c4)](_0x30423d){const _0x3853d7=_0x5be414,{username:_0x53ad94,password:_0x46cde9,phone:_0xc533d,phoneCode:_0x358fee}=_0x30423d,_0x4fe16e=await this[_0x3853d7(0x1f2)][_0x3853d7(0x1dc)]({'where':[{'username':_0x53ad94},{'phone':_0xc533d}]});if(_0x4fe16e&&_0x4fe16e['username']===_0x53ad94)throw new common_1[(_0x3853d7(0x1f5))](_0x3853d7(0x1ec),common_1[_0x3853d7(0x183)][_0x3853d7(0x19b)]);if(_0x4fe16e&&_0x4fe16e[_0x3853d7(0x213)]===_0xc533d)throw new common_1[(_0x3853d7(0x1f5))](_0x3853d7(0x192),common_1[_0x3853d7(0x183)][_0x3853d7(0x19b)]);}async[_0x5be414(0x181)](_0x2f5051){const _0x31e5b3=_0x5be414;return await this[_0x31e5b3(0x1f2)]['save'](_0x2f5051);}};UserService=__decorate([(0x0,common_1[_0x5be414(0x19c)])(),__param(0x0,(0x0,typeorm_1[_0x5be414(0x1c2)])(user_entity_1[_0x5be414(0x1fe)])),__param(0x1,(0x0,typeorm_1[_0x5be414(0x1c2)])(whiteList_entity_1[_0x5be414(0x1f6)])),__param(0x7,(0x0,typeorm_1[_0x5be414(0x1c2)])(config_entity_1['ConfigEntity'])),__metadata(_0x5be414(0x1df),[typeorm_2[_0x5be414(0x203)],typeorm_2[_0x5be414(0x203)],typeorm_2[_0x5be414(0x1e4)],verification_service_1[_0x5be414(0x21d)],mailer_1[_0x5be414(0x212)],userBalance_service_1['UserBalanceService'],globalConfig_service_1['GlobalConfigService'],typeorm_2[_0x5be414(0x203)]])],UserService),exports[_0x5be414(0x1e3)]=UserService;