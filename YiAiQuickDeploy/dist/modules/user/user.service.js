'use strict';function _0x521f(_0x39e108,_0x21027a){const _0x50ac8d=_0x50ac();return _0x521f=function(_0x521f9f,_0x452f8b){_0x521f9f=_0x521f9f-0xe6;let _0x16ec59=_0x50ac8d[_0x521f9f];return _0x16ec59;},_0x521f(_0x39e108,_0x21027a);}const _0x1029fd=_0x521f;(function(_0x3a8080,_0x3bcabd){const _0x13032b=_0x521f,_0x405319=_0x3a8080();while(!![]){try{const _0x241e4d=-parseInt(_0x13032b(0x104))/0x1*(-parseInt(_0x13032b(0x192))/0x2)+-parseInt(_0x13032b(0xf1))/0x3*(parseInt(_0x13032b(0x16e))/0x4)+parseInt(_0x13032b(0x144))/0x5+-parseInt(_0x13032b(0x149))/0x6*(-parseInt(_0x13032b(0x101))/0x7)+parseInt(_0x13032b(0x196))/0x8*(-parseInt(_0x13032b(0x171))/0x9)+-parseInt(_0x13032b(0x105))/0xa+-parseInt(_0x13032b(0xf9))/0xb*(parseInt(_0x13032b(0x195))/0xc);if(_0x241e4d===_0x3bcabd)break;else _0x405319['push'](_0x405319['shift']());}catch(_0x5ee687){_0x405319['push'](_0x405319['shift']());}}}(_0x50ac,0xeb676));var __decorate=this&&this[_0x1029fd(0xf3)]||function(_0x48eac5,_0x3f2277,_0x1569f0,_0x2a813c){const _0x47c6a1=_0x1029fd;var _0x2a9b28=arguments[_0x47c6a1(0x190)],_0xe67e2a=_0x2a9b28<0x3?_0x3f2277:_0x2a813c===null?_0x2a813c=Object[_0x47c6a1(0x147)](_0x3f2277,_0x1569f0):_0x2a813c,_0xb5d24;if(typeof Reflect===_0x47c6a1(0xea)&&typeof Reflect[_0x47c6a1(0x121)]===_0x47c6a1(0x133))_0xe67e2a=Reflect[_0x47c6a1(0x121)](_0x48eac5,_0x3f2277,_0x1569f0,_0x2a813c);else{for(var _0x28c730=_0x48eac5[_0x47c6a1(0x190)]-0x1;_0x28c730>=0x0;_0x28c730--)if(_0xb5d24=_0x48eac5[_0x28c730])_0xe67e2a=(_0x2a9b28<0x3?_0xb5d24(_0xe67e2a):_0x2a9b28>0x3?_0xb5d24(_0x3f2277,_0x1569f0,_0xe67e2a):_0xb5d24(_0x3f2277,_0x1569f0))||_0xe67e2a;}return _0x2a9b28>0x3&&_0xe67e2a&&Object[_0x47c6a1(0x117)](_0x3f2277,_0x1569f0,_0xe67e2a),_0xe67e2a;},__metadata=this&&this[_0x1029fd(0x108)]||function(_0x11cda5,_0xb47a16){const _0x26fb64=_0x1029fd;if(typeof Reflect===_0x26fb64(0xea)&&typeof Reflect[_0x26fb64(0x198)]===_0x26fb64(0x133))return Reflect['metadata'](_0x11cda5,_0xb47a16);},__param=this&&this[_0x1029fd(0xfa)]||function(_0x11f8c2,_0x3dc954){return function(_0x4a1e12,_0x15b960){_0x3dc954(_0x4a1e12,_0x15b960,_0x11f8c2);};};Object[_0x1029fd(0x117)](exports,_0x1029fd(0x182),{'value':!![]}),exports[_0x1029fd(0x183)]=void 0x0;function _0x50ac(){const _0x5786b8=['hashSync','username',']成功!','sendMail','genInviteCode','configMap:\x20','77392HEbRws','queryUserBalance','getInviteRecord','19PRzLwt','1613020LzjaUq','registerBaseUrl','InjectRepository','__metadata','avatar','当前密码错误！','修改用户状态失败！','registerIp','getUserOpenId','role','当前账户不存在！','Registration','userEntity','email','savaLoginIp','digest','find','qureyUserInfoByInviteCode','defineProperty','BAD_REQUEST','registerVerifyExpir','inviteCode','getConfigs','typeorm','maskIpAddress','../globalConfig/config.entity','getSuper','hex','decorate','whiteListEntity','已生成过邀请码、请勿重复生成','user','../../common/constants/verification.constant','修改密码失败、请重新试试吧。','userId','email\x20response\x20\x20->\x20:\x20','createVerification','configKey','UNAUTHORIZED','mailerService','inviteLink','queryAll','当前手机号已注册、请勿重复注册！','../chatgpt/whiteList.entity','MailerService','UserStatusErrMsg','function','BLACKLISTED','getUserStatus','生成邀请码失败，请重新试一次吧！','userRecharge','forEach','createUser','compareSync','用户不存在！','当前用户不存在！','createdAt','不可将用户置为未激活状态！','userBalanceService','save','isVerifyEmail','registerVerifyEmailDesc','无效的邀请码！','5777385rSnQMp','getUserFromOpenId','bindWx','getOwnPropertyDescriptor','Repository','192CoehXZ','当前绑定用户不存在！','../userBalance/userBalance.service','verifyUserCredentials','balanceInfo','verificationService','queryUserBalanceByIds','../../common/constants/balance.constant','startsWith','globalConfigService','getClientIp','verifyUserRegisterByPhone','createUserFromOpenId','formatCreateOrUpdateDate','./user.entity','log','修改用户信息失败！','updateUserStatus','DESC','assign','用户名或者邮箱已被注册！','createUserAndVerifycation','VerificationService','UserBalanceService','addBalanceToNewUser','updateUserPassword','sign','affected','绑定微信失败、请联系管理员！','updateStatus','VerificationEnum','createHash','@nestjs/common','crypto','md5','getUserById','status','316OTxXFt','超级管理员不可被操作！','visitor','2034SCbIyu','lodash','error:\x20','当前用户信息失效、请重新登录！','恭喜您绑定成功、后续可直接扫码登录了！','修改用户状态成功！','update','phone','queryUserInfoById','map','resetUserPass','configEntity','reduce','LOCKED','HttpStatus','ConfigEntity','UserEntity','__esModule','UserService','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','design:paramtypes','client','GlobalConfigService','UserStatusEnum','userDefautlAvatar','findOne','consecutiveDays','generateRandomString','未激活用户不可手动变更状态！','HttpException','queryOneUserInfo','length','$2a$','112226qpngjY','获取邀请记录失败！','Connection','270636nbLrcS','20616HhhwYd','ACTIVE','metadata','super','$2b$','123456','没有变更，无需更改！','@nestjs/typeorm','object','密码重置为[','password','openId','Like','configVal','lastLoginIp','9819OAEFgW','----,','__decorate','split','$2y$','cloneDeep','maskEmail','PENDING','297kSYzNL','__param'];_0x50ac=function(){return _0x5786b8;};return _0x50ac();}const globalConfig_service_1=require('../globalConfig/globalConfig.service'),user_constant_1=require('../../common/constants/user.constant'),mailer_1=require('@nestjs-modules/mailer'),verification_service_1=require('../verification/verification.service'),common_1=require(_0x1029fd(0x169)),typeorm_1=require(_0x1029fd(0xe9)),typeorm_2=require(_0x1029fd(0x11c)),user_entity_1=require(_0x1029fd(0x157)),bcrypt=require('bcryptjs'),crypto=require(_0x1029fd(0x16a)),_=require(_0x1029fd(0x172)),verification_constant_1=require(_0x1029fd(0x125)),userBalance_service_1=require(_0x1029fd(0x14b)),utils_1=require('../../common/utils'),balance_constant_1=require(_0x1029fd(0x150)),config_entity_1=require(_0x1029fd(0x11e)),whiteList_entity_1=require(_0x1029fd(0x130));let UserService=class UserService{constructor(_0x325575,_0x38087d,_0x5bc38a,_0x28e668,_0x57c73a,_0x320a10,_0x277834,_0x22edd8){const _0x3dad72=_0x1029fd;this['userEntity']=_0x325575,this[_0x3dad72(0x122)]=_0x38087d,this['connection']=_0x5bc38a,this[_0x3dad72(0x14e)]=_0x28e668,this[_0x3dad72(0x12c)]=_0x57c73a,this['userBalanceService']=_0x320a10,this[_0x3dad72(0x152)]=_0x277834,this['configEntity']=_0x22edd8;}async[_0x1029fd(0x15e)](_0xd08e89,_0x30b43f){const _0x521323=_0x1029fd,{username:_0x1e6031,email:_0x472cb4,password:_0x3fc8e1,invitedBy:_0x45c46a,client:client=0x0}=_0xd08e89;if(_0x45c46a){const _0x2c2a06=await this['userEntity'][_0x521323(0x18a)]({'where':{'inviteCode':_0x45c46a}});if(!_0x2c2a06)throw new common_1[(_0x521323(0x18e))](_0x521323(0x143),common_1['HttpStatus']['BAD_REQUEST']);}const _0x29e80e=[{'username':_0x1e6031},{'email':_0x472cb4}],_0x1aeb62=await this[_0x521323(0x111)]['findOne']({'where':_0x29e80e});if(_0x1aeb62&&_0x1aeb62[_0x521323(0x16d)]!==user_constant_1[_0x521323(0x188)][_0x521323(0xf8)])throw new common_1['HttpException'](_0x521323(0x15d),common_1['HttpStatus'][_0x521323(0x118)]);try{const _0x46d240=_[_0x521323(0xf6)](_0xd08e89),_0x5d8fa1=bcrypt['hashSync'](_0x3fc8e1,0xa),_0x1d5add=(0x0,utils_1[_0x521323(0x153)])(_0x30b43f);_0x46d240[_0x521323(0xec)]=_0x5d8fa1,_0x46d240[_0x521323(0x10c)]=_0x1d5add,_0x46d240[_0x521323(0x186)]=client;let _0x26a3bf;if(!_0x1aeb62){const _0x3a2953=await this['globalConfigService']['getConfigs']([_0x521323(0x189)]);_0x46d240[_0x521323(0x109)]=_0x3a2953,_0x26a3bf=await this['userEntity']['save'](_0x46d240);}else _0x26a3bf=_0x1aeb62;const _0x1a6642=await this[_0x521323(0x17c)][_0x521323(0x115)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x521323(0x141),_0x521323(0x106),'registerVerifyEmailTitle',_0x521323(0x142),'registerVerifyEmailFrom',_0x521323(0x119)])}}),_0x26fa87=_0x1a6642[_0x521323(0x17d)]((_0x231c89,_0xf34e8f)=>{const _0x565dd3=_0x521323;return _0x231c89[_0xf34e8f[_0x565dd3(0x12a)]]=_0xf34e8f[_0x565dd3(0xef)],_0x231c89;},{}),_0x2c3b43=_0x26fa87[_0x521323(0x141)]?Number(_0x26fa87[_0x521323(0x141)]):0x1;if(_0x2c3b43){const _0x39c4f0=_0x26fa87[_0x521323(0x119)]?Number(_0x26fa87[_0x521323(0x119)]):0x1e*0x3c,_0x27eb9e=await this[_0x521323(0x14e)][_0x521323(0x129)](_0x26a3bf,verification_constant_1[_0x521323(0x167)][_0x521323(0x110)],_0x39c4f0),{code:_0x1f68c0,email:_0x35559c,id:_0x109c3e}=_0x27eb9e,{registerVerifyEmailFrom:_0x3578ca}=_0x26fa87;console['log'](_0x521323(0x100),_0x26fa87);const _0xaed8f0=await this[_0x521323(0x12c)][_0x521323(0xfe)]({'to':_0x35559c,'subject':'来自'+_0x3578ca+'的账号激活','template':'register','context':Object[_0x521323(0x15c)]({'baseUrl':_0x26fa87[_0x521323(0x106)],'code':_0x1f68c0,'id':_0x109c3e},_0x26fa87)});console[_0x521323(0x158)](_0x521323(0x128),_0xaed8f0);}else{const {username:_0x411f83,email:_0xb9fc67,id:_0x3b36c6,invitedBy:_0x5a4d91}=_0x26a3bf;await this[_0x521323(0x15a)](_0x3b36c6,user_constant_1[_0x521323(0x188)][_0x521323(0x197)]);let _0x2d44ec;_0x5a4d91&&(_0x2d44ec=await this[_0x521323(0x116)](_0x5a4d91)),await this['userBalanceService'][_0x521323(0x161)](_0x3b36c6,_0x2d44ec===null||_0x2d44ec===void 0x0?void 0x0:_0x2d44ec['id']);}return _0x26a3bf;}catch(_0x1954e3){console['log'](_0x521323(0x173),_0x1954e3);throw _0x1954e3;}}async[_0x1029fd(0x11f)](){const _0x481ff5=_0x1029fd,_0x367aa2=await this[_0x481ff5(0x111)][_0x481ff5(0x18a)]({'where':{'role':_0x481ff5(0x199)}});return _0x367aa2;}async[_0x1029fd(0x14c)](_0x50cbae){const _0x2ac200=_0x1029fd,{username:_0xf982ec,password:_0x5a9330,uid:uid=0x0,phone:_0x29017a}=_0x50cbae;let _0xb0f842=null;if(uid>0x0){_0xb0f842=await this['userEntity'][_0x2ac200(0x18a)]({'where':{'id':uid}});if(!_0xb0f842)throw new common_1[(_0x2ac200(0x18e))](_0x2ac200(0x10f),common_1[_0x2ac200(0x17f)][_0x2ac200(0x118)]);if(_0xb0f842[_0x2ac200(0xec)]['startsWith'](_0x2ac200(0x191))||_0xb0f842[_0x2ac200(0xec)]['startsWith'](_0x2ac200(0xe6))||_0xb0f842[_0x2ac200(0xec)]['startsWith'](_0x2ac200(0xf5))){if(!bcrypt[_0x2ac200(0x13a)](_0x5a9330,_0xb0f842[_0x2ac200(0xec)]))throw new common_1[(_0x2ac200(0x18e))]('当前密码错误！',common_1['HttpStatus']['BAD_REQUEST']);}else{console['log'](_0x2ac200(0xf2));const _0x4a503d=crypto[_0x2ac200(0x168)]('md5')['update'](_0x5a9330)[_0x2ac200(0x114)]('hex');console[_0x2ac200(0x158)]('----,',_0x4a503d);if(_0x4a503d!==_0xb0f842['password'])throw new common_1[(_0x2ac200(0x18e))](_0x2ac200(0x10a),common_1['HttpStatus'][_0x2ac200(0x118)]);}}if(_0xf982ec&&_0x5a9330){const _0x5729e4=[{'username':_0xf982ec},{'email':_0xf982ec}];_0xb0f842=await this[_0x2ac200(0x111)]['findOne']({'where':_0x5729e4});if(!_0xb0f842)throw new common_1[(_0x2ac200(0x18e))]('当前账户不存在！',common_1[_0x2ac200(0x17f)][_0x2ac200(0x118)]);if(_0xb0f842[_0x2ac200(0xec)][_0x2ac200(0x151)]('$2a$')||_0xb0f842['password'][_0x2ac200(0x151)](_0x2ac200(0xe6))||_0xb0f842['password'][_0x2ac200(0x151)](_0x2ac200(0xf5))){if(!bcrypt[_0x2ac200(0x13a)](_0x5a9330,_0xb0f842[_0x2ac200(0xec)]))throw new common_1[(_0x2ac200(0x18e))]('当前密码错误！',common_1[_0x2ac200(0x17f)][_0x2ac200(0x118)]);}else{console[_0x2ac200(0x158)](_0x2ac200(0xf2));const _0xf03370=crypto[_0x2ac200(0x168)](_0x2ac200(0x16b))['update'](_0x5a9330)[_0x2ac200(0x114)](_0x2ac200(0x120));console[_0x2ac200(0x158)](_0x2ac200(0xf2),_0xf03370);if(_0xf03370!==_0xb0f842[_0x2ac200(0xec)])throw new common_1[(_0x2ac200(0x18e))](_0x2ac200(0x10a),common_1[_0x2ac200(0x17f)][_0x2ac200(0x118)]);}}if(_0x29017a&&_0x5a9330){const _0x4a0b4c=[{'phone':_0x29017a}];_0xb0f842=await this['userEntity'][_0x2ac200(0x18a)]({'where':_0x4a0b4c});if(!_0xb0f842)throw new common_1['HttpException'](_0x2ac200(0x10f),common_1[_0x2ac200(0x17f)]['BAD_REQUEST']);if(_0xb0f842[_0x2ac200(0xec)][_0x2ac200(0x151)](_0x2ac200(0x191))||_0xb0f842['password'][_0x2ac200(0x151)](_0x2ac200(0xe6))||_0xb0f842[_0x2ac200(0xec)]['startsWith']('$2y$')){if(!bcrypt[_0x2ac200(0x13a)](_0x5a9330,_0xb0f842[_0x2ac200(0xec)]))throw new common_1[(_0x2ac200(0x18e))](_0x2ac200(0x10a),common_1[_0x2ac200(0x17f)][_0x2ac200(0x118)]);}else{console['log']('----,');const _0x377a57=crypto[_0x2ac200(0x168)](_0x2ac200(0x16b))['update'](_0x5a9330)[_0x2ac200(0x114)](_0x2ac200(0x120));console['log'](_0x2ac200(0xf2),_0x377a57);if(_0x377a57!==_0xb0f842[_0x2ac200(0xec)])throw new common_1['HttpException'](_0x2ac200(0x10a),common_1['HttpStatus'][_0x2ac200(0x118)]);}}if(!_0xb0f842)throw new common_1[(_0x2ac200(0x18e))](_0x2ac200(0x10f),common_1[_0x2ac200(0x17f)]['BAD_REQUEST']);if(_0xb0f842[_0x2ac200(0x16d)]!==user_constant_1[_0x2ac200(0x188)][_0x2ac200(0x197)])throw new common_1['HttpException'](user_constant_1[_0x2ac200(0x132)][_0xb0f842[_0x2ac200(0x16d)]],common_1[_0x2ac200(0x17f)][_0x2ac200(0x118)]);return _0xb0f842;}async['verifyUserPassword'](_0x6b7695,_0x4692af){const _0x1decae=_0x1029fd,_0x2841e1=await this[_0x1decae(0x111)][_0x1decae(0x18a)]({'where':{'id':_0x6b7695}});if(_0x2841e1[_0x1decae(0xec)]['startsWith'](_0x1decae(0x191))||_0x2841e1[_0x1decae(0xec)]['startsWith'](_0x1decae(0xe6))||_0x2841e1['password'][_0x1decae(0x151)](_0x1decae(0xf5)))return bcrypt['compareSync'](_0x4692af,_0x2841e1[_0x1decae(0xec)]);else{const _0x19af40=crypto[_0x1decae(0x168)](_0x1decae(0x16b))[_0x1decae(0x177)](_0x4692af)[_0x1decae(0x114)](_0x1decae(0x120));return console[_0x1decae(0x158)](_0x1decae(0xf2),_0x19af40),_0x19af40===_0x2841e1[_0x1decae(0xec)];}}async[_0x1029fd(0x15a)](_0x42a328,_0xd0bca6){const _0x3af466=_0x1029fd,_0x1adfb8=await this[_0x3af466(0x111)][_0x3af466(0x177)]({'id':_0x42a328},{'status':_0xd0bca6});return _0x1adfb8[_0x3af466(0x164)]>0x0;}async[_0x1029fd(0x135)](_0x21321e){const _0x2661e0=_0x1029fd,_0x240b6a=await this['userEntity'][_0x2661e0(0x18a)]({'where':{'id':_0x21321e}});return _0x240b6a[_0x2661e0(0x16d)];}async[_0x1029fd(0x179)](_0x147f12){const _0x3e3095=_0x1029fd;return await this[_0x3e3095(0x111)][_0x3e3095(0x18a)]({'where':{'id':_0x147f12}});}async[_0x1029fd(0x18f)](_0x12711d){const _0x56c0d6=_0x1029fd;return await this[_0x56c0d6(0x111)]['findOne']({'where':{'id':_0x12711d}});}async['checkUserStatus'](_0x1e1b5c){const _0x519d7f=_0x1029fd,{id:_0x2f20a7,role:_0x3f609a}=_0x1e1b5c;if(_0x3f609a===_0x519d7f(0x170))return!![];const _0x4cf7cf=await this[_0x519d7f(0x111)][_0x519d7f(0x18a)]({'where':{'id':_0x2f20a7}});if(!_0x4cf7cf)throw new common_1[(_0x519d7f(0x18e))]('当前用户信息失效、请重新登录！',common_1[_0x519d7f(0x17f)][_0x519d7f(0x12b)]);if(_0x4cf7cf[_0x519d7f(0x16d)]===user_constant_1[_0x519d7f(0x188)][_0x519d7f(0x134)])throw new common_1[(_0x519d7f(0x18e))](_0x519d7f(0x184),common_1[_0x519d7f(0x17f)][_0x519d7f(0x118)]);if(_0x4cf7cf['status']===user_constant_1['UserStatusEnum'][_0x519d7f(0x17e)])throw new common_1[(_0x519d7f(0x18e))]('您的账户已被封禁、如有疑问、请联系管理员！',common_1['HttpStatus'][_0x519d7f(0x118)]);}async['getUserInfo'](_0x9e0983){const _0x493954=_0x1029fd,_0x38dc45=await this['userEntity'][_0x493954(0x18a)]({'where':{'id':_0x9e0983},'select':['username',_0x493954(0x109),_0x493954(0x10e),_0x493954(0x112),'sign',_0x493954(0x11a),_0x493954(0xed),_0x493954(0x18b)]});if(!_0x38dc45)throw new common_1[(_0x493954(0x18e))](_0x493954(0x174),common_1[_0x493954(0x17f)][_0x493954(0x12b)]);_0x38dc45['isBindWx']=!!(_0x38dc45===null||_0x38dc45===void 0x0?void 0x0:_0x38dc45[_0x493954(0xed)]),delete _0x38dc45[_0x493954(0xed)];const _0x385643=await this[_0x493954(0x13f)][_0x493954(0x102)](_0x9e0983);return{'userInfo':_0x38dc45,'userBalance':Object[_0x493954(0x15c)]({},_0x385643)};}async[_0x1029fd(0x16c)](_0x4db6da){const _0x2617e0=_0x1029fd;return await this[_0x2617e0(0x111)][_0x2617e0(0x18a)]({'where':{'id':_0x4db6da}});}async[_0x1029fd(0x10d)](_0x523d67){const _0x58cfe5=_0x1029fd;return await this[_0x58cfe5(0x111)][_0x58cfe5(0x18a)]({'where':{'openId':_0x523d67}});}async['updateInfo'](_0x26918d,_0x5ecb10){const _0x3b9a9c=_0x1029fd,{id:_0x13d204}=_0x5ecb10['user'],_0x462bd8=await this[_0x3b9a9c(0x111)][_0x3b9a9c(0x18a)]({'where':{'id':_0x13d204}});if(!_0x462bd8)throw new common_1['HttpException'](_0x3b9a9c(0x13c),common_1[_0x3b9a9c(0x17f)][_0x3b9a9c(0x118)]);if(_0x26918d[_0x3b9a9c(0xfc)]&&_0x462bd8[_0x3b9a9c(0xfc)]===_0x26918d[_0x3b9a9c(0xfc)])throw new common_1[(_0x3b9a9c(0x18e))](_0x3b9a9c(0xe8),common_1[_0x3b9a9c(0x17f)][_0x3b9a9c(0x118)]);if(_0x26918d[_0x3b9a9c(0xfc)]){const _0x26eaa7=await this['userEntity'][_0x3b9a9c(0x18a)]({'where':{'username':_0x26918d['username'],'id':(0x0,typeorm_2['Not'])(_0x13d204)}});if(_0x26eaa7)throw new common_1[(_0x3b9a9c(0x18e))]('用户名已存在！',common_1[_0x3b9a9c(0x17f)][_0x3b9a9c(0x118)]);}const _0x198d42=await this[_0x3b9a9c(0x111)][_0x3b9a9c(0x177)]({'id':_0x13d204},_0x26918d);if(_0x198d42[_0x3b9a9c(0x164)]<=0x0)throw new common_1['HttpException'](_0x3b9a9c(0x159),common_1[_0x3b9a9c(0x17f)][_0x3b9a9c(0x118)]);return'修改用户信息成功！';}async[_0x1029fd(0x162)](_0x90eb05,_0x49b262){const _0x11deff=_0x1029fd,_0x3bf4ea=bcrypt[_0x11deff(0xfb)](_0x49b262,0xa),_0x2bb5e6=await this[_0x11deff(0x111)]['update']({'id':_0x90eb05},{'password':_0x3bf4ea});if(_0x2bb5e6[_0x11deff(0x164)]<=0x0)throw new common_1[(_0x11deff(0x18e))](_0x11deff(0x126),common_1[_0x11deff(0x17f)][_0x11deff(0x118)]);}async[_0x1029fd(0xff)](_0x45a6bf){const _0x406ed5=_0x1029fd,{id:_0x2620ff}=_0x45a6bf[_0x406ed5(0x124)],_0xbd2d4c=await this[_0x406ed5(0x111)][_0x406ed5(0x18a)]({'where':{'id':_0x2620ff}});if(!_0xbd2d4c||_0xbd2d4c[_0x406ed5(0x11a)])throw new common_1[(_0x406ed5(0x18e))](_0x406ed5(0x123),common_1[_0x406ed5(0x17f)]['BAD_REQUEST']);const _0x4f5917=(0x0,utils_1[_0x406ed5(0x18c)])(),_0x2c81eb=await this[_0x406ed5(0x111)][_0x406ed5(0x18a)]({'where':{'inviteCode':_0x4f5917}});if(_0x2c81eb)throw new common_1['HttpException'](_0x406ed5(0x136),common_1['HttpStatus']['BAD_REQUEST']);const _0x35daa6=await this[_0x406ed5(0x111)][_0x406ed5(0x177)]({'id':_0x2620ff},{'inviteCode':_0x4f5917});if(_0x35daa6[_0x406ed5(0x164)]<=0x0)throw new common_1[(_0x406ed5(0x18e))]('生成邀请码失败，请重新试一次吧！',common_1[_0x406ed5(0x17f)]['BAD_REQUEST']);return _0x4f5917;}async[_0x1029fd(0x103)](_0x5e1e4b,_0x2cdc8f){const _0x2b29c1=_0x1029fd;try{const {id:_0x5d3c7b}=_0x5e1e4b[_0x2b29c1(0x124)],{page:page=0x1,size:size=0xa}=_0x2cdc8f,_0x5b76f4=await this['userEntity'][_0x2b29c1(0x18a)]({'where':{'id':_0x5d3c7b}}),{inviteCode:_0x1d754e}=_0x5b76f4;if(!_0x1d754e)return[];const [_0x3c0627,_0x5b7169]=await this[_0x2b29c1(0x111)]['findAndCount']({'where':{'inviteCode':_0x1d754e},'order':{'id':'DESC'},'select':['username',_0x2b29c1(0x112),_0x2b29c1(0x13d),_0x2b29c1(0x16d),_0x2b29c1(0x109)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x2b29c1(0x156)])(_0x3c0627)['map'](_0x4609cd=>{const _0x404554=_0x2b29c1;return _0x4609cd[_0x404554(0x112)]=(0x0,utils_1[_0x404554(0xf7)])(_0x4609cd[_0x404554(0x112)]),_0x4609cd;}),{'rows':_0x3c0627,'count':_0x5b7169};}catch(_0x596453){console[_0x2b29c1(0x158)](_0x2b29c1(0x173),_0x596453);throw new common_1[(_0x2b29c1(0x18e))](_0x2b29c1(0x193),common_1['HttpStatus'][_0x2b29c1(0x118)]);}}async[_0x1029fd(0x12d)](_0x55b41a){const _0x45ff2d=_0x1029fd,_0x246288=await this[_0x45ff2d(0x111)]['findOne']({'where':{'inviteCode':_0x55b41a}});if(!_0x246288)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x246288,_0x329da8=await this[_0x45ff2d(0x111)][_0x45ff2d(0x177)]({'inviteCode':_0x55b41a},{'inviteLinkCount':inviteLinkCount+0x1});return _0x329da8[_0x45ff2d(0x164)]?0x1:0x0;}async['qureyUserInfoByInviteCode'](_0x2a4fff){const _0xfe8ae3=_0x1029fd;return await this[_0xfe8ae3(0x111)][_0xfe8ae3(0x18a)]({'where':{'inviteCode':_0x2a4fff}});}async[_0x1029fd(0x137)](_0x11da2f){const _0x44de4b=_0x1029fd,{userId:_0x193218,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x11da2f;await this[_0x44de4b(0x13f)]['addBalanceToUser'](_0x193218,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x454295=await this['userBalanceService']['saveRecordRechargeLog']({'userId':_0x193218,'rechargeType':balance_constant_1['RechargeType']['ADMIN_GIFT'],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x454295;}async[_0x1029fd(0x12e)](_0x131cde,_0x56d398){const _0x26b7a4=_0x1029fd,{page:page=0x1,size:size=0xa,username:_0x4f0271,email:_0x426afe,status:_0x40168a,keyword:_0x408a5d,phone:_0x2d15c3}=_0x131cde;let _0x51b2be={};_0x4f0271&&Object[_0x26b7a4(0x15c)](_0x51b2be,{'username':(0x0,typeorm_2[_0x26b7a4(0xee)])('%'+_0x4f0271+'%')}),_0x426afe&&Object['assign'](_0x51b2be,{'email':(0x0,typeorm_2[_0x26b7a4(0xee)])('%'+_0x426afe+'%')}),_0x2d15c3&&Object[_0x26b7a4(0x15c)](_0x51b2be,{'phone':(0x0,typeorm_2[_0x26b7a4(0xee)])('%'+_0x2d15c3+'%')}),_0x40168a&&Object[_0x26b7a4(0x15c)](_0x51b2be,{'status':_0x40168a});_0x408a5d&&(_0x51b2be=[{'username':(0x0,typeorm_2[_0x26b7a4(0xee)])('%'+_0x408a5d+'%')},{'email':(0x0,typeorm_2[_0x26b7a4(0xee)])('%'+_0x408a5d+'%')},{'phone':(0x0,typeorm_2['Like'])('%'+_0x408a5d+'%')}]);const [_0x330acf,_0xf6b2b]=await this[_0x26b7a4(0x111)]['findAndCount']({'skip':(page-0x1)*size,'where':_0x51b2be,'take':size,'order':{'createdAt':_0x26b7a4(0x15b)},'cache':!![],'select':['username','avatar',_0x26b7a4(0x11a),_0x26b7a4(0x10e),_0x26b7a4(0x163),_0x26b7a4(0x16d),'id',_0x26b7a4(0x112),_0x26b7a4(0x13d),'lastLoginIp','phone']}),_0x591c57=_0x330acf[_0x26b7a4(0x17a)](_0x671f10=>_0x671f10['id']),_0x2ed0ba=await this['userBalanceService'][_0x26b7a4(0x14f)](_0x591c57);return _0x330acf[_0x26b7a4(0x138)](_0x15ad64=>_0x15ad64[_0x26b7a4(0x14d)]=_0x2ed0ba[_0x26b7a4(0x115)](_0xa0ff55=>_0xa0ff55[_0x26b7a4(0x127)]===_0x15ad64['id'])),_0x56d398['user']['role']!==_0x26b7a4(0x199)&&_0x330acf[_0x26b7a4(0x138)](_0x1153db=>_0x1153db['email']=(0x0,utils_1['maskEmail'])(_0x1153db[_0x26b7a4(0x112)])),_0x56d398[_0x26b7a4(0x124)]['role']!==_0x26b7a4(0x199)&&_0x330acf['forEach'](_0x596c01=>_0x596c01[_0x26b7a4(0xf0)]=(0x0,utils_1[_0x26b7a4(0x11d)])(_0x596c01[_0x26b7a4(0xf0)])),_0x56d398[_0x26b7a4(0x124)]['role']!==_0x26b7a4(0x199)&&_0x330acf[_0x26b7a4(0x138)](_0x354dfb=>_0x354dfb[_0x26b7a4(0x178)]=(0x0,utils_1['maskIpAddress'])(_0x354dfb[_0x26b7a4(0x178)])),{'rows':_0x330acf,'count':_0xf6b2b};}async['queryOne']({id:_0x3a6755}){const _0x47a3b5=_0x1029fd;return await this[_0x47a3b5(0x111)][_0x47a3b5(0x18a)]({'where':{'id':_0x3a6755},'select':[_0x47a3b5(0xfc),_0x47a3b5(0x109),'inviteCode',_0x47a3b5(0x10e),'sign',_0x47a3b5(0x16d)]});}async[_0x1029fd(0x166)](_0x1e4183){const _0x314d08=_0x1029fd,{id:_0x1ea490,status:_0xf0a74e}=_0x1e4183,_0x4d572d=await this['userEntity'][_0x314d08(0x18a)]({'where':{'id':_0x1ea490}});if(!_0x4d572d)throw new common_1[(_0x314d08(0x18e))](_0x314d08(0x13b),common_1['HttpStatus'][_0x314d08(0x118)]);if(_0x4d572d[_0x314d08(0x10e)]===_0x314d08(0x199))throw new common_1[(_0x314d08(0x18e))](_0x314d08(0x16f),common_1['HttpStatus'][_0x314d08(0x118)]);if(_0x4d572d[_0x314d08(0x16d)]===user_constant_1[_0x314d08(0x188)]['PENDING'])throw new common_1[(_0x314d08(0x18e))](_0x314d08(0x18d),common_1['HttpStatus']['BAD_REQUEST']);if(_0x4d572d[_0x314d08(0x10e)]==='super')throw new common_1[(_0x314d08(0x18e))]('超级管理员不可被操作！',common_1[_0x314d08(0x17f)][_0x314d08(0x118)]);if(_0xf0a74e===user_constant_1[_0x314d08(0x188)][_0x314d08(0xf8)])throw new common_1[(_0x314d08(0x18e))](_0x314d08(0x13e),common_1[_0x314d08(0x17f)]['BAD_REQUEST']);const _0x1e268b=await this[_0x314d08(0x111)][_0x314d08(0x177)]({'id':_0x1ea490},{'status':_0xf0a74e});if(_0x1e268b[_0x314d08(0x164)]<=0x0)throw new common_1['HttpException'](_0x314d08(0x10b),common_1['HttpStatus'][_0x314d08(0x118)]);return _0x314d08(0x176);}async[_0x1029fd(0x17b)](_0x3c8020){const _0x3612f4=_0x1029fd,{id:_0x256e00}=_0x3c8020,_0x1a4c7f=await this[_0x3612f4(0x111)][_0x3612f4(0x18a)]({'where':{'id':_0x256e00}});if(!_0x1a4c7f)throw new common_1['HttpException'](_0x3612f4(0x13b),common_1[_0x3612f4(0x17f)]['BAD_REQUEST']);const _0x4d5130=_0x3612f4(0xe7),_0x2e5130=bcrypt['hashSync'](_0x4d5130,0xa),_0x7dafa7=await this[_0x3612f4(0x111)][_0x3612f4(0x177)]({'id':_0x256e00},{'password':_0x2e5130});if(_0x7dafa7[_0x3612f4(0x164)]<=0x0)throw new common_1['HttpException']('重置密码失败！',common_1[_0x3612f4(0x17f)][_0x3612f4(0x118)]);return _0x3612f4(0xeb)+_0x4d5130+_0x3612f4(0xfd);}async[_0x1029fd(0x113)](_0x31ce5c,_0x375f29){const _0x5876e5=_0x1029fd;return await this[_0x5876e5(0x111)][_0x5876e5(0x177)]({'id':_0x31ce5c},{'lastLoginIp':_0x375f29});}async[_0x1029fd(0x145)](_0x897feb,_0x2a578e){const _0x4370ff=_0x1029fd,_0x428393=await this[_0x4370ff(0x111)][_0x4370ff(0x18a)]({'where':{'openId':_0x897feb}});if(!_0x428393){const _0x5621a2=_0x2a578e?_0x2a578e[_0x4370ff(0xf4)](':')[0x1]:'',_0x66742b=await this[_0x4370ff(0x116)](_0x5621a2),_0x429cde=await this[_0x4370ff(0x155)](_0x897feb,_0x5621a2);return await this['userBalanceService'][_0x4370ff(0x161)](_0x429cde['id'],_0x5621a2?_0x66742b===null||_0x66742b===void 0x0?void 0x0:_0x66742b['id']:null),_0x429cde;}return _0x428393;}async[_0x1029fd(0x155)](_0x1bf54e,_0x4f3ece){const _0x45f517=_0x1029fd,_0x3bd6a1=await this[_0x45f517(0x152)][_0x45f517(0x11b)]([_0x45f517(0x189)]),_0x142517={'avatar':_0x3bd6a1,'username':'用户'+(0x0,utils_1['createRandomUid'])(),'status':user_constant_1[_0x45f517(0x188)][_0x45f517(0x197)],'sex':0x0,'email':(0x0,utils_1['createRandomUid'])()+'@default.com','invitedBy':_0x4f3ece,'openId':_0x1bf54e},_0x139e3a=await this[_0x45f517(0x111)][_0x45f517(0x140)](_0x142517);return _0x139e3a;}async[_0x1029fd(0x146)](_0x3577dc,_0x347975){const _0x2308a1=_0x1029fd;try{const _0x4b0e77=await this[_0x2308a1(0x111)]['findOne']({'where':{'id':_0x347975}});if(!_0x4b0e77)return{'status':![],'msg':_0x2308a1(0x14a)};const _0x508682=await this[_0x2308a1(0x111)]['findOne']({'where':{'openId':_0x3577dc}});if(_0x508682)return{'status':![],'msg':'该微信已绑定其他账号！'};const _0x5dc14c=await this[_0x2308a1(0x111)][_0x2308a1(0x177)]({'id':_0x347975},{'openId':_0x3577dc});if(_0x5dc14c[_0x2308a1(0x164)]<=0x0)return{'status':![],'msg':_0x2308a1(0x165)};return{'status':!![],'msg':_0x2308a1(0x175)};}catch(_0xf28fc0){return{'status':![],'msg':'绑定微信失败、请联系管理员！'};}}async['getOpenIdByUserId'](_0x137498){const _0x4618ab=_0x1029fd,_0x226cbc=await this[_0x4618ab(0x111)][_0x4618ab(0x18a)]({'where':{'id':_0x137498}});return _0x226cbc===null||_0x226cbc===void 0x0?void 0x0:_0x226cbc['openId'];}async[_0x1029fd(0x154)](_0x1ab6c5){const _0x36a778=_0x1029fd,{username:_0x115273,password:_0x44b22f,phone:_0x1ef30a,phoneCode:_0x47f836}=_0x1ab6c5,_0x5cec15=await this['userEntity'][_0x36a778(0x18a)]({'where':[{'username':_0x115273},{'phone':_0x1ef30a}]});if(_0x5cec15&&_0x5cec15[_0x36a778(0xfc)]===_0x115273)throw new common_1[(_0x36a778(0x18e))]('用户名已存在、请更换用户名！',common_1[_0x36a778(0x17f)]['BAD_REQUEST']);if(_0x5cec15&&_0x5cec15[_0x36a778(0x178)]===_0x1ef30a)throw new common_1['HttpException'](_0x36a778(0x12f),common_1['HttpStatus'][_0x36a778(0x118)]);}async[_0x1029fd(0x139)](_0xb9ee0d){const _0x3a3390=_0x1029fd;return await this[_0x3a3390(0x111)]['save'](_0xb9ee0d);}};UserService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x1029fd(0x107)])(user_entity_1[_0x1029fd(0x181)])),__param(0x1,(0x0,typeorm_1[_0x1029fd(0x107)])(whiteList_entity_1['WhiteListEntity'])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x1029fd(0x180)])),__metadata(_0x1029fd(0x185),[typeorm_2[_0x1029fd(0x148)],typeorm_2[_0x1029fd(0x148)],typeorm_2[_0x1029fd(0x194)],verification_service_1[_0x1029fd(0x15f)],mailer_1[_0x1029fd(0x131)],userBalance_service_1[_0x1029fd(0x160)],globalConfig_service_1[_0x1029fd(0x187)],typeorm_2[_0x1029fd(0x148)]])],UserService),exports[_0x1029fd(0x183)]=UserService;