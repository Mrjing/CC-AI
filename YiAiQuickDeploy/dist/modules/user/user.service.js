'use strict';const _0x20df8c=_0x1b2b;(function(_0x55f1bc,_0x3e55be){const _0x5693e4=_0x1b2b,_0x1a09d3=_0x55f1bc();while(!![]){try{const _0x3b0fc9=parseInt(_0x5693e4(0x1c4))/0x1+parseInt(_0x5693e4(0x187))/0x2+-parseInt(_0x5693e4(0x1a6))/0x3*(-parseInt(_0x5693e4(0x16c))/0x4)+-parseInt(_0x5693e4(0x1a0))/0x5+parseInt(_0x5693e4(0x145))/0x6*(parseInt(_0x5693e4(0x1b0))/0x7)+parseInt(_0x5693e4(0x1c3))/0x8+-parseInt(_0x5693e4(0x1cf))/0x9;if(_0x3b0fc9===_0x3e55be)break;else _0x1a09d3['push'](_0x1a09d3['shift']());}catch(_0x2e4fac){_0x1a09d3['push'](_0x1a09d3['shift']());}}}(_0x17d5,0x56935));function _0x1b2b(_0x43046a,_0x4f1eb0){const _0x17d527=_0x17d5();return _0x1b2b=function(_0x1b2ba2,_0x214e6e){_0x1b2ba2=_0x1b2ba2-0x133;let _0x2db989=_0x17d527[_0x1b2ba2];return _0x2db989;},_0x1b2b(_0x43046a,_0x4f1eb0);}var __decorate=this&&this[_0x20df8c(0x1bd)]||function(_0x445134,_0x38165e,_0x4be94f,_0x28a017){const _0x5a367f=_0x20df8c;var _0x5d186f=arguments[_0x5a367f(0x17d)],_0x2d739f=_0x5d186f<0x3?_0x38165e:_0x28a017===null?_0x28a017=Object[_0x5a367f(0x18a)](_0x38165e,_0x4be94f):_0x28a017,_0x211015;if(typeof Reflect==='object'&&typeof Reflect[_0x5a367f(0x183)]===_0x5a367f(0x1d5))_0x2d739f=Reflect[_0x5a367f(0x183)](_0x445134,_0x38165e,_0x4be94f,_0x28a017);else{for(var _0x2b5666=_0x445134['length']-0x1;_0x2b5666>=0x0;_0x2b5666--)if(_0x211015=_0x445134[_0x2b5666])_0x2d739f=(_0x5d186f<0x3?_0x211015(_0x2d739f):_0x5d186f>0x3?_0x211015(_0x38165e,_0x4be94f,_0x2d739f):_0x211015(_0x38165e,_0x4be94f))||_0x2d739f;}return _0x5d186f>0x3&&_0x2d739f&&Object[_0x5a367f(0x1b9)](_0x38165e,_0x4be94f,_0x2d739f),_0x2d739f;},__metadata=this&&this[_0x20df8c(0x155)]||function(_0x5b1128,_0x393b2f){const _0x37a968=_0x20df8c;if(typeof Reflect===_0x37a968(0x1d7)&&typeof Reflect['metadata']===_0x37a968(0x1d5))return Reflect[_0x37a968(0x1cc)](_0x5b1128,_0x393b2f);},__param=this&&this['__param']||function(_0x24fed6,_0x41508a){return function(_0x552d74,_0x4daf57){_0x41508a(_0x552d74,_0x4daf57,_0x24fed6);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x20df8c(0x1b1)]=void 0x0;const globalConfig_service_1=require(_0x20df8c(0x1a8)),user_constant_1=require(_0x20df8c(0x1b4)),mailer_1=require(_0x20df8c(0x158)),verification_service_1=require(_0x20df8c(0x1cd)),common_1=require(_0x20df8c(0x1df)),typeorm_1=require(_0x20df8c(0x193)),typeorm_2=require(_0x20df8c(0x18b)),user_entity_1=require(_0x20df8c(0x182)),bcrypt=require('bcryptjs'),crypto=require(_0x20df8c(0x1a2)),_=require(_0x20df8c(0x147)),verification_constant_1=require(_0x20df8c(0x180)),userBalance_service_1=require(_0x20df8c(0x1d1)),utils_1=require(_0x20df8c(0x1d4)),balance_constant_1=require('../../common/constants/balance.constant'),config_entity_1=require(_0x20df8c(0x1ce)),whiteList_entity_1=require(_0x20df8c(0x18d));function _0x17d5(){const _0x5cca9f=['mailerService','ACTIVE','globalConfigService','userEntity','metadata','../verification/verification.service','../globalConfig/config.entity','8444115haqHra','WhiteListEntity','../userBalance/userBalance.service','Injectable','getSuper','../../common/utils','function','Repository','object','未激活用户不可手动变更状态！','configEntity','openId','avatar','该微信已绑定其他账号！','HttpException','VerificationService','@nestjs/common','whiteListEntity','userDefautlAvatar','visitor','maskIpAddress','用户名已存在！','email','queryOne','registerVerifyExpir','createUserFromOpenId','super','consecutiveDays','修改用户信息失败！','registerBaseUrl','compareSync','getUserFromOpenId','balanceInfo','startsWith','$2y$','ADMIN_GIFT','verifyUserRegisterByPhone','6AFmRfC','createdAt','lodash','用户名或者邮箱已被注册！','密码重置为[','您的账户已被封禁、如有疑问、请联系管理员！','verificationService','design:paramtypes','UserStatusErrMsg','role','isVerifyEmail','queryUserBalance','updateUserStatus','getConfigs','DESC','获取邀请记录失败！','__metadata','registerVerifyEmailDesc','log','@nestjs-modules/mailer','绑定微信失败、请联系管理员！','verifyUserCredentials','没有变更，无需更改！','forEach','HttpStatus','超级管理员不可被操作！','checkUserStatus','hex','修改密码失败、请重新试试吧。','Like','生成邀请码失败，请重新试一次吧！','sign','修改用户状态成功！','formatCreateOrUpdateDate','isBindWx','user','不可将用户置为未激活状态！','addBalanceToUser','sendMail','114312VAOlfa','MailerService','password','已生成过邀请码、请勿重复生成','重置密码失败！','status','username','createUser','lastLoginIp','error:\x20','$2b$','registerVerifyEmailFrom','cloneDeep','verifyUserPassword','Connection','GlobalConfigService','affected','length','inviteCode','当前密码错误！','../../common/constants/verification.constant','qureyUserInfoByInviteCode','./user.entity','decorate','BAD_REQUEST','digest','saveRecordRechargeLog','1163400XRXcsh','userRecharge','PENDING','getOwnPropertyDescriptor','typeorm','configVal','../chatgpt/whiteList.entity','md5','createRandomUid','当前手机号已注册、请勿重复注册！','恭喜您绑定成功、后续可直接扫码登录了！','无效的邀请码！','@nestjs/typeorm','BLACKLISTED','用户不存在！','userBalanceService','userId','getUserById','inviteLink','resetUserPass','email\x20response\x20\x20->\x20:\x20','findOne','修改用户状态失败！','InjectRepository','UserStatusEnum','3525840HIYsbm','UNAUTHORIZED','crypto','getInviteRecord','find','createHash','30maMwHG','UserEntity','../globalConfig/globalConfig.service','map','update','registerIp','createVerification','hashSync','phone','当前绑定用户不存在！','275961oXoMIa','UserService','$2a$','maskEmail','../../common/constants/user.constant','generateRandomString','genInviteCode','addBalanceToNewUser','split','defineProperty','updateInfo','updateStatus','----,','__decorate','queryUserInfoById','Not','当前用户信息失效、请重新登录！','connection','assign','4878136NkenRb','481346uxXBJK','ConfigEntity','updateUserPassword','当前账户不存在！'];_0x17d5=function(){return _0x5cca9f;};return _0x17d5();}let UserService=class UserService{constructor(_0xe18505,_0x5b15d0,_0x5491b2,_0x5db3df,_0x59df7d,_0x289d4c,_0x59473a,_0x423f71){const _0x36d82f=_0x20df8c;this[_0x36d82f(0x1cb)]=_0xe18505,this[_0x36d82f(0x1e0)]=_0x5b15d0,this[_0x36d82f(0x1c1)]=_0x5491b2,this[_0x36d82f(0x14b)]=_0x5db3df,this[_0x36d82f(0x1c8)]=_0x59df7d,this['userBalanceService']=_0x289d4c,this['globalConfigService']=_0x59473a,this[_0x36d82f(0x1d9)]=_0x423f71;}async['createUserAndVerifycation'](_0x4ac2a0,_0x3a707f){const _0x1ef9a8=_0x20df8c,{username:_0x8adea9,email:_0x13ea9e,password:_0x4c6267,invitedBy:_0x41663d,client:client=0x0}=_0x4ac2a0;if(_0x41663d){const _0x214fd5=await this[_0x1ef9a8(0x1cb)]['findOne']({'where':{'inviteCode':_0x41663d}});if(!_0x214fd5)throw new common_1[(_0x1ef9a8(0x1dd))](_0x1ef9a8(0x192),common_1[_0x1ef9a8(0x15d)][_0x1ef9a8(0x184)]);}const _0x545c83=[{'username':_0x8adea9},{'email':_0x13ea9e}],_0x391056=await this['userEntity']['findOne']({'where':_0x545c83});if(_0x391056&&_0x391056['status']!==user_constant_1[_0x1ef9a8(0x19f)][_0x1ef9a8(0x189)])throw new common_1[(_0x1ef9a8(0x1dd))](_0x1ef9a8(0x148),common_1[_0x1ef9a8(0x15d)][_0x1ef9a8(0x184)]);try{const _0x4dd78c=_[_0x1ef9a8(0x178)](_0x4ac2a0),_0x1e9ff6=bcrypt[_0x1ef9a8(0x1ad)](_0x4c6267,0xa),_0xd86c34=(0x0,utils_1['getClientIp'])(_0x3a707f);_0x4dd78c[_0x1ef9a8(0x16e)]=_0x1e9ff6,_0x4dd78c[_0x1ef9a8(0x1ab)]=_0xd86c34,_0x4dd78c['client']=client;let _0xdaaff6;if(!_0x391056){const _0x1fb42e=await this[_0x1ef9a8(0x1ca)][_0x1ef9a8(0x152)]([_0x1ef9a8(0x1e1)]);_0x4dd78c[_0x1ef9a8(0x1db)]=_0x1fb42e,_0xdaaff6=await this[_0x1ef9a8(0x1cb)]['save'](_0x4dd78c);}else _0xdaaff6=_0x391056;const _0x16a225=await this[_0x1ef9a8(0x1d9)][_0x1ef9a8(0x1a4)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x1ef9a8(0x14f),_0x1ef9a8(0x13d),'registerVerifyEmailTitle',_0x1ef9a8(0x156),_0x1ef9a8(0x177),_0x1ef9a8(0x138)])}}),_0x36c04e=_0x16a225['reduce']((_0x4725b8,_0x4baa3b)=>{const _0x42b963=_0x1ef9a8;return _0x4725b8[_0x4baa3b['configKey']]=_0x4baa3b[_0x42b963(0x18c)],_0x4725b8;},{}),_0x57dd55=_0x36c04e[_0x1ef9a8(0x14f)]?Number(_0x36c04e['isVerifyEmail']):0x1;if(_0x57dd55){const _0x2f48fe=_0x36c04e[_0x1ef9a8(0x138)]?Number(_0x36c04e['registerVerifyExpir']):0x1e*0x3c,_0x53976d=await this['verificationService'][_0x1ef9a8(0x1ac)](_0xdaaff6,verification_constant_1['VerificationEnum']['Registration'],_0x2f48fe),{code:_0x44a769,email:_0x4ab9fe,id:_0x38ec8a}=_0x53976d,{registerVerifyEmailFrom:_0x544ad9}=_0x36c04e;console['log']('configMap:\x20',_0x36c04e);const _0x3654ad=await this[_0x1ef9a8(0x1c8)][_0x1ef9a8(0x16b)]({'to':_0x4ab9fe,'subject':'来自'+_0x544ad9+'的账号激活','template':'register','context':Object[_0x1ef9a8(0x1c2)]({'baseUrl':_0x36c04e[_0x1ef9a8(0x13d)],'code':_0x44a769,'id':_0x38ec8a},_0x36c04e)});console[_0x1ef9a8(0x157)](_0x1ef9a8(0x19b),_0x3654ad);}else{const {username:_0x1b2e21,email:_0x5520d0,id:_0x32c55e,invitedBy:_0x2c373e}=_0xdaaff6;await this[_0x1ef9a8(0x151)](_0x32c55e,user_constant_1['UserStatusEnum'][_0x1ef9a8(0x1c9)]);let _0x124092;_0x2c373e&&(_0x124092=await this['qureyUserInfoByInviteCode'](_0x2c373e)),await this[_0x1ef9a8(0x196)]['addBalanceToNewUser'](_0x32c55e,_0x124092===null||_0x124092===void 0x0?void 0x0:_0x124092['id']);}return _0xdaaff6;}catch(_0x51cc28){console[_0x1ef9a8(0x157)](_0x1ef9a8(0x175),_0x51cc28);throw _0x51cc28;}}async[_0x20df8c(0x1d3)](){const _0x282f52=_0x20df8c,_0x462ed3=await this[_0x282f52(0x1cb)][_0x282f52(0x19c)]({'where':{'role':_0x282f52(0x13a)}});return _0x462ed3;}async[_0x20df8c(0x15a)](_0x16474e){const _0x15c326=_0x20df8c,{username:_0x2217cb,password:_0x3c1a1a,uid:uid=0x0,phone:_0x306d1e}=_0x16474e;let _0x5c6e54=null;if(uid>0x0){_0x5c6e54=await this[_0x15c326(0x1cb)]['findOne']({'where':{'id':uid}});if(!_0x5c6e54)throw new common_1[(_0x15c326(0x1dd))](_0x15c326(0x1c7),common_1[_0x15c326(0x15d)][_0x15c326(0x184)]);if(_0x5c6e54['password']['startsWith'](_0x15c326(0x1b2))||_0x5c6e54[_0x15c326(0x16e)][_0x15c326(0x141)]('$2b$')||_0x5c6e54[_0x15c326(0x16e)][_0x15c326(0x141)](_0x15c326(0x142))){if(!bcrypt['compareSync'](_0x3c1a1a,_0x5c6e54[_0x15c326(0x16e)]))throw new common_1['HttpException'](_0x15c326(0x17f),common_1[_0x15c326(0x15d)]['BAD_REQUEST']);}else{console[_0x15c326(0x157)](_0x15c326(0x1bc));const _0x34d99e=crypto['createHash']('md5')['update'](_0x3c1a1a)[_0x15c326(0x185)](_0x15c326(0x160));console[_0x15c326(0x157)](_0x15c326(0x1bc),_0x34d99e);if(_0x34d99e!==_0x5c6e54[_0x15c326(0x16e)])throw new common_1['HttpException'](_0x15c326(0x17f),common_1[_0x15c326(0x15d)][_0x15c326(0x184)]);}}if(_0x2217cb&&_0x3c1a1a){const _0x3c3a13=[{'username':_0x2217cb},{'email':_0x2217cb}];_0x5c6e54=await this[_0x15c326(0x1cb)][_0x15c326(0x19c)]({'where':_0x3c3a13});if(!_0x5c6e54)throw new common_1[(_0x15c326(0x1dd))](_0x15c326(0x1c7),common_1[_0x15c326(0x15d)][_0x15c326(0x184)]);if(_0x5c6e54['password'][_0x15c326(0x141)]('$2a$')||_0x5c6e54['password']['startsWith'](_0x15c326(0x176))||_0x5c6e54[_0x15c326(0x16e)]['startsWith'](_0x15c326(0x142))){if(!bcrypt['compareSync'](_0x3c1a1a,_0x5c6e54['password']))throw new common_1[(_0x15c326(0x1dd))](_0x15c326(0x17f),common_1[_0x15c326(0x15d)]['BAD_REQUEST']);}else{console['log'](_0x15c326(0x1bc));const _0x521e0f=crypto['createHash']('md5')[_0x15c326(0x1aa)](_0x3c1a1a)[_0x15c326(0x185)](_0x15c326(0x160));console['log'](_0x15c326(0x1bc),_0x521e0f);if(_0x521e0f!==_0x5c6e54[_0x15c326(0x16e)])throw new common_1[(_0x15c326(0x1dd))]('当前密码错误！',common_1[_0x15c326(0x15d)][_0x15c326(0x184)]);}}if(_0x306d1e&&_0x3c1a1a){const _0x4df2ae=[{'phone':_0x306d1e}];_0x5c6e54=await this[_0x15c326(0x1cb)][_0x15c326(0x19c)]({'where':_0x4df2ae});if(!_0x5c6e54)throw new common_1[(_0x15c326(0x1dd))](_0x15c326(0x1c7),common_1[_0x15c326(0x15d)][_0x15c326(0x184)]);if(_0x5c6e54[_0x15c326(0x16e)][_0x15c326(0x141)](_0x15c326(0x1b2))||_0x5c6e54[_0x15c326(0x16e)][_0x15c326(0x141)](_0x15c326(0x176))||_0x5c6e54['password'][_0x15c326(0x141)](_0x15c326(0x142))){if(!bcrypt[_0x15c326(0x13e)](_0x3c1a1a,_0x5c6e54[_0x15c326(0x16e)]))throw new common_1[(_0x15c326(0x1dd))](_0x15c326(0x17f),common_1['HttpStatus']['BAD_REQUEST']);}else{console[_0x15c326(0x157)](_0x15c326(0x1bc));const _0x203d11=crypto[_0x15c326(0x1a5)](_0x15c326(0x18e))[_0x15c326(0x1aa)](_0x3c1a1a)[_0x15c326(0x185)](_0x15c326(0x160));console[_0x15c326(0x157)](_0x15c326(0x1bc),_0x203d11);if(_0x203d11!==_0x5c6e54[_0x15c326(0x16e)])throw new common_1[(_0x15c326(0x1dd))]('当前密码错误！',common_1['HttpStatus'][_0x15c326(0x184)]);}}if(!_0x5c6e54)throw new common_1[(_0x15c326(0x1dd))]('当前账户不存在！',common_1[_0x15c326(0x15d)][_0x15c326(0x184)]);if(_0x5c6e54[_0x15c326(0x171)]!==user_constant_1['UserStatusEnum']['ACTIVE'])throw new common_1['HttpException'](user_constant_1[_0x15c326(0x14d)][_0x5c6e54[_0x15c326(0x171)]],common_1[_0x15c326(0x15d)][_0x15c326(0x184)]);return _0x5c6e54;}async[_0x20df8c(0x179)](_0x3b0b27,_0x34894f){const _0x1c5753=_0x20df8c,_0x1fb55a=await this[_0x1c5753(0x1cb)]['findOne']({'where':{'id':_0x3b0b27}});if(_0x1fb55a[_0x1c5753(0x16e)]['startsWith'](_0x1c5753(0x1b2))||_0x1fb55a[_0x1c5753(0x16e)][_0x1c5753(0x141)](_0x1c5753(0x176))||_0x1fb55a[_0x1c5753(0x16e)]['startsWith'](_0x1c5753(0x142)))return bcrypt[_0x1c5753(0x13e)](_0x34894f,_0x1fb55a[_0x1c5753(0x16e)]);else{const _0x3964f8=crypto[_0x1c5753(0x1a5)](_0x1c5753(0x18e))[_0x1c5753(0x1aa)](_0x34894f)[_0x1c5753(0x185)]('hex');return console[_0x1c5753(0x157)]('----,',_0x3964f8),_0x3964f8===_0x1fb55a[_0x1c5753(0x16e)];}}async[_0x20df8c(0x151)](_0x10aaa9,_0x462084){const _0x3f55f9=_0x20df8c,_0x4f49ae=await this[_0x3f55f9(0x1cb)][_0x3f55f9(0x1aa)]({'id':_0x10aaa9},{'status':_0x462084});return _0x4f49ae['affected']>0x0;}async['getUserStatus'](_0xfe485a){const _0x3a8a51=_0x20df8c,_0x1ea5e6=await this[_0x3a8a51(0x1cb)][_0x3a8a51(0x19c)]({'where':{'id':_0xfe485a}});return _0x1ea5e6[_0x3a8a51(0x171)];}async[_0x20df8c(0x1be)](_0x7db3e){const _0x1cb7e3=_0x20df8c;return await this[_0x1cb7e3(0x1cb)][_0x1cb7e3(0x19c)]({'where':{'id':_0x7db3e}});}async['queryOneUserInfo'](_0x1abbf5){const _0x2326d1=_0x20df8c;return await this[_0x2326d1(0x1cb)][_0x2326d1(0x19c)]({'where':{'id':_0x1abbf5}});}async[_0x20df8c(0x15f)](_0x37da02){const _0x1b956a=_0x20df8c,{id:_0x51cea8,role:_0xde7d92}=_0x37da02;if(_0xde7d92===_0x1b956a(0x133))return!![];const _0x3be9cc=await this['userEntity'][_0x1b956a(0x19c)]({'where':{'id':_0x51cea8}});if(!_0x3be9cc)throw new common_1[(_0x1b956a(0x1dd))]('当前用户信息失效、请重新登录！',common_1[_0x1b956a(0x15d)][_0x1b956a(0x1a1)]);if(_0x3be9cc[_0x1b956a(0x171)]===user_constant_1[_0x1b956a(0x19f)][_0x1b956a(0x194)])throw new common_1[(_0x1b956a(0x1dd))]('您的账户已被永久加入黑名单、如有疑问、请联系管理员！',common_1[_0x1b956a(0x15d)][_0x1b956a(0x184)]);if(_0x3be9cc['status']===user_constant_1[_0x1b956a(0x19f)]['LOCKED'])throw new common_1[(_0x1b956a(0x1dd))](_0x1b956a(0x14a),common_1['HttpStatus'][_0x1b956a(0x184)]);}async['getUserInfo'](_0x85c2f0){const _0x1637ae=_0x20df8c,_0x210e79=await this[_0x1637ae(0x1cb)][_0x1637ae(0x19c)]({'where':{'id':_0x85c2f0},'select':[_0x1637ae(0x172),_0x1637ae(0x1db),'role',_0x1637ae(0x136),'sign',_0x1637ae(0x17e),'openId',_0x1637ae(0x13b)]});if(!_0x210e79)throw new common_1[(_0x1637ae(0x1dd))](_0x1637ae(0x1c0),common_1['HttpStatus'][_0x1637ae(0x1a1)]);_0x210e79[_0x1637ae(0x167)]=!!(_0x210e79===null||_0x210e79===void 0x0?void 0x0:_0x210e79[_0x1637ae(0x1da)]),delete _0x210e79[_0x1637ae(0x1da)];const _0x5e7adf=await this[_0x1637ae(0x196)][_0x1637ae(0x150)](_0x85c2f0);return{'userInfo':_0x210e79,'userBalance':Object[_0x1637ae(0x1c2)]({},_0x5e7adf)};}async[_0x20df8c(0x198)](_0x461d2b){const _0x3be0af=_0x20df8c;return await this[_0x3be0af(0x1cb)]['findOne']({'where':{'id':_0x461d2b}});}async['getUserOpenId'](_0x77bfb5){const _0x5cefa6=_0x20df8c;return await this[_0x5cefa6(0x1cb)]['findOne']({'where':{'openId':_0x77bfb5}});}async[_0x20df8c(0x1ba)](_0x20b280,_0x39af57){const _0x3b2317=_0x20df8c,{id:_0x2849d5}=_0x39af57[_0x3b2317(0x168)],_0x5f2d09=await this[_0x3b2317(0x1cb)][_0x3b2317(0x19c)]({'where':{'id':_0x2849d5}});if(!_0x5f2d09)throw new common_1[(_0x3b2317(0x1dd))]('当前用户不存在！',common_1['HttpStatus'][_0x3b2317(0x184)]);if(_0x20b280[_0x3b2317(0x172)]&&_0x5f2d09['username']===_0x20b280[_0x3b2317(0x172)])throw new common_1[(_0x3b2317(0x1dd))](_0x3b2317(0x15b),common_1['HttpStatus'][_0x3b2317(0x184)]);if(_0x20b280[_0x3b2317(0x172)]){const _0x4f9519=await this['userEntity']['findOne']({'where':{'username':_0x20b280['username'],'id':(0x0,typeorm_2[_0x3b2317(0x1bf)])(_0x2849d5)}});if(_0x4f9519)throw new common_1[(_0x3b2317(0x1dd))](_0x3b2317(0x135),common_1[_0x3b2317(0x15d)]['BAD_REQUEST']);}const _0x101f3c=await this[_0x3b2317(0x1cb)][_0x3b2317(0x1aa)]({'id':_0x2849d5},_0x20b280);if(_0x101f3c['affected']<=0x0)throw new common_1[(_0x3b2317(0x1dd))](_0x3b2317(0x13c),common_1[_0x3b2317(0x15d)]['BAD_REQUEST']);return'修改用户信息成功！';}async[_0x20df8c(0x1c6)](_0x4a9a29,_0x2792e2){const _0x326a12=_0x20df8c,_0x5aac5f=bcrypt[_0x326a12(0x1ad)](_0x2792e2,0xa),_0x841f9e=await this['userEntity'][_0x326a12(0x1aa)]({'id':_0x4a9a29},{'password':_0x5aac5f});if(_0x841f9e[_0x326a12(0x17c)]<=0x0)throw new common_1[(_0x326a12(0x1dd))](_0x326a12(0x161),common_1[_0x326a12(0x15d)][_0x326a12(0x184)]);}async[_0x20df8c(0x1b6)](_0x148e30){const _0x21ae82=_0x20df8c,{id:_0x39d434}=_0x148e30[_0x21ae82(0x168)],_0x5d7cff=await this[_0x21ae82(0x1cb)][_0x21ae82(0x19c)]({'where':{'id':_0x39d434}});if(!_0x5d7cff||_0x5d7cff[_0x21ae82(0x17e)])throw new common_1['HttpException'](_0x21ae82(0x16f),common_1[_0x21ae82(0x15d)]['BAD_REQUEST']);const _0x254c4a=(0x0,utils_1[_0x21ae82(0x1b5)])(),_0x5c0995=await this[_0x21ae82(0x1cb)]['findOne']({'where':{'inviteCode':_0x254c4a}});if(_0x5c0995)throw new common_1[(_0x21ae82(0x1dd))](_0x21ae82(0x163),common_1[_0x21ae82(0x15d)][_0x21ae82(0x184)]);const _0x43fd43=await this['userEntity']['update']({'id':_0x39d434},{'inviteCode':_0x254c4a});if(_0x43fd43[_0x21ae82(0x17c)]<=0x0)throw new common_1[(_0x21ae82(0x1dd))](_0x21ae82(0x163),common_1[_0x21ae82(0x15d)][_0x21ae82(0x184)]);return _0x254c4a;}async[_0x20df8c(0x1a3)](_0xa9bdf2,_0x59f49c){const _0x1bdef3=_0x20df8c;try{const {id:_0x1cc2c1}=_0xa9bdf2[_0x1bdef3(0x168)],{page:page=0x1,size:size=0xa}=_0x59f49c,_0x1bd3f1=await this[_0x1bdef3(0x1cb)]['findOne']({'where':{'id':_0x1cc2c1}}),{inviteCode:_0x23f691}=_0x1bd3f1;if(!_0x23f691)return[];const [_0x5099a1,_0x384271]=await this[_0x1bdef3(0x1cb)]['findAndCount']({'where':{'inviteCode':_0x23f691},'order':{'id':_0x1bdef3(0x153)},'select':[_0x1bdef3(0x172),_0x1bdef3(0x136),_0x1bdef3(0x146),_0x1bdef3(0x171),_0x1bdef3(0x1db)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x1bdef3(0x166)])(_0x5099a1)[_0x1bdef3(0x1a9)](_0x4d0d9b=>{const _0x55fa19=_0x1bdef3;return _0x4d0d9b[_0x55fa19(0x136)]=(0x0,utils_1['maskEmail'])(_0x4d0d9b['email']),_0x4d0d9b;}),{'rows':_0x5099a1,'count':_0x384271};}catch(_0x54e6ec){console[_0x1bdef3(0x157)]('error:\x20',_0x54e6ec);throw new common_1[(_0x1bdef3(0x1dd))](_0x1bdef3(0x154),common_1['HttpStatus'][_0x1bdef3(0x184)]);}}async[_0x20df8c(0x199)](_0x305c53){const _0x22cd52=_0x20df8c,_0x242011=await this[_0x22cd52(0x1cb)][_0x22cd52(0x19c)]({'where':{'inviteCode':_0x305c53}});if(!_0x242011)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x242011,_0x489005=await this[_0x22cd52(0x1cb)][_0x22cd52(0x1aa)]({'inviteCode':_0x305c53},{'inviteLinkCount':inviteLinkCount+0x1});return _0x489005[_0x22cd52(0x17c)]?0x1:0x0;}async[_0x20df8c(0x181)](_0x5400c5){const _0x357f4a=_0x20df8c;return await this['userEntity'][_0x357f4a(0x19c)]({'where':{'inviteCode':_0x5400c5}});}async[_0x20df8c(0x188)](_0x309642){const _0x544079=_0x20df8c,{userId:_0x3540bc,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x309642;await this['userBalanceService'][_0x544079(0x16a)](_0x3540bc,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x47751f=await this[_0x544079(0x196)][_0x544079(0x186)]({'userId':_0x3540bc,'rechargeType':balance_constant_1['RechargeType'][_0x544079(0x143)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x47751f;}async['queryAll'](_0x315376,_0x4f958b){const _0x3575fb=_0x20df8c,{page:page=0x1,size:size=0xa,username:_0x302824,email:_0x100c8b,status:_0x29d234,keyword:_0x14f2fb,phone:_0x3fe56b}=_0x315376;let _0x34a8b9={};_0x302824&&Object[_0x3575fb(0x1c2)](_0x34a8b9,{'username':(0x0,typeorm_2['Like'])('%'+_0x302824+'%')}),_0x100c8b&&Object['assign'](_0x34a8b9,{'email':(0x0,typeorm_2[_0x3575fb(0x162)])('%'+_0x100c8b+'%')}),_0x3fe56b&&Object[_0x3575fb(0x1c2)](_0x34a8b9,{'phone':(0x0,typeorm_2['Like'])('%'+_0x3fe56b+'%')}),_0x29d234&&Object[_0x3575fb(0x1c2)](_0x34a8b9,{'status':_0x29d234});_0x14f2fb&&(_0x34a8b9=[{'username':(0x0,typeorm_2[_0x3575fb(0x162)])('%'+_0x14f2fb+'%')},{'email':(0x0,typeorm_2['Like'])('%'+_0x14f2fb+'%')},{'phone':(0x0,typeorm_2[_0x3575fb(0x162)])('%'+_0x14f2fb+'%')}]);const [_0x251838,_0x56eee8]=await this['userEntity']['findAndCount']({'skip':(page-0x1)*size,'where':_0x34a8b9,'take':size,'order':{'createdAt':_0x3575fb(0x153)},'cache':!![],'select':[_0x3575fb(0x172),_0x3575fb(0x1db),_0x3575fb(0x17e),_0x3575fb(0x14e),_0x3575fb(0x164),'status','id',_0x3575fb(0x136),'createdAt',_0x3575fb(0x174),_0x3575fb(0x1ae)]}),_0x5e5a34=_0x251838[_0x3575fb(0x1a9)](_0x47f138=>_0x47f138['id']),_0x2f8bcf=await this[_0x3575fb(0x196)]['queryUserBalanceByIds'](_0x5e5a34);return _0x251838[_0x3575fb(0x15c)](_0x1a7664=>_0x1a7664[_0x3575fb(0x140)]=_0x2f8bcf['find'](_0x36e315=>_0x36e315[_0x3575fb(0x197)]===_0x1a7664['id'])),_0x4f958b[_0x3575fb(0x168)]['role']!==_0x3575fb(0x13a)&&_0x251838['forEach'](_0x4c4369=>_0x4c4369['email']=(0x0,utils_1[_0x3575fb(0x1b3)])(_0x4c4369[_0x3575fb(0x136)])),_0x4f958b[_0x3575fb(0x168)][_0x3575fb(0x14e)]!==_0x3575fb(0x13a)&&_0x251838[_0x3575fb(0x15c)](_0x4381e4=>_0x4381e4['lastLoginIp']=(0x0,utils_1[_0x3575fb(0x134)])(_0x4381e4[_0x3575fb(0x174)])),_0x4f958b[_0x3575fb(0x168)][_0x3575fb(0x14e)]!=='super'&&_0x251838[_0x3575fb(0x15c)](_0x36fecc=>_0x36fecc[_0x3575fb(0x1ae)]=(0x0,utils_1[_0x3575fb(0x134)])(_0x36fecc[_0x3575fb(0x1ae)])),{'rows':_0x251838,'count':_0x56eee8};}async[_0x20df8c(0x137)]({id:_0x50f03f}){const _0x32a831=_0x20df8c;return await this[_0x32a831(0x1cb)][_0x32a831(0x19c)]({'where':{'id':_0x50f03f},'select':['username',_0x32a831(0x1db),_0x32a831(0x17e),_0x32a831(0x14e),_0x32a831(0x164),'status']});}async[_0x20df8c(0x1bb)](_0x506bbd){const _0x4ee8d9=_0x20df8c,{id:_0x1f1a84,status:_0xf84de2}=_0x506bbd,_0x1eab0f=await this[_0x4ee8d9(0x1cb)]['findOne']({'where':{'id':_0x1f1a84}});if(!_0x1eab0f)throw new common_1['HttpException']('用户不存在！',common_1[_0x4ee8d9(0x15d)][_0x4ee8d9(0x184)]);if(_0x1eab0f[_0x4ee8d9(0x14e)]===_0x4ee8d9(0x13a))throw new common_1['HttpException'](_0x4ee8d9(0x15e),common_1[_0x4ee8d9(0x15d)][_0x4ee8d9(0x184)]);if(_0x1eab0f[_0x4ee8d9(0x171)]===user_constant_1[_0x4ee8d9(0x19f)]['PENDING'])throw new common_1[(_0x4ee8d9(0x1dd))](_0x4ee8d9(0x1d8),common_1[_0x4ee8d9(0x15d)][_0x4ee8d9(0x184)]);if(_0x1eab0f[_0x4ee8d9(0x14e)]===_0x4ee8d9(0x13a))throw new common_1[(_0x4ee8d9(0x1dd))](_0x4ee8d9(0x15e),common_1[_0x4ee8d9(0x15d)][_0x4ee8d9(0x184)]);if(_0xf84de2===user_constant_1[_0x4ee8d9(0x19f)][_0x4ee8d9(0x189)])throw new common_1[(_0x4ee8d9(0x1dd))](_0x4ee8d9(0x169),common_1[_0x4ee8d9(0x15d)]['BAD_REQUEST']);const _0x30224f=await this[_0x4ee8d9(0x1cb)][_0x4ee8d9(0x1aa)]({'id':_0x1f1a84},{'status':_0xf84de2});if(_0x30224f['affected']<=0x0)throw new common_1['HttpException'](_0x4ee8d9(0x19d),common_1[_0x4ee8d9(0x15d)][_0x4ee8d9(0x184)]);return _0x4ee8d9(0x165);}async[_0x20df8c(0x19a)](_0xf85122){const _0x1d51e4=_0x20df8c,{id:_0x4292e0}=_0xf85122,_0x4da765=await this[_0x1d51e4(0x1cb)][_0x1d51e4(0x19c)]({'where':{'id':_0x4292e0}});if(!_0x4da765)throw new common_1[(_0x1d51e4(0x1dd))](_0x1d51e4(0x195),common_1[_0x1d51e4(0x15d)]['BAD_REQUEST']);const _0x160ff9='123456',_0x2c68da=bcrypt[_0x1d51e4(0x1ad)](_0x160ff9,0xa),_0xf3d4b7=await this[_0x1d51e4(0x1cb)][_0x1d51e4(0x1aa)]({'id':_0x4292e0},{'password':_0x2c68da});if(_0xf3d4b7['affected']<=0x0)throw new common_1[(_0x1d51e4(0x1dd))](_0x1d51e4(0x170),common_1['HttpStatus'][_0x1d51e4(0x184)]);return _0x1d51e4(0x149)+_0x160ff9+']成功!';}async['savaLoginIp'](_0x13d8bb,_0x342dc1){const _0x4a1b04=_0x20df8c;return await this['userEntity'][_0x4a1b04(0x1aa)]({'id':_0x13d8bb},{'lastLoginIp':_0x342dc1});}async[_0x20df8c(0x13f)](_0x46881b,_0x51496e){const _0x198976=_0x20df8c,_0x3b2d1e=await this['userEntity'][_0x198976(0x19c)]({'where':{'openId':_0x46881b}});if(!_0x3b2d1e){const _0x43f2bc=_0x51496e?_0x51496e[_0x198976(0x1b8)](':')[0x1]:'',_0x3bfb73=await this['qureyUserInfoByInviteCode'](_0x43f2bc),_0x5a445b=await this[_0x198976(0x139)](_0x46881b,_0x43f2bc);return await this['userBalanceService'][_0x198976(0x1b7)](_0x5a445b['id'],_0x43f2bc?_0x3bfb73===null||_0x3bfb73===void 0x0?void 0x0:_0x3bfb73['id']:null),_0x5a445b;}return _0x3b2d1e;}async[_0x20df8c(0x139)](_0x10bff5,_0x2c3bf2){const _0x59574a=_0x20df8c,_0x588eff=await this['globalConfigService'][_0x59574a(0x152)](['userDefautlAvatar']),_0x191199={'avatar':_0x588eff,'username':'用户'+(0x0,utils_1[_0x59574a(0x18f)])(),'status':user_constant_1[_0x59574a(0x19f)][_0x59574a(0x1c9)],'sex':0x0,'email':(0x0,utils_1[_0x59574a(0x18f)])()+'@default.com','invitedBy':_0x2c3bf2,'openId':_0x10bff5},_0x38ad22=await this[_0x59574a(0x1cb)]['save'](_0x191199);return _0x38ad22;}async['bindWx'](_0xcbae62,_0x195296){const _0x1a9c74=_0x20df8c;try{const _0x3da91c=await this[_0x1a9c74(0x1cb)]['findOne']({'where':{'id':_0x195296}});if(!_0x3da91c)return{'status':![],'msg':_0x1a9c74(0x1af)};const _0x3ccb2b=await this[_0x1a9c74(0x1cb)]['findOne']({'where':{'openId':_0xcbae62}});if(_0x3ccb2b)return{'status':![],'msg':_0x1a9c74(0x1dc)};const _0x454ac0=await this[_0x1a9c74(0x1cb)][_0x1a9c74(0x1aa)]({'id':_0x195296},{'openId':_0xcbae62});if(_0x454ac0[_0x1a9c74(0x17c)]<=0x0)return{'status':![],'msg':'绑定微信失败、请联系管理员！'};return{'status':!![],'msg':_0x1a9c74(0x191)};}catch(_0x5dd774){return{'status':![],'msg':_0x1a9c74(0x159)};}}async['getOpenIdByUserId'](_0x1c36c7){const _0x5aef5a=_0x20df8c,_0x5926a3=await this[_0x5aef5a(0x1cb)][_0x5aef5a(0x19c)]({'where':{'id':_0x1c36c7}});return _0x5926a3===null||_0x5926a3===void 0x0?void 0x0:_0x5926a3[_0x5aef5a(0x1da)];}async[_0x20df8c(0x144)](_0x2b6f03){const _0x5206fd=_0x20df8c,{username:_0x5699b8,password:_0x42a165,phone:_0x5ab89e,phoneCode:_0x32c24d}=_0x2b6f03,_0x55f2ae=await this[_0x5206fd(0x1cb)][_0x5206fd(0x19c)]({'where':[{'username':_0x5699b8},{'phone':_0x5ab89e}]});if(_0x55f2ae&&_0x55f2ae['username']===_0x5699b8)throw new common_1[(_0x5206fd(0x1dd))]('用户名已存在、请更换用户名！',common_1[_0x5206fd(0x15d)][_0x5206fd(0x184)]);if(_0x55f2ae&&_0x55f2ae[_0x5206fd(0x1ae)]===_0x5ab89e)throw new common_1[(_0x5206fd(0x1dd))](_0x5206fd(0x190),common_1[_0x5206fd(0x15d)][_0x5206fd(0x184)]);}async[_0x20df8c(0x173)](_0x146cad){const _0x204928=_0x20df8c;return await this[_0x204928(0x1cb)]['save'](_0x146cad);}};UserService=__decorate([(0x0,common_1[_0x20df8c(0x1d2)])(),__param(0x0,(0x0,typeorm_1[_0x20df8c(0x19e)])(user_entity_1[_0x20df8c(0x1a7)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1[_0x20df8c(0x1d0)])),__param(0x7,(0x0,typeorm_1[_0x20df8c(0x19e)])(config_entity_1[_0x20df8c(0x1c5)])),__metadata(_0x20df8c(0x14c),[typeorm_2[_0x20df8c(0x1d6)],typeorm_2[_0x20df8c(0x1d6)],typeorm_2[_0x20df8c(0x17a)],verification_service_1[_0x20df8c(0x1de)],mailer_1[_0x20df8c(0x16d)],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x20df8c(0x17b)],typeorm_2[_0x20df8c(0x1d6)]])],UserService),exports['UserService']=UserService;