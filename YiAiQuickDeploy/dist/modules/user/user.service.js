'use strict';const _0x5b9c58=_0x54a7;function _0x1b22(){const _0x1dfc28=['ACTIVE','2343ltshpM','saveRecordRechargeLog','email\x20response\x20\x20->\x20:\x20','save','RechargeType','client','__esModule','checkUserStatus','当前用户信息失效、请重新登录！','bcryptjs',']成功!','md5','WhiteListEntity','genInviteCode','function','BAD_REQUEST','../verification/verification.service','bindWx','username','queryUserBalanceByIds','userBalanceService','当前绑定用户不存在！','ADMIN_GIFT','../globalConfig/globalConfig.service','findAndCount','../../common/utils','maskEmail','queryUserBalance','resetUserPass','avatar','decorate','__decorate','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','UNAUTHORIZED','password','当前用户不存在！','重置密码失败！','verifyUserPassword','super','registerVerifyEmailFrom','2769496lXMDHP','Not','length','lastLoginIp','__metadata','globalConfigService','createHash','queryOneUserInfo','Registration','defineProperty','@default.com','恭喜您绑定成功、后续可直接扫码登录了！','phone','hashSync','../../common/constants/balance.constant','userEntity','该微信已绑定其他账号！','queryAll','status','compareSync','findOne','绑定微信失败、请联系管理员！','object','openId','reduce','email','$2b$','您的账户已被封禁、如有疑问、请联系管理员！','inviteCode','balanceInfo','getOpenIdByUserId','8649423OZVrhG','maskIpAddress','UserBalanceService','../../common/constants/user.constant','DESC','BLACKLISTED','verifyUserCredentials','__param','../chatgpt/whiteList.entity','crypto','digest','2238830KYHPVy','configEntity','$2y$','qureyUserInfoByInviteCode','InjectRepository','split','Connection','密码重置为[','userDefautlAvatar','sign','245hGnHVQ','MailerService','updateUserPassword','UserStatusEnum','当前密码错误！','inviteLink','update','forEach','getConfigs','用户不存在！','HttpException','HttpStatus','updateUserStatus','用户名已存在、请更换用户名！','./user.entity','register','assign','UserEntity','mailerService','超级管理员不可被操作！','3560jBkbii','affected','log','$2a$','hex','UserService','PENDING','map','123456','error:\x20','getUserInfo','getUserOpenId','修改用户状态成功！','获取邀请记录失败！','生成邀请码失败，请重新试一次吧！','createUserFromOpenId','userId','6581635JYUPhP','isVerifyEmail','修改密码失败、请重新试试吧。','registerVerifyExpir','cloneDeep','VerificationService','----,','没有变更，无需更改！','updateStatus','generateRandomString','role','Like','createUserAndVerifycation','无效的邀请码！','Repository','createVerification','ConfigEntity','startsWith','addBalanceToNewUser','@nestjs/common','72978JxnYrh','../globalConfig/config.entity','registerBaseUrl','metadata','修改用户状态失败！','visitor','getOwnPropertyDescriptor','connection','用户名或者邮箱已被注册！','user','registerVerifyEmailDesc','consecutiveDays','1084337kPGExz','@nestjs-modules/mailer','getInviteRecord','createdAt','isBindWx','updateInfo','当前账户不存在！','@nestjs/typeorm','queryUserInfoById','createRandomUid'];_0x1b22=function(){return _0x1dfc28;};return _0x1b22();}(function(_0x9729d6,_0x3e6e7c){const _0xc25374=_0x54a7,_0x3ee59c=_0x9729d6();while(!![]){try{const _0x518e64=-parseInt(_0xc25374(0x191))/0x1+-parseInt(_0xc25374(0x1ee))/0x2+parseInt(_0xc25374(0x19c))/0x3*(parseInt(_0xc25374(0x20c))/0x4)+parseInt(_0xc25374(0x21d))/0x5+parseInt(_0xc25374(0x231))/0x6*(-parseInt(_0xc25374(0x1f8))/0x7)+parseInt(_0xc25374(0x1c4))/0x8+parseInt(_0xc25374(0x1e3))/0x9;if(_0x518e64===_0x3e6e7c)break;else _0x3ee59c['push'](_0x3ee59c['shift']());}catch(_0x20e394){_0x3ee59c['push'](_0x3ee59c['shift']());}}}(_0x1b22,0xa842a));function _0x54a7(_0x17f549,_0x371a93){const _0x1b2285=_0x1b22();return _0x54a7=function(_0x54a711,_0x5756e3){_0x54a711=_0x54a711-0x186;let _0x197d55=_0x1b2285[_0x54a711];return _0x197d55;},_0x54a7(_0x17f549,_0x371a93);}var __decorate=this&&this[_0x5b9c58(0x1bb)]||function(_0x5239a7,_0x50b1f5,_0xbb2fa8,_0x42acad){const _0x3a5d2c=_0x5b9c58;var _0x2d9486=arguments[_0x3a5d2c(0x1c6)],_0x2f64c9=_0x2d9486<0x3?_0x50b1f5:_0x42acad===null?_0x42acad=Object[_0x3a5d2c(0x18b)](_0x50b1f5,_0xbb2fa8):_0x42acad,_0x153edc;if(typeof Reflect===_0x3a5d2c(0x1da)&&typeof Reflect[_0x3a5d2c(0x1ba)]==='function')_0x2f64c9=Reflect[_0x3a5d2c(0x1ba)](_0x5239a7,_0x50b1f5,_0xbb2fa8,_0x42acad);else{for(var _0x13be28=_0x5239a7['length']-0x1;_0x13be28>=0x0;_0x13be28--)if(_0x153edc=_0x5239a7[_0x13be28])_0x2f64c9=(_0x2d9486<0x3?_0x153edc(_0x2f64c9):_0x2d9486>0x3?_0x153edc(_0x50b1f5,_0xbb2fa8,_0x2f64c9):_0x153edc(_0x50b1f5,_0xbb2fa8))||_0x2f64c9;}return _0x2d9486>0x3&&_0x2f64c9&&Object[_0x3a5d2c(0x1cd)](_0x50b1f5,_0xbb2fa8,_0x2f64c9),_0x2f64c9;},__metadata=this&&this[_0x5b9c58(0x1c8)]||function(_0x31882e,_0x20d9dc){const _0x1f3cee=_0x5b9c58;if(typeof Reflect===_0x1f3cee(0x1da)&&typeof Reflect[_0x1f3cee(0x188)]===_0x1f3cee(0x1aa))return Reflect[_0x1f3cee(0x188)](_0x31882e,_0x20d9dc);},__param=this&&this[_0x5b9c58(0x1ea)]||function(_0x5a2512,_0x204105){return function(_0x120caf,_0x32d710){_0x204105(_0x120caf,_0x32d710,_0x5a2512);};};Object[_0x5b9c58(0x1cd)](exports,_0x5b9c58(0x1a2),{'value':!![]}),exports[_0x5b9c58(0x211)]=void 0x0;const globalConfig_service_1=require(_0x5b9c58(0x1b3)),user_constant_1=require(_0x5b9c58(0x1e6)),mailer_1=require(_0x5b9c58(0x192)),verification_service_1=require(_0x5b9c58(0x1ac)),common_1=require(_0x5b9c58(0x230)),typeorm_1=require(_0x5b9c58(0x198)),typeorm_2=require('typeorm'),user_entity_1=require(_0x5b9c58(0x206)),bcrypt=require(_0x5b9c58(0x1a5)),crypto=require(_0x5b9c58(0x1ec)),_=require('lodash'),verification_constant_1=require('../../common/constants/verification.constant'),userBalance_service_1=require('../userBalance/userBalance.service'),utils_1=require(_0x5b9c58(0x1b5)),balance_constant_1=require(_0x5b9c58(0x1d2)),config_entity_1=require(_0x5b9c58(0x186)),whiteList_entity_1=require(_0x5b9c58(0x1eb));let UserService=class UserService{constructor(_0x42d887,_0x4d870b,_0x22f2cc,_0xac2e44,_0x15d3dc,_0x4b0267,_0x198f67,_0x1e2518){const _0x4da0a0=_0x5b9c58;this[_0x4da0a0(0x1d3)]=_0x42d887,this['whiteListEntity']=_0x4d870b,this[_0x4da0a0(0x18c)]=_0x22f2cc,this['verificationService']=_0xac2e44,this[_0x4da0a0(0x20a)]=_0x15d3dc,this[_0x4da0a0(0x1b0)]=_0x4b0267,this[_0x4da0a0(0x1c9)]=_0x198f67,this[_0x4da0a0(0x1ef)]=_0x1e2518;}async[_0x5b9c58(0x229)](_0x1d3be0,_0x1715d3){const _0x3ddaed=_0x5b9c58,{username:_0x211390,email:_0x4a7508,password:_0x1a44d7,invitedBy:_0x49632d,client:client=0x0}=_0x1d3be0;if(_0x49632d){const _0x93ec93=await this['userEntity'][_0x3ddaed(0x1d8)]({'where':{'inviteCode':_0x49632d}});if(!_0x93ec93)throw new common_1[(_0x3ddaed(0x202))](_0x3ddaed(0x22a),common_1[_0x3ddaed(0x203)]['BAD_REQUEST']);}const _0x2a2c25=[{'username':_0x211390},{'email':_0x4a7508}],_0x4a6641=await this[_0x3ddaed(0x1d3)]['findOne']({'where':_0x2a2c25});if(_0x4a6641&&_0x4a6641[_0x3ddaed(0x1d6)]!==user_constant_1['UserStatusEnum'][_0x3ddaed(0x212)])throw new common_1[(_0x3ddaed(0x202))](_0x3ddaed(0x18d),common_1[_0x3ddaed(0x203)]['BAD_REQUEST']);try{const _0x19ae30=_[_0x3ddaed(0x221)](_0x1d3be0),_0x175239=bcrypt[_0x3ddaed(0x1d1)](_0x1a44d7,0xa),_0x313492=(0x0,utils_1['getClientIp'])(_0x1715d3);_0x19ae30[_0x3ddaed(0x1be)]=_0x175239,_0x19ae30['registerIp']=_0x313492,_0x19ae30[_0x3ddaed(0x1a1)]=client;let _0x19a161;if(!_0x4a6641){const _0x1123ad=await this['globalConfigService']['getConfigs']([_0x3ddaed(0x1f6)]);_0x19ae30[_0x3ddaed(0x1b9)]=_0x1123ad,_0x19a161=await this[_0x3ddaed(0x1d3)][_0x3ddaed(0x19f)](_0x19ae30);}else _0x19a161=_0x4a6641;const _0x49e1c5=await this[_0x3ddaed(0x1ef)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x3ddaed(0x21e),_0x3ddaed(0x187),'registerVerifyEmailTitle',_0x3ddaed(0x18f),_0x3ddaed(0x1c3),_0x3ddaed(0x220)])}}),_0x11d4b4=_0x49e1c5[_0x3ddaed(0x1dc)]((_0x1bfabf,_0x98f45b)=>{return _0x1bfabf[_0x98f45b['configKey']]=_0x98f45b['configVal'],_0x1bfabf;},{}),_0x24e248=_0x11d4b4[_0x3ddaed(0x21e)]?Number(_0x11d4b4[_0x3ddaed(0x21e)]):0x1;if(_0x24e248){const _0x156cc0=_0x11d4b4[_0x3ddaed(0x220)]?Number(_0x11d4b4[_0x3ddaed(0x220)]):0x1e*0x3c,_0x3cf36e=await this['verificationService'][_0x3ddaed(0x22c)](_0x19a161,verification_constant_1['VerificationEnum'][_0x3ddaed(0x1cc)],_0x156cc0),{code:_0x153247,email:_0x54a232,id:_0xae3208}=_0x3cf36e,{registerVerifyEmailFrom:_0x7c2289}=_0x11d4b4;console[_0x3ddaed(0x20e)]('configMap:\x20',_0x11d4b4);const _0x4ce138=await this[_0x3ddaed(0x20a)]['sendMail']({'to':_0x54a232,'subject':'来自'+_0x7c2289+'的账号激活','template':_0x3ddaed(0x207),'context':Object[_0x3ddaed(0x208)]({'baseUrl':_0x11d4b4[_0x3ddaed(0x187)],'code':_0x153247,'id':_0xae3208},_0x11d4b4)});console['log'](_0x3ddaed(0x19e),_0x4ce138);}else{const {username:_0xe01cd4,email:_0x48daeb,id:_0x3d4c9d,invitedBy:_0x108d39}=_0x19a161;await this['updateUserStatus'](_0x3d4c9d,user_constant_1[_0x3ddaed(0x1fb)][_0x3ddaed(0x19b)]);let _0xa80d51;_0x108d39&&(_0xa80d51=await this[_0x3ddaed(0x1f1)](_0x108d39)),await this[_0x3ddaed(0x1b0)][_0x3ddaed(0x22f)](_0x3d4c9d,_0xa80d51===null||_0xa80d51===void 0x0?void 0x0:_0xa80d51['id']);}return _0x19a161;}catch(_0x3752fb){console[_0x3ddaed(0x20e)](_0x3ddaed(0x215),_0x3752fb);throw _0x3752fb;}}async['getSuper'](){const _0x1142e7=_0x5b9c58,_0x347328=await this[_0x1142e7(0x1d3)][_0x1142e7(0x1d8)]({'where':{'role':'super'}});return _0x347328;}async[_0x5b9c58(0x1e9)](_0xee03ce){const _0xfa98d2=_0x5b9c58,{username:_0x566a83,password:_0x24daba,uid:uid=0x0,phone:_0x2f81d4}=_0xee03ce;let _0x52f39f=null;if(uid>0x0){_0x52f39f=await this[_0xfa98d2(0x1d3)]['findOne']({'where':{'id':uid}});if(!_0x52f39f)throw new common_1[(_0xfa98d2(0x202))](_0xfa98d2(0x197),common_1[_0xfa98d2(0x203)][_0xfa98d2(0x1ab)]);if(_0x52f39f[_0xfa98d2(0x1be)][_0xfa98d2(0x22e)](_0xfa98d2(0x20f))||_0x52f39f[_0xfa98d2(0x1be)][_0xfa98d2(0x22e)]('$2b$')||_0x52f39f[_0xfa98d2(0x1be)][_0xfa98d2(0x22e)]('$2y$')){if(!bcrypt[_0xfa98d2(0x1d7)](_0x24daba,_0x52f39f[_0xfa98d2(0x1be)]))throw new common_1[(_0xfa98d2(0x202))](_0xfa98d2(0x1fc),common_1[_0xfa98d2(0x203)][_0xfa98d2(0x1ab)]);}else{console[_0xfa98d2(0x20e)](_0xfa98d2(0x223));const _0x5e8456=crypto['createHash'](_0xfa98d2(0x1a7))['update'](_0x24daba)[_0xfa98d2(0x1ed)](_0xfa98d2(0x210));console[_0xfa98d2(0x20e)]('----,',_0x5e8456);if(_0x5e8456!==_0x52f39f[_0xfa98d2(0x1be)])throw new common_1[(_0xfa98d2(0x202))](_0xfa98d2(0x1fc),common_1[_0xfa98d2(0x203)][_0xfa98d2(0x1ab)]);}}if(_0x566a83&&_0x24daba){const _0x30e209=[{'username':_0x566a83},{'email':_0x566a83}];_0x52f39f=await this[_0xfa98d2(0x1d3)][_0xfa98d2(0x1d8)]({'where':_0x30e209});if(!_0x52f39f)throw new common_1[(_0xfa98d2(0x202))](_0xfa98d2(0x197),common_1[_0xfa98d2(0x203)]['BAD_REQUEST']);if(_0x52f39f[_0xfa98d2(0x1be)][_0xfa98d2(0x22e)](_0xfa98d2(0x20f))||_0x52f39f[_0xfa98d2(0x1be)][_0xfa98d2(0x22e)](_0xfa98d2(0x1de))||_0x52f39f[_0xfa98d2(0x1be)][_0xfa98d2(0x22e)](_0xfa98d2(0x1f0))){if(!bcrypt['compareSync'](_0x24daba,_0x52f39f[_0xfa98d2(0x1be)]))throw new common_1[(_0xfa98d2(0x202))](_0xfa98d2(0x1fc),common_1[_0xfa98d2(0x203)][_0xfa98d2(0x1ab)]);}else{console[_0xfa98d2(0x20e)]('----,');const _0x373899=crypto[_0xfa98d2(0x1ca)]('md5')[_0xfa98d2(0x1fe)](_0x24daba)['digest']('hex');console['log'](_0xfa98d2(0x223),_0x373899);if(_0x373899!==_0x52f39f[_0xfa98d2(0x1be)])throw new common_1[(_0xfa98d2(0x202))]('当前密码错误！',common_1['HttpStatus']['BAD_REQUEST']);}}if(_0x2f81d4&&_0x24daba){const _0x567986=[{'phone':_0x2f81d4}];_0x52f39f=await this[_0xfa98d2(0x1d3)][_0xfa98d2(0x1d8)]({'where':_0x567986});if(!_0x52f39f)throw new common_1['HttpException'](_0xfa98d2(0x197),common_1[_0xfa98d2(0x203)]['BAD_REQUEST']);if(_0x52f39f[_0xfa98d2(0x1be)][_0xfa98d2(0x22e)](_0xfa98d2(0x20f))||_0x52f39f['password'][_0xfa98d2(0x22e)](_0xfa98d2(0x1de))||_0x52f39f[_0xfa98d2(0x1be)][_0xfa98d2(0x22e)]('$2y$')){if(!bcrypt[_0xfa98d2(0x1d7)](_0x24daba,_0x52f39f[_0xfa98d2(0x1be)]))throw new common_1[(_0xfa98d2(0x202))](_0xfa98d2(0x1fc),common_1['HttpStatus'][_0xfa98d2(0x1ab)]);}else{console[_0xfa98d2(0x20e)](_0xfa98d2(0x223));const _0x45eb78=crypto[_0xfa98d2(0x1ca)](_0xfa98d2(0x1a7))[_0xfa98d2(0x1fe)](_0x24daba)[_0xfa98d2(0x1ed)](_0xfa98d2(0x210));console[_0xfa98d2(0x20e)](_0xfa98d2(0x223),_0x45eb78);if(_0x45eb78!==_0x52f39f[_0xfa98d2(0x1be)])throw new common_1[(_0xfa98d2(0x202))]('当前密码错误！',common_1[_0xfa98d2(0x203)][_0xfa98d2(0x1ab)]);}}if(!_0x52f39f)throw new common_1['HttpException']('当前账户不存在！',common_1['HttpStatus'][_0xfa98d2(0x1ab)]);if(_0x52f39f['status']!==user_constant_1[_0xfa98d2(0x1fb)][_0xfa98d2(0x19b)])throw new common_1[(_0xfa98d2(0x202))](user_constant_1['UserStatusErrMsg'][_0x52f39f['status']],common_1[_0xfa98d2(0x203)]['BAD_REQUEST']);return _0x52f39f;}async[_0x5b9c58(0x1c1)](_0x12d60c,_0x237705){const _0x1cbaed=_0x5b9c58,_0x5cf651=await this[_0x1cbaed(0x1d3)][_0x1cbaed(0x1d8)]({'where':{'id':_0x12d60c}});if(_0x5cf651[_0x1cbaed(0x1be)][_0x1cbaed(0x22e)](_0x1cbaed(0x20f))||_0x5cf651[_0x1cbaed(0x1be)][_0x1cbaed(0x22e)](_0x1cbaed(0x1de))||_0x5cf651[_0x1cbaed(0x1be)][_0x1cbaed(0x22e)](_0x1cbaed(0x1f0)))return bcrypt[_0x1cbaed(0x1d7)](_0x237705,_0x5cf651['password']);else{const _0x958deb=crypto[_0x1cbaed(0x1ca)](_0x1cbaed(0x1a7))[_0x1cbaed(0x1fe)](_0x237705)[_0x1cbaed(0x1ed)](_0x1cbaed(0x210));return console[_0x1cbaed(0x20e)](_0x1cbaed(0x223),_0x958deb),_0x958deb===_0x5cf651['password'];}}async[_0x5b9c58(0x204)](_0x3e1c98,_0x294d2b){const _0x381e1b=_0x5b9c58,_0x458013=await this[_0x381e1b(0x1d3)][_0x381e1b(0x1fe)]({'id':_0x3e1c98},{'status':_0x294d2b});return _0x458013[_0x381e1b(0x20d)]>0x0;}async['getUserStatus'](_0x2edf8f){const _0x49da81=_0x5b9c58,_0x2dafbd=await this[_0x49da81(0x1d3)][_0x49da81(0x1d8)]({'where':{'id':_0x2edf8f}});return _0x2dafbd[_0x49da81(0x1d6)];}async[_0x5b9c58(0x199)](_0x4a14a0){return await this['userEntity']['findOne']({'where':{'id':_0x4a14a0}});}async[_0x5b9c58(0x1cb)](_0x2ecfa7){const _0x1fce38=_0x5b9c58;return await this[_0x1fce38(0x1d3)][_0x1fce38(0x1d8)]({'where':{'id':_0x2ecfa7}});}async[_0x5b9c58(0x1a3)](_0x4975eb){const _0x184fa9=_0x5b9c58,{id:_0x428d43,role:_0x1f47bf}=_0x4975eb;if(_0x1f47bf===_0x184fa9(0x18a))return!![];const _0x35266f=await this[_0x184fa9(0x1d3)][_0x184fa9(0x1d8)]({'where':{'id':_0x428d43}});if(!_0x35266f)throw new common_1[(_0x184fa9(0x202))]('当前用户信息失效、请重新登录！',common_1[_0x184fa9(0x203)][_0x184fa9(0x1bd)]);if(_0x35266f['status']===user_constant_1[_0x184fa9(0x1fb)][_0x184fa9(0x1e8)])throw new common_1[(_0x184fa9(0x202))](_0x184fa9(0x1bc),common_1[_0x184fa9(0x203)][_0x184fa9(0x1ab)]);if(_0x35266f[_0x184fa9(0x1d6)]===user_constant_1[_0x184fa9(0x1fb)]['LOCKED'])throw new common_1[(_0x184fa9(0x202))](_0x184fa9(0x1df),common_1[_0x184fa9(0x203)][_0x184fa9(0x1ab)]);}async[_0x5b9c58(0x216)](_0x321b75){const _0x3482bf=_0x5b9c58,_0x224778=await this[_0x3482bf(0x1d3)][_0x3482bf(0x1d8)]({'where':{'id':_0x321b75},'select':[_0x3482bf(0x1ae),_0x3482bf(0x1b9),'role',_0x3482bf(0x1dd),_0x3482bf(0x1f7),_0x3482bf(0x1e0),'openId',_0x3482bf(0x190)]});if(!_0x224778)throw new common_1[(_0x3482bf(0x202))](_0x3482bf(0x1a4),common_1[_0x3482bf(0x203)][_0x3482bf(0x1bd)]);_0x224778[_0x3482bf(0x195)]=!!(_0x224778===null||_0x224778===void 0x0?void 0x0:_0x224778[_0x3482bf(0x1db)]),delete _0x224778[_0x3482bf(0x1db)];const _0x4857c3=await this['userBalanceService'][_0x3482bf(0x1b7)](_0x321b75);return{'userInfo':_0x224778,'userBalance':Object[_0x3482bf(0x208)]({},_0x4857c3)};}async['getUserById'](_0x4c3bf3){const _0x10a8c3=_0x5b9c58;return await this[_0x10a8c3(0x1d3)][_0x10a8c3(0x1d8)]({'where':{'id':_0x4c3bf3}});}async[_0x5b9c58(0x217)](_0x2f71dd){const _0x34decd=_0x5b9c58;return await this[_0x34decd(0x1d3)]['findOne']({'where':{'openId':_0x2f71dd}});}async[_0x5b9c58(0x196)](_0x31fea0,_0x5ec1f3){const _0x1347d7=_0x5b9c58,{id:_0x303805}=_0x5ec1f3[_0x1347d7(0x18e)],_0xa66e69=await this[_0x1347d7(0x1d3)][_0x1347d7(0x1d8)]({'where':{'id':_0x303805}});if(!_0xa66e69)throw new common_1[(_0x1347d7(0x202))](_0x1347d7(0x1bf),common_1[_0x1347d7(0x203)][_0x1347d7(0x1ab)]);if(_0x31fea0[_0x1347d7(0x1ae)]&&_0xa66e69['username']===_0x31fea0['username'])throw new common_1[(_0x1347d7(0x202))](_0x1347d7(0x224),common_1[_0x1347d7(0x203)][_0x1347d7(0x1ab)]);if(_0x31fea0[_0x1347d7(0x1ae)]){const _0x1e38ca=await this[_0x1347d7(0x1d3)][_0x1347d7(0x1d8)]({'where':{'username':_0x31fea0[_0x1347d7(0x1ae)],'id':(0x0,typeorm_2[_0x1347d7(0x1c5)])(_0x303805)}});if(_0x1e38ca)throw new common_1['HttpException']('用户名已存在！',common_1[_0x1347d7(0x203)][_0x1347d7(0x1ab)]);}const _0x586dfd=await this['userEntity'][_0x1347d7(0x1fe)]({'id':_0x303805},_0x31fea0);if(_0x586dfd[_0x1347d7(0x20d)]<=0x0)throw new common_1[(_0x1347d7(0x202))]('修改用户信息失败！',common_1[_0x1347d7(0x203)]['BAD_REQUEST']);return'修改用户信息成功！';}async[_0x5b9c58(0x1fa)](_0x3f1c36,_0x369b9d){const _0x27c2ac=_0x5b9c58,_0x119ed4=bcrypt[_0x27c2ac(0x1d1)](_0x369b9d,0xa),_0x2f2020=await this['userEntity']['update']({'id':_0x3f1c36},{'password':_0x119ed4});if(_0x2f2020[_0x27c2ac(0x20d)]<=0x0)throw new common_1[(_0x27c2ac(0x202))](_0x27c2ac(0x21f),common_1[_0x27c2ac(0x203)]['BAD_REQUEST']);}async[_0x5b9c58(0x1a9)](_0x2f2fd7){const _0x21badb=_0x5b9c58,{id:_0x5c82c9}=_0x2f2fd7[_0x21badb(0x18e)],_0xc6794c=await this[_0x21badb(0x1d3)]['findOne']({'where':{'id':_0x5c82c9}});if(!_0xc6794c||_0xc6794c[_0x21badb(0x1e0)])throw new common_1[(_0x21badb(0x202))]('已生成过邀请码、请勿重复生成',common_1['HttpStatus'][_0x21badb(0x1ab)]);const _0x1efab5=(0x0,utils_1[_0x21badb(0x226)])(),_0x9ccbad=await this['userEntity'][_0x21badb(0x1d8)]({'where':{'inviteCode':_0x1efab5}});if(_0x9ccbad)throw new common_1[(_0x21badb(0x202))](_0x21badb(0x21a),common_1['HttpStatus'][_0x21badb(0x1ab)]);const _0x123f3b=await this[_0x21badb(0x1d3)][_0x21badb(0x1fe)]({'id':_0x5c82c9},{'inviteCode':_0x1efab5});if(_0x123f3b[_0x21badb(0x20d)]<=0x0)throw new common_1[(_0x21badb(0x202))](_0x21badb(0x21a),common_1[_0x21badb(0x203)][_0x21badb(0x1ab)]);return _0x1efab5;}async[_0x5b9c58(0x193)](_0x19be3d,_0x37a958){const _0x56613d=_0x5b9c58;try{const {id:_0x2d5020}=_0x19be3d[_0x56613d(0x18e)],{page:page=0x1,size:size=0xa}=_0x37a958,_0x39037b=await this[_0x56613d(0x1d3)][_0x56613d(0x1d8)]({'where':{'id':_0x2d5020}}),{inviteCode:_0x224f81}=_0x39037b;if(!_0x224f81)return[];const [_0x14b925,_0x3913e]=await this[_0x56613d(0x1d3)][_0x56613d(0x1b4)]({'where':{'inviteCode':_0x224f81},'order':{'id':_0x56613d(0x1e7)},'select':[_0x56613d(0x1ae),_0x56613d(0x1dd),_0x56613d(0x194),_0x56613d(0x1d6),_0x56613d(0x1b9)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1['formatCreateOrUpdateDate'])(_0x14b925)[_0x56613d(0x213)](_0x4913ff=>{const _0x3030fe=_0x56613d;return _0x4913ff[_0x3030fe(0x1dd)]=(0x0,utils_1[_0x3030fe(0x1b6)])(_0x4913ff[_0x3030fe(0x1dd)]),_0x4913ff;}),{'rows':_0x14b925,'count':_0x3913e};}catch(_0x1653a9){console[_0x56613d(0x20e)](_0x56613d(0x215),_0x1653a9);throw new common_1[(_0x56613d(0x202))](_0x56613d(0x219),common_1[_0x56613d(0x203)][_0x56613d(0x1ab)]);}}async[_0x5b9c58(0x1fd)](_0x4af277){const _0x113665=_0x5b9c58,_0x4ad6c7=await this[_0x113665(0x1d3)][_0x113665(0x1d8)]({'where':{'inviteCode':_0x4af277}});if(!_0x4ad6c7)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x4ad6c7,_0x4a4f39=await this['userEntity']['update']({'inviteCode':_0x4af277},{'inviteLinkCount':inviteLinkCount+0x1});return _0x4a4f39[_0x113665(0x20d)]?0x1:0x0;}async[_0x5b9c58(0x1f1)](_0x25bbe0){const _0x38a93d=_0x5b9c58;return await this[_0x38a93d(0x1d3)]['findOne']({'where':{'inviteCode':_0x25bbe0}});}async['userRecharge'](_0x285d11){const _0x394058=_0x5b9c58,{userId:_0x4c4b88,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x285d11;await this[_0x394058(0x1b0)]['addBalanceToUser'](_0x4c4b88,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x447793=await this[_0x394058(0x1b0)][_0x394058(0x19d)]({'userId':_0x4c4b88,'rechargeType':balance_constant_1[_0x394058(0x1a0)][_0x394058(0x1b2)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x447793;}async[_0x5b9c58(0x1d5)](_0x448dd1,_0x2ad1da){const _0x26826d=_0x5b9c58,{page:page=0x1,size:size=0xa,username:_0x44ebc3,email:_0x9f191c,status:_0x44f203,keyword:_0x22b5cb,phone:_0x40c097}=_0x448dd1;let _0x3ddaf6={};_0x44ebc3&&Object[_0x26826d(0x208)](_0x3ddaf6,{'username':(0x0,typeorm_2[_0x26826d(0x228)])('%'+_0x44ebc3+'%')}),_0x9f191c&&Object['assign'](_0x3ddaf6,{'email':(0x0,typeorm_2['Like'])('%'+_0x9f191c+'%')}),_0x40c097&&Object['assign'](_0x3ddaf6,{'phone':(0x0,typeorm_2[_0x26826d(0x228)])('%'+_0x40c097+'%')}),_0x44f203&&Object[_0x26826d(0x208)](_0x3ddaf6,{'status':_0x44f203});_0x22b5cb&&(_0x3ddaf6=[{'username':(0x0,typeorm_2[_0x26826d(0x228)])('%'+_0x22b5cb+'%')},{'email':(0x0,typeorm_2['Like'])('%'+_0x22b5cb+'%')},{'phone':(0x0,typeorm_2[_0x26826d(0x228)])('%'+_0x22b5cb+'%')}]);const [_0x2c9ca6,_0x163b44]=await this[_0x26826d(0x1d3)][_0x26826d(0x1b4)]({'skip':(page-0x1)*size,'where':_0x3ddaf6,'take':size,'order':{'createdAt':_0x26826d(0x1e7)},'cache':!![],'select':[_0x26826d(0x1ae),_0x26826d(0x1b9),_0x26826d(0x1e0),_0x26826d(0x227),'sign','status','id',_0x26826d(0x1dd),_0x26826d(0x194),_0x26826d(0x1c7),'phone']}),_0x100b14=_0x2c9ca6['map'](_0x4fd664=>_0x4fd664['id']),_0x482d1d=await this[_0x26826d(0x1b0)][_0x26826d(0x1af)](_0x100b14);return _0x2c9ca6[_0x26826d(0x1ff)](_0x20de75=>_0x20de75[_0x26826d(0x1e1)]=_0x482d1d['find'](_0x55dc03=>_0x55dc03[_0x26826d(0x21c)]===_0x20de75['id'])),_0x2ad1da[_0x26826d(0x18e)][_0x26826d(0x227)]!==_0x26826d(0x1c2)&&_0x2c9ca6[_0x26826d(0x1ff)](_0x44e518=>_0x44e518['email']=(0x0,utils_1[_0x26826d(0x1b6)])(_0x44e518[_0x26826d(0x1dd)])),_0x2ad1da[_0x26826d(0x18e)]['role']!=='super'&&_0x2c9ca6[_0x26826d(0x1ff)](_0x18bb66=>_0x18bb66[_0x26826d(0x1c7)]=(0x0,utils_1[_0x26826d(0x1e4)])(_0x18bb66[_0x26826d(0x1c7)])),_0x2ad1da[_0x26826d(0x18e)][_0x26826d(0x227)]!=='super'&&_0x2c9ca6[_0x26826d(0x1ff)](_0x142135=>_0x142135[_0x26826d(0x1d0)]=(0x0,utils_1['maskIpAddress'])(_0x142135[_0x26826d(0x1d0)])),{'rows':_0x2c9ca6,'count':_0x163b44};}async['queryOne']({id:_0xf00eed}){const _0x46a246=_0x5b9c58;return await this['userEntity'][_0x46a246(0x1d8)]({'where':{'id':_0xf00eed},'select':[_0x46a246(0x1ae),'avatar',_0x46a246(0x1e0),_0x46a246(0x227),_0x46a246(0x1f7),_0x46a246(0x1d6)]});}async[_0x5b9c58(0x225)](_0x338e5f){const _0x2a656a=_0x5b9c58,{id:_0xe58379,status:_0x1254da}=_0x338e5f,_0x308651=await this[_0x2a656a(0x1d3)][_0x2a656a(0x1d8)]({'where':{'id':_0xe58379}});if(!_0x308651)throw new common_1[(_0x2a656a(0x202))](_0x2a656a(0x201),common_1[_0x2a656a(0x203)][_0x2a656a(0x1ab)]);if(_0x308651[_0x2a656a(0x227)]==='super')throw new common_1[(_0x2a656a(0x202))](_0x2a656a(0x20b),common_1[_0x2a656a(0x203)][_0x2a656a(0x1ab)]);if(_0x308651[_0x2a656a(0x1d6)]===user_constant_1[_0x2a656a(0x1fb)][_0x2a656a(0x212)])throw new common_1[(_0x2a656a(0x202))]('未激活用户不可手动变更状态！',common_1['HttpStatus']['BAD_REQUEST']);if(_0x308651['role']===_0x2a656a(0x1c2))throw new common_1[(_0x2a656a(0x202))](_0x2a656a(0x20b),common_1['HttpStatus']['BAD_REQUEST']);if(_0x1254da===user_constant_1['UserStatusEnum'][_0x2a656a(0x212)])throw new common_1[(_0x2a656a(0x202))]('不可将用户置为未激活状态！',common_1[_0x2a656a(0x203)]['BAD_REQUEST']);const _0x37dd2b=await this[_0x2a656a(0x1d3)][_0x2a656a(0x1fe)]({'id':_0xe58379},{'status':_0x1254da});if(_0x37dd2b[_0x2a656a(0x20d)]<=0x0)throw new common_1['HttpException'](_0x2a656a(0x189),common_1['HttpStatus'][_0x2a656a(0x1ab)]);return _0x2a656a(0x218);}async[_0x5b9c58(0x1b8)](_0x4d72fb){const _0x24b168=_0x5b9c58,{id:_0x59c527}=_0x4d72fb,_0x3df905=await this[_0x24b168(0x1d3)]['findOne']({'where':{'id':_0x59c527}});if(!_0x3df905)throw new common_1['HttpException'](_0x24b168(0x201),common_1[_0x24b168(0x203)][_0x24b168(0x1ab)]);const _0x2fd919=_0x24b168(0x214),_0x4b981d=bcrypt[_0x24b168(0x1d1)](_0x2fd919,0xa),_0x5b61bd=await this[_0x24b168(0x1d3)][_0x24b168(0x1fe)]({'id':_0x59c527},{'password':_0x4b981d});if(_0x5b61bd[_0x24b168(0x20d)]<=0x0)throw new common_1[(_0x24b168(0x202))](_0x24b168(0x1c0),common_1[_0x24b168(0x203)][_0x24b168(0x1ab)]);return _0x24b168(0x1f5)+_0x2fd919+_0x24b168(0x1a6);}async['savaLoginIp'](_0xa9673e,_0x261c8e){const _0x542ec9=_0x5b9c58;return await this[_0x542ec9(0x1d3)][_0x542ec9(0x1fe)]({'id':_0xa9673e},{'lastLoginIp':_0x261c8e});}async['getUserFromOpenId'](_0x1ab57a,_0x3579f3){const _0x4ae7c6=_0x5b9c58,_0x1ba125=await this[_0x4ae7c6(0x1d3)]['findOne']({'where':{'openId':_0x1ab57a}});if(!_0x1ba125){const _0x2d043f=_0x3579f3?_0x3579f3[_0x4ae7c6(0x1f3)](':')[0x1]:'',_0x54dce1=await this[_0x4ae7c6(0x1f1)](_0x2d043f),_0x5b0cdb=await this[_0x4ae7c6(0x21b)](_0x1ab57a,_0x2d043f);return await this[_0x4ae7c6(0x1b0)][_0x4ae7c6(0x22f)](_0x5b0cdb['id'],_0x2d043f?_0x54dce1===null||_0x54dce1===void 0x0?void 0x0:_0x54dce1['id']:null),_0x5b0cdb;}return _0x1ba125;}async['createUserFromOpenId'](_0x703ff4,_0x4c6267){const _0x333a06=_0x5b9c58,_0x1e98e3=await this['globalConfigService'][_0x333a06(0x200)]([_0x333a06(0x1f6)]),_0x5b8584={'avatar':_0x1e98e3,'username':'用户'+(0x0,utils_1[_0x333a06(0x19a)])(),'status':user_constant_1['UserStatusEnum'][_0x333a06(0x19b)],'sex':0x0,'email':(0x0,utils_1[_0x333a06(0x19a)])()+_0x333a06(0x1ce),'invitedBy':_0x4c6267,'openId':_0x703ff4},_0x54d403=await this[_0x333a06(0x1d3)][_0x333a06(0x19f)](_0x5b8584);return _0x54d403;}async[_0x5b9c58(0x1ad)](_0x23e4d2,_0x43c001){const _0x44302e=_0x5b9c58;try{const _0x465ee8=await this[_0x44302e(0x1d3)][_0x44302e(0x1d8)]({'where':{'id':_0x43c001}});if(!_0x465ee8)return{'status':![],'msg':_0x44302e(0x1b1)};const _0x1afe77=await this[_0x44302e(0x1d3)][_0x44302e(0x1d8)]({'where':{'openId':_0x23e4d2}});if(_0x1afe77)return{'status':![],'msg':_0x44302e(0x1d4)};const _0x1bd17f=await this[_0x44302e(0x1d3)][_0x44302e(0x1fe)]({'id':_0x43c001},{'openId':_0x23e4d2});if(_0x1bd17f['affected']<=0x0)return{'status':![],'msg':_0x44302e(0x1d9)};return{'status':!![],'msg':_0x44302e(0x1cf)};}catch(_0x57ec4e){return{'status':![],'msg':_0x44302e(0x1d9)};}}async[_0x5b9c58(0x1e2)](_0x1fed45){const _0x2a86a4=_0x5b9c58,_0x43124e=await this[_0x2a86a4(0x1d3)][_0x2a86a4(0x1d8)]({'where':{'id':_0x1fed45}});return _0x43124e===null||_0x43124e===void 0x0?void 0x0:_0x43124e['openId'];}async['verifyUserRegisterByPhone'](_0x11ce1e){const _0x8d9898=_0x5b9c58,{username:_0x478d36,password:_0x306d2f,phone:_0x2ef94b,phoneCode:_0x47f34a}=_0x11ce1e,_0x49ffd0=await this[_0x8d9898(0x1d3)][_0x8d9898(0x1d8)]({'where':[{'username':_0x478d36},{'phone':_0x2ef94b}]});if(_0x49ffd0&&_0x49ffd0['username']===_0x478d36)throw new common_1[(_0x8d9898(0x202))](_0x8d9898(0x205),common_1[_0x8d9898(0x203)][_0x8d9898(0x1ab)]);if(_0x49ffd0&&_0x49ffd0[_0x8d9898(0x1d0)]===_0x2ef94b)throw new common_1[(_0x8d9898(0x202))]('当前手机号已注册、请勿重复注册！',common_1[_0x8d9898(0x203)]['BAD_REQUEST']);}async['createUser'](_0x2afc8f){const _0x283cd=_0x5b9c58;return await this[_0x283cd(0x1d3)][_0x283cd(0x19f)](_0x2afc8f);}};UserService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x5b9c58(0x1f2)])(user_entity_1[_0x5b9c58(0x209)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1[_0x5b9c58(0x1a8)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x5b9c58(0x22d)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x5b9c58(0x22b)],typeorm_2[_0x5b9c58(0x1f4)],verification_service_1[_0x5b9c58(0x222)],mailer_1[_0x5b9c58(0x1f9)],userBalance_service_1[_0x5b9c58(0x1e5)],globalConfig_service_1['GlobalConfigService'],typeorm_2[_0x5b9c58(0x22b)]])],UserService),exports[_0x5b9c58(0x211)]=UserService;