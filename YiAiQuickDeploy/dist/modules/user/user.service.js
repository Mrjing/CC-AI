'use strict';const _0x5c6cd8=_0x4857;(function(_0xb1ee,_0x40cb63){const _0x3b8347=_0x4857,_0x7ff82=_0xb1ee();while(!![]){try{const _0x4b4903=parseInt(_0x3b8347(0x12b))/0x1+-parseInt(_0x3b8347(0xb4))/0x2*(-parseInt(_0x3b8347(0x107))/0x3)+-parseInt(_0x3b8347(0xcd))/0x4*(parseInt(_0x3b8347(0xd8))/0x5)+parseInt(_0x3b8347(0x116))/0x6+parseInt(_0x3b8347(0xd4))/0x7*(-parseInt(_0x3b8347(0xe3))/0x8)+parseInt(_0x3b8347(0xc3))/0x9*(parseInt(_0x3b8347(0x8c))/0xa)+parseInt(_0x3b8347(0x12e))/0xb*(-parseInt(_0x3b8347(0x89))/0xc);if(_0x4b4903===_0x40cb63)break;else _0x7ff82['push'](_0x7ff82['shift']());}catch(_0xee18d7){_0x7ff82['push'](_0x7ff82['shift']());}}}(_0x2ccb,0x1d0df));function _0x4857(_0x2f1d8b,_0x5aab42){const _0x2ccb32=_0x2ccb();return _0x4857=function(_0x4857af,_0x3f6103){_0x4857af=_0x4857af-0x82;let _0x9db06=_0x2ccb32[_0x4857af];return _0x9db06;},_0x4857(_0x2f1d8b,_0x5aab42);}var __decorate=this&&this['__decorate']||function(_0x2dff04,_0x2c6972,_0x563be2,_0xeff946){const _0x1258c5=_0x4857;var _0x14863d=arguments[_0x1258c5(0xcf)],_0x3e0de6=_0x14863d<0x3?_0x2c6972:_0xeff946===null?_0xeff946=Object[_0x1258c5(0xf7)](_0x2c6972,_0x563be2):_0xeff946,_0x502576;if(typeof Reflect===_0x1258c5(0x8e)&&typeof Reflect[_0x1258c5(0x109)]===_0x1258c5(0xe2))_0x3e0de6=Reflect[_0x1258c5(0x109)](_0x2dff04,_0x2c6972,_0x563be2,_0xeff946);else{for(var _0x49bbf0=_0x2dff04['length']-0x1;_0x49bbf0>=0x0;_0x49bbf0--)if(_0x502576=_0x2dff04[_0x49bbf0])_0x3e0de6=(_0x14863d<0x3?_0x502576(_0x3e0de6):_0x14863d>0x3?_0x502576(_0x2c6972,_0x563be2,_0x3e0de6):_0x502576(_0x2c6972,_0x563be2))||_0x3e0de6;}return _0x14863d>0x3&&_0x3e0de6&&Object['defineProperty'](_0x2c6972,_0x563be2,_0x3e0de6),_0x3e0de6;},__metadata=this&&this[_0x5c6cd8(0xe5)]||function(_0xc6c58a,_0x1f8b8d){const _0x163970=_0x5c6cd8;if(typeof Reflect===_0x163970(0x8e)&&typeof Reflect[_0x163970(0x8a)]===_0x163970(0xe2))return Reflect[_0x163970(0x8a)](_0xc6c58a,_0x1f8b8d);},__param=this&&this[_0x5c6cd8(0xae)]||function(_0x15b804,_0x434474){return function(_0x2d7786,_0x3938bb){_0x434474(_0x2d7786,_0x3938bb,_0x15b804);};};Object['defineProperty'](exports,_0x5c6cd8(0x99),{'value':!![]}),exports[_0x5c6cd8(0xd7)]=void 0x0;const globalConfig_service_1=require(_0x5c6cd8(0x113)),user_constant_1=require(_0x5c6cd8(0x12a)),mailer_1=require(_0x5c6cd8(0xed)),verification_service_1=require(_0x5c6cd8(0x121)),common_1=require(_0x5c6cd8(0xa6)),typeorm_1=require(_0x5c6cd8(0xab)),typeorm_2=require(_0x5c6cd8(0xc0)),user_entity_1=require(_0x5c6cd8(0xef)),bcrypt=require(_0x5c6cd8(0x11f)),crypto=require(_0x5c6cd8(0xb8)),_=require(_0x5c6cd8(0xf2)),verification_constant_1=require(_0x5c6cd8(0xc8)),userBalance_service_1=require('../userBalance/userBalance.service'),utils_1=require('../../common/utils'),balance_constant_1=require(_0x5c6cd8(0xfb)),config_entity_1=require(_0x5c6cd8(0xaf)),whiteList_entity_1=require('../chatgpt/whiteList.entity');let UserService=class UserService{constructor(_0x3b9da2,_0x354b37,_0x5e751f,_0x31f1bc,_0x379d68,_0x4a732e,_0x2cf8e6,_0x364925){const _0x472c07=_0x5c6cd8;this[_0x472c07(0x106)]=_0x3b9da2,this['whiteListEntity']=_0x354b37,this[_0x472c07(0x10d)]=_0x5e751f,this['verificationService']=_0x31f1bc,this[_0x472c07(0xbd)]=_0x379d68,this[_0x472c07(0x85)]=_0x4a732e,this[_0x472c07(0xa8)]=_0x2cf8e6,this[_0x472c07(0x87)]=_0x364925;}async['createUserAndVerifycation'](_0x1ddf9f,_0x7432af){const _0x4daa00=_0x5c6cd8,{username:_0x4bde6e,email:_0x524eb8,password:_0x46eff4,invitedBy:_0x2df443,client:client=0x0}=_0x1ddf9f;if(_0x2df443){const _0x3c4bf8=await this[_0x4daa00(0x106)][_0x4daa00(0xe4)]({'where':{'inviteCode':_0x2df443}});if(!_0x3c4bf8)throw new common_1[(_0x4daa00(0xdf))](_0x4daa00(0x104),common_1[_0x4daa00(0xea)][_0x4daa00(0x130)]);}const _0xfbc6e=[{'username':_0x4bde6e},{'email':_0x524eb8}],_0x460a64=await this[_0x4daa00(0x106)][_0x4daa00(0xe4)]({'where':_0xfbc6e});if(_0x460a64&&_0x460a64['status']!==user_constant_1[_0x4daa00(0x97)][_0x4daa00(0xdb)])throw new common_1[(_0x4daa00(0xdf))](_0x4daa00(0xe6),common_1[_0x4daa00(0xea)][_0x4daa00(0x130)]);try{const _0x92c731=_['cloneDeep'](_0x1ddf9f),_0x1668c6=bcrypt[_0x4daa00(0x8d)](_0x46eff4,0xa),_0x27a4cb=(0x0,utils_1[_0x4daa00(0x11c)])(_0x7432af);_0x92c731['password']=_0x1668c6,_0x92c731[_0x4daa00(0x86)]=_0x27a4cb,_0x92c731[_0x4daa00(0xfc)]=client;let _0x431773;if(!_0x460a64){const _0x5aa5a7=await this[_0x4daa00(0xa8)][_0x4daa00(0x96)]([_0x4daa00(0x134)]);_0x92c731[_0x4daa00(0x131)]=_0x5aa5a7,_0x431773=await this[_0x4daa00(0x106)][_0x4daa00(0x114)](_0x92c731);}else _0x431773=_0x460a64;const _0x1c6c8f=await this[_0x4daa00(0x87)][_0x4daa00(0xda)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x4daa00(0x120),_0x4daa00(0x124),_0x4daa00(0xbf),_0x4daa00(0x84),_0x4daa00(0xba),_0x4daa00(0x12f)])}}),_0x11c16e=_0x1c6c8f['reduce']((_0x3dcb78,_0x1fc4c7)=>{const _0x36baeb=_0x4daa00;return _0x3dcb78[_0x1fc4c7[_0x36baeb(0xfd)]]=_0x1fc4c7['configVal'],_0x3dcb78;},{}),_0x2258f1=_0x11c16e[_0x4daa00(0x120)]?Number(_0x11c16e[_0x4daa00(0x120)]):0x1;if(_0x2258f1){const _0x350783=_0x11c16e[_0x4daa00(0x12f)]?Number(_0x11c16e[_0x4daa00(0x12f)]):0x1e*0x3c,_0x1483c5=await this[_0x4daa00(0xff)]['createVerification'](_0x431773,verification_constant_1[_0x4daa00(0x91)][_0x4daa00(0x94)],_0x350783),{code:_0xece8b6,email:_0x3cfd65,id:_0x469c48}=_0x1483c5,{registerVerifyEmailFrom:_0xafbd2b}=_0x11c16e;console[_0x4daa00(0x83)](_0x4daa00(0xec),_0x11c16e);const _0x46259f=await this[_0x4daa00(0xbd)]['sendMail']({'to':_0x3cfd65,'subject':'来自'+_0xafbd2b+_0x4daa00(0xe9),'template':_0x4daa00(0xc9),'context':Object[_0x4daa00(0xca)]({'baseUrl':_0x11c16e[_0x4daa00(0x124)],'code':_0xece8b6,'id':_0x469c48},_0x11c16e)});console[_0x4daa00(0x83)]('email\x20response\x20\x20->\x20:\x20',_0x46259f);}else{const {username:_0x1e07a4,email:_0x3137e5,id:_0x2f2586,invitedBy:_0x143856}=_0x431773;await this[_0x4daa00(0xf4)](_0x2f2586,user_constant_1['UserStatusEnum'][_0x4daa00(0x93)]);let _0x5902c1;_0x143856&&(_0x5902c1=await this['qureyUserInfoByInviteCode'](_0x143856)),await this[_0x4daa00(0x85)][_0x4daa00(0xb3)](_0x2f2586,_0x5902c1===null||_0x5902c1===void 0x0?void 0x0:_0x5902c1['id']);}return _0x431773;}catch(_0x38bf12){console['log'](_0x4daa00(0x10a),_0x38bf12);throw _0x38bf12;}}async[_0x5c6cd8(0xb6)](){const _0xb442b3=await this['userEntity']['findOne']({'where':{'role':'super'}});return _0xb442b3;}async['verifyUserCredentials'](_0x47b07a){const _0x1d2de3=_0x5c6cd8,{username:_0x1110c2,password:_0x2f9051,uid:uid=0x0,phone:_0x280646}=_0x47b07a;let _0x3386ca=null;if(uid>0x0){_0x3386ca=await this[_0x1d2de3(0x106)][_0x1d2de3(0xe4)]({'where':{'id':uid}});if(!_0x3386ca)throw new common_1[(_0x1d2de3(0xdf))](_0x1d2de3(0xa4),common_1[_0x1d2de3(0xea)]['BAD_REQUEST']);if(_0x3386ca[_0x1d2de3(0xe8)][_0x1d2de3(0xc6)](_0x1d2de3(0x82))||_0x3386ca['password'][_0x1d2de3(0xc6)](_0x1d2de3(0xb0))||_0x3386ca[_0x1d2de3(0xe8)][_0x1d2de3(0xc6)](_0x1d2de3(0x9b))){if(!bcrypt[_0x1d2de3(0xdc)](_0x2f9051,_0x3386ca[_0x1d2de3(0xe8)]))throw new common_1[(_0x1d2de3(0xdf))](_0x1d2de3(0xfe),common_1[_0x1d2de3(0xea)]['BAD_REQUEST']);}else{console['log'](_0x1d2de3(0xc7));const _0x1d55f6=crypto[_0x1d2de3(0xc1)](_0x1d2de3(0x117))[_0x1d2de3(0xe7)](_0x2f9051)[_0x1d2de3(0xde)](_0x1d2de3(0xc5));console[_0x1d2de3(0x83)]('----,',_0x1d55f6);if(_0x1d55f6!==_0x3386ca['password'])throw new common_1[(_0x1d2de3(0xdf))](_0x1d2de3(0xfe),common_1[_0x1d2de3(0xea)][_0x1d2de3(0x130)]);}}if(_0x1110c2&&_0x2f9051){const _0x1fdb13=[{'username':_0x1110c2},{'email':_0x1110c2}];_0x3386ca=await this[_0x1d2de3(0x106)][_0x1d2de3(0xe4)]({'where':_0x1fdb13});if(!_0x3386ca)throw new common_1[(_0x1d2de3(0xdf))](_0x1d2de3(0xa4),common_1[_0x1d2de3(0xea)][_0x1d2de3(0x130)]);if(_0x3386ca[_0x1d2de3(0xe8)][_0x1d2de3(0xc6)](_0x1d2de3(0x82))||_0x3386ca[_0x1d2de3(0xe8)][_0x1d2de3(0xc6)](_0x1d2de3(0xb0))||_0x3386ca[_0x1d2de3(0xe8)]['startsWith']('$2y$')){if(!bcrypt[_0x1d2de3(0xdc)](_0x2f9051,_0x3386ca['password']))throw new common_1[(_0x1d2de3(0xdf))](_0x1d2de3(0xfe),common_1[_0x1d2de3(0xea)][_0x1d2de3(0x130)]);}else{console[_0x1d2de3(0x83)](_0x1d2de3(0xc7));const _0x31fb7f=crypto[_0x1d2de3(0xc1)](_0x1d2de3(0x117))[_0x1d2de3(0xe7)](_0x2f9051)['digest']('hex');console[_0x1d2de3(0x83)]('----,',_0x31fb7f);if(_0x31fb7f!==_0x3386ca[_0x1d2de3(0xe8)])throw new common_1[(_0x1d2de3(0xdf))](_0x1d2de3(0xfe),common_1['HttpStatus'][_0x1d2de3(0x130)]);}}if(_0x280646&&_0x2f9051){const _0x246435=[{'phone':_0x280646}];_0x3386ca=await this['userEntity'][_0x1d2de3(0xe4)]({'where':_0x246435});if(!_0x3386ca)throw new common_1[(_0x1d2de3(0xdf))](_0x1d2de3(0xa4),common_1[_0x1d2de3(0xea)][_0x1d2de3(0x130)]);if(_0x3386ca[_0x1d2de3(0xe8)]['startsWith']('$2a$')||_0x3386ca['password'][_0x1d2de3(0xc6)]('$2b$')||_0x3386ca['password'][_0x1d2de3(0xc6)](_0x1d2de3(0x9b))){if(!bcrypt['compareSync'](_0x2f9051,_0x3386ca['password']))throw new common_1['HttpException'](_0x1d2de3(0xfe),common_1['HttpStatus'][_0x1d2de3(0x130)]);}else{console[_0x1d2de3(0x83)](_0x1d2de3(0xc7));const _0x44358c=crypto['createHash'](_0x1d2de3(0x117))['update'](_0x2f9051)[_0x1d2de3(0xde)](_0x1d2de3(0xc5));console[_0x1d2de3(0x83)](_0x1d2de3(0xc7),_0x44358c);if(_0x44358c!==_0x3386ca['password'])throw new common_1[(_0x1d2de3(0xdf))](_0x1d2de3(0xfe),common_1[_0x1d2de3(0xea)][_0x1d2de3(0x130)]);}}if(!_0x3386ca)throw new common_1[(_0x1d2de3(0xdf))](_0x1d2de3(0xa4),common_1['HttpStatus']['BAD_REQUEST']);if(_0x3386ca[_0x1d2de3(0x102)]!==user_constant_1['UserStatusEnum']['ACTIVE'])throw new common_1['HttpException'](user_constant_1['UserStatusErrMsg'][_0x3386ca[_0x1d2de3(0x102)]],common_1[_0x1d2de3(0xea)][_0x1d2de3(0x130)]);return _0x3386ca;}async['verifyUserPassword'](_0x465b55,_0x2642ef){const _0x16ca95=_0x5c6cd8,_0x38b5f7=await this[_0x16ca95(0x106)][_0x16ca95(0xe4)]({'where':{'id':_0x465b55}});if(_0x38b5f7[_0x16ca95(0xe8)][_0x16ca95(0xc6)](_0x16ca95(0x82))||_0x38b5f7['password'][_0x16ca95(0xc6)](_0x16ca95(0xb0))||_0x38b5f7['password'][_0x16ca95(0xc6)]('$2y$'))return bcrypt[_0x16ca95(0xdc)](_0x2642ef,_0x38b5f7['password']);else{const _0x5a09f3=crypto[_0x16ca95(0xc1)](_0x16ca95(0x117))[_0x16ca95(0xe7)](_0x2642ef)[_0x16ca95(0xde)]('hex');return console['log'](_0x16ca95(0xc7),_0x5a09f3),_0x5a09f3===_0x38b5f7[_0x16ca95(0xe8)];}}async[_0x5c6cd8(0xf4)](_0x4354f5,_0x7d30e3){const _0x4425e1=_0x5c6cd8,_0xf52d2=await this['userEntity'][_0x4425e1(0xe7)]({'id':_0x4354f5},{'status':_0x7d30e3});return _0xf52d2[_0x4425e1(0xe1)]>0x0;}async[_0x5c6cd8(0xcb)](_0x22fb41){const _0xf21154=_0x5c6cd8,_0x329b51=await this[_0xf21154(0x106)][_0xf21154(0xe4)]({'where':{'id':_0x22fb41}});return _0x329b51[_0xf21154(0x102)];}async['queryUserInfoById'](_0x59e76b){const _0x1eccd3=_0x5c6cd8;return await this['userEntity'][_0x1eccd3(0xe4)]({'where':{'id':_0x59e76b}});}async['queryOneUserInfo'](_0x4e4654){return await this['userEntity']['findOne']({'where':{'id':_0x4e4654}});}async['checkUserStatus'](_0x4da005){const _0x31098a=_0x5c6cd8,{id:_0x27c608,role:_0x5d25fb}=_0x4da005;if(_0x5d25fb===_0x31098a(0xee))return!![];const _0x5e3f5d=await this['userEntity'][_0x31098a(0xe4)]({'where':{'id':_0x27c608}});if(!_0x5e3f5d)throw new common_1[(_0x31098a(0xdf))]('当前用户信息失效、请重新登录！',common_1['HttpStatus']['UNAUTHORIZED']);if(_0x5e3f5d['status']===user_constant_1['UserStatusEnum'][_0x31098a(0x125)])throw new common_1['HttpException'](_0x31098a(0x10f),common_1[_0x31098a(0xea)]['BAD_REQUEST']);if(_0x5e3f5d[_0x31098a(0x102)]===user_constant_1[_0x31098a(0x97)]['LOCKED'])throw new common_1[(_0x31098a(0xdf))](_0x31098a(0xeb),common_1[_0x31098a(0xea)][_0x31098a(0x130)]);}async[_0x5c6cd8(0xb9)](_0xe6635c){const _0x4493a=_0x5c6cd8,_0x65ee21=await this[_0x4493a(0x106)][_0x4493a(0xe4)]({'where':{'id':_0xe6635c},'select':[_0x4493a(0x8b),_0x4493a(0x131),_0x4493a(0x115),'email','sign','inviteCode',_0x4493a(0x129),_0x4493a(0xb1)]});if(!_0x65ee21)throw new common_1[(_0x4493a(0xdf))](_0x4493a(0x11e),common_1['HttpStatus'][_0x4493a(0xa1)]);_0x65ee21[_0x4493a(0x12c)]=!!(_0x65ee21===null||_0x65ee21===void 0x0?void 0x0:_0x65ee21[_0x4493a(0x129)]),delete _0x65ee21[_0x4493a(0x129)];const _0x566dba=await this[_0x4493a(0x85)]['queryUserBalance'](_0xe6635c);return{'userInfo':_0x65ee21,'userBalance':Object[_0x4493a(0xca)]({},_0x566dba)};}async[_0x5c6cd8(0x12d)](_0x5085fd){const _0x3d3557=_0x5c6cd8;return await this[_0x3d3557(0x106)][_0x3d3557(0xe4)]({'where':{'id':_0x5085fd}});}async[_0x5c6cd8(0xb2)](_0x27982e){const _0x50dae3=_0x5c6cd8;return await this[_0x50dae3(0x106)]['findOne']({'where':{'openId':_0x27982e}});}async['updateInfo'](_0xbda805,_0x44db80){const _0x29d0cd=_0x5c6cd8,{id:_0x592c61}=_0x44db80[_0x29d0cd(0xd1)],_0x35c8ea=await this[_0x29d0cd(0x106)][_0x29d0cd(0xe4)]({'where':{'id':_0x592c61}});if(!_0x35c8ea)throw new common_1['HttpException'](_0x29d0cd(0x133),common_1[_0x29d0cd(0xea)]['BAD_REQUEST']);if(_0xbda805[_0x29d0cd(0x8b)]&&_0x35c8ea[_0x29d0cd(0x8b)]===_0xbda805[_0x29d0cd(0x8b)])throw new common_1[(_0x29d0cd(0xdf))](_0x29d0cd(0xdd),common_1[_0x29d0cd(0xea)]['BAD_REQUEST']);if(_0xbda805[_0x29d0cd(0x8b)]){const _0x706268=await this['userEntity'][_0x29d0cd(0xe4)]({'where':{'username':_0xbda805[_0x29d0cd(0x8b)],'id':(0x0,typeorm_2[_0x29d0cd(0xbb)])(_0x592c61)}});if(_0x706268)throw new common_1[(_0x29d0cd(0xdf))](_0x29d0cd(0x127),common_1[_0x29d0cd(0xea)][_0x29d0cd(0x130)]);}const _0x227363=await this['userEntity']['update']({'id':_0x592c61},_0xbda805);if(_0x227363[_0x29d0cd(0xe1)]<=0x0)throw new common_1[(_0x29d0cd(0xdf))](_0x29d0cd(0x9e),common_1[_0x29d0cd(0xea)][_0x29d0cd(0x130)]);return _0x29d0cd(0x112);}async[_0x5c6cd8(0xa7)](_0x29d944,_0x34f807){const _0x5b2da5=_0x5c6cd8,_0x336413=bcrypt[_0x5b2da5(0x8d)](_0x34f807,0xa),_0x161033=await this[_0x5b2da5(0x106)][_0x5b2da5(0xe7)]({'id':_0x29d944},{'password':_0x336413});if(_0x161033[_0x5b2da5(0xe1)]<=0x0)throw new common_1[(_0x5b2da5(0xdf))]('修改密码失败、请重新试试吧。',common_1[_0x5b2da5(0xea)][_0x5b2da5(0x130)]);}async[_0x5c6cd8(0xf5)](_0x28298e){const _0x609f70=_0x5c6cd8,{id:_0x2a1dd2}=_0x28298e[_0x609f70(0xd1)],_0x58a78f=await this[_0x609f70(0x106)][_0x609f70(0xe4)]({'where':{'id':_0x2a1dd2}});if(!_0x58a78f||_0x58a78f[_0x609f70(0xc4)])throw new common_1['HttpException'](_0x609f70(0x122),common_1[_0x609f70(0xea)][_0x609f70(0x130)]);const _0x597547=(0x0,utils_1[_0x609f70(0xf6)])(),_0x1c3b6f=await this[_0x609f70(0x106)]['findOne']({'where':{'inviteCode':_0x597547}});if(_0x1c3b6f)throw new common_1[(_0x609f70(0xdf))](_0x609f70(0xcc),common_1[_0x609f70(0xea)]['BAD_REQUEST']);const _0x3cd6fc=await this['userEntity'][_0x609f70(0xe7)]({'id':_0x2a1dd2},{'inviteCode':_0x597547});if(_0x3cd6fc[_0x609f70(0xe1)]<=0x0)throw new common_1['HttpException'](_0x609f70(0xcc),common_1[_0x609f70(0xea)][_0x609f70(0x130)]);return _0x597547;}async[_0x5c6cd8(0x105)](_0x5970,_0x5a0774){const _0x341d2f=_0x5c6cd8;try{const {id:_0x248f78}=_0x5970[_0x341d2f(0xd1)],{page:page=0x1,size:size=0xa}=_0x5a0774,_0x49bf27=await this['userEntity'][_0x341d2f(0xe4)]({'where':{'id':_0x248f78}}),{inviteCode:_0x356d46}=_0x49bf27;if(!_0x356d46)return[];const [_0x217778,_0x2ccc3f]=await this[_0x341d2f(0x106)][_0x341d2f(0xaa)]({'where':{'inviteCode':_0x356d46},'order':{'id':_0x341d2f(0xa9)},'select':['username',_0x341d2f(0xd6),'createdAt','status','avatar'],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x341d2f(0xf9)])(_0x217778)['map'](_0x4ccbc1=>{const _0x4c72b1=_0x341d2f;return _0x4ccbc1[_0x4c72b1(0xd6)]=(0x0,utils_1[_0x4c72b1(0x132)])(_0x4ccbc1['email']),_0x4ccbc1;}),{'rows':_0x217778,'count':_0x2ccc3f};}catch(_0x1bcd19){console[_0x341d2f(0x83)]('error:\x20',_0x1bcd19);throw new common_1[(_0x341d2f(0xdf))](_0x341d2f(0xc2),common_1[_0x341d2f(0xea)][_0x341d2f(0x130)]);}}async[_0x5c6cd8(0x100)](_0x445694){const _0x5ce53a=_0x5c6cd8,_0x1e3b27=await this[_0x5ce53a(0x106)]['findOne']({'where':{'inviteCode':_0x445694}});if(!_0x1e3b27)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x1e3b27,_0x117379=await this[_0x5ce53a(0x106)][_0x5ce53a(0xe7)]({'inviteCode':_0x445694},{'inviteLinkCount':inviteLinkCount+0x1});return _0x117379[_0x5ce53a(0xe1)]?0x1:0x0;}async[_0x5c6cd8(0x108)](_0x4af899){const _0x14c882=_0x5c6cd8;return await this['userEntity'][_0x14c882(0xe4)]({'where':{'inviteCode':_0x4af899}});}async['userRecharge'](_0x4c869c){const _0x11a162=_0x5c6cd8,{userId:_0x21296b,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4c869c;await this[_0x11a162(0x85)]['addBalanceToUser'](_0x21296b,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x75a87c=await this[_0x11a162(0x85)][_0x11a162(0xbe)]({'userId':_0x21296b,'rechargeType':balance_constant_1[_0x11a162(0xa5)][_0x11a162(0x95)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x75a87c;}async[_0x5c6cd8(0x111)](_0x2e458b,_0x6bf5b5){const _0x45ecee=_0x5c6cd8,{page:page=0x1,size:size=0xa,username:_0x7a005a,email:_0x294619,status:_0x450782,keyword:_0x3e1a1a,phone:_0x2f03db}=_0x2e458b;let _0x3896a7={};_0x7a005a&&Object[_0x45ecee(0xca)](_0x3896a7,{'username':(0x0,typeorm_2[_0x45ecee(0x101)])('%'+_0x7a005a+'%')}),_0x294619&&Object['assign'](_0x3896a7,{'email':(0x0,typeorm_2[_0x45ecee(0x101)])('%'+_0x294619+'%')}),_0x2f03db&&Object[_0x45ecee(0xca)](_0x3896a7,{'phone':(0x0,typeorm_2[_0x45ecee(0x101)])('%'+_0x2f03db+'%')}),_0x450782&&Object['assign'](_0x3896a7,{'status':_0x450782});_0x3e1a1a&&(_0x3896a7=[{'username':(0x0,typeorm_2['Like'])('%'+_0x3e1a1a+'%')},{'email':(0x0,typeorm_2['Like'])('%'+_0x3e1a1a+'%')},{'phone':(0x0,typeorm_2['Like'])('%'+_0x3e1a1a+'%')}]);const [_0x2d5351,_0x522e85]=await this[_0x45ecee(0x106)][_0x45ecee(0xaa)]({'skip':(page-0x1)*size,'where':_0x3896a7,'take':size,'order':{'createdAt':_0x45ecee(0xa9)},'cache':!![],'select':[_0x45ecee(0x8b),_0x45ecee(0x131),_0x45ecee(0xc4),_0x45ecee(0x115),_0x45ecee(0x110),'status','id',_0x45ecee(0xd6),_0x45ecee(0x126),_0x45ecee(0x9d),_0x45ecee(0xd3)]}),_0x34df4e=_0x2d5351[_0x45ecee(0xf1)](_0x29dc4a=>_0x29dc4a['id']),_0x13d2fa=await this[_0x45ecee(0x85)][_0x45ecee(0xa3)](_0x34df4e);return _0x2d5351[_0x45ecee(0x8f)](_0x4637b9=>_0x4637b9[_0x45ecee(0xce)]=_0x13d2fa['find'](_0x9c8a00=>_0x9c8a00[_0x45ecee(0x11b)]===_0x4637b9['id'])),_0x6bf5b5['user'][_0x45ecee(0x115)]!==_0x45ecee(0xad)&&_0x2d5351[_0x45ecee(0x8f)](_0x583b28=>_0x583b28[_0x45ecee(0xd6)]=(0x0,utils_1[_0x45ecee(0x132)])(_0x583b28[_0x45ecee(0xd6)])),_0x6bf5b5[_0x45ecee(0xd1)]['role']!==_0x45ecee(0xad)&&_0x2d5351[_0x45ecee(0x8f)](_0x52198f=>_0x52198f[_0x45ecee(0x9d)]=(0x0,utils_1[_0x45ecee(0x123)])(_0x52198f[_0x45ecee(0x9d)])),_0x6bf5b5[_0x45ecee(0xd1)]['role']!==_0x45ecee(0xad)&&_0x2d5351[_0x45ecee(0x8f)](_0x42b8c0=>_0x42b8c0['phone']=(0x0,utils_1[_0x45ecee(0x123)])(_0x42b8c0['phone'])),{'rows':_0x2d5351,'count':_0x522e85};}async[_0x5c6cd8(0xe0)]({id:_0x220d67}){const _0x15559c=_0x5c6cd8;return await this[_0x15559c(0x106)][_0x15559c(0xe4)]({'where':{'id':_0x220d67},'select':[_0x15559c(0x8b),'avatar',_0x15559c(0xc4),'role',_0x15559c(0x110),_0x15559c(0x102)]});}async['updateStatus'](_0x3f6bfb){const _0x431435=_0x5c6cd8,{id:_0x1b6984,status:_0x260d40}=_0x3f6bfb,_0x3f3a09=await this['userEntity']['findOne']({'where':{'id':_0x1b6984}});if(!_0x3f3a09)throw new common_1[(_0x431435(0xdf))](_0x431435(0x9a),common_1[_0x431435(0xea)][_0x431435(0x130)]);if(_0x3f3a09[_0x431435(0x115)]==='super')throw new common_1['HttpException']('超级管理员不可被操作！',common_1[_0x431435(0xea)][_0x431435(0x130)]);if(_0x3f3a09[_0x431435(0x102)]===user_constant_1[_0x431435(0x97)][_0x431435(0xdb)])throw new common_1['HttpException'](_0x431435(0x128),common_1[_0x431435(0xea)][_0x431435(0x130)]);if(_0x3f3a09['role']===_0x431435(0xad))throw new common_1['HttpException'](_0x431435(0xb7),common_1[_0x431435(0xea)][_0x431435(0x130)]);if(_0x260d40===user_constant_1['UserStatusEnum']['PENDING'])throw new common_1[(_0x431435(0xdf))]('不可将用户置为未激活状态！',common_1['HttpStatus']['BAD_REQUEST']);const _0x26222e=await this[_0x431435(0x106)][_0x431435(0xe7)]({'id':_0x1b6984},{'status':_0x260d40});if(_0x26222e[_0x431435(0xe1)]<=0x0)throw new common_1[(_0x431435(0xdf))]('修改用户状态失败！',common_1['HttpStatus'][_0x431435(0x130)]);return _0x431435(0xa0);}async['resetUserPass'](_0x352aff){const _0x5494af=_0x5c6cd8,{id:_0x335027}=_0x352aff,_0x2281b8=await this[_0x5494af(0x106)][_0x5494af(0xe4)]({'where':{'id':_0x335027}});if(!_0x2281b8)throw new common_1[(_0x5494af(0xdf))]('用户不存在！',common_1['HttpStatus'][_0x5494af(0x130)]);const _0xd56ab3=_0x5494af(0xac),_0x54d5a4=bcrypt[_0x5494af(0x8d)](_0xd56ab3,0xa),_0x78c8d9=await this['userEntity'][_0x5494af(0xe7)]({'id':_0x335027},{'password':_0x54d5a4});if(_0x78c8d9['affected']<=0x0)throw new common_1[(_0x5494af(0xdf))](_0x5494af(0x90),common_1[_0x5494af(0xea)][_0x5494af(0x130)]);return'密码重置为['+_0xd56ab3+_0x5494af(0x10b);}async[_0x5c6cd8(0xd9)](_0x4b1adc,_0x3ea9b6){const _0x44729b=_0x5c6cd8;return await this[_0x44729b(0x106)][_0x44729b(0xe7)]({'id':_0x4b1adc},{'lastLoginIp':_0x3ea9b6});}async[_0x5c6cd8(0x88)](_0x5501e7,_0x3df947){const _0x1dc5e8=_0x5c6cd8,_0x350edb=await this['userEntity'][_0x1dc5e8(0xe4)]({'where':{'openId':_0x5501e7}});if(!_0x350edb){const _0x44cf99=_0x3df947?_0x3df947[_0x1dc5e8(0xd5)](':')[0x1]:'',_0x46ccdf=await this['qureyUserInfoByInviteCode'](_0x44cf99),_0x3c1587=await this['createUserFromOpenId'](_0x5501e7,_0x44cf99);return await this[_0x1dc5e8(0x85)][_0x1dc5e8(0xb3)](_0x3c1587['id'],_0x44cf99?_0x46ccdf===null||_0x46ccdf===void 0x0?void 0x0:_0x46ccdf['id']:null),_0x3c1587;}return _0x350edb;}async[_0x5c6cd8(0xd2)](_0x2fbfb4,_0x1ae8fe){const _0x263eaa=_0x5c6cd8,_0x2980d8=await this[_0x263eaa(0xa8)][_0x263eaa(0x96)](['userDefautlAvatar']),_0x682f9a={'avatar':_0x2980d8,'username':'用户'+(0x0,utils_1['createRandomUid'])(),'status':user_constant_1[_0x263eaa(0x97)][_0x263eaa(0x93)],'sex':0x0,'email':(0x0,utils_1[_0x263eaa(0x10e)])()+'@default.com','invitedBy':_0x1ae8fe,'openId':_0x2fbfb4},_0x4a19f9=await this[_0x263eaa(0x106)][_0x263eaa(0x114)](_0x682f9a);return _0x4a19f9;}async[_0x5c6cd8(0x10c)](_0x53e42b,_0x3a8ae6){const _0x4e8688=_0x5c6cd8;try{const _0x27469a=await this[_0x4e8688(0x106)]['findOne']({'where':{'id':_0x3a8ae6}});if(!_0x27469a)return{'status':![],'msg':_0x4e8688(0xa2)};const _0x5e4f82=await this['userEntity'][_0x4e8688(0xe4)]({'where':{'openId':_0x53e42b}});if(_0x5e4f82)return{'status':![],'msg':_0x4e8688(0xfa)};const _0x165841=await this['userEntity'][_0x4e8688(0xe7)]({'id':_0x3a8ae6},{'openId':_0x53e42b});if(_0x165841[_0x4e8688(0xe1)]<=0x0)return{'status':![],'msg':_0x4e8688(0x103)};return{'status':!![],'msg':'恭喜您绑定成功、后续可直接扫码登录了！'};}catch(_0x1fbe36){return{'status':![],'msg':_0x4e8688(0x103)};}}async[_0x5c6cd8(0x9c)](_0x8dff83){const _0x53eed7=_0x5c6cd8,_0x3fedd1=await this['userEntity']['findOne']({'where':{'id':_0x8dff83}});return _0x3fedd1===null||_0x3fedd1===void 0x0?void 0x0:_0x3fedd1[_0x53eed7(0x129)];}async['verifyUserRegisterByPhone'](_0x41612b){const _0x30b09e=_0x5c6cd8,{username:_0x52dfbe,password:_0x3dfd63,phone:_0x33ded0,phoneCode:_0x39994e}=_0x41612b,_0x4402ae=await this[_0x30b09e(0x106)][_0x30b09e(0xe4)]({'where':[{'username':_0x52dfbe},{'phone':_0x33ded0}]});if(_0x4402ae&&_0x4402ae[_0x30b09e(0x8b)]===_0x52dfbe)throw new common_1['HttpException'](_0x30b09e(0xd0),common_1['HttpStatus'][_0x30b09e(0x130)]);if(_0x4402ae&&_0x4402ae['phone']===_0x33ded0)throw new common_1[(_0x30b09e(0xdf))]('当前手机号已注册、请勿重复注册！',common_1[_0x30b09e(0xea)][_0x30b09e(0x130)]);}async[_0x5c6cd8(0x98)](_0x54190b){const _0x5bb02a=_0x5c6cd8;return await this['userEntity'][_0x5bb02a(0x114)](_0x54190b);}};UserService=__decorate([(0x0,common_1[_0x5c6cd8(0x118)])(),__param(0x0,(0x0,typeorm_1[_0x5c6cd8(0x11d)])(user_entity_1[_0x5c6cd8(0x119)])),__param(0x1,(0x0,typeorm_1[_0x5c6cd8(0x11d)])(whiteList_entity_1[_0x5c6cd8(0x92)])),__param(0x7,(0x0,typeorm_1[_0x5c6cd8(0x11d)])(config_entity_1[_0x5c6cd8(0x11a)])),__metadata(_0x5c6cd8(0xf0),[typeorm_2[_0x5c6cd8(0xf3)],typeorm_2[_0x5c6cd8(0xf3)],typeorm_2[_0x5c6cd8(0xb5)],verification_service_1[_0x5c6cd8(0xf8)],mailer_1[_0x5c6cd8(0xbc)],userBalance_service_1[_0x5c6cd8(0x9f)],globalConfig_service_1[_0x5c6cd8(0x135)],typeorm_2['Repository']])],UserService),exports[_0x5c6cd8(0xd7)]=UserService;function _0x2ccb(){const _0x484798=['Connection','getSuper','超级管理员不可被操作！','crypto','getUserInfo','registerVerifyEmailFrom','Not','MailerService','mailerService','saveRecordRechargeLog','registerVerifyEmailTitle','typeorm','createHash','获取邀请记录失败！','9UBjsjh','inviteCode','hex','startsWith','----,','../../common/constants/verification.constant','register','assign','getUserStatus','生成邀请码失败，请重新试一次吧！','291792nUiwIY','balanceInfo','length','用户名已存在、请更换用户名！','user','createUserFromOpenId','phone','7QjlLkl','split','email','UserService','5mPITmq','savaLoginIp','find','PENDING','compareSync','没有变更，无需更改！','digest','HttpException','queryOne','affected','function','2856RtncQv','findOne','__metadata','用户名或者邮箱已被注册！','update','password','的账号激活','HttpStatus','您的账户已被封禁、如有疑问、请联系管理员！','configMap:\x20','@nestjs-modules/mailer','visitor','./user.entity','design:paramtypes','map','lodash','Repository','updateUserStatus','genInviteCode','generateRandomString','getOwnPropertyDescriptor','VerificationService','formatCreateOrUpdateDate','该微信已绑定其他账号！','../../common/constants/balance.constant','client','configKey','当前密码错误！','verificationService','inviteLink','Like','status','绑定微信失败、请联系管理员！','无效的邀请码！','getInviteRecord','userEntity','3657ImsrwV','qureyUserInfoByInviteCode','decorate','error:\x20',']成功!','bindWx','connection','createRandomUid','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','sign','queryAll','修改用户信息成功！','../globalConfig/globalConfig.service','save','role','1412448KQLJtx','md5','Injectable','UserEntity','ConfigEntity','userId','getClientIp','InjectRepository','当前用户信息失效、请重新登录！','bcryptjs','isVerifyEmail','../verification/verification.service','已生成过邀请码、请勿重复生成','maskIpAddress','registerBaseUrl','BLACKLISTED','createdAt','用户名已存在！','未激活用户不可手动变更状态！','openId','../../common/constants/user.constant','218363ORWUiv','isBindWx','getUserById','88qSFlWW','registerVerifyExpir','BAD_REQUEST','avatar','maskEmail','当前用户不存在！','userDefautlAvatar','GlobalConfigService','$2a$','log','registerVerifyEmailDesc','userBalanceService','registerIp','configEntity','getUserFromOpenId','764568sLubyc','metadata','username','1580470yuPGOY','hashSync','object','forEach','重置密码失败！','VerificationEnum','WhiteListEntity','ACTIVE','Registration','ADMIN_GIFT','getConfigs','UserStatusEnum','createUser','__esModule','用户不存在！','$2y$','getOpenIdByUserId','lastLoginIp','修改用户信息失败！','UserBalanceService','修改用户状态成功！','UNAUTHORIZED','当前绑定用户不存在！','queryUserBalanceByIds','当前账户不存在！','RechargeType','@nestjs/common','updateUserPassword','globalConfigService','DESC','findAndCount','@nestjs/typeorm','123456','super','__param','../globalConfig/config.entity','$2b$','consecutiveDays','getUserOpenId','addBalanceToNewUser','148ByKLLv'];_0x2ccb=function(){return _0x484798;};return _0x2ccb();}