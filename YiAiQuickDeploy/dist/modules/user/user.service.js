'use strict';const _0x334499=_0x1594;(function(_0x320558,_0x9b3d44){const _0x2415f1=_0x1594,_0x1375d9=_0x320558();while(!![]){try{const _0x4ab582=-parseInt(_0x2415f1(0xe9))/0x1+parseInt(_0x2415f1(0x12d))/0x2+-parseInt(_0x2415f1(0x12f))/0x3*(parseInt(_0x2415f1(0xea))/0x4)+-parseInt(_0x2415f1(0x16c))/0x5+parseInt(_0x2415f1(0xdc))/0x6+parseInt(_0x2415f1(0x14b))/0x7+parseInt(_0x2415f1(0xd9))/0x8;if(_0x4ab582===_0x9b3d44)break;else _0x1375d9['push'](_0x1375d9['shift']());}catch(_0x16f4b4){_0x1375d9['push'](_0x1375d9['shift']());}}}(_0x5831,0xa7b89));var __decorate=this&&this[_0x334499(0x101)]||function(_0x53da31,_0x23243a,_0x574428,_0x48a493){const _0x31a530=_0x334499;var _0x3cee12=arguments['length'],_0x3f7d23=_0x3cee12<0x3?_0x23243a:_0x48a493===null?_0x48a493=Object[_0x31a530(0x117)](_0x23243a,_0x574428):_0x48a493,_0x325191;if(typeof Reflect===_0x31a530(0xf0)&&typeof Reflect[_0x31a530(0x16e)]===_0x31a530(0xe4))_0x3f7d23=Reflect[_0x31a530(0x16e)](_0x53da31,_0x23243a,_0x574428,_0x48a493);else{for(var _0x538f5f=_0x53da31[_0x31a530(0x138)]-0x1;_0x538f5f>=0x0;_0x538f5f--)if(_0x325191=_0x53da31[_0x538f5f])_0x3f7d23=(_0x3cee12<0x3?_0x325191(_0x3f7d23):_0x3cee12>0x3?_0x325191(_0x23243a,_0x574428,_0x3f7d23):_0x325191(_0x23243a,_0x574428))||_0x3f7d23;}return _0x3cee12>0x3&&_0x3f7d23&&Object[_0x31a530(0xdb)](_0x23243a,_0x574428,_0x3f7d23),_0x3f7d23;},__metadata=this&&this['__metadata']||function(_0x7fa015,_0x72fbda){const _0x4d5a07=_0x334499;if(typeof Reflect===_0x4d5a07(0xf0)&&typeof Reflect[_0x4d5a07(0x126)]===_0x4d5a07(0xe4))return Reflect[_0x4d5a07(0x126)](_0x7fa015,_0x72fbda);},__param=this&&this[_0x334499(0xec)]||function(_0x17954f,_0x50d747){return function(_0xa25761,_0x36c05a){_0x50d747(_0xa25761,_0x36c05a,_0x17954f);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x334499(0x15a)]=void 0x0;const globalConfig_service_1=require(_0x334499(0xcb)),user_constant_1=require(_0x334499(0x167)),mailer_1=require('@nestjs-modules/mailer'),verification_service_1=require(_0x334499(0xd8)),common_1=require(_0x334499(0x16d)),typeorm_1=require(_0x334499(0xbb)),typeorm_2=require(_0x334499(0x152)),user_entity_1=require(_0x334499(0x131)),bcrypt=require(_0x334499(0xcc)),crypto=require(_0x334499(0xbc)),_=require(_0x334499(0x124)),verification_constant_1=require('../../common/constants/verification.constant'),userBalance_service_1=require('../userBalance/userBalance.service'),utils_1=require(_0x334499(0x14c)),balance_constant_1=require(_0x334499(0xc5)),config_entity_1=require(_0x334499(0x10e)),whiteList_entity_1=require(_0x334499(0xbd));function _0x5831(){const _0x16df15=['用户不存在！','../globalConfig/config.entity','当前用户信息失效、请重新登录！','不可将用户置为未激活状态！','avatar','HttpException','sign','该微信已绑定其他账号！','resetUserPass','openId','getOwnPropertyDescriptor','getClientIp','user','createdAt','savaLoginIp','generateRandomString','恭喜您绑定成功、后续可直接扫码登录了！','未激活用户不可手动变更状态！','$2y$','HttpStatus','md5','UserStatusEnum','phone','lodash','genInviteCode','metadata','您的账户已被封禁、如有疑问、请联系管理员！','role','super','createUserFromOpenId','findOne','client','640920qdrmXa','UserStatusErrMsg','327YceldW','LOCKED','./user.entity','globalConfigService','createUser','createRandomUid','UserBalanceService','Like','lastLoginIp','length','BAD_REQUEST','email','balanceInfo','registerVerifyEmailDesc','queryUserBalance','addBalanceToNewUser','VerificationService','queryUserBalanceByIds','的账号激活','startsWith','password','configMap:\x20','affected','isBindWx','WhiteListEntity','InjectRepository','userEntity','修改用户信息失败！','305081MJyEpU','../../common/utils','当前账户不存在！','verifyUserCredentials','UNAUTHORIZED','verifyUserRegisterByPhone','Repository','typeorm','error:\x20','split','$2b$','design:paramtypes','formatCreateOrUpdateDate','assign','----,','UserService','Connection','getUserOpenId','当前用户不存在！','DESC','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','createVerification','VerificationEnum','addBalanceToUser','获取邀请记录失败！','verificationService','username','$2a$','../../common/constants/user.constant','当前密码错误！','updateUserPassword','compareSync','findAndCount','3409360gsinSb','@nestjs/common','decorate','maskEmail','queryAll','@nestjs/typeorm','crypto','../chatgpt/whiteList.entity','GlobalConfigService','digest','save','getInviteRecord','用户名已存在！','update','consecutiveDays','../../common/constants/balance.constant','ADMIN_GIFT','ConfigEntity','Not','UserEntity','getConfigs','../globalConfig/globalConfig.service','bcryptjs','createHash','getSuper','超级管理员不可被操作！','修改密码失败、请重新试试吧。','sendMail','registerBaseUrl','configEntity','hashSync','密码重置为[','map','userBalanceService','../verification/verification.service','17722632kxIxaV','当前绑定用户不存在！','defineProperty','1232862mvxGrR','isVerifyEmail','registerIp','生成邀请码失败，请重新试一次吧！','123456','hex','已生成过邀请码、请勿重复生成','bindWx','function','saveRecordRechargeLog','verifyUserPassword','log','find','153554OEOZPo','46328rVoprO','registerVerifyExpir','__param','修改用户状态失败！','cloneDeep','用户名或者邮箱已被注册！','object','用户名已存在、请更换用户名！','getUserStatus','queryOne','修改用户信息成功！','修改用户状态成功！','connection','register','qureyUserInfoByInviteCode','getUserInfo','ACTIVE','@default.com','updateUserStatus','无效的邀请码！','inviteCode','PENDING','Registration','__decorate','queryUserInfoById','forEach','checkUserStatus','whiteListEntity','userDefautlAvatar','maskIpAddress','status','当前手机号已注册、请勿重复注册！','没有变更，无需更改！','MailerService','configKey'];_0x5831=function(){return _0x16df15;};return _0x5831();}function _0x1594(_0x500424,_0x56e17b){const _0x58312f=_0x5831();return _0x1594=function(_0x159462,_0x1b6fe2){_0x159462=_0x159462-0xbb;let _0x452e32=_0x58312f[_0x159462];return _0x452e32;},_0x1594(_0x500424,_0x56e17b);}let UserService=class UserService{constructor(_0x4146e1,_0x13d352,_0x25fd0b,_0x36fa03,_0x27f0f7,_0x238e9a,_0x4274ba,_0x509b0e){const _0x113cf9=_0x334499;this[_0x113cf9(0x149)]=_0x4146e1,this[_0x113cf9(0x105)]=_0x13d352,this[_0x113cf9(0xf6)]=_0x25fd0b,this[_0x113cf9(0x164)]=_0x36fa03,this['mailerService']=_0x27f0f7,this['userBalanceService']=_0x238e9a,this[_0x113cf9(0x132)]=_0x4274ba,this['configEntity']=_0x509b0e;}async['createUserAndVerifycation'](_0x13cfb2,_0x185d05){const _0x3517a4=_0x334499,{username:_0x32e934,email:_0x5cbaed,password:_0x5f2a20,invitedBy:_0x1d60f4,client:client=0x0}=_0x13cfb2;if(_0x1d60f4){const _0x5f57e5=await this[_0x3517a4(0x149)][_0x3517a4(0x12b)]({'where':{'inviteCode':_0x1d60f4}});if(!_0x5f57e5)throw new common_1[(_0x3517a4(0x112))](_0x3517a4(0xfd),common_1['HttpStatus'][_0x3517a4(0x139)]);}const _0x461f71=[{'username':_0x32e934},{'email':_0x5cbaed}],_0x3d6912=await this['userEntity'][_0x3517a4(0x12b)]({'where':_0x461f71});if(_0x3d6912&&_0x3d6912[_0x3517a4(0x108)]!==user_constant_1['UserStatusEnum'][_0x3517a4(0xff)])throw new common_1[(_0x3517a4(0x112))](_0x3517a4(0xef),common_1[_0x3517a4(0x120)][_0x3517a4(0x139)]);try{const _0x5689ec=_[_0x3517a4(0xee)](_0x13cfb2),_0x37dacd=bcrypt[_0x3517a4(0xd4)](_0x5f2a20,0xa),_0x336d8e=(0x0,utils_1[_0x3517a4(0x118)])(_0x185d05);_0x5689ec[_0x3517a4(0x143)]=_0x37dacd,_0x5689ec[_0x3517a4(0xde)]=_0x336d8e,_0x5689ec[_0x3517a4(0x12c)]=client;let _0x4687aa;if(!_0x3d6912){const _0x3909d9=await this['globalConfigService'][_0x3517a4(0xca)]([_0x3517a4(0x106)]);_0x5689ec[_0x3517a4(0x111)]=_0x3909d9,_0x4687aa=await this[_0x3517a4(0x149)]['save'](_0x5689ec);}else _0x4687aa=_0x3d6912;const _0x5a43e0=await this[_0x3517a4(0xd3)][_0x3517a4(0xe8)]({'where':{'configKey':(0x0,typeorm_2['In'])(['isVerifyEmail',_0x3517a4(0xd2),'registerVerifyEmailTitle',_0x3517a4(0x13c),'registerVerifyEmailFrom',_0x3517a4(0xeb)])}}),_0x2add6c=_0x5a43e0['reduce']((_0x3642fd,_0x5e383f)=>{const _0x360b38=_0x3517a4;return _0x3642fd[_0x5e383f[_0x360b38(0x10c)]]=_0x5e383f['configVal'],_0x3642fd;},{}),_0x99571=_0x2add6c['isVerifyEmail']?Number(_0x2add6c[_0x3517a4(0xdd)]):0x1;if(_0x99571){const _0x39768a=_0x2add6c[_0x3517a4(0xeb)]?Number(_0x2add6c['registerVerifyExpir']):0x1e*0x3c,_0x3a8ae0=await this[_0x3517a4(0x164)][_0x3517a4(0x160)](_0x4687aa,verification_constant_1[_0x3517a4(0x161)][_0x3517a4(0x100)],_0x39768a),{code:_0x2a55e8,email:_0x1b5cc2,id:_0x2a16a4}=_0x3a8ae0,{registerVerifyEmailFrom:_0x4e6e61}=_0x2add6c;console['log'](_0x3517a4(0x144),_0x2add6c);const _0x5814c7=await this['mailerService'][_0x3517a4(0xd1)]({'to':_0x1b5cc2,'subject':'来自'+_0x4e6e61+_0x3517a4(0x141),'template':_0x3517a4(0xf7),'context':Object['assign']({'baseUrl':_0x2add6c['registerBaseUrl'],'code':_0x2a55e8,'id':_0x2a16a4},_0x2add6c)});console[_0x3517a4(0xe7)]('email\x20response\x20\x20->\x20:\x20',_0x5814c7);}else{const {username:_0x128632,email:_0x4a0312,id:_0x3b4abf,invitedBy:_0x58ac35}=_0x4687aa;await this['updateUserStatus'](_0x3b4abf,user_constant_1[_0x3517a4(0x122)][_0x3517a4(0xfa)]);let _0x49dee2;_0x58ac35&&(_0x49dee2=await this[_0x3517a4(0xf8)](_0x58ac35)),await this['userBalanceService'][_0x3517a4(0x13e)](_0x3b4abf,_0x49dee2===null||_0x49dee2===void 0x0?void 0x0:_0x49dee2['id']);}return _0x4687aa;}catch(_0x4eb85e){console['log']('error:\x20',_0x4eb85e);throw _0x4eb85e;}}async[_0x334499(0xce)](){const _0x54cc27=_0x334499,_0x36efa5=await this['userEntity'][_0x54cc27(0x12b)]({'where':{'role':_0x54cc27(0x129)}});return _0x36efa5;}async[_0x334499(0x14e)](_0x4e25c2){const _0x3d329d=_0x334499,{username:_0x3b40c2,password:_0x1fc460,uid:uid=0x0,phone:_0x2ac030}=_0x4e25c2;let _0x532a42=null;if(uid>0x0){_0x532a42=await this['userEntity'][_0x3d329d(0x12b)]({'where':{'id':uid}});if(!_0x532a42)throw new common_1[(_0x3d329d(0x112))](_0x3d329d(0x14d),common_1['HttpStatus'][_0x3d329d(0x139)]);if(_0x532a42[_0x3d329d(0x143)][_0x3d329d(0x142)](_0x3d329d(0x166))||_0x532a42['password']['startsWith'](_0x3d329d(0x155))||_0x532a42[_0x3d329d(0x143)]['startsWith']('$2y$')){if(!bcrypt['compareSync'](_0x1fc460,_0x532a42['password']))throw new common_1[(_0x3d329d(0x112))]('当前密码错误！',common_1['HttpStatus'][_0x3d329d(0x139)]);}else{console[_0x3d329d(0xe7)](_0x3d329d(0x159));const _0x2091a8=crypto[_0x3d329d(0xcd)](_0x3d329d(0x121))[_0x3d329d(0xc3)](_0x1fc460)[_0x3d329d(0xbf)]('hex');console[_0x3d329d(0xe7)](_0x3d329d(0x159),_0x2091a8);if(_0x2091a8!==_0x532a42[_0x3d329d(0x143)])throw new common_1[(_0x3d329d(0x112))](_0x3d329d(0x168),common_1[_0x3d329d(0x120)]['BAD_REQUEST']);}}if(_0x3b40c2&&_0x1fc460){const _0x3b1bb4=[{'username':_0x3b40c2},{'email':_0x3b40c2}];_0x532a42=await this[_0x3d329d(0x149)]['findOne']({'where':_0x3b1bb4});if(!_0x532a42)throw new common_1[(_0x3d329d(0x112))](_0x3d329d(0x14d),common_1['HttpStatus'][_0x3d329d(0x139)]);if(_0x532a42['password'][_0x3d329d(0x142)](_0x3d329d(0x166))||_0x532a42[_0x3d329d(0x143)][_0x3d329d(0x142)]('$2b$')||_0x532a42[_0x3d329d(0x143)]['startsWith'](_0x3d329d(0x11f))){if(!bcrypt[_0x3d329d(0x16a)](_0x1fc460,_0x532a42[_0x3d329d(0x143)]))throw new common_1[(_0x3d329d(0x112))](_0x3d329d(0x168),common_1[_0x3d329d(0x120)][_0x3d329d(0x139)]);}else{console[_0x3d329d(0xe7)](_0x3d329d(0x159));const _0x5954e0=crypto[_0x3d329d(0xcd)](_0x3d329d(0x121))[_0x3d329d(0xc3)](_0x1fc460)[_0x3d329d(0xbf)](_0x3d329d(0xe1));console[_0x3d329d(0xe7)](_0x3d329d(0x159),_0x5954e0);if(_0x5954e0!==_0x532a42['password'])throw new common_1[(_0x3d329d(0x112))](_0x3d329d(0x168),common_1[_0x3d329d(0x120)][_0x3d329d(0x139)]);}}if(_0x2ac030&&_0x1fc460){const _0x43c174=[{'phone':_0x2ac030}];_0x532a42=await this[_0x3d329d(0x149)]['findOne']({'where':_0x43c174});if(!_0x532a42)throw new common_1[(_0x3d329d(0x112))](_0x3d329d(0x14d),common_1[_0x3d329d(0x120)][_0x3d329d(0x139)]);if(_0x532a42[_0x3d329d(0x143)]['startsWith'](_0x3d329d(0x166))||_0x532a42[_0x3d329d(0x143)][_0x3d329d(0x142)](_0x3d329d(0x155))||_0x532a42[_0x3d329d(0x143)][_0x3d329d(0x142)](_0x3d329d(0x11f))){if(!bcrypt['compareSync'](_0x1fc460,_0x532a42['password']))throw new common_1['HttpException']('当前密码错误！',common_1[_0x3d329d(0x120)][_0x3d329d(0x139)]);}else{console['log'](_0x3d329d(0x159));const _0x1f1382=crypto['createHash']('md5')[_0x3d329d(0xc3)](_0x1fc460)[_0x3d329d(0xbf)](_0x3d329d(0xe1));console[_0x3d329d(0xe7)](_0x3d329d(0x159),_0x1f1382);if(_0x1f1382!==_0x532a42['password'])throw new common_1['HttpException'](_0x3d329d(0x168),common_1[_0x3d329d(0x120)]['BAD_REQUEST']);}}if(!_0x532a42)throw new common_1['HttpException'](_0x3d329d(0x14d),common_1[_0x3d329d(0x120)]['BAD_REQUEST']);if(_0x532a42[_0x3d329d(0x108)]!==user_constant_1[_0x3d329d(0x122)][_0x3d329d(0xfa)])throw new common_1[(_0x3d329d(0x112))](user_constant_1[_0x3d329d(0x12e)][_0x532a42[_0x3d329d(0x108)]],common_1['HttpStatus'][_0x3d329d(0x139)]);return _0x532a42;}async[_0x334499(0xe6)](_0x1c284a,_0x181dc5){const _0x418fdf=_0x334499,_0x8ae254=await this['userEntity'][_0x418fdf(0x12b)]({'where':{'id':_0x1c284a}});if(_0x8ae254['password'][_0x418fdf(0x142)](_0x418fdf(0x166))||_0x8ae254[_0x418fdf(0x143)][_0x418fdf(0x142)](_0x418fdf(0x155))||_0x8ae254[_0x418fdf(0x143)][_0x418fdf(0x142)](_0x418fdf(0x11f)))return bcrypt['compareSync'](_0x181dc5,_0x8ae254['password']);else{const _0x5892e6=crypto[_0x418fdf(0xcd)](_0x418fdf(0x121))[_0x418fdf(0xc3)](_0x181dc5)['digest'](_0x418fdf(0xe1));return console[_0x418fdf(0xe7)](_0x418fdf(0x159),_0x5892e6),_0x5892e6===_0x8ae254[_0x418fdf(0x143)];}}async[_0x334499(0xfc)](_0x1f2471,_0x57b91a){const _0x11172d=_0x334499,_0x5a84c7=await this[_0x11172d(0x149)][_0x11172d(0xc3)]({'id':_0x1f2471},{'status':_0x57b91a});return _0x5a84c7[_0x11172d(0x145)]>0x0;}async[_0x334499(0xf2)](_0x1e146c){const _0x51abaf=_0x334499,_0x174082=await this[_0x51abaf(0x149)][_0x51abaf(0x12b)]({'where':{'id':_0x1e146c}});return _0x174082[_0x51abaf(0x108)];}async[_0x334499(0x102)](_0x320849){const _0x2250c4=_0x334499;return await this[_0x2250c4(0x149)][_0x2250c4(0x12b)]({'where':{'id':_0x320849}});}async['queryOneUserInfo'](_0x202ecd){const _0x1ba3ea=_0x334499;return await this[_0x1ba3ea(0x149)][_0x1ba3ea(0x12b)]({'where':{'id':_0x202ecd}});}async[_0x334499(0x104)](_0x2f6026){const _0x208073=_0x334499,{id:_0xa67587,role:_0x16b68f}=_0x2f6026;if(_0x16b68f==='visitor')return!![];const _0x37f851=await this[_0x208073(0x149)][_0x208073(0x12b)]({'where':{'id':_0xa67587}});if(!_0x37f851)throw new common_1['HttpException']('当前用户信息失效、请重新登录！',common_1[_0x208073(0x120)][_0x208073(0x14f)]);if(_0x37f851[_0x208073(0x108)]===user_constant_1[_0x208073(0x122)]['BLACKLISTED'])throw new common_1[(_0x208073(0x112))](_0x208073(0x15f),common_1[_0x208073(0x120)][_0x208073(0x139)]);if(_0x37f851[_0x208073(0x108)]===user_constant_1[_0x208073(0x122)][_0x208073(0x130)])throw new common_1[(_0x208073(0x112))](_0x208073(0x127),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x334499(0xf9)](_0x200dce){const _0x23d278=_0x334499,_0x37d651=await this['userEntity'][_0x23d278(0x12b)]({'where':{'id':_0x200dce},'select':[_0x23d278(0x165),'avatar',_0x23d278(0x128),'email',_0x23d278(0x113),_0x23d278(0xfe),_0x23d278(0x116),_0x23d278(0xc4)]});if(!_0x37d651)throw new common_1[(_0x23d278(0x112))](_0x23d278(0x10f),common_1[_0x23d278(0x120)][_0x23d278(0x14f)]);_0x37d651[_0x23d278(0x146)]=!!(_0x37d651===null||_0x37d651===void 0x0?void 0x0:_0x37d651[_0x23d278(0x116)]),delete _0x37d651[_0x23d278(0x116)];const _0x1af909=await this[_0x23d278(0xd7)][_0x23d278(0x13d)](_0x200dce);return{'userInfo':_0x37d651,'userBalance':Object[_0x23d278(0x158)]({},_0x1af909)};}async['getUserById'](_0xf3f400){const _0x3845f7=_0x334499;return await this[_0x3845f7(0x149)][_0x3845f7(0x12b)]({'where':{'id':_0xf3f400}});}async[_0x334499(0x15c)](_0x1b60f3){const _0x3ead48=_0x334499;return await this[_0x3ead48(0x149)][_0x3ead48(0x12b)]({'where':{'openId':_0x1b60f3}});}async['updateInfo'](_0x4ecc49,_0x19177e){const _0x83608f=_0x334499,{id:_0x3930d8}=_0x19177e[_0x83608f(0x119)],_0x2aab9b=await this[_0x83608f(0x149)]['findOne']({'where':{'id':_0x3930d8}});if(!_0x2aab9b)throw new common_1[(_0x83608f(0x112))](_0x83608f(0x15d),common_1[_0x83608f(0x120)]['BAD_REQUEST']);if(_0x4ecc49[_0x83608f(0x165)]&&_0x2aab9b[_0x83608f(0x165)]===_0x4ecc49[_0x83608f(0x165)])throw new common_1[(_0x83608f(0x112))](_0x83608f(0x10a),common_1['HttpStatus'][_0x83608f(0x139)]);if(_0x4ecc49[_0x83608f(0x165)]){const _0x49cc28=await this[_0x83608f(0x149)][_0x83608f(0x12b)]({'where':{'username':_0x4ecc49['username'],'id':(0x0,typeorm_2[_0x83608f(0xc8)])(_0x3930d8)}});if(_0x49cc28)throw new common_1[(_0x83608f(0x112))](_0x83608f(0xc2),common_1['HttpStatus'][_0x83608f(0x139)]);}const _0x1aad39=await this['userEntity']['update']({'id':_0x3930d8},_0x4ecc49);if(_0x1aad39[_0x83608f(0x145)]<=0x0)throw new common_1[(_0x83608f(0x112))](_0x83608f(0x14a),common_1[_0x83608f(0x120)][_0x83608f(0x139)]);return _0x83608f(0xf4);}async[_0x334499(0x169)](_0x1178b7,_0x3660fc){const _0x1404c5=_0x334499,_0x202e0e=bcrypt[_0x1404c5(0xd4)](_0x3660fc,0xa),_0x3418f6=await this['userEntity'][_0x1404c5(0xc3)]({'id':_0x1178b7},{'password':_0x202e0e});if(_0x3418f6[_0x1404c5(0x145)]<=0x0)throw new common_1[(_0x1404c5(0x112))](_0x1404c5(0xd0),common_1[_0x1404c5(0x120)][_0x1404c5(0x139)]);}async[_0x334499(0x125)](_0x37e0b3){const _0x4a2ccc=_0x334499,{id:_0x27e300}=_0x37e0b3['user'],_0x5eb66f=await this['userEntity']['findOne']({'where':{'id':_0x27e300}});if(!_0x5eb66f||_0x5eb66f[_0x4a2ccc(0xfe)])throw new common_1[(_0x4a2ccc(0x112))](_0x4a2ccc(0xe2),common_1[_0x4a2ccc(0x120)][_0x4a2ccc(0x139)]);const _0xc19b8c=(0x0,utils_1[_0x4a2ccc(0x11c)])(),_0x256958=await this['userEntity'][_0x4a2ccc(0x12b)]({'where':{'inviteCode':_0xc19b8c}});if(_0x256958)throw new common_1[(_0x4a2ccc(0x112))](_0x4a2ccc(0xdf),common_1[_0x4a2ccc(0x120)][_0x4a2ccc(0x139)]);const _0x46ffae=await this[_0x4a2ccc(0x149)]['update']({'id':_0x27e300},{'inviteCode':_0xc19b8c});if(_0x46ffae['affected']<=0x0)throw new common_1['HttpException'](_0x4a2ccc(0xdf),common_1[_0x4a2ccc(0x120)]['BAD_REQUEST']);return _0xc19b8c;}async[_0x334499(0xc1)](_0x2f977e,_0x361973){const _0x23d49f=_0x334499;try{const {id:_0x244145}=_0x2f977e['user'],{page:page=0x1,size:size=0xa}=_0x361973,_0x4e2bd1=await this[_0x23d49f(0x149)]['findOne']({'where':{'id':_0x244145}}),{inviteCode:_0x2a9ec1}=_0x4e2bd1;if(!_0x2a9ec1)return[];const [_0x4e3ec2,_0xfc0b06]=await this[_0x23d49f(0x149)][_0x23d49f(0x16b)]({'where':{'inviteCode':_0x2a9ec1},'order':{'id':'DESC'},'select':[_0x23d49f(0x165),'email',_0x23d49f(0x11a),_0x23d49f(0x108),_0x23d49f(0x111)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x23d49f(0x157)])(_0x4e3ec2)['map'](_0x2cce07=>{const _0x874f05=_0x23d49f;return _0x2cce07[_0x874f05(0x13a)]=(0x0,utils_1[_0x874f05(0x16f)])(_0x2cce07[_0x874f05(0x13a)]),_0x2cce07;}),{'rows':_0x4e3ec2,'count':_0xfc0b06};}catch(_0x3c566c){console[_0x23d49f(0xe7)](_0x23d49f(0x153),_0x3c566c);throw new common_1['HttpException'](_0x23d49f(0x163),common_1['HttpStatus'][_0x23d49f(0x139)]);}}async['inviteLink'](_0x159754){const _0x1708a5=_0x334499,_0x57dc74=await this['userEntity']['findOne']({'where':{'inviteCode':_0x159754}});if(!_0x57dc74)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x57dc74,_0x51d258=await this[_0x1708a5(0x149)]['update']({'inviteCode':_0x159754},{'inviteLinkCount':inviteLinkCount+0x1});return _0x51d258[_0x1708a5(0x145)]?0x1:0x0;}async['qureyUserInfoByInviteCode'](_0x118b85){const _0x17319e=_0x334499;return await this[_0x17319e(0x149)][_0x17319e(0x12b)]({'where':{'inviteCode':_0x118b85}});}async['userRecharge'](_0x4616f7){const _0xa2d377=_0x334499,{userId:_0x5db037,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4616f7;await this[_0xa2d377(0xd7)][_0xa2d377(0x162)](_0x5db037,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0xa122df=await this[_0xa2d377(0xd7)][_0xa2d377(0xe5)]({'userId':_0x5db037,'rechargeType':balance_constant_1['RechargeType'][_0xa2d377(0xc6)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0xa122df;}async[_0x334499(0x170)](_0x2f7eb8,_0x5a79ab){const _0x351342=_0x334499,{page:page=0x1,size:size=0xa,username:_0x51b387,email:_0x4870b3,status:_0x1a987a,keyword:_0x15707f,phone:_0x1e3433}=_0x2f7eb8;let _0x1c1e72={};_0x51b387&&Object[_0x351342(0x158)](_0x1c1e72,{'username':(0x0,typeorm_2[_0x351342(0x136)])('%'+_0x51b387+'%')}),_0x4870b3&&Object[_0x351342(0x158)](_0x1c1e72,{'email':(0x0,typeorm_2['Like'])('%'+_0x4870b3+'%')}),_0x1e3433&&Object['assign'](_0x1c1e72,{'phone':(0x0,typeorm_2['Like'])('%'+_0x1e3433+'%')}),_0x1a987a&&Object['assign'](_0x1c1e72,{'status':_0x1a987a});_0x15707f&&(_0x1c1e72=[{'username':(0x0,typeorm_2[_0x351342(0x136)])('%'+_0x15707f+'%')},{'email':(0x0,typeorm_2[_0x351342(0x136)])('%'+_0x15707f+'%')},{'phone':(0x0,typeorm_2[_0x351342(0x136)])('%'+_0x15707f+'%')}]);const [_0xd5fed0,_0x173b6d]=await this[_0x351342(0x149)][_0x351342(0x16b)]({'skip':(page-0x1)*size,'where':_0x1c1e72,'take':size,'order':{'createdAt':_0x351342(0x15e)},'cache':!![],'select':['username',_0x351342(0x111),'inviteCode',_0x351342(0x128),_0x351342(0x113),_0x351342(0x108),'id',_0x351342(0x13a),_0x351342(0x11a),'lastLoginIp','phone']}),_0x45d149=_0xd5fed0[_0x351342(0xd6)](_0x1a475e=>_0x1a475e['id']),_0x39c635=await this['userBalanceService'][_0x351342(0x140)](_0x45d149);return _0xd5fed0['forEach'](_0xcb8d08=>_0xcb8d08[_0x351342(0x13b)]=_0x39c635['find'](_0x442f95=>_0x442f95['userId']===_0xcb8d08['id'])),_0x5a79ab['user'][_0x351342(0x128)]!==_0x351342(0x129)&&_0xd5fed0[_0x351342(0x103)](_0x4ed954=>_0x4ed954[_0x351342(0x13a)]=(0x0,utils_1[_0x351342(0x16f)])(_0x4ed954[_0x351342(0x13a)])),_0x5a79ab[_0x351342(0x119)][_0x351342(0x128)]!==_0x351342(0x129)&&_0xd5fed0[_0x351342(0x103)](_0x2375d6=>_0x2375d6[_0x351342(0x137)]=(0x0,utils_1[_0x351342(0x107)])(_0x2375d6[_0x351342(0x137)])),_0x5a79ab[_0x351342(0x119)][_0x351342(0x128)]!==_0x351342(0x129)&&_0xd5fed0['forEach'](_0x466084=>_0x466084['phone']=(0x0,utils_1[_0x351342(0x107)])(_0x466084[_0x351342(0x123)])),{'rows':_0xd5fed0,'count':_0x173b6d};}async[_0x334499(0xf3)]({id:_0x453583}){const _0x2347f2=_0x334499;return await this['userEntity']['findOne']({'where':{'id':_0x453583},'select':['username',_0x2347f2(0x111),_0x2347f2(0xfe),_0x2347f2(0x128),_0x2347f2(0x113),'status']});}async['updateStatus'](_0x5c2c7c){const _0x30b600=_0x334499,{id:_0xacab14,status:_0x3ae90f}=_0x5c2c7c,_0x57d9f7=await this[_0x30b600(0x149)]['findOne']({'where':{'id':_0xacab14}});if(!_0x57d9f7)throw new common_1[(_0x30b600(0x112))](_0x30b600(0x10d),common_1[_0x30b600(0x120)]['BAD_REQUEST']);if(_0x57d9f7[_0x30b600(0x128)]===_0x30b600(0x129))throw new common_1['HttpException'](_0x30b600(0xcf),common_1[_0x30b600(0x120)]['BAD_REQUEST']);if(_0x57d9f7[_0x30b600(0x108)]===user_constant_1[_0x30b600(0x122)][_0x30b600(0xff)])throw new common_1['HttpException'](_0x30b600(0x11e),common_1[_0x30b600(0x120)][_0x30b600(0x139)]);if(_0x57d9f7[_0x30b600(0x128)]===_0x30b600(0x129))throw new common_1['HttpException'](_0x30b600(0xcf),common_1[_0x30b600(0x120)][_0x30b600(0x139)]);if(_0x3ae90f===user_constant_1['UserStatusEnum'][_0x30b600(0xff)])throw new common_1['HttpException'](_0x30b600(0x110),common_1['HttpStatus'][_0x30b600(0x139)]);const _0x476022=await this[_0x30b600(0x149)][_0x30b600(0xc3)]({'id':_0xacab14},{'status':_0x3ae90f});if(_0x476022['affected']<=0x0)throw new common_1[(_0x30b600(0x112))](_0x30b600(0xed),common_1[_0x30b600(0x120)][_0x30b600(0x139)]);return _0x30b600(0xf5);}async[_0x334499(0x115)](_0x4dd395){const _0x3e2218=_0x334499,{id:_0x43fe9c}=_0x4dd395,_0x1ed95d=await this[_0x3e2218(0x149)][_0x3e2218(0x12b)]({'where':{'id':_0x43fe9c}});if(!_0x1ed95d)throw new common_1[(_0x3e2218(0x112))](_0x3e2218(0x10d),common_1[_0x3e2218(0x120)][_0x3e2218(0x139)]);const _0x19e84a=_0x3e2218(0xe0),_0xd246d1=bcrypt['hashSync'](_0x19e84a,0xa),_0x59d5ef=await this['userEntity']['update']({'id':_0x43fe9c},{'password':_0xd246d1});if(_0x59d5ef[_0x3e2218(0x145)]<=0x0)throw new common_1[(_0x3e2218(0x112))]('重置密码失败！',common_1['HttpStatus']['BAD_REQUEST']);return _0x3e2218(0xd5)+_0x19e84a+']成功!';}async[_0x334499(0x11b)](_0x55ac70,_0x4b324b){const _0x2a68e8=_0x334499;return await this['userEntity'][_0x2a68e8(0xc3)]({'id':_0x55ac70},{'lastLoginIp':_0x4b324b});}async['getUserFromOpenId'](_0x9185c2,_0x59a670){const _0x20b2d1=_0x334499,_0x544fa9=await this['userEntity'][_0x20b2d1(0x12b)]({'where':{'openId':_0x9185c2}});if(!_0x544fa9){const _0x5d9d5d=_0x59a670?_0x59a670[_0x20b2d1(0x154)](':')[0x1]:'',_0x56deb3=await this['qureyUserInfoByInviteCode'](_0x5d9d5d),_0x7330=await this[_0x20b2d1(0x12a)](_0x9185c2,_0x5d9d5d);return await this[_0x20b2d1(0xd7)]['addBalanceToNewUser'](_0x7330['id'],_0x5d9d5d?_0x56deb3===null||_0x56deb3===void 0x0?void 0x0:_0x56deb3['id']:null),_0x7330;}return _0x544fa9;}async['createUserFromOpenId'](_0x214713,_0x4289b6){const _0x6c5e05=_0x334499,_0x15283d=await this['globalConfigService'][_0x6c5e05(0xca)]([_0x6c5e05(0x106)]),_0x53ecbc={'avatar':_0x15283d,'username':'用户'+(0x0,utils_1[_0x6c5e05(0x134)])(),'status':user_constant_1[_0x6c5e05(0x122)][_0x6c5e05(0xfa)],'sex':0x0,'email':(0x0,utils_1[_0x6c5e05(0x134)])()+_0x6c5e05(0xfb),'invitedBy':_0x4289b6,'openId':_0x214713},_0x1661db=await this['userEntity'][_0x6c5e05(0xc0)](_0x53ecbc);return _0x1661db;}async[_0x334499(0xe3)](_0x4e224e,_0x53b55a){const _0x356f56=_0x334499;try{const _0x2414ba=await this[_0x356f56(0x149)][_0x356f56(0x12b)]({'where':{'id':_0x53b55a}});if(!_0x2414ba)return{'status':![],'msg':_0x356f56(0xda)};const _0x27951e=await this['userEntity'][_0x356f56(0x12b)]({'where':{'openId':_0x4e224e}});if(_0x27951e)return{'status':![],'msg':_0x356f56(0x114)};const _0x54152c=await this[_0x356f56(0x149)][_0x356f56(0xc3)]({'id':_0x53b55a},{'openId':_0x4e224e});if(_0x54152c['affected']<=0x0)return{'status':![],'msg':'绑定微信失败、请联系管理员！'};return{'status':!![],'msg':_0x356f56(0x11d)};}catch(_0xf981fe){return{'status':![],'msg':'绑定微信失败、请联系管理员！'};}}async['getOpenIdByUserId'](_0x3ad4f2){const _0x322308=_0x334499,_0x6d5472=await this[_0x322308(0x149)][_0x322308(0x12b)]({'where':{'id':_0x3ad4f2}});return _0x6d5472===null||_0x6d5472===void 0x0?void 0x0:_0x6d5472[_0x322308(0x116)];}async[_0x334499(0x150)](_0x594ac9){const _0x2c5709=_0x334499,{username:_0x492807,password:_0x292ac8,phone:_0x5a681e,phoneCode:_0x1ce81f}=_0x594ac9,_0xf4cb24=await this['userEntity'][_0x2c5709(0x12b)]({'where':[{'username':_0x492807},{'phone':_0x5a681e}]});if(_0xf4cb24&&_0xf4cb24[_0x2c5709(0x165)]===_0x492807)throw new common_1[(_0x2c5709(0x112))](_0x2c5709(0xf1),common_1[_0x2c5709(0x120)][_0x2c5709(0x139)]);if(_0xf4cb24&&_0xf4cb24[_0x2c5709(0x123)]===_0x5a681e)throw new common_1[(_0x2c5709(0x112))](_0x2c5709(0x109),common_1['HttpStatus'][_0x2c5709(0x139)]);}async[_0x334499(0x133)](_0x561112){const _0x1eb4fb=_0x334499;return await this[_0x1eb4fb(0x149)]['save'](_0x561112);}};UserService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x334499(0xc9)])),__param(0x1,(0x0,typeorm_1[_0x334499(0x148)])(whiteList_entity_1[_0x334499(0x147)])),__param(0x7,(0x0,typeorm_1[_0x334499(0x148)])(config_entity_1[_0x334499(0xc7)])),__metadata(_0x334499(0x156),[typeorm_2[_0x334499(0x151)],typeorm_2[_0x334499(0x151)],typeorm_2[_0x334499(0x15b)],verification_service_1[_0x334499(0x13f)],mailer_1[_0x334499(0x10b)],userBalance_service_1[_0x334499(0x135)],globalConfig_service_1[_0x334499(0xbe)],typeorm_2['Repository']])],UserService),exports[_0x334499(0x15a)]=UserService;