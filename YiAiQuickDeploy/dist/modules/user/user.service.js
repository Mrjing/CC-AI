'use strict';const _0x1c903d=_0x3d50;(function(_0xb67298,_0x589b2b){const _0x4c09b4=_0x3d50,_0x1394b5=_0xb67298();while(!![]){try{const _0x459ff6=-parseInt(_0x4c09b4(0x1b3))/0x1*(parseInt(_0x4c09b4(0x1ab))/0x2)+parseInt(_0x4c09b4(0x238))/0x3+parseInt(_0x4c09b4(0x1ee))/0x4+parseInt(_0x4c09b4(0x1bf))/0x5*(-parseInt(_0x4c09b4(0x213))/0x6)+parseInt(_0x4c09b4(0x1b6))/0x7+parseInt(_0x4c09b4(0x1b4))/0x8+-parseInt(_0x4c09b4(0x22b))/0x9;if(_0x459ff6===_0x589b2b)break;else _0x1394b5['push'](_0x1394b5['shift']());}catch(_0x33e2f3){_0x1394b5['push'](_0x1394b5['shift']());}}}(_0x3291,0xcc967));function _0x3d50(_0x43cc06,_0x18844a){const _0x329162=_0x3291();return _0x3d50=function(_0x3d50bb,_0x1ab630){_0x3d50bb=_0x3d50bb-0x198;let _0x491c7c=_0x329162[_0x3d50bb];return _0x491c7c;},_0x3d50(_0x43cc06,_0x18844a);}var __decorate=this&&this['__decorate']||function(_0x3d094e,_0xe5142,_0x1ad407,_0x19e2f7){const _0x3724b4=_0x3d50;var _0x53f917=arguments[_0x3724b4(0x1fd)],_0x4a3e20=_0x53f917<0x3?_0xe5142:_0x19e2f7===null?_0x19e2f7=Object[_0x3724b4(0x230)](_0xe5142,_0x1ad407):_0x19e2f7,_0xe750b4;if(typeof Reflect===_0x3724b4(0x20a)&&typeof Reflect['decorate']==='function')_0x4a3e20=Reflect['decorate'](_0x3d094e,_0xe5142,_0x1ad407,_0x19e2f7);else{for(var _0x500f11=_0x3d094e[_0x3724b4(0x1fd)]-0x1;_0x500f11>=0x0;_0x500f11--)if(_0xe750b4=_0x3d094e[_0x500f11])_0x4a3e20=(_0x53f917<0x3?_0xe750b4(_0x4a3e20):_0x53f917>0x3?_0xe750b4(_0xe5142,_0x1ad407,_0x4a3e20):_0xe750b4(_0xe5142,_0x1ad407))||_0x4a3e20;}return _0x53f917>0x3&&_0x4a3e20&&Object[_0x3724b4(0x212)](_0xe5142,_0x1ad407,_0x4a3e20),_0x4a3e20;},__metadata=this&&this[_0x1c903d(0x1a4)]||function(_0x1b7505,_0xeaa6e9){if(typeof Reflect==='object'&&typeof Reflect['metadata']==='function')return Reflect['metadata'](_0x1b7505,_0xeaa6e9);},__param=this&&this[_0x1c903d(0x1b9)]||function(_0x2988b6,_0x1651df){return function(_0x49def2,_0x1aa0b0){_0x1651df(_0x49def2,_0x1aa0b0,_0x2988b6);};};Object[_0x1c903d(0x212)](exports,_0x1c903d(0x19b),{'value':!![]}),exports['UserService']=void 0x0;const globalConfig_service_1=require(_0x1c903d(0x20e)),user_constant_1=require('../../common/constants/user.constant'),mailer_1=require(_0x1c903d(0x1b8)),verification_service_1=require(_0x1c903d(0x1e8)),common_1=require(_0x1c903d(0x235)),typeorm_1=require(_0x1c903d(0x215)),typeorm_2=require('typeorm'),user_entity_1=require(_0x1c903d(0x1e7)),bcrypt=require(_0x1c903d(0x19c)),crypto=require(_0x1c903d(0x1d7)),_=require(_0x1c903d(0x1df)),verification_constant_1=require(_0x1c903d(0x236)),userBalance_service_1=require(_0x1c903d(0x205)),utils_1=require(_0x1c903d(0x1ad)),balance_constant_1=require(_0x1c903d(0x244)),config_entity_1=require(_0x1c903d(0x1e1)),whiteList_entity_1=require('../chatgpt/whiteList.entity');let UserService=class UserService{constructor(_0x2aeee0,_0x3f1cd3,_0x424ab6,_0x5997b6,_0x4afd8d,_0x46c461,_0x2588c5,_0x44a93c){const _0x407a8d=_0x1c903d;this['userEntity']=_0x2aeee0,this['whiteListEntity']=_0x3f1cd3,this[_0x407a8d(0x20c)]=_0x424ab6,this[_0x407a8d(0x1d3)]=_0x5997b6,this['mailerService']=_0x4afd8d,this[_0x407a8d(0x1e6)]=_0x46c461,this[_0x407a8d(0x1e4)]=_0x2588c5,this[_0x407a8d(0x237)]=_0x44a93c;}async[_0x1c903d(0x1f1)](_0x298421,_0x8c4a8d){const _0x29805c=_0x1c903d,{username:_0x48d8d1,email:_0x42d91b,password:_0x3164f7,invitedBy:_0x3f220c,client:client=0x0}=_0x298421;if(_0x3f220c){const _0x299f22=await this[_0x29805c(0x1b7)][_0x29805c(0x1d5)]({'where':{'inviteCode':_0x3f220c}});if(!_0x299f22)throw new common_1[(_0x29805c(0x1f8))]('无效的邀请码！',common_1['HttpStatus']['BAD_REQUEST']);}const _0x53cf07=[{'username':_0x48d8d1},{'email':_0x42d91b}],_0x493aca=await this['userEntity'][_0x29805c(0x1d5)]({'where':_0x53cf07});if(_0x493aca&&_0x493aca[_0x29805c(0x1c8)]!==user_constant_1[_0x29805c(0x1d9)][_0x29805c(0x1a6)])throw new common_1[(_0x29805c(0x1f8))]('用户名或者邮箱已被注册！',common_1[_0x29805c(0x227)][_0x29805c(0x1e9)]);try{const _0x3162f5=_['cloneDeep'](_0x298421),_0xe56d87=bcrypt[_0x29805c(0x1a0)](_0x3164f7,0xa),_0x164b99=(0x0,utils_1[_0x29805c(0x1b1)])(_0x8c4a8d);_0x3162f5['password']=_0xe56d87,_0x3162f5[_0x29805c(0x1be)]=_0x164b99,_0x3162f5['client']=client;let _0x3497f4;if(!_0x493aca){const _0xa5546c=await this[_0x29805c(0x1e4)][_0x29805c(0x226)]([_0x29805c(0x1fb)]);_0x3162f5[_0x29805c(0x247)]=_0xa5546c,_0x3497f4=await this['userEntity'][_0x29805c(0x1ae)](_0x3162f5);}else _0x3497f4=_0x493aca;const _0x2be841=await this[_0x29805c(0x237)][_0x29805c(0x220)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x29805c(0x216),_0x29805c(0x20b),_0x29805c(0x199),_0x29805c(0x21d),_0x29805c(0x229),_0x29805c(0x1dc)])}}),_0x57f8fb=_0x2be841[_0x29805c(0x1d8)]((_0x104b52,_0x499ef7)=>{const _0x529e3a=_0x29805c;return _0x104b52[_0x499ef7[_0x529e3a(0x1e3)]]=_0x499ef7[_0x529e3a(0x234)],_0x104b52;},{}),_0x32319d=_0x57f8fb[_0x29805c(0x216)]?Number(_0x57f8fb[_0x29805c(0x216)]):0x1;if(_0x32319d){const _0x530638=_0x57f8fb[_0x29805c(0x1dc)]?Number(_0x57f8fb[_0x29805c(0x1dc)]):0x1e*0x3c,_0x4e47e5=await this[_0x29805c(0x1d3)][_0x29805c(0x22d)](_0x3497f4,verification_constant_1[_0x29805c(0x217)][_0x29805c(0x23d)],_0x530638),{code:_0x2b4691,email:_0x551bfb,id:_0x3d788b}=_0x4e47e5,{registerVerifyEmailFrom:_0x23b43d}=_0x57f8fb;console['log'](_0x29805c(0x1b5),_0x57f8fb);const _0x5e1e9c=await this[_0x29805c(0x1d2)][_0x29805c(0x1dd)]({'to':_0x551bfb,'subject':'来自'+_0x23b43d+'的账号激活','template':_0x29805c(0x239),'context':Object[_0x29805c(0x240)]({'baseUrl':_0x57f8fb['registerBaseUrl'],'code':_0x2b4691,'id':_0x3d788b},_0x57f8fb)});console[_0x29805c(0x1a9)]('email\x20response\x20\x20->\x20:\x20',_0x5e1e9c);}else{const {username:_0x92ff7,email:_0x21cf66,id:_0x7223e2,invitedBy:_0x484bc0}=_0x3497f4;await this[_0x29805c(0x1c5)](_0x7223e2,user_constant_1[_0x29805c(0x1d9)][_0x29805c(0x23e)]);let _0x3ead88;_0x484bc0&&(_0x3ead88=await this['qureyUserInfoByInviteCode'](_0x484bc0)),await this[_0x29805c(0x1e6)][_0x29805c(0x22e)](_0x7223e2,_0x3ead88===null||_0x3ead88===void 0x0?void 0x0:_0x3ead88['id']);}return _0x3497f4;}catch(_0x26f8e8){console['log']('error:\x20',_0x26f8e8);throw _0x26f8e8;}}async[_0x1c903d(0x1f7)](){const _0x21e027=_0x1c903d,_0x57128a=await this[_0x21e027(0x1b7)][_0x21e027(0x1d5)]({'where':{'role':_0x21e027(0x200)}});return _0x57128a;}async[_0x1c903d(0x1ef)](_0x4ce7b9){const _0x3c5d39=_0x1c903d,{username:_0x47c244,password:_0x5194e6,uid:uid=0x0,phone:_0x42564f}=_0x4ce7b9;let _0x580228=null;if(uid>0x0){_0x580228=await this[_0x3c5d39(0x1b7)][_0x3c5d39(0x1d5)]({'where':{'id':uid}});if(!_0x580228)throw new common_1[(_0x3c5d39(0x1f8))](_0x3c5d39(0x204),common_1[_0x3c5d39(0x227)][_0x3c5d39(0x1e9)]);if(_0x580228['password'][_0x3c5d39(0x1e0)]('$2a$')||_0x580228[_0x3c5d39(0x1f6)][_0x3c5d39(0x1e0)]('$2b$')||_0x580228[_0x3c5d39(0x1f6)][_0x3c5d39(0x1e0)]('$2y$')){if(!bcrypt[_0x3c5d39(0x1a1)](_0x5194e6,_0x580228['password']))throw new common_1[(_0x3c5d39(0x1f8))](_0x3c5d39(0x1c4),common_1[_0x3c5d39(0x227)][_0x3c5d39(0x1e9)]);}else{console[_0x3c5d39(0x1a9)](_0x3c5d39(0x246));const _0x32c3c8=crypto[_0x3c5d39(0x23a)](_0x3c5d39(0x1de))['update'](_0x5194e6)[_0x3c5d39(0x232)](_0x3c5d39(0x243));console[_0x3c5d39(0x1a9)](_0x3c5d39(0x246),_0x32c3c8);if(_0x32c3c8!==_0x580228[_0x3c5d39(0x1f6)])throw new common_1[(_0x3c5d39(0x1f8))](_0x3c5d39(0x1c4),common_1[_0x3c5d39(0x227)][_0x3c5d39(0x1e9)]);}}if(_0x47c244&&_0x5194e6){const _0x415399=[{'username':_0x47c244},{'email':_0x47c244}];_0x580228=await this[_0x3c5d39(0x1b7)][_0x3c5d39(0x1d5)]({'where':_0x415399});if(!_0x580228)throw new common_1[(_0x3c5d39(0x1f8))](_0x3c5d39(0x204),common_1[_0x3c5d39(0x227)]['BAD_REQUEST']);if(_0x580228[_0x3c5d39(0x1f6)][_0x3c5d39(0x1e0)]('$2a$')||_0x580228[_0x3c5d39(0x1f6)][_0x3c5d39(0x1e0)](_0x3c5d39(0x221))||_0x580228['password'][_0x3c5d39(0x1e0)](_0x3c5d39(0x231))){if(!bcrypt[_0x3c5d39(0x1a1)](_0x5194e6,_0x580228[_0x3c5d39(0x1f6)]))throw new common_1[(_0x3c5d39(0x1f8))](_0x3c5d39(0x1c4),common_1[_0x3c5d39(0x227)][_0x3c5d39(0x1e9)]);}else{console['log'](_0x3c5d39(0x246));const _0x56c065=crypto['createHash'](_0x3c5d39(0x1de))[_0x3c5d39(0x1cc)](_0x5194e6)[_0x3c5d39(0x232)](_0x3c5d39(0x243));console[_0x3c5d39(0x1a9)](_0x3c5d39(0x246),_0x56c065);if(_0x56c065!==_0x580228[_0x3c5d39(0x1f6)])throw new common_1[(_0x3c5d39(0x1f8))](_0x3c5d39(0x1c4),common_1[_0x3c5d39(0x227)][_0x3c5d39(0x1e9)]);}}if(_0x42564f&&_0x5194e6){const _0x161f99=[{'phone':_0x42564f}];_0x580228=await this['userEntity'][_0x3c5d39(0x1d5)]({'where':_0x161f99});if(!_0x580228)throw new common_1['HttpException']('当前账户不存在！',common_1[_0x3c5d39(0x227)]['BAD_REQUEST']);if(_0x580228[_0x3c5d39(0x1f6)][_0x3c5d39(0x1e0)]('$2a$')||_0x580228[_0x3c5d39(0x1f6)][_0x3c5d39(0x1e0)](_0x3c5d39(0x221))||_0x580228[_0x3c5d39(0x1f6)]['startsWith'](_0x3c5d39(0x231))){if(!bcrypt[_0x3c5d39(0x1a1)](_0x5194e6,_0x580228['password']))throw new common_1['HttpException'](_0x3c5d39(0x1c4),common_1[_0x3c5d39(0x227)][_0x3c5d39(0x1e9)]);}else{console[_0x3c5d39(0x1a9)](_0x3c5d39(0x246));const _0x315700=crypto[_0x3c5d39(0x23a)](_0x3c5d39(0x1de))[_0x3c5d39(0x1cc)](_0x5194e6)[_0x3c5d39(0x232)]('hex');console[_0x3c5d39(0x1a9)](_0x3c5d39(0x246),_0x315700);if(_0x315700!==_0x580228[_0x3c5d39(0x1f6)])throw new common_1[(_0x3c5d39(0x1f8))]('当前密码错误！',common_1[_0x3c5d39(0x227)][_0x3c5d39(0x1e9)]);}}if(!_0x580228)throw new common_1[(_0x3c5d39(0x1f8))](_0x3c5d39(0x204),common_1['HttpStatus']['BAD_REQUEST']);if(_0x580228[_0x3c5d39(0x1c8)]!==user_constant_1[_0x3c5d39(0x1d9)][_0x3c5d39(0x23e)])throw new common_1[(_0x3c5d39(0x1f8))](user_constant_1[_0x3c5d39(0x245)][_0x580228[_0x3c5d39(0x1c8)]],common_1['HttpStatus']['BAD_REQUEST']);return _0x580228;}async['verifyUserPassword'](_0x36c82b,_0x4b6fe1){const _0x2baad6=_0x1c903d,_0x29a78b=await this['userEntity'][_0x2baad6(0x1d5)]({'where':{'id':_0x36c82b}});if(_0x29a78b[_0x2baad6(0x1f6)]['startsWith']('$2a$')||_0x29a78b[_0x2baad6(0x1f6)]['startsWith'](_0x2baad6(0x221))||_0x29a78b[_0x2baad6(0x1f6)][_0x2baad6(0x1e0)](_0x2baad6(0x231)))return bcrypt[_0x2baad6(0x1a1)](_0x4b6fe1,_0x29a78b['password']);else{const _0x4a1384=crypto[_0x2baad6(0x23a)]('md5')['update'](_0x4b6fe1)[_0x2baad6(0x232)](_0x2baad6(0x243));return console[_0x2baad6(0x1a9)](_0x2baad6(0x246),_0x4a1384),_0x4a1384===_0x29a78b[_0x2baad6(0x1f6)];}}async[_0x1c903d(0x1c5)](_0x42becb,_0xb70919){const _0x5cb0fc=_0x1c903d,_0x3dded2=await this[_0x5cb0fc(0x1b7)]['update']({'id':_0x42becb},{'status':_0xb70919});return _0x3dded2[_0x5cb0fc(0x219)]>0x0;}async[_0x1c903d(0x1f3)](_0x40c08b){const _0x31c9dd=_0x1c903d,_0x6c878d=await this['userEntity'][_0x31c9dd(0x1d5)]({'where':{'id':_0x40c08b}});return _0x6c878d[_0x31c9dd(0x1c8)];}async[_0x1c903d(0x218)](_0xea8eee){const _0x5d3310=_0x1c903d;return await this[_0x5d3310(0x1b7)]['findOne']({'where':{'id':_0xea8eee}});}async[_0x1c903d(0x223)](_0x362570){const _0x287454=_0x1c903d;return await this['userEntity'][_0x287454(0x1d5)]({'where':{'id':_0x362570}});}async[_0x1c903d(0x20d)](_0x4f4f39){const _0x501656=_0x1c903d,{id:_0x5d5772,role:_0x347be7}=_0x4f4f39;if(_0x347be7===_0x501656(0x208))return!![];const _0x3a1f92=await this[_0x501656(0x1b7)][_0x501656(0x1d5)]({'where':{'id':_0x5d5772}});if(!_0x3a1f92)throw new common_1[(_0x501656(0x1f8))](_0x501656(0x1b0),common_1[_0x501656(0x227)]['UNAUTHORIZED']);if(_0x3a1f92[_0x501656(0x1c8)]===user_constant_1[_0x501656(0x1d9)]['BLACKLISTED'])throw new common_1[(_0x501656(0x1f8))](_0x501656(0x23c),common_1[_0x501656(0x227)][_0x501656(0x1e9)]);if(_0x3a1f92['status']===user_constant_1[_0x501656(0x1d9)][_0x501656(0x1da)])throw new common_1[(_0x501656(0x1f8))](_0x501656(0x1a3),common_1[_0x501656(0x227)][_0x501656(0x1e9)]);}async['getUserInfo'](_0x1bb9ed){const _0x35d90d=_0x1c903d,_0x5b1616=await this[_0x35d90d(0x1b7)][_0x35d90d(0x1d5)]({'where':{'id':_0x1bb9ed},'select':['username',_0x35d90d(0x247),_0x35d90d(0x21c),_0x35d90d(0x1cd),_0x35d90d(0x1fa),_0x35d90d(0x19a),_0x35d90d(0x1ca),_0x35d90d(0x1ff)]});if(!_0x5b1616)throw new common_1[(_0x35d90d(0x1f8))](_0x35d90d(0x1b0),common_1[_0x35d90d(0x227)][_0x35d90d(0x1c1)]);_0x5b1616[_0x35d90d(0x1ea)]=!!(_0x5b1616===null||_0x5b1616===void 0x0?void 0x0:_0x5b1616['openId']),delete _0x5b1616[_0x35d90d(0x1ca)];const _0x2d4a44=await this['userBalanceService'][_0x35d90d(0x19d)](_0x1bb9ed);return{'userInfo':_0x5b1616,'userBalance':Object[_0x35d90d(0x240)]({},_0x2d4a44)};}async['getUserById'](_0x150649){const _0x8dd720=_0x1c903d;return await this['userEntity'][_0x8dd720(0x1d5)]({'where':{'id':_0x150649}});}async[_0x1c903d(0x1d4)](_0x36b666){const _0x3c226=_0x1c903d;return await this[_0x3c226(0x1b7)][_0x3c226(0x1d5)]({'where':{'openId':_0x36b666}});}async[_0x1c903d(0x228)](_0x281617,_0x3a20a1){const _0x24c3b6=_0x1c903d,{id:_0x5c1c0e}=_0x3a20a1[_0x24c3b6(0x222)],_0x888142=await this[_0x24c3b6(0x1b7)]['findOne']({'where':{'id':_0x5c1c0e}});if(!_0x888142)throw new common_1[(_0x24c3b6(0x1f8))](_0x24c3b6(0x21e),common_1[_0x24c3b6(0x227)]['BAD_REQUEST']);if(_0x281617[_0x24c3b6(0x225)]&&_0x888142['username']===_0x281617[_0x24c3b6(0x225)])throw new common_1[(_0x24c3b6(0x1f8))](_0x24c3b6(0x19e),common_1[_0x24c3b6(0x227)][_0x24c3b6(0x1e9)]);if(_0x281617[_0x24c3b6(0x225)]){const _0x25b46c=await this[_0x24c3b6(0x1b7)][_0x24c3b6(0x1d5)]({'where':{'username':_0x281617[_0x24c3b6(0x225)],'id':(0x0,typeorm_2[_0x24c3b6(0x1cf)])(_0x5c1c0e)}});if(_0x25b46c)throw new common_1[(_0x24c3b6(0x1f8))]('用户名已存在！',common_1[_0x24c3b6(0x227)][_0x24c3b6(0x1e9)]);}const _0x3bfb63=await this[_0x24c3b6(0x1b7)]['update']({'id':_0x5c1c0e},_0x281617);if(_0x3bfb63[_0x24c3b6(0x219)]<=0x0)throw new common_1[(_0x24c3b6(0x1f8))](_0x24c3b6(0x1f9),common_1['HttpStatus'][_0x24c3b6(0x1e9)]);return'修改用户信息成功！';}async[_0x1c903d(0x233)](_0x53e49a,_0x249d5e){const _0x5826f2=_0x1c903d,_0x2f0435=bcrypt['hashSync'](_0x249d5e,0xa),_0x282cd8=await this[_0x5826f2(0x1b7)][_0x5826f2(0x1cc)]({'id':_0x53e49a},{'password':_0x2f0435});if(_0x282cd8[_0x5826f2(0x219)]<=0x0)throw new common_1['HttpException'](_0x5826f2(0x1f4),common_1[_0x5826f2(0x227)][_0x5826f2(0x1e9)]);}async['genInviteCode'](_0x2df7e4){const _0x3df432=_0x1c903d,{id:_0x29cf63}=_0x2df7e4[_0x3df432(0x222)],_0x20fe6b=await this[_0x3df432(0x1b7)][_0x3df432(0x1d5)]({'where':{'id':_0x29cf63}});if(!_0x20fe6b||_0x20fe6b[_0x3df432(0x19a)])throw new common_1[(_0x3df432(0x1f8))](_0x3df432(0x21b),common_1[_0x3df432(0x227)][_0x3df432(0x1e9)]);const _0x2f8a9d=(0x0,utils_1[_0x3df432(0x1a2)])(),_0x563f42=await this['userEntity'][_0x3df432(0x1d5)]({'where':{'inviteCode':_0x2f8a9d}});if(_0x563f42)throw new common_1[(_0x3df432(0x1f8))](_0x3df432(0x1fe),common_1[_0x3df432(0x227)][_0x3df432(0x1e9)]);const _0x364242=await this['userEntity']['update']({'id':_0x29cf63},{'inviteCode':_0x2f8a9d});if(_0x364242['affected']<=0x0)throw new common_1['HttpException'](_0x3df432(0x1fe),common_1[_0x3df432(0x227)][_0x3df432(0x1e9)]);return _0x2f8a9d;}async[_0x1c903d(0x1ec)](_0x95b8e8,_0x36c374){const _0x558b5d=_0x1c903d;try{const {id:_0x38e109}=_0x95b8e8[_0x558b5d(0x222)],{page:page=0x1,size:size=0xa}=_0x36c374,_0xdfd3df=await this[_0x558b5d(0x1b7)][_0x558b5d(0x1d5)]({'where':{'id':_0x38e109}}),{inviteCode:_0x1b600a}=_0xdfd3df;if(!_0x1b600a)return[];const [_0x4202f4,_0x5c50d5]=await this[_0x558b5d(0x1b7)][_0x558b5d(0x22f)]({'where':{'inviteCode':_0x1b600a},'order':{'id':_0x558b5d(0x1bb)},'select':[_0x558b5d(0x225),_0x558b5d(0x1cd),_0x558b5d(0x1c9),_0x558b5d(0x1c8),_0x558b5d(0x247)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x558b5d(0x22a)])(_0x4202f4)[_0x558b5d(0x1bc)](_0x175727=>{const _0xd06561=_0x558b5d;return _0x175727[_0xd06561(0x1cd)]=(0x0,utils_1[_0xd06561(0x20f)])(_0x175727['email']),_0x175727;}),{'rows':_0x4202f4,'count':_0x5c50d5};}catch(_0x153417){console[_0x558b5d(0x1a9)](_0x558b5d(0x1db),_0x153417);throw new common_1['HttpException'](_0x558b5d(0x1f2),common_1[_0x558b5d(0x227)]['BAD_REQUEST']);}}async['inviteLink'](_0x3d5fd2){const _0x33251a=_0x1c903d,_0x57f262=await this['userEntity']['findOne']({'where':{'inviteCode':_0x3d5fd2}});if(!_0x57f262)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x57f262,_0x159ca6=await this[_0x33251a(0x1b7)]['update']({'inviteCode':_0x3d5fd2},{'inviteLinkCount':inviteLinkCount+0x1});return _0x159ca6[_0x33251a(0x219)]?0x1:0x0;}async['qureyUserInfoByInviteCode'](_0x5093c2){const _0x52f1f8=_0x1c903d;return await this[_0x52f1f8(0x1b7)]['findOne']({'where':{'inviteCode':_0x5093c2}});}async['userRecharge'](_0x3d0afe){const _0x4af26b=_0x1c903d,{userId:_0x35814b,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3d0afe;await this['userBalanceService']['addBalanceToUser'](_0x35814b,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x456f12=await this[_0x4af26b(0x1e6)]['saveRecordRechargeLog']({'userId':_0x35814b,'rechargeType':balance_constant_1[_0x4af26b(0x241)]['ADMIN_GIFT'],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x456f12;}async[_0x1c903d(0x1d1)](_0x15ad77,_0xecdd11){const _0x25dedb=_0x1c903d,{page:page=0x1,size:size=0xa,username:_0x289671,email:_0x46fc3c,status:_0x207a30,keyword:_0x36c54e,phone:_0x5c7e52}=_0x15ad77;let _0x1b64ae={};_0x289671&&Object[_0x25dedb(0x240)](_0x1b64ae,{'username':(0x0,typeorm_2[_0x25dedb(0x211)])('%'+_0x289671+'%')}),_0x46fc3c&&Object[_0x25dedb(0x240)](_0x1b64ae,{'email':(0x0,typeorm_2[_0x25dedb(0x211)])('%'+_0x46fc3c+'%')}),_0x5c7e52&&Object[_0x25dedb(0x240)](_0x1b64ae,{'phone':(0x0,typeorm_2[_0x25dedb(0x211)])('%'+_0x5c7e52+'%')}),_0x207a30&&Object[_0x25dedb(0x240)](_0x1b64ae,{'status':_0x207a30});_0x36c54e&&(_0x1b64ae=[{'username':(0x0,typeorm_2[_0x25dedb(0x211)])('%'+_0x36c54e+'%')},{'email':(0x0,typeorm_2[_0x25dedb(0x211)])('%'+_0x36c54e+'%')},{'phone':(0x0,typeorm_2[_0x25dedb(0x211)])('%'+_0x36c54e+'%')}]);const [_0x59c1c3,_0x396486]=await this[_0x25dedb(0x1b7)][_0x25dedb(0x22f)]({'skip':(page-0x1)*size,'where':_0x1b64ae,'take':size,'order':{'createdAt':'DESC'},'cache':!![],'select':[_0x25dedb(0x225),_0x25dedb(0x247),_0x25dedb(0x19a),_0x25dedb(0x21c),_0x25dedb(0x1fa),'status','id','email',_0x25dedb(0x1c9),_0x25dedb(0x1eb),_0x25dedb(0x201)]}),_0x3062cf=_0x59c1c3[_0x25dedb(0x1bc)](_0x432e6f=>_0x432e6f['id']),_0x4279fb=await this['userBalanceService'][_0x25dedb(0x1f0)](_0x3062cf);return _0x59c1c3[_0x25dedb(0x1e2)](_0x310f8e=>_0x310f8e[_0x25dedb(0x242)]=_0x4279fb[_0x25dedb(0x220)](_0x17a752=>_0x17a752[_0x25dedb(0x1fc)]===_0x310f8e['id'])),_0xecdd11[_0x25dedb(0x222)]['role']!==_0x25dedb(0x200)&&_0x59c1c3[_0x25dedb(0x1e2)](_0x4ffa3c=>_0x4ffa3c[_0x25dedb(0x1cd)]=(0x0,utils_1['maskEmail'])(_0x4ffa3c[_0x25dedb(0x1cd)])),_0xecdd11[_0x25dedb(0x222)][_0x25dedb(0x21c)]!=='super'&&_0x59c1c3[_0x25dedb(0x1e2)](_0x3901c5=>_0x3901c5[_0x25dedb(0x1eb)]=(0x0,utils_1[_0x25dedb(0x249)])(_0x3901c5[_0x25dedb(0x1eb)])),_0xecdd11[_0x25dedb(0x222)][_0x25dedb(0x21c)]!==_0x25dedb(0x200)&&_0x59c1c3['forEach'](_0x5b8275=>_0x5b8275[_0x25dedb(0x201)]=(0x0,utils_1[_0x25dedb(0x249)])(_0x5b8275[_0x25dedb(0x201)])),{'rows':_0x59c1c3,'count':_0x396486};}async[_0x1c903d(0x209)]({id:_0x3b28fa}){const _0x3b2b25=_0x1c903d;return await this[_0x3b2b25(0x1b7)][_0x3b2b25(0x1d5)]({'where':{'id':_0x3b28fa},'select':[_0x3b2b25(0x225),_0x3b2b25(0x247),_0x3b2b25(0x19a),_0x3b2b25(0x21c),_0x3b2b25(0x1fa),'status']});}async[_0x1c903d(0x1cb)](_0x2656fb){const _0x2beba8=_0x1c903d,{id:_0x20c66a,status:_0x529af3}=_0x2656fb,_0x140bc8=await this[_0x2beba8(0x1b7)]['findOne']({'where':{'id':_0x20c66a}});if(!_0x140bc8)throw new common_1[(_0x2beba8(0x1f8))](_0x2beba8(0x1a7),common_1[_0x2beba8(0x227)][_0x2beba8(0x1e9)]);if(_0x140bc8[_0x2beba8(0x21c)]==='super')throw new common_1[(_0x2beba8(0x1f8))](_0x2beba8(0x214),common_1[_0x2beba8(0x227)][_0x2beba8(0x1e9)]);if(_0x140bc8['status']===user_constant_1[_0x2beba8(0x1d9)][_0x2beba8(0x1a6)])throw new common_1[(_0x2beba8(0x1f8))]('未激活用户不可手动变更状态！',common_1['HttpStatus'][_0x2beba8(0x1e9)]);if(_0x140bc8['role']==='super')throw new common_1[(_0x2beba8(0x1f8))](_0x2beba8(0x214),common_1[_0x2beba8(0x227)][_0x2beba8(0x1e9)]);if(_0x529af3===user_constant_1[_0x2beba8(0x1d9)][_0x2beba8(0x1a6)])throw new common_1['HttpException'](_0x2beba8(0x248),common_1[_0x2beba8(0x227)][_0x2beba8(0x1e9)]);const _0xddf89d=await this[_0x2beba8(0x1b7)]['update']({'id':_0x20c66a},{'status':_0x529af3});if(_0xddf89d[_0x2beba8(0x219)]<=0x0)throw new common_1[(_0x2beba8(0x1f8))]('修改用户状态失败！',common_1[_0x2beba8(0x227)][_0x2beba8(0x1e9)]);return _0x2beba8(0x198);}async[_0x1c903d(0x1c7)](_0x2d3bd6){const _0x1227ee=_0x1c903d,{id:_0x2495e6}=_0x2d3bd6,_0x4856e6=await this[_0x1227ee(0x1b7)][_0x1227ee(0x1d5)]({'where':{'id':_0x2495e6}});if(!_0x4856e6)throw new common_1['HttpException'](_0x1227ee(0x1a7),common_1[_0x1227ee(0x227)]['BAD_REQUEST']);const _0x4cc447=_0x1227ee(0x1c0),_0x386df8=bcrypt[_0x1227ee(0x1a0)](_0x4cc447,0xa),_0x2b8d02=await this[_0x1227ee(0x1b7)]['update']({'id':_0x2495e6},{'password':_0x386df8});if(_0x2b8d02[_0x1227ee(0x219)]<=0x0)throw new common_1[(_0x1227ee(0x1f8))](_0x1227ee(0x1d6),common_1[_0x1227ee(0x227)][_0x1227ee(0x1e9)]);return _0x1227ee(0x23f)+_0x4cc447+_0x1227ee(0x1ed);}async[_0x1c903d(0x21a)](_0x46a6b3,_0x28dada){const _0x1db777=_0x1c903d;return await this[_0x1db777(0x1b7)][_0x1db777(0x1cc)]({'id':_0x46a6b3},{'lastLoginIp':_0x28dada});}async['getUserFromOpenId'](_0x53a1e7,_0x11f5bb){const _0x4b251d=_0x1c903d,_0xf37387=await this['userEntity']['findOne']({'where':{'openId':_0x53a1e7}});if(!_0xf37387){const _0x3f6889=_0x11f5bb?_0x11f5bb[_0x4b251d(0x1f5)](':')[0x1]:'',_0x11b11d=await this[_0x4b251d(0x203)](_0x3f6889),_0x22503a=await this[_0x4b251d(0x224)](_0x53a1e7,_0x3f6889);return await this[_0x4b251d(0x1e6)]['addBalanceToNewUser'](_0x22503a['id'],_0x3f6889?_0x11b11d===null||_0x11b11d===void 0x0?void 0x0:_0x11b11d['id']:null),_0x22503a;}return _0xf37387;}async[_0x1c903d(0x224)](_0x21c2eb,_0x56fee0){const _0x1966d7=_0x1c903d,_0x4509a4=await this[_0x1966d7(0x1e4)]['getConfigs']([_0x1966d7(0x1fb)]),_0x293cc8={'avatar':_0x4509a4,'username':'用户'+(0x0,utils_1[_0x1966d7(0x19f)])(),'status':user_constant_1[_0x1966d7(0x1d9)][_0x1966d7(0x23e)],'sex':0x0,'email':(0x0,utils_1[_0x1966d7(0x19f)])()+_0x1966d7(0x22c),'invitedBy':_0x56fee0,'openId':_0x21c2eb},_0x40b979=await this[_0x1966d7(0x1b7)][_0x1966d7(0x1ae)](_0x293cc8);return _0x40b979;}async[_0x1c903d(0x207)](_0x1de47d,_0x152006){const _0x3a182a=_0x1c903d;try{const _0x506679=await this[_0x3a182a(0x1b7)][_0x3a182a(0x1d5)]({'where':{'id':_0x152006}});if(!_0x506679)return{'status':![],'msg':_0x3a182a(0x1c6)};const _0x4e3141=await this['userEntity'][_0x3a182a(0x1d5)]({'where':{'openId':_0x1de47d}});if(_0x4e3141)return{'status':![],'msg':_0x3a182a(0x1ba)};const _0x38ac89=await this[_0x3a182a(0x1b7)][_0x3a182a(0x1cc)]({'id':_0x152006},{'openId':_0x1de47d});if(_0x38ac89[_0x3a182a(0x219)]<=0x0)return{'status':![],'msg':'绑定微信失败、请联系管理员！'};return{'status':!![],'msg':_0x3a182a(0x1c2)};}catch(_0x1bdbe6){return{'status':![],'msg':_0x3a182a(0x1e5)};}}async[_0x1c903d(0x1ce)](_0x3078cd){const _0x25d75a=_0x1c903d,_0x1a0047=await this['userEntity'][_0x25d75a(0x1d5)]({'where':{'id':_0x3078cd}});return _0x1a0047===null||_0x1a0047===void 0x0?void 0x0:_0x1a0047[_0x25d75a(0x1ca)];}async[_0x1c903d(0x1af)](_0x172143){const _0x1c2eab=_0x1c903d,{username:_0x30438b,password:_0x32328d,phone:_0x17e9a8,phoneCode:_0x59ae62}=_0x172143,_0x1c1789=await this[_0x1c2eab(0x1b7)][_0x1c2eab(0x1d5)]({'where':[{'username':_0x30438b},{'phone':_0x17e9a8}]});if(_0x1c1789&&_0x1c1789[_0x1c2eab(0x225)]===_0x30438b)throw new common_1['HttpException'](_0x1c2eab(0x1a5),common_1[_0x1c2eab(0x227)][_0x1c2eab(0x1e9)]);if(_0x1c1789&&_0x1c1789[_0x1c2eab(0x201)]===_0x17e9a8)throw new common_1[(_0x1c2eab(0x1f8))](_0x1c2eab(0x1bd),common_1[_0x1c2eab(0x227)][_0x1c2eab(0x1e9)]);}async[_0x1c903d(0x1ac)](_0x5e5aa4){const _0x16faba=_0x1c903d;return await this[_0x16faba(0x1b7)][_0x16faba(0x1ae)](_0x5e5aa4);}};UserService=__decorate([(0x0,common_1[_0x1c903d(0x1b2)])(),__param(0x0,(0x0,typeorm_1[_0x1c903d(0x202)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1[_0x1c903d(0x1d0)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(config_entity_1['ConfigEntity'])),__metadata(_0x1c903d(0x210),[typeorm_2[_0x1c903d(0x23b)],typeorm_2['Repository'],typeorm_2[_0x1c903d(0x1c3)],verification_service_1['VerificationService'],mailer_1[_0x1c903d(0x1a8)],userBalance_service_1[_0x1c903d(0x1aa)],globalConfig_service_1[_0x1c903d(0x206)],typeorm_2[_0x1c903d(0x23b)]])],UserService),exports[_0x1c903d(0x21f)]=UserService;function _0x3291(){const _0x15d79a=['用户不存在！','MailerService','log','UserBalanceService','210780TXLboJ','createUser','../../common/utils','save','verifyUserRegisterByPhone','当前用户信息失效、请重新登录！','getClientIp','Injectable','1jIlcVu','10934304gFrCIL','configMap:\x20','2097760bBEKAG','userEntity','@nestjs-modules/mailer','__param','该微信已绑定其他账号！','DESC','map','当前手机号已注册、请勿重复注册！','registerIp','337635NPgCNK','123456','UNAUTHORIZED','恭喜您绑定成功、后续可直接扫码登录了！','Connection','当前密码错误！','updateUserStatus','当前绑定用户不存在！','resetUserPass','status','createdAt','openId','updateStatus','update','email','getOpenIdByUserId','Not','WhiteListEntity','queryAll','mailerService','verificationService','getUserOpenId','findOne','重置密码失败！','crypto','reduce','UserStatusEnum','LOCKED','error:\x20','registerVerifyExpir','sendMail','md5','lodash','startsWith','../globalConfig/config.entity','forEach','configKey','globalConfigService','绑定微信失败、请联系管理员！','userBalanceService','./user.entity','../verification/verification.service','BAD_REQUEST','isBindWx','lastLoginIp','getInviteRecord',']成功!','5248712JzDbiJ','verifyUserCredentials','queryUserBalanceByIds','createUserAndVerifycation','获取邀请记录失败！','getUserStatus','修改密码失败、请重新试试吧。','split','password','getSuper','HttpException','修改用户信息失败！','sign','userDefautlAvatar','userId','length','生成邀请码失败，请重新试一次吧！','consecutiveDays','super','phone','InjectRepository','qureyUserInfoByInviteCode','当前账户不存在！','../userBalance/userBalance.service','GlobalConfigService','bindWx','visitor','queryOne','object','registerBaseUrl','connection','checkUserStatus','../globalConfig/globalConfig.service','maskEmail','design:paramtypes','Like','defineProperty','66AANdWh','超级管理员不可被操作！','@nestjs/typeorm','isVerifyEmail','VerificationEnum','queryUserInfoById','affected','savaLoginIp','已生成过邀请码、请勿重复生成','role','registerVerifyEmailDesc','当前用户不存在！','UserService','find','$2b$','user','queryOneUserInfo','createUserFromOpenId','username','getConfigs','HttpStatus','updateInfo','registerVerifyEmailFrom','formatCreateOrUpdateDate','24637815HHntyA','@default.com','createVerification','addBalanceToNewUser','findAndCount','getOwnPropertyDescriptor','$2y$','digest','updateUserPassword','configVal','@nestjs/common','../../common/constants/verification.constant','configEntity','4335201LitXHa','register','createHash','Repository','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','Registration','ACTIVE','密码重置为[','assign','RechargeType','balanceInfo','hex','../../common/constants/balance.constant','UserStatusErrMsg','----,','avatar','不可将用户置为未激活状态！','maskIpAddress','修改用户状态成功！','registerVerifyEmailTitle','inviteCode','__esModule','bcryptjs','queryUserBalance','没有变更，无需更改！','createRandomUid','hashSync','compareSync','generateRandomString','您的账户已被封禁、如有疑问、请联系管理员！','__metadata','用户名已存在、请更换用户名！','PENDING'];_0x3291=function(){return _0x15d79a;};return _0x3291();}