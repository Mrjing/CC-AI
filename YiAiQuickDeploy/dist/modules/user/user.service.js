'use strict';function _0x46bc(){const _0xf737bd=['save','超级管理员不可被操作！','userId','globalConfigService','log','当前账户不存在！','绑定微信失败、请联系管理员！','__decorate','updateInfo','registerVerifyEmailTitle','getConfigs','bcryptjs','当前密码错误！','Not','您的账户已被封禁、如有疑问、请联系管理员！','update','defineProperty','HttpException','createUser','$2b$','../../common/utils','status','createUserAndVerifycation','$2y$','generateRandomString','397740BwuhLs','checkUserStatus','getClientIp','queryUserInfoById','role','assign','error:\x20','HttpStatus','userDefautlAvatar','$2a$','用户名已存在、请更换用户名！','无效的邀请码！','queryOneUserInfo','email\x20response\x20\x20->\x20:\x20','../globalConfig/globalConfig.service','metadata','getSuper','getUserFromOpenId','Registration','getUserById','createVerification','ConfigEntity','Repository','digest','compareSync','WhiteListEntity','createdAt','不可将用户置为未激活状态！','isVerifyEmail','@nestjs/typeorm','phone','createUserFromOpenId','BAD_REQUEST','UserEntity','maskIpAddress','bindWx','lodash','./user.entity','../../common/constants/verification.constant','maskEmail','createRandomUid','123456','userBalanceService','没有变更，无需更改！','PENDING','md5','当前用户不存在！','__esModule','avatar','GlobalConfigService','consecutiveDays','用户不存在！','该微信已绑定其他账号！','openId','VerificationService','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','----,','queryUserBalance','密码重置为[','ACTIVE','saveRecordRechargeLog','../../common/constants/user.constant','qureyUserInfoByInviteCode','hex','typeorm','2813784rAgGnQ','未激活用户不可手动变更状态！','affected','addBalanceToUser','updateUserStatus','生成邀请码失败，请重新试一次吧！','当前绑定用户不存在！','1002416TWNRWV','sign','registerBaseUrl','formatCreateOrUpdateDate','verifyUserRegisterByPhone','RechargeType','configMap:\x20','createHash','registerIp','获取邀请记录失败！','super','findAndCount','UserService','getOwnPropertyDescriptor','registerVerifyExpir','register','verifyUserPassword','find','../chatgpt/whiteList.entity','149224FKlzGy','length','decorate','object','修改密码失败、请重新试试吧。','lastLoginIp','function','Like','getUserStatus','379235qjDoLc','../userBalance/userBalance.service','forEach','inviteLink','InjectRepository','UNAUTHORIZED','288465VuZqru','getOpenIdByUserId','DESC','password','../globalConfig/config.entity','map','addBalanceToNewUser','恭喜您绑定成功、后续可直接扫码登录了！','重置密码失败！','../../common/constants/balance.constant','username','修改用户状态失败！','__param','@nestjs/common','userRecharge','user','registerVerifyEmailDesc','mailerService','6aiujMn','Connection','sendMail','已生成过邀请码、请勿重复生成','Injectable','startsWith','1149906vjSMRN','email','LOCKED','getInviteRecord','ADMIN_GIFT','__metadata','visitor','修改用户信息失败！','balanceInfo','userEntity','@default.com','hashSync','inviteCode','whiteListEntity','updateUserPassword','design:paramtypes','verifyUserCredentials','的账号激活','cloneDeep','findOne','UserStatusEnum','configEntity','@nestjs-modules/mailer','UserBalanceService','VerificationEnum'];_0x46bc=function(){return _0xf737bd;};return _0x46bc();}const _0x3818a7=_0x48f9;function _0x48f9(_0x3faafa,_0x15eb0e){const _0x46bc05=_0x46bc();return _0x48f9=function(_0x48f975,_0x53129d){_0x48f975=_0x48f975-0x1aa;let _0x3bb353=_0x46bc05[_0x48f975];return _0x3bb353;},_0x48f9(_0x3faafa,_0x15eb0e);}(function(_0xfda144,_0x48c754){const _0xef3405=_0x48f9,_0x5746d4=_0xfda144();while(!![]){try{const _0x201b37=-parseInt(_0xef3405(0x1ca))/0x1+-parseInt(_0xef3405(0x1bb))/0x2*(-parseInt(_0xef3405(0x1dc))/0x3)+-parseInt(_0xef3405(0x25c))/0x4+parseInt(_0xef3405(0x1c4))/0x5+parseInt(_0xef3405(0x1e2))/0x6+-parseInt(_0xef3405(0x214))/0x7+parseInt(_0xef3405(0x255))/0x8;if(_0x201b37===_0x48c754)break;else _0x5746d4['push'](_0x5746d4['shift']());}catch(_0x5be839){_0x5746d4['push'](_0x5746d4['shift']());}}}(_0x46bc,0x2a20c));var __decorate=this&&this[_0x3818a7(0x202)]||function(_0x26bad6,_0x442501,_0x5cd22e,_0x3bda35){const _0x424c83=_0x3818a7;var _0x28628f=arguments[_0x424c83(0x1bc)],_0x236f78=_0x28628f<0x3?_0x442501:_0x3bda35===null?_0x3bda35=Object[_0x424c83(0x1b5)](_0x442501,_0x5cd22e):_0x3bda35,_0xbfa19f;if(typeof Reflect==='object'&&typeof Reflect[_0x424c83(0x1bd)]===_0x424c83(0x1c1))_0x236f78=Reflect[_0x424c83(0x1bd)](_0x26bad6,_0x442501,_0x5cd22e,_0x3bda35);else{for(var _0x54eacf=_0x26bad6['length']-0x1;_0x54eacf>=0x0;_0x54eacf--)if(_0xbfa19f=_0x26bad6[_0x54eacf])_0x236f78=(_0x28628f<0x3?_0xbfa19f(_0x236f78):_0x28628f>0x3?_0xbfa19f(_0x442501,_0x5cd22e,_0x236f78):_0xbfa19f(_0x442501,_0x5cd22e))||_0x236f78;}return _0x28628f>0x3&&_0x236f78&&Object[_0x424c83(0x20b)](_0x442501,_0x5cd22e,_0x236f78),_0x236f78;},__metadata=this&&this[_0x3818a7(0x1e7)]||function(_0x132e8f,_0xc1c77b){const _0x384a83=_0x3818a7;if(typeof Reflect===_0x384a83(0x1be)&&typeof Reflect[_0x384a83(0x223)]===_0x384a83(0x1c1))return Reflect[_0x384a83(0x223)](_0x132e8f,_0xc1c77b);},__param=this&&this[_0x3818a7(0x1d6)]||function(_0x37c56e,_0x1d92b7){return function(_0x222e27,_0x52223c){_0x1d92b7(_0x222e27,_0x52223c,_0x37c56e);};};Object[_0x3818a7(0x20b)](exports,_0x3818a7(0x243),{'value':!![]}),exports[_0x3818a7(0x1b4)]=void 0x0;const globalConfig_service_1=require(_0x3818a7(0x222)),user_constant_1=require(_0x3818a7(0x251)),mailer_1=require(_0x3818a7(0x1f8)),verification_service_1=require('../verification/verification.service'),common_1=require(_0x3818a7(0x1d7)),typeorm_1=require(_0x3818a7(0x231)),typeorm_2=require(_0x3818a7(0x254)),user_entity_1=require(_0x3818a7(0x239)),bcrypt=require(_0x3818a7(0x206)),crypto=require('crypto'),_=require(_0x3818a7(0x238)),verification_constant_1=require(_0x3818a7(0x23a)),userBalance_service_1=require(_0x3818a7(0x1c5)),utils_1=require(_0x3818a7(0x20f)),balance_constant_1=require(_0x3818a7(0x1d3)),config_entity_1=require(_0x3818a7(0x1ce)),whiteList_entity_1=require(_0x3818a7(0x1ba));let UserService=class UserService{constructor(_0x5ef08c,_0x5c193c,_0x51d6d5,_0x1398d1,_0x5e677c,_0xd3b0b2,_0x313683,_0x20bda4){const _0x2c92b5=_0x3818a7;this[_0x2c92b5(0x1eb)]=_0x5ef08c,this[_0x2c92b5(0x1ef)]=_0x5c193c,this['connection']=_0x51d6d5,this['verificationService']=_0x1398d1,this[_0x2c92b5(0x1db)]=_0x5e677c,this['userBalanceService']=_0xd3b0b2,this[_0x2c92b5(0x1fe)]=_0x313683,this['configEntity']=_0x20bda4;}async[_0x3818a7(0x211)](_0x2bdcd3,_0x9b3d14){const _0x3be120=_0x3818a7,{username:_0x4e2815,email:_0x413e36,password:_0x57f8fe,invitedBy:_0x44a122,client:client=0x0}=_0x2bdcd3;if(_0x44a122){const _0xae6611=await this[_0x3be120(0x1eb)][_0x3be120(0x1f5)]({'where':{'inviteCode':_0x44a122}});if(!_0xae6611)throw new common_1[(_0x3be120(0x20c))](_0x3be120(0x21f),common_1[_0x3be120(0x21b)][_0x3be120(0x234)]);}const _0x5cafb0=[{'username':_0x4e2815},{'email':_0x413e36}],_0x494deb=await this['userEntity'][_0x3be120(0x1f5)]({'where':_0x5cafb0});if(_0x494deb&&_0x494deb[_0x3be120(0x210)]!==user_constant_1[_0x3be120(0x1f6)][_0x3be120(0x240)])throw new common_1['HttpException']('用户名或者邮箱已被注册！',common_1[_0x3be120(0x21b)][_0x3be120(0x234)]);try{const _0x51c551=_[_0x3be120(0x1f4)](_0x2bdcd3),_0x47e05b=bcrypt[_0x3be120(0x1ed)](_0x57f8fe,0xa),_0x5e3873=(0x0,utils_1[_0x3be120(0x216)])(_0x9b3d14);_0x51c551[_0x3be120(0x1cd)]=_0x47e05b,_0x51c551[_0x3be120(0x1b0)]=_0x5e3873,_0x51c551['client']=client;let _0x333434;if(!_0x494deb){const _0x57a39d=await this[_0x3be120(0x1fe)][_0x3be120(0x205)]([_0x3be120(0x21c)]);_0x51c551['avatar']=_0x57a39d,_0x333434=await this[_0x3be120(0x1eb)][_0x3be120(0x1fb)](_0x51c551);}else _0x333434=_0x494deb;const _0x2a42de=await this[_0x3be120(0x1f7)][_0x3be120(0x1b9)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x3be120(0x230),_0x3be120(0x1aa),_0x3be120(0x204),_0x3be120(0x1da),'registerVerifyEmailFrom',_0x3be120(0x1b6)])}}),_0x4563cb=_0x2a42de['reduce']((_0x2f77b4,_0xb0ca)=>{return _0x2f77b4[_0xb0ca['configKey']]=_0xb0ca['configVal'],_0x2f77b4;},{}),_0x4fc99a=_0x4563cb[_0x3be120(0x230)]?Number(_0x4563cb['isVerifyEmail']):0x1;if(_0x4fc99a){const _0x44bb96=_0x4563cb['registerVerifyExpir']?Number(_0x4563cb[_0x3be120(0x1b6)]):0x1e*0x3c,_0x143d67=await this['verificationService'][_0x3be120(0x228)](_0x333434,verification_constant_1[_0x3be120(0x1fa)][_0x3be120(0x226)],_0x44bb96),{code:_0xe0a07a,email:_0xe071e8,id:_0x1d2827}=_0x143d67,{registerVerifyEmailFrom:_0x566f8b}=_0x4563cb;console[_0x3be120(0x1ff)](_0x3be120(0x1ae),_0x4563cb);const _0x1d3a35=await this[_0x3be120(0x1db)][_0x3be120(0x1de)]({'to':_0xe071e8,'subject':'来自'+_0x566f8b+_0x3be120(0x1f3),'template':_0x3be120(0x1b7),'context':Object[_0x3be120(0x219)]({'baseUrl':_0x4563cb[_0x3be120(0x1aa)],'code':_0xe0a07a,'id':_0x1d2827},_0x4563cb)});console[_0x3be120(0x1ff)](_0x3be120(0x221),_0x1d3a35);}else{const {username:_0x74637,email:_0x596b23,id:_0x1689d4,invitedBy:_0x39833d}=_0x333434;await this[_0x3be120(0x259)](_0x1689d4,user_constant_1[_0x3be120(0x1f6)][_0x3be120(0x24f)]);let _0x3571a3;_0x39833d&&(_0x3571a3=await this[_0x3be120(0x252)](_0x39833d)),await this[_0x3be120(0x23e)]['addBalanceToNewUser'](_0x1689d4,_0x3571a3===null||_0x3571a3===void 0x0?void 0x0:_0x3571a3['id']);}return _0x333434;}catch(_0x39b9a3){console[_0x3be120(0x1ff)](_0x3be120(0x21a),_0x39b9a3);throw _0x39b9a3;}}async[_0x3818a7(0x224)](){const _0x550184=_0x3818a7,_0x4a7d00=await this['userEntity'][_0x550184(0x1f5)]({'where':{'role':'super'}});return _0x4a7d00;}async[_0x3818a7(0x1f2)](_0x35e0bb){const _0x2216fb=_0x3818a7,{username:_0x4afac9,password:_0x21c6ef,uid:uid=0x0,phone:_0x4df857}=_0x35e0bb;let _0x2989a4=null;if(uid>0x0){_0x2989a4=await this[_0x2216fb(0x1eb)][_0x2216fb(0x1f5)]({'where':{'id':uid}});if(!_0x2989a4)throw new common_1['HttpException'](_0x2216fb(0x200),common_1['HttpStatus'][_0x2216fb(0x234)]);if(_0x2989a4[_0x2216fb(0x1cd)][_0x2216fb(0x1e1)]('$2a$')||_0x2989a4['password'][_0x2216fb(0x1e1)](_0x2216fb(0x20e))||_0x2989a4[_0x2216fb(0x1cd)][_0x2216fb(0x1e1)]('$2y$')){if(!bcrypt[_0x2216fb(0x22c)](_0x21c6ef,_0x2989a4[_0x2216fb(0x1cd)]))throw new common_1[(_0x2216fb(0x20c))]('当前密码错误！',common_1['HttpStatus'][_0x2216fb(0x234)]);}else{console[_0x2216fb(0x1ff)](_0x2216fb(0x24c));const _0x5cec3d=crypto[_0x2216fb(0x1af)](_0x2216fb(0x241))[_0x2216fb(0x20a)](_0x21c6ef)[_0x2216fb(0x22b)]('hex');console[_0x2216fb(0x1ff)]('----,',_0x5cec3d);if(_0x5cec3d!==_0x2989a4[_0x2216fb(0x1cd)])throw new common_1[(_0x2216fb(0x20c))](_0x2216fb(0x207),common_1['HttpStatus'][_0x2216fb(0x234)]);}}if(_0x4afac9&&_0x21c6ef){const _0x54fcc7=[{'username':_0x4afac9},{'email':_0x4afac9}];_0x2989a4=await this[_0x2216fb(0x1eb)]['findOne']({'where':_0x54fcc7});if(!_0x2989a4)throw new common_1[(_0x2216fb(0x20c))](_0x2216fb(0x200),common_1['HttpStatus']['BAD_REQUEST']);if(_0x2989a4[_0x2216fb(0x1cd)][_0x2216fb(0x1e1)](_0x2216fb(0x21d))||_0x2989a4[_0x2216fb(0x1cd)]['startsWith'](_0x2216fb(0x20e))||_0x2989a4[_0x2216fb(0x1cd)]['startsWith'](_0x2216fb(0x212))){if(!bcrypt[_0x2216fb(0x22c)](_0x21c6ef,_0x2989a4[_0x2216fb(0x1cd)]))throw new common_1[(_0x2216fb(0x20c))](_0x2216fb(0x207),common_1['HttpStatus'][_0x2216fb(0x234)]);}else{console[_0x2216fb(0x1ff)](_0x2216fb(0x24c));const _0x39776f=crypto[_0x2216fb(0x1af)](_0x2216fb(0x241))[_0x2216fb(0x20a)](_0x21c6ef)[_0x2216fb(0x22b)](_0x2216fb(0x253));console[_0x2216fb(0x1ff)]('----,',_0x39776f);if(_0x39776f!==_0x2989a4[_0x2216fb(0x1cd)])throw new common_1['HttpException'](_0x2216fb(0x207),common_1[_0x2216fb(0x21b)]['BAD_REQUEST']);}}if(_0x4df857&&_0x21c6ef){const _0x551ec0=[{'phone':_0x4df857}];_0x2989a4=await this[_0x2216fb(0x1eb)][_0x2216fb(0x1f5)]({'where':_0x551ec0});if(!_0x2989a4)throw new common_1['HttpException'](_0x2216fb(0x200),common_1['HttpStatus'][_0x2216fb(0x234)]);if(_0x2989a4['password'][_0x2216fb(0x1e1)](_0x2216fb(0x21d))||_0x2989a4[_0x2216fb(0x1cd)][_0x2216fb(0x1e1)](_0x2216fb(0x20e))||_0x2989a4[_0x2216fb(0x1cd)][_0x2216fb(0x1e1)](_0x2216fb(0x212))){if(!bcrypt[_0x2216fb(0x22c)](_0x21c6ef,_0x2989a4[_0x2216fb(0x1cd)]))throw new common_1[(_0x2216fb(0x20c))](_0x2216fb(0x207),common_1['HttpStatus'][_0x2216fb(0x234)]);}else{console['log'](_0x2216fb(0x24c));const _0x2843cb=crypto[_0x2216fb(0x1af)](_0x2216fb(0x241))[_0x2216fb(0x20a)](_0x21c6ef)['digest']('hex');console[_0x2216fb(0x1ff)](_0x2216fb(0x24c),_0x2843cb);if(_0x2843cb!==_0x2989a4[_0x2216fb(0x1cd)])throw new common_1['HttpException']('当前密码错误！',common_1[_0x2216fb(0x21b)][_0x2216fb(0x234)]);}}if(!_0x2989a4)throw new common_1[(_0x2216fb(0x20c))](_0x2216fb(0x200),common_1[_0x2216fb(0x21b)][_0x2216fb(0x234)]);if(_0x2989a4['status']!==user_constant_1[_0x2216fb(0x1f6)][_0x2216fb(0x24f)])throw new common_1['HttpException'](user_constant_1['UserStatusErrMsg'][_0x2989a4['status']],common_1[_0x2216fb(0x21b)]['BAD_REQUEST']);return _0x2989a4;}async[_0x3818a7(0x1b8)](_0x4cb1bf,_0xe0c051){const _0x55d60f=_0x3818a7,_0x1bec00=await this['userEntity']['findOne']({'where':{'id':_0x4cb1bf}});if(_0x1bec00[_0x55d60f(0x1cd)][_0x55d60f(0x1e1)](_0x55d60f(0x21d))||_0x1bec00[_0x55d60f(0x1cd)]['startsWith'](_0x55d60f(0x20e))||_0x1bec00[_0x55d60f(0x1cd)]['startsWith'](_0x55d60f(0x212)))return bcrypt['compareSync'](_0xe0c051,_0x1bec00[_0x55d60f(0x1cd)]);else{const _0x44bfd2=crypto['createHash'](_0x55d60f(0x241))[_0x55d60f(0x20a)](_0xe0c051)[_0x55d60f(0x22b)]('hex');return console[_0x55d60f(0x1ff)](_0x55d60f(0x24c),_0x44bfd2),_0x44bfd2===_0x1bec00[_0x55d60f(0x1cd)];}}async[_0x3818a7(0x259)](_0x38b147,_0x54d749){const _0x5ecb27=_0x3818a7,_0x209159=await this[_0x5ecb27(0x1eb)]['update']({'id':_0x38b147},{'status':_0x54d749});return _0x209159[_0x5ecb27(0x257)]>0x0;}async[_0x3818a7(0x1c3)](_0x32b2f6){const _0x4568da=_0x3818a7,_0x2e4dc6=await this[_0x4568da(0x1eb)][_0x4568da(0x1f5)]({'where':{'id':_0x32b2f6}});return _0x2e4dc6['status'];}async[_0x3818a7(0x217)](_0x450d9d){const _0x55e3c8=_0x3818a7;return await this[_0x55e3c8(0x1eb)][_0x55e3c8(0x1f5)]({'where':{'id':_0x450d9d}});}async[_0x3818a7(0x220)](_0x202ec5){const _0x3fdb42=_0x3818a7;return await this[_0x3fdb42(0x1eb)][_0x3fdb42(0x1f5)]({'where':{'id':_0x202ec5}});}async[_0x3818a7(0x215)](_0x3f04d6){const _0x2bcbbc=_0x3818a7,{id:_0x424d84,role:_0x13fb42}=_0x3f04d6;if(_0x13fb42===_0x2bcbbc(0x1e8))return!![];const _0x48503e=await this[_0x2bcbbc(0x1eb)][_0x2bcbbc(0x1f5)]({'where':{'id':_0x424d84}});if(!_0x48503e)throw new common_1['HttpException']('当前用户信息失效、请重新登录！',common_1[_0x2bcbbc(0x21b)][_0x2bcbbc(0x1c9)]);if(_0x48503e[_0x2bcbbc(0x210)]===user_constant_1['UserStatusEnum']['BLACKLISTED'])throw new common_1[(_0x2bcbbc(0x20c))](_0x2bcbbc(0x24b),common_1[_0x2bcbbc(0x21b)][_0x2bcbbc(0x234)]);if(_0x48503e['status']===user_constant_1[_0x2bcbbc(0x1f6)][_0x2bcbbc(0x1e4)])throw new common_1[(_0x2bcbbc(0x20c))](_0x2bcbbc(0x209),common_1['HttpStatus'][_0x2bcbbc(0x234)]);}async['getUserInfo'](_0x115b0a){const _0x516f86=_0x3818a7,_0xfa5666=await this['userEntity'][_0x516f86(0x1f5)]({'where':{'id':_0x115b0a},'select':[_0x516f86(0x1d4),_0x516f86(0x244),_0x516f86(0x218),_0x516f86(0x1e3),_0x516f86(0x25d),_0x516f86(0x1ee),_0x516f86(0x249),_0x516f86(0x246)]});if(!_0xfa5666)throw new common_1[(_0x516f86(0x20c))]('当前用户信息失效、请重新登录！',common_1[_0x516f86(0x21b)][_0x516f86(0x1c9)]);_0xfa5666['isBindWx']=!!(_0xfa5666===null||_0xfa5666===void 0x0?void 0x0:_0xfa5666['openId']),delete _0xfa5666[_0x516f86(0x249)];const _0x2b241f=await this[_0x516f86(0x23e)][_0x516f86(0x24d)](_0x115b0a);return{'userInfo':_0xfa5666,'userBalance':Object[_0x516f86(0x219)]({},_0x2b241f)};}async[_0x3818a7(0x227)](_0x341666){const _0x583025=_0x3818a7;return await this[_0x583025(0x1eb)]['findOne']({'where':{'id':_0x341666}});}async['getUserOpenId'](_0x5ab260){const _0x45a572=_0x3818a7;return await this[_0x45a572(0x1eb)][_0x45a572(0x1f5)]({'where':{'openId':_0x5ab260}});}async[_0x3818a7(0x203)](_0x1de918,_0x280804){const _0x2826d1=_0x3818a7,{id:_0x31a35c}=_0x280804[_0x2826d1(0x1d9)],_0x323b6f=await this[_0x2826d1(0x1eb)][_0x2826d1(0x1f5)]({'where':{'id':_0x31a35c}});if(!_0x323b6f)throw new common_1['HttpException'](_0x2826d1(0x242),common_1[_0x2826d1(0x21b)]['BAD_REQUEST']);if(_0x1de918[_0x2826d1(0x1d4)]&&_0x323b6f['username']===_0x1de918['username'])throw new common_1[(_0x2826d1(0x20c))](_0x2826d1(0x23f),common_1[_0x2826d1(0x21b)][_0x2826d1(0x234)]);if(_0x1de918[_0x2826d1(0x1d4)]){const _0x85ae42=await this['userEntity'][_0x2826d1(0x1f5)]({'where':{'username':_0x1de918[_0x2826d1(0x1d4)],'id':(0x0,typeorm_2[_0x2826d1(0x208)])(_0x31a35c)}});if(_0x85ae42)throw new common_1[(_0x2826d1(0x20c))]('用户名已存在！',common_1['HttpStatus']['BAD_REQUEST']);}const _0x5c8d30=await this[_0x2826d1(0x1eb)][_0x2826d1(0x20a)]({'id':_0x31a35c},_0x1de918);if(_0x5c8d30[_0x2826d1(0x257)]<=0x0)throw new common_1['HttpException'](_0x2826d1(0x1e9),common_1['HttpStatus'][_0x2826d1(0x234)]);return'修改用户信息成功！';}async[_0x3818a7(0x1f0)](_0x4a3f2b,_0x97f7f){const _0x371a51=_0x3818a7,_0x427790=bcrypt[_0x371a51(0x1ed)](_0x97f7f,0xa),_0x3c2724=await this[_0x371a51(0x1eb)]['update']({'id':_0x4a3f2b},{'password':_0x427790});if(_0x3c2724[_0x371a51(0x257)]<=0x0)throw new common_1['HttpException'](_0x371a51(0x1bf),common_1[_0x371a51(0x21b)][_0x371a51(0x234)]);}async['genInviteCode'](_0x3bf9e6){const _0x5ac4cc=_0x3818a7,{id:_0x1bbf43}=_0x3bf9e6[_0x5ac4cc(0x1d9)],_0x4f8fd1=await this[_0x5ac4cc(0x1eb)][_0x5ac4cc(0x1f5)]({'where':{'id':_0x1bbf43}});if(!_0x4f8fd1||_0x4f8fd1[_0x5ac4cc(0x1ee)])throw new common_1[(_0x5ac4cc(0x20c))](_0x5ac4cc(0x1df),common_1[_0x5ac4cc(0x21b)][_0x5ac4cc(0x234)]);const _0x689e6e=(0x0,utils_1[_0x5ac4cc(0x213)])(),_0x11fc4b=await this[_0x5ac4cc(0x1eb)][_0x5ac4cc(0x1f5)]({'where':{'inviteCode':_0x689e6e}});if(_0x11fc4b)throw new common_1[(_0x5ac4cc(0x20c))](_0x5ac4cc(0x25a),common_1[_0x5ac4cc(0x21b)][_0x5ac4cc(0x234)]);const _0x252e5e=await this[_0x5ac4cc(0x1eb)][_0x5ac4cc(0x20a)]({'id':_0x1bbf43},{'inviteCode':_0x689e6e});if(_0x252e5e[_0x5ac4cc(0x257)]<=0x0)throw new common_1[(_0x5ac4cc(0x20c))]('生成邀请码失败，请重新试一次吧！',common_1['HttpStatus'][_0x5ac4cc(0x234)]);return _0x689e6e;}async[_0x3818a7(0x1e5)](_0x30b8fa,_0x43a043){const _0x5129f2=_0x3818a7;try{const {id:_0xd959f8}=_0x30b8fa[_0x5129f2(0x1d9)],{page:page=0x1,size:size=0xa}=_0x43a043,_0x5022a9=await this[_0x5129f2(0x1eb)][_0x5129f2(0x1f5)]({'where':{'id':_0xd959f8}}),{inviteCode:_0xe587a9}=_0x5022a9;if(!_0xe587a9)return[];const [_0x4063da,_0x39764f]=await this['userEntity'][_0x5129f2(0x1b3)]({'where':{'inviteCode':_0xe587a9},'order':{'id':_0x5129f2(0x1cc)},'select':[_0x5129f2(0x1d4),'email',_0x5129f2(0x22e),_0x5129f2(0x210),'avatar'],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x5129f2(0x1ab)])(_0x4063da)[_0x5129f2(0x1cf)](_0x4d06c9=>{const _0x34dd8a=_0x5129f2;return _0x4d06c9[_0x34dd8a(0x1e3)]=(0x0,utils_1[_0x34dd8a(0x23b)])(_0x4d06c9[_0x34dd8a(0x1e3)]),_0x4d06c9;}),{'rows':_0x4063da,'count':_0x39764f};}catch(_0xedc9e8){console[_0x5129f2(0x1ff)](_0x5129f2(0x21a),_0xedc9e8);throw new common_1['HttpException'](_0x5129f2(0x1b1),common_1[_0x5129f2(0x21b)]['BAD_REQUEST']);}}async[_0x3818a7(0x1c7)](_0x7e02ca){const _0x203022=_0x3818a7,_0xacad00=await this[_0x203022(0x1eb)][_0x203022(0x1f5)]({'where':{'inviteCode':_0x7e02ca}});if(!_0xacad00)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0xacad00,_0x5e729a=await this[_0x203022(0x1eb)][_0x203022(0x20a)]({'inviteCode':_0x7e02ca},{'inviteLinkCount':inviteLinkCount+0x1});return _0x5e729a[_0x203022(0x257)]?0x1:0x0;}async['qureyUserInfoByInviteCode'](_0x4a9a93){const _0x218604=_0x3818a7;return await this[_0x218604(0x1eb)][_0x218604(0x1f5)]({'where':{'inviteCode':_0x4a9a93}});}async[_0x3818a7(0x1d8)](_0x484c07){const _0x1993da=_0x3818a7,{userId:_0x17836d,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x484c07;await this['userBalanceService'][_0x1993da(0x258)](_0x17836d,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0xa244b=await this[_0x1993da(0x23e)][_0x1993da(0x250)]({'userId':_0x17836d,'rechargeType':balance_constant_1[_0x1993da(0x1ad)][_0x1993da(0x1e6)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0xa244b;}async['queryAll'](_0x24139b,_0x3f2d76){const _0x42bc7c=_0x3818a7,{page:page=0x1,size:size=0xa,username:_0x38be86,email:_0x19833d,status:_0x5d008e,keyword:_0x40108d,phone:_0x5a2c21}=_0x24139b;let _0x497c80={};_0x38be86&&Object[_0x42bc7c(0x219)](_0x497c80,{'username':(0x0,typeorm_2['Like'])('%'+_0x38be86+'%')}),_0x19833d&&Object[_0x42bc7c(0x219)](_0x497c80,{'email':(0x0,typeorm_2[_0x42bc7c(0x1c2)])('%'+_0x19833d+'%')}),_0x5a2c21&&Object['assign'](_0x497c80,{'phone':(0x0,typeorm_2[_0x42bc7c(0x1c2)])('%'+_0x5a2c21+'%')}),_0x5d008e&&Object[_0x42bc7c(0x219)](_0x497c80,{'status':_0x5d008e});_0x40108d&&(_0x497c80=[{'username':(0x0,typeorm_2[_0x42bc7c(0x1c2)])('%'+_0x40108d+'%')},{'email':(0x0,typeorm_2['Like'])('%'+_0x40108d+'%')},{'phone':(0x0,typeorm_2[_0x42bc7c(0x1c2)])('%'+_0x40108d+'%')}]);const [_0x206653,_0x2b517b]=await this[_0x42bc7c(0x1eb)][_0x42bc7c(0x1b3)]({'skip':(page-0x1)*size,'where':_0x497c80,'take':size,'order':{'createdAt':_0x42bc7c(0x1cc)},'cache':!![],'select':[_0x42bc7c(0x1d4),_0x42bc7c(0x244),_0x42bc7c(0x1ee),_0x42bc7c(0x218),_0x42bc7c(0x25d),'status','id',_0x42bc7c(0x1e3),'createdAt',_0x42bc7c(0x1c0),'phone']}),_0x344afc=_0x206653['map'](_0x246d9a=>_0x246d9a['id']),_0x2bebb6=await this[_0x42bc7c(0x23e)]['queryUserBalanceByIds'](_0x344afc);return _0x206653[_0x42bc7c(0x1c6)](_0x4341c3=>_0x4341c3[_0x42bc7c(0x1ea)]=_0x2bebb6[_0x42bc7c(0x1b9)](_0x138863=>_0x138863[_0x42bc7c(0x1fd)]===_0x4341c3['id'])),_0x3f2d76[_0x42bc7c(0x1d9)]['role']!==_0x42bc7c(0x1b2)&&_0x206653['forEach'](_0x1264f6=>_0x1264f6[_0x42bc7c(0x1e3)]=(0x0,utils_1[_0x42bc7c(0x23b)])(_0x1264f6[_0x42bc7c(0x1e3)])),_0x3f2d76[_0x42bc7c(0x1d9)][_0x42bc7c(0x218)]!==_0x42bc7c(0x1b2)&&_0x206653[_0x42bc7c(0x1c6)](_0x8bb4b8=>_0x8bb4b8[_0x42bc7c(0x1c0)]=(0x0,utils_1[_0x42bc7c(0x236)])(_0x8bb4b8[_0x42bc7c(0x1c0)])),_0x3f2d76['user'][_0x42bc7c(0x218)]!==_0x42bc7c(0x1b2)&&_0x206653[_0x42bc7c(0x1c6)](_0x145ed5=>_0x145ed5[_0x42bc7c(0x232)]=(0x0,utils_1['maskIpAddress'])(_0x145ed5[_0x42bc7c(0x232)])),{'rows':_0x206653,'count':_0x2b517b};}async['queryOne']({id:_0x112364}){const _0x200991=_0x3818a7;return await this[_0x200991(0x1eb)][_0x200991(0x1f5)]({'where':{'id':_0x112364},'select':['username',_0x200991(0x244),_0x200991(0x1ee),_0x200991(0x218),_0x200991(0x25d),_0x200991(0x210)]});}async['updateStatus'](_0x487017){const _0x87be38=_0x3818a7,{id:_0x495bb5,status:_0x3f6c3a}=_0x487017,_0x46d25c=await this[_0x87be38(0x1eb)][_0x87be38(0x1f5)]({'where':{'id':_0x495bb5}});if(!_0x46d25c)throw new common_1['HttpException'](_0x87be38(0x247),common_1[_0x87be38(0x21b)][_0x87be38(0x234)]);if(_0x46d25c['role']===_0x87be38(0x1b2))throw new common_1['HttpException']('超级管理员不可被操作！',common_1['HttpStatus'][_0x87be38(0x234)]);if(_0x46d25c[_0x87be38(0x210)]===user_constant_1[_0x87be38(0x1f6)][_0x87be38(0x240)])throw new common_1[(_0x87be38(0x20c))](_0x87be38(0x256),common_1['HttpStatus'][_0x87be38(0x234)]);if(_0x46d25c[_0x87be38(0x218)]===_0x87be38(0x1b2))throw new common_1[(_0x87be38(0x20c))](_0x87be38(0x1fc),common_1[_0x87be38(0x21b)]['BAD_REQUEST']);if(_0x3f6c3a===user_constant_1[_0x87be38(0x1f6)][_0x87be38(0x240)])throw new common_1[(_0x87be38(0x20c))](_0x87be38(0x22f),common_1[_0x87be38(0x21b)][_0x87be38(0x234)]);const _0x3e377e=await this['userEntity'][_0x87be38(0x20a)]({'id':_0x495bb5},{'status':_0x3f6c3a});if(_0x3e377e[_0x87be38(0x257)]<=0x0)throw new common_1['HttpException'](_0x87be38(0x1d5),common_1['HttpStatus'][_0x87be38(0x234)]);return'修改用户状态成功！';}async['resetUserPass'](_0x45eb70){const _0x453c63=_0x3818a7,{id:_0x57302d}=_0x45eb70,_0xd38caf=await this[_0x453c63(0x1eb)]['findOne']({'where':{'id':_0x57302d}});if(!_0xd38caf)throw new common_1[(_0x453c63(0x20c))](_0x453c63(0x247),common_1[_0x453c63(0x21b)]['BAD_REQUEST']);const _0xcb9f2f=_0x453c63(0x23d),_0xd043df=bcrypt[_0x453c63(0x1ed)](_0xcb9f2f,0xa),_0x59dacd=await this[_0x453c63(0x1eb)][_0x453c63(0x20a)]({'id':_0x57302d},{'password':_0xd043df});if(_0x59dacd[_0x453c63(0x257)]<=0x0)throw new common_1['HttpException'](_0x453c63(0x1d2),common_1[_0x453c63(0x21b)][_0x453c63(0x234)]);return _0x453c63(0x24e)+_0xcb9f2f+']成功!';}async['savaLoginIp'](_0x1c667e,_0x14c8af){const _0x2c4ddf=_0x3818a7;return await this[_0x2c4ddf(0x1eb)][_0x2c4ddf(0x20a)]({'id':_0x1c667e},{'lastLoginIp':_0x14c8af});}async[_0x3818a7(0x225)](_0x4b0ce6,_0x1ae152){const _0x1d6210=_0x3818a7,_0x4dc12c=await this[_0x1d6210(0x1eb)][_0x1d6210(0x1f5)]({'where':{'openId':_0x4b0ce6}});if(!_0x4dc12c){const _0x3fe034=_0x1ae152?_0x1ae152['split'](':')[0x1]:'',_0x4836db=await this[_0x1d6210(0x252)](_0x3fe034),_0x14de55=await this['createUserFromOpenId'](_0x4b0ce6,_0x3fe034);return await this['userBalanceService'][_0x1d6210(0x1d0)](_0x14de55['id'],_0x3fe034?_0x4836db===null||_0x4836db===void 0x0?void 0x0:_0x4836db['id']:null),_0x14de55;}return _0x4dc12c;}async[_0x3818a7(0x233)](_0xa74eee,_0x104921){const _0x4b758c=_0x3818a7,_0xc5cc3b=await this['globalConfigService'][_0x4b758c(0x205)]([_0x4b758c(0x21c)]),_0x17f2e6={'avatar':_0xc5cc3b,'username':'用户'+(0x0,utils_1[_0x4b758c(0x23c)])(),'status':user_constant_1[_0x4b758c(0x1f6)][_0x4b758c(0x24f)],'sex':0x0,'email':(0x0,utils_1[_0x4b758c(0x23c)])()+_0x4b758c(0x1ec),'invitedBy':_0x104921,'openId':_0xa74eee},_0x897307=await this[_0x4b758c(0x1eb)][_0x4b758c(0x1fb)](_0x17f2e6);return _0x897307;}async[_0x3818a7(0x237)](_0x1a3059,_0x4fcbc3){const _0x130c63=_0x3818a7;try{const _0x2e63d8=await this[_0x130c63(0x1eb)][_0x130c63(0x1f5)]({'where':{'id':_0x4fcbc3}});if(!_0x2e63d8)return{'status':![],'msg':_0x130c63(0x25b)};const _0x1d2530=await this[_0x130c63(0x1eb)][_0x130c63(0x1f5)]({'where':{'openId':_0x1a3059}});if(_0x1d2530)return{'status':![],'msg':_0x130c63(0x248)};const _0x281034=await this[_0x130c63(0x1eb)][_0x130c63(0x20a)]({'id':_0x4fcbc3},{'openId':_0x1a3059});if(_0x281034['affected']<=0x0)return{'status':![],'msg':_0x130c63(0x201)};return{'status':!![],'msg':_0x130c63(0x1d1)};}catch(_0x451abc){return{'status':![],'msg':'绑定微信失败、请联系管理员！'};}}async[_0x3818a7(0x1cb)](_0x5da2bb){const _0x3528b0=_0x3818a7,_0x2d7609=await this[_0x3528b0(0x1eb)][_0x3528b0(0x1f5)]({'where':{'id':_0x5da2bb}});return _0x2d7609===null||_0x2d7609===void 0x0?void 0x0:_0x2d7609[_0x3528b0(0x249)];}async[_0x3818a7(0x1ac)](_0x45d042){const _0x1d5751=_0x3818a7,{username:_0x56e4ac,password:_0x589f09,phone:_0x4597bc,phoneCode:_0x2db0d6}=_0x45d042,_0x8a0a5=await this[_0x1d5751(0x1eb)]['findOne']({'where':[{'username':_0x56e4ac},{'phone':_0x4597bc}]});if(_0x8a0a5&&_0x8a0a5[_0x1d5751(0x1d4)]===_0x56e4ac)throw new common_1[(_0x1d5751(0x20c))](_0x1d5751(0x21e),common_1[_0x1d5751(0x21b)][_0x1d5751(0x234)]);if(_0x8a0a5&&_0x8a0a5[_0x1d5751(0x232)]===_0x4597bc)throw new common_1[(_0x1d5751(0x20c))]('当前手机号已注册、请勿重复注册！',common_1[_0x1d5751(0x21b)]['BAD_REQUEST']);}async[_0x3818a7(0x20d)](_0x47e56e){const _0x382f04=_0x3818a7;return await this[_0x382f04(0x1eb)][_0x382f04(0x1fb)](_0x47e56e);}};UserService=__decorate([(0x0,common_1[_0x3818a7(0x1e0)])(),__param(0x0,(0x0,typeorm_1[_0x3818a7(0x1c8)])(user_entity_1[_0x3818a7(0x235)])),__param(0x1,(0x0,typeorm_1[_0x3818a7(0x1c8)])(whiteList_entity_1[_0x3818a7(0x22d)])),__param(0x7,(0x0,typeorm_1[_0x3818a7(0x1c8)])(config_entity_1[_0x3818a7(0x229)])),__metadata(_0x3818a7(0x1f1),[typeorm_2[_0x3818a7(0x22a)],typeorm_2['Repository'],typeorm_2[_0x3818a7(0x1dd)],verification_service_1[_0x3818a7(0x24a)],mailer_1['MailerService'],userBalance_service_1[_0x3818a7(0x1f9)],globalConfig_service_1[_0x3818a7(0x245)],typeorm_2['Repository']])],UserService),exports[_0x3818a7(0x1b4)]=UserService;