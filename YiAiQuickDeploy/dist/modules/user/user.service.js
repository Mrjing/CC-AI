'use strict';function _0x265e(_0x158ecb,_0x353efe){const _0x5e939b=_0x5e93();return _0x265e=function(_0x265e95,_0x2bdd59){_0x265e95=_0x265e95-0x1c0;let _0x220efe=_0x5e939b[_0x265e95];return _0x220efe;},_0x265e(_0x158ecb,_0x353efe);}const _0x4f6a9f=_0x265e;(function(_0x419393,_0x21f616){const _0xd36444=_0x265e,_0x4a5815=_0x419393();while(!![]){try{const _0xc50123=-parseInt(_0xd36444(0x26f))/0x1*(-parseInt(_0xd36444(0x1fc))/0x2)+-parseInt(_0xd36444(0x1c6))/0x3*(parseInt(_0xd36444(0x1d7))/0x4)+-parseInt(_0xd36444(0x20b))/0x5*(-parseInt(_0xd36444(0x231))/0x6)+-parseInt(_0xd36444(0x228))/0x7+parseInt(_0xd36444(0x213))/0x8+parseInt(_0xd36444(0x25e))/0x9*(parseInt(_0xd36444(0x1f9))/0xa)+-parseInt(_0xd36444(0x1cb))/0xb;if(_0xc50123===_0x21f616)break;else _0x4a5815['push'](_0x4a5815['shift']());}catch(_0x3b7d29){_0x4a5815['push'](_0x4a5815['shift']());}}}(_0x5e93,0xf0992));function _0x5e93(){const _0x24e372=['error:\x20','status','123456','HttpStatus','修改用户信息失败！','affected','find','findOne','getUserOpenId','用户名已存在！','assign','ACTIVE','../../common/constants/user.constant','register','当前账户不存在！','createUser','registerVerifyEmailFrom','createRandomUid','user','$2y$','hashSync','您的账户已被封禁、如有疑问、请联系管理员！','update','userEntity','length','role','phone','design:paramtypes','createUserAndVerifycation','maskEmail','updateUserStatus','queryUserBalance','347860rInUfi','用户名已存在、请更换用户名！','当前用户信息失效、请重新登录！','486946dczvpJ','queryOne','isBindWx','Not','UserStatusEnum','Connection','用户名或者邮箱已被注册！','balanceInfo','UserStatusErrMsg','verificationService','registerVerifyEmailTitle','object','isVerifyEmail','RechargeType','defineProperty','6145SDeGUn','GlobalConfigService','username','addBalanceToNewUser','userDefautlAvatar','Injectable','----,','修改用户信息成功！','12764032PrDSuh','cloneDeep','PENDING','UNAUTHORIZED','resetUserPass','的账号激活','client','updateUserPassword','userRecharge','$2b$','email','当前手机号已注册、请勿重复注册！','checkUserStatus','BAD_REQUEST','hex','LOCKED','VerificationService','Registration','compareSync','updateStatus','修改用户状态失败！','66710HWiBwJ','metadata','../globalConfig/globalConfig.service','getOpenIdByUserId','saveRecordRechargeLog','password','__esModule','UserBalanceService','HttpException','5676caMPlq','md5','@nestjs/typeorm','UserEntity','inviteLink','修改密码失败、请重新试试吧。','userBalanceService','InjectRepository','../globalConfig/config.entity','generateRandomString','registerVerifyEmailDesc','ConfigEntity','maskIpAddress','createHash','startsWith','configVal','userId','updateInfo','ADMIN_GIFT','createdAt','registerVerifyExpir','绑定微信失败、请联系管理员！','inviteCode','bindWx','createUserFromOpenId','reduce','configKey','registerBaseUrl','queryUserInfoByPhone','mailerService','恭喜您绑定成功、后续可直接扫码登录了！','__param','__metadata','不可将用户置为未激活状态！','getUserFromOpenId','未激活用户不可手动变更状态！','当前用户不存在！','当前绑定用户不存在！','bcryptjs','getClientIp','queryOneUserInfo','genInviteCode','queryAll','digest','visitor','252BBEYzy','configEntity','super','lodash','生成邀请码失败，请重新试一次吧！','getConfigs','formatCreateOrUpdateDate','Like','map','该微信已绑定其他账号！','save','getOwnPropertyDescriptor','WhiteListEntity','当前密码错误！','超级管理员不可被操作！','qureyUserInfoByInviteCode','getUserById','5JzAUxa','log','typeorm','修改用户状态成功！','consecutiveDays','verifyUserCredentials','forEach','function','@nestjs/common','Repository','lastLoginIp','4353333uZJutb','getUserStatus','$2a$','../userBalance/userBalance.service','globalConfigService','27537180KneOjT','sign','getInviteRecord','openId','avatar','用户不存在！','DESC','queryUserInfoById','findAndCount','addBalanceToUser','registerIp','../../common/utils','4YVtoNe','MailerService'];_0x5e93=function(){return _0x24e372;};return _0x5e93();}var __decorate=this&&this['__decorate']||function(_0x3625fb,_0x2c9039,_0x4f8d48,_0x1d4f4c){const _0x295382=_0x265e;var _0x14dd0d=arguments[_0x295382(0x1f1)],_0x163e19=_0x14dd0d<0x3?_0x2c9039:_0x1d4f4c===null?_0x1d4f4c=Object[_0x295382(0x269)](_0x2c9039,_0x4f8d48):_0x1d4f4c,_0x2b1f3e;if(typeof Reflect===_0x295382(0x207)&&typeof Reflect['decorate']===_0x295382(0x1c2))_0x163e19=Reflect['decorate'](_0x3625fb,_0x2c9039,_0x4f8d48,_0x1d4f4c);else{for(var _0x477446=_0x3625fb[_0x295382(0x1f1)]-0x1;_0x477446>=0x0;_0x477446--)if(_0x2b1f3e=_0x3625fb[_0x477446])_0x163e19=(_0x14dd0d<0x3?_0x2b1f3e(_0x163e19):_0x14dd0d>0x3?_0x2b1f3e(_0x2c9039,_0x4f8d48,_0x163e19):_0x2b1f3e(_0x2c9039,_0x4f8d48))||_0x163e19;}return _0x14dd0d>0x3&&_0x163e19&&Object[_0x295382(0x20a)](_0x2c9039,_0x4f8d48,_0x163e19),_0x163e19;},__metadata=this&&this[_0x4f6a9f(0x251)]||function(_0x394a86,_0x4df834){const _0x43019e=_0x4f6a9f;if(typeof Reflect===_0x43019e(0x207)&&typeof Reflect[_0x43019e(0x229)]===_0x43019e(0x1c2))return Reflect[_0x43019e(0x229)](_0x394a86,_0x4df834);},__param=this&&this[_0x4f6a9f(0x250)]||function(_0x2a576f,_0x4e5d3d){return function(_0x197b96,_0x467db9){_0x4e5d3d(_0x197b96,_0x467db9,_0x2a576f);};};Object['defineProperty'](exports,_0x4f6a9f(0x22e),{'value':!![]}),exports['UserService']=void 0x0;const globalConfig_service_1=require(_0x4f6a9f(0x22a)),user_constant_1=require(_0x4f6a9f(0x1e5)),mailer_1=require('@nestjs-modules/mailer'),verification_service_1=require('../verification/verification.service'),common_1=require(_0x4f6a9f(0x1c3)),typeorm_1=require(_0x4f6a9f(0x233)),typeorm_2=require(_0x4f6a9f(0x271)),user_entity_1=require('./user.entity'),bcrypt=require(_0x4f6a9f(0x257)),crypto=require('crypto'),_=require(_0x4f6a9f(0x261)),verification_constant_1=require('../../common/constants/verification.constant'),userBalance_service_1=require(_0x4f6a9f(0x1c9)),utils_1=require(_0x4f6a9f(0x1d6)),balance_constant_1=require('../../common/constants/balance.constant'),config_entity_1=require(_0x4f6a9f(0x239)),whiteList_entity_1=require('../chatgpt/whiteList.entity');let UserService=class UserService{constructor(_0x3ed386,_0x5ed003,_0x26b765,_0x32ff46,_0x12e684,_0x8ff578,_0x3fa1c9,_0x4634e4){const _0x463098=_0x4f6a9f;this['userEntity']=_0x3ed386,this['whiteListEntity']=_0x5ed003,this['connection']=_0x26b765,this[_0x463098(0x205)]=_0x32ff46,this[_0x463098(0x24e)]=_0x12e684,this[_0x463098(0x237)]=_0x8ff578,this[_0x463098(0x1ca)]=_0x3fa1c9,this[_0x463098(0x25f)]=_0x4634e4;}async[_0x4f6a9f(0x1f5)](_0x2f61ca,_0x38b9b5){const _0x43ef9b=_0x4f6a9f,{username:_0x17eba6,email:_0x31b2c1,password:_0x1106b3,invitedBy:_0x1c0014,client:client=0x0}=_0x2f61ca;if(_0x1c0014){const _0x4a687c=await this[_0x43ef9b(0x1f0)]['findOne']({'where':{'inviteCode':_0x1c0014}});if(!_0x4a687c)throw new common_1[(_0x43ef9b(0x230))]('无效的邀请码！',common_1[_0x43ef9b(0x1dc)][_0x43ef9b(0x220)]);}const _0x60d91f=[{'username':_0x17eba6},{'email':_0x31b2c1}],_0x196124=await this[_0x43ef9b(0x1f0)]['findOne']({'where':_0x60d91f});if(_0x196124&&_0x196124[_0x43ef9b(0x1da)]!==user_constant_1[_0x43ef9b(0x200)]['PENDING'])throw new common_1['HttpException'](_0x43ef9b(0x202),common_1['HttpStatus'][_0x43ef9b(0x220)]);try{const _0x3fdb87=_[_0x43ef9b(0x214)](_0x2f61ca),_0x3e2235=bcrypt[_0x43ef9b(0x1ed)](_0x1106b3,0xa),_0x44f936=(0x0,utils_1[_0x43ef9b(0x258)])(_0x38b9b5);_0x3fdb87[_0x43ef9b(0x22d)]=_0x3e2235,_0x3fdb87[_0x43ef9b(0x1d5)]=_0x44f936,_0x3fdb87[_0x43ef9b(0x219)]=client;let _0x3d8f37;if(!_0x196124){const _0x1bf2e6=await this['globalConfigService'][_0x43ef9b(0x263)](['userDefautlAvatar']);_0x3fdb87['avatar']=_0x1bf2e6,_0x3d8f37=await this['userEntity'][_0x43ef9b(0x268)](_0x3fdb87);}else _0x3d8f37=_0x196124;const _0x17e907=await this[_0x43ef9b(0x25f)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x43ef9b(0x208),_0x43ef9b(0x24c),_0x43ef9b(0x206),_0x43ef9b(0x23b),_0x43ef9b(0x1e9),_0x43ef9b(0x245)])}}),_0x5ab710=_0x17e907[_0x43ef9b(0x24a)]((_0xed128f,_0x648523)=>{const _0x3b7049=_0x43ef9b;return _0xed128f[_0x648523[_0x3b7049(0x24b)]]=_0x648523[_0x3b7049(0x240)],_0xed128f;},{}),_0x9ccd69=_0x5ab710[_0x43ef9b(0x208)]?Number(_0x5ab710['isVerifyEmail']):0x1;if(_0x9ccd69){const _0x4632ab=_0x5ab710[_0x43ef9b(0x245)]?Number(_0x5ab710['registerVerifyExpir']):0x1e*0x3c,_0x3af7fe=await this[_0x43ef9b(0x205)]['createVerification'](_0x3d8f37,verification_constant_1['VerificationEnum'][_0x43ef9b(0x224)],_0x4632ab),{code:_0x4b042e,email:_0x285c9b,id:_0x59b66c}=_0x3af7fe,{registerVerifyEmailFrom:_0x39d8fa}=_0x5ab710;console[_0x43ef9b(0x270)]('configMap:\x20',_0x5ab710);const _0x5c832e=await this['mailerService']['sendMail']({'to':_0x285c9b,'subject':'来自'+_0x39d8fa+_0x43ef9b(0x218),'template':_0x43ef9b(0x1e6),'context':Object[_0x43ef9b(0x1e3)]({'baseUrl':_0x5ab710[_0x43ef9b(0x24c)],'code':_0x4b042e,'id':_0x59b66c},_0x5ab710)});console['log']('email\x20response\x20\x20->\x20:\x20',_0x5c832e);}else{const {username:_0x54dff5,email:_0x4d7f32,id:_0x18f0df,invitedBy:_0x13aebe}=_0x3d8f37;await this[_0x43ef9b(0x1f7)](_0x18f0df,user_constant_1[_0x43ef9b(0x200)][_0x43ef9b(0x1e4)]);let _0x32d016;_0x13aebe&&(_0x32d016=await this[_0x43ef9b(0x26d)](_0x13aebe)),await this[_0x43ef9b(0x237)][_0x43ef9b(0x20e)](_0x18f0df,_0x32d016===null||_0x32d016===void 0x0?void 0x0:_0x32d016['id']);}return _0x3d8f37;}catch(_0x3ec33f){console[_0x43ef9b(0x270)](_0x43ef9b(0x1d9),_0x3ec33f);throw _0x3ec33f;}}async['getSuper'](){const _0x3eead4=_0x4f6a9f,_0xdcb635=await this[_0x3eead4(0x1f0)][_0x3eead4(0x1e0)]({'where':{'role':_0x3eead4(0x260)}});return _0xdcb635;}async[_0x4f6a9f(0x1c0)](_0x29a968){const _0x1784fb=_0x4f6a9f,{username:_0x5a7019,password:_0x662fbe,uid:uid=0x0,phone:_0x5d7974}=_0x29a968;let _0x4fc45d=null;if(uid>0x0){_0x4fc45d=await this[_0x1784fb(0x1f0)][_0x1784fb(0x1e0)]({'where':{'id':uid}});if(!_0x4fc45d)throw new common_1[(_0x1784fb(0x230))](_0x1784fb(0x1e7),common_1['HttpStatus'][_0x1784fb(0x220)]);if(_0x4fc45d[_0x1784fb(0x22d)]['startsWith'](_0x1784fb(0x1c8))||_0x4fc45d[_0x1784fb(0x22d)]['startsWith'](_0x1784fb(0x21c))||_0x4fc45d[_0x1784fb(0x22d)][_0x1784fb(0x23f)]('$2y$')){if(!bcrypt[_0x1784fb(0x225)](_0x662fbe,_0x4fc45d[_0x1784fb(0x22d)]))throw new common_1[(_0x1784fb(0x230))]('当前密码错误！',common_1[_0x1784fb(0x1dc)]['BAD_REQUEST']);}else{console['log'](_0x1784fb(0x211));const _0x168912=crypto[_0x1784fb(0x23e)](_0x1784fb(0x232))[_0x1784fb(0x1ef)](_0x662fbe)[_0x1784fb(0x25c)](_0x1784fb(0x221));console[_0x1784fb(0x270)](_0x1784fb(0x211),_0x168912);if(_0x168912!==_0x4fc45d[_0x1784fb(0x22d)])throw new common_1[(_0x1784fb(0x230))](_0x1784fb(0x26b),common_1[_0x1784fb(0x1dc)]['BAD_REQUEST']);}}if(_0x5a7019&&_0x662fbe){const _0x4f2e98=[{'username':_0x5a7019},{'email':_0x5a7019}];_0x4fc45d=await this['userEntity'][_0x1784fb(0x1e0)]({'where':_0x4f2e98});if(!_0x4fc45d)throw new common_1[(_0x1784fb(0x230))](_0x1784fb(0x1e7),common_1['HttpStatus'][_0x1784fb(0x220)]);if(_0x4fc45d[_0x1784fb(0x22d)][_0x1784fb(0x23f)](_0x1784fb(0x1c8))||_0x4fc45d['password'][_0x1784fb(0x23f)]('$2b$')||_0x4fc45d[_0x1784fb(0x22d)]['startsWith']('$2y$')){if(!bcrypt[_0x1784fb(0x225)](_0x662fbe,_0x4fc45d[_0x1784fb(0x22d)]))throw new common_1['HttpException'](_0x1784fb(0x26b),common_1[_0x1784fb(0x1dc)][_0x1784fb(0x220)]);}else{console['log'](_0x1784fb(0x211));const _0xf74697=crypto[_0x1784fb(0x23e)](_0x1784fb(0x232))[_0x1784fb(0x1ef)](_0x662fbe)[_0x1784fb(0x25c)](_0x1784fb(0x221));console[_0x1784fb(0x270)]('----,',_0xf74697);if(_0xf74697!==_0x4fc45d[_0x1784fb(0x22d)])throw new common_1[(_0x1784fb(0x230))](_0x1784fb(0x26b),common_1['HttpStatus']['BAD_REQUEST']);}}if(_0x5d7974&&_0x662fbe){const _0x75ff45=[{'phone':_0x5d7974}];_0x4fc45d=await this['userEntity'][_0x1784fb(0x1e0)]({'where':_0x75ff45});if(!_0x4fc45d)throw new common_1['HttpException'](_0x1784fb(0x1e7),common_1[_0x1784fb(0x1dc)][_0x1784fb(0x220)]);if(_0x4fc45d[_0x1784fb(0x22d)][_0x1784fb(0x23f)]('$2a$')||_0x4fc45d[_0x1784fb(0x22d)][_0x1784fb(0x23f)]('$2b$')||_0x4fc45d[_0x1784fb(0x22d)][_0x1784fb(0x23f)](_0x1784fb(0x1ec))){if(!bcrypt[_0x1784fb(0x225)](_0x662fbe,_0x4fc45d[_0x1784fb(0x22d)]))throw new common_1[(_0x1784fb(0x230))](_0x1784fb(0x26b),common_1[_0x1784fb(0x1dc)][_0x1784fb(0x220)]);}else{console['log'](_0x1784fb(0x211));const _0x232889=crypto[_0x1784fb(0x23e)]('md5')[_0x1784fb(0x1ef)](_0x662fbe)[_0x1784fb(0x25c)](_0x1784fb(0x221));console['log'](_0x1784fb(0x211),_0x232889);if(_0x232889!==_0x4fc45d[_0x1784fb(0x22d)])throw new common_1['HttpException'](_0x1784fb(0x26b),common_1[_0x1784fb(0x1dc)][_0x1784fb(0x220)]);}}if(!_0x4fc45d)throw new common_1[(_0x1784fb(0x230))](_0x1784fb(0x1e7),common_1['HttpStatus'][_0x1784fb(0x220)]);if(_0x4fc45d[_0x1784fb(0x1da)]!==user_constant_1['UserStatusEnum']['ACTIVE'])throw new common_1[(_0x1784fb(0x230))](user_constant_1[_0x1784fb(0x204)][_0x4fc45d[_0x1784fb(0x1da)]],common_1[_0x1784fb(0x1dc)][_0x1784fb(0x220)]);return _0x4fc45d;}async['verifyUserPassword'](_0x2cd7e8,_0x2d7205){const _0x2705b4=_0x4f6a9f,_0xa811f5=await this[_0x2705b4(0x1f0)][_0x2705b4(0x1e0)]({'where':{'id':_0x2cd7e8}});if(_0xa811f5[_0x2705b4(0x22d)][_0x2705b4(0x23f)](_0x2705b4(0x1c8))||_0xa811f5[_0x2705b4(0x22d)][_0x2705b4(0x23f)]('$2b$')||_0xa811f5[_0x2705b4(0x22d)][_0x2705b4(0x23f)](_0x2705b4(0x1ec)))return bcrypt['compareSync'](_0x2d7205,_0xa811f5['password']);else{const _0x435fb7=crypto[_0x2705b4(0x23e)]('md5')[_0x2705b4(0x1ef)](_0x2d7205)['digest'](_0x2705b4(0x221));return console[_0x2705b4(0x270)](_0x2705b4(0x211),_0x435fb7),_0x435fb7===_0xa811f5[_0x2705b4(0x22d)];}}async[_0x4f6a9f(0x1f7)](_0x5314e9,_0x5d3e44){const _0x424c41=_0x4f6a9f,_0x39c608=await this['userEntity'][_0x424c41(0x1ef)]({'id':_0x5314e9},{'status':_0x5d3e44});return _0x39c608['affected']>0x0;}async[_0x4f6a9f(0x1c7)](_0x3d307d){const _0x14560d=_0x4f6a9f,_0x55e676=await this[_0x14560d(0x1f0)]['findOne']({'where':{'id':_0x3d307d}});return _0x55e676[_0x14560d(0x1da)];}async[_0x4f6a9f(0x1d2)](_0x9ad010){const _0x9080fd=_0x4f6a9f;return await this[_0x9080fd(0x1f0)]['findOne']({'where':{'id':_0x9ad010}});}async[_0x4f6a9f(0x24d)](_0x4ce901){const _0x2a709f=_0x4f6a9f;return await this[_0x2a709f(0x1f0)]['findOne']({'where':{'phone':_0x4ce901}});}async[_0x4f6a9f(0x259)](_0x499ba0){const _0x267782=_0x4f6a9f;return await this[_0x267782(0x1f0)][_0x267782(0x1e0)]({'where':{'id':_0x499ba0}});}async[_0x4f6a9f(0x21f)](_0x55ab38){const _0x98cae4=_0x4f6a9f,{id:_0x276b70,role:_0x2fdef1}=_0x55ab38;if(_0x2fdef1===_0x98cae4(0x25d))return!![];const _0x252266=await this[_0x98cae4(0x1f0)]['findOne']({'where':{'id':_0x276b70}});if(!_0x252266)throw new common_1[(_0x98cae4(0x230))](_0x98cae4(0x1fb),common_1['HttpStatus'][_0x98cae4(0x216)]);if(_0x252266[_0x98cae4(0x1da)]===user_constant_1['UserStatusEnum']['BLACKLISTED'])throw new common_1[(_0x98cae4(0x230))]('您的账户已被永久加入黑名单、如有疑问、请联系管理员！',common_1[_0x98cae4(0x1dc)][_0x98cae4(0x220)]);if(_0x252266['status']===user_constant_1['UserStatusEnum'][_0x98cae4(0x222)])throw new common_1[(_0x98cae4(0x230))](_0x98cae4(0x1ee),common_1[_0x98cae4(0x1dc)][_0x98cae4(0x220)]);}async['getUserInfo'](_0x200327){const _0x24bbb3=_0x4f6a9f,_0x8cae60=await this[_0x24bbb3(0x1f0)][_0x24bbb3(0x1e0)]({'where':{'id':_0x200327},'select':[_0x24bbb3(0x20d),'avatar',_0x24bbb3(0x1f2),_0x24bbb3(0x21d),'sign',_0x24bbb3(0x247),_0x24bbb3(0x1ce),_0x24bbb3(0x273)]});if(!_0x8cae60)throw new common_1['HttpException'](_0x24bbb3(0x1fb),common_1[_0x24bbb3(0x1dc)][_0x24bbb3(0x216)]);_0x8cae60[_0x24bbb3(0x1fe)]=!!(_0x8cae60===null||_0x8cae60===void 0x0?void 0x0:_0x8cae60[_0x24bbb3(0x1ce)]),delete _0x8cae60['openId'];const _0xc036c=await this[_0x24bbb3(0x237)][_0x24bbb3(0x1f8)](_0x200327);return{'userInfo':_0x8cae60,'userBalance':Object[_0x24bbb3(0x1e3)]({},_0xc036c)};}async[_0x4f6a9f(0x26e)](_0x1471c7){const _0x300803=_0x4f6a9f;return await this[_0x300803(0x1f0)][_0x300803(0x1e0)]({'where':{'id':_0x1471c7}});}async[_0x4f6a9f(0x1e1)](_0x1f6b1c){const _0x4d3923=_0x4f6a9f;return await this[_0x4d3923(0x1f0)]['findOne']({'where':{'openId':_0x1f6b1c}});}async[_0x4f6a9f(0x242)](_0x5b54c9,_0x43b950){const _0xab390=_0x4f6a9f,{id:_0x238a75}=_0x43b950[_0xab390(0x1eb)],_0x4a2def=await this[_0xab390(0x1f0)][_0xab390(0x1e0)]({'where':{'id':_0x238a75}});if(!_0x4a2def)throw new common_1[(_0xab390(0x230))](_0xab390(0x255),common_1[_0xab390(0x1dc)][_0xab390(0x220)]);if(_0x5b54c9['username']&&_0x4a2def[_0xab390(0x20d)]===_0x5b54c9[_0xab390(0x20d)])throw new common_1['HttpException']('没有变更，无需更改！',common_1[_0xab390(0x1dc)][_0xab390(0x220)]);if(_0x5b54c9[_0xab390(0x20d)]){const _0x26e6ba=await this[_0xab390(0x1f0)][_0xab390(0x1e0)]({'where':{'username':_0x5b54c9[_0xab390(0x20d)],'id':(0x0,typeorm_2[_0xab390(0x1ff)])(_0x238a75)}});if(_0x26e6ba)throw new common_1['HttpException'](_0xab390(0x1e2),common_1['HttpStatus']['BAD_REQUEST']);}const _0x5714e7=await this[_0xab390(0x1f0)][_0xab390(0x1ef)]({'id':_0x238a75},_0x5b54c9);if(_0x5714e7[_0xab390(0x1de)]<=0x0)throw new common_1[(_0xab390(0x230))](_0xab390(0x1dd),common_1['HttpStatus'][_0xab390(0x220)]);return _0xab390(0x212);}async[_0x4f6a9f(0x21a)](_0x218ed9,_0x31499f){const _0x30bb6e=_0x4f6a9f,_0x56f58d=bcrypt[_0x30bb6e(0x1ed)](_0x31499f,0xa),_0x51b651=await this['userEntity']['update']({'id':_0x218ed9},{'password':_0x56f58d});if(_0x51b651[_0x30bb6e(0x1de)]<=0x0)throw new common_1['HttpException'](_0x30bb6e(0x236),common_1[_0x30bb6e(0x1dc)][_0x30bb6e(0x220)]);}async[_0x4f6a9f(0x25a)](_0x572745){const _0xd1e8cc=_0x4f6a9f,{id:_0x2bf7f9}=_0x572745[_0xd1e8cc(0x1eb)],_0x39e464=await this[_0xd1e8cc(0x1f0)]['findOne']({'where':{'id':_0x2bf7f9}});if(!_0x39e464||_0x39e464[_0xd1e8cc(0x247)])throw new common_1['HttpException']('已生成过邀请码、请勿重复生成',common_1['HttpStatus'][_0xd1e8cc(0x220)]);const _0x86983b=(0x0,utils_1[_0xd1e8cc(0x23a)])(),_0x4c1a48=await this[_0xd1e8cc(0x1f0)]['findOne']({'where':{'inviteCode':_0x86983b}});if(_0x4c1a48)throw new common_1[(_0xd1e8cc(0x230))](_0xd1e8cc(0x262),common_1[_0xd1e8cc(0x1dc)]['BAD_REQUEST']);const _0x50a7e5=await this[_0xd1e8cc(0x1f0)][_0xd1e8cc(0x1ef)]({'id':_0x2bf7f9},{'inviteCode':_0x86983b});if(_0x50a7e5['affected']<=0x0)throw new common_1[(_0xd1e8cc(0x230))](_0xd1e8cc(0x262),common_1[_0xd1e8cc(0x1dc)][_0xd1e8cc(0x220)]);return _0x86983b;}async[_0x4f6a9f(0x1cd)](_0x200b8a,_0x43a0c8){const _0x346bbc=_0x4f6a9f;try{const {id:_0x59c30d}=_0x200b8a[_0x346bbc(0x1eb)],{page:page=0x1,size:size=0xa}=_0x43a0c8,_0x2a857e=await this[_0x346bbc(0x1f0)][_0x346bbc(0x1e0)]({'where':{'id':_0x59c30d}}),{inviteCode:_0x3a4a2d}=_0x2a857e;if(!_0x3a4a2d)return[];const [_0x14d8d3,_0x598341]=await this['userEntity'][_0x346bbc(0x1d3)]({'where':{'inviteCode':_0x3a4a2d},'order':{'id':'DESC'},'select':['username',_0x346bbc(0x21d),_0x346bbc(0x244),_0x346bbc(0x1da),'avatar'],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x346bbc(0x264)])(_0x14d8d3)[_0x346bbc(0x266)](_0x596592=>{const _0x194fb7=_0x346bbc;return _0x596592[_0x194fb7(0x21d)]=(0x0,utils_1[_0x194fb7(0x1f6)])(_0x596592[_0x194fb7(0x21d)]),_0x596592;}),{'rows':_0x14d8d3,'count':_0x598341};}catch(_0x565886){console[_0x346bbc(0x270)](_0x346bbc(0x1d9),_0x565886);throw new common_1[(_0x346bbc(0x230))]('获取邀请记录失败！',common_1[_0x346bbc(0x1dc)]['BAD_REQUEST']);}}async[_0x4f6a9f(0x235)](_0x4794f3){const _0x1ff541=_0x4f6a9f,_0x36f2af=await this[_0x1ff541(0x1f0)][_0x1ff541(0x1e0)]({'where':{'inviteCode':_0x4794f3}});if(!_0x36f2af)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x36f2af,_0x31925c=await this[_0x1ff541(0x1f0)][_0x1ff541(0x1ef)]({'inviteCode':_0x4794f3},{'inviteLinkCount':inviteLinkCount+0x1});return _0x31925c['affected']?0x1:0x0;}async[_0x4f6a9f(0x26d)](_0x3570b3){const _0x23fccd=_0x4f6a9f;return await this[_0x23fccd(0x1f0)]['findOne']({'where':{'inviteCode':_0x3570b3}});}async[_0x4f6a9f(0x21b)](_0x4ad40a){const _0x40fa56=_0x4f6a9f,{userId:_0x5c5652,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4ad40a;await this['userBalanceService'][_0x40fa56(0x1d4)](_0x5c5652,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x3cfc51=await this[_0x40fa56(0x237)][_0x40fa56(0x22c)]({'userId':_0x5c5652,'rechargeType':balance_constant_1[_0x40fa56(0x209)][_0x40fa56(0x243)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x3cfc51;}async[_0x4f6a9f(0x25b)](_0x421322,_0xda971b){const _0x482bee=_0x4f6a9f,{page:page=0x1,size:size=0xa,username:_0x164a12,email:_0x3a5d0f,status:_0x225a25,keyword:_0x233bd7,phone:_0x37d155}=_0x421322;let _0x8e6ada={};_0x164a12&&Object[_0x482bee(0x1e3)](_0x8e6ada,{'username':(0x0,typeorm_2[_0x482bee(0x265)])('%'+_0x164a12+'%')}),_0x3a5d0f&&Object[_0x482bee(0x1e3)](_0x8e6ada,{'email':(0x0,typeorm_2[_0x482bee(0x265)])('%'+_0x3a5d0f+'%')}),_0x37d155&&Object[_0x482bee(0x1e3)](_0x8e6ada,{'phone':(0x0,typeorm_2[_0x482bee(0x265)])('%'+_0x37d155+'%')}),_0x225a25&&Object[_0x482bee(0x1e3)](_0x8e6ada,{'status':_0x225a25});_0x233bd7&&(_0x8e6ada=[{'username':(0x0,typeorm_2[_0x482bee(0x265)])('%'+_0x233bd7+'%')},{'email':(0x0,typeorm_2[_0x482bee(0x265)])('%'+_0x233bd7+'%')},{'phone':(0x0,typeorm_2[_0x482bee(0x265)])('%'+_0x233bd7+'%')}]);const [_0x4cb75f,_0xa138e]=await this[_0x482bee(0x1f0)][_0x482bee(0x1d3)]({'skip':(page-0x1)*size,'where':_0x8e6ada,'take':size,'order':{'createdAt':_0x482bee(0x1d1)},'cache':!![],'select':[_0x482bee(0x20d),_0x482bee(0x1cf),'inviteCode',_0x482bee(0x1f2),_0x482bee(0x1cc),_0x482bee(0x1da),'id',_0x482bee(0x21d),_0x482bee(0x244),_0x482bee(0x1c5),_0x482bee(0x1f3)]}),_0x2bdbc8=_0x4cb75f[_0x482bee(0x266)](_0x2b3c14=>_0x2b3c14['id']),_0x320bfb=await this[_0x482bee(0x237)]['queryUserBalanceByIds'](_0x2bdbc8);return _0x4cb75f['forEach'](_0x2ab90b=>_0x2ab90b[_0x482bee(0x203)]=_0x320bfb[_0x482bee(0x1df)](_0x5c92c5=>_0x5c92c5[_0x482bee(0x241)]===_0x2ab90b['id'])),_0xda971b[_0x482bee(0x1eb)]['role']!==_0x482bee(0x260)&&_0x4cb75f[_0x482bee(0x1c1)](_0x48b06d=>_0x48b06d['email']=(0x0,utils_1[_0x482bee(0x1f6)])(_0x48b06d['email'])),_0xda971b[_0x482bee(0x1eb)][_0x482bee(0x1f2)]!=='super'&&_0x4cb75f[_0x482bee(0x1c1)](_0x58e8aa=>_0x58e8aa[_0x482bee(0x1c5)]=(0x0,utils_1[_0x482bee(0x23d)])(_0x58e8aa[_0x482bee(0x1c5)])),_0xda971b[_0x482bee(0x1eb)]['role']!=='super'&&_0x4cb75f[_0x482bee(0x1c1)](_0x5e6c35=>_0x5e6c35[_0x482bee(0x1f3)]=(0x0,utils_1[_0x482bee(0x23d)])(_0x5e6c35['phone'])),{'rows':_0x4cb75f,'count':_0xa138e};}async[_0x4f6a9f(0x1fd)]({id:_0x7083c0}){const _0x519d55=_0x4f6a9f;return await this[_0x519d55(0x1f0)][_0x519d55(0x1e0)]({'where':{'id':_0x7083c0},'select':[_0x519d55(0x20d),'avatar',_0x519d55(0x247),_0x519d55(0x1f2),_0x519d55(0x1cc),_0x519d55(0x1da)]});}async[_0x4f6a9f(0x226)](_0x5972b5){const _0x19e397=_0x4f6a9f,{id:_0x436db3,status:_0x4a0cf5}=_0x5972b5,_0x4bcc99=await this[_0x19e397(0x1f0)][_0x19e397(0x1e0)]({'where':{'id':_0x436db3}});if(!_0x4bcc99)throw new common_1[(_0x19e397(0x230))](_0x19e397(0x1d0),common_1[_0x19e397(0x1dc)][_0x19e397(0x220)]);if(_0x4bcc99[_0x19e397(0x1f2)]==='super')throw new common_1[(_0x19e397(0x230))](_0x19e397(0x26c),common_1[_0x19e397(0x1dc)][_0x19e397(0x220)]);if(_0x4bcc99['status']===user_constant_1['UserStatusEnum'][_0x19e397(0x215)])throw new common_1[(_0x19e397(0x230))](_0x19e397(0x254),common_1[_0x19e397(0x1dc)][_0x19e397(0x220)]);if(_0x4bcc99[_0x19e397(0x1f2)]===_0x19e397(0x260))throw new common_1[(_0x19e397(0x230))](_0x19e397(0x26c),common_1['HttpStatus'][_0x19e397(0x220)]);if(_0x4a0cf5===user_constant_1[_0x19e397(0x200)][_0x19e397(0x215)])throw new common_1[(_0x19e397(0x230))](_0x19e397(0x252),common_1[_0x19e397(0x1dc)]['BAD_REQUEST']);const _0x4a2d32=await this['userEntity'][_0x19e397(0x1ef)]({'id':_0x436db3},{'status':_0x4a0cf5});if(_0x4a2d32[_0x19e397(0x1de)]<=0x0)throw new common_1[(_0x19e397(0x230))](_0x19e397(0x227),common_1[_0x19e397(0x1dc)][_0x19e397(0x220)]);return _0x19e397(0x272);}async[_0x4f6a9f(0x217)](_0x29001e){const _0x32831b=_0x4f6a9f,{id:_0x29c02f}=_0x29001e,_0x344bc0=await this['userEntity'][_0x32831b(0x1e0)]({'where':{'id':_0x29c02f}});if(!_0x344bc0)throw new common_1[(_0x32831b(0x230))]('用户不存在！',common_1[_0x32831b(0x1dc)][_0x32831b(0x220)]);const _0x35a3c6=_0x32831b(0x1db),_0x4138df=bcrypt[_0x32831b(0x1ed)](_0x35a3c6,0xa),_0x4352d2=await this[_0x32831b(0x1f0)][_0x32831b(0x1ef)]({'id':_0x29c02f},{'password':_0x4138df});if(_0x4352d2['affected']<=0x0)throw new common_1[(_0x32831b(0x230))]('重置密码失败！',common_1[_0x32831b(0x1dc)][_0x32831b(0x220)]);return'密码重置为['+_0x35a3c6+']成功!';}async['savaLoginIp'](_0x24fc3b,_0x36c701){const _0x3f4c99=_0x4f6a9f;return await this[_0x3f4c99(0x1f0)][_0x3f4c99(0x1ef)]({'id':_0x24fc3b},{'lastLoginIp':_0x36c701});}async[_0x4f6a9f(0x253)](_0x6ac2cf,_0x1f44d2){const _0x2b57c4=_0x4f6a9f,_0xdc6757=await this[_0x2b57c4(0x1f0)][_0x2b57c4(0x1e0)]({'where':{'openId':_0x6ac2cf}});if(!_0xdc6757){const _0x1320f8=_0x1f44d2?_0x1f44d2['split'](':')[0x1]:'',_0x32fef3=await this[_0x2b57c4(0x26d)](_0x1320f8),_0x5a4777=await this[_0x2b57c4(0x249)](_0x6ac2cf,_0x1320f8);return await this[_0x2b57c4(0x237)]['addBalanceToNewUser'](_0x5a4777['id'],_0x1320f8?_0x32fef3===null||_0x32fef3===void 0x0?void 0x0:_0x32fef3['id']:null),_0x5a4777;}return _0xdc6757;}async['createUserFromOpenId'](_0x18a172,_0x3e06e2){const _0x475a5e=_0x4f6a9f,_0x12c4cf=await this[_0x475a5e(0x1ca)]['getConfigs']([_0x475a5e(0x20f)]),_0x80367b={'avatar':_0x12c4cf,'username':'用户'+(0x0,utils_1[_0x475a5e(0x1ea)])(),'status':user_constant_1['UserStatusEnum']['ACTIVE'],'sex':0x0,'email':(0x0,utils_1[_0x475a5e(0x1ea)])()+'@default.com','invitedBy':_0x3e06e2,'openId':_0x18a172},_0x3c5167=await this[_0x475a5e(0x1f0)][_0x475a5e(0x268)](_0x80367b);return _0x3c5167;}async[_0x4f6a9f(0x248)](_0x5a0b90,_0x5dda72){const _0x2e1be4=_0x4f6a9f;try{const _0x36ea8f=await this['userEntity'][_0x2e1be4(0x1e0)]({'where':{'id':_0x5dda72}});if(!_0x36ea8f)return{'status':![],'msg':_0x2e1be4(0x256)};const _0x3e4830=await this[_0x2e1be4(0x1f0)][_0x2e1be4(0x1e0)]({'where':{'openId':_0x5a0b90}});if(_0x3e4830)return{'status':![],'msg':_0x2e1be4(0x267)};const _0xc1b99=await this['userEntity'][_0x2e1be4(0x1ef)]({'id':_0x5dda72},{'openId':_0x5a0b90});if(_0xc1b99[_0x2e1be4(0x1de)]<=0x0)return{'status':![],'msg':_0x2e1be4(0x246)};return{'status':!![],'msg':_0x2e1be4(0x24f)};}catch(_0x53d820){return{'status':![],'msg':_0x2e1be4(0x246)};}}async[_0x4f6a9f(0x22b)](_0x2b7cad){const _0xa55ed4=_0x4f6a9f,_0x10a35b=await this[_0xa55ed4(0x1f0)][_0xa55ed4(0x1e0)]({'where':{'id':_0x2b7cad}});return _0x10a35b===null||_0x10a35b===void 0x0?void 0x0:_0x10a35b[_0xa55ed4(0x1ce)];}async['verifyUserRegisterByPhone'](_0x408a2d){const _0x4b0d31=_0x4f6a9f,{username:_0xa69c36,password:_0x32ac44,phone:_0x5e7c15,phoneCode:_0x49c371}=_0x408a2d,_0x2c7c3b=await this[_0x4b0d31(0x1f0)][_0x4b0d31(0x1e0)]({'where':[{'username':_0xa69c36},{'phone':_0x5e7c15}]});if(_0x2c7c3b&&_0x2c7c3b[_0x4b0d31(0x20d)]===_0xa69c36)throw new common_1[(_0x4b0d31(0x230))](_0x4b0d31(0x1fa),common_1[_0x4b0d31(0x1dc)][_0x4b0d31(0x220)]);if(_0x2c7c3b&&_0x2c7c3b[_0x4b0d31(0x1f3)]===_0x5e7c15)throw new common_1[(_0x4b0d31(0x230))](_0x4b0d31(0x21e),common_1[_0x4b0d31(0x1dc)]['BAD_REQUEST']);}async[_0x4f6a9f(0x1e8)](_0x5ad4d2){const _0x19554c=_0x4f6a9f;return await this['userEntity'][_0x19554c(0x268)](_0x5ad4d2);}};UserService=__decorate([(0x0,common_1[_0x4f6a9f(0x210)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x4f6a9f(0x234)])),__param(0x1,(0x0,typeorm_1[_0x4f6a9f(0x238)])(whiteList_entity_1[_0x4f6a9f(0x26a)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x4f6a9f(0x23c)])),__metadata(_0x4f6a9f(0x1f4),[typeorm_2[_0x4f6a9f(0x1c4)],typeorm_2[_0x4f6a9f(0x1c4)],typeorm_2[_0x4f6a9f(0x201)],verification_service_1[_0x4f6a9f(0x223)],mailer_1[_0x4f6a9f(0x1d8)],userBalance_service_1[_0x4f6a9f(0x22f)],globalConfig_service_1[_0x4f6a9f(0x20c)],typeorm_2[_0x4f6a9f(0x1c4)]])],UserService),exports['UserService']=UserService;