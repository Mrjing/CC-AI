'use strict';const _0x811160=_0x3d50;function _0x3d50(_0x11299f,_0x45cc72){const _0x178939=_0x1789();return _0x3d50=function(_0x3d50f3,_0xbd1458){_0x3d50f3=_0x3d50f3-0x77;let _0x1043c7=_0x178939[_0x3d50f3];return _0x1043c7;},_0x3d50(_0x11299f,_0x45cc72);}(function(_0x90bbb7,_0x55e7f7){const _0x1d9526=_0x3d50,_0x2fd4b1=_0x90bbb7();while(!![]){try{const _0x290de4=parseInt(_0x1d9526(0xd2))/0x1+parseInt(_0x1d9526(0xf7))/0x2+-parseInt(_0x1d9526(0x10f))/0x3*(parseInt(_0x1d9526(0xe3))/0x4)+-parseInt(_0x1d9526(0x98))/0x5*(-parseInt(_0x1d9526(0xf3))/0x6)+-parseInt(_0x1d9526(0x12b))/0x7*(parseInt(_0x1d9526(0x11a))/0x8)+-parseInt(_0x1d9526(0x9f))/0x9+parseInt(_0x1d9526(0x11b))/0xa*(-parseInt(_0x1d9526(0xf1))/0xb);if(_0x290de4===_0x55e7f7)break;else _0x2fd4b1['push'](_0x2fd4b1['shift']());}catch(_0x56a449){_0x2fd4b1['push'](_0x2fd4b1['shift']());}}}(_0x1789,0x560e1));var __decorate=this&&this[_0x811160(0x97)]||function(_0x2ed0ab,_0x2c9400,_0x3966bb,_0x4166ac){const _0x50d4d4=_0x811160;var _0x2ec8d5=arguments[_0x50d4d4(0xe2)],_0x537db6=_0x2ec8d5<0x3?_0x2c9400:_0x4166ac===null?_0x4166ac=Object[_0x50d4d4(0x122)](_0x2c9400,_0x3966bb):_0x4166ac,_0x8d3775;if(typeof Reflect===_0x50d4d4(0x9e)&&typeof Reflect[_0x50d4d4(0xb5)]===_0x50d4d4(0x112))_0x537db6=Reflect[_0x50d4d4(0xb5)](_0x2ed0ab,_0x2c9400,_0x3966bb,_0x4166ac);else{for(var _0x328dda=_0x2ed0ab[_0x50d4d4(0xe2)]-0x1;_0x328dda>=0x0;_0x328dda--)if(_0x8d3775=_0x2ed0ab[_0x328dda])_0x537db6=(_0x2ec8d5<0x3?_0x8d3775(_0x537db6):_0x2ec8d5>0x3?_0x8d3775(_0x2c9400,_0x3966bb,_0x537db6):_0x8d3775(_0x2c9400,_0x3966bb))||_0x537db6;}return _0x2ec8d5>0x3&&_0x537db6&&Object[_0x50d4d4(0x120)](_0x2c9400,_0x3966bb,_0x537db6),_0x537db6;},__metadata=this&&this[_0x811160(0xe8)]||function(_0x3a3dd6,_0x381678){const _0x11c97e=_0x811160;if(typeof Reflect==='object'&&typeof Reflect[_0x11c97e(0xc4)]===_0x11c97e(0x112))return Reflect[_0x11c97e(0xc4)](_0x3a3dd6,_0x381678);},__param=this&&this['__param']||function(_0x4fb6b4,_0x365c5e){return function(_0xf44733,_0x1e3847){_0x365c5e(_0xf44733,_0x1e3847,_0x4fb6b4);};};Object[_0x811160(0x120)](exports,_0x811160(0xb9),{'value':!![]}),exports[_0x811160(0x8c)]=void 0x0;const globalConfig_service_1=require(_0x811160(0xd3)),user_constant_1=require(_0x811160(0x79)),mailer_1=require('@nestjs-modules/mailer'),verification_service_1=require(_0x811160(0xe1)),common_1=require(_0x811160(0x126)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x811160(0x102)),user_entity_1=require(_0x811160(0xed)),bcrypt=require('bcryptjs'),crypto=require(_0x811160(0x89)),_=require('lodash'),verification_constant_1=require('../../common/constants/verification.constant'),userBalance_service_1=require(_0x811160(0xf2)),utils_1=require(_0x811160(0x128)),balance_constant_1=require(_0x811160(0x96)),config_entity_1=require(_0x811160(0xcf)),whiteList_entity_1=require(_0x811160(0xa6));function _0x1789(){const _0x2f36b1=['ADMIN_GIFT','789306tgpVkL','verifyUserCredentials','ACTIVE','registerVerifyEmailFrom','../../common/constants/user.constant','inviteCode','WhiteListEntity','phone','PENDING','UserEntity','createUserFromOpenId','ConfigEntity','configKey','queryUserBalance','hashSync','BAD_REQUEST','生成邀请码失败，请重新试一次吧！','getUserFromOpenId','用户名或者邮箱已被注册！','checkUserStatus','crypto','修改密码失败、请重新试试吧。','恭喜您绑定成功、后续可直接扫码登录了！','UserService','affected','forEach','createRandomUid','$2b$','password','balanceInfo','isVerifyEmail','super','修改用户信息成功！','../../common/constants/balance.constant','__decorate','316750vouneE','获取邀请记录失败！','Registration','split','createUser','email','object','1601469rJPRQd','registerVerifyEmailTitle','@default.com','lastLoginIp','resetUserPass','当前手机号已注册、请勿重复注册！','configEntity','../chatgpt/whiteList.entity','client','getUserStatus','update','visitor','reduce','configMap:\x20','maskEmail','用户不存在！','Not','isBindWx','用户名已存在、请更换用户名！','inviteLink','hex','userBalanceService','decorate','UserBalanceService','updateUserStatus','qureyUserInfoByInviteCode','__esModule','UserStatusErrMsg','assign','重置密码失败！','md5','getUserInfo','queryUserInfoById','getInviteRecord','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','user','绑定微信失败、请联系管理员！','metadata','save','bindWx','queryOne','userEntity','digest','----,','UNAUTHORIZED','InjectRepository','HttpException','findAndCount','../globalConfig/config.entity','DESC','log','390902vDCqPc','../globalConfig/globalConfig.service','verifyUserPassword',']成功!','globalConfigService','userId','queryAll','修改用户状态成功！','当前密码错误！','Repository','用户名已存在！','queryUserBalanceByIds','Like','$2a$','getUserOpenId','../verification/verification.service','length','398224UTFHOf','HttpStatus','mailerService','createUserAndVerifycation','whiteListEntity','__metadata','registerVerifyEmailDesc','getConfigs','未激活用户不可手动变更状态！','超级管理员不可被操作！','./user.entity','findOne','register','error:\x20','586806PmbILG','../userBalance/userBalance.service','60hCROeA','addBalanceToUser','role','123456','845788vSdhoU','Connection','addBalanceToNewUser','createHash','没有变更，无需更改！','email\x20response\x20\x20->\x20:\x20','registerVerifyExpir','verificationService','当前用户不存在！','createdAt','updateUserPassword','typeorm','registerBaseUrl','当前账户不存在！','修改用户信息失败！','avatar','userRecharge','compareSync','queryOneUserInfo','find','openId','username','updateInfo','当前用户信息失效、请重新登录！','6LzrTKZ','startsWith','RechargeType','function','userDefautlAvatar','status','verifyUserRegisterByPhone','密码重置为[','UserStatusEnum','BLACKLISTED','createVerification','32oqlvuS','50DdlFRw','无效的邀请码！','connection','已生成过邀请码、请勿重复生成','savaLoginIp','defineProperty','$2y$','getOwnPropertyDescriptor','sign','formatCreateOrUpdateDate','map','@nestjs/common','VerificationService','../../common/utils','saveRecordRechargeLog'];_0x1789=function(){return _0x2f36b1;};return _0x1789();}let UserService=class UserService{constructor(_0x35ecee,_0x56718d,_0x2812a1,_0xd7e393,_0x386ead,_0x2a4f71,_0x1d89bb,_0x264a40){const _0x1a838a=_0x811160;this['userEntity']=_0x35ecee,this[_0x1a838a(0xe7)]=_0x56718d,this[_0x1a838a(0x11d)]=_0x2812a1,this['verificationService']=_0xd7e393,this[_0x1a838a(0xe5)]=_0x386ead,this[_0x1a838a(0xb4)]=_0x2a4f71,this[_0x1a838a(0xd6)]=_0x1d89bb,this[_0x1a838a(0xa5)]=_0x264a40;}async[_0x811160(0xe6)](_0x5177cc,_0x4c2a8c){const _0x363aba=_0x811160,{username:_0x2b2c0a,email:_0x289f86,password:_0x5b1c69,invitedBy:_0x1e3d56,client:client=0x0}=_0x5177cc;if(_0x1e3d56){const _0x229ac2=await this['userEntity'][_0x363aba(0xee)]({'where':{'inviteCode':_0x1e3d56}});if(!_0x229ac2)throw new common_1[(_0x363aba(0xcd))](_0x363aba(0x11c),common_1[_0x363aba(0xe4)][_0x363aba(0x84)]);}const _0xa5e75=[{'username':_0x2b2c0a},{'email':_0x289f86}],_0x4f1788=await this[_0x363aba(0xc8)][_0x363aba(0xee)]({'where':_0xa5e75});if(_0x4f1788&&_0x4f1788[_0x363aba(0x114)]!==user_constant_1[_0x363aba(0x117)][_0x363aba(0x7d)])throw new common_1[(_0x363aba(0xcd))](_0x363aba(0x87),common_1[_0x363aba(0xe4)][_0x363aba(0x84)]);try{const _0x4b2215=_['cloneDeep'](_0x5177cc),_0x563133=bcrypt[_0x363aba(0x83)](_0x5b1c69,0xa),_0x325d06=(0x0,utils_1['getClientIp'])(_0x4c2a8c);_0x4b2215[_0x363aba(0x91)]=_0x563133,_0x4b2215['registerIp']=_0x325d06,_0x4b2215[_0x363aba(0xa7)]=client;let _0xc61fae;if(!_0x4f1788){const _0x499ada=await this[_0x363aba(0xd6)][_0x363aba(0xea)]([_0x363aba(0x113)]);_0x4b2215[_0x363aba(0x106)]=_0x499ada,_0xc61fae=await this[_0x363aba(0xc8)][_0x363aba(0xc5)](_0x4b2215);}else _0xc61fae=_0x4f1788;const _0x27bc95=await this['configEntity'][_0x363aba(0x10a)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x363aba(0x93),_0x363aba(0x103),_0x363aba(0xa0),_0x363aba(0xe9),_0x363aba(0x78),'registerVerifyExpir'])}}),_0x19fa5b=_0x27bc95[_0x363aba(0xab)]((_0x4a741d,_0x30113f)=>{const _0xeae53d=_0x363aba;return _0x4a741d[_0x30113f[_0xeae53d(0x81)]]=_0x30113f['configVal'],_0x4a741d;},{}),_0x4e776d=_0x19fa5b[_0x363aba(0x93)]?Number(_0x19fa5b['isVerifyEmail']):0x1;if(_0x4e776d){const _0x1ce818=_0x19fa5b[_0x363aba(0xfd)]?Number(_0x19fa5b[_0x363aba(0xfd)]):0x1e*0x3c,_0x1b9773=await this[_0x363aba(0xfe)][_0x363aba(0x119)](_0xc61fae,verification_constant_1['VerificationEnum'][_0x363aba(0x9a)],_0x1ce818),{code:_0xcbe748,email:_0xdccc2a,id:_0xa93f37}=_0x1b9773,{registerVerifyEmailFrom:_0x4fe394}=_0x19fa5b;console['log'](_0x363aba(0xac),_0x19fa5b);const _0x1ae3dd=await this[_0x363aba(0xe5)]['sendMail']({'to':_0xdccc2a,'subject':'来自'+_0x4fe394+'的账号激活','template':_0x363aba(0xef),'context':Object['assign']({'baseUrl':_0x19fa5b[_0x363aba(0x103)],'code':_0xcbe748,'id':_0xa93f37},_0x19fa5b)});console['log'](_0x363aba(0xfc),_0x1ae3dd);}else{const {username:_0x4c5c8b,email:_0x1152d4,id:_0x37040a,invitedBy:_0x2e3f35}=_0xc61fae;await this[_0x363aba(0xb7)](_0x37040a,user_constant_1['UserStatusEnum']['ACTIVE']);let _0x4ff857;_0x2e3f35&&(_0x4ff857=await this['qureyUserInfoByInviteCode'](_0x2e3f35)),await this[_0x363aba(0xb4)]['addBalanceToNewUser'](_0x37040a,_0x4ff857===null||_0x4ff857===void 0x0?void 0x0:_0x4ff857['id']);}return _0xc61fae;}catch(_0x4c69fd){console[_0x363aba(0xd1)](_0x363aba(0xf0),_0x4c69fd);throw _0x4c69fd;}}async['getSuper'](){const _0x51b597=_0x811160,_0xe6a685=await this['userEntity'][_0x51b597(0xee)]({'where':{'role':_0x51b597(0x94)}});return _0xe6a685;}async[_0x811160(0x12c)](_0x55bd46){const _0x514f33=_0x811160,{username:_0xffe9ac,password:_0x2704d4,uid:uid=0x0,phone:_0x3f89ff}=_0x55bd46;let _0x31f1d5=null;if(uid>0x0){_0x31f1d5=await this[_0x514f33(0xc8)][_0x514f33(0xee)]({'where':{'id':uid}});if(!_0x31f1d5)throw new common_1['HttpException']('当前账户不存在！',common_1['HttpStatus'][_0x514f33(0x84)]);if(_0x31f1d5[_0x514f33(0x91)][_0x514f33(0x110)](_0x514f33(0xdf))||_0x31f1d5[_0x514f33(0x91)]['startsWith']('$2b$')||_0x31f1d5[_0x514f33(0x91)][_0x514f33(0x110)](_0x514f33(0x121))){if(!bcrypt[_0x514f33(0x108)](_0x2704d4,_0x31f1d5[_0x514f33(0x91)]))throw new common_1[(_0x514f33(0xcd))](_0x514f33(0xda),common_1[_0x514f33(0xe4)][_0x514f33(0x84)]);}else{console['log']('----,');const _0x57c5da=crypto[_0x514f33(0xfa)](_0x514f33(0xbd))[_0x514f33(0xa9)](_0x2704d4)[_0x514f33(0xc9)](_0x514f33(0xb3));console[_0x514f33(0xd1)](_0x514f33(0xca),_0x57c5da);if(_0x57c5da!==_0x31f1d5[_0x514f33(0x91)])throw new common_1['HttpException']('当前密码错误！',common_1[_0x514f33(0xe4)][_0x514f33(0x84)]);}}if(_0xffe9ac&&_0x2704d4){const _0x509642=[{'username':_0xffe9ac},{'email':_0xffe9ac}];_0x31f1d5=await this[_0x514f33(0xc8)][_0x514f33(0xee)]({'where':_0x509642});if(!_0x31f1d5)throw new common_1[(_0x514f33(0xcd))](_0x514f33(0x104),common_1[_0x514f33(0xe4)]['BAD_REQUEST']);if(_0x31f1d5[_0x514f33(0x91)][_0x514f33(0x110)](_0x514f33(0xdf))||_0x31f1d5[_0x514f33(0x91)][_0x514f33(0x110)]('$2b$')||_0x31f1d5[_0x514f33(0x91)][_0x514f33(0x110)](_0x514f33(0x121))){if(!bcrypt[_0x514f33(0x108)](_0x2704d4,_0x31f1d5['password']))throw new common_1[(_0x514f33(0xcd))](_0x514f33(0xda),common_1[_0x514f33(0xe4)]['BAD_REQUEST']);}else{console[_0x514f33(0xd1)](_0x514f33(0xca));const _0x468c=crypto[_0x514f33(0xfa)](_0x514f33(0xbd))[_0x514f33(0xa9)](_0x2704d4)['digest'](_0x514f33(0xb3));console[_0x514f33(0xd1)](_0x514f33(0xca),_0x468c);if(_0x468c!==_0x31f1d5[_0x514f33(0x91)])throw new common_1[(_0x514f33(0xcd))](_0x514f33(0xda),common_1[_0x514f33(0xe4)][_0x514f33(0x84)]);}}if(_0x3f89ff&&_0x2704d4){const _0x2a8329=[{'phone':_0x3f89ff}];_0x31f1d5=await this['userEntity'][_0x514f33(0xee)]({'where':_0x2a8329});if(!_0x31f1d5)throw new common_1[(_0x514f33(0xcd))]('当前账户不存在！',common_1['HttpStatus']['BAD_REQUEST']);if(_0x31f1d5['password']['startsWith'](_0x514f33(0xdf))||_0x31f1d5[_0x514f33(0x91)][_0x514f33(0x110)](_0x514f33(0x90))||_0x31f1d5[_0x514f33(0x91)][_0x514f33(0x110)](_0x514f33(0x121))){if(!bcrypt[_0x514f33(0x108)](_0x2704d4,_0x31f1d5[_0x514f33(0x91)]))throw new common_1['HttpException'](_0x514f33(0xda),common_1[_0x514f33(0xe4)][_0x514f33(0x84)]);}else{console['log'](_0x514f33(0xca));const _0x520b9e=crypto[_0x514f33(0xfa)]('md5')[_0x514f33(0xa9)](_0x2704d4)['digest']('hex');console['log'](_0x514f33(0xca),_0x520b9e);if(_0x520b9e!==_0x31f1d5[_0x514f33(0x91)])throw new common_1[(_0x514f33(0xcd))](_0x514f33(0xda),common_1[_0x514f33(0xe4)]['BAD_REQUEST']);}}if(!_0x31f1d5)throw new common_1['HttpException'](_0x514f33(0x104),common_1[_0x514f33(0xe4)]['BAD_REQUEST']);if(_0x31f1d5['status']!==user_constant_1[_0x514f33(0x117)][_0x514f33(0x77)])throw new common_1[(_0x514f33(0xcd))](user_constant_1[_0x514f33(0xba)][_0x31f1d5[_0x514f33(0x114)]],common_1[_0x514f33(0xe4)]['BAD_REQUEST']);return _0x31f1d5;}async[_0x811160(0xd4)](_0x5c6bf9,_0x11f17b){const _0x5a9a44=_0x811160,_0x48527b=await this[_0x5a9a44(0xc8)][_0x5a9a44(0xee)]({'where':{'id':_0x5c6bf9}});if(_0x48527b['password'][_0x5a9a44(0x110)]('$2a$')||_0x48527b[_0x5a9a44(0x91)][_0x5a9a44(0x110)](_0x5a9a44(0x90))||_0x48527b[_0x5a9a44(0x91)][_0x5a9a44(0x110)](_0x5a9a44(0x121)))return bcrypt['compareSync'](_0x11f17b,_0x48527b['password']);else{const _0x4c5030=crypto[_0x5a9a44(0xfa)](_0x5a9a44(0xbd))[_0x5a9a44(0xa9)](_0x11f17b)['digest'](_0x5a9a44(0xb3));return console['log'](_0x5a9a44(0xca),_0x4c5030),_0x4c5030===_0x48527b['password'];}}async[_0x811160(0xb7)](_0x3f2fd9,_0x31980a){const _0x2379ee=_0x811160,_0x34a4bc=await this[_0x2379ee(0xc8)][_0x2379ee(0xa9)]({'id':_0x3f2fd9},{'status':_0x31980a});return _0x34a4bc['affected']>0x0;}async[_0x811160(0xa8)](_0x503475){const _0x439706=_0x811160,_0xbb139f=await this[_0x439706(0xc8)][_0x439706(0xee)]({'where':{'id':_0x503475}});return _0xbb139f[_0x439706(0x114)];}async[_0x811160(0xbf)](_0x451064){const _0xa7180c=_0x811160;return await this[_0xa7180c(0xc8)][_0xa7180c(0xee)]({'where':{'id':_0x451064}});}async[_0x811160(0x109)](_0x1626fb){const _0x4b7ea4=_0x811160;return await this['userEntity'][_0x4b7ea4(0xee)]({'where':{'id':_0x1626fb}});}async[_0x811160(0x88)](_0x8db554){const _0x322c6a=_0x811160,{id:_0x1805ac,role:_0x2d938a}=_0x8db554;if(_0x2d938a===_0x322c6a(0xaa))return!![];const _0x505ee2=await this['userEntity'][_0x322c6a(0xee)]({'where':{'id':_0x1805ac}});if(!_0x505ee2)throw new common_1[(_0x322c6a(0xcd))](_0x322c6a(0x10e),common_1[_0x322c6a(0xe4)][_0x322c6a(0xcb)]);if(_0x505ee2[_0x322c6a(0x114)]===user_constant_1[_0x322c6a(0x117)][_0x322c6a(0x118)])throw new common_1['HttpException'](_0x322c6a(0xc1),common_1[_0x322c6a(0xe4)][_0x322c6a(0x84)]);if(_0x505ee2[_0x322c6a(0x114)]===user_constant_1[_0x322c6a(0x117)]['LOCKED'])throw new common_1[(_0x322c6a(0xcd))]('您的账户已被封禁、如有疑问、请联系管理员！',common_1[_0x322c6a(0xe4)][_0x322c6a(0x84)]);}async[_0x811160(0xbe)](_0x47e595){const _0x12b4db=_0x811160,_0x85ed23=await this['userEntity'][_0x12b4db(0xee)]({'where':{'id':_0x47e595},'select':[_0x12b4db(0x10c),'avatar',_0x12b4db(0xf5),_0x12b4db(0x9d),_0x12b4db(0x123),_0x12b4db(0x7a),'openId','consecutiveDays']});if(!_0x85ed23)throw new common_1['HttpException']('当前用户信息失效、请重新登录！',common_1[_0x12b4db(0xe4)][_0x12b4db(0xcb)]);_0x85ed23[_0x12b4db(0xb0)]=!!(_0x85ed23===null||_0x85ed23===void 0x0?void 0x0:_0x85ed23['openId']),delete _0x85ed23[_0x12b4db(0x10b)];const _0x4bbc0a=await this[_0x12b4db(0xb4)][_0x12b4db(0x82)](_0x47e595);return{'userInfo':_0x85ed23,'userBalance':Object[_0x12b4db(0xbb)]({},_0x4bbc0a)};}async['getUserById'](_0x54f05a){const _0x2c5ce7=_0x811160;return await this[_0x2c5ce7(0xc8)]['findOne']({'where':{'id':_0x54f05a}});}async[_0x811160(0xe0)](_0x4efab7){const _0xc6cd47=_0x811160;return await this[_0xc6cd47(0xc8)][_0xc6cd47(0xee)]({'where':{'openId':_0x4efab7}});}async[_0x811160(0x10d)](_0xc314fd,_0x537803){const _0x480e38=_0x811160,{id:_0x43cde2}=_0x537803['user'],_0x428a1d=await this[_0x480e38(0xc8)][_0x480e38(0xee)]({'where':{'id':_0x43cde2}});if(!_0x428a1d)throw new common_1['HttpException'](_0x480e38(0xff),common_1[_0x480e38(0xe4)][_0x480e38(0x84)]);if(_0xc314fd[_0x480e38(0x10c)]&&_0x428a1d[_0x480e38(0x10c)]===_0xc314fd['username'])throw new common_1[(_0x480e38(0xcd))](_0x480e38(0xfb),common_1[_0x480e38(0xe4)][_0x480e38(0x84)]);if(_0xc314fd[_0x480e38(0x10c)]){const _0x408661=await this[_0x480e38(0xc8)]['findOne']({'where':{'username':_0xc314fd[_0x480e38(0x10c)],'id':(0x0,typeorm_2[_0x480e38(0xaf)])(_0x43cde2)}});if(_0x408661)throw new common_1[(_0x480e38(0xcd))](_0x480e38(0xdc),common_1[_0x480e38(0xe4)][_0x480e38(0x84)]);}const _0x1e7944=await this[_0x480e38(0xc8)][_0x480e38(0xa9)]({'id':_0x43cde2},_0xc314fd);if(_0x1e7944[_0x480e38(0x8d)]<=0x0)throw new common_1[(_0x480e38(0xcd))](_0x480e38(0x105),common_1['HttpStatus'][_0x480e38(0x84)]);return _0x480e38(0x95);}async[_0x811160(0x101)](_0xd10ec,_0x87719){const _0x374aa0=_0x811160,_0x31dee7=bcrypt[_0x374aa0(0x83)](_0x87719,0xa),_0x47d3d5=await this[_0x374aa0(0xc8)][_0x374aa0(0xa9)]({'id':_0xd10ec},{'password':_0x31dee7});if(_0x47d3d5[_0x374aa0(0x8d)]<=0x0)throw new common_1[(_0x374aa0(0xcd))](_0x374aa0(0x8a),common_1['HttpStatus'][_0x374aa0(0x84)]);}async['genInviteCode'](_0x2b46a9){const _0x1d00d8=_0x811160,{id:_0x16bef0}=_0x2b46a9[_0x1d00d8(0xc2)],_0x286712=await this['userEntity'][_0x1d00d8(0xee)]({'where':{'id':_0x16bef0}});if(!_0x286712||_0x286712['inviteCode'])throw new common_1[(_0x1d00d8(0xcd))](_0x1d00d8(0x11e),common_1[_0x1d00d8(0xe4)][_0x1d00d8(0x84)]);const _0x280038=(0x0,utils_1['generateRandomString'])(),_0x113529=await this[_0x1d00d8(0xc8)][_0x1d00d8(0xee)]({'where':{'inviteCode':_0x280038}});if(_0x113529)throw new common_1[(_0x1d00d8(0xcd))](_0x1d00d8(0x85),common_1[_0x1d00d8(0xe4)][_0x1d00d8(0x84)]);const _0xf095a3=await this['userEntity'][_0x1d00d8(0xa9)]({'id':_0x16bef0},{'inviteCode':_0x280038});if(_0xf095a3[_0x1d00d8(0x8d)]<=0x0)throw new common_1[(_0x1d00d8(0xcd))](_0x1d00d8(0x85),common_1[_0x1d00d8(0xe4)][_0x1d00d8(0x84)]);return _0x280038;}async[_0x811160(0xc0)](_0x4ddfcd,_0x4d6b20){const _0xfd7acc=_0x811160;try{const {id:_0x5a104a}=_0x4ddfcd[_0xfd7acc(0xc2)],{page:page=0x1,size:size=0xa}=_0x4d6b20,_0x5f16f9=await this[_0xfd7acc(0xc8)][_0xfd7acc(0xee)]({'where':{'id':_0x5a104a}}),{inviteCode:_0x1c915c}=_0x5f16f9;if(!_0x1c915c)return[];const [_0x46c0a6,_0x18e0cb]=await this[_0xfd7acc(0xc8)][_0xfd7acc(0xce)]({'where':{'inviteCode':_0x1c915c},'order':{'id':_0xfd7acc(0xd0)},'select':[_0xfd7acc(0x10c),_0xfd7acc(0x9d),_0xfd7acc(0x100),_0xfd7acc(0x114),_0xfd7acc(0x106)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0xfd7acc(0x124)])(_0x46c0a6)[_0xfd7acc(0x125)](_0x104413=>{const _0x513c13=_0xfd7acc;return _0x104413['email']=(0x0,utils_1['maskEmail'])(_0x104413[_0x513c13(0x9d)]),_0x104413;}),{'rows':_0x46c0a6,'count':_0x18e0cb};}catch(_0x398407){console['log'](_0xfd7acc(0xf0),_0x398407);throw new common_1[(_0xfd7acc(0xcd))](_0xfd7acc(0x99),common_1[_0xfd7acc(0xe4)][_0xfd7acc(0x84)]);}}async[_0x811160(0xb2)](_0x5269fe){const _0x55c251=_0x811160,_0x41ac98=await this[_0x55c251(0xc8)][_0x55c251(0xee)]({'where':{'inviteCode':_0x5269fe}});if(!_0x41ac98)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x41ac98,_0x14cbbf=await this[_0x55c251(0xc8)]['update']({'inviteCode':_0x5269fe},{'inviteLinkCount':inviteLinkCount+0x1});return _0x14cbbf[_0x55c251(0x8d)]?0x1:0x0;}async[_0x811160(0xb8)](_0x19b273){const _0xd1ba88=_0x811160;return await this[_0xd1ba88(0xc8)]['findOne']({'where':{'inviteCode':_0x19b273}});}async[_0x811160(0x107)](_0x2b58ec){const _0x5244aa=_0x811160,{userId:_0x3e4f49,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2b58ec;await this['userBalanceService'][_0x5244aa(0xf4)](_0x3e4f49,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x1802ec=await this['userBalanceService'][_0x5244aa(0x129)]({'userId':_0x3e4f49,'rechargeType':balance_constant_1[_0x5244aa(0x111)][_0x5244aa(0x12a)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x1802ec;}async[_0x811160(0xd8)](_0x272b02,_0xbc646f){const _0x32f29b=_0x811160,{page:page=0x1,size:size=0xa,username:_0xd768ea,email:_0x37577a,status:_0x535f3b,keyword:_0x2a3dd7,phone:_0x39aa2e}=_0x272b02;let _0x17547f={};_0xd768ea&&Object['assign'](_0x17547f,{'username':(0x0,typeorm_2[_0x32f29b(0xde)])('%'+_0xd768ea+'%')}),_0x37577a&&Object['assign'](_0x17547f,{'email':(0x0,typeorm_2[_0x32f29b(0xde)])('%'+_0x37577a+'%')}),_0x39aa2e&&Object[_0x32f29b(0xbb)](_0x17547f,{'phone':(0x0,typeorm_2[_0x32f29b(0xde)])('%'+_0x39aa2e+'%')}),_0x535f3b&&Object[_0x32f29b(0xbb)](_0x17547f,{'status':_0x535f3b});_0x2a3dd7&&(_0x17547f=[{'username':(0x0,typeorm_2['Like'])('%'+_0x2a3dd7+'%')},{'email':(0x0,typeorm_2['Like'])('%'+_0x2a3dd7+'%')},{'phone':(0x0,typeorm_2[_0x32f29b(0xde)])('%'+_0x2a3dd7+'%')}]);const [_0x7fcee8,_0xe8bcfa]=await this[_0x32f29b(0xc8)]['findAndCount']({'skip':(page-0x1)*size,'where':_0x17547f,'take':size,'order':{'createdAt':_0x32f29b(0xd0)},'cache':!![],'select':[_0x32f29b(0x10c),'avatar',_0x32f29b(0x7a),_0x32f29b(0xf5),'sign','status','id',_0x32f29b(0x9d),_0x32f29b(0x100),_0x32f29b(0xa2),_0x32f29b(0x7c)]}),_0x432241=_0x7fcee8['map'](_0x1005ec=>_0x1005ec['id']),_0x26380a=await this[_0x32f29b(0xb4)][_0x32f29b(0xdd)](_0x432241);return _0x7fcee8[_0x32f29b(0x8e)](_0x587b40=>_0x587b40[_0x32f29b(0x92)]=_0x26380a[_0x32f29b(0x10a)](_0x252acf=>_0x252acf[_0x32f29b(0xd7)]===_0x587b40['id'])),_0xbc646f['user']['role']!==_0x32f29b(0x94)&&_0x7fcee8[_0x32f29b(0x8e)](_0x1f15bb=>_0x1f15bb['email']=(0x0,utils_1[_0x32f29b(0xad)])(_0x1f15bb[_0x32f29b(0x9d)])),_0xbc646f[_0x32f29b(0xc2)][_0x32f29b(0xf5)]!==_0x32f29b(0x94)&&_0x7fcee8[_0x32f29b(0x8e)](_0x224d79=>_0x224d79[_0x32f29b(0xa2)]=(0x0,utils_1['maskIpAddress'])(_0x224d79[_0x32f29b(0xa2)])),_0xbc646f['user'][_0x32f29b(0xf5)]!==_0x32f29b(0x94)&&_0x7fcee8[_0x32f29b(0x8e)](_0x2282e1=>_0x2282e1[_0x32f29b(0x7c)]=(0x0,utils_1['maskIpAddress'])(_0x2282e1[_0x32f29b(0x7c)])),{'rows':_0x7fcee8,'count':_0xe8bcfa};}async[_0x811160(0xc7)]({id:_0x54ba89}){const _0x2facdb=_0x811160;return await this[_0x2facdb(0xc8)][_0x2facdb(0xee)]({'where':{'id':_0x54ba89},'select':['username',_0x2facdb(0x106),_0x2facdb(0x7a),_0x2facdb(0xf5),_0x2facdb(0x123),'status']});}async['updateStatus'](_0x51c585){const _0x1fc766=_0x811160,{id:_0x1ac558,status:_0x188725}=_0x51c585,_0x274e60=await this[_0x1fc766(0xc8)][_0x1fc766(0xee)]({'where':{'id':_0x1ac558}});if(!_0x274e60)throw new common_1[(_0x1fc766(0xcd))]('用户不存在！',common_1[_0x1fc766(0xe4)]['BAD_REQUEST']);if(_0x274e60[_0x1fc766(0xf5)]===_0x1fc766(0x94))throw new common_1[(_0x1fc766(0xcd))](_0x1fc766(0xec),common_1[_0x1fc766(0xe4)][_0x1fc766(0x84)]);if(_0x274e60[_0x1fc766(0x114)]===user_constant_1[_0x1fc766(0x117)][_0x1fc766(0x7d)])throw new common_1['HttpException'](_0x1fc766(0xeb),common_1['HttpStatus'][_0x1fc766(0x84)]);if(_0x274e60['role']==='super')throw new common_1[(_0x1fc766(0xcd))]('超级管理员不可被操作！',common_1[_0x1fc766(0xe4)][_0x1fc766(0x84)]);if(_0x188725===user_constant_1[_0x1fc766(0x117)]['PENDING'])throw new common_1[(_0x1fc766(0xcd))]('不可将用户置为未激活状态！',common_1['HttpStatus']['BAD_REQUEST']);const _0x37e4b9=await this[_0x1fc766(0xc8)][_0x1fc766(0xa9)]({'id':_0x1ac558},{'status':_0x188725});if(_0x37e4b9[_0x1fc766(0x8d)]<=0x0)throw new common_1[(_0x1fc766(0xcd))]('修改用户状态失败！',common_1['HttpStatus'][_0x1fc766(0x84)]);return _0x1fc766(0xd9);}async[_0x811160(0xa3)](_0x290e07){const _0x4786f7=_0x811160,{id:_0x305107}=_0x290e07,_0xbaac01=await this['userEntity'][_0x4786f7(0xee)]({'where':{'id':_0x305107}});if(!_0xbaac01)throw new common_1[(_0x4786f7(0xcd))](_0x4786f7(0xae),common_1[_0x4786f7(0xe4)][_0x4786f7(0x84)]);const _0x474dd0=_0x4786f7(0xf6),_0x3baa37=bcrypt[_0x4786f7(0x83)](_0x474dd0,0xa),_0xf0a37f=await this[_0x4786f7(0xc8)]['update']({'id':_0x305107},{'password':_0x3baa37});if(_0xf0a37f[_0x4786f7(0x8d)]<=0x0)throw new common_1[(_0x4786f7(0xcd))](_0x4786f7(0xbc),common_1[_0x4786f7(0xe4)][_0x4786f7(0x84)]);return _0x4786f7(0x116)+_0x474dd0+_0x4786f7(0xd5);}async[_0x811160(0x11f)](_0x240b98,_0x2106e3){const _0x4d908f=_0x811160;return await this[_0x4d908f(0xc8)][_0x4d908f(0xa9)]({'id':_0x240b98},{'lastLoginIp':_0x2106e3});}async[_0x811160(0x86)](_0x5e1df5,_0xb14889){const _0x450ccc=_0x811160,_0x447379=await this[_0x450ccc(0xc8)][_0x450ccc(0xee)]({'where':{'openId':_0x5e1df5}});if(!_0x447379){const _0xc371d=_0xb14889?_0xb14889[_0x450ccc(0x9b)](':')[0x1]:'',_0x322fd7=await this[_0x450ccc(0xb8)](_0xc371d),_0x1b6ca5=await this['createUserFromOpenId'](_0x5e1df5,_0xc371d);return await this['userBalanceService'][_0x450ccc(0xf9)](_0x1b6ca5['id'],_0xc371d?_0x322fd7===null||_0x322fd7===void 0x0?void 0x0:_0x322fd7['id']:null),_0x1b6ca5;}return _0x447379;}async[_0x811160(0x7f)](_0x494c2e,_0x2b34de){const _0x1ea5cf=_0x811160,_0x5898f3=await this['globalConfigService']['getConfigs'](['userDefautlAvatar']),_0x5139c5={'avatar':_0x5898f3,'username':'用户'+(0x0,utils_1[_0x1ea5cf(0x8f)])(),'status':user_constant_1[_0x1ea5cf(0x117)][_0x1ea5cf(0x77)],'sex':0x0,'email':(0x0,utils_1[_0x1ea5cf(0x8f)])()+_0x1ea5cf(0xa1),'invitedBy':_0x2b34de,'openId':_0x494c2e},_0x2eb47c=await this[_0x1ea5cf(0xc8)][_0x1ea5cf(0xc5)](_0x5139c5);return _0x2eb47c;}async[_0x811160(0xc6)](_0x2ba5ab,_0x5d650b){const _0x3fd311=_0x811160;try{const _0x1fdfae=await this['userEntity'][_0x3fd311(0xee)]({'where':{'id':_0x5d650b}});if(!_0x1fdfae)return{'status':![],'msg':'当前绑定用户不存在！'};const _0x291e45=await this[_0x3fd311(0xc8)][_0x3fd311(0xee)]({'where':{'openId':_0x2ba5ab}});if(_0x291e45)return{'status':![],'msg':'该微信已绑定其他账号！'};const _0x1a09cb=await this[_0x3fd311(0xc8)][_0x3fd311(0xa9)]({'id':_0x5d650b},{'openId':_0x2ba5ab});if(_0x1a09cb[_0x3fd311(0x8d)]<=0x0)return{'status':![],'msg':_0x3fd311(0xc3)};return{'status':!![],'msg':_0x3fd311(0x8b)};}catch(_0x3f07bd){return{'status':![],'msg':_0x3fd311(0xc3)};}}async['getOpenIdByUserId'](_0x346b2e){const _0x37f06a=_0x811160,_0x18ca7f=await this[_0x37f06a(0xc8)]['findOne']({'where':{'id':_0x346b2e}});return _0x18ca7f===null||_0x18ca7f===void 0x0?void 0x0:_0x18ca7f[_0x37f06a(0x10b)];}async[_0x811160(0x115)](_0x3a8ae7){const _0x235496=_0x811160,{username:_0x370d65,password:_0x1e868c,phone:_0x555a9e,phoneCode:_0x4570a8}=_0x3a8ae7,_0x3224cb=await this[_0x235496(0xc8)][_0x235496(0xee)]({'where':[{'username':_0x370d65},{'phone':_0x555a9e}]});if(_0x3224cb&&_0x3224cb[_0x235496(0x10c)]===_0x370d65)throw new common_1[(_0x235496(0xcd))](_0x235496(0xb1),common_1[_0x235496(0xe4)][_0x235496(0x84)]);if(_0x3224cb&&_0x3224cb[_0x235496(0x7c)]===_0x555a9e)throw new common_1[(_0x235496(0xcd))](_0x235496(0xa4),common_1['HttpStatus'][_0x235496(0x84)]);}async[_0x811160(0x9c)](_0x116c3f){const _0x4115a2=_0x811160;return await this[_0x4115a2(0xc8)][_0x4115a2(0xc5)](_0x116c3f);}};UserService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x811160(0x7e)])),__param(0x1,(0x0,typeorm_1[_0x811160(0xcc)])(whiteList_entity_1[_0x811160(0x7b)])),__param(0x7,(0x0,typeorm_1[_0x811160(0xcc)])(config_entity_1[_0x811160(0x80)])),__metadata('design:paramtypes',[typeorm_2[_0x811160(0xdb)],typeorm_2[_0x811160(0xdb)],typeorm_2[_0x811160(0xf8)],verification_service_1[_0x811160(0x127)],mailer_1['MailerService'],userBalance_service_1[_0x811160(0xb6)],globalConfig_service_1['GlobalConfigService'],typeorm_2['Repository']])],UserService),exports[_0x811160(0x8c)]=UserService;