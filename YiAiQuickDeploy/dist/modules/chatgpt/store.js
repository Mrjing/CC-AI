'use strict';const _0x3c056f=_0x4519;function _0x20a4(){const _0x1fadf5=['getData','map','max','encode','parentMessageId','cl100k_base','uuid','join','hunyuan','set','getUuid','gpt-4-vision-preview','filter','2450295yCzaRa','assistant','concat','_getTokenCount','50gMrpyd','type','log','length','expires','content','some','17581TIKaPb','8jXlqdH','_recursivePruning','24HEBWgC','push','buildMessageFromParentMessageId','includes','__esModule','3719778ccVkpp','@dqbd/tiktoken','get_encoding','formatOptions','image_url','get','store','chat','replace','ERNIE','2443592oZgnwf','setData','text','1824470YPRDxk','NineStore','user','142345eXmwfG','slice','gpt-4-all','system','186411VvSDsi','generateKey','namespace'];_0x20a4=function(){return _0x1fadf5;};return _0x20a4();}(function(_0x1425ef,_0x23da08){const _0x282bfc=_0x4519,_0x26c340=_0x1425ef();while(!![]){try{const _0x5712f2=-parseInt(_0x282bfc(0x1bb))/0x1+parseInt(_0x282bfc(0x1be))/0x2*(parseInt(_0x282bfc(0x1a0))/0x3)+parseInt(_0x282bfc(0x1bc))/0x4*(-parseInt(_0x282bfc(0x199))/0x5)+-parseInt(_0x282bfc(0x1c3))/0x6+-parseInt(_0x282bfc(0x19c))/0x7+-parseInt(_0x282bfc(0x1cd))/0x8+parseInt(_0x282bfc(0x1b0))/0x9*(parseInt(_0x282bfc(0x1b4))/0xa);if(_0x5712f2===_0x23da08)break;else _0x26c340['push'](_0x26c340['shift']());}catch(_0x18d786){_0x26c340['push'](_0x26c340['shift']());}}}(_0x20a4,0x6506b));Object['defineProperty'](exports,_0x3c056f(0x1c2),{'value':!![]}),exports[_0x3c056f(0x19a)]=void 0x0;function _0x4519(_0x280788,_0x2dbae3){const _0x20a469=_0x20a4();return _0x4519=function(_0x4519a6,_0x501f76){_0x4519a6=_0x4519a6-0x198;let _0x1896fc=_0x20a469[_0x4519a6];return _0x1896fc;},_0x4519(_0x280788,_0x2dbae3);}const uuid_1=require(_0x3c056f(0x1a9)),tiktoken_1=require(_0x3c056f(0x1c4)),tokenizer=(0x0,tiktoken_1[_0x3c056f(0x1c5)])(_0x3c056f(0x1a8));class NineStore{constructor(_0xc6a1eb){const _0x156c17=_0x3c056f,{store:_0x2c51b5,namespace:_0x1d8512,expires:_0x3e608d}=this[_0x156c17(0x1c6)](_0xc6a1eb);this[_0x156c17(0x1c9)]=_0x2c51b5,this[_0x156c17(0x1a2)]=_0x1d8512,this[_0x156c17(0x1b8)]=_0x3e608d;}[_0x3c056f(0x1c6)](_0x51aedc){const _0x3e7cb4=_0x3c056f,{store:_0xd8ffd7,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace=_0x3e7cb4(0x1ca)}=_0x51aedc;return{'store':_0xd8ffd7,'namespace':namespace,'expires':expires};}[_0x3c056f(0x1a1)](_0x198551){const _0x4768e9=_0x3c056f;return this[_0x4768e9(0x1a2)]?this['namespace']+'-'+_0x198551:_0x198551;}async[_0x3c056f(0x1a3)](_0x2f299e){const _0x42b320=_0x3c056f,_0x325acf=await this[_0x42b320(0x1c9)][_0x42b320(0x1c8)](_0x2f299e);return _0x325acf;}async[_0x3c056f(0x1ce)](_0x4df820,_0x548964=this[_0x3c056f(0x1b8)]){const _0x3ba211=_0x3c056f;await this['store'][_0x3ba211(0x1ac)](_0x4df820['id'],_0x4df820,_0x548964);}async[_0x3c056f(0x1c0)](_0x5eb2b9,_0x3c3fc1){const _0x5bd411=_0x3c056f;let {maxRounds:_0x4d07b9,maxModelToken:_0x56c767,maxResponseTokens:_0x2f4b8b,systemMessage:systemMessage='',name:_0x4c1304,imageUrl:_0x5adc7a,model:_0x3bf3c6,activeModel:_0x2aff1b}=_0x3c3fc1,{parentMessageId:_0x5aa1e9}=_0x3c3fc1,_0x48bfd0=[],_0x1ee68d=0x0;if(systemMessage){const _0x425ea6=['gemini-pro',_0x5bd411(0x1cc),_0x5bd411(0x1ab)],_0x4905a9=_0x2aff1b&&_0x425ea6[_0x5bd411(0x1ba)](_0xeee269=>_0x2aff1b[_0x5bd411(0x1c1)](_0xeee269));_0x4905a9?(_0x48bfd0['push']({'role':'user','content':systemMessage,'name':_0x4c1304}),_0x48bfd0[_0x5bd411(0x1bf)]({'role':_0x5bd411(0x1b1),'content':'好的','name':_0x4c1304})):_0x48bfd0['push']({'role':_0x5bd411(0x19f),'content':systemMessage,'name':_0x4c1304});}const _0x11d46c=_0x48bfd0[_0x5bd411(0x1b7)];let _0x38283e=0x0;if(_0x2aff1b===_0x5bd411(0x1ae)&&_0x5adc7a){const _0x1cb93d=[{'type':'text','text':_0x5eb2b9},{'type':_0x5bd411(0x1c7),'image_url':{'url':_0x5adc7a}}];_0x48bfd0[_0x5bd411(0x1bf)]({'role':'user','content':_0x1cb93d,'name':_0x4c1304});}else _0x3bf3c6===_0x5bd411(0x19e)&&_0x5adc7a&&(_0x5eb2b9=_0x5adc7a+'\x0a'+_0x5eb2b9),_0x48bfd0['push']({'role':_0x5bd411(0x19b),'content':_0x5eb2b9,'name':_0x4c1304});let _0x41bb9e=_0x48bfd0;do{if(!_0x5aa1e9)break;const _0x431b81=await this[_0x5bd411(0x1a3)](_0x5aa1e9);if(!_0x431b81)break;const {text:_0x1db06e,name:_0xb5f958,role:_0x504ce2,imageUrl:_0x3b6b32}=_0x431b81;let _0x40e579=_0x1db06e;_0x3b6b32&&(_0x2aff1b==='gpt-4-vision-preview'&&(_0x40e579=[{'type':_0x5bd411(0x198),'text':_0x1db06e},{'type':'image_url','image_url':{'url':_0x3b6b32}}]));_0x41bb9e=_0x41bb9e[_0x5bd411(0x19d)](0x0,_0x11d46c)[_0x5bd411(0x1b2)]([{'role':_0x504ce2,'content':_0x40e579,'name':_0xb5f958},..._0x41bb9e[_0x5bd411(0x19d)](_0x11d46c)]),_0x38283e++;if(_0x4d07b9&&_0x38283e>=_0x4d07b9)break;if(_0x56c767&&_0x2f4b8b){const _0x1cd70c=_0x56c767-_0x2f4b8b;_0x1ee68d=await this['_getTokenCount'](_0x41bb9e);const _0x4930d7=_0x1ee68d+0xc8<=_0x1cd70c;!_0x4930d7&&(_0x41bb9e=this[_0x5bd411(0x1bd)](_0x41bb9e,_0x1cd70c,systemMessage));}_0x5aa1e9=_0x431b81[_0x5bd411(0x1a7)];}while(!![]);const _0x2628fc=Math[_0x5bd411(0x1a5)](0x1,Math['min'](_0x56c767-_0x1ee68d,_0x2f4b8b));return console[_0x5bd411(0x1b6)]('本次携带上下文的长度',_0x41bb9e[_0x5bd411(0x1b7)],_0x1ee68d),{'context':_0x41bb9e,'round':_0x41bb9e[_0x5bd411(0x1b7)],'historyToken':_0x1ee68d};}[_0x3c056f(0x1b3)](_0x57f6d2){const _0x18f2dd=_0x3c056f;let _0x39d5f6=_0x57f6d2['reduce']((_0x34aaf6,_0x453076)=>{const _0x174fe0=_0x4519;if(Array['isArray'](_0x453076['content'])){const _0x564158=_0x453076['content'][_0x174fe0(0x1af)](_0x3c8af9=>_0x3c8af9[_0x174fe0(0x1b5)]===_0x174fe0(0x198))[_0x174fe0(0x1a4)](_0x1b1cc5=>_0x1b1cc5[_0x174fe0(0x198)])[_0x174fe0(0x1aa)]('\x20');return _0x34aaf6+_0x564158;}else return _0x34aaf6+(_0x453076[_0x174fe0(0x1b9)]||'');},'');return _0x39d5f6=_0x39d5f6[_0x18f2dd(0x1cb)](/<\|endoftext\|>/g,''),tokenizer[_0x18f2dd(0x1a6)](_0x39d5f6)[_0x18f2dd(0x1b7)];}[_0x3c056f(0x1bd)](_0x5d2a48,_0x3c9a72,_0x674e8a){const _0x114ff1=_0x3c056f,_0xd79898=this[_0x114ff1(0x1b3)](_0x5d2a48);if(_0xd79898<=_0x3c9a72)return _0x5d2a48;return _0x5d2a48['splice'](_0x674e8a?0x1:0x0,0x1),this['_recursivePruning'](_0x5d2a48,_0x3c9a72,_0x674e8a);}[_0x3c056f(0x1ad)](){return(0x0,uuid_1['v4'])();}}exports['NineStore']=NineStore;