'use strict';const _0x253694=_0x569d;(function(_0x5c3d79,_0x3dc2ba){const _0x76ddb9=_0x569d,_0x494d97=_0x5c3d79();while(!![]){try{const _0x3e8f27=-parseInt(_0x76ddb9(0x93))/0x1+parseInt(_0x76ddb9(0xb3))/0x2+parseInt(_0x76ddb9(0xb6))/0x3+parseInt(_0x76ddb9(0xa8))/0x4+parseInt(_0x76ddb9(0xa4))/0x5*(-parseInt(_0x76ddb9(0xba))/0x6)+-parseInt(_0x76ddb9(0xc5))/0x7*(parseInt(_0x76ddb9(0xae))/0x8)+-parseInt(_0x76ddb9(0x96))/0x9*(parseInt(_0x76ddb9(0xbe))/0xa);if(_0x3e8f27===_0x3dc2ba)break;else _0x494d97['push'](_0x494d97['shift']());}catch(_0xae26db){_0x494d97['push'](_0x494d97['shift']());}}}(_0x5709,0xc8e6a));function _0x5709(){const _0x12ec14=['_getTokenCount','parentMessageId','997870GOTKFO','getData','本次携带上下文的长度','3405831TNYCVz','concat','formatOptions','_recursivePruning','40596yMmCLa','log','get','system','1964120XctwSv','hunyuan','some','user','buildMessageFromParentMessageId','generateKey','NineStore','7JZWSZq','length','6480QOdEwi','filter','expires','45nvWwCy','max','replace','splice','__esModule','min','content','isArray','@dqbd/tiktoken','namespace','gemini-pro','assistant','join','uuid','130MAqPzJ','setData','store','slice','3453040wICeBl','getUuid','gpt-4-vision-preview','includes','text','set','4081008vxkHIT','push','image_url'];_0x5709=function(){return _0x12ec14;};return _0x5709();}Object['defineProperty'](exports,_0x253694(0x9a),{'value':!![]}),exports[_0x253694(0xc4)]=void 0x0;function _0x569d(_0x9dc9c2,_0x32a751){const _0x5709aa=_0x5709();return _0x569d=function(_0x569da0,_0x462e3d){_0x569da0=_0x569da0-0x92;let _0x2c61a1=_0x5709aa[_0x569da0];return _0x2c61a1;},_0x569d(_0x9dc9c2,_0x32a751);}const uuid_1=require(_0x253694(0xa3)),tiktoken_1=require(_0x253694(0x9e)),tokenizer=(0x0,tiktoken_1['get_encoding'])('cl100k_base');class NineStore{constructor(_0x152cc1){const _0x21002f=_0x253694,{store:_0x29724d,namespace:_0x3c78d,expires:_0x523502}=this[_0x21002f(0xb8)](_0x152cc1);this[_0x21002f(0xa6)]=_0x29724d,this[_0x21002f(0x9f)]=_0x3c78d,this[_0x21002f(0x95)]=_0x523502;}[_0x253694(0xb8)](_0x51149e){const {store:_0x17145c,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace='chat'}=_0x51149e;return{'store':_0x17145c,'namespace':namespace,'expires':expires};}[_0x253694(0xc3)](_0x569dc9){const _0x292118=_0x253694;return this[_0x292118(0x9f)]?this[_0x292118(0x9f)]+'-'+_0x569dc9:_0x569dc9;}async[_0x253694(0xb4)](_0x48b74e){const _0x3a10a5=_0x253694,_0x9e337=await this['store'][_0x3a10a5(0xbc)](_0x48b74e);return _0x9e337;}async[_0x253694(0xa5)](_0x4a169e,_0x3b2814=this['expires']){const _0x36347f=_0x253694;await this[_0x36347f(0xa6)][_0x36347f(0xad)](_0x4a169e['id'],_0x4a169e,_0x3b2814);}async[_0x253694(0xc2)](_0x43308c,_0x390e80){const _0x313e84=_0x253694;let {maxRounds:_0x32b5d7,maxModelToken:_0x18a6b4,maxResponseTokens:_0x59da8b,systemMessage:systemMessage='',name:_0x37a288,imageUrl:_0x21b7bb,model:_0x380c6f,activeModel:_0x322834}=_0x390e80,{parentMessageId:_0x42156e}=_0x390e80,_0x58923c=[],_0x541c9e=0x0;if(systemMessage){const _0x552d16=[_0x313e84(0xa0),'ERNIE',_0x313e84(0xbf)],_0x5de7d3=_0x322834&&_0x552d16[_0x313e84(0xc0)](_0xc1d30=>_0x322834[_0x313e84(0xab)](_0xc1d30));_0x5de7d3?(_0x58923c[_0x313e84(0xaf)]({'role':_0x313e84(0xc1),'content':systemMessage,'name':_0x37a288}),_0x58923c[_0x313e84(0xaf)]({'role':_0x313e84(0xa1),'content':'好的','name':_0x37a288})):_0x58923c['push']({'role':_0x313e84(0xbd),'content':systemMessage,'name':_0x37a288});}const _0x419191=_0x58923c[_0x313e84(0x92)];let _0x1c4da2=0x0;if(_0x322834==='gpt-4-vision-preview'&&_0x21b7bb){const _0x447d8e=[{'type':_0x313e84(0xac),'text':_0x43308c},{'type':_0x313e84(0xb0),'image_url':{'url':_0x21b7bb}}];_0x58923c['push']({'role':_0x313e84(0xc1),'content':_0x447d8e,'name':_0x37a288});}else _0x380c6f==='gpt-4-all'&&_0x21b7bb&&(_0x43308c=_0x21b7bb+'\x0a'+_0x43308c),_0x58923c[_0x313e84(0xaf)]({'role':_0x313e84(0xc1),'content':_0x43308c,'name':_0x37a288});let _0x3f32be=_0x58923c;do{if(!_0x42156e)break;const _0x4a2304=await this[_0x313e84(0xb4)](_0x42156e);if(!_0x4a2304)break;const {text:_0x524312,name:_0x51865a,role:_0x2ebd86,imageUrl:_0xe2698b}=_0x4a2304;let _0x4c1fe4=_0x524312;_0xe2698b&&(_0x322834===_0x313e84(0xaa)&&(_0x4c1fe4=[{'type':_0x313e84(0xac),'text':_0x524312},{'type':'image_url','image_url':{'url':_0xe2698b}}]));_0x3f32be=_0x3f32be[_0x313e84(0xa7)](0x0,_0x419191)[_0x313e84(0xb7)]([{'role':_0x2ebd86,'content':_0x4c1fe4,'name':_0x51865a},..._0x3f32be['slice'](_0x419191)]),_0x1c4da2++;if(_0x32b5d7&&_0x1c4da2>=_0x32b5d7)break;if(_0x18a6b4&&_0x59da8b){const _0x3877c6=_0x18a6b4-_0x59da8b;_0x541c9e=await this[_0x313e84(0xb1)](_0x3f32be);const _0x2c3604=_0x541c9e+0xc8<=_0x3877c6;!_0x2c3604&&(_0x3f32be=this[_0x313e84(0xb9)](_0x3f32be,_0x3877c6,systemMessage));}_0x42156e=_0x4a2304[_0x313e84(0xb2)];}while(!![]);const _0x4f77c9=Math[_0x313e84(0x97)](0x1,Math[_0x313e84(0x9b)](_0x18a6b4-_0x541c9e,_0x59da8b));return console[_0x313e84(0xbb)](_0x313e84(0xb5),_0x3f32be[_0x313e84(0x92)],_0x541c9e),{'context':_0x3f32be,'round':_0x3f32be[_0x313e84(0x92)],'historyToken':_0x541c9e};}[_0x253694(0xb1)](_0xf0cf2){const _0x54972d=_0x253694;let _0x34a84f=_0xf0cf2['reduce']((_0x30af26,_0x325d57)=>{const _0x1bfc78=_0x569d;if(Array[_0x1bfc78(0x9d)](_0x325d57[_0x1bfc78(0x9c)])){const _0xf0aada=_0x325d57[_0x1bfc78(0x9c)][_0x1bfc78(0x94)](_0x1f5561=>_0x1f5561['type']===_0x1bfc78(0xac))['map'](_0x3ef575=>_0x3ef575[_0x1bfc78(0xac)])[_0x1bfc78(0xa2)]('\x20');return _0x30af26+_0xf0aada;}else return _0x30af26+(_0x325d57[_0x1bfc78(0x9c)]||'');},'');return _0x34a84f=_0x34a84f[_0x54972d(0x98)](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x34a84f)[_0x54972d(0x92)];}[_0x253694(0xb9)](_0x415cf7,_0x455923,_0x19d3da){const _0x4a5f6a=_0x253694,_0x7b6f39=this[_0x4a5f6a(0xb1)](_0x415cf7);if(_0x7b6f39<=_0x455923)return _0x415cf7;return _0x415cf7[_0x4a5f6a(0x99)](_0x19d3da?0x1:0x0,0x1),this[_0x4a5f6a(0xb9)](_0x415cf7,_0x455923,_0x19d3da);}[_0x253694(0xa9)](){return(0x0,uuid_1['v4'])();}}exports[_0x253694(0xc4)]=NineStore;