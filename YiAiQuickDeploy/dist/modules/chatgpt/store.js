'use strict';function _0x402e(){const _0x5c122c=['slice','buildMessageFromParentMessageId','isArray','28647JSTBUT','length','513519ZiRWNz','1212580BUVQyd','getData','gemini-pro','get','reduce','本次携带上下文的长度','2030LIoNEs','join','generateKey','hunyuan','15yOxAWO','map','setData','store','namespace','text','image_url','942487amGUYL','log','type','1341000EMKzSQ','replace','ERNIE','some','__esModule','min','formatOptions','concat','defineProperty','max','assistant','parentMessageId','NineStore','get_encoding','3noHlJL','_recursivePruning','user','expires','cl100k_base','567282xJRWSJ','11498NzhISf','system','push','set','_getTokenCount','splice','uuid','chat','gpt-4-all'];_0x402e=function(){return _0x5c122c;};return _0x402e();}const _0x5104b5=_0x3c5b;(function(_0x1bd886,_0x306889){const _0x46cf51=_0x3c5b,_0x159d6f=_0x1bd886();while(!![]){try{const _0x506814=-parseInt(_0x46cf51(0x8c))/0x1*(parseInt(_0x46cf51(0x92))/0x2)+-parseInt(_0x46cf51(0xa0))/0x3+parseInt(_0x46cf51(0xa1))/0x4+-parseInt(_0x46cf51(0xab))/0x5*(parseInt(_0x46cf51(0x91))/0x6)+-parseInt(_0x46cf51(0xb2))/0x7+-parseInt(_0x46cf51(0xb5))/0x8+parseInt(_0x46cf51(0x9e))/0x9*(parseInt(_0x46cf51(0xa7))/0xa);if(_0x506814===_0x306889)break;else _0x159d6f['push'](_0x159d6f['shift']());}catch(_0x41e160){_0x159d6f['push'](_0x159d6f['shift']());}}}(_0x402e,0x2ab77));Object[_0x5104b5(0x86)](exports,_0x5104b5(0x82),{'value':!![]}),exports[_0x5104b5(0x8a)]=void 0x0;function _0x3c5b(_0x5034b2,_0x588384){const _0x402e4a=_0x402e();return _0x3c5b=function(_0x3c5bec,_0x28e8b8){_0x3c5bec=_0x3c5bec-0x82;let _0x1d40d0=_0x402e4a[_0x3c5bec];return _0x1d40d0;},_0x3c5b(_0x5034b2,_0x588384);}const uuid_1=require(_0x5104b5(0x98)),tiktoken_1=require('@dqbd/tiktoken'),tokenizer=(0x0,tiktoken_1[_0x5104b5(0x8b)])(_0x5104b5(0x90));class NineStore{constructor(_0x291bca){const _0x27e176=_0x5104b5,{store:_0x5468c2,namespace:_0x433246,expires:_0xe3d623}=this[_0x27e176(0x84)](_0x291bca);this[_0x27e176(0xae)]=_0x5468c2,this[_0x27e176(0xaf)]=_0x433246,this['expires']=_0xe3d623;}[_0x5104b5(0x84)](_0x126b47){const _0x185203=_0x5104b5,{store:_0x3e3afa,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace=_0x185203(0x99)}=_0x126b47;return{'store':_0x3e3afa,'namespace':namespace,'expires':expires};}[_0x5104b5(0xa9)](_0x112713){const _0x17582d=_0x5104b5;return this[_0x17582d(0xaf)]?this[_0x17582d(0xaf)]+'-'+_0x112713:_0x112713;}async[_0x5104b5(0xa2)](_0x342dca){const _0x367549=_0x5104b5,_0x212d3b=await this['store'][_0x367549(0xa4)](_0x342dca);return _0x212d3b;}async[_0x5104b5(0xad)](_0x34fd29,_0x18527a=this[_0x5104b5(0x8f)]){const _0x5d10eb=_0x5104b5;await this[_0x5d10eb(0xae)][_0x5d10eb(0x95)](_0x34fd29['id'],_0x34fd29,_0x18527a);}async[_0x5104b5(0x9c)](_0x475be6,_0x84ad7a){const _0x491249=_0x5104b5;let {maxRounds:_0x5a0e03,maxModelToken:_0xcf897e,maxResponseTokens:_0x473813,systemMessage:systemMessage='',name:_0x42c6e9,imageUrl:_0x221a57,model:_0x58a74a,activeModel:_0x2ce7b5}=_0x84ad7a,{parentMessageId:_0x59961a}=_0x84ad7a,_0x473e68=[],_0x549bbc=0x0;if(systemMessage){const _0x4dfb70=[_0x491249(0xa3),_0x491249(0xb7),_0x491249(0xaa)],_0x1f0ab9=_0x2ce7b5&&_0x4dfb70[_0x491249(0xb8)](_0xdb34e1=>_0x2ce7b5['includes'](_0xdb34e1));_0x1f0ab9?(_0x473e68[_0x491249(0x94)]({'role':'user','content':systemMessage,'name':_0x42c6e9}),_0x473e68['push']({'role':_0x491249(0x88),'content':'好的','name':_0x42c6e9})):_0x473e68[_0x491249(0x94)]({'role':_0x491249(0x93),'content':systemMessage,'name':_0x42c6e9});}const _0x33d2ea=_0x473e68['length'];let _0x49955b=0x0;if(_0x2ce7b5==='gpt-4-vision-preview'&&_0x221a57){const _0x340e91=[{'type':_0x491249(0xb0),'text':_0x475be6},{'type':'image_url','image_url':{'url':_0x221a57}}];_0x473e68[_0x491249(0x94)]({'role':_0x491249(0x8e),'content':_0x340e91,'name':_0x42c6e9});}else _0x58a74a===_0x491249(0x9a)&&_0x221a57&&(_0x475be6=_0x221a57+'\x0a'+_0x475be6),_0x473e68['push']({'role':_0x491249(0x8e),'content':_0x475be6,'name':_0x42c6e9});let _0x434129=_0x473e68;do{if(!_0x59961a)break;const _0x441799=await this['getData'](_0x59961a);if(!_0x441799)break;const {text:_0x5a6c94,name:_0x38ee86,role:_0x99337b,imageUrl:_0x566aac}=_0x441799;let _0x432bdb=_0x5a6c94;_0x566aac&&(_0x2ce7b5==='gpt-4-vision-preview'&&(_0x432bdb=[{'type':_0x491249(0xb0),'text':_0x5a6c94},{'type':_0x491249(0xb1),'image_url':{'url':_0x566aac}}]));_0x434129=_0x434129[_0x491249(0x9b)](0x0,_0x33d2ea)[_0x491249(0x85)]([{'role':_0x99337b,'content':_0x432bdb,'name':_0x38ee86},..._0x434129['slice'](_0x33d2ea)]),_0x49955b++;if(_0x5a0e03&&_0x49955b>=_0x5a0e03)break;if(_0xcf897e&&_0x473813){const _0x1cfaf8=_0xcf897e-_0x473813;_0x549bbc=await this[_0x491249(0x96)](_0x434129);const _0x5e8c7c=_0x549bbc+0xc8<=_0x1cfaf8;!_0x5e8c7c&&(_0x434129=this[_0x491249(0x8d)](_0x434129,_0x1cfaf8,systemMessage));}_0x59961a=_0x441799[_0x491249(0x89)];}while(!![]);const _0x493e22=Math[_0x491249(0x87)](0x1,Math[_0x491249(0x83)](_0xcf897e-_0x549bbc,_0x473813));return console[_0x491249(0xb3)](_0x491249(0xa6),_0x434129['length'],_0x549bbc),{'context':_0x434129,'round':_0x434129[_0x491249(0x9f)],'historyToken':_0x549bbc};}[_0x5104b5(0x96)](_0x5e59bf){const _0x34b6dc=_0x5104b5;let _0x16d0d9=_0x5e59bf[_0x34b6dc(0xa5)]((_0x388b8e,_0x373bef)=>{const _0xbdfde6=_0x34b6dc;if(Array[_0xbdfde6(0x9d)](_0x373bef['content'])){const _0x177920=_0x373bef['content']['filter'](_0x418811=>_0x418811[_0xbdfde6(0xb4)]===_0xbdfde6(0xb0))[_0xbdfde6(0xac)](_0x2e13f6=>_0x2e13f6['text'])[_0xbdfde6(0xa8)]('\x20');return _0x388b8e+_0x177920;}else return _0x388b8e+(_0x373bef['content']||'');},'');return _0x16d0d9=_0x16d0d9[_0x34b6dc(0xb6)](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x16d0d9)[_0x34b6dc(0x9f)];}['_recursivePruning'](_0x216a3d,_0x45bcb5,_0x29d511){const _0x446271=_0x5104b5,_0x9cd8=this['_getTokenCount'](_0x216a3d);if(_0x9cd8<=_0x45bcb5)return _0x216a3d;return _0x216a3d[_0x446271(0x97)](_0x29d511?0x1:0x0,0x1),this[_0x446271(0x8d)](_0x216a3d,_0x45bcb5,_0x29d511);}['getUuid'](){return(0x0,uuid_1['v4'])();}}exports['NineStore']=NineStore;