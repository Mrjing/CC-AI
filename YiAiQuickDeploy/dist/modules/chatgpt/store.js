'use strict';const _0x27f0b6=_0x1274;(function(_0x38ac95,_0x1254eb){const _0x45c5bb=_0x1274,_0x5c33f3=_0x38ac95();while(!![]){try{const _0x822566=-parseInt(_0x45c5bb(0x189))/0x1+-parseInt(_0x45c5bb(0x17f))/0x2+parseInt(_0x45c5bb(0x167))/0x3+-parseInt(_0x45c5bb(0x17a))/0x4*(-parseInt(_0x45c5bb(0x166))/0x5)+parseInt(_0x45c5bb(0x180))/0x6+parseInt(_0x45c5bb(0x175))/0x7*(parseInt(_0x45c5bb(0x185))/0x8)+-parseInt(_0x45c5bb(0x164))/0x9;if(_0x822566===_0x1254eb)break;else _0x5c33f3['push'](_0x5c33f3['shift']());}catch(_0x2ad5bb){_0x5c33f3['push'](_0x5c33f3['shift']());}}}(_0x334a,0x34611));Object[_0x27f0b6(0x170)](exports,_0x27f0b6(0x18b),{'value':!![]}),exports[_0x27f0b6(0x18c)]=void 0x0;const uuid_1=require(_0x27f0b6(0x184)),tiktoken_1=require('@dqbd/tiktoken'),tokenizer=(0x0,tiktoken_1[_0x27f0b6(0x16d)])(_0x27f0b6(0x161));function _0x1274(_0x3a2621,_0x1c7c73){const _0x334ac4=_0x334a();return _0x1274=function(_0x127442,_0x1775be){_0x127442=_0x127442-0x15f;let _0x56cf4d=_0x334ac4[_0x127442];return _0x56cf4d;},_0x1274(_0x3a2621,_0x1c7c73);}class NineStore{constructor(_0x26f91a){const _0x400d1e=_0x27f0b6,{store:_0xef6af5,namespace:_0x5746d3,expires:_0x51c5c2}=this[_0x400d1e(0x18f)](_0x26f91a);this[_0x400d1e(0x16f)]=_0xef6af5,this[_0x400d1e(0x163)]=_0x5746d3,this[_0x400d1e(0x18a)]=_0x51c5c2;}[_0x27f0b6(0x18f)](_0x2973d8){const {store:_0xa88c67,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace='chat'}=_0x2973d8;return{'store':_0xa88c67,'namespace':namespace,'expires':expires};}['generateKey'](_0x226435){const _0x39e925=_0x27f0b6;return this[_0x39e925(0x163)]?this[_0x39e925(0x163)]+'-'+_0x226435:_0x226435;}async[_0x27f0b6(0x187)](_0x561320){const _0x57e8fd=_0x27f0b6,_0xd78938=await this[_0x57e8fd(0x16f)][_0x57e8fd(0x188)](_0x561320);return _0xd78938;}async[_0x27f0b6(0x16e)](_0x3fd15c,_0x298575=this[_0x27f0b6(0x18a)]){const _0x2bdc93=_0x27f0b6;await this['store'][_0x2bdc93(0x171)](_0x3fd15c['id'],_0x3fd15c,_0x298575);}async['buildMessageFromParentMessageId'](_0xab7f25,_0x4a4bbc){const _0x34fe1e=_0x27f0b6;let {maxRounds:_0x430ee3,maxModelToken:_0x777ac7,maxResponseTokens:_0x5ea993,systemMessage:systemMessage='',name:_0x4d6522,imageUrl:_0x3879bd,model:_0x34d9a2,activeModel:_0x7dc6b}=_0x4a4bbc,{parentMessageId:_0x45e0de}=_0x4a4bbc,_0x2db7a5=[],_0x23eb9b=0x0;if(systemMessage){const _0x35b04b=[_0x34fe1e(0x18d),_0x34fe1e(0x15f),'hunyuan'],_0x420129=_0x7dc6b&&_0x35b04b[_0x34fe1e(0x183)](_0x2cc459=>_0x7dc6b[_0x34fe1e(0x16b)](_0x2cc459));_0x420129?(_0x2db7a5[_0x34fe1e(0x182)]({'role':_0x34fe1e(0x177),'content':systemMessage,'name':_0x4d6522}),_0x2db7a5['push']({'role':_0x34fe1e(0x17e),'content':'好的','name':_0x4d6522})):_0x2db7a5[_0x34fe1e(0x182)]({'role':_0x34fe1e(0x162),'content':systemMessage,'name':_0x4d6522});}const _0x1f9e55=_0x2db7a5[_0x34fe1e(0x174)];let _0x307dac=0x0;if(_0x7dc6b===_0x34fe1e(0x179)&&_0x3879bd){const _0x5c8068=[{'type':_0x34fe1e(0x165),'text':_0xab7f25},{'type':'image_url','image_url':{'url':_0x3879bd}}];_0x2db7a5[_0x34fe1e(0x182)]({'role':_0x34fe1e(0x177),'content':_0x5c8068,'name':_0x4d6522});}else _0x34d9a2==='gpt-4-all'&&_0x3879bd&&(_0xab7f25=_0x3879bd+'\x0a'+_0xab7f25),_0x2db7a5['push']({'role':'user','content':_0xab7f25,'name':_0x4d6522});let _0x131f9a=_0x2db7a5;do{if(!_0x45e0de)break;const _0x52cf12=await this[_0x34fe1e(0x187)](_0x45e0de);if(!_0x52cf12)break;const {text:_0x2b5419,name:_0x218070,role:_0x464cfe,imageUrl:_0xbafad}=_0x52cf12;let _0x37af8b=_0x2b5419;_0xbafad&&(_0x7dc6b===_0x34fe1e(0x179)&&(_0x37af8b=[{'type':_0x34fe1e(0x165),'text':_0x2b5419},{'type':_0x34fe1e(0x190),'image_url':{'url':_0xbafad}}]));_0x131f9a=_0x131f9a[_0x34fe1e(0x186)](0x0,_0x1f9e55)[_0x34fe1e(0x176)]([{'role':_0x464cfe,'content':_0x37af8b,'name':_0x218070},..._0x131f9a[_0x34fe1e(0x186)](_0x1f9e55)]),_0x307dac++;if(_0x430ee3&&_0x307dac>=_0x430ee3)break;if(_0x777ac7&&_0x5ea993){const _0x51e062=_0x777ac7-_0x5ea993;_0x23eb9b=await this['_getTokenCount'](_0x131f9a);const _0x562223=_0x23eb9b+0xc8<=_0x51e062;!_0x562223&&(_0x131f9a=this['_recursivePruning'](_0x131f9a,_0x51e062,systemMessage));}_0x45e0de=_0x52cf12[_0x34fe1e(0x16c)];}while(!![]);const _0x2fb689=Math[_0x34fe1e(0x17d)](0x1,Math[_0x34fe1e(0x181)](_0x777ac7-_0x23eb9b,_0x5ea993));return console[_0x34fe1e(0x172)]('本次携带上下文的长度',_0x131f9a[_0x34fe1e(0x174)],_0x23eb9b),{'context':_0x131f9a,'round':_0x131f9a['length'],'historyToken':_0x23eb9b};}[_0x27f0b6(0x168)](_0x4b5094){const _0x36a8a7=_0x27f0b6;let _0x39c76e=_0x4b5094[_0x36a8a7(0x178)]((_0x27c1b3,_0x4465c3)=>{const _0x56bf7b=_0x36a8a7;if(Array['isArray'](_0x4465c3[_0x56bf7b(0x18e)])){const _0x1d3ef8=_0x4465c3[_0x56bf7b(0x18e)]['filter'](_0x302b47=>_0x302b47[_0x56bf7b(0x173)]===_0x56bf7b(0x165))['map'](_0x489941=>_0x489941[_0x56bf7b(0x165)])[_0x56bf7b(0x17b)]('\x20');return _0x27c1b3+_0x1d3ef8;}else return _0x27c1b3+(_0x4465c3[_0x56bf7b(0x18e)]||'');},'');return _0x39c76e=_0x39c76e[_0x36a8a7(0x17c)](/<\|endoftext\|>/g,''),tokenizer[_0x36a8a7(0x160)](_0x39c76e)[_0x36a8a7(0x174)];}[_0x27f0b6(0x16a)](_0x251caf,_0x38b110,_0x4659c3){const _0x2850b9=_0x27f0b6,_0x297811=this['_getTokenCount'](_0x251caf);if(_0x297811<=_0x38b110)return _0x251caf;return _0x251caf[_0x2850b9(0x191)](_0x4659c3?0x1:0x0,0x1),this[_0x2850b9(0x16a)](_0x251caf,_0x38b110,_0x4659c3);}[_0x27f0b6(0x169)](){return(0x0,uuid_1['v4'])();}}exports[_0x27f0b6(0x18c)]=NineStore;function _0x334a(){const _0x104615=['encode','cl100k_base','system','namespace','5012478AcBdPs','text','845gKKBaj','911772wmWcAA','_getTokenCount','getUuid','_recursivePruning','includes','parentMessageId','get_encoding','setData','store','defineProperty','set','log','type','length','266VjpSYF','concat','user','reduce','gpt-4-vision-preview','4868SkuVxR','join','replace','max','assistant','662928YUdVbr','2063778DjUtjU','min','push','some','uuid','90176jqteib','slice','getData','get','178945pgNTue','expires','__esModule','NineStore','gemini-pro','content','formatOptions','image_url','splice','ERNIE'];_0x334a=function(){return _0x104615;};return _0x334a();}