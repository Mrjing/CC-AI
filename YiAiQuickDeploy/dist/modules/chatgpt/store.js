'use strict';const _0x72af14=_0x2990;(function(_0x1859df,_0x289d0e){const _0x48e624=_0x2990,_0x3ba86f=_0x1859df();while(!![]){try{const _0x19b7d7=-parseInt(_0x48e624(0x9b))/0x1+-parseInt(_0x48e624(0x96))/0x2*(-parseInt(_0x48e624(0x77))/0x3)+-parseInt(_0x48e624(0x9d))/0x4+parseInt(_0x48e624(0x74))/0x5+-parseInt(_0x48e624(0x72))/0x6+-parseInt(_0x48e624(0x8a))/0x7+parseInt(_0x48e624(0x80))/0x8;if(_0x19b7d7===_0x289d0e)break;else _0x3ba86f['push'](_0x3ba86f['shift']());}catch(_0x35a5bb){_0x3ba86f['push'](_0x3ba86f['shift']());}}}(_0x73ac,0x2c180));Object[_0x72af14(0x7b)](exports,_0x72af14(0x9c),{'value':!![]}),exports[_0x72af14(0x7f)]=void 0x0;function _0x2990(_0x301bed,_0x266eb0){const _0x73ac22=_0x73ac();return _0x2990=function(_0x29904f,_0x1b9373){_0x29904f=_0x29904f-0x72;let _0xc1e9c1=_0x73ac22[_0x29904f];return _0xc1e9c1;},_0x2990(_0x301bed,_0x266eb0);}const uuid_1=require(_0x72af14(0x85)),tiktoken_1=require('@dqbd/tiktoken'),tokenizer=(0x0,tiktoken_1[_0x72af14(0x7e)])(_0x72af14(0x89));class NineStore{constructor(_0x429e16){const _0x25bfb1=_0x72af14,{store:_0x4a2e97,namespace:_0x2e97f6,expires:_0x30c3bf}=this[_0x25bfb1(0x86)](_0x429e16);this[_0x25bfb1(0x92)]=_0x4a2e97,this['namespace']=_0x2e97f6,this['expires']=_0x30c3bf;}[_0x72af14(0x86)](_0x2e6473){const _0x11c62f=_0x72af14,{store:_0x2cfe1c,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace=_0x11c62f(0x8e)}=_0x2e6473;return{'store':_0x2cfe1c,'namespace':namespace,'expires':expires};}[_0x72af14(0x81)](_0x3b0a31){const _0x586959=_0x72af14;return this[_0x586959(0x82)]?this['namespace']+'-'+_0x3b0a31:_0x3b0a31;}async['getData'](_0x4bdaca){const _0x18f194=_0x72af14,_0x11e73e=await this[_0x18f194(0x92)][_0x18f194(0x84)](_0x4bdaca);return _0x11e73e;}async['setData'](_0x2c0b65,_0x326a84=this[_0x72af14(0x99)]){const _0x1081c9=_0x72af14;await this[_0x1081c9(0x92)][_0x1081c9(0x88)](_0x2c0b65['id'],_0x2c0b65,_0x326a84);}async['buildMessageFromParentMessageId'](_0x5f5491,_0x542925){const _0x437f6a=_0x72af14;let {maxRounds:_0x667a5f,maxModelToken:_0x1220b2,maxResponseTokens:_0x4e0165,systemMessage:systemMessage='',name:_0x29f418,imageUrl:_0xafb72,model:_0x16cf1b,activeModel:_0x39892f}=_0x542925,{parentMessageId:_0xb0a2da}=_0x542925,_0x4dbc1d=[],_0x1e4b64=0x0;if(systemMessage){const _0x5e9202=['gemini-pro',_0x437f6a(0x7d),_0x437f6a(0x98)],_0x1c63fb=_0x39892f&&_0x5e9202[_0x437f6a(0x8c)](_0x4f468d=>_0x39892f['includes'](_0x4f468d));_0x1c63fb?(_0x4dbc1d[_0x437f6a(0x7a)]({'role':_0x437f6a(0x83),'content':systemMessage,'name':_0x29f418}),_0x4dbc1d[_0x437f6a(0x7a)]({'role':'assistant','content':'好的','name':_0x29f418})):_0x4dbc1d[_0x437f6a(0x7a)]({'role':_0x437f6a(0x93),'content':systemMessage,'name':_0x29f418});}const _0x59b7ae=_0x4dbc1d['length'];let _0xa9b48a=0x0;if(_0x39892f==='gpt-4-vision-preview'&&_0xafb72){const _0x16e570=[{'type':'text','text':_0x5f5491},{'type':_0x437f6a(0x95),'image_url':{'url':_0xafb72}}];_0x4dbc1d[_0x437f6a(0x7a)]({'role':_0x437f6a(0x83),'content':_0x16e570,'name':_0x29f418});}else _0x16cf1b===_0x437f6a(0x90)&&_0xafb72&&(_0x5f5491=_0xafb72+'\x0a'+_0x5f5491),_0x4dbc1d[_0x437f6a(0x7a)]({'role':'user','content':_0x5f5491,'name':_0x29f418});let _0x4a148c=_0x4dbc1d;do{if(!_0xb0a2da)break;const _0x5912f6=await this['getData'](_0xb0a2da);if(!_0x5912f6)break;const {text:_0x5f4616,name:_0x4fb44a,role:_0xc5d8c3,imageUrl:_0x4c8e9a}=_0x5912f6;let _0x15db1d=_0x5f4616;_0x4c8e9a&&(_0x39892f==='gpt-4-vision-preview'&&(_0x15db1d=[{'type':_0x437f6a(0x73),'text':_0x5f4616},{'type':'image_url','image_url':{'url':_0x4c8e9a}}]));_0x4a148c=_0x4a148c[_0x437f6a(0x8d)](0x0,_0x59b7ae)['concat']([{'role':_0xc5d8c3,'content':_0x15db1d,'name':_0x4fb44a},..._0x4a148c['slice'](_0x59b7ae)]),_0xa9b48a++;if(_0x667a5f&&_0xa9b48a>=_0x667a5f)break;if(_0x1220b2&&_0x4e0165){const _0x3a0fe3=_0x1220b2-_0x4e0165;_0x1e4b64=await this[_0x437f6a(0x78)](_0x4a148c);const _0x528476=_0x1e4b64+0xc8<=_0x3a0fe3;!_0x528476&&(_0x4a148c=this[_0x437f6a(0x97)](_0x4a148c,_0x3a0fe3,systemMessage));}_0xb0a2da=_0x5912f6[_0x437f6a(0x76)];}while(!![]);const _0x3d1b71=Math[_0x437f6a(0x9e)](0x1,Math[_0x437f6a(0x8f)](_0x1220b2-_0x1e4b64,_0x4e0165));return console[_0x437f6a(0x94)]('本次携带上下文的长度',_0x4a148c[_0x437f6a(0x9a)],_0x1e4b64),{'context':_0x4a148c,'round':_0x4a148c[_0x437f6a(0x9a)],'historyToken':_0x1e4b64};}[_0x72af14(0x78)](_0x2341a8){const _0x43cb93=_0x72af14;let _0x437f3b=_0x2341a8[_0x43cb93(0x8b)]((_0x2dad71,_0x529f3d)=>{const _0x4a8d41=_0x43cb93;if(Array[_0x4a8d41(0x87)](_0x529f3d[_0x4a8d41(0x7c)])){const _0x4623f4=_0x529f3d[_0x4a8d41(0x7c)]['filter'](_0x26513e=>_0x26513e['type']==='text')['map'](_0x2eed64=>_0x2eed64[_0x4a8d41(0x73)])[_0x4a8d41(0x75)]('\x20');return _0x2dad71+_0x4623f4;}else return _0x2dad71+(_0x529f3d[_0x4a8d41(0x7c)]||'');},'');return _0x437f3b=_0x437f3b[_0x43cb93(0x79)](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x437f3b)[_0x43cb93(0x9a)];}[_0x72af14(0x97)](_0xebfd88,_0x31c360,_0x47119c){const _0x36e0be=_0x72af14,_0x5ab546=this[_0x36e0be(0x78)](_0xebfd88);if(_0x5ab546<=_0x31c360)return _0xebfd88;return _0xebfd88['splice'](_0x47119c?0x1:0x0,0x1),this['_recursivePruning'](_0xebfd88,_0x31c360,_0x47119c);}[_0x72af14(0x91)](){return(0x0,uuid_1['v4'])();}}exports[_0x72af14(0x7f)]=NineStore;function _0x73ac(){const _0x1b1a61=['isArray','set','cl100k_base','2427432RuyEAX','reduce','some','slice','chat','min','gpt-4-all','getUuid','store','system','log','image_url','90XhLOBf','_recursivePruning','hunyuan','expires','length','88448yuxEpz','__esModule','1184296kgVklg','max','613134GYiNCA','text','1028300kIGASb','join','parentMessageId','14502CADntq','_getTokenCount','replace','push','defineProperty','content','ERNIE','get_encoding','NineStore','4727240FngVsS','generateKey','namespace','user','get','uuid','formatOptions'];_0x73ac=function(){return _0x1b1a61;};return _0x73ac();}