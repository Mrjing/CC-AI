'use strict';const _0x416a39=_0x45b3;function _0x45b3(_0x30b12d,_0x4fe674){const _0x2891e8=_0x2891();return _0x45b3=function(_0x45b3aa,_0x7a8caf){_0x45b3aa=_0x45b3aa-0x185;let _0x2327c8=_0x2891e8[_0x45b3aa];return _0x2327c8;},_0x45b3(_0x30b12d,_0x4fe674);}(function(_0x501f28,_0x28ee74){const _0x4473b2=_0x45b3,_0x306bc1=_0x501f28();while(!![]){try{const _0x1053e8=parseInt(_0x4473b2(0x1a4))/0x1+parseInt(_0x4473b2(0x188))/0x2*(parseInt(_0x4473b2(0x19f))/0x3)+parseInt(_0x4473b2(0x186))/0x4*(parseInt(_0x4473b2(0x1a0))/0x5)+parseInt(_0x4473b2(0x194))/0x6+parseInt(_0x4473b2(0x1b8))/0x7+-parseInt(_0x4473b2(0x1a7))/0x8*(parseInt(_0x4473b2(0x195))/0x9)+parseInt(_0x4473b2(0x190))/0xa*(-parseInt(_0x4473b2(0x1a2))/0xb);if(_0x1053e8===_0x28ee74)break;else _0x306bc1['push'](_0x306bc1['shift']());}catch(_0x225f02){_0x306bc1['push'](_0x306bc1['shift']());}}}(_0x2891,0x8c9f9));function _0x2891(){const _0x1fb47a=['reduce','899061VmBZFc','NineStore','本次携带上下文的长度','647976uJwnsT','formatOptions','join','gpt-4-all','_getTokenCount','min','slice','image_url','length','namespace','replace','user','parentMessageId','expires','log','content','system','6349210GUrNyM','getData','gpt-4-vision-preview','map','2840AWLrjs','getUuid','36928kteqqq','get','max','ERNIE','type','push','store','splice','20eETDNX','concat','chat','includes','6018150jILTwL','99aqWMXX','setData','_recursivePruning','isArray','__esModule','@dqbd/tiktoken','buildMessageFromParentMessageId','generateKey','filter','defineProperty','180Elrcnd','4595LYTHKE','text','17063673SYmWBr'];_0x2891=function(){return _0x1fb47a;};return _0x2891();}Object[_0x416a39(0x19e)](exports,_0x416a39(0x199),{'value':!![]}),exports['NineStore']=void 0x0;const uuid_1=require('uuid'),tiktoken_1=require(_0x416a39(0x19a)),tokenizer=(0x0,tiktoken_1['get_encoding'])('cl100k_base');class NineStore{constructor(_0x44e49f){const _0x2b62b5=_0x416a39,{store:_0x4c66ea,namespace:_0x147e56,expires:_0xa38615}=this[_0x2b62b5(0x1a8)](_0x44e49f);this[_0x2b62b5(0x18e)]=_0x4c66ea,this[_0x2b62b5(0x1b0)]=_0x147e56,this[_0x2b62b5(0x1b4)]=_0xa38615;}['formatOptions'](_0x3ddf19){const _0x16c2f5=_0x416a39,{store:_0x40440f,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace=_0x16c2f5(0x192)}=_0x3ddf19;return{'store':_0x40440f,'namespace':namespace,'expires':expires};}[_0x416a39(0x19c)](_0x111204){const _0x53173e=_0x416a39;return this[_0x53173e(0x1b0)]?this[_0x53173e(0x1b0)]+'-'+_0x111204:_0x111204;}async[_0x416a39(0x1b9)](_0x2207d6){const _0x49e1fc=_0x416a39,_0x57a229=await this[_0x49e1fc(0x18e)][_0x49e1fc(0x189)](_0x2207d6);return _0x57a229;}async[_0x416a39(0x196)](_0x5199cb,_0x5c8ecd=this['expires']){const _0x500fc0=_0x416a39;await this[_0x500fc0(0x18e)]['set'](_0x5199cb['id'],_0x5199cb,_0x5c8ecd);}async[_0x416a39(0x19b)](_0x3cb6b8,_0x24a43c){const _0x2cb6dc=_0x416a39;let {maxRounds:_0x2ad18b,maxModelToken:_0x3a76b7,maxResponseTokens:_0x47b3c3,systemMessage:systemMessage='',name:_0x36b382,imageUrl:_0x21cdcf,model:_0x4d3d31,activeModel:_0x47e58e}=_0x24a43c,{parentMessageId:_0x1666df}=_0x24a43c,_0x5f3cf9=[],_0x125158=0x0;if(systemMessage){const _0x4b1fcb=['gemini-pro',_0x2cb6dc(0x18b),'hunyuan'],_0x2610f7=_0x47e58e&&_0x4b1fcb['some'](_0x599465=>_0x47e58e[_0x2cb6dc(0x193)](_0x599465));_0x2610f7?(_0x5f3cf9[_0x2cb6dc(0x18d)]({'role':_0x2cb6dc(0x1b2),'content':systemMessage,'name':_0x36b382}),_0x5f3cf9[_0x2cb6dc(0x18d)]({'role':'assistant','content':'好的','name':_0x36b382})):_0x5f3cf9[_0x2cb6dc(0x18d)]({'role':_0x2cb6dc(0x1b7),'content':systemMessage,'name':_0x36b382});}const _0x3fddda=_0x5f3cf9[_0x2cb6dc(0x1af)];let _0x129ff0=0x0;if(_0x47e58e===_0x2cb6dc(0x1ba)&&_0x21cdcf){const _0x5c2d07=[{'type':'text','text':_0x3cb6b8},{'type':_0x2cb6dc(0x1ae),'image_url':{'url':_0x21cdcf}}];_0x5f3cf9[_0x2cb6dc(0x18d)]({'role':_0x2cb6dc(0x1b2),'content':_0x5c2d07,'name':_0x36b382});}else _0x4d3d31===_0x2cb6dc(0x1aa)&&_0x21cdcf&&(_0x3cb6b8=_0x21cdcf+'\x0a'+_0x3cb6b8),_0x5f3cf9[_0x2cb6dc(0x18d)]({'role':_0x2cb6dc(0x1b2),'content':_0x3cb6b8,'name':_0x36b382});let _0x4ee727=_0x5f3cf9;do{if(!_0x1666df)break;const _0x54d402=await this[_0x2cb6dc(0x1b9)](_0x1666df);if(!_0x54d402)break;const {text:_0x356de3,name:_0x4d0136,role:_0x322ac0,imageUrl:_0x1c76f5}=_0x54d402;let _0x10dcd2=_0x356de3;_0x1c76f5&&(_0x47e58e==='gpt-4-vision-preview'&&(_0x10dcd2=[{'type':'text','text':_0x356de3},{'type':_0x2cb6dc(0x1ae),'image_url':{'url':_0x1c76f5}}]));_0x4ee727=_0x4ee727[_0x2cb6dc(0x1ad)](0x0,_0x3fddda)[_0x2cb6dc(0x191)]([{'role':_0x322ac0,'content':_0x10dcd2,'name':_0x4d0136},..._0x4ee727[_0x2cb6dc(0x1ad)](_0x3fddda)]),_0x129ff0++;if(_0x2ad18b&&_0x129ff0>=_0x2ad18b)break;if(_0x3a76b7&&_0x47b3c3){const _0x240799=_0x3a76b7-_0x47b3c3;_0x125158=await this['_getTokenCount'](_0x4ee727);const _0x8034e6=_0x125158+0xc8<=_0x240799;!_0x8034e6&&(_0x4ee727=this[_0x2cb6dc(0x197)](_0x4ee727,_0x240799,systemMessage));}_0x1666df=_0x54d402[_0x2cb6dc(0x1b3)];}while(!![]);const _0x5ade9c=Math[_0x2cb6dc(0x18a)](0x1,Math[_0x2cb6dc(0x1ac)](_0x3a76b7-_0x125158,_0x47b3c3));return console[_0x2cb6dc(0x1b5)](_0x2cb6dc(0x1a6),_0x4ee727[_0x2cb6dc(0x1af)],_0x125158),{'context':_0x4ee727,'round':_0x4ee727[_0x2cb6dc(0x1af)],'historyToken':_0x125158};}[_0x416a39(0x1ab)](_0x35905e){const _0x228d1e=_0x416a39;let _0x599a2c=_0x35905e[_0x228d1e(0x1a3)]((_0x46ba94,_0x5cec6a)=>{const _0x203d30=_0x228d1e;if(Array[_0x203d30(0x198)](_0x5cec6a[_0x203d30(0x1b6)])){const _0x730d8d=_0x5cec6a['content'][_0x203d30(0x19d)](_0x4334a2=>_0x4334a2[_0x203d30(0x18c)]===_0x203d30(0x1a1))[_0x203d30(0x185)](_0x3863aa=>_0x3863aa['text'])[_0x203d30(0x1a9)]('\x20');return _0x46ba94+_0x730d8d;}else return _0x46ba94+(_0x5cec6a[_0x203d30(0x1b6)]||'');},'');return _0x599a2c=_0x599a2c[_0x228d1e(0x1b1)](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x599a2c)['length'];}[_0x416a39(0x197)](_0x5c92ca,_0x3f73af,_0x2879b4){const _0x3958c4=_0x416a39,_0xf472ff=this[_0x3958c4(0x1ab)](_0x5c92ca);if(_0xf472ff<=_0x3f73af)return _0x5c92ca;return _0x5c92ca[_0x3958c4(0x18f)](_0x2879b4?0x1:0x0,0x1),this['_recursivePruning'](_0x5c92ca,_0x3f73af,_0x2879b4);}[_0x416a39(0x187)](){return(0x0,uuid_1['v4'])();}}exports[_0x416a39(0x1a5)]=NineStore;