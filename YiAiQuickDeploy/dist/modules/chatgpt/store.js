'use strict';const _0x194f20=_0x1dd9;(function(_0x4b5619,_0xbc79c8){const _0xc1206c=_0x1dd9,_0x1e405f=_0x4b5619();while(!![]){try{const _0x323a92=-parseInt(_0xc1206c(0x1e7))/0x1+-parseInt(_0xc1206c(0x1d9))/0x2+parseInt(_0xc1206c(0x1ca))/0x3+-parseInt(_0xc1206c(0x1c9))/0x4+parseInt(_0xc1206c(0x1d0))/0x5+-parseInt(_0xc1206c(0x1e2))/0x6*(parseInt(_0xc1206c(0x1d4))/0x7)+parseInt(_0xc1206c(0x1d5))/0x8;if(_0x323a92===_0xbc79c8)break;else _0x1e405f['push'](_0x1e405f['shift']());}catch(_0x27910a){_0x1e405f['push'](_0x1e405f['shift']());}}}(_0x4c4f,0x8be44));function _0x4c4f(){const _0x50aea4=['ERNIE','slice','set','uuid','getUuid','6yKLZwr','gpt-4-all','some','store','map','465599lsRbNs','join','log','assistant','_recursivePruning','setData','namespace','expires','max','content','system','push','defineProperty','_getTokenCount','text','type','reduce','3627716PxZAFE','2884503qIzLCB','__esModule','min','hunyuan','length','user','2994940ByimqT','本次携带上下文的长度','filter','includes','1666805iUlBta','8749616JReXkc','chat','image_url','encode','941104vZnTLp','formatOptions','gpt-4-vision-preview','cl100k_base'];_0x4c4f=function(){return _0x50aea4;};return _0x4c4f();}Object[_0x194f20(0x1f3)](exports,_0x194f20(0x1cb),{'value':!![]}),exports['NineStore']=void 0x0;function _0x1dd9(_0x4b0005,_0x47a921){const _0x4c4f14=_0x4c4f();return _0x1dd9=function(_0x1dd94f,_0x43e847){_0x1dd94f=_0x1dd94f-0x1c6;let _0x42af41=_0x4c4f14[_0x1dd94f];return _0x42af41;},_0x1dd9(_0x4b0005,_0x47a921);}const uuid_1=require(_0x194f20(0x1e0)),tiktoken_1=require('@dqbd/tiktoken'),tokenizer=(0x0,tiktoken_1['get_encoding'])(_0x194f20(0x1dc));class NineStore{constructor(_0x1452be){const _0x30d525=_0x194f20,{store:_0x2e80d1,namespace:_0x5da26a,expires:_0x1ba930}=this[_0x30d525(0x1da)](_0x1452be);this['store']=_0x2e80d1,this[_0x30d525(0x1ed)]=_0x5da26a,this[_0x30d525(0x1ee)]=_0x1ba930;}[_0x194f20(0x1da)](_0x313f4f){const _0x38ca45=_0x194f20,{store:_0x10c0d3,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace=_0x38ca45(0x1d6)}=_0x313f4f;return{'store':_0x10c0d3,'namespace':namespace,'expires':expires};}['generateKey'](_0x306084){const _0xcf4d31=_0x194f20;return this[_0xcf4d31(0x1ed)]?this[_0xcf4d31(0x1ed)]+'-'+_0x306084:_0x306084;}async['getData'](_0xb55a0){const _0x5905cf=_0x194f20,_0x4b3636=await this[_0x5905cf(0x1e5)]['get'](_0xb55a0);return _0x4b3636;}async[_0x194f20(0x1ec)](_0x58f1c1,_0x11eefb=this[_0x194f20(0x1ee)]){const _0x566ae6=_0x194f20;await this[_0x566ae6(0x1e5)][_0x566ae6(0x1df)](_0x58f1c1['id'],_0x58f1c1,_0x11eefb);}async['buildMessageFromParentMessageId'](_0x255a80,_0x1fd388){const _0x447af8=_0x194f20;let {maxRounds:_0x48070f,maxModelToken:_0x5da836,maxResponseTokens:_0x307838,systemMessage:systemMessage='',name:_0x70b4c0,imageUrl:_0x4661ad,model:_0x56f34f,activeModel:_0x548825}=_0x1fd388,{parentMessageId:_0x46ca1d}=_0x1fd388,_0x3e0873=[],_0x16c88f=0x0;if(systemMessage){const _0x2250d9=['gemini-pro',_0x447af8(0x1dd),_0x447af8(0x1cd)],_0x442318=_0x548825&&_0x2250d9[_0x447af8(0x1e4)](_0x459e1a=>_0x548825[_0x447af8(0x1d3)](_0x459e1a));_0x442318?(_0x3e0873[_0x447af8(0x1f2)]({'role':_0x447af8(0x1cf),'content':systemMessage,'name':_0x70b4c0}),_0x3e0873[_0x447af8(0x1f2)]({'role':_0x447af8(0x1ea),'content':'好的','name':_0x70b4c0})):_0x3e0873[_0x447af8(0x1f2)]({'role':_0x447af8(0x1f1),'content':systemMessage,'name':_0x70b4c0});}const _0x13b339=_0x3e0873[_0x447af8(0x1ce)];let _0x16c8ce=0x0;if(_0x548825===_0x447af8(0x1db)&&_0x4661ad){const _0x35982b=[{'type':_0x447af8(0x1c6),'text':_0x255a80},{'type':_0x447af8(0x1d7),'image_url':{'url':_0x4661ad}}];_0x3e0873[_0x447af8(0x1f2)]({'role':'user','content':_0x35982b,'name':_0x70b4c0});}else _0x56f34f===_0x447af8(0x1e3)&&_0x4661ad&&(_0x255a80=_0x4661ad+'\x0a'+_0x255a80),_0x3e0873[_0x447af8(0x1f2)]({'role':'user','content':_0x255a80,'name':_0x70b4c0});let _0x3b0cbe=_0x3e0873;do{if(!_0x46ca1d)break;const _0x31ccbb=await this['getData'](_0x46ca1d);if(!_0x31ccbb)break;const {text:_0x2e5e05,name:_0x416534,role:_0x119c22,imageUrl:_0x3d5b8d}=_0x31ccbb;let _0x3baf33=_0x2e5e05;_0x3d5b8d&&(_0x548825===_0x447af8(0x1db)&&(_0x3baf33=[{'type':'text','text':_0x2e5e05},{'type':_0x447af8(0x1d7),'image_url':{'url':_0x3d5b8d}}]));_0x3b0cbe=_0x3b0cbe[_0x447af8(0x1de)](0x0,_0x13b339)['concat']([{'role':_0x119c22,'content':_0x3baf33,'name':_0x416534},..._0x3b0cbe[_0x447af8(0x1de)](_0x13b339)]),_0x16c8ce++;if(_0x48070f&&_0x16c8ce>=_0x48070f)break;if(_0x5da836&&_0x307838){const _0x146809=_0x5da836-_0x307838;_0x16c88f=await this[_0x447af8(0x1f4)](_0x3b0cbe);const _0x3ab402=_0x16c88f+0xc8<=_0x146809;!_0x3ab402&&(_0x3b0cbe=this['_recursivePruning'](_0x3b0cbe,_0x146809,systemMessage));}_0x46ca1d=_0x31ccbb['parentMessageId'];}while(!![]);const _0x2883d1=Math[_0x447af8(0x1ef)](0x1,Math[_0x447af8(0x1cc)](_0x5da836-_0x16c88f,_0x307838));return console[_0x447af8(0x1e9)](_0x447af8(0x1d1),_0x3b0cbe[_0x447af8(0x1ce)],_0x16c88f),{'context':_0x3b0cbe,'round':_0x3b0cbe[_0x447af8(0x1ce)],'historyToken':_0x16c88f};}[_0x194f20(0x1f4)](_0x399825){const _0xfffbd5=_0x194f20;let _0x2f3146=_0x399825[_0xfffbd5(0x1c8)]((_0xab2709,_0x9c4c1d)=>{const _0x2f9970=_0xfffbd5;if(Array['isArray'](_0x9c4c1d[_0x2f9970(0x1f0)])){const _0x541ef8=_0x9c4c1d[_0x2f9970(0x1f0)][_0x2f9970(0x1d2)](_0xd6eaf7=>_0xd6eaf7[_0x2f9970(0x1c7)]==='text')[_0x2f9970(0x1e6)](_0x4a2d3a=>_0x4a2d3a[_0x2f9970(0x1c6)])[_0x2f9970(0x1e8)]('\x20');return _0xab2709+_0x541ef8;}else return _0xab2709+(_0x9c4c1d[_0x2f9970(0x1f0)]||'');},'');return _0x2f3146=_0x2f3146['replace'](/<\|endoftext\|>/g,''),tokenizer[_0xfffbd5(0x1d8)](_0x2f3146)[_0xfffbd5(0x1ce)];}[_0x194f20(0x1eb)](_0x4e5a49,_0x2353bf,_0x32ab8b){const _0x58a0ae=_0x194f20,_0x33ef1e=this['_getTokenCount'](_0x4e5a49);if(_0x33ef1e<=_0x2353bf)return _0x4e5a49;return _0x4e5a49['splice'](_0x32ab8b?0x1:0x0,0x1),this[_0x58a0ae(0x1eb)](_0x4e5a49,_0x2353bf,_0x32ab8b);}[_0x194f20(0x1e1)](){return(0x0,uuid_1['v4'])();}}exports['NineStore']=NineStore;