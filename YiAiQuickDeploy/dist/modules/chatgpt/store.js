'use strict';function _0x3c03(_0x120385,_0x31ccc0){const _0x49827f=_0x4982();return _0x3c03=function(_0x3c03f0,_0x3f3ac9){_0x3c03f0=_0x3c03f0-0x1bb;let _0x465dd2=_0x49827f[_0x3c03f0];return _0x465dd2;},_0x3c03(_0x120385,_0x31ccc0);}const _0x271013=_0x3c03;function _0x4982(){const _0x37802c=['819816Albwpy','NineStore','namespace','image_url','set','store','formatOptions','18732QMKHen','126822SyZrdU','__esModule','get','user','hunyuan','8638QhxaRl','8LGWrPm','get_encoding','gpt-4-vision-preview','defineProperty','join','chat','_recursivePruning','map','552gugTPC','min','system','encode','315050VorJfu','length','push','assistant','includes','gpt-4-all','slice','gemini-pro','getData','27lVRmBN','generateKey','log','text','content','reduce','uuid','type','expires','2172365GpRofo','_getTokenCount','replace','616TgzakC','146988udVsll','getUuid','cl100k_base'];_0x4982=function(){return _0x37802c;};return _0x4982();}(function(_0x13e038,_0x36be34){const _0x159754=_0x3c03,_0x16ec3d=_0x13e038();while(!![]){try{const _0x3bbc23=-parseInt(_0x159754(0x1d5))/0x1+-parseInt(_0x159754(0x1e5))/0x2+-parseInt(_0x159754(0x1e0))/0x3*(parseInt(_0x159754(0x1e6))/0x4)+-parseInt(_0x159754(0x1d1))/0x5+-parseInt(_0x159754(0x1bb))/0x6*(parseInt(_0x159754(0x1df))/0x7)+-parseInt(_0x159754(0x1d8))/0x8*(parseInt(_0x159754(0x1c8))/0x9)+parseInt(_0x159754(0x1bf))/0xa*(parseInt(_0x159754(0x1d4))/0xb);if(_0x3bbc23===_0x36be34)break;else _0x16ec3d['push'](_0x16ec3d['shift']());}catch(_0x1a07c0){_0x16ec3d['push'](_0x16ec3d['shift']());}}}(_0x4982,0x83ea9));Object[_0x271013(0x1e9)](exports,_0x271013(0x1e1),{'value':!![]}),exports[_0x271013(0x1d9)]=void 0x0;const uuid_1=require(_0x271013(0x1ce)),tiktoken_1=require('@dqbd/tiktoken'),tokenizer=(0x0,tiktoken_1[_0x271013(0x1e7)])(_0x271013(0x1d7));class NineStore{constructor(_0x306ebd){const _0x30e719=_0x271013,{store:_0x161ad7,namespace:_0x16cb83,expires:_0x2feaec}=this[_0x30e719(0x1de)](_0x306ebd);this[_0x30e719(0x1dd)]=_0x161ad7,this['namespace']=_0x16cb83,this[_0x30e719(0x1d0)]=_0x2feaec;}[_0x271013(0x1de)](_0x5821a0){const _0x1ce2d3=_0x271013,{store:_0x3f67bc,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace=_0x1ce2d3(0x1eb)}=_0x5821a0;return{'store':_0x3f67bc,'namespace':namespace,'expires':expires};}[_0x271013(0x1c9)](_0x5c3225){const _0x556675=_0x271013;return this[_0x556675(0x1da)]?this['namespace']+'-'+_0x5c3225:_0x5c3225;}async[_0x271013(0x1c7)](_0x4fe3f2){const _0x4c1a73=_0x271013,_0x26a26e=await this[_0x4c1a73(0x1dd)][_0x4c1a73(0x1e2)](_0x4fe3f2);return _0x26a26e;}async['setData'](_0x56bbda,_0x38fe11=this['expires']){const _0x2b7089=_0x271013;await this['store'][_0x2b7089(0x1dc)](_0x56bbda['id'],_0x56bbda,_0x38fe11);}async['buildMessageFromParentMessageId'](_0x5d749c,_0xb1b2f0){const _0x5a31bb=_0x271013;let {maxRounds:_0x6fed5f,maxModelToken:_0x250f4f,maxResponseTokens:_0x35c070,systemMessage:systemMessage='',name:_0x10c43e,imageUrl:_0xd78754,model:_0x97acbf,activeModel:_0x5867eb}=_0xb1b2f0,{parentMessageId:_0x44ee67}=_0xb1b2f0,_0x5fb7d7=[],_0x4a8eea=0x0;if(systemMessage){const _0x9967b9=[_0x5a31bb(0x1c6),'ERNIE',_0x5a31bb(0x1e4)],_0x76ed6d=_0x5867eb&&_0x9967b9['some'](_0x368900=>_0x5867eb[_0x5a31bb(0x1c3)](_0x368900));_0x76ed6d?(_0x5fb7d7[_0x5a31bb(0x1c1)]({'role':_0x5a31bb(0x1e3),'content':systemMessage,'name':_0x10c43e}),_0x5fb7d7[_0x5a31bb(0x1c1)]({'role':_0x5a31bb(0x1c2),'content':'好的','name':_0x10c43e})):_0x5fb7d7[_0x5a31bb(0x1c1)]({'role':_0x5a31bb(0x1bd),'content':systemMessage,'name':_0x10c43e});}const _0x3157fd=_0x5fb7d7[_0x5a31bb(0x1c0)];let _0x26e2d6=0x0;if(_0x5867eb===_0x5a31bb(0x1e8)&&_0xd78754){const _0x2b6a96=[{'type':_0x5a31bb(0x1cb),'text':_0x5d749c},{'type':'image_url','image_url':{'url':_0xd78754}}];_0x5fb7d7[_0x5a31bb(0x1c1)]({'role':_0x5a31bb(0x1e3),'content':_0x2b6a96,'name':_0x10c43e});}else _0x97acbf===_0x5a31bb(0x1c4)&&_0xd78754&&(_0x5d749c=_0xd78754+'\x0a'+_0x5d749c),_0x5fb7d7[_0x5a31bb(0x1c1)]({'role':_0x5a31bb(0x1e3),'content':_0x5d749c,'name':_0x10c43e});let _0x129da4=_0x5fb7d7;do{if(!_0x44ee67)break;const _0x300bb0=await this[_0x5a31bb(0x1c7)](_0x44ee67);if(!_0x300bb0)break;const {text:_0x266ddc,name:_0x5f448a,role:_0x30ae1f,imageUrl:_0xc61c80}=_0x300bb0;let _0x13b903=_0x266ddc;_0xc61c80&&(_0x5867eb==='gpt-4-vision-preview'&&(_0x13b903=[{'type':'text','text':_0x266ddc},{'type':_0x5a31bb(0x1db),'image_url':{'url':_0xc61c80}}]));_0x129da4=_0x129da4['slice'](0x0,_0x3157fd)['concat']([{'role':_0x30ae1f,'content':_0x13b903,'name':_0x5f448a},..._0x129da4[_0x5a31bb(0x1c5)](_0x3157fd)]),_0x26e2d6++;if(_0x6fed5f&&_0x26e2d6>=_0x6fed5f)break;if(_0x250f4f&&_0x35c070){const _0x2558f9=_0x250f4f-_0x35c070;_0x4a8eea=await this[_0x5a31bb(0x1d2)](_0x129da4);const _0x37deec=_0x4a8eea+0xc8<=_0x2558f9;!_0x37deec&&(_0x129da4=this[_0x5a31bb(0x1ec)](_0x129da4,_0x2558f9,systemMessage));}_0x44ee67=_0x300bb0['parentMessageId'];}while(!![]);const _0x265214=Math['max'](0x1,Math[_0x5a31bb(0x1bc)](_0x250f4f-_0x4a8eea,_0x35c070));return console[_0x5a31bb(0x1ca)]('本次携带上下文的长度',_0x129da4[_0x5a31bb(0x1c0)],_0x4a8eea),{'context':_0x129da4,'round':_0x129da4[_0x5a31bb(0x1c0)],'historyToken':_0x4a8eea};}['_getTokenCount'](_0x23bb0a){const _0x1707e8=_0x271013;let _0x35a546=_0x23bb0a[_0x1707e8(0x1cd)]((_0x46b4b3,_0x5b0d9a)=>{const _0x5e4686=_0x1707e8;if(Array['isArray'](_0x5b0d9a[_0x5e4686(0x1cc)])){const _0x4a5a35=_0x5b0d9a[_0x5e4686(0x1cc)]['filter'](_0x41d2a1=>_0x41d2a1[_0x5e4686(0x1cf)]===_0x5e4686(0x1cb))[_0x5e4686(0x1ed)](_0x129751=>_0x129751[_0x5e4686(0x1cb)])[_0x5e4686(0x1ea)]('\x20');return _0x46b4b3+_0x4a5a35;}else return _0x46b4b3+(_0x5b0d9a['content']||'');},'');return _0x35a546=_0x35a546[_0x1707e8(0x1d3)](/<\|endoftext\|>/g,''),tokenizer[_0x1707e8(0x1be)](_0x35a546)[_0x1707e8(0x1c0)];}[_0x271013(0x1ec)](_0x33ab76,_0x4b4533,_0xd97e95){const _0x47ddec=_0x271013,_0x367a18=this[_0x47ddec(0x1d2)](_0x33ab76);if(_0x367a18<=_0x4b4533)return _0x33ab76;return _0x33ab76['splice'](_0xd97e95?0x1:0x0,0x1),this['_recursivePruning'](_0x33ab76,_0x4b4533,_0xd97e95);}[_0x271013(0x1d6)](){return(0x0,uuid_1['v4'])();}}exports['NineStore']=NineStore;