'use strict';const _0x13b68c=_0x2f53;(function(_0x5845f9,_0x56959a){const _0x1bd5d4=_0x2f53,_0x2bb06a=_0x5845f9();while(!![]){try{const _0xb74bf5=parseInt(_0x1bd5d4(0x1a6))/0x1+parseInt(_0x1bd5d4(0x17c))/0x2+parseInt(_0x1bd5d4(0x198))/0x3*(parseInt(_0x1bd5d4(0x187))/0x4)+parseInt(_0x1bd5d4(0x1ad))/0x5*(-parseInt(_0x1bd5d4(0x190))/0x6)+-parseInt(_0x1bd5d4(0x194))/0x7*(-parseInt(_0x1bd5d4(0x19e))/0x8)+-parseInt(_0x1bd5d4(0x1a1))/0x9+-parseInt(_0x1bd5d4(0x1a8))/0xa*(parseInt(_0x1bd5d4(0x18c))/0xb);if(_0xb74bf5===_0x56959a)break;else _0x2bb06a['push'](_0x2bb06a['shift']());}catch(_0x4199ef){_0x2bb06a['push'](_0x2bb06a['shift']());}}}(_0x26fd,0xdf7cb));Object[_0x13b68c(0x197)](exports,_0x13b68c(0x17e),{'value':!![]}),exports[_0x13b68c(0x1b0)]=void 0x0;const uuid_1=require(_0x13b68c(0x18b)),tiktoken_1=require(_0x13b68c(0x1ab)),tokenizer=(0x0,tiktoken_1[_0x13b68c(0x19c)])(_0x13b68c(0x191));function _0x2f53(_0x4fb016,_0x1ae1e8){const _0x26fd8e=_0x26fd();return _0x2f53=function(_0x2f533b,_0x578fe7){_0x2f533b=_0x2f533b-0x17b;let _0x53c368=_0x26fd8e[_0x2f533b];return _0x53c368;},_0x2f53(_0x4fb016,_0x1ae1e8);}function _0x26fd(){const _0x21bb67=['getUuid','__esModule','gpt-4-all','_getTokenCount','set','text','type','system','max','isArray','29644IvLChF','hunyuan','slice','content','uuid','13211781gPSRzc','gpt-4-vision-preview','image_url','length','90iZSrTZ','cl100k_base','store','generateKey','164752qQAsTy','formatOptions','user','defineProperty','549bmNTrY','ERNIE','push','concat','get_encoding','gemini-pro','352LNYJja','getData','chat','15423111udTfsw','expires','log','namespace','filter','763040HWVSlw','get','10IzziYr','join','_recursivePruning','@dqbd/tiktoken','reduce','362405lNxVvN','includes','buildMessageFromParentMessageId','NineStore','min','setData','3525062ndNCNi'];_0x26fd=function(){return _0x21bb67;};return _0x26fd();}class NineStore{constructor(_0xb8621a){const _0x5004cc=_0x13b68c,{store:_0x1a7c59,namespace:_0x34a699,expires:_0xd208db}=this[_0x5004cc(0x195)](_0xb8621a);this[_0x5004cc(0x192)]=_0x1a7c59,this[_0x5004cc(0x1a4)]=_0x34a699,this[_0x5004cc(0x1a2)]=_0xd208db;}[_0x13b68c(0x195)](_0x389800){const _0xad6ed8=_0x13b68c,{store:_0xbfce0b,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace=_0xad6ed8(0x1a0)}=_0x389800;return{'store':_0xbfce0b,'namespace':namespace,'expires':expires};}[_0x13b68c(0x193)](_0x4bde7f){const _0x30fc60=_0x13b68c;return this[_0x30fc60(0x1a4)]?this['namespace']+'-'+_0x4bde7f:_0x4bde7f;}async[_0x13b68c(0x19f)](_0x3dd898){const _0x1618e8=_0x13b68c,_0x2835f1=await this[_0x1618e8(0x192)][_0x1618e8(0x1a7)](_0x3dd898);return _0x2835f1;}async[_0x13b68c(0x17b)](_0x11aa73,_0x238143=this[_0x13b68c(0x1a2)]){const _0x2bcf38=_0x13b68c;await this[_0x2bcf38(0x192)][_0x2bcf38(0x181)](_0x11aa73['id'],_0x11aa73,_0x238143);}async[_0x13b68c(0x1af)](_0x1c7f22,_0x20b73c){const _0x1a1664=_0x13b68c;let {maxRounds:_0x233f64,maxModelToken:_0x15e986,maxResponseTokens:_0x2872e0,systemMessage:systemMessage='',name:_0x3f5758,imageUrl:_0x3ce361,model:_0xfdcb6b,activeModel:_0xdf951c}=_0x20b73c,{parentMessageId:_0x54b939}=_0x20b73c,_0x564c7f=[],_0x3ecc17=0x0;if(systemMessage){const _0x54878c=[_0x1a1664(0x19d),_0x1a1664(0x199),_0x1a1664(0x188)],_0x510929=_0xdf951c&&_0x54878c['some'](_0x29a089=>_0xdf951c[_0x1a1664(0x1ae)](_0x29a089));_0x510929?(_0x564c7f[_0x1a1664(0x19a)]({'role':_0x1a1664(0x196),'content':systemMessage,'name':_0x3f5758}),_0x564c7f[_0x1a1664(0x19a)]({'role':'assistant','content':'好的','name':_0x3f5758})):_0x564c7f[_0x1a1664(0x19a)]({'role':_0x1a1664(0x184),'content':systemMessage,'name':_0x3f5758});}const _0x20d1b4=_0x564c7f[_0x1a1664(0x18f)];let _0x249092=0x0;if(_0xdf951c===_0x1a1664(0x18d)&&_0x3ce361){const _0x4539ce=[{'type':_0x1a1664(0x182),'text':_0x1c7f22},{'type':_0x1a1664(0x18e),'image_url':{'url':_0x3ce361}}];_0x564c7f[_0x1a1664(0x19a)]({'role':_0x1a1664(0x196),'content':_0x4539ce,'name':_0x3f5758});}else _0xfdcb6b===_0x1a1664(0x17f)&&_0x3ce361&&(_0x1c7f22=_0x3ce361+'\x0a'+_0x1c7f22),_0x564c7f['push']({'role':_0x1a1664(0x196),'content':_0x1c7f22,'name':_0x3f5758});let _0x25b767=_0x564c7f;do{if(!_0x54b939)break;const _0x5041a5=await this[_0x1a1664(0x19f)](_0x54b939);if(!_0x5041a5)break;const {text:_0x292c76,name:_0x1ded19,role:_0x3a3c67,imageUrl:_0x16ff6f}=_0x5041a5;let _0x5db0a7=_0x292c76;_0x16ff6f&&(_0xdf951c===_0x1a1664(0x18d)&&(_0x5db0a7=[{'type':_0x1a1664(0x182),'text':_0x292c76},{'type':'image_url','image_url':{'url':_0x16ff6f}}]));_0x25b767=_0x25b767[_0x1a1664(0x189)](0x0,_0x20d1b4)[_0x1a1664(0x19b)]([{'role':_0x3a3c67,'content':_0x5db0a7,'name':_0x1ded19},..._0x25b767['slice'](_0x20d1b4)]),_0x249092++;if(_0x233f64&&_0x249092>=_0x233f64)break;if(_0x15e986&&_0x2872e0){const _0x3ca792=_0x15e986-_0x2872e0;_0x3ecc17=await this['_getTokenCount'](_0x25b767);const _0x1afe32=_0x3ecc17+0xc8<=_0x3ca792;!_0x1afe32&&(_0x25b767=this[_0x1a1664(0x1aa)](_0x25b767,_0x3ca792,systemMessage));}_0x54b939=_0x5041a5['parentMessageId'];}while(!![]);const _0x3b5b60=Math[_0x1a1664(0x185)](0x1,Math[_0x1a1664(0x1b1)](_0x15e986-_0x3ecc17,_0x2872e0));return console[_0x1a1664(0x1a3)]('本次携带上下文的长度',_0x25b767[_0x1a1664(0x18f)],_0x3ecc17),{'context':_0x25b767,'round':_0x25b767[_0x1a1664(0x18f)],'historyToken':_0x3ecc17};}[_0x13b68c(0x180)](_0x5bb6ba){const _0xbab0cb=_0x13b68c;let _0x33b4d3=_0x5bb6ba[_0xbab0cb(0x1ac)]((_0x3fb8ea,_0x199bb7)=>{const _0x2d0796=_0xbab0cb;if(Array[_0x2d0796(0x186)](_0x199bb7['content'])){const _0x25ea24=_0x199bb7['content'][_0x2d0796(0x1a5)](_0x2a2185=>_0x2a2185[_0x2d0796(0x183)]===_0x2d0796(0x182))['map'](_0x1d5ce9=>_0x1d5ce9['text'])[_0x2d0796(0x1a9)]('\x20');return _0x3fb8ea+_0x25ea24;}else return _0x3fb8ea+(_0x199bb7[_0x2d0796(0x18a)]||'');},'');return _0x33b4d3=_0x33b4d3['replace'](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x33b4d3)['length'];}[_0x13b68c(0x1aa)](_0x4ffe49,_0x5d2abe,_0x181c54){const _0x4dd9a2=_0x13b68c,_0x322c34=this[_0x4dd9a2(0x180)](_0x4ffe49);if(_0x322c34<=_0x5d2abe)return _0x4ffe49;return _0x4ffe49['splice'](_0x181c54?0x1:0x0,0x1),this[_0x4dd9a2(0x1aa)](_0x4ffe49,_0x5d2abe,_0x181c54);}[_0x13b68c(0x17d)](){return(0x0,uuid_1['v4'])();}}exports[_0x13b68c(0x1b0)]=NineStore;