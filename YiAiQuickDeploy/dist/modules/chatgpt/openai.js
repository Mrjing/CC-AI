'use strict';const _0x5ed222=_0x21d7;(function(_0x49990a,_0x61860e){const _0x3257dc=_0x21d7,_0x454477=_0x49990a();while(!![]){try{const _0x1c254e=parseInt(_0x3257dc(0x163))/0x1+-parseInt(_0x3257dc(0x157))/0x2+-parseInt(_0x3257dc(0x14e))/0x3*(parseInt(_0x3257dc(0x14b))/0x4)+parseInt(_0x3257dc(0x15c))/0x5*(-parseInt(_0x3257dc(0x166))/0x6)+parseInt(_0x3257dc(0x13d))/0x7+parseInt(_0x3257dc(0x151))/0x8+parseInt(_0x3257dc(0x172))/0x9;if(_0x1c254e===_0x61860e)break;else _0x454477['push'](_0x454477['shift']());}catch(_0x42aa45){_0x454477['push'](_0x454477['shift']());}}}(_0xe961,0xbe947));function _0xe961(){const _0x94330c=['绘制图片失败，请检查你的提示词是否有非法描述！','includes','endsWith','/v1/images/generations','openai-draw\x20error:\x20','MidjourneyService','detail','------>\x20开始上传图片！！！','3776116TShsGZ','[DONE]\x20','defineProperty','3YUZbra','@dqbd/tiktoken','data','2582080PKERNN','get_encoding','b64_json','max_tokens','from','/v1/chat/completions','586050YQjUkh','trim','content','split','stringify','70CUADsI','string','Bearer\x20','length','\x20[DONE]','gpt-4-vision-preview','getTokenCount','1421998yLzDAf','parse\x20Error','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','662844YISBbU','error','绘制图片失败，此次绘画被拒绝了！','sendMessageFromOpenAi','cl100k_base','filter','https://api.openai.com','Logger','application/json','log','当前请求已过载、请稍等会儿再试试吧！','POST','8223264NVRvDV','stream','uploadFile','[DONE]','replace','parse','imageUrl','slice','finish_reason','Billing\x20hard\x20limit\x20has\x20been\x20reached','role','response','.png','data:','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','上传图片过程中出现错误:\x20','dall','status','debug','choices','base64','6340957RXsLdo','text','forEach','toString','default','绘制图片失败，请稍后试试吧！'];_0xe961=function(){return _0x94330c;};return _0xe961();}Object[_0x5ed222(0x14d)](exports,'__esModule',{'value':!![]}),exports[_0x5ed222(0x162)]=exports[_0x5ed222(0x169)]=void 0x0;const axios_1=require('axios'),tiktoken_1=require(_0x5ed222(0x14f)),common_1=require('@nestjs/common'),uuid=require('uuid'),tokenizer=(0x0,tiktoken_1[_0x5ed222(0x152)])(_0x5ed222(0x16a));function getFullUrl(_0x895c47){const _0x2a9492=_0x5ed222,_0x56aedb=_0x895c47[_0x2a9492(0x145)]('/')?_0x895c47[_0x2a9492(0x179)](0x0,-0x1):_0x895c47,_0x5a0935=_0x56aedb||_0x2a9492(0x16c);return _0x5a0935+_0x2a9492(0x156);}async function sendMessageFromOpenAi(_0x55c130,_0x8263b6,_0xa11530){const _0x1b9aee=_0x5ed222;var _0x47c2b9,_0x328999,_0x37f88e,_0xd0a889;const {onProgress:_0x466196,maxToken:_0x232125,apiKey:_0x1f9822,model:_0xe8c20f,temperature:temperature=0.8,proxyUrl:_0x374c75,prompt:_0x27ae20}=_0x8263b6;if(_0xe8c20f[_0x1b9aee(0x144)](_0x1b9aee(0x138))){let _0x44c43e={'text':'','imageUrl':''};try{const _0x821791={'method':'POST','url':_0x374c75+_0x1b9aee(0x146),'headers':{'Content-Type':_0x1b9aee(0x16e),'Authorization':'Bearer\x20'+_0x1f9822},'data':{'prompt':_0x27ae20,'model':_0xe8c20f,'response_format':_0x1b9aee(0x153)}},_0x3c4643=await(0x0,axios_1[_0x1b9aee(0x141)])(_0x821791),{b64_json:_0x48084f,revised_prompt:_0x3c5eb1}=_0x3c4643[_0x1b9aee(0x150)][_0x1b9aee(0x150)][0x0],_0xc04b00=Buffer['from'](_0x48084f,_0x1b9aee(0x13c));let _0x1a314a='';try{const _0x1b325c=uuid['v4']()[_0x1b9aee(0x179)](0x0,0xa)+_0x1b9aee(0x134);common_1['Logger'][_0x1b9aee(0x13a)](_0x1b9aee(0x14a),_0x1b9aee(0x148));const _0x4a9bf9=Buffer[_0x1b9aee(0x155)](_0x48084f,_0x1b9aee(0x13c));_0x1a314a=await _0xa11530[_0x1b9aee(0x174)]({'filename':_0x1b325c,'buffer':_0x4a9bf9}),common_1[_0x1b9aee(0x16d)][_0x1b9aee(0x13a)]('图片上传成功，URL:\x20'+_0x1a314a,_0x1b9aee(0x148));}catch(_0x1dd30b){common_1[_0x1b9aee(0x16d)]['error'](_0x1b9aee(0x137)+_0x1dd30b,'MidjourneyService');}return _0x44c43e[_0x1b9aee(0x178)]=_0x1a314a,_0x44c43e[_0x1b9aee(0x13e)]=_0x3c5eb1,_0x466196&&_0x466196({'text':_0x44c43e[_0x1b9aee(0x13e)]}),_0x44c43e;}catch(_0x3d6c01){const _0x33963d=((_0x47c2b9=_0x3d6c01===null||_0x3d6c01===void 0x0?void 0x0:_0x3d6c01['response'])===null||_0x47c2b9===void 0x0?void 0x0:_0x47c2b9[_0x1b9aee(0x139)])||0x1f4;console[_0x1b9aee(0x16f)](_0x1b9aee(0x147),JSON[_0x1b9aee(0x15b)](_0x3d6c01),_0x33963d);const _0x3bd174=(_0xd0a889=(_0x37f88e=(_0x328999=_0x3d6c01===null||_0x3d6c01===void 0x0?void 0x0:_0x3d6c01[_0x1b9aee(0x133)])===null||_0x328999===void 0x0?void 0x0:_0x328999[_0x1b9aee(0x150)])===null||_0x37f88e===void 0x0?void 0x0:_0x37f88e[_0x1b9aee(0x167)])===null||_0xd0a889===void 0x0?void 0x0:_0xd0a889['message'];if(_0x33963d===0x1ad)return _0x44c43e[_0x1b9aee(0x13e)]=_0x1b9aee(0x170),_0x44c43e;if(_0x33963d===0x190&&_0x3bd174[_0x1b9aee(0x144)](_0x1b9aee(0x165)))return _0x44c43e[_0x1b9aee(0x13e)]='您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',_0x44c43e;if(_0x33963d===0x190&&_0x3bd174[_0x1b9aee(0x144)](_0x1b9aee(0x131)))return _0x44c43e[_0x1b9aee(0x13e)]=_0x1b9aee(0x136),_0x44c43e;if(_0x33963d===0x1f4)return _0x44c43e[_0x1b9aee(0x13e)]=_0x1b9aee(0x143),_0x44c43e;if(_0x33963d===0x191)return _0x44c43e['text']=_0x1b9aee(0x168),_0x44c43e;return _0x44c43e[_0x1b9aee(0x13e)]=_0x1b9aee(0x142),_0x44c43e;}}else{let _0x6a5bea={'text':''};const _0x3b50c9={'method':_0x1b9aee(0x171),'url':getFullUrl(_0x374c75),'responseType':_0x1b9aee(0x173),'headers':{'Content-Type':_0x1b9aee(0x16e),'Accept':_0x1b9aee(0x16e),'Authorization':_0x1b9aee(0x15e)+_0x1f9822},'data':{'stream':!![],'temperature':temperature,'model':_0xe8c20f,'messages':_0x55c130}};return _0xe8c20f===_0x1b9aee(0x161)&&(_0x3b50c9[_0x1b9aee(0x150)][_0x1b9aee(0x154)]=0x800),new Promise(async(_0xed4984,_0x1ca4c3)=>{const _0x4868c3=_0x1b9aee;try{const _0x20fc2c=await(0x0,axios_1[_0x4868c3(0x141)])(_0x3b50c9),_0x8ef5c8=_0x20fc2c[_0x4868c3(0x150)];_0x8ef5c8['on'](_0x4868c3(0x150),_0x57e9df=>{const _0xdcef21=_0x4868c3;var _0x299448;const _0x189055=_0x57e9df[_0xdcef21(0x140)]()[_0xdcef21(0x15a)]('\x0a\x0a')[_0xdcef21(0x16b)](_0x1de0c6=>_0x1de0c6[_0xdcef21(0x158)]()!=='');for(const _0x8f2473 of _0x189055){const _0x5b18f3=_0x8f2473['replace'](_0xdcef21(0x135),'');let _0x2581f9=![];try{_0x2581f9=JSON[_0xdcef21(0x177)](_0x5b18f3)[_0xdcef21(0x13b)][0x0][_0xdcef21(0x130)]==='stop';}catch(_0xf27d5){_0x2581f9=![];}if(_0x2581f9)return _0x6a5bea[_0xdcef21(0x13e)]=_0x6a5bea[_0xdcef21(0x13e)]['trim'](),_0x6a5bea;try{if(_0x5b18f3!==_0xdcef21(0x160)&&_0x5b18f3!==_0xdcef21(0x175)&&_0x5b18f3!=_0xdcef21(0x14c)){const _0x304f4b=JSON[_0xdcef21(0x177)](_0x5b18f3);_0x304f4b['id']&&(_0x6a5bea['id']=_0x304f4b['id']);if((_0x299448=_0x304f4b[_0xdcef21(0x13b)])===null||_0x299448===void 0x0?void 0x0:_0x299448[_0xdcef21(0x15f)]){const _0x1d8ef8=_0x304f4b[_0xdcef21(0x13b)][0x0]['delta'];_0x6a5bea['delta']=_0x1d8ef8[_0xdcef21(0x159)];if(_0x1d8ef8===null||_0x1d8ef8===void 0x0?void 0x0:_0x1d8ef8[_0xdcef21(0x159)])_0x6a5bea[_0xdcef21(0x13e)]+=_0x1d8ef8[_0xdcef21(0x159)];_0x1d8ef8['role']&&(_0x6a5bea[_0xdcef21(0x132)]=_0x1d8ef8['role']),_0x6a5bea[_0xdcef21(0x149)]=_0x304f4b;}_0x466196&&_0x466196({'text':_0x6a5bea[_0xdcef21(0x13e)]});}}catch(_0x2efb59){console[_0xdcef21(0x16f)](_0xdcef21(0x164),_0x5b18f3);}}});let _0x447b5f='';_0x55c130[_0x4868c3(0x13f)](_0x413723=>{_0x447b5f+=_0x413723['content']+'\x20';}),_0x8ef5c8['on']('end',()=>{const _0x213933=_0x4868c3;if(_0x6a5bea[_0x213933(0x149)]&&_0x6a5bea[_0x213933(0x13e)]){const _0x49dd0f=getTokenCount(_0x447b5f),_0x13c837=getTokenCount(_0x6a5bea[_0x213933(0x13e)]);_0x6a5bea[_0x213933(0x149)]['usage']={'prompt_tokens':_0x49dd0f,'completion_tokens':_0x13c837,'total_tokens':_0x49dd0f+_0x13c837,'estimated':!![]};}return _0xed4984(_0x6a5bea);});}catch(_0x4826a8){_0x1ca4c3(_0x4826a8);}});}}exports['sendMessageFromOpenAi']=sendMessageFromOpenAi;function getTokenCount(_0x592a3d){const _0x3970c6=_0x5ed222;if(!_0x592a3d)return 0x0;return typeof _0x592a3d!==_0x3970c6(0x15d)&&(_0x592a3d=String(_0x592a3d)),_0x592a3d=_0x592a3d[_0x3970c6(0x176)](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x592a3d)[_0x3970c6(0x15f)];}function _0x21d7(_0x379e31,_0x44cf15){const _0xe961c8=_0xe961();return _0x21d7=function(_0x21d720,_0x872c5){_0x21d720=_0x21d720-0x130;let _0x5eeede=_0xe961c8[_0x21d720];return _0x5eeede;},_0x21d7(_0x379e31,_0x44cf15);}exports[_0x5ed222(0x162)]=getTokenCount;