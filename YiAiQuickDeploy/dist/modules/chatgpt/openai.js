'use strict';const _0x4a0331=_0x4dfe;(function(_0x538b48,_0x1a069b){const _0x406f1a=_0x4dfe,_0x18ef29=_0x538b48();while(!![]){try{const _0xc81235=parseInt(_0x406f1a(0xab))/0x1*(parseInt(_0x406f1a(0x96))/0x2)+-parseInt(_0x406f1a(0xb2))/0x3+-parseInt(_0x406f1a(0x98))/0x4*(parseInt(_0x406f1a(0x82))/0x5)+-parseInt(_0x406f1a(0x9b))/0x6+parseInt(_0x406f1a(0xb1))/0x7*(parseInt(_0x406f1a(0xc5))/0x8)+-parseInt(_0x406f1a(0xb9))/0x9*(parseInt(_0x406f1a(0xb6))/0xa)+parseInt(_0x406f1a(0xb0))/0xb*(parseInt(_0x406f1a(0x99))/0xc);if(_0xc81235===_0x1a069b)break;else _0x18ef29['push'](_0x18ef29['shift']());}catch(_0x2b6c5c){_0x18ef29['push'](_0x18ef29['shift']());}}}(_0x44c9,0x18f29));Object[_0x4a0331(0xa5)](exports,'__esModule',{'value':!![]}),exports[_0x4a0331(0x88)]=exports['sendMessageFromOpenAi']=void 0x0;const axios_1=require('axios'),tiktoken_1=require(_0x4a0331(0x8c)),common_1=require(_0x4a0331(0xaf)),uuid=require(_0x4a0331(0xbe)),tokenizer=(0x0,tiktoken_1[_0x4a0331(0x87)])('cl100k_base');function getFullUrl(_0x33bc0f){const _0x113234=_0x4a0331,_0x1bc0e9=_0x33bc0f[_0x113234(0xa1)]('/')?_0x33bc0f[_0x113234(0xbd)](0x0,-0x1):_0x33bc0f,_0x5d1990=_0x1bc0e9||'https://api.openai.com';return _0x5d1990+_0x113234(0xb7);}async function sendMessageFromOpenAi(_0x385141,_0x52b399,_0x43b47f){const _0x17d895=_0x4a0331;var _0x5a3279,_0x2c6064,_0xb17420,_0x5e5072;const {onProgress:_0x191cc,maxToken:_0x4e9c59,apiKey:_0x5df530,model:_0xdbd1b0,temperature:temperature=0.8,proxyUrl:_0x439154,prompt:_0x42eb38}=_0x52b399;if(_0xdbd1b0[_0x17d895(0xa3)]('dall')){let _0x30bb47={'text':'','imageUrl':''};try{const _0x4807f9={'method':_0x17d895(0x94),'url':_0x439154+_0x17d895(0xa2),'headers':{'Content-Type':'application/json','Authorization':'Bearer\x20'+_0x5df530},'data':{'prompt':_0x42eb38,'model':_0xdbd1b0,'response_format':_0x17d895(0x9c)}},_0x76d092=await(0x0,axios_1[_0x17d895(0xb3)])(_0x4807f9),{b64_json:_0x296be7,revised_prompt:_0xdd7b75}=_0x76d092['data'][_0x17d895(0xa6)][0x0],_0x3ede44=Buffer[_0x17d895(0xa8)](_0x296be7,_0x17d895(0xc4));let _0x555a42='';try{const _0x19314d=uuid['v4']()[_0x17d895(0xbd)](0x0,0xa)+'.png';common_1[_0x17d895(0xbc)]['debug'](_0x17d895(0x85),_0x17d895(0xb8));const _0x233e16=Buffer['from'](_0x296be7,_0x17d895(0xc4));_0x555a42=await _0x43b47f[_0x17d895(0x84)]({'filename':_0x19314d,'buffer':_0x233e16}),common_1[_0x17d895(0xbc)]['debug'](_0x17d895(0x9f)+_0x555a42,'MidjourneyService');}catch(_0x382a9a){common_1[_0x17d895(0xbc)][_0x17d895(0x86)](_0x17d895(0x9e)+_0x382a9a,'MidjourneyService');}return _0x30bb47[_0x17d895(0x80)]=_0x555a42,_0x30bb47[_0x17d895(0x8e)]=_0xdd7b75,_0x191cc&&_0x191cc({'text':_0x30bb47[_0x17d895(0x8e)]}),_0x30bb47;}catch(_0x510d72){const _0x5e017b=((_0x5a3279=_0x510d72===null||_0x510d72===void 0x0?void 0x0:_0x510d72[_0x17d895(0x89)])===null||_0x5a3279===void 0x0?void 0x0:_0x5a3279[_0x17d895(0xc3)])||0x1f4;console[_0x17d895(0x90)](_0x17d895(0xa0),JSON[_0x17d895(0xb4)](_0x510d72),_0x5e017b);const _0x55015b=(_0x5e5072=(_0xb17420=(_0x2c6064=_0x510d72===null||_0x510d72===void 0x0?void 0x0:_0x510d72[_0x17d895(0x89)])===null||_0x2c6064===void 0x0?void 0x0:_0x2c6064[_0x17d895(0xa6)])===null||_0xb17420===void 0x0?void 0x0:_0xb17420[_0x17d895(0x86)])===null||_0x5e5072===void 0x0?void 0x0:_0x5e5072[_0x17d895(0xa9)];if(_0x5e017b===0x1ad)return _0x30bb47[_0x17d895(0x8e)]='当前请求已过载、请稍等会儿再试试吧！',_0x30bb47;if(_0x5e017b===0x190&&_0x55015b[_0x17d895(0xa3)](_0x17d895(0xc0)))return _0x30bb47[_0x17d895(0x8e)]='您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',_0x30bb47;if(_0x5e017b===0x190&&_0x55015b['includes'](_0x17d895(0x95)))return _0x30bb47[_0x17d895(0x8e)]='当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',_0x30bb47;if(_0x5e017b===0x1f4)return _0x30bb47[_0x17d895(0x8e)]=_0x17d895(0xc2),_0x30bb47;if(_0x5e017b===0x191)return _0x30bb47[_0x17d895(0x8e)]=_0x17d895(0xb5),_0x30bb47;return _0x30bb47[_0x17d895(0x8e)]='绘制图片失败，请稍后试试吧！',_0x30bb47;}}else{let _0x1e0aec={'text':''};const _0x29fa78={'method':_0x17d895(0x94),'url':getFullUrl(_0x439154),'responseType':'stream','headers':{'Content-Type':_0x17d895(0xba),'Accept':_0x17d895(0xba),'Authorization':_0x17d895(0xae)+_0x5df530},'data':{'stream':!![],'temperature':temperature,'model':_0xdbd1b0,'messages':_0x385141}};return _0xdbd1b0===_0x17d895(0x91)&&(_0x29fa78[_0x17d895(0xa6)][_0x17d895(0x92)]=0x800),new Promise(async(_0x2f3475,_0x217170)=>{const _0x293969=_0x17d895;try{const _0x39601f=await(0x0,axios_1[_0x293969(0xb3)])(_0x29fa78),_0x9487d6=_0x39601f[_0x293969(0xa6)];_0x9487d6['on']('data',_0x295e27=>{const _0x4f31f3=_0x293969;var _0x203c98;const _0x29c699=_0x295e27[_0x4f31f3(0xac)]()[_0x4f31f3(0xa7)]('\x0a\x0a')[_0x4f31f3(0xad)](_0x40c378=>_0x40c378['trim']()!=='');for(const _0x1846d4 of _0x29c699){const _0x1add8b=_0x1846d4['replace']('data:','');let _0x2c031d=![];try{_0x2c031d=JSON[_0x4f31f3(0x9d)](_0x1add8b)[_0x4f31f3(0x8a)][0x0][_0x4f31f3(0xaa)]==='stop';}catch(_0x415bd5){_0x2c031d=![];}if(_0x2c031d)return _0x1e0aec[_0x4f31f3(0x8e)]=_0x1e0aec[_0x4f31f3(0x8e)][_0x4f31f3(0x81)](),_0x1e0aec;try{if(_0x1add8b!==_0x4f31f3(0x93)&&_0x1add8b!=='[DONE]'&&_0x1add8b!='[DONE]\x20'){const _0x4895bc=JSON[_0x4f31f3(0x9d)](_0x1add8b);_0x4895bc['id']&&(_0x1e0aec['id']=_0x4895bc['id']);if((_0x203c98=_0x4895bc[_0x4f31f3(0x8a)])===null||_0x203c98===void 0x0?void 0x0:_0x203c98['length']){const _0x2823b8=_0x4895bc[_0x4f31f3(0x8a)][0x0][_0x4f31f3(0x83)];_0x1e0aec['delta']=_0x2823b8['content'];if(_0x2823b8===null||_0x2823b8===void 0x0?void 0x0:_0x2823b8['content'])_0x1e0aec[_0x4f31f3(0x8e)]+=_0x2823b8[_0x4f31f3(0x9a)];_0x2823b8[_0x4f31f3(0x8d)]&&(_0x1e0aec[_0x4f31f3(0x8d)]=_0x2823b8[_0x4f31f3(0x8d)]),_0x1e0aec[_0x4f31f3(0xc6)]=_0x4895bc;}_0x191cc&&_0x191cc({'text':_0x1e0aec[_0x4f31f3(0x8e)]});}}catch(_0x16aed7){console[_0x4f31f3(0x90)](_0x4f31f3(0xbf),_0x1add8b);}}});let _0x316001='';_0x385141[_0x293969(0x97)](_0x41660e=>{_0x316001+=_0x41660e['content']+'\x20';}),_0x9487d6['on'](_0x293969(0xbb),()=>{const _0xc74eb1=_0x293969;if(_0x1e0aec[_0xc74eb1(0xc6)]&&_0x1e0aec['text']){const _0x1e59cf=getTokenCount(_0x316001),_0x4a8497=getTokenCount(_0x1e0aec[_0xc74eb1(0x8e)]);_0x1e0aec[_0xc74eb1(0xc6)][_0xc74eb1(0x8f)]={'prompt_tokens':_0x1e59cf,'completion_tokens':_0x4a8497,'total_tokens':_0x1e59cf+_0x4a8497,'estimated':!![]};}return _0x2f3475(_0x1e0aec);});}catch(_0x16a0c1){_0x217170(_0x16a0c1);}});}}exports[_0x4a0331(0xa4)]=sendMessageFromOpenAi;function _0x4dfe(_0x5762b7,_0x49bd61){const _0x44c9c5=_0x44c9();return _0x4dfe=function(_0x4dfef5,_0x3ef218){_0x4dfef5=_0x4dfef5-0x80;let _0x5ba49d=_0x44c9c5[_0x4dfef5];return _0x5ba49d;},_0x4dfe(_0x5762b7,_0x49bd61);}function _0x44c9(){const _0x4c789a=['string','@dqbd/tiktoken','role','text','usage','log','gpt-4-vision-preview','max_tokens','\x20[DONE]','POST','Billing\x20hard\x20limit\x20has\x20been\x20reached','178twETPR','forEach','100cDsGcx','125028ALDrZf','content','1112958CgKzqC','b64_json','parse','上传图片过程中出现错误:\x20','图片上传成功，URL:\x20','openai-draw\x20error:\x20','endsWith','/v1/images/generations','includes','sendMessageFromOpenAi','defineProperty','data','split','from','message','finish_reason','1667JwtNlb','toString','filter','Bearer\x20','@nestjs/common','231EjsSqV','203xjqZVd','68520ckhpOb','default','stringify','绘制图片失败，此次绘画被拒绝了！','867980fDixLt','/v1/chat/completions','MidjourneyService','9KObNOs','application/json','end','Logger','slice','uuid','parse\x20Error','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','length','绘制图片失败，请检查你的提示词是否有非法描述！','status','base64','52408QIYsoP','detail','imageUrl','trim','31965LEqDQR','delta','uploadFile','------>\x20开始上传图片！！！','error','get_encoding','getTokenCount','response','choices'];_0x44c9=function(){return _0x4c789a;};return _0x44c9();}function getTokenCount(_0x2e7ba6){const _0x5d8f37=_0x4a0331;if(!_0x2e7ba6)return 0x0;return typeof _0x2e7ba6!==_0x5d8f37(0x8b)&&(_0x2e7ba6=String(_0x2e7ba6)),_0x2e7ba6=_0x2e7ba6['replace'](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x2e7ba6)[_0x5d8f37(0xc1)];}exports[_0x4a0331(0x88)]=getTokenCount;