'use strict';const _0x300bd9=_0x4b9d;(function(_0x5e8327,_0x5bcca5){const _0x1115a3=_0x4b9d,_0x10aa13=_0x5e8327();while(!![]){try{const _0x3613c3=parseInt(_0x1115a3(0xc9))/0x1*(-parseInt(_0x1115a3(0xb8))/0x2)+-parseInt(_0x1115a3(0xc5))/0x3*(parseInt(_0x1115a3(0xc3))/0x4)+parseInt(_0x1115a3(0xa7))/0x5*(parseInt(_0x1115a3(0xd7))/0x6)+parseInt(_0x1115a3(0xa2))/0x7+-parseInt(_0x1115a3(0xba))/0x8+-parseInt(_0x1115a3(0xce))/0x9+parseInt(_0x1115a3(0xa6))/0xa;if(_0x3613c3===_0x5bcca5)break;else _0x10aa13['push'](_0x10aa13['shift']());}catch(_0x33051a){_0x10aa13['push'](_0x10aa13['shift']());}}}(_0xe600,0x249c4));function _0xe600(){const _0x481366=['This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','toString','\x20[DONE]','application/json','filter','1676352XwBGnS','delta','log','绘制图片失败，请稍后试试吧！','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','uuid','message','@dqbd/tiktoken','includes','content','usage','parse\x20Error','from','data','text','max_tokens','上传图片过程中出现错误:\x20','uploadFile','[DONE]\x20','choices','绘制图片失败，请检查你的提示词是否有非法描述！','466249FJAfii','default','stream','length','4422300DmGKLJ','5COVssJ','detail','encode','slice','finish_reason','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','get_encoding','sendMessageFromOpenAi','axios','------>\x20开始上传图片！！！','绘制图片失败，此次绘画被拒绝了！','[DONE]','error','split','defineProperty','response','getTokenCount','466UyddUD','debug','89632PNBKpd','string','/v1/images/generations','parse','__esModule','图片上传成功，URL:\x20','dall','stringify','forEach','16636CQxXna','openai-draw\x20error:\x20','75CAkEci','base64','Billing\x20hard\x20limit\x20has\x20been\x20reached','b64_json','1087OvIaRM','Logger','trim','@nestjs/common','MidjourneyService','2428407XZnpxo','role','replace','POST'];_0xe600=function(){return _0x481366;};return _0xe600();}Object[_0x300bd9(0xb5)](exports,_0x300bd9(0xbe),{'value':!![]}),exports[_0x300bd9(0xb7)]=exports[_0x300bd9(0xae)]=void 0x0;const axios_1=require(_0x300bd9(0xaf)),tiktoken_1=require(_0x300bd9(0x94)),common_1=require(_0x300bd9(0xcc)),uuid=require(_0x300bd9(0x92)),tokenizer=(0x0,tiktoken_1[_0x300bd9(0xad)])('cl100k_base');function getFullUrl(_0x52be54){const _0x363b31=_0x300bd9,_0x4b33e4=_0x52be54['endsWith']('/')?_0x52be54[_0x363b31(0xaa)](0x0,-0x1):_0x52be54,_0x5ede47=_0x4b33e4||'https://api.openai.com';return _0x5ede47+'/v1/chat/completions';}async function sendMessageFromOpenAi(_0x2544df,_0x3b084e,_0x5d20b0){const _0x525b71=_0x300bd9;var _0x294ab6,_0x268ceb,_0x15f709,_0x2dea19;const {onProgress:_0x33b343,maxToken:_0xd5a302,apiKey:_0x1f2377,model:_0x348cfa,temperature:temperature=0.8,proxyUrl:_0x5dab38,prompt:_0x361339}=_0x3b084e;if(_0x348cfa[_0x525b71(0x95)](_0x525b71(0xc0))){let _0x244fae={'text':'','imageUrl':''};try{const _0x17dc90={'method':'POST','url':_0x5dab38+_0x525b71(0xbc),'headers':{'Content-Type':_0x525b71(0xd5),'Authorization':'Bearer\x20'+_0x1f2377},'data':{'prompt':_0x361339,'model':_0x348cfa,'response_format':_0x525b71(0xc8)}},_0x5826b5=await(0x0,axios_1['default'])(_0x17dc90),{b64_json:_0x56c9fa,revised_prompt:_0x54ea1b}=_0x5826b5['data']['data'][0x0],_0x126e04=Buffer['from'](_0x56c9fa,_0x525b71(0xc6));let _0x173432='';try{const _0x43d876=uuid['v4']()[_0x525b71(0xaa)](0x0,0xa)+'.png';common_1[_0x525b71(0xca)][_0x525b71(0xb9)](_0x525b71(0xb0),_0x525b71(0xcd));const _0x5dd35d=Buffer[_0x525b71(0x99)](_0x56c9fa,'base64');_0x173432=await _0x5d20b0[_0x525b71(0x9e)]({'filename':_0x43d876,'buffer':_0x5dd35d}),common_1[_0x525b71(0xca)][_0x525b71(0xb9)](_0x525b71(0xbf)+_0x173432,_0x525b71(0xcd));}catch(_0x5769d2){common_1[_0x525b71(0xca)][_0x525b71(0xb3)](_0x525b71(0x9d)+_0x5769d2,'MidjourneyService');}return _0x244fae['imageUrl']=_0x173432,_0x244fae[_0x525b71(0x9b)]=_0x54ea1b,_0x33b343&&_0x33b343({'text':_0x244fae[_0x525b71(0x9b)]}),_0x244fae;}catch(_0x337953){const _0x7b512b=((_0x294ab6=_0x337953===null||_0x337953===void 0x0?void 0x0:_0x337953[_0x525b71(0xb6)])===null||_0x294ab6===void 0x0?void 0x0:_0x294ab6['status'])||0x1f4;console[_0x525b71(0x8f)](_0x525b71(0xc4),JSON[_0x525b71(0xc1)](_0x337953),_0x7b512b);const _0x368748=(_0x2dea19=(_0x15f709=(_0x268ceb=_0x337953===null||_0x337953===void 0x0?void 0x0:_0x337953[_0x525b71(0xb6)])===null||_0x268ceb===void 0x0?void 0x0:_0x268ceb[_0x525b71(0x9a)])===null||_0x15f709===void 0x0?void 0x0:_0x15f709[_0x525b71(0xb3)])===null||_0x2dea19===void 0x0?void 0x0:_0x2dea19[_0x525b71(0x93)];if(_0x7b512b===0x1ad)return _0x244fae[_0x525b71(0x9b)]='当前请求已过载、请稍等会儿再试试吧！',_0x244fae;if(_0x7b512b===0x190&&_0x368748[_0x525b71(0x95)](_0x525b71(0xd2)))return _0x244fae['text']=_0x525b71(0x91),_0x244fae;if(_0x7b512b===0x190&&_0x368748[_0x525b71(0x95)](_0x525b71(0xc7)))return _0x244fae[_0x525b71(0x9b)]=_0x525b71(0xac),_0x244fae;if(_0x7b512b===0x1f4)return _0x244fae['text']=_0x525b71(0xa1),_0x244fae;if(_0x7b512b===0x191)return _0x244fae[_0x525b71(0x9b)]=_0x525b71(0xb1),_0x244fae;return _0x244fae[_0x525b71(0x9b)]=_0x525b71(0x90),_0x244fae;}}else{let _0x5bb0a1={'text':''};const _0x1b8a09={'method':_0x525b71(0xd1),'url':getFullUrl(_0x5dab38),'responseType':_0x525b71(0xa4),'headers':{'Content-Type':_0x525b71(0xd5),'Accept':_0x525b71(0xd5),'Authorization':'Bearer\x20'+_0x1f2377},'data':{'stream':!![],'temperature':temperature,'model':_0x348cfa,'messages':_0x2544df}};return _0x348cfa==='gpt-4-vision-preview'&&(_0x1b8a09[_0x525b71(0x9a)][_0x525b71(0x9c)]=0x800),new Promise(async(_0x5ddd15,_0x15c08a)=>{const _0x33be55=_0x525b71;try{const _0x557bf5=await(0x0,axios_1[_0x33be55(0xa3)])(_0x1b8a09),_0x53721d=_0x557bf5[_0x33be55(0x9a)];_0x53721d['on']('data',_0x29eac3=>{const _0x2ecd7b=_0x33be55;var _0x311517;const _0x40bb5a=_0x29eac3[_0x2ecd7b(0xd3)]()[_0x2ecd7b(0xb4)]('\x0a\x0a')[_0x2ecd7b(0xd6)](_0x219ba1=>_0x219ba1[_0x2ecd7b(0xcb)]()!=='');for(const _0x52f811 of _0x40bb5a){const _0x295174=_0x52f811[_0x2ecd7b(0xd0)]('data:','');let _0x47b032=![];try{_0x47b032=JSON[_0x2ecd7b(0xbd)](_0x295174)[_0x2ecd7b(0xa0)][0x0][_0x2ecd7b(0xab)]==='stop';}catch(_0x4d16fb){_0x47b032=![];}if(_0x47b032)return _0x5bb0a1[_0x2ecd7b(0x9b)]=_0x5bb0a1[_0x2ecd7b(0x9b)][_0x2ecd7b(0xcb)](),_0x5bb0a1;try{if(_0x295174!==_0x2ecd7b(0xd4)&&_0x295174!==_0x2ecd7b(0xb2)&&_0x295174!=_0x2ecd7b(0x9f)){const _0x378248=JSON['parse'](_0x295174);_0x378248['id']&&(_0x5bb0a1['id']=_0x378248['id']);if((_0x311517=_0x378248['choices'])===null||_0x311517===void 0x0?void 0x0:_0x311517[_0x2ecd7b(0xa5)]){const _0xfd41b6=_0x378248[_0x2ecd7b(0xa0)][0x0][_0x2ecd7b(0x8e)];_0x5bb0a1[_0x2ecd7b(0x8e)]=_0xfd41b6[_0x2ecd7b(0x96)];if(_0xfd41b6===null||_0xfd41b6===void 0x0?void 0x0:_0xfd41b6[_0x2ecd7b(0x96)])_0x5bb0a1[_0x2ecd7b(0x9b)]+=_0xfd41b6[_0x2ecd7b(0x96)];_0xfd41b6['role']&&(_0x5bb0a1[_0x2ecd7b(0xcf)]=_0xfd41b6['role']),_0x5bb0a1[_0x2ecd7b(0xa8)]=_0x378248;}_0x33b343&&_0x33b343({'text':_0x5bb0a1[_0x2ecd7b(0x9b)]});}}catch(_0x111383){console[_0x2ecd7b(0x8f)](_0x2ecd7b(0x98),_0x295174);}}});let _0x206b9c='';_0x2544df[_0x33be55(0xc2)](_0x1423e3=>{const _0x4569a0=_0x33be55;_0x206b9c+=_0x1423e3[_0x4569a0(0x96)]+'\x20';}),_0x53721d['on']('end',()=>{const _0x7dbc20=_0x33be55;if(_0x5bb0a1[_0x7dbc20(0xa8)]&&_0x5bb0a1[_0x7dbc20(0x9b)]){const _0x57ba24=getTokenCount(_0x206b9c),_0x2be57a=getTokenCount(_0x5bb0a1[_0x7dbc20(0x9b)]);_0x5bb0a1[_0x7dbc20(0xa8)][_0x7dbc20(0x97)]={'prompt_tokens':_0x57ba24,'completion_tokens':_0x2be57a,'total_tokens':_0x57ba24+_0x2be57a,'estimated':!![]};}return _0x5ddd15(_0x5bb0a1);});}catch(_0x5c2282){_0x15c08a(_0x5c2282);}});}}function _0x4b9d(_0x1cef6b,_0x1d9b97){const _0xe600d6=_0xe600();return _0x4b9d=function(_0x4b9d05,_0x4757db){_0x4b9d05=_0x4b9d05-0x8e;let _0x230ea5=_0xe600d6[_0x4b9d05];return _0x230ea5;},_0x4b9d(_0x1cef6b,_0x1d9b97);}exports[_0x300bd9(0xae)]=sendMessageFromOpenAi;function getTokenCount(_0x85ad1c){const _0x4b2d38=_0x300bd9;if(!_0x85ad1c)return 0x0;return typeof _0x85ad1c!==_0x4b2d38(0xbb)&&(_0x85ad1c=String(_0x85ad1c)),_0x85ad1c=_0x85ad1c[_0x4b2d38(0xd0)](/<\|endoftext\|>/g,''),tokenizer[_0x4b2d38(0xa9)](_0x85ad1c)['length'];}exports[_0x300bd9(0xb7)]=getTokenCount;