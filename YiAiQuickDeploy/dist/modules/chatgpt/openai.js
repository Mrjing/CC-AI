'use strict';const _0x32f5d3=_0x4195;(function(_0x34204a,_0x9b83d6){const _0x3b12d8=_0x4195,_0x59632a=_0x34204a();while(!![]){try{const _0x8137e=-parseInt(_0x3b12d8(0xa8))/0x1+parseInt(_0x3b12d8(0xb6))/0x2*(-parseInt(_0x3b12d8(0xa0))/0x3)+-parseInt(_0x3b12d8(0x98))/0x4+parseInt(_0x3b12d8(0x95))/0x5+-parseInt(_0x3b12d8(0xb2))/0x6*(-parseInt(_0x3b12d8(0x9c))/0x7)+parseInt(_0x3b12d8(0x82))/0x8*(-parseInt(_0x3b12d8(0xb1))/0x9)+parseInt(_0x3b12d8(0x8f))/0xa*(parseInt(_0x3b12d8(0x96))/0xb);if(_0x8137e===_0x9b83d6)break;else _0x59632a['push'](_0x59632a['shift']());}catch(_0x13840b){_0x59632a['push'](_0x59632a['shift']());}}}(_0x4077,0xacf90));Object['defineProperty'](exports,_0x32f5d3(0x8a),{'value':!![]}),exports[_0x32f5d3(0x84)]=exports[_0x32f5d3(0xb0)]=void 0x0;const axios_1=require('axios'),tiktoken_1=require('@dqbd/tiktoken'),common_1=require(_0x32f5d3(0x97)),uuid=require('uuid'),tokenizer=(0x0,tiktoken_1[_0x32f5d3(0xb7)])('cl100k_base');function _0x4195(_0x588847,_0x24681c){const _0x407753=_0x4077();return _0x4195=function(_0x41958c,_0x207ea3){_0x41958c=_0x41958c-0x7c;let _0x4fda21=_0x407753[_0x41958c];return _0x4fda21;},_0x4195(_0x588847,_0x24681c);}function getFullUrl(_0x1d015b){const _0x4d07fc=_0x32f5d3,_0x2ce2fd=_0x1d015b[_0x4d07fc(0x88)]('/')?_0x1d015b[_0x4d07fc(0xa6)](0x0,-0x1):_0x1d015b,_0x259d3b=_0x2ce2fd||_0x4d07fc(0x8c);return _0x259d3b+'/v1/chat/completions';}async function sendMessageFromOpenAi(_0x5140ce,_0x25f1eb,_0x4dadf5){const _0x9eefc7=_0x32f5d3;var _0x16452c,_0x21f87c,_0x404242,_0x17980d;const {onProgress:_0x541ddf,maxToken:_0x129f68,apiKey:_0x110295,model:_0x24b041,temperature:temperature=0.8,proxyUrl:_0x3080c3,prompt:_0x179838}=_0x25f1eb;if(_0x24b041[_0x9eefc7(0x83)]('dall')){let _0x45b9dc={'text':'','imageUrl':''};try{const _0x87b254={'method':'POST','url':_0x3080c3+_0x9eefc7(0xa1),'headers':{'Content-Type':_0x9eefc7(0x9f),'Authorization':_0x9eefc7(0x91)+_0x110295},'data':{'prompt':_0x179838,'model':_0x24b041,'response_format':'b64_json'}},_0x143930=await(0x0,axios_1[_0x9eefc7(0x7f)])(_0x87b254),{b64_json:_0x416196,revised_prompt:_0x226cec}=_0x143930[_0x9eefc7(0xa7)][_0x9eefc7(0xa7)][0x0],_0x2f1bc0=Buffer['from'](_0x416196,_0x9eefc7(0x8e));let _0x18e133='';try{const _0x5065dc=uuid['v4']()[_0x9eefc7(0xa6)](0x0,0xa)+_0x9eefc7(0xb5);common_1['Logger'][_0x9eefc7(0x9a)]('------>\x20开始上传图片！！！',_0x9eefc7(0xab));const _0x15c0c4=Buffer['from'](_0x416196,_0x9eefc7(0x8e));_0x18e133=await _0x4dadf5['uploadFile']({'filename':_0x5065dc,'buffer':_0x15c0c4}),common_1[_0x9eefc7(0x85)][_0x9eefc7(0x9a)]('图片上传成功，URL:\x20'+_0x18e133,_0x9eefc7(0xab));}catch(_0x5763c3){common_1[_0x9eefc7(0x85)][_0x9eefc7(0x92)](_0x9eefc7(0x80)+_0x5763c3,_0x9eefc7(0xab));}return _0x45b9dc[_0x9eefc7(0x81)]=_0x18e133,_0x45b9dc[_0x9eefc7(0x7c)]=_0x226cec,_0x541ddf&&_0x541ddf({'text':_0x45b9dc[_0x9eefc7(0x7c)]}),_0x45b9dc;}catch(_0x259b83){const _0x4e1cf6=((_0x16452c=_0x259b83===null||_0x259b83===void 0x0?void 0x0:_0x259b83[_0x9eefc7(0xae)])===null||_0x16452c===void 0x0?void 0x0:_0x16452c['status'])||0x1f4;console['log'](_0x9eefc7(0xa4),JSON[_0x9eefc7(0xb4)](_0x259b83),_0x4e1cf6);const _0x4a1dac=(_0x17980d=(_0x404242=(_0x21f87c=_0x259b83===null||_0x259b83===void 0x0?void 0x0:_0x259b83[_0x9eefc7(0xae)])===null||_0x21f87c===void 0x0?void 0x0:_0x21f87c[_0x9eefc7(0xa7)])===null||_0x404242===void 0x0?void 0x0:_0x404242[_0x9eefc7(0x92)])===null||_0x17980d===void 0x0?void 0x0:_0x17980d[_0x9eefc7(0x8d)];if(_0x4e1cf6===0x1ad)return _0x45b9dc[_0x9eefc7(0x7c)]=_0x9eefc7(0x89),_0x45b9dc;if(_0x4e1cf6===0x190&&_0x4a1dac['includes'](_0x9eefc7(0x8b)))return _0x45b9dc[_0x9eefc7(0x7c)]=_0x9eefc7(0x93),_0x45b9dc;if(_0x4e1cf6===0x190&&_0x4a1dac[_0x9eefc7(0x83)]('Billing\x20hard\x20limit\x20has\x20been\x20reached'))return _0x45b9dc[_0x9eefc7(0x7c)]=_0x9eefc7(0xaa),_0x45b9dc;if(_0x4e1cf6===0x1f4)return _0x45b9dc[_0x9eefc7(0x7c)]='绘制图片失败，请检查你的提示词是否有非法描述！',_0x45b9dc;if(_0x4e1cf6===0x191)return _0x45b9dc[_0x9eefc7(0x7c)]=_0x9eefc7(0x87),_0x45b9dc;return _0x45b9dc[_0x9eefc7(0x7c)]='绘制图片失败，请稍后试试吧！',_0x45b9dc;}}else{let _0x5e2901={'text':''};const _0x4af8a1={'method':'POST','url':getFullUrl(_0x3080c3),'responseType':_0x9eefc7(0x90),'headers':{'Content-Type':_0x9eefc7(0x9f),'Accept':_0x9eefc7(0x9f),'Authorization':_0x9eefc7(0x91)+_0x110295},'data':{'stream':!![],'temperature':temperature,'model':_0x24b041,'messages':_0x5140ce}};return _0x24b041==='gpt-4-vision-preview'&&(_0x4af8a1[_0x9eefc7(0xa7)]['max_tokens']=0x800),new Promise(async(_0x3f6fff,_0x134b8a)=>{const _0x1225af=_0x9eefc7;try{const _0x410723=await(0x0,axios_1[_0x1225af(0x7f)])(_0x4af8a1),_0x10001a=_0x410723[_0x1225af(0xa7)];_0x10001a['on'](_0x1225af(0xa7),_0xd478bc=>{const _0x428d5a=_0x1225af;var _0x1ebd11;const _0x139b1=_0xd478bc[_0x428d5a(0x86)]()[_0x428d5a(0x94)]('\x0a\x0a')[_0x428d5a(0xa5)](_0x5797c6=>_0x5797c6[_0x428d5a(0xaf)]()!=='');for(const _0x46865a of _0x139b1){const _0x2bdd6c=_0x46865a['replace'](_0x428d5a(0xa9),'');let _0x54831d=![];try{_0x54831d=JSON[_0x428d5a(0xa3)](_0x2bdd6c)['choices'][0x0][_0x428d5a(0x99)]===_0x428d5a(0x7e);}catch(_0x17dcbd){_0x54831d=![];}if(_0x54831d)return _0x5e2901[_0x428d5a(0x7c)]=_0x5e2901[_0x428d5a(0x7c)][_0x428d5a(0xaf)](),_0x5e2901;try{if(_0x2bdd6c!=='\x20[DONE]'&&_0x2bdd6c!==_0x428d5a(0x9e)&&_0x2bdd6c!=_0x428d5a(0xb3)){const _0x565bac=JSON[_0x428d5a(0xa3)](_0x2bdd6c);_0x565bac['id']&&(_0x5e2901['id']=_0x565bac['id']);if((_0x1ebd11=_0x565bac[_0x428d5a(0x9b)])===null||_0x1ebd11===void 0x0?void 0x0:_0x1ebd11['length']){const _0x629a6a=_0x565bac[_0x428d5a(0x9b)][0x0]['delta'];_0x5e2901[_0x428d5a(0x7d)]=_0x629a6a[_0x428d5a(0xa2)];if(_0x629a6a===null||_0x629a6a===void 0x0?void 0x0:_0x629a6a[_0x428d5a(0xa2)])_0x5e2901[_0x428d5a(0x7c)]+=_0x629a6a['content'];_0x629a6a[_0x428d5a(0xac)]&&(_0x5e2901[_0x428d5a(0xac)]=_0x629a6a[_0x428d5a(0xac)]),_0x5e2901[_0x428d5a(0x9d)]=_0x565bac;}_0x541ddf&&_0x541ddf({'text':_0x5e2901[_0x428d5a(0x7c)]});}}catch(_0x425b18){console['log']('parse\x20Error',_0x2bdd6c);}}});let _0x533875='';_0x5140ce['forEach'](_0x22bd2d=>{const _0x44d488=_0x1225af;_0x533875+=_0x22bd2d[_0x44d488(0xa2)]+'\x20';}),_0x10001a['on'](_0x1225af(0xad),()=>{const _0x2d0c89=_0x1225af;if(_0x5e2901[_0x2d0c89(0x9d)]&&_0x5e2901[_0x2d0c89(0x7c)]){const _0x3f34ee=getTokenCount(_0x533875),_0x37a5da=getTokenCount(_0x5e2901['text']);_0x5e2901[_0x2d0c89(0x9d)]['usage']={'prompt_tokens':_0x3f34ee,'completion_tokens':_0x37a5da,'total_tokens':_0x3f34ee+_0x37a5da,'estimated':!![]};}return _0x3f6fff(_0x5e2901);});}catch(_0x22bae6){_0x134b8a(_0x22bae6);}});}}exports[_0x32f5d3(0xb0)]=sendMessageFromOpenAi;function getTokenCount(_0x513047){if(!_0x513047)return 0x0;return typeof _0x513047!=='string'&&(_0x513047=String(_0x513047)),_0x513047=_0x513047['replace'](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x513047)['length'];}function _0x4077(){const _0x1be198=['6AcNlfI','/v1/images/generations','content','parse','openai-draw\x20error:\x20','filter','slice','data','1090091fofoqp','data:','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','MidjourneyService','role','end','response','trim','sendMessageFromOpenAi','9DjOVBP','4648638meRneq','[DONE]\x20','stringify','.png','1360516JrKqQk','get_encoding','text','delta','stop','default','上传图片过程中出现错误:\x20','imageUrl','3978152dBsdtR','includes','getTokenCount','Logger','toString','绘制图片失败，此次绘画被拒绝了！','endsWith','当前请求已过载、请稍等会儿再试试吧！','__esModule','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','https://api.openai.com','message','base64','25705340sCfrOg','stream','Bearer\x20','error','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','split','3266220adQEpJ','11pGkhfR','@nestjs/common','1368716vRPlTh','finish_reason','debug','choices','7bJLdqx','detail','[DONE]','application/json'];_0x4077=function(){return _0x1be198;};return _0x4077();}exports[_0x32f5d3(0x84)]=getTokenCount;