'use strict';const _0xc08cd7=_0x390b;function _0x390b(_0x207c53,_0x1b08a5){const _0x1819ad=_0x1819();return _0x390b=function(_0x390b66,_0x2c6369){_0x390b66=_0x390b66-0x11f;let _0x149d88=_0x1819ad[_0x390b66];return _0x149d88;},_0x390b(_0x207c53,_0x1b08a5);}(function(_0x1d7800,_0x59b05d){const _0x54752e=_0x390b,_0x108e52=_0x1d7800();while(!![]){try{const _0x4e2dd2=parseInt(_0x54752e(0x135))/0x1+parseInt(_0x54752e(0x163))/0x2*(-parseInt(_0x54752e(0x16a))/0x3)+parseInt(_0x54752e(0x152))/0x4*(parseInt(_0x54752e(0x147))/0x5)+parseInt(_0x54752e(0x14c))/0x6*(-parseInt(_0x54752e(0x161))/0x7)+-parseInt(_0x54752e(0x13b))/0x8+-parseInt(_0x54752e(0x132))/0x9*(parseInt(_0x54752e(0x156))/0xa)+parseInt(_0x54752e(0x13f))/0xb*(parseInt(_0x54752e(0x12d))/0xc);if(_0x4e2dd2===_0x59b05d)break;else _0x108e52['push'](_0x108e52['shift']());}catch(_0x4a6ff4){_0x108e52['push'](_0x108e52['shift']());}}}(_0x1819,0x527ab));Object[_0xc08cd7(0x153)](exports,_0xc08cd7(0x127),{'value':!![]}),exports['getTokenCount']=exports['sendMessageFromOpenAi']=void 0x0;const axios_1=require(_0xc08cd7(0x139)),tiktoken_1=require(_0xc08cd7(0x14d)),common_1=require('@nestjs/common'),uuid=require('uuid'),tokenizer=(0x0,tiktoken_1['get_encoding'])(_0xc08cd7(0x12f));function getFullUrl(_0x781ba3){const _0x536fce=_0xc08cd7,_0x2288bc=_0x781ba3[_0x536fce(0x15d)]('/')?_0x781ba3[_0x536fce(0x157)](0x0,-0x1):_0x781ba3,_0x5a3b18=_0x2288bc||'https://api.openai.com';return _0x5a3b18+_0x536fce(0x121);}async function sendMessageFromOpenAi(_0x3caab3,_0x5703ec,_0x3d3d92){const _0x237409=_0xc08cd7;var _0xdc726a,_0x7d6b85,_0x334529,_0x38116f;const {onProgress:_0x3279ec,maxToken:_0x31d36f,apiKey:_0x33ca2c,model:_0x3d0916,temperature:temperature=0.8,proxyUrl:_0x3c7630,prompt:_0x23ff16}=_0x5703ec;if(_0x3d0916[_0x237409(0x14a)](_0x237409(0x126))){let _0x8d7f65={'text':'','imageUrl':''};try{const _0x47c266={'method':_0x237409(0x12e),'url':_0x3c7630+_0x237409(0x11f),'headers':{'Content-Type':_0x237409(0x148),'Authorization':'Bearer\x20'+_0x33ca2c},'data':{'prompt':_0x23ff16,'model':_0x3d0916,'response_format':_0x237409(0x165)}},_0x2c457d=await(0x0,axios_1[_0x237409(0x145)])(_0x47c266),{b64_json:_0x57c10d,revised_prompt:_0x395faa}=_0x2c457d[_0x237409(0x150)][_0x237409(0x150)][0x0],_0x4d52ff=Buffer[_0x237409(0x159)](_0x57c10d,_0x237409(0x15a));let _0x4629f7='';try{const _0x4732ca=uuid['v4']()[_0x237409(0x157)](0x0,0xa)+_0x237409(0x138);common_1[_0x237409(0x160)]['debug'](_0x237409(0x129),_0x237409(0x169));const _0x3a9aad=Buffer[_0x237409(0x159)](_0x57c10d,'base64');_0x4629f7=await _0x3d3d92[_0x237409(0x140)]({'filename':_0x4732ca,'buffer':_0x3a9aad}),common_1[_0x237409(0x160)]['debug'](_0x237409(0x130)+_0x4629f7,_0x237409(0x169));}catch(_0x2953d2){common_1[_0x237409(0x160)][_0x237409(0x151)](_0x237409(0x133)+_0x2953d2,_0x237409(0x169));}return _0x8d7f65[_0x237409(0x143)]=_0x4629f7,_0x8d7f65['text']=_0x395faa,_0x3279ec&&_0x3279ec({'text':_0x8d7f65[_0x237409(0x158)]}),_0x8d7f65;}catch(_0x42732f){const _0x1a4d1f=((_0xdc726a=_0x42732f===null||_0x42732f===void 0x0?void 0x0:_0x42732f[_0x237409(0x123)])===null||_0xdc726a===void 0x0?void 0x0:_0xdc726a[_0x237409(0x122)])||0x1f4;console[_0x237409(0x167)]('openai-draw\x20error:\x20',JSON['stringify'](_0x42732f),_0x1a4d1f);const _0x188830=(_0x38116f=(_0x334529=(_0x7d6b85=_0x42732f===null||_0x42732f===void 0x0?void 0x0:_0x42732f['response'])===null||_0x7d6b85===void 0x0?void 0x0:_0x7d6b85[_0x237409(0x150)])===null||_0x334529===void 0x0?void 0x0:_0x334529[_0x237409(0x151)])===null||_0x38116f===void 0x0?void 0x0:_0x38116f[_0x237409(0x13a)];if(_0x1a4d1f===0x1ad)return _0x8d7f65[_0x237409(0x158)]=_0x237409(0x14b),_0x8d7f65;if(_0x1a4d1f===0x190&&_0x188830[_0x237409(0x14a)](_0x237409(0x155)))return _0x8d7f65['text']=_0x237409(0x164),_0x8d7f65;if(_0x1a4d1f===0x190&&_0x188830[_0x237409(0x14a)](_0x237409(0x14f)))return _0x8d7f65[_0x237409(0x158)]='当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',_0x8d7f65;if(_0x1a4d1f===0x1f4)return _0x8d7f65[_0x237409(0x158)]=_0x237409(0x144),_0x8d7f65;if(_0x1a4d1f===0x191)return _0x8d7f65[_0x237409(0x158)]='绘制图片失败，此次绘画被拒绝了！',_0x8d7f65;return _0x8d7f65['text']='绘制图片失败，请稍后试试吧！',_0x8d7f65;}}else{let _0xa2d83f={'text':''};const _0x4a9469={'method':_0x237409(0x12e),'url':getFullUrl(_0x3c7630),'responseType':_0x237409(0x14e),'headers':{'Content-Type':_0x237409(0x148),'Accept':'application/json','Authorization':_0x237409(0x166)+_0x33ca2c},'data':{'stream':!![],'temperature':temperature,'model':_0x3d0916,'messages':_0x3caab3}};return _0x3d0916===_0x237409(0x15e)&&(_0x4a9469[_0x237409(0x150)][_0x237409(0x13d)]=0x800),new Promise(async(_0xbec678,_0x1e23e3)=>{const _0x329c2c=_0x237409;try{const _0x3d315e=await(0x0,axios_1[_0x329c2c(0x145)])(_0x4a9469),_0x5c0f3a=_0x3d315e['data'];_0x5c0f3a['on'](_0x329c2c(0x150),_0x3cca83=>{const _0x11c4c5=_0x329c2c;var _0x3774a4;const _0x23add2=_0x3cca83['toString']()[_0x11c4c5(0x134)]('\x0a\x0a')[_0x11c4c5(0x141)](_0x2abe83=>_0x2abe83['trim']()!=='');for(const _0x394f85 of _0x23add2){const _0x2e0c89=_0x394f85[_0x11c4c5(0x131)](_0x11c4c5(0x12a),'');let _0x666c34=![];try{_0x666c34=JSON[_0x11c4c5(0x125)](_0x2e0c89)[_0x11c4c5(0x15f)][0x0][_0x11c4c5(0x15c)]===_0x11c4c5(0x162);}catch(_0x5d5a5b){_0x666c34=![];}if(_0x666c34)return _0xa2d83f[_0x11c4c5(0x158)]=_0xa2d83f[_0x11c4c5(0x158)][_0x11c4c5(0x13c)](),_0xa2d83f;try{if(_0x2e0c89!=='\x20[DONE]'&&_0x2e0c89!==_0x11c4c5(0x120)&&_0x2e0c89!=_0x11c4c5(0x15b)){const _0x454fdc=JSON['parse'](_0x2e0c89);_0x454fdc['id']&&(_0xa2d83f['id']=_0x454fdc['id']);if((_0x3774a4=_0x454fdc[_0x11c4c5(0x15f)])===null||_0x3774a4===void 0x0?void 0x0:_0x3774a4[_0x11c4c5(0x137)]){const _0x5a1bde=_0x454fdc['choices'][0x0][_0x11c4c5(0x13e)];_0xa2d83f[_0x11c4c5(0x13e)]=_0x5a1bde[_0x11c4c5(0x124)];if(_0x5a1bde===null||_0x5a1bde===void 0x0?void 0x0:_0x5a1bde['content'])_0xa2d83f[_0x11c4c5(0x158)]+=_0x5a1bde[_0x11c4c5(0x124)];_0x5a1bde[_0x11c4c5(0x142)]&&(_0xa2d83f[_0x11c4c5(0x142)]=_0x5a1bde[_0x11c4c5(0x142)]),_0xa2d83f[_0x11c4c5(0x149)]=_0x454fdc;}_0x3279ec&&_0x3279ec({'text':_0xa2d83f[_0x11c4c5(0x158)]});}}catch(_0x2b3056){console[_0x11c4c5(0x167)](_0x11c4c5(0x12b),_0x2e0c89);}}});let _0x1a403f='';_0x3caab3[_0x329c2c(0x12c)](_0x3e1fb0=>{const _0x4c790d=_0x329c2c;_0x1a403f+=_0x3e1fb0[_0x4c790d(0x124)]+'\x20';}),_0x5c0f3a['on'](_0x329c2c(0x146),()=>{const _0x93b884=_0x329c2c;if(_0xa2d83f[_0x93b884(0x149)]&&_0xa2d83f[_0x93b884(0x158)]){const _0x285973=getTokenCount(_0x1a403f),_0x53aef8=getTokenCount(_0xa2d83f[_0x93b884(0x158)]);_0xa2d83f['detail'][_0x93b884(0x168)]={'prompt_tokens':_0x285973,'completion_tokens':_0x53aef8,'total_tokens':_0x285973+_0x53aef8,'estimated':!![]};}return _0xbec678(_0xa2d83f);});}catch(_0x3500a4){_0x1e23e3(_0x3500a4);}});}}exports['sendMessageFromOpenAi']=sendMessageFromOpenAi;function getTokenCount(_0x308ed0){const _0x3d09db=_0xc08cd7;if(!_0x308ed0)return 0x0;return typeof _0x308ed0!==_0x3d09db(0x136)&&(_0x308ed0=String(_0x308ed0)),_0x308ed0=_0x308ed0[_0x3d09db(0x131)](/<\|endoftext\|>/g,''),tokenizer[_0x3d09db(0x128)](_0x308ed0)[_0x3d09db(0x137)];}exports[_0xc08cd7(0x154)]=getTokenCount;function _0x1819(){const _0x1a92a1=['trim','max_tokens','delta','77XVisBW','uploadFile','filter','role','imageUrl','绘制图片失败，请检查你的提示词是否有非法描述！','default','end','5KAhUjI','application/json','detail','includes','当前请求已过载、请稍等会儿再试试吧！','6ZhcsPH','@dqbd/tiktoken','stream','Billing\x20hard\x20limit\x20has\x20been\x20reached','data','error','941740MnYzXV','defineProperty','getTokenCount','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','1446400XwEoVJ','slice','text','from','base64','[DONE]\x20','finish_reason','endsWith','gpt-4-vision-preview','choices','Logger','1281763mBLgda','stop','2PdueGI','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','b64_json','Bearer\x20','log','usage','MidjourneyService','85647wfImbD','/v1/images/generations','[DONE]','/v1/chat/completions','status','response','content','parse','dall','__esModule','encode','------>\x20开始上传图片！！！','data:','parse\x20Error','forEach','1702716oCyQob','POST','cl100k_base','图片上传成功，URL:\x20','replace','27DihVcF','上传图片过程中出现错误:\x20','split','351713UUtUqk','string','length','.png','axios','message','4775888ERrSPe'];_0x1819=function(){return _0x1a92a1;};return _0x1819();}