'use strict';const _0x1cd126=_0x1b18;(function(_0x33a873,_0x536f37){const _0xe9dd4d=_0x1b18,_0x526094=_0x33a873();while(!![]){try{const _0x391dcc=parseInt(_0xe9dd4d(0xbd))/0x1*(parseInt(_0xe9dd4d(0x9e))/0x2)+-parseInt(_0xe9dd4d(0x90))/0x3*(-parseInt(_0xe9dd4d(0xa3))/0x4)+-parseInt(_0xe9dd4d(0xd2))/0x5*(-parseInt(_0xe9dd4d(0xcb))/0x6)+parseInt(_0xe9dd4d(0xb8))/0x7*(parseInt(_0xe9dd4d(0xdb))/0x8)+-parseInt(_0xe9dd4d(0xce))/0x9*(-parseInt(_0xe9dd4d(0xad))/0xa)+parseInt(_0xe9dd4d(0xdd))/0xb+parseInt(_0xe9dd4d(0xda))/0xc*(-parseInt(_0xe9dd4d(0xaa))/0xd);if(_0x391dcc===_0x536f37)break;else _0x526094['push'](_0x526094['shift']());}catch(_0x1f9e2b){_0x526094['push'](_0x526094['shift']());}}}(_0x51e1,0x22639));Object[_0x1cd126(0xcc)](exports,_0x1cd126(0xba),{'value':!![]}),exports[_0x1cd126(0xbc)]=exports['sendMessageFromOpenAi']=void 0x0;const axios_1=require(_0x1cd126(0xd6)),tiktoken_1=require(_0x1cd126(0xac)),common_1=require(_0x1cd126(0x96)),uuid=require('uuid'),tokenizer=(0x0,tiktoken_1['get_encoding'])(_0x1cd126(0xab));function _0x51e1(){const _0x11c2b7=['184vzMtCZ','gpt-4-vision-preview','20999kYVFJB','usage','4047PGVUMO','choices','filter','uploadFile','/v1/chat/completions','application/json','@nestjs/common','detail','stop','data:','response','绘制图片失败，请稍后试试吧！','length','text','79278ThUizf','includes','default','delta','error','4rcFxrk','POST','finish_reason','------>\x20开始上传图片！！！','/v1/images/generations','绘制图片失败，请检查你的提示词是否有非法描述！','content','767CGtugf','cl100k_base','@dqbd/tiktoken','710xBVlYr','endsWith','绘制图片失败，此次绘画被拒绝了！','replace','debug','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','https://api.openai.com','Billing\x20hard\x20limit\x20has\x20been\x20reached','图片上传成功，URL:\x20','data','Logger','48643rESzFv','当前请求已过载、请稍等会儿再试试吧！','__esModule','imageUrl','getTokenCount','3uFQvBG','forEach','role','dall','trim','max_tokens','\x20[DONE]','.png','stream','sendMessageFromOpenAi','split','[DONE]','from','base64','102gFHDPL','defineProperty','encode','33066LTYRsw','MidjourneyService','openai-draw\x20error:\x20','message','16580OKvABc','string','parse\x20Error','toString','axios','slice','Bearer\x20','[DONE]\x20','93228RAZxbe'];_0x51e1=function(){return _0x11c2b7;};return _0x51e1();}function getFullUrl(_0x424f03){const _0x51794d=_0x1cd126,_0x59a2ac=_0x424f03[_0x51794d(0xae)]('/')?_0x424f03[_0x51794d(0xd7)](0x0,-0x1):_0x424f03,_0xd98005=_0x59a2ac||_0x51794d(0xb3);return _0xd98005+_0x51794d(0x94);}async function sendMessageFromOpenAi(_0x4134b1,_0x27c6f8,_0x6896d1){const _0x3375c3=_0x1cd126;var _0x3019d8,_0x507acb,_0x472b13,_0x427d3f;const {onProgress:_0xed2a2f,maxToken:_0x537d99,apiKey:_0x245910,model:_0x533fda,temperature:temperature=0.8,proxyUrl:_0x5bbd30,prompt:_0x4d90b0}=_0x27c6f8;if(_0x533fda[_0x3375c3(0x9f)](_0x3375c3(0xc0))){let _0x42745a={'text':'','imageUrl':''};try{const _0x25ec73={'method':_0x3375c3(0xa4),'url':_0x5bbd30+_0x3375c3(0xa7),'headers':{'Content-Type':_0x3375c3(0x95),'Authorization':_0x3375c3(0xd8)+_0x245910},'data':{'prompt':_0x4d90b0,'model':_0x533fda,'response_format':'b64_json'}},_0x5adaf9=await(0x0,axios_1[_0x3375c3(0xa0)])(_0x25ec73),{b64_json:_0x4658e5,revised_prompt:_0x47484a}=_0x5adaf9[_0x3375c3(0xb6)]['data'][0x0],_0x4124cf=Buffer[_0x3375c3(0xc9)](_0x4658e5,_0x3375c3(0xca));let _0xff4208='';try{const _0x23a37b=uuid['v4']()['slice'](0x0,0xa)+_0x3375c3(0xc4);common_1[_0x3375c3(0xb7)][_0x3375c3(0xb1)](_0x3375c3(0xa6),_0x3375c3(0xcf));const _0x44a407=Buffer[_0x3375c3(0xc9)](_0x4658e5,_0x3375c3(0xca));_0xff4208=await _0x6896d1[_0x3375c3(0x93)]({'filename':_0x23a37b,'buffer':_0x44a407}),common_1[_0x3375c3(0xb7)][_0x3375c3(0xb1)](_0x3375c3(0xb5)+_0xff4208,_0x3375c3(0xcf));}catch(_0x36b25a){common_1['Logger'][_0x3375c3(0xa2)]('上传图片过程中出现错误:\x20'+_0x36b25a,_0x3375c3(0xcf));}return _0x42745a[_0x3375c3(0xbb)]=_0xff4208,_0x42745a[_0x3375c3(0x9d)]=_0x47484a,_0xed2a2f&&_0xed2a2f({'text':_0x42745a[_0x3375c3(0x9d)]}),_0x42745a;}catch(_0x3a5981){const _0x422cea=((_0x3019d8=_0x3a5981===null||_0x3a5981===void 0x0?void 0x0:_0x3a5981[_0x3375c3(0x9a)])===null||_0x3019d8===void 0x0?void 0x0:_0x3019d8['status'])||0x1f4;console['log'](_0x3375c3(0xd0),JSON['stringify'](_0x3a5981),_0x422cea);const _0x48f863=(_0x427d3f=(_0x472b13=(_0x507acb=_0x3a5981===null||_0x3a5981===void 0x0?void 0x0:_0x3a5981[_0x3375c3(0x9a)])===null||_0x507acb===void 0x0?void 0x0:_0x507acb[_0x3375c3(0xb6)])===null||_0x472b13===void 0x0?void 0x0:_0x472b13[_0x3375c3(0xa2)])===null||_0x427d3f===void 0x0?void 0x0:_0x427d3f[_0x3375c3(0xd1)];if(_0x422cea===0x1ad)return _0x42745a[_0x3375c3(0x9d)]=_0x3375c3(0xb9),_0x42745a;if(_0x422cea===0x190&&_0x48f863[_0x3375c3(0x9f)]('This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters'))return _0x42745a[_0x3375c3(0x9d)]=_0x3375c3(0xb2),_0x42745a;if(_0x422cea===0x190&&_0x48f863['includes'](_0x3375c3(0xb4)))return _0x42745a[_0x3375c3(0x9d)]='当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',_0x42745a;if(_0x422cea===0x1f4)return _0x42745a[_0x3375c3(0x9d)]=_0x3375c3(0xa8),_0x42745a;if(_0x422cea===0x191)return _0x42745a[_0x3375c3(0x9d)]=_0x3375c3(0xaf),_0x42745a;return _0x42745a[_0x3375c3(0x9d)]=_0x3375c3(0x9b),_0x42745a;}}else{let _0x45bc24={'text':''};const _0x516be0={'method':'POST','url':getFullUrl(_0x5bbd30),'responseType':_0x3375c3(0xc5),'headers':{'Content-Type':_0x3375c3(0x95),'Accept':_0x3375c3(0x95),'Authorization':_0x3375c3(0xd8)+_0x245910},'data':{'stream':!![],'temperature':temperature,'model':_0x533fda,'messages':_0x4134b1}};return _0x533fda===_0x3375c3(0xdc)&&(_0x516be0['data'][_0x3375c3(0xc2)]=0x800),new Promise(async(_0x265db1,_0x132c40)=>{const _0x1069dd=_0x3375c3;try{const _0x41483f=await(0x0,axios_1['default'])(_0x516be0),_0x36693b=_0x41483f[_0x1069dd(0xb6)];_0x36693b['on'](_0x1069dd(0xb6),_0x1fb50a=>{const _0x5de728=_0x1069dd;var _0x9b005e;const _0x3bf826=_0x1fb50a[_0x5de728(0xd5)]()[_0x5de728(0xc7)]('\x0a\x0a')[_0x5de728(0x92)](_0x3af352=>_0x3af352[_0x5de728(0xc1)]()!=='');for(const _0x6b9157 of _0x3bf826){const _0x15d92f=_0x6b9157[_0x5de728(0xb0)](_0x5de728(0x99),'');let _0x223796=![];try{_0x223796=JSON['parse'](_0x15d92f)[_0x5de728(0x91)][0x0][_0x5de728(0xa5)]===_0x5de728(0x98);}catch(_0x47fb8d){_0x223796=![];}if(_0x223796)return _0x45bc24[_0x5de728(0x9d)]=_0x45bc24[_0x5de728(0x9d)][_0x5de728(0xc1)](),_0x45bc24;try{if(_0x15d92f!==_0x5de728(0xc3)&&_0x15d92f!==_0x5de728(0xc8)&&_0x15d92f!=_0x5de728(0xd9)){const _0x277c6d=JSON['parse'](_0x15d92f);_0x277c6d['id']&&(_0x45bc24['id']=_0x277c6d['id']);if((_0x9b005e=_0x277c6d['choices'])===null||_0x9b005e===void 0x0?void 0x0:_0x9b005e[_0x5de728(0x9c)]){const _0x18c5d2=_0x277c6d[_0x5de728(0x91)][0x0][_0x5de728(0xa1)];_0x45bc24[_0x5de728(0xa1)]=_0x18c5d2[_0x5de728(0xa9)];if(_0x18c5d2===null||_0x18c5d2===void 0x0?void 0x0:_0x18c5d2[_0x5de728(0xa9)])_0x45bc24[_0x5de728(0x9d)]+=_0x18c5d2[_0x5de728(0xa9)];_0x18c5d2['role']&&(_0x45bc24[_0x5de728(0xbf)]=_0x18c5d2[_0x5de728(0xbf)]),_0x45bc24[_0x5de728(0x97)]=_0x277c6d;}_0xed2a2f&&_0xed2a2f({'text':_0x45bc24[_0x5de728(0x9d)]});}}catch(_0x1b98dd){console['log'](_0x5de728(0xd4),_0x15d92f);}}});let _0x4e7245='';_0x4134b1[_0x1069dd(0xbe)](_0x59c2f3=>{const _0x3b86a5=_0x1069dd;_0x4e7245+=_0x59c2f3[_0x3b86a5(0xa9)]+'\x20';}),_0x36693b['on']('end',()=>{const _0x1f1c50=_0x1069dd;if(_0x45bc24['detail']&&_0x45bc24['text']){const _0x1206eb=getTokenCount(_0x4e7245),_0x1a4411=getTokenCount(_0x45bc24[_0x1f1c50(0x9d)]);_0x45bc24['detail'][_0x1f1c50(0xde)]={'prompt_tokens':_0x1206eb,'completion_tokens':_0x1a4411,'total_tokens':_0x1206eb+_0x1a4411,'estimated':!![]};}return _0x265db1(_0x45bc24);});}catch(_0x12a0b8){_0x132c40(_0x12a0b8);}});}}exports[_0x1cd126(0xc6)]=sendMessageFromOpenAi;function _0x1b18(_0x35e4e0,_0x4a72ef){const _0x51e129=_0x51e1();return _0x1b18=function(_0x1b187e,_0x67388f){_0x1b187e=_0x1b187e-0x90;let _0x4ce028=_0x51e129[_0x1b187e];return _0x4ce028;},_0x1b18(_0x35e4e0,_0x4a72ef);}function getTokenCount(_0x13a8ab){const _0x53e48a=_0x1cd126;if(!_0x13a8ab)return 0x0;return typeof _0x13a8ab!==_0x53e48a(0xd3)&&(_0x13a8ab=String(_0x13a8ab)),_0x13a8ab=_0x13a8ab[_0x53e48a(0xb0)](/<\|endoftext\|>/g,''),tokenizer[_0x53e48a(0xcd)](_0x13a8ab)[_0x53e48a(0x9c)];}exports[_0x1cd126(0xbc)]=getTokenCount;