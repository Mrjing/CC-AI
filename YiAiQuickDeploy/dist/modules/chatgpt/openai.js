'use strict';const _0x7e0172=_0x51cc;(function(_0xa9e981,_0x39b4b4){const _0x40e2e6=_0x51cc,_0xd940a0=_0xa9e981();while(!![]){try{const _0x8c0f48=parseInt(_0x40e2e6(0x211))/0x1*(parseInt(_0x40e2e6(0x226))/0x2)+-parseInt(_0x40e2e6(0x21a))/0x3+-parseInt(_0x40e2e6(0x22b))/0x4+parseInt(_0x40e2e6(0x1f2))/0x5+parseInt(_0x40e2e6(0x1f8))/0x6+parseInt(_0x40e2e6(0x217))/0x7*(parseInt(_0x40e2e6(0x212))/0x8)+-parseInt(_0x40e2e6(0x20e))/0x9;if(_0x8c0f48===_0x39b4b4)break;else _0xd940a0['push'](_0xd940a0['shift']());}catch(_0x39ea6f){_0xd940a0['push'](_0xd940a0['shift']());}}}(_0x9d56,0xefc37));Object['defineProperty'](exports,_0x7e0172(0x206),{'value':!![]}),exports[_0x7e0172(0x215)]=exports[_0x7e0172(0x22f)]=void 0x0;const axios_1=require(_0x7e0172(0x203)),tiktoken_1=require(_0x7e0172(0x228)),common_1=require('@nestjs/common'),uuid=require(_0x7e0172(0x22a)),tokenizer=(0x0,tiktoken_1[_0x7e0172(0x221)])(_0x7e0172(0x1f6));function getFullUrl(_0x4b6c7e){const _0x11512a=_0x7e0172,_0x500171=_0x4b6c7e[_0x11512a(0x1f9)]('/')?_0x4b6c7e[_0x11512a(0x23a)](0x0,-0x1):_0x4b6c7e,_0x3cba7d=_0x500171||_0x11512a(0x223);return _0x3cba7d+'/v1/chat/completions';}function _0x51cc(_0x4d6367,_0x1c0610){const _0x9d56fa=_0x9d56();return _0x51cc=function(_0x51ccf0,_0x13c540){_0x51ccf0=_0x51ccf0-0x1f2;let _0x417827=_0x9d56fa[_0x51ccf0];return _0x417827;},_0x51cc(_0x4d6367,_0x1c0610);}function _0x9d56(){const _0x83bb4b=['detail','forEach','1358550iieKwe','role','Logger','5791FXhNrJ','1497112PKBstj','log','encode','getTokenCount','debug','14ptxOpx','response','------>\x20开始上传图片！！！','2044911wUNhiT','gpt-4-vision-preview','uploadFile','filter','stream','\x20[DONE]','绘制图片失败，请稍后试试吧！','get_encoding','imageUrl','https://api.openai.com','.png','Bearer\x20','296qormfp','base64','@dqbd/tiktoken','message','uuid','6877124pIiBKT','max_tokens','includes','choices','sendMessageFromOpenAi','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','parse','text','stop','MidjourneyService','error','[DONE]\x20','Billing\x20hard\x20limit\x20has\x20been\x20reached','end','data:','slice','6393165tcCHZQ','dall','/v1/images/generations','stringify','cl100k_base','openai-draw\x20error:\x20','6143760BiPNCJ','endsWith','from','上传图片过程中出现错误:\x20','图片上传成功，URL:\x20','string','application/json','toString','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','POST','绘制图片失败，请检查你的提示词是否有非法描述！','axios','content','default','__esModule','length','replace','status','data','trim'];_0x9d56=function(){return _0x83bb4b;};return _0x9d56();}async function sendMessageFromOpenAi(_0x5d253f,_0x10cd72,_0x3b87f8){const _0x4e9b7a=_0x7e0172;var _0x15d75a,_0x39467d,_0x1a7f39,_0x52ac84;const {onProgress:_0x20de6f,maxToken:_0x547c33,apiKey:_0x17f1f6,model:_0x1538c6,temperature:temperature=0.8,proxyUrl:_0x45bcc5,prompt:_0x40aaab}=_0x10cd72;if(_0x1538c6[_0x4e9b7a(0x22d)](_0x4e9b7a(0x1f3))){let _0x6a948c={'text':'','imageUrl':''};try{const _0x2d7687={'method':'POST','url':_0x45bcc5+_0x4e9b7a(0x1f4),'headers':{'Content-Type':'application/json','Authorization':_0x4e9b7a(0x225)+_0x17f1f6},'data':{'prompt':_0x40aaab,'model':_0x1538c6,'response_format':'b64_json'}},_0x238ef6=await(0x0,axios_1[_0x4e9b7a(0x205)])(_0x2d7687),{b64_json:_0x571bba,revised_prompt:_0x2d60fe}=_0x238ef6[_0x4e9b7a(0x20a)][_0x4e9b7a(0x20a)][0x0],_0x5461e9=Buffer[_0x4e9b7a(0x1fa)](_0x571bba,_0x4e9b7a(0x227));let _0x387d0f='';try{const _0x47f935=uuid['v4']()[_0x4e9b7a(0x23a)](0x0,0xa)+_0x4e9b7a(0x224);common_1[_0x4e9b7a(0x210)]['debug'](_0x4e9b7a(0x219),'MidjourneyService');const _0x3991d8=Buffer[_0x4e9b7a(0x1fa)](_0x571bba,_0x4e9b7a(0x227));_0x387d0f=await _0x3b87f8[_0x4e9b7a(0x21c)]({'filename':_0x47f935,'buffer':_0x3991d8}),common_1[_0x4e9b7a(0x210)][_0x4e9b7a(0x216)](_0x4e9b7a(0x1fc)+_0x387d0f,_0x4e9b7a(0x234));}catch(_0x3b2275){common_1[_0x4e9b7a(0x210)]['error'](_0x4e9b7a(0x1fb)+_0x3b2275,'MidjourneyService');}return _0x6a948c[_0x4e9b7a(0x222)]=_0x387d0f,_0x6a948c['text']=_0x2d60fe,_0x20de6f&&_0x20de6f({'text':_0x6a948c[_0x4e9b7a(0x232)]}),_0x6a948c;}catch(_0x11b3df){const _0x237e70=((_0x15d75a=_0x11b3df===null||_0x11b3df===void 0x0?void 0x0:_0x11b3df[_0x4e9b7a(0x218)])===null||_0x15d75a===void 0x0?void 0x0:_0x15d75a[_0x4e9b7a(0x209)])||0x1f4;console[_0x4e9b7a(0x213)](_0x4e9b7a(0x1f7),JSON[_0x4e9b7a(0x1f5)](_0x11b3df),_0x237e70);const _0x40eb18=(_0x52ac84=(_0x1a7f39=(_0x39467d=_0x11b3df===null||_0x11b3df===void 0x0?void 0x0:_0x11b3df[_0x4e9b7a(0x218)])===null||_0x39467d===void 0x0?void 0x0:_0x39467d[_0x4e9b7a(0x20a)])===null||_0x1a7f39===void 0x0?void 0x0:_0x1a7f39[_0x4e9b7a(0x235)])===null||_0x52ac84===void 0x0?void 0x0:_0x52ac84[_0x4e9b7a(0x229)];if(_0x237e70===0x1ad)return _0x6a948c[_0x4e9b7a(0x232)]='当前请求已过载、请稍等会儿再试试吧！',_0x6a948c;if(_0x237e70===0x190&&_0x40eb18[_0x4e9b7a(0x22d)](_0x4e9b7a(0x230)))return _0x6a948c[_0x4e9b7a(0x232)]='您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',_0x6a948c;if(_0x237e70===0x190&&_0x40eb18[_0x4e9b7a(0x22d)](_0x4e9b7a(0x237)))return _0x6a948c['text']=_0x4e9b7a(0x200),_0x6a948c;if(_0x237e70===0x1f4)return _0x6a948c[_0x4e9b7a(0x232)]=_0x4e9b7a(0x202),_0x6a948c;if(_0x237e70===0x191)return _0x6a948c[_0x4e9b7a(0x232)]='绘制图片失败，此次绘画被拒绝了！',_0x6a948c;return _0x6a948c[_0x4e9b7a(0x232)]=_0x4e9b7a(0x220),_0x6a948c;}}else{let _0x9f8e29={'text':''};const _0x151e40={'method':_0x4e9b7a(0x201),'url':getFullUrl(_0x45bcc5),'responseType':_0x4e9b7a(0x21e),'headers':{'Content-Type':_0x4e9b7a(0x1fe),'Accept':_0x4e9b7a(0x1fe),'Authorization':_0x4e9b7a(0x225)+_0x17f1f6},'data':{'stream':!![],'temperature':temperature,'model':_0x1538c6,'messages':_0x5d253f}};return _0x1538c6===_0x4e9b7a(0x21b)&&(_0x151e40[_0x4e9b7a(0x20a)][_0x4e9b7a(0x22c)]=0x800),new Promise(async(_0x204a2e,_0x3cac59)=>{const _0x319d98=_0x4e9b7a;try{const _0x547051=await(0x0,axios_1[_0x319d98(0x205)])(_0x151e40),_0x1e5082=_0x547051[_0x319d98(0x20a)];_0x1e5082['on'](_0x319d98(0x20a),_0x1fd61a=>{const _0x51fc4e=_0x319d98;var _0x4f9ad3;const _0xc7b330=_0x1fd61a[_0x51fc4e(0x1ff)]()['split']('\x0a\x0a')[_0x51fc4e(0x21d)](_0x1d59fa=>_0x1d59fa[_0x51fc4e(0x20b)]()!=='');for(const _0x377f8e of _0xc7b330){const _0x30cbbc=_0x377f8e[_0x51fc4e(0x208)](_0x51fc4e(0x239),'');let _0x555394=![];try{_0x555394=JSON[_0x51fc4e(0x231)](_0x30cbbc)[_0x51fc4e(0x22e)][0x0]['finish_reason']===_0x51fc4e(0x233);}catch(_0x252231){_0x555394=![];}if(_0x555394)return _0x9f8e29[_0x51fc4e(0x232)]=_0x9f8e29[_0x51fc4e(0x232)]['trim'](),_0x9f8e29;try{if(_0x30cbbc!==_0x51fc4e(0x21f)&&_0x30cbbc!=='[DONE]'&&_0x30cbbc!=_0x51fc4e(0x236)){const _0x13d207=JSON[_0x51fc4e(0x231)](_0x30cbbc);_0x13d207['id']&&(_0x9f8e29['id']=_0x13d207['id']);if((_0x4f9ad3=_0x13d207[_0x51fc4e(0x22e)])===null||_0x4f9ad3===void 0x0?void 0x0:_0x4f9ad3[_0x51fc4e(0x207)]){const _0x385258=_0x13d207[_0x51fc4e(0x22e)][0x0]['delta'];_0x9f8e29['delta']=_0x385258[_0x51fc4e(0x204)];if(_0x385258===null||_0x385258===void 0x0?void 0x0:_0x385258[_0x51fc4e(0x204)])_0x9f8e29[_0x51fc4e(0x232)]+=_0x385258[_0x51fc4e(0x204)];_0x385258[_0x51fc4e(0x20f)]&&(_0x9f8e29[_0x51fc4e(0x20f)]=_0x385258[_0x51fc4e(0x20f)]),_0x9f8e29[_0x51fc4e(0x20c)]=_0x13d207;}_0x20de6f&&_0x20de6f({'text':_0x9f8e29[_0x51fc4e(0x232)]});}}catch(_0x3598c4){console['log']('parse\x20Error',_0x30cbbc);}}});let _0x5100f4='';_0x5d253f[_0x319d98(0x20d)](_0x38803d=>{const _0x2fee31=_0x319d98;_0x5100f4+=_0x38803d[_0x2fee31(0x204)]+'\x20';}),_0x1e5082['on'](_0x319d98(0x238),()=>{const _0x5d525b=_0x319d98;if(_0x9f8e29['detail']&&_0x9f8e29[_0x5d525b(0x232)]){const _0xfc4e0=getTokenCount(_0x5100f4),_0x399cfd=getTokenCount(_0x9f8e29['text']);_0x9f8e29['detail']['usage']={'prompt_tokens':_0xfc4e0,'completion_tokens':_0x399cfd,'total_tokens':_0xfc4e0+_0x399cfd,'estimated':!![]};}return _0x204a2e(_0x9f8e29);});}catch(_0x330dd8){_0x3cac59(_0x330dd8);}});}}exports[_0x7e0172(0x22f)]=sendMessageFromOpenAi;function getTokenCount(_0x2efdd5){const _0x591bc3=_0x7e0172;if(!_0x2efdd5)return 0x0;return typeof _0x2efdd5!==_0x591bc3(0x1fd)&&(_0x2efdd5=String(_0x2efdd5)),_0x2efdd5=_0x2efdd5[_0x591bc3(0x208)](/<\|endoftext\|>/g,''),tokenizer[_0x591bc3(0x214)](_0x2efdd5)[_0x591bc3(0x207)];}exports['getTokenCount']=getTokenCount;