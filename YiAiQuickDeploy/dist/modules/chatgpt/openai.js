'use strict';function _0x5dc7(){const _0xfc93b6=['------>\x20开始上传图片！！！','data','绘制图片失败，请检查你的提示词是否有非法描述！','data:','axios','choices','detail','string','POST','imageUrl','sendMessageFromOpenAi','3017511xdpLGn','application/json','content','dall','base64','stringify','length','message','图片上传成功，URL:\x20','stream','.png','Logger','log','status','__esModule','error','上传图片过程中出现错误:\x20','includes','get_encoding','[DONE]','parse','slice','9771ryJFoq','cl100k_base','10895LRbTkL','3830148PzprBa','role','2738533FamTps','2836rTejnn','stop','绘制图片失败，请稍后试试吧！','/v1/images/generations','defineProperty','response','@dqbd/tiktoken','replace','debug','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','text','MidjourneyService','split','trim','encode','getTokenCount','finish_reason','14947630uUbMku','绘制图片失败，此次绘画被拒绝了！','max_tokens','uuid','delta','default','Bearer\x20','toString','/v1/chat/completions','openai-draw\x20error:\x20','24IurBFM','end','filter','uploadFile','960BNUcYp','1036454zQlzbi','b64_json','forEach'];_0x5dc7=function(){return _0xfc93b6;};return _0x5dc7();}const _0x499068=_0x315f;(function(_0x380eb9,_0xad009){const _0x4fb41c=_0x315f,_0x340443=_0x380eb9();while(!![]){try{const _0x52b8e3=parseInt(_0x4fb41c(0x16b))/0x1+parseInt(_0x4fb41c(0x16a))/0x2*(parseInt(_0x4fb41c(0x145))/0x3)+parseInt(_0x4fb41c(0x14b))/0x4*(-parseInt(_0x4fb41c(0x147))/0x5)+parseInt(_0x4fb41c(0x148))/0x6+-parseInt(_0x4fb41c(0x14a))/0x7+parseInt(_0x4fb41c(0x166))/0x8*(parseInt(_0x4fb41c(0x12f))/0x9)+-parseInt(_0x4fb41c(0x15c))/0xa;if(_0x52b8e3===_0xad009)break;else _0x340443['push'](_0x340443['shift']());}catch(_0x56e5f7){_0x340443['push'](_0x340443['shift']());}}}(_0x5dc7,0xc683c));Object[_0x499068(0x14f)](exports,_0x499068(0x13d),{'value':!![]}),exports['getTokenCount']=exports[_0x499068(0x12e)]=void 0x0;const axios_1=require(_0x499068(0x172)),tiktoken_1=require(_0x499068(0x151)),common_1=require('@nestjs/common'),uuid=require(_0x499068(0x15f)),tokenizer=(0x0,tiktoken_1[_0x499068(0x141)])(_0x499068(0x146));function getFullUrl(_0x4a4f69){const _0x47a01b=_0x499068,_0x4c8d88=_0x4a4f69['endsWith']('/')?_0x4a4f69[_0x47a01b(0x144)](0x0,-0x1):_0x4a4f69,_0x17394b=_0x4c8d88||'https://api.openai.com';return _0x17394b+_0x47a01b(0x164);}function _0x315f(_0x15de0f,_0x4f80bd){const _0x5dc7e3=_0x5dc7();return _0x315f=function(_0x315ff9,_0xd424d1){_0x315ff9=_0x315ff9-0x12c;let _0x3571c1=_0x5dc7e3[_0x315ff9];return _0x3571c1;},_0x315f(_0x15de0f,_0x4f80bd);}async function sendMessageFromOpenAi(_0x44b24e,_0x10f7e7,_0x4af560){const _0xe2bf3b=_0x499068;var _0x428a43,_0x31305f,_0x2d571b,_0x2c984c;const {onProgress:_0x51625e,maxToken:_0x3e2175,apiKey:_0x96d581,model:_0x28f98d,temperature:temperature=0.8,proxyUrl:_0x1727ac,prompt:_0x3f9b6b}=_0x10f7e7;if(_0x28f98d[_0xe2bf3b(0x140)](_0xe2bf3b(0x132))){let _0x1293a8={'text':'','imageUrl':''};try{const _0x305501={'method':_0xe2bf3b(0x12c),'url':_0x1727ac+_0xe2bf3b(0x14e),'headers':{'Content-Type':_0xe2bf3b(0x130),'Authorization':_0xe2bf3b(0x162)+_0x96d581},'data':{'prompt':_0x3f9b6b,'model':_0x28f98d,'response_format':_0xe2bf3b(0x16c)}},_0x52b1ed=await(0x0,axios_1['default'])(_0x305501),{b64_json:_0x329dbc,revised_prompt:_0x17640d}=_0x52b1ed[_0xe2bf3b(0x16f)][_0xe2bf3b(0x16f)][0x0],_0x19ce63=Buffer['from'](_0x329dbc,_0xe2bf3b(0x133));let _0x25f866='';try{const _0x55b76a=uuid['v4']()[_0xe2bf3b(0x144)](0x0,0xa)+_0xe2bf3b(0x139);common_1['Logger'][_0xe2bf3b(0x153)](_0xe2bf3b(0x16e),_0xe2bf3b(0x156));const _0x48e765=Buffer['from'](_0x329dbc,_0xe2bf3b(0x133));_0x25f866=await _0x4af560[_0xe2bf3b(0x169)]({'filename':_0x55b76a,'buffer':_0x48e765}),common_1[_0xe2bf3b(0x13a)][_0xe2bf3b(0x153)](_0xe2bf3b(0x137)+_0x25f866,'MidjourneyService');}catch(_0x215121){common_1[_0xe2bf3b(0x13a)][_0xe2bf3b(0x13e)](_0xe2bf3b(0x13f)+_0x215121,_0xe2bf3b(0x156));}return _0x1293a8[_0xe2bf3b(0x12d)]=_0x25f866,_0x1293a8[_0xe2bf3b(0x155)]=_0x17640d,_0x51625e&&_0x51625e({'text':_0x1293a8['text']}),_0x1293a8;}catch(_0x491608){const _0x5985b3=((_0x428a43=_0x491608===null||_0x491608===void 0x0?void 0x0:_0x491608[_0xe2bf3b(0x150)])===null||_0x428a43===void 0x0?void 0x0:_0x428a43[_0xe2bf3b(0x13c)])||0x1f4;console[_0xe2bf3b(0x13b)](_0xe2bf3b(0x165),JSON[_0xe2bf3b(0x134)](_0x491608),_0x5985b3);const _0x1b5d22=(_0x2c984c=(_0x2d571b=(_0x31305f=_0x491608===null||_0x491608===void 0x0?void 0x0:_0x491608['response'])===null||_0x31305f===void 0x0?void 0x0:_0x31305f['data'])===null||_0x2d571b===void 0x0?void 0x0:_0x2d571b[_0xe2bf3b(0x13e)])===null||_0x2c984c===void 0x0?void 0x0:_0x2c984c[_0xe2bf3b(0x136)];if(_0x5985b3===0x1ad)return _0x1293a8[_0xe2bf3b(0x155)]='当前请求已过载、请稍等会儿再试试吧！',_0x1293a8;if(_0x5985b3===0x190&&_0x1b5d22['includes']('This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters'))return _0x1293a8[_0xe2bf3b(0x155)]=_0xe2bf3b(0x154),_0x1293a8;if(_0x5985b3===0x190&&_0x1b5d22[_0xe2bf3b(0x140)]('Billing\x20hard\x20limit\x20has\x20been\x20reached'))return _0x1293a8[_0xe2bf3b(0x155)]='当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',_0x1293a8;if(_0x5985b3===0x1f4)return _0x1293a8[_0xe2bf3b(0x155)]=_0xe2bf3b(0x170),_0x1293a8;if(_0x5985b3===0x191)return _0x1293a8[_0xe2bf3b(0x155)]=_0xe2bf3b(0x15d),_0x1293a8;return _0x1293a8[_0xe2bf3b(0x155)]=_0xe2bf3b(0x14d),_0x1293a8;}}else{let _0x3d7242={'text':''};const _0x3093e9={'method':'POST','url':getFullUrl(_0x1727ac),'responseType':_0xe2bf3b(0x138),'headers':{'Content-Type':'application/json','Accept':_0xe2bf3b(0x130),'Authorization':_0xe2bf3b(0x162)+_0x96d581},'data':{'stream':!![],'temperature':temperature,'model':_0x28f98d,'messages':_0x44b24e}};return _0x28f98d==='gpt-4-vision-preview'&&(_0x3093e9[_0xe2bf3b(0x16f)][_0xe2bf3b(0x15e)]=0x800),new Promise(async(_0x46bd1a,_0x55abae)=>{const _0x5ba774=_0xe2bf3b;try{const _0x2a4b7a=await(0x0,axios_1[_0x5ba774(0x161)])(_0x3093e9),_0x48eacd=_0x2a4b7a[_0x5ba774(0x16f)];_0x48eacd['on'](_0x5ba774(0x16f),_0x3ee2b2=>{const _0x40aa95=_0x5ba774;var _0xb25f67;const _0x5be207=_0x3ee2b2[_0x40aa95(0x163)]()[_0x40aa95(0x157)]('\x0a\x0a')[_0x40aa95(0x168)](_0x2caa64=>_0x2caa64['trim']()!=='');for(const _0x544681 of _0x5be207){const _0x206f1f=_0x544681[_0x40aa95(0x152)](_0x40aa95(0x171),'');let _0x5af0b8=![];try{_0x5af0b8=JSON[_0x40aa95(0x143)](_0x206f1f)[_0x40aa95(0x173)][0x0][_0x40aa95(0x15b)]===_0x40aa95(0x14c);}catch(_0x14ac3d){_0x5af0b8=![];}if(_0x5af0b8)return _0x3d7242['text']=_0x3d7242[_0x40aa95(0x155)][_0x40aa95(0x158)](),_0x3d7242;try{if(_0x206f1f!=='\x20[DONE]'&&_0x206f1f!==_0x40aa95(0x142)&&_0x206f1f!='[DONE]\x20'){const _0x488ea5=JSON[_0x40aa95(0x143)](_0x206f1f);_0x488ea5['id']&&(_0x3d7242['id']=_0x488ea5['id']);if((_0xb25f67=_0x488ea5[_0x40aa95(0x173)])===null||_0xb25f67===void 0x0?void 0x0:_0xb25f67[_0x40aa95(0x135)]){const _0x3b6c0c=_0x488ea5[_0x40aa95(0x173)][0x0][_0x40aa95(0x160)];_0x3d7242[_0x40aa95(0x160)]=_0x3b6c0c['content'];if(_0x3b6c0c===null||_0x3b6c0c===void 0x0?void 0x0:_0x3b6c0c[_0x40aa95(0x131)])_0x3d7242[_0x40aa95(0x155)]+=_0x3b6c0c[_0x40aa95(0x131)];_0x3b6c0c[_0x40aa95(0x149)]&&(_0x3d7242[_0x40aa95(0x149)]=_0x3b6c0c[_0x40aa95(0x149)]),_0x3d7242[_0x40aa95(0x174)]=_0x488ea5;}_0x51625e&&_0x51625e({'text':_0x3d7242['text']});}}catch(_0xf6abe5){console[_0x40aa95(0x13b)]('parse\x20Error',_0x206f1f);}}});let _0x153116='';_0x44b24e[_0x5ba774(0x16d)](_0x57e207=>{const _0x3f8af7=_0x5ba774;_0x153116+=_0x57e207[_0x3f8af7(0x131)]+'\x20';}),_0x48eacd['on'](_0x5ba774(0x167),()=>{const _0x45b343=_0x5ba774;if(_0x3d7242[_0x45b343(0x174)]&&_0x3d7242['text']){const _0x1803e4=getTokenCount(_0x153116),_0x563e84=getTokenCount(_0x3d7242['text']);_0x3d7242[_0x45b343(0x174)]['usage']={'prompt_tokens':_0x1803e4,'completion_tokens':_0x563e84,'total_tokens':_0x1803e4+_0x563e84,'estimated':!![]};}return _0x46bd1a(_0x3d7242);});}catch(_0x12cd61){_0x55abae(_0x12cd61);}});}}exports[_0x499068(0x12e)]=sendMessageFromOpenAi;function getTokenCount(_0x5624c8){const _0x29e74d=_0x499068;if(!_0x5624c8)return 0x0;return typeof _0x5624c8!==_0x29e74d(0x175)&&(_0x5624c8=String(_0x5624c8)),_0x5624c8=_0x5624c8[_0x29e74d(0x152)](/<\|endoftext\|>/g,''),tokenizer[_0x29e74d(0x159)](_0x5624c8)['length'];}exports[_0x499068(0x15a)]=getTokenCount;