'use strict';const _0x47e1bc=_0x3306;function _0x435f(){const _0x58d493=['图片上传成功，URL:\x20','openai-draw\x20error:\x20','end','usage','绘制图片失败，此次绘画被拒绝了！','7055CVggsA','forEach','__esModule','uploadFile','1687911tuWlZa','choices','delta','text','1713635QcgiKl','includes','cl100k_base','146024dayNTJ','max_tokens','Bearer\x20','base64','slice','split','default','.png','[DONE]\x20','POST','trim','Billing\x20hard\x20limit\x20has\x20been\x20reached','@nestjs/common','parse','content','application/json','358110aotjKu','------>\x20开始上传图片！！！','getTokenCount','\x20[DONE]','/v1/images/generations','MidjourneyService','40VkqczS','Logger','error','replace','toString','axios','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','https://api.openai.com','上传图片过程中出现错误:\x20','get_encoding','log','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','message','data:','length','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','stringify','/v1/chat/completions','4yxNFhD','2371565NOyJno','detail','2fnYwtn','sendMessageFromOpenAi','from','732SLvzCt','encode','当前请求已过载、请稍等会儿再试试吧！','filter','绘制图片失败，请检查你的提示词是否有非法描述！','finish_reason','gpt-4-vision-preview','response','role','30ffsckh','defineProperty','debug','10440444KUabAM','imageUrl','data','[DONE]','endsWith','b64_json','status','绘制图片失败，请稍后试试吧！'];_0x435f=function(){return _0x58d493;};return _0x435f();}(function(_0x2fa2eb,_0x562a23){const _0x764753=_0x3306,_0x435c20=_0x2fa2eb();while(!![]){try{const _0x1627a8=parseInt(_0x764753(0x151))/0x1*(-parseInt(_0x764753(0x178))/0x2)+-parseInt(_0x764753(0x171))/0x3*(-parseInt(_0x764753(0x14e))/0x4)+parseInt(_0x764753(0x16d))/0x5*(parseInt(_0x764753(0x154))/0x6)+parseInt(_0x764753(0x14f))/0x7+parseInt(_0x764753(0x13c))/0x8*(-parseInt(_0x764753(0x188))/0x9)+-parseInt(_0x764753(0x15d))/0xa*(-parseInt(_0x764753(0x175))/0xb)+-parseInt(_0x764753(0x160))/0xc;if(_0x1627a8===_0x562a23)break;else _0x435c20['push'](_0x435c20['shift']());}catch(_0x3b5ed3){_0x435c20['push'](_0x435c20['shift']());}}}(_0x435f,0x4f91e));Object[_0x47e1bc(0x15e)](exports,_0x47e1bc(0x16f),{'value':!![]}),exports['getTokenCount']=exports[_0x47e1bc(0x152)]=void 0x0;const axios_1=require(_0x47e1bc(0x141)),tiktoken_1=require('@dqbd/tiktoken'),common_1=require(_0x47e1bc(0x184)),uuid=require('uuid'),tokenizer=(0x0,tiktoken_1[_0x47e1bc(0x145)])(_0x47e1bc(0x177));function getFullUrl(_0x41df44){const _0x2edc78=_0x47e1bc,_0x4f60aa=_0x41df44[_0x2edc78(0x164)]('/')?_0x41df44[_0x2edc78(0x17c)](0x0,-0x1):_0x41df44,_0xc11210=_0x4f60aa||_0x2edc78(0x143);return _0xc11210+_0x2edc78(0x14d);}async function sendMessageFromOpenAi(_0x46eabd,_0x58f911,_0xf6c23){const _0x2da8f8=_0x47e1bc;var _0x9b8be5,_0x54bd3f,_0x10ee9c,_0x3cf4d5;const {onProgress:_0x19a0bf,maxToken:_0x5864af,apiKey:_0x1bb802,model:_0x15ea8d,temperature:temperature=0.8,proxyUrl:_0x33cf57,prompt:_0x53c3b9}=_0x58f911;if(_0x15ea8d[_0x2da8f8(0x176)]('dall')){let _0x1bd65e={'text':'','imageUrl':''};try{const _0x598dde={'method':'POST','url':_0x33cf57+_0x2da8f8(0x18c),'headers':{'Content-Type':_0x2da8f8(0x187),'Authorization':_0x2da8f8(0x17a)+_0x1bb802},'data':{'prompt':_0x53c3b9,'model':_0x15ea8d,'response_format':_0x2da8f8(0x165)}},_0x3f9067=await(0x0,axios_1[_0x2da8f8(0x17e)])(_0x598dde),{b64_json:_0x439434,revised_prompt:_0x5c2518}=_0x3f9067[_0x2da8f8(0x162)]['data'][0x0],_0x1061c7=Buffer[_0x2da8f8(0x153)](_0x439434,_0x2da8f8(0x17b));let _0x5c37a6='';try{const _0x29a95a=uuid['v4']()[_0x2da8f8(0x17c)](0x0,0xa)+_0x2da8f8(0x17f);common_1[_0x2da8f8(0x13d)][_0x2da8f8(0x15f)](_0x2da8f8(0x189),'MidjourneyService');const _0x4a1718=Buffer['from'](_0x439434,_0x2da8f8(0x17b));_0x5c37a6=await _0xf6c23[_0x2da8f8(0x170)]({'filename':_0x29a95a,'buffer':_0x4a1718}),common_1[_0x2da8f8(0x13d)][_0x2da8f8(0x15f)](_0x2da8f8(0x168)+_0x5c37a6,'MidjourneyService');}catch(_0x3f7b57){common_1[_0x2da8f8(0x13d)][_0x2da8f8(0x13e)](_0x2da8f8(0x144)+_0x3f7b57,_0x2da8f8(0x18d));}return _0x1bd65e[_0x2da8f8(0x161)]=_0x5c37a6,_0x1bd65e[_0x2da8f8(0x174)]=_0x5c2518,_0x19a0bf&&_0x19a0bf({'text':_0x1bd65e[_0x2da8f8(0x174)]}),_0x1bd65e;}catch(_0x3d2445){const _0x17b4ad=((_0x9b8be5=_0x3d2445===null||_0x3d2445===void 0x0?void 0x0:_0x3d2445[_0x2da8f8(0x15b)])===null||_0x9b8be5===void 0x0?void 0x0:_0x9b8be5[_0x2da8f8(0x166)])||0x1f4;console[_0x2da8f8(0x146)](_0x2da8f8(0x169),JSON[_0x2da8f8(0x14c)](_0x3d2445),_0x17b4ad);const _0x1479b5=(_0x3cf4d5=(_0x10ee9c=(_0x54bd3f=_0x3d2445===null||_0x3d2445===void 0x0?void 0x0:_0x3d2445['response'])===null||_0x54bd3f===void 0x0?void 0x0:_0x54bd3f[_0x2da8f8(0x162)])===null||_0x10ee9c===void 0x0?void 0x0:_0x10ee9c['error'])===null||_0x3cf4d5===void 0x0?void 0x0:_0x3cf4d5[_0x2da8f8(0x148)];if(_0x17b4ad===0x1ad)return _0x1bd65e['text']=_0x2da8f8(0x156),_0x1bd65e;if(_0x17b4ad===0x190&&_0x1479b5[_0x2da8f8(0x176)](_0x2da8f8(0x14b)))return _0x1bd65e[_0x2da8f8(0x174)]=_0x2da8f8(0x142),_0x1bd65e;if(_0x17b4ad===0x190&&_0x1479b5['includes'](_0x2da8f8(0x183)))return _0x1bd65e['text']=_0x2da8f8(0x147),_0x1bd65e;if(_0x17b4ad===0x1f4)return _0x1bd65e[_0x2da8f8(0x174)]=_0x2da8f8(0x158),_0x1bd65e;if(_0x17b4ad===0x191)return _0x1bd65e['text']=_0x2da8f8(0x16c),_0x1bd65e;return _0x1bd65e[_0x2da8f8(0x174)]=_0x2da8f8(0x167),_0x1bd65e;}}else{let _0x3ca199={'text':''};const _0x120f5f={'method':_0x2da8f8(0x181),'url':getFullUrl(_0x33cf57),'responseType':'stream','headers':{'Content-Type':_0x2da8f8(0x187),'Accept':'application/json','Authorization':'Bearer\x20'+_0x1bb802},'data':{'stream':!![],'temperature':temperature,'model':_0x15ea8d,'messages':_0x46eabd}};return _0x15ea8d===_0x2da8f8(0x15a)&&(_0x120f5f[_0x2da8f8(0x162)][_0x2da8f8(0x179)]=0x800),new Promise(async(_0x56c0d1,_0x1a8ab1)=>{const _0x110c78=_0x2da8f8;try{const _0x429fe4=await(0x0,axios_1[_0x110c78(0x17e)])(_0x120f5f),_0x49eaf5=_0x429fe4[_0x110c78(0x162)];_0x49eaf5['on'](_0x110c78(0x162),_0x5c2b84=>{const _0x48ba0f=_0x110c78;var _0x1d877e;const _0x444ec8=_0x5c2b84[_0x48ba0f(0x140)]()[_0x48ba0f(0x17d)]('\x0a\x0a')[_0x48ba0f(0x157)](_0x1179a0=>_0x1179a0[_0x48ba0f(0x182)]()!=='');for(const _0x284a56 of _0x444ec8){const _0x3e64f2=_0x284a56[_0x48ba0f(0x13f)](_0x48ba0f(0x149),'');let _0x33707c=![];try{_0x33707c=JSON[_0x48ba0f(0x185)](_0x3e64f2)[_0x48ba0f(0x172)][0x0][_0x48ba0f(0x159)]==='stop';}catch(_0x12f8ba){_0x33707c=![];}if(_0x33707c)return _0x3ca199[_0x48ba0f(0x174)]=_0x3ca199['text']['trim'](),_0x3ca199;try{if(_0x3e64f2!==_0x48ba0f(0x18b)&&_0x3e64f2!==_0x48ba0f(0x163)&&_0x3e64f2!=_0x48ba0f(0x180)){const _0xe4aa81=JSON[_0x48ba0f(0x185)](_0x3e64f2);_0xe4aa81['id']&&(_0x3ca199['id']=_0xe4aa81['id']);if((_0x1d877e=_0xe4aa81['choices'])===null||_0x1d877e===void 0x0?void 0x0:_0x1d877e[_0x48ba0f(0x14a)]){const _0x2acf89=_0xe4aa81[_0x48ba0f(0x172)][0x0][_0x48ba0f(0x173)];_0x3ca199[_0x48ba0f(0x173)]=_0x2acf89[_0x48ba0f(0x186)];if(_0x2acf89===null||_0x2acf89===void 0x0?void 0x0:_0x2acf89[_0x48ba0f(0x186)])_0x3ca199[_0x48ba0f(0x174)]+=_0x2acf89[_0x48ba0f(0x186)];_0x2acf89[_0x48ba0f(0x15c)]&&(_0x3ca199[_0x48ba0f(0x15c)]=_0x2acf89[_0x48ba0f(0x15c)]),_0x3ca199[_0x48ba0f(0x150)]=_0xe4aa81;}_0x19a0bf&&_0x19a0bf({'text':_0x3ca199[_0x48ba0f(0x174)]});}}catch(_0x34d493){console[_0x48ba0f(0x146)]('parse\x20Error',_0x3e64f2);}}});let _0x16fdab='';_0x46eabd[_0x110c78(0x16e)](_0x4b9d5f=>{const _0x316e07=_0x110c78;_0x16fdab+=_0x4b9d5f[_0x316e07(0x186)]+'\x20';}),_0x49eaf5['on'](_0x110c78(0x16a),()=>{const _0x36dc78=_0x110c78;if(_0x3ca199['detail']&&_0x3ca199[_0x36dc78(0x174)]){const _0x4c409b=getTokenCount(_0x16fdab),_0x412b34=getTokenCount(_0x3ca199[_0x36dc78(0x174)]);_0x3ca199[_0x36dc78(0x150)][_0x36dc78(0x16b)]={'prompt_tokens':_0x4c409b,'completion_tokens':_0x412b34,'total_tokens':_0x4c409b+_0x412b34,'estimated':!![]};}return _0x56c0d1(_0x3ca199);});}catch(_0x3e3681){_0x1a8ab1(_0x3e3681);}});}}exports[_0x47e1bc(0x152)]=sendMessageFromOpenAi;function _0x3306(_0x4c0fed,_0x59d2c3){const _0x435ffc=_0x435f();return _0x3306=function(_0x3306a2,_0x39920a){_0x3306a2=_0x3306a2-0x13c;let _0xe5e52=_0x435ffc[_0x3306a2];return _0xe5e52;},_0x3306(_0x4c0fed,_0x59d2c3);}function getTokenCount(_0x55e451){const _0x1c58b5=_0x47e1bc;if(!_0x55e451)return 0x0;return typeof _0x55e451!=='string'&&(_0x55e451=String(_0x55e451)),_0x55e451=_0x55e451['replace'](/<\|endoftext\|>/g,''),tokenizer[_0x1c58b5(0x155)](_0x55e451)['length'];}exports[_0x47e1bc(0x18a)]=getTokenCount;