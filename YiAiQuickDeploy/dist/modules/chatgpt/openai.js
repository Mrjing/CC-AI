'use strict';const _0x169bfb=_0x45e4;function _0x3b1f(){const _0x3f7473=['application/json','defineProperty','data:','log','------>\x20开始上传图片！！！','/v1/chat/completions','forEach','string','from','parse\x20Error','data','gpt-4-vision-preview','finish_reason','uploadFile','delta','openai-draw\x20error:\x20','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','3591keTJog','usage','text','stringify','getTokenCount','Logger','stream','1948592YhwktL','@nestjs/common','max_tokens','MidjourneyService','content','\x20[DONE]','24328jlgZbY','[DONE]','slice','b64_json','replace','POST','uuid','6922286DJfxuU','trim','detail','Billing\x20hard\x20limit\x20has\x20been\x20reached','dall','10KWDwQS','debug','toString','encode','role','/v1/images/generations','get_encoding','includes','cl100k_base','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','Bearer\x20','上传图片过程中出现错误:\x20','error','绘制图片失败，请检查你的提示词是否有非法描述！','message','2285046DOTWHI','575757TvZDzI','split','绘制图片失败，请稍后试试吧！','1041840djrAXn','imageUrl','axios','1430616mUvMFM','base64','parse','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','choices'];_0x3b1f=function(){return _0x3f7473;};return _0x3b1f();}(function(_0x3f21af,_0x57b25e){const _0x15d9f5=_0x45e4,_0x20b90c=_0x3f21af();while(!![]){try{const _0x5e690a=parseInt(_0x15d9f5(0x1ff))/0x1+-parseInt(_0x15d9f5(0x1fe))/0x2+parseInt(_0x15d9f5(0x205))/0x3+-parseInt(_0x15d9f5(0x1dd))/0x4*(-parseInt(_0x15d9f5(0x1ef))/0x5)+parseInt(_0x15d9f5(0x202))/0x6+parseInt(_0x15d9f5(0x1ea))/0x7+parseInt(_0x15d9f5(0x1e3))/0x8*(-parseInt(_0x15d9f5(0x21b))/0x9);if(_0x5e690a===_0x57b25e)break;else _0x20b90c['push'](_0x20b90c['shift']());}catch(_0x1f0701){_0x20b90c['push'](_0x20b90c['shift']());}}}(_0x3b1f,0xcb82d));Object[_0x169bfb(0x20b)](exports,'__esModule',{'value':!![]}),exports[_0x169bfb(0x1da)]=exports['sendMessageFromOpenAi']=void 0x0;const axios_1=require(_0x169bfb(0x204)),tiktoken_1=require('@dqbd/tiktoken'),common_1=require(_0x169bfb(0x1de)),uuid=require(_0x169bfb(0x1e9)),tokenizer=(0x0,tiktoken_1[_0x169bfb(0x1f5)])(_0x169bfb(0x1f7));function getFullUrl(_0xf2dde0){const _0x333d9a=_0x169bfb,_0x5c323b=_0xf2dde0['endsWith']('/')?_0xf2dde0[_0x333d9a(0x1e5)](0x0,-0x1):_0xf2dde0,_0x31e511=_0x5c323b||'https://api.openai.com';return _0x31e511+_0x333d9a(0x20f);}async function sendMessageFromOpenAi(_0x53c697,_0x112221,_0x29eef4){const _0x152333=_0x169bfb;var _0x24df51,_0x2a5dac,_0x8faadb,_0x26b516;const {onProgress:_0x2daabb,maxToken:_0x1aefe5,apiKey:_0xa43055,model:_0x2f6b8a,temperature:temperature=0.8,proxyUrl:_0x1b1e87,prompt:_0x1930d7}=_0x112221;if(_0x2f6b8a[_0x152333(0x1f6)](_0x152333(0x1ee))){let _0x5c77b8={'text':'','imageUrl':''};try{const _0x24022c={'method':'POST','url':_0x1b1e87+_0x152333(0x1f4),'headers':{'Content-Type':_0x152333(0x20a),'Authorization':_0x152333(0x1f9)+_0xa43055},'data':{'prompt':_0x1930d7,'model':_0x2f6b8a,'response_format':_0x152333(0x1e6)}},_0x3db79c=await(0x0,axios_1['default'])(_0x24022c),{b64_json:_0x2d7de5,revised_prompt:_0x487f3d}=_0x3db79c[_0x152333(0x214)][_0x152333(0x214)][0x0],_0x34e7b2=Buffer['from'](_0x2d7de5,_0x152333(0x206));let _0x5bf3e9='';try{const _0x21d86e=uuid['v4']()['slice'](0x0,0xa)+'.png';common_1[_0x152333(0x1db)][_0x152333(0x1f0)](_0x152333(0x20e),_0x152333(0x1e0));const _0x59e1e4=Buffer[_0x152333(0x212)](_0x2d7de5,_0x152333(0x206));_0x5bf3e9=await _0x29eef4[_0x152333(0x217)]({'filename':_0x21d86e,'buffer':_0x59e1e4}),common_1[_0x152333(0x1db)]['debug']('图片上传成功，URL:\x20'+_0x5bf3e9,'MidjourneyService');}catch(_0x25035d){common_1[_0x152333(0x1db)][_0x152333(0x1fb)](_0x152333(0x1fa)+_0x25035d,_0x152333(0x1e0));}return _0x5c77b8[_0x152333(0x203)]=_0x5bf3e9,_0x5c77b8['text']=_0x487f3d,_0x2daabb&&_0x2daabb({'text':_0x5c77b8[_0x152333(0x21d)]}),_0x5c77b8;}catch(_0x383d37){const _0x2172c9=((_0x24df51=_0x383d37===null||_0x383d37===void 0x0?void 0x0:_0x383d37['response'])===null||_0x24df51===void 0x0?void 0x0:_0x24df51['status'])||0x1f4;console[_0x152333(0x20d)](_0x152333(0x219),JSON[_0x152333(0x21e)](_0x383d37),_0x2172c9);const _0x469957=(_0x26b516=(_0x8faadb=(_0x2a5dac=_0x383d37===null||_0x383d37===void 0x0?void 0x0:_0x383d37['response'])===null||_0x2a5dac===void 0x0?void 0x0:_0x2a5dac[_0x152333(0x214)])===null||_0x8faadb===void 0x0?void 0x0:_0x8faadb[_0x152333(0x1fb)])===null||_0x26b516===void 0x0?void 0x0:_0x26b516[_0x152333(0x1fd)];if(_0x2172c9===0x1ad)return _0x5c77b8[_0x152333(0x21d)]='当前请求已过载、请稍等会儿再试试吧！',_0x5c77b8;if(_0x2172c9===0x190&&_0x469957['includes'](_0x152333(0x1f8)))return _0x5c77b8[_0x152333(0x21d)]=_0x152333(0x208),_0x5c77b8;if(_0x2172c9===0x190&&_0x469957[_0x152333(0x1f6)](_0x152333(0x1ed)))return _0x5c77b8[_0x152333(0x21d)]=_0x152333(0x21a),_0x5c77b8;if(_0x2172c9===0x1f4)return _0x5c77b8[_0x152333(0x21d)]=_0x152333(0x1fc),_0x5c77b8;if(_0x2172c9===0x191)return _0x5c77b8[_0x152333(0x21d)]='绘制图片失败，此次绘画被拒绝了！',_0x5c77b8;return _0x5c77b8['text']=_0x152333(0x201),_0x5c77b8;}}else{let _0x12c724={'text':''};const _0x286309={'method':_0x152333(0x1e8),'url':getFullUrl(_0x1b1e87),'responseType':_0x152333(0x1dc),'headers':{'Content-Type':_0x152333(0x20a),'Accept':'application/json','Authorization':_0x152333(0x1f9)+_0xa43055},'data':{'stream':!![],'temperature':temperature,'model':_0x2f6b8a,'messages':_0x53c697}};return _0x2f6b8a===_0x152333(0x215)&&(_0x286309[_0x152333(0x214)][_0x152333(0x1df)]=0x800),new Promise(async(_0x139b16,_0x108095)=>{const _0x4cc29b=_0x152333;try{const _0x3d03cc=await(0x0,axios_1['default'])(_0x286309),_0x2d4d83=_0x3d03cc[_0x4cc29b(0x214)];_0x2d4d83['on'](_0x4cc29b(0x214),_0x1280e4=>{const _0x34eaaa=_0x4cc29b;var _0x4c6ed1;const _0x236e34=_0x1280e4[_0x34eaaa(0x1f1)]()[_0x34eaaa(0x200)]('\x0a\x0a')['filter'](_0x17250d=>_0x17250d[_0x34eaaa(0x1eb)]()!=='');for(const _0x5a704e of _0x236e34){const _0x59639e=_0x5a704e[_0x34eaaa(0x1e7)](_0x34eaaa(0x20c),'');let _0x26fc5a=![];try{_0x26fc5a=JSON[_0x34eaaa(0x207)](_0x59639e)[_0x34eaaa(0x209)][0x0][_0x34eaaa(0x216)]==='stop';}catch(_0x2d19bb){_0x26fc5a=![];}if(_0x26fc5a)return _0x12c724[_0x34eaaa(0x21d)]=_0x12c724['text'][_0x34eaaa(0x1eb)](),_0x12c724;try{if(_0x59639e!==_0x34eaaa(0x1e2)&&_0x59639e!==_0x34eaaa(0x1e4)&&_0x59639e!='[DONE]\x20'){const _0x218af1=JSON[_0x34eaaa(0x207)](_0x59639e);_0x218af1['id']&&(_0x12c724['id']=_0x218af1['id']);if((_0x4c6ed1=_0x218af1[_0x34eaaa(0x209)])===null||_0x4c6ed1===void 0x0?void 0x0:_0x4c6ed1['length']){const _0x13b425=_0x218af1['choices'][0x0][_0x34eaaa(0x218)];_0x12c724[_0x34eaaa(0x218)]=_0x13b425[_0x34eaaa(0x1e1)];if(_0x13b425===null||_0x13b425===void 0x0?void 0x0:_0x13b425[_0x34eaaa(0x1e1)])_0x12c724['text']+=_0x13b425[_0x34eaaa(0x1e1)];_0x13b425['role']&&(_0x12c724['role']=_0x13b425[_0x34eaaa(0x1f3)]),_0x12c724[_0x34eaaa(0x1ec)]=_0x218af1;}_0x2daabb&&_0x2daabb({'text':_0x12c724[_0x34eaaa(0x21d)]});}}catch(_0x5c46d7){console[_0x34eaaa(0x20d)](_0x34eaaa(0x213),_0x59639e);}}});let _0xf8d1dc='';_0x53c697[_0x4cc29b(0x210)](_0x22ad80=>{const _0x191929=_0x4cc29b;_0xf8d1dc+=_0x22ad80[_0x191929(0x1e1)]+'\x20';}),_0x2d4d83['on']('end',()=>{const _0x175576=_0x4cc29b;if(_0x12c724[_0x175576(0x1ec)]&&_0x12c724['text']){const _0x2af6a0=getTokenCount(_0xf8d1dc),_0x2144fb=getTokenCount(_0x12c724['text']);_0x12c724['detail'][_0x175576(0x21c)]={'prompt_tokens':_0x2af6a0,'completion_tokens':_0x2144fb,'total_tokens':_0x2af6a0+_0x2144fb,'estimated':!![]};}return _0x139b16(_0x12c724);});}catch(_0x3e98a8){_0x108095(_0x3e98a8);}});}}function _0x45e4(_0x5e0186,_0x548fce){const _0x3b1f17=_0x3b1f();return _0x45e4=function(_0x45e443,_0x44be72){_0x45e443=_0x45e443-0x1da;let _0x2576ad=_0x3b1f17[_0x45e443];return _0x2576ad;},_0x45e4(_0x5e0186,_0x548fce);}exports['sendMessageFromOpenAi']=sendMessageFromOpenAi;function getTokenCount(_0x219d20){const _0x51e113=_0x169bfb;if(!_0x219d20)return 0x0;return typeof _0x219d20!==_0x51e113(0x211)&&(_0x219d20=String(_0x219d20)),_0x219d20=_0x219d20[_0x51e113(0x1e7)](/<\|endoftext\|>/g,''),tokenizer[_0x51e113(0x1f2)](_0x219d20)['length'];}exports[_0x169bfb(0x1da)]=getTokenCount;