'use strict';const _0x575719=_0x1441;(function(_0x456350,_0x5263ec){const _0x3da5e0=_0x1441,_0x25f369=_0x456350();while(!![]){try{const _0x1b1f86=parseInt(_0x3da5e0(0xbe))/0x1+-parseInt(_0x3da5e0(0xc7))/0x2*(-parseInt(_0x3da5e0(0xdb))/0x3)+-parseInt(_0x3da5e0(0xeb))/0x4*(parseInt(_0x3da5e0(0xe7))/0x5)+-parseInt(_0x3da5e0(0xdc))/0x6+parseInt(_0x3da5e0(0xcd))/0x7+parseInt(_0x3da5e0(0xc2))/0x8*(parseInt(_0x3da5e0(0xd0))/0x9)+parseInt(_0x3da5e0(0xcf))/0xa*(-parseInt(_0x3da5e0(0xde))/0xb);if(_0x1b1f86===_0x5263ec)break;else _0x25f369['push'](_0x25f369['shift']());}catch(_0x1865aa){_0x25f369['push'](_0x25f369['shift']());}}}(_0x40aa,0x5bdcc));Object[_0x575719(0xaf)](exports,_0x575719(0xef),{'value':!![]}),exports[_0x575719(0xea)]=exports[_0x575719(0xd8)]=void 0x0;function _0x40aa(){const _0x171426=['165249XYnwwM','/v1/chat/completions','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','@dqbd/tiktoken','application/json','log','length','base64','sendMessageFromOpenAi','max_tokens','message','27879xMDBAL','2295672dmyayN','replace','2046DYhTuu','parse\x20Error','绘制图片失败，请检查你的提示词是否有非法描述！','trim','detail','stop','dall','toString','MidjourneyService','10wIfBtv','\x20[DONE]','default','getTokenCount','700988DeVhDw','error','text','Logger','__esModule','status','axios','data','delta','end','slice','defineProperty','includes','[DONE]\x20','https://api.openai.com','b64_json','绘制图片失败，此次绘画被拒绝了！','content','split','stringify','data:','POST','choices','/v1/images/generations','Bearer\x20','图片上传成功，URL:\x20','643973WPIIIO','parse','usage','.png','56NNLLqb','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','forEach','response','from','134OxbCAc','绘制图片失败，请稍后试试吧！','filter','@nestjs/common','finish_reason','get_encoding','1448699bYshrq','debug','26490Qgdspv'];_0x40aa=function(){return _0x171426;};return _0x40aa();}const axios_1=require(_0x575719(0xf1)),tiktoken_1=require(_0x575719(0xd3)),common_1=require(_0x575719(0xca)),uuid=require('uuid'),tokenizer=(0x0,tiktoken_1[_0x575719(0xcc)])('cl100k_base');function getFullUrl(_0xdb302){const _0x5b904c=_0x575719,_0x42f628=_0xdb302['endsWith']('/')?_0xdb302[_0x5b904c(0xf5)](0x0,-0x1):_0xdb302,_0x27054b=_0x42f628||_0x5b904c(0xb2);return _0x27054b+_0x5b904c(0xd1);}async function sendMessageFromOpenAi(_0x315b2c,_0x1e4dbc,_0x3dbcb7){const _0x494fdb=_0x575719;var _0x4f9dee,_0xde9889,_0x575fef,_0x20b233;const {onProgress:_0x55c72f,maxToken:_0x4540c5,apiKey:_0xd19659,model:_0x2ce2c5,temperature:temperature=0.8,proxyUrl:_0x262324,prompt:_0x53d8d1}=_0x1e4dbc;if(_0x2ce2c5[_0x494fdb(0xb0)](_0x494fdb(0xe4))){let _0x131cb5={'text':'','imageUrl':''};try{const _0x1e6ac5={'method':_0x494fdb(0xb9),'url':_0x262324+_0x494fdb(0xbb),'headers':{'Content-Type':_0x494fdb(0xd4),'Authorization':_0x494fdb(0xbc)+_0xd19659},'data':{'prompt':_0x53d8d1,'model':_0x2ce2c5,'response_format':_0x494fdb(0xb3)}},_0x497f13=await(0x0,axios_1[_0x494fdb(0xe9)])(_0x1e6ac5),{b64_json:_0xf26fcc,revised_prompt:_0x149e3d}=_0x497f13[_0x494fdb(0xf2)][_0x494fdb(0xf2)][0x0],_0x52aec4=Buffer[_0x494fdb(0xc6)](_0xf26fcc,_0x494fdb(0xd7));let _0x195425='';try{const _0x432e1a=uuid['v4']()[_0x494fdb(0xf5)](0x0,0xa)+_0x494fdb(0xc1);common_1[_0x494fdb(0xee)]['debug']('------>\x20开始上传图片！！！',_0x494fdb(0xe6));const _0x194321=Buffer['from'](_0xf26fcc,_0x494fdb(0xd7));_0x195425=await _0x3dbcb7['uploadFile']({'filename':_0x432e1a,'buffer':_0x194321}),common_1[_0x494fdb(0xee)][_0x494fdb(0xce)](_0x494fdb(0xbd)+_0x195425,_0x494fdb(0xe6));}catch(_0x3cb18a){common_1[_0x494fdb(0xee)]['error']('上传图片过程中出现错误:\x20'+_0x3cb18a,'MidjourneyService');}return _0x131cb5['imageUrl']=_0x195425,_0x131cb5[_0x494fdb(0xed)]=_0x149e3d,_0x55c72f&&_0x55c72f({'text':_0x131cb5[_0x494fdb(0xed)]}),_0x131cb5;}catch(_0x6af0e8){const _0x3afd47=((_0x4f9dee=_0x6af0e8===null||_0x6af0e8===void 0x0?void 0x0:_0x6af0e8['response'])===null||_0x4f9dee===void 0x0?void 0x0:_0x4f9dee[_0x494fdb(0xf0)])||0x1f4;console[_0x494fdb(0xd5)]('openai-draw\x20error:\x20',JSON[_0x494fdb(0xb7)](_0x6af0e8),_0x3afd47);const _0x3a0e3c=(_0x20b233=(_0x575fef=(_0xde9889=_0x6af0e8===null||_0x6af0e8===void 0x0?void 0x0:_0x6af0e8[_0x494fdb(0xc5)])===null||_0xde9889===void 0x0?void 0x0:_0xde9889[_0x494fdb(0xf2)])===null||_0x575fef===void 0x0?void 0x0:_0x575fef[_0x494fdb(0xec)])===null||_0x20b233===void 0x0?void 0x0:_0x20b233[_0x494fdb(0xda)];if(_0x3afd47===0x1ad)return _0x131cb5[_0x494fdb(0xed)]='当前请求已过载、请稍等会儿再试试吧！',_0x131cb5;if(_0x3afd47===0x190&&_0x3a0e3c[_0x494fdb(0xb0)]('This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters'))return _0x131cb5[_0x494fdb(0xed)]=_0x494fdb(0xd2),_0x131cb5;if(_0x3afd47===0x190&&_0x3a0e3c[_0x494fdb(0xb0)]('Billing\x20hard\x20limit\x20has\x20been\x20reached'))return _0x131cb5[_0x494fdb(0xed)]=_0x494fdb(0xc3),_0x131cb5;if(_0x3afd47===0x1f4)return _0x131cb5[_0x494fdb(0xed)]=_0x494fdb(0xe0),_0x131cb5;if(_0x3afd47===0x191)return _0x131cb5[_0x494fdb(0xed)]=_0x494fdb(0xb4),_0x131cb5;return _0x131cb5[_0x494fdb(0xed)]=_0x494fdb(0xc8),_0x131cb5;}}else{let _0x169119={'text':''};const _0x18d994={'method':'POST','url':getFullUrl(_0x262324),'responseType':'stream','headers':{'Content-Type':'application/json','Accept':'application/json','Authorization':'Bearer\x20'+_0xd19659},'data':{'stream':!![],'temperature':temperature,'model':_0x2ce2c5,'messages':_0x315b2c}};return _0x2ce2c5==='gpt-4-vision-preview'&&(_0x18d994[_0x494fdb(0xf2)][_0x494fdb(0xd9)]=0x800),new Promise(async(_0x51371d,_0x49800c)=>{const _0x4c1cc1=_0x494fdb;try{const _0x2157c4=await(0x0,axios_1[_0x4c1cc1(0xe9)])(_0x18d994),_0x24a2a9=_0x2157c4[_0x4c1cc1(0xf2)];_0x24a2a9['on']('data',_0x178490=>{const _0x495f5a=_0x4c1cc1;var _0x70fc1;const _0x4aa0d5=_0x178490[_0x495f5a(0xe5)]()[_0x495f5a(0xb6)]('\x0a\x0a')[_0x495f5a(0xc9)](_0x3dee26=>_0x3dee26[_0x495f5a(0xe1)]()!=='');for(const _0x35b2d6 of _0x4aa0d5){const _0x3a1021=_0x35b2d6['replace'](_0x495f5a(0xb8),'');let _0x292a9c=![];try{_0x292a9c=JSON[_0x495f5a(0xbf)](_0x3a1021)[_0x495f5a(0xba)][0x0][_0x495f5a(0xcb)]===_0x495f5a(0xe3);}catch(_0x329735){_0x292a9c=![];}if(_0x292a9c)return _0x169119[_0x495f5a(0xed)]=_0x169119[_0x495f5a(0xed)]['trim'](),_0x169119;try{if(_0x3a1021!==_0x495f5a(0xe8)&&_0x3a1021!=='[DONE]'&&_0x3a1021!=_0x495f5a(0xb1)){const _0x515777=JSON[_0x495f5a(0xbf)](_0x3a1021);_0x515777['id']&&(_0x169119['id']=_0x515777['id']);if((_0x70fc1=_0x515777['choices'])===null||_0x70fc1===void 0x0?void 0x0:_0x70fc1[_0x495f5a(0xd6)]){const _0x3f9405=_0x515777[_0x495f5a(0xba)][0x0][_0x495f5a(0xf3)];_0x169119[_0x495f5a(0xf3)]=_0x3f9405[_0x495f5a(0xb5)];if(_0x3f9405===null||_0x3f9405===void 0x0?void 0x0:_0x3f9405[_0x495f5a(0xb5)])_0x169119[_0x495f5a(0xed)]+=_0x3f9405[_0x495f5a(0xb5)];_0x3f9405['role']&&(_0x169119['role']=_0x3f9405['role']),_0x169119[_0x495f5a(0xe2)]=_0x515777;}_0x55c72f&&_0x55c72f({'text':_0x169119[_0x495f5a(0xed)]});}}catch(_0x1934d8){console['log'](_0x495f5a(0xdf),_0x3a1021);}}});let _0x3e1796='';_0x315b2c[_0x4c1cc1(0xc4)](_0x6e12e9=>{const _0x4943b1=_0x4c1cc1;_0x3e1796+=_0x6e12e9[_0x4943b1(0xb5)]+'\x20';}),_0x24a2a9['on'](_0x4c1cc1(0xf4),()=>{const _0x525e33=_0x4c1cc1;if(_0x169119['detail']&&_0x169119['text']){const _0x43199c=getTokenCount(_0x3e1796),_0x4cdce0=getTokenCount(_0x169119['text']);_0x169119['detail'][_0x525e33(0xc0)]={'prompt_tokens':_0x43199c,'completion_tokens':_0x4cdce0,'total_tokens':_0x43199c+_0x4cdce0,'estimated':!![]};}return _0x51371d(_0x169119);});}catch(_0x16104a){_0x49800c(_0x16104a);}});}}exports['sendMessageFromOpenAi']=sendMessageFromOpenAi;function getTokenCount(_0x2aab27){const _0x5baf34=_0x575719;if(!_0x2aab27)return 0x0;return typeof _0x2aab27!=='string'&&(_0x2aab27=String(_0x2aab27)),_0x2aab27=_0x2aab27[_0x5baf34(0xdd)](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x2aab27)[_0x5baf34(0xd6)];}function _0x1441(_0x43a423,_0x24aefa){const _0x40aaf5=_0x40aa();return _0x1441=function(_0x1441a4,_0x6845d7){_0x1441a4=_0x1441a4-0xaf;let _0x2c2430=_0x40aaf5[_0x1441a4];return _0x2c2430;},_0x1441(_0x43a423,_0x24aefa);}exports[_0x575719(0xea)]=getTokenCount;