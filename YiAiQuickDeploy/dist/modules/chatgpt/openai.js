'use strict';const _0x5a1a3d=_0x2825;(function(_0x4813ca,_0x23dd91){const _0x24acfe=_0x2825,_0x31b0ca=_0x4813ca();while(!![]){try{const _0x5df967=-parseInt(_0x24acfe(0x135))/0x1+-parseInt(_0x24acfe(0x142))/0x2*(-parseInt(_0x24acfe(0x166))/0x3)+parseInt(_0x24acfe(0x150))/0x4+-parseInt(_0x24acfe(0x123))/0x5+-parseInt(_0x24acfe(0x14b))/0x6*(parseInt(_0x24acfe(0x129))/0x7)+parseInt(_0x24acfe(0x126))/0x8*(-parseInt(_0x24acfe(0x158))/0x9)+parseInt(_0x24acfe(0x136))/0xa;if(_0x5df967===_0x23dd91)break;else _0x31b0ca['push'](_0x31b0ca['shift']());}catch(_0xab36c9){_0x31b0ca['push'](_0x31b0ca['shift']());}}}(_0x56f7,0x57d7d));Object[_0x5a1a3d(0x162)](exports,_0x5a1a3d(0x140),{'value':!![]}),exports[_0x5a1a3d(0x138)]=exports[_0x5a1a3d(0x141)]=void 0x0;const axios_1=require(_0x5a1a3d(0x137)),tiktoken_1=require(_0x5a1a3d(0x13e)),common_1=require(_0x5a1a3d(0x149)),uuid=require(_0x5a1a3d(0x14a)),tokenizer=(0x0,tiktoken_1[_0x5a1a3d(0x139)])(_0x5a1a3d(0x146));function getFullUrl(_0x578039){const _0x4c0190=_0x5a1a3d,_0x23ad4a=_0x578039[_0x4c0190(0x161)]('/')?_0x578039['slice'](0x0,-0x1):_0x578039,_0x1db402=_0x23ad4a||_0x4c0190(0x165);return _0x1db402+_0x4c0190(0x153);}function _0x2825(_0x293bb4,_0x25e5a0){const _0x56f7f8=_0x56f7();return _0x2825=function(_0x28259f,_0x281435){_0x28259f=_0x28259f-0x122;let _0x403c51=_0x56f7f8[_0x28259f];return _0x403c51;},_0x2825(_0x293bb4,_0x25e5a0);}async function sendMessageFromOpenAi(_0x1596b0,_0x57f3b9,_0x1d0e89){const _0x323b5c=_0x5a1a3d;var _0x357cdc,_0x3c4f4e,_0xe0388e,_0x21f988;const {onProgress:_0x3dcc6d,maxToken:_0x587b58,apiKey:_0x17f6f0,model:_0x49f6d5,temperature:temperature=0.8,proxyUrl:_0x1b767c,prompt:_0x113c26}=_0x57f3b9;if(_0x49f6d5[_0x323b5c(0x125)](_0x323b5c(0x14f))){let _0x32b0b3={'text':'','imageUrl':''};try{const _0xc142ed={'method':_0x323b5c(0x131),'url':_0x1b767c+_0x323b5c(0x16d),'headers':{'Content-Type':_0x323b5c(0x13b),'Authorization':_0x323b5c(0x155)+_0x17f6f0},'data':{'prompt':_0x113c26,'model':_0x49f6d5,'response_format':_0x323b5c(0x12d)}},_0x11b387=await(0x0,axios_1[_0x323b5c(0x15a)])(_0xc142ed),{b64_json:_0x4e15d6,revised_prompt:_0xbc8bb2}=_0x11b387[_0x323b5c(0x157)][_0x323b5c(0x157)][0x0],_0x622108=Buffer[_0x323b5c(0x154)](_0x4e15d6,_0x323b5c(0x130));let _0x5b2a73='';try{const _0x17712f=uuid['v4']()[_0x323b5c(0x12f)](0x0,0xa)+_0x323b5c(0x132);common_1[_0x323b5c(0x168)][_0x323b5c(0x160)](_0x323b5c(0x15c),'MidjourneyService');const _0x48ab60=Buffer[_0x323b5c(0x154)](_0x4e15d6,_0x323b5c(0x130));_0x5b2a73=await _0x1d0e89[_0x323b5c(0x151)]({'filename':_0x17712f,'buffer':_0x48ab60}),common_1[_0x323b5c(0x168)][_0x323b5c(0x160)]('图片上传成功，URL:\x20'+_0x5b2a73,_0x323b5c(0x12c));}catch(_0x3609ec){common_1[_0x323b5c(0x168)]['error'](_0x323b5c(0x124)+_0x3609ec,'MidjourneyService');}return _0x32b0b3[_0x323b5c(0x15d)]=_0x5b2a73,_0x32b0b3[_0x323b5c(0x16f)]=_0xbc8bb2,_0x3dcc6d&&_0x3dcc6d({'text':_0x32b0b3['text']}),_0x32b0b3;}catch(_0x51a7f8){const _0x14bce9=((_0x357cdc=_0x51a7f8===null||_0x51a7f8===void 0x0?void 0x0:_0x51a7f8[_0x323b5c(0x167)])===null||_0x357cdc===void 0x0?void 0x0:_0x357cdc[_0x323b5c(0x12e)])||0x1f4;console[_0x323b5c(0x15b)](_0x323b5c(0x134),JSON[_0x323b5c(0x169)](_0x51a7f8),_0x14bce9);const _0x19f44d=(_0x21f988=(_0xe0388e=(_0x3c4f4e=_0x51a7f8===null||_0x51a7f8===void 0x0?void 0x0:_0x51a7f8[_0x323b5c(0x167)])===null||_0x3c4f4e===void 0x0?void 0x0:_0x3c4f4e['data'])===null||_0xe0388e===void 0x0?void 0x0:_0xe0388e[_0x323b5c(0x12b)])===null||_0x21f988===void 0x0?void 0x0:_0x21f988[_0x323b5c(0x145)];if(_0x14bce9===0x1ad)return _0x32b0b3[_0x323b5c(0x16f)]='当前请求已过载、请稍等会儿再试试吧！',_0x32b0b3;if(_0x14bce9===0x190&&_0x19f44d[_0x323b5c(0x125)](_0x323b5c(0x159)))return _0x32b0b3['text']=_0x323b5c(0x12a),_0x32b0b3;if(_0x14bce9===0x190&&_0x19f44d[_0x323b5c(0x125)]('Billing\x20hard\x20limit\x20has\x20been\x20reached'))return _0x32b0b3[_0x323b5c(0x16f)]=_0x323b5c(0x14c),_0x32b0b3;if(_0x14bce9===0x1f4)return _0x32b0b3[_0x323b5c(0x16f)]=_0x323b5c(0x16b),_0x32b0b3;if(_0x14bce9===0x191)return _0x32b0b3['text']='绘制图片失败，此次绘画被拒绝了！',_0x32b0b3;return _0x32b0b3['text']=_0x323b5c(0x16a),_0x32b0b3;}}else{let _0x44e3f0={'text':''};const _0x4eb3d1={'method':_0x323b5c(0x131),'url':getFullUrl(_0x1b767c),'responseType':_0x323b5c(0x170),'headers':{'Content-Type':'application/json','Accept':_0x323b5c(0x13b),'Authorization':_0x323b5c(0x155)+_0x17f6f0},'data':{'stream':!![],'temperature':temperature,'model':_0x49f6d5,'messages':_0x1596b0}};return _0x49f6d5===_0x323b5c(0x13d)&&(_0x4eb3d1[_0x323b5c(0x157)][_0x323b5c(0x127)]=0x800),new Promise(async(_0x5ac264,_0x491c01)=>{const _0x3fcc57=_0x323b5c;try{const _0x2fca8c=await(0x0,axios_1['default'])(_0x4eb3d1),_0x11444a=_0x2fca8c['data'];_0x11444a['on'](_0x3fcc57(0x157),_0x334321=>{const _0x469327=_0x3fcc57;var _0x47df12;const _0x593db7=_0x334321[_0x469327(0x15e)]()['split']('\x0a\x0a')[_0x469327(0x164)](_0x52d134=>_0x52d134['trim']()!=='');for(const _0x4aa4fb of _0x593db7){const _0x5dea96=_0x4aa4fb[_0x469327(0x128)](_0x469327(0x133),'');let _0x141966=![];try{_0x141966=JSON[_0x469327(0x16e)](_0x5dea96)[_0x469327(0x144)][0x0]['finish_reason']===_0x469327(0x147);}catch(_0x122384){_0x141966=![];}if(_0x141966)return _0x44e3f0[_0x469327(0x16f)]=_0x44e3f0['text'][_0x469327(0x156)](),_0x44e3f0;try{if(_0x5dea96!==_0x469327(0x148)&&_0x5dea96!==_0x469327(0x15f)&&_0x5dea96!=_0x469327(0x14e)){const _0x4e6315=JSON[_0x469327(0x16e)](_0x5dea96);_0x4e6315['id']&&(_0x44e3f0['id']=_0x4e6315['id']);if((_0x47df12=_0x4e6315[_0x469327(0x144)])===null||_0x47df12===void 0x0?void 0x0:_0x47df12[_0x469327(0x14d)]){const _0x3796a4=_0x4e6315[_0x469327(0x144)][0x0][_0x469327(0x13f)];_0x44e3f0[_0x469327(0x13f)]=_0x3796a4['content'];if(_0x3796a4===null||_0x3796a4===void 0x0?void 0x0:_0x3796a4[_0x469327(0x152)])_0x44e3f0[_0x469327(0x16f)]+=_0x3796a4[_0x469327(0x152)];_0x3796a4[_0x469327(0x122)]&&(_0x44e3f0[_0x469327(0x122)]=_0x3796a4[_0x469327(0x122)]),_0x44e3f0[_0x469327(0x13c)]=_0x4e6315;}_0x3dcc6d&&_0x3dcc6d({'text':_0x44e3f0[_0x469327(0x16f)]});}}catch(_0x2b16c2){console[_0x469327(0x15b)]('parse\x20Error',_0x5dea96);}}});let _0x59fa51='';_0x1596b0[_0x3fcc57(0x16c)](_0x301e05=>{_0x59fa51+=_0x301e05['content']+'\x20';}),_0x11444a['on'](_0x3fcc57(0x13a),()=>{const _0x17c9b0=_0x3fcc57;if(_0x44e3f0[_0x17c9b0(0x13c)]&&_0x44e3f0['text']){const _0x2ce479=getTokenCount(_0x59fa51),_0x3bc762=getTokenCount(_0x44e3f0[_0x17c9b0(0x16f)]);_0x44e3f0[_0x17c9b0(0x13c)][_0x17c9b0(0x163)]={'prompt_tokens':_0x2ce479,'completion_tokens':_0x3bc762,'total_tokens':_0x2ce479+_0x3bc762,'estimated':!![]};}return _0x5ac264(_0x44e3f0);});}catch(_0x31703b){_0x491c01(_0x31703b);}});}}exports[_0x5a1a3d(0x141)]=sendMessageFromOpenAi;function _0x56f7(){const _0x19367f=['@dqbd/tiktoken','delta','__esModule','sendMessageFromOpenAi','134vFuCth','string','choices','message','cl100k_base','stop','\x20[DONE]','@nestjs/common','uuid','174OGcfaZ','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','length','[DONE]\x20','dall','2871200VCtNtt','uploadFile','content','/v1/chat/completions','from','Bearer\x20','trim','data','462717hqfENg','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','default','log','------>\x20开始上传图片！！！','imageUrl','toString','[DONE]','debug','endsWith','defineProperty','usage','filter','https://api.openai.com','24282sGsUKQ','response','Logger','stringify','绘制图片失败，请稍后试试吧！','绘制图片失败，请检查你的提示词是否有非法描述！','forEach','/v1/images/generations','parse','text','stream','role','206790HKYdmZ','上传图片过程中出现错误:\x20','includes','32DXusFv','max_tokens','replace','144186HpFFce','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','error','MidjourneyService','b64_json','status','slice','base64','POST','.png','data:','openai-draw\x20error:\x20','369895gcPCNI','3139540XgIQxn','axios','getTokenCount','get_encoding','end','application/json','detail','gpt-4-vision-preview'];_0x56f7=function(){return _0x19367f;};return _0x56f7();}function getTokenCount(_0x186134){const _0x44b099=_0x5a1a3d;if(!_0x186134)return 0x0;return typeof _0x186134!==_0x44b099(0x143)&&(_0x186134=String(_0x186134)),_0x186134=_0x186134[_0x44b099(0x128)](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x186134)[_0x44b099(0x14d)];}exports[_0x5a1a3d(0x138)]=getTokenCount;