'use strict';const _0x22f349=_0xe764;(function(_0x3160a9,_0x2bda41){const _0x169a20=_0xe764,_0x25abad=_0x3160a9();while(!![]){try{const _0x263d5d=parseInt(_0x169a20(0xb6))/0x1+-parseInt(_0x169a20(0xa7))/0x2+-parseInt(_0x169a20(0x9b))/0x3+-parseInt(_0x169a20(0x94))/0x4*(-parseInt(_0x169a20(0x8b))/0x5)+parseInt(_0x169a20(0x89))/0x6+-parseInt(_0x169a20(0xc0))/0x7+parseInt(_0x169a20(0x85))/0x8*(parseInt(_0x169a20(0x96))/0x9);if(_0x263d5d===_0x2bda41)break;else _0x25abad['push'](_0x25abad['shift']());}catch(_0x4fcfa3){_0x25abad['push'](_0x25abad['shift']());}}}(_0x16c3,0xf0bcd));Object[_0x22f349(0xac)](exports,_0x22f349(0x9c),{'value':!![]}),exports[_0x22f349(0x98)]=exports[_0x22f349(0xbc)]=void 0x0;function _0xe764(_0x563ebe,_0x460cc9){const _0x16c3a3=_0x16c3();return _0xe764=function(_0xe764e,_0x233900){_0xe764e=_0xe764e-0x82;let _0x1424aa=_0x16c3a3[_0xe764e];return _0x1424aa;},_0xe764(_0x563ebe,_0x460cc9);}const axios_1=require(_0x22f349(0xb8)),tiktoken_1=require(_0x22f349(0xa5)),common_1=require('@nestjs/common'),uuid=require('uuid'),tokenizer=(0x0,tiktoken_1['get_encoding'])(_0x22f349(0xc2));function getFullUrl(_0x3cc273){const _0x4193c3=_0x22f349,_0x44f397=_0x3cc273[_0x4193c3(0xbd)]('/')?_0x3cc273[_0x4193c3(0xc9)](0x0,-0x1):_0x3cc273,_0x4f3187=_0x44f397||_0x4193c3(0xaf);return _0x4f3187+_0x4193c3(0xb3);}async function sendMessageFromOpenAi(_0x3e8891,_0x1c2e3f,_0x4e7147){const _0x12b141=_0x22f349;var _0x591c3c,_0x13518f,_0x1795c7,_0x1be73f;const {onProgress:_0x5246ea,maxToken:_0x5a8ff5,apiKey:_0x190b11,model:_0x3fce7d,temperature:temperature=0.8,proxyUrl:_0x59be0e,prompt:_0x439639}=_0x1c2e3f;if(_0x3fce7d[_0x12b141(0xbe)](_0x12b141(0xc5))){let _0x14d410={'text':'','imageUrl':''};try{const _0x415fcd={'method':_0x12b141(0xab),'url':_0x59be0e+'/v1/images/generations','headers':{'Content-Type':_0x12b141(0xc1),'Authorization':_0x12b141(0x90)+_0x190b11},'data':{'prompt':_0x439639,'model':_0x3fce7d,'response_format':'b64_json'}},_0x2971ea=await(0x0,axios_1[_0x12b141(0x9d)])(_0x415fcd),{b64_json:_0x583704,revised_prompt:_0x1ec327}=_0x2971ea[_0x12b141(0xbb)][_0x12b141(0xbb)][0x0],_0x2c894b=Buffer[_0x12b141(0xc3)](_0x583704,_0x12b141(0x86));let _0x141ac2='';try{const _0x3cfd84=uuid['v4']()[_0x12b141(0xc9)](0x0,0xa)+'.png';common_1[_0x12b141(0xa3)][_0x12b141(0xa6)](_0x12b141(0xb1),_0x12b141(0xb0));const _0x33a344=Buffer['from'](_0x583704,'base64');_0x141ac2=await _0x4e7147[_0x12b141(0xad)]({'filename':_0x3cfd84,'buffer':_0x33a344}),common_1['Logger'][_0x12b141(0xa6)](_0x12b141(0xb2)+_0x141ac2,_0x12b141(0xb0));}catch(_0x3dad4f){common_1[_0x12b141(0xa3)]['error'](_0x12b141(0x8e)+_0x3dad4f,_0x12b141(0xb0));}return _0x14d410[_0x12b141(0x8c)]=_0x141ac2,_0x14d410['text']=_0x1ec327,_0x5246ea&&_0x5246ea({'text':_0x14d410[_0x12b141(0x8f)]}),_0x14d410;}catch(_0x1736ea){const _0xa01741=((_0x591c3c=_0x1736ea===null||_0x1736ea===void 0x0?void 0x0:_0x1736ea[_0x12b141(0xb5)])===null||_0x591c3c===void 0x0?void 0x0:_0x591c3c[_0x12b141(0x9e)])||0x1f4;console[_0x12b141(0x97)]('openai-draw\x20error:\x20',JSON[_0x12b141(0xc8)](_0x1736ea),_0xa01741);const _0x3412f8=(_0x1be73f=(_0x1795c7=(_0x13518f=_0x1736ea===null||_0x1736ea===void 0x0?void 0x0:_0x1736ea[_0x12b141(0xb5)])===null||_0x13518f===void 0x0?void 0x0:_0x13518f[_0x12b141(0xbb)])===null||_0x1795c7===void 0x0?void 0x0:_0x1795c7[_0x12b141(0xa9)])===null||_0x1be73f===void 0x0?void 0x0:_0x1be73f[_0x12b141(0x83)];if(_0xa01741===0x1ad)return _0x14d410['text']='当前请求已过载、请稍等会儿再试试吧！',_0x14d410;if(_0xa01741===0x190&&_0x3412f8['includes'](_0x12b141(0xa4)))return _0x14d410[_0x12b141(0x8f)]='您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',_0x14d410;if(_0xa01741===0x190&&_0x3412f8['includes'](_0x12b141(0x93)))return _0x14d410['text']=_0x12b141(0x82),_0x14d410;if(_0xa01741===0x1f4)return _0x14d410[_0x12b141(0x8f)]=_0x12b141(0xa8),_0x14d410;if(_0xa01741===0x191)return _0x14d410[_0x12b141(0x8f)]='绘制图片失败，此次绘画被拒绝了！',_0x14d410;return _0x14d410['text']=_0x12b141(0xc6),_0x14d410;}}else{let _0x420232={'text':''};const _0x5dafae={'method':_0x12b141(0xab),'url':getFullUrl(_0x59be0e),'responseType':_0x12b141(0xb4),'headers':{'Content-Type':_0x12b141(0xc1),'Accept':_0x12b141(0xc1),'Authorization':_0x12b141(0x90)+_0x190b11},'data':{'stream':!![],'temperature':temperature,'model':_0x3fce7d,'messages':_0x3e8891}};return _0x3fce7d==='gpt-4-vision-preview'&&(_0x5dafae['data'][_0x12b141(0xc7)]=0x800),new Promise(async(_0x4e7e6a,_0x1fe773)=>{const _0x5aa39a=_0x12b141;try{const _0x4c6005=await(0x0,axios_1[_0x5aa39a(0x9d)])(_0x5dafae),_0x10825f=_0x4c6005['data'];_0x10825f['on'](_0x5aa39a(0xbb),_0x2e1846=>{const _0x4a26b0=_0x5aa39a;var _0x1c7a5a;const _0x46429a=_0x2e1846[_0x4a26b0(0x84)]()[_0x4a26b0(0x9f)]('\x0a\x0a')[_0x4a26b0(0xbf)](_0x509ca3=>_0x509ca3[_0x4a26b0(0x8a)]()!=='');for(const _0x18f4e3 of _0x46429a){const _0xa321d2=_0x18f4e3[_0x4a26b0(0xb9)](_0x4a26b0(0x9a),'');let _0x58877d=![];try{_0x58877d=JSON[_0x4a26b0(0xba)](_0xa321d2)[_0x4a26b0(0x91)][0x0][_0x4a26b0(0xa2)]==='stop';}catch(_0x597a3b){_0x58877d=![];}if(_0x58877d)return _0x420232[_0x4a26b0(0x8f)]=_0x420232[_0x4a26b0(0x8f)][_0x4a26b0(0x8a)](),_0x420232;try{if(_0xa321d2!==_0x4a26b0(0x95)&&_0xa321d2!==_0x4a26b0(0x8d)&&_0xa321d2!=_0x4a26b0(0xb7)){const _0x1552dc=JSON['parse'](_0xa321d2);_0x1552dc['id']&&(_0x420232['id']=_0x1552dc['id']);if((_0x1c7a5a=_0x1552dc[_0x4a26b0(0x91)])===null||_0x1c7a5a===void 0x0?void 0x0:_0x1c7a5a[_0x4a26b0(0x92)]){const _0x4a7770=_0x1552dc[_0x4a26b0(0x91)][0x0][_0x4a26b0(0xae)];_0x420232[_0x4a26b0(0xae)]=_0x4a7770[_0x4a26b0(0xa1)];if(_0x4a7770===null||_0x4a7770===void 0x0?void 0x0:_0x4a7770['content'])_0x420232['text']+=_0x4a7770[_0x4a26b0(0xa1)];_0x4a7770[_0x4a26b0(0x88)]&&(_0x420232[_0x4a26b0(0x88)]=_0x4a7770[_0x4a26b0(0x88)]),_0x420232['detail']=_0x1552dc;}_0x5246ea&&_0x5246ea({'text':_0x420232[_0x4a26b0(0x8f)]});}}catch(_0x230fc2){console[_0x4a26b0(0x97)](_0x4a26b0(0xaa),_0xa321d2);}}});let _0x4a2e5f='';_0x3e8891[_0x5aa39a(0x87)](_0xd2fb71=>{const _0x2b16cc=_0x5aa39a;_0x4a2e5f+=_0xd2fb71[_0x2b16cc(0xa1)]+'\x20';}),_0x10825f['on']('end',()=>{const _0x5cf2c2=_0x5aa39a;if(_0x420232[_0x5cf2c2(0x99)]&&_0x420232['text']){const _0x42a91f=getTokenCount(_0x4a2e5f),_0x1b81df=getTokenCount(_0x420232[_0x5cf2c2(0x8f)]);_0x420232[_0x5cf2c2(0x99)][_0x5cf2c2(0xc4)]={'prompt_tokens':_0x42a91f,'completion_tokens':_0x1b81df,'total_tokens':_0x42a91f+_0x1b81df,'estimated':!![]};}return _0x4e7e6a(_0x420232);});}catch(_0x5da30e){_0x1fe773(_0x5da30e);}});}}exports['sendMessageFromOpenAi']=sendMessageFromOpenAi;function getTokenCount(_0x87581d){const _0x28a437=_0x22f349;if(!_0x87581d)return 0x0;return typeof _0x87581d!==_0x28a437(0xa0)&&(_0x87581d=String(_0x87581d)),_0x87581d=_0x87581d['replace'](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x87581d)[_0x28a437(0x92)];}exports[_0x22f349(0x98)]=getTokenCount;function _0x16c3(){const _0x5e069e=['default','status','split','string','content','finish_reason','Logger','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','@dqbd/tiktoken','debug','816408FgSacx','绘制图片失败，请检查你的提示词是否有非法描述！','error','parse\x20Error','POST','defineProperty','uploadFile','delta','https://api.openai.com','MidjourneyService','------>\x20开始上传图片！！！','图片上传成功，URL:\x20','/v1/chat/completions','stream','response','1229755TesFJS','[DONE]\x20','axios','replace','parse','data','sendMessageFromOpenAi','endsWith','includes','filter','8962499LeOxAh','application/json','cl100k_base','from','usage','dall','绘制图片失败，请稍后试试吧！','max_tokens','stringify','slice','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','message','toString','8VcoDtm','base64','forEach','role','5029932VsKAwj','trim','18965gIcpOy','imageUrl','[DONE]','上传图片过程中出现错误:\x20','text','Bearer\x20','choices','length','Billing\x20hard\x20limit\x20has\x20been\x20reached','156JsHCka','\x20[DONE]','8139177EMkjUa','log','getTokenCount','detail','data:','1337205OcLweY','__esModule'];_0x16c3=function(){return _0x5e069e;};return _0x16c3();}