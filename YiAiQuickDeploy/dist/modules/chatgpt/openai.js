'use strict';const _0x3ffba5=_0x326b;function _0x26cd(){const _0x4ef518=['__esModule','filter','parse','from','slice','replace','axios','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','text','debug','绘制图片失败，请稍后试试吧！','role','uuid','POST','MidjourneyService','cl100k_base','@dqbd/tiktoken','end','openai-draw\x20error:\x20','encode','/v1/images/generations','imageUrl','Bearer\x20','defineProperty','message','107470cUWMaB','804VTOoFG','getTokenCount','base64','6185BfMUNJ','90fEbRrp','error','log','includes','detail','sendMessageFromOpenAi','delta','1662414PtvUTS','data:','finish_reason','2424yIVeXR','/v1/chat/completions','30PfcIKo','string','stringify','7821NOAnMs','Logger','图片上传成功，URL:\x20','choices','toString','b64_json','parse\x20Error','\x20[DONE]','trim','data','endsWith','31302zCJchg','gpt-4-vision-preview','split','上传图片过程中出现错误:\x20','324002IXhKzs','.png','length','Billing\x20hard\x20limit\x20has\x20been\x20reached','40jDpRai','default','538830GhSBoH','content','status'];_0x26cd=function(){return _0x4ef518;};return _0x26cd();}(function(_0x375412,_0x545cd1){const _0x1b489b=_0x326b,_0x558aeb=_0x375412();while(!![]){try{const _0xa87b9a=-parseInt(_0x1b489b(0x1a3))/0x1*(parseInt(_0x1b489b(0x1a0))/0x2)+-parseInt(_0x1b489b(0x1e0))/0x3+parseInt(_0x1b489b(0x1d5))/0x4*(-parseInt(_0x1b489b(0x1d8))/0x5)+parseInt(_0x1b489b(0x1ae))/0x6+parseInt(_0x1b489b(0x1b2))/0x7*(-parseInt(_0x1b489b(0x1b6))/0x8)+-parseInt(_0x1b489b(0x1d9))/0x9*(parseInt(_0x1b489b(0x1b8))/0xa)+-parseInt(_0x1b489b(0x1d4))/0xb*(-parseInt(_0x1b489b(0x1e3))/0xc);if(_0xa87b9a===_0x545cd1)break;else _0x558aeb['push'](_0x558aeb['shift']());}catch(_0x1eb303){_0x558aeb['push'](_0x558aeb['shift']());}}}(_0x26cd,0x46697));Object[_0x3ffba5(0x1d2)](exports,_0x3ffba5(0x1bb),{'value':!![]}),exports[_0x3ffba5(0x1d6)]=exports[_0x3ffba5(0x1de)]=void 0x0;const axios_1=require(_0x3ffba5(0x1c1)),tiktoken_1=require(_0x3ffba5(0x1cb)),common_1=require('@nestjs/common'),uuid=require(_0x3ffba5(0x1c7)),tokenizer=(0x0,tiktoken_1['get_encoding'])(_0x3ffba5(0x1ca));function _0x326b(_0x53305e,_0x5eab2a){const _0x26cdf7=_0x26cd();return _0x326b=function(_0x326b96,_0x3efda0){_0x326b96=_0x326b96-0x1a0;let _0x591e84=_0x26cdf7[_0x326b96];return _0x591e84;},_0x326b(_0x53305e,_0x5eab2a);}function getFullUrl(_0x3b17d6){const _0x22b732=_0x3ffba5,_0x1efdcd=_0x3b17d6[_0x22b732(0x1ad)]('/')?_0x3b17d6[_0x22b732(0x1bf)](0x0,-0x1):_0x3b17d6,_0x389745=_0x1efdcd||'https://api.openai.com';return _0x389745+_0x22b732(0x1e4);}async function sendMessageFromOpenAi(_0x3d87b9,_0x29784d,_0x54f41c){const _0x1181ed=_0x3ffba5;var _0x45e2b6,_0x8250be,_0xb36163,_0x46a6b8;const {onProgress:_0x5e61fb,maxToken:_0x5b4261,apiKey:_0x1f1c72,model:_0x305826,temperature:temperature=0.8,proxyUrl:_0x3bdb65,prompt:_0xf8072c}=_0x29784d;if(_0x305826[_0x1181ed(0x1dc)]('dall')){let _0xdf612f={'text':'','imageUrl':''};try{const _0x4f7b8d={'method':_0x1181ed(0x1c8),'url':_0x3bdb65+_0x1181ed(0x1cf),'headers':{'Content-Type':'application/json','Authorization':_0x1181ed(0x1d1)+_0x1f1c72},'data':{'prompt':_0xf8072c,'model':_0x305826,'response_format':_0x1181ed(0x1a8)}},_0x1de356=await(0x0,axios_1[_0x1181ed(0x1b7)])(_0x4f7b8d),{b64_json:_0x214bac,revised_prompt:_0x134d9a}=_0x1de356[_0x1181ed(0x1ac)][_0x1181ed(0x1ac)][0x0],_0x26685a=Buffer['from'](_0x214bac,_0x1181ed(0x1d7));let _0x4d06bd='';try{const _0x74127d=uuid['v4']()[_0x1181ed(0x1bf)](0x0,0xa)+_0x1181ed(0x1b3);common_1['Logger'][_0x1181ed(0x1c4)]('------>\x20开始上传图片！！！','MidjourneyService');const _0xc134b9=Buffer[_0x1181ed(0x1be)](_0x214bac,'base64');_0x4d06bd=await _0x54f41c['uploadFile']({'filename':_0x74127d,'buffer':_0xc134b9}),common_1[_0x1181ed(0x1a4)][_0x1181ed(0x1c4)](_0x1181ed(0x1a5)+_0x4d06bd,_0x1181ed(0x1c9));}catch(_0x57bad2){common_1[_0x1181ed(0x1a4)][_0x1181ed(0x1da)](_0x1181ed(0x1b1)+_0x57bad2,'MidjourneyService');}return _0xdf612f[_0x1181ed(0x1d0)]=_0x4d06bd,_0xdf612f[_0x1181ed(0x1c3)]=_0x134d9a,_0x5e61fb&&_0x5e61fb({'text':_0xdf612f['text']}),_0xdf612f;}catch(_0x365624){const _0x4a27bb=((_0x45e2b6=_0x365624===null||_0x365624===void 0x0?void 0x0:_0x365624['response'])===null||_0x45e2b6===void 0x0?void 0x0:_0x45e2b6[_0x1181ed(0x1ba)])||0x1f4;console[_0x1181ed(0x1db)](_0x1181ed(0x1cd),JSON[_0x1181ed(0x1a2)](_0x365624),_0x4a27bb);const _0x1115bf=(_0x46a6b8=(_0xb36163=(_0x8250be=_0x365624===null||_0x365624===void 0x0?void 0x0:_0x365624['response'])===null||_0x8250be===void 0x0?void 0x0:_0x8250be[_0x1181ed(0x1ac)])===null||_0xb36163===void 0x0?void 0x0:_0xb36163[_0x1181ed(0x1da)])===null||_0x46a6b8===void 0x0?void 0x0:_0x46a6b8[_0x1181ed(0x1d3)];if(_0x4a27bb===0x1ad)return _0xdf612f[_0x1181ed(0x1c3)]='当前请求已过载、请稍等会儿再试试吧！',_0xdf612f;if(_0x4a27bb===0x190&&_0x1115bf[_0x1181ed(0x1dc)]('This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters'))return _0xdf612f[_0x1181ed(0x1c3)]=_0x1181ed(0x1c2),_0xdf612f;if(_0x4a27bb===0x190&&_0x1115bf[_0x1181ed(0x1dc)](_0x1181ed(0x1b5)))return _0xdf612f[_0x1181ed(0x1c3)]='当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',_0xdf612f;if(_0x4a27bb===0x1f4)return _0xdf612f[_0x1181ed(0x1c3)]='绘制图片失败，请检查你的提示词是否有非法描述！',_0xdf612f;if(_0x4a27bb===0x191)return _0xdf612f[_0x1181ed(0x1c3)]='绘制图片失败，此次绘画被拒绝了！',_0xdf612f;return _0xdf612f[_0x1181ed(0x1c3)]=_0x1181ed(0x1c5),_0xdf612f;}}else{let _0x35e7f9={'text':''};const _0x3c83a0={'method':_0x1181ed(0x1c8),'url':getFullUrl(_0x3bdb65),'responseType':'stream','headers':{'Content-Type':'application/json','Accept':'application/json','Authorization':_0x1181ed(0x1d1)+_0x1f1c72},'data':{'stream':!![],'temperature':temperature,'model':_0x305826,'messages':_0x3d87b9}};return _0x305826===_0x1181ed(0x1af)&&(_0x3c83a0[_0x1181ed(0x1ac)]['max_tokens']=0x800),new Promise(async(_0x19eb62,_0x115907)=>{const _0x192d2c=_0x1181ed;try{const _0x32caf7=await(0x0,axios_1['default'])(_0x3c83a0),_0x4f79a6=_0x32caf7[_0x192d2c(0x1ac)];_0x4f79a6['on']('data',_0x48236d=>{const _0x18ef71=_0x192d2c;var _0x2e19e8;const _0xa2bdc0=_0x48236d[_0x18ef71(0x1a7)]()[_0x18ef71(0x1b0)]('\x0a\x0a')[_0x18ef71(0x1bc)](_0xf83bda=>_0xf83bda[_0x18ef71(0x1ab)]()!=='');for(const _0x29127e of _0xa2bdc0){const _0x1f8435=_0x29127e[_0x18ef71(0x1c0)](_0x18ef71(0x1e1),'');let _0x11344f=![];try{_0x11344f=JSON[_0x18ef71(0x1bd)](_0x1f8435)[_0x18ef71(0x1a6)][0x0][_0x18ef71(0x1e2)]==='stop';}catch(_0x52bfb6){_0x11344f=![];}if(_0x11344f)return _0x35e7f9[_0x18ef71(0x1c3)]=_0x35e7f9[_0x18ef71(0x1c3)]['trim'](),_0x35e7f9;try{if(_0x1f8435!==_0x18ef71(0x1aa)&&_0x1f8435!=='[DONE]'&&_0x1f8435!='[DONE]\x20'){const _0x1390dd=JSON[_0x18ef71(0x1bd)](_0x1f8435);_0x1390dd['id']&&(_0x35e7f9['id']=_0x1390dd['id']);if((_0x2e19e8=_0x1390dd[_0x18ef71(0x1a6)])===null||_0x2e19e8===void 0x0?void 0x0:_0x2e19e8['length']){const _0x305381=_0x1390dd['choices'][0x0]['delta'];_0x35e7f9[_0x18ef71(0x1df)]=_0x305381[_0x18ef71(0x1b9)];if(_0x305381===null||_0x305381===void 0x0?void 0x0:_0x305381['content'])_0x35e7f9[_0x18ef71(0x1c3)]+=_0x305381[_0x18ef71(0x1b9)];_0x305381['role']&&(_0x35e7f9[_0x18ef71(0x1c6)]=_0x305381[_0x18ef71(0x1c6)]),_0x35e7f9[_0x18ef71(0x1dd)]=_0x1390dd;}_0x5e61fb&&_0x5e61fb({'text':_0x35e7f9[_0x18ef71(0x1c3)]});}}catch(_0x290836){console[_0x18ef71(0x1db)](_0x18ef71(0x1a9),_0x1f8435);}}});let _0x36ee4f='';_0x3d87b9['forEach'](_0x43a2a4=>{_0x36ee4f+=_0x43a2a4['content']+'\x20';}),_0x4f79a6['on'](_0x192d2c(0x1cc),()=>{const _0x180878=_0x192d2c;if(_0x35e7f9['detail']&&_0x35e7f9[_0x180878(0x1c3)]){const _0x3ddbb9=getTokenCount(_0x36ee4f),_0x4b63d4=getTokenCount(_0x35e7f9[_0x180878(0x1c3)]);_0x35e7f9['detail']['usage']={'prompt_tokens':_0x3ddbb9,'completion_tokens':_0x4b63d4,'total_tokens':_0x3ddbb9+_0x4b63d4,'estimated':!![]};}return _0x19eb62(_0x35e7f9);});}catch(_0x323224){_0x115907(_0x323224);}});}}exports[_0x3ffba5(0x1de)]=sendMessageFromOpenAi;function getTokenCount(_0x19b3fa){const _0x45ea7d=_0x3ffba5;if(!_0x19b3fa)return 0x0;return typeof _0x19b3fa!==_0x45ea7d(0x1a1)&&(_0x19b3fa=String(_0x19b3fa)),_0x19b3fa=_0x19b3fa[_0x45ea7d(0x1c0)](/<\|endoftext\|>/g,''),tokenizer[_0x45ea7d(0x1ce)](_0x19b3fa)[_0x45ea7d(0x1b4)];}exports[_0x3ffba5(0x1d6)]=getTokenCount;