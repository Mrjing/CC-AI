'use strict';function _0x4ae0(_0x2f9401,_0x1c86af){const _0x450802=_0x4508();return _0x4ae0=function(_0x4ae021,_0x22d740){_0x4ae021=_0x4ae021-0x178;let _0x27e01a=_0x450802[_0x4ae021];return _0x27e01a;},_0x4ae0(_0x2f9401,_0x1c86af);}const _0x5c7b4e=_0x4ae0;function _0x4508(){const _0x55712b=['ChatBoxTypeEntity','getClientIp','ChatPreTypeEntity','statusText:','chatLogService','openaiModel3MaxTokens16kRes','status','./gptkeys.entity','keyv','formatModelToken','post','openaiModel3MaxTokensRes','checkAutoReply','delChatBox','delete','checkBadWords','@nestjs/common','ceil','setChatBox','saveChatLog','https://api.openai.com','./../user/user.service','chatPreEntity','systemMessage','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','user','queryChatPreType','close','application/octet-stream;\x20charset=utf-8','chatPreTypeEntity','gpt-3','conversationId','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','addOneIfOdd','billing','getAllKeyList','appInfo','error','userBanance','uploadService','./openai','dall','getRequestParams','usage','Billing\x20hard\x20limit\x20has\x20been\x20reached','floor','InjectRepository','REDIS_USER','autoreplyService','text','OpenAiErrorCodeMessage','openai-draw\x20error:\x20','绘制图片失败，请稍后试试吧！','../../common/constants/errorMessage.constant','error:\x20','typeInfo','3320zUUWlX','__decorate','configService','buildMessageFromParentMessageId','onModuleInit','preset','5093649ZFuBJA','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','DeductionKey','./helper','ModelsService','16UZLDst','getGroupInfoFromId',',\x20消耗积分：\x20','当前Key余额已不足、请重新再试一次吧！','keyPool','Logger','queryChatBoxType','2884528zsfxPV','CHAT_TYPE','./../upload/upload.service','GptKeysEntity','gptKeysEntity','prompt','importDynamic','ConfigEntity','Injectable','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','save','configEntity','../chatGroup/chatGroup.service','sendMessageFromOpenAi','8270647qkzSXG','./zhipu','draw\x20paompt\x20info\x20<==**==>\x20','149316BuDKmA','getBaseConfig','imageUrl','openaiModel3MaxTokens16k','chatBoxTypeEntity','BAD_REQUEST','setHeader','Incorrect\x20API\x20key\x20provided','ChatPreEntity','getMaxTokenFromModelWithOpenAi','base64','用户ID:\x20','\x0a\x20Current\x20date:\x20','@keyv/redis','mjDraw','uploadFile','196858cfwPoT','update','abort','chat-error\x20<----------------------------------------->','statusCode','standard','提供了错误的模型秘钥','env','./chatBoxType.entity','REDIS_HOST','chatGroupService','function','assistant','gpt-4-1106','assign','openaiTimeoutMs','typeId','appId','delChatBoxType','../../common/utils','nineai-chatlog','deductFromBalance','openaiModel4MaxTokens32kRes','end','./chatPre.entity','toLowerCase','model','REDIS_PORT','findOne','openaiModel4MaxTokensRes','400\x20error','setChatPre','chatBoxEntity','delChatPre','userBalanceService','b64_json','size','getOwnPropertyDescriptor','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','openaiModel3MaxTokens','detail','gpt-4','gpt-4-vision-preview','systemPreMessage','当前模型不是聊天模型','Bearer\x20','globalConfigService','split','model3','9aoOxWD','Repository','filter','key','response','UserService','1106','dall-e-3','sendMessageFromZhipu','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','当前请求已过载、请稍等会儿再试试吧！','push','getUploadType','childList','./chatPreType.entity','AppEntity','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','setChatPreType','chatgpt-ai-web','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','FanyiService','axios','stringify','sendMessageFromBaidu','includes','当前模型调用过于频繁、请重新试试吧！','defineProperty','../badwords/badwords.service','saveUseLog','maxModelTokens','lockKey','config','getRandomDrawKey','design:paramtypes','Catch\x20Error\x20','94490XuOmRU','../fanyi/fanyi.service','find','DrawService','setData','32k','modelInfo','绘制图片失败，此次绘画被拒绝了！','@nestjs/typeorm','count','NineStore','all','toISOString','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','modelsService','.png','delChatPreType','log','code:\x20','20568xAizTx','AutoreplyService','nineStore','getUuid','openaiBaseUrl','uuid','queryChatBoxFrontend','PAINT_TYPE','result','length','metadata','weight','当前模型key余额已耗尽','userService','当前分类下有未处理数据不可移除！','data','statusText','getConfigs','Too\x20Many\x20Requests','../app/app.entity','appEntity','./chatBox.entity','default','getCurrentModelKeyInfo','decorate','服务异常、请重新试试吧！！！','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','getModelProxyUrl','非法操作！','chatSyncFree','redis://','badwordsService','setChatBoxType','openaiModel4MaxTokens','HttpStatus','unifiedFormattingResponse','ChatgptService','ConfigService','queryChatBox','../models/models.service','ChatLogService','缺失必要参数！','../globalConfig/config.entity','model4','checkUserStatus','/v1/images/generations','message','map','coverImg','openaiModel4MaxTokens32k','abortController','UserBalanceService','getTokenCount','DESC','queryChatPre','forEach','当前模型key已被封禁','parse',',\x20消耗token:\x20','../globalConfig/globalConfig.service','HttpException','dall-e\x20draw\x20params:\x20','validateBalance','Content-type','235tjOTob','chat-error-detail\x20\x20<----------------------------------------->','write','removeSpecialCharacters','quality'];_0x4508=function(){return _0x55712b;};return _0x4508();}(function(_0x363233,_0x40a319){const _0x4ba134=_0x4ae0,_0x221a6d=_0x363233();while(!![]){try{const _0x4d4c7c=-parseInt(_0x4ba134(0x1fa))/0x1+parseInt(_0x4ba134(0x1d9))/0x2+-parseInt(_0x4ba134(0x22b))/0x3*(parseInt(_0x4ba134(0x1ea))/0x4)+parseInt(_0x4ba134(0x18a))/0x5*(parseInt(_0x4ba134(0x261))/0x6)+parseInt(_0x4ba134(0x1e7))/0x7+parseInt(_0x4ba134(0x1d2))/0x8*(parseInt(_0x4ba134(0x1cd))/0x9)+-parseInt(_0x4ba134(0x1c7))/0xa*(parseInt(_0x4ba134(0x24e))/0xb);if(_0x4d4c7c===_0x40a319)break;else _0x221a6d['push'](_0x221a6d['shift']());}catch(_0x150c7d){_0x221a6d['push'](_0x221a6d['shift']());}}}(_0x4508,0xb8982));var __decorate=this&&this[_0x5c7b4e(0x1c8)]||function(_0x2b5b92,_0x151243,_0x2e4c2b,_0x13465c){const _0x209991=_0x5c7b4e;var _0x22f96b=arguments[_0x209991(0x26a)],_0x4487e0=_0x22f96b<0x3?_0x151243:_0x13465c===null?_0x13465c=Object[_0x209991(0x21f)](_0x151243,_0x2e4c2b):_0x13465c,_0xcc939a;if(typeof Reflect==='object'&&typeof Reflect[_0x209991(0x279)]===_0x209991(0x205))_0x4487e0=Reflect[_0x209991(0x279)](_0x2b5b92,_0x151243,_0x2e4c2b,_0x13465c);else{for(var _0x819dfe=_0x2b5b92[_0x209991(0x26a)]-0x1;_0x819dfe>=0x0;_0x819dfe--)if(_0xcc939a=_0x2b5b92[_0x819dfe])_0x4487e0=(_0x22f96b<0x3?_0xcc939a(_0x4487e0):_0x22f96b>0x3?_0xcc939a(_0x151243,_0x2e4c2b,_0x4487e0):_0xcc939a(_0x151243,_0x2e4c2b))||_0x4487e0;}return _0x22f96b>0x3&&_0x4487e0&&Object[_0x209991(0x245)](_0x151243,_0x2e4c2b,_0x4487e0),_0x4487e0;},__metadata=this&&this['__metadata']||function(_0x3a3b7f,_0x574e62){const _0x2c8697=_0x5c7b4e;if(typeof Reflect==='object'&&typeof Reflect[_0x2c8697(0x26b)]===_0x2c8697(0x205))return Reflect[_0x2c8697(0x26b)](_0x3a3b7f,_0x574e62);},__param=this&&this['__param']||function(_0x1dd20f,_0x2bd0a3){return function(_0x181241,_0x2da45e){_0x2bd0a3(_0x181241,_0x2da45e,_0x1dd20f);};};Object[_0x5c7b4e(0x245)](exports,'__esModule',{'value':!![]}),exports[_0x5c7b4e(0x285)]=void 0x0;const upload_service_1=require(_0x5c7b4e(0x1db)),user_service_1=require(_0x5c7b4e(0x1a4)),nestjs_config_1=require('nestjs-config'),common_1=require(_0x5c7b4e(0x19f)),errorMessage_constant_1=require(_0x5c7b4e(0x1c4)),utils_1=require(_0x5c7b4e(0x20d)),axios_1=require(_0x5c7b4e(0x240)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require('../../common/constants/balance.constant'),chatLog_service_1=require('../chatLog/chatLog.service'),uuid=require(_0x5c7b4e(0x266)),config_entity_1=require(_0x5c7b4e(0x28b)),typeorm_1=require('typeorm'),typeorm_2=require(_0x5c7b4e(0x256)),badwords_service_1=require(_0x5c7b4e(0x246)),autoreply_service_1=require('../autoreply/autoreply.service'),gptkeys_entity_1=require(_0x5c7b4e(0x196)),globalConfig_service_1=require(_0x5c7b4e(0x185)),fanyi_service_1=require(_0x5c7b4e(0x24f)),app_entity_1=require(_0x5c7b4e(0x274)),chatGroup_service_1=require(_0x5c7b4e(0x1e5)),models_service_1=require(_0x5c7b4e(0x288)),baidu_1=require('./baidu'),helper_1=require(_0x5c7b4e(0x1d0)),store_1=require('./store'),zhipu_1=require(_0x5c7b4e(0x1e8)),openai_1=require(_0x5c7b4e(0x1b7)),chatBoxType_entity_1=require(_0x5c7b4e(0x202)),chatBox_entity_1=require(_0x5c7b4e(0x276)),chatPre_entity_1=require(_0x5c7b4e(0x212)),chatPreType_entity_1=require(_0x5c7b4e(0x239));let ChatgptService=class ChatgptService{constructor(_0x3392c7,_0x82b62f,_0xe12b30,_0x5e77d7,_0x549fe6,_0x33eddc,_0x224fff,_0x3b913e,_0x22ac48,_0x570c2f,_0x377cf3,_0x407a84,_0x108cd5,_0x54d271,_0x416657,_0xcc42d,_0x2164f2,_0x53a09d){const _0xd486e0=_0x5c7b4e;this[_0xd486e0(0x1dd)]=_0x3392c7,this[_0xd486e0(0x1e4)]=_0x82b62f,this[_0xd486e0(0x1ee)]=_0xe12b30,this[_0xd486e0(0x21a)]=_0x5e77d7,this[_0xd486e0(0x275)]=_0x549fe6,this[_0xd486e0(0x1ac)]=_0x33eddc,this[_0xd486e0(0x1a5)]=_0x224fff,this[_0xd486e0(0x1c9)]=_0x3b913e,this[_0xd486e0(0x21c)]=_0x22ac48,this[_0xd486e0(0x193)]=_0x570c2f,this[_0xd486e0(0x26e)]=_0x377cf3,this[_0xd486e0(0x1b6)]=_0x407a84,this[_0xd486e0(0x280)]=_0x108cd5,this[_0xd486e0(0x1bf)]=_0x54d271,this[_0xd486e0(0x228)]=_0x416657,this['fanyiService']=_0xcc42d,this[_0xd486e0(0x204)]=_0x2164f2,this[_0xd486e0(0x25c)]=_0x53a09d,this[_0xd486e0(0x263)]=null,this['whiteListUser']=[],this[_0xd486e0(0x1d6)]={'list3':[],'list4':[]};}async[_0x5c7b4e(0x1cb)](){const _0x3aebb6=_0x5c7b4e;let _0x14999a=await(0x0,utils_1['importDynamic'])(_0x3aebb6(0x23d)),_0x3293c6=await(0x0,utils_1[_0x3aebb6(0x1df)])(_0x3aebb6(0x1f7)),_0x2c18d0=await(0x0,utils_1[_0x3aebb6(0x1df)])(_0x3aebb6(0x197));_0x14999a=(_0x14999a===null||_0x14999a===void 0x0?void 0x0:_0x14999a[_0x3aebb6(0x277)])?_0x14999a['default']:_0x14999a,_0x3293c6=(_0x3293c6===null||_0x3293c6===void 0x0?void 0x0:_0x3293c6[_0x3aebb6(0x277)])?_0x3293c6[_0x3aebb6(0x277)]:_0x3293c6,_0x2c18d0=(_0x2c18d0===null||_0x2c18d0===void 0x0?void 0x0:_0x2c18d0[_0x3aebb6(0x277)])?_0x2c18d0[_0x3aebb6(0x277)]:_0x2c18d0;const {ChatGPTAPI:_0x47d0ce,ChatGPTError:_0x475eab,ChatGPTUnofficialProxyAPI:_0x4d820e}=_0x14999a,_0x5b10c0=+process[_0x3aebb6(0x201)][_0x3aebb6(0x215)],_0x2233f5=process[_0x3aebb6(0x201)][_0x3aebb6(0x203)],_0x13026e=process[_0x3aebb6(0x201)]['REDIS_PASSWORD'],_0x53466c=process[_0x3aebb6(0x201)][_0x3aebb6(0x1be)],_0x3ca2ce=_0x3aebb6(0x27f)+(_0x53466c||'')+':'+(_0x13026e||'')+'@'+_0x2233f5+':'+_0x5b10c0,_0x5922ba=new _0x3293c6(_0x3ca2ce),_0x1e509f=new _0x2c18d0({'store':_0x5922ba,'namespace':_0x3aebb6(0x20e)});this['nineStore']=new store_1[(_0x3aebb6(0x258))]({'store':_0x1e509f,'namespace':'chat'});}async[_0x5c7b4e(0x1b9)](_0x3412e1,_0x48da2c,_0x2b6677,_0x20e887=null){const _0x171071=_0x5c7b4e;var _0x14f17e;!_0x20e887&&(_0x20e887=(_0x14f17e=await this[_0x171071(0x25c)][_0x171071(0x1eb)]())===null||_0x14f17e===void 0x0?void 0x0:_0x14f17e[_0x171071(0x254)]);const {timeout:timeout=0x3c}=_0x2b6677,{topN:_0x1f539e,model:_0x25e6b2}=_0x20e887,{parentMessageId:parentMessageId=0x0}=_0x3412e1,_0x167fe7=await this[_0x171071(0x228)][_0x171071(0x272)]([_0x171071(0x209)]),_0x3a0c1b=timeout*0x3e8||_0x167fe7||0x64*0x3e8,_0x50b873={'parentMessageId':parentMessageId,'timeoutMs':+_0x3a0c1b,'completionParams':{'model':_0x25e6b2,'temperature':_0x1f539e}};return _0x48da2c&&(_0x50b873[_0x171071(0x1a6)]=_0x48da2c),_0x50b873;}async[_0x5c7b4e(0x27e)](_0x1456bb){const _0x1a4869=_0x5c7b4e,_0x47e148=await this['modelsService'][_0x1a4869(0x24b)](),_0x401f38=await this[_0x1a4869(0x228)][_0x1a4869(0x272)]([_0x1a4869(0x225)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x415b8c,model:_0x4972ec}=_0x47e148,_0x256e08=await this[_0x1a4869(0x27c)](_0x47e148),{context:_0x3ce628}=await this[_0x1a4869(0x263)][_0x1a4869(0x1ca)](_0x1456bb,{'parentMessageId':'','systemMessage':_0x401f38});try{const _0xa159a1=await(0x0,openai_1[_0x1a4869(0x1e6)])(_0x3ce628,{'apiKey':(0x0,utils_1[_0x1a4869(0x18d)])(_0x415b8c),'model':_0x4972ec,'proxyUrl':_0x256e08,'onProgress':null});return _0xa159a1===null||_0xa159a1===void 0x0?void 0x0:_0xa159a1['text'];}catch(_0x4b9a76){console[_0x1a4869(0x25f)](_0x1a4869(0x1c5),_0x4b9a76);}}async['chatProcess'](_0x19c36b,_0x87f9c7,_0x98c566){const _0x53754e=_0x5c7b4e;var _0x2d3a13,_0x32ed65,_0x2c9d4d,_0x63a956;const _0x3eea10=_0x87f9c7[_0x53754e(0x17c)],{options:options={},appId:_0xd8abab,cusromPrompt:_0x57a519,systemMessage:systemMessage=''}=_0x19c36b;let _0x358e11=systemMessage;const {parentMessageId:_0x2ae06e}=options,{prompt:_0x5756b6,imageUrl:_0x28fb05,model:_0x1fd49f}=_0x19c36b,{groupId:_0x21a25a,usingNetwork:_0x440e3d}=options,_0x223ec8=await this['chatGroupService'][_0x53754e(0x1d3)](_0x21a25a),_0x5a59ee=(_0x223ec8===null||_0x223ec8===void 0x0?void 0x0:_0x223ec8['config'])?JSON[_0x53754e(0x183)](_0x223ec8[_0x53754e(0x24a)]):await this['modelsService'][_0x53754e(0x1eb)](),{keyType:_0x44a8c8,model:_0x1fc04e,topN:_0x3c246e,systemMessage:_0x528ff9,rounds:_0x3840af}=_0x5a59ee[_0x53754e(0x254)];let _0x22bebf=null;!_0x57a519?_0x22bebf=await this[_0x53754e(0x25c)][_0x53754e(0x278)](_0x1fc04e):_0x22bebf=await this[_0x53754e(0x25c)]['getRandomDrawKey']();if(!_0x22bebf)throw new common_1[(_0x53754e(0x186))](_0x53754e(0x234),common_1[_0x53754e(0x283)][_0x53754e(0x1ef)]);const {deduct:_0x31ea7c,isTokenBased:_0x46e110,tokenFeeRatio:_0x1f3f12,deductType:_0x37306c,key:_0x9edab9,secret:_0x120422,modelName:_0x193d5e,id:_0x796523,accessToken:_0x3b5f79}=_0x22bebf;await this[_0x53754e(0x26e)][_0x53754e(0x28d)](_0x87f9c7['user']),await this[_0x53754e(0x21c)][_0x53754e(0x188)](_0x87f9c7,_0x37306c===0x1?_0x53754e(0x22a):_0x53754e(0x28c),_0x31ea7c),_0x98c566&&_0x98c566[_0x53754e(0x1f0)](_0x53754e(0x189),_0x53754e(0x1ab)),await this[_0x53754e(0x280)][_0x53754e(0x19e)](_0x5756b6,_0x87f9c7[_0x53754e(0x1a8)]['id']);const _0x7a3b92=await this[_0x53754e(0x1bf)][_0x53754e(0x19b)](_0x5756b6);if(_0x7a3b92&&_0x98c566){const _0x5f829e={'message':_0x7a3b92,'code':0x1f4};return _0x98c566['write'](JSON[_0x53754e(0x241)](_0x5f829e)),_0x98c566['end']();}if(_0xd8abab){const _0x58a4dd=await this[_0x53754e(0x275)][_0x53754e(0x216)]({'where':{'id':_0xd8abab,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x58a4dd)throw new common_1[(_0x53754e(0x186))](_0x53754e(0x1af),common_1[_0x53754e(0x283)][_0x53754e(0x1ef)]);_0x58a4dd['preset']&&(_0x358e11=_0x58a4dd[_0x53754e(0x1cc)]);}else{if(_0x57a519)_0x358e11=systemMessage;else{if(_0x528ff9)_0x358e11=_0x528ff9;else{const _0x1defd9=new Date()[_0x53754e(0x25a)]()['split']('T')[0x0],_0x69ee52=await this[_0x53754e(0x228)]['getConfigs']([_0x53754e(0x225)]);_0x358e11=_0x69ee52+(_0x53754e(0x1f6)+_0x1defd9);}}}let _0x2496c7='';if(_0x440e3d){_0x2496c7=await(0x0,utils_1['compileNetwork'])(_0x5756b6);const _0x171fa9=new Date()[_0x53754e(0x25a)]()[_0x53754e(0x229)]('T')[0x0],_0x49558b=await this[_0x53754e(0x228)][_0x53754e(0x272)](['systemPreMessage']);_0x358e11=_0x49558b+('\x0a\x20Current\x20date:\x20'+_0x171fa9);}const _0x1fa06d=await this[_0x53754e(0x1b9)](options,_0x358e11,_0x22bebf,_0x5a59ee[_0x53754e(0x254)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x3484dc}=_0x22bebf;_0x98c566&&_0x98c566[_0x53754e(0x195)](0xc8);let _0x6892aa=null,_0x32eced=null;try{if(_0x98c566){let _0x658e3f=null,_0x5b0647=![];_0x98c566['on'](_0x53754e(0x1aa),async()=>{const _0x31b491=_0x53754e;if(_0x5b0647)return;_0x3eea10[_0x31b491(0x1fc)]();const _0x2aa8e5=await(0x0,openai_1[_0x31b491(0x17e)])(_0x5756b6)||0x0,_0x25ec26=await(0x0,openai_1['getTokenCount'])(_0x658e3f===null||_0x658e3f===void 0x0?void 0x0:_0x658e3f['text'])||0x0,_0x52be35=_0x2aa8e5+_0x25ec26,_0x447506=(0x0,utils_1['getClientIp'])(_0x87f9c7);await this[_0x31b491(0x193)][_0x31b491(0x1a2)]({'appId':_0xd8abab,'curIp':_0x447506,'userId':_0x87f9c7[_0x31b491(0x1a8)]['id'],'type':balance_constant_1[_0x31b491(0x1cf)][_0x31b491(0x1da)],'prompt':_0x5756b6,'imageUrl':_0x28fb05,'activeModel':_0x1fd49f,'answer':'','promptTokens':_0x2aa8e5,'completionTokens':0x0,'totalTokens':_0x2aa8e5,'model':_0x1fc04e,'role':'user','groupId':_0x21a25a,'requestOptions':JSON[_0x31b491(0x241)]({'options':null,'prompt':_0x5756b6})}),await this[_0x31b491(0x193)][_0x31b491(0x1a2)]({'appId':_0xd8abab,'curIp':_0x447506,'userId':_0x87f9c7[_0x31b491(0x1a8)]['id'],'type':balance_constant_1[_0x31b491(0x1cf)][_0x31b491(0x1da)],'prompt':_0x5756b6,'answer':_0x658e3f===null||_0x658e3f===void 0x0?void 0x0:_0x658e3f[_0x31b491(0x1c0)],'promptTokens':_0x2aa8e5,'completionTokens':_0x25ec26,'totalTokens':_0x52be35,'model':_0x1fc04e,'role':'assistant','groupId':_0x21a25a,'requestOptions':JSON[_0x31b491(0x241)]({'options':{'model':_0x1fc04e,'temperature':_0x3c246e},'prompt':_0x5756b6}),'conversationOptions':JSON['stringify']({'conversationId':_0x658e3f===null||_0x658e3f===void 0x0?void 0x0:_0x658e3f['conversationId'],'model':_0x1fc04e,'parentMessageId':_0x658e3f===null||_0x658e3f===void 0x0?void 0x0:_0x658e3f['id'],'temperature':_0x3c246e})});let _0x4c3d5b=_0x31ea7c;_0x46e110===!![]&&(_0x4c3d5b=Math[_0x31b491(0x1a0)](_0x31ea7c*_0x52be35/_0x1f3f12)),await this[_0x31b491(0x21c)][_0x31b491(0x20f)](_0x87f9c7[_0x31b491(0x1a8)]['id'],_0x31b491(0x214)+(_0x37306c===0x1?0x3:0x4),_0x4c3d5b,_0x52be35);});if(Number(_0x44a8c8)===0x1){const {key:_0x86add4,maxToken:_0x107754,maxTokenRes:_0x17f4ea,proxyResUrl:_0x35ec83}=await this[_0x53754e(0x198)](_0x22bebf),{parentMessageId:_0x473405,completionParams:_0x5d187f,systemMessage:_0x4f9f24}=_0x1fa06d,{model:_0x36b885,temperature:_0x44af7c}=_0x5d187f,{context:_0x377a9c}=await this['nineStore'][_0x53754e(0x1ca)](_0x440e3d?_0x2496c7:_0x5756b6,{'parentMessageId':_0x473405,'systemMessage':_0x4f9f24,'maxModelToken':_0x107754,'maxResponseTokens':_0x17f4ea,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x3840af),'imageUrl':_0x28fb05,'activeModel':_0x1fd49f});let _0x240017=!![];_0x6892aa=await(0x0,openai_1[_0x53754e(0x1e6)])(_0x377a9c,{'maxToken':_0x107754,'maxTokenRes':_0x17f4ea,'apiKey':_0x9edab9,'model':_0x36b885,'prompt':_0x5756b6,'activeModel':_0x1fd49f,'imageUrl':_0x28fb05,'temperature':_0x44af7c,'proxyUrl':_0x35ec83,'onProgress':_0x5e1a2e=>{const _0x34d4ec=_0x53754e;_0x98c566[_0x34d4ec(0x18c)](_0x240017?JSON[_0x34d4ec(0x241)](_0x5e1a2e):'\x0a'+JSON['stringify'](_0x5e1a2e)),_0x658e3f=_0x5e1a2e,_0x240017=![];}},this[_0x53754e(0x1b6)]),_0x5b0647=!![];}if(Number(_0x44a8c8)===0x2){let _0x105abe=!![];const {context:_0x16f533}=await this[_0x53754e(0x263)]['buildMessageFromParentMessageId'](_0x440e3d?_0x2496c7:_0x5756b6,{'parentMessageId':_0x2ae06e,'maxRounds':(0x0,helper_1[_0x53754e(0x1b0)])(_0x3840af)});_0x6892aa=await(0x0,baidu_1[_0x53754e(0x242)])(_0x440e3d?_0x2496c7:_0x16f533,{'temperature':_0x3c246e,'accessToken':_0x3b5f79,'model':_0x1fc04e,'onProgress':_0x21c38b=>{const _0x2942a8=_0x53754e;_0x98c566['write'](_0x105abe?JSON[_0x2942a8(0x241)](_0x21c38b):'\x0a'+JSON[_0x2942a8(0x241)](_0x21c38b)),_0x105abe=![],_0x658e3f=_0x21c38b;}}),_0x5b0647=!![];}if(Number(_0x44a8c8)===0x3){let _0x15d4b5=!![];const {context:_0x4e2870}=await this[_0x53754e(0x263)][_0x53754e(0x1ca)](_0x440e3d?_0x2496c7:_0x5756b6,{'parentMessageId':_0x2ae06e,'maxRounds':(0x0,helper_1[_0x53754e(0x1b0)])(_0x3840af)});_0x6892aa=await(0x0,zhipu_1[_0x53754e(0x233)])(_0x440e3d?_0x2496c7:_0x4e2870,{'temperature':_0x3c246e,'key':_0x3484dc,'model':_0x1fc04e,'onProgress':_0x448521=>{const _0x4b93da=_0x53754e;_0x98c566[_0x4b93da(0x18c)](_0x15d4b5?JSON['stringify'](_0x448521):'\x0a'+JSON[_0x4b93da(0x241)](_0x448521)),_0x15d4b5=![],_0x658e3f=_0x448521;}}),_0x5b0647=!![];}const _0x2b049e={'id':this[_0x53754e(0x263)][_0x53754e(0x264)](),'text':_0x5756b6,'role':_0x53754e(0x1a8),'name':undefined,'usage':null,'imageUrl':_0x28fb05,'activeModel':_0x1fd49f,'parentMessageId':_0x2ae06e,'conversationId':_0x6892aa===null||_0x6892aa===void 0x0?void 0x0:_0x6892aa['conversationId']};_0x32eced={'model':_0x1fc04e,'parentMessageId':_0x2ae06e},await this['nineStore'][_0x53754e(0x252)](_0x2b049e);const _0x4c6162={'id':_0x6892aa['id'],'text':_0x6892aa[_0x53754e(0x1c0)],'role':_0x53754e(0x206),'name':undefined,'usage':_0x6892aa===null||_0x6892aa===void 0x0?void 0x0:_0x6892aa[_0x53754e(0x1ba)],'imageUrl':_0x28fb05,'parentMessageId':_0x2b049e['id'],'conversationId':_0x6892aa===null||_0x6892aa===void 0x0?void 0x0:_0x6892aa[_0x53754e(0x1ae)]};await this[_0x53754e(0x263)]['setData'](_0x4c6162),_0x32eced={'model':_0x1fc04e,'parentMessageId':_0x2b049e['id']};}else{const {key:_0x277540,maxToken:_0x4d4cda,maxTokenRes:_0x1d71ad,proxyResUrl:_0x4f788b}=await this[_0x53754e(0x198)](_0x22bebf),{parentMessageId:_0x5325e4,completionParams:_0x2befda,systemMessage:_0x5b23fb}=_0x1fa06d,{model:_0x567eb3,temperature:_0x590029}=_0x2befda,{context:_0x3d1a6d}=await this[_0x53754e(0x263)][_0x53754e(0x1ca)](_0x440e3d?_0x2496c7:_0x5756b6,{'parentMessageId':_0x5325e4,'systemMessage':_0x5b23fb,'maxRounds':(0x0,helper_1[_0x53754e(0x1b0)])(_0x3840af)});_0x6892aa=await(0x0,openai_1[_0x53754e(0x1e6)])(_0x3d1a6d,{'apiKey':_0x9edab9,'model':_0x567eb3,'temperature':_0x590029,'proxyUrl':_0x4f788b,'onProgress':null,'prompt':_0x5756b6});}let _0x382d5b=null,_0x5c05a7=null;_0x1fc04e['includes']('dall')?_0x382d5b=((_0x2d3a13=_0x6892aa[_0x53754e(0x222)])===null||_0x2d3a13===void 0x0?void 0x0:_0x2d3a13[_0x53754e(0x1ba)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x5c05a7=await(0x0,helper_1[_0x53754e(0x284)])(_0x44a8c8,_0x6892aa,_0x32eced);const {prompt_tokens:_0x2cb6d6,completion_tokens:_0x511345,total_tokens:_0x31c4c0}=_0x1fc04e[_0x53754e(0x243)](_0x53754e(0x1b8))?_0x382d5b:_0x5c05a7[_0x53754e(0x1ba)];let _0x31087e=_0x31ea7c;_0x46e110===!![]&&(_0x31087e=Math[_0x53754e(0x1a0)](_0x31ea7c*_0x31c4c0/_0x1f3f12));await this[_0x53754e(0x21c)]['deductFromBalance'](_0x87f9c7[_0x53754e(0x1a8)]['id'],_0x53754e(0x214)+(_0x37306c===0x1?0x3:0x4),_0x31087e,_0x31c4c0),await this['modelsService'][_0x53754e(0x247)](_0x796523,_0x31c4c0);const _0x5da13a=(0x0,utils_1[_0x53754e(0x190)])(_0x87f9c7);await this['chatLogService']['saveChatLog']({'appId':_0xd8abab,'curIp':_0x5da13a,'userId':_0x87f9c7[_0x53754e(0x1a8)]['id'],'type':balance_constant_1[_0x53754e(0x1cf)][_0x53754e(0x1da)],'prompt':_0x5756b6,'imageUrl':_0x28fb05,'activeModel':_0x1fd49f,'answer':'','promptTokens':_0x2cb6d6,'completionTokens':0x0,'totalTokens':_0x31c4c0,'model':_0x1fc04e,'role':_0x53754e(0x1a8),'groupId':_0x21a25a,'requestOptions':JSON[_0x53754e(0x241)]({'options':null,'prompt':_0x5756b6})}),await this[_0x53754e(0x193)][_0x53754e(0x1a2)]({'appId':_0xd8abab,'curIp':_0x5da13a,'userId':_0x87f9c7[_0x53754e(0x1a8)]['id'],'type':balance_constant_1['DeductionKey'][_0x53754e(0x1da)],'prompt':_0x5756b6,'imageUrl':_0x6892aa===null||_0x6892aa===void 0x0?void 0x0:_0x6892aa[_0x53754e(0x1ec)],'answer':_0x6892aa[_0x53754e(0x1c0)],'promptTokens':_0x2cb6d6,'completionTokens':_0x511345,'totalTokens':_0x31c4c0,'model':_0x1fc04e,'role':_0x53754e(0x206),'groupId':_0x21a25a,'requestOptions':JSON['stringify']({'options':{'model':_0x1fc04e,'temperature':_0x3c246e},'prompt':_0x5756b6}),'conversationOptions':JSON[_0x53754e(0x241)]({'conversationId':_0x6892aa[_0x53754e(0x1ae)],'model':_0x1fc04e,'parentMessageId':_0x6892aa['id'],'temperature':_0x3c246e})}),common_1[_0x53754e(0x1d7)]['debug'](_0x53754e(0x1f5)+_0x87f9c7['user']['id']+'\x20模型名称:\x20'+_0x193d5e+'-'+_0x1fd49f+_0x53754e(0x184)+_0x31c4c0+_0x53754e(0x1d4)+_0x31087e,_0x53754e(0x285));const _0x354497=await this[_0x53754e(0x21c)]['queryUserBalance'](_0x87f9c7['user']['id']);return _0x6892aa[_0x53754e(0x1b5)]=Object[_0x53754e(0x208)]({},_0x354497),_0x6892aa[_0x53754e(0x269)]&&(_0x6892aa[_0x53754e(0x269)]=''),_0x6892aa['is_end']=!![],_0x98c566?_0x98c566[_0x53754e(0x18c)]('\x0a'+JSON[_0x53754e(0x241)](_0x6892aa)):_0x6892aa[_0x53754e(0x1c0)];}catch(_0x29ce1a){console['log'](_0x53754e(0x1fd),_0x9edab9,_0x29ce1a);const _0x9a6a80=(_0x29ce1a===null||_0x29ce1a===void 0x0?void 0x0:_0x29ce1a['statusCode'])||0x190,_0x5a996c=((_0x32ed65=_0x29ce1a===null||_0x29ce1a===void 0x0?void 0x0:_0x29ce1a[_0x53754e(0x22f)])===null||_0x32ed65===void 0x0?void 0x0:_0x32ed65['status'])||(_0x29ce1a===null||_0x29ce1a===void 0x0?void 0x0:_0x29ce1a['statusCode'])||0x190;console['log'](_0x53754e(0x18b),_0x53754e(0x260),_0x9a6a80,_0x53754e(0x178),_0x29ce1a===null||_0x29ce1a===void 0x0?void 0x0:_0x29ce1a[_0x53754e(0x178)],_0x53754e(0x192),(_0x2c9d4d=_0x29ce1a===null||_0x29ce1a===void 0x0?void 0x0:_0x29ce1a['response'])===null||_0x2c9d4d===void 0x0?void 0x0:_0x2c9d4d[_0x53754e(0x271)],_0x53754e(0x195),(_0x63a956=_0x29ce1a===null||_0x29ce1a===void 0x0?void 0x0:_0x29ce1a['response'])===null||_0x63a956===void 0x0?void 0x0:_0x63a956[_0x53754e(0x195)]);if(_0x29ce1a[_0x53754e(0x195)]&&_0x29ce1a[_0x53754e(0x195)]===0x192){const _0x5d2af2={'message':_0x53754e(0x24d)+_0x29ce1a[_0x53754e(0x178)],'code':0x192};if(_0x98c566)return _0x98c566['write'](JSON[_0x53754e(0x241)](_0x5d2af2));else throw new common_1['HttpException'](_0x29ce1a[_0x53754e(0x178)],common_1[_0x53754e(0x283)]['PAYMENT_REQUIRED']);}if(!_0x5a996c){if(_0x98c566)return _0x98c566[_0x53754e(0x18c)](JSON[_0x53754e(0x241)]({'message':_0x29ce1a[_0x53754e(0x178)],'code':0x1f4}));else throw new common_1[(_0x53754e(0x186))](_0x29ce1a[_0x53754e(0x178)],common_1[_0x53754e(0x283)]['BAD_REQUEST']);}let _0x2270fe=errorMessage_constant_1[_0x53754e(0x1c1)][_0x5a996c]?errorMessage_constant_1[_0x53754e(0x1c1)][_0x5a996c]:_0x53754e(0x27a);(_0x29ce1a===null||_0x29ce1a===void 0x0?void 0x0:_0x29ce1a[_0x53754e(0x178)][_0x53754e(0x243)](_0x53754e(0x1a7)))&&Number(_0x44a8c8)===0x1&&(await this[_0x53754e(0x25c)][_0x53754e(0x249)](_0x796523,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0x2270fe=_0x53754e(0x182));(_0x29ce1a===null||_0x29ce1a===void 0x0?void 0x0:_0x29ce1a[_0x53754e(0x1fe)])===0x1ad&&_0x29ce1a['message'][_0x53754e(0x243)](_0x53754e(0x1b1))&&Number(_0x44a8c8)===0x1&&(await this[_0x53754e(0x25c)][_0x53754e(0x249)](_0x796523,_0x53754e(0x220),-0x3),_0x2270fe=_0x53754e(0x26d));(_0x29ce1a===null||_0x29ce1a===void 0x0?void 0x0:_0x29ce1a[_0x53754e(0x1fe)])===0x1ad&&(_0x29ce1a===null||_0x29ce1a===void 0x0?void 0x0:_0x29ce1a[_0x53754e(0x271)])===_0x53754e(0x273)&&(_0x2270fe=_0x53754e(0x244));(_0x29ce1a===null||_0x29ce1a===void 0x0?void 0x0:_0x29ce1a[_0x53754e(0x1fe)])===0x191&&_0x29ce1a[_0x53754e(0x178)]['includes'](_0x53754e(0x1f1))&&Number(_0x44a8c8)===0x1&&(await this['modelsService']['lockKey'](_0x796523,_0x53754e(0x200),-0x2),_0x2270fe=_0x53754e(0x23e));(_0x29ce1a===null||_0x29ce1a===void 0x0?void 0x0:_0x29ce1a[_0x53754e(0x1fe)])===0x194&&_0x29ce1a[_0x53754e(0x178)][_0x53754e(0x243)](_0x53754e(0x25b))&&Number(_0x44a8c8)===0x1&&(await this[_0x53754e(0x25c)][_0x53754e(0x249)](_0x796523,_0x53754e(0x226),-0x4),_0x2270fe=_0x53754e(0x27b));_0x9a6a80===0x190&&console[_0x53754e(0x25f)](_0x53754e(0x218),_0x29ce1a,_0x29ce1a[_0x53754e(0x178)]);const _0x19f642={'message':_0x2270fe||'Please\x20check\x20the\x20back-end\x20console','code':_0x9a6a80===0x191?0x190:_0x9a6a80||0x1f4};if(_0x98c566)return _0x98c566[_0x53754e(0x18c)](JSON[_0x53754e(0x241)](_0x19f642));else throw new common_1[(_0x53754e(0x186))](_0x19f642[_0x53754e(0x178)],common_1[_0x53754e(0x283)][_0x53754e(0x1ef)]);}finally{_0x98c566&&_0x98c566[_0x53754e(0x211)]();}}async['draw'](_0x297d92,_0x4a85d7){const _0xdebe0=_0x5c7b4e;var _0x52e972,_0x2d1334,_0x5ef67b,_0x52dd4f;await this[_0xdebe0(0x280)][_0xdebe0(0x19e)](_0x297d92[_0xdebe0(0x1de)],_0x4a85d7[_0xdebe0(0x1a8)]['id']),await this['userService'][_0xdebe0(0x28d)](_0x4a85d7[_0xdebe0(0x1a8)]);const _0x377718=(_0x297d92===null||_0x297d92===void 0x0?void 0x0:_0x297d92['quality'])==='hd'?0x4:0x2;await this[_0xdebe0(0x21c)][_0xdebe0(0x188)](_0x4a85d7,'mjDraw',_0x377718);let _0x2d8846=[];const _0x4e1e85=await this[_0xdebe0(0x25c)][_0xdebe0(0x278)](_0xdebe0(0x232)),_0x5690d9=_0x4e1e85===null||_0x4e1e85===void 0x0?void 0x0:_0x4e1e85['id'],{key:_0x1eaad9,proxyResUrl:_0x5dddf2}=await this[_0xdebe0(0x198)](_0x4e1e85);common_1[_0xdebe0(0x1d7)][_0xdebe0(0x25f)](_0xdebe0(0x1e9)+_0x297d92['prompt']+',\x20key\x20===>\x20'+_0x1eaad9,_0xdebe0(0x251));try{const _0x4932e6=_0x5dddf2+_0xdebe0(0x28e),_0x410f70=Object[_0xdebe0(0x208)](Object['assign']({},_0x297d92),{'model':'dall-e-3'});console[_0xdebe0(0x25f)](_0xdebe0(0x187),_0x410f70);const _0x589a88=await axios_1[_0xdebe0(0x277)][_0xdebe0(0x199)](_0x4932e6,Object['assign'](Object['assign']({},_0x410f70),{'response_format':_0xdebe0(0x21d)}),{'headers':{'Authorization':_0xdebe0(0x227)+_0x1eaad9}});_0x2d8846=_0x589a88[_0xdebe0(0x270)][_0xdebe0(0x270)];const _0x1fdd32=[];for(const _0x18272e of _0x2d8846){const _0x2614d0=uuid['v4']()['slice'](0x0,0xa)+_0xdebe0(0x25d),_0x3bbba7=Buffer['from'](_0x18272e[_0xdebe0(0x21d)],_0xdebe0(0x1f4));_0x1fdd32[_0xdebe0(0x236)](this['uploadService'][_0xdebe0(0x1f9)]({'filename':_0x2614d0,'buffer':_0x3bbba7}));}const _0x19aa5c=await Promise[_0xdebe0(0x259)](_0x1fdd32);await this[_0xdebe0(0x21c)]['deductFromBalance'](_0x4a85d7[_0xdebe0(0x1a8)]['id'],_0xdebe0(0x1f8),(_0x410f70===null||_0x410f70===void 0x0?void 0x0:_0x410f70[_0xdebe0(0x18e)])===_0xdebe0(0x1ff)?0x2:0x4,_0x377718);const _0x4c4131=(0x0,utils_1['getClientIp'])(_0x4a85d7),_0x55648f=[],_0x5247b4=await this[_0xdebe0(0x1b6)][_0xdebe0(0x237)](),[_0x4402d5,_0x42f954]=_0x297d92[_0xdebe0(0x21e)][_0xdebe0(0x229)]('x');return _0x19aa5c[_0xdebe0(0x181)](_0x273023=>{const _0x4aa397=_0xdebe0;_0x55648f[_0x4aa397(0x236)](this[_0x4aa397(0x193)][_0x4aa397(0x1a2)]({'curIp':_0x4c4131,'userId':_0x4a85d7['user']['id'],'type':balance_constant_1['DeductionKey'][_0x4aa397(0x268)],'prompt':_0x297d92[_0x4aa397(0x1de)],'answer':_0x273023,'fileInfo':JSON[_0x4aa397(0x241)]({'cosType':_0x5247b4,'width':_0x4402d5,'height':_0x42f954,'cosUrl':_0x273023}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x4aa397(0x232)}));}),await Promise[_0xdebe0(0x259)](_0x55648f),_0x19aa5c;}catch(_0x4fb3d8){const _0x17be88=((_0x52e972=_0x4fb3d8===null||_0x4fb3d8===void 0x0?void 0x0:_0x4fb3d8[_0xdebe0(0x22f)])===null||_0x52e972===void 0x0?void 0x0:_0x52e972[_0xdebe0(0x195)])||0x1f4;console[_0xdebe0(0x25f)](_0xdebe0(0x1c2),JSON[_0xdebe0(0x241)](_0x4fb3d8),_0x1eaad9,_0x17be88);const _0x2dc23d=(_0x52dd4f=(_0x5ef67b=(_0x2d1334=_0x4fb3d8===null||_0x4fb3d8===void 0x0?void 0x0:_0x4fb3d8['response'])===null||_0x2d1334===void 0x0?void 0x0:_0x2d1334[_0xdebe0(0x270)])===null||_0x5ef67b===void 0x0?void 0x0:_0x5ef67b[_0xdebe0(0x1b4)])===null||_0x52dd4f===void 0x0?void 0x0:_0x52dd4f[_0xdebe0(0x178)];if(_0x17be88===0x1ad)throw new common_1[(_0xdebe0(0x186))](_0xdebe0(0x235),common_1[_0xdebe0(0x283)]['BAD_REQUEST']);if(_0x17be88===0x190&&_0x2dc23d[_0xdebe0(0x243)](_0xdebe0(0x23b)))throw new common_1[(_0xdebe0(0x186))](_0xdebe0(0x1ce),common_1[_0xdebe0(0x283)][_0xdebe0(0x1ef)]);if(_0x17be88===0x190&&_0x2dc23d[_0xdebe0(0x243)](_0xdebe0(0x1bb))){await this['modelsService']['lockKey'](_0x5690d9,_0xdebe0(0x1e2),-0x1);throw new common_1[(_0xdebe0(0x186))](_0xdebe0(0x1d5),common_1[_0xdebe0(0x283)][_0xdebe0(0x1ef)]);}if(_0x17be88===0x1f4)throw new common_1[(_0xdebe0(0x186))]('绘制图片失败，请检查你的提示词是否有非法描述！',common_1[_0xdebe0(0x283)][_0xdebe0(0x1ef)]);if(_0x17be88===0x191)throw new common_1[(_0xdebe0(0x186))](_0xdebe0(0x255),common_1[_0xdebe0(0x283)][_0xdebe0(0x1ef)]);throw new common_1['HttpException'](_0xdebe0(0x1c3),common_1[_0xdebe0(0x283)]['BAD_REQUEST']);}}async[_0x5c7b4e(0x1b2)](){const _0x340fc1=_0x5c7b4e,_0x5bd155=await this[_0x340fc1(0x1dd)]['find']({'where':{'status':0x1},'select':['id',_0x340fc1(0x22e),_0x340fc1(0x26c),_0x340fc1(0x214),_0x340fc1(0x248),'maxResponseTokens','openaiProxyUrl',_0x340fc1(0x209)]}),_0x5f22ce=_0x5bd155[_0x340fc1(0x22d)](_0x1f3822=>_0x1f3822[_0x340fc1(0x214)]['includes']('gpt-3')),_0x466c2c=_0x5bd155['filter'](_0x59c563=>_0x59c563[_0x340fc1(0x214)]['includes'](_0x340fc1(0x223)));this[_0x340fc1(0x1d6)]={'list3':_0x5f22ce,'list4':_0x466c2c};}async[_0x5c7b4e(0x27c)](_0x1d69ae){const _0x34ab4f=_0x5c7b4e,_0x3995a6=await this[_0x34ab4f(0x228)]['getConfigs']([_0x34ab4f(0x265)]);return(_0x1d69ae===null||_0x1d69ae===void 0x0?void 0x0:_0x1d69ae['proxyUrl'])||_0x3995a6||_0x34ab4f(0x1a3);}async[_0x5c7b4e(0x198)](_0xd8dca4){const _0x3769b3=_0x5c7b4e,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x3769b3(0x228)][_0x3769b3(0x272)]([_0x3769b3(0x221),_0x3769b3(0x19a),_0x3769b3(0x1ed),_0x3769b3(0x194),_0x3769b3(0x282),_0x3769b3(0x217),_0x3769b3(0x17b),_0x3769b3(0x210),_0x3769b3(0x265)]);let _0x2aff51=null,_0x803eb9=null,_0x550020=null,{model:_0x5dc200,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x2e9f76}=_0xd8dca4;return _0x5dc200[_0x3769b3(0x213)]()[_0x3769b3(0x243)]('gpt-4')&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x803eb9>=0x1000&&(maxModelTokens=0x1000),_0x2aff51=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x803eb9=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x5dc200[_0x3769b3(0x213)]()[_0x3769b3(0x243)](_0x3769b3(0x253))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x803eb9>=0x4000&&(maxModelTokens=0x4000),_0x2aff51=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x803eb9=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x5dc200[_0x3769b3(0x213)]()[_0x3769b3(0x243)]('1106')&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x803eb9>=0x1000&&(maxModelTokens=0x1000),_0x2aff51=maxModelTokens||0x3ffc,_0x803eb9=maxResponseTokens||0x1000)),_0x5dc200['toLowerCase']()[_0x3769b3(0x243)](_0x3769b3(0x1ad))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x803eb9>=0x7d0&&(maxModelTokens=0x7d0),_0x2aff51=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x803eb9=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x5dc200[_0x3769b3(0x213)]()['includes']('16k')&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x803eb9>=0x2000&&(maxModelTokens=0x2000),_0x2aff51=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x803eb9=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x5dc200[_0x3769b3(0x213)]()[_0x3769b3(0x243)](_0x3769b3(0x231))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x803eb9>=0x1000&&(maxModelTokens=0x1000),_0x2aff51=maxModelTokens||0x4000,_0x803eb9=maxResponseTokens||0x1000)),_0x550020=proxyUrl||openaiBaseUrl||_0x3769b3(0x1a3),_0x803eb9>=_0x2aff51&&(_0x803eb9=Math[_0x3769b3(0x1bc)](_0x2aff51/0x2)),{'key':_0x2e9f76,'maxToken':_0x2aff51,'maxTokenRes':_0x803eb9,'proxyResUrl':_0x550020};}async[_0x5c7b4e(0x281)](_0x5c3e7f,_0x86872d){const _0x1c3a1c=_0x5c7b4e;try{const {name:_0x84c51f,icon:_0x8a010a,order:_0x1ccecf,id:_0x375650,status:_0x584470}=_0x86872d;return _0x375650?await this[_0x1c3a1c(0x1ee)][_0x1c3a1c(0x1fb)]({'id':_0x375650},{'name':_0x84c51f,'icon':_0x8a010a,'order':_0x1ccecf,'status':_0x584470}):await this['chatBoxTypeEntity']['save']({'name':_0x84c51f,'icon':_0x8a010a,'order':_0x1ccecf,'status':_0x584470});}catch(_0x146643){console['log'](_0x1c3a1c(0x1c5),_0x146643);}}async[_0x5c7b4e(0x20c)](_0x54f540,_0x8dabb3){const _0xf183a3=_0x5c7b4e,{id:_0x23b9d5}=_0x8dabb3;if(!_0x23b9d5)throw new common_1[(_0xf183a3(0x186))](_0xf183a3(0x27d),common_1[_0xf183a3(0x283)]['BAD_REQUEST']);const _0x25a2a1=await this[_0xf183a3(0x21a)][_0xf183a3(0x257)]({'where':{'typeId':_0x23b9d5}});if(_0x25a2a1)throw new common_1[(_0xf183a3(0x186))](_0xf183a3(0x26f),common_1[_0xf183a3(0x283)][_0xf183a3(0x1ef)]);return await this[_0xf183a3(0x1ee)][_0xf183a3(0x19d)]({'id':_0x23b9d5});}async[_0x5c7b4e(0x1d8)](){const _0x1fb2ff=_0x5c7b4e;return await this[_0x1fb2ff(0x1ee)]['find']({'order':{'order':_0x1fb2ff(0x17f)}});}async[_0x5c7b4e(0x1a1)](_0x30324c,_0x6b9569){const _0x274d0d=_0x5c7b4e,{title:_0x52d595,prompt:_0x58fac1,appId:_0x1bc835,order:_0x418dea,status:_0x357ef0,typeId:_0x429daf,id:_0x123214,url:_0x3bee23}=_0x6b9569;if(!_0x429daf)throw new common_1[(_0x274d0d(0x186))](_0x274d0d(0x28a),common_1[_0x274d0d(0x283)][_0x274d0d(0x1ef)]);try{const _0x1009e7={'title':_0x52d595,'order':_0x418dea,'status':_0x357ef0,'typeId':_0x429daf,'url':_0x3bee23};return _0x1009e7[_0x274d0d(0x20b)]=_0x1bc835||0x0,_0x1009e7[_0x274d0d(0x1de)]=_0x58fac1||'',_0x123214?await this[_0x274d0d(0x21a)][_0x274d0d(0x1fb)]({'id':_0x123214},_0x1009e7):await this[_0x274d0d(0x21a)][_0x274d0d(0x1e3)](_0x1009e7);}catch(_0x47a988){console[_0x274d0d(0x25f)]('error:\x20',_0x47a988);}}async[_0x5c7b4e(0x19c)](_0x35581b,_0x1bac4c){const _0x3e3228=_0x5c7b4e,{id:_0x3b0d4d}=_0x1bac4c;if(!_0x3b0d4d)throw new common_1[(_0x3e3228(0x186))](_0x3e3228(0x27d),common_1[_0x3e3228(0x283)][_0x3e3228(0x1ef)]);return await this[_0x3e3228(0x21a)]['delete']({'id':_0x3b0d4d});}async[_0x5c7b4e(0x287)](){const _0x165da5=_0x5c7b4e,_0x22caf9=await this[_0x165da5(0x21a)]['find']({'order':{'order':_0x165da5(0x17f)}}),_0xa08236=[...new Set(_0x22caf9[_0x165da5(0x179)](_0xb77c37=>_0xb77c37[_0x165da5(0x20a)]))],_0x21fcd8=[...new Set(_0x22caf9[_0x165da5(0x179)](_0x487e9b=>_0x487e9b[_0x165da5(0x20b)]))],_0x2af1e8=await this[_0x165da5(0x1ee)][_0x165da5(0x250)]({'where':{'id':(0x0,typeorm_1['In'])(_0xa08236)}}),_0x5b2a23=await this['appEntity'][_0x165da5(0x250)]({'where':{'id':(0x0,typeorm_1['In'])(_0x21fcd8)}});return _0x22caf9['map'](_0x414f20=>{const _0x4b24a7=_0x165da5,{typeId:_0x144130,appId:_0x299530}=_0x414f20;return _0x414f20['typeInfo']=_0x2af1e8[_0x4b24a7(0x250)](_0x40df2b=>_0x40df2b['id']===_0x144130),_0x414f20[_0x4b24a7(0x1b3)]=_0x5b2a23['find'](_0x84ab42=>_0x84ab42['id']===_0x299530),_0x414f20;});}async[_0x5c7b4e(0x267)](){const _0x1ed147=_0x5c7b4e,_0x5dd335=await this[_0x1ed147(0x1ee)][_0x1ed147(0x250)]({'order':{'order':_0x1ed147(0x17f)},'where':{'status':!![]}}),_0x1aef35=await this['chatBoxEntity'][_0x1ed147(0x250)]({'where':{'status':!![]}}),_0x4d86f1=[...new Set(_0x1aef35[_0x1ed147(0x179)](_0xafa5b9=>_0xafa5b9[_0x1ed147(0x20b)]))],_0x228787=await this[_0x1ed147(0x275)][_0x1ed147(0x250)]({'where':{'id':(0x0,typeorm_1['In'])(_0x4d86f1)}});return _0x1aef35[_0x1ed147(0x181)](_0x51ee25=>{const _0x1daaa5=_0x1ed147,_0x3b87c5=_0x228787[_0x1daaa5(0x250)](_0x54382c=>_0x54382c['id']===_0x51ee25['appId']);return _0x51ee25[_0x1daaa5(0x17a)]=_0x3b87c5===null||_0x3b87c5===void 0x0?void 0x0:_0x3b87c5['coverImg'],_0x51ee25;}),_0x5dd335[_0x1ed147(0x179)](_0x345a5d=>{const _0x52c39f=_0x1ed147;return _0x345a5d[_0x52c39f(0x238)]=_0x1aef35[_0x52c39f(0x22d)](_0x3b6935=>_0x3b6935[_0x52c39f(0x20a)]===_0x345a5d['id']&&_0x3b6935['status']),_0x345a5d;});}async[_0x5c7b4e(0x23c)](_0x27a349,_0x3dcce3){const _0x8cd2f0=_0x5c7b4e;try{const {name:_0x57655d,icon:_0x1d050c,order:_0x36ecd0,id:_0xaac822,status:_0xd89c8}=_0x3dcce3;return _0xaac822?await this[_0x8cd2f0(0x1ac)][_0x8cd2f0(0x1fb)]({'id':_0xaac822},{'name':_0x57655d,'icon':_0x1d050c,'order':_0x36ecd0,'status':_0xd89c8}):await this[_0x8cd2f0(0x1ac)][_0x8cd2f0(0x1e3)]({'name':_0x57655d,'icon':_0x1d050c,'order':_0x36ecd0,'status':_0xd89c8});}catch(_0x35fd15){console[_0x8cd2f0(0x25f)](_0x8cd2f0(0x1c5),_0x35fd15);}}async[_0x5c7b4e(0x25e)](_0x41e654,_0x5d0e92){const _0x19a06b=_0x5c7b4e,{id:_0x1049e6}=_0x5d0e92;if(!_0x1049e6)throw new common_1['HttpException']('非法操作！',common_1['HttpStatus'][_0x19a06b(0x1ef)]);const _0x33e147=await this['chatBoxEntity'][_0x19a06b(0x257)]({'where':{'typeId':_0x1049e6}});if(_0x33e147)throw new common_1['HttpException']('当前分类下有未处理数据不可移除！',common_1[_0x19a06b(0x283)]['BAD_REQUEST']);return await this[_0x19a06b(0x1ac)][_0x19a06b(0x19d)]({'id':_0x1049e6});}async[_0x5c7b4e(0x1a9)](){const _0x926fd5=_0x5c7b4e;return await this[_0x926fd5(0x1ac)]['find']({'order':{'order':'DESC'}});}async[_0x5c7b4e(0x219)](_0x2ec85f,_0x39157d){const _0x14e486=_0x5c7b4e,{title:_0x5d4153,prompt:_0x32a7d6,appId:_0xd6d035,order:_0x427197,status:_0x1a0e17,typeId:_0x358b72,id:_0x474ceb,url:_0x11cc03}=_0x39157d;if(!_0x358b72)throw new common_1[(_0x14e486(0x186))](_0x14e486(0x28a),common_1[_0x14e486(0x283)][_0x14e486(0x1ef)]);try{const _0x87c4c6={'title':_0x5d4153,'prompt':_0x32a7d6,'order':_0x427197,'status':_0x1a0e17,'typeId':_0x358b72,'url':_0x11cc03};return _0x474ceb?await this[_0x14e486(0x1a5)][_0x14e486(0x1fb)]({'id':_0x474ceb},_0x87c4c6):await this[_0x14e486(0x1a5)][_0x14e486(0x1e3)](_0x87c4c6);}catch(_0x392670){console[_0x14e486(0x25f)]('error:\x20',_0x392670);}}async[_0x5c7b4e(0x21b)](_0x5681ee,_0x19fb5d){const _0x38ce9e=_0x5c7b4e,{id:_0x3a7ba5}=_0x19fb5d;if(!_0x3a7ba5)throw new common_1['HttpException'](_0x38ce9e(0x27d),common_1[_0x38ce9e(0x283)][_0x38ce9e(0x1ef)]);return await this[_0x38ce9e(0x1a5)][_0x38ce9e(0x19d)]({'id':_0x3a7ba5});}async[_0x5c7b4e(0x180)](){const _0x483f91=_0x5c7b4e,_0x3ec3cf=await this[_0x483f91(0x1a5)][_0x483f91(0x250)]({'order':{'order':_0x483f91(0x17f)}}),_0x1bea3e=[...new Set(_0x3ec3cf['map'](_0x2cbee5=>_0x2cbee5[_0x483f91(0x20a)]))],_0x1536f0=await this[_0x483f91(0x1ac)][_0x483f91(0x250)]({'where':{'id':(0x0,typeorm_1['In'])(_0x1bea3e)}});return _0x3ec3cf['map'](_0x50890f=>{const _0x5c860d=_0x483f91,{typeId:_0x5afe1a,appId:_0x466f73}=_0x50890f;return _0x50890f[_0x5c860d(0x1c6)]=_0x1536f0[_0x5c860d(0x250)](_0x3e0052=>_0x3e0052['id']===_0x5afe1a),_0x50890f;});}async['queryChatPreList'](){const _0x589586=_0x5c7b4e,_0x5d41c9=await this[_0x589586(0x1ac)][_0x589586(0x250)]({'order':{'order':_0x589586(0x17f)},'where':{'status':!![]}}),_0x504aa8=await this[_0x589586(0x1a5)][_0x589586(0x250)]({'where':{'status':!![]}});return _0x5d41c9['map'](_0x2b044b=>{const _0x3e25ae=_0x589586;return _0x2b044b[_0x3e25ae(0x238)]=_0x504aa8['filter'](_0xdf8d49=>_0xdf8d49['typeId']===_0x2b044b['id']&&_0xdf8d49[_0x3e25ae(0x195)]),_0x2b044b;});}async[_0x5c7b4e(0x1f3)](_0x1210b8,_0x1929cf,_0x238370){const _0x300e8a=_0x5c7b4e;let _0xc0c843=0x1000,_0x5886d8=0x800;return _0x1210b8[_0x300e8a(0x213)]()[_0x300e8a(0x243)]('gpt-4')&&(_0xc0c843=_0x1929cf>=0x2004?0x2004:_0x1929cf,_0x5886d8=_0x238370>=0x1000?0x1000:_0x238370,_0x1210b8[_0x300e8a(0x213)]()[_0x300e8a(0x243)](_0x300e8a(0x253))&&(_0xc0c843=_0x1929cf>=0x8000?0x8000:_0x1929cf,_0x5886d8=_0x238370>=0x3e80?0x3e80:_0x238370),(_0x1210b8[_0x300e8a(0x213)]()[_0x300e8a(0x243)](_0x300e8a(0x207))||_0x1210b8['toLowerCase']()[_0x300e8a(0x243)](_0x300e8a(0x224)))&&(_0xc0c843=_0x1929cf>=0x1f400?0x1f400:_0x1929cf,_0x5886d8=_0x238370>=0x1000?0x1000:_0x238370)),_0x1210b8[_0x300e8a(0x213)]()[_0x300e8a(0x243)]('gpt-3')&&(_0xc0c843=_0x1929cf>=0x1000?0x1000:_0x1929cf,_0x5886d8=_0x238370>=0x800?0x800:_0x238370,_0x1210b8[_0x300e8a(0x213)]()[_0x300e8a(0x243)]('16k')&&(_0xc0c843=_0x1929cf>=0x4000?0x4000:_0x1929cf,_0x5886d8=_0x238370>=0x1f40?0x1f40:_0x238370),_0x1210b8['toLowerCase']()[_0x300e8a(0x243)](_0x300e8a(0x231))&&(_0xc0c843=_0x1929cf>=0x4000?0x4000:_0x1929cf,_0x5886d8=_0x238370>=0x1f40?0x1f40:_0x238370)),{'maxToken':_0xc0c843,'maxRes':_0x5886d8};}};ChatgptService=__decorate([(0x0,common_1[_0x5c7b4e(0x1e1)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(gptkeys_entity_1[_0x5c7b4e(0x1dc)])),__param(0x1,(0x0,typeorm_2[_0x5c7b4e(0x1bd)])(config_entity_1[_0x5c7b4e(0x1e0)])),__param(0x2,(0x0,typeorm_2['InjectRepository'])(chatBoxType_entity_1[_0x5c7b4e(0x18f)])),__param(0x3,(0x0,typeorm_2['InjectRepository'])(chatBox_entity_1['ChatBoxEntity'])),__param(0x4,(0x0,typeorm_2['InjectRepository'])(app_entity_1[_0x5c7b4e(0x23a)])),__param(0x5,(0x0,typeorm_2[_0x5c7b4e(0x1bd)])(chatPreType_entity_1[_0x5c7b4e(0x191)])),__param(0x6,(0x0,typeorm_2[_0x5c7b4e(0x1bd)])(chatPre_entity_1[_0x5c7b4e(0x1f2)])),__metadata(_0x5c7b4e(0x24c),[typeorm_1['Repository'],typeorm_1[_0x5c7b4e(0x22c)],typeorm_1['Repository'],typeorm_1[_0x5c7b4e(0x22c)],typeorm_1[_0x5c7b4e(0x22c)],typeorm_1[_0x5c7b4e(0x22c)],typeorm_1[_0x5c7b4e(0x22c)],nestjs_config_1[_0x5c7b4e(0x286)],userBalance_service_1[_0x5c7b4e(0x17d)],chatLog_service_1[_0x5c7b4e(0x289)],user_service_1[_0x5c7b4e(0x230)],upload_service_1['UploadService'],badwords_service_1['BadwordsService'],autoreply_service_1[_0x5c7b4e(0x262)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0x5c7b4e(0x23f)],chatGroup_service_1['ChatGroupService'],models_service_1[_0x5c7b4e(0x1d1)]])],ChatgptService),exports[_0x5c7b4e(0x285)]=ChatgptService;