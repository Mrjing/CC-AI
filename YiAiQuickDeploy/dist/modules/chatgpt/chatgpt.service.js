'use strict';const _0x4db944=_0x21a7;(function(_0x2ded0d,_0x3a56b6){const _0x545418=_0x21a7,_0x51f6c2=_0x2ded0d();while(!![]){try{const _0x1ac08a=-parseInt(_0x545418(0x19a))/0x1+parseInt(_0x545418(0x11a))/0x2*(-parseInt(_0x545418(0xf3))/0x3)+-parseInt(_0x545418(0x15f))/0x4+parseInt(_0x545418(0x18e))/0x5+-parseInt(_0x545418(0x1a4))/0x6*(-parseInt(_0x545418(0x198))/0x7)+parseInt(_0x545418(0x124))/0x8+-parseInt(_0x545418(0x174))/0x9;if(_0x1ac08a===_0x3a56b6)break;else _0x51f6c2['push'](_0x51f6c2['shift']());}catch(_0xa9fb77){_0x51f6c2['push'](_0x51f6c2['shift']());}}}(_0x27c4,0x3bafb));var __decorate=this&&this['__decorate']||function(_0x58ebef,_0xa4e18,_0x3632f3,_0x43a4d2){const _0x4f75a6=_0x21a7;var _0x5059e4=arguments['length'],_0x26dac4=_0x5059e4<0x3?_0xa4e18:_0x43a4d2===null?_0x43a4d2=Object[_0x4f75a6(0x176)](_0xa4e18,_0x3632f3):_0x43a4d2,_0xa8dcd5;if(typeof Reflect===_0x4f75a6(0x119)&&typeof Reflect[_0x4f75a6(0x15e)]===_0x4f75a6(0xdd))_0x26dac4=Reflect['decorate'](_0x58ebef,_0xa4e18,_0x3632f3,_0x43a4d2);else{for(var _0x115e04=_0x58ebef['length']-0x1;_0x115e04>=0x0;_0x115e04--)if(_0xa8dcd5=_0x58ebef[_0x115e04])_0x26dac4=(_0x5059e4<0x3?_0xa8dcd5(_0x26dac4):_0x5059e4>0x3?_0xa8dcd5(_0xa4e18,_0x3632f3,_0x26dac4):_0xa8dcd5(_0xa4e18,_0x3632f3))||_0x26dac4;}return _0x5059e4>0x3&&_0x26dac4&&Object['defineProperty'](_0xa4e18,_0x3632f3,_0x26dac4),_0x26dac4;},__metadata=this&&this[_0x4db944(0x197)]||function(_0x476673,_0x22c1ef){const _0x50206a=_0x4db944;if(typeof Reflect===_0x50206a(0x119)&&typeof Reflect[_0x50206a(0x1bf)]===_0x50206a(0xdd))return Reflect[_0x50206a(0x1bf)](_0x476673,_0x22c1ef);},__param=this&&this['__param']||function(_0x524f3f,_0x2d1695){return function(_0xabf025,_0x281852){_0x2d1695(_0xabf025,_0x281852,_0x524f3f);};};function _0x21a7(_0x553426,_0x49f01b){const _0x27c4e7=_0x27c4();return _0x21a7=function(_0x21a715,_0x5cdb5b){_0x21a715=_0x21a715-0xd4;let _0x15f965=_0x27c4e7[_0x21a715];return _0x15f965;},_0x21a7(_0x553426,_0x49f01b);}Object[_0x4db944(0x13d)](exports,_0x4db944(0x1d1),{'value':!![]}),exports[_0x4db944(0x183)]=void 0x0;const upload_service_1=require(_0x4db944(0x1bb)),user_service_1=require(_0x4db944(0x156)),nestjs_config_1=require('nestjs-config'),common_1=require(_0x4db944(0x1ab)),errorMessage_constant_1=require(_0x4db944(0x16e)),utils_1=require('../../common/utils'),axios_1=require(_0x4db944(0x1a1)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require(_0x4db944(0x171)),chatLog_service_1=require(_0x4db944(0x191)),uuid=require('uuid'),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require(_0x4db944(0x13b)),typeorm_2=require(_0x4db944(0x192)),badwords_service_1=require(_0x4db944(0x1d6)),autoreply_service_1=require(_0x4db944(0x106)),gptkeys_entity_1=require(_0x4db944(0xee)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),fanyi_service_1=require(_0x4db944(0x13a)),app_entity_1=require('../app/app.entity'),chatGroup_service_1=require('../chatGroup/chatGroup.service'),models_service_1=require(_0x4db944(0x10f)),baidu_1=require(_0x4db944(0x121)),helper_1=require('./helper'),store_1=require(_0x4db944(0x109)),zhipu_1=require(_0x4db944(0x195)),openai_1=require(_0x4db944(0x18d)),chatBoxType_entity_1=require(_0x4db944(0xdb)),chatBox_entity_1=require(_0x4db944(0x1bc)),chatPre_entity_1=require(_0x4db944(0x1b5)),chatPreType_entity_1=require(_0x4db944(0xd6));function _0x27c4(){const _0x1e37cb=['openaiModel3MaxTokens','removeSpecialCharacters','Bearer\x20','push','userBanance','chatgpt-ai-web','ceil','sendMessageFromBaidu','../autoreply/autoreply.service','UserBalanceService','assign','./store','当前模型key已被封禁','modelsService','DeductionKey','setChatBox','chatGroupService','../models/models.service','env','status','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','BadwordsService','Please\x20check\x20the\x20back-end\x20console','getClientIp','PAYMENT_REQUIRED','log','Billing\x20hard\x20limit\x20has\x20been\x20reached','object','53182JyJXyC','abort','ModelsService','end','DESC','ChatBoxTypeEntity','result','./baidu','filter','post','2026784VKBNaT','chatProcess','validateBalance','getBaseConfig','default','unifiedFormattingResponse','model3','findOne','draw','chatSyncFree','saveUseLog','openaiTimeoutMs','saveChatLog','autoreplyService','提供了错误的模型秘钥','appInfo','https://api.openai.com','32k','gpt-3','ConfigService','openaiProxyUrl','1106','../fanyi/fanyi.service','typeorm','queryChatPreList','defineProperty','map','sendMessageFromZhipu','close','getAllKeyList','appEntity','chatLogService','onModuleInit','GlobalConfigService','user','all','openaiBaseUrl','update','checkBadWords','b64_json','stringify','standard','badwordsService',',\x20消耗积分：\x20','quality','model4','billing','REDIS_PASSWORD','nineStore','setChatPreType','./../user/user.service',',\x20消耗token:\x20','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','compileNetwork','forEach','configService','REDIS_PORT','error','decorate','642320ghPRdY','HttpStatus','imageUrl','Logger','proxyUrl','chatPreTypeEntity','gpt-4-1106','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','openai-draw\x20error:\x20','error:\x20','getRequestParams','ChatPreTypeEntity','base64','write','\x20模型名称:\x20','../../common/constants/errorMessage.constant','OpenAiErrorCodeMessage','queryChatBoxType','../../common/constants/balance.constant','PAINT_TYPE','chat-error-detail\x20\x20<----------------------------------------->','2599983sNoHJz','当前模型key余额已耗尽','getOwnPropertyDescriptor','绘制图片失败，此次绘画被拒绝了！','setData','fanyiService','debug','dall-e-3','delChatPre','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','userService','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','statusText:','checkUserStatus','abortController','ChatgptService','.png','assistant','16k','当前Key余额已不足、请重新再试一次吧！','code:\x20','prompt','UserService','split','data','./openai','2424825vuuGvP','delChatPreType','addOneIfOdd','../chatLog/chatLog.service','@nestjs/typeorm','uploadFile','GptKeysEntity','./zhipu','queryChatPreType','__metadata','33593IZfpUJ','非法操作！','283928nructD','openaiModel4MaxTokens','nineai-chatlog','REDIS_USER','buildMessageFromParentMessageId','当前请求已过载、请稍等会儿再试试吧！','keyPool','axios','openaiModel4MaxTokens32kRes','FanyiService','366kUskMV','find','size','coverImg','\x0a\x20Current\x20date:\x20','appId','当前模型调用过于频繁、请重新试试吧！','@nestjs/common','preset','mjDraw','Incorrect\x20API\x20key\x20provided','NineStore','systemMessage','AutoreplyService','checkAutoReply','CHAT_TYPE','childList','./chatPre.entity','setChatBoxType','getGroupInfoFromId','typeId','ChatPreEntity','setChatPre','./../upload/upload.service','./chatBox.entity','openaiModel3MaxTokensRes','ChatGroupService','metadata','getConfigs','Catch\x20Error\x20','chatBoxTypeEntity','HttpException','delete','getModelProxyUrl','dall-e\x20draw\x20params:\x20','sendMessageFromOpenAi','importDynamic','BAD_REQUEST','globalConfigService','Injectable','chatBoxEntity','redis://','Repository','服务异常、请重新试试吧！！！','includes','__esModule','systemPreMessage','dall','weight','delChatBoxType','../badwords/badwords.service','chatPreEntity','getCurrentModelKeyInfo','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','statusCode','./chatPreType.entity','userBalanceService','statusText','floor','typeInfo','./chatBoxType.entity','is_end','function','UploadService','keyv','modelInfo','toLowerCase','lockKey','formatModelToken','message','ConfigEntity','queryChatBoxFrontend','getRandomDrawKey','queryChatBox','getMaxTokenFromModelWithOpenAi','deductFromBalance','count','save','text','./gptkeys.entity','design:paramtypes','getTokenCount','model','缺失必要参数！','6ReeRkh','openaiModel3MaxTokens16k','conversationId','uploadService','用户ID:\x20','gpt-4','toISOString','usage','slice','InjectRepository','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！'];_0x27c4=function(){return _0x1e37cb;};return _0x27c4();}let ChatgptService=class ChatgptService{constructor(_0xab48f2,_0x5db164,_0x1adb9f,_0x2cec50,_0x561e5e,_0x1f9973,_0x44208c,_0x4c9ba4,_0x5aa1ca,_0x1a714b,_0x45d3bf,_0xa01fc8,_0x2b57d8,_0x1acb6f,_0x6353a6,_0x4abe11,_0x3f04ef,_0x172ea0){const _0x3574c3=_0x4db944;this['gptKeysEntity']=_0xab48f2,this['configEntity']=_0x5db164,this[_0x3574c3(0x1c2)]=_0x1adb9f,this['chatBoxEntity']=_0x2cec50,this['appEntity']=_0x561e5e,this[_0x3574c3(0x164)]=_0x1f9973,this['chatPreEntity']=_0x44208c,this[_0x3574c3(0x15b)]=_0x4c9ba4,this['userBalanceService']=_0x5aa1ca,this['chatLogService']=_0x1a714b,this[_0x3574c3(0x17e)]=_0x45d3bf,this[_0x3574c3(0xf6)]=_0xa01fc8,this[_0x3574c3(0x14e)]=_0x2b57d8,this[_0x3574c3(0x131)]=_0x1acb6f,this[_0x3574c3(0x1ca)]=_0x6353a6,this[_0x3574c3(0x179)]=_0x4abe11,this[_0x3574c3(0x10e)]=_0x3f04ef,this[_0x3574c3(0x10b)]=_0x172ea0,this[_0x3574c3(0x154)]=null,this['whiteListUser']=[],this['keyPool']={'list3':[],'list4':[]};}async[_0x4db944(0x144)](){const _0x248838=_0x4db944;let _0xdc118a=await(0x0,utils_1[_0x248838(0x1c8)])(_0x248838(0x103)),_0x3ae756=await(0x0,utils_1['importDynamic'])('@keyv/redis'),_0x16ac47=await(0x0,utils_1[_0x248838(0x1c8)])(_0x248838(0xdf));_0xdc118a=(_0xdc118a===null||_0xdc118a===void 0x0?void 0x0:_0xdc118a[_0x248838(0x128)])?_0xdc118a[_0x248838(0x128)]:_0xdc118a,_0x3ae756=(_0x3ae756===null||_0x3ae756===void 0x0?void 0x0:_0x3ae756[_0x248838(0x128)])?_0x3ae756['default']:_0x3ae756,_0x16ac47=(_0x16ac47===null||_0x16ac47===void 0x0?void 0x0:_0x16ac47[_0x248838(0x128)])?_0x16ac47['default']:_0x16ac47;const {ChatGPTAPI:_0x4b42d4,ChatGPTError:_0x7ad560,ChatGPTUnofficialProxyAPI:_0x4ae81b}=_0xdc118a,_0x5b580d=+process[_0x248838(0x110)][_0x248838(0x15c)],_0x3a83e3=process[_0x248838(0x110)]['REDIS_HOST'],_0x85acd4=process[_0x248838(0x110)][_0x248838(0x153)],_0x2e753d=process[_0x248838(0x110)][_0x248838(0x19d)],_0x40bee3=_0x248838(0x1cd)+(_0x2e753d||'')+':'+(_0x85acd4||'')+'@'+_0x3a83e3+':'+_0x5b580d,_0x408692=new _0x3ae756(_0x40bee3),_0x50b534=new _0x16ac47({'store':_0x408692,'namespace':_0x248838(0x19c)});this[_0x248838(0x154)]=new store_1[(_0x248838(0x1af))]({'store':_0x50b534,'namespace':'chat'});}async[_0x4db944(0x169)](_0x22236b,_0x1e755e,_0x3bb81a,_0x1d9247=null){const _0x3efec6=_0x4db944;var _0x41eeb1;!_0x1d9247&&(_0x1d9247=(_0x41eeb1=await this[_0x3efec6(0x10b)][_0x3efec6(0x127)]())===null||_0x41eeb1===void 0x0?void 0x0:_0x41eeb1[_0x3efec6(0xe0)]);const {timeout:timeout=0x3c}=_0x3bb81a,{topN:_0x2bfc36,model:_0x537408}=_0x1d9247,{parentMessageId:parentMessageId=0x0}=_0x22236b,_0x2cf419=await this['globalConfigService'][_0x3efec6(0x1c0)]([_0x3efec6(0x12f)]),_0x4f236b=timeout*0x3e8||_0x2cf419||0x64*0x3e8,_0x1ead6b={'parentMessageId':parentMessageId,'timeoutMs':+_0x4f236b,'completionParams':{'model':_0x537408,'temperature':_0x2bfc36}};return _0x1e755e&&(_0x1ead6b[_0x3efec6(0x1b0)]=_0x1e755e),_0x1ead6b;}async[_0x4db944(0x12d)](_0xf21dfc){const _0x2efc4e=_0x4db944,_0x585d8f=await this['modelsService']['getRandomDrawKey'](),_0x3f3bff=await this[_0x2efc4e(0x1ca)][_0x2efc4e(0x1c0)]([_0x2efc4e(0x1d2)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x228e63,model:_0x560cc6}=_0x585d8f,_0x4f11e1=await this['getModelProxyUrl'](_0x585d8f),{context:_0x385165}=await this[_0x2efc4e(0x154)][_0x2efc4e(0x19e)](_0xf21dfc,{'parentMessageId':'','systemMessage':_0x3f3bff});try{const _0x146f74=await(0x0,openai_1[_0x2efc4e(0x1c7)])(_0x385165,{'apiKey':(0x0,utils_1[_0x2efc4e(0xff)])(_0x228e63),'model':_0x560cc6,'proxyUrl':_0x4f11e1,'onProgress':null});return _0x146f74===null||_0x146f74===void 0x0?void 0x0:_0x146f74[_0x2efc4e(0xed)];}catch(_0x2b1793){console[_0x2efc4e(0x117)](_0x2efc4e(0x168),_0x2b1793);}}async[_0x4db944(0x125)](_0x5854e2,_0x806c5,_0x39a212){const _0x490d33=_0x4db944;var _0x1c5f60,_0x1932f6,_0x4fc856,_0x26557;const _0x533a12=_0x806c5[_0x490d33(0x182)],{options:options={},appId:_0x5b5bca,cusromPrompt:_0x4d6594,systemMessage:systemMessage=''}=_0x5854e2;let _0x4a1743=systemMessage;const {parentMessageId:_0x1e8dfd}=options,{prompt:_0x19ff38,imageUrl:_0x1a3ce9,model:_0x25bceb}=_0x5854e2,{groupId:_0x29b7e,usingNetwork:_0x237153}=options,_0x573c3d=await this[_0x490d33(0x10e)][_0x490d33(0x1b7)](_0x29b7e),_0x6d17d6=(_0x573c3d===null||_0x573c3d===void 0x0?void 0x0:_0x573c3d['config'])?JSON['parse'](_0x573c3d['config']):await this['modelsService']['getBaseConfig'](),{keyType:_0x2ff0af,model:_0x2562ee,topN:_0x2ac029,systemMessage:_0x1bda76,rounds:_0xb3c0c8}=_0x6d17d6[_0x490d33(0xe0)];let _0x34a0df=null;!_0x4d6594?_0x34a0df=await this[_0x490d33(0x10b)][_0x490d33(0x1d8)](_0x2562ee):_0x34a0df=await this['modelsService'][_0x490d33(0xe7)]();if(!_0x34a0df)throw new common_1['HttpException']('当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！',common_1[_0x490d33(0x160)][_0x490d33(0x1c9)]);const {deduct:_0x4b7299,isTokenBased:_0x31c1ac,tokenFeeRatio:_0x5150d5,deductType:_0x207b27,key:_0x3cfbb9,secret:_0x1738fa,modelName:_0x520de5,id:_0x46d34e,accessToken:_0x1d094f}=_0x34a0df;await this[_0x490d33(0x17e)][_0x490d33(0x181)](_0x806c5[_0x490d33(0x146)]),await this[_0x490d33(0xd7)][_0x490d33(0x126)](_0x806c5,_0x207b27===0x1?_0x490d33(0x12a):_0x490d33(0x151),_0x4b7299),_0x39a212&&_0x39a212['setHeader']('Content-type','application/octet-stream;\x20charset=utf-8'),await this[_0x490d33(0x14e)]['checkBadWords'](_0x19ff38,_0x806c5['user']['id']);const _0x15490f=await this['autoreplyService'][_0x490d33(0x1b2)](_0x19ff38);if(_0x15490f&&_0x39a212){const _0x56b65a={'message':_0x15490f,'code':0x1f4};return _0x39a212[_0x490d33(0x16c)](JSON['stringify'](_0x56b65a)),_0x39a212[_0x490d33(0x11d)]();}if(_0x5b5bca){const _0x4af070=await this[_0x490d33(0x142)][_0x490d33(0x12b)]({'where':{'id':_0x5b5bca,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x4af070)throw new common_1[(_0x490d33(0x1c3))](_0x490d33(0x166),common_1[_0x490d33(0x160)][_0x490d33(0x1c9)]);_0x4af070['preset']&&(_0x4a1743=_0x4af070[_0x490d33(0x1ac)]);}else{if(_0x4d6594)_0x4a1743=systemMessage;else{if(_0x1bda76)_0x4a1743=_0x1bda76;else{const _0x4e0352=new Date()[_0x490d33(0xf9)]()['split']('T')[0x0],_0x2fdb8d=await this['globalConfigService'][_0x490d33(0x1c0)]([_0x490d33(0x1d2)]);_0x4a1743=_0x2fdb8d+('\x0a\x20Current\x20date:\x20'+_0x4e0352);}}}let _0x371533='';if(_0x237153){_0x371533=await(0x0,utils_1[_0x490d33(0x159)])(_0x19ff38);const _0x540b0c=new Date()[_0x490d33(0xf9)]()[_0x490d33(0x18b)]('T')[0x0],_0x3bfbab=await this[_0x490d33(0x1ca)][_0x490d33(0x1c0)](['systemPreMessage']);_0x4a1743=_0x3bfbab+(_0x490d33(0x1a8)+_0x540b0c);}const _0x2b1fb4=await this[_0x490d33(0x169)](options,_0x4a1743,_0x34a0df,_0x6d17d6[_0x490d33(0xe0)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x43cba1}=_0x34a0df;_0x39a212&&_0x39a212[_0x490d33(0x111)](0xc8);let _0x6be91e=null,_0x36f73e=null;try{if(_0x39a212){let _0x21bcc4=null,_0x149d08=![];_0x39a212['on'](_0x490d33(0x140),async()=>{const _0x3171d5=_0x490d33;if(_0x149d08)return;_0x533a12[_0x3171d5(0x11b)]();const _0x402eec=await(0x0,openai_1[_0x3171d5(0xf0)])(_0x19ff38)||0x0,_0x14ba11=await(0x0,openai_1[_0x3171d5(0xf0)])(_0x21bcc4===null||_0x21bcc4===void 0x0?void 0x0:_0x21bcc4['text'])||0x0,_0x2842e9=_0x402eec+_0x14ba11,_0x1b569b=(0x0,utils_1['getClientIp'])(_0x806c5);await this['chatLogService'][_0x3171d5(0x130)]({'appId':_0x5b5bca,'curIp':_0x1b569b,'userId':_0x806c5[_0x3171d5(0x146)]['id'],'type':balance_constant_1[_0x3171d5(0x10c)][_0x3171d5(0x1b3)],'prompt':_0x19ff38,'imageUrl':_0x1a3ce9,'activeModel':_0x25bceb,'answer':'','promptTokens':_0x402eec,'completionTokens':0x0,'totalTokens':_0x402eec,'model':_0x2562ee,'role':_0x3171d5(0x146),'groupId':_0x29b7e,'requestOptions':JSON[_0x3171d5(0x14c)]({'options':null,'prompt':_0x19ff38})}),await this[_0x3171d5(0x143)]['saveChatLog']({'appId':_0x5b5bca,'curIp':_0x1b569b,'userId':_0x806c5[_0x3171d5(0x146)]['id'],'type':balance_constant_1[_0x3171d5(0x10c)][_0x3171d5(0x1b3)],'prompt':_0x19ff38,'answer':_0x21bcc4===null||_0x21bcc4===void 0x0?void 0x0:_0x21bcc4[_0x3171d5(0xed)],'promptTokens':_0x402eec,'completionTokens':_0x14ba11,'totalTokens':_0x2842e9,'model':_0x2562ee,'role':_0x3171d5(0x185),'groupId':_0x29b7e,'requestOptions':JSON['stringify']({'options':{'model':_0x2562ee,'temperature':_0x2ac029},'prompt':_0x19ff38}),'conversationOptions':JSON[_0x3171d5(0x14c)]({'conversationId':_0x21bcc4===null||_0x21bcc4===void 0x0?void 0x0:_0x21bcc4[_0x3171d5(0xf5)],'model':_0x2562ee,'parentMessageId':_0x21bcc4===null||_0x21bcc4===void 0x0?void 0x0:_0x21bcc4['id'],'temperature':_0x2ac029})});let _0x308b97=_0x4b7299;_0x31c1ac===!![]&&(_0x308b97=Math[_0x3171d5(0x104)](_0x4b7299*_0x2842e9/_0x5150d5)),await this[_0x3171d5(0xd7)][_0x3171d5(0xea)](_0x806c5[_0x3171d5(0x146)]['id'],_0x3171d5(0xf1)+(_0x207b27===0x1?0x3:0x4),_0x308b97,_0x2842e9);});if(Number(_0x2ff0af)===0x1){const {key:_0x3c3225,maxToken:_0x474ff1,maxTokenRes:_0x13d8a4,proxyResUrl:_0x3a49be}=await this[_0x490d33(0xe3)](_0x34a0df),{parentMessageId:_0x16e39b,completionParams:_0x36e6e2,systemMessage:_0x3982df}=_0x2b1fb4,{model:_0x3938c6,temperature:_0x151ff5}=_0x36e6e2,{context:_0x2c1264}=await this[_0x490d33(0x154)][_0x490d33(0x19e)](_0x237153?_0x371533:_0x19ff38,{'parentMessageId':_0x16e39b,'systemMessage':_0x3982df,'maxModelToken':_0x474ff1,'maxResponseTokens':_0x13d8a4,'maxRounds':(0x0,helper_1[_0x490d33(0x190)])(_0xb3c0c8),'imageUrl':_0x1a3ce9,'activeModel':_0x25bceb});let _0x551da6=!![];_0x6be91e=await(0x0,openai_1[_0x490d33(0x1c7)])(_0x2c1264,{'maxToken':_0x474ff1,'maxTokenRes':_0x13d8a4,'apiKey':_0x3cfbb9,'model':_0x3938c6,'prompt':_0x19ff38,'activeModel':_0x25bceb,'imageUrl':_0x1a3ce9,'temperature':_0x151ff5,'proxyUrl':_0x3a49be,'onProgress':_0xdf2562=>{const _0x16893f=_0x490d33;_0x39a212['write'](_0x551da6?JSON['stringify'](_0xdf2562):'\x0a'+JSON[_0x16893f(0x14c)](_0xdf2562)),_0x21bcc4=_0xdf2562,_0x551da6=![];}},this[_0x490d33(0xf6)]),_0x149d08=!![];}if(Number(_0x2ff0af)===0x2){let _0x26ec73=!![];const {context:_0x204a8e}=await this[_0x490d33(0x154)][_0x490d33(0x19e)](_0x237153?_0x371533:_0x19ff38,{'parentMessageId':_0x1e8dfd,'maxRounds':(0x0,helper_1[_0x490d33(0x190)])(_0xb3c0c8)});_0x6be91e=await(0x0,baidu_1[_0x490d33(0x105)])(_0x237153?_0x371533:_0x204a8e,{'temperature':_0x2ac029,'accessToken':_0x1d094f,'model':_0x2562ee,'onProgress':_0x3bc608=>{const _0x4d1049=_0x490d33;_0x39a212[_0x4d1049(0x16c)](_0x26ec73?JSON['stringify'](_0x3bc608):'\x0a'+JSON[_0x4d1049(0x14c)](_0x3bc608)),_0x26ec73=![],_0x21bcc4=_0x3bc608;}}),_0x149d08=!![];}if(Number(_0x2ff0af)===0x3){let _0x39b8d7=!![];const {context:_0x1528ed}=await this[_0x490d33(0x154)]['buildMessageFromParentMessageId'](_0x237153?_0x371533:_0x19ff38,{'parentMessageId':_0x1e8dfd,'maxRounds':(0x0,helper_1[_0x490d33(0x190)])(_0xb3c0c8)});_0x6be91e=await(0x0,zhipu_1[_0x490d33(0x13f)])(_0x237153?_0x371533:_0x1528ed,{'temperature':_0x2ac029,'key':_0x43cba1,'model':_0x2562ee,'onProgress':_0x43b919=>{const _0x162a70=_0x490d33;_0x39a212[_0x162a70(0x16c)](_0x39b8d7?JSON[_0x162a70(0x14c)](_0x43b919):'\x0a'+JSON['stringify'](_0x43b919)),_0x39b8d7=![],_0x21bcc4=_0x43b919;}}),_0x149d08=!![];}const _0x2ca1d1={'id':this[_0x490d33(0x154)]['getUuid'](),'text':_0x19ff38,'role':_0x490d33(0x146),'name':undefined,'usage':null,'imageUrl':_0x1a3ce9,'activeModel':_0x25bceb,'parentMessageId':_0x1e8dfd,'conversationId':_0x6be91e===null||_0x6be91e===void 0x0?void 0x0:_0x6be91e[_0x490d33(0xf5)]};_0x36f73e={'model':_0x2562ee,'parentMessageId':_0x1e8dfd},await this['nineStore']['setData'](_0x2ca1d1);const _0x43c255={'id':_0x6be91e['id'],'text':_0x6be91e[_0x490d33(0xed)],'role':_0x490d33(0x185),'name':undefined,'usage':_0x6be91e===null||_0x6be91e===void 0x0?void 0x0:_0x6be91e[_0x490d33(0xfa)],'imageUrl':_0x1a3ce9,'parentMessageId':_0x2ca1d1['id'],'conversationId':_0x6be91e===null||_0x6be91e===void 0x0?void 0x0:_0x6be91e['conversationId']};await this['nineStore'][_0x490d33(0x178)](_0x43c255),_0x36f73e={'model':_0x2562ee,'parentMessageId':_0x2ca1d1['id']};}else{const {key:_0x53c6f0,maxToken:_0x522534,maxTokenRes:_0x404f0d,proxyResUrl:_0x19fa79}=await this[_0x490d33(0xe3)](_0x34a0df),{parentMessageId:_0x1742ac,completionParams:_0x12f69f,systemMessage:_0x7e85fc}=_0x2b1fb4,{model:_0x1fd4c8,temperature:_0x4c2251}=_0x12f69f,{context:_0x25415b}=await this['nineStore']['buildMessageFromParentMessageId'](_0x237153?_0x371533:_0x19ff38,{'parentMessageId':_0x1742ac,'systemMessage':_0x7e85fc,'maxRounds':(0x0,helper_1[_0x490d33(0x190)])(_0xb3c0c8)});_0x6be91e=await(0x0,openai_1[_0x490d33(0x1c7)])(_0x25415b,{'apiKey':_0x3cfbb9,'model':_0x1fd4c8,'temperature':_0x4c2251,'proxyUrl':_0x19fa79,'onProgress':null,'prompt':_0x19ff38});}let _0x3126ae=null,_0x1f7605=null;_0x2562ee[_0x490d33(0x1d0)](_0x490d33(0x1d3))?_0x3126ae=((_0x1c5f60=_0x6be91e['detail'])===null||_0x1c5f60===void 0x0?void 0x0:_0x1c5f60[_0x490d33(0xfa)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x1f7605=await(0x0,helper_1[_0x490d33(0x129)])(_0x2ff0af,_0x6be91e,_0x36f73e);const {prompt_tokens:_0x202f84,completion_tokens:_0x5f045a,total_tokens:_0x1d8c6d}=_0x2562ee[_0x490d33(0x1d0)](_0x490d33(0x1d3))?_0x3126ae:_0x1f7605[_0x490d33(0xfa)];let _0x5cd1da=_0x4b7299;_0x31c1ac===!![]&&(_0x5cd1da=Math[_0x490d33(0x104)](_0x4b7299*_0x1d8c6d/_0x5150d5));await this[_0x490d33(0xd7)][_0x490d33(0xea)](_0x806c5['user']['id'],_0x490d33(0xf1)+(_0x207b27===0x1?0x3:0x4),_0x5cd1da,_0x1d8c6d),await this[_0x490d33(0x10b)][_0x490d33(0x12e)](_0x46d34e,_0x1d8c6d);const _0x32cc97=(0x0,utils_1['getClientIp'])(_0x806c5);await this[_0x490d33(0x143)]['saveChatLog']({'appId':_0x5b5bca,'curIp':_0x32cc97,'userId':_0x806c5[_0x490d33(0x146)]['id'],'type':balance_constant_1['DeductionKey'][_0x490d33(0x1b3)],'prompt':_0x19ff38,'imageUrl':_0x1a3ce9,'activeModel':_0x25bceb,'answer':'','promptTokens':_0x202f84,'completionTokens':0x0,'totalTokens':_0x1d8c6d,'model':_0x2562ee,'role':_0x490d33(0x146),'groupId':_0x29b7e,'requestOptions':JSON[_0x490d33(0x14c)]({'options':null,'prompt':_0x19ff38})}),await this[_0x490d33(0x143)][_0x490d33(0x130)]({'appId':_0x5b5bca,'curIp':_0x32cc97,'userId':_0x806c5[_0x490d33(0x146)]['id'],'type':balance_constant_1[_0x490d33(0x10c)][_0x490d33(0x1b3)],'prompt':_0x19ff38,'imageUrl':_0x6be91e===null||_0x6be91e===void 0x0?void 0x0:_0x6be91e[_0x490d33(0x161)],'answer':_0x6be91e[_0x490d33(0xed)],'promptTokens':_0x202f84,'completionTokens':_0x5f045a,'totalTokens':_0x1d8c6d,'model':_0x2562ee,'role':'assistant','groupId':_0x29b7e,'requestOptions':JSON[_0x490d33(0x14c)]({'options':{'model':_0x2562ee,'temperature':_0x2ac029},'prompt':_0x19ff38}),'conversationOptions':JSON[_0x490d33(0x14c)]({'conversationId':_0x6be91e[_0x490d33(0xf5)],'model':_0x2562ee,'parentMessageId':_0x6be91e['id'],'temperature':_0x2ac029})}),common_1[_0x490d33(0x162)][_0x490d33(0x17a)](_0x490d33(0xf7)+_0x806c5[_0x490d33(0x146)]['id']+_0x490d33(0x16d)+_0x520de5+'-'+_0x25bceb+_0x490d33(0x157)+_0x1d8c6d+_0x490d33(0x14f)+_0x5cd1da,_0x490d33(0x183));const _0x31f87c=await this[_0x490d33(0xd7)]['queryUserBalance'](_0x806c5[_0x490d33(0x146)]['id']);return _0x6be91e[_0x490d33(0x102)]=Object[_0x490d33(0x108)]({},_0x31f87c),_0x6be91e[_0x490d33(0x120)]&&(_0x6be91e[_0x490d33(0x120)]=''),_0x6be91e[_0x490d33(0xdc)]=!![],_0x39a212?_0x39a212[_0x490d33(0x16c)]('\x0a'+JSON[_0x490d33(0x14c)](_0x6be91e)):_0x6be91e[_0x490d33(0xed)];}catch(_0x250713){console['log']('chat-error\x20<----------------------------------------->',_0x3cfbb9,_0x250713);const _0x2cf977=(_0x250713===null||_0x250713===void 0x0?void 0x0:_0x250713[_0x490d33(0xd5)])||0x190,_0x311323=((_0x1932f6=_0x250713===null||_0x250713===void 0x0?void 0x0:_0x250713['response'])===null||_0x1932f6===void 0x0?void 0x0:_0x1932f6[_0x490d33(0x111)])||(_0x250713===null||_0x250713===void 0x0?void 0x0:_0x250713['statusCode'])||0x190;console[_0x490d33(0x117)](_0x490d33(0x173),_0x490d33(0x188),_0x2cf977,_0x490d33(0xe4),_0x250713===null||_0x250713===void 0x0?void 0x0:_0x250713[_0x490d33(0xe4)],_0x490d33(0x180),(_0x4fc856=_0x250713===null||_0x250713===void 0x0?void 0x0:_0x250713['response'])===null||_0x4fc856===void 0x0?void 0x0:_0x4fc856[_0x490d33(0xd8)],_0x490d33(0x111),(_0x26557=_0x250713===null||_0x250713===void 0x0?void 0x0:_0x250713['response'])===null||_0x26557===void 0x0?void 0x0:_0x26557[_0x490d33(0x111)]);if(_0x250713['status']&&_0x250713[_0x490d33(0x111)]===0x192){const _0x432750={'message':_0x490d33(0x1c1)+_0x250713[_0x490d33(0xe4)],'code':0x192};if(_0x39a212)return _0x39a212['write'](JSON['stringify'](_0x432750));else throw new common_1[(_0x490d33(0x1c3))](_0x250713[_0x490d33(0xe4)],common_1[_0x490d33(0x160)][_0x490d33(0x116)]);}if(!_0x311323){if(_0x39a212)return _0x39a212['write'](JSON[_0x490d33(0x14c)]({'message':_0x250713['message'],'code':0x1f4}));else throw new common_1[(_0x490d33(0x1c3))](_0x250713[_0x490d33(0xe4)],common_1[_0x490d33(0x160)]['BAD_REQUEST']);}let _0xdaba5e=errorMessage_constant_1[_0x490d33(0x16f)][_0x311323]?errorMessage_constant_1[_0x490d33(0x16f)][_0x311323]:_0x490d33(0x1cf);(_0x250713===null||_0x250713===void 0x0?void 0x0:_0x250713['message'][_0x490d33(0x1d0)](_0x490d33(0xd4)))&&Number(_0x2ff0af)===0x1&&(await this[_0x490d33(0x10b)][_0x490d33(0xe2)](_0x46d34e,_0x490d33(0x17f),-0x1),_0xdaba5e=_0x490d33(0x10a));(_0x250713===null||_0x250713===void 0x0?void 0x0:_0x250713[_0x490d33(0xd5)])===0x1ad&&_0x250713['message']['includes'](_0x490d33(0x152))&&Number(_0x2ff0af)===0x1&&(await this['modelsService'][_0x490d33(0xe2)](_0x46d34e,'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0xdaba5e=_0x490d33(0x175));(_0x250713===null||_0x250713===void 0x0?void 0x0:_0x250713['statusCode'])===0x1ad&&(_0x250713===null||_0x250713===void 0x0?void 0x0:_0x250713[_0x490d33(0xd8)])==='Too\x20Many\x20Requests'&&(_0xdaba5e=_0x490d33(0x1aa));(_0x250713===null||_0x250713===void 0x0?void 0x0:_0x250713[_0x490d33(0xd5)])===0x191&&_0x250713[_0x490d33(0xe4)][_0x490d33(0x1d0)](_0x490d33(0x1ae))&&Number(_0x2ff0af)===0x1&&(await this[_0x490d33(0x10b)][_0x490d33(0xe2)](_0x46d34e,_0x490d33(0x132),-0x2),_0xdaba5e='提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！');(_0x250713===null||_0x250713===void 0x0?void 0x0:_0x250713[_0x490d33(0xd5)])===0x194&&_0x250713[_0x490d33(0xe4)][_0x490d33(0x1d0)](_0x490d33(0x158))&&Number(_0x2ff0af)===0x1&&(await this['modelsService']['lockKey'](_0x46d34e,'当前模型不是聊天模型',-0x4),_0xdaba5e=_0x490d33(0xfd));_0x2cf977===0x190&&console[_0x490d33(0x117)]('400\x20error',_0x250713,_0x250713[_0x490d33(0xe4)]);const _0x3a161a={'message':_0xdaba5e||_0x490d33(0x114),'code':_0x2cf977===0x191?0x190:_0x2cf977||0x1f4};if(_0x39a212)return _0x39a212['write'](JSON[_0x490d33(0x14c)](_0x3a161a));else throw new common_1[(_0x490d33(0x1c3))](_0x3a161a[_0x490d33(0xe4)],common_1[_0x490d33(0x160)][_0x490d33(0x1c9)]);}finally{_0x39a212&&_0x39a212[_0x490d33(0x11d)]();}}async[_0x4db944(0x12c)](_0x2105b8,_0x50500d){const _0x260575=_0x4db944;var _0x5207c1,_0x3a28bd,_0x34240d,_0x57b02f;await this[_0x260575(0x14e)][_0x260575(0x14a)](_0x2105b8[_0x260575(0x189)],_0x50500d[_0x260575(0x146)]['id']),await this[_0x260575(0x17e)][_0x260575(0x181)](_0x50500d[_0x260575(0x146)]);const _0x350c1e=(_0x2105b8===null||_0x2105b8===void 0x0?void 0x0:_0x2105b8['quality'])==='hd'?0x4:0x2;await this['userBalanceService'][_0x260575(0x126)](_0x50500d,_0x260575(0x1ad),_0x350c1e);let _0x454776=[];const _0x5c5007=await this[_0x260575(0x10b)][_0x260575(0x1d8)](_0x260575(0x17b)),_0x120a78=_0x5c5007===null||_0x5c5007===void 0x0?void 0x0:_0x5c5007['id'],{key:_0x3999c1,proxyResUrl:_0x3fdee3}=await this[_0x260575(0xe3)](_0x5c5007);common_1[_0x260575(0x162)][_0x260575(0x117)]('draw\x20paompt\x20info\x20<==**==>\x20'+_0x2105b8[_0x260575(0x189)]+',\x20key\x20===>\x20'+_0x3999c1,'DrawService');try{const _0x2d300a=_0x3fdee3+'/v1/images/generations',_0x5344c4=Object[_0x260575(0x108)](Object[_0x260575(0x108)]({},_0x2105b8),{'model':_0x260575(0x17b)});console[_0x260575(0x117)](_0x260575(0x1c6),_0x5344c4);const _0x5f5b9c=await axios_1[_0x260575(0x128)][_0x260575(0x123)](_0x2d300a,Object[_0x260575(0x108)](Object['assign']({},_0x5344c4),{'response_format':_0x260575(0x14b)}),{'headers':{'Authorization':_0x260575(0x100)+_0x3999c1}});_0x454776=_0x5f5b9c[_0x260575(0x18c)][_0x260575(0x18c)];const _0x5c69c3=[];for(const _0x4c9fb8 of _0x454776){const _0x49d209=uuid['v4']()[_0x260575(0xfb)](0x0,0xa)+_0x260575(0x184),_0x5527b1=Buffer['from'](_0x4c9fb8[_0x260575(0x14b)],_0x260575(0x16b));_0x5c69c3[_0x260575(0x101)](this['uploadService'][_0x260575(0x193)]({'filename':_0x49d209,'buffer':_0x5527b1}));}const _0x74dcd6=await Promise[_0x260575(0x147)](_0x5c69c3);await this[_0x260575(0xd7)][_0x260575(0xea)](_0x50500d[_0x260575(0x146)]['id'],_0x260575(0x1ad),(_0x5344c4===null||_0x5344c4===void 0x0?void 0x0:_0x5344c4[_0x260575(0x150)])===_0x260575(0x14d)?0x2:0x4,_0x350c1e);const _0x469153=(0x0,utils_1[_0x260575(0x115)])(_0x50500d),_0x1f5afb=[],_0xa31fe=await this[_0x260575(0xf6)]['getUploadType'](),[_0x4513b5,_0xfc095c]=_0x2105b8[_0x260575(0x1a6)][_0x260575(0x18b)]('x');return _0x74dcd6['forEach'](_0x17e19f=>{const _0x1ac874=_0x260575;_0x1f5afb['push'](this[_0x1ac874(0x143)][_0x1ac874(0x130)]({'curIp':_0x469153,'userId':_0x50500d['user']['id'],'type':balance_constant_1['DeductionKey'][_0x1ac874(0x172)],'prompt':_0x2105b8[_0x1ac874(0x189)],'answer':_0x17e19f,'fileInfo':JSON[_0x1ac874(0x14c)]({'cosType':_0xa31fe,'width':_0x4513b5,'height':_0xfc095c,'cosUrl':_0x17e19f}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x1ac874(0x17b)}));}),await Promise['all'](_0x1f5afb),_0x74dcd6;}catch(_0x2bea27){const _0x4054f7=((_0x5207c1=_0x2bea27===null||_0x2bea27===void 0x0?void 0x0:_0x2bea27['response'])===null||_0x5207c1===void 0x0?void 0x0:_0x5207c1[_0x260575(0x111)])||0x1f4;console[_0x260575(0x117)](_0x260575(0x167),JSON[_0x260575(0x14c)](_0x2bea27),_0x3999c1,_0x4054f7);const _0x931f31=(_0x57b02f=(_0x34240d=(_0x3a28bd=_0x2bea27===null||_0x2bea27===void 0x0?void 0x0:_0x2bea27['response'])===null||_0x3a28bd===void 0x0?void 0x0:_0x3a28bd[_0x260575(0x18c)])===null||_0x34240d===void 0x0?void 0x0:_0x34240d[_0x260575(0x15d)])===null||_0x57b02f===void 0x0?void 0x0:_0x57b02f[_0x260575(0xe4)];if(_0x4054f7===0x1ad)throw new common_1[(_0x260575(0x1c3))](_0x260575(0x19f),common_1['HttpStatus'][_0x260575(0x1c9)]);if(_0x4054f7===0x190&&_0x931f31[_0x260575(0x1d0)](_0x260575(0x112)))throw new common_1[(_0x260575(0x1c3))](_0x260575(0x17d),common_1[_0x260575(0x160)][_0x260575(0x1c9)]);if(_0x4054f7===0x190&&_0x931f31[_0x260575(0x1d0)](_0x260575(0x118))){await this[_0x260575(0x10b)][_0x260575(0xe2)](_0x120a78,_0x260575(0x17f),-0x1);throw new common_1[(_0x260575(0x1c3))](_0x260575(0x187),common_1[_0x260575(0x160)][_0x260575(0x1c9)]);}if(_0x4054f7===0x1f4)throw new common_1[(_0x260575(0x1c3))]('绘制图片失败，请检查你的提示词是否有非法描述！',common_1[_0x260575(0x160)][_0x260575(0x1c9)]);if(_0x4054f7===0x191)throw new common_1[(_0x260575(0x1c3))](_0x260575(0x177),common_1[_0x260575(0x160)][_0x260575(0x1c9)]);throw new common_1[(_0x260575(0x1c3))]('绘制图片失败，请稍后试试吧！',common_1[_0x260575(0x160)][_0x260575(0x1c9)]);}}async[_0x4db944(0x141)](){const _0xa48444=_0x4db944,_0x3956d0=await this['gptKeysEntity']['find']({'where':{'status':0x1},'select':['id','key',_0xa48444(0x1d4),_0xa48444(0xf1),'maxModelTokens','maxResponseTokens',_0xa48444(0x138),_0xa48444(0x12f)]}),_0x333a8f=_0x3956d0['filter'](_0x18b7ac=>_0x18b7ac[_0xa48444(0xf1)]['includes'](_0xa48444(0x136))),_0x36a4a2=_0x3956d0[_0xa48444(0x122)](_0x3eff8c=>_0x3eff8c[_0xa48444(0xf1)][_0xa48444(0x1d0)](_0xa48444(0xf8)));this[_0xa48444(0x1a0)]={'list3':_0x333a8f,'list4':_0x36a4a2};}async[_0x4db944(0x1c5)](_0x306454){const _0xf78ea0=_0x4db944,_0x160ca0=await this['globalConfigService'][_0xf78ea0(0x1c0)]([_0xf78ea0(0x148)]);return(_0x306454===null||_0x306454===void 0x0?void 0x0:_0x306454[_0xf78ea0(0x163)])||_0x160ca0||_0xf78ea0(0x134);}async[_0x4db944(0xe3)](_0x417dbb){const _0x33193d=_0x4db944,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x33193d(0x1ca)][_0x33193d(0x1c0)]([_0x33193d(0xfe),_0x33193d(0x1bd),_0x33193d(0xf4),'openaiModel3MaxTokens16kRes',_0x33193d(0x19b),'openaiModel4MaxTokensRes','openaiModel4MaxTokens32k',_0x33193d(0x1a2),_0x33193d(0x148)]);let _0xa88d33=null,_0x3ff5d0=null,_0x20a115=null,{model:_0x278d88,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x2b6308}=_0x417dbb;return _0x278d88[_0x33193d(0xe1)]()[_0x33193d(0x1d0)](_0x33193d(0xf8))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x3ff5d0>=0x1000&&(maxModelTokens=0x1000),_0xa88d33=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x3ff5d0=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x278d88[_0x33193d(0xe1)]()[_0x33193d(0x1d0)](_0x33193d(0x135))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x3ff5d0>=0x4000&&(maxModelTokens=0x4000),_0xa88d33=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x3ff5d0=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x278d88[_0x33193d(0xe1)]()['includes'](_0x33193d(0x139))&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x3ff5d0>=0x1000&&(maxModelTokens=0x1000),_0xa88d33=maxModelTokens||0x3ffc,_0x3ff5d0=maxResponseTokens||0x1000)),_0x278d88['toLowerCase']()['includes'](_0x33193d(0x136))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x3ff5d0>=0x7d0&&(maxModelTokens=0x7d0),_0xa88d33=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x3ff5d0=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x278d88[_0x33193d(0xe1)]()[_0x33193d(0x1d0)](_0x33193d(0x186))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x3ff5d0>=0x2000&&(maxModelTokens=0x2000),_0xa88d33=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x3ff5d0=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x278d88[_0x33193d(0xe1)]()['includes'](_0x33193d(0x139))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x3ff5d0>=0x1000&&(maxModelTokens=0x1000),_0xa88d33=maxModelTokens||0x4000,_0x3ff5d0=maxResponseTokens||0x1000)),_0x20a115=proxyUrl||openaiBaseUrl||_0x33193d(0x134),_0x3ff5d0>=_0xa88d33&&(_0x3ff5d0=Math[_0x33193d(0xd9)](_0xa88d33/0x2)),{'key':_0x2b6308,'maxToken':_0xa88d33,'maxTokenRes':_0x3ff5d0,'proxyResUrl':_0x20a115};}async[_0x4db944(0x1b6)](_0xf6bf94,_0x2ba66d){const _0x231a40=_0x4db944;try{const {name:_0x55afe2,icon:_0x46e71b,order:_0x526c25,id:_0xc687bf,status:_0x4ff4b9}=_0x2ba66d;return _0xc687bf?await this[_0x231a40(0x1c2)][_0x231a40(0x149)]({'id':_0xc687bf},{'name':_0x55afe2,'icon':_0x46e71b,'order':_0x526c25,'status':_0x4ff4b9}):await this[_0x231a40(0x1c2)][_0x231a40(0xec)]({'name':_0x55afe2,'icon':_0x46e71b,'order':_0x526c25,'status':_0x4ff4b9});}catch(_0x3955c2){console[_0x231a40(0x117)](_0x231a40(0x168),_0x3955c2);}}async[_0x4db944(0x1d5)](_0x219893,_0x344cdc){const _0x3bebdd=_0x4db944,{id:_0x350172}=_0x344cdc;if(!_0x350172)throw new common_1[(_0x3bebdd(0x1c3))](_0x3bebdd(0x199),common_1['HttpStatus'][_0x3bebdd(0x1c9)]);const _0x12efde=await this[_0x3bebdd(0x1cc)][_0x3bebdd(0xeb)]({'where':{'typeId':_0x350172}});if(_0x12efde)throw new common_1[(_0x3bebdd(0x1c3))]('当前分类下有未处理数据不可移除！',common_1[_0x3bebdd(0x160)][_0x3bebdd(0x1c9)]);return await this[_0x3bebdd(0x1c2)]['delete']({'id':_0x350172});}async[_0x4db944(0x170)](){const _0x5e21ac=_0x4db944;return await this[_0x5e21ac(0x1c2)]['find']({'order':{'order':_0x5e21ac(0x11e)}});}async[_0x4db944(0x10d)](_0x321815,_0xf4f9a0){const _0x31595b=_0x4db944,{title:_0x19e44f,prompt:_0xc1fbf0,appId:_0x5a3ab4,order:_0x5a1f02,status:_0x5975ab,typeId:_0xee6c6d,id:_0x447808,url:_0xef97f8}=_0xf4f9a0;if(!_0xee6c6d)throw new common_1['HttpException'](_0x31595b(0xf2),common_1['HttpStatus'][_0x31595b(0x1c9)]);try{const _0x55b60c={'title':_0x19e44f,'order':_0x5a1f02,'status':_0x5975ab,'typeId':_0xee6c6d,'url':_0xef97f8};return _0x55b60c[_0x31595b(0x1a9)]=_0x5a3ab4||0x0,_0x55b60c[_0x31595b(0x189)]=_0xc1fbf0||'',_0x447808?await this[_0x31595b(0x1cc)][_0x31595b(0x149)]({'id':_0x447808},_0x55b60c):await this[_0x31595b(0x1cc)][_0x31595b(0xec)](_0x55b60c);}catch(_0x369ff0){console[_0x31595b(0x117)](_0x31595b(0x168),_0x369ff0);}}async['delChatBox'](_0x2c3b5f,_0x2215e6){const _0xa88525=_0x4db944,{id:_0x2ff8cf}=_0x2215e6;if(!_0x2ff8cf)throw new common_1[(_0xa88525(0x1c3))]('非法操作！',common_1[_0xa88525(0x160)][_0xa88525(0x1c9)]);return await this[_0xa88525(0x1cc)][_0xa88525(0x1c4)]({'id':_0x2ff8cf});}async[_0x4db944(0xe8)](){const _0x191f0e=_0x4db944,_0xa5f991=await this[_0x191f0e(0x1cc)][_0x191f0e(0x1a5)]({'order':{'order':'DESC'}}),_0x1c1576=[...new Set(_0xa5f991[_0x191f0e(0x13e)](_0x2cea1b=>_0x2cea1b['typeId']))],_0x3fc553=[...new Set(_0xa5f991[_0x191f0e(0x13e)](_0x3e8557=>_0x3e8557[_0x191f0e(0x1a9)]))],_0x18f3bb=await this['chatBoxTypeEntity'][_0x191f0e(0x1a5)]({'where':{'id':(0x0,typeorm_1['In'])(_0x1c1576)}}),_0x25b2e8=await this[_0x191f0e(0x142)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x3fc553)}});return _0xa5f991['map'](_0x3c84cb=>{const _0x28497a=_0x191f0e,{typeId:_0x4350a9,appId:_0x47a4ce}=_0x3c84cb;return _0x3c84cb['typeInfo']=_0x18f3bb[_0x28497a(0x1a5)](_0x40d981=>_0x40d981['id']===_0x4350a9),_0x3c84cb[_0x28497a(0x133)]=_0x25b2e8[_0x28497a(0x1a5)](_0x493c30=>_0x493c30['id']===_0x47a4ce),_0x3c84cb;});}async[_0x4db944(0xe6)](){const _0x132590=_0x4db944,_0x98502d=await this['chatBoxTypeEntity'][_0x132590(0x1a5)]({'order':{'order':_0x132590(0x11e)},'where':{'status':!![]}}),_0x4e789d=await this['chatBoxEntity'][_0x132590(0x1a5)]({'where':{'status':!![]}}),_0x27b26c=[...new Set(_0x4e789d[_0x132590(0x13e)](_0x459c04=>_0x459c04[_0x132590(0x1a9)]))],_0x11b65d=await this[_0x132590(0x142)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x27b26c)}});return _0x4e789d[_0x132590(0x15a)](_0x2d31e5=>{const _0x1d2d83=_0x132590,_0x7ffe67=_0x11b65d[_0x1d2d83(0x1a5)](_0x424a71=>_0x424a71['id']===_0x2d31e5['appId']);return _0x2d31e5[_0x1d2d83(0x1a7)]=_0x7ffe67===null||_0x7ffe67===void 0x0?void 0x0:_0x7ffe67[_0x1d2d83(0x1a7)],_0x2d31e5;}),_0x98502d['map'](_0x34aeca=>{const _0xcc80d5=_0x132590;return _0x34aeca['childList']=_0x4e789d[_0xcc80d5(0x122)](_0x54b8cc=>_0x54b8cc[_0xcc80d5(0x1b8)]===_0x34aeca['id']&&_0x54b8cc[_0xcc80d5(0x111)]),_0x34aeca;});}async[_0x4db944(0x155)](_0x78d943,_0x126e5b){const _0x48b830=_0x4db944;try{const {name:_0x2ac1c6,icon:_0x45d4c8,order:_0x6e7ae3,id:_0x4cdc79,status:_0x1459f8}=_0x126e5b;return _0x4cdc79?await this['chatPreTypeEntity']['update']({'id':_0x4cdc79},{'name':_0x2ac1c6,'icon':_0x45d4c8,'order':_0x6e7ae3,'status':_0x1459f8}):await this[_0x48b830(0x164)]['save']({'name':_0x2ac1c6,'icon':_0x45d4c8,'order':_0x6e7ae3,'status':_0x1459f8});}catch(_0x462c29){console['log'](_0x48b830(0x168),_0x462c29);}}async[_0x4db944(0x18f)](_0x4bac9c,_0x9172b4){const _0x503966=_0x4db944,{id:_0xe703ec}=_0x9172b4;if(!_0xe703ec)throw new common_1[(_0x503966(0x1c3))]('非法操作！',common_1[_0x503966(0x160)]['BAD_REQUEST']);const _0x553c16=await this[_0x503966(0x1cc)][_0x503966(0xeb)]({'where':{'typeId':_0xe703ec}});if(_0x553c16)throw new common_1[(_0x503966(0x1c3))]('当前分类下有未处理数据不可移除！',common_1['HttpStatus'][_0x503966(0x1c9)]);return await this[_0x503966(0x164)]['delete']({'id':_0xe703ec});}async[_0x4db944(0x196)](){const _0x406f4f=_0x4db944;return await this[_0x406f4f(0x164)]['find']({'order':{'order':_0x406f4f(0x11e)}});}async[_0x4db944(0x1ba)](_0x2b0097,_0x242f57){const _0x29b112=_0x4db944,{title:_0x589697,prompt:_0x2a535f,appId:_0x57f447,order:_0x46568a,status:_0x5ce655,typeId:_0x3ddadf,id:_0x2d8aa9,url:_0x53fb2c}=_0x242f57;if(!_0x3ddadf)throw new common_1[(_0x29b112(0x1c3))](_0x29b112(0xf2),common_1['HttpStatus']['BAD_REQUEST']);try{const _0x11b99a={'title':_0x589697,'prompt':_0x2a535f,'order':_0x46568a,'status':_0x5ce655,'typeId':_0x3ddadf,'url':_0x53fb2c};return _0x2d8aa9?await this[_0x29b112(0x1d7)][_0x29b112(0x149)]({'id':_0x2d8aa9},_0x11b99a):await this['chatPreEntity'][_0x29b112(0xec)](_0x11b99a);}catch(_0x5e65ab){console[_0x29b112(0x117)]('error:\x20',_0x5e65ab);}}async[_0x4db944(0x17c)](_0x4db5c1,_0x7c85d){const _0x4a96cf=_0x4db944,{id:_0x29f6fd}=_0x7c85d;if(!_0x29f6fd)throw new common_1[(_0x4a96cf(0x1c3))](_0x4a96cf(0x199),common_1[_0x4a96cf(0x160)][_0x4a96cf(0x1c9)]);return await this[_0x4a96cf(0x1d7)][_0x4a96cf(0x1c4)]({'id':_0x29f6fd});}async['queryChatPre'](){const _0x2729a5=_0x4db944,_0x44fed2=await this[_0x2729a5(0x1d7)][_0x2729a5(0x1a5)]({'order':{'order':_0x2729a5(0x11e)}}),_0x434904=[...new Set(_0x44fed2[_0x2729a5(0x13e)](_0x309207=>_0x309207[_0x2729a5(0x1b8)]))],_0x46abcb=await this[_0x2729a5(0x164)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x434904)}});return _0x44fed2[_0x2729a5(0x13e)](_0x5af6c6=>{const _0x3dab37=_0x2729a5,{typeId:_0x9263d6,appId:_0xbaaf44}=_0x5af6c6;return _0x5af6c6[_0x3dab37(0xda)]=_0x46abcb[_0x3dab37(0x1a5)](_0x2f6534=>_0x2f6534['id']===_0x9263d6),_0x5af6c6;});}async[_0x4db944(0x13c)](){const _0x416fbb=_0x4db944,_0xc0e5bc=await this['chatPreTypeEntity'][_0x416fbb(0x1a5)]({'order':{'order':'DESC'},'where':{'status':!![]}}),_0xb1f0a2=await this[_0x416fbb(0x1d7)]['find']({'where':{'status':!![]}});return _0xc0e5bc[_0x416fbb(0x13e)](_0x149738=>{const _0x3c401a=_0x416fbb;return _0x149738[_0x3c401a(0x1b4)]=_0xb1f0a2['filter'](_0x3efbf3=>_0x3efbf3[_0x3c401a(0x1b8)]===_0x149738['id']&&_0x3efbf3['status']),_0x149738;});}async[_0x4db944(0xe9)](_0x646bf2,_0x3e0a42,_0x510219){const _0x4f7574=_0x4db944;let _0x4264f1=0x1000,_0x209a96=0x800;return _0x646bf2[_0x4f7574(0xe1)]()['includes'](_0x4f7574(0xf8))&&(_0x4264f1=_0x3e0a42>=0x2004?0x2004:_0x3e0a42,_0x209a96=_0x510219>=0x1000?0x1000:_0x510219,_0x646bf2[_0x4f7574(0xe1)]()['includes'](_0x4f7574(0x135))&&(_0x4264f1=_0x3e0a42>=0x8000?0x8000:_0x3e0a42,_0x209a96=_0x510219>=0x3e80?0x3e80:_0x510219),(_0x646bf2[_0x4f7574(0xe1)]()['includes'](_0x4f7574(0x165))||_0x646bf2[_0x4f7574(0xe1)]()['includes']('gpt-4-vision-preview'))&&(_0x4264f1=_0x3e0a42>=0x1f400?0x1f400:_0x3e0a42,_0x209a96=_0x510219>=0x1000?0x1000:_0x510219)),_0x646bf2[_0x4f7574(0xe1)]()[_0x4f7574(0x1d0)](_0x4f7574(0x136))&&(_0x4264f1=_0x3e0a42>=0x1000?0x1000:_0x3e0a42,_0x209a96=_0x510219>=0x800?0x800:_0x510219,_0x646bf2[_0x4f7574(0xe1)]()[_0x4f7574(0x1d0)](_0x4f7574(0x186))&&(_0x4264f1=_0x3e0a42>=0x4000?0x4000:_0x3e0a42,_0x209a96=_0x510219>=0x1f40?0x1f40:_0x510219),_0x646bf2[_0x4f7574(0xe1)]()[_0x4f7574(0x1d0)](_0x4f7574(0x139))&&(_0x4264f1=_0x3e0a42>=0x4000?0x4000:_0x3e0a42,_0x209a96=_0x510219>=0x1f40?0x1f40:_0x510219)),{'maxToken':_0x4264f1,'maxRes':_0x209a96};}};ChatgptService=__decorate([(0x0,common_1[_0x4db944(0x1cb)])(),__param(0x0,(0x0,typeorm_2[_0x4db944(0xfc)])(gptkeys_entity_1[_0x4db944(0x194)])),__param(0x1,(0x0,typeorm_2[_0x4db944(0xfc)])(config_entity_1[_0x4db944(0xe5)])),__param(0x2,(0x0,typeorm_2['InjectRepository'])(chatBoxType_entity_1[_0x4db944(0x11f)])),__param(0x3,(0x0,typeorm_2[_0x4db944(0xfc)])(chatBox_entity_1['ChatBoxEntity'])),__param(0x4,(0x0,typeorm_2[_0x4db944(0xfc)])(app_entity_1['AppEntity'])),__param(0x5,(0x0,typeorm_2[_0x4db944(0xfc)])(chatPreType_entity_1[_0x4db944(0x16a)])),__param(0x6,(0x0,typeorm_2['InjectRepository'])(chatPre_entity_1[_0x4db944(0x1b9)])),__metadata(_0x4db944(0xef),[typeorm_1[_0x4db944(0x1ce)],typeorm_1[_0x4db944(0x1ce)],typeorm_1['Repository'],typeorm_1[_0x4db944(0x1ce)],typeorm_1[_0x4db944(0x1ce)],typeorm_1['Repository'],typeorm_1[_0x4db944(0x1ce)],nestjs_config_1[_0x4db944(0x137)],userBalance_service_1[_0x4db944(0x107)],chatLog_service_1['ChatLogService'],user_service_1[_0x4db944(0x18a)],upload_service_1[_0x4db944(0xde)],badwords_service_1[_0x4db944(0x113)],autoreply_service_1[_0x4db944(0x1b1)],globalConfig_service_1[_0x4db944(0x145)],fanyi_service_1[_0x4db944(0x1a3)],chatGroup_service_1[_0x4db944(0x1be)],models_service_1[_0x4db944(0x11c)]])],ChatgptService),exports['ChatgptService']=ChatgptService;