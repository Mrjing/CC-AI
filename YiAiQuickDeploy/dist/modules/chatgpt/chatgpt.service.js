'use strict';function _0x63b2(){const _0x44f815=['当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','UserBalanceService','onModuleInit','\x20模型名称:\x20','../chatGroup/chatGroup.service','b64_json','GlobalConfigService','setChatPreType','model3','openaiBaseUrl','function','filter','nineStore','checkUserStatus','HttpException','appId','configService','weight',',\x20key\x20===>\x20','InjectRepository','../models/models.service','save','findOne','configEntity','914116OzpIHR','getMaxTokenFromModelWithOpenAi','getUuid','validateBalance','modelsService','getModelProxyUrl','code:\x20','importDynamic',',\x20消耗token:\x20','count','ChatGroupService','PAINT_TYPE','chatPreEntity','1007496ibUQGo','usage','./../upload/upload.service','model','ChatPreEntity','../app/app.entity','standard','unifiedFormattingResponse','./baidu','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','whiteListUser','11416JRaWmi','is_end','typeInfo','190508pqQBcv','16k','decorate','mjDraw','getRandomDrawKey','CHAT_TYPE','childList','Logger','gpt-4-1106','stringify','dall-e\x20draw\x20params:\x20','openaiProxyUrl','提供了错误的模型秘钥','openaiModel3MaxTokens','keyv','application/octet-stream;\x20charset=utf-8','length','dall','../../common/constants/errorMessage.constant','DESC','.png','draw\x20paompt\x20info\x20<==**==>\x20','detail','chatBoxEntity','delChatPreType','./chatPreType.entity','getConfigs','19793990CMRHkp','size','imageUrl','ConfigService','Too\x20Many\x20Requests','parse','data','chatSyncFree','__param','maxResponseTokens','includes','ceil','../chatLog/chatLog.service','prompt','../globalConfig/globalConfig.service','all','/v1/images/generations','NineStore','close','gpt-4','object','chatPreTypeEntity','statusText','lockKey','delChatBox','draw','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','ModelsService','appInfo','getClientIp','../autoreply/autoreply.service','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','ChatgptService','6GWxjEr','setChatBox','axios','openaiModel4MaxTokens','addOneIfOdd','response','delete','__esModule','push','DeductionKey','943587bznwMW','56648EwwVTR','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','systemPreMessage','error:\x20','error','UserService','getBaseConfig','message','getTokenCount','queryUserBalance','openaiModel3MaxTokens16k','queryChatPre','post','queryChatBoxType','用户ID:\x20','statusCode','saveChatLog','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','toISOString','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','typeorm','default','saveUseLog','queryChatBoxFrontend','\x0a\x20Current\x20date:\x20','getUploadType','setData','modelInfo','keyPool','AutoreplyService','@nestjs/common','当前请求已过载、请稍等会儿再试试吧！','绘制图片失败，请检查你的提示词是否有非法描述！','delChatBoxType','openaiModel3MaxTokens16kRes','globalConfigService','map','delChatPre','queryChatPreType','log','text','当前模型不是聊天模型','../badwords/badwords.service','Please\x20check\x20the\x20back-end\x20console','sendMessageFromOpenAi','fanyiService','2313naAXsd','preset',',\x20消耗积分：\x20','abortController','Bearer\x20','../../common/constants/balance.constant','toLowerCase','autoreplyService','当前Key余额已不足、请重新再试一次吧！','ChatLogService','chatProcess','BAD_REQUEST','Injectable','chatBoxTypeEntity','ChatPreTypeEntity','openaiTimeoutMs','openai-draw\x20error:\x20','assistant','checkAutoReply','userService','AppEntity','result','HttpStatus','userBalanceService','gpt-4-vision-preview','1106','./chatBoxType.entity','systemMessage','forEach','abort','write','./helper','model4','quality','getAllKeyList','gptKeysEntity','GptKeysEntity','end','非法操作！','defineProperty','slice','debug','../../common/utils','缺失必要参数！','appEntity','32k','formatModelToken','setHeader','ChatBoxEntity','chat-error\x20<----------------------------------------->','dall-e-3','user','@keyv/redis','openaiModel3MaxTokensRes','typeId','__decorate','Repository','OpenAiErrorCodeMessage','Catch\x20Error\x20','getCurrentModelKeyInfo','sendMessageFromBaidu','当前模型调用过于频繁、请重新试试吧！','find','getGroupInfoFromId','Billing\x20hard\x20limit\x20has\x20been\x20reached','split','__metadata','base64','conversationId','coverImg','gpt-3','chatLogService','buildMessageFromParentMessageId','DrawService','badwordsService','uploadService','./zhipu','../fanyi/fanyi.service','https://api.openai.com','40YOkAkc','deductFromBalance','update','env','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','REDIS_PORT','chatGroupService','getRequestParams','ChatBoxTypeEntity','status','UploadService','绘制图片失败，此次绘画被拒绝了！','当前模型key已被封禁','chatgpt-ai-web','./../user/user.service','assign'];_0x63b2=function(){return _0x44f815;};return _0x63b2();}const _0x3b035d=_0x53bd;(function(_0x126929,_0x5e4a11){const _0x18c9c4=_0x53bd,_0x175dc1=_0x126929();while(!![]){try{const _0x58cab2=parseInt(_0x18c9c4(0x154))/0x1+-parseInt(_0x18c9c4(0xff))/0x2+-parseInt(_0x18c9c4(0x153))/0x3+parseInt(_0x18c9c4(0x10d))/0x4*(-parseInt(_0x18c9c4(0x1d1))/0x5)+-parseInt(_0x18c9c4(0x149))/0x6*(parseInt(_0x18c9c4(0xf2))/0x7)+parseInt(_0x18c9c4(0x10a))/0x8*(-parseInt(_0x18c9c4(0x182))/0x9)+parseInt(_0x18c9c4(0x128))/0xa;if(_0x58cab2===_0x5e4a11)break;else _0x175dc1['push'](_0x175dc1['shift']());}catch(_0xc5ff0c){_0x175dc1['push'](_0x175dc1['shift']());}}}(_0x63b2,0x52de3));var __decorate=this&&this[_0x3b035d(0x1b9)]||function(_0xaf60a4,_0x6bdb09,_0x3eecf9,_0xd7990b){const _0x5decc6=_0x3b035d;var _0x414ae7=arguments[_0x5decc6(0x11d)],_0x7a4e11=_0x414ae7<0x3?_0x6bdb09:_0xd7990b===null?_0xd7990b=Object['getOwnPropertyDescriptor'](_0x6bdb09,_0x3eecf9):_0xd7990b,_0x5b6a9d;if(typeof Reflect===_0x5decc6(0x13c)&&typeof Reflect[_0x5decc6(0x10f)]===_0x5decc6(0xe4))_0x7a4e11=Reflect[_0x5decc6(0x10f)](_0xaf60a4,_0x6bdb09,_0x3eecf9,_0xd7990b);else{for(var _0x3aedf7=_0xaf60a4['length']-0x1;_0x3aedf7>=0x0;_0x3aedf7--)if(_0x5b6a9d=_0xaf60a4[_0x3aedf7])_0x7a4e11=(_0x414ae7<0x3?_0x5b6a9d(_0x7a4e11):_0x414ae7>0x3?_0x5b6a9d(_0x6bdb09,_0x3eecf9,_0x7a4e11):_0x5b6a9d(_0x6bdb09,_0x3eecf9))||_0x7a4e11;}return _0x414ae7>0x3&&_0x7a4e11&&Object[_0x5decc6(0x1a9)](_0x6bdb09,_0x3eecf9,_0x7a4e11),_0x7a4e11;},__metadata=this&&this[_0x3b035d(0x1c4)]||function(_0x1affac,_0x42b3ae){const _0x1266b5=_0x3b035d;if(typeof Reflect===_0x1266b5(0x13c)&&typeof Reflect['metadata']===_0x1266b5(0xe4))return Reflect['metadata'](_0x1affac,_0x42b3ae);},__param=this&&this[_0x3b035d(0x130)]||function(_0x470939,_0x9cf11){return function(_0x4e1db8,_0x4cee2c){_0x9cf11(_0x4e1db8,_0x4cee2c,_0x470939);};};Object[_0x3b035d(0x1a9)](exports,_0x3b035d(0x150),{'value':!![]}),exports[_0x3b035d(0x148)]=void 0x0;const upload_service_1=require(_0x3b035d(0x101)),user_service_1=require(_0x3b035d(0xd8)),nestjs_config_1=require('nestjs-config'),common_1=require(_0x3b035d(0x172)),errorMessage_constant_1=require(_0x3b035d(0x11f)),utils_1=require(_0x3b035d(0x1ac)),axios_1=require(_0x3b035d(0x14b)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require(_0x3b035d(0x187)),chatLog_service_1=require(_0x3b035d(0x134)),uuid=require('uuid'),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require(_0x3b035d(0x168)),typeorm_2=require('@nestjs/typeorm'),badwords_service_1=require(_0x3b035d(0x17e)),autoreply_service_1=require(_0x3b035d(0x146)),gptkeys_entity_1=require('./gptkeys.entity'),globalConfig_service_1=require(_0x3b035d(0x136)),fanyi_service_1=require(_0x3b035d(0x1cf)),app_entity_1=require(_0x3b035d(0x104)),chatGroup_service_1=require(_0x3b035d(0xde)),models_service_1=require(_0x3b035d(0xee)),baidu_1=require(_0x3b035d(0x107)),helper_1=require(_0x3b035d(0x1a1)),store_1=require('./store'),zhipu_1=require(_0x3b035d(0x1ce)),openai_1=require('./openai'),chatBoxType_entity_1=require(_0x3b035d(0x19c)),chatBox_entity_1=require('./chatBox.entity'),chatPre_entity_1=require('./chatPre.entity'),chatPreType_entity_1=require(_0x3b035d(0x126));function _0x53bd(_0x4452d8,_0x1612dc){const _0x63b284=_0x63b2();return _0x53bd=function(_0x53bd1a,_0x138c09){_0x53bd1a=_0x53bd1a-0xcb;let _0x5ce677=_0x63b284[_0x53bd1a];return _0x5ce677;},_0x53bd(_0x4452d8,_0x1612dc);}let ChatgptService=class ChatgptService{constructor(_0x13c736,_0x5a4eee,_0x49f2f3,_0x11cdc4,_0x3cd98c,_0x587128,_0xe59edc,_0xc5f617,_0x2e9faf,_0x4ce883,_0x2cd4ff,_0x404953,_0x1f8bcf,_0x28ea34,_0x3d27cf,_0x1d1f01,_0x1669a2,_0x41b659){const _0x384897=_0x3b035d;this[_0x384897(0x1a5)]=_0x13c736,this[_0x384897(0xf1)]=_0x5a4eee,this[_0x384897(0x18f)]=_0x49f2f3,this[_0x384897(0x124)]=_0x11cdc4,this['appEntity']=_0x3cd98c,this[_0x384897(0x13d)]=_0x587128,this[_0x384897(0xfe)]=_0xe59edc,this[_0x384897(0xea)]=_0xc5f617,this[_0x384897(0x199)]=_0x2e9faf,this[_0x384897(0x1c9)]=_0x4ce883,this[_0x384897(0x195)]=_0x2cd4ff,this['uploadService']=_0x404953,this[_0x384897(0x1cc)]=_0x1f8bcf,this[_0x384897(0x189)]=_0x28ea34,this['globalConfigService']=_0x3d27cf,this[_0x384897(0x181)]=_0x1d1f01,this[_0x384897(0xd0)]=_0x1669a2,this['modelsService']=_0x41b659,this[_0x384897(0xe6)]=null,this[_0x384897(0x109)]=[],this[_0x384897(0x170)]={'list3':[],'list4':[]};}async[_0x3b035d(0xdc)](){const _0x39a569=_0x3b035d;let _0x313a51=await(0x0,utils_1['importDynamic'])(_0x39a569(0xd7)),_0x733b73=await(0x0,utils_1[_0x39a569(0xf9)])(_0x39a569(0x1b6)),_0xd770b=await(0x0,utils_1[_0x39a569(0xf9)])(_0x39a569(0x11b));_0x313a51=(_0x313a51===null||_0x313a51===void 0x0?void 0x0:_0x313a51[_0x39a569(0x169)])?_0x313a51[_0x39a569(0x169)]:_0x313a51,_0x733b73=(_0x733b73===null||_0x733b73===void 0x0?void 0x0:_0x733b73[_0x39a569(0x169)])?_0x733b73[_0x39a569(0x169)]:_0x733b73,_0xd770b=(_0xd770b===null||_0xd770b===void 0x0?void 0x0:_0xd770b['default'])?_0xd770b[_0x39a569(0x169)]:_0xd770b;const {ChatGPTAPI:_0x444fd4,ChatGPTError:_0x5aaba7,ChatGPTUnofficialProxyAPI:_0x4ea996}=_0x313a51,_0x3d52e0=+process[_0x39a569(0xcd)][_0x39a569(0xcf)],_0x223a71=process[_0x39a569(0xcd)]['REDIS_HOST'],_0x49916b=process[_0x39a569(0xcd)]['REDIS_PASSWORD'],_0x45c021=process[_0x39a569(0xcd)]['REDIS_USER'],_0x2eea7f='redis://'+(_0x45c021||'')+':'+(_0x49916b||'')+'@'+_0x223a71+':'+_0x3d52e0,_0x3b8290=new _0x733b73(_0x2eea7f),_0x2f0b58=new _0xd770b({'store':_0x3b8290,'namespace':'nineai-chatlog'});this[_0x39a569(0xe6)]=new store_1[(_0x39a569(0x139))]({'store':_0x2f0b58,'namespace':'chat'});}async[_0x3b035d(0xd1)](_0x45ebd3,_0x115118,_0x4ab05e,_0x4987f0=null){const _0x4ce801=_0x3b035d;var _0x815261;!_0x4987f0&&(_0x4987f0=(_0x815261=await this['modelsService'][_0x4ce801(0x15a)]())===null||_0x815261===void 0x0?void 0x0:_0x815261[_0x4ce801(0x16f)]);const {timeout:timeout=0x3c}=_0x4ab05e,{topN:_0xd94c0c,model:_0x54c2e5}=_0x4987f0,{parentMessageId:parentMessageId=0x0}=_0x45ebd3,_0x409ab8=await this['globalConfigService'][_0x4ce801(0x127)]([_0x4ce801(0x191)]),_0x23271e=timeout*0x3e8||_0x409ab8||0x64*0x3e8,_0x1ff07c={'parentMessageId':parentMessageId,'timeoutMs':+_0x23271e,'completionParams':{'model':_0x54c2e5,'temperature':_0xd94c0c}};return _0x115118&&(_0x1ff07c[_0x4ce801(0x19d)]=_0x115118),_0x1ff07c;}async[_0x3b035d(0x12f)](_0x2fc896){const _0x5aef00=_0x3b035d,_0x1e02d1=await this[_0x5aef00(0xf6)][_0x5aef00(0x111)](),_0x5887ca=await this[_0x5aef00(0x177)][_0x5aef00(0x127)]([_0x5aef00(0x156)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x5544aa,model:_0x28117e}=_0x1e02d1,_0x25d469=await this[_0x5aef00(0xf7)](_0x1e02d1),{context:_0x27c90c}=await this[_0x5aef00(0xe6)][_0x5aef00(0x1ca)](_0x2fc896,{'parentMessageId':'','systemMessage':_0x5887ca});try{const _0x2bdf1f=await(0x0,openai_1[_0x5aef00(0x180)])(_0x27c90c,{'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0x5544aa),'model':_0x28117e,'proxyUrl':_0x25d469,'onProgress':null});return _0x2bdf1f===null||_0x2bdf1f===void 0x0?void 0x0:_0x2bdf1f[_0x5aef00(0x17c)];}catch(_0x414b9b){console['log']('error:\x20',_0x414b9b);}}async[_0x3b035d(0x18c)](_0x37279c,_0x18ccf2,_0x30af8a){const _0x5ec6e5=_0x3b035d;var _0x22f06a,_0x46ef25,_0x58baf0,_0x2fa440;const _0x4347a9=_0x18ccf2[_0x5ec6e5(0x185)],{options:options={},appId:_0x231432,cusromPrompt:_0x47e011,systemMessage:systemMessage=''}=_0x37279c;let _0x5ec917=systemMessage;const {parentMessageId:_0x56ba6a}=options,{prompt:_0x42b572,imageUrl:_0x24380a,model:_0x5a2c76}=_0x37279c,{groupId:_0x57d0f5,usingNetwork:_0x375260}=options,_0x1477bf=await this[_0x5ec6e5(0xd0)][_0x5ec6e5(0x1c1)](_0x57d0f5),_0x3cede7=(_0x1477bf===null||_0x1477bf===void 0x0?void 0x0:_0x1477bf['config'])?JSON[_0x5ec6e5(0x12d)](_0x1477bf['config']):await this[_0x5ec6e5(0xf6)][_0x5ec6e5(0x15a)](),{keyType:_0x434fde,model:_0x4dc792,topN:_0x2e7669,systemMessage:_0x145fcb,rounds:_0x14d1b1}=_0x3cede7['modelInfo'];let _0xfe60ab=null;!_0x47e011?_0xfe60ab=await this[_0x5ec6e5(0xf6)]['getCurrentModelKeyInfo'](_0x4dc792):_0xfe60ab=await this['modelsService']['getRandomDrawKey']();if(!_0xfe60ab)throw new common_1['HttpException'](_0x5ec6e5(0xda),common_1[_0x5ec6e5(0x198)][_0x5ec6e5(0x18d)]);const {deduct:_0x169ad0,isTokenBased:_0x592e18,tokenFeeRatio:_0x2262bb,deductType:_0x374a43,key:_0x497d70,secret:_0x488ac0,modelName:_0x36ab2c,id:_0x1b8168,accessToken:_0x3f2efd}=_0xfe60ab;await this[_0x5ec6e5(0x195)][_0x5ec6e5(0xe7)](_0x18ccf2[_0x5ec6e5(0x1b5)]),await this[_0x5ec6e5(0x199)][_0x5ec6e5(0xf5)](_0x18ccf2,_0x374a43===0x1?_0x5ec6e5(0xe2):_0x5ec6e5(0x1a2),_0x169ad0),_0x30af8a&&_0x30af8a[_0x5ec6e5(0x1b1)]('Content-type',_0x5ec6e5(0x11c)),await this[_0x5ec6e5(0x1cc)]['checkBadWords'](_0x42b572,_0x18ccf2[_0x5ec6e5(0x1b5)]['id']);const _0x3912f3=await this[_0x5ec6e5(0x189)][_0x5ec6e5(0x194)](_0x42b572);if(_0x3912f3&&_0x30af8a){const _0x36859b={'message':_0x3912f3,'code':0x1f4};return _0x30af8a[_0x5ec6e5(0x1a0)](JSON['stringify'](_0x36859b)),_0x30af8a['end']();}if(_0x231432){const _0xa2f526=await this['appEntity'][_0x5ec6e5(0xf0)]({'where':{'id':_0x231432,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0xa2f526)throw new common_1['HttpException'](_0x5ec6e5(0xce),common_1['HttpStatus'][_0x5ec6e5(0x18d)]);_0xa2f526['preset']&&(_0x5ec917=_0xa2f526[_0x5ec6e5(0x183)]);}else{if(_0x47e011)_0x5ec917=systemMessage;else{if(_0x145fcb)_0x5ec917=_0x145fcb;else{const _0x4c9abc=new Date()[_0x5ec6e5(0x166)]()[_0x5ec6e5(0x1c3)]('T')[0x0],_0x5cca08=await this[_0x5ec6e5(0x177)][_0x5ec6e5(0x127)]([_0x5ec6e5(0x156)]);_0x5ec917=_0x5cca08+('\x0a\x20Current\x20date:\x20'+_0x4c9abc);}}}let _0x12b511='';if(_0x375260){_0x12b511=await(0x0,utils_1['compileNetwork'])(_0x42b572);const _0x4df156=new Date()[_0x5ec6e5(0x166)]()[_0x5ec6e5(0x1c3)]('T')[0x0],_0x556c25=await this['globalConfigService'][_0x5ec6e5(0x127)]([_0x5ec6e5(0x156)]);_0x5ec917=_0x556c25+(_0x5ec6e5(0x16c)+_0x4df156);}const _0xa4bf45=await this[_0x5ec6e5(0xd1)](options,_0x5ec917,_0xfe60ab,_0x3cede7[_0x5ec6e5(0x16f)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0xf44b54}=_0xfe60ab;_0x30af8a&&_0x30af8a['status'](0xc8);let _0x31c474=null,_0xe5015d=null;try{if(_0x30af8a){let _0x46ee33=null,_0x38430e=![];_0x30af8a['on'](_0x5ec6e5(0x13a),async()=>{const _0xfb4881=_0x5ec6e5;if(_0x38430e)return;_0x4347a9[_0xfb4881(0x19f)]();const _0x406c01=await(0x0,openai_1[_0xfb4881(0x15c)])(_0x42b572)||0x0,_0x1c95f9=await(0x0,openai_1[_0xfb4881(0x15c)])(_0x46ee33===null||_0x46ee33===void 0x0?void 0x0:_0x46ee33[_0xfb4881(0x17c)])||0x0,_0x4e143d=_0x406c01+_0x1c95f9,_0x2591c0=(0x0,utils_1[_0xfb4881(0x145)])(_0x18ccf2);await this[_0xfb4881(0x1c9)][_0xfb4881(0x164)]({'appId':_0x231432,'curIp':_0x2591c0,'userId':_0x18ccf2[_0xfb4881(0x1b5)]['id'],'type':balance_constant_1[_0xfb4881(0x152)][_0xfb4881(0x112)],'prompt':_0x42b572,'imageUrl':_0x24380a,'activeModel':_0x5a2c76,'answer':'','promptTokens':_0x406c01,'completionTokens':0x0,'totalTokens':_0x406c01,'model':_0x4dc792,'role':_0xfb4881(0x1b5),'groupId':_0x57d0f5,'requestOptions':JSON[_0xfb4881(0x116)]({'options':null,'prompt':_0x42b572})}),await this[_0xfb4881(0x1c9)][_0xfb4881(0x164)]({'appId':_0x231432,'curIp':_0x2591c0,'userId':_0x18ccf2['user']['id'],'type':balance_constant_1['DeductionKey'][_0xfb4881(0x112)],'prompt':_0x42b572,'answer':_0x46ee33===null||_0x46ee33===void 0x0?void 0x0:_0x46ee33['text'],'promptTokens':_0x406c01,'completionTokens':_0x1c95f9,'totalTokens':_0x4e143d,'model':_0x4dc792,'role':_0xfb4881(0x193),'groupId':_0x57d0f5,'requestOptions':JSON[_0xfb4881(0x116)]({'options':{'model':_0x4dc792,'temperature':_0x2e7669},'prompt':_0x42b572}),'conversationOptions':JSON[_0xfb4881(0x116)]({'conversationId':_0x46ee33===null||_0x46ee33===void 0x0?void 0x0:_0x46ee33['conversationId'],'model':_0x4dc792,'parentMessageId':_0x46ee33===null||_0x46ee33===void 0x0?void 0x0:_0x46ee33['id'],'temperature':_0x2e7669})});let _0x1c59aa=_0x169ad0;_0x592e18===!![]&&(_0x1c59aa=Math[_0xfb4881(0x133)](_0x169ad0*_0x4e143d/_0x2262bb)),await this[_0xfb4881(0x199)][_0xfb4881(0xcb)](_0x18ccf2[_0xfb4881(0x1b5)]['id'],_0xfb4881(0x102)+(_0x374a43===0x1?0x3:0x4),_0x1c59aa,_0x4e143d);});if(Number(_0x434fde)===0x1){const {key:_0x19db27,maxToken:_0x4eda8b,maxTokenRes:_0x1ab6d1,proxyResUrl:_0x344139}=await this['formatModelToken'](_0xfe60ab),{parentMessageId:_0x3385f5,completionParams:_0x49e1f9,systemMessage:_0x384efd}=_0xa4bf45,{model:_0x49dfdc,temperature:_0x5f100d}=_0x49e1f9,{context:_0x1e0ecc}=await this[_0x5ec6e5(0xe6)][_0x5ec6e5(0x1ca)](_0x375260?_0x12b511:_0x42b572,{'parentMessageId':_0x3385f5,'systemMessage':_0x384efd,'maxModelToken':_0x4eda8b,'maxResponseTokens':_0x1ab6d1,'maxRounds':(0x0,helper_1[_0x5ec6e5(0x14d)])(_0x14d1b1),'imageUrl':_0x24380a,'activeModel':_0x5a2c76});let _0x2745f4=!![];_0x31c474=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x1e0ecc,{'maxToken':_0x4eda8b,'maxTokenRes':_0x1ab6d1,'apiKey':_0x497d70,'model':_0x49dfdc,'prompt':_0x42b572,'activeModel':_0x5a2c76,'imageUrl':_0x24380a,'temperature':_0x5f100d,'proxyUrl':_0x344139,'onProgress':_0x9c397f=>{const _0x4ebe78=_0x5ec6e5;_0x30af8a[_0x4ebe78(0x1a0)](_0x2745f4?JSON[_0x4ebe78(0x116)](_0x9c397f):'\x0a'+JSON[_0x4ebe78(0x116)](_0x9c397f)),_0x46ee33=_0x9c397f,_0x2745f4=![];}},this[_0x5ec6e5(0x1cd)]),_0x38430e=!![];}if(Number(_0x434fde)===0x2){let _0x34900c=!![];const {context:_0x3e4208}=await this['nineStore'][_0x5ec6e5(0x1ca)](_0x375260?_0x12b511:_0x42b572,{'parentMessageId':_0x56ba6a,'maxRounds':(0x0,helper_1[_0x5ec6e5(0x14d)])(_0x14d1b1)});_0x31c474=await(0x0,baidu_1[_0x5ec6e5(0x1be)])(_0x375260?_0x12b511:_0x3e4208,{'temperature':_0x2e7669,'accessToken':_0x3f2efd,'model':_0x4dc792,'onProgress':_0x5625e3=>{const _0x1404ae=_0x5ec6e5;_0x30af8a['write'](_0x34900c?JSON[_0x1404ae(0x116)](_0x5625e3):'\x0a'+JSON[_0x1404ae(0x116)](_0x5625e3)),_0x34900c=![],_0x46ee33=_0x5625e3;}}),_0x38430e=!![];}if(Number(_0x434fde)===0x3){let _0x21a1d6=!![];const {context:_0x8cb8fe}=await this[_0x5ec6e5(0xe6)]['buildMessageFromParentMessageId'](_0x375260?_0x12b511:_0x42b572,{'parentMessageId':_0x56ba6a,'maxRounds':(0x0,helper_1[_0x5ec6e5(0x14d)])(_0x14d1b1)});_0x31c474=await(0x0,zhipu_1['sendMessageFromZhipu'])(_0x375260?_0x12b511:_0x8cb8fe,{'temperature':_0x2e7669,'key':_0xf44b54,'model':_0x4dc792,'onProgress':_0x17b1e4=>{const _0x461094=_0x5ec6e5;_0x30af8a[_0x461094(0x1a0)](_0x21a1d6?JSON[_0x461094(0x116)](_0x17b1e4):'\x0a'+JSON['stringify'](_0x17b1e4)),_0x21a1d6=![],_0x46ee33=_0x17b1e4;}}),_0x38430e=!![];}const _0x584d24={'id':this[_0x5ec6e5(0xe6)][_0x5ec6e5(0xf4)](),'text':_0x42b572,'role':_0x5ec6e5(0x1b5),'name':undefined,'usage':null,'imageUrl':_0x24380a,'activeModel':_0x5a2c76,'parentMessageId':_0x56ba6a,'conversationId':_0x31c474===null||_0x31c474===void 0x0?void 0x0:_0x31c474[_0x5ec6e5(0x1c6)]};_0xe5015d={'model':_0x4dc792,'parentMessageId':_0x56ba6a},await this[_0x5ec6e5(0xe6)][_0x5ec6e5(0x16e)](_0x584d24);const _0xd0aa81={'id':_0x31c474['id'],'text':_0x31c474['text'],'role':_0x5ec6e5(0x193),'name':undefined,'usage':_0x31c474===null||_0x31c474===void 0x0?void 0x0:_0x31c474[_0x5ec6e5(0x100)],'imageUrl':_0x24380a,'parentMessageId':_0x584d24['id'],'conversationId':_0x31c474===null||_0x31c474===void 0x0?void 0x0:_0x31c474[_0x5ec6e5(0x1c6)]};await this['nineStore'][_0x5ec6e5(0x16e)](_0xd0aa81),_0xe5015d={'model':_0x4dc792,'parentMessageId':_0x584d24['id']};}else{const {key:_0x39bd4c,maxToken:_0x37cb25,maxTokenRes:_0x11516a,proxyResUrl:_0x5a1e65}=await this['formatModelToken'](_0xfe60ab),{parentMessageId:_0x4e0954,completionParams:_0x3747db,systemMessage:_0x51bbaf}=_0xa4bf45,{model:_0x5298d4,temperature:_0x2600c9}=_0x3747db,{context:_0x2ebc3d}=await this[_0x5ec6e5(0xe6)]['buildMessageFromParentMessageId'](_0x375260?_0x12b511:_0x42b572,{'parentMessageId':_0x4e0954,'systemMessage':_0x51bbaf,'maxRounds':(0x0,helper_1[_0x5ec6e5(0x14d)])(_0x14d1b1)});_0x31c474=await(0x0,openai_1[_0x5ec6e5(0x180)])(_0x2ebc3d,{'apiKey':_0x497d70,'model':_0x5298d4,'temperature':_0x2600c9,'proxyUrl':_0x5a1e65,'onProgress':null,'prompt':_0x42b572});}let _0xbb8e13=null,_0x52e749=null;_0x4dc792['includes'](_0x5ec6e5(0x11e))?_0xbb8e13=((_0x22f06a=_0x31c474[_0x5ec6e5(0x123)])===null||_0x22f06a===void 0x0?void 0x0:_0x22f06a[_0x5ec6e5(0x100)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x52e749=await(0x0,helper_1[_0x5ec6e5(0x106)])(_0x434fde,_0x31c474,_0xe5015d);const {prompt_tokens:_0x227cf8,completion_tokens:_0x12ac8a,total_tokens:_0x1cc474}=_0x4dc792[_0x5ec6e5(0x132)](_0x5ec6e5(0x11e))?_0xbb8e13:_0x52e749['usage'];let _0x421b9a=_0x169ad0;_0x592e18===!![]&&(_0x421b9a=Math[_0x5ec6e5(0x133)](_0x169ad0*_0x1cc474/_0x2262bb));await this[_0x5ec6e5(0x199)][_0x5ec6e5(0xcb)](_0x18ccf2[_0x5ec6e5(0x1b5)]['id'],_0x5ec6e5(0x102)+(_0x374a43===0x1?0x3:0x4),_0x421b9a,_0x1cc474),await this[_0x5ec6e5(0xf6)][_0x5ec6e5(0x16a)](_0x1b8168,_0x1cc474);const _0x4e26b4=(0x0,utils_1[_0x5ec6e5(0x145)])(_0x18ccf2);await this[_0x5ec6e5(0x1c9)][_0x5ec6e5(0x164)]({'appId':_0x231432,'curIp':_0x4e26b4,'userId':_0x18ccf2[_0x5ec6e5(0x1b5)]['id'],'type':balance_constant_1[_0x5ec6e5(0x152)][_0x5ec6e5(0x112)],'prompt':_0x42b572,'imageUrl':_0x24380a,'activeModel':_0x5a2c76,'answer':'','promptTokens':_0x227cf8,'completionTokens':0x0,'totalTokens':_0x1cc474,'model':_0x4dc792,'role':_0x5ec6e5(0x1b5),'groupId':_0x57d0f5,'requestOptions':JSON[_0x5ec6e5(0x116)]({'options':null,'prompt':_0x42b572})}),await this['chatLogService'][_0x5ec6e5(0x164)]({'appId':_0x231432,'curIp':_0x4e26b4,'userId':_0x18ccf2['user']['id'],'type':balance_constant_1[_0x5ec6e5(0x152)][_0x5ec6e5(0x112)],'prompt':_0x42b572,'imageUrl':_0x31c474===null||_0x31c474===void 0x0?void 0x0:_0x31c474[_0x5ec6e5(0x12a)],'answer':_0x31c474[_0x5ec6e5(0x17c)],'promptTokens':_0x227cf8,'completionTokens':_0x12ac8a,'totalTokens':_0x1cc474,'model':_0x4dc792,'role':_0x5ec6e5(0x193),'groupId':_0x57d0f5,'requestOptions':JSON[_0x5ec6e5(0x116)]({'options':{'model':_0x4dc792,'temperature':_0x2e7669},'prompt':_0x42b572}),'conversationOptions':JSON[_0x5ec6e5(0x116)]({'conversationId':_0x31c474[_0x5ec6e5(0x1c6)],'model':_0x4dc792,'parentMessageId':_0x31c474['id'],'temperature':_0x2e7669})}),common_1[_0x5ec6e5(0x114)][_0x5ec6e5(0x1ab)](_0x5ec6e5(0x162)+_0x18ccf2[_0x5ec6e5(0x1b5)]['id']+_0x5ec6e5(0xdd)+_0x36ab2c+'-'+_0x5a2c76+_0x5ec6e5(0xfa)+_0x1cc474+_0x5ec6e5(0x184)+_0x421b9a,_0x5ec6e5(0x148));const _0x16d75f=await this['userBalanceService'][_0x5ec6e5(0x15d)](_0x18ccf2[_0x5ec6e5(0x1b5)]['id']);return _0x31c474['userBanance']=Object['assign']({},_0x16d75f),_0x31c474[_0x5ec6e5(0x197)]&&(_0x31c474[_0x5ec6e5(0x197)]=''),_0x31c474[_0x5ec6e5(0x10b)]=!![],_0x30af8a?_0x30af8a[_0x5ec6e5(0x1a0)]('\x0a'+JSON[_0x5ec6e5(0x116)](_0x31c474)):_0x31c474['text'];}catch(_0x354f6f){console['log'](_0x5ec6e5(0x1b3),_0x497d70,_0x354f6f);const _0x29c352=(_0x354f6f===null||_0x354f6f===void 0x0?void 0x0:_0x354f6f[_0x5ec6e5(0x163)])||0x190,_0x1d8a14=((_0x46ef25=_0x354f6f===null||_0x354f6f===void 0x0?void 0x0:_0x354f6f['response'])===null||_0x46ef25===void 0x0?void 0x0:_0x46ef25[_0x5ec6e5(0xd3)])||(_0x354f6f===null||_0x354f6f===void 0x0?void 0x0:_0x354f6f[_0x5ec6e5(0x163)])||0x190;console['log']('chat-error-detail\x20\x20<----------------------------------------->',_0x5ec6e5(0xf8),_0x29c352,_0x5ec6e5(0x15b),_0x354f6f===null||_0x354f6f===void 0x0?void 0x0:_0x354f6f['message'],'statusText:',(_0x58baf0=_0x354f6f===null||_0x354f6f===void 0x0?void 0x0:_0x354f6f[_0x5ec6e5(0x14e)])===null||_0x58baf0===void 0x0?void 0x0:_0x58baf0[_0x5ec6e5(0x13e)],_0x5ec6e5(0xd3),(_0x2fa440=_0x354f6f===null||_0x354f6f===void 0x0?void 0x0:_0x354f6f['response'])===null||_0x2fa440===void 0x0?void 0x0:_0x2fa440['status']);if(_0x354f6f[_0x5ec6e5(0xd3)]&&_0x354f6f['status']===0x192){const _0x465818={'message':_0x5ec6e5(0x1bc)+_0x354f6f[_0x5ec6e5(0x15b)],'code':0x192};if(_0x30af8a)return _0x30af8a['write'](JSON[_0x5ec6e5(0x116)](_0x465818));else throw new common_1['HttpException'](_0x354f6f['message'],common_1['HttpStatus']['PAYMENT_REQUIRED']);}if(!_0x1d8a14){if(_0x30af8a)return _0x30af8a[_0x5ec6e5(0x1a0)](JSON['stringify']({'message':_0x354f6f['message'],'code':0x1f4}));else throw new common_1['HttpException'](_0x354f6f[_0x5ec6e5(0x15b)],common_1['HttpStatus'][_0x5ec6e5(0x18d)]);}let _0x1c2aa6=errorMessage_constant_1[_0x5ec6e5(0x1bb)][_0x1d8a14]?errorMessage_constant_1[_0x5ec6e5(0x1bb)][_0x1d8a14]:'服务异常、请重新试试吧！！！';(_0x354f6f===null||_0x354f6f===void 0x0?void 0x0:_0x354f6f[_0x5ec6e5(0x15b)][_0x5ec6e5(0x132)](_0x5ec6e5(0x155)))&&Number(_0x434fde)===0x1&&(await this[_0x5ec6e5(0xf6)][_0x5ec6e5(0x13f)](_0x1b8168,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0x1c2aa6=_0x5ec6e5(0xd6));(_0x354f6f===null||_0x354f6f===void 0x0?void 0x0:_0x354f6f['statusCode'])===0x1ad&&_0x354f6f[_0x5ec6e5(0x15b)]['includes']('billing')&&Number(_0x434fde)===0x1&&(await this[_0x5ec6e5(0xf6)][_0x5ec6e5(0x13f)](_0x1b8168,'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x1c2aa6='当前模型key余额已耗尽');(_0x354f6f===null||_0x354f6f===void 0x0?void 0x0:_0x354f6f['statusCode'])===0x1ad&&(_0x354f6f===null||_0x354f6f===void 0x0?void 0x0:_0x354f6f[_0x5ec6e5(0x13e)])===_0x5ec6e5(0x12c)&&(_0x1c2aa6=_0x5ec6e5(0x1bf));(_0x354f6f===null||_0x354f6f===void 0x0?void 0x0:_0x354f6f[_0x5ec6e5(0x163)])===0x191&&_0x354f6f[_0x5ec6e5(0x15b)][_0x5ec6e5(0x132)]('Incorrect\x20API\x20key\x20provided')&&Number(_0x434fde)===0x1&&(await this[_0x5ec6e5(0xf6)][_0x5ec6e5(0x13f)](_0x1b8168,_0x5ec6e5(0x119),-0x2),_0x1c2aa6='提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！');(_0x354f6f===null||_0x354f6f===void 0x0?void 0x0:_0x354f6f[_0x5ec6e5(0x163)])===0x194&&_0x354f6f[_0x5ec6e5(0x15b)][_0x5ec6e5(0x132)](_0x5ec6e5(0x142))&&Number(_0x434fde)===0x1&&(await this[_0x5ec6e5(0xf6)][_0x5ec6e5(0x13f)](_0x1b8168,_0x5ec6e5(0x17d),-0x4),_0x1c2aa6=_0x5ec6e5(0x165));_0x29c352===0x190&&console['log']('400\x20error',_0x354f6f,_0x354f6f[_0x5ec6e5(0x15b)]);const _0x37f88a={'message':_0x1c2aa6||_0x5ec6e5(0x17f),'code':_0x29c352===0x191?0x190:_0x29c352||0x1f4};if(_0x30af8a)return _0x30af8a[_0x5ec6e5(0x1a0)](JSON[_0x5ec6e5(0x116)](_0x37f88a));else throw new common_1['HttpException'](_0x37f88a[_0x5ec6e5(0x15b)],common_1[_0x5ec6e5(0x198)]['BAD_REQUEST']);}finally{_0x30af8a&&_0x30af8a[_0x5ec6e5(0x1a7)]();}}async[_0x3b035d(0x141)](_0xe32452,_0x335e58){const _0x2d7eed=_0x3b035d;var _0x17398e,_0x505998,_0x3a5f2c,_0x396f0e;await this[_0x2d7eed(0x1cc)]['checkBadWords'](_0xe32452[_0x2d7eed(0x135)],_0x335e58[_0x2d7eed(0x1b5)]['id']),await this[_0x2d7eed(0x195)][_0x2d7eed(0xe7)](_0x335e58['user']);const _0x224122=(_0xe32452===null||_0xe32452===void 0x0?void 0x0:_0xe32452[_0x2d7eed(0x1a3)])==='hd'?0x4:0x2;await this[_0x2d7eed(0x199)]['validateBalance'](_0x335e58,_0x2d7eed(0x110),_0x224122);let _0x2fd8cd=[];const _0x80bd57=await this[_0x2d7eed(0xf6)][_0x2d7eed(0x1bd)]('dall-e-3'),_0x35a409=_0x80bd57===null||_0x80bd57===void 0x0?void 0x0:_0x80bd57['id'],{key:_0x3074ba,proxyResUrl:_0x1ce771}=await this[_0x2d7eed(0x1b0)](_0x80bd57);common_1['Logger']['log'](_0x2d7eed(0x122)+_0xe32452[_0x2d7eed(0x135)]+_0x2d7eed(0xec)+_0x3074ba,_0x2d7eed(0x1cb));try{const _0x157b67=_0x1ce771+_0x2d7eed(0x138),_0x4c0bf2=Object[_0x2d7eed(0xd9)](Object['assign']({},_0xe32452),{'model':_0x2d7eed(0x1b4)});console['log'](_0x2d7eed(0x117),_0x4c0bf2);const _0x213140=await axios_1[_0x2d7eed(0x169)][_0x2d7eed(0x160)](_0x157b67,Object[_0x2d7eed(0xd9)](Object[_0x2d7eed(0xd9)]({},_0x4c0bf2),{'response_format':_0x2d7eed(0xdf)}),{'headers':{'Authorization':_0x2d7eed(0x186)+_0x3074ba}});_0x2fd8cd=_0x213140['data'][_0x2d7eed(0x12e)];const _0x176aa1=[];for(const _0x52f2b8 of _0x2fd8cd){const _0x42b574=uuid['v4']()[_0x2d7eed(0x1aa)](0x0,0xa)+_0x2d7eed(0x121),_0x47542e=Buffer['from'](_0x52f2b8['b64_json'],_0x2d7eed(0x1c5));_0x176aa1['push'](this[_0x2d7eed(0x1cd)]['uploadFile']({'filename':_0x42b574,'buffer':_0x47542e}));}const _0x5e9461=await Promise[_0x2d7eed(0x137)](_0x176aa1);await this[_0x2d7eed(0x199)][_0x2d7eed(0xcb)](_0x335e58[_0x2d7eed(0x1b5)]['id'],_0x2d7eed(0x110),(_0x4c0bf2===null||_0x4c0bf2===void 0x0?void 0x0:_0x4c0bf2['quality'])===_0x2d7eed(0x105)?0x2:0x4,_0x224122);const _0x2a4592=(0x0,utils_1['getClientIp'])(_0x335e58),_0x470ac4=[],_0x19bae2=await this[_0x2d7eed(0x1cd)][_0x2d7eed(0x16d)](),[_0x338b14,_0x48c4a1]=_0xe32452[_0x2d7eed(0x129)][_0x2d7eed(0x1c3)]('x');return _0x5e9461[_0x2d7eed(0x19e)](_0x18338c=>{const _0x3138fb=_0x2d7eed;_0x470ac4[_0x3138fb(0x151)](this[_0x3138fb(0x1c9)][_0x3138fb(0x164)]({'curIp':_0x2a4592,'userId':_0x335e58[_0x3138fb(0x1b5)]['id'],'type':balance_constant_1['DeductionKey'][_0x3138fb(0xfd)],'prompt':_0xe32452[_0x3138fb(0x135)],'answer':_0x18338c,'fileInfo':JSON['stringify']({'cosType':_0x19bae2,'width':_0x338b14,'height':_0x48c4a1,'cosUrl':_0x18338c}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x3138fb(0x1b4)}));}),await Promise[_0x2d7eed(0x137)](_0x470ac4),_0x5e9461;}catch(_0x2d8847){const _0x44ab5f=((_0x17398e=_0x2d8847===null||_0x2d8847===void 0x0?void 0x0:_0x2d8847[_0x2d7eed(0x14e)])===null||_0x17398e===void 0x0?void 0x0:_0x17398e[_0x2d7eed(0xd3)])||0x1f4;console['log'](_0x2d7eed(0x192),JSON[_0x2d7eed(0x116)](_0x2d8847),_0x3074ba,_0x44ab5f);const _0x6bc23e=(_0x396f0e=(_0x3a5f2c=(_0x505998=_0x2d8847===null||_0x2d8847===void 0x0?void 0x0:_0x2d8847['response'])===null||_0x505998===void 0x0?void 0x0:_0x505998[_0x2d7eed(0x12e)])===null||_0x3a5f2c===void 0x0?void 0x0:_0x3a5f2c[_0x2d7eed(0x158)])===null||_0x396f0e===void 0x0?void 0x0:_0x396f0e[_0x2d7eed(0x15b)];if(_0x44ab5f===0x1ad)throw new common_1[(_0x2d7eed(0xe8))](_0x2d7eed(0x173),common_1[_0x2d7eed(0x198)][_0x2d7eed(0x18d)]);if(_0x44ab5f===0x190&&_0x6bc23e['includes'](_0x2d7eed(0x147)))throw new common_1[(_0x2d7eed(0xe8))](_0x2d7eed(0x167),common_1[_0x2d7eed(0x198)]['BAD_REQUEST']);if(_0x44ab5f===0x190&&_0x6bc23e[_0x2d7eed(0x132)](_0x2d7eed(0x1c2))){await this['modelsService'][_0x2d7eed(0x13f)](_0x35a409,_0x2d7eed(0x108),-0x1);throw new common_1[(_0x2d7eed(0xe8))](_0x2d7eed(0x18a),common_1[_0x2d7eed(0x198)][_0x2d7eed(0x18d)]);}if(_0x44ab5f===0x1f4)throw new common_1[(_0x2d7eed(0xe8))](_0x2d7eed(0x174),common_1['HttpStatus']['BAD_REQUEST']);if(_0x44ab5f===0x191)throw new common_1[(_0x2d7eed(0xe8))](_0x2d7eed(0xd5),common_1['HttpStatus']['BAD_REQUEST']);throw new common_1[(_0x2d7eed(0xe8))]('绘制图片失败，请稍后试试吧！',common_1[_0x2d7eed(0x198)][_0x2d7eed(0x18d)]);}}async[_0x3b035d(0x1a4)](){const _0x1aaa98=_0x3b035d,_0xd93eed=await this['gptKeysEntity'][_0x1aaa98(0x1c0)]({'where':{'status':0x1},'select':['id','key',_0x1aaa98(0xeb),_0x1aaa98(0x102),'maxModelTokens',_0x1aaa98(0x131),_0x1aaa98(0x118),'openaiTimeoutMs']}),_0x1ebd36=_0xd93eed[_0x1aaa98(0xe5)](_0x27e899=>_0x27e899['model']['includes'](_0x1aaa98(0x1c8))),_0x191887=_0xd93eed[_0x1aaa98(0xe5)](_0x1bbba2=>_0x1bbba2[_0x1aaa98(0x102)]['includes'](_0x1aaa98(0x13b)));this['keyPool']={'list3':_0x1ebd36,'list4':_0x191887};}async[_0x3b035d(0xf7)](_0x222c03){const _0x194e97=_0x3b035d,_0x215b5d=await this[_0x194e97(0x177)][_0x194e97(0x127)]([_0x194e97(0xe3)]);return(_0x222c03===null||_0x222c03===void 0x0?void 0x0:_0x222c03['proxyUrl'])||_0x215b5d||'https://api.openai.com';}async[_0x3b035d(0x1b0)](_0x38e9ac){const _0x37e2f3=_0x3b035d,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x37e2f3(0x177)][_0x37e2f3(0x127)]([_0x37e2f3(0x11a),_0x37e2f3(0x1b7),_0x37e2f3(0x15e),_0x37e2f3(0x176),_0x37e2f3(0x14c),'openaiModel4MaxTokensRes','openaiModel4MaxTokens32k','openaiModel4MaxTokens32kRes','openaiBaseUrl']);let _0x3f506b=null,_0x2c022c=null,_0xf6df3=null,{model:_0x1fea01,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x37dbe7}=_0x38e9ac;return _0x1fea01['toLowerCase']()['includes'](_0x37e2f3(0x13b))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x2c022c>=0x1000&&(maxModelTokens=0x1000),_0x3f506b=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x2c022c=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x1fea01['toLowerCase']()['includes'](_0x37e2f3(0x1af))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x2c022c>=0x4000&&(maxModelTokens=0x4000),_0x3f506b=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x2c022c=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x1fea01[_0x37e2f3(0x188)]()[_0x37e2f3(0x132)](_0x37e2f3(0x19b))&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x2c022c>=0x1000&&(maxModelTokens=0x1000),_0x3f506b=maxModelTokens||0x3ffc,_0x2c022c=maxResponseTokens||0x1000)),_0x1fea01['toLowerCase']()[_0x37e2f3(0x132)](_0x37e2f3(0x1c8))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x2c022c>=0x7d0&&(maxModelTokens=0x7d0),_0x3f506b=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x2c022c=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x1fea01[_0x37e2f3(0x188)]()[_0x37e2f3(0x132)](_0x37e2f3(0x10e))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x2c022c>=0x2000&&(maxModelTokens=0x2000),_0x3f506b=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x2c022c=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x1fea01[_0x37e2f3(0x188)]()[_0x37e2f3(0x132)](_0x37e2f3(0x19b))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x2c022c>=0x1000&&(maxModelTokens=0x1000),_0x3f506b=maxModelTokens||0x4000,_0x2c022c=maxResponseTokens||0x1000)),_0xf6df3=proxyUrl||openaiBaseUrl||_0x37e2f3(0x1d0),_0x2c022c>=_0x3f506b&&(_0x2c022c=Math['floor'](_0x3f506b/0x2)),{'key':_0x37dbe7,'maxToken':_0x3f506b,'maxTokenRes':_0x2c022c,'proxyResUrl':_0xf6df3};}async['setChatBoxType'](_0x5f6a61,_0x14fe61){const _0x19147a=_0x3b035d;try{const {name:_0x3e88aa,icon:_0x3a822f,order:_0x1fdc37,id:_0x333833,status:_0x39b28a}=_0x14fe61;return _0x333833?await this[_0x19147a(0x18f)][_0x19147a(0xcc)]({'id':_0x333833},{'name':_0x3e88aa,'icon':_0x3a822f,'order':_0x1fdc37,'status':_0x39b28a}):await this[_0x19147a(0x18f)][_0x19147a(0xef)]({'name':_0x3e88aa,'icon':_0x3a822f,'order':_0x1fdc37,'status':_0x39b28a});}catch(_0x245217){console['log'](_0x19147a(0x157),_0x245217);}}async[_0x3b035d(0x175)](_0x400da5,_0x2a3bc6){const _0x2e193e=_0x3b035d,{id:_0x3562e0}=_0x2a3bc6;if(!_0x3562e0)throw new common_1[(_0x2e193e(0xe8))]('非法操作！',common_1[_0x2e193e(0x198)][_0x2e193e(0x18d)]);const _0x2c0f60=await this[_0x2e193e(0x124)]['count']({'where':{'typeId':_0x3562e0}});if(_0x2c0f60)throw new common_1[(_0x2e193e(0xe8))]('当前分类下有未处理数据不可移除！',common_1['HttpStatus'][_0x2e193e(0x18d)]);return await this[_0x2e193e(0x18f)][_0x2e193e(0x14f)]({'id':_0x3562e0});}async[_0x3b035d(0x161)](){const _0x22a930=_0x3b035d;return await this[_0x22a930(0x18f)][_0x22a930(0x1c0)]({'order':{'order':_0x22a930(0x120)}});}async[_0x3b035d(0x14a)](_0x467d88,_0x165c94){const _0x894945=_0x3b035d,{title:_0x464b65,prompt:_0x43e3ed,appId:_0x5903ad,order:_0x5c0145,status:_0x1d4309,typeId:_0x504065,id:_0x4c660b,url:_0xf40421}=_0x165c94;if(!_0x504065)throw new common_1[(_0x894945(0xe8))](_0x894945(0x1ad),common_1[_0x894945(0x198)][_0x894945(0x18d)]);try{const _0x379909={'title':_0x464b65,'order':_0x5c0145,'status':_0x1d4309,'typeId':_0x504065,'url':_0xf40421};return _0x379909[_0x894945(0xe9)]=_0x5903ad||0x0,_0x379909[_0x894945(0x135)]=_0x43e3ed||'',_0x4c660b?await this[_0x894945(0x124)][_0x894945(0xcc)]({'id':_0x4c660b},_0x379909):await this[_0x894945(0x124)][_0x894945(0xef)](_0x379909);}catch(_0x12de1e){console[_0x894945(0x17b)]('error:\x20',_0x12de1e);}}async[_0x3b035d(0x140)](_0x207c7f,_0x483699){const _0x1922f4=_0x3b035d,{id:_0x43fa45}=_0x483699;if(!_0x43fa45)throw new common_1[(_0x1922f4(0xe8))](_0x1922f4(0x1a8),common_1[_0x1922f4(0x198)]['BAD_REQUEST']);return await this[_0x1922f4(0x124)][_0x1922f4(0x14f)]({'id':_0x43fa45});}async['queryChatBox'](){const _0x329bd4=_0x3b035d,_0xe9c127=await this[_0x329bd4(0x124)][_0x329bd4(0x1c0)]({'order':{'order':'DESC'}}),_0x1cae86=[...new Set(_0xe9c127[_0x329bd4(0x178)](_0x298574=>_0x298574[_0x329bd4(0x1b8)]))],_0x167501=[...new Set(_0xe9c127['map'](_0x4cd07e=>_0x4cd07e['appId']))],_0x11d10f=await this['chatBoxTypeEntity'][_0x329bd4(0x1c0)]({'where':{'id':(0x0,typeorm_1['In'])(_0x1cae86)}}),_0x55d178=await this['appEntity'][_0x329bd4(0x1c0)]({'where':{'id':(0x0,typeorm_1['In'])(_0x167501)}});return _0xe9c127[_0x329bd4(0x178)](_0x9badd6=>{const _0x4edf82=_0x329bd4,{typeId:_0x3eeb6f,appId:_0x30d4dd}=_0x9badd6;return _0x9badd6[_0x4edf82(0x10c)]=_0x11d10f[_0x4edf82(0x1c0)](_0x1f568d=>_0x1f568d['id']===_0x3eeb6f),_0x9badd6[_0x4edf82(0x144)]=_0x55d178[_0x4edf82(0x1c0)](_0x208699=>_0x208699['id']===_0x30d4dd),_0x9badd6;});}async[_0x3b035d(0x16b)](){const _0x335ddb=_0x3b035d,_0x405c34=await this[_0x335ddb(0x18f)][_0x335ddb(0x1c0)]({'order':{'order':_0x335ddb(0x120)},'where':{'status':!![]}}),_0x4534d1=await this[_0x335ddb(0x124)][_0x335ddb(0x1c0)]({'where':{'status':!![]}}),_0x55bc65=[...new Set(_0x4534d1[_0x335ddb(0x178)](_0x16b2c9=>_0x16b2c9[_0x335ddb(0xe9)]))],_0x524ea7=await this[_0x335ddb(0x1ae)][_0x335ddb(0x1c0)]({'where':{'id':(0x0,typeorm_1['In'])(_0x55bc65)}});return _0x4534d1[_0x335ddb(0x19e)](_0x60ea57=>{const _0x4d5d92=_0x335ddb,_0x2a4eb7=_0x524ea7['find'](_0x2f3043=>_0x2f3043['id']===_0x60ea57[_0x4d5d92(0xe9)]);return _0x60ea57['coverImg']=_0x2a4eb7===null||_0x2a4eb7===void 0x0?void 0x0:_0x2a4eb7[_0x4d5d92(0x1c7)],_0x60ea57;}),_0x405c34[_0x335ddb(0x178)](_0x1c22f9=>{const _0x33f14d=_0x335ddb;return _0x1c22f9['childList']=_0x4534d1[_0x33f14d(0xe5)](_0x1b3408=>_0x1b3408[_0x33f14d(0x1b8)]===_0x1c22f9['id']&&_0x1b3408['status']),_0x1c22f9;});}async[_0x3b035d(0xe1)](_0xb4b9ea,_0x41373f){const _0x38fa7e=_0x3b035d;try{const {name:_0x2c723e,icon:_0x1c48b9,order:_0x37f04c,id:_0x1713fd,status:_0x1ce68d}=_0x41373f;return _0x1713fd?await this[_0x38fa7e(0x13d)][_0x38fa7e(0xcc)]({'id':_0x1713fd},{'name':_0x2c723e,'icon':_0x1c48b9,'order':_0x37f04c,'status':_0x1ce68d}):await this['chatPreTypeEntity']['save']({'name':_0x2c723e,'icon':_0x1c48b9,'order':_0x37f04c,'status':_0x1ce68d});}catch(_0x54d388){console[_0x38fa7e(0x17b)](_0x38fa7e(0x157),_0x54d388);}}async[_0x3b035d(0x125)](_0x3009d7,_0x3e08dd){const _0x367e2f=_0x3b035d,{id:_0x3b9328}=_0x3e08dd;if(!_0x3b9328)throw new common_1[(_0x367e2f(0xe8))](_0x367e2f(0x1a8),common_1[_0x367e2f(0x198)]['BAD_REQUEST']);const _0x2ab697=await this['chatBoxEntity'][_0x367e2f(0xfb)]({'where':{'typeId':_0x3b9328}});if(_0x2ab697)throw new common_1[(_0x367e2f(0xe8))]('当前分类下有未处理数据不可移除！',common_1[_0x367e2f(0x198)][_0x367e2f(0x18d)]);return await this[_0x367e2f(0x13d)][_0x367e2f(0x14f)]({'id':_0x3b9328});}async[_0x3b035d(0x17a)](){const _0x4ce358=_0x3b035d;return await this[_0x4ce358(0x13d)][_0x4ce358(0x1c0)]({'order':{'order':_0x4ce358(0x120)}});}async['setChatPre'](_0x530772,_0x39de91){const _0x49ca6b=_0x3b035d,{title:_0xa564b6,prompt:_0x1b32e4,appId:_0x1190fa,order:_0x4c7648,status:_0xce3da3,typeId:_0xfd48ec,id:_0x26b397,url:_0x3e054f}=_0x39de91;if(!_0xfd48ec)throw new common_1['HttpException']('缺失必要参数！',common_1[_0x49ca6b(0x198)]['BAD_REQUEST']);try{const _0x4cb75e={'title':_0xa564b6,'prompt':_0x1b32e4,'order':_0x4c7648,'status':_0xce3da3,'typeId':_0xfd48ec,'url':_0x3e054f};return _0x26b397?await this[_0x49ca6b(0xfe)][_0x49ca6b(0xcc)]({'id':_0x26b397},_0x4cb75e):await this['chatPreEntity'][_0x49ca6b(0xef)](_0x4cb75e);}catch(_0x29c165){console[_0x49ca6b(0x17b)](_0x49ca6b(0x157),_0x29c165);}}async[_0x3b035d(0x179)](_0x6a7a7c,_0xe338d9){const _0x420219=_0x3b035d,{id:_0x2ebaa7}=_0xe338d9;if(!_0x2ebaa7)throw new common_1[(_0x420219(0xe8))](_0x420219(0x1a8),common_1[_0x420219(0x198)]['BAD_REQUEST']);return await this[_0x420219(0xfe)]['delete']({'id':_0x2ebaa7});}async[_0x3b035d(0x15f)](){const _0x2830a0=_0x3b035d,_0x328371=await this['chatPreEntity'][_0x2830a0(0x1c0)]({'order':{'order':_0x2830a0(0x120)}}),_0x18ca1b=[...new Set(_0x328371[_0x2830a0(0x178)](_0x54eeda=>_0x54eeda['typeId']))],_0xf047a1=await this[_0x2830a0(0x13d)][_0x2830a0(0x1c0)]({'where':{'id':(0x0,typeorm_1['In'])(_0x18ca1b)}});return _0x328371[_0x2830a0(0x178)](_0x310964=>{const _0x3faa5b=_0x2830a0,{typeId:_0x347674,appId:_0x2831ef}=_0x310964;return _0x310964[_0x3faa5b(0x10c)]=_0xf047a1['find'](_0x257be4=>_0x257be4['id']===_0x347674),_0x310964;});}async['queryChatPreList'](){const _0x36e1c3=_0x3b035d,_0x3cea57=await this[_0x36e1c3(0x13d)]['find']({'order':{'order':_0x36e1c3(0x120)},'where':{'status':!![]}}),_0x2b7eb9=await this[_0x36e1c3(0xfe)][_0x36e1c3(0x1c0)]({'where':{'status':!![]}});return _0x3cea57[_0x36e1c3(0x178)](_0xb8d167=>{const _0xa3c636=_0x36e1c3;return _0xb8d167[_0xa3c636(0x113)]=_0x2b7eb9[_0xa3c636(0xe5)](_0x1a7079=>_0x1a7079[_0xa3c636(0x1b8)]===_0xb8d167['id']&&_0x1a7079[_0xa3c636(0xd3)]),_0xb8d167;});}async[_0x3b035d(0xf3)](_0x3f5639,_0x5c7469,_0x2be2d5){const _0x3efe52=_0x3b035d;let _0x294d1b=0x1000,_0x35191d=0x800;return _0x3f5639['toLowerCase']()[_0x3efe52(0x132)](_0x3efe52(0x13b))&&(_0x294d1b=_0x5c7469>=0x2004?0x2004:_0x5c7469,_0x35191d=_0x2be2d5>=0x1000?0x1000:_0x2be2d5,_0x3f5639[_0x3efe52(0x188)]()[_0x3efe52(0x132)]('32k')&&(_0x294d1b=_0x5c7469>=0x8000?0x8000:_0x5c7469,_0x35191d=_0x2be2d5>=0x3e80?0x3e80:_0x2be2d5),(_0x3f5639['toLowerCase']()[_0x3efe52(0x132)](_0x3efe52(0x115))||_0x3f5639['toLowerCase']()['includes'](_0x3efe52(0x19a)))&&(_0x294d1b=_0x5c7469>=0x1f400?0x1f400:_0x5c7469,_0x35191d=_0x2be2d5>=0x1000?0x1000:_0x2be2d5)),_0x3f5639[_0x3efe52(0x188)]()[_0x3efe52(0x132)](_0x3efe52(0x1c8))&&(_0x294d1b=_0x5c7469>=0x1000?0x1000:_0x5c7469,_0x35191d=_0x2be2d5>=0x800?0x800:_0x2be2d5,_0x3f5639[_0x3efe52(0x188)]()['includes'](_0x3efe52(0x10e))&&(_0x294d1b=_0x5c7469>=0x4000?0x4000:_0x5c7469,_0x35191d=_0x2be2d5>=0x1f40?0x1f40:_0x2be2d5),_0x3f5639[_0x3efe52(0x188)]()['includes'](_0x3efe52(0x19b))&&(_0x294d1b=_0x5c7469>=0x4000?0x4000:_0x5c7469,_0x35191d=_0x2be2d5>=0x1f40?0x1f40:_0x2be2d5)),{'maxToken':_0x294d1b,'maxRes':_0x35191d};}};ChatgptService=__decorate([(0x0,common_1[_0x3b035d(0x18e)])(),__param(0x0,(0x0,typeorm_2[_0x3b035d(0xed)])(gptkeys_entity_1[_0x3b035d(0x1a6)])),__param(0x1,(0x0,typeorm_2[_0x3b035d(0xed)])(config_entity_1['ConfigEntity'])),__param(0x2,(0x0,typeorm_2[_0x3b035d(0xed)])(chatBoxType_entity_1[_0x3b035d(0xd2)])),__param(0x3,(0x0,typeorm_2[_0x3b035d(0xed)])(chatBox_entity_1[_0x3b035d(0x1b2)])),__param(0x4,(0x0,typeorm_2[_0x3b035d(0xed)])(app_entity_1[_0x3b035d(0x196)])),__param(0x5,(0x0,typeorm_2[_0x3b035d(0xed)])(chatPreType_entity_1[_0x3b035d(0x190)])),__param(0x6,(0x0,typeorm_2[_0x3b035d(0xed)])(chatPre_entity_1[_0x3b035d(0x103)])),__metadata('design:paramtypes',[typeorm_1[_0x3b035d(0x1ba)],typeorm_1['Repository'],typeorm_1['Repository'],typeorm_1[_0x3b035d(0x1ba)],typeorm_1[_0x3b035d(0x1ba)],typeorm_1['Repository'],typeorm_1[_0x3b035d(0x1ba)],nestjs_config_1[_0x3b035d(0x12b)],userBalance_service_1[_0x3b035d(0xdb)],chatLog_service_1[_0x3b035d(0x18b)],user_service_1[_0x3b035d(0x159)],upload_service_1[_0x3b035d(0xd4)],badwords_service_1['BadwordsService'],autoreply_service_1[_0x3b035d(0x171)],globalConfig_service_1[_0x3b035d(0xe0)],fanyi_service_1['FanyiService'],chatGroup_service_1[_0x3b035d(0xfc)],models_service_1[_0x3b035d(0x143)]])],ChatgptService),exports[_0x3b035d(0x148)]=ChatgptService;