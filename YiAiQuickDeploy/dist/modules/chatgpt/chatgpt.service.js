'use strict';const _0x36b9b2=_0x66a1;function _0x27ec(){const _0x1574c8=['./chatPre.entity','./chatBoxType.entity','openaiModel3MaxTokens16kRes','axios','绘制图片失败，请稍后试试吧！','chatProcess','Billing\x20hard\x20limit\x20has\x20been\x20reached','AutoreplyService','../globalConfig/config.entity','size','HttpException','metadata','decorate','status','当前请求已过载、请稍等会儿再试试吧！','importDynamic','prompt','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','16k','nestjs-config','../models/models.service','getUuid','queryChatBoxType','systemMessage','preset','all','imageUrl','assistant','statusText','userBalanceService','lockKey','用户ID:\x20','../badwords/badwords.service','PAYMENT_REQUIRED','1230424alRZeW','./openai','weight','https://api.openai.com','save','parse','1106','__esModule','end','defineProperty','userBanance','coverImg','Logger','error','slice','systemPreMessage','fanyiService','formatModelToken','ChatPreEntity','./baidu','map','delChatPreType','write','filter','push','error:\x20','5512585sKwoKg','keyv','ceil','绘制图片失败，请检查你的提示词是否有非法描述！','./chatPreType.entity','BadwordsService','__param','chatBoxTypeEntity','chatBoxEntity','queryChatPreType','message','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','chatPreEntity','DeductionKey','typeorm','32k','缺失必要参数！','setHeader','user','../fanyi/fanyi.service','\x0a\x20Current\x20date:\x20','abortController','deductFromBalance','915082XqPUPH','ChatLogService','../../common/constants/errorMessage.constant','HttpStatus','@nestjs/typeorm','PAINT_TYPE','object','ConfigService','badwordsService','configEntity','openaiModel3MaxTokens16k','ChatgptService','Please\x20check\x20the\x20back-end\x20console','400\x20error','default','./../user/user.service','sendMessageFromBaidu','ChatBoxEntity','服务异常、请重新试试吧！！！','@keyv/redis','appEntity','uuid','1004704uDdAle','DrawService','/v1/images/generations','3587773TjsBLi','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','openaiProxyUrl','getOwnPropertyDescriptor','configService','chatPreTypeEntity','delChatBox','当前模型不是聊天模型','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','openai-draw\x20error:\x20','floor','usage','design:paramtypes','\x20模型名称:\x20','getBaseConfig','code:\x20','draw','typeId','uploadFile','userService','Catch\x20Error\x20','stringify','chatgpt-ai-web','getGroupInfoFromId','log','UserBalanceService','./helper','../chatGroup/chatGroup.service','env','getClientIp','statusCode','REDIS_USER','split','OpenAiErrorCodeMessage','nineai-chatlog','Injectable','InjectRepository','sendMessageFromOpenAi','setChatPreType','gpt-4','gptKeysEntity','find','getCurrentModelKeyInfo','modelsService','getUploadType','gpt-3','GptKeysEntity','chatGroupService','result','getConfigs','setData','response','5001612EDlDZA','childList','ChatBoxTypeEntity','Content-type','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','saveChatLog',',\x20消耗积分：\x20','openaiModel4MaxTokens32kRes','dall','chatLogService','BAD_REQUEST',',\x20消耗token:\x20','queryChatPre','delChatBoxType','openaiModel4MaxTokens','draw\x20paompt\x20info\x20<==**==>\x20','../../common/constants/balance.constant','uploadService','unifiedFormattingResponse','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','keyPool','../app/app.entity','statusText:','appId','post','FanyiService','225zXoCQa','quality','saveUseLog','checkUserStatus','toISOString','非法操作！','length','./gptkeys.entity','text','__decorate','includes','buildMessageFromParentMessageId','queryChatBox','DESC','getModelProxyUrl','.png','openaiBaseUrl','toLowerCase','../chatLog/chatLog.service','gpt-4-vision-preview','chat','queryUserBalance','nineStore','getRandomDrawKey','sendMessageFromZhipu','34878EiLIpO','CHAT_TYPE','chat-error\x20<----------------------------------------->','conversationId','delete','maxResponseTokens','getTokenCount','setChatBoxType','REDIS_PORT','update','mjDraw','UploadService','typeInfo','./chatBox.entity','addOneIfOdd','提供了错误的模型秘钥','gpt-4-1106','openaiModel4MaxTokens32k','queryChatBoxFrontend','ModelsService','globalConfigService','config','chatSyncFree','compileNetwork','b64_json','./store','当前分类下有未处理数据不可移除！','abort','Repository','chat-error-detail\x20\x20<----------------------------------------->','validateBalance','redis://','Too\x20Many\x20Requests','../globalConfig/globalConfig.service','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','forEach','__metadata','from','modelInfo','is_end','./../upload/upload.service','whiteListUser','124FmalaA','绘制图片失败，此次绘画被拒绝了！','count','checkBadWords','dall-e-3','findOne','model','dall-e\x20draw\x20params:\x20','当前模型调用过于频繁、请重新试试吧！','assign','data','checkAutoReply','getAllKeyList','openaiTimeoutMs'];_0x27ec=function(){return _0x1574c8;};return _0x27ec();}function _0x66a1(_0x5d570e,_0x485b94){const _0x27ec1a=_0x27ec();return _0x66a1=function(_0x66a114,_0x503712){_0x66a114=_0x66a114-0x1d1;let _0x9c0780=_0x27ec1a[_0x66a114];return _0x9c0780;},_0x66a1(_0x5d570e,_0x485b94);}(function(_0x211de8,_0x2ebde4){const _0x2afa52=_0x66a1,_0x4e8967=_0x211de8();while(!![]){try{const _0x203ade=-parseInt(_0x2afa52(0x24c))/0x1+-parseInt(_0x2afa52(0x262))/0x2+parseInt(_0x2afa52(0x2cd))/0x3*(-parseInt(_0x2afa52(0x1eb))/0x4)+-parseInt(_0x2afa52(0x235))/0x5+-parseInt(_0x2afa52(0x299))/0x6+parseInt(_0x2afa52(0x265))/0x7+parseInt(_0x2afa52(0x21b))/0x8*(parseInt(_0x2afa52(0x2b4))/0x9);if(_0x203ade===_0x2ebde4)break;else _0x4e8967['push'](_0x4e8967['shift']());}catch(_0x2f4584){_0x4e8967['push'](_0x4e8967['shift']());}}}(_0x27ec,0x9d247));var __decorate=this&&this[_0x36b9b2(0x2bd)]||function(_0x57729d,_0x26f325,_0x47fb44,_0x222d3e){const _0x39f11c=_0x36b9b2;var _0x5f35e0=arguments[_0x39f11c(0x2ba)],_0x22dd91=_0x5f35e0<0x3?_0x26f325:_0x222d3e===null?_0x222d3e=Object[_0x39f11c(0x268)](_0x26f325,_0x47fb44):_0x222d3e,_0x392a68;if(typeof Reflect===_0x39f11c(0x252)&&typeof Reflect[_0x39f11c(0x205)]==='function')_0x22dd91=Reflect[_0x39f11c(0x205)](_0x57729d,_0x26f325,_0x47fb44,_0x222d3e);else{for(var _0x14ff99=_0x57729d[_0x39f11c(0x2ba)]-0x1;_0x14ff99>=0x0;_0x14ff99--)if(_0x392a68=_0x57729d[_0x14ff99])_0x22dd91=(_0x5f35e0<0x3?_0x392a68(_0x22dd91):_0x5f35e0>0x3?_0x392a68(_0x26f325,_0x47fb44,_0x22dd91):_0x392a68(_0x26f325,_0x47fb44))||_0x22dd91;}return _0x5f35e0>0x3&&_0x22dd91&&Object[_0x39f11c(0x224)](_0x26f325,_0x47fb44,_0x22dd91),_0x22dd91;},__metadata=this&&this[_0x36b9b2(0x1e5)]||function(_0x2dbce1,_0x1e7f77){const _0x1df0e1=_0x36b9b2;if(typeof Reflect===_0x1df0e1(0x252)&&typeof Reflect[_0x1df0e1(0x204)]==='function')return Reflect[_0x1df0e1(0x204)](_0x2dbce1,_0x1e7f77);},__param=this&&this[_0x36b9b2(0x23b)]||function(_0xc184fc,_0x53ae1e){return function(_0x4d22a4,_0x561d5f){_0x53ae1e(_0x4d22a4,_0x561d5f,_0xc184fc);};};Object[_0x36b9b2(0x224)](exports,_0x36b9b2(0x222),{'value':!![]}),exports[_0x36b9b2(0x257)]=void 0x0;const upload_service_1=require(_0x36b9b2(0x1e9)),user_service_1=require(_0x36b9b2(0x25b)),nestjs_config_1=require(_0x36b9b2(0x20c)),common_1=require('@nestjs/common'),errorMessage_constant_1=require(_0x36b9b2(0x24e)),utils_1=require('../../common/utils'),axios_1=require(_0x36b9b2(0x1fc)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require(_0x36b9b2(0x2aa)),chatLog_service_1=require(_0x36b9b2(0x2c6)),uuid=require(_0x36b9b2(0x261)),config_entity_1=require(_0x36b9b2(0x201)),typeorm_1=require(_0x36b9b2(0x243)),typeorm_2=require(_0x36b9b2(0x250)),badwords_service_1=require(_0x36b9b2(0x219)),autoreply_service_1=require('../autoreply/autoreply.service'),gptkeys_entity_1=require(_0x36b9b2(0x2bb)),globalConfig_service_1=require(_0x36b9b2(0x1e2)),fanyi_service_1=require(_0x36b9b2(0x248)),app_entity_1=require(_0x36b9b2(0x2af)),chatGroup_service_1=require(_0x36b9b2(0x280)),models_service_1=require(_0x36b9b2(0x20d)),baidu_1=require(_0x36b9b2(0x22e)),helper_1=require(_0x36b9b2(0x27f)),store_1=require(_0x36b9b2(0x1da)),zhipu_1=require('./zhipu'),openai_1=require(_0x36b9b2(0x21c)),chatBoxType_entity_1=require(_0x36b9b2(0x1fa)),chatBox_entity_1=require(_0x36b9b2(0x2da)),chatPre_entity_1=require(_0x36b9b2(0x1f9)),chatPreType_entity_1=require(_0x36b9b2(0x239));let ChatgptService=class ChatgptService{constructor(_0x77a7b,_0x133bdd,_0x8cb3ab,_0x1ed533,_0x1cf1f8,_0x269813,_0x4214d6,_0x3a8383,_0x10a0ee,_0x2eab50,_0xae5fc5,_0xcb1d89,_0xef6953,_0x49591e,_0x57460d,_0x4b3a0a,_0x541d42,_0x561b6){const _0x1a2a6a=_0x36b9b2;this['gptKeysEntity']=_0x77a7b,this[_0x1a2a6a(0x255)]=_0x133bdd,this['chatBoxTypeEntity']=_0x8cb3ab,this['chatBoxEntity']=_0x1ed533,this[_0x1a2a6a(0x260)]=_0x1cf1f8,this[_0x1a2a6a(0x26a)]=_0x269813,this[_0x1a2a6a(0x241)]=_0x4214d6,this[_0x1a2a6a(0x269)]=_0x3a8383,this[_0x1a2a6a(0x216)]=_0x10a0ee,this[_0x1a2a6a(0x2a3)]=_0x2eab50,this[_0x1a2a6a(0x278)]=_0xae5fc5,this[_0x1a2a6a(0x2ab)]=_0xcb1d89,this[_0x1a2a6a(0x254)]=_0xef6953,this['autoreplyService']=_0x49591e,this[_0x1a2a6a(0x1d5)]=_0x57460d,this[_0x1a2a6a(0x22b)]=_0x4b3a0a,this[_0x1a2a6a(0x294)]=_0x541d42,this[_0x1a2a6a(0x290)]=_0x561b6,this['nineStore']=null,this[_0x1a2a6a(0x1ea)]=[],this[_0x1a2a6a(0x2ae)]={'list3':[],'list4':[]};}async['onModuleInit'](){const _0x447289=_0x36b9b2;let _0x10e052=await(0x0,utils_1[_0x447289(0x208)])(_0x447289(0x27b)),_0x57985d=await(0x0,utils_1[_0x447289(0x208)])(_0x447289(0x25f)),_0x15e50c=await(0x0,utils_1[_0x447289(0x208)])(_0x447289(0x236));_0x10e052=(_0x10e052===null||_0x10e052===void 0x0?void 0x0:_0x10e052[_0x447289(0x25a)])?_0x10e052[_0x447289(0x25a)]:_0x10e052,_0x57985d=(_0x57985d===null||_0x57985d===void 0x0?void 0x0:_0x57985d['default'])?_0x57985d[_0x447289(0x25a)]:_0x57985d,_0x15e50c=(_0x15e50c===null||_0x15e50c===void 0x0?void 0x0:_0x15e50c['default'])?_0x15e50c[_0x447289(0x25a)]:_0x15e50c;const {ChatGPTAPI:_0x3a8a40,ChatGPTError:_0x215932,ChatGPTUnofficialProxyAPI:_0x501eb3}=_0x10e052,_0x59d476=+process[_0x447289(0x281)][_0x447289(0x2d5)],_0x5c37cc=process['env']['REDIS_HOST'],_0x314436=process[_0x447289(0x281)]['REDIS_PASSWORD'],_0x14823a=process[_0x447289(0x281)][_0x447289(0x284)],_0x4b59a1=_0x447289(0x1e0)+(_0x14823a||'')+':'+(_0x314436||'')+'@'+_0x5c37cc+':'+_0x59d476,_0x24e284=new _0x57985d(_0x4b59a1),_0x2d98bf=new _0x15e50c({'store':_0x24e284,'namespace':_0x447289(0x287)});this[_0x447289(0x2ca)]=new store_1['NineStore']({'store':_0x2d98bf,'namespace':_0x447289(0x2c8)});}async['getRequestParams'](_0x53d6d9,_0x42cfae,_0x4059de,_0x1b9297=null){const _0x1141e6=_0x36b9b2;var _0xd7cc36;!_0x1b9297&&(_0x1b9297=(_0xd7cc36=await this[_0x1141e6(0x290)]['getBaseConfig']())===null||_0xd7cc36===void 0x0?void 0x0:_0xd7cc36[_0x1141e6(0x1e7)]);const {timeout:timeout=0x3c}=_0x4059de,{topN:_0x74da9,model:_0xbfcb16}=_0x1b9297,{parentMessageId:parentMessageId=0x0}=_0x53d6d9,_0x519a6d=await this[_0x1141e6(0x1d5)][_0x1141e6(0x296)]([_0x1141e6(0x1f8)]),_0x599565=timeout*0x3e8||_0x519a6d||0x64*0x3e8,_0x2fd364={'parentMessageId':parentMessageId,'timeoutMs':+_0x599565,'completionParams':{'model':_0xbfcb16,'temperature':_0x74da9}};return _0x42cfae&&(_0x2fd364[_0x1141e6(0x210)]=_0x42cfae),_0x2fd364;}async[_0x36b9b2(0x1d7)](_0x92d2b3){const _0x49adc6=_0x36b9b2,_0x1334ef=await this[_0x49adc6(0x290)]['getRandomDrawKey'](),_0x3ae2bd=await this[_0x49adc6(0x1d5)]['getConfigs']([_0x49adc6(0x22a)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x562c10,model:_0x4385a4}=_0x1334ef,_0x1f8307=await this[_0x49adc6(0x2c2)](_0x1334ef),{context:_0x56fc23}=await this[_0x49adc6(0x2ca)][_0x49adc6(0x2bf)](_0x92d2b3,{'parentMessageId':'','systemMessage':_0x3ae2bd});try{const _0x3d5db0=await(0x0,openai_1[_0x49adc6(0x28a)])(_0x56fc23,{'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0x562c10),'model':_0x4385a4,'proxyUrl':_0x1f8307,'onProgress':null});return _0x3d5db0===null||_0x3d5db0===void 0x0?void 0x0:_0x3d5db0['text'];}catch(_0x19963c){console[_0x49adc6(0x27d)](_0x49adc6(0x234),_0x19963c);}}async[_0x36b9b2(0x1fe)](_0x35b321,_0x456074,_0x57ca16){const _0x438467=_0x36b9b2;var _0x16237b,_0x4490f7,_0x4fae5c,_0x259eac;const _0x12c6db=_0x456074[_0x438467(0x24a)],{options:options={},appId:_0x271653,cusromPrompt:_0x1c3152,systemMessage:systemMessage=''}=_0x35b321;let _0x27dfee=systemMessage;const {parentMessageId:_0x4b2ffd}=options,{prompt:_0x4e4afb,imageUrl:_0x1b5638,model:_0x1c914c}=_0x35b321,{groupId:_0x19f06c,usingNetwork:_0x2b4ab4}=options,_0x23380f=await this[_0x438467(0x294)][_0x438467(0x27c)](_0x19f06c),_0x88f46f=(_0x23380f===null||_0x23380f===void 0x0?void 0x0:_0x23380f[_0x438467(0x1d6)])?JSON[_0x438467(0x220)](_0x23380f['config']):await this['modelsService'][_0x438467(0x273)](),{keyType:_0x5e642,model:_0x2cc243,topN:_0xcadabe,systemMessage:_0x567d8e,rounds:_0x27e475}=_0x88f46f['modelInfo'];let _0x21bf81=null;!_0x1c3152?_0x21bf81=await this['modelsService'][_0x438467(0x28f)](_0x2cc243):_0x21bf81=await this[_0x438467(0x290)][_0x438467(0x2cb)]();if(!_0x21bf81)throw new common_1[(_0x438467(0x203))](_0x438467(0x20a),common_1['HttpStatus'][_0x438467(0x2a4)]);const {deduct:_0x4c8f67,isTokenBased:_0x481a20,tokenFeeRatio:_0x5d570d,deductType:_0xa5a4ae,key:_0x29e77e,secret:_0x21ef59,modelName:_0x90f9c2,id:_0x4ebc4d,accessToken:_0x2fccb5}=_0x21bf81;await this[_0x438467(0x278)]['checkUserStatus'](_0x456074['user']),await this[_0x438467(0x216)]['validateBalance'](_0x456074,_0xa5a4ae===0x1?'model3':'model4',_0x4c8f67),_0x57ca16&&_0x57ca16[_0x438467(0x246)](_0x438467(0x29c),'application/octet-stream;\x20charset=utf-8'),await this['badwordsService'][_0x438467(0x1ee)](_0x4e4afb,_0x456074[_0x438467(0x247)]['id']);const _0x5200f6=await this['autoreplyService'][_0x438467(0x1f6)](_0x4e4afb);if(_0x5200f6&&_0x57ca16){const _0x54a5e3={'message':_0x5200f6,'code':0x1f4};return _0x57ca16['write'](JSON['stringify'](_0x54a5e3)),_0x57ca16[_0x438467(0x223)]();}if(_0x271653){const _0x4e541e=await this['appEntity'][_0x438467(0x1f0)]({'where':{'id':_0x271653,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x4e541e)throw new common_1[(_0x438467(0x203))](_0x438467(0x29e),common_1[_0x438467(0x24f)][_0x438467(0x2a4)]);_0x4e541e[_0x438467(0x211)]&&(_0x27dfee=_0x4e541e[_0x438467(0x211)]);}else{if(_0x1c3152)_0x27dfee=systemMessage;else{if(_0x567d8e)_0x27dfee=_0x567d8e;else{const _0x247347=new Date()[_0x438467(0x2b8)]()['split']('T')[0x0],_0x415121=await this[_0x438467(0x1d5)][_0x438467(0x296)]([_0x438467(0x22a)]);_0x27dfee=_0x415121+(_0x438467(0x249)+_0x247347);}}}let _0x508b32='';if(_0x2b4ab4){_0x508b32=await(0x0,utils_1[_0x438467(0x1d8)])(_0x4e4afb);const _0x4a82aa=new Date()[_0x438467(0x2b8)]()[_0x438467(0x285)]('T')[0x0],_0x11e950=await this[_0x438467(0x1d5)][_0x438467(0x296)]([_0x438467(0x22a)]);_0x27dfee=_0x11e950+(_0x438467(0x249)+_0x4a82aa);}const _0x1bb1e9=await this['getRequestParams'](options,_0x27dfee,_0x21bf81,_0x88f46f[_0x438467(0x1e7)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x331f41}=_0x21bf81;_0x57ca16&&_0x57ca16[_0x438467(0x206)](0xc8);let _0x25962f=null,_0x458ad6=null;try{if(_0x57ca16){let _0x366b76=null,_0x9a5d6c=![];_0x57ca16['on']('close',async()=>{const _0x5f6282=_0x438467;if(_0x9a5d6c)return;_0x12c6db[_0x5f6282(0x1dc)]();const _0x54e8e8=await(0x0,openai_1[_0x5f6282(0x2d3)])(_0x4e4afb)||0x0,_0x3039fc=await(0x0,openai_1['getTokenCount'])(_0x366b76===null||_0x366b76===void 0x0?void 0x0:_0x366b76[_0x5f6282(0x2bc)])||0x0,_0x45fe94=_0x54e8e8+_0x3039fc,_0xd8c917=(0x0,utils_1[_0x5f6282(0x282)])(_0x456074);await this['chatLogService']['saveChatLog']({'appId':_0x271653,'curIp':_0xd8c917,'userId':_0x456074[_0x5f6282(0x247)]['id'],'type':balance_constant_1[_0x5f6282(0x242)][_0x5f6282(0x2ce)],'prompt':_0x4e4afb,'imageUrl':_0x1b5638,'activeModel':_0x1c914c,'answer':'','promptTokens':_0x54e8e8,'completionTokens':0x0,'totalTokens':_0x54e8e8,'model':_0x2cc243,'role':'user','groupId':_0x19f06c,'requestOptions':JSON[_0x5f6282(0x27a)]({'options':null,'prompt':_0x4e4afb})}),await this[_0x5f6282(0x2a3)][_0x5f6282(0x29f)]({'appId':_0x271653,'curIp':_0xd8c917,'userId':_0x456074[_0x5f6282(0x247)]['id'],'type':balance_constant_1[_0x5f6282(0x242)][_0x5f6282(0x2ce)],'prompt':_0x4e4afb,'answer':_0x366b76===null||_0x366b76===void 0x0?void 0x0:_0x366b76[_0x5f6282(0x2bc)],'promptTokens':_0x54e8e8,'completionTokens':_0x3039fc,'totalTokens':_0x45fe94,'model':_0x2cc243,'role':'assistant','groupId':_0x19f06c,'requestOptions':JSON[_0x5f6282(0x27a)]({'options':{'model':_0x2cc243,'temperature':_0xcadabe},'prompt':_0x4e4afb}),'conversationOptions':JSON[_0x5f6282(0x27a)]({'conversationId':_0x366b76===null||_0x366b76===void 0x0?void 0x0:_0x366b76['conversationId'],'model':_0x2cc243,'parentMessageId':_0x366b76===null||_0x366b76===void 0x0?void 0x0:_0x366b76['id'],'temperature':_0xcadabe})});let _0x50084=_0x4c8f67;_0x481a20===!![]&&(_0x50084=Math[_0x5f6282(0x237)](_0x4c8f67*_0x45fe94/_0x5d570d)),await this[_0x5f6282(0x216)]['deductFromBalance'](_0x456074[_0x5f6282(0x247)]['id'],_0x5f6282(0x1f1)+(_0xa5a4ae===0x1?0x3:0x4),_0x50084,_0x45fe94);});if(Number(_0x5e642)===0x1){const {key:_0x2378e4,maxToken:_0x53a29e,maxTokenRes:_0x5bb5d5,proxyResUrl:_0x2528f6}=await this[_0x438467(0x22c)](_0x21bf81),{parentMessageId:_0x3a5f8a,completionParams:_0x304dec,systemMessage:_0x36c308}=_0x1bb1e9,{model:_0x535a04,temperature:_0x7c5bad}=_0x304dec,{context:_0x235589}=await this[_0x438467(0x2ca)][_0x438467(0x2bf)](_0x2b4ab4?_0x508b32:_0x4e4afb,{'parentMessageId':_0x3a5f8a,'systemMessage':_0x36c308,'maxModelToken':_0x53a29e,'maxResponseTokens':_0x5bb5d5,'maxRounds':(0x0,helper_1[_0x438467(0x2db)])(_0x27e475),'imageUrl':_0x1b5638,'activeModel':_0x1c914c});let _0x455efa=!![];_0x25962f=await(0x0,openai_1[_0x438467(0x28a)])(_0x235589,{'maxToken':_0x53a29e,'maxTokenRes':_0x5bb5d5,'apiKey':_0x29e77e,'model':_0x535a04,'prompt':_0x4e4afb,'activeModel':_0x1c914c,'imageUrl':_0x1b5638,'temperature':_0x7c5bad,'proxyUrl':_0x2528f6,'onProgress':_0x4829=>{const _0x2d9df5=_0x438467;_0x57ca16[_0x2d9df5(0x231)](_0x455efa?JSON[_0x2d9df5(0x27a)](_0x4829):'\x0a'+JSON[_0x2d9df5(0x27a)](_0x4829)),_0x366b76=_0x4829,_0x455efa=![];}},this['uploadService']),_0x9a5d6c=!![];}if(Number(_0x5e642)===0x2){let _0x1afc5a=!![];const {context:_0x15e503}=await this[_0x438467(0x2ca)][_0x438467(0x2bf)](_0x2b4ab4?_0x508b32:_0x4e4afb,{'parentMessageId':_0x4b2ffd,'maxRounds':(0x0,helper_1[_0x438467(0x2db)])(_0x27e475)});_0x25962f=await(0x0,baidu_1[_0x438467(0x25c)])(_0x2b4ab4?_0x508b32:_0x15e503,{'temperature':_0xcadabe,'accessToken':_0x2fccb5,'model':_0x2cc243,'onProgress':_0x17ea5b=>{const _0x3c104a=_0x438467;_0x57ca16[_0x3c104a(0x231)](_0x1afc5a?JSON['stringify'](_0x17ea5b):'\x0a'+JSON[_0x3c104a(0x27a)](_0x17ea5b)),_0x1afc5a=![],_0x366b76=_0x17ea5b;}}),_0x9a5d6c=!![];}if(Number(_0x5e642)===0x3){let _0xe03f2=!![];const {context:_0x35950a}=await this[_0x438467(0x2ca)][_0x438467(0x2bf)](_0x2b4ab4?_0x508b32:_0x4e4afb,{'parentMessageId':_0x4b2ffd,'maxRounds':(0x0,helper_1[_0x438467(0x2db)])(_0x27e475)});_0x25962f=await(0x0,zhipu_1[_0x438467(0x2cc)])(_0x2b4ab4?_0x508b32:_0x35950a,{'temperature':_0xcadabe,'key':_0x331f41,'model':_0x2cc243,'onProgress':_0x307875=>{const _0xa6faf9=_0x438467;_0x57ca16['write'](_0xe03f2?JSON[_0xa6faf9(0x27a)](_0x307875):'\x0a'+JSON[_0xa6faf9(0x27a)](_0x307875)),_0xe03f2=![],_0x366b76=_0x307875;}}),_0x9a5d6c=!![];}const _0xde6b07={'id':this[_0x438467(0x2ca)][_0x438467(0x20e)](),'text':_0x4e4afb,'role':_0x438467(0x247),'name':undefined,'usage':null,'imageUrl':_0x1b5638,'activeModel':_0x1c914c,'parentMessageId':_0x4b2ffd,'conversationId':_0x25962f===null||_0x25962f===void 0x0?void 0x0:_0x25962f[_0x438467(0x2d0)]};_0x458ad6={'model':_0x2cc243,'parentMessageId':_0x4b2ffd},await this[_0x438467(0x2ca)][_0x438467(0x297)](_0xde6b07);const _0x1544a8={'id':_0x25962f['id'],'text':_0x25962f[_0x438467(0x2bc)],'role':_0x438467(0x214),'name':undefined,'usage':_0x25962f===null||_0x25962f===void 0x0?void 0x0:_0x25962f[_0x438467(0x270)],'imageUrl':_0x1b5638,'parentMessageId':_0xde6b07['id'],'conversationId':_0x25962f===null||_0x25962f===void 0x0?void 0x0:_0x25962f[_0x438467(0x2d0)]};await this['nineStore'][_0x438467(0x297)](_0x1544a8),_0x458ad6={'model':_0x2cc243,'parentMessageId':_0xde6b07['id']};}else{const {key:_0x28ec0d,maxToken:_0x4b45f0,maxTokenRes:_0x110d94,proxyResUrl:_0x197ea9}=await this[_0x438467(0x22c)](_0x21bf81),{parentMessageId:_0x577f09,completionParams:_0x2c98f8,systemMessage:_0x4ef4bd}=_0x1bb1e9,{model:_0x1f927a,temperature:_0x36a1d6}=_0x2c98f8,{context:_0x272163}=await this['nineStore']['buildMessageFromParentMessageId'](_0x2b4ab4?_0x508b32:_0x4e4afb,{'parentMessageId':_0x577f09,'systemMessage':_0x4ef4bd,'maxRounds':(0x0,helper_1[_0x438467(0x2db)])(_0x27e475)});_0x25962f=await(0x0,openai_1[_0x438467(0x28a)])(_0x272163,{'apiKey':_0x29e77e,'model':_0x1f927a,'temperature':_0x36a1d6,'proxyUrl':_0x197ea9,'onProgress':null,'prompt':_0x4e4afb});}let _0x16bce9=null,_0x30bc6e=null;_0x2cc243[_0x438467(0x2be)](_0x438467(0x2a2))?_0x16bce9=((_0x16237b=_0x25962f['detail'])===null||_0x16237b===void 0x0?void 0x0:_0x16237b[_0x438467(0x270)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x30bc6e=await(0x0,helper_1[_0x438467(0x2ac)])(_0x5e642,_0x25962f,_0x458ad6);const {prompt_tokens:_0x133fbd,completion_tokens:_0x22d62e,total_tokens:_0x4c97be}=_0x2cc243[_0x438467(0x2be)](_0x438467(0x2a2))?_0x16bce9:_0x30bc6e['usage'];let _0xfdada5=_0x4c8f67;_0x481a20===!![]&&(_0xfdada5=Math[_0x438467(0x237)](_0x4c8f67*_0x4c97be/_0x5d570d));await this[_0x438467(0x216)][_0x438467(0x24b)](_0x456074[_0x438467(0x247)]['id'],_0x438467(0x1f1)+(_0xa5a4ae===0x1?0x3:0x4),_0xfdada5,_0x4c97be),await this[_0x438467(0x290)][_0x438467(0x2b6)](_0x4ebc4d,_0x4c97be);const _0xf6bde1=(0x0,utils_1[_0x438467(0x282)])(_0x456074);await this['chatLogService'][_0x438467(0x29f)]({'appId':_0x271653,'curIp':_0xf6bde1,'userId':_0x456074[_0x438467(0x247)]['id'],'type':balance_constant_1[_0x438467(0x242)]['CHAT_TYPE'],'prompt':_0x4e4afb,'imageUrl':_0x1b5638,'activeModel':_0x1c914c,'answer':'','promptTokens':_0x133fbd,'completionTokens':0x0,'totalTokens':_0x4c97be,'model':_0x2cc243,'role':_0x438467(0x247),'groupId':_0x19f06c,'requestOptions':JSON[_0x438467(0x27a)]({'options':null,'prompt':_0x4e4afb})}),await this[_0x438467(0x2a3)][_0x438467(0x29f)]({'appId':_0x271653,'curIp':_0xf6bde1,'userId':_0x456074[_0x438467(0x247)]['id'],'type':balance_constant_1[_0x438467(0x242)]['CHAT_TYPE'],'prompt':_0x4e4afb,'imageUrl':_0x25962f===null||_0x25962f===void 0x0?void 0x0:_0x25962f[_0x438467(0x213)],'answer':_0x25962f[_0x438467(0x2bc)],'promptTokens':_0x133fbd,'completionTokens':_0x22d62e,'totalTokens':_0x4c97be,'model':_0x2cc243,'role':_0x438467(0x214),'groupId':_0x19f06c,'requestOptions':JSON[_0x438467(0x27a)]({'options':{'model':_0x2cc243,'temperature':_0xcadabe},'prompt':_0x4e4afb}),'conversationOptions':JSON[_0x438467(0x27a)]({'conversationId':_0x25962f['conversationId'],'model':_0x2cc243,'parentMessageId':_0x25962f['id'],'temperature':_0xcadabe})}),common_1[_0x438467(0x227)]['debug'](_0x438467(0x218)+_0x456074[_0x438467(0x247)]['id']+_0x438467(0x272)+_0x90f9c2+'-'+_0x1c914c+_0x438467(0x2a5)+_0x4c97be+_0x438467(0x2a0)+_0xfdada5,'ChatgptService');const _0x5b6e10=await this['userBalanceService'][_0x438467(0x2c9)](_0x456074[_0x438467(0x247)]['id']);return _0x25962f[_0x438467(0x225)]=Object[_0x438467(0x1f4)]({},_0x5b6e10),_0x25962f[_0x438467(0x295)]&&(_0x25962f[_0x438467(0x295)]=''),_0x25962f[_0x438467(0x1e8)]=!![],_0x57ca16?_0x57ca16[_0x438467(0x231)]('\x0a'+JSON[_0x438467(0x27a)](_0x25962f)):_0x25962f['text'];}catch(_0x1cc2eb){console[_0x438467(0x27d)](_0x438467(0x2cf),_0x29e77e,_0x1cc2eb);const _0x4083cb=(_0x1cc2eb===null||_0x1cc2eb===void 0x0?void 0x0:_0x1cc2eb[_0x438467(0x283)])||0x190,_0x58a238=((_0x4490f7=_0x1cc2eb===null||_0x1cc2eb===void 0x0?void 0x0:_0x1cc2eb[_0x438467(0x298)])===null||_0x4490f7===void 0x0?void 0x0:_0x4490f7[_0x438467(0x206)])||(_0x1cc2eb===null||_0x1cc2eb===void 0x0?void 0x0:_0x1cc2eb[_0x438467(0x283)])||0x190;console['log'](_0x438467(0x1de),_0x438467(0x274),_0x4083cb,_0x438467(0x23f),_0x1cc2eb===null||_0x1cc2eb===void 0x0?void 0x0:_0x1cc2eb[_0x438467(0x23f)],_0x438467(0x2b0),(_0x4fae5c=_0x1cc2eb===null||_0x1cc2eb===void 0x0?void 0x0:_0x1cc2eb[_0x438467(0x298)])===null||_0x4fae5c===void 0x0?void 0x0:_0x4fae5c['statusText'],_0x438467(0x206),(_0x259eac=_0x1cc2eb===null||_0x1cc2eb===void 0x0?void 0x0:_0x1cc2eb[_0x438467(0x298)])===null||_0x259eac===void 0x0?void 0x0:_0x259eac['status']);if(_0x1cc2eb[_0x438467(0x206)]&&_0x1cc2eb[_0x438467(0x206)]===0x192){const _0x472694={'message':_0x438467(0x279)+_0x1cc2eb[_0x438467(0x23f)],'code':0x192};if(_0x57ca16)return _0x57ca16[_0x438467(0x231)](JSON[_0x438467(0x27a)](_0x472694));else throw new common_1[(_0x438467(0x203))](_0x1cc2eb['message'],common_1[_0x438467(0x24f)][_0x438467(0x21a)]);}if(!_0x58a238){if(_0x57ca16)return _0x57ca16[_0x438467(0x231)](JSON[_0x438467(0x27a)]({'message':_0x1cc2eb[_0x438467(0x23f)],'code':0x1f4}));else throw new common_1[(_0x438467(0x203))](_0x1cc2eb[_0x438467(0x23f)],common_1[_0x438467(0x24f)][_0x438467(0x2a4)]);}let _0x2bd4fa=errorMessage_constant_1[_0x438467(0x286)][_0x58a238]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x58a238]:_0x438467(0x25e);(_0x1cc2eb===null||_0x1cc2eb===void 0x0?void 0x0:_0x1cc2eb[_0x438467(0x23f)][_0x438467(0x2be)](_0x438467(0x266)))&&Number(_0x5e642)===0x1&&(await this[_0x438467(0x290)][_0x438467(0x217)](_0x4ebc4d,_0x438467(0x1e3),-0x1),_0x2bd4fa='当前模型key已被封禁');(_0x1cc2eb===null||_0x1cc2eb===void 0x0?void 0x0:_0x1cc2eb[_0x438467(0x283)])===0x1ad&&_0x1cc2eb[_0x438467(0x23f)]['includes']('billing')&&Number(_0x5e642)===0x1&&(await this[_0x438467(0x290)][_0x438467(0x217)](_0x4ebc4d,'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x2bd4fa='当前模型key余额已耗尽');(_0x1cc2eb===null||_0x1cc2eb===void 0x0?void 0x0:_0x1cc2eb[_0x438467(0x283)])===0x1ad&&(_0x1cc2eb===null||_0x1cc2eb===void 0x0?void 0x0:_0x1cc2eb[_0x438467(0x215)])===_0x438467(0x1e1)&&(_0x2bd4fa=_0x438467(0x1f3));(_0x1cc2eb===null||_0x1cc2eb===void 0x0?void 0x0:_0x1cc2eb['statusCode'])===0x191&&_0x1cc2eb[_0x438467(0x23f)][_0x438467(0x2be)]('Incorrect\x20API\x20key\x20provided')&&Number(_0x5e642)===0x1&&(await this[_0x438467(0x290)][_0x438467(0x217)](_0x4ebc4d,_0x438467(0x2dc),-0x2),_0x2bd4fa=_0x438467(0x2ad));(_0x1cc2eb===null||_0x1cc2eb===void 0x0?void 0x0:_0x1cc2eb['statusCode'])===0x194&&_0x1cc2eb[_0x438467(0x23f)][_0x438467(0x2be)](_0x438467(0x26d))&&Number(_0x5e642)===0x1&&(await this[_0x438467(0x290)][_0x438467(0x217)](_0x4ebc4d,_0x438467(0x26c),-0x4),_0x2bd4fa='当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！');_0x4083cb===0x190&&console['log'](_0x438467(0x259),_0x1cc2eb,_0x1cc2eb[_0x438467(0x23f)]);const _0x49b4b8={'message':_0x2bd4fa||_0x438467(0x258),'code':_0x4083cb===0x191?0x190:_0x4083cb||0x1f4};if(_0x57ca16)return _0x57ca16[_0x438467(0x231)](JSON[_0x438467(0x27a)](_0x49b4b8));else throw new common_1[(_0x438467(0x203))](_0x49b4b8[_0x438467(0x23f)],common_1[_0x438467(0x24f)][_0x438467(0x2a4)]);}finally{_0x57ca16&&_0x57ca16['end']();}}async[_0x36b9b2(0x275)](_0x5dd501,_0x416210){const _0x4c2953=_0x36b9b2;var _0x1c33bd,_0x474286,_0x332751,_0x29599f;await this[_0x4c2953(0x254)][_0x4c2953(0x1ee)](_0x5dd501[_0x4c2953(0x209)],_0x416210['user']['id']),await this[_0x4c2953(0x278)][_0x4c2953(0x2b7)](_0x416210[_0x4c2953(0x247)]);const _0x341b74=(_0x5dd501===null||_0x5dd501===void 0x0?void 0x0:_0x5dd501[_0x4c2953(0x2b5)])==='hd'?0x4:0x2;await this[_0x4c2953(0x216)][_0x4c2953(0x1df)](_0x416210,_0x4c2953(0x2d7),_0x341b74);let _0x472d8a=[];const _0x1e0391=await this['modelsService'][_0x4c2953(0x28f)]('dall-e-3'),_0x4eb47f=_0x1e0391===null||_0x1e0391===void 0x0?void 0x0:_0x1e0391['id'],{key:_0x115b47,proxyResUrl:_0x3fc1ef}=await this['formatModelToken'](_0x1e0391);common_1[_0x4c2953(0x227)][_0x4c2953(0x27d)](_0x4c2953(0x2a9)+_0x5dd501[_0x4c2953(0x209)]+',\x20key\x20===>\x20'+_0x115b47,_0x4c2953(0x263));try{const _0x44c8af=_0x3fc1ef+_0x4c2953(0x264),_0x461057=Object['assign'](Object['assign']({},_0x5dd501),{'model':_0x4c2953(0x1ef)});console[_0x4c2953(0x27d)](_0x4c2953(0x1f2),_0x461057);const _0xac0d53=await axios_1[_0x4c2953(0x25a)][_0x4c2953(0x2b2)](_0x44c8af,Object[_0x4c2953(0x1f4)](Object[_0x4c2953(0x1f4)]({},_0x461057),{'response_format':_0x4c2953(0x1d9)}),{'headers':{'Authorization':'Bearer\x20'+_0x115b47}});_0x472d8a=_0xac0d53[_0x4c2953(0x1f5)][_0x4c2953(0x1f5)];const _0x1198b1=[];for(const _0xa5ba98 of _0x472d8a){const _0x375338=uuid['v4']()[_0x4c2953(0x229)](0x0,0xa)+_0x4c2953(0x2c3),_0x5dcbb4=Buffer[_0x4c2953(0x1e6)](_0xa5ba98[_0x4c2953(0x1d9)],'base64');_0x1198b1[_0x4c2953(0x233)](this[_0x4c2953(0x2ab)][_0x4c2953(0x277)]({'filename':_0x375338,'buffer':_0x5dcbb4}));}const _0x4a9125=await Promise[_0x4c2953(0x212)](_0x1198b1);await this['userBalanceService'][_0x4c2953(0x24b)](_0x416210['user']['id'],_0x4c2953(0x2d7),(_0x461057===null||_0x461057===void 0x0?void 0x0:_0x461057[_0x4c2953(0x2b5)])==='standard'?0x2:0x4,_0x341b74);const _0x4e93e1=(0x0,utils_1[_0x4c2953(0x282)])(_0x416210),_0x381601=[],_0x1517c4=await this[_0x4c2953(0x2ab)][_0x4c2953(0x291)](),[_0x3e1fe4,_0x22b64c]=_0x5dd501[_0x4c2953(0x202)]['split']('x');return _0x4a9125[_0x4c2953(0x1e4)](_0x44155d=>{const _0x4cef87=_0x4c2953;_0x381601[_0x4cef87(0x233)](this[_0x4cef87(0x2a3)][_0x4cef87(0x29f)]({'curIp':_0x4e93e1,'userId':_0x416210['user']['id'],'type':balance_constant_1['DeductionKey'][_0x4cef87(0x251)],'prompt':_0x5dd501[_0x4cef87(0x209)],'answer':_0x44155d,'fileInfo':JSON[_0x4cef87(0x27a)]({'cosType':_0x1517c4,'width':_0x3e1fe4,'height':_0x22b64c,'cosUrl':_0x44155d}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x4cef87(0x1ef)}));}),await Promise['all'](_0x381601),_0x4a9125;}catch(_0xa6c3e5){const _0x67f298=((_0x1c33bd=_0xa6c3e5===null||_0xa6c3e5===void 0x0?void 0x0:_0xa6c3e5[_0x4c2953(0x298)])===null||_0x1c33bd===void 0x0?void 0x0:_0x1c33bd[_0x4c2953(0x206)])||0x1f4;console[_0x4c2953(0x27d)](_0x4c2953(0x26e),JSON[_0x4c2953(0x27a)](_0xa6c3e5),_0x115b47,_0x67f298);const _0x4a8e1b=(_0x29599f=(_0x332751=(_0x474286=_0xa6c3e5===null||_0xa6c3e5===void 0x0?void 0x0:_0xa6c3e5[_0x4c2953(0x298)])===null||_0x474286===void 0x0?void 0x0:_0x474286[_0x4c2953(0x1f5)])===null||_0x332751===void 0x0?void 0x0:_0x332751[_0x4c2953(0x228)])===null||_0x29599f===void 0x0?void 0x0:_0x29599f['message'];if(_0x67f298===0x1ad)throw new common_1[(_0x4c2953(0x203))](_0x4c2953(0x207),common_1['HttpStatus'][_0x4c2953(0x2a4)]);if(_0x67f298===0x190&&_0x4a8e1b[_0x4c2953(0x2be)](_0x4c2953(0x29d)))throw new common_1[(_0x4c2953(0x203))](_0x4c2953(0x240),common_1[_0x4c2953(0x24f)][_0x4c2953(0x2a4)]);if(_0x67f298===0x190&&_0x4a8e1b[_0x4c2953(0x2be)](_0x4c2953(0x1ff))){await this[_0x4c2953(0x290)][_0x4c2953(0x217)](_0x4eb47f,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1);throw new common_1['HttpException']('当前Key余额已不足、请重新再试一次吧！',common_1[_0x4c2953(0x24f)][_0x4c2953(0x2a4)]);}if(_0x67f298===0x1f4)throw new common_1[(_0x4c2953(0x203))](_0x4c2953(0x238),common_1['HttpStatus'][_0x4c2953(0x2a4)]);if(_0x67f298===0x191)throw new common_1[(_0x4c2953(0x203))](_0x4c2953(0x1ec),common_1[_0x4c2953(0x24f)][_0x4c2953(0x2a4)]);throw new common_1['HttpException'](_0x4c2953(0x1fd),common_1['HttpStatus'][_0x4c2953(0x2a4)]);}}async[_0x36b9b2(0x1f7)](){const _0x1f8026=_0x36b9b2,_0x3459bb=await this[_0x1f8026(0x28d)][_0x1f8026(0x28e)]({'where':{'status':0x1},'select':['id','key',_0x1f8026(0x21d),'model','maxModelTokens',_0x1f8026(0x2d2),_0x1f8026(0x267),_0x1f8026(0x1f8)]}),_0x57ffb6=_0x3459bb['filter'](_0x370267=>_0x370267[_0x1f8026(0x1f1)]['includes'](_0x1f8026(0x292))),_0x441a67=_0x3459bb[_0x1f8026(0x232)](_0x1cfb5a=>_0x1cfb5a['model'][_0x1f8026(0x2be)](_0x1f8026(0x28c)));this[_0x1f8026(0x2ae)]={'list3':_0x57ffb6,'list4':_0x441a67};}async[_0x36b9b2(0x2c2)](_0x1983bc){const _0x4eb712=_0x36b9b2,_0x3d47b2=await this[_0x4eb712(0x1d5)]['getConfigs']([_0x4eb712(0x2c4)]);return(_0x1983bc===null||_0x1983bc===void 0x0?void 0x0:_0x1983bc['proxyUrl'])||_0x3d47b2||_0x4eb712(0x21e);}async[_0x36b9b2(0x22c)](_0x5bdc63){const _0x1f9b6c=_0x36b9b2,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x1f9b6c(0x1d5)]['getConfigs'](['openaiModel3MaxTokens','openaiModel3MaxTokensRes',_0x1f9b6c(0x256),_0x1f9b6c(0x1fb),_0x1f9b6c(0x2a8),'openaiModel4MaxTokensRes',_0x1f9b6c(0x1d2),_0x1f9b6c(0x2a1),_0x1f9b6c(0x2c4)]);let _0x1c0841=null,_0x147047=null,_0x3b6d2c=null,{model:_0x4b7c8f,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x435436}=_0x5bdc63;return _0x4b7c8f['toLowerCase']()[_0x1f9b6c(0x2be)]('gpt-4')&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x147047>=0x1000&&(maxModelTokens=0x1000),_0x1c0841=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x147047=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x4b7c8f[_0x1f9b6c(0x2c5)]()[_0x1f9b6c(0x2be)](_0x1f9b6c(0x244))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x147047>=0x4000&&(maxModelTokens=0x4000),_0x1c0841=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x147047=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x4b7c8f[_0x1f9b6c(0x2c5)]()['includes'](_0x1f9b6c(0x221))&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x147047>=0x1000&&(maxModelTokens=0x1000),_0x1c0841=maxModelTokens||0x3ffc,_0x147047=maxResponseTokens||0x1000)),_0x4b7c8f['toLowerCase']()[_0x1f9b6c(0x2be)](_0x1f9b6c(0x292))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x147047>=0x7d0&&(maxModelTokens=0x7d0),_0x1c0841=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x147047=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x4b7c8f[_0x1f9b6c(0x2c5)]()[_0x1f9b6c(0x2be)]('16k')&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x147047>=0x2000&&(maxModelTokens=0x2000),_0x1c0841=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x147047=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x4b7c8f[_0x1f9b6c(0x2c5)]()[_0x1f9b6c(0x2be)](_0x1f9b6c(0x221))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x147047>=0x1000&&(maxModelTokens=0x1000),_0x1c0841=maxModelTokens||0x4000,_0x147047=maxResponseTokens||0x1000)),_0x3b6d2c=proxyUrl||openaiBaseUrl||_0x1f9b6c(0x21e),_0x147047>=_0x1c0841&&(_0x147047=Math[_0x1f9b6c(0x26f)](_0x1c0841/0x2)),{'key':_0x435436,'maxToken':_0x1c0841,'maxTokenRes':_0x147047,'proxyResUrl':_0x3b6d2c};}async[_0x36b9b2(0x2d4)](_0x56ed,_0x49030c){const _0x5827a6=_0x36b9b2;try{const {name:_0x8182c2,icon:_0x2d4757,order:_0x2cdb7b,id:_0x1208ef,status:_0x53fca0}=_0x49030c;return _0x1208ef?await this[_0x5827a6(0x23c)]['update']({'id':_0x1208ef},{'name':_0x8182c2,'icon':_0x2d4757,'order':_0x2cdb7b,'status':_0x53fca0}):await this[_0x5827a6(0x23c)][_0x5827a6(0x21f)]({'name':_0x8182c2,'icon':_0x2d4757,'order':_0x2cdb7b,'status':_0x53fca0});}catch(_0x1a12a5){console['log'](_0x5827a6(0x234),_0x1a12a5);}}async[_0x36b9b2(0x2a7)](_0x1d18f6,_0x5c093a){const _0x12588a=_0x36b9b2,{id:_0x4d05e5}=_0x5c093a;if(!_0x4d05e5)throw new common_1[(_0x12588a(0x203))]('非法操作！',common_1[_0x12588a(0x24f)][_0x12588a(0x2a4)]);const _0x15c54b=await this[_0x12588a(0x23d)]['count']({'where':{'typeId':_0x4d05e5}});if(_0x15c54b)throw new common_1[(_0x12588a(0x203))](_0x12588a(0x1db),common_1[_0x12588a(0x24f)][_0x12588a(0x2a4)]);return await this['chatBoxTypeEntity'][_0x12588a(0x2d1)]({'id':_0x4d05e5});}async[_0x36b9b2(0x20f)](){const _0x1128dc=_0x36b9b2;return await this[_0x1128dc(0x23c)][_0x1128dc(0x28e)]({'order':{'order':_0x1128dc(0x2c1)}});}async['setChatBox'](_0x31137c,_0x42dc2c){const _0x4f48f5=_0x36b9b2,{title:_0x321906,prompt:_0x15c387,appId:_0x4763b5,order:_0x37788c,status:_0x1e4a8a,typeId:_0x46e178,id:_0xff2672,url:_0x2b14e4}=_0x42dc2c;if(!_0x46e178)throw new common_1[(_0x4f48f5(0x203))](_0x4f48f5(0x245),common_1[_0x4f48f5(0x24f)]['BAD_REQUEST']);try{const _0x481b83={'title':_0x321906,'order':_0x37788c,'status':_0x1e4a8a,'typeId':_0x46e178,'url':_0x2b14e4};return _0x481b83['appId']=_0x4763b5||0x0,_0x481b83[_0x4f48f5(0x209)]=_0x15c387||'',_0xff2672?await this[_0x4f48f5(0x23d)][_0x4f48f5(0x2d6)]({'id':_0xff2672},_0x481b83):await this[_0x4f48f5(0x23d)][_0x4f48f5(0x21f)](_0x481b83);}catch(_0x4008a4){console[_0x4f48f5(0x27d)](_0x4f48f5(0x234),_0x4008a4);}}async[_0x36b9b2(0x26b)](_0x222202,_0x9b53a6){const _0x17af65=_0x36b9b2,{id:_0x155940}=_0x9b53a6;if(!_0x155940)throw new common_1['HttpException'](_0x17af65(0x2b9),common_1['HttpStatus'][_0x17af65(0x2a4)]);return await this[_0x17af65(0x23d)][_0x17af65(0x2d1)]({'id':_0x155940});}async[_0x36b9b2(0x2c0)](){const _0x112523=_0x36b9b2,_0xebe09e=await this[_0x112523(0x23d)][_0x112523(0x28e)]({'order':{'order':_0x112523(0x2c1)}}),_0x20ce55=[...new Set(_0xebe09e[_0x112523(0x22f)](_0x3d1961=>_0x3d1961[_0x112523(0x276)]))],_0x17f3d9=[...new Set(_0xebe09e[_0x112523(0x22f)](_0x1db703=>_0x1db703[_0x112523(0x2b1)]))],_0x43bf18=await this['chatBoxTypeEntity']['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x20ce55)}}),_0x3e181c=await this[_0x112523(0x260)][_0x112523(0x28e)]({'where':{'id':(0x0,typeorm_1['In'])(_0x17f3d9)}});return _0xebe09e[_0x112523(0x22f)](_0x297c87=>{const _0x5748cf=_0x112523,{typeId:_0x114829,appId:_0x142b39}=_0x297c87;return _0x297c87['typeInfo']=_0x43bf18[_0x5748cf(0x28e)](_0x28e19c=>_0x28e19c['id']===_0x114829),_0x297c87['appInfo']=_0x3e181c[_0x5748cf(0x28e)](_0x4f8ca4=>_0x4f8ca4['id']===_0x142b39),_0x297c87;});}async[_0x36b9b2(0x1d3)](){const _0x452053=_0x36b9b2,_0x29bc24=await this['chatBoxTypeEntity'][_0x452053(0x28e)]({'order':{'order':'DESC'},'where':{'status':!![]}}),_0x27fa70=await this[_0x452053(0x23d)]['find']({'where':{'status':!![]}}),_0x220bc8=[...new Set(_0x27fa70[_0x452053(0x22f)](_0x2d7f21=>_0x2d7f21[_0x452053(0x2b1)]))],_0x1d4296=await this['appEntity']['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x220bc8)}});return _0x27fa70[_0x452053(0x1e4)](_0x975c3b=>{const _0x285c0f=_0x452053,_0x59b79e=_0x1d4296['find'](_0x5568a2=>_0x5568a2['id']===_0x975c3b[_0x285c0f(0x2b1)]);return _0x975c3b[_0x285c0f(0x226)]=_0x59b79e===null||_0x59b79e===void 0x0?void 0x0:_0x59b79e[_0x285c0f(0x226)],_0x975c3b;}),_0x29bc24[_0x452053(0x22f)](_0x544a8e=>{const _0x7ae19e=_0x452053;return _0x544a8e[_0x7ae19e(0x29a)]=_0x27fa70[_0x7ae19e(0x232)](_0x1fc424=>_0x1fc424[_0x7ae19e(0x276)]===_0x544a8e['id']&&_0x1fc424['status']),_0x544a8e;});}async[_0x36b9b2(0x28b)](_0x552863,_0x120459){const _0x4304a4=_0x36b9b2;try{const {name:_0x1c154f,icon:_0x557591,order:_0x4b2752,id:_0x506e38,status:_0x33f082}=_0x120459;return _0x506e38?await this['chatPreTypeEntity'][_0x4304a4(0x2d6)]({'id':_0x506e38},{'name':_0x1c154f,'icon':_0x557591,'order':_0x4b2752,'status':_0x33f082}):await this[_0x4304a4(0x26a)]['save']({'name':_0x1c154f,'icon':_0x557591,'order':_0x4b2752,'status':_0x33f082});}catch(_0x17e0a5){console[_0x4304a4(0x27d)](_0x4304a4(0x234),_0x17e0a5);}}async[_0x36b9b2(0x230)](_0x40048e,_0xda8ea6){const _0x24b972=_0x36b9b2,{id:_0x6ded63}=_0xda8ea6;if(!_0x6ded63)throw new common_1[(_0x24b972(0x203))](_0x24b972(0x2b9),common_1[_0x24b972(0x24f)][_0x24b972(0x2a4)]);const _0x455d63=await this[_0x24b972(0x23d)][_0x24b972(0x1ed)]({'where':{'typeId':_0x6ded63}});if(_0x455d63)throw new common_1['HttpException']('当前分类下有未处理数据不可移除！',common_1[_0x24b972(0x24f)][_0x24b972(0x2a4)]);return await this[_0x24b972(0x26a)][_0x24b972(0x2d1)]({'id':_0x6ded63});}async[_0x36b9b2(0x23e)](){const _0xf52522=_0x36b9b2;return await this[_0xf52522(0x26a)][_0xf52522(0x28e)]({'order':{'order':_0xf52522(0x2c1)}});}async['setChatPre'](_0x46106a,_0x4f10ef){const _0x1c2966=_0x36b9b2,{title:_0x589cb5,prompt:_0x324b74,appId:_0x310c85,order:_0x222c00,status:_0x46aea0,typeId:_0x21870b,id:_0x439f23,url:_0x14d17e}=_0x4f10ef;if(!_0x21870b)throw new common_1[(_0x1c2966(0x203))](_0x1c2966(0x245),common_1['HttpStatus'][_0x1c2966(0x2a4)]);try{const _0x5e02bb={'title':_0x589cb5,'prompt':_0x324b74,'order':_0x222c00,'status':_0x46aea0,'typeId':_0x21870b,'url':_0x14d17e};return _0x439f23?await this['chatPreEntity'][_0x1c2966(0x2d6)]({'id':_0x439f23},_0x5e02bb):await this[_0x1c2966(0x241)][_0x1c2966(0x21f)](_0x5e02bb);}catch(_0x3e3cd7){console[_0x1c2966(0x27d)](_0x1c2966(0x234),_0x3e3cd7);}}async['delChatPre'](_0x3c1ab7,_0x30d66e){const _0x28fb61=_0x36b9b2,{id:_0x58f1a5}=_0x30d66e;if(!_0x58f1a5)throw new common_1['HttpException']('非法操作！',common_1[_0x28fb61(0x24f)][_0x28fb61(0x2a4)]);return await this[_0x28fb61(0x241)]['delete']({'id':_0x58f1a5});}async[_0x36b9b2(0x2a6)](){const _0x23963a=_0x36b9b2,_0x3330e8=await this[_0x23963a(0x241)][_0x23963a(0x28e)]({'order':{'order':_0x23963a(0x2c1)}}),_0x1f15af=[...new Set(_0x3330e8[_0x23963a(0x22f)](_0x8377d6=>_0x8377d6[_0x23963a(0x276)]))],_0xb4454f=await this[_0x23963a(0x26a)][_0x23963a(0x28e)]({'where':{'id':(0x0,typeorm_1['In'])(_0x1f15af)}});return _0x3330e8['map'](_0x24495c=>{const _0x2e0de5=_0x23963a,{typeId:_0x52397e,appId:_0x2b40ad}=_0x24495c;return _0x24495c[_0x2e0de5(0x2d9)]=_0xb4454f[_0x2e0de5(0x28e)](_0x2d45b0=>_0x2d45b0['id']===_0x52397e),_0x24495c;});}async['queryChatPreList'](){const _0x38775e=_0x36b9b2,_0x4d03da=await this[_0x38775e(0x26a)]['find']({'order':{'order':_0x38775e(0x2c1)},'where':{'status':!![]}}),_0x4ed74d=await this[_0x38775e(0x241)][_0x38775e(0x28e)]({'where':{'status':!![]}});return _0x4d03da[_0x38775e(0x22f)](_0x40cb38=>{const _0x2f871c=_0x38775e;return _0x40cb38[_0x2f871c(0x29a)]=_0x4ed74d[_0x2f871c(0x232)](_0x502abc=>_0x502abc[_0x2f871c(0x276)]===_0x40cb38['id']&&_0x502abc['status']),_0x40cb38;});}async['getMaxTokenFromModelWithOpenAi'](_0x820598,_0x2d4788,_0x43a588){const _0x2ef7cb=_0x36b9b2;let _0x26e3ad=0x1000,_0x2e690a=0x800;return _0x820598[_0x2ef7cb(0x2c5)]()[_0x2ef7cb(0x2be)]('gpt-4')&&(_0x26e3ad=_0x2d4788>=0x2004?0x2004:_0x2d4788,_0x2e690a=_0x43a588>=0x1000?0x1000:_0x43a588,_0x820598[_0x2ef7cb(0x2c5)]()['includes'](_0x2ef7cb(0x244))&&(_0x26e3ad=_0x2d4788>=0x8000?0x8000:_0x2d4788,_0x2e690a=_0x43a588>=0x3e80?0x3e80:_0x43a588),(_0x820598[_0x2ef7cb(0x2c5)]()['includes'](_0x2ef7cb(0x1d1))||_0x820598[_0x2ef7cb(0x2c5)]()[_0x2ef7cb(0x2be)](_0x2ef7cb(0x2c7)))&&(_0x26e3ad=_0x2d4788>=0x1f400?0x1f400:_0x2d4788,_0x2e690a=_0x43a588>=0x1000?0x1000:_0x43a588)),_0x820598[_0x2ef7cb(0x2c5)]()[_0x2ef7cb(0x2be)](_0x2ef7cb(0x292))&&(_0x26e3ad=_0x2d4788>=0x1000?0x1000:_0x2d4788,_0x2e690a=_0x43a588>=0x800?0x800:_0x43a588,_0x820598[_0x2ef7cb(0x2c5)]()[_0x2ef7cb(0x2be)](_0x2ef7cb(0x20b))&&(_0x26e3ad=_0x2d4788>=0x4000?0x4000:_0x2d4788,_0x2e690a=_0x43a588>=0x1f40?0x1f40:_0x43a588),_0x820598[_0x2ef7cb(0x2c5)]()[_0x2ef7cb(0x2be)](_0x2ef7cb(0x221))&&(_0x26e3ad=_0x2d4788>=0x4000?0x4000:_0x2d4788,_0x2e690a=_0x43a588>=0x1f40?0x1f40:_0x43a588)),{'maxToken':_0x26e3ad,'maxRes':_0x2e690a};}};ChatgptService=__decorate([(0x0,common_1[_0x36b9b2(0x288)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(gptkeys_entity_1[_0x36b9b2(0x293)])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(config_entity_1['ConfigEntity'])),__param(0x2,(0x0,typeorm_2[_0x36b9b2(0x289)])(chatBoxType_entity_1[_0x36b9b2(0x29b)])),__param(0x3,(0x0,typeorm_2[_0x36b9b2(0x289)])(chatBox_entity_1[_0x36b9b2(0x25d)])),__param(0x4,(0x0,typeorm_2[_0x36b9b2(0x289)])(app_entity_1['AppEntity'])),__param(0x5,(0x0,typeorm_2[_0x36b9b2(0x289)])(chatPreType_entity_1['ChatPreTypeEntity'])),__param(0x6,(0x0,typeorm_2[_0x36b9b2(0x289)])(chatPre_entity_1[_0x36b9b2(0x22d)])),__metadata(_0x36b9b2(0x271),[typeorm_1[_0x36b9b2(0x1dd)],typeorm_1[_0x36b9b2(0x1dd)],typeorm_1['Repository'],typeorm_1[_0x36b9b2(0x1dd)],typeorm_1[_0x36b9b2(0x1dd)],typeorm_1[_0x36b9b2(0x1dd)],typeorm_1[_0x36b9b2(0x1dd)],nestjs_config_1[_0x36b9b2(0x253)],userBalance_service_1[_0x36b9b2(0x27e)],chatLog_service_1[_0x36b9b2(0x24d)],user_service_1['UserService'],upload_service_1[_0x36b9b2(0x2d8)],badwords_service_1[_0x36b9b2(0x23a)],autoreply_service_1[_0x36b9b2(0x200)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0x36b9b2(0x2b3)],chatGroup_service_1['ChatGroupService'],models_service_1[_0x36b9b2(0x1d4)]])],ChatgptService),exports[_0x36b9b2(0x257)]=ChatgptService;