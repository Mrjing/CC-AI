'use strict';const _0x1d5a86=_0x22ff;function _0x22ff(_0x404f71,_0x594d1a){const _0x31f0b4=_0x31f0();return _0x22ff=function(_0x22ffa2,_0x48ddf5){_0x22ffa2=_0x22ffa2-0x7b;let _0x133ec3=_0x31f0b4[_0x22ffa2];return _0x133ec3;},_0x22ff(_0x404f71,_0x594d1a);}(function(_0x39b0bb,_0x25a16c){const _0x17d149=_0x22ff,_0x38dac7=_0x39b0bb();while(!![]){try{const _0x1ea69d=-parseInt(_0x17d149(0x121))/0x1+-parseInt(_0x17d149(0x9e))/0x2+-parseInt(_0x17d149(0xf0))/0x3*(-parseInt(_0x17d149(0xb1))/0x4)+parseInt(_0x17d149(0x10d))/0x5*(-parseInt(_0x17d149(0x8d))/0x6)+parseInt(_0x17d149(0x8c))/0x7+parseInt(_0x17d149(0x113))/0x8+-parseInt(_0x17d149(0x14f))/0x9*(-parseInt(_0x17d149(0xe7))/0xa);if(_0x1ea69d===_0x25a16c)break;else _0x38dac7['push'](_0x38dac7['shift']());}catch(_0x543b1a){_0x38dac7['push'](_0x38dac7['shift']());}}}(_0x31f0,0xd51cd));var __decorate=this&&this[_0x1d5a86(0x11b)]||function(_0x462443,_0xbb56e7,_0x636954,_0x131e62){const _0x339054=_0x1d5a86;var _0x1aeb32=arguments[_0x339054(0x7b)],_0x3949df=_0x1aeb32<0x3?_0xbb56e7:_0x131e62===null?_0x131e62=Object['getOwnPropertyDescriptor'](_0xbb56e7,_0x636954):_0x131e62,_0x473938;if(typeof Reflect===_0x339054(0x174)&&typeof Reflect[_0x339054(0x149)]===_0x339054(0xaa))_0x3949df=Reflect[_0x339054(0x149)](_0x462443,_0xbb56e7,_0x636954,_0x131e62);else{for(var _0x4c8290=_0x462443[_0x339054(0x7b)]-0x1;_0x4c8290>=0x0;_0x4c8290--)if(_0x473938=_0x462443[_0x4c8290])_0x3949df=(_0x1aeb32<0x3?_0x473938(_0x3949df):_0x1aeb32>0x3?_0x473938(_0xbb56e7,_0x636954,_0x3949df):_0x473938(_0xbb56e7,_0x636954))||_0x3949df;}return _0x1aeb32>0x3&&_0x3949df&&Object[_0x339054(0x147)](_0xbb56e7,_0x636954,_0x3949df),_0x3949df;},__metadata=this&&this['__metadata']||function(_0x4e75e3,_0x4d01c5){const _0x17ad2b=_0x1d5a86;if(typeof Reflect===_0x17ad2b(0x174)&&typeof Reflect[_0x17ad2b(0x10c)]===_0x17ad2b(0xaa))return Reflect['metadata'](_0x4e75e3,_0x4d01c5);},__param=this&&this[_0x1d5a86(0x102)]||function(_0x276a1e,_0x462121){return function(_0x2094b5,_0x2dcdf4){_0x462121(_0x2094b5,_0x2dcdf4,_0x276a1e);};};function _0x31f0(){const _0x9802f3=['BAD_REQUEST','ChatPreTypeEntity','queryChatBoxType','getRandomDrawKey','modelsService','getModelProxyUrl','getGroupInfoFromId','chatBoxEntity','uploadService','axios','prompt','usage','mjDraw','openaiModel3MaxTokensRes','../autoreply/autoreply.service','response','config','gpt-4-1106','maxResponseTokens','standard','defineProperty','dall','decorate','importDynamic','Incorrect\x20API\x20key\x20provided','./openai','design:paramtypes','REDIS_PORT','16615503dEjAIk','gpt-3','openaiModel3MaxTokens16kRes','dall-e-3','code:\x20','32k','statusText','Too\x20Many\x20Requests','weight','nestjs-config','ChatPreEntity','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','keyv','getConfigs','save','Repository','debug','queryUserBalance','application/octet-stream;\x20charset=utf-8','model4','./chatPre.entity','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','openaiModel4MaxTokens32k','queryChatPre','openaiModel4MaxTokens','gpt-4-vision-preview','appEntity','appInfo','https://api.openai.com','coverImg','DeductionKey','chatBoxTypeEntity','draw','delChatPreType','../../common/utils','abortController','saveUseLog','object','uploadFile','deductFromBalance','model3','当前模型调用过于频繁、请重新试试吧！','Injectable','../fanyi/fanyi.service','nineai-chatlog','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','length','includes','Please\x20check\x20the\x20back-end\x20console','HttpException','openaiModel3MaxTokens16k','setChatBoxType','imageUrl','map','autoreplyService','Billing\x20hard\x20limit\x20has\x20been\x20reached','slice','getBaseConfig','queryChatPreList','queryChatBoxFrontend','ChatBoxTypeEntity','chatPreEntity','addOneIfOdd','9057979jHvNyV','216pDyzJV','gptKeysEntity','PAYMENT_REQUIRED','NineStore','appId','openai-draw\x20error:\x20','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','ConfigService','ChatgptService','getUploadType','userService','../globalConfig/config.entity','push','../models/models.service','delete','setHeader','./zhipu','1223628FjQaOE','DESC','globalConfigService','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','checkUserStatus','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','../../common/constants/balance.constant','formatModelToken','data','find','checkAutoReply','systemMessage','function','parse','OpenAiErrorCodeMessage','update','\x0a\x20Current\x20date:\x20','fanyiService','error:\x20','8xtMhBk','当前模型key已被封禁','CHAT_TYPE','AutoreplyService','toLowerCase','text','./../user/user.service',',\x20消耗token:\x20','onModuleInit','./chatPreType.entity','b64_json','chatGroupService','../chatLog/chatLog.service','size','write','chatLogService','HttpStatus','getCurrentModelKeyInfo','chatProcess','UserService','assistant','delChatBox','buildMessageFromParentMessageId','end','setData','非法操作！','redis://','count','setChatPreType','status','.png','conversationId','floor','openaiBaseUrl','saveChatLog','queryChatBox','getTokenCount','chatSyncFree','Bearer\x20','all','./baidu','../../common/constants/errorMessage.constant','Logger','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','typeInfo','log','getMaxTokenFromModelWithOpenAi','InjectRepository','stringify','绘制图片失败，请检查你的提示词是否有非法描述！','REDIS_PASSWORD','removeSpecialCharacters','__esModule','1106','10BxmJSs','post','default','findOne','Catch\x20Error\x20','chatPreTypeEntity','当前模型key余额已耗尽','badwordsService','from','275133tAHHDa','statusCode','detail','./chatBox.entity','preset','split','quality','lockKey','user','REDIS_USER','forEach','systemPreMessage','UserBalanceService','./../upload/upload.service','message','filter','../badwords/badwords.service','BadwordsService','__param','ChatGroupService','childList','userBanance','gpt-4','userBalanceService','toISOString','16k','env','当前分类下有未处理数据不可移除！','metadata','166945IwxJWc','../chatGroup/chatGroup.service','queryChatPreType','assign','model','modelInfo','2351616PeKsCa','openaiTimeoutMs','typeorm','PAINT_TYPE','openaiModel4MaxTokens32kRes','result','uuid','sendMessageFromOpenAi','__decorate','../globalConfig/globalConfig.service','getRequestParams','getAllKeyList','提供了错误的模型秘钥','./store','930811YUBTCL','sendMessageFromBaidu','typeId','draw\x20paompt\x20info\x20<==**==>\x20','Content-type','chat','nineStore','DrawService','keyPool',',\x20消耗积分：\x20','chatgpt-ai-web',',\x20key\x20===>\x20','chat-error\x20<----------------------------------------->','FanyiService','GptKeysEntity','compileNetwork','getClientIp','AppEntity'];_0x31f0=function(){return _0x9802f3;};return _0x31f0();}Object[_0x1d5a86(0x147)](exports,_0x1d5a86(0xe5),{'value':!![]}),exports[_0x1d5a86(0x95)]=void 0x0;const upload_service_1=require(_0x1d5a86(0xfd)),user_service_1=require(_0x1d5a86(0xb7)),nestjs_config_1=require(_0x1d5a86(0x158)),common_1=require('@nestjs/common'),errorMessage_constant_1=require(_0x1d5a86(0xda)),utils_1=require(_0x1d5a86(0x171)),axios_1=require(_0x1d5a86(0x13c)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require(_0x1d5a86(0xa4)),chatLog_service_1=require(_0x1d5a86(0xbd)),uuid=require(_0x1d5a86(0x119)),config_entity_1=require(_0x1d5a86(0x98)),typeorm_1=require(_0x1d5a86(0x115)),typeorm_2=require('@nestjs/typeorm'),badwords_service_1=require(_0x1d5a86(0x100)),autoreply_service_1=require(_0x1d5a86(0x141)),gptkeys_entity_1=require('./gptkeys.entity'),globalConfig_service_1=require(_0x1d5a86(0x11c)),fanyi_service_1=require(_0x1d5a86(0x17a)),app_entity_1=require('../app/app.entity'),chatGroup_service_1=require(_0x1d5a86(0x10e)),models_service_1=require(_0x1d5a86(0x9a)),baidu_1=require(_0x1d5a86(0xd9)),helper_1=require('./helper'),store_1=require(_0x1d5a86(0x120)),zhipu_1=require(_0x1d5a86(0x9d)),openai_1=require(_0x1d5a86(0x14c)),chatBoxType_entity_1=require('./chatBoxType.entity'),chatBox_entity_1=require(_0x1d5a86(0xf3)),chatPre_entity_1=require(_0x1d5a86(0x163)),chatPreType_entity_1=require(_0x1d5a86(0xba));let ChatgptService=class ChatgptService{constructor(_0x194058,_0x5d40f8,_0x3e6c31,_0x3a5d35,_0x560ef6,_0x48a0fb,_0x68a144,_0xc89235,_0x215947,_0x406b7d,_0x47cee2,_0x5eb9e4,_0x63b0bc,_0x3c405d,_0xb43b4a,_0x5301d2,_0x407919,_0x530b95){const _0x157c7e=_0x1d5a86;this[_0x157c7e(0x8e)]=_0x194058,this['configEntity']=_0x5d40f8,this[_0x157c7e(0x16e)]=_0x3e6c31,this['chatBoxEntity']=_0x3a5d35,this[_0x157c7e(0x169)]=_0x560ef6,this[_0x157c7e(0xec)]=_0x48a0fb,this[_0x157c7e(0x8a)]=_0x68a144,this['configService']=_0xc89235,this['userBalanceService']=_0x215947,this[_0x157c7e(0xc0)]=_0x406b7d,this[_0x157c7e(0x97)]=_0x47cee2,this[_0x157c7e(0x13b)]=_0x5eb9e4,this['badwordsService']=_0x63b0bc,this[_0x157c7e(0x83)]=_0x3c405d,this[_0x157c7e(0xa0)]=_0xb43b4a,this[_0x157c7e(0xaf)]=_0x5301d2,this[_0x157c7e(0xbc)]=_0x407919,this[_0x157c7e(0x137)]=_0x530b95,this['nineStore']=null,this['whiteListUser']=[],this[_0x157c7e(0x129)]={'list3':[],'list4':[]};}async[_0x1d5a86(0xb9)](){const _0x3a3e04=_0x1d5a86;let _0x47e612=await(0x0,utils_1['importDynamic'])(_0x3a3e04(0x12b)),_0x544d40=await(0x0,utils_1['importDynamic'])('@keyv/redis'),_0x24a886=await(0x0,utils_1[_0x3a3e04(0x14a)])(_0x3a3e04(0x15b));_0x47e612=(_0x47e612===null||_0x47e612===void 0x0?void 0x0:_0x47e612[_0x3a3e04(0xe9)])?_0x47e612[_0x3a3e04(0xe9)]:_0x47e612,_0x544d40=(_0x544d40===null||_0x544d40===void 0x0?void 0x0:_0x544d40[_0x3a3e04(0xe9)])?_0x544d40[_0x3a3e04(0xe9)]:_0x544d40,_0x24a886=(_0x24a886===null||_0x24a886===void 0x0?void 0x0:_0x24a886['default'])?_0x24a886[_0x3a3e04(0xe9)]:_0x24a886;const {ChatGPTAPI:_0x4b49e5,ChatGPTError:_0x5c23fa,ChatGPTUnofficialProxyAPI:_0x36f8c1}=_0x47e612,_0x2e9985=+process['env'][_0x3a3e04(0x14e)],_0x12c26b=process['env']['REDIS_HOST'],_0x903bd4=process['env'][_0x3a3e04(0xe3)],_0x3a1145=process[_0x3a3e04(0x10a)][_0x3a3e04(0xf9)],_0x3d91e9=_0x3a3e04(0xcb)+(_0x3a1145||'')+':'+(_0x903bd4||'')+'@'+_0x12c26b+':'+_0x2e9985,_0x456ae1=new _0x544d40(_0x3d91e9),_0x42e339=new _0x24a886({'store':_0x456ae1,'namespace':_0x3a3e04(0x17b)});this[_0x3a3e04(0x127)]=new store_1[(_0x3a3e04(0x90))]({'store':_0x42e339,'namespace':_0x3a3e04(0x126)});}async['getRequestParams'](_0x352dba,_0x11fc10,_0x256934,_0x444e43=null){const _0x12178c=_0x1d5a86;var _0x33f785;!_0x444e43&&(_0x444e43=(_0x33f785=await this[_0x12178c(0x137)][_0x12178c(0x86)]())===null||_0x33f785===void 0x0?void 0x0:_0x33f785[_0x12178c(0x112)]);const {timeout:timeout=0x3c}=_0x256934,{topN:_0x1217d0,model:_0x36f0e5}=_0x444e43,{parentMessageId:parentMessageId=0x0}=_0x352dba,_0x207036=await this[_0x12178c(0xa0)][_0x12178c(0x15c)]([_0x12178c(0x114)]),_0xf73a0a=timeout*0x3e8||_0x207036||0x64*0x3e8,_0x1f7351={'parentMessageId':parentMessageId,'timeoutMs':+_0xf73a0a,'completionParams':{'model':_0x36f0e5,'temperature':_0x1217d0}};return _0x11fc10&&(_0x1f7351[_0x12178c(0xa9)]=_0x11fc10),_0x1f7351;}async[_0x1d5a86(0xd6)](_0x4c2942){const _0x308ef6=_0x1d5a86,_0x26182d=await this[_0x308ef6(0x137)]['getRandomDrawKey'](),_0x37fb6a=await this[_0x308ef6(0xa0)]['getConfigs']([_0x308ef6(0xfb)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x242ebb,model:_0x31f3d2}=_0x26182d,_0x5b7451=await this[_0x308ef6(0x138)](_0x26182d),{context:_0x18a6bb}=await this[_0x308ef6(0x127)][_0x308ef6(0xc7)](_0x4c2942,{'parentMessageId':'','systemMessage':_0x37fb6a});try{const _0x1df74d=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x18a6bb,{'apiKey':(0x0,utils_1[_0x308ef6(0xe4)])(_0x242ebb),'model':_0x31f3d2,'proxyUrl':_0x5b7451,'onProgress':null});return _0x1df74d===null||_0x1df74d===void 0x0?void 0x0:_0x1df74d[_0x308ef6(0xb6)];}catch(_0x5471c9){console[_0x308ef6(0xde)](_0x308ef6(0xb0),_0x5471c9);}}async[_0x1d5a86(0xc3)](_0x15e989,_0x35dac6,_0x4d0b27){const _0x52ee48=_0x1d5a86;var _0x5290ed,_0x5936b0,_0x2aa88e,_0x1e354f;const _0x34548f=_0x35dac6[_0x52ee48(0x172)],{options:options={},appId:_0x5391c4,cusromPrompt:_0x4e5ef2,systemMessage:systemMessage=''}=_0x15e989;let _0x4cafa2=systemMessage;const {parentMessageId:_0x14eb85}=options,{prompt:_0x2671ad,imageUrl:_0x1265e6,model:_0x358f6c}=_0x15e989,{groupId:_0x2a0647,usingNetwork:_0x4e3a72}=options,_0x44478e=await this[_0x52ee48(0xbc)][_0x52ee48(0x139)](_0x2a0647),_0x2757be=(_0x44478e===null||_0x44478e===void 0x0?void 0x0:_0x44478e[_0x52ee48(0x143)])?JSON[_0x52ee48(0xab)](_0x44478e[_0x52ee48(0x143)]):await this['modelsService'][_0x52ee48(0x86)](),{keyType:_0x2e1853,model:_0x59809a,topN:_0x2134b4,systemMessage:_0x1ac6a8,rounds:_0x3c59ae}=_0x2757be[_0x52ee48(0x112)];let _0x5e44d7=null;!_0x4e5ef2?_0x5e44d7=await this['modelsService'][_0x52ee48(0xc2)](_0x59809a):_0x5e44d7=await this[_0x52ee48(0x137)][_0x52ee48(0x136)]();if(!_0x5e44d7)throw new common_1[(_0x52ee48(0x7e))](_0x52ee48(0x17c),common_1[_0x52ee48(0xc1)][_0x52ee48(0x133)]);const {deduct:_0x441854,isTokenBased:_0x594b12,tokenFeeRatio:_0x3b66d9,deductType:_0x35093c,key:_0x2f025a,secret:_0x4618ba,modelName:_0x256a84,id:_0x3aa77e,accessToken:_0x33fb9f}=_0x5e44d7;await this[_0x52ee48(0x97)]['checkUserStatus'](_0x35dac6[_0x52ee48(0xf8)]),await this['userBalanceService']['validateBalance'](_0x35dac6,_0x35093c===0x1?_0x52ee48(0x177):_0x52ee48(0x162),_0x441854),_0x4d0b27&&_0x4d0b27[_0x52ee48(0x9c)](_0x52ee48(0x125),_0x52ee48(0x161)),await this[_0x52ee48(0xee)]['checkBadWords'](_0x2671ad,_0x35dac6[_0x52ee48(0xf8)]['id']);const _0x1ff756=await this[_0x52ee48(0x83)][_0x52ee48(0xa8)](_0x2671ad);if(_0x1ff756&&_0x4d0b27){const _0xa8766={'message':_0x1ff756,'code':0x1f4};return _0x4d0b27[_0x52ee48(0xbf)](JSON[_0x52ee48(0xe1)](_0xa8766)),_0x4d0b27[_0x52ee48(0xc8)]();}if(_0x5391c4){const _0x42d5af=await this[_0x52ee48(0x169)][_0x52ee48(0xea)]({'where':{'id':_0x5391c4,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x42d5af)throw new common_1[(_0x52ee48(0x7e))](_0x52ee48(0x164),common_1['HttpStatus'][_0x52ee48(0x133)]);_0x42d5af['preset']&&(_0x4cafa2=_0x42d5af[_0x52ee48(0xf4)]);}else{if(_0x4e5ef2)_0x4cafa2=systemMessage;else{if(_0x1ac6a8)_0x4cafa2=_0x1ac6a8;else{const _0x15e2f1=new Date()['toISOString']()[_0x52ee48(0xf5)]('T')[0x0],_0x288450=await this[_0x52ee48(0xa0)][_0x52ee48(0x15c)]([_0x52ee48(0xfb)]);_0x4cafa2=_0x288450+(_0x52ee48(0xae)+_0x15e2f1);}}}let _0x3f0e83='';if(_0x4e3a72){_0x3f0e83=await(0x0,utils_1[_0x52ee48(0x130)])(_0x2671ad);const _0x2d7ca8=new Date()[_0x52ee48(0x108)]()[_0x52ee48(0xf5)]('T')[0x0],_0x1db7cc=await this[_0x52ee48(0xa0)][_0x52ee48(0x15c)]([_0x52ee48(0xfb)]);_0x4cafa2=_0x1db7cc+(_0x52ee48(0xae)+_0x2d7ca8);}const _0x3e275b=await this[_0x52ee48(0x11d)](options,_0x4cafa2,_0x5e44d7,_0x2757be[_0x52ee48(0x112)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x318eb7}=_0x5e44d7;_0x4d0b27&&_0x4d0b27['status'](0xc8);let _0x388012=null,_0x3dc1b6=null;try{if(_0x4d0b27){let _0x4c39a2=null,_0x36993e=![];_0x4d0b27['on']('close',async()=>{const _0x59eac3=_0x52ee48;if(_0x36993e)return;_0x34548f['abort']();const _0x59b12c=await(0x0,openai_1[_0x59eac3(0xd5)])(_0x2671ad)||0x0,_0x178c11=await(0x0,openai_1[_0x59eac3(0xd5)])(_0x4c39a2===null||_0x4c39a2===void 0x0?void 0x0:_0x4c39a2[_0x59eac3(0xb6)])||0x0,_0x46887e=_0x59b12c+_0x178c11,_0x10a300=(0x0,utils_1[_0x59eac3(0x131)])(_0x35dac6);await this[_0x59eac3(0xc0)][_0x59eac3(0xd3)]({'appId':_0x5391c4,'curIp':_0x10a300,'userId':_0x35dac6[_0x59eac3(0xf8)]['id'],'type':balance_constant_1['DeductionKey']['CHAT_TYPE'],'prompt':_0x2671ad,'imageUrl':_0x1265e6,'activeModel':_0x358f6c,'answer':'','promptTokens':_0x59b12c,'completionTokens':0x0,'totalTokens':_0x59b12c,'model':_0x59809a,'role':'user','groupId':_0x2a0647,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x2671ad})}),await this[_0x59eac3(0xc0)][_0x59eac3(0xd3)]({'appId':_0x5391c4,'curIp':_0x10a300,'userId':_0x35dac6[_0x59eac3(0xf8)]['id'],'type':balance_constant_1['DeductionKey'][_0x59eac3(0xb3)],'prompt':_0x2671ad,'answer':_0x4c39a2===null||_0x4c39a2===void 0x0?void 0x0:_0x4c39a2[_0x59eac3(0xb6)],'promptTokens':_0x59b12c,'completionTokens':_0x178c11,'totalTokens':_0x46887e,'model':_0x59809a,'role':_0x59eac3(0xc5),'groupId':_0x2a0647,'requestOptions':JSON[_0x59eac3(0xe1)]({'options':{'model':_0x59809a,'temperature':_0x2134b4},'prompt':_0x2671ad}),'conversationOptions':JSON[_0x59eac3(0xe1)]({'conversationId':_0x4c39a2===null||_0x4c39a2===void 0x0?void 0x0:_0x4c39a2[_0x59eac3(0xd0)],'model':_0x59809a,'parentMessageId':_0x4c39a2===null||_0x4c39a2===void 0x0?void 0x0:_0x4c39a2['id'],'temperature':_0x2134b4})});let _0x52239d=_0x441854;_0x594b12===!![]&&(_0x52239d=Math['ceil'](_0x441854*_0x46887e/_0x3b66d9)),await this[_0x59eac3(0x107)][_0x59eac3(0x176)](_0x35dac6[_0x59eac3(0xf8)]['id'],_0x59eac3(0x111)+(_0x35093c===0x1?0x3:0x4),_0x52239d,_0x46887e);});if(Number(_0x2e1853)===0x1){const {key:_0xc240d5,maxToken:_0x560f7d,maxTokenRes:_0x209e60,proxyResUrl:_0x2829ef}=await this[_0x52ee48(0xa5)](_0x5e44d7),{parentMessageId:_0x5c08ef,completionParams:_0x28ee7f,systemMessage:_0x13b107}=_0x3e275b,{model:_0x4c2cbc,temperature:_0x1b39ab}=_0x28ee7f,{context:_0x294886}=await this[_0x52ee48(0x127)][_0x52ee48(0xc7)](_0x4e3a72?_0x3f0e83:_0x2671ad,{'parentMessageId':_0x5c08ef,'systemMessage':_0x13b107,'maxModelToken':_0x560f7d,'maxResponseTokens':_0x209e60,'maxRounds':(0x0,helper_1[_0x52ee48(0x8b)])(_0x3c59ae),'imageUrl':_0x1265e6,'activeModel':_0x358f6c});let _0x5706ca=!![];_0x388012=await(0x0,openai_1[_0x52ee48(0x11a)])(_0x294886,{'maxToken':_0x560f7d,'maxTokenRes':_0x209e60,'apiKey':_0x2f025a,'model':_0x4c2cbc,'prompt':_0x2671ad,'activeModel':_0x358f6c,'imageUrl':_0x1265e6,'temperature':_0x1b39ab,'proxyUrl':_0x2829ef,'onProgress':_0x5db308=>{const _0x15ab36=_0x52ee48;_0x4d0b27[_0x15ab36(0xbf)](_0x5706ca?JSON['stringify'](_0x5db308):'\x0a'+JSON[_0x15ab36(0xe1)](_0x5db308)),_0x4c39a2=_0x5db308,_0x5706ca=![];}},this['uploadService']),_0x36993e=!![];}if(Number(_0x2e1853)===0x2){let _0x33f7d1=!![];const {context:_0x2a6e92}=await this[_0x52ee48(0x127)][_0x52ee48(0xc7)](_0x4e3a72?_0x3f0e83:_0x2671ad,{'parentMessageId':_0x14eb85,'maxRounds':(0x0,helper_1[_0x52ee48(0x8b)])(_0x3c59ae)});_0x388012=await(0x0,baidu_1[_0x52ee48(0x122)])(_0x4e3a72?_0x3f0e83:_0x2a6e92,{'temperature':_0x2134b4,'accessToken':_0x33fb9f,'model':_0x59809a,'onProgress':_0x2be929=>{const _0x1893e0=_0x52ee48;_0x4d0b27[_0x1893e0(0xbf)](_0x33f7d1?JSON['stringify'](_0x2be929):'\x0a'+JSON[_0x1893e0(0xe1)](_0x2be929)),_0x33f7d1=![],_0x4c39a2=_0x2be929;}}),_0x36993e=!![];}if(Number(_0x2e1853)===0x3){let _0x360684=!![];const {context:_0x55a978}=await this[_0x52ee48(0x127)][_0x52ee48(0xc7)](_0x4e3a72?_0x3f0e83:_0x2671ad,{'parentMessageId':_0x14eb85,'maxRounds':(0x0,helper_1[_0x52ee48(0x8b)])(_0x3c59ae)});_0x388012=await(0x0,zhipu_1['sendMessageFromZhipu'])(_0x4e3a72?_0x3f0e83:_0x55a978,{'temperature':_0x2134b4,'key':_0x318eb7,'model':_0x59809a,'onProgress':_0x328689=>{const _0x3cef85=_0x52ee48;_0x4d0b27[_0x3cef85(0xbf)](_0x360684?JSON['stringify'](_0x328689):'\x0a'+JSON[_0x3cef85(0xe1)](_0x328689)),_0x360684=![],_0x4c39a2=_0x328689;}}),_0x36993e=!![];}const _0x573190={'id':this['nineStore']['getUuid'](),'text':_0x2671ad,'role':_0x52ee48(0xf8),'name':undefined,'usage':null,'imageUrl':_0x1265e6,'activeModel':_0x358f6c,'parentMessageId':_0x14eb85,'conversationId':_0x388012===null||_0x388012===void 0x0?void 0x0:_0x388012[_0x52ee48(0xd0)]};_0x3dc1b6={'model':_0x59809a,'parentMessageId':_0x14eb85},await this[_0x52ee48(0x127)]['setData'](_0x573190);const _0x560372={'id':_0x388012['id'],'text':_0x388012[_0x52ee48(0xb6)],'role':'assistant','name':undefined,'usage':_0x388012===null||_0x388012===void 0x0?void 0x0:_0x388012[_0x52ee48(0x13e)],'imageUrl':_0x1265e6,'parentMessageId':_0x573190['id'],'conversationId':_0x388012===null||_0x388012===void 0x0?void 0x0:_0x388012[_0x52ee48(0xd0)]};await this[_0x52ee48(0x127)][_0x52ee48(0xc9)](_0x560372),_0x3dc1b6={'model':_0x59809a,'parentMessageId':_0x573190['id']};}else{const {key:_0x5098a5,maxToken:_0x59703e,maxTokenRes:_0x4fd1ce,proxyResUrl:_0x20d84d}=await this['formatModelToken'](_0x5e44d7),{parentMessageId:_0x135a51,completionParams:_0x466e66,systemMessage:_0x169159}=_0x3e275b,{model:_0x15ace1,temperature:_0x24a0a3}=_0x466e66,{context:_0x573a76}=await this[_0x52ee48(0x127)][_0x52ee48(0xc7)](_0x4e3a72?_0x3f0e83:_0x2671ad,{'parentMessageId':_0x135a51,'systemMessage':_0x169159,'maxRounds':(0x0,helper_1[_0x52ee48(0x8b)])(_0x3c59ae)});_0x388012=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x573a76,{'apiKey':_0x2f025a,'model':_0x15ace1,'temperature':_0x24a0a3,'proxyUrl':_0x20d84d,'onProgress':null,'prompt':_0x2671ad});}let _0x3308c7=null,_0x1c7e02=null;_0x59809a[_0x52ee48(0x7c)](_0x52ee48(0x148))?_0x3308c7=((_0x5290ed=_0x388012[_0x52ee48(0xf2)])===null||_0x5290ed===void 0x0?void 0x0:_0x5290ed['usage'])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x1c7e02=await(0x0,helper_1['unifiedFormattingResponse'])(_0x2e1853,_0x388012,_0x3dc1b6);const {prompt_tokens:_0x544ee3,completion_tokens:_0x282c8c,total_tokens:_0x105b98}=_0x59809a['includes'](_0x52ee48(0x148))?_0x3308c7:_0x1c7e02[_0x52ee48(0x13e)];let _0x158fcc=_0x441854;_0x594b12===!![]&&(_0x158fcc=Math['ceil'](_0x441854*_0x105b98/_0x3b66d9));await this['userBalanceService'][_0x52ee48(0x176)](_0x35dac6[_0x52ee48(0xf8)]['id'],_0x52ee48(0x111)+(_0x35093c===0x1?0x3:0x4),_0x158fcc,_0x105b98),await this[_0x52ee48(0x137)][_0x52ee48(0x173)](_0x3aa77e,_0x105b98);const _0xcfab=(0x0,utils_1['getClientIp'])(_0x35dac6);await this[_0x52ee48(0xc0)][_0x52ee48(0xd3)]({'appId':_0x5391c4,'curIp':_0xcfab,'userId':_0x35dac6['user']['id'],'type':balance_constant_1[_0x52ee48(0x16d)]['CHAT_TYPE'],'prompt':_0x2671ad,'imageUrl':_0x1265e6,'activeModel':_0x358f6c,'answer':'','promptTokens':_0x544ee3,'completionTokens':0x0,'totalTokens':_0x105b98,'model':_0x59809a,'role':'user','groupId':_0x2a0647,'requestOptions':JSON[_0x52ee48(0xe1)]({'options':null,'prompt':_0x2671ad})}),await this[_0x52ee48(0xc0)]['saveChatLog']({'appId':_0x5391c4,'curIp':_0xcfab,'userId':_0x35dac6[_0x52ee48(0xf8)]['id'],'type':balance_constant_1[_0x52ee48(0x16d)][_0x52ee48(0xb3)],'prompt':_0x2671ad,'imageUrl':_0x388012===null||_0x388012===void 0x0?void 0x0:_0x388012[_0x52ee48(0x81)],'answer':_0x388012['text'],'promptTokens':_0x544ee3,'completionTokens':_0x282c8c,'totalTokens':_0x105b98,'model':_0x59809a,'role':_0x52ee48(0xc5),'groupId':_0x2a0647,'requestOptions':JSON[_0x52ee48(0xe1)]({'options':{'model':_0x59809a,'temperature':_0x2134b4},'prompt':_0x2671ad}),'conversationOptions':JSON[_0x52ee48(0xe1)]({'conversationId':_0x388012[_0x52ee48(0xd0)],'model':_0x59809a,'parentMessageId':_0x388012['id'],'temperature':_0x2134b4})}),common_1['Logger'][_0x52ee48(0x15f)]('用户ID:\x20'+_0x35dac6['user']['id']+'\x20模型名称:\x20'+_0x256a84+'-'+_0x358f6c+_0x52ee48(0xb8)+_0x105b98+_0x52ee48(0x12a)+_0x158fcc,_0x52ee48(0x95));const _0x55f9cf=await this[_0x52ee48(0x107)][_0x52ee48(0x160)](_0x35dac6['user']['id']);return _0x388012[_0x52ee48(0x105)]=Object[_0x52ee48(0x110)]({},_0x55f9cf),_0x388012[_0x52ee48(0x118)]&&(_0x388012[_0x52ee48(0x118)]=''),_0x388012['is_end']=!![],_0x4d0b27?_0x4d0b27[_0x52ee48(0xbf)]('\x0a'+JSON['stringify'](_0x388012)):_0x388012['text'];}catch(_0x24f4ac){console['log'](_0x52ee48(0x12d),_0x2f025a,_0x24f4ac);const _0x5ce261=(_0x24f4ac===null||_0x24f4ac===void 0x0?void 0x0:_0x24f4ac[_0x52ee48(0xf1)])||0x190,_0x2effb0=((_0x5936b0=_0x24f4ac===null||_0x24f4ac===void 0x0?void 0x0:_0x24f4ac[_0x52ee48(0x142)])===null||_0x5936b0===void 0x0?void 0x0:_0x5936b0['status'])||(_0x24f4ac===null||_0x24f4ac===void 0x0?void 0x0:_0x24f4ac[_0x52ee48(0xf1)])||0x190;console[_0x52ee48(0xde)]('chat-error-detail\x20\x20<----------------------------------------->',_0x52ee48(0x153),_0x5ce261,_0x52ee48(0xfe),_0x24f4ac===null||_0x24f4ac===void 0x0?void 0x0:_0x24f4ac[_0x52ee48(0xfe)],'statusText:',(_0x2aa88e=_0x24f4ac===null||_0x24f4ac===void 0x0?void 0x0:_0x24f4ac[_0x52ee48(0x142)])===null||_0x2aa88e===void 0x0?void 0x0:_0x2aa88e['statusText'],_0x52ee48(0xce),(_0x1e354f=_0x24f4ac===null||_0x24f4ac===void 0x0?void 0x0:_0x24f4ac[_0x52ee48(0x142)])===null||_0x1e354f===void 0x0?void 0x0:_0x1e354f[_0x52ee48(0xce)]);if(_0x24f4ac[_0x52ee48(0xce)]&&_0x24f4ac[_0x52ee48(0xce)]===0x192){const _0x4484c6={'message':_0x52ee48(0xeb)+_0x24f4ac[_0x52ee48(0xfe)],'code':0x192};if(_0x4d0b27)return _0x4d0b27[_0x52ee48(0xbf)](JSON[_0x52ee48(0xe1)](_0x4484c6));else throw new common_1['HttpException'](_0x24f4ac[_0x52ee48(0xfe)],common_1[_0x52ee48(0xc1)][_0x52ee48(0x8f)]);}if(!_0x2effb0){if(_0x4d0b27)return _0x4d0b27['write'](JSON[_0x52ee48(0xe1)]({'message':_0x24f4ac[_0x52ee48(0xfe)],'code':0x1f4}));else throw new common_1[(_0x52ee48(0x7e))](_0x24f4ac[_0x52ee48(0xfe)],common_1[_0x52ee48(0xc1)]['BAD_REQUEST']);}let _0x329014=errorMessage_constant_1[_0x52ee48(0xac)][_0x2effb0]?errorMessage_constant_1[_0x52ee48(0xac)][_0x2effb0]:'服务异常、请重新试试吧！！！';(_0x24f4ac===null||_0x24f4ac===void 0x0?void 0x0:_0x24f4ac[_0x52ee48(0xfe)][_0x52ee48(0x7c)](_0x52ee48(0xa1)))&&Number(_0x2e1853)===0x1&&(await this['modelsService'][_0x52ee48(0xf7)](_0x3aa77e,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0x329014=_0x52ee48(0xb2));(_0x24f4ac===null||_0x24f4ac===void 0x0?void 0x0:_0x24f4ac[_0x52ee48(0xf1)])===0x1ad&&_0x24f4ac[_0x52ee48(0xfe)][_0x52ee48(0x7c)]('billing')&&Number(_0x2e1853)===0x1&&(await this[_0x52ee48(0x137)]['lockKey'](_0x3aa77e,'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x329014=_0x52ee48(0xed));(_0x24f4ac===null||_0x24f4ac===void 0x0?void 0x0:_0x24f4ac[_0x52ee48(0xf1)])===0x1ad&&(_0x24f4ac===null||_0x24f4ac===void 0x0?void 0x0:_0x24f4ac[_0x52ee48(0x155)])===_0x52ee48(0x156)&&(_0x329014=_0x52ee48(0x178));(_0x24f4ac===null||_0x24f4ac===void 0x0?void 0x0:_0x24f4ac[_0x52ee48(0xf1)])===0x191&&_0x24f4ac[_0x52ee48(0xfe)][_0x52ee48(0x7c)](_0x52ee48(0x14b))&&Number(_0x2e1853)===0x1&&(await this['modelsService']['lockKey'](_0x3aa77e,_0x52ee48(0x11f),-0x2),_0x329014='提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！');(_0x24f4ac===null||_0x24f4ac===void 0x0?void 0x0:_0x24f4ac[_0x52ee48(0xf1)])===0x194&&_0x24f4ac[_0x52ee48(0xfe)][_0x52ee48(0x7c)](_0x52ee48(0x15a))&&Number(_0x2e1853)===0x1&&(await this[_0x52ee48(0x137)][_0x52ee48(0xf7)](_0x3aa77e,'当前模型不是聊天模型',-0x4),_0x329014=_0x52ee48(0x93));_0x5ce261===0x190&&console[_0x52ee48(0xde)]('400\x20error',_0x24f4ac,_0x24f4ac[_0x52ee48(0xfe)]);const _0x51859c={'message':_0x329014||_0x52ee48(0x7d),'code':_0x5ce261===0x191?0x190:_0x5ce261||0x1f4};if(_0x4d0b27)return _0x4d0b27[_0x52ee48(0xbf)](JSON[_0x52ee48(0xe1)](_0x51859c));else throw new common_1['HttpException'](_0x51859c[_0x52ee48(0xfe)],common_1['HttpStatus'][_0x52ee48(0x133)]);}finally{_0x4d0b27&&_0x4d0b27['end']();}}async[_0x1d5a86(0x16f)](_0x659edc,_0x334116){const _0x1c864f=_0x1d5a86;var _0x474282,_0x40716f,_0xf73cae,_0x3900d6;await this[_0x1c864f(0xee)]['checkBadWords'](_0x659edc[_0x1c864f(0x13d)],_0x334116['user']['id']),await this[_0x1c864f(0x97)][_0x1c864f(0xa2)](_0x334116['user']);const _0x36ad53=(_0x659edc===null||_0x659edc===void 0x0?void 0x0:_0x659edc[_0x1c864f(0xf6)])==='hd'?0x4:0x2;await this['userBalanceService']['validateBalance'](_0x334116,_0x1c864f(0x13f),_0x36ad53);let _0x79f16f=[];const _0x24464a=await this[_0x1c864f(0x137)]['getCurrentModelKeyInfo'](_0x1c864f(0x152)),_0x3deb64=_0x24464a===null||_0x24464a===void 0x0?void 0x0:_0x24464a['id'],{key:_0x4c270d,proxyResUrl:_0x195dba}=await this[_0x1c864f(0xa5)](_0x24464a);common_1[_0x1c864f(0xdb)][_0x1c864f(0xde)](_0x1c864f(0x124)+_0x659edc[_0x1c864f(0x13d)]+_0x1c864f(0x12c)+_0x4c270d,_0x1c864f(0x128));try{const _0x1383bc=_0x195dba+'/v1/images/generations',_0x7ae085=Object['assign'](Object[_0x1c864f(0x110)]({},_0x659edc),{'model':_0x1c864f(0x152)});console['log']('dall-e\x20draw\x20params:\x20',_0x7ae085);const _0x484573=await axios_1[_0x1c864f(0xe9)][_0x1c864f(0xe8)](_0x1383bc,Object[_0x1c864f(0x110)](Object[_0x1c864f(0x110)]({},_0x7ae085),{'response_format':_0x1c864f(0xbb)}),{'headers':{'Authorization':_0x1c864f(0xd7)+_0x4c270d}});_0x79f16f=_0x484573[_0x1c864f(0xa6)][_0x1c864f(0xa6)];const _0x16bbbc=[];for(const _0x17a500 of _0x79f16f){const _0x4625f1=uuid['v4']()[_0x1c864f(0x85)](0x0,0xa)+_0x1c864f(0xcf),_0x47dfe4=Buffer[_0x1c864f(0xef)](_0x17a500['b64_json'],'base64');_0x16bbbc[_0x1c864f(0x99)](this[_0x1c864f(0x13b)][_0x1c864f(0x175)]({'filename':_0x4625f1,'buffer':_0x47dfe4}));}const _0x40326a=await Promise[_0x1c864f(0xd8)](_0x16bbbc);await this[_0x1c864f(0x107)][_0x1c864f(0x176)](_0x334116[_0x1c864f(0xf8)]['id'],_0x1c864f(0x13f),(_0x7ae085===null||_0x7ae085===void 0x0?void 0x0:_0x7ae085[_0x1c864f(0xf6)])===_0x1c864f(0x146)?0x2:0x4,_0x36ad53);const _0x41e5cd=(0x0,utils_1[_0x1c864f(0x131)])(_0x334116),_0x37c21b=[],_0x5f52fc=await this[_0x1c864f(0x13b)][_0x1c864f(0x96)](),[_0x36db1a,_0x3c816a]=_0x659edc[_0x1c864f(0xbe)]['split']('x');return _0x40326a[_0x1c864f(0xfa)](_0xf1c93e=>{const _0x113791=_0x1c864f;_0x37c21b[_0x113791(0x99)](this[_0x113791(0xc0)][_0x113791(0xd3)]({'curIp':_0x41e5cd,'userId':_0x334116[_0x113791(0xf8)]['id'],'type':balance_constant_1[_0x113791(0x16d)][_0x113791(0x116)],'prompt':_0x659edc[_0x113791(0x13d)],'answer':_0xf1c93e,'fileInfo':JSON[_0x113791(0xe1)]({'cosType':_0x5f52fc,'width':_0x36db1a,'height':_0x3c816a,'cosUrl':_0xf1c93e}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':'dall-e-3'}));}),await Promise['all'](_0x37c21b),_0x40326a;}catch(_0x4355aa){const _0x2139e3=((_0x474282=_0x4355aa===null||_0x4355aa===void 0x0?void 0x0:_0x4355aa[_0x1c864f(0x142)])===null||_0x474282===void 0x0?void 0x0:_0x474282[_0x1c864f(0xce)])||0x1f4;console['log'](_0x1c864f(0x92),JSON[_0x1c864f(0xe1)](_0x4355aa),_0x4c270d,_0x2139e3);const _0x5d52a6=(_0x3900d6=(_0xf73cae=(_0x40716f=_0x4355aa===null||_0x4355aa===void 0x0?void 0x0:_0x4355aa['response'])===null||_0x40716f===void 0x0?void 0x0:_0x40716f[_0x1c864f(0xa6)])===null||_0xf73cae===void 0x0?void 0x0:_0xf73cae['error'])===null||_0x3900d6===void 0x0?void 0x0:_0x3900d6[_0x1c864f(0xfe)];if(_0x2139e3===0x1ad)throw new common_1['HttpException']('当前请求已过载、请稍等会儿再试试吧！',common_1[_0x1c864f(0xc1)][_0x1c864f(0x133)]);if(_0x2139e3===0x190&&_0x5d52a6[_0x1c864f(0x7c)]('This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters'))throw new common_1[(_0x1c864f(0x7e))](_0x1c864f(0xa3),common_1[_0x1c864f(0xc1)]['BAD_REQUEST']);if(_0x2139e3===0x190&&_0x5d52a6['includes'](_0x1c864f(0x84))){await this[_0x1c864f(0x137)][_0x1c864f(0xf7)](_0x3deb64,_0x1c864f(0xdc),-0x1);throw new common_1['HttpException']('当前Key余额已不足、请重新再试一次吧！',common_1['HttpStatus']['BAD_REQUEST']);}if(_0x2139e3===0x1f4)throw new common_1[(_0x1c864f(0x7e))](_0x1c864f(0xe2),common_1[_0x1c864f(0xc1)]['BAD_REQUEST']);if(_0x2139e3===0x191)throw new common_1[(_0x1c864f(0x7e))]('绘制图片失败，此次绘画被拒绝了！',common_1[_0x1c864f(0xc1)][_0x1c864f(0x133)]);throw new common_1[(_0x1c864f(0x7e))]('绘制图片失败，请稍后试试吧！',common_1[_0x1c864f(0xc1)][_0x1c864f(0x133)]);}}async[_0x1d5a86(0x11e)](){const _0x205cfd=_0x1d5a86,_0x5c1379=await this['gptKeysEntity'][_0x205cfd(0xa7)]({'where':{'status':0x1},'select':['id','key',_0x205cfd(0x157),_0x205cfd(0x111),'maxModelTokens',_0x205cfd(0x145),'openaiProxyUrl','openaiTimeoutMs']}),_0x81255f=_0x5c1379[_0x205cfd(0xff)](_0x16e16d=>_0x16e16d['model'][_0x205cfd(0x7c)]('gpt-3')),_0xc84eea=_0x5c1379['filter'](_0x2fdc9c=>_0x2fdc9c[_0x205cfd(0x111)][_0x205cfd(0x7c)]('gpt-4'));this[_0x205cfd(0x129)]={'list3':_0x81255f,'list4':_0xc84eea};}async[_0x1d5a86(0x138)](_0x20a349){const _0x947b3f=_0x1d5a86,_0x125b55=await this['globalConfigService']['getConfigs']([_0x947b3f(0xd2)]);return(_0x20a349===null||_0x20a349===void 0x0?void 0x0:_0x20a349['proxyUrl'])||_0x125b55||_0x947b3f(0x16b);}async['formatModelToken'](_0x1f9298){const _0x5773d1=_0x1d5a86,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x5773d1(0xa0)][_0x5773d1(0x15c)](['openaiModel3MaxTokens',_0x5773d1(0x140),_0x5773d1(0x7f),_0x5773d1(0x151),_0x5773d1(0x167),'openaiModel4MaxTokensRes',_0x5773d1(0x165),_0x5773d1(0x117),_0x5773d1(0xd2)]);let _0x45bbc1=null,_0x273662=null,_0x158504=null,{model:_0x3148ea,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x38066d}=_0x1f9298;return _0x3148ea['toLowerCase']()[_0x5773d1(0x7c)](_0x5773d1(0x106))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x273662>=0x1000&&(maxModelTokens=0x1000),_0x45bbc1=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x273662=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x3148ea[_0x5773d1(0xb5)]()[_0x5773d1(0x7c)](_0x5773d1(0x154))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x273662>=0x4000&&(maxModelTokens=0x4000),_0x45bbc1=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x273662=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x3148ea['toLowerCase']()[_0x5773d1(0x7c)](_0x5773d1(0xe6))&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x273662>=0x1000&&(maxModelTokens=0x1000),_0x45bbc1=maxModelTokens||0x3ffc,_0x273662=maxResponseTokens||0x1000)),_0x3148ea[_0x5773d1(0xb5)]()[_0x5773d1(0x7c)]('gpt-3')&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x273662>=0x7d0&&(maxModelTokens=0x7d0),_0x45bbc1=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x273662=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x3148ea[_0x5773d1(0xb5)]()['includes'](_0x5773d1(0x109))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x273662>=0x2000&&(maxModelTokens=0x2000),_0x45bbc1=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x273662=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x3148ea[_0x5773d1(0xb5)]()['includes'](_0x5773d1(0xe6))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x273662>=0x1000&&(maxModelTokens=0x1000),_0x45bbc1=maxModelTokens||0x4000,_0x273662=maxResponseTokens||0x1000)),_0x158504=proxyUrl||openaiBaseUrl||_0x5773d1(0x16b),_0x273662>=_0x45bbc1&&(_0x273662=Math[_0x5773d1(0xd1)](_0x45bbc1/0x2)),{'key':_0x38066d,'maxToken':_0x45bbc1,'maxTokenRes':_0x273662,'proxyResUrl':_0x158504};}async[_0x1d5a86(0x80)](_0x588d15,_0x530270){const _0x3dc86c=_0x1d5a86;try{const {name:_0x291306,icon:_0x5e207c,order:_0x16a833,id:_0x22a44d,status:_0x5d2802}=_0x530270;return _0x22a44d?await this['chatBoxTypeEntity'][_0x3dc86c(0xad)]({'id':_0x22a44d},{'name':_0x291306,'icon':_0x5e207c,'order':_0x16a833,'status':_0x5d2802}):await this[_0x3dc86c(0x16e)]['save']({'name':_0x291306,'icon':_0x5e207c,'order':_0x16a833,'status':_0x5d2802});}catch(_0x33139a){console[_0x3dc86c(0xde)](_0x3dc86c(0xb0),_0x33139a);}}async['delChatBoxType'](_0x605ab0,_0x43ecdf){const _0x457d67=_0x1d5a86,{id:_0x18d56d}=_0x43ecdf;if(!_0x18d56d)throw new common_1['HttpException'](_0x457d67(0xca),common_1[_0x457d67(0xc1)][_0x457d67(0x133)]);const _0x4f942b=await this[_0x457d67(0x13a)][_0x457d67(0xcc)]({'where':{'typeId':_0x18d56d}});if(_0x4f942b)throw new common_1[(_0x457d67(0x7e))](_0x457d67(0x10b),common_1[_0x457d67(0xc1)]['BAD_REQUEST']);return await this[_0x457d67(0x16e)]['delete']({'id':_0x18d56d});}async[_0x1d5a86(0x135)](){const _0x12d21b=_0x1d5a86;return await this[_0x12d21b(0x16e)][_0x12d21b(0xa7)]({'order':{'order':'DESC'}});}async['setChatBox'](_0x204077,_0x50954c){const _0x522a53=_0x1d5a86,{title:_0x40a815,prompt:_0x352367,appId:_0x3ade21,order:_0x106968,status:_0x3d7730,typeId:_0x3c8a2c,id:_0x5213c1,url:_0x3086b0}=_0x50954c;if(!_0x3c8a2c)throw new common_1[(_0x522a53(0x7e))]('缺失必要参数！',common_1[_0x522a53(0xc1)][_0x522a53(0x133)]);try{const _0xd52f8a={'title':_0x40a815,'order':_0x106968,'status':_0x3d7730,'typeId':_0x3c8a2c,'url':_0x3086b0};return _0xd52f8a[_0x522a53(0x91)]=_0x3ade21||0x0,_0xd52f8a['prompt']=_0x352367||'',_0x5213c1?await this['chatBoxEntity'][_0x522a53(0xad)]({'id':_0x5213c1},_0xd52f8a):await this['chatBoxEntity'][_0x522a53(0x15d)](_0xd52f8a);}catch(_0x522258){console['log'](_0x522a53(0xb0),_0x522258);}}async[_0x1d5a86(0xc6)](_0x4fd2bf,_0xe8fec6){const _0x46f838=_0x1d5a86,{id:_0x3549a2}=_0xe8fec6;if(!_0x3549a2)throw new common_1[(_0x46f838(0x7e))](_0x46f838(0xca),common_1[_0x46f838(0xc1)][_0x46f838(0x133)]);return await this[_0x46f838(0x13a)]['delete']({'id':_0x3549a2});}async[_0x1d5a86(0xd4)](){const _0x4ae660=_0x1d5a86,_0x38d464=await this[_0x4ae660(0x13a)]['find']({'order':{'order':_0x4ae660(0x9f)}}),_0x9e33a1=[...new Set(_0x38d464[_0x4ae660(0x82)](_0x13c160=>_0x13c160[_0x4ae660(0x123)]))],_0x35b3d6=[...new Set(_0x38d464[_0x4ae660(0x82)](_0x5ac44b=>_0x5ac44b['appId']))],_0x4d1645=await this[_0x4ae660(0x16e)][_0x4ae660(0xa7)]({'where':{'id':(0x0,typeorm_1['In'])(_0x9e33a1)}}),_0x3243a3=await this[_0x4ae660(0x169)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x35b3d6)}});return _0x38d464['map'](_0x5897ae=>{const _0x5e75eb=_0x4ae660,{typeId:_0x3b938f,appId:_0x489d7f}=_0x5897ae;return _0x5897ae[_0x5e75eb(0xdd)]=_0x4d1645[_0x5e75eb(0xa7)](_0x17fc0b=>_0x17fc0b['id']===_0x3b938f),_0x5897ae[_0x5e75eb(0x16a)]=_0x3243a3[_0x5e75eb(0xa7)](_0x28ee5c=>_0x28ee5c['id']===_0x489d7f),_0x5897ae;});}async[_0x1d5a86(0x88)](){const _0x17b7e9=_0x1d5a86,_0x2eb9d6=await this[_0x17b7e9(0x16e)][_0x17b7e9(0xa7)]({'order':{'order':_0x17b7e9(0x9f)},'where':{'status':!![]}}),_0x5c0d94=await this['chatBoxEntity']['find']({'where':{'status':!![]}}),_0x448314=[...new Set(_0x5c0d94[_0x17b7e9(0x82)](_0x138adc=>_0x138adc['appId']))],_0x3fae5c=await this[_0x17b7e9(0x169)][_0x17b7e9(0xa7)]({'where':{'id':(0x0,typeorm_1['In'])(_0x448314)}});return _0x5c0d94['forEach'](_0xc428ee=>{const _0x334ebe=_0x17b7e9,_0xef3335=_0x3fae5c['find'](_0x4d4c89=>_0x4d4c89['id']===_0xc428ee[_0x334ebe(0x91)]);return _0xc428ee[_0x334ebe(0x16c)]=_0xef3335===null||_0xef3335===void 0x0?void 0x0:_0xef3335[_0x334ebe(0x16c)],_0xc428ee;}),_0x2eb9d6['map'](_0x3c5425=>{const _0x5528ec=_0x17b7e9;return _0x3c5425[_0x5528ec(0x104)]=_0x5c0d94['filter'](_0x4e2749=>_0x4e2749[_0x5528ec(0x123)]===_0x3c5425['id']&&_0x4e2749[_0x5528ec(0xce)]),_0x3c5425;});}async[_0x1d5a86(0xcd)](_0x4e648f,_0x306a45){const _0x36041c=_0x1d5a86;try{const {name:_0x55992f,icon:_0x11db9c,order:_0x20c1e6,id:_0x11c7af,status:_0x427962}=_0x306a45;return _0x11c7af?await this[_0x36041c(0xec)][_0x36041c(0xad)]({'id':_0x11c7af},{'name':_0x55992f,'icon':_0x11db9c,'order':_0x20c1e6,'status':_0x427962}):await this[_0x36041c(0xec)]['save']({'name':_0x55992f,'icon':_0x11db9c,'order':_0x20c1e6,'status':_0x427962});}catch(_0x131b8f){console[_0x36041c(0xde)](_0x36041c(0xb0),_0x131b8f);}}async[_0x1d5a86(0x170)](_0x349c44,_0x32f053){const _0xcd20d7=_0x1d5a86,{id:_0x3ded6f}=_0x32f053;if(!_0x3ded6f)throw new common_1[(_0xcd20d7(0x7e))](_0xcd20d7(0xca),common_1[_0xcd20d7(0xc1)][_0xcd20d7(0x133)]);const _0x29a843=await this[_0xcd20d7(0x13a)][_0xcd20d7(0xcc)]({'where':{'typeId':_0x3ded6f}});if(_0x29a843)throw new common_1[(_0xcd20d7(0x7e))]('当前分类下有未处理数据不可移除！',common_1['HttpStatus']['BAD_REQUEST']);return await this[_0xcd20d7(0xec)]['delete']({'id':_0x3ded6f});}async[_0x1d5a86(0x10f)](){const _0x316e1a=_0x1d5a86;return await this[_0x316e1a(0xec)][_0x316e1a(0xa7)]({'order':{'order':_0x316e1a(0x9f)}});}async['setChatPre'](_0xcd50a6,_0x211f53){const _0x56e3b8=_0x1d5a86,{title:_0x4fe61a,prompt:_0x2ad0d0,appId:_0x180703,order:_0x3cd46d,status:_0x7f887b,typeId:_0x2458f1,id:_0x4ed100,url:_0x164615}=_0x211f53;if(!_0x2458f1)throw new common_1[(_0x56e3b8(0x7e))]('缺失必要参数！',common_1['HttpStatus'][_0x56e3b8(0x133)]);try{const _0x2b588c={'title':_0x4fe61a,'prompt':_0x2ad0d0,'order':_0x3cd46d,'status':_0x7f887b,'typeId':_0x2458f1,'url':_0x164615};return _0x4ed100?await this[_0x56e3b8(0x8a)]['update']({'id':_0x4ed100},_0x2b588c):await this[_0x56e3b8(0x8a)][_0x56e3b8(0x15d)](_0x2b588c);}catch(_0x28cc51){console[_0x56e3b8(0xde)](_0x56e3b8(0xb0),_0x28cc51);}}async['delChatPre'](_0x4e0a9f,_0x95170f){const _0xf193ac=_0x1d5a86,{id:_0x5f086e}=_0x95170f;if(!_0x5f086e)throw new common_1[(_0xf193ac(0x7e))]('非法操作！',common_1[_0xf193ac(0xc1)]['BAD_REQUEST']);return await this[_0xf193ac(0x8a)][_0xf193ac(0x9b)]({'id':_0x5f086e});}async[_0x1d5a86(0x166)](){const _0x282e95=_0x1d5a86,_0x4b24d9=await this[_0x282e95(0x8a)]['find']({'order':{'order':'DESC'}}),_0x31345e=[...new Set(_0x4b24d9[_0x282e95(0x82)](_0x2abe96=>_0x2abe96[_0x282e95(0x123)]))],_0x41cae4=await this[_0x282e95(0xec)][_0x282e95(0xa7)]({'where':{'id':(0x0,typeorm_1['In'])(_0x31345e)}});return _0x4b24d9[_0x282e95(0x82)](_0x1538ac=>{const _0x9c3534=_0x282e95,{typeId:_0x4b6195,appId:_0x481762}=_0x1538ac;return _0x1538ac[_0x9c3534(0xdd)]=_0x41cae4[_0x9c3534(0xa7)](_0x598b3b=>_0x598b3b['id']===_0x4b6195),_0x1538ac;});}async[_0x1d5a86(0x87)](){const _0x1c65d3=_0x1d5a86,_0x18f61d=await this['chatPreTypeEntity'][_0x1c65d3(0xa7)]({'order':{'order':'DESC'},'where':{'status':!![]}}),_0xdd82f6=await this[_0x1c65d3(0x8a)][_0x1c65d3(0xa7)]({'where':{'status':!![]}});return _0x18f61d[_0x1c65d3(0x82)](_0x44a8a9=>{const _0x12497a=_0x1c65d3;return _0x44a8a9[_0x12497a(0x104)]=_0xdd82f6['filter'](_0x548423=>_0x548423[_0x12497a(0x123)]===_0x44a8a9['id']&&_0x548423[_0x12497a(0xce)]),_0x44a8a9;});}async[_0x1d5a86(0xdf)](_0x2023af,_0x4e6535,_0x1dd148){const _0x498970=_0x1d5a86;let _0x514cb6=0x1000,_0x53b7cc=0x800;return _0x2023af['toLowerCase']()[_0x498970(0x7c)](_0x498970(0x106))&&(_0x514cb6=_0x4e6535>=0x2004?0x2004:_0x4e6535,_0x53b7cc=_0x1dd148>=0x1000?0x1000:_0x1dd148,_0x2023af[_0x498970(0xb5)]()[_0x498970(0x7c)](_0x498970(0x154))&&(_0x514cb6=_0x4e6535>=0x8000?0x8000:_0x4e6535,_0x53b7cc=_0x1dd148>=0x3e80?0x3e80:_0x1dd148),(_0x2023af[_0x498970(0xb5)]()[_0x498970(0x7c)](_0x498970(0x144))||_0x2023af[_0x498970(0xb5)]()[_0x498970(0x7c)](_0x498970(0x168)))&&(_0x514cb6=_0x4e6535>=0x1f400?0x1f400:_0x4e6535,_0x53b7cc=_0x1dd148>=0x1000?0x1000:_0x1dd148)),_0x2023af['toLowerCase']()[_0x498970(0x7c)](_0x498970(0x150))&&(_0x514cb6=_0x4e6535>=0x1000?0x1000:_0x4e6535,_0x53b7cc=_0x1dd148>=0x800?0x800:_0x1dd148,_0x2023af['toLowerCase']()[_0x498970(0x7c)]('16k')&&(_0x514cb6=_0x4e6535>=0x4000?0x4000:_0x4e6535,_0x53b7cc=_0x1dd148>=0x1f40?0x1f40:_0x1dd148),_0x2023af['toLowerCase']()[_0x498970(0x7c)]('1106')&&(_0x514cb6=_0x4e6535>=0x4000?0x4000:_0x4e6535,_0x53b7cc=_0x1dd148>=0x1f40?0x1f40:_0x1dd148)),{'maxToken':_0x514cb6,'maxRes':_0x53b7cc};}};ChatgptService=__decorate([(0x0,common_1[_0x1d5a86(0x179)])(),__param(0x0,(0x0,typeorm_2[_0x1d5a86(0xe0)])(gptkeys_entity_1[_0x1d5a86(0x12f)])),__param(0x1,(0x0,typeorm_2[_0x1d5a86(0xe0)])(config_entity_1['ConfigEntity'])),__param(0x2,(0x0,typeorm_2[_0x1d5a86(0xe0)])(chatBoxType_entity_1[_0x1d5a86(0x89)])),__param(0x3,(0x0,typeorm_2[_0x1d5a86(0xe0)])(chatBox_entity_1['ChatBoxEntity'])),__param(0x4,(0x0,typeorm_2['InjectRepository'])(app_entity_1[_0x1d5a86(0x132)])),__param(0x5,(0x0,typeorm_2[_0x1d5a86(0xe0)])(chatPreType_entity_1[_0x1d5a86(0x134)])),__param(0x6,(0x0,typeorm_2['InjectRepository'])(chatPre_entity_1[_0x1d5a86(0x159)])),__metadata(_0x1d5a86(0x14d),[typeorm_1['Repository'],typeorm_1['Repository'],typeorm_1['Repository'],typeorm_1[_0x1d5a86(0x15e)],typeorm_1[_0x1d5a86(0x15e)],typeorm_1[_0x1d5a86(0x15e)],typeorm_1[_0x1d5a86(0x15e)],nestjs_config_1[_0x1d5a86(0x94)],userBalance_service_1[_0x1d5a86(0xfc)],chatLog_service_1['ChatLogService'],user_service_1[_0x1d5a86(0xc4)],upload_service_1['UploadService'],badwords_service_1[_0x1d5a86(0x101)],autoreply_service_1[_0x1d5a86(0xb4)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0x1d5a86(0x12e)],chatGroup_service_1[_0x1d5a86(0x103)],models_service_1['ModelsService']])],ChatgptService),exports[_0x1d5a86(0x95)]=ChatgptService;