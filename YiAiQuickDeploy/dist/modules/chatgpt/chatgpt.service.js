'use strict';const _0xbabf12=_0x114b;(function(_0x2ba931,_0x17c24c){const _0x3b58dd=_0x114b,_0xd07bfa=_0x2ba931();while(!![]){try{const _0x34c8ed=-parseInt(_0x3b58dd(0x15e))/0x1+-parseInt(_0x3b58dd(0xc3))/0x2+parseInt(_0x3b58dd(0xb4))/0x3*(-parseInt(_0x3b58dd(0xb3))/0x4)+-parseInt(_0x3b58dd(0x180))/0x5*(parseInt(_0x3b58dd(0xfa))/0x6)+-parseInt(_0x3b58dd(0xa8))/0x7*(-parseInt(_0x3b58dd(0x106))/0x8)+-parseInt(_0x3b58dd(0x10f))/0x9*(-parseInt(_0x3b58dd(0x9a))/0xa)+parseInt(_0x3b58dd(0xcc))/0xb*(parseInt(_0x3b58dd(0xef))/0xc);if(_0x34c8ed===_0x17c24c)break;else _0xd07bfa['push'](_0xd07bfa['shift']());}catch(_0x5311bd){_0xd07bfa['push'](_0xd07bfa['shift']());}}}(_0x26a8,0x9dbf6));var __decorate=this&&this[_0xbabf12(0x100)]||function(_0x2750df,_0x1a0a11,_0x31ae25,_0x362a62){const _0x298cee=_0xbabf12;var _0x8a0e84=arguments['length'],_0x4f3a73=_0x8a0e84<0x3?_0x1a0a11:_0x362a62===null?_0x362a62=Object[_0x298cee(0xd4)](_0x1a0a11,_0x31ae25):_0x362a62,_0x1e790b;if(typeof Reflect===_0x298cee(0xdc)&&typeof Reflect['decorate']===_0x298cee(0xe1))_0x4f3a73=Reflect[_0x298cee(0x16b)](_0x2750df,_0x1a0a11,_0x31ae25,_0x362a62);else{for(var _0xfeeb0d=_0x2750df[_0x298cee(0x10d)]-0x1;_0xfeeb0d>=0x0;_0xfeeb0d--)if(_0x1e790b=_0x2750df[_0xfeeb0d])_0x4f3a73=(_0x8a0e84<0x3?_0x1e790b(_0x4f3a73):_0x8a0e84>0x3?_0x1e790b(_0x1a0a11,_0x31ae25,_0x4f3a73):_0x1e790b(_0x1a0a11,_0x31ae25))||_0x4f3a73;}return _0x8a0e84>0x3&&_0x4f3a73&&Object['defineProperty'](_0x1a0a11,_0x31ae25,_0x4f3a73),_0x4f3a73;},__metadata=this&&this[_0xbabf12(0xb9)]||function(_0x261bfa,_0x212b80){const _0x2d2257=_0xbabf12;if(typeof Reflect===_0x2d2257(0xdc)&&typeof Reflect['metadata']==='function')return Reflect[_0x2d2257(0xa3)](_0x261bfa,_0x212b80);},__param=this&&this['__param']||function(_0x30f069,_0x19d152){return function(_0x2ca2e3,_0x31de73){_0x19d152(_0x2ca2e3,_0x31de73,_0x30f069);};};Object[_0xbabf12(0x133)](exports,_0xbabf12(0x98),{'value':!![]}),exports[_0xbabf12(0x185)]=void 0x0;const upload_service_1=require(_0xbabf12(0x197)),user_service_1=require('./../user/user.service'),nestjs_config_1=require(_0xbabf12(0x140)),common_1=require(_0xbabf12(0x124)),errorMessage_constant_1=require(_0xbabf12(0xec)),utils_1=require('../../common/utils'),axios_1=require(_0xbabf12(0xad)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require('../../common/constants/balance.constant'),chatLog_service_1=require(_0xbabf12(0xe8)),uuid=require('uuid'),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require(_0xbabf12(0xde)),typeorm_2=require(_0xbabf12(0x173)),badwords_service_1=require('../badwords/badwords.service'),autoreply_service_1=require('../autoreply/autoreply.service'),gptkeys_entity_1=require('./gptkeys.entity'),globalConfig_service_1=require(_0xbabf12(0xab)),fanyi_service_1=require(_0xbabf12(0xbb)),app_entity_1=require(_0xbabf12(0x13a)),chatGroup_service_1=require(_0xbabf12(0x17a)),models_service_1=require(_0xbabf12(0x134)),baidu_1=require(_0xbabf12(0x159)),helper_1=require(_0xbabf12(0x14a)),store_1=require(_0xbabf12(0x10b)),zhipu_1=require('./zhipu'),openai_1=require(_0xbabf12(0x10a)),chatBoxType_entity_1=require('./chatBoxType.entity'),chatBox_entity_1=require(_0xbabf12(0x149)),chatPre_entity_1=require(_0xbabf12(0x176)),chatPreType_entity_1=require(_0xbabf12(0x17b));function _0x114b(_0xb41e4,_0x46a450){const _0x26a8e5=_0x26a8();return _0x114b=function(_0x114b2f,_0x20236f){_0x114b2f=_0x114b2f-0x91;let _0x330b7c=_0x26a8e5[_0x114b2f];return _0x330b7c;},_0x114b(_0xb41e4,_0x46a450);}function _0x26a8(){const _0x415ac3=['chatPreEntity','Repository','detail','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','uploadService','systemMessage','env','./chatBox.entity','./helper','getUuid','status','usage','ConfigService','size','forEach','.png','delChatPre','chat','draw','FanyiService','AppEntity','用户ID:\x20','chatPreTypeEntity','./baidu','gpt-4-1106','400\x20error','AutoreplyService','chatSyncFree','1196742GpwiPc','delChatPreType','setChatPreType','deductFromBalance','assign','gpt-3','缺失必要参数！','getTokenCount','InjectRepository','appId','提供了错误的模型秘钥','quality','dall-e-3','decorate','saveChatLog','ChatBoxEntity','imageUrl','redis://','draw\x20paompt\x20info\x20<==**==>\x20','delete','appEntity','@nestjs/typeorm','weight','DESC','./chatPre.entity','HttpException','uploadFile','base64','../chatGroup/chatGroup.service','./chatPreType.entity','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','formatModelToken','checkBadWords','globalConfigService','15415JGKFAX','stringify','error','response','preset','ChatgptService','NineStore','Logger','userBalanceService','update','Content-type','userService','1106','chatgpt-ai-web','getUploadType','getMaxTokenFromModelWithOpenAi','ConfigEntity','chatGroupService','typeInfo','DeductionKey','from','dall-e\x20draw\x20params:\x20','getRequestParams','./../upload/upload.service','sendMessageFromOpenAi','当前请求已过载、请稍等会儿再试试吧！','code:\x20','push','gpt-4-vision-preview','abortController','getBaseConfig','ChatPreTypeEntity','__esModule','ceil','10nfxvxL','REDIS_PORT','mjDraw','Billing\x20hard\x20limit\x20has\x20been\x20reached',',\x20消耗积分：\x20','whiteListUser','prompt','openaiProxyUrl','maxModelTokens','metadata','post','openaiModel4MaxTokensRes','\x20模型名称:\x20','GptKeysEntity','4498417RexSaT','PAINT_TYPE','checkAutoReply','../globalConfig/globalConfig.service','chatBoxEntity','axios','getConfigs','getModelProxyUrl','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','Injectable','systemPreMessage','2078292FelvSw','3RYcXru','includes','fanyiService','chatBoxTypeEntity','importDynamic','__metadata','queryUserBalance','../fanyi/fanyi.service','write','config','queryChatBox','getCurrentModelKeyInfo','nineai-chatlog','BAD_REQUEST','getAllKeyList','54908AqMXFB','dall','CHAT_TYPE','nineStore','lockKey','GlobalConfigService','floor','openai-draw\x20error:\x20','autoreplyService','4544991YiXeep','setHeader','end','gpt-4','ChatLogService','非法操作！','compileNetwork','save','getOwnPropertyDescriptor','OpenAiErrorCodeMessage','sendMessageFromZhipu','modelInfo','count','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','Bearer\x20','default','object','openaiBaseUrl','typeorm','map','statusCode','function','UploadService','keyPool','chatProcess','coverImg','\x0a\x20Current\x20date:\x20','setChatBoxType','../chatLog/chatLog.service','filter','standard','typeId','../../common/constants/errorMessage.constant','message','user','36ARqIUV','https://api.openai.com','queryChatPreType','openaiModel3MaxTokens16kRes','onModuleInit','getClientIp','findOne','chat-error-detail\x20\x20<----------------------------------------->','queryChatBoxFrontend','unifiedFormattingResponse','checkUserStatus','372GgshQN','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','ModelsService','maxResponseTokens',',\x20消耗token:\x20','Please\x20check\x20the\x20back-end\x20console','__decorate','b64_json','slice','assistant','design:paramtypes','userBanance','8AuWbTE','openaiTimeoutMs','appInfo','Too\x20Many\x20Requests','./openai','./store','queryChatPreList','length','sendMessageFromBaidu','6289875xbGMIi','validateBalance','toLowerCase','statusText','addOneIfOdd','/v1/images/generations','badwordsService','getRandomDrawKey','HttpStatus','queryChatBoxType','openaiModel3MaxTokens16k','close','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','conversationId','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','key','gptKeysEntity','childList','Incorrect\x20API\x20key\x20provided','error:\x20','16k','@nestjs/common','data','modelsService','getGroupInfoFromId','saveUseLog','当前模型key已被封禁','chatLogService','chat-error\x20<----------------------------------------->','model','Catch\x20Error\x20','log','buildMessageFromParentMessageId','toISOString','@keyv/redis','绘制图片失败，请检查你的提示词是否有非法描述！','defineProperty','../models/models.service',',\x20key\x20===>\x20','model4','text','find','all','../app/app.entity','当前分类下有未处理数据不可移除！','服务异常、请重新试试吧！！！','openaiModel4MaxTokens','32k','split','nestjs-config'];_0x26a8=function(){return _0x415ac3;};return _0x26a8();}let ChatgptService=class ChatgptService{constructor(_0x24e90e,_0x4fbac3,_0x3f46f4,_0xe1c7ca,_0x50c6a5,_0x211202,_0x28ee87,_0x259eed,_0x91e733,_0x5eef52,_0x40b3fc,_0x401653,_0x2ed438,_0x5baf2c,_0x472eff,_0x43b74d,_0x170c5c,_0x4b4b68){const _0x574867=_0xbabf12;this['gptKeysEntity']=_0x24e90e,this['configEntity']=_0x4fbac3,this['chatBoxTypeEntity']=_0x3f46f4,this[_0x574867(0xac)]=_0xe1c7ca,this[_0x574867(0x172)]=_0x50c6a5,this[_0x574867(0x158)]=_0x211202,this[_0x574867(0x141)]=_0x28ee87,this['configService']=_0x259eed,this[_0x574867(0x188)]=_0x91e733,this[_0x574867(0x12a)]=_0x5eef52,this[_0x574867(0x18b)]=_0x40b3fc,this['uploadService']=_0x401653,this[_0x574867(0x115)]=_0x2ed438,this[_0x574867(0xcb)]=_0x5baf2c,this[_0x574867(0x17f)]=_0x472eff,this[_0x574867(0xb6)]=_0x43b74d,this[_0x574867(0x191)]=_0x170c5c,this[_0x574867(0x126)]=_0x4b4b68,this['nineStore']=null,this[_0x574867(0x9f)]=[],this[_0x574867(0xe3)]={'list3':[],'list4':[]};}async[_0xbabf12(0xf3)](){const _0x8c2ad2=_0xbabf12;let _0x5854e2=await(0x0,utils_1[_0x8c2ad2(0xb8)])(_0x8c2ad2(0x18d)),_0x4a6a0d=await(0x0,utils_1[_0x8c2ad2(0xb8)])(_0x8c2ad2(0x131)),_0x186bc4=await(0x0,utils_1[_0x8c2ad2(0xb8)])('keyv');_0x5854e2=(_0x5854e2===null||_0x5854e2===void 0x0?void 0x0:_0x5854e2[_0x8c2ad2(0xdb)])?_0x5854e2[_0x8c2ad2(0xdb)]:_0x5854e2,_0x4a6a0d=(_0x4a6a0d===null||_0x4a6a0d===void 0x0?void 0x0:_0x4a6a0d['default'])?_0x4a6a0d[_0x8c2ad2(0xdb)]:_0x4a6a0d,_0x186bc4=(_0x186bc4===null||_0x186bc4===void 0x0?void 0x0:_0x186bc4[_0x8c2ad2(0xdb)])?_0x186bc4['default']:_0x186bc4;const {ChatGPTAPI:_0x1b698c,ChatGPTError:_0x2f32e8,ChatGPTUnofficialProxyAPI:_0x20badb}=_0x5854e2,_0x16464f=+process[_0x8c2ad2(0x148)][_0x8c2ad2(0x9b)],_0x171107=process[_0x8c2ad2(0x148)]['REDIS_HOST'],_0x2c60c0=process[_0x8c2ad2(0x148)]['REDIS_PASSWORD'],_0x2f2df3=process[_0x8c2ad2(0x148)]['REDIS_USER'],_0x31c84c=_0x8c2ad2(0x16f)+(_0x2f2df3||'')+':'+(_0x2c60c0||'')+'@'+_0x171107+':'+_0x16464f,_0x1f4089=new _0x4a6a0d(_0x31c84c),_0x37aff5=new _0x186bc4({'store':_0x1f4089,'namespace':_0x8c2ad2(0xc0)});this[_0x8c2ad2(0xc6)]=new store_1[(_0x8c2ad2(0x186))]({'store':_0x37aff5,'namespace':_0x8c2ad2(0x153)});}async[_0xbabf12(0x196)](_0x44ea90,_0xb42a91,_0x482e9a,_0x2cf554=null){const _0x323461=_0xbabf12;var _0x300f91;!_0x2cf554&&(_0x2cf554=(_0x300f91=await this[_0x323461(0x126)][_0x323461(0x96)]())===null||_0x300f91===void 0x0?void 0x0:_0x300f91[_0x323461(0xd7)]);const {timeout:timeout=0x3c}=_0x482e9a,{topN:_0x5b9750,model:_0x5ab337}=_0x2cf554,{parentMessageId:parentMessageId=0x0}=_0x44ea90,_0x44b4d7=await this[_0x323461(0x17f)][_0x323461(0xae)]([_0x323461(0x107)]),_0x31feb5=timeout*0x3e8||_0x44b4d7||0x64*0x3e8,_0x51fd4f={'parentMessageId':parentMessageId,'timeoutMs':+_0x31feb5,'completionParams':{'model':_0x5ab337,'temperature':_0x5b9750}};return _0xb42a91&&(_0x51fd4f[_0x323461(0x147)]=_0xb42a91),_0x51fd4f;}async[_0xbabf12(0x15d)](_0x2b25fe){const _0x4c898f=_0xbabf12,_0x4cc3eb=await this[_0x4c898f(0x126)]['getRandomDrawKey'](),_0x31092b=await this[_0x4c898f(0x17f)]['getConfigs']([_0x4c898f(0xb2)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0xf0b604,model:_0x35c4ec}=_0x4cc3eb,_0x3b5feb=await this[_0x4c898f(0xaf)](_0x4cc3eb),{context:_0x3415a0}=await this[_0x4c898f(0xc6)][_0x4c898f(0x12f)](_0x2b25fe,{'parentMessageId':'','systemMessage':_0x31092b});try{const _0x868275=await(0x0,openai_1[_0x4c898f(0x198)])(_0x3415a0,{'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0xf0b604),'model':_0x35c4ec,'proxyUrl':_0x3b5feb,'onProgress':null});return _0x868275===null||_0x868275===void 0x0?void 0x0:_0x868275[_0x4c898f(0x137)];}catch(_0x51fb04){console[_0x4c898f(0x12e)]('error:\x20',_0x51fb04);}}async[_0xbabf12(0xe4)](_0x37807e,_0x5718f6,_0x1cf941){const _0x3de756=_0xbabf12;var _0x1e398f,_0x11fa95,_0x36026b,_0x2e5a61;const _0x4e739d=_0x5718f6[_0x3de756(0x95)],{options:options={},appId:_0x5d0fcf,cusromPrompt:_0x34afc5,systemMessage:systemMessage=''}=_0x37807e;let _0x1271a6=systemMessage;const {parentMessageId:_0x51fa47}=options,{prompt:_0x550c7b,imageUrl:_0x4175b1,model:_0x13dd9e}=_0x37807e,{groupId:_0x206772,usingNetwork:_0x2c07c8}=options,_0xe499d7=await this[_0x3de756(0x191)][_0x3de756(0x127)](_0x206772),_0x2d03d3=(_0xe499d7===null||_0xe499d7===void 0x0?void 0x0:_0xe499d7[_0x3de756(0xbd)])?JSON['parse'](_0xe499d7[_0x3de756(0xbd)]):await this[_0x3de756(0x126)][_0x3de756(0x96)](),{keyType:_0xca807c,model:_0x5c369c,topN:_0x49f19f,systemMessage:_0x151890,rounds:_0x4ec054}=_0x2d03d3['modelInfo'];let _0x3917ca=null;!_0x34afc5?_0x3917ca=await this['modelsService']['getCurrentModelKeyInfo'](_0x5c369c):_0x3917ca=await this[_0x3de756(0x126)][_0x3de756(0x116)]();if(!_0x3917ca)throw new common_1['HttpException'](_0x3de756(0x11b),common_1['HttpStatus'][_0x3de756(0xc1)]);const {deduct:_0x167c35,isTokenBased:_0x4d86b5,tokenFeeRatio:_0x56d5c1,deductType:_0x1b618c,key:_0x3f4764,secret:_0x1a5878,modelName:_0x2cd0fc,id:_0xae79ed,accessToken:_0x4daccd}=_0x3917ca;await this['userService']['checkUserStatus'](_0x5718f6[_0x3de756(0xee)]),await this[_0x3de756(0x188)][_0x3de756(0x110)](_0x5718f6,_0x1b618c===0x1?'model3':_0x3de756(0x136),_0x167c35),_0x1cf941&&_0x1cf941[_0x3de756(0xcd)](_0x3de756(0x18a),'application/octet-stream;\x20charset=utf-8'),await this[_0x3de756(0x115)]['checkBadWords'](_0x550c7b,_0x5718f6[_0x3de756(0xee)]['id']);const _0x31ba41=await this['autoreplyService'][_0x3de756(0xaa)](_0x550c7b);if(_0x31ba41&&_0x1cf941){const _0x11447e={'message':_0x31ba41,'code':0x1f4};return _0x1cf941[_0x3de756(0xbc)](JSON['stringify'](_0x11447e)),_0x1cf941[_0x3de756(0xce)]();}if(_0x5d0fcf){const _0x355e12=await this[_0x3de756(0x172)][_0x3de756(0xf5)]({'where':{'id':_0x5d0fcf,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x355e12)throw new common_1[(_0x3de756(0x177))](_0x3de756(0x17c),common_1[_0x3de756(0x117)][_0x3de756(0xc1)]);_0x355e12['preset']&&(_0x1271a6=_0x355e12[_0x3de756(0x184)]);}else{if(_0x34afc5)_0x1271a6=systemMessage;else{if(_0x151890)_0x1271a6=_0x151890;else{const _0x44fb01=new Date()[_0x3de756(0x130)]()[_0x3de756(0x13f)]('T')[0x0],_0x170fe6=await this[_0x3de756(0x17f)][_0x3de756(0xae)]([_0x3de756(0xb2)]);_0x1271a6=_0x170fe6+(_0x3de756(0xe6)+_0x44fb01);}}}let _0x4e80a0='';if(_0x2c07c8){_0x4e80a0=await(0x0,utils_1[_0x3de756(0xd2)])(_0x550c7b);const _0x14eadc=new Date()[_0x3de756(0x130)]()[_0x3de756(0x13f)]('T')[0x0],_0x37d1f7=await this[_0x3de756(0x17f)][_0x3de756(0xae)]([_0x3de756(0xb2)]);_0x1271a6=_0x37d1f7+('\x0a\x20Current\x20date:\x20'+_0x14eadc);}const _0x58eaca=await this[_0x3de756(0x196)](options,_0x1271a6,_0x3917ca,_0x2d03d3[_0x3de756(0xd7)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x1866bd}=_0x3917ca;_0x1cf941&&_0x1cf941[_0x3de756(0x14c)](0xc8);let _0x1ed363=null,_0x4b0600=null;try{if(_0x1cf941){let _0x263dd3=null,_0xb959d=![];_0x1cf941['on'](_0x3de756(0x11a),async()=>{const _0x329d64=_0x3de756;if(_0xb959d)return;_0x4e739d['abort']();const _0x1fe399=await(0x0,openai_1[_0x329d64(0x165)])(_0x550c7b)||0x0,_0x1b682a=await(0x0,openai_1[_0x329d64(0x165)])(_0x263dd3===null||_0x263dd3===void 0x0?void 0x0:_0x263dd3['text'])||0x0,_0x5bb32a=_0x1fe399+_0x1b682a,_0x279921=(0x0,utils_1[_0x329d64(0xf4)])(_0x5718f6);await this['chatLogService'][_0x329d64(0x16c)]({'appId':_0x5d0fcf,'curIp':_0x279921,'userId':_0x5718f6[_0x329d64(0xee)]['id'],'type':balance_constant_1[_0x329d64(0x193)]['CHAT_TYPE'],'prompt':_0x550c7b,'imageUrl':_0x4175b1,'activeModel':_0x13dd9e,'answer':'','promptTokens':_0x1fe399,'completionTokens':0x0,'totalTokens':_0x1fe399,'model':_0x5c369c,'role':'user','groupId':_0x206772,'requestOptions':JSON[_0x329d64(0x181)]({'options':null,'prompt':_0x550c7b})}),await this[_0x329d64(0x12a)][_0x329d64(0x16c)]({'appId':_0x5d0fcf,'curIp':_0x279921,'userId':_0x5718f6[_0x329d64(0xee)]['id'],'type':balance_constant_1['DeductionKey'][_0x329d64(0xc5)],'prompt':_0x550c7b,'answer':_0x263dd3===null||_0x263dd3===void 0x0?void 0x0:_0x263dd3[_0x329d64(0x137)],'promptTokens':_0x1fe399,'completionTokens':_0x1b682a,'totalTokens':_0x5bb32a,'model':_0x5c369c,'role':_0x329d64(0x103),'groupId':_0x206772,'requestOptions':JSON['stringify']({'options':{'model':_0x5c369c,'temperature':_0x49f19f},'prompt':_0x550c7b}),'conversationOptions':JSON[_0x329d64(0x181)]({'conversationId':_0x263dd3===null||_0x263dd3===void 0x0?void 0x0:_0x263dd3[_0x329d64(0x11c)],'model':_0x5c369c,'parentMessageId':_0x263dd3===null||_0x263dd3===void 0x0?void 0x0:_0x263dd3['id'],'temperature':_0x49f19f})});let _0x3baf05=_0x167c35;_0x4d86b5===!![]&&(_0x3baf05=Math[_0x329d64(0x99)](_0x167c35*_0x5bb32a/_0x56d5c1)),await this[_0x329d64(0x188)][_0x329d64(0x161)](_0x5718f6[_0x329d64(0xee)]['id'],'model'+(_0x1b618c===0x1?0x3:0x4),_0x3baf05,_0x5bb32a);});if(Number(_0xca807c)===0x1){const {key:_0x3c217a,maxToken:_0x4ef3f4,maxTokenRes:_0x27f997,proxyResUrl:_0x1c948a}=await this[_0x3de756(0x17d)](_0x3917ca),{parentMessageId:_0x1dc25f,completionParams:_0x12b622,systemMessage:_0x3e5297}=_0x58eaca,{model:_0x12d520,temperature:_0x14527c}=_0x12b622,{context:_0x45c964}=await this[_0x3de756(0xc6)][_0x3de756(0x12f)](_0x2c07c8?_0x4e80a0:_0x550c7b,{'parentMessageId':_0x1dc25f,'systemMessage':_0x3e5297,'maxModelToken':_0x4ef3f4,'maxResponseTokens':_0x27f997,'maxRounds':(0x0,helper_1[_0x3de756(0x113)])(_0x4ec054),'imageUrl':_0x4175b1,'activeModel':_0x13dd9e});let _0x1bf7ff=!![];_0x1ed363=await(0x0,openai_1[_0x3de756(0x198)])(_0x45c964,{'maxToken':_0x4ef3f4,'maxTokenRes':_0x27f997,'apiKey':_0x3f4764,'model':_0x12d520,'prompt':_0x550c7b,'activeModel':_0x13dd9e,'imageUrl':_0x4175b1,'temperature':_0x14527c,'proxyUrl':_0x1c948a,'onProgress':_0x3add30=>{const _0x40710c=_0x3de756;_0x1cf941['write'](_0x1bf7ff?JSON[_0x40710c(0x181)](_0x3add30):'\x0a'+JSON[_0x40710c(0x181)](_0x3add30)),_0x263dd3=_0x3add30,_0x1bf7ff=![];}},this[_0x3de756(0x146)]),_0xb959d=!![];}if(Number(_0xca807c)===0x2){let _0x31967f=!![];const {context:_0x49bdce}=await this['nineStore'][_0x3de756(0x12f)](_0x2c07c8?_0x4e80a0:_0x550c7b,{'parentMessageId':_0x51fa47,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x4ec054)});_0x1ed363=await(0x0,baidu_1[_0x3de756(0x10e)])(_0x2c07c8?_0x4e80a0:_0x49bdce,{'temperature':_0x49f19f,'accessToken':_0x4daccd,'model':_0x5c369c,'onProgress':_0x5581de=>{const _0x16105e=_0x3de756;_0x1cf941[_0x16105e(0xbc)](_0x31967f?JSON[_0x16105e(0x181)](_0x5581de):'\x0a'+JSON['stringify'](_0x5581de)),_0x31967f=![],_0x263dd3=_0x5581de;}}),_0xb959d=!![];}if(Number(_0xca807c)===0x3){let _0x2a48b3=!![];const {context:_0x31e86e}=await this[_0x3de756(0xc6)][_0x3de756(0x12f)](_0x2c07c8?_0x4e80a0:_0x550c7b,{'parentMessageId':_0x51fa47,'maxRounds':(0x0,helper_1[_0x3de756(0x113)])(_0x4ec054)});_0x1ed363=await(0x0,zhipu_1[_0x3de756(0xd6)])(_0x2c07c8?_0x4e80a0:_0x31e86e,{'temperature':_0x49f19f,'key':_0x1866bd,'model':_0x5c369c,'onProgress':_0x40d483=>{const _0x3a9278=_0x3de756;_0x1cf941[_0x3a9278(0xbc)](_0x2a48b3?JSON[_0x3a9278(0x181)](_0x40d483):'\x0a'+JSON['stringify'](_0x40d483)),_0x2a48b3=![],_0x263dd3=_0x40d483;}}),_0xb959d=!![];}const _0x1a10fb={'id':this[_0x3de756(0xc6)][_0x3de756(0x14b)](),'text':_0x550c7b,'role':_0x3de756(0xee),'name':undefined,'usage':null,'imageUrl':_0x4175b1,'activeModel':_0x13dd9e,'parentMessageId':_0x51fa47,'conversationId':_0x1ed363===null||_0x1ed363===void 0x0?void 0x0:_0x1ed363['conversationId']};_0x4b0600={'model':_0x5c369c,'parentMessageId':_0x51fa47},await this[_0x3de756(0xc6)]['setData'](_0x1a10fb);const _0x185779={'id':_0x1ed363['id'],'text':_0x1ed363['text'],'role':_0x3de756(0x103),'name':undefined,'usage':_0x1ed363===null||_0x1ed363===void 0x0?void 0x0:_0x1ed363['usage'],'imageUrl':_0x4175b1,'parentMessageId':_0x1a10fb['id'],'conversationId':_0x1ed363===null||_0x1ed363===void 0x0?void 0x0:_0x1ed363[_0x3de756(0x11c)]};await this[_0x3de756(0xc6)]['setData'](_0x185779),_0x4b0600={'model':_0x5c369c,'parentMessageId':_0x1a10fb['id']};}else{const {key:_0x42d545,maxToken:_0x3bb90b,maxTokenRes:_0x2aeaa0,proxyResUrl:_0xde25f1}=await this[_0x3de756(0x17d)](_0x3917ca),{parentMessageId:_0x473610,completionParams:_0x1afae2,systemMessage:_0x34a706}=_0x58eaca,{model:_0x2e6d0a,temperature:_0x330931}=_0x1afae2,{context:_0x120504}=await this[_0x3de756(0xc6)][_0x3de756(0x12f)](_0x2c07c8?_0x4e80a0:_0x550c7b,{'parentMessageId':_0x473610,'systemMessage':_0x34a706,'maxRounds':(0x0,helper_1[_0x3de756(0x113)])(_0x4ec054)});_0x1ed363=await(0x0,openai_1[_0x3de756(0x198)])(_0x120504,{'apiKey':_0x3f4764,'model':_0x2e6d0a,'temperature':_0x330931,'proxyUrl':_0xde25f1,'onProgress':null,'prompt':_0x550c7b});}let _0x4e0828=null,_0x4b290d=null;_0x5c369c[_0x3de756(0xb5)](_0x3de756(0xc4))?_0x4e0828=((_0x1e398f=_0x1ed363[_0x3de756(0x143)])===null||_0x1e398f===void 0x0?void 0x0:_0x1e398f[_0x3de756(0x14d)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x4b290d=await(0x0,helper_1[_0x3de756(0xf8)])(_0xca807c,_0x1ed363,_0x4b0600);const {prompt_tokens:_0x4856bb,completion_tokens:_0x1f2bed,total_tokens:_0x3fcbba}=_0x5c369c['includes'](_0x3de756(0xc4))?_0x4e0828:_0x4b290d['usage'];let _0x2d239a=_0x167c35;_0x4d86b5===!![]&&(_0x2d239a=Math[_0x3de756(0x99)](_0x167c35*_0x3fcbba/_0x56d5c1));await this['userBalanceService']['deductFromBalance'](_0x5718f6['user']['id'],_0x3de756(0x12c)+(_0x1b618c===0x1?0x3:0x4),_0x2d239a,_0x3fcbba),await this[_0x3de756(0x126)][_0x3de756(0x128)](_0xae79ed,_0x3fcbba);const _0x769c3e=(0x0,utils_1[_0x3de756(0xf4)])(_0x5718f6);await this[_0x3de756(0x12a)][_0x3de756(0x16c)]({'appId':_0x5d0fcf,'curIp':_0x769c3e,'userId':_0x5718f6['user']['id'],'type':balance_constant_1[_0x3de756(0x193)][_0x3de756(0xc5)],'prompt':_0x550c7b,'imageUrl':_0x4175b1,'activeModel':_0x13dd9e,'answer':'','promptTokens':_0x4856bb,'completionTokens':0x0,'totalTokens':_0x3fcbba,'model':_0x5c369c,'role':'user','groupId':_0x206772,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x550c7b})}),await this[_0x3de756(0x12a)][_0x3de756(0x16c)]({'appId':_0x5d0fcf,'curIp':_0x769c3e,'userId':_0x5718f6[_0x3de756(0xee)]['id'],'type':balance_constant_1[_0x3de756(0x193)][_0x3de756(0xc5)],'prompt':_0x550c7b,'imageUrl':_0x1ed363===null||_0x1ed363===void 0x0?void 0x0:_0x1ed363[_0x3de756(0x16e)],'answer':_0x1ed363[_0x3de756(0x137)],'promptTokens':_0x4856bb,'completionTokens':_0x1f2bed,'totalTokens':_0x3fcbba,'model':_0x5c369c,'role':_0x3de756(0x103),'groupId':_0x206772,'requestOptions':JSON[_0x3de756(0x181)]({'options':{'model':_0x5c369c,'temperature':_0x49f19f},'prompt':_0x550c7b}),'conversationOptions':JSON['stringify']({'conversationId':_0x1ed363[_0x3de756(0x11c)],'model':_0x5c369c,'parentMessageId':_0x1ed363['id'],'temperature':_0x49f19f})}),common_1[_0x3de756(0x187)]['debug'](_0x3de756(0x157)+_0x5718f6[_0x3de756(0xee)]['id']+_0x3de756(0xa6)+_0x2cd0fc+'-'+_0x13dd9e+_0x3de756(0xfe)+_0x3fcbba+_0x3de756(0x9e)+_0x2d239a,_0x3de756(0x185));const _0x21adc5=await this[_0x3de756(0x188)][_0x3de756(0xba)](_0x5718f6['user']['id']);return _0x1ed363[_0x3de756(0x105)]=Object[_0x3de756(0x162)]({},_0x21adc5),_0x1ed363['result']&&(_0x1ed363['result']=''),_0x1ed363['is_end']=!![],_0x1cf941?_0x1cf941[_0x3de756(0xbc)]('\x0a'+JSON[_0x3de756(0x181)](_0x1ed363)):_0x1ed363[_0x3de756(0x137)];}catch(_0x4af08a){console['log'](_0x3de756(0x12b),_0x3f4764,_0x4af08a);const _0x421d23=(_0x4af08a===null||_0x4af08a===void 0x0?void 0x0:_0x4af08a[_0x3de756(0xe0)])||0x190,_0x15d291=((_0x11fa95=_0x4af08a===null||_0x4af08a===void 0x0?void 0x0:_0x4af08a['response'])===null||_0x11fa95===void 0x0?void 0x0:_0x11fa95['status'])||(_0x4af08a===null||_0x4af08a===void 0x0?void 0x0:_0x4af08a[_0x3de756(0xe0)])||0x190;console[_0x3de756(0x12e)](_0x3de756(0xf6),_0x3de756(0x92),_0x421d23,_0x3de756(0xed),_0x4af08a===null||_0x4af08a===void 0x0?void 0x0:_0x4af08a[_0x3de756(0xed)],'statusText:',(_0x36026b=_0x4af08a===null||_0x4af08a===void 0x0?void 0x0:_0x4af08a[_0x3de756(0x183)])===null||_0x36026b===void 0x0?void 0x0:_0x36026b[_0x3de756(0x112)],'status',(_0x2e5a61=_0x4af08a===null||_0x4af08a===void 0x0?void 0x0:_0x4af08a[_0x3de756(0x183)])===null||_0x2e5a61===void 0x0?void 0x0:_0x2e5a61[_0x3de756(0x14c)]);if(_0x4af08a[_0x3de756(0x14c)]&&_0x4af08a[_0x3de756(0x14c)]===0x192){const _0x4a7813={'message':_0x3de756(0x12d)+_0x4af08a[_0x3de756(0xed)],'code':0x192};if(_0x1cf941)return _0x1cf941[_0x3de756(0xbc)](JSON[_0x3de756(0x181)](_0x4a7813));else throw new common_1[(_0x3de756(0x177))](_0x4af08a['message'],common_1[_0x3de756(0x117)]['PAYMENT_REQUIRED']);}if(!_0x15d291){if(_0x1cf941)return _0x1cf941[_0x3de756(0xbc)](JSON[_0x3de756(0x181)]({'message':_0x4af08a[_0x3de756(0xed)],'code':0x1f4}));else throw new common_1['HttpException'](_0x4af08a[_0x3de756(0xed)],common_1['HttpStatus'][_0x3de756(0xc1)]);}let _0x98aa65=errorMessage_constant_1[_0x3de756(0xd5)][_0x15d291]?errorMessage_constant_1[_0x3de756(0xd5)][_0x15d291]:_0x3de756(0x13c);(_0x4af08a===null||_0x4af08a===void 0x0?void 0x0:_0x4af08a[_0x3de756(0xed)][_0x3de756(0xb5)](_0x3de756(0xb0)))&&Number(_0xca807c)===0x1&&(await this[_0x3de756(0x126)][_0x3de756(0xc7)](_0xae79ed,_0x3de756(0xfb),-0x1),_0x98aa65=_0x3de756(0x129));(_0x4af08a===null||_0x4af08a===void 0x0?void 0x0:_0x4af08a[_0x3de756(0xe0)])===0x1ad&&_0x4af08a['message'][_0x3de756(0xb5)]('billing')&&Number(_0xca807c)===0x1&&(await this[_0x3de756(0x126)][_0x3de756(0xc7)](_0xae79ed,_0x3de756(0x11d),-0x3),_0x98aa65='当前模型key余额已耗尽');(_0x4af08a===null||_0x4af08a===void 0x0?void 0x0:_0x4af08a[_0x3de756(0xe0)])===0x1ad&&(_0x4af08a===null||_0x4af08a===void 0x0?void 0x0:_0x4af08a['statusText'])===_0x3de756(0x109)&&(_0x98aa65='当前模型调用过于频繁、请重新试试吧！');(_0x4af08a===null||_0x4af08a===void 0x0?void 0x0:_0x4af08a[_0x3de756(0xe0)])===0x191&&_0x4af08a['message'][_0x3de756(0xb5)](_0x3de756(0x121))&&Number(_0xca807c)===0x1&&(await this[_0x3de756(0x126)][_0x3de756(0xc7)](_0xae79ed,_0x3de756(0x168),-0x2),_0x98aa65=_0x3de756(0x145));(_0x4af08a===null||_0x4af08a===void 0x0?void 0x0:_0x4af08a['statusCode'])===0x194&&_0x4af08a[_0x3de756(0xed)]['includes'](_0x3de756(0xd9))&&Number(_0xca807c)===0x1&&(await this[_0x3de756(0x126)][_0x3de756(0xc7)](_0xae79ed,'当前模型不是聊天模型',-0x4),_0x98aa65=_0x3de756(0x144));_0x421d23===0x190&&console[_0x3de756(0x12e)](_0x3de756(0x15b),_0x4af08a,_0x4af08a[_0x3de756(0xed)]);const _0x17da49={'message':_0x98aa65||_0x3de756(0xff),'code':_0x421d23===0x191?0x190:_0x421d23||0x1f4};if(_0x1cf941)return _0x1cf941[_0x3de756(0xbc)](JSON[_0x3de756(0x181)](_0x17da49));else throw new common_1[(_0x3de756(0x177))](_0x17da49[_0x3de756(0xed)],common_1[_0x3de756(0x117)][_0x3de756(0xc1)]);}finally{_0x1cf941&&_0x1cf941[_0x3de756(0xce)]();}}async[_0xbabf12(0x154)](_0x1e85e9,_0x2a867c){const _0x5e9186=_0xbabf12;var _0xd0697e,_0x56c2d2,_0x52dc2d,_0x4c8909;await this['badwordsService'][_0x5e9186(0x17e)](_0x1e85e9[_0x5e9186(0xa0)],_0x2a867c['user']['id']),await this[_0x5e9186(0x18b)][_0x5e9186(0xf9)](_0x2a867c['user']);const _0x555c8f=(_0x1e85e9===null||_0x1e85e9===void 0x0?void 0x0:_0x1e85e9[_0x5e9186(0x169)])==='hd'?0x4:0x2;await this[_0x5e9186(0x188)]['validateBalance'](_0x2a867c,_0x5e9186(0x9c),_0x555c8f);let _0x5be4f9=[];const _0x25bf56=await this[_0x5e9186(0x126)][_0x5e9186(0xbf)](_0x5e9186(0x16a)),_0x1723bc=_0x25bf56===null||_0x25bf56===void 0x0?void 0x0:_0x25bf56['id'],{key:_0x279e48,proxyResUrl:_0x4fe515}=await this['formatModelToken'](_0x25bf56);common_1[_0x5e9186(0x187)][_0x5e9186(0x12e)](_0x5e9186(0x170)+_0x1e85e9[_0x5e9186(0xa0)]+_0x5e9186(0x135)+_0x279e48,'DrawService');try{const _0x57f123=_0x4fe515+_0x5e9186(0x114),_0x1722b6=Object[_0x5e9186(0x162)](Object[_0x5e9186(0x162)]({},_0x1e85e9),{'model':_0x5e9186(0x16a)});console[_0x5e9186(0x12e)](_0x5e9186(0x195),_0x1722b6);const _0x38d961=await axios_1['default'][_0x5e9186(0xa4)](_0x57f123,Object[_0x5e9186(0x162)](Object[_0x5e9186(0x162)]({},_0x1722b6),{'response_format':_0x5e9186(0x101)}),{'headers':{'Authorization':_0x5e9186(0xda)+_0x279e48}});_0x5be4f9=_0x38d961[_0x5e9186(0x125)][_0x5e9186(0x125)];const _0x319801=[];for(const _0x3bc167 of _0x5be4f9){const _0x5832c4=uuid['v4']()[_0x5e9186(0x102)](0x0,0xa)+_0x5e9186(0x151),_0x34d08f=Buffer[_0x5e9186(0x194)](_0x3bc167['b64_json'],_0x5e9186(0x179));_0x319801['push'](this['uploadService'][_0x5e9186(0x178)]({'filename':_0x5832c4,'buffer':_0x34d08f}));}const _0x48a7eb=await Promise[_0x5e9186(0x139)](_0x319801);await this[_0x5e9186(0x188)][_0x5e9186(0x161)](_0x2a867c[_0x5e9186(0xee)]['id'],_0x5e9186(0x9c),(_0x1722b6===null||_0x1722b6===void 0x0?void 0x0:_0x1722b6[_0x5e9186(0x169)])===_0x5e9186(0xea)?0x2:0x4,_0x555c8f);const _0x48974f=(0x0,utils_1[_0x5e9186(0xf4)])(_0x2a867c),_0x1af36c=[],_0x4663c9=await this[_0x5e9186(0x146)][_0x5e9186(0x18e)](),[_0x1812ef,_0x23df3e]=_0x1e85e9[_0x5e9186(0x14f)][_0x5e9186(0x13f)]('x');return _0x48a7eb['forEach'](_0x5afc01=>{const _0x52343c=_0x5e9186;_0x1af36c[_0x52343c(0x93)](this[_0x52343c(0x12a)][_0x52343c(0x16c)]({'curIp':_0x48974f,'userId':_0x2a867c[_0x52343c(0xee)]['id'],'type':balance_constant_1[_0x52343c(0x193)][_0x52343c(0xa9)],'prompt':_0x1e85e9[_0x52343c(0xa0)],'answer':_0x5afc01,'fileInfo':JSON[_0x52343c(0x181)]({'cosType':_0x4663c9,'width':_0x1812ef,'height':_0x23df3e,'cosUrl':_0x5afc01}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x52343c(0x16a)}));}),await Promise[_0x5e9186(0x139)](_0x1af36c),_0x48a7eb;}catch(_0x50dcc8){const _0x447f0f=((_0xd0697e=_0x50dcc8===null||_0x50dcc8===void 0x0?void 0x0:_0x50dcc8['response'])===null||_0xd0697e===void 0x0?void 0x0:_0xd0697e[_0x5e9186(0x14c)])||0x1f4;console[_0x5e9186(0x12e)](_0x5e9186(0xca),JSON['stringify'](_0x50dcc8),_0x279e48,_0x447f0f);const _0x344494=(_0x4c8909=(_0x52dc2d=(_0x56c2d2=_0x50dcc8===null||_0x50dcc8===void 0x0?void 0x0:_0x50dcc8['response'])===null||_0x56c2d2===void 0x0?void 0x0:_0x56c2d2[_0x5e9186(0x125)])===null||_0x52dc2d===void 0x0?void 0x0:_0x52dc2d[_0x5e9186(0x182)])===null||_0x4c8909===void 0x0?void 0x0:_0x4c8909[_0x5e9186(0xed)];if(_0x447f0f===0x1ad)throw new common_1['HttpException'](_0x5e9186(0x91),common_1[_0x5e9186(0x117)][_0x5e9186(0xc1)]);if(_0x447f0f===0x190&&_0x344494[_0x5e9186(0xb5)]('This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters'))throw new common_1[(_0x5e9186(0x177))]('您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',common_1[_0x5e9186(0x117)][_0x5e9186(0xc1)]);if(_0x447f0f===0x190&&_0x344494[_0x5e9186(0xb5)](_0x5e9186(0x9d))){await this[_0x5e9186(0x126)][_0x5e9186(0xc7)](_0x1723bc,_0x5e9186(0xfb),-0x1);throw new common_1[(_0x5e9186(0x177))]('当前Key余额已不足、请重新再试一次吧！',common_1['HttpStatus']['BAD_REQUEST']);}if(_0x447f0f===0x1f4)throw new common_1[(_0x5e9186(0x177))](_0x5e9186(0x132),common_1[_0x5e9186(0x117)][_0x5e9186(0xc1)]);if(_0x447f0f===0x191)throw new common_1['HttpException']('绘制图片失败，此次绘画被拒绝了！',common_1[_0x5e9186(0x117)][_0x5e9186(0xc1)]);throw new common_1['HttpException']('绘制图片失败，请稍后试试吧！',common_1['HttpStatus']['BAD_REQUEST']);}}async[_0xbabf12(0xc2)](){const _0xbb469f=_0xbabf12,_0x3025d2=await this[_0xbb469f(0x11f)][_0xbb469f(0x138)]({'where':{'status':0x1},'select':['id',_0xbb469f(0x11e),_0xbb469f(0x174),_0xbb469f(0x12c),_0xbb469f(0xa2),_0xbb469f(0xfd),_0xbb469f(0xa1),'openaiTimeoutMs']}),_0x5d688e=_0x3025d2[_0xbb469f(0xe9)](_0x231fcf=>_0x231fcf[_0xbb469f(0x12c)][_0xbb469f(0xb5)](_0xbb469f(0x163))),_0x4b0efd=_0x3025d2[_0xbb469f(0xe9)](_0x286b5c=>_0x286b5c['model'][_0xbb469f(0xb5)](_0xbb469f(0xcf)));this[_0xbb469f(0xe3)]={'list3':_0x5d688e,'list4':_0x4b0efd};}async['getModelProxyUrl'](_0x2e41fa){const _0x3fe3e3=_0xbabf12,_0x660c5f=await this['globalConfigService']['getConfigs']([_0x3fe3e3(0xdd)]);return(_0x2e41fa===null||_0x2e41fa===void 0x0?void 0x0:_0x2e41fa['proxyUrl'])||_0x660c5f||_0x3fe3e3(0xf0);}async[_0xbabf12(0x17d)](_0x26f5e6){const _0x42cf51=_0xbabf12,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x42cf51(0x17f)][_0x42cf51(0xae)](['openaiModel3MaxTokens','openaiModel3MaxTokensRes',_0x42cf51(0x119),_0x42cf51(0xf2),_0x42cf51(0x13d),_0x42cf51(0xa5),'openaiModel4MaxTokens32k','openaiModel4MaxTokens32kRes',_0x42cf51(0xdd)]);let _0x583b75=null,_0x5b069a=null,_0x40dec9=null,{model:_0x3badc4,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x5b4055}=_0x26f5e6;return _0x3badc4['toLowerCase']()[_0x42cf51(0xb5)](_0x42cf51(0xcf))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x5b069a>=0x1000&&(maxModelTokens=0x1000),_0x583b75=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x5b069a=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x3badc4[_0x42cf51(0x111)]()['includes'](_0x42cf51(0x13e))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x5b069a>=0x4000&&(maxModelTokens=0x4000),_0x583b75=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x5b069a=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x3badc4[_0x42cf51(0x111)]()[_0x42cf51(0xb5)](_0x42cf51(0x18c))&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x5b069a>=0x1000&&(maxModelTokens=0x1000),_0x583b75=maxModelTokens||0x3ffc,_0x5b069a=maxResponseTokens||0x1000)),_0x3badc4[_0x42cf51(0x111)]()[_0x42cf51(0xb5)]('gpt-3')&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x5b069a>=0x7d0&&(maxModelTokens=0x7d0),_0x583b75=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x5b069a=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x3badc4[_0x42cf51(0x111)]()['includes'](_0x42cf51(0x123))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x5b069a>=0x2000&&(maxModelTokens=0x2000),_0x583b75=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x5b069a=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x3badc4[_0x42cf51(0x111)]()['includes'](_0x42cf51(0x18c))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x5b069a>=0x1000&&(maxModelTokens=0x1000),_0x583b75=maxModelTokens||0x4000,_0x5b069a=maxResponseTokens||0x1000)),_0x40dec9=proxyUrl||openaiBaseUrl||_0x42cf51(0xf0),_0x5b069a>=_0x583b75&&(_0x5b069a=Math[_0x42cf51(0xc9)](_0x583b75/0x2)),{'key':_0x5b4055,'maxToken':_0x583b75,'maxTokenRes':_0x5b069a,'proxyResUrl':_0x40dec9};}async[_0xbabf12(0xe7)](_0x475224,_0x554f91){const _0x4f510e=_0xbabf12;try{const {name:_0x2d9c82,icon:_0x4632c2,order:_0x5e27ff,id:_0x38aec0,status:_0x530720}=_0x554f91;return _0x38aec0?await this[_0x4f510e(0xb7)][_0x4f510e(0x189)]({'id':_0x38aec0},{'name':_0x2d9c82,'icon':_0x4632c2,'order':_0x5e27ff,'status':_0x530720}):await this[_0x4f510e(0xb7)][_0x4f510e(0xd3)]({'name':_0x2d9c82,'icon':_0x4632c2,'order':_0x5e27ff,'status':_0x530720});}catch(_0x215149){console[_0x4f510e(0x12e)](_0x4f510e(0x122),_0x215149);}}async['delChatBoxType'](_0x5684f0,_0x3e688e){const _0x595afa=_0xbabf12,{id:_0x340a90}=_0x3e688e;if(!_0x340a90)throw new common_1[(_0x595afa(0x177))](_0x595afa(0xd1),common_1['HttpStatus'][_0x595afa(0xc1)]);const _0x20302c=await this[_0x595afa(0xac)][_0x595afa(0xd8)]({'where':{'typeId':_0x340a90}});if(_0x20302c)throw new common_1['HttpException'](_0x595afa(0x13b),common_1[_0x595afa(0x117)][_0x595afa(0xc1)]);return await this[_0x595afa(0xb7)][_0x595afa(0x171)]({'id':_0x340a90});}async[_0xbabf12(0x118)](){const _0x3cd712=_0xbabf12;return await this[_0x3cd712(0xb7)]['find']({'order':{'order':_0x3cd712(0x175)}});}async['setChatBox'](_0x3e6fb3,_0x30f55c){const _0x5e32e6=_0xbabf12,{title:_0x3f1d9b,prompt:_0x570fae,appId:_0x502ce1,order:_0x1ec5b4,status:_0x4adbd5,typeId:_0x2e86cd,id:_0x1212f6,url:_0x32d02c}=_0x30f55c;if(!_0x2e86cd)throw new common_1['HttpException']('缺失必要参数！',common_1['HttpStatus']['BAD_REQUEST']);try{const _0x591339={'title':_0x3f1d9b,'order':_0x1ec5b4,'status':_0x4adbd5,'typeId':_0x2e86cd,'url':_0x32d02c};return _0x591339[_0x5e32e6(0x167)]=_0x502ce1||0x0,_0x591339[_0x5e32e6(0xa0)]=_0x570fae||'',_0x1212f6?await this[_0x5e32e6(0xac)]['update']({'id':_0x1212f6},_0x591339):await this[_0x5e32e6(0xac)][_0x5e32e6(0xd3)](_0x591339);}catch(_0x3e9764){console['log'](_0x5e32e6(0x122),_0x3e9764);}}async['delChatBox'](_0x59d2aa,_0x4de847){const _0x2332da=_0xbabf12,{id:_0x19d702}=_0x4de847;if(!_0x19d702)throw new common_1[(_0x2332da(0x177))](_0x2332da(0xd1),common_1[_0x2332da(0x117)][_0x2332da(0xc1)]);return await this['chatBoxEntity']['delete']({'id':_0x19d702});}async[_0xbabf12(0xbe)](){const _0x5a6e1c=_0xbabf12,_0x3df305=await this[_0x5a6e1c(0xac)][_0x5a6e1c(0x138)]({'order':{'order':_0x5a6e1c(0x175)}}),_0x45a64c=[...new Set(_0x3df305[_0x5a6e1c(0xdf)](_0xa4c591=>_0xa4c591[_0x5a6e1c(0xeb)]))],_0xf22630=[...new Set(_0x3df305['map'](_0x162bf4=>_0x162bf4['appId']))],_0x54a1b7=await this[_0x5a6e1c(0xb7)][_0x5a6e1c(0x138)]({'where':{'id':(0x0,typeorm_1['In'])(_0x45a64c)}}),_0x5da17d=await this['appEntity'][_0x5a6e1c(0x138)]({'where':{'id':(0x0,typeorm_1['In'])(_0xf22630)}});return _0x3df305[_0x5a6e1c(0xdf)](_0x48980b=>{const _0x2f7462=_0x5a6e1c,{typeId:_0x66081b,appId:_0x147bc0}=_0x48980b;return _0x48980b[_0x2f7462(0x192)]=_0x54a1b7[_0x2f7462(0x138)](_0x29fa59=>_0x29fa59['id']===_0x66081b),_0x48980b[_0x2f7462(0x108)]=_0x5da17d[_0x2f7462(0x138)](_0x30f279=>_0x30f279['id']===_0x147bc0),_0x48980b;});}async[_0xbabf12(0xf7)](){const _0x461266=_0xbabf12,_0x5adecf=await this[_0x461266(0xb7)][_0x461266(0x138)]({'order':{'order':_0x461266(0x175)},'where':{'status':!![]}}),_0x454cf0=await this['chatBoxEntity'][_0x461266(0x138)]({'where':{'status':!![]}}),_0x39ccce=[...new Set(_0x454cf0[_0x461266(0xdf)](_0x90232=>_0x90232[_0x461266(0x167)]))],_0x3ba6b4=await this['appEntity'][_0x461266(0x138)]({'where':{'id':(0x0,typeorm_1['In'])(_0x39ccce)}});return _0x454cf0[_0x461266(0x150)](_0x1ad4ac=>{const _0x57ff99=_0x461266,_0x34b626=_0x3ba6b4[_0x57ff99(0x138)](_0x518706=>_0x518706['id']===_0x1ad4ac['appId']);return _0x1ad4ac[_0x57ff99(0xe5)]=_0x34b626===null||_0x34b626===void 0x0?void 0x0:_0x34b626['coverImg'],_0x1ad4ac;}),_0x5adecf[_0x461266(0xdf)](_0x39956c=>{const _0x47f2d2=_0x461266;return _0x39956c[_0x47f2d2(0x120)]=_0x454cf0['filter'](_0x4b820c=>_0x4b820c[_0x47f2d2(0xeb)]===_0x39956c['id']&&_0x4b820c[_0x47f2d2(0x14c)]),_0x39956c;});}async[_0xbabf12(0x160)](_0x143862,_0x50151e){const _0x104450=_0xbabf12;try{const {name:_0x1306a4,icon:_0x2ad0bd,order:_0x1e81cc,id:_0x142ce1,status:_0x302bab}=_0x50151e;return _0x142ce1?await this[_0x104450(0x158)][_0x104450(0x189)]({'id':_0x142ce1},{'name':_0x1306a4,'icon':_0x2ad0bd,'order':_0x1e81cc,'status':_0x302bab}):await this[_0x104450(0x158)][_0x104450(0xd3)]({'name':_0x1306a4,'icon':_0x2ad0bd,'order':_0x1e81cc,'status':_0x302bab});}catch(_0x310399){console[_0x104450(0x12e)](_0x104450(0x122),_0x310399);}}async[_0xbabf12(0x15f)](_0x1701ff,_0x161fe6){const _0x5b4bd3=_0xbabf12,{id:_0x4a5ee9}=_0x161fe6;if(!_0x4a5ee9)throw new common_1[(_0x5b4bd3(0x177))](_0x5b4bd3(0xd1),common_1[_0x5b4bd3(0x117)][_0x5b4bd3(0xc1)]);const _0x42be8a=await this[_0x5b4bd3(0xac)][_0x5b4bd3(0xd8)]({'where':{'typeId':_0x4a5ee9}});if(_0x42be8a)throw new common_1[(_0x5b4bd3(0x177))]('当前分类下有未处理数据不可移除！',common_1['HttpStatus'][_0x5b4bd3(0xc1)]);return await this[_0x5b4bd3(0x158)][_0x5b4bd3(0x171)]({'id':_0x4a5ee9});}async[_0xbabf12(0xf1)](){const _0x54ed07=_0xbabf12;return await this[_0x54ed07(0x158)][_0x54ed07(0x138)]({'order':{'order':'DESC'}});}async['setChatPre'](_0x1a1dbe,_0x577c96){const _0x31b3cd=_0xbabf12,{title:_0x2ab40c,prompt:_0x25e272,appId:_0x1d49e4,order:_0x462e16,status:_0x459fde,typeId:_0x150cac,id:_0x6c159f,url:_0x594d7a}=_0x577c96;if(!_0x150cac)throw new common_1[(_0x31b3cd(0x177))](_0x31b3cd(0x164),common_1[_0x31b3cd(0x117)]['BAD_REQUEST']);try{const _0xfd5d8f={'title':_0x2ab40c,'prompt':_0x25e272,'order':_0x462e16,'status':_0x459fde,'typeId':_0x150cac,'url':_0x594d7a};return _0x6c159f?await this[_0x31b3cd(0x141)][_0x31b3cd(0x189)]({'id':_0x6c159f},_0xfd5d8f):await this[_0x31b3cd(0x141)][_0x31b3cd(0xd3)](_0xfd5d8f);}catch(_0x280dc5){console[_0x31b3cd(0x12e)](_0x31b3cd(0x122),_0x280dc5);}}async[_0xbabf12(0x152)](_0xb2bf45,_0x2378af){const _0xece85a=_0xbabf12,{id:_0x5c622f}=_0x2378af;if(!_0x5c622f)throw new common_1[(_0xece85a(0x177))](_0xece85a(0xd1),common_1[_0xece85a(0x117)][_0xece85a(0xc1)]);return await this[_0xece85a(0x141)]['delete']({'id':_0x5c622f});}async['queryChatPre'](){const _0x1072e1=_0xbabf12,_0x1971a0=await this[_0x1072e1(0x141)]['find']({'order':{'order':_0x1072e1(0x175)}}),_0x24762c=[...new Set(_0x1971a0['map'](_0x184cf6=>_0x184cf6[_0x1072e1(0xeb)]))],_0x2f67b4=await this[_0x1072e1(0x158)][_0x1072e1(0x138)]({'where':{'id':(0x0,typeorm_1['In'])(_0x24762c)}});return _0x1971a0[_0x1072e1(0xdf)](_0xeb585a=>{const _0x54f502=_0x1072e1,{typeId:_0xd5712e,appId:_0x3710a7}=_0xeb585a;return _0xeb585a['typeInfo']=_0x2f67b4[_0x54f502(0x138)](_0x1f4c6f=>_0x1f4c6f['id']===_0xd5712e),_0xeb585a;});}async[_0xbabf12(0x10c)](){const _0x5414d8=_0xbabf12,_0x5a2335=await this[_0x5414d8(0x158)]['find']({'order':{'order':_0x5414d8(0x175)},'where':{'status':!![]}}),_0x252e68=await this['chatPreEntity']['find']({'where':{'status':!![]}});return _0x5a2335[_0x5414d8(0xdf)](_0xd27330=>{const _0x1fcdca=_0x5414d8;return _0xd27330[_0x1fcdca(0x120)]=_0x252e68[_0x1fcdca(0xe9)](_0x4b2ea4=>_0x4b2ea4['typeId']===_0xd27330['id']&&_0x4b2ea4[_0x1fcdca(0x14c)]),_0xd27330;});}async[_0xbabf12(0x18f)](_0x2c8ad6,_0x59cfa0,_0x3ac12){const _0x3a479d=_0xbabf12;let _0x20e5c8=0x1000,_0x13f5d0=0x800;return _0x2c8ad6[_0x3a479d(0x111)]()[_0x3a479d(0xb5)](_0x3a479d(0xcf))&&(_0x20e5c8=_0x59cfa0>=0x2004?0x2004:_0x59cfa0,_0x13f5d0=_0x3ac12>=0x1000?0x1000:_0x3ac12,_0x2c8ad6[_0x3a479d(0x111)]()['includes']('32k')&&(_0x20e5c8=_0x59cfa0>=0x8000?0x8000:_0x59cfa0,_0x13f5d0=_0x3ac12>=0x3e80?0x3e80:_0x3ac12),(_0x2c8ad6[_0x3a479d(0x111)]()[_0x3a479d(0xb5)](_0x3a479d(0x15a))||_0x2c8ad6[_0x3a479d(0x111)]()['includes'](_0x3a479d(0x94)))&&(_0x20e5c8=_0x59cfa0>=0x1f400?0x1f400:_0x59cfa0,_0x13f5d0=_0x3ac12>=0x1000?0x1000:_0x3ac12)),_0x2c8ad6['toLowerCase']()[_0x3a479d(0xb5)](_0x3a479d(0x163))&&(_0x20e5c8=_0x59cfa0>=0x1000?0x1000:_0x59cfa0,_0x13f5d0=_0x3ac12>=0x800?0x800:_0x3ac12,_0x2c8ad6[_0x3a479d(0x111)]()[_0x3a479d(0xb5)](_0x3a479d(0x123))&&(_0x20e5c8=_0x59cfa0>=0x4000?0x4000:_0x59cfa0,_0x13f5d0=_0x3ac12>=0x1f40?0x1f40:_0x3ac12),_0x2c8ad6[_0x3a479d(0x111)]()[_0x3a479d(0xb5)]('1106')&&(_0x20e5c8=_0x59cfa0>=0x4000?0x4000:_0x59cfa0,_0x13f5d0=_0x3ac12>=0x1f40?0x1f40:_0x3ac12)),{'maxToken':_0x20e5c8,'maxRes':_0x13f5d0};}};ChatgptService=__decorate([(0x0,common_1[_0xbabf12(0xb1)])(),__param(0x0,(0x0,typeorm_2[_0xbabf12(0x166)])(gptkeys_entity_1[_0xbabf12(0xa7)])),__param(0x1,(0x0,typeorm_2[_0xbabf12(0x166)])(config_entity_1[_0xbabf12(0x190)])),__param(0x2,(0x0,typeorm_2[_0xbabf12(0x166)])(chatBoxType_entity_1['ChatBoxTypeEntity'])),__param(0x3,(0x0,typeorm_2[_0xbabf12(0x166)])(chatBox_entity_1[_0xbabf12(0x16d)])),__param(0x4,(0x0,typeorm_2[_0xbabf12(0x166)])(app_entity_1[_0xbabf12(0x156)])),__param(0x5,(0x0,typeorm_2[_0xbabf12(0x166)])(chatPreType_entity_1[_0xbabf12(0x97)])),__param(0x6,(0x0,typeorm_2[_0xbabf12(0x166)])(chatPre_entity_1['ChatPreEntity'])),__metadata(_0xbabf12(0x104),[typeorm_1[_0xbabf12(0x142)],typeorm_1['Repository'],typeorm_1[_0xbabf12(0x142)],typeorm_1[_0xbabf12(0x142)],typeorm_1[_0xbabf12(0x142)],typeorm_1['Repository'],typeorm_1[_0xbabf12(0x142)],nestjs_config_1[_0xbabf12(0x14e)],userBalance_service_1['UserBalanceService'],chatLog_service_1[_0xbabf12(0xd0)],user_service_1['UserService'],upload_service_1[_0xbabf12(0xe2)],badwords_service_1['BadwordsService'],autoreply_service_1[_0xbabf12(0x15c)],globalConfig_service_1[_0xbabf12(0xc8)],fanyi_service_1[_0xbabf12(0x155)],chatGroup_service_1['ChatGroupService'],models_service_1[_0xbabf12(0xfc)]])],ChatgptService),exports[_0xbabf12(0x185)]=ChatgptService;