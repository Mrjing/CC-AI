'use strict';function _0x1285(){const _0x3504cb=['@keyv/redis','filter','configService','config','../../common/constants/balance.constant','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','gpt-3','assign','removeSpecialCharacters','env','getGroupInfoFromId','lockKey','UserBalanceService','非法操作！','buildMessageFromParentMessageId','queryChatBoxType','systemPreMessage','function','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','../chatLog/chatLog.service','用户ID:\x20','50KgCGFI','queryChatBoxFrontend','end','nestjs-config','dall','getOwnPropertyDescriptor','getBaseConfig','badwordsService','chatgpt-ai-web','size','ChatBoxTypeEntity','delete','checkBadWords','delChatPreType','PAINT_TYPE','uploadService','queryChatPreType','openaiModel3MaxTokensRes','maxResponseTokens','绘制图片失败，此次绘画被拒绝了！','gpt-4-vision-preview','OpenAiErrorCodeMessage','getTokenCount','from','BadwordsService','REDIS_PASSWORD','26135ucywUn','key','saveChatLog','addOneIfOdd','ModelsService','@nestjs/typeorm','REDIS_PORT','400\x20error','result','36EDYAxC','axios','__esModule','decorate','getUploadType','openaiBaseUrl','ChatBoxEntity','detail',',\x20key\x20===>\x20','缺失必要参数！','statusCode','user','includes','text','statusText','floor','gptKeysEntity','chatBoxTypeEntity','getClientIp','base64','Incorrect\x20API\x20key\x20provided','getModelProxyUrl','./helper','__decorate','sendMessageFromOpenAi','Content-type','chatBoxEntity','standard','userBanance','appEntity','whiteListUser','formatModelToken','quality','nineai-chatlog','setChatBoxType','openaiTimeoutMs','parse','绘制图片失败，请稍后试试吧！','9952JtZkcV','mjDraw','108691RnmOwz','draw','toISOString','chat-error\x20<----------------------------------------->','./chatBoxType.entity','5736760YUUKUy','conversationId','openaiModel4MaxTokens','1106','forEach','message','HttpException','push','default','abortController','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','201817oIbkHg','autoreplyService','find','redis://','ceil','chatProcess','当前模型不是聊天模型','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','../../common/utils','../badwords/badwords.service','./../user/user.service','status','当前分类下有未处理数据不可移除！','statusText:','defineProperty','usage','https://api.openai.com','getCurrentModelKeyInfo','getUuid','stringify','../userBalance/userBalance.service','dall-e\x20draw\x20params:\x20','chat','174DDcrPJ','REDIS_HOST','importDynamic','coverImg','@nestjs/common','openaiModel4MaxTokens32kRes','is_end','setChatPre','data','32k','fanyiService','./store','ConfigService','map','chat-error-detail\x20\x20<----------------------------------------->','object','weight','REDIS_USER','appId','onModuleInit',',\x20消耗token:\x20','getRequestParams','update','16k','Injectable','queryChatPre','getRandomDrawKey','getConfigs','绘制图片失败，请检查你的提示词是否有非法描述！','当前请求已过载、请稍等会儿再试试吧！','prompt','ChatPreEntity','log','DeductionKey','all','uuid','InjectRepository','metadata','split','BAD_REQUEST','length','error:\x20','CHAT_TYPE','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','save','HttpStatus','提供了错误的模型秘钥','systemMessage','abort','../models/models.service','chatPreTypeEntity','draw\x20paompt\x20info\x20<==**==>\x20','__metadata','chatGroupService','ChatGroupService','unifiedFormattingResponse','10467081xZbYuH','__param','ConfigEntity','slice','toLowerCase','当前模型调用过于频繁、请重新试试吧！','design:paramtypes','globalConfigService','userService','./chatBox.entity','setData','billing','typeId','AutoreplyService','userBalanceService','validateBalance','Catch\x20Error\x20','../../common/constants/errorMessage.constant','openai-draw\x20error:\x20','queryUserBalance','../fanyi/fanyi.service','keyPool','checkAutoReply','UserService','deductFromBalance','NineStore','maxModelTokens','chatSyncFree','DESC','./gptkeys.entity','ChatgptService','../globalConfig/globalConfig.service','服务异常、请重新试试吧！！！','setHeader','openaiModel3MaxTokens','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','chatPreEntity','../autoreply/autoreply.service','dall-e-3','openaiModel4MaxTokens32k','\x0a\x20Current\x20date:\x20','proxyUrl','preset','openaiProxyUrl','setChatBox','DrawService','gpt-4-1106','Billing\x20hard\x20limit\x20has\x20been\x20reached','appInfo','application/octet-stream;\x20charset=utf-8','PAYMENT_REQUIRED','2250GZyYCL','findOne','delChatPre','error','chatLogService','count','model','Repository','gpt-4','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','3758800FvzXbP','response','delChatBoxType','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','\x20模型名称:\x20','queryChatPreList','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','write','FanyiService','assistant','configEntity','ChatPreTypeEntity','checkUserStatus','imageUrl','modelsService','Too\x20Many\x20Requests','nineStore'];_0x1285=function(){return _0x3504cb;};return _0x1285();}const _0x46f540=_0x1f2e;(function(_0x593169,_0xea462d){const _0x511072=_0x1f2e,_0xe2823f=_0x593169();while(!![]){try{const _0x26f56c=-parseInt(_0x511072(0x157))/0x1*(parseInt(_0x511072(0x13d))/0x2)+-parseInt(_0x511072(0x160))/0x3*(-parseInt(_0x511072(0x186))/0x4)+parseInt(_0x511072(0x18d))/0x5+parseInt(_0x511072(0x1af))/0x6*(parseInt(_0x511072(0x198))/0x7)+parseInt(_0x511072(0x117))/0x8+parseInt(_0x511072(0xda))/0x9+parseInt(_0x511072(0x10d))/0xa*(-parseInt(_0x511072(0x188))/0xb);if(_0x26f56c===_0xea462d)break;else _0xe2823f['push'](_0xe2823f['shift']());}catch(_0x2f4ebc){_0xe2823f['push'](_0xe2823f['shift']());}}}(_0x1285,0xbbe1e));var __decorate=this&&this[_0x46f540(0x177)]||function(_0x5d0f26,_0x4606fc,_0x809b6e,_0x5f32e6){const _0x194e4c=_0x46f540;var _0x6ffc21=arguments[_0x194e4c(0xca)],_0x105fe9=_0x6ffc21<0x3?_0x4606fc:_0x5f32e6===null?_0x5f32e6=Object[_0x194e4c(0x142)](_0x4606fc,_0x809b6e):_0x5f32e6,_0x5b3fa4;if(typeof Reflect==='object'&&typeof Reflect[_0x194e4c(0x163)]==='function')_0x105fe9=Reflect[_0x194e4c(0x163)](_0x5d0f26,_0x4606fc,_0x809b6e,_0x5f32e6);else{for(var _0x24f32f=_0x5d0f26[_0x194e4c(0xca)]-0x1;_0x24f32f>=0x0;_0x24f32f--)if(_0x5b3fa4=_0x5d0f26[_0x24f32f])_0x105fe9=(_0x6ffc21<0x3?_0x5b3fa4(_0x105fe9):_0x6ffc21>0x3?_0x5b3fa4(_0x4606fc,_0x809b6e,_0x105fe9):_0x5b3fa4(_0x4606fc,_0x809b6e))||_0x105fe9;}return _0x6ffc21>0x3&&_0x105fe9&&Object[_0x194e4c(0x1a6)](_0x4606fc,_0x809b6e,_0x105fe9),_0x105fe9;},__metadata=this&&this[_0x46f540(0xd6)]||function(_0x38a3c5,_0x108627){const _0x23c683=_0x46f540;if(typeof Reflect===_0x23c683(0x1be)&&typeof Reflect[_0x23c683(0xc7)]===_0x23c683(0x139))return Reflect['metadata'](_0x38a3c5,_0x108627);},__param=this&&this[_0x46f540(0xdb)]||function(_0x1ce55b,_0x27bb26){return function(_0x8c2808,_0x4dba43){_0x27bb26(_0x8c2808,_0x4dba43,_0x1ce55b);};};Object[_0x46f540(0x1a6)](exports,_0x46f540(0x162),{'value':!![]}),exports[_0x46f540(0xf8)]=void 0x0;const upload_service_1=require('./../upload/upload.service'),user_service_1=require(_0x46f540(0x1a2)),nestjs_config_1=require(_0x46f540(0x140)),common_1=require(_0x46f540(0x1b3)),errorMessage_constant_1=require(_0x46f540(0xeb)),utils_1=require(_0x46f540(0x1a0)),axios_1=require(_0x46f540(0x161)),userBalance_service_1=require(_0x46f540(0x1ac)),balance_constant_1=require(_0x46f540(0x12c)),chatLog_service_1=require(_0x46f540(0x13b)),uuid=require(_0x46f540(0xc5)),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require('typeorm'),typeorm_2=require(_0x46f540(0x15c)),badwords_service_1=require(_0x46f540(0x1a1)),autoreply_service_1=require(_0x46f540(0xff)),gptkeys_entity_1=require(_0x46f540(0xf7)),globalConfig_service_1=require(_0x46f540(0xf9)),fanyi_service_1=require(_0x46f540(0xee)),app_entity_1=require('../app/app.entity'),chatGroup_service_1=require('../chatGroup/chatGroup.service'),models_service_1=require(_0x46f540(0xd3)),baidu_1=require('./baidu'),helper_1=require(_0x46f540(0x176)),store_1=require(_0x46f540(0x1ba)),zhipu_1=require('./zhipu'),openai_1=require('./openai'),chatBoxType_entity_1=require(_0x46f540(0x18c)),chatBox_entity_1=require(_0x46f540(0xe3)),chatPre_entity_1=require('./chatPre.entity'),chatPreType_entity_1=require('./chatPreType.entity');let ChatgptService=class ChatgptService{constructor(_0xd60de8,_0xcec652,_0x28a86d,_0x26e496,_0xbedb5e,_0x5d6070,_0x1600be,_0x267723,_0x6115c4,_0x491566,_0x2e5ab9,_0x30f594,_0x5b435e,_0x58ef14,_0x2f1c7a,_0x5a4e9f,_0x1b7eb0,_0x220a1a){const _0x34dbfd=_0x46f540;this[_0x34dbfd(0x170)]=_0xd60de8,this[_0x34dbfd(0x121)]=_0xcec652,this[_0x34dbfd(0x171)]=_0x28a86d,this[_0x34dbfd(0x17a)]=_0x26e496,this[_0x34dbfd(0x17d)]=_0xbedb5e,this[_0x34dbfd(0xd4)]=_0x5d6070,this[_0x34dbfd(0xfe)]=_0x1600be,this[_0x34dbfd(0x12a)]=_0x267723,this[_0x34dbfd(0xe8)]=_0x6115c4,this['chatLogService']=_0x491566,this[_0x34dbfd(0xe2)]=_0x2e5ab9,this[_0x34dbfd(0x14c)]=_0x30f594,this[_0x34dbfd(0x144)]=_0x5b435e,this[_0x34dbfd(0x199)]=_0x58ef14,this[_0x34dbfd(0xe1)]=_0x2f1c7a,this[_0x34dbfd(0x1b9)]=_0x5a4e9f,this[_0x34dbfd(0xd7)]=_0x1b7eb0,this[_0x34dbfd(0x125)]=_0x220a1a,this[_0x34dbfd(0x127)]=null,this[_0x34dbfd(0x17e)]=[],this['keyPool']={'list3':[],'list4':[]};}async[_0x46f540(0xb5)](){const _0x169a54=_0x46f540;let _0x1eaf74=await(0x0,utils_1[_0x169a54(0x1b1)])(_0x169a54(0x145)),_0x433850=await(0x0,utils_1[_0x169a54(0x1b1)])(_0x169a54(0x128)),_0xfe7dcd=await(0x0,utils_1[_0x169a54(0x1b1)])('keyv');_0x1eaf74=(_0x1eaf74===null||_0x1eaf74===void 0x0?void 0x0:_0x1eaf74[_0x169a54(0x195)])?_0x1eaf74[_0x169a54(0x195)]:_0x1eaf74,_0x433850=(_0x433850===null||_0x433850===void 0x0?void 0x0:_0x433850[_0x169a54(0x195)])?_0x433850[_0x169a54(0x195)]:_0x433850,_0xfe7dcd=(_0xfe7dcd===null||_0xfe7dcd===void 0x0?void 0x0:_0xfe7dcd[_0x169a54(0x195)])?_0xfe7dcd[_0x169a54(0x195)]:_0xfe7dcd;const {ChatGPTAPI:_0x3b12c9,ChatGPTError:_0x20b217,ChatGPTUnofficialProxyAPI:_0x4c8dbb}=_0x1eaf74,_0x3bac09=+process[_0x169a54(0x131)][_0x169a54(0x15d)],_0x47c707=process['env'][_0x169a54(0x1b0)],_0x46ce2b=process[_0x169a54(0x131)][_0x169a54(0x156)],_0x1461a0=process[_0x169a54(0x131)][_0x169a54(0x1c0)],_0xea161=_0x169a54(0x19b)+(_0x1461a0||'')+':'+(_0x46ce2b||'')+'@'+_0x47c707+':'+_0x3bac09,_0x31169b=new _0x433850(_0xea161),_0x39aa17=new _0xfe7dcd({'store':_0x31169b,'namespace':_0x169a54(0x181)});this[_0x169a54(0x127)]=new store_1[(_0x169a54(0xf3))]({'store':_0x39aa17,'namespace':_0x169a54(0x1ae)});}async[_0x46f540(0xb7)](_0x4aed8e,_0x120769,_0x27be4a,_0x24f8d7=null){const _0x5b9918=_0x46f540;var _0x15e696;!_0x24f8d7&&(_0x24f8d7=(_0x15e696=await this['modelsService'][_0x5b9918(0x143)]())===null||_0x15e696===void 0x0?void 0x0:_0x15e696['modelInfo']);const {timeout:timeout=0x3c}=_0x27be4a,{topN:_0xff15aa,model:_0x3a573a}=_0x24f8d7,{parentMessageId:parentMessageId=0x0}=_0x4aed8e,_0x3a14f8=await this[_0x5b9918(0xe1)][_0x5b9918(0xbd)]([_0x5b9918(0x183)]),_0x9ec37c=timeout*0x3e8||_0x3a14f8||0x64*0x3e8,_0x35c413={'parentMessageId':parentMessageId,'timeoutMs':+_0x9ec37c,'completionParams':{'model':_0x3a573a,'temperature':_0xff15aa}};return _0x120769&&(_0x35c413[_0x5b9918(0xd1)]=_0x120769),_0x35c413;}async[_0x46f540(0xf5)](_0x72f105){const _0x3584ab=_0x46f540,_0x28ccc7=await this['modelsService'][_0x3584ab(0xbc)](),_0x59ca89=await this[_0x3584ab(0xe1)][_0x3584ab(0xbd)]([_0x3584ab(0x138)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x1f58b7,model:_0xff0d7a}=_0x28ccc7,_0x4f9547=await this['getModelProxyUrl'](_0x28ccc7),{context:_0x1ea470}=await this[_0x3584ab(0x127)]['buildMessageFromParentMessageId'](_0x72f105,{'parentMessageId':'','systemMessage':_0x59ca89});try{const _0xc48612=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x1ea470,{'apiKey':(0x0,utils_1[_0x3584ab(0x130)])(_0x1f58b7),'model':_0xff0d7a,'proxyUrl':_0x4f9547,'onProgress':null});return _0xc48612===null||_0xc48612===void 0x0?void 0x0:_0xc48612[_0x3584ab(0x16d)];}catch(_0x43302b){console[_0x3584ab(0xc2)](_0x3584ab(0xcb),_0x43302b);}}async[_0x46f540(0x19d)](_0x4e3e7e,_0x2b59a9,_0x3201f7){const _0x5342e8=_0x46f540;var _0xbcdc2d,_0x59edcc,_0xca1c81,_0x1bb7b8;const _0x2cf424=_0x2b59a9[_0x5342e8(0x196)],{options:options={},appId:_0x3c431a,cusromPrompt:_0xbbc6ec,systemMessage:systemMessage=''}=_0x4e3e7e;let _0x480119=systemMessage;const {parentMessageId:_0x29eb59}=options,{prompt:_0x4cfd01,imageUrl:_0xca5076,model:_0x18a262}=_0x4e3e7e,{groupId:_0x12c13c,usingNetwork:_0x443b64}=options,_0x230bae=await this[_0x5342e8(0xd7)][_0x5342e8(0x132)](_0x12c13c),_0x41cb65=(_0x230bae===null||_0x230bae===void 0x0?void 0x0:_0x230bae[_0x5342e8(0x12b)])?JSON[_0x5342e8(0x184)](_0x230bae[_0x5342e8(0x12b)]):await this[_0x5342e8(0x125)][_0x5342e8(0x143)](),{keyType:_0x1198c5,model:_0x588b18,topN:_0x3a63d2,systemMessage:_0x239c5e,rounds:_0x3db246}=_0x41cb65['modelInfo'];let _0x33d7e7=null;!_0xbbc6ec?_0x33d7e7=await this[_0x5342e8(0x125)][_0x5342e8(0x1a9)](_0x588b18):_0x33d7e7=await this[_0x5342e8(0x125)]['getRandomDrawKey']();if(!_0x33d7e7)throw new common_1['HttpException'](_0x5342e8(0xfd),common_1[_0x5342e8(0xcf)][_0x5342e8(0xc9)]);const {deduct:_0x411613,isTokenBased:_0x270bd6,tokenFeeRatio:_0x164a0a,deductType:_0x228540,key:_0x5ebdbe,secret:_0x527707,modelName:_0x33adf3,id:_0x123531,accessToken:_0x45cbdd}=_0x33d7e7;await this['userService'][_0x5342e8(0x123)](_0x2b59a9[_0x5342e8(0x16b)]),await this[_0x5342e8(0xe8)][_0x5342e8(0xe9)](_0x2b59a9,_0x228540===0x1?'model3':'model4',_0x411613),_0x3201f7&&_0x3201f7[_0x5342e8(0xfb)](_0x5342e8(0x179),_0x5342e8(0x10b)),await this[_0x5342e8(0x144)][_0x5342e8(0x149)](_0x4cfd01,_0x2b59a9[_0x5342e8(0x16b)]['id']);const _0x5a3ca6=await this[_0x5342e8(0x199)][_0x5342e8(0xf0)](_0x4cfd01);if(_0x5a3ca6&&_0x3201f7){const _0x52772c={'message':_0x5a3ca6,'code':0x1f4};return _0x3201f7[_0x5342e8(0x11e)](JSON['stringify'](_0x52772c)),_0x3201f7[_0x5342e8(0x13f)]();}if(_0x3c431a){const _0x54b3eb=await this[_0x5342e8(0x17d)][_0x5342e8(0x10e)]({'where':{'id':_0x3c431a,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x54b3eb)throw new common_1[(_0x5342e8(0x193))](_0x5342e8(0x11d),common_1[_0x5342e8(0xcf)]['BAD_REQUEST']);_0x54b3eb[_0x5342e8(0x104)]&&(_0x480119=_0x54b3eb[_0x5342e8(0x104)]);}else{if(_0xbbc6ec)_0x480119=systemMessage;else{if(_0x239c5e)_0x480119=_0x239c5e;else{const _0x14ecda=new Date()[_0x5342e8(0x18a)]()[_0x5342e8(0xc8)]('T')[0x0],_0x2d9b93=await this[_0x5342e8(0xe1)][_0x5342e8(0xbd)](['systemPreMessage']);_0x480119=_0x2d9b93+(_0x5342e8(0x102)+_0x14ecda);}}}let _0x2316db='';if(_0x443b64){_0x2316db=await(0x0,utils_1['compileNetwork'])(_0x4cfd01);const _0x3162fb=new Date()[_0x5342e8(0x18a)]()['split']('T')[0x0],_0x51d196=await this['globalConfigService'][_0x5342e8(0xbd)](['systemPreMessage']);_0x480119=_0x51d196+(_0x5342e8(0x102)+_0x3162fb);}const _0x48282b=await this['getRequestParams'](options,_0x480119,_0x33d7e7,_0x41cb65['modelInfo']),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x52c206}=_0x33d7e7;_0x3201f7&&_0x3201f7[_0x5342e8(0x1a3)](0xc8);let _0x165183=null,_0x5746be=null;try{if(_0x3201f7){let _0x5a7f85=null,_0x21f76a=![];_0x3201f7['on']('close',async()=>{const _0x48628c=_0x5342e8;if(_0x21f76a)return;_0x2cf424[_0x48628c(0xd2)]();const _0x43f15f=await(0x0,openai_1[_0x48628c(0x153)])(_0x4cfd01)||0x0,_0x12358a=await(0x0,openai_1[_0x48628c(0x153)])(_0x5a7f85===null||_0x5a7f85===void 0x0?void 0x0:_0x5a7f85[_0x48628c(0x16d)])||0x0,_0x12cc4f=_0x43f15f+_0x12358a,_0x119530=(0x0,utils_1[_0x48628c(0x172)])(_0x2b59a9);await this['chatLogService'][_0x48628c(0x159)]({'appId':_0x3c431a,'curIp':_0x119530,'userId':_0x2b59a9[_0x48628c(0x16b)]['id'],'type':balance_constant_1[_0x48628c(0xc3)][_0x48628c(0xcc)],'prompt':_0x4cfd01,'imageUrl':_0xca5076,'activeModel':_0x18a262,'answer':'','promptTokens':_0x43f15f,'completionTokens':0x0,'totalTokens':_0x43f15f,'model':_0x588b18,'role':_0x48628c(0x16b),'groupId':_0x12c13c,'requestOptions':JSON[_0x48628c(0x1ab)]({'options':null,'prompt':_0x4cfd01})}),await this['chatLogService'][_0x48628c(0x159)]({'appId':_0x3c431a,'curIp':_0x119530,'userId':_0x2b59a9['user']['id'],'type':balance_constant_1[_0x48628c(0xc3)][_0x48628c(0xcc)],'prompt':_0x4cfd01,'answer':_0x5a7f85===null||_0x5a7f85===void 0x0?void 0x0:_0x5a7f85[_0x48628c(0x16d)],'promptTokens':_0x43f15f,'completionTokens':_0x12358a,'totalTokens':_0x12cc4f,'model':_0x588b18,'role':_0x48628c(0x120),'groupId':_0x12c13c,'requestOptions':JSON[_0x48628c(0x1ab)]({'options':{'model':_0x588b18,'temperature':_0x3a63d2},'prompt':_0x4cfd01}),'conversationOptions':JSON[_0x48628c(0x1ab)]({'conversationId':_0x5a7f85===null||_0x5a7f85===void 0x0?void 0x0:_0x5a7f85['conversationId'],'model':_0x588b18,'parentMessageId':_0x5a7f85===null||_0x5a7f85===void 0x0?void 0x0:_0x5a7f85['id'],'temperature':_0x3a63d2})});let _0x27f84b=_0x411613;_0x270bd6===!![]&&(_0x27f84b=Math[_0x48628c(0x19c)](_0x411613*_0x12cc4f/_0x164a0a)),await this[_0x48628c(0xe8)][_0x48628c(0xf2)](_0x2b59a9[_0x48628c(0x16b)]['id'],'model'+(_0x228540===0x1?0x3:0x4),_0x27f84b,_0x12cc4f);});if(Number(_0x1198c5)===0x1){const {key:_0x5a2a35,maxToken:_0x1ea812,maxTokenRes:_0x4af917,proxyResUrl:_0x59a352}=await this['formatModelToken'](_0x33d7e7),{parentMessageId:_0x5778f9,completionParams:_0x49ecf2,systemMessage:_0xa8432f}=_0x48282b,{model:_0x12b952,temperature:_0x10f14e}=_0x49ecf2,{context:_0x2550e7}=await this[_0x5342e8(0x127)]['buildMessageFromParentMessageId'](_0x443b64?_0x2316db:_0x4cfd01,{'parentMessageId':_0x5778f9,'systemMessage':_0xa8432f,'maxModelToken':_0x1ea812,'maxResponseTokens':_0x4af917,'maxRounds':(0x0,helper_1[_0x5342e8(0x15a)])(_0x3db246),'imageUrl':_0xca5076,'activeModel':_0x18a262});let _0xc8eee0=!![];_0x165183=await(0x0,openai_1[_0x5342e8(0x178)])(_0x2550e7,{'maxToken':_0x1ea812,'maxTokenRes':_0x4af917,'apiKey':_0x5ebdbe,'model':_0x12b952,'prompt':_0x4cfd01,'activeModel':_0x18a262,'imageUrl':_0xca5076,'temperature':_0x10f14e,'proxyUrl':_0x59a352,'onProgress':_0x1d197f=>{const _0x99dd37=_0x5342e8;_0x3201f7[_0x99dd37(0x11e)](_0xc8eee0?JSON[_0x99dd37(0x1ab)](_0x1d197f):'\x0a'+JSON[_0x99dd37(0x1ab)](_0x1d197f)),_0x5a7f85=_0x1d197f,_0xc8eee0=![];}},this[_0x5342e8(0x14c)]),_0x21f76a=!![];}if(Number(_0x1198c5)===0x2){let _0x308d53=!![];const {context:_0x5b69ec}=await this[_0x5342e8(0x127)][_0x5342e8(0x136)](_0x443b64?_0x2316db:_0x4cfd01,{'parentMessageId':_0x29eb59,'maxRounds':(0x0,helper_1[_0x5342e8(0x15a)])(_0x3db246)});_0x165183=await(0x0,baidu_1['sendMessageFromBaidu'])(_0x443b64?_0x2316db:_0x5b69ec,{'temperature':_0x3a63d2,'accessToken':_0x45cbdd,'model':_0x588b18,'onProgress':_0x28031f=>{const _0x5c1c94=_0x5342e8;_0x3201f7['write'](_0x308d53?JSON['stringify'](_0x28031f):'\x0a'+JSON[_0x5c1c94(0x1ab)](_0x28031f)),_0x308d53=![],_0x5a7f85=_0x28031f;}}),_0x21f76a=!![];}if(Number(_0x1198c5)===0x3){let _0x2e8fd6=!![];const {context:_0x1b28ec}=await this['nineStore'][_0x5342e8(0x136)](_0x443b64?_0x2316db:_0x4cfd01,{'parentMessageId':_0x29eb59,'maxRounds':(0x0,helper_1[_0x5342e8(0x15a)])(_0x3db246)});_0x165183=await(0x0,zhipu_1['sendMessageFromZhipu'])(_0x443b64?_0x2316db:_0x1b28ec,{'temperature':_0x3a63d2,'key':_0x52c206,'model':_0x588b18,'onProgress':_0xa92c5c=>{const _0x2d6b8f=_0x5342e8;_0x3201f7[_0x2d6b8f(0x11e)](_0x2e8fd6?JSON['stringify'](_0xa92c5c):'\x0a'+JSON[_0x2d6b8f(0x1ab)](_0xa92c5c)),_0x2e8fd6=![],_0x5a7f85=_0xa92c5c;}}),_0x21f76a=!![];}const _0x1b094b={'id':this[_0x5342e8(0x127)][_0x5342e8(0x1aa)](),'text':_0x4cfd01,'role':_0x5342e8(0x16b),'name':undefined,'usage':null,'imageUrl':_0xca5076,'activeModel':_0x18a262,'parentMessageId':_0x29eb59,'conversationId':_0x165183===null||_0x165183===void 0x0?void 0x0:_0x165183[_0x5342e8(0x18e)]};_0x5746be={'model':_0x588b18,'parentMessageId':_0x29eb59},await this[_0x5342e8(0x127)][_0x5342e8(0xe4)](_0x1b094b);const _0x19396f={'id':_0x165183['id'],'text':_0x165183['text'],'role':_0x5342e8(0x120),'name':undefined,'usage':_0x165183===null||_0x165183===void 0x0?void 0x0:_0x165183[_0x5342e8(0x1a7)],'imageUrl':_0xca5076,'parentMessageId':_0x1b094b['id'],'conversationId':_0x165183===null||_0x165183===void 0x0?void 0x0:_0x165183['conversationId']};await this[_0x5342e8(0x127)]['setData'](_0x19396f),_0x5746be={'model':_0x588b18,'parentMessageId':_0x1b094b['id']};}else{const {key:_0x569dae,maxToken:_0x3910c1,maxTokenRes:_0x28ea8e,proxyResUrl:_0x557933}=await this[_0x5342e8(0x17f)](_0x33d7e7),{parentMessageId:_0x2bce59,completionParams:_0x310522,systemMessage:_0x47beb9}=_0x48282b,{model:_0x40abe9,temperature:_0x5ebb44}=_0x310522,{context:_0x41a979}=await this[_0x5342e8(0x127)]['buildMessageFromParentMessageId'](_0x443b64?_0x2316db:_0x4cfd01,{'parentMessageId':_0x2bce59,'systemMessage':_0x47beb9,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x3db246)});_0x165183=await(0x0,openai_1[_0x5342e8(0x178)])(_0x41a979,{'apiKey':_0x5ebdbe,'model':_0x40abe9,'temperature':_0x5ebb44,'proxyUrl':_0x557933,'onProgress':null,'prompt':_0x4cfd01});}let _0x1b6022=null,_0x1fd1bd=null;_0x588b18[_0x5342e8(0x16c)](_0x5342e8(0x141))?_0x1b6022=((_0xbcdc2d=_0x165183[_0x5342e8(0x167)])===null||_0xbcdc2d===void 0x0?void 0x0:_0xbcdc2d[_0x5342e8(0x1a7)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x1fd1bd=await(0x0,helper_1[_0x5342e8(0xd9)])(_0x1198c5,_0x165183,_0x5746be);const {prompt_tokens:_0x44a1d4,completion_tokens:_0x735b37,total_tokens:_0x7396e1}=_0x588b18[_0x5342e8(0x16c)](_0x5342e8(0x141))?_0x1b6022:_0x1fd1bd[_0x5342e8(0x1a7)];let _0x511299=_0x411613;_0x270bd6===!![]&&(_0x511299=Math[_0x5342e8(0x19c)](_0x411613*_0x7396e1/_0x164a0a));await this['userBalanceService'][_0x5342e8(0xf2)](_0x2b59a9[_0x5342e8(0x16b)]['id'],_0x5342e8(0x113)+(_0x228540===0x1?0x3:0x4),_0x511299,_0x7396e1),await this[_0x5342e8(0x125)]['saveUseLog'](_0x123531,_0x7396e1);const _0x56736e=(0x0,utils_1['getClientIp'])(_0x2b59a9);await this['chatLogService'][_0x5342e8(0x159)]({'appId':_0x3c431a,'curIp':_0x56736e,'userId':_0x2b59a9[_0x5342e8(0x16b)]['id'],'type':balance_constant_1['DeductionKey'][_0x5342e8(0xcc)],'prompt':_0x4cfd01,'imageUrl':_0xca5076,'activeModel':_0x18a262,'answer':'','promptTokens':_0x44a1d4,'completionTokens':0x0,'totalTokens':_0x7396e1,'model':_0x588b18,'role':_0x5342e8(0x16b),'groupId':_0x12c13c,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x4cfd01})}),await this[_0x5342e8(0x111)][_0x5342e8(0x159)]({'appId':_0x3c431a,'curIp':_0x56736e,'userId':_0x2b59a9[_0x5342e8(0x16b)]['id'],'type':balance_constant_1[_0x5342e8(0xc3)][_0x5342e8(0xcc)],'prompt':_0x4cfd01,'imageUrl':_0x165183===null||_0x165183===void 0x0?void 0x0:_0x165183[_0x5342e8(0x124)],'answer':_0x165183[_0x5342e8(0x16d)],'promptTokens':_0x44a1d4,'completionTokens':_0x735b37,'totalTokens':_0x7396e1,'model':_0x588b18,'role':_0x5342e8(0x120),'groupId':_0x12c13c,'requestOptions':JSON[_0x5342e8(0x1ab)]({'options':{'model':_0x588b18,'temperature':_0x3a63d2},'prompt':_0x4cfd01}),'conversationOptions':JSON['stringify']({'conversationId':_0x165183[_0x5342e8(0x18e)],'model':_0x588b18,'parentMessageId':_0x165183['id'],'temperature':_0x3a63d2})}),common_1['Logger']['debug'](_0x5342e8(0x13c)+_0x2b59a9[_0x5342e8(0x16b)]['id']+_0x5342e8(0x11b)+_0x33adf3+'-'+_0x18a262+_0x5342e8(0xb6)+_0x7396e1+',\x20消耗积分：\x20'+_0x511299,_0x5342e8(0xf8));const _0x2f5444=await this[_0x5342e8(0xe8)][_0x5342e8(0xed)](_0x2b59a9[_0x5342e8(0x16b)]['id']);return _0x165183[_0x5342e8(0x17c)]=Object[_0x5342e8(0x12f)]({},_0x2f5444),_0x165183[_0x5342e8(0x15f)]&&(_0x165183[_0x5342e8(0x15f)]=''),_0x165183[_0x5342e8(0x1b5)]=!![],_0x3201f7?_0x3201f7[_0x5342e8(0x11e)]('\x0a'+JSON[_0x5342e8(0x1ab)](_0x165183)):_0x165183['text'];}catch(_0x50f6af){console[_0x5342e8(0xc2)](_0x5342e8(0x18b),_0x5ebdbe,_0x50f6af);const _0x11cd38=(_0x50f6af===null||_0x50f6af===void 0x0?void 0x0:_0x50f6af[_0x5342e8(0x16a)])||0x190,_0x2a67ba=((_0x59edcc=_0x50f6af===null||_0x50f6af===void 0x0?void 0x0:_0x50f6af[_0x5342e8(0x118)])===null||_0x59edcc===void 0x0?void 0x0:_0x59edcc['status'])||(_0x50f6af===null||_0x50f6af===void 0x0?void 0x0:_0x50f6af[_0x5342e8(0x16a)])||0x190;console[_0x5342e8(0xc2)](_0x5342e8(0x1bd),'code:\x20',_0x11cd38,_0x5342e8(0x192),_0x50f6af===null||_0x50f6af===void 0x0?void 0x0:_0x50f6af[_0x5342e8(0x192)],_0x5342e8(0x1a5),(_0xca1c81=_0x50f6af===null||_0x50f6af===void 0x0?void 0x0:_0x50f6af['response'])===null||_0xca1c81===void 0x0?void 0x0:_0xca1c81[_0x5342e8(0x16e)],_0x5342e8(0x1a3),(_0x1bb7b8=_0x50f6af===null||_0x50f6af===void 0x0?void 0x0:_0x50f6af[_0x5342e8(0x118)])===null||_0x1bb7b8===void 0x0?void 0x0:_0x1bb7b8[_0x5342e8(0x1a3)]);if(_0x50f6af['status']&&_0x50f6af['status']===0x192){const _0x4319f4={'message':_0x5342e8(0xea)+_0x50f6af[_0x5342e8(0x192)],'code':0x192};if(_0x3201f7)return _0x3201f7[_0x5342e8(0x11e)](JSON[_0x5342e8(0x1ab)](_0x4319f4));else throw new common_1[(_0x5342e8(0x193))](_0x50f6af[_0x5342e8(0x192)],common_1[_0x5342e8(0xcf)][_0x5342e8(0x10c)]);}if(!_0x2a67ba){if(_0x3201f7)return _0x3201f7[_0x5342e8(0x11e)](JSON['stringify']({'message':_0x50f6af[_0x5342e8(0x192)],'code':0x1f4}));else throw new common_1[(_0x5342e8(0x193))](_0x50f6af[_0x5342e8(0x192)],common_1[_0x5342e8(0xcf)][_0x5342e8(0xc9)]);}let _0x49ccdf=errorMessage_constant_1[_0x5342e8(0x152)][_0x2a67ba]?errorMessage_constant_1[_0x5342e8(0x152)][_0x2a67ba]:_0x5342e8(0xfa);(_0x50f6af===null||_0x50f6af===void 0x0?void 0x0:_0x50f6af[_0x5342e8(0x192)][_0x5342e8(0x16c)](_0x5342e8(0x197)))&&Number(_0x1198c5)===0x1&&(await this[_0x5342e8(0x125)][_0x5342e8(0x133)](_0x123531,_0x5342e8(0x116),-0x1),_0x49ccdf='当前模型key已被封禁');(_0x50f6af===null||_0x50f6af===void 0x0?void 0x0:_0x50f6af[_0x5342e8(0x16a)])===0x1ad&&_0x50f6af['message'][_0x5342e8(0x16c)](_0x5342e8(0xe5))&&Number(_0x1198c5)===0x1&&(await this[_0x5342e8(0x125)]['lockKey'](_0x123531,_0x5342e8(0x13a),-0x3),_0x49ccdf='当前模型key余额已耗尽');(_0x50f6af===null||_0x50f6af===void 0x0?void 0x0:_0x50f6af['statusCode'])===0x1ad&&(_0x50f6af===null||_0x50f6af===void 0x0?void 0x0:_0x50f6af['statusText'])===_0x5342e8(0x126)&&(_0x49ccdf=_0x5342e8(0xdf));(_0x50f6af===null||_0x50f6af===void 0x0?void 0x0:_0x50f6af[_0x5342e8(0x16a)])===0x191&&_0x50f6af['message'][_0x5342e8(0x16c)](_0x5342e8(0x174))&&Number(_0x1198c5)===0x1&&(await this[_0x5342e8(0x125)]['lockKey'](_0x123531,_0x5342e8(0xd0),-0x2),_0x49ccdf=_0x5342e8(0xcd));(_0x50f6af===null||_0x50f6af===void 0x0?void 0x0:_0x50f6af['statusCode'])===0x194&&_0x50f6af[_0x5342e8(0x192)][_0x5342e8(0x16c)]('This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported')&&Number(_0x1198c5)===0x1&&(await this['modelsService'][_0x5342e8(0x133)](_0x123531,_0x5342e8(0x19e),-0x4),_0x49ccdf=_0x5342e8(0x11a));_0x11cd38===0x190&&console['log'](_0x5342e8(0x15e),_0x50f6af,_0x50f6af[_0x5342e8(0x192)]);const _0x5e0a51={'message':_0x49ccdf||'Please\x20check\x20the\x20back-end\x20console','code':_0x11cd38===0x191?0x190:_0x11cd38||0x1f4};if(_0x3201f7)return _0x3201f7[_0x5342e8(0x11e)](JSON[_0x5342e8(0x1ab)](_0x5e0a51));else throw new common_1[(_0x5342e8(0x193))](_0x5e0a51[_0x5342e8(0x192)],common_1[_0x5342e8(0xcf)][_0x5342e8(0xc9)]);}finally{_0x3201f7&&_0x3201f7[_0x5342e8(0x13f)]();}}async[_0x46f540(0x189)](_0x354631,_0x10f1d2){const _0x18f010=_0x46f540;var _0x574ed0,_0x36a333,_0x1b62af,_0x3d1712;await this[_0x18f010(0x144)][_0x18f010(0x149)](_0x354631[_0x18f010(0xc0)],_0x10f1d2[_0x18f010(0x16b)]['id']),await this['userService'][_0x18f010(0x123)](_0x10f1d2['user']);const _0x2a9061=(_0x354631===null||_0x354631===void 0x0?void 0x0:_0x354631[_0x18f010(0x180)])==='hd'?0x4:0x2;await this['userBalanceService'][_0x18f010(0xe9)](_0x10f1d2,_0x18f010(0x187),_0x2a9061);let _0x386924=[];const _0xb03d7c=await this[_0x18f010(0x125)][_0x18f010(0x1a9)](_0x18f010(0x100)),_0x4cf2f5=_0xb03d7c===null||_0xb03d7c===void 0x0?void 0x0:_0xb03d7c['id'],{key:_0x2d8ae0,proxyResUrl:_0x4528f7}=await this['formatModelToken'](_0xb03d7c);common_1['Logger']['log'](_0x18f010(0xd5)+_0x354631['prompt']+_0x18f010(0x168)+_0x2d8ae0,_0x18f010(0x107));try{const _0x3b413e=_0x4528f7+'/v1/images/generations',_0x21b165=Object[_0x18f010(0x12f)](Object[_0x18f010(0x12f)]({},_0x354631),{'model':_0x18f010(0x100)});console[_0x18f010(0xc2)](_0x18f010(0x1ad),_0x21b165);const _0x312628=await axios_1['default']['post'](_0x3b413e,Object[_0x18f010(0x12f)](Object[_0x18f010(0x12f)]({},_0x21b165),{'response_format':'b64_json'}),{'headers':{'Authorization':'Bearer\x20'+_0x2d8ae0}});_0x386924=_0x312628[_0x18f010(0x1b7)][_0x18f010(0x1b7)];const _0x591680=[];for(const _0x478a34 of _0x386924){const _0x1b4bdc=uuid['v4']()[_0x18f010(0xdd)](0x0,0xa)+'.png',_0xe21af4=Buffer[_0x18f010(0x154)](_0x478a34['b64_json'],_0x18f010(0x173));_0x591680[_0x18f010(0x194)](this[_0x18f010(0x14c)]['uploadFile']({'filename':_0x1b4bdc,'buffer':_0xe21af4}));}const _0x4da65a=await Promise['all'](_0x591680);await this['userBalanceService'][_0x18f010(0xf2)](_0x10f1d2[_0x18f010(0x16b)]['id'],_0x18f010(0x187),(_0x21b165===null||_0x21b165===void 0x0?void 0x0:_0x21b165[_0x18f010(0x180)])===_0x18f010(0x17b)?0x2:0x4,_0x2a9061);const _0x281682=(0x0,utils_1['getClientIp'])(_0x10f1d2),_0x3d25be=[],_0x41646d=await this[_0x18f010(0x14c)][_0x18f010(0x164)](),[_0x494a46,_0x5bff01]=_0x354631[_0x18f010(0x146)][_0x18f010(0xc8)]('x');return _0x4da65a['forEach'](_0x46998a=>{const _0xa90ee2=_0x18f010;_0x3d25be[_0xa90ee2(0x194)](this['chatLogService']['saveChatLog']({'curIp':_0x281682,'userId':_0x10f1d2[_0xa90ee2(0x16b)]['id'],'type':balance_constant_1[_0xa90ee2(0xc3)][_0xa90ee2(0x14b)],'prompt':_0x354631['prompt'],'answer':_0x46998a,'fileInfo':JSON[_0xa90ee2(0x1ab)]({'cosType':_0x41646d,'width':_0x494a46,'height':_0x5bff01,'cosUrl':_0x46998a}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0xa90ee2(0x100)}));}),await Promise[_0x18f010(0xc4)](_0x3d25be),_0x4da65a;}catch(_0x40b291){const _0x2d4811=((_0x574ed0=_0x40b291===null||_0x40b291===void 0x0?void 0x0:_0x40b291[_0x18f010(0x118)])===null||_0x574ed0===void 0x0?void 0x0:_0x574ed0[_0x18f010(0x1a3)])||0x1f4;console[_0x18f010(0xc2)](_0x18f010(0xec),JSON[_0x18f010(0x1ab)](_0x40b291),_0x2d8ae0,_0x2d4811);const _0x11d448=(_0x3d1712=(_0x1b62af=(_0x36a333=_0x40b291===null||_0x40b291===void 0x0?void 0x0:_0x40b291['response'])===null||_0x36a333===void 0x0?void 0x0:_0x36a333['data'])===null||_0x1b62af===void 0x0?void 0x0:_0x1b62af[_0x18f010(0x110)])===null||_0x3d1712===void 0x0?void 0x0:_0x3d1712[_0x18f010(0x192)];if(_0x2d4811===0x1ad)throw new common_1['HttpException'](_0x18f010(0xbf),common_1[_0x18f010(0xcf)][_0x18f010(0xc9)]);if(_0x2d4811===0x190&&_0x11d448[_0x18f010(0x16c)](_0x18f010(0x12d)))throw new common_1[(_0x18f010(0x193))](_0x18f010(0x19f),common_1[_0x18f010(0xcf)][_0x18f010(0xc9)]);if(_0x2d4811===0x190&&_0x11d448[_0x18f010(0x16c)](_0x18f010(0x109))){await this[_0x18f010(0x125)]['lockKey'](_0x4cf2f5,_0x18f010(0x116),-0x1);throw new common_1[(_0x18f010(0x193))]('当前Key余额已不足、请重新再试一次吧！',common_1['HttpStatus'][_0x18f010(0xc9)]);}if(_0x2d4811===0x1f4)throw new common_1[(_0x18f010(0x193))](_0x18f010(0xbe),common_1['HttpStatus'][_0x18f010(0xc9)]);if(_0x2d4811===0x191)throw new common_1[(_0x18f010(0x193))](_0x18f010(0x150),common_1[_0x18f010(0xcf)]['BAD_REQUEST']);throw new common_1['HttpException'](_0x18f010(0x185),common_1[_0x18f010(0xcf)][_0x18f010(0xc9)]);}}async['getAllKeyList'](){const _0xe74ad5=_0x46f540,_0x4ef10f=await this[_0xe74ad5(0x170)][_0xe74ad5(0x19a)]({'where':{'status':0x1},'select':['id',_0xe74ad5(0x158),_0xe74ad5(0x1bf),'model',_0xe74ad5(0xf4),_0xe74ad5(0x14f),_0xe74ad5(0x105),_0xe74ad5(0x183)]}),_0x4319a5=_0x4ef10f[_0xe74ad5(0x129)](_0x534ee3=>_0x534ee3['model']['includes'](_0xe74ad5(0x12e))),_0x23a728=_0x4ef10f[_0xe74ad5(0x129)](_0x429316=>_0x429316[_0xe74ad5(0x113)][_0xe74ad5(0x16c)](_0xe74ad5(0x115)));this[_0xe74ad5(0xef)]={'list3':_0x4319a5,'list4':_0x23a728};}async[_0x46f540(0x175)](_0x7fa1c){const _0x167107=_0x46f540,_0xb0b060=await this[_0x167107(0xe1)][_0x167107(0xbd)]([_0x167107(0x165)]);return(_0x7fa1c===null||_0x7fa1c===void 0x0?void 0x0:_0x7fa1c[_0x167107(0x103)])||_0xb0b060||'https://api.openai.com';}async[_0x46f540(0x17f)](_0x325a05){const _0x40566b=_0x46f540,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x40566b(0xe1)][_0x40566b(0xbd)]([_0x40566b(0xfc),_0x40566b(0x14e),'openaiModel3MaxTokens16k','openaiModel3MaxTokens16kRes',_0x40566b(0x18f),'openaiModel4MaxTokensRes',_0x40566b(0x101),_0x40566b(0x1b4),_0x40566b(0x165)]);let _0x5a7df6=null,_0x10b0ea=null,_0x373892=null,{model:_0x2478d8,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x1b07ca}=_0x325a05;return _0x2478d8[_0x40566b(0xde)]()['includes'](_0x40566b(0x115))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x10b0ea>=0x1000&&(maxModelTokens=0x1000),_0x5a7df6=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x10b0ea=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x2478d8['toLowerCase']()['includes'](_0x40566b(0x1b8))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x10b0ea>=0x4000&&(maxModelTokens=0x4000),_0x5a7df6=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x10b0ea=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x2478d8[_0x40566b(0xde)]()[_0x40566b(0x16c)](_0x40566b(0x190))&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x10b0ea>=0x1000&&(maxModelTokens=0x1000),_0x5a7df6=maxModelTokens||0x3ffc,_0x10b0ea=maxResponseTokens||0x1000)),_0x2478d8[_0x40566b(0xde)]()[_0x40566b(0x16c)](_0x40566b(0x12e))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x10b0ea>=0x7d0&&(maxModelTokens=0x7d0),_0x5a7df6=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x10b0ea=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x2478d8[_0x40566b(0xde)]()[_0x40566b(0x16c)]('16k')&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x10b0ea>=0x2000&&(maxModelTokens=0x2000),_0x5a7df6=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x10b0ea=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x2478d8[_0x40566b(0xde)]()['includes']('1106')&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x10b0ea>=0x1000&&(maxModelTokens=0x1000),_0x5a7df6=maxModelTokens||0x4000,_0x10b0ea=maxResponseTokens||0x1000)),_0x373892=proxyUrl||openaiBaseUrl||_0x40566b(0x1a8),_0x10b0ea>=_0x5a7df6&&(_0x10b0ea=Math[_0x40566b(0x16f)](_0x5a7df6/0x2)),{'key':_0x1b07ca,'maxToken':_0x5a7df6,'maxTokenRes':_0x10b0ea,'proxyResUrl':_0x373892};}async[_0x46f540(0x182)](_0x52037a,_0x52eb2b){const _0x2385d4=_0x46f540;try{const {name:_0x3bd9c3,icon:_0x44f00e,order:_0x8bac28,id:_0x44b4d9,status:_0x173396}=_0x52eb2b;return _0x44b4d9?await this[_0x2385d4(0x171)][_0x2385d4(0xb8)]({'id':_0x44b4d9},{'name':_0x3bd9c3,'icon':_0x44f00e,'order':_0x8bac28,'status':_0x173396}):await this[_0x2385d4(0x171)][_0x2385d4(0xce)]({'name':_0x3bd9c3,'icon':_0x44f00e,'order':_0x8bac28,'status':_0x173396});}catch(_0x4c7c75){console[_0x2385d4(0xc2)](_0x2385d4(0xcb),_0x4c7c75);}}async[_0x46f540(0x119)](_0x1f453c,_0x33649a){const _0xd8277a=_0x46f540,{id:_0x1018b1}=_0x33649a;if(!_0x1018b1)throw new common_1[(_0xd8277a(0x193))](_0xd8277a(0x135),common_1['HttpStatus'][_0xd8277a(0xc9)]);const _0x5b331b=await this['chatBoxEntity'][_0xd8277a(0x112)]({'where':{'typeId':_0x1018b1}});if(_0x5b331b)throw new common_1['HttpException']('当前分类下有未处理数据不可移除！',common_1[_0xd8277a(0xcf)][_0xd8277a(0xc9)]);return await this[_0xd8277a(0x171)][_0xd8277a(0x148)]({'id':_0x1018b1});}async[_0x46f540(0x137)](){const _0x4baae3=_0x46f540;return await this[_0x4baae3(0x171)]['find']({'order':{'order':_0x4baae3(0xf6)}});}async[_0x46f540(0x106)](_0xadaf6f,_0x1e9b78){const _0x5a3ced=_0x46f540,{title:_0x15fb9f,prompt:_0x2f07e6,appId:_0x530d51,order:_0x398acf,status:_0x2444d4,typeId:_0x5aa696,id:_0x533484,url:_0x4d742f}=_0x1e9b78;if(!_0x5aa696)throw new common_1[(_0x5a3ced(0x193))]('缺失必要参数！',common_1[_0x5a3ced(0xcf)][_0x5a3ced(0xc9)]);try{const _0x277cdd={'title':_0x15fb9f,'order':_0x398acf,'status':_0x2444d4,'typeId':_0x5aa696,'url':_0x4d742f};return _0x277cdd[_0x5a3ced(0x1c1)]=_0x530d51||0x0,_0x277cdd[_0x5a3ced(0xc0)]=_0x2f07e6||'',_0x533484?await this['chatBoxEntity']['update']({'id':_0x533484},_0x277cdd):await this['chatBoxEntity'][_0x5a3ced(0xce)](_0x277cdd);}catch(_0x58fea5){console[_0x5a3ced(0xc2)]('error:\x20',_0x58fea5);}}async['delChatBox'](_0x562699,_0x4372c4){const _0x3b8a28=_0x46f540,{id:_0x2a4a40}=_0x4372c4;if(!_0x2a4a40)throw new common_1[(_0x3b8a28(0x193))](_0x3b8a28(0x135),common_1[_0x3b8a28(0xcf)]['BAD_REQUEST']);return await this[_0x3b8a28(0x17a)][_0x3b8a28(0x148)]({'id':_0x2a4a40});}async['queryChatBox'](){const _0x249c9e=_0x46f540,_0x4427f8=await this['chatBoxEntity'][_0x249c9e(0x19a)]({'order':{'order':_0x249c9e(0xf6)}}),_0xee301d=[...new Set(_0x4427f8[_0x249c9e(0x1bc)](_0x34bde4=>_0x34bde4[_0x249c9e(0xe6)]))],_0x4bd7ae=[...new Set(_0x4427f8[_0x249c9e(0x1bc)](_0x1016d1=>_0x1016d1[_0x249c9e(0x1c1)]))],_0x44ac04=await this[_0x249c9e(0x171)][_0x249c9e(0x19a)]({'where':{'id':(0x0,typeorm_1['In'])(_0xee301d)}}),_0x5336f8=await this[_0x249c9e(0x17d)][_0x249c9e(0x19a)]({'where':{'id':(0x0,typeorm_1['In'])(_0x4bd7ae)}});return _0x4427f8[_0x249c9e(0x1bc)](_0x1a1cdf=>{const _0x1f34a8=_0x249c9e,{typeId:_0x29b0cc,appId:_0x33680c}=_0x1a1cdf;return _0x1a1cdf['typeInfo']=_0x44ac04[_0x1f34a8(0x19a)](_0x5e0106=>_0x5e0106['id']===_0x29b0cc),_0x1a1cdf[_0x1f34a8(0x10a)]=_0x5336f8[_0x1f34a8(0x19a)](_0x435272=>_0x435272['id']===_0x33680c),_0x1a1cdf;});}async[_0x46f540(0x13e)](){const _0x117eb0=_0x46f540,_0x555471=await this[_0x117eb0(0x171)][_0x117eb0(0x19a)]({'order':{'order':_0x117eb0(0xf6)},'where':{'status':!![]}}),_0x454c9c=await this[_0x117eb0(0x17a)][_0x117eb0(0x19a)]({'where':{'status':!![]}}),_0x312a9e=[...new Set(_0x454c9c[_0x117eb0(0x1bc)](_0x4fb24a=>_0x4fb24a[_0x117eb0(0x1c1)]))],_0x5874a4=await this[_0x117eb0(0x17d)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x312a9e)}});return _0x454c9c[_0x117eb0(0x191)](_0x3f9883=>{const _0x8e20bb=_0x117eb0,_0x49029c=_0x5874a4[_0x8e20bb(0x19a)](_0x38d26d=>_0x38d26d['id']===_0x3f9883[_0x8e20bb(0x1c1)]);return _0x3f9883[_0x8e20bb(0x1b2)]=_0x49029c===null||_0x49029c===void 0x0?void 0x0:_0x49029c[_0x8e20bb(0x1b2)],_0x3f9883;}),_0x555471[_0x117eb0(0x1bc)](_0x2444c4=>{const _0x5040dd=_0x117eb0;return _0x2444c4['childList']=_0x454c9c[_0x5040dd(0x129)](_0x1edccf=>_0x1edccf[_0x5040dd(0xe6)]===_0x2444c4['id']&&_0x1edccf[_0x5040dd(0x1a3)]),_0x2444c4;});}async['setChatPreType'](_0x5ee67d,_0x3a54cf){const _0x474698=_0x46f540;try{const {name:_0x291465,icon:_0x1107b2,order:_0x2833a5,id:_0x35054e,status:_0x5cb138}=_0x3a54cf;return _0x35054e?await this[_0x474698(0xd4)]['update']({'id':_0x35054e},{'name':_0x291465,'icon':_0x1107b2,'order':_0x2833a5,'status':_0x5cb138}):await this[_0x474698(0xd4)][_0x474698(0xce)]({'name':_0x291465,'icon':_0x1107b2,'order':_0x2833a5,'status':_0x5cb138});}catch(_0x2f6b28){console[_0x474698(0xc2)](_0x474698(0xcb),_0x2f6b28);}}async[_0x46f540(0x14a)](_0x325c41,_0x3b505b){const _0x39764d=_0x46f540,{id:_0x5ad222}=_0x3b505b;if(!_0x5ad222)throw new common_1['HttpException'](_0x39764d(0x135),common_1['HttpStatus']['BAD_REQUEST']);const _0x56c511=await this['chatBoxEntity'][_0x39764d(0x112)]({'where':{'typeId':_0x5ad222}});if(_0x56c511)throw new common_1[(_0x39764d(0x193))](_0x39764d(0x1a4),common_1[_0x39764d(0xcf)]['BAD_REQUEST']);return await this[_0x39764d(0xd4)][_0x39764d(0x148)]({'id':_0x5ad222});}async[_0x46f540(0x14d)](){const _0x20aa75=_0x46f540;return await this[_0x20aa75(0xd4)][_0x20aa75(0x19a)]({'order':{'order':_0x20aa75(0xf6)}});}async[_0x46f540(0x1b6)](_0x557f9f,_0x227adc){const _0x3a6e8e=_0x46f540,{title:_0x5e69db,prompt:_0x91d9c6,appId:_0x242e3d,order:_0x5a6171,status:_0x585368,typeId:_0x549aaa,id:_0x355830,url:_0xce8e68}=_0x227adc;if(!_0x549aaa)throw new common_1[(_0x3a6e8e(0x193))](_0x3a6e8e(0x169),common_1[_0x3a6e8e(0xcf)][_0x3a6e8e(0xc9)]);try{const _0x5550fa={'title':_0x5e69db,'prompt':_0x91d9c6,'order':_0x5a6171,'status':_0x585368,'typeId':_0x549aaa,'url':_0xce8e68};return _0x355830?await this['chatPreEntity'][_0x3a6e8e(0xb8)]({'id':_0x355830},_0x5550fa):await this[_0x3a6e8e(0xfe)]['save'](_0x5550fa);}catch(_0x838ded){console['log']('error:\x20',_0x838ded);}}async[_0x46f540(0x10f)](_0x450f8c,_0x235e32){const _0x5f065d=_0x46f540,{id:_0x28d5ab}=_0x235e32;if(!_0x28d5ab)throw new common_1['HttpException'](_0x5f065d(0x135),common_1[_0x5f065d(0xcf)]['BAD_REQUEST']);return await this[_0x5f065d(0xfe)]['delete']({'id':_0x28d5ab});}async[_0x46f540(0xbb)](){const _0x460298=_0x46f540,_0x1fea47=await this[_0x460298(0xfe)]['find']({'order':{'order':_0x460298(0xf6)}}),_0x2c58ed=[...new Set(_0x1fea47[_0x460298(0x1bc)](_0x5c0dba=>_0x5c0dba[_0x460298(0xe6)]))],_0x54ce71=await this[_0x460298(0xd4)][_0x460298(0x19a)]({'where':{'id':(0x0,typeorm_1['In'])(_0x2c58ed)}});return _0x1fea47[_0x460298(0x1bc)](_0x55aaf5=>{const _0x2b31e6=_0x460298,{typeId:_0x3e80c6,appId:_0x11a229}=_0x55aaf5;return _0x55aaf5['typeInfo']=_0x54ce71[_0x2b31e6(0x19a)](_0x4a5b8b=>_0x4a5b8b['id']===_0x3e80c6),_0x55aaf5;});}async[_0x46f540(0x11c)](){const _0x27e27c=_0x46f540,_0x3df799=await this[_0x27e27c(0xd4)]['find']({'order':{'order':'DESC'},'where':{'status':!![]}}),_0x4c2bde=await this['chatPreEntity'][_0x27e27c(0x19a)]({'where':{'status':!![]}});return _0x3df799[_0x27e27c(0x1bc)](_0x210a57=>{const _0x23e966=_0x27e27c;return _0x210a57['childList']=_0x4c2bde[_0x23e966(0x129)](_0x31594b=>_0x31594b['typeId']===_0x210a57['id']&&_0x31594b[_0x23e966(0x1a3)]),_0x210a57;});}async['getMaxTokenFromModelWithOpenAi'](_0x24e600,_0x1f5057,_0x5c4feb){const _0xc780ed=_0x46f540;let _0x598607=0x1000,_0x2ab46f=0x800;return _0x24e600[_0xc780ed(0xde)]()[_0xc780ed(0x16c)](_0xc780ed(0x115))&&(_0x598607=_0x1f5057>=0x2004?0x2004:_0x1f5057,_0x2ab46f=_0x5c4feb>=0x1000?0x1000:_0x5c4feb,_0x24e600[_0xc780ed(0xde)]()['includes'](_0xc780ed(0x1b8))&&(_0x598607=_0x1f5057>=0x8000?0x8000:_0x1f5057,_0x2ab46f=_0x5c4feb>=0x3e80?0x3e80:_0x5c4feb),(_0x24e600[_0xc780ed(0xde)]()[_0xc780ed(0x16c)](_0xc780ed(0x108))||_0x24e600[_0xc780ed(0xde)]()[_0xc780ed(0x16c)](_0xc780ed(0x151)))&&(_0x598607=_0x1f5057>=0x1f400?0x1f400:_0x1f5057,_0x2ab46f=_0x5c4feb>=0x1000?0x1000:_0x5c4feb)),_0x24e600[_0xc780ed(0xde)]()[_0xc780ed(0x16c)]('gpt-3')&&(_0x598607=_0x1f5057>=0x1000?0x1000:_0x1f5057,_0x2ab46f=_0x5c4feb>=0x800?0x800:_0x5c4feb,_0x24e600[_0xc780ed(0xde)]()[_0xc780ed(0x16c)](_0xc780ed(0xb9))&&(_0x598607=_0x1f5057>=0x4000?0x4000:_0x1f5057,_0x2ab46f=_0x5c4feb>=0x1f40?0x1f40:_0x5c4feb),_0x24e600[_0xc780ed(0xde)]()['includes']('1106')&&(_0x598607=_0x1f5057>=0x4000?0x4000:_0x1f5057,_0x2ab46f=_0x5c4feb>=0x1f40?0x1f40:_0x5c4feb)),{'maxToken':_0x598607,'maxRes':_0x2ab46f};}};function _0x1f2e(_0x2abf4c,_0x35863d){const _0x12850d=_0x1285();return _0x1f2e=function(_0x1f2e8b,_0x19a7ab){_0x1f2e8b=_0x1f2e8b-0xb5;let _0x317b91=_0x12850d[_0x1f2e8b];return _0x317b91;},_0x1f2e(_0x2abf4c,_0x35863d);}ChatgptService=__decorate([(0x0,common_1[_0x46f540(0xba)])(),__param(0x0,(0x0,typeorm_2[_0x46f540(0xc6)])(gptkeys_entity_1['GptKeysEntity'])),__param(0x1,(0x0,typeorm_2[_0x46f540(0xc6)])(config_entity_1[_0x46f540(0xdc)])),__param(0x2,(0x0,typeorm_2[_0x46f540(0xc6)])(chatBoxType_entity_1[_0x46f540(0x147)])),__param(0x3,(0x0,typeorm_2[_0x46f540(0xc6)])(chatBox_entity_1[_0x46f540(0x166)])),__param(0x4,(0x0,typeorm_2['InjectRepository'])(app_entity_1['AppEntity'])),__param(0x5,(0x0,typeorm_2[_0x46f540(0xc6)])(chatPreType_entity_1[_0x46f540(0x122)])),__param(0x6,(0x0,typeorm_2[_0x46f540(0xc6)])(chatPre_entity_1[_0x46f540(0xc1)])),__metadata(_0x46f540(0xe0),[typeorm_1['Repository'],typeorm_1['Repository'],typeorm_1[_0x46f540(0x114)],typeorm_1[_0x46f540(0x114)],typeorm_1[_0x46f540(0x114)],typeorm_1['Repository'],typeorm_1[_0x46f540(0x114)],nestjs_config_1[_0x46f540(0x1bb)],userBalance_service_1[_0x46f540(0x134)],chatLog_service_1['ChatLogService'],user_service_1[_0x46f540(0xf1)],upload_service_1['UploadService'],badwords_service_1[_0x46f540(0x155)],autoreply_service_1[_0x46f540(0xe7)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0x46f540(0x11f)],chatGroup_service_1[_0x46f540(0xd8)],models_service_1[_0x46f540(0x15b)]])],ChatgptService),exports['ChatgptService']=ChatgptService;