'use strict';const _0x4677f6=_0x1808;(function(_0x342ebe,_0x5890ec){const _0x485290=_0x1808,_0x49fc69=_0x342ebe();while(!![]){try{const _0x42725f=-parseInt(_0x485290(0x2a1))/0x1*(parseInt(_0x485290(0x255))/0x2)+-parseInt(_0x485290(0x1ea))/0x3+parseInt(_0x485290(0x28f))/0x4+-parseInt(_0x485290(0x284))/0x5+parseInt(_0x485290(0x29b))/0x6*(parseInt(_0x485290(0x25d))/0x7)+-parseInt(_0x485290(0x2a8))/0x8+-parseInt(_0x485290(0x208))/0x9*(-parseInt(_0x485290(0x23a))/0xa);if(_0x42725f===_0x5890ec)break;else _0x49fc69['push'](_0x49fc69['shift']());}catch(_0x398ed0){_0x49fc69['push'](_0x49fc69['shift']());}}}(_0x200d,0x1edce));function _0x1808(_0x11c31b,_0x433927){const _0x200d3a=_0x200d();return _0x1808=function(_0x1808f1,_0x566781){_0x1808f1=_0x1808f1-0x1c9;let _0x2ad872=_0x200d3a[_0x1808f1];return _0x2ad872;},_0x1808(_0x11c31b,_0x433927);}var __decorate=this&&this[_0x4677f6(0x1ed)]||function(_0x5cf9a6,_0x52b45c,_0x21172b,_0xdfd558){const _0x3ac60c=_0x4677f6;var _0x5b6985=arguments[_0x3ac60c(0x210)],_0x1e8a5b=_0x5b6985<0x3?_0x52b45c:_0xdfd558===null?_0xdfd558=Object[_0x3ac60c(0x25c)](_0x52b45c,_0x21172b):_0xdfd558,_0x4830a0;if(typeof Reflect===_0x3ac60c(0x274)&&typeof Reflect[_0x3ac60c(0x2cf)]===_0x3ac60c(0x1f4))_0x1e8a5b=Reflect['decorate'](_0x5cf9a6,_0x52b45c,_0x21172b,_0xdfd558);else{for(var _0x2fc7c2=_0x5cf9a6[_0x3ac60c(0x210)]-0x1;_0x2fc7c2>=0x0;_0x2fc7c2--)if(_0x4830a0=_0x5cf9a6[_0x2fc7c2])_0x1e8a5b=(_0x5b6985<0x3?_0x4830a0(_0x1e8a5b):_0x5b6985>0x3?_0x4830a0(_0x52b45c,_0x21172b,_0x1e8a5b):_0x4830a0(_0x52b45c,_0x21172b))||_0x1e8a5b;}return _0x5b6985>0x3&&_0x1e8a5b&&Object[_0x3ac60c(0x1e4)](_0x52b45c,_0x21172b,_0x1e8a5b),_0x1e8a5b;},__metadata=this&&this[_0x4677f6(0x270)]||function(_0x3332aa,_0x36aa90){const _0x3eabf1=_0x4677f6;if(typeof Reflect==='object'&&typeof Reflect[_0x3eabf1(0x20f)]===_0x3eabf1(0x1f4))return Reflect[_0x3eabf1(0x20f)](_0x3332aa,_0x36aa90);},__param=this&&this[_0x4677f6(0x1cc)]||function(_0x336661,_0x196882){return function(_0x185a77,_0x1c9d42){_0x196882(_0x185a77,_0x1c9d42,_0x336661);};};Object[_0x4677f6(0x1e4)](exports,'__esModule',{'value':!![]}),exports[_0x4677f6(0x283)]=void 0x0;const upload_service_1=require(_0x4677f6(0x2ad)),user_service_1=require(_0x4677f6(0x201)),nestjs_config_1=require(_0x4677f6(0x21b)),common_1=require(_0x4677f6(0x27f)),errorMessage_constant_1=require(_0x4677f6(0x1ec)),utils_1=require(_0x4677f6(0x206)),axios_1=require('axios'),userBalance_service_1=require(_0x4677f6(0x1d9)),balance_constant_1=require(_0x4677f6(0x233)),chatLog_service_1=require('../chatLog/chatLog.service'),uuid=require(_0x4677f6(0x26d)),config_entity_1=require(_0x4677f6(0x219)),typeorm_1=require(_0x4677f6(0x1e3)),typeorm_2=require(_0x4677f6(0x2bf)),badwords_service_1=require(_0x4677f6(0x1d7)),autoreply_service_1=require('../autoreply/autoreply.service'),gptkeys_entity_1=require(_0x4677f6(0x1ff)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),fanyi_service_1=require(_0x4677f6(0x227)),app_entity_1=require(_0x4677f6(0x2c3)),chatGroup_service_1=require(_0x4677f6(0x244)),models_service_1=require('../models/models.service'),baidu_1=require('./baidu'),helper_1=require(_0x4677f6(0x1e5)),store_1=require('./store'),zhipu_1=require(_0x4677f6(0x29a)),openai_1=require('./openai'),chatBoxType_entity_1=require(_0x4677f6(0x25e)),chatBox_entity_1=require(_0x4677f6(0x24f)),chatPre_entity_1=require(_0x4677f6(0x1fd)),chatPreType_entity_1=require('./chatPreType.entity');let ChatgptService=class ChatgptService{constructor(_0x46ca3b,_0x271b1e,_0x882ad5,_0x1d2304,_0x573f2b,_0x36031c,_0x2889c9,_0x293bad,_0x1e827a,_0x563550,_0x430c49,_0x3ba976,_0x17b429,_0x91a2b9,_0x4dbc1d,_0x319ad3,_0x4899c4,_0x3f1007){const _0xfe2af0=_0x4677f6;this['gptKeysEntity']=_0x46ca3b,this['configEntity']=_0x271b1e,this[_0xfe2af0(0x23f)]=_0x882ad5,this[_0xfe2af0(0x2c5)]=_0x1d2304,this['appEntity']=_0x573f2b,this['chatPreTypeEntity']=_0x36031c,this['chatPreEntity']=_0x2889c9,this[_0xfe2af0(0x229)]=_0x293bad,this[_0xfe2af0(0x252)]=_0x1e827a,this['chatLogService']=_0x563550,this[_0xfe2af0(0x1e7)]=_0x430c49,this[_0xfe2af0(0x1f9)]=_0x3ba976,this['badwordsService']=_0x17b429,this[_0xfe2af0(0x235)]=_0x91a2b9,this[_0xfe2af0(0x209)]=_0x4dbc1d,this[_0xfe2af0(0x2bd)]=_0x319ad3,this[_0xfe2af0(0x250)]=_0x4899c4,this[_0xfe2af0(0x20e)]=_0x3f1007,this['nineStore']=null,this['whiteListUser']=[],this[_0xfe2af0(0x1d2)]={'list3':[],'list4':[]};}async[_0x4677f6(0x259)](){const _0x2d86bd=_0x4677f6;let _0x1b5e02=await(0x0,utils_1[_0x2d86bd(0x26f)])(_0x2d86bd(0x242)),_0x26b738=await(0x0,utils_1[_0x2d86bd(0x26f)])(_0x2d86bd(0x204)),_0x289cf7=await(0x0,utils_1[_0x2d86bd(0x26f)])(_0x2d86bd(0x21f));_0x1b5e02=(_0x1b5e02===null||_0x1b5e02===void 0x0?void 0x0:_0x1b5e02[_0x2d86bd(0x29c)])?_0x1b5e02['default']:_0x1b5e02,_0x26b738=(_0x26b738===null||_0x26b738===void 0x0?void 0x0:_0x26b738['default'])?_0x26b738['default']:_0x26b738,_0x289cf7=(_0x289cf7===null||_0x289cf7===void 0x0?void 0x0:_0x289cf7[_0x2d86bd(0x29c)])?_0x289cf7[_0x2d86bd(0x29c)]:_0x289cf7;const {ChatGPTAPI:_0x1a20bf,ChatGPTError:_0x17c858,ChatGPTUnofficialProxyAPI:_0x336fca}=_0x1b5e02,_0x177bd9=+process[_0x2d86bd(0x1dd)][_0x2d86bd(0x2bb)],_0x1563bd=process[_0x2d86bd(0x1dd)][_0x2d86bd(0x288)],_0xc2cf37=process[_0x2d86bd(0x1dd)]['REDIS_PASSWORD'],_0x9b06df=process[_0x2d86bd(0x1dd)][_0x2d86bd(0x2be)],_0x26b032=_0x2d86bd(0x22a)+(_0x9b06df||'')+':'+(_0xc2cf37||'')+'@'+_0x1563bd+':'+_0x177bd9,_0x581ef9=new _0x26b738(_0x26b032),_0x2fbd3b=new _0x289cf7({'store':_0x581ef9,'namespace':_0x2d86bd(0x273)});this['nineStore']=new store_1['NineStore']({'store':_0x2fbd3b,'namespace':'chat'});}async['getRequestParams'](_0x494b11,_0xa1e51b,_0x2648d0,_0x19585e=null){const _0x3ae1d8=_0x4677f6;var _0x356778;!_0x19585e&&(_0x19585e=(_0x356778=await this[_0x3ae1d8(0x20e)]['getBaseConfig']())===null||_0x356778===void 0x0?void 0x0:_0x356778[_0x3ae1d8(0x251)]);const {timeout:timeout=0x3c}=_0x2648d0,{topN:_0x119ba3,model:_0x2bef5a}=_0x19585e,{parentMessageId:parentMessageId=0x0}=_0x494b11,_0x49b09a=await this[_0x3ae1d8(0x209)]['getConfigs']([_0x3ae1d8(0x272)]),_0x56518d=timeout*0x3e8||_0x49b09a||0x64*0x3e8,_0x9349ce={'parentMessageId':parentMessageId,'timeoutMs':+_0x56518d,'completionParams':{'model':_0x2bef5a,'temperature':_0x119ba3}};return _0xa1e51b&&(_0x9349ce[_0x3ae1d8(0x24d)]=_0xa1e51b),_0x9349ce;}async[_0x4677f6(0x207)](_0x5186b9){const _0x2cb0ac=_0x4677f6,_0x3d72b0=await this['modelsService'][_0x2cb0ac(0x262)](),_0x7c2e42=await this['globalConfigService'][_0x2cb0ac(0x1f5)](['systemPreMessage']),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x56731d,model:_0x49ebf8}=_0x3d72b0,_0x4cbfa6=await this[_0x2cb0ac(0x238)](_0x3d72b0),{context:_0x4668fb}=await this[_0x2cb0ac(0x1d4)]['buildMessageFromParentMessageId'](_0x5186b9,{'parentMessageId':'','systemMessage':_0x7c2e42});try{const _0x26f555=await(0x0,openai_1[_0x2cb0ac(0x2c0)])(_0x4668fb,{'apiKey':(0x0,utils_1[_0x2cb0ac(0x1dc)])(_0x56731d),'model':_0x49ebf8,'proxyUrl':_0x4cbfa6,'onProgress':null});return _0x26f555===null||_0x26f555===void 0x0?void 0x0:_0x26f555[_0x2cb0ac(0x298)];}catch(_0x1b2871){console[_0x2cb0ac(0x280)]('error:\x20',_0x1b2871);}}async[_0x4677f6(0x2a6)](_0x4f433a,_0x3255a8,_0x1f5349){const _0x2639b7=_0x4677f6;var _0x26a909,_0x45d8e1,_0x443609,_0x2d8c32;const _0x4ccbe6=_0x3255a8[_0x2639b7(0x2a9)],{options:options={},appId:_0x3aadbd,cusromPrompt:_0x2b3fe6,systemMessage:systemMessage=''}=_0x4f433a;let _0x49ff3e=systemMessage;const {parentMessageId:_0x42d751}=options,{prompt:_0x2b78b0,imageUrl:_0xc53efe,model:_0x1e4f49}=_0x4f433a,{groupId:_0x333938,usingNetwork:_0x4a3228}=options,_0x7722ec=await this[_0x2639b7(0x250)][_0x2639b7(0x225)](_0x333938),_0x255ca8=(_0x7722ec===null||_0x7722ec===void 0x0?void 0x0:_0x7722ec[_0x2639b7(0x2c7)])?JSON['parse'](_0x7722ec['config']):await this[_0x2639b7(0x20e)][_0x2639b7(0x2af)](),{keyType:_0xb4e0d4,model:_0x2d3374,topN:_0x2db3e2,systemMessage:_0x5f5d27,rounds:_0x491dab}=_0x255ca8[_0x2639b7(0x251)];let _0x2aaf90=null;!_0x2b3fe6?_0x2aaf90=await this[_0x2639b7(0x20e)]['getCurrentModelKeyInfo'](_0x2d3374):_0x2aaf90=await this[_0x2639b7(0x20e)][_0x2639b7(0x262)]();if(!_0x2aaf90)throw new common_1[(_0x2639b7(0x202))](_0x2639b7(0x25f),common_1[_0x2639b7(0x24b)][_0x2639b7(0x1d3)]);const {deduct:_0x127ddc,isTokenBased:_0x5ada3e,tokenFeeRatio:_0x43ea53,deductType:_0x4959ce,key:_0x4cfa0b,secret:_0xcbbb3e,modelName:_0x453029,id:_0x3390f6,accessToken:_0x4edabb}=_0x2aaf90;await this[_0x2639b7(0x1e7)][_0x2639b7(0x236)](_0x3255a8[_0x2639b7(0x1f8)]),await this[_0x2639b7(0x252)][_0x2639b7(0x1e0)](_0x3255a8,_0x4959ce===0x1?'model3':_0x2639b7(0x243),_0x127ddc),_0x1f5349&&_0x1f5349[_0x2639b7(0x1ef)](_0x2639b7(0x249),_0x2639b7(0x22d)),await this['badwordsService']['checkBadWords'](_0x2b78b0,_0x3255a8[_0x2639b7(0x1f8)]['id']);const _0x249c0b=await this[_0x2639b7(0x235)][_0x2639b7(0x2ab)](_0x2b78b0);if(_0x249c0b&&_0x1f5349){const _0x38b15e={'message':_0x249c0b,'code':0x1f4};return _0x1f5349[_0x2639b7(0x2c4)](JSON[_0x2639b7(0x294)](_0x38b15e)),_0x1f5349[_0x2639b7(0x2a4)]();}if(_0x3aadbd){const _0x5cb387=await this[_0x2639b7(0x299)][_0x2639b7(0x2c2)]({'where':{'id':_0x3aadbd,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x5cb387)throw new common_1[(_0x2639b7(0x202))](_0x2639b7(0x1cb),common_1[_0x2639b7(0x24b)]['BAD_REQUEST']);_0x5cb387[_0x2639b7(0x261)]&&(_0x49ff3e=_0x5cb387[_0x2639b7(0x261)]);}else{if(_0x2b3fe6)_0x49ff3e=systemMessage;else{if(_0x5f5d27)_0x49ff3e=_0x5f5d27;else{const _0x14dace=new Date()[_0x2639b7(0x281)]()[_0x2639b7(0x290)]('T')[0x0],_0x54e51b=await this[_0x2639b7(0x209)][_0x2639b7(0x1f5)]([_0x2639b7(0x232)]);_0x49ff3e=_0x54e51b+(_0x2639b7(0x1c9)+_0x14dace);}}}let _0x29225f='';if(_0x4a3228){_0x29225f=await(0x0,utils_1[_0x2639b7(0x27d)])(_0x2b78b0);const _0x3d1722=new Date()[_0x2639b7(0x281)]()['split']('T')[0x0],_0x5b14c2=await this[_0x2639b7(0x209)][_0x2639b7(0x1f5)](['systemPreMessage']);_0x49ff3e=_0x5b14c2+(_0x2639b7(0x1c9)+_0x3d1722);}const _0x50234b=await this[_0x2639b7(0x2ba)](options,_0x49ff3e,_0x2aaf90,_0x255ca8['modelInfo']),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x2dcc31}=_0x2aaf90;_0x1f5349&&_0x1f5349[_0x2639b7(0x275)](0xc8);let _0xa8f28f=null,_0x437c56=null;try{if(_0x1f5349){let _0x115a9e=null,_0x3e61b4=![];_0x1f5349['on'](_0x2639b7(0x24a),async()=>{const _0x534fdd=_0x2639b7;if(_0x3e61b4)return;_0x4ccbe6[_0x534fdd(0x293)]();const _0x246915=await(0x0,openai_1['getTokenCount'])(_0x2b78b0)||0x0,_0x25652c=await(0x0,openai_1[_0x534fdd(0x1f7)])(_0x115a9e===null||_0x115a9e===void 0x0?void 0x0:_0x115a9e['text'])||0x0,_0x181674=_0x246915+_0x25652c,_0x118aaa=(0x0,utils_1[_0x534fdd(0x287)])(_0x3255a8);await this[_0x534fdd(0x258)][_0x534fdd(0x253)]({'appId':_0x3aadbd,'curIp':_0x118aaa,'userId':_0x3255a8[_0x534fdd(0x1f8)]['id'],'type':balance_constant_1[_0x534fdd(0x1e8)][_0x534fdd(0x23c)],'prompt':_0x2b78b0,'imageUrl':_0xc53efe,'activeModel':_0x1e4f49,'answer':'','promptTokens':_0x246915,'completionTokens':0x0,'totalTokens':_0x246915,'model':_0x2d3374,'role':'user','groupId':_0x333938,'requestOptions':JSON[_0x534fdd(0x294)]({'options':null,'prompt':_0x2b78b0})}),await this[_0x534fdd(0x258)][_0x534fdd(0x253)]({'appId':_0x3aadbd,'curIp':_0x118aaa,'userId':_0x3255a8['user']['id'],'type':balance_constant_1['DeductionKey']['CHAT_TYPE'],'prompt':_0x2b78b0,'answer':_0x115a9e===null||_0x115a9e===void 0x0?void 0x0:_0x115a9e[_0x534fdd(0x298)],'promptTokens':_0x246915,'completionTokens':_0x25652c,'totalTokens':_0x181674,'model':_0x2d3374,'role':_0x534fdd(0x2ca),'groupId':_0x333938,'requestOptions':JSON[_0x534fdd(0x294)]({'options':{'model':_0x2d3374,'temperature':_0x2db3e2},'prompt':_0x2b78b0}),'conversationOptions':JSON['stringify']({'conversationId':_0x115a9e===null||_0x115a9e===void 0x0?void 0x0:_0x115a9e[_0x534fdd(0x245)],'model':_0x2d3374,'parentMessageId':_0x115a9e===null||_0x115a9e===void 0x0?void 0x0:_0x115a9e['id'],'temperature':_0x2db3e2})});let _0x1c4332=_0x127ddc;_0x5ada3e===!![]&&(_0x1c4332=Math[_0x534fdd(0x1d1)](_0x127ddc*_0x181674/_0x43ea53)),await this[_0x534fdd(0x252)]['deductFromBalance'](_0x3255a8[_0x534fdd(0x1f8)]['id'],'model'+(_0x4959ce===0x1?0x3:0x4),_0x1c4332,_0x181674);});if(Number(_0xb4e0d4)===0x1){const {key:_0x30dec7,maxToken:_0x54c90c,maxTokenRes:_0x532f9,proxyResUrl:_0xd60747}=await this['formatModelToken'](_0x2aaf90),{parentMessageId:_0x12fdb8,completionParams:_0x74c25e,systemMessage:_0x30a6a4}=_0x50234b,{model:_0x62c933,temperature:_0xc050c2}=_0x74c25e,{context:_0x1e3f54}=await this[_0x2639b7(0x1d4)][_0x2639b7(0x2c9)](_0x4a3228?_0x29225f:_0x2b78b0,{'parentMessageId':_0x12fdb8,'systemMessage':_0x30a6a4,'maxModelToken':_0x54c90c,'maxResponseTokens':_0x532f9,'maxRounds':(0x0,helper_1[_0x2639b7(0x1d0)])(_0x491dab),'imageUrl':_0xc53efe,'activeModel':_0x1e4f49});let _0x48b2a7=!![];_0xa8f28f=await(0x0,openai_1[_0x2639b7(0x2c0)])(_0x1e3f54,{'maxToken':_0x54c90c,'maxTokenRes':_0x532f9,'apiKey':_0x4cfa0b,'model':_0x62c933,'prompt':_0x2b78b0,'activeModel':_0x1e4f49,'imageUrl':_0xc53efe,'temperature':_0xc050c2,'proxyUrl':_0xd60747,'onProgress':_0x2e0fbc=>{const _0x47f930=_0x2639b7;_0x1f5349[_0x47f930(0x2c4)](_0x48b2a7?JSON['stringify'](_0x2e0fbc):'\x0a'+JSON[_0x47f930(0x294)](_0x2e0fbc)),_0x115a9e=_0x2e0fbc,_0x48b2a7=![];}},this[_0x2639b7(0x1f9)]),_0x3e61b4=!![];}if(Number(_0xb4e0d4)===0x2){let _0x52c5b3=!![];const {context:_0x393b44}=await this[_0x2639b7(0x1d4)]['buildMessageFromParentMessageId'](_0x4a3228?_0x29225f:_0x2b78b0,{'parentMessageId':_0x42d751,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x491dab)});_0xa8f28f=await(0x0,baidu_1[_0x2639b7(0x26e)])(_0x4a3228?_0x29225f:_0x393b44,{'temperature':_0x2db3e2,'accessToken':_0x4edabb,'model':_0x2d3374,'onProgress':_0x4bafdd=>{const _0x99da27=_0x2639b7;_0x1f5349[_0x99da27(0x2c4)](_0x52c5b3?JSON['stringify'](_0x4bafdd):'\x0a'+JSON[_0x99da27(0x294)](_0x4bafdd)),_0x52c5b3=![],_0x115a9e=_0x4bafdd;}}),_0x3e61b4=!![];}if(Number(_0xb4e0d4)===0x3){let _0x131c1b=!![];const {context:_0x1b5606}=await this[_0x2639b7(0x1d4)][_0x2639b7(0x2c9)](_0x4a3228?_0x29225f:_0x2b78b0,{'parentMessageId':_0x42d751,'maxRounds':(0x0,helper_1[_0x2639b7(0x1d0)])(_0x491dab)});_0xa8f28f=await(0x0,zhipu_1['sendMessageFromZhipu'])(_0x4a3228?_0x29225f:_0x1b5606,{'temperature':_0x2db3e2,'key':_0x2dcc31,'model':_0x2d3374,'onProgress':_0xef0619=>{const _0x188e96=_0x2639b7;_0x1f5349[_0x188e96(0x2c4)](_0x131c1b?JSON[_0x188e96(0x294)](_0xef0619):'\x0a'+JSON[_0x188e96(0x294)](_0xef0619)),_0x131c1b=![],_0x115a9e=_0xef0619;}}),_0x3e61b4=!![];}const _0x2d5764={'id':this[_0x2639b7(0x1d4)]['getUuid'](),'text':_0x2b78b0,'role':_0x2639b7(0x1f8),'name':undefined,'usage':null,'imageUrl':_0xc53efe,'activeModel':_0x1e4f49,'parentMessageId':_0x42d751,'conversationId':_0xa8f28f===null||_0xa8f28f===void 0x0?void 0x0:_0xa8f28f[_0x2639b7(0x245)]};_0x437c56={'model':_0x2d3374,'parentMessageId':_0x42d751},await this[_0x2639b7(0x1d4)][_0x2639b7(0x212)](_0x2d5764);const _0x326ae8={'id':_0xa8f28f['id'],'text':_0xa8f28f[_0x2639b7(0x298)],'role':_0x2639b7(0x2ca),'name':undefined,'usage':_0xa8f28f===null||_0xa8f28f===void 0x0?void 0x0:_0xa8f28f['usage'],'imageUrl':_0xc53efe,'parentMessageId':_0x2d5764['id'],'conversationId':_0xa8f28f===null||_0xa8f28f===void 0x0?void 0x0:_0xa8f28f[_0x2639b7(0x245)]};await this[_0x2639b7(0x1d4)][_0x2639b7(0x212)](_0x326ae8),_0x437c56={'model':_0x2d3374,'parentMessageId':_0x2d5764['id']};}else{const {key:_0x4bb1f4,maxToken:_0x95d61b,maxTokenRes:_0x5accd0,proxyResUrl:_0x4fb80f}=await this[_0x2639b7(0x1f3)](_0x2aaf90),{parentMessageId:_0x16b1d8,completionParams:_0x95235f,systemMessage:_0x4d70b2}=_0x50234b,{model:_0x1d98d6,temperature:_0x33a602}=_0x95235f,{context:_0x59db89}=await this[_0x2639b7(0x1d4)][_0x2639b7(0x2c9)](_0x4a3228?_0x29225f:_0x2b78b0,{'parentMessageId':_0x16b1d8,'systemMessage':_0x4d70b2,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x491dab)});_0xa8f28f=await(0x0,openai_1[_0x2639b7(0x2c0)])(_0x59db89,{'apiKey':_0x4cfa0b,'model':_0x1d98d6,'temperature':_0x33a602,'proxyUrl':_0x4fb80f,'onProgress':null,'prompt':_0x2b78b0});}let _0xef314=null,_0x23e7e3=null;_0x2d3374[_0x2639b7(0x27a)](_0x2639b7(0x2ce))?_0xef314=((_0x26a909=_0xa8f28f[_0x2639b7(0x24c)])===null||_0x26a909===void 0x0?void 0x0:_0x26a909['usage'])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x23e7e3=await(0x0,helper_1['unifiedFormattingResponse'])(_0xb4e0d4,_0xa8f28f,_0x437c56);const {prompt_tokens:_0x13941a,completion_tokens:_0x262bdf,total_tokens:_0x5a1048}=_0x2d3374[_0x2639b7(0x27a)](_0x2639b7(0x2ce))?_0xef314:_0x23e7e3[_0x2639b7(0x23b)];let _0x38f46c=_0x127ddc;_0x5ada3e===!![]&&(_0x38f46c=Math[_0x2639b7(0x1d1)](_0x127ddc*_0x5a1048/_0x43ea53));await this[_0x2639b7(0x252)][_0x2639b7(0x218)](_0x3255a8[_0x2639b7(0x1f8)]['id'],'model'+(_0x4959ce===0x1?0x3:0x4),_0x38f46c,_0x5a1048),await this[_0x2639b7(0x20e)][_0x2639b7(0x297)](_0x3390f6,_0x5a1048);const _0x116220=(0x0,utils_1[_0x2639b7(0x287)])(_0x3255a8);await this[_0x2639b7(0x258)]['saveChatLog']({'appId':_0x3aadbd,'curIp':_0x116220,'userId':_0x3255a8[_0x2639b7(0x1f8)]['id'],'type':balance_constant_1['DeductionKey'][_0x2639b7(0x23c)],'prompt':_0x2b78b0,'imageUrl':_0xc53efe,'activeModel':_0x1e4f49,'answer':'','promptTokens':_0x13941a,'completionTokens':0x0,'totalTokens':_0x5a1048,'model':_0x2d3374,'role':_0x2639b7(0x1f8),'groupId':_0x333938,'requestOptions':JSON[_0x2639b7(0x294)]({'options':null,'prompt':_0x2b78b0})}),await this[_0x2639b7(0x258)][_0x2639b7(0x253)]({'appId':_0x3aadbd,'curIp':_0x116220,'userId':_0x3255a8[_0x2639b7(0x1f8)]['id'],'type':balance_constant_1[_0x2639b7(0x1e8)][_0x2639b7(0x23c)],'prompt':_0x2b78b0,'imageUrl':_0xa8f28f===null||_0xa8f28f===void 0x0?void 0x0:_0xa8f28f[_0x2639b7(0x23e)],'answer':_0xa8f28f['text'],'promptTokens':_0x13941a,'completionTokens':_0x262bdf,'totalTokens':_0x5a1048,'model':_0x2d3374,'role':_0x2639b7(0x2ca),'groupId':_0x333938,'requestOptions':JSON['stringify']({'options':{'model':_0x2d3374,'temperature':_0x2db3e2},'prompt':_0x2b78b0}),'conversationOptions':JSON['stringify']({'conversationId':_0xa8f28f['conversationId'],'model':_0x2d3374,'parentMessageId':_0xa8f28f['id'],'temperature':_0x2db3e2})}),common_1[_0x2639b7(0x214)][_0x2639b7(0x289)](_0x2639b7(0x234)+_0x3255a8[_0x2639b7(0x1f8)]['id']+'\x20模型名称:\x20'+_0x453029+'-'+_0x1e4f49+_0x2639b7(0x296)+_0x5a1048+_0x2639b7(0x23d)+_0x38f46c,_0x2639b7(0x283));const _0x116636=await this[_0x2639b7(0x252)][_0x2639b7(0x29e)](_0x3255a8['user']['id']);return _0xa8f28f[_0x2639b7(0x22c)]=Object[_0x2639b7(0x295)]({},_0x116636),_0xa8f28f[_0x2639b7(0x217)]&&(_0xa8f28f['result']=''),_0xa8f28f[_0x2639b7(0x29f)]=!![],_0x1f5349?_0x1f5349[_0x2639b7(0x2c4)]('\x0a'+JSON[_0x2639b7(0x294)](_0xa8f28f)):_0xa8f28f[_0x2639b7(0x298)];}catch(_0x4bc74e){console[_0x2639b7(0x280)](_0x2639b7(0x222),_0x4cfa0b,_0x4bc74e);const _0xa6a12=(_0x4bc74e===null||_0x4bc74e===void 0x0?void 0x0:_0x4bc74e[_0x2639b7(0x267)])||0x190,_0x4a5298=((_0x45d8e1=_0x4bc74e===null||_0x4bc74e===void 0x0?void 0x0:_0x4bc74e[_0x2639b7(0x2cc)])===null||_0x45d8e1===void 0x0?void 0x0:_0x45d8e1['status'])||(_0x4bc74e===null||_0x4bc74e===void 0x0?void 0x0:_0x4bc74e['statusCode'])||0x190;console[_0x2639b7(0x280)]('chat-error-detail\x20\x20<----------------------------------------->','code:\x20',_0xa6a12,_0x2639b7(0x26b),_0x4bc74e===null||_0x4bc74e===void 0x0?void 0x0:_0x4bc74e[_0x2639b7(0x26b)],_0x2639b7(0x271),(_0x443609=_0x4bc74e===null||_0x4bc74e===void 0x0?void 0x0:_0x4bc74e[_0x2639b7(0x2cc)])===null||_0x443609===void 0x0?void 0x0:_0x443609[_0x2639b7(0x2b3)],_0x2639b7(0x275),(_0x2d8c32=_0x4bc74e===null||_0x4bc74e===void 0x0?void 0x0:_0x4bc74e['response'])===null||_0x2d8c32===void 0x0?void 0x0:_0x2d8c32[_0x2639b7(0x275)]);if(_0x4bc74e[_0x2639b7(0x275)]&&_0x4bc74e[_0x2639b7(0x275)]===0x192){const _0x21ed8b={'message':_0x2639b7(0x28c)+_0x4bc74e['message'],'code':0x192};if(_0x1f5349)return _0x1f5349[_0x2639b7(0x2c4)](JSON['stringify'](_0x21ed8b));else throw new common_1[(_0x2639b7(0x202))](_0x4bc74e['message'],common_1[_0x2639b7(0x24b)][_0x2639b7(0x25b)]);}if(!_0x4a5298){if(_0x1f5349)return _0x1f5349['write'](JSON['stringify']({'message':_0x4bc74e[_0x2639b7(0x26b)],'code':0x1f4}));else throw new common_1[(_0x2639b7(0x202))](_0x4bc74e[_0x2639b7(0x26b)],common_1['HttpStatus'][_0x2639b7(0x1d3)]);}let _0xf5376b=errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x4a5298]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x4a5298]:_0x2639b7(0x1d5);(_0x4bc74e===null||_0x4bc74e===void 0x0?void 0x0:_0x4bc74e['message'][_0x2639b7(0x27a)](_0x2639b7(0x231)))&&Number(_0xb4e0d4)===0x1&&(await this['modelsService']['lockKey'](_0x3390f6,_0x2639b7(0x2b8),-0x1),_0xf5376b='当前模型key已被封禁');(_0x4bc74e===null||_0x4bc74e===void 0x0?void 0x0:_0x4bc74e[_0x2639b7(0x267)])===0x1ad&&_0x4bc74e[_0x2639b7(0x26b)]['includes'](_0x2639b7(0x1eb))&&Number(_0xb4e0d4)===0x1&&(await this[_0x2639b7(0x20e)]['lockKey'](_0x3390f6,'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0xf5376b=_0x2639b7(0x241));(_0x4bc74e===null||_0x4bc74e===void 0x0?void 0x0:_0x4bc74e['statusCode'])===0x1ad&&(_0x4bc74e===null||_0x4bc74e===void 0x0?void 0x0:_0x4bc74e[_0x2639b7(0x2b3)])===_0x2639b7(0x2a7)&&(_0xf5376b=_0x2639b7(0x1f2));(_0x4bc74e===null||_0x4bc74e===void 0x0?void 0x0:_0x4bc74e['statusCode'])===0x191&&_0x4bc74e[_0x2639b7(0x26b)][_0x2639b7(0x27a)](_0x2639b7(0x213))&&Number(_0xb4e0d4)===0x1&&(await this[_0x2639b7(0x20e)][_0x2639b7(0x1ce)](_0x3390f6,'提供了错误的模型秘钥',-0x2),_0xf5376b=_0x2639b7(0x1db));(_0x4bc74e===null||_0x4bc74e===void 0x0?void 0x0:_0x4bc74e[_0x2639b7(0x267)])===0x194&&_0x4bc74e[_0x2639b7(0x26b)]['includes'](_0x2639b7(0x28e))&&Number(_0xb4e0d4)===0x1&&(await this[_0x2639b7(0x20e)][_0x2639b7(0x1ce)](_0x3390f6,'当前模型不是聊天模型',-0x4),_0xf5376b=_0x2639b7(0x2cd));_0xa6a12===0x190&&console[_0x2639b7(0x280)](_0x2639b7(0x1f6),_0x4bc74e,_0x4bc74e[_0x2639b7(0x26b)]);const _0x38f733={'message':_0xf5376b||_0x2639b7(0x230),'code':_0xa6a12===0x191?0x190:_0xa6a12||0x1f4};if(_0x1f5349)return _0x1f5349[_0x2639b7(0x2c4)](JSON['stringify'](_0x38f733));else throw new common_1[(_0x2639b7(0x202))](_0x38f733['message'],common_1[_0x2639b7(0x24b)][_0x2639b7(0x1d3)]);}finally{_0x1f5349&&_0x1f5349[_0x2639b7(0x2a4)]();}}async[_0x4677f6(0x2b4)](_0x269c61,_0x24b669){const _0x1cfdfa=_0x4677f6;var _0x576388,_0x3d78ba,_0x4d33d3,_0x35377e;await this[_0x1cfdfa(0x26c)]['checkBadWords'](_0x269c61['prompt'],_0x24b669[_0x1cfdfa(0x1f8)]['id']),await this[_0x1cfdfa(0x1e7)]['checkUserStatus'](_0x24b669[_0x1cfdfa(0x1f8)]);const _0x4896ae=(_0x269c61===null||_0x269c61===void 0x0?void 0x0:_0x269c61[_0x1cfdfa(0x246)])==='hd'?0x4:0x2;await this['userBalanceService'][_0x1cfdfa(0x1e0)](_0x24b669,'mjDraw',_0x4896ae);let _0x3d94b1=[];const _0x320f59=await this[_0x1cfdfa(0x20e)]['getCurrentModelKeyInfo'](_0x1cfdfa(0x1fa)),_0x2c9406=_0x320f59===null||_0x320f59===void 0x0?void 0x0:_0x320f59['id'],{key:_0x2309dc,proxyResUrl:_0x100b95}=await this['formatModelToken'](_0x320f59);common_1['Logger'][_0x1cfdfa(0x280)](_0x1cfdfa(0x215)+_0x269c61[_0x1cfdfa(0x27b)]+_0x1cfdfa(0x277)+_0x2309dc,'DrawService');try{const _0x5e9492=_0x100b95+_0x1cfdfa(0x2b5),_0x37a063=Object[_0x1cfdfa(0x295)](Object['assign']({},_0x269c61),{'model':_0x1cfdfa(0x1fa)});console[_0x1cfdfa(0x280)]('dall-e\x20draw\x20params:\x20',_0x37a063);const _0x412719=await axios_1[_0x1cfdfa(0x29c)][_0x1cfdfa(0x28d)](_0x5e9492,Object[_0x1cfdfa(0x295)](Object['assign']({},_0x37a063),{'response_format':_0x1cfdfa(0x1ca)}),{'headers':{'Authorization':_0x1cfdfa(0x2b6)+_0x2309dc}});_0x3d94b1=_0x412719[_0x1cfdfa(0x24e)][_0x1cfdfa(0x24e)];const _0x1d0ede=[];for(const _0xe89b9b of _0x3d94b1){const _0x30e3aa=uuid['v4']()[_0x1cfdfa(0x228)](0x0,0xa)+_0x1cfdfa(0x257),_0x41ff5c=Buffer[_0x1cfdfa(0x21e)](_0xe89b9b[_0x1cfdfa(0x1ca)],_0x1cfdfa(0x2b2));_0x1d0ede['push'](this['uploadService']['uploadFile']({'filename':_0x30e3aa,'buffer':_0x41ff5c}));}const _0x15d5a2=await Promise[_0x1cfdfa(0x2c1)](_0x1d0ede);await this['userBalanceService'][_0x1cfdfa(0x218)](_0x24b669[_0x1cfdfa(0x1f8)]['id'],_0x1cfdfa(0x2b7),(_0x37a063===null||_0x37a063===void 0x0?void 0x0:_0x37a063[_0x1cfdfa(0x246)])===_0x1cfdfa(0x216)?0x2:0x4,_0x4896ae);const _0x3d3e67=(0x0,utils_1[_0x1cfdfa(0x287)])(_0x24b669),_0x1dfcce=[],_0x267b1a=await this[_0x1cfdfa(0x1f9)]['getUploadType'](),[_0x1bb7e7,_0x190e98]=_0x269c61[_0x1cfdfa(0x211)][_0x1cfdfa(0x290)]('x');return _0x15d5a2[_0x1cfdfa(0x276)](_0x5125ac=>{const _0x3e5341=_0x1cfdfa;_0x1dfcce[_0x3e5341(0x2ac)](this[_0x3e5341(0x258)]['saveChatLog']({'curIp':_0x3d3e67,'userId':_0x24b669[_0x3e5341(0x1f8)]['id'],'type':balance_constant_1[_0x3e5341(0x1e8)][_0x3e5341(0x240)],'prompt':_0x269c61[_0x3e5341(0x27b)],'answer':_0x5125ac,'fileInfo':JSON[_0x3e5341(0x294)]({'cosType':_0x267b1a,'width':_0x1bb7e7,'height':_0x190e98,'cosUrl':_0x5125ac}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x3e5341(0x1fa)}));}),await Promise[_0x1cfdfa(0x2c1)](_0x1dfcce),_0x15d5a2;}catch(_0x465ba5){const _0x4f9e3e=((_0x576388=_0x465ba5===null||_0x465ba5===void 0x0?void 0x0:_0x465ba5[_0x1cfdfa(0x2cc)])===null||_0x576388===void 0x0?void 0x0:_0x576388[_0x1cfdfa(0x275)])||0x1f4;console[_0x1cfdfa(0x280)](_0x1cfdfa(0x2a0),JSON['stringify'](_0x465ba5),_0x2309dc,_0x4f9e3e);const _0x448fe8=(_0x35377e=(_0x4d33d3=(_0x3d78ba=_0x465ba5===null||_0x465ba5===void 0x0?void 0x0:_0x465ba5['response'])===null||_0x3d78ba===void 0x0?void 0x0:_0x3d78ba[_0x1cfdfa(0x24e)])===null||_0x4d33d3===void 0x0?void 0x0:_0x4d33d3['error'])===null||_0x35377e===void 0x0?void 0x0:_0x35377e[_0x1cfdfa(0x26b)];if(_0x4f9e3e===0x1ad)throw new common_1['HttpException'](_0x1cfdfa(0x26a),common_1[_0x1cfdfa(0x24b)][_0x1cfdfa(0x1d3)]);if(_0x4f9e3e===0x190&&_0x448fe8[_0x1cfdfa(0x27a)](_0x1cfdfa(0x266)))throw new common_1[(_0x1cfdfa(0x202))](_0x1cfdfa(0x2a3),common_1[_0x1cfdfa(0x24b)]['BAD_REQUEST']);if(_0x4f9e3e===0x190&&_0x448fe8[_0x1cfdfa(0x27a)](_0x1cfdfa(0x239))){await this[_0x1cfdfa(0x20e)][_0x1cfdfa(0x1ce)](_0x2c9406,_0x1cfdfa(0x2b8),-0x1);throw new common_1[(_0x1cfdfa(0x202))](_0x1cfdfa(0x2c8),common_1[_0x1cfdfa(0x24b)]['BAD_REQUEST']);}if(_0x4f9e3e===0x1f4)throw new common_1[(_0x1cfdfa(0x202))](_0x1cfdfa(0x1cd),common_1[_0x1cfdfa(0x24b)][_0x1cfdfa(0x1d3)]);if(_0x4f9e3e===0x191)throw new common_1['HttpException'](_0x1cfdfa(0x1da),common_1[_0x1cfdfa(0x24b)]['BAD_REQUEST']);throw new common_1['HttpException']('绘制图片失败，请稍后试试吧！',common_1[_0x1cfdfa(0x24b)][_0x1cfdfa(0x1d3)]);}}async[_0x4677f6(0x263)](){const _0x209ee5=_0x4677f6,_0x18c596=await this[_0x209ee5(0x1e9)]['find']({'where':{'status':0x1},'select':['id','key',_0x209ee5(0x203),_0x209ee5(0x254),'maxModelTokens','maxResponseTokens',_0x209ee5(0x2b0),_0x209ee5(0x272)]}),_0x239888=_0x18c596['filter'](_0x1cae96=>_0x1cae96[_0x209ee5(0x254)][_0x209ee5(0x27a)](_0x209ee5(0x237))),_0x2a191f=_0x18c596[_0x209ee5(0x1df)](_0x4a1ade=>_0x4a1ade[_0x209ee5(0x254)][_0x209ee5(0x27a)](_0x209ee5(0x20c)));this[_0x209ee5(0x1d2)]={'list3':_0x239888,'list4':_0x2a191f};}async[_0x4677f6(0x238)](_0x193b8b){const _0x60f0d9=_0x4677f6,_0x2b1f02=await this['globalConfigService'][_0x60f0d9(0x1f5)]([_0x60f0d9(0x2bc)]);return(_0x193b8b===null||_0x193b8b===void 0x0?void 0x0:_0x193b8b[_0x60f0d9(0x1f0)])||_0x2b1f02||_0x60f0d9(0x2b1);}async[_0x4677f6(0x1f3)](_0x221d17){const _0x2f255a=_0x4677f6,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this['globalConfigService'][_0x2f255a(0x1f5)]([_0x2f255a(0x2aa),'openaiModel3MaxTokensRes',_0x2f255a(0x285),_0x2f255a(0x1de),_0x2f255a(0x25a),_0x2f255a(0x1fe),'openaiModel4MaxTokens32k',_0x2f255a(0x200),'openaiBaseUrl']);let _0x229ec5=null,_0x5f4c3c=null,_0x10ce96=null,{model:_0x5937e0,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x2d6f6b}=_0x221d17;return _0x5937e0['toLowerCase']()[_0x2f255a(0x27a)](_0x2f255a(0x20c))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x5f4c3c>=0x1000&&(maxModelTokens=0x1000),_0x229ec5=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x5f4c3c=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x5937e0[_0x2f255a(0x20d)]()[_0x2f255a(0x27a)]('32k')&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x5f4c3c>=0x4000&&(maxModelTokens=0x4000),_0x229ec5=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x5f4c3c=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x5937e0[_0x2f255a(0x20d)]()[_0x2f255a(0x27a)](_0x2f255a(0x268))&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x5f4c3c>=0x1000&&(maxModelTokens=0x1000),_0x229ec5=maxModelTokens||0x3ffc,_0x5f4c3c=maxResponseTokens||0x1000)),_0x5937e0[_0x2f255a(0x20d)]()[_0x2f255a(0x27a)](_0x2f255a(0x237))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x5f4c3c>=0x7d0&&(maxModelTokens=0x7d0),_0x229ec5=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x5f4c3c=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x5937e0[_0x2f255a(0x20d)]()[_0x2f255a(0x27a)](_0x2f255a(0x21a))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x5f4c3c>=0x2000&&(maxModelTokens=0x2000),_0x229ec5=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x5f4c3c=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x5937e0[_0x2f255a(0x20d)]()[_0x2f255a(0x27a)]('1106')&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x5f4c3c>=0x1000&&(maxModelTokens=0x1000),_0x229ec5=maxModelTokens||0x4000,_0x5f4c3c=maxResponseTokens||0x1000)),_0x10ce96=proxyUrl||openaiBaseUrl||'https://api.openai.com',_0x5f4c3c>=_0x229ec5&&(_0x5f4c3c=Math[_0x2f255a(0x260)](_0x229ec5/0x2)),{'key':_0x2d6f6b,'maxToken':_0x229ec5,'maxTokenRes':_0x5f4c3c,'proxyResUrl':_0x10ce96};}async['setChatBoxType'](_0x4a80c6,_0x234e16){const _0x21f66c=_0x4677f6;try{const {name:_0x3645ac,icon:_0x3e26d2,order:_0x2145eb,id:_0x5b5739,status:_0x995b9d}=_0x234e16;return _0x5b5739?await this[_0x21f66c(0x23f)][_0x21f66c(0x2ae)]({'id':_0x5b5739},{'name':_0x3645ac,'icon':_0x3e26d2,'order':_0x2145eb,'status':_0x995b9d}):await this['chatBoxTypeEntity']['save']({'name':_0x3645ac,'icon':_0x3e26d2,'order':_0x2145eb,'status':_0x995b9d});}catch(_0xe8f41c){console['log']('error:\x20',_0xe8f41c);}}async[_0x4677f6(0x29d)](_0x242025,_0xfdf31a){const _0x8786ba=_0x4677f6,{id:_0xf88e9c}=_0xfdf31a;if(!_0xf88e9c)throw new common_1[(_0x8786ba(0x202))]('非法操作！',common_1['HttpStatus'][_0x8786ba(0x1d3)]);const _0x20b128=await this[_0x8786ba(0x2c5)]['count']({'where':{'typeId':_0xf88e9c}});if(_0x20b128)throw new common_1[(_0x8786ba(0x202))]('当前分类下有未处理数据不可移除！',common_1[_0x8786ba(0x24b)][_0x8786ba(0x1d3)]);return await this['chatBoxTypeEntity'][_0x8786ba(0x20b)]({'id':_0xf88e9c});}async[_0x4677f6(0x292)](){const _0x5933e1=_0x4677f6;return await this[_0x5933e1(0x23f)][_0x5933e1(0x279)]({'order':{'order':'DESC'}});}async[_0x4677f6(0x1e2)](_0x428064,_0x5a29c8){const _0xe43eb8=_0x4677f6,{title:_0xfe00a4,prompt:_0x29bbc7,appId:_0xc26345,order:_0x4c2ce8,status:_0x4f306e,typeId:_0x3e49a3,id:_0x1913be,url:_0x504df6}=_0x5a29c8;if(!_0x3e49a3)throw new common_1[(_0xe43eb8(0x202))](_0xe43eb8(0x27c),common_1[_0xe43eb8(0x24b)]['BAD_REQUEST']);try{const _0x55cf21={'title':_0xfe00a4,'order':_0x4c2ce8,'status':_0x4f306e,'typeId':_0x3e49a3,'url':_0x504df6};return _0x55cf21['appId']=_0xc26345||0x0,_0x55cf21['prompt']=_0x29bbc7||'',_0x1913be?await this[_0xe43eb8(0x2c5)][_0xe43eb8(0x2ae)]({'id':_0x1913be},_0x55cf21):await this[_0xe43eb8(0x2c5)][_0xe43eb8(0x22f)](_0x55cf21);}catch(_0x2e0aee){console[_0xe43eb8(0x280)]('error:\x20',_0x2e0aee);}}async['delChatBox'](_0x3accbf,_0x421ede){const _0x3e9f2f=_0x4677f6,{id:_0x5538cf}=_0x421ede;if(!_0x5538cf)throw new common_1[(_0x3e9f2f(0x202))]('非法操作！',common_1['HttpStatus']['BAD_REQUEST']);return await this[_0x3e9f2f(0x2c5)]['delete']({'id':_0x5538cf});}async['queryChatBox'](){const _0x3d3a7d=_0x4677f6,_0x440ffe=await this['chatBoxEntity'][_0x3d3a7d(0x279)]({'order':{'order':'DESC'}}),_0x1f15e2=[...new Set(_0x440ffe[_0x3d3a7d(0x2b9)](_0x243729=>_0x243729[_0x3d3a7d(0x1d8)]))],_0x1467a5=[...new Set(_0x440ffe[_0x3d3a7d(0x2b9)](_0x438a3f=>_0x438a3f[_0x3d3a7d(0x1d6)]))],_0x1833ea=await this[_0x3d3a7d(0x23f)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x1f15e2)}}),_0x5ac6ac=await this[_0x3d3a7d(0x299)][_0x3d3a7d(0x279)]({'where':{'id':(0x0,typeorm_1['In'])(_0x1467a5)}});return _0x440ffe[_0x3d3a7d(0x2b9)](_0x347d96=>{const _0x2aa409=_0x3d3a7d,{typeId:_0x5eb837,appId:_0x2690aa}=_0x347d96;return _0x347d96['typeInfo']=_0x1833ea['find'](_0x1f65b8=>_0x1f65b8['id']===_0x5eb837),_0x347d96[_0x2aa409(0x1ee)]=_0x5ac6ac[_0x2aa409(0x279)](_0x43fa09=>_0x43fa09['id']===_0x2690aa),_0x347d96;});}async[_0x4677f6(0x1fb)](){const _0x27ca91=_0x4677f6,_0x310e17=await this[_0x27ca91(0x23f)][_0x27ca91(0x279)]({'order':{'order':_0x27ca91(0x1e1)},'where':{'status':!![]}}),_0x57c73a=await this[_0x27ca91(0x2c5)][_0x27ca91(0x279)]({'where':{'status':!![]}}),_0x4cfbc1=[...new Set(_0x57c73a[_0x27ca91(0x2b9)](_0x347b59=>_0x347b59['appId']))],_0x3f2b35=await this['appEntity']['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x4cfbc1)}});return _0x57c73a[_0x27ca91(0x276)](_0x465b7e=>{const _0x3d518c=_0x27ca91,_0x51bf55=_0x3f2b35[_0x3d518c(0x279)](_0x57f215=>_0x57f215['id']===_0x465b7e['appId']);return _0x465b7e[_0x3d518c(0x220)]=_0x51bf55===null||_0x51bf55===void 0x0?void 0x0:_0x51bf55[_0x3d518c(0x220)],_0x465b7e;}),_0x310e17['map'](_0x41f0e5=>{const _0x199657=_0x27ca91;return _0x41f0e5[_0x199657(0x2a5)]=_0x57c73a[_0x199657(0x1df)](_0x27c65d=>_0x27c65d['typeId']===_0x41f0e5['id']&&_0x27c65d[_0x199657(0x275)]),_0x41f0e5;});}async[_0x4677f6(0x286)](_0x5d3b70,_0x1db117){const _0x18bb62=_0x4677f6;try{const {name:_0x1805b7,icon:_0x4859f1,order:_0x3f2e83,id:_0xba9081,status:_0x2f56e3}=_0x1db117;return _0xba9081?await this[_0x18bb62(0x278)]['update']({'id':_0xba9081},{'name':_0x1805b7,'icon':_0x4859f1,'order':_0x3f2e83,'status':_0x2f56e3}):await this[_0x18bb62(0x278)][_0x18bb62(0x22f)]({'name':_0x1805b7,'icon':_0x4859f1,'order':_0x3f2e83,'status':_0x2f56e3});}catch(_0x586533){console[_0x18bb62(0x280)](_0x18bb62(0x269),_0x586533);}}async[_0x4677f6(0x282)](_0x136217,_0x4ac726){const _0x13c5ce=_0x4677f6,{id:_0x4a90a5}=_0x4ac726;if(!_0x4a90a5)throw new common_1[(_0x13c5ce(0x202))]('非法操作！',common_1[_0x13c5ce(0x24b)][_0x13c5ce(0x1d3)]);const _0x1b6aef=await this[_0x13c5ce(0x2c5)]['count']({'where':{'typeId':_0x4a90a5}});if(_0x1b6aef)throw new common_1[(_0x13c5ce(0x202))](_0x13c5ce(0x28a),common_1[_0x13c5ce(0x24b)][_0x13c5ce(0x1d3)]);return await this[_0x13c5ce(0x278)][_0x13c5ce(0x20b)]({'id':_0x4a90a5});}async[_0x4677f6(0x264)](){const _0x131837=_0x4677f6;return await this[_0x131837(0x278)][_0x131837(0x279)]({'order':{'order':_0x131837(0x1e1)}});}async[_0x4677f6(0x1f1)](_0x54dedb,_0x3941dd){const _0x4ed601=_0x4677f6,{title:_0x4d0ba9,prompt:_0x59c865,appId:_0x28adc8,order:_0x2c96e3,status:_0x4e5d34,typeId:_0x49b6cf,id:_0x452597,url:_0x35dc25}=_0x3941dd;if(!_0x49b6cf)throw new common_1[(_0x4ed601(0x202))](_0x4ed601(0x27c),common_1[_0x4ed601(0x24b)]['BAD_REQUEST']);try{const _0x22f395={'title':_0x4d0ba9,'prompt':_0x59c865,'order':_0x2c96e3,'status':_0x4e5d34,'typeId':_0x49b6cf,'url':_0x35dc25};return _0x452597?await this[_0x4ed601(0x224)][_0x4ed601(0x2ae)]({'id':_0x452597},_0x22f395):await this[_0x4ed601(0x224)]['save'](_0x22f395);}catch(_0xd43a2c){console[_0x4ed601(0x280)]('error:\x20',_0xd43a2c);}}async[_0x4677f6(0x22b)](_0x1b1c92,_0x3f2d3c){const _0x3cff84=_0x4677f6,{id:_0xf41f69}=_0x3f2d3c;if(!_0xf41f69)throw new common_1[(_0x3cff84(0x202))]('非法操作！',common_1[_0x3cff84(0x24b)]['BAD_REQUEST']);return await this[_0x3cff84(0x224)]['delete']({'id':_0xf41f69});}async[_0x4677f6(0x20a)](){const _0x4ee880=_0x4677f6,_0x427642=await this[_0x4ee880(0x224)][_0x4ee880(0x279)]({'order':{'order':_0x4ee880(0x1e1)}}),_0x52284e=[...new Set(_0x427642['map'](_0x4a95ca=>_0x4a95ca[_0x4ee880(0x1d8)]))],_0x3c3111=await this[_0x4ee880(0x278)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x52284e)}});return _0x427642[_0x4ee880(0x2b9)](_0x3eb5b2=>{const _0x69dd2c=_0x4ee880,{typeId:_0xe6e51b,appId:_0x4594dd}=_0x3eb5b2;return _0x3eb5b2['typeInfo']=_0x3c3111[_0x69dd2c(0x279)](_0x437596=>_0x437596['id']===_0xe6e51b),_0x3eb5b2;});}async[_0x4677f6(0x28b)](){const _0x5b6da5=_0x4677f6,_0x3ca39d=await this[_0x5b6da5(0x278)]['find']({'order':{'order':_0x5b6da5(0x1e1)},'where':{'status':!![]}}),_0x85e0da=await this[_0x5b6da5(0x224)][_0x5b6da5(0x279)]({'where':{'status':!![]}});return _0x3ca39d[_0x5b6da5(0x2b9)](_0x247542=>{const _0x26251f=_0x5b6da5;return _0x247542[_0x26251f(0x2a5)]=_0x85e0da[_0x26251f(0x1df)](_0xabbdc7=>_0xabbdc7['typeId']===_0x247542['id']&&_0xabbdc7[_0x26251f(0x275)]),_0x247542;});}async['getMaxTokenFromModelWithOpenAi'](_0x43998e,_0x18df19,_0x51b671){const _0x16fd52=_0x4677f6;let _0x1d227b=0x1000,_0x340db7=0x800;return _0x43998e[_0x16fd52(0x20d)]()[_0x16fd52(0x27a)](_0x16fd52(0x20c))&&(_0x1d227b=_0x18df19>=0x2004?0x2004:_0x18df19,_0x340db7=_0x51b671>=0x1000?0x1000:_0x51b671,_0x43998e[_0x16fd52(0x20d)]()[_0x16fd52(0x27a)]('32k')&&(_0x1d227b=_0x18df19>=0x8000?0x8000:_0x18df19,_0x340db7=_0x51b671>=0x3e80?0x3e80:_0x51b671),(_0x43998e['toLowerCase']()[_0x16fd52(0x27a)](_0x16fd52(0x2cb))||_0x43998e[_0x16fd52(0x20d)]()[_0x16fd52(0x27a)](_0x16fd52(0x22e)))&&(_0x1d227b=_0x18df19>=0x1f400?0x1f400:_0x18df19,_0x340db7=_0x51b671>=0x1000?0x1000:_0x51b671)),_0x43998e['toLowerCase']()['includes'](_0x16fd52(0x237))&&(_0x1d227b=_0x18df19>=0x1000?0x1000:_0x18df19,_0x340db7=_0x51b671>=0x800?0x800:_0x51b671,_0x43998e['toLowerCase']()[_0x16fd52(0x27a)](_0x16fd52(0x21a))&&(_0x1d227b=_0x18df19>=0x4000?0x4000:_0x18df19,_0x340db7=_0x51b671>=0x1f40?0x1f40:_0x51b671),_0x43998e[_0x16fd52(0x20d)]()[_0x16fd52(0x27a)](_0x16fd52(0x268))&&(_0x1d227b=_0x18df19>=0x4000?0x4000:_0x18df19,_0x340db7=_0x51b671>=0x1f40?0x1f40:_0x51b671)),{'maxToken':_0x1d227b,'maxRes':_0x340db7};}};function _0x200d(){const _0x43e935=['queryChatPreList','Catch\x20Error\x20','post','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','734048EkPZRO','split','UploadService','queryChatBoxType','abort','stringify','assign',',\x20消耗token:\x20','saveUseLog','text','appEntity','./zhipu','43818GvINYk','default','delChatBoxType','queryUserBalance','is_end','openai-draw\x20error:\x20','5CsrIFC','ModelsService','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','end','childList','chatProcess','Too\x20Many\x20Requests','843456lZPykR','abortController','openaiModel3MaxTokens','checkAutoReply','push','./../upload/upload.service','update','getBaseConfig','openaiProxyUrl','https://api.openai.com','base64','statusText','draw','/v1/images/generations','Bearer\x20','mjDraw','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','map','getRequestParams','REDIS_PORT','openaiBaseUrl','fanyiService','REDIS_USER','@nestjs/typeorm','sendMessageFromOpenAi','all','findOne','../app/app.entity','write','chatBoxEntity','GptKeysEntity','config','当前Key余额已不足、请重新再试一次吧！','buildMessageFromParentMessageId','assistant','gpt-4-1106','response','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','dall','decorate','\x0a\x20Current\x20date:\x20','b64_json','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','__param','绘制图片失败，请检查你的提示词是否有非法描述！','lockKey','UserService','addOneIfOdd','ceil','keyPool','BAD_REQUEST','nineStore','服务异常、请重新试试吧！！！','appId','../badwords/badwords.service','typeId','../userBalance/userBalance.service','绘制图片失败，此次绘画被拒绝了！','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','removeSpecialCharacters','env','openaiModel3MaxTokens16kRes','filter','validateBalance','DESC','setChatBox','typeorm','defineProperty','./helper','design:paramtypes','userService','DeductionKey','gptKeysEntity','472674DUMehx','billing','../../common/constants/errorMessage.constant','__decorate','appInfo','setHeader','proxyUrl','setChatPre','当前模型调用过于频繁、请重新试试吧！','formatModelToken','function','getConfigs','400\x20error','getTokenCount','user','uploadService','dall-e-3','queryChatBoxFrontend','ChatPreTypeEntity','./chatPre.entity','openaiModel4MaxTokensRes','./gptkeys.entity','openaiModel4MaxTokens32kRes','./../user/user.service','HttpException','weight','@keyv/redis','Repository','../../common/utils','chatSyncFree','1740735ONGrpd','globalConfigService','queryChatPre','delete','gpt-4','toLowerCase','modelsService','metadata','length','size','setData','Incorrect\x20API\x20key\x20provided','Logger','draw\x20paompt\x20info\x20<==**==>\x20','standard','result','deductFromBalance','../globalConfig/config.entity','16k','nestjs-config','BadwordsService','AutoreplyService','from','keyv','coverImg','ChatPreEntity','chat-error\x20<----------------------------------------->','ChatBoxEntity','chatPreEntity','getGroupInfoFromId','InjectRepository','../fanyi/fanyi.service','slice','configService','redis://','delChatPre','userBanance','application/octet-stream;\x20charset=utf-8','gpt-4-vision-preview','save','Please\x20check\x20the\x20back-end\x20console','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','systemPreMessage','../../common/constants/balance.constant','用户ID:\x20','autoreplyService','checkUserStatus','gpt-3','getModelProxyUrl','Billing\x20hard\x20limit\x20has\x20been\x20reached','20fXzrIn','usage','CHAT_TYPE',',\x20消耗积分：\x20','imageUrl','chatBoxTypeEntity','PAINT_TYPE','当前模型key余额已耗尽','chatgpt-ai-web','model4','../chatGroup/chatGroup.service','conversationId','quality','ConfigService','ChatBoxTypeEntity','Content-type','close','HttpStatus','detail','systemMessage','data','./chatBox.entity','chatGroupService','modelInfo','userBalanceService','saveChatLog','model','50998axfUzR','GlobalConfigService','.png','chatLogService','onModuleInit','openaiModel4MaxTokens','PAYMENT_REQUIRED','getOwnPropertyDescriptor','175uuyrTa','./chatBoxType.entity','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','floor','preset','getRandomDrawKey','getAllKeyList','queryChatPreType','UserBalanceService','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','statusCode','1106','error:\x20','当前请求已过载、请稍等会儿再试试吧！','message','badwordsService','uuid','sendMessageFromBaidu','importDynamic','__metadata','statusText:','openaiTimeoutMs','nineai-chatlog','object','status','forEach',',\x20key\x20===>\x20','chatPreTypeEntity','find','includes','prompt','缺失必要参数！','compileNetwork','FanyiService','@nestjs/common','log','toISOString','delChatPreType','ChatgptService','1180090HMRvkA','openaiModel3MaxTokens16k','setChatPreType','getClientIp','REDIS_HOST','debug','当前分类下有未处理数据不可移除！'];_0x200d=function(){return _0x43e935;};return _0x200d();}ChatgptService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x4677f6(0x226)])(gptkeys_entity_1[_0x4677f6(0x2c6)])),__param(0x1,(0x0,typeorm_2[_0x4677f6(0x226)])(config_entity_1['ConfigEntity'])),__param(0x2,(0x0,typeorm_2[_0x4677f6(0x226)])(chatBoxType_entity_1[_0x4677f6(0x248)])),__param(0x3,(0x0,typeorm_2[_0x4677f6(0x226)])(chatBox_entity_1[_0x4677f6(0x223)])),__param(0x4,(0x0,typeorm_2[_0x4677f6(0x226)])(app_entity_1['AppEntity'])),__param(0x5,(0x0,typeorm_2[_0x4677f6(0x226)])(chatPreType_entity_1[_0x4677f6(0x1fc)])),__param(0x6,(0x0,typeorm_2['InjectRepository'])(chatPre_entity_1[_0x4677f6(0x221)])),__metadata(_0x4677f6(0x1e6),[typeorm_1[_0x4677f6(0x205)],typeorm_1[_0x4677f6(0x205)],typeorm_1[_0x4677f6(0x205)],typeorm_1[_0x4677f6(0x205)],typeorm_1['Repository'],typeorm_1[_0x4677f6(0x205)],typeorm_1['Repository'],nestjs_config_1[_0x4677f6(0x247)],userBalance_service_1[_0x4677f6(0x265)],chatLog_service_1['ChatLogService'],user_service_1[_0x4677f6(0x1cf)],upload_service_1[_0x4677f6(0x291)],badwords_service_1[_0x4677f6(0x21c)],autoreply_service_1[_0x4677f6(0x21d)],globalConfig_service_1[_0x4677f6(0x256)],fanyi_service_1[_0x4677f6(0x27e)],chatGroup_service_1['ChatGroupService'],models_service_1[_0x4677f6(0x2a2)]])],ChatgptService),exports[_0x4677f6(0x283)]=ChatgptService;