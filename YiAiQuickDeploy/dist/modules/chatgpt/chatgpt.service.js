'use strict';const _0x31df0b=_0x3ec1;(function(_0x29e52d,_0x32eae8){const _0x3d298b=_0x3ec1,_0x4bcd00=_0x29e52d();while(!![]){try{const _0x227c15=parseInt(_0x3d298b(0x1cd))/0x1+-parseInt(_0x3d298b(0x2a7))/0x2+-parseInt(_0x3d298b(0x262))/0x3+-parseInt(_0x3d298b(0x1c5))/0x4+-parseInt(_0x3d298b(0x215))/0x5*(parseInt(_0x3d298b(0x210))/0x6)+parseInt(_0x3d298b(0x232))/0x7+parseInt(_0x3d298b(0x200))/0x8;if(_0x227c15===_0x32eae8)break;else _0x4bcd00['push'](_0x4bcd00['shift']());}catch(_0x34282d){_0x4bcd00['push'](_0x4bcd00['shift']());}}}(_0x3856,0x1c0cc));var __decorate=this&&this['__decorate']||function(_0x3c40bc,_0x33033a,_0x2cd827,_0x325750){const _0x2679d7=_0x3ec1;var _0x3ee72e=arguments[_0x2679d7(0x2aa)],_0x3e625f=_0x3ee72e<0x3?_0x33033a:_0x325750===null?_0x325750=Object['getOwnPropertyDescriptor'](_0x33033a,_0x2cd827):_0x325750,_0x1188c8;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x2679d7(0x235))_0x3e625f=Reflect[_0x2679d7(0x1dc)](_0x3c40bc,_0x33033a,_0x2cd827,_0x325750);else{for(var _0x59aa9f=_0x3c40bc[_0x2679d7(0x2aa)]-0x1;_0x59aa9f>=0x0;_0x59aa9f--)if(_0x1188c8=_0x3c40bc[_0x59aa9f])_0x3e625f=(_0x3ee72e<0x3?_0x1188c8(_0x3e625f):_0x3ee72e>0x3?_0x1188c8(_0x33033a,_0x2cd827,_0x3e625f):_0x1188c8(_0x33033a,_0x2cd827))||_0x3e625f;}return _0x3ee72e>0x3&&_0x3e625f&&Object[_0x2679d7(0x265)](_0x33033a,_0x2cd827,_0x3e625f),_0x3e625f;},__metadata=this&&this[_0x31df0b(0x2bc)]||function(_0x5d4c68,_0x181ba9){const _0x49f1d2=_0x31df0b;if(typeof Reflect===_0x49f1d2(0x292)&&typeof Reflect[_0x49f1d2(0x260)]==='function')return Reflect['metadata'](_0x5d4c68,_0x181ba9);},__param=this&&this['__param']||function(_0x475a0c,_0x1389b9){return function(_0x1a0156,_0x4b6656){_0x1389b9(_0x1a0156,_0x4b6656,_0x475a0c);};};Object[_0x31df0b(0x265)](exports,_0x31df0b(0x271),{'value':!![]}),exports['ChatgptService']=void 0x0;const upload_service_1=require('./../upload/upload.service'),user_service_1=require(_0x31df0b(0x1f9)),nestjs_config_1=require(_0x31df0b(0x27a)),common_1=require('@nestjs/common'),errorMessage_constant_1=require(_0x31df0b(0x231)),utils_1=require(_0x31df0b(0x207)),axios_1=require(_0x31df0b(0x1e9)),userBalance_service_1=require(_0x31df0b(0x203)),balance_constant_1=require('../../common/constants/balance.constant'),chatLog_service_1=require('../chatLog/chatLog.service'),uuid=require('uuid'),config_entity_1=require(_0x31df0b(0x1da)),typeorm_1=require(_0x31df0b(0x1fd)),typeorm_2=require(_0x31df0b(0x278)),badwords_service_1=require(_0x31df0b(0x205)),autoreply_service_1=require(_0x31df0b(0x2bb)),gptkeys_entity_1=require(_0x31df0b(0x1fa)),globalConfig_service_1=require(_0x31df0b(0x1e8)),fanyi_service_1=require(_0x31df0b(0x204)),app_entity_1=require(_0x31df0b(0x22d)),chatGroup_service_1=require(_0x31df0b(0x293)),models_service_1=require(_0x31df0b(0x1d8)),baidu_1=require(_0x31df0b(0x25a)),helper_1=require(_0x31df0b(0x1d2)),store_1=require(_0x31df0b(0x2be)),zhipu_1=require('./zhipu'),openai_1=require(_0x31df0b(0x286)),chatBoxType_entity_1=require(_0x31df0b(0x223)),chatBox_entity_1=require(_0x31df0b(0x1d5)),chatPre_entity_1=require(_0x31df0b(0x282)),chatPreType_entity_1=require(_0x31df0b(0x237));let ChatgptService=class ChatgptService{constructor(_0x1996a2,_0x438380,_0x2f4ba0,_0x21e9b0,_0x196a18,_0x4549db,_0x1593b6,_0x1275a4,_0xc1f327,_0x4d3b93,_0x1ef2ee,_0x35b607,_0x900231,_0x1b8bf8,_0x3d4666,_0x45febe,_0x17ee24,_0x33df13){const _0x2ed465=_0x31df0b;this[_0x2ed465(0x277)]=_0x1996a2,this['configEntity']=_0x438380,this[_0x2ed465(0x1ec)]=_0x2f4ba0,this['chatBoxEntity']=_0x21e9b0,this['appEntity']=_0x196a18,this[_0x2ed465(0x21a)]=_0x4549db,this['chatPreEntity']=_0x1593b6,this[_0x2ed465(0x1f7)]=_0x1275a4,this['userBalanceService']=_0xc1f327,this[_0x2ed465(0x20d)]=_0x4d3b93,this[_0x2ed465(0x239)]=_0x1ef2ee,this[_0x2ed465(0x22a)]=_0x35b607,this[_0x2ed465(0x2a0)]=_0x900231,this[_0x2ed465(0x25d)]=_0x1b8bf8,this[_0x2ed465(0x28c)]=_0x3d4666,this['fanyiService']=_0x45febe,this['chatGroupService']=_0x17ee24,this[_0x2ed465(0x2c3)]=_0x33df13,this['nineStore']=null,this[_0x2ed465(0x1d7)]=[],this[_0x2ed465(0x29e)]={'list3':[],'list4':[]};}async['onModuleInit'](){const _0x27cf7d=_0x31df0b;let _0x3232d6=await(0x0,utils_1['importDynamic'])(_0x27cf7d(0x28d)),_0x2ab6de=await(0x0,utils_1[_0x27cf7d(0x225)])(_0x27cf7d(0x284)),_0xe9479b=await(0x0,utils_1[_0x27cf7d(0x225)])('keyv');_0x3232d6=(_0x3232d6===null||_0x3232d6===void 0x0?void 0x0:_0x3232d6[_0x27cf7d(0x29f)])?_0x3232d6[_0x27cf7d(0x29f)]:_0x3232d6,_0x2ab6de=(_0x2ab6de===null||_0x2ab6de===void 0x0?void 0x0:_0x2ab6de[_0x27cf7d(0x29f)])?_0x2ab6de[_0x27cf7d(0x29f)]:_0x2ab6de,_0xe9479b=(_0xe9479b===null||_0xe9479b===void 0x0?void 0x0:_0xe9479b[_0x27cf7d(0x29f)])?_0xe9479b[_0x27cf7d(0x29f)]:_0xe9479b;const {ChatGPTAPI:_0x19c3f8,ChatGPTError:_0x319897,ChatGPTUnofficialProxyAPI:_0x5a8077}=_0x3232d6,_0x4f6fc4=+process[_0x27cf7d(0x26f)][_0x27cf7d(0x1c4)],_0x10f9c3=process[_0x27cf7d(0x26f)][_0x27cf7d(0x253)],_0xa7d19f=process['env'][_0x27cf7d(0x295)],_0x48abba=process['env'][_0x27cf7d(0x201)],_0x176b92=_0x27cf7d(0x221)+(_0x48abba||'')+':'+(_0xa7d19f||'')+'@'+_0x10f9c3+':'+_0x4f6fc4,_0x2664b3=new _0x2ab6de(_0x176b92),_0x54c2bb=new _0xe9479b({'store':_0x2664b3,'namespace':'nineai-chatlog'});this[_0x27cf7d(0x1fc)]=new store_1[(_0x27cf7d(0x1c6))]({'store':_0x54c2bb,'namespace':_0x27cf7d(0x1d0)});}async[_0x31df0b(0x216)](_0x1666df,_0x33779d,_0x48955f,_0x2233a5=null){const _0x2b1aa9=_0x31df0b;var _0x2083a7;!_0x2233a5&&(_0x2233a5=(_0x2083a7=await this[_0x2b1aa9(0x2c3)][_0x2b1aa9(0x1f3)]())===null||_0x2083a7===void 0x0?void 0x0:_0x2083a7[_0x2b1aa9(0x288)]);const {timeout:timeout=0x3c}=_0x48955f,{topN:_0xc989c7,model:_0x3d0c94}=_0x2233a5,{parentMessageId:parentMessageId=0x0}=_0x1666df,_0x5edbec=await this[_0x2b1aa9(0x28c)][_0x2b1aa9(0x290)]([_0x2b1aa9(0x2c5)]),_0x406d89=timeout*0x3e8||_0x5edbec||0x64*0x3e8,_0x414858={'parentMessageId':parentMessageId,'timeoutMs':+_0x406d89,'completionParams':{'model':_0x3d0c94,'temperature':_0xc989c7}};return _0x33779d&&(_0x414858['systemMessage']=_0x33779d),_0x414858;}async[_0x31df0b(0x2af)](_0x53d79f){const _0x498079=_0x31df0b,_0x557540=await this[_0x498079(0x2c3)][_0x498079(0x214)](),_0x5f47d5=await this[_0x498079(0x28c)]['getConfigs']([_0x498079(0x275)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x2e9bf4,model:_0x59fb1c}=_0x557540,_0x4a8f55=await this[_0x498079(0x226)](_0x557540),{context:_0x241666}=await this['nineStore'][_0x498079(0x287)](_0x53d79f,{'parentMessageId':'','systemMessage':_0x5f47d5});try{const _0xb8172=await(0x0,openai_1[_0x498079(0x29a)])(_0x241666,{'apiKey':(0x0,utils_1[_0x498079(0x2bd)])(_0x2e9bf4),'model':_0x59fb1c,'proxyUrl':_0x4a8f55,'onProgress':null});return _0xb8172===null||_0xb8172===void 0x0?void 0x0:_0xb8172[_0x498079(0x1c7)];}catch(_0x39809f){console[_0x498079(0x24e)](_0x498079(0x240),_0x39809f);}}async[_0x31df0b(0x2a2)](_0x46ec7a,_0xec812b,_0x172aca){const _0x34ab95=_0x31df0b;var _0x1e5d91,_0x138d37,_0x32b14c,_0x1c1091;const _0x44019c=_0xec812b['abortController'],{options:options={},appId:_0x40f358,cusromPrompt:_0x131adc,systemMessage:systemMessage=''}=_0x46ec7a;let _0x3bf068=systemMessage;const {parentMessageId:_0xdcef1d}=options,{prompt:_0x2b3539,imageUrl:_0x18d3b9,model:_0x46f0dc}=_0x46ec7a,{groupId:_0x403f55,usingNetwork:_0x21128f}=options,_0x458bcc=await this['chatGroupService']['getGroupInfoFromId'](_0x403f55),_0x363a64=(_0x458bcc===null||_0x458bcc===void 0x0?void 0x0:_0x458bcc[_0x34ab95(0x1c3)])?JSON[_0x34ab95(0x1f6)](_0x458bcc[_0x34ab95(0x1c3)]):await this['modelsService']['getBaseConfig'](),{keyType:_0x568889,model:_0x285db9,topN:_0xcec689,systemMessage:_0x5f2601,rounds:_0x526bc9}=_0x363a64['modelInfo'];let _0x5be8d9=null;!_0x131adc?_0x5be8d9=await this[_0x34ab95(0x2c3)]['getCurrentModelKeyInfo'](_0x285db9):_0x5be8d9=await this[_0x34ab95(0x2c3)][_0x34ab95(0x214)]();if(!_0x5be8d9)throw new common_1['HttpException'](_0x34ab95(0x24c),common_1['HttpStatus'][_0x34ab95(0x211)]);const {deduct:_0x582568,isTokenBased:_0x1bcab6,tokenFeeRatio:_0x2d9feb,deductType:_0x3dbafd,key:_0x1a7a4d,secret:_0x1a5cd4,modelName:_0x17d0cd,id:_0x55e3fe,accessToken:_0x51d375}=_0x5be8d9;await this['userService'][_0x34ab95(0x1c8)](_0xec812b[_0x34ab95(0x1ef)]),await this[_0x34ab95(0x1e1)][_0x34ab95(0x27d)](_0xec812b,_0x3dbafd===0x1?_0x34ab95(0x1ca):'model4',_0x582568),_0x172aca&&_0x172aca[_0x34ab95(0x1ed)](_0x34ab95(0x1fb),_0x34ab95(0x280)),await this['badwordsService'][_0x34ab95(0x2ad)](_0x2b3539,_0xec812b[_0x34ab95(0x1ef)]['id']);const _0x19f1c6=await this['autoreplyService'][_0x34ab95(0x25c)](_0x2b3539);if(_0x19f1c6&&_0x172aca){const _0x7ce943={'message':_0x19f1c6,'code':0x1f4};return _0x172aca['write'](JSON[_0x34ab95(0x1c2)](_0x7ce943)),_0x172aca[_0x34ab95(0x24a)]();}if(_0x40f358){const _0x4bbfd6=await this[_0x34ab95(0x1ce)][_0x34ab95(0x2b1)]({'where':{'id':_0x40f358,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x4bbfd6)throw new common_1['HttpException']('你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',common_1[_0x34ab95(0x1e6)][_0x34ab95(0x211)]);_0x4bbfd6[_0x34ab95(0x2a5)]&&(_0x3bf068=_0x4bbfd6['preset']);}else{if(_0x131adc)_0x3bf068=systemMessage;else{if(_0x5f2601)_0x3bf068=_0x5f2601;else{const _0x66d2b9=new Date()[_0x34ab95(0x26b)]()[_0x34ab95(0x298)]('T')[0x0],_0x11eaea=await this[_0x34ab95(0x28c)][_0x34ab95(0x290)]([_0x34ab95(0x275)]);_0x3bf068=_0x11eaea+(_0x34ab95(0x2a4)+_0x66d2b9);}}}let _0x4b0b24='';if(_0x21128f){_0x4b0b24=await(0x0,utils_1[_0x34ab95(0x1d1)])(_0x2b3539);const _0x1542a8=new Date()['toISOString']()['split']('T')[0x0],_0x3f8805=await this[_0x34ab95(0x28c)][_0x34ab95(0x290)]([_0x34ab95(0x275)]);_0x3bf068=_0x3f8805+(_0x34ab95(0x2a4)+_0x1542a8);}const _0x4a9730=await this[_0x34ab95(0x216)](options,_0x3bf068,_0x5be8d9,_0x363a64['modelInfo']),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x554425}=_0x5be8d9;_0x172aca&&_0x172aca[_0x34ab95(0x202)](0xc8);let _0x3983a6=null,_0x55e52d=null;try{if(_0x172aca){let _0x4dab4a=null,_0x526570=![];_0x172aca['on']('close',async()=>{const _0x562e51=_0x34ab95;if(_0x526570)return;_0x44019c[_0x562e51(0x238)]();const _0x49ec8f=await(0x0,openai_1[_0x562e51(0x1fe)])(_0x2b3539)||0x0,_0xa3375a=await(0x0,openai_1[_0x562e51(0x1fe)])(_0x4dab4a===null||_0x4dab4a===void 0x0?void 0x0:_0x4dab4a[_0x562e51(0x1c7)])||0x0,_0x298d0a=_0x49ec8f+_0xa3375a,_0x176d07=(0x0,utils_1[_0x562e51(0x21c)])(_0xec812b);await this[_0x562e51(0x20d)][_0x562e51(0x24f)]({'appId':_0x40f358,'curIp':_0x176d07,'userId':_0xec812b[_0x562e51(0x1ef)]['id'],'type':balance_constant_1['DeductionKey']['CHAT_TYPE'],'prompt':_0x2b3539,'imageUrl':_0x18d3b9,'activeModel':_0x46f0dc,'answer':'','promptTokens':_0x49ec8f,'completionTokens':0x0,'totalTokens':_0x49ec8f,'model':_0x285db9,'role':_0x562e51(0x1ef),'groupId':_0x403f55,'requestOptions':JSON[_0x562e51(0x1c2)]({'options':null,'prompt':_0x2b3539})}),await this[_0x562e51(0x20d)][_0x562e51(0x24f)]({'appId':_0x40f358,'curIp':_0x176d07,'userId':_0xec812b[_0x562e51(0x1ef)]['id'],'type':balance_constant_1[_0x562e51(0x1cc)]['CHAT_TYPE'],'prompt':_0x2b3539,'answer':_0x4dab4a===null||_0x4dab4a===void 0x0?void 0x0:_0x4dab4a[_0x562e51(0x1c7)],'promptTokens':_0x49ec8f,'completionTokens':_0xa3375a,'totalTokens':_0x298d0a,'model':_0x285db9,'role':_0x562e51(0x2c4),'groupId':_0x403f55,'requestOptions':JSON['stringify']({'options':{'model':_0x285db9,'temperature':_0xcec689},'prompt':_0x2b3539}),'conversationOptions':JSON[_0x562e51(0x1c2)]({'conversationId':_0x4dab4a===null||_0x4dab4a===void 0x0?void 0x0:_0x4dab4a[_0x562e51(0x2a6)],'model':_0x285db9,'parentMessageId':_0x4dab4a===null||_0x4dab4a===void 0x0?void 0x0:_0x4dab4a['id'],'temperature':_0xcec689})});let _0x483646=_0x582568;_0x1bcab6===!![]&&(_0x483646=Math[_0x562e51(0x276)](_0x582568*_0x298d0a/_0x2d9feb)),await this[_0x562e51(0x1e1)][_0x562e51(0x20a)](_0xec812b[_0x562e51(0x1ef)]['id'],_0x562e51(0x24d)+(_0x3dbafd===0x1?0x3:0x4),_0x483646,_0x298d0a);});if(Number(_0x568889)===0x1){const {key:_0x30f5d1,maxToken:_0x24f6db,maxTokenRes:_0x965b3c,proxyResUrl:_0x3bad47}=await this[_0x34ab95(0x22e)](_0x5be8d9),{parentMessageId:_0x37b1c6,completionParams:_0x3cba19,systemMessage:_0x3ffaea}=_0x4a9730,{model:_0x41d923,temperature:_0x2163f0}=_0x3cba19,{context:_0x3fa452}=await this[_0x34ab95(0x1fc)][_0x34ab95(0x287)](_0x21128f?_0x4b0b24:_0x2b3539,{'parentMessageId':_0x37b1c6,'systemMessage':_0x3ffaea,'maxModelToken':_0x24f6db,'maxResponseTokens':_0x965b3c,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x526bc9),'imageUrl':_0x18d3b9,'activeModel':_0x46f0dc});let _0x3ceee1=!![];_0x3983a6=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x3fa452,{'maxToken':_0x24f6db,'maxTokenRes':_0x965b3c,'apiKey':_0x1a7a4d,'model':_0x41d923,'prompt':_0x2b3539,'activeModel':_0x46f0dc,'imageUrl':_0x18d3b9,'temperature':_0x2163f0,'proxyUrl':_0x3bad47,'onProgress':_0x5d26c5=>{const _0x33abb8=_0x34ab95;_0x172aca['write'](_0x3ceee1?JSON['stringify'](_0x5d26c5):'\x0a'+JSON[_0x33abb8(0x1c2)](_0x5d26c5)),_0x4dab4a=_0x5d26c5,_0x3ceee1=![];}},this['uploadService']),_0x526570=!![];}if(Number(_0x568889)===0x2){let _0x35a97a=!![];const {context:_0x139062}=await this['nineStore'][_0x34ab95(0x287)](_0x21128f?_0x4b0b24:_0x2b3539,{'parentMessageId':_0xdcef1d,'maxRounds':(0x0,helper_1[_0x34ab95(0x23f)])(_0x526bc9)});_0x3983a6=await(0x0,baidu_1[_0x34ab95(0x243)])(_0x21128f?_0x4b0b24:_0x139062,{'temperature':_0xcec689,'accessToken':_0x51d375,'model':_0x285db9,'onProgress':_0x49ad6b=>{const _0x138fde=_0x34ab95;_0x172aca[_0x138fde(0x1d9)](_0x35a97a?JSON[_0x138fde(0x1c2)](_0x49ad6b):'\x0a'+JSON[_0x138fde(0x1c2)](_0x49ad6b)),_0x35a97a=![],_0x4dab4a=_0x49ad6b;}}),_0x526570=!![];}if(Number(_0x568889)===0x3){let _0x1fde4b=!![];const {context:_0x22985a}=await this['nineStore']['buildMessageFromParentMessageId'](_0x21128f?_0x4b0b24:_0x2b3539,{'parentMessageId':_0xdcef1d,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x526bc9)});_0x3983a6=await(0x0,zhipu_1[_0x34ab95(0x1dd)])(_0x21128f?_0x4b0b24:_0x22985a,{'temperature':_0xcec689,'key':_0x554425,'model':_0x285db9,'onProgress':_0xe26678=>{const _0xce62fd=_0x34ab95;_0x172aca[_0xce62fd(0x1d9)](_0x1fde4b?JSON[_0xce62fd(0x1c2)](_0xe26678):'\x0a'+JSON[_0xce62fd(0x1c2)](_0xe26678)),_0x1fde4b=![],_0x4dab4a=_0xe26678;}}),_0x526570=!![];}const _0x5ca702={'id':this['nineStore']['getUuid'](),'text':_0x2b3539,'role':_0x34ab95(0x1ef),'name':undefined,'usage':null,'imageUrl':_0x18d3b9,'activeModel':_0x46f0dc,'parentMessageId':_0xdcef1d,'conversationId':_0x3983a6===null||_0x3983a6===void 0x0?void 0x0:_0x3983a6[_0x34ab95(0x2a6)]};_0x55e52d={'model':_0x285db9,'parentMessageId':_0xdcef1d},await this[_0x34ab95(0x1fc)][_0x34ab95(0x209)](_0x5ca702);const _0x43b2c1={'id':_0x3983a6['id'],'text':_0x3983a6['text'],'role':_0x34ab95(0x2c4),'name':undefined,'usage':_0x3983a6===null||_0x3983a6===void 0x0?void 0x0:_0x3983a6[_0x34ab95(0x245)],'imageUrl':_0x18d3b9,'parentMessageId':_0x5ca702['id'],'conversationId':_0x3983a6===null||_0x3983a6===void 0x0?void 0x0:_0x3983a6[_0x34ab95(0x2a6)]};await this[_0x34ab95(0x1fc)][_0x34ab95(0x209)](_0x43b2c1),_0x55e52d={'model':_0x285db9,'parentMessageId':_0x5ca702['id']};}else{const {key:_0x78d569,maxToken:_0x147773,maxTokenRes:_0x10877c,proxyResUrl:_0x34e7a7}=await this[_0x34ab95(0x22e)](_0x5be8d9),{parentMessageId:_0xe546e3,completionParams:_0x4f2190,systemMessage:_0x507d15}=_0x4a9730,{model:_0x1df51f,temperature:_0x22775d}=_0x4f2190,{context:_0x4ca51f}=await this[_0x34ab95(0x1fc)]['buildMessageFromParentMessageId'](_0x21128f?_0x4b0b24:_0x2b3539,{'parentMessageId':_0xe546e3,'systemMessage':_0x507d15,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x526bc9)});_0x3983a6=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x4ca51f,{'apiKey':_0x1a7a4d,'model':_0x1df51f,'temperature':_0x22775d,'proxyUrl':_0x34e7a7,'onProgress':null,'prompt':_0x2b3539});}let _0x44d6b3=null,_0x536d80=null;_0x285db9[_0x34ab95(0x241)](_0x34ab95(0x2c1))?_0x44d6b3=((_0x1e5d91=_0x3983a6[_0x34ab95(0x1d6)])===null||_0x1e5d91===void 0x0?void 0x0:_0x1e5d91[_0x34ab95(0x245)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x536d80=await(0x0,helper_1[_0x34ab95(0x234)])(_0x568889,_0x3983a6,_0x55e52d);const {prompt_tokens:_0x397eb4,completion_tokens:_0x379b3f,total_tokens:_0x2f81ad}=_0x285db9[_0x34ab95(0x241)](_0x34ab95(0x2c1))?_0x44d6b3:_0x536d80[_0x34ab95(0x245)];let _0x300eec=_0x582568;_0x1bcab6===!![]&&(_0x300eec=Math[_0x34ab95(0x276)](_0x582568*_0x2f81ad/_0x2d9feb));await this[_0x34ab95(0x1e1)]['deductFromBalance'](_0xec812b[_0x34ab95(0x1ef)]['id'],_0x34ab95(0x24d)+(_0x3dbafd===0x1?0x3:0x4),_0x300eec,_0x2f81ad),await this['modelsService'][_0x34ab95(0x1e2)](_0x55e3fe,_0x2f81ad);const _0x279f38=(0x0,utils_1[_0x34ab95(0x21c)])(_0xec812b);await this['chatLogService'][_0x34ab95(0x24f)]({'appId':_0x40f358,'curIp':_0x279f38,'userId':_0xec812b['user']['id'],'type':balance_constant_1[_0x34ab95(0x1cc)]['CHAT_TYPE'],'prompt':_0x2b3539,'imageUrl':_0x18d3b9,'activeModel':_0x46f0dc,'answer':'','promptTokens':_0x397eb4,'completionTokens':0x0,'totalTokens':_0x2f81ad,'model':_0x285db9,'role':_0x34ab95(0x1ef),'groupId':_0x403f55,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x2b3539})}),await this[_0x34ab95(0x20d)]['saveChatLog']({'appId':_0x40f358,'curIp':_0x279f38,'userId':_0xec812b['user']['id'],'type':balance_constant_1[_0x34ab95(0x1cc)][_0x34ab95(0x27c)],'prompt':_0x2b3539,'imageUrl':_0x3983a6===null||_0x3983a6===void 0x0?void 0x0:_0x3983a6[_0x34ab95(0x20b)],'answer':_0x3983a6['text'],'promptTokens':_0x397eb4,'completionTokens':_0x379b3f,'totalTokens':_0x2f81ad,'model':_0x285db9,'role':_0x34ab95(0x2c4),'groupId':_0x403f55,'requestOptions':JSON[_0x34ab95(0x1c2)]({'options':{'model':_0x285db9,'temperature':_0xcec689},'prompt':_0x2b3539}),'conversationOptions':JSON[_0x34ab95(0x1c2)]({'conversationId':_0x3983a6['conversationId'],'model':_0x285db9,'parentMessageId':_0x3983a6['id'],'temperature':_0xcec689})}),common_1[_0x34ab95(0x1eb)][_0x34ab95(0x22b)](_0x34ab95(0x1c9)+_0xec812b[_0x34ab95(0x1ef)]['id']+'\x20模型名称:\x20'+_0x17d0cd+'-'+_0x46f0dc+_0x34ab95(0x1d3)+_0x2f81ad+',\x20消耗积分：\x20'+_0x300eec,_0x34ab95(0x2ac));const _0x4b1a8a=await this[_0x34ab95(0x1e1)][_0x34ab95(0x1ff)](_0xec812b[_0x34ab95(0x1ef)]['id']);return _0x3983a6['userBanance']=Object[_0x34ab95(0x2b3)]({},_0x4b1a8a),_0x3983a6[_0x34ab95(0x268)]&&(_0x3983a6[_0x34ab95(0x268)]=''),_0x3983a6['is_end']=!![],_0x172aca?_0x172aca[_0x34ab95(0x1d9)]('\x0a'+JSON['stringify'](_0x3983a6)):_0x3983a6['text'];}catch(_0x2368c6){console[_0x34ab95(0x24e)](_0x34ab95(0x28f),_0x1a7a4d,_0x2368c6);const _0x3fc8c6=(_0x2368c6===null||_0x2368c6===void 0x0?void 0x0:_0x2368c6[_0x34ab95(0x218)])||0x190,_0x12455a=((_0x138d37=_0x2368c6===null||_0x2368c6===void 0x0?void 0x0:_0x2368c6[_0x34ab95(0x255)])===null||_0x138d37===void 0x0?void 0x0:_0x138d37[_0x34ab95(0x202)])||(_0x2368c6===null||_0x2368c6===void 0x0?void 0x0:_0x2368c6[_0x34ab95(0x218)])||0x190;console['log'](_0x34ab95(0x217),_0x34ab95(0x263),_0x3fc8c6,_0x34ab95(0x27e),_0x2368c6===null||_0x2368c6===void 0x0?void 0x0:_0x2368c6[_0x34ab95(0x27e)],_0x34ab95(0x23d),(_0x32b14c=_0x2368c6===null||_0x2368c6===void 0x0?void 0x0:_0x2368c6[_0x34ab95(0x255)])===null||_0x32b14c===void 0x0?void 0x0:_0x32b14c['statusText'],_0x34ab95(0x202),(_0x1c1091=_0x2368c6===null||_0x2368c6===void 0x0?void 0x0:_0x2368c6[_0x34ab95(0x255)])===null||_0x1c1091===void 0x0?void 0x0:_0x1c1091[_0x34ab95(0x202)]);if(_0x2368c6['status']&&_0x2368c6[_0x34ab95(0x202)]===0x192){const _0x5b9e23={'message':_0x34ab95(0x219)+_0x2368c6[_0x34ab95(0x27e)],'code':0x192};if(_0x172aca)return _0x172aca[_0x34ab95(0x1d9)](JSON['stringify'](_0x5b9e23));else throw new common_1[(_0x34ab95(0x1e4))](_0x2368c6[_0x34ab95(0x27e)],common_1[_0x34ab95(0x1e6)][_0x34ab95(0x2b0)]);}if(!_0x12455a){if(_0x172aca)return _0x172aca[_0x34ab95(0x1d9)](JSON['stringify']({'message':_0x2368c6['message'],'code':0x1f4}));else throw new common_1['HttpException'](_0x2368c6[_0x34ab95(0x27e)],common_1['HttpStatus']['BAD_REQUEST']);}let _0x5d1ea5=errorMessage_constant_1[_0x34ab95(0x283)][_0x12455a]?errorMessage_constant_1[_0x34ab95(0x283)][_0x12455a]:_0x34ab95(0x21d);(_0x2368c6===null||_0x2368c6===void 0x0?void 0x0:_0x2368c6[_0x34ab95(0x27e)][_0x34ab95(0x241)](_0x34ab95(0x294)))&&Number(_0x568889)===0x1&&(await this['modelsService'][_0x34ab95(0x20c)](_0x55e3fe,_0x34ab95(0x1cf),-0x1),_0x5d1ea5='当前模型key已被封禁');(_0x2368c6===null||_0x2368c6===void 0x0?void 0x0:_0x2368c6[_0x34ab95(0x218)])===0x1ad&&_0x2368c6['message'][_0x34ab95(0x241)](_0x34ab95(0x297))&&Number(_0x568889)===0x1&&(await this['modelsService'][_0x34ab95(0x20c)](_0x55e3fe,_0x34ab95(0x229),-0x3),_0x5d1ea5=_0x34ab95(0x254));(_0x2368c6===null||_0x2368c6===void 0x0?void 0x0:_0x2368c6['statusCode'])===0x1ad&&(_0x2368c6===null||_0x2368c6===void 0x0?void 0x0:_0x2368c6[_0x34ab95(0x299)])==='Too\x20Many\x20Requests'&&(_0x5d1ea5=_0x34ab95(0x274));(_0x2368c6===null||_0x2368c6===void 0x0?void 0x0:_0x2368c6[_0x34ab95(0x218)])===0x191&&_0x2368c6[_0x34ab95(0x27e)][_0x34ab95(0x241)](_0x34ab95(0x2a8))&&Number(_0x568889)===0x1&&(await this[_0x34ab95(0x2c3)][_0x34ab95(0x20c)](_0x55e3fe,'提供了错误的模型秘钥',-0x2),_0x5d1ea5=_0x34ab95(0x256));(_0x2368c6===null||_0x2368c6===void 0x0?void 0x0:_0x2368c6[_0x34ab95(0x218)])===0x194&&_0x2368c6[_0x34ab95(0x27e)]['includes'](_0x34ab95(0x20f))&&Number(_0x568889)===0x1&&(await this['modelsService'][_0x34ab95(0x20c)](_0x55e3fe,'当前模型不是聊天模型',-0x4),_0x5d1ea5=_0x34ab95(0x1cb));_0x3fc8c6===0x190&&console[_0x34ab95(0x24e)]('400\x20error',_0x2368c6,_0x2368c6[_0x34ab95(0x27e)]);const _0x59114f={'message':_0x5d1ea5||_0x34ab95(0x29b),'code':_0x3fc8c6===0x191?0x190:_0x3fc8c6||0x1f4};if(_0x172aca)return _0x172aca[_0x34ab95(0x1d9)](JSON[_0x34ab95(0x1c2)](_0x59114f));else throw new common_1[(_0x34ab95(0x1e4))](_0x59114f[_0x34ab95(0x27e)],common_1[_0x34ab95(0x1e6)][_0x34ab95(0x211)]);}finally{_0x172aca&&_0x172aca[_0x34ab95(0x24a)]();}}async[_0x31df0b(0x2a3)](_0x3f4bc6,_0x56afdc){const _0x38d724=_0x31df0b;var _0x1da4df,_0x191f9f,_0x1e5404,_0x5c5084;await this['badwordsService'][_0x38d724(0x2ad)](_0x3f4bc6[_0x38d724(0x1d4)],_0x56afdc[_0x38d724(0x1ef)]['id']),await this[_0x38d724(0x239)][_0x38d724(0x1c8)](_0x56afdc['user']);const _0x276e22=(_0x3f4bc6===null||_0x3f4bc6===void 0x0?void 0x0:_0x3f4bc6['quality'])==='hd'?0x4:0x2;await this[_0x38d724(0x1e1)][_0x38d724(0x27d)](_0x56afdc,_0x38d724(0x24b),_0x276e22);let _0x435a22=[];const _0x2f5b23=await this['modelsService']['getCurrentModelKeyInfo'](_0x38d724(0x1f1)),_0x367bf6=_0x2f5b23===null||_0x2f5b23===void 0x0?void 0x0:_0x2f5b23['id'],{key:_0x3b5380,proxyResUrl:_0x23bf62}=await this[_0x38d724(0x22e)](_0x2f5b23);common_1[_0x38d724(0x1eb)][_0x38d724(0x24e)](_0x38d724(0x26a)+_0x3f4bc6[_0x38d724(0x1d4)]+_0x38d724(0x247)+_0x3b5380,_0x38d724(0x20e));try{const _0x5ecdde=_0x23bf62+_0x38d724(0x21f),_0x12b8a7=Object[_0x38d724(0x2b3)](Object[_0x38d724(0x2b3)]({},_0x3f4bc6),{'model':_0x38d724(0x1f1)});console['log'](_0x38d724(0x1f5),_0x12b8a7);const _0x100797=await axios_1[_0x38d724(0x29f)][_0x38d724(0x212)](_0x5ecdde,Object[_0x38d724(0x2b3)](Object[_0x38d724(0x2b3)]({},_0x12b8a7),{'response_format':_0x38d724(0x29d)}),{'headers':{'Authorization':_0x38d724(0x224)+_0x3b5380}});_0x435a22=_0x100797[_0x38d724(0x26d)][_0x38d724(0x26d)];const _0x23711b=[];for(const _0x57aadc of _0x435a22){const _0x13b53d=uuid['v4']()[_0x38d724(0x2c0)](0x0,0xa)+_0x38d724(0x266),_0x5efdc7=Buffer[_0x38d724(0x228)](_0x57aadc['b64_json'],_0x38d724(0x281));_0x23711b['push'](this[_0x38d724(0x22a)]['uploadFile']({'filename':_0x13b53d,'buffer':_0x5efdc7}));}const _0x2beb01=await Promise[_0x38d724(0x2ab)](_0x23711b);await this['userBalanceService'][_0x38d724(0x20a)](_0x56afdc[_0x38d724(0x1ef)]['id'],'mjDraw',(_0x12b8a7===null||_0x12b8a7===void 0x0?void 0x0:_0x12b8a7[_0x38d724(0x246)])===_0x38d724(0x1de)?0x2:0x4,_0x276e22);const _0x42487c=(0x0,utils_1[_0x38d724(0x21c)])(_0x56afdc),_0x7fbd80=[],_0x34bc32=await this[_0x38d724(0x22a)][_0x38d724(0x233)](),[_0x796f29,_0x14c6b6]=_0x3f4bc6[_0x38d724(0x21e)][_0x38d724(0x298)]('x');return _0x2beb01[_0x38d724(0x1f2)](_0x3b2ae1=>{const _0x4c64e3=_0x38d724;_0x7fbd80['push'](this[_0x4c64e3(0x20d)][_0x4c64e3(0x24f)]({'curIp':_0x42487c,'userId':_0x56afdc[_0x4c64e3(0x1ef)]['id'],'type':balance_constant_1[_0x4c64e3(0x1cc)][_0x4c64e3(0x2b8)],'prompt':_0x3f4bc6['prompt'],'answer':_0x3b2ae1,'fileInfo':JSON[_0x4c64e3(0x1c2)]({'cosType':_0x34bc32,'width':_0x796f29,'height':_0x14c6b6,'cosUrl':_0x3b2ae1}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x4c64e3(0x1f1)}));}),await Promise[_0x38d724(0x2ab)](_0x7fbd80),_0x2beb01;}catch(_0x595bc5){const _0x55b681=((_0x1da4df=_0x595bc5===null||_0x595bc5===void 0x0?void 0x0:_0x595bc5[_0x38d724(0x255)])===null||_0x1da4df===void 0x0?void 0x0:_0x1da4df['status'])||0x1f4;console['log'](_0x38d724(0x1f4),JSON[_0x38d724(0x1c2)](_0x595bc5),_0x3b5380,_0x55b681);const _0x1758d2=(_0x5c5084=(_0x1e5404=(_0x191f9f=_0x595bc5===null||_0x595bc5===void 0x0?void 0x0:_0x595bc5[_0x38d724(0x255)])===null||_0x191f9f===void 0x0?void 0x0:_0x191f9f['data'])===null||_0x1e5404===void 0x0?void 0x0:_0x1e5404[_0x38d724(0x2b9)])===null||_0x5c5084===void 0x0?void 0x0:_0x5c5084[_0x38d724(0x27e)];if(_0x55b681===0x1ad)throw new common_1[(_0x38d724(0x1e4))](_0x38d724(0x2b5),common_1[_0x38d724(0x1e6)][_0x38d724(0x211)]);if(_0x55b681===0x190&&_0x1758d2[_0x38d724(0x241)](_0x38d724(0x230)))throw new common_1[(_0x38d724(0x1e4))](_0x38d724(0x289),common_1[_0x38d724(0x1e6)][_0x38d724(0x211)]);if(_0x55b681===0x190&&_0x1758d2['includes'](_0x38d724(0x267))){await this[_0x38d724(0x2c3)][_0x38d724(0x20c)](_0x367bf6,_0x38d724(0x1cf),-0x1);throw new common_1[(_0x38d724(0x1e4))](_0x38d724(0x23b),common_1[_0x38d724(0x1e6)][_0x38d724(0x211)]);}if(_0x55b681===0x1f4)throw new common_1['HttpException']('绘制图片失败，请检查你的提示词是否有非法描述！',common_1[_0x38d724(0x1e6)]['BAD_REQUEST']);if(_0x55b681===0x191)throw new common_1[(_0x38d724(0x1e4))](_0x38d724(0x2b4),common_1[_0x38d724(0x1e6)][_0x38d724(0x211)]);throw new common_1[(_0x38d724(0x1e4))](_0x38d724(0x1e7),common_1[_0x38d724(0x1e6)]['BAD_REQUEST']);}}async['getAllKeyList'](){const _0x2a3005=_0x31df0b,_0x13512e=await this['gptKeysEntity'][_0x2a3005(0x291)]({'where':{'status':0x1},'select':['id',_0x2a3005(0x270),'weight',_0x2a3005(0x24d),'maxModelTokens',_0x2a3005(0x208),'openaiProxyUrl',_0x2a3005(0x2c5)]}),_0xf9c1cf=_0x13512e[_0x2a3005(0x1e0)](_0x4b6358=>_0x4b6358[_0x2a3005(0x24d)]['includes'](_0x2a3005(0x285))),_0x387d2c=_0x13512e[_0x2a3005(0x1e0)](_0x53692e=>_0x53692e['model']['includes'](_0x2a3005(0x213)));this[_0x2a3005(0x29e)]={'list3':_0xf9c1cf,'list4':_0x387d2c};}async[_0x31df0b(0x226)](_0x4bf1e4){const _0x55cd8a=_0x31df0b,_0x309de0=await this[_0x55cd8a(0x28c)][_0x55cd8a(0x290)]([_0x55cd8a(0x252)]);return(_0x4bf1e4===null||_0x4bf1e4===void 0x0?void 0x0:_0x4bf1e4[_0x55cd8a(0x249)])||_0x309de0||_0x55cd8a(0x22f);}async[_0x31df0b(0x22e)](_0x5f110e){const _0x3642e6=_0x31df0b,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x3642e6(0x28c)][_0x3642e6(0x290)]([_0x3642e6(0x264),'openaiModel3MaxTokensRes',_0x3642e6(0x29c),_0x3642e6(0x25e),_0x3642e6(0x28a),'openaiModel4MaxTokensRes',_0x3642e6(0x220),_0x3642e6(0x251),_0x3642e6(0x252)]);let _0x3ee908=null,_0x4a6d82=null,_0x4bc0ba=null,{model:_0x3ad563,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x39747e}=_0x5f110e;return _0x3ad563[_0x3642e6(0x25b)]()['includes']('gpt-4')&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x4a6d82>=0x1000&&(maxModelTokens=0x1000),_0x3ee908=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x4a6d82=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x3ad563['toLowerCase']()[_0x3642e6(0x241)]('32k')&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x4a6d82>=0x4000&&(maxModelTokens=0x4000),_0x3ee908=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x4a6d82=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x3ad563[_0x3642e6(0x25b)]()['includes']('1106')&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x4a6d82>=0x1000&&(maxModelTokens=0x1000),_0x3ee908=maxModelTokens||0x3ffc,_0x4a6d82=maxResponseTokens||0x1000)),_0x3ad563['toLowerCase']()[_0x3642e6(0x241)](_0x3642e6(0x285))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x4a6d82>=0x7d0&&(maxModelTokens=0x7d0),_0x3ee908=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x4a6d82=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x3ad563[_0x3642e6(0x25b)]()[_0x3642e6(0x241)]('16k')&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x4a6d82>=0x2000&&(maxModelTokens=0x2000),_0x3ee908=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x4a6d82=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x3ad563[_0x3642e6(0x25b)]()[_0x3642e6(0x241)](_0x3642e6(0x27b))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x4a6d82>=0x1000&&(maxModelTokens=0x1000),_0x3ee908=maxModelTokens||0x4000,_0x4a6d82=maxResponseTokens||0x1000)),_0x4bc0ba=proxyUrl||openaiBaseUrl||'https://api.openai.com',_0x4a6d82>=_0x3ee908&&(_0x4a6d82=Math['floor'](_0x3ee908/0x2)),{'key':_0x39747e,'maxToken':_0x3ee908,'maxTokenRes':_0x4a6d82,'proxyResUrl':_0x4bc0ba};}async['setChatBoxType'](_0x43e2ee,_0x160358){const _0x3f811f=_0x31df0b;try{const {name:_0x1fe23a,icon:_0x44f2ad,order:_0x2aa618,id:_0x241747,status:_0x2a2c08}=_0x160358;return _0x241747?await this[_0x3f811f(0x1ec)][_0x3f811f(0x259)]({'id':_0x241747},{'name':_0x1fe23a,'icon':_0x44f2ad,'order':_0x2aa618,'status':_0x2a2c08}):await this[_0x3f811f(0x1ec)][_0x3f811f(0x2ba)]({'name':_0x1fe23a,'icon':_0x44f2ad,'order':_0x2aa618,'status':_0x2a2c08});}catch(_0x1955fb){console[_0x3f811f(0x24e)](_0x3f811f(0x240),_0x1955fb);}}async['delChatBoxType'](_0x3e6c20,_0x28e641){const _0x5cf189=_0x31df0b,{id:_0x5b8618}=_0x28e641;if(!_0x5b8618)throw new common_1[(_0x5cf189(0x1e4))](_0x5cf189(0x236),common_1[_0x5cf189(0x1e6)][_0x5cf189(0x211)]);const _0x5f44c9=await this['chatBoxEntity'][_0x5cf189(0x2ae)]({'where':{'typeId':_0x5b8618}});if(_0x5f44c9)throw new common_1[(_0x5cf189(0x1e4))]('当前分类下有未处理数据不可移除！',common_1['HttpStatus']['BAD_REQUEST']);return await this[_0x5cf189(0x1ec)][_0x5cf189(0x258)]({'id':_0x5b8618});}async[_0x31df0b(0x222)](){const _0x29708a=_0x31df0b;return await this[_0x29708a(0x1ec)][_0x29708a(0x291)]({'order':{'order':_0x29708a(0x273)}});}async['setChatBox'](_0x37d6fb,_0x3c72e8){const _0x13322f=_0x31df0b,{title:_0x2b9d85,prompt:_0x2e5282,appId:_0xe495fd,order:_0x4d9bdb,status:_0x556696,typeId:_0xc2767b,id:_0xe5cb67,url:_0xcc8370}=_0x3c72e8;if(!_0xc2767b)throw new common_1[(_0x13322f(0x1e4))](_0x13322f(0x21b),common_1[_0x13322f(0x1e6)][_0x13322f(0x211)]);try{const _0x5281d7={'title':_0x2b9d85,'order':_0x4d9bdb,'status':_0x556696,'typeId':_0xc2767b,'url':_0xcc8370};return _0x5281d7[_0x13322f(0x27f)]=_0xe495fd||0x0,_0x5281d7['prompt']=_0x2e5282||'',_0xe5cb67?await this[_0x13322f(0x272)][_0x13322f(0x259)]({'id':_0xe5cb67},_0x5281d7):await this['chatBoxEntity'][_0x13322f(0x2ba)](_0x5281d7);}catch(_0x2fe2eb){console[_0x13322f(0x24e)](_0x13322f(0x240),_0x2fe2eb);}}async[_0x31df0b(0x1ea)](_0x5d57df,_0x35fa71){const _0x42ee0a=_0x31df0b,{id:_0x2d1c1b}=_0x35fa71;if(!_0x2d1c1b)throw new common_1[(_0x42ee0a(0x1e4))]('非法操作！',common_1['HttpStatus'][_0x42ee0a(0x211)]);return await this[_0x42ee0a(0x272)][_0x42ee0a(0x258)]({'id':_0x2d1c1b});}async[_0x31df0b(0x269)](){const _0x593c85=_0x31df0b,_0x5525d2=await this[_0x593c85(0x272)][_0x593c85(0x291)]({'order':{'order':_0x593c85(0x273)}}),_0xc50b12=[...new Set(_0x5525d2['map'](_0x1eab28=>_0x1eab28[_0x593c85(0x25f)]))],_0x195dcb=[...new Set(_0x5525d2['map'](_0xdfbbb3=>_0xdfbbb3['appId']))],_0xbc1f11=await this[_0x593c85(0x1ec)][_0x593c85(0x291)]({'where':{'id':(0x0,typeorm_1['In'])(_0xc50b12)}}),_0x3c4653=await this[_0x593c85(0x1ce)][_0x593c85(0x291)]({'where':{'id':(0x0,typeorm_1['In'])(_0x195dcb)}});return _0x5525d2[_0x593c85(0x23a)](_0x5adf01=>{const _0x18c39f=_0x593c85,{typeId:_0x5a7989,appId:_0x4e12dc}=_0x5adf01;return _0x5adf01[_0x18c39f(0x206)]=_0xbc1f11['find'](_0x32158d=>_0x32158d['id']===_0x5a7989),_0x5adf01[_0x18c39f(0x1f8)]=_0x3c4653['find'](_0x449134=>_0x449134['id']===_0x4e12dc),_0x5adf01;});}async[_0x31df0b(0x257)](){const _0x335c6a=_0x31df0b,_0x2c2270=await this[_0x335c6a(0x1ec)]['find']({'order':{'order':_0x335c6a(0x273)},'where':{'status':!![]}}),_0x532a1e=await this[_0x335c6a(0x272)][_0x335c6a(0x291)]({'where':{'status':!![]}}),_0x4d434f=[...new Set(_0x532a1e[_0x335c6a(0x23a)](_0x351fd2=>_0x351fd2[_0x335c6a(0x27f)]))],_0x5b0ebf=await this[_0x335c6a(0x1ce)][_0x335c6a(0x291)]({'where':{'id':(0x0,typeorm_1['In'])(_0x4d434f)}});return _0x532a1e[_0x335c6a(0x1f2)](_0x2ecbfc=>{const _0x5b92e0=_0x335c6a,_0x3645e9=_0x5b0ebf[_0x5b92e0(0x291)](_0x1b01c8=>_0x1b01c8['id']===_0x2ecbfc[_0x5b92e0(0x27f)]);return _0x2ecbfc[_0x5b92e0(0x242)]=_0x3645e9===null||_0x3645e9===void 0x0?void 0x0:_0x3645e9[_0x5b92e0(0x242)],_0x2ecbfc;}),_0x2c2270[_0x335c6a(0x23a)](_0x1f7796=>{const _0x255849=_0x335c6a;return _0x1f7796['childList']=_0x532a1e[_0x255849(0x1e0)](_0x4bff4c=>_0x4bff4c[_0x255849(0x25f)]===_0x1f7796['id']&&_0x4bff4c[_0x255849(0x202)]),_0x1f7796;});}async[_0x31df0b(0x23c)](_0x40b1f2,_0x4eef53){const _0x2c8253=_0x31df0b;try{const {name:_0x572fcc,icon:_0x3e1802,order:_0x57963f,id:_0x3a6daa,status:_0x1ef53b}=_0x4eef53;return _0x3a6daa?await this[_0x2c8253(0x21a)][_0x2c8253(0x259)]({'id':_0x3a6daa},{'name':_0x572fcc,'icon':_0x3e1802,'order':_0x57963f,'status':_0x1ef53b}):await this[_0x2c8253(0x21a)]['save']({'name':_0x572fcc,'icon':_0x3e1802,'order':_0x57963f,'status':_0x1ef53b});}catch(_0x3ce534){console[_0x2c8253(0x24e)](_0x2c8253(0x240),_0x3ce534);}}async[_0x31df0b(0x244)](_0x1c08cd,_0x22619d){const _0xb04302=_0x31df0b,{id:_0x209759}=_0x22619d;if(!_0x209759)throw new common_1[(_0xb04302(0x1e4))](_0xb04302(0x236),common_1[_0xb04302(0x1e6)][_0xb04302(0x211)]);const _0x16203f=await this[_0xb04302(0x272)][_0xb04302(0x2ae)]({'where':{'typeId':_0x209759}});if(_0x16203f)throw new common_1[(_0xb04302(0x1e4))]('当前分类下有未处理数据不可移除！',common_1['HttpStatus'][_0xb04302(0x211)]);return await this[_0xb04302(0x21a)][_0xb04302(0x258)]({'id':_0x209759});}async['queryChatPreType'](){const _0x13507a=_0x31df0b;return await this['chatPreTypeEntity'][_0x13507a(0x291)]({'order':{'order':_0x13507a(0x273)}});}async[_0x31df0b(0x22c)](_0xb58b4f,_0x4656dd){const _0x4258b3=_0x31df0b,{title:_0x5cceb9,prompt:_0x281287,appId:_0x80ad5d,order:_0x3d030e,status:_0x174112,typeId:_0xdced3,id:_0x46dec4,url:_0x2de709}=_0x4656dd;if(!_0xdced3)throw new common_1['HttpException'](_0x4258b3(0x21b),common_1['HttpStatus'][_0x4258b3(0x211)]);try{const _0x1dd6a8={'title':_0x5cceb9,'prompt':_0x281287,'order':_0x3d030e,'status':_0x174112,'typeId':_0xdced3,'url':_0x2de709};return _0x46dec4?await this[_0x4258b3(0x2b7)][_0x4258b3(0x259)]({'id':_0x46dec4},_0x1dd6a8):await this[_0x4258b3(0x2b7)][_0x4258b3(0x2ba)](_0x1dd6a8);}catch(_0x4b9e5b){console[_0x4258b3(0x24e)]('error:\x20',_0x4b9e5b);}}async[_0x31df0b(0x1df)](_0x5cbe7c,_0x2ebf00){const _0xc80c91=_0x31df0b,{id:_0x4ee24d}=_0x2ebf00;if(!_0x4ee24d)throw new common_1[(_0xc80c91(0x1e4))]('非法操作！',common_1[_0xc80c91(0x1e6)][_0xc80c91(0x211)]);return await this[_0xc80c91(0x2b7)][_0xc80c91(0x258)]({'id':_0x4ee24d});}async[_0x31df0b(0x227)](){const _0x5ca195=_0x31df0b,_0x2d4f3c=await this[_0x5ca195(0x2b7)][_0x5ca195(0x291)]({'order':{'order':_0x5ca195(0x273)}}),_0x48484c=[...new Set(_0x2d4f3c[_0x5ca195(0x23a)](_0x166960=>_0x166960[_0x5ca195(0x25f)]))],_0x1684ba=await this[_0x5ca195(0x21a)][_0x5ca195(0x291)]({'where':{'id':(0x0,typeorm_1['In'])(_0x48484c)}});return _0x2d4f3c[_0x5ca195(0x23a)](_0x55c2ae=>{const _0xe5c182=_0x5ca195,{typeId:_0x10addc,appId:_0x2436c1}=_0x55c2ae;return _0x55c2ae['typeInfo']=_0x1684ba[_0xe5c182(0x291)](_0x2a5d04=>_0x2a5d04['id']===_0x10addc),_0x55c2ae;});}async['queryChatPreList'](){const _0x4b334a=_0x31df0b,_0x491a27=await this[_0x4b334a(0x21a)][_0x4b334a(0x291)]({'order':{'order':'DESC'},'where':{'status':!![]}}),_0x1ffd70=await this['chatPreEntity'][_0x4b334a(0x291)]({'where':{'status':!![]}});return _0x491a27[_0x4b334a(0x23a)](_0x3dd9c9=>{const _0x47d944=_0x4b334a;return _0x3dd9c9['childList']=_0x1ffd70['filter'](_0x406b58=>_0x406b58[_0x47d944(0x25f)]===_0x3dd9c9['id']&&_0x406b58['status']),_0x3dd9c9;});}async[_0x31df0b(0x28b)](_0x117bf0,_0x38c176,_0x39fb10){const _0x43891c=_0x31df0b;let _0x25d1a7=0x1000,_0x4ab77a=0x800;return _0x117bf0[_0x43891c(0x25b)]()[_0x43891c(0x241)](_0x43891c(0x213))&&(_0x25d1a7=_0x38c176>=0x2004?0x2004:_0x38c176,_0x4ab77a=_0x39fb10>=0x1000?0x1000:_0x39fb10,_0x117bf0[_0x43891c(0x25b)]()[_0x43891c(0x241)](_0x43891c(0x26c))&&(_0x25d1a7=_0x38c176>=0x8000?0x8000:_0x38c176,_0x4ab77a=_0x39fb10>=0x3e80?0x3e80:_0x39fb10),(_0x117bf0[_0x43891c(0x25b)]()[_0x43891c(0x241)](_0x43891c(0x2a9))||_0x117bf0[_0x43891c(0x25b)]()[_0x43891c(0x241)](_0x43891c(0x1f0)))&&(_0x25d1a7=_0x38c176>=0x1f400?0x1f400:_0x38c176,_0x4ab77a=_0x39fb10>=0x1000?0x1000:_0x39fb10)),_0x117bf0[_0x43891c(0x25b)]()[_0x43891c(0x241)](_0x43891c(0x285))&&(_0x25d1a7=_0x38c176>=0x1000?0x1000:_0x38c176,_0x4ab77a=_0x39fb10>=0x800?0x800:_0x39fb10,_0x117bf0[_0x43891c(0x25b)]()[_0x43891c(0x241)](_0x43891c(0x2a1))&&(_0x25d1a7=_0x38c176>=0x4000?0x4000:_0x38c176,_0x4ab77a=_0x39fb10>=0x1f40?0x1f40:_0x39fb10),_0x117bf0['toLowerCase']()[_0x43891c(0x241)](_0x43891c(0x27b))&&(_0x25d1a7=_0x38c176>=0x4000?0x4000:_0x38c176,_0x4ab77a=_0x39fb10>=0x1f40?0x1f40:_0x39fb10)),{'maxToken':_0x25d1a7,'maxRes':_0x4ab77a};}};function _0x3856(){const _0x39db51=['appInfo','./../user/user.service','./gptkeys.entity','Content-type','nineStore','typeorm','getTokenCount','queryUserBalance','3443016ouyFdO','REDIS_USER','status','../userBalance/userBalance.service','../fanyi/fanyi.service','../badwords/badwords.service','typeInfo','../../common/utils','maxResponseTokens','setData','deductFromBalance','imageUrl','lockKey','chatLogService','DrawService','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','30cIeHao','BAD_REQUEST','post','gpt-4','getRandomDrawKey','52235SUJuKz','getRequestParams','chat-error-detail\x20\x20<----------------------------------------->','statusCode','Catch\x20Error\x20','chatPreTypeEntity','缺失必要参数！','getClientIp','服务异常、请重新试试吧！！！','size','/v1/images/generations','openaiModel4MaxTokens32k','redis://','queryChatBoxType','./chatBoxType.entity','Bearer\x20','importDynamic','getModelProxyUrl','queryChatPre','from','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','uploadService','debug','setChatPre','../app/app.entity','formatModelToken','https://api.openai.com','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','../../common/constants/errorMessage.constant','486647XnedCK','getUploadType','unifiedFormattingResponse','function','非法操作！','./chatPreType.entity','abort','userService','map','当前Key余额已不足、请重新再试一次吧！','setChatPreType','statusText:','ChatBoxTypeEntity','addOneIfOdd','error:\x20','includes','coverImg','sendMessageFromBaidu','delChatPreType','usage','quality',',\x20key\x20===>\x20','ChatPreEntity','proxyUrl','end','mjDraw','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','model','log','saveChatLog','ConfigService','openaiModel4MaxTokens32kRes','openaiBaseUrl','REDIS_HOST','当前模型key余额已耗尽','response','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','queryChatBoxFrontend','delete','update','./baidu','toLowerCase','checkAutoReply','autoreplyService','openaiModel3MaxTokens16kRes','typeId','metadata','Repository','80532JNzZNE','code:\x20','openaiModel3MaxTokens','defineProperty','.png','Billing\x20hard\x20limit\x20has\x20been\x20reached','result','queryChatBox','draw\x20paompt\x20info\x20<==**==>\x20','toISOString','32k','data','UploadService','env','key','__esModule','chatBoxEntity','DESC','当前模型调用过于频繁、请重新试试吧！','systemPreMessage','ceil','gptKeysEntity','@nestjs/typeorm','ChatGroupService','nestjs-config','1106','CHAT_TYPE','validateBalance','message','appId','application/octet-stream;\x20charset=utf-8','base64','./chatPre.entity','OpenAiErrorCodeMessage','@keyv/redis','gpt-3','./openai','buildMessageFromParentMessageId','modelInfo','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','openaiModel4MaxTokens','getMaxTokenFromModelWithOpenAi','globalConfigService','chatgpt-ai-web','BadwordsService','chat-error\x20<----------------------------------------->','getConfigs','find','object','../chatGroup/chatGroup.service','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','REDIS_PASSWORD','InjectRepository','billing','split','statusText','sendMessageFromOpenAi','Please\x20check\x20the\x20back-end\x20console','openaiModel3MaxTokens16k','b64_json','keyPool','default','badwordsService','16k','chatProcess','draw','\x0a\x20Current\x20date:\x20','preset','conversationId','328402JyqUWW','Incorrect\x20API\x20key\x20provided','gpt-4-1106','length','all','ChatgptService','checkBadWords','count','chatSyncFree','PAYMENT_REQUIRED','findOne','design:paramtypes','assign','绘制图片失败，此次绘画被拒绝了！','当前请求已过载、请稍等会儿再试试吧！','ChatLogService','chatPreEntity','PAINT_TYPE','error','save','../autoreply/autoreply.service','__metadata','removeSpecialCharacters','./store','UserBalanceService','slice','dall','UserService','modelsService','assistant','openaiTimeoutMs','Injectable','stringify','config','REDIS_PORT','632172iHNuAb','NineStore','text','checkUserStatus','用户ID:\x20','model3','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','DeductionKey','16317dmbzgh','appEntity','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','chat','compileNetwork','./helper',',\x20消耗token:\x20','prompt','./chatBox.entity','detail','whiteListUser','../models/models.service','write','../globalConfig/config.entity','ConfigEntity','decorate','sendMessageFromZhipu','standard','delChatPre','filter','userBalanceService','saveUseLog','GptKeysEntity','HttpException','FanyiService','HttpStatus','绘制图片失败，请稍后试试吧！','../globalConfig/globalConfig.service','axios','delChatBox','Logger','chatBoxTypeEntity','setHeader','ModelsService','user','gpt-4-vision-preview','dall-e-3','forEach','getBaseConfig','openai-draw\x20error:\x20','dall-e\x20draw\x20params:\x20','parse','configService'];_0x3856=function(){return _0x39db51;};return _0x3856();}function _0x3ec1(_0x13597c,_0x1c1ec4){const _0x38565c=_0x3856();return _0x3ec1=function(_0x3ec175,_0x7a30f5){_0x3ec175=_0x3ec175-0x1c1;let _0x46479e=_0x38565c[_0x3ec175];return _0x46479e;},_0x3ec1(_0x13597c,_0x1c1ec4);}ChatgptService=__decorate([(0x0,common_1[_0x31df0b(0x1c1)])(),__param(0x0,(0x0,typeorm_2[_0x31df0b(0x296)])(gptkeys_entity_1[_0x31df0b(0x1e3)])),__param(0x1,(0x0,typeorm_2[_0x31df0b(0x296)])(config_entity_1[_0x31df0b(0x1db)])),__param(0x2,(0x0,typeorm_2['InjectRepository'])(chatBoxType_entity_1[_0x31df0b(0x23e)])),__param(0x3,(0x0,typeorm_2['InjectRepository'])(chatBox_entity_1['ChatBoxEntity'])),__param(0x4,(0x0,typeorm_2[_0x31df0b(0x296)])(app_entity_1['AppEntity'])),__param(0x5,(0x0,typeorm_2[_0x31df0b(0x296)])(chatPreType_entity_1['ChatPreTypeEntity'])),__param(0x6,(0x0,typeorm_2[_0x31df0b(0x296)])(chatPre_entity_1[_0x31df0b(0x248)])),__metadata(_0x31df0b(0x2b2),[typeorm_1[_0x31df0b(0x261)],typeorm_1[_0x31df0b(0x261)],typeorm_1[_0x31df0b(0x261)],typeorm_1['Repository'],typeorm_1[_0x31df0b(0x261)],typeorm_1['Repository'],typeorm_1[_0x31df0b(0x261)],nestjs_config_1[_0x31df0b(0x250)],userBalance_service_1[_0x31df0b(0x2bf)],chatLog_service_1[_0x31df0b(0x2b6)],user_service_1[_0x31df0b(0x2c2)],upload_service_1[_0x31df0b(0x26e)],badwords_service_1[_0x31df0b(0x28e)],autoreply_service_1['AutoreplyService'],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0x31df0b(0x1e5)],chatGroup_service_1[_0x31df0b(0x279)],models_service_1[_0x31df0b(0x1ee)]])],ChatgptService),exports['ChatgptService']=ChatgptService;