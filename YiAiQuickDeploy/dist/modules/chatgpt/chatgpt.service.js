'use strict';function _0x5d4f(_0x1626de,_0x1e0ca8){const _0x46134b=_0x4613();return _0x5d4f=function(_0x5d4fed,_0x33943e){_0x5d4fed=_0x5d4fed-0xe1;let _0x22c821=_0x46134b[_0x5d4fed];return _0x22c821;},_0x5d4f(_0x1626de,_0x1e0ca8);}const _0x2f57d0=_0x5d4f;(function(_0x55cae7,_0x3f952f){const _0x575101=_0x5d4f,_0x13e3a8=_0x55cae7();while(!![]){try{const _0x4c3180=parseInt(_0x575101(0x179))/0x1+parseInt(_0x575101(0x1c5))/0x2+parseInt(_0x575101(0x15e))/0x3+-parseInt(_0x575101(0x1cf))/0x4*(parseInt(_0x575101(0x104))/0x5)+-parseInt(_0x575101(0x1db))/0x6+parseInt(_0x575101(0xec))/0x7*(parseInt(_0x575101(0x154))/0x8)+parseInt(_0x575101(0x16f))/0x9;if(_0x4c3180===_0x3f952f)break;else _0x13e3a8['push'](_0x13e3a8['shift']());}catch(_0x174860){_0x13e3a8['push'](_0x13e3a8['shift']());}}}(_0x4613,0xce9c8));var __decorate=this&&this['__decorate']||function(_0x493cb9,_0x45e59b,_0x4a36b0,_0x55a411){const _0x50527a=_0x5d4f;var _0x495735=arguments['length'],_0x14f020=_0x495735<0x3?_0x45e59b:_0x55a411===null?_0x55a411=Object[_0x50527a(0x12b)](_0x45e59b,_0x4a36b0):_0x55a411,_0x32a2c0;if(typeof Reflect===_0x50527a(0x16b)&&typeof Reflect['decorate']==='function')_0x14f020=Reflect[_0x50527a(0xf7)](_0x493cb9,_0x45e59b,_0x4a36b0,_0x55a411);else{for(var _0x38dd41=_0x493cb9[_0x50527a(0x18e)]-0x1;_0x38dd41>=0x0;_0x38dd41--)if(_0x32a2c0=_0x493cb9[_0x38dd41])_0x14f020=(_0x495735<0x3?_0x32a2c0(_0x14f020):_0x495735>0x3?_0x32a2c0(_0x45e59b,_0x4a36b0,_0x14f020):_0x32a2c0(_0x45e59b,_0x4a36b0))||_0x14f020;}return _0x495735>0x3&&_0x14f020&&Object['defineProperty'](_0x45e59b,_0x4a36b0,_0x14f020),_0x14f020;},__metadata=this&&this['__metadata']||function(_0x4662b0,_0x1a0249){const _0x168b8=_0x5d4f;if(typeof Reflect===_0x168b8(0x16b)&&typeof Reflect[_0x168b8(0xf3)]===_0x168b8(0x131))return Reflect['metadata'](_0x4662b0,_0x1a0249);},__param=this&&this[_0x2f57d0(0x16d)]||function(_0x28451a,_0x5d34c6){return function(_0x303e96,_0xac6c33){_0x5d34c6(_0x303e96,_0xac6c33,_0x28451a);};};Object[_0x2f57d0(0x114)](exports,_0x2f57d0(0x160),{'value':!![]}),exports[_0x2f57d0(0x178)]=void 0x0;const upload_service_1=require(_0x2f57d0(0x1a2)),user_service_1=require(_0x2f57d0(0x13d)),nestjs_config_1=require('nestjs-config'),common_1=require('@nestjs/common'),errorMessage_constant_1=require('../../common/constants/errorMessage.constant'),utils_1=require(_0x2f57d0(0x137)),axios_1=require('axios'),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require(_0x2f57d0(0xf9)),chatLog_service_1=require(_0x2f57d0(0x1d5)),uuid=require(_0x2f57d0(0x1c2)),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require(_0x2f57d0(0x1bc)),typeorm_2=require(_0x2f57d0(0x190)),badwords_service_1=require(_0x2f57d0(0x1d2)),autoreply_service_1=require(_0x2f57d0(0xfb)),gptkeys_entity_1=require(_0x2f57d0(0x1ab)),globalConfig_service_1=require(_0x2f57d0(0x194)),fanyi_service_1=require(_0x2f57d0(0xfa)),app_entity_1=require(_0x2f57d0(0x1cc)),chatGroup_service_1=require(_0x2f57d0(0x1b1)),models_service_1=require(_0x2f57d0(0x14f)),baidu_1=require(_0x2f57d0(0xe1)),helper_1=require(_0x2f57d0(0x13f)),store_1=require(_0x2f57d0(0x193)),zhipu_1=require(_0x2f57d0(0x1d7)),openai_1=require(_0x2f57d0(0x17e)),chatBoxType_entity_1=require(_0x2f57d0(0x1bf)),chatBox_entity_1=require(_0x2f57d0(0xea)),chatPre_entity_1=require(_0x2f57d0(0x172)),chatPreType_entity_1=require(_0x2f57d0(0x108));let ChatgptService=class ChatgptService{constructor(_0x28c22b,_0x159938,_0x537564,_0x208b7c,_0x3a357e,_0x5f11a2,_0x2bc1a6,_0x454122,_0x4829da,_0x2a8f02,_0x2574af,_0x12ef42,_0x36c648,_0x548b36,_0x3cc5cc,_0x4dc890,_0x2c7f3a,_0x5a33f6){const _0x449600=_0x2f57d0;this[_0x449600(0xe5)]=_0x28c22b,this[_0x449600(0x12e)]=_0x159938,this[_0x449600(0x11c)]=_0x537564,this[_0x449600(0x1c7)]=_0x208b7c,this['appEntity']=_0x3a357e,this[_0x449600(0x187)]=_0x5f11a2,this['chatPreEntity']=_0x2bc1a6,this['configService']=_0x454122,this[_0x449600(0x121)]=_0x4829da,this['chatLogService']=_0x2a8f02,this[_0x449600(0xef)]=_0x2574af,this[_0x449600(0x1c8)]=_0x12ef42,this[_0x449600(0x1a3)]=_0x36c648,this['autoreplyService']=_0x548b36,this[_0x449600(0x156)]=_0x3cc5cc,this['fanyiService']=_0x4dc890,this[_0x449600(0x14b)]=_0x2c7f3a,this['modelsService']=_0x5a33f6,this[_0x449600(0x196)]=null,this['whiteListUser']=[],this[_0x449600(0x157)]={'list3':[],'list4':[]};}async[_0x2f57d0(0x1b6)](){const _0x234fe7=_0x2f57d0;let _0x1bc055=await(0x0,utils_1[_0x234fe7(0xe3)])(_0x234fe7(0x182)),_0x1becb5=await(0x0,utils_1[_0x234fe7(0xe3)])(_0x234fe7(0x181)),_0x1eddc6=await(0x0,utils_1['importDynamic'])('keyv');_0x1bc055=(_0x1bc055===null||_0x1bc055===void 0x0?void 0x0:_0x1bc055[_0x234fe7(0x147)])?_0x1bc055['default']:_0x1bc055,_0x1becb5=(_0x1becb5===null||_0x1becb5===void 0x0?void 0x0:_0x1becb5[_0x234fe7(0x147)])?_0x1becb5[_0x234fe7(0x147)]:_0x1becb5,_0x1eddc6=(_0x1eddc6===null||_0x1eddc6===void 0x0?void 0x0:_0x1eddc6['default'])?_0x1eddc6['default']:_0x1eddc6;const {ChatGPTAPI:_0x1a7647,ChatGPTError:_0x5839ec,ChatGPTUnofficialProxyAPI:_0x23ba37}=_0x1bc055,_0x26b9c1=+process[_0x234fe7(0x135)][_0x234fe7(0x1d8)],_0xa068e7=process[_0x234fe7(0x135)][_0x234fe7(0x132)],_0x25bbee=process[_0x234fe7(0x135)][_0x234fe7(0x198)],_0x4e0374=process[_0x234fe7(0x135)][_0x234fe7(0x151)],_0x4aab7d=_0x234fe7(0x123)+(_0x4e0374||'')+':'+(_0x25bbee||'')+'@'+_0xa068e7+':'+_0x26b9c1,_0x4c4501=new _0x1becb5(_0x4aab7d),_0xb0cea8=new _0x1eddc6({'store':_0x4c4501,'namespace':_0x234fe7(0x1e1)});this[_0x234fe7(0x196)]=new store_1[(_0x234fe7(0x11a))]({'store':_0xb0cea8,'namespace':'chat'});}async[_0x2f57d0(0x112)](_0x4c85af,_0x2564b5,_0x5377db,_0x28bb14=null){const _0x4a4c8f=_0x2f57d0;var _0xa03a22;!_0x28bb14&&(_0x28bb14=(_0xa03a22=await this[_0x4a4c8f(0x12a)]['getBaseConfig']())===null||_0xa03a22===void 0x0?void 0x0:_0xa03a22['modelInfo']);const {timeout:timeout=0x3c}=_0x5377db,{topN:_0x38aa45,model:_0x3ddf9a}=_0x28bb14,{parentMessageId:parentMessageId=0x0}=_0x4c85af,_0x2b8eac=await this[_0x4a4c8f(0x156)][_0x4a4c8f(0xeb)](['openaiTimeoutMs']),_0xf3e078=timeout*0x3e8||_0x2b8eac||0x64*0x3e8,_0x86f156={'parentMessageId':parentMessageId,'timeoutMs':+_0xf3e078,'completionParams':{'model':_0x3ddf9a,'temperature':_0x38aa45}};return _0x2564b5&&(_0x86f156[_0x4a4c8f(0x1b8)]=_0x2564b5),_0x86f156;}async['chatSyncFree'](_0x46fe97){const _0x1c7804=_0x2f57d0,_0x221c3c=await this[_0x1c7804(0x12a)][_0x1c7804(0x19f)](),_0x5de174=await this[_0x1c7804(0x156)][_0x1c7804(0xeb)]([_0x1c7804(0x1e7)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0xb081c,model:_0x2a23d6}=_0x221c3c,_0x27d937=await this[_0x1c7804(0x163)](_0x221c3c),{context:_0xc1dfa0}=await this[_0x1c7804(0x196)][_0x1c7804(0x105)](_0x46fe97,{'parentMessageId':'','systemMessage':_0x5de174});try{const _0x30d120=await(0x0,openai_1[_0x1c7804(0x103)])(_0xc1dfa0,{'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0xb081c),'model':_0x2a23d6,'proxyUrl':_0x27d937,'onProgress':null});return _0x30d120===null||_0x30d120===void 0x0?void 0x0:_0x30d120['text'];}catch(_0xb5b732){console['log']('error:\x20',_0xb5b732);}}async[_0x2f57d0(0x10b)](_0x69f57b,_0x17e730,_0x3d3e20){const _0x161f9d=_0x2f57d0;var _0x213a06,_0x623502,_0x5ed304,_0x425a39;const _0x594a38=_0x17e730['abortController'],{options:options={},appId:_0xd298c1,cusromPrompt:_0x5d79f5,systemMessage:systemMessage=''}=_0x69f57b;let _0x2c6698=systemMessage;const {parentMessageId:_0x1d77f5}=options,{prompt:_0x5e1a2c,imageUrl:_0x540993,model:_0x9a54b1}=_0x69f57b,{groupId:_0x4520de,usingNetwork:_0x3a9865}=options,_0x1ce8f9=await this[_0x161f9d(0x14b)][_0x161f9d(0x15d)](_0x4520de),_0x554357=(_0x1ce8f9===null||_0x1ce8f9===void 0x0?void 0x0:_0x1ce8f9['config'])?JSON[_0x161f9d(0x133)](_0x1ce8f9['config']):await this[_0x161f9d(0x12a)][_0x161f9d(0x126)](),{keyType:_0x18db56,model:_0x59aac7,topN:_0x3cbe40,systemMessage:_0x39bf49,rounds:_0x143274}=_0x554357[_0x161f9d(0x19a)];let _0xac2df7=null;!_0x5d79f5?_0xac2df7=await this['modelsService']['getCurrentModelKeyInfo'](_0x59aac7):_0xac2df7=await this[_0x161f9d(0x12a)][_0x161f9d(0x19f)]();if(!_0xac2df7)throw new common_1[(_0x161f9d(0x1bd))](_0x161f9d(0x1e2),common_1['HttpStatus']['BAD_REQUEST']);const {deduct:_0x592c53,isTokenBased:_0x281888,tokenFeeRatio:_0xde49dd,deductType:_0x45b6bd,key:_0x592498,secret:_0x1a8c8e,modelName:_0x14dbec,id:_0x307db8,accessToken:_0x22f393}=_0xac2df7;await this[_0x161f9d(0xef)][_0x161f9d(0x17f)](_0x17e730['user']),await this[_0x161f9d(0x121)]['validateBalance'](_0x17e730,_0x45b6bd===0x1?_0x161f9d(0x102):'model4',_0x592c53),_0x3d3e20&&_0x3d3e20[_0x161f9d(0x183)](_0x161f9d(0x10e),_0x161f9d(0x12d)),await this[_0x161f9d(0x1a3)][_0x161f9d(0xf4)](_0x5e1a2c,_0x17e730[_0x161f9d(0xfe)]['id']);const _0x45d542=await this[_0x161f9d(0x170)][_0x161f9d(0x1d4)](_0x5e1a2c);if(_0x45d542&&_0x3d3e20){const _0x4e27a7={'message':_0x45d542,'code':0x1f4};return _0x3d3e20[_0x161f9d(0x117)](JSON['stringify'](_0x4e27a7)),_0x3d3e20[_0x161f9d(0x124)]();}if(_0xd298c1){const _0x4e472e=await this[_0x161f9d(0x19e)][_0x161f9d(0x18a)]({'where':{'id':_0xd298c1,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x4e472e)throw new common_1[(_0x161f9d(0x1bd))](_0x161f9d(0x1b3),common_1[_0x161f9d(0x152)][_0x161f9d(0x1ba)]);_0x4e472e[_0x161f9d(0x11f)]&&(_0x2c6698=_0x4e472e['preset']);}else{if(_0x5d79f5)_0x2c6698=systemMessage;else{if(_0x39bf49)_0x2c6698=_0x39bf49;else{const _0x2d5592=new Date()[_0x161f9d(0x143)]()[_0x161f9d(0x191)]('T')[0x0],_0x410bfa=await this[_0x161f9d(0x156)]['getConfigs']([_0x161f9d(0x1e7)]);_0x2c6698=_0x410bfa+(_0x161f9d(0xfd)+_0x2d5592);}}}let _0x1a6e8f='';if(_0x3a9865){_0x1a6e8f=await(0x0,utils_1[_0x161f9d(0x1ac)])(_0x5e1a2c);const _0x24aa3d=new Date()[_0x161f9d(0x143)]()[_0x161f9d(0x191)]('T')[0x0],_0x311942=await this[_0x161f9d(0x156)][_0x161f9d(0xeb)]([_0x161f9d(0x1e7)]);_0x2c6698=_0x311942+(_0x161f9d(0xfd)+_0x24aa3d);}const _0x4695e0=await this[_0x161f9d(0x112)](options,_0x2c6698,_0xac2df7,_0x554357['modelInfo']),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x3dfc56}=_0xac2df7;_0x3d3e20&&_0x3d3e20[_0x161f9d(0x10f)](0xc8);let _0x2ea419=null,_0x3181d8=null;try{if(_0x3d3e20){let _0xf36d2b=null,_0x3d0719=![];_0x3d3e20['on'](_0x161f9d(0x113),async()=>{const _0x25c2e9=_0x161f9d;if(_0x3d0719)return;_0x594a38[_0x25c2e9(0x120)]();const _0x55f9f1=await(0x0,openai_1[_0x25c2e9(0x184)])(_0x5e1a2c)||0x0,_0x4db6c4=await(0x0,openai_1['getTokenCount'])(_0xf36d2b===null||_0xf36d2b===void 0x0?void 0x0:_0xf36d2b[_0x25c2e9(0x136)])||0x0,_0x49ff6c=_0x55f9f1+_0x4db6c4,_0x335fa7=(0x0,utils_1['getClientIp'])(_0x17e730);await this['chatLogService']['saveChatLog']({'appId':_0xd298c1,'curIp':_0x335fa7,'userId':_0x17e730[_0x25c2e9(0xfe)]['id'],'type':balance_constant_1[_0x25c2e9(0x12c)][_0x25c2e9(0x142)],'prompt':_0x5e1a2c,'imageUrl':_0x540993,'activeModel':_0x9a54b1,'answer':'','promptTokens':_0x55f9f1,'completionTokens':0x0,'totalTokens':_0x55f9f1,'model':_0x59aac7,'role':_0x25c2e9(0xfe),'groupId':_0x4520de,'requestOptions':JSON[_0x25c2e9(0xe7)]({'options':null,'prompt':_0x5e1a2c})}),await this['chatLogService']['saveChatLog']({'appId':_0xd298c1,'curIp':_0x335fa7,'userId':_0x17e730[_0x25c2e9(0xfe)]['id'],'type':balance_constant_1[_0x25c2e9(0x12c)][_0x25c2e9(0x142)],'prompt':_0x5e1a2c,'answer':_0xf36d2b===null||_0xf36d2b===void 0x0?void 0x0:_0xf36d2b[_0x25c2e9(0x136)],'promptTokens':_0x55f9f1,'completionTokens':_0x4db6c4,'totalTokens':_0x49ff6c,'model':_0x59aac7,'role':_0x25c2e9(0x1b2),'groupId':_0x4520de,'requestOptions':JSON[_0x25c2e9(0xe7)]({'options':{'model':_0x59aac7,'temperature':_0x3cbe40},'prompt':_0x5e1a2c}),'conversationOptions':JSON['stringify']({'conversationId':_0xf36d2b===null||_0xf36d2b===void 0x0?void 0x0:_0xf36d2b[_0x25c2e9(0x18c)],'model':_0x59aac7,'parentMessageId':_0xf36d2b===null||_0xf36d2b===void 0x0?void 0x0:_0xf36d2b['id'],'temperature':_0x3cbe40})});let _0x2e17cf=_0x592c53;_0x281888===!![]&&(_0x2e17cf=Math['ceil'](_0x592c53*_0x49ff6c/_0xde49dd)),await this[_0x25c2e9(0x121)]['deductFromBalance'](_0x17e730[_0x25c2e9(0xfe)]['id'],'model'+(_0x45b6bd===0x1?0x3:0x4),_0x2e17cf,_0x49ff6c);});if(Number(_0x18db56)===0x1){const {key:_0x4c6662,maxToken:_0x5b6449,maxTokenRes:_0x3a439e,proxyResUrl:_0x3f9b66}=await this['formatModelToken'](_0xac2df7),{parentMessageId:_0x2da50a,completionParams:_0x38f314,systemMessage:_0x366f43}=_0x4695e0,{model:_0x3d2623,temperature:_0x608f78}=_0x38f314,{context:_0x1e4c8b}=await this[_0x161f9d(0x196)][_0x161f9d(0x105)](_0x3a9865?_0x1a6e8f:_0x5e1a2c,{'parentMessageId':_0x2da50a,'systemMessage':_0x366f43,'maxModelToken':_0x5b6449,'maxResponseTokens':_0x3a439e,'maxRounds':(0x0,helper_1[_0x161f9d(0x17d)])(_0x143274),'imageUrl':_0x540993,'activeModel':_0x9a54b1});let _0x4940d3=!![];_0x2ea419=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x1e4c8b,{'maxToken':_0x5b6449,'maxTokenRes':_0x3a439e,'apiKey':_0x592498,'model':_0x3d2623,'prompt':_0x5e1a2c,'activeModel':_0x9a54b1,'imageUrl':_0x540993,'temperature':_0x608f78,'proxyUrl':_0x3f9b66,'onProgress':_0x4bfec6=>{const _0x3b7572=_0x161f9d;_0x3d3e20[_0x3b7572(0x117)](_0x4940d3?JSON[_0x3b7572(0xe7)](_0x4bfec6):'\x0a'+JSON[_0x3b7572(0xe7)](_0x4bfec6)),_0xf36d2b=_0x4bfec6,_0x4940d3=![];}},this[_0x161f9d(0x1c8)]),_0x3d0719=!![];}if(Number(_0x18db56)===0x2){let _0x2471ab=!![];const {context:_0x9fcde8}=await this[_0x161f9d(0x196)]['buildMessageFromParentMessageId'](_0x3a9865?_0x1a6e8f:_0x5e1a2c,{'parentMessageId':_0x1d77f5,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x143274)});_0x2ea419=await(0x0,baidu_1[_0x161f9d(0x145)])(_0x3a9865?_0x1a6e8f:_0x9fcde8,{'temperature':_0x3cbe40,'accessToken':_0x22f393,'model':_0x59aac7,'onProgress':_0x568789=>{const _0x9668e8=_0x161f9d;_0x3d3e20[_0x9668e8(0x117)](_0x2471ab?JSON['stringify'](_0x568789):'\x0a'+JSON[_0x9668e8(0xe7)](_0x568789)),_0x2471ab=![],_0xf36d2b=_0x568789;}}),_0x3d0719=!![];}if(Number(_0x18db56)===0x3){let _0x4f8ef3=!![];const {context:_0x3f01c3}=await this[_0x161f9d(0x196)][_0x161f9d(0x105)](_0x3a9865?_0x1a6e8f:_0x5e1a2c,{'parentMessageId':_0x1d77f5,'maxRounds':(0x0,helper_1[_0x161f9d(0x17d)])(_0x143274)});_0x2ea419=await(0x0,zhipu_1[_0x161f9d(0x10a)])(_0x3a9865?_0x1a6e8f:_0x3f01c3,{'temperature':_0x3cbe40,'key':_0x3dfc56,'model':_0x59aac7,'onProgress':_0x3102cf=>{const _0x3ba475=_0x161f9d;_0x3d3e20['write'](_0x4f8ef3?JSON[_0x3ba475(0xe7)](_0x3102cf):'\x0a'+JSON[_0x3ba475(0xe7)](_0x3102cf)),_0x4f8ef3=![],_0xf36d2b=_0x3102cf;}}),_0x3d0719=!![];}const _0x585868={'id':this[_0x161f9d(0x196)]['getUuid'](),'text':_0x5e1a2c,'role':_0x161f9d(0xfe),'name':undefined,'usage':null,'imageUrl':_0x540993,'activeModel':_0x9a54b1,'parentMessageId':_0x1d77f5,'conversationId':_0x2ea419===null||_0x2ea419===void 0x0?void 0x0:_0x2ea419[_0x161f9d(0x18c)]};_0x3181d8={'model':_0x59aac7,'parentMessageId':_0x1d77f5},await this[_0x161f9d(0x196)][_0x161f9d(0x1c9)](_0x585868);const _0x1ce388={'id':_0x2ea419['id'],'text':_0x2ea419[_0x161f9d(0x136)],'role':_0x161f9d(0x1b2),'name':undefined,'usage':_0x2ea419===null||_0x2ea419===void 0x0?void 0x0:_0x2ea419[_0x161f9d(0x180)],'imageUrl':_0x540993,'parentMessageId':_0x585868['id'],'conversationId':_0x2ea419===null||_0x2ea419===void 0x0?void 0x0:_0x2ea419['conversationId']};await this[_0x161f9d(0x196)][_0x161f9d(0x1c9)](_0x1ce388),_0x3181d8={'model':_0x59aac7,'parentMessageId':_0x585868['id']};}else{const {key:_0x2069a6,maxToken:_0x4ea87c,maxTokenRes:_0x2fb531,proxyResUrl:_0x357972}=await this['formatModelToken'](_0xac2df7),{parentMessageId:_0x4bea9c,completionParams:_0x5e8b58,systemMessage:_0x1ae47e}=_0x4695e0,{model:_0x161586,temperature:_0x168396}=_0x5e8b58,{context:_0x20f607}=await this[_0x161f9d(0x196)][_0x161f9d(0x105)](_0x3a9865?_0x1a6e8f:_0x5e1a2c,{'parentMessageId':_0x4bea9c,'systemMessage':_0x1ae47e,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x143274)});_0x2ea419=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x20f607,{'apiKey':_0x592498,'model':_0x161586,'temperature':_0x168396,'proxyUrl':_0x357972,'onProgress':null,'prompt':_0x5e1a2c});}let _0xc5b940=null,_0x2acb9e=null;_0x59aac7[_0x161f9d(0x1d0)](_0x161f9d(0x109))?_0xc5b940=((_0x213a06=_0x2ea419[_0x161f9d(0x129)])===null||_0x213a06===void 0x0?void 0x0:_0x213a06[_0x161f9d(0x180)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x2acb9e=await(0x0,helper_1['unifiedFormattingResponse'])(_0x18db56,_0x2ea419,_0x3181d8);const {prompt_tokens:_0x5caed6,completion_tokens:_0x289828,total_tokens:_0x564ad3}=_0x59aac7['includes'](_0x161f9d(0x109))?_0xc5b940:_0x2acb9e['usage'];let _0x42c996=_0x592c53;_0x281888===!![]&&(_0x42c996=Math['ceil'](_0x592c53*_0x564ad3/_0xde49dd));await this['userBalanceService'][_0x161f9d(0x12f)](_0x17e730[_0x161f9d(0xfe)]['id'],_0x161f9d(0x1cb)+(_0x45b6bd===0x1?0x3:0x4),_0x42c996,_0x564ad3),await this[_0x161f9d(0x12a)]['saveUseLog'](_0x307db8,_0x564ad3);const _0x245247=(0x0,utils_1[_0x161f9d(0x128)])(_0x17e730);await this[_0x161f9d(0x10d)][_0x161f9d(0x138)]({'appId':_0xd298c1,'curIp':_0x245247,'userId':_0x17e730[_0x161f9d(0xfe)]['id'],'type':balance_constant_1[_0x161f9d(0x12c)][_0x161f9d(0x142)],'prompt':_0x5e1a2c,'imageUrl':_0x540993,'activeModel':_0x9a54b1,'answer':'','promptTokens':_0x5caed6,'completionTokens':0x0,'totalTokens':_0x564ad3,'model':_0x59aac7,'role':_0x161f9d(0xfe),'groupId':_0x4520de,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x5e1a2c})}),await this[_0x161f9d(0x10d)][_0x161f9d(0x138)]({'appId':_0xd298c1,'curIp':_0x245247,'userId':_0x17e730[_0x161f9d(0xfe)]['id'],'type':balance_constant_1['DeductionKey'][_0x161f9d(0x142)],'prompt':_0x5e1a2c,'imageUrl':_0x2ea419===null||_0x2ea419===void 0x0?void 0x0:_0x2ea419[_0x161f9d(0x1d9)],'answer':_0x2ea419[_0x161f9d(0x136)],'promptTokens':_0x5caed6,'completionTokens':_0x289828,'totalTokens':_0x564ad3,'model':_0x59aac7,'role':'assistant','groupId':_0x4520de,'requestOptions':JSON['stringify']({'options':{'model':_0x59aac7,'temperature':_0x3cbe40},'prompt':_0x5e1a2c}),'conversationOptions':JSON[_0x161f9d(0xe7)]({'conversationId':_0x2ea419['conversationId'],'model':_0x59aac7,'parentMessageId':_0x2ea419['id'],'temperature':_0x3cbe40})}),common_1[_0x161f9d(0x1da)][_0x161f9d(0x111)](_0x161f9d(0x11b)+_0x17e730[_0x161f9d(0xfe)]['id']+_0x161f9d(0x1ce)+_0x14dbec+'-'+_0x9a54b1+_0x161f9d(0x140)+_0x564ad3+',\x20消耗积分：\x20'+_0x42c996,_0x161f9d(0x178));const _0x1db2df=await this[_0x161f9d(0x121)][_0x161f9d(0x15f)](_0x17e730['user']['id']);return _0x2ea419[_0x161f9d(0x19d)]=Object[_0x161f9d(0x1a1)]({},_0x1db2df),_0x2ea419[_0x161f9d(0x167)]&&(_0x2ea419['result']=''),_0x2ea419[_0x161f9d(0x100)]=!![],_0x3d3e20?_0x3d3e20[_0x161f9d(0x117)]('\x0a'+JSON[_0x161f9d(0xe7)](_0x2ea419)):_0x2ea419[_0x161f9d(0x136)];}catch(_0x52dd66){console['log']('chat-error\x20<----------------------------------------->',_0x592498,_0x52dd66);const _0x52ff92=(_0x52dd66===null||_0x52dd66===void 0x0?void 0x0:_0x52dd66[_0x161f9d(0x1a8)])||0x190,_0x43b25e=((_0x623502=_0x52dd66===null||_0x52dd66===void 0x0?void 0x0:_0x52dd66['response'])===null||_0x623502===void 0x0?void 0x0:_0x623502[_0x161f9d(0x10f)])||(_0x52dd66===null||_0x52dd66===void 0x0?void 0x0:_0x52dd66[_0x161f9d(0x1a8)])||0x190;console['log'](_0x161f9d(0xe9),'code:\x20',_0x52ff92,_0x161f9d(0x119),_0x52dd66===null||_0x52dd66===void 0x0?void 0x0:_0x52dd66[_0x161f9d(0x119)],'statusText:',(_0x5ed304=_0x52dd66===null||_0x52dd66===void 0x0?void 0x0:_0x52dd66['response'])===null||_0x5ed304===void 0x0?void 0x0:_0x5ed304[_0x161f9d(0x14a)],_0x161f9d(0x10f),(_0x425a39=_0x52dd66===null||_0x52dd66===void 0x0?void 0x0:_0x52dd66[_0x161f9d(0xf8)])===null||_0x425a39===void 0x0?void 0x0:_0x425a39[_0x161f9d(0x10f)]);if(_0x52dd66[_0x161f9d(0x10f)]&&_0x52dd66[_0x161f9d(0x10f)]===0x192){const _0x1dd020={'message':'Catch\x20Error\x20'+_0x52dd66['message'],'code':0x192};if(_0x3d3e20)return _0x3d3e20[_0x161f9d(0x117)](JSON[_0x161f9d(0xe7)](_0x1dd020));else throw new common_1['HttpException'](_0x52dd66[_0x161f9d(0x119)],common_1[_0x161f9d(0x152)][_0x161f9d(0xf6)]);}if(!_0x43b25e){if(_0x3d3e20)return _0x3d3e20[_0x161f9d(0x117)](JSON[_0x161f9d(0xe7)]({'message':_0x52dd66[_0x161f9d(0x119)],'code':0x1f4}));else throw new common_1[(_0x161f9d(0x1bd))](_0x52dd66[_0x161f9d(0x119)],common_1[_0x161f9d(0x152)][_0x161f9d(0x1ba)]);}let _0x5edb9e=errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x43b25e]?errorMessage_constant_1[_0x161f9d(0x13b)][_0x43b25e]:'服务异常、请重新试试吧！！！';(_0x52dd66===null||_0x52dd66===void 0x0?void 0x0:_0x52dd66[_0x161f9d(0x119)][_0x161f9d(0x1d0)]('The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.'))&&Number(_0x18db56)===0x1&&(await this[_0x161f9d(0x12a)][_0x161f9d(0x1aa)](_0x307db8,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0x5edb9e=_0x161f9d(0x13a));(_0x52dd66===null||_0x52dd66===void 0x0?void 0x0:_0x52dd66[_0x161f9d(0x1a8)])===0x1ad&&_0x52dd66['message']['includes'](_0x161f9d(0x148))&&Number(_0x18db56)===0x1&&(await this[_0x161f9d(0x12a)][_0x161f9d(0x1aa)](_0x307db8,_0x161f9d(0x1e3),-0x3),_0x5edb9e=_0x161f9d(0xf2));(_0x52dd66===null||_0x52dd66===void 0x0?void 0x0:_0x52dd66['statusCode'])===0x1ad&&(_0x52dd66===null||_0x52dd66===void 0x0?void 0x0:_0x52dd66[_0x161f9d(0x14a)])===_0x161f9d(0x16e)&&(_0x5edb9e=_0x161f9d(0x1e8));(_0x52dd66===null||_0x52dd66===void 0x0?void 0x0:_0x52dd66[_0x161f9d(0x1a8)])===0x191&&_0x52dd66[_0x161f9d(0x119)][_0x161f9d(0x1d0)]('Incorrect\x20API\x20key\x20provided')&&Number(_0x18db56)===0x1&&(await this[_0x161f9d(0x12a)]['lockKey'](_0x307db8,_0x161f9d(0xf0),-0x2),_0x5edb9e='提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！');(_0x52dd66===null||_0x52dd66===void 0x0?void 0x0:_0x52dd66[_0x161f9d(0x1a8)])===0x194&&_0x52dd66[_0x161f9d(0x119)]['includes'](_0x161f9d(0x188))&&Number(_0x18db56)===0x1&&(await this['modelsService'][_0x161f9d(0x1aa)](_0x307db8,_0x161f9d(0x19c),-0x4),_0x5edb9e='当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！');_0x52ff92===0x190&&console[_0x161f9d(0x1a4)](_0x161f9d(0xed),_0x52dd66,_0x52dd66[_0x161f9d(0x119)]);const _0x41658f={'message':_0x5edb9e||_0x161f9d(0x1e9),'code':_0x52ff92===0x191?0x190:_0x52ff92||0x1f4};if(_0x3d3e20)return _0x3d3e20['write'](JSON[_0x161f9d(0xe7)](_0x41658f));else throw new common_1[(_0x161f9d(0x1bd))](_0x41658f[_0x161f9d(0x119)],common_1[_0x161f9d(0x152)]['BAD_REQUEST']);}finally{_0x3d3e20&&_0x3d3e20[_0x161f9d(0x124)]();}}async[_0x2f57d0(0x186)](_0x2e3746,_0x3b4bb3){const _0x532d78=_0x2f57d0;var _0x50a07a,_0xa464a1,_0x52b695,_0x4fb915;await this[_0x532d78(0x1a3)]['checkBadWords'](_0x2e3746[_0x532d78(0x144)],_0x3b4bb3['user']['id']),await this[_0x532d78(0xef)][_0x532d78(0x17f)](_0x3b4bb3['user']);const _0x54c1c7=(_0x2e3746===null||_0x2e3746===void 0x0?void 0x0:_0x2e3746[_0x532d78(0x1cd)])==='hd'?0x4:0x2;await this[_0x532d78(0x121)][_0x532d78(0x1c3)](_0x3b4bb3,_0x532d78(0x1af),_0x54c1c7);let _0x109869=[];const _0x36bd0f=await this[_0x532d78(0x12a)][_0x532d78(0x139)](_0x532d78(0x14d)),_0x4f6435=_0x36bd0f===null||_0x36bd0f===void 0x0?void 0x0:_0x36bd0f['id'],{key:_0x5b19b6,proxyResUrl:_0x25060f}=await this[_0x532d78(0x18d)](_0x36bd0f);common_1['Logger'][_0x532d78(0x1a4)](_0x532d78(0x15b)+_0x2e3746[_0x532d78(0x144)]+_0x532d78(0x1a7)+_0x5b19b6,'DrawService');try{const _0x5825a1=_0x25060f+_0x532d78(0x1d3),_0x5677f2=Object[_0x532d78(0x1a1)](Object[_0x532d78(0x1a1)]({},_0x2e3746),{'model':_0x532d78(0x14d)});console['log'](_0x532d78(0x115),_0x5677f2);const _0x548d80=await axios_1[_0x532d78(0x147)][_0x532d78(0x1c0)](_0x5825a1,Object[_0x532d78(0x1a1)](Object[_0x532d78(0x1a1)]({},_0x5677f2),{'response_format':_0x532d78(0x1d1)}),{'headers':{'Authorization':_0x532d78(0x169)+_0x5b19b6}});_0x109869=_0x548d80[_0x532d78(0xee)][_0x532d78(0xee)];const _0xf5020f=[];for(const _0x15c1ea of _0x109869){const _0x2d0f47=uuid['v4']()[_0x532d78(0x185)](0x0,0xa)+_0x532d78(0x164),_0x591382=Buffer[_0x532d78(0x1a5)](_0x15c1ea[_0x532d78(0x1d1)],_0x532d78(0x1c1));_0xf5020f[_0x532d78(0x15a)](this['uploadService'][_0x532d78(0x122)]({'filename':_0x2d0f47,'buffer':_0x591382}));}const _0x33c236=await Promise[_0x532d78(0x1a9)](_0xf5020f);await this['userBalanceService'][_0x532d78(0x12f)](_0x3b4bb3['user']['id'],_0x532d78(0x1af),(_0x5677f2===null||_0x5677f2===void 0x0?void 0x0:_0x5677f2[_0x532d78(0x1cd)])===_0x532d78(0xe2)?0x2:0x4,_0x54c1c7);const _0x33da69=(0x0,utils_1[_0x532d78(0x128)])(_0x3b4bb3),_0x25bcc1=[],_0xeef59d=await this[_0x532d78(0x1c8)][_0x532d78(0x127)](),[_0x3847be,_0x2e71b3]=_0x2e3746['size'][_0x532d78(0x191)]('x');return _0x33c236[_0x532d78(0x1e5)](_0x3037a1=>{const _0x58f34e=_0x532d78;_0x25bcc1[_0x58f34e(0x15a)](this[_0x58f34e(0x10d)]['saveChatLog']({'curIp':_0x33da69,'userId':_0x3b4bb3[_0x58f34e(0xfe)]['id'],'type':balance_constant_1[_0x58f34e(0x12c)][_0x58f34e(0x1b0)],'prompt':_0x2e3746['prompt'],'answer':_0x3037a1,'fileInfo':JSON[_0x58f34e(0xe7)]({'cosType':_0xeef59d,'width':_0x3847be,'height':_0x2e71b3,'cosUrl':_0x3037a1}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':'dall-e-3'}));}),await Promise['all'](_0x25bcc1),_0x33c236;}catch(_0x2d11a2){const _0x9e636e=((_0x50a07a=_0x2d11a2===null||_0x2d11a2===void 0x0?void 0x0:_0x2d11a2[_0x532d78(0xf8)])===null||_0x50a07a===void 0x0?void 0x0:_0x50a07a[_0x532d78(0x10f)])||0x1f4;console[_0x532d78(0x1a4)](_0x532d78(0x1b9),JSON[_0x532d78(0xe7)](_0x2d11a2),_0x5b19b6,_0x9e636e);const _0x1c671c=(_0x4fb915=(_0x52b695=(_0xa464a1=_0x2d11a2===null||_0x2d11a2===void 0x0?void 0x0:_0x2d11a2[_0x532d78(0xf8)])===null||_0xa464a1===void 0x0?void 0x0:_0xa464a1[_0x532d78(0xee)])===null||_0x52b695===void 0x0?void 0x0:_0x52b695[_0x532d78(0x14e)])===null||_0x4fb915===void 0x0?void 0x0:_0x4fb915['message'];if(_0x9e636e===0x1ad)throw new common_1['HttpException'](_0x532d78(0x1df),common_1[_0x532d78(0x152)][_0x532d78(0x1ba)]);if(_0x9e636e===0x190&&_0x1c671c[_0x532d78(0x1d0)]('This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters'))throw new common_1[(_0x532d78(0x1bd))](_0x532d78(0x1ca),common_1[_0x532d78(0x152)][_0x532d78(0x1ba)]);if(_0x9e636e===0x190&&_0x1c671c[_0x532d78(0x1d0)]('Billing\x20hard\x20limit\x20has\x20been\x20reached')){await this[_0x532d78(0x12a)][_0x532d78(0x1aa)](_0x4f6435,_0x532d78(0x197),-0x1);throw new common_1['HttpException'](_0x532d78(0x1dc),common_1['HttpStatus'][_0x532d78(0x1ba)]);}if(_0x9e636e===0x1f4)throw new common_1[(_0x532d78(0x1bd))](_0x532d78(0xe4),common_1['HttpStatus']['BAD_REQUEST']);if(_0x9e636e===0x191)throw new common_1['HttpException']('绘制图片失败，此次绘画被拒绝了！',common_1[_0x532d78(0x152)]['BAD_REQUEST']);throw new common_1[(_0x532d78(0x1bd))]('绘制图片失败，请稍后试试吧！',common_1[_0x532d78(0x152)][_0x532d78(0x1ba)]);}}async['getAllKeyList'](){const _0x333cf9=_0x2f57d0,_0x3bdc1c=await this['gptKeysEntity'][_0x333cf9(0x116)]({'where':{'status':0x1},'select':['id',_0x333cf9(0x1e4),_0x333cf9(0x1c6),_0x333cf9(0x1cb),_0x333cf9(0x118),'maxResponseTokens',_0x333cf9(0x10c),_0x333cf9(0x1a0)]}),_0x114474=_0x3bdc1c['filter'](_0x385f38=>_0x385f38[_0x333cf9(0x1cb)]['includes']('gpt-3')),_0x32a7a0=_0x3bdc1c[_0x333cf9(0x162)](_0xe32a2=>_0xe32a2['model']['includes'](_0x333cf9(0x13e)));this[_0x333cf9(0x157)]={'list3':_0x114474,'list4':_0x32a7a0};}async[_0x2f57d0(0x163)](_0x207618){const _0x59ea75=_0x2f57d0,_0x390cbc=await this[_0x59ea75(0x156)][_0x59ea75(0xeb)]([_0x59ea75(0x195)]);return(_0x207618===null||_0x207618===void 0x0?void 0x0:_0x207618[_0x59ea75(0xe8)])||_0x390cbc||_0x59ea75(0x1a6);}async['formatModelToken'](_0x373ac8){const _0x76eecf=_0x2f57d0,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x76eecf(0x156)][_0x76eecf(0xeb)]([_0x76eecf(0x130),'openaiModel3MaxTokensRes',_0x76eecf(0x19b),_0x76eecf(0xff),'openaiModel4MaxTokens',_0x76eecf(0x1bb),_0x76eecf(0x174),'openaiModel4MaxTokens32kRes',_0x76eecf(0x195)]);let _0x27dcfc=null,_0x3a7654=null,_0x5134d3=null,{model:_0x12689c,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x5031f3}=_0x373ac8;return _0x12689c[_0x76eecf(0xfc)]()[_0x76eecf(0x1d0)](_0x76eecf(0x13e))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x3a7654>=0x1000&&(maxModelTokens=0x1000),_0x27dcfc=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x3a7654=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x12689c[_0x76eecf(0xfc)]()[_0x76eecf(0x1d0)](_0x76eecf(0x168))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x3a7654>=0x4000&&(maxModelTokens=0x4000),_0x27dcfc=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x3a7654=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x12689c[_0x76eecf(0xfc)]()[_0x76eecf(0x1d0)](_0x76eecf(0x1b7))&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x3a7654>=0x1000&&(maxModelTokens=0x1000),_0x27dcfc=maxModelTokens||0x3ffc,_0x3a7654=maxResponseTokens||0x1000)),_0x12689c[_0x76eecf(0xfc)]()[_0x76eecf(0x1d0)](_0x76eecf(0x17c))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x3a7654>=0x7d0&&(maxModelTokens=0x7d0),_0x27dcfc=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x3a7654=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x12689c[_0x76eecf(0xfc)]()['includes'](_0x76eecf(0x1ad))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x3a7654>=0x2000&&(maxModelTokens=0x2000),_0x27dcfc=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x3a7654=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x12689c[_0x76eecf(0xfc)]()[_0x76eecf(0x1d0)](_0x76eecf(0x1b7))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x3a7654>=0x1000&&(maxModelTokens=0x1000),_0x27dcfc=maxModelTokens||0x4000,_0x3a7654=maxResponseTokens||0x1000)),_0x5134d3=proxyUrl||openaiBaseUrl||_0x76eecf(0x1a6),_0x3a7654>=_0x27dcfc&&(_0x3a7654=Math[_0x76eecf(0x1d6)](_0x27dcfc/0x2)),{'key':_0x5031f3,'maxToken':_0x27dcfc,'maxTokenRes':_0x3a7654,'proxyResUrl':_0x5134d3};}async['setChatBoxType'](_0x487a49,_0x1b61fd){const _0x3a57ea=_0x2f57d0;try{const {name:_0x310925,icon:_0x3efe3c,order:_0x1b0d4e,id:_0x1196a4,status:_0x4f71f5}=_0x1b61fd;return _0x1196a4?await this[_0x3a57ea(0x11c)][_0x3a57ea(0x110)]({'id':_0x1196a4},{'name':_0x310925,'icon':_0x3efe3c,'order':_0x1b0d4e,'status':_0x4f71f5}):await this[_0x3a57ea(0x11c)][_0x3a57ea(0x106)]({'name':_0x310925,'icon':_0x3efe3c,'order':_0x1b0d4e,'status':_0x4f71f5});}catch(_0x302133){console['log']('error:\x20',_0x302133);}}async[_0x2f57d0(0xf1)](_0x48ced5,_0x741ac9){const _0x391d59=_0x2f57d0,{id:_0x45afcb}=_0x741ac9;if(!_0x45afcb)throw new common_1[(_0x391d59(0x1bd))](_0x391d59(0x175),common_1['HttpStatus']['BAD_REQUEST']);const _0x5750c8=await this[_0x391d59(0x1c7)][_0x391d59(0x177)]({'where':{'typeId':_0x45afcb}});if(_0x5750c8)throw new common_1['HttpException']('当前分类下有未处理数据不可移除！',common_1['HttpStatus'][_0x391d59(0x1ba)]);return await this[_0x391d59(0x11c)][_0x391d59(0x158)]({'id':_0x45afcb});}async[_0x2f57d0(0x1e0)](){const _0x2051f2=_0x2f57d0;return await this['chatBoxTypeEntity'][_0x2051f2(0x116)]({'order':{'order':_0x2051f2(0x150)}});}async[_0x2f57d0(0x1b4)](_0xcce778,_0x309bde){const _0x1c2083=_0x2f57d0,{title:_0x532ca4,prompt:_0x325792,appId:_0x2ee7d0,order:_0x23851a,status:_0x1efd57,typeId:_0x46cfac,id:_0x557532,url:_0x149ef7}=_0x309bde;if(!_0x46cfac)throw new common_1[(_0x1c2083(0x1bd))](_0x1c2083(0x125),common_1[_0x1c2083(0x152)]['BAD_REQUEST']);try{const _0x3a5804={'title':_0x532ca4,'order':_0x23851a,'status':_0x1efd57,'typeId':_0x46cfac,'url':_0x149ef7};return _0x3a5804[_0x1c2083(0x155)]=_0x2ee7d0||0x0,_0x3a5804[_0x1c2083(0x144)]=_0x325792||'',_0x557532?await this['chatBoxEntity'][_0x1c2083(0x110)]({'id':_0x557532},_0x3a5804):await this['chatBoxEntity'][_0x1c2083(0x106)](_0x3a5804);}catch(_0xeadeff){console['log'](_0x1c2083(0x146),_0xeadeff);}}async[_0x2f57d0(0x189)](_0x51ae1e,_0x4dd4e8){const _0x174e43=_0x2f57d0,{id:_0x41c701}=_0x4dd4e8;if(!_0x41c701)throw new common_1[(_0x174e43(0x1bd))](_0x174e43(0x175),common_1[_0x174e43(0x152)]['BAD_REQUEST']);return await this['chatBoxEntity'][_0x174e43(0x158)]({'id':_0x41c701});}async['queryChatBox'](){const _0x4c087f=_0x2f57d0,_0x230c9f=await this[_0x4c087f(0x1c7)]['find']({'order':{'order':_0x4c087f(0x150)}}),_0x41f52e=[...new Set(_0x230c9f[_0x4c087f(0x16a)](_0x4ed0cf=>_0x4ed0cf[_0x4c087f(0x15c)]))],_0x27320a=[...new Set(_0x230c9f[_0x4c087f(0x16a)](_0x3e3b25=>_0x3e3b25[_0x4c087f(0x155)]))],_0x248140=await this[_0x4c087f(0x11c)][_0x4c087f(0x116)]({'where':{'id':(0x0,typeorm_1['In'])(_0x41f52e)}}),_0x2a7d2a=await this[_0x4c087f(0x19e)][_0x4c087f(0x116)]({'where':{'id':(0x0,typeorm_1['In'])(_0x27320a)}});return _0x230c9f['map'](_0x55dd23=>{const _0x55918d=_0x4c087f,{typeId:_0x1c72ab,appId:_0x25e1ef}=_0x55dd23;return _0x55dd23[_0x55918d(0x176)]=_0x248140[_0x55918d(0x116)](_0x3d404a=>_0x3d404a['id']===_0x1c72ab),_0x55dd23[_0x55918d(0x153)]=_0x2a7d2a[_0x55918d(0x116)](_0x2868b3=>_0x2868b3['id']===_0x25e1ef),_0x55dd23;});}async[_0x2f57d0(0x18b)](){const _0x489583=_0x2f57d0,_0x506c05=await this[_0x489583(0x11c)][_0x489583(0x116)]({'order':{'order':_0x489583(0x150)},'where':{'status':!![]}}),_0x3a5cf6=await this[_0x489583(0x1c7)]['find']({'where':{'status':!![]}}),_0x571eb2=[...new Set(_0x3a5cf6[_0x489583(0x16a)](_0x4e8e59=>_0x4e8e59[_0x489583(0x155)]))],_0x2b4bae=await this[_0x489583(0x19e)][_0x489583(0x116)]({'where':{'id':(0x0,typeorm_1['In'])(_0x571eb2)}});return _0x3a5cf6[_0x489583(0x1e5)](_0x136d6d=>{const _0x2f9880=_0x489583,_0x21a54a=_0x2b4bae['find'](_0x954d59=>_0x954d59['id']===_0x136d6d[_0x2f9880(0x155)]);return _0x136d6d[_0x2f9880(0x11d)]=_0x21a54a===null||_0x21a54a===void 0x0?void 0x0:_0x21a54a[_0x2f9880(0x11d)],_0x136d6d;}),_0x506c05['map'](_0x4517ec=>{const _0x1c74b7=_0x489583;return _0x4517ec[_0x1c74b7(0x171)]=_0x3a5cf6[_0x1c74b7(0x162)](_0x1df4b5=>_0x1df4b5[_0x1c74b7(0x15c)]===_0x4517ec['id']&&_0x1df4b5['status']),_0x4517ec;});}async[_0x2f57d0(0x159)](_0x369833,_0x3a47e9){const _0x3245ca=_0x2f57d0;try{const {name:_0x2eda23,icon:_0x3df3c6,order:_0x4abfc1,id:_0x122ec7,status:_0xf96686}=_0x3a47e9;return _0x122ec7?await this[_0x3245ca(0x187)][_0x3245ca(0x110)]({'id':_0x122ec7},{'name':_0x2eda23,'icon':_0x3df3c6,'order':_0x4abfc1,'status':_0xf96686}):await this[_0x3245ca(0x187)][_0x3245ca(0x106)]({'name':_0x2eda23,'icon':_0x3df3c6,'order':_0x4abfc1,'status':_0xf96686});}catch(_0x4c8ade){console[_0x3245ca(0x1a4)]('error:\x20',_0x4c8ade);}}async[_0x2f57d0(0x1de)](_0xedcec6,_0x356980){const _0x387ffe=_0x2f57d0,{id:_0x1ff92e}=_0x356980;if(!_0x1ff92e)throw new common_1[(_0x387ffe(0x1bd))](_0x387ffe(0x175),common_1[_0x387ffe(0x152)][_0x387ffe(0x1ba)]);const _0x3fecc6=await this[_0x387ffe(0x1c7)][_0x387ffe(0x177)]({'where':{'typeId':_0x1ff92e}});if(_0x3fecc6)throw new common_1[(_0x387ffe(0x1bd))](_0x387ffe(0x199),common_1['HttpStatus'][_0x387ffe(0x1ba)]);return await this[_0x387ffe(0x187)]['delete']({'id':_0x1ff92e});}async[_0x2f57d0(0x14c)](){const _0x39454d=_0x2f57d0;return await this[_0x39454d(0x187)][_0x39454d(0x116)]({'order':{'order':_0x39454d(0x150)}});}async['setChatPre'](_0x5d5865,_0x3ac93f){const _0x59aa05=_0x2f57d0,{title:_0x13e04a,prompt:_0x391ffd,appId:_0x420a07,order:_0x349dbc,status:_0x4e3e3b,typeId:_0x2fb8b5,id:_0x503cb3,url:_0x51eebe}=_0x3ac93f;if(!_0x2fb8b5)throw new common_1[(_0x59aa05(0x1bd))]('缺失必要参数！',common_1['HttpStatus'][_0x59aa05(0x1ba)]);try{const _0x5adaa1={'title':_0x13e04a,'prompt':_0x391ffd,'order':_0x349dbc,'status':_0x4e3e3b,'typeId':_0x2fb8b5,'url':_0x51eebe};return _0x503cb3?await this[_0x59aa05(0x17a)][_0x59aa05(0x110)]({'id':_0x503cb3},_0x5adaa1):await this[_0x59aa05(0x17a)][_0x59aa05(0x106)](_0x5adaa1);}catch(_0x3ac80a){console[_0x59aa05(0x1a4)](_0x59aa05(0x146),_0x3ac80a);}}async[_0x2f57d0(0x134)](_0x38c41d,_0x594e8a){const _0x2fdef4=_0x2f57d0,{id:_0x36d12e}=_0x594e8a;if(!_0x36d12e)throw new common_1[(_0x2fdef4(0x1bd))](_0x2fdef4(0x175),common_1[_0x2fdef4(0x152)][_0x2fdef4(0x1ba)]);return await this['chatPreEntity'][_0x2fdef4(0x158)]({'id':_0x36d12e});}async[_0x2f57d0(0x165)](){const _0x605245=_0x2f57d0,_0x26a117=await this[_0x605245(0x17a)][_0x605245(0x116)]({'order':{'order':_0x605245(0x150)}}),_0x5541b6=[...new Set(_0x26a117[_0x605245(0x16a)](_0xcac7ce=>_0xcac7ce[_0x605245(0x15c)]))],_0x58ff0f=await this[_0x605245(0x187)][_0x605245(0x116)]({'where':{'id':(0x0,typeorm_1['In'])(_0x5541b6)}});return _0x26a117[_0x605245(0x16a)](_0x358984=>{const _0xa0b3da=_0x605245,{typeId:_0x2f4e98,appId:_0x3f809a}=_0x358984;return _0x358984[_0xa0b3da(0x176)]=_0x58ff0f[_0xa0b3da(0x116)](_0x413875=>_0x413875['id']===_0x2f4e98),_0x358984;});}async['queryChatPreList'](){const _0x148880=_0x2f57d0,_0x539158=await this['chatPreTypeEntity'][_0x148880(0x116)]({'order':{'order':_0x148880(0x150)},'where':{'status':!![]}}),_0x24903d=await this[_0x148880(0x17a)][_0x148880(0x116)]({'where':{'status':!![]}});return _0x539158[_0x148880(0x16a)](_0x24fb1f=>{const _0x10a7a1=_0x148880;return _0x24fb1f[_0x10a7a1(0x171)]=_0x24903d['filter'](_0x513746=>_0x513746[_0x10a7a1(0x15c)]===_0x24fb1f['id']&&_0x513746[_0x10a7a1(0x10f)]),_0x24fb1f;});}async[_0x2f57d0(0x1b5)](_0x31b50a,_0x25047f,_0x2df52c){const _0x40c6d3=_0x2f57d0;let _0xb92713=0x1000,_0x39c780=0x800;return _0x31b50a['toLowerCase']()[_0x40c6d3(0x1d0)]('gpt-4')&&(_0xb92713=_0x25047f>=0x2004?0x2004:_0x25047f,_0x39c780=_0x2df52c>=0x1000?0x1000:_0x2df52c,_0x31b50a[_0x40c6d3(0xfc)]()[_0x40c6d3(0x1d0)]('32k')&&(_0xb92713=_0x25047f>=0x8000?0x8000:_0x25047f,_0x39c780=_0x2df52c>=0x3e80?0x3e80:_0x2df52c),(_0x31b50a[_0x40c6d3(0xfc)]()['includes'](_0x40c6d3(0x192))||_0x31b50a[_0x40c6d3(0xfc)]()['includes']('gpt-4-vision-preview'))&&(_0xb92713=_0x25047f>=0x1f400?0x1f400:_0x25047f,_0x39c780=_0x2df52c>=0x1000?0x1000:_0x2df52c)),_0x31b50a['toLowerCase']()[_0x40c6d3(0x1d0)]('gpt-3')&&(_0xb92713=_0x25047f>=0x1000?0x1000:_0x25047f,_0x39c780=_0x2df52c>=0x800?0x800:_0x2df52c,_0x31b50a[_0x40c6d3(0xfc)]()[_0x40c6d3(0x1d0)]('16k')&&(_0xb92713=_0x25047f>=0x4000?0x4000:_0x25047f,_0x39c780=_0x2df52c>=0x1f40?0x1f40:_0x2df52c),_0x31b50a[_0x40c6d3(0xfc)]()[_0x40c6d3(0x1d0)](_0x40c6d3(0x1b7))&&(_0xb92713=_0x25047f>=0x4000?0x4000:_0x25047f,_0x39c780=_0x2df52c>=0x1f40?0x1f40:_0x2df52c)),{'maxToken':_0xb92713,'maxRes':_0x39c780};}};function _0x4613(){const _0x1d6141=['ModelsService','result','32k','Bearer\x20','map','object','ChatBoxEntity','__param','Too\x20Many\x20Requests','9375903VTZhAc','autoreplyService','childList','./chatPre.entity','BadwordsService','openaiModel4MaxTokens32k','非法操作！','typeInfo','count','ChatgptService','6483yOOcux','chatPreEntity','ConfigService','gpt-3','addOneIfOdd','./openai','checkUserStatus','usage','@keyv/redis','chatgpt-ai-web','setHeader','getTokenCount','slice','draw','chatPreTypeEntity','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','delChatBox','findOne','queryChatBoxFrontend','conversationId','formatModelToken','length','UserService','@nestjs/typeorm','split','gpt-4-1106','./store','../globalConfig/globalConfig.service','openaiBaseUrl','nineStore','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','REDIS_PASSWORD','当前分类下有未处理数据不可移除！','modelInfo','openaiModel3MaxTokens16k','当前模型不是聊天模型','userBanance','appEntity','getRandomDrawKey','openaiTimeoutMs','assign','./../upload/upload.service','badwordsService','log','from','https://api.openai.com',',\x20key\x20===>\x20','statusCode','all','lockKey','./gptkeys.entity','compileNetwork','16k','ChatBoxTypeEntity','mjDraw','PAINT_TYPE','../chatGroup/chatGroup.service','assistant','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','setChatBox','getMaxTokenFromModelWithOpenAi','onModuleInit','1106','systemMessage','openai-draw\x20error:\x20','BAD_REQUEST','openaiModel4MaxTokensRes','typeorm','HttpException','GlobalConfigService','./chatBoxType.entity','post','base64','uuid','validateBalance','ChatPreTypeEntity','695436iVQSuO','weight','chatBoxEntity','uploadService','setData','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','model','../app/app.entity','quality','\x20模型名称:\x20','16IDOQXG','includes','b64_json','../badwords/badwords.service','/v1/images/generations','checkAutoReply','../chatLog/chatLog.service','floor','./zhipu','REDIS_PORT','imageUrl','Logger','4827510riReKV','当前Key余额已不足、请重新再试一次吧！','InjectRepository','delChatPreType','当前请求已过载、请稍等会儿再试试吧！','queryChatBoxType','nineai-chatlog','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','key','forEach','Injectable','systemPreMessage','当前模型调用过于频繁、请重新试试吧！','Please\x20check\x20the\x20back-end\x20console','./baidu','standard','importDynamic','绘制图片失败，请检查你的提示词是否有非法描述！','gptKeysEntity','GptKeysEntity','stringify','proxyUrl','chat-error-detail\x20\x20<----------------------------------------->','./chatBox.entity','getConfigs','229600klCFYO','400\x20error','data','userService','提供了错误的模型秘钥','delChatBoxType','当前模型key余额已耗尽','metadata','checkBadWords','Repository','PAYMENT_REQUIRED','decorate','response','../../common/constants/balance.constant','../fanyi/fanyi.service','../autoreply/autoreply.service','toLowerCase','\x0a\x20Current\x20date:\x20','user','openaiModel3MaxTokens16kRes','is_end','UploadService','model3','sendMessageFromOpenAi','695860tNpepB','buildMessageFromParentMessageId','save','ConfigEntity','./chatPreType.entity','dall','sendMessageFromZhipu','chatProcess','openaiProxyUrl','chatLogService','Content-type','status','update','debug','getRequestParams','close','defineProperty','dall-e\x20draw\x20params:\x20','find','write','maxModelTokens','message','NineStore','用户ID:\x20','chatBoxTypeEntity','coverImg','ChatGroupService','preset','abort','userBalanceService','uploadFile','redis://','end','缺失必要参数！','getBaseConfig','getUploadType','getClientIp','detail','modelsService','getOwnPropertyDescriptor','DeductionKey','application/octet-stream;\x20charset=utf-8','configEntity','deductFromBalance','openaiModel3MaxTokens','function','REDIS_HOST','parse','delChatPre','env','text','../../common/utils','saveChatLog','getCurrentModelKeyInfo','当前模型key已被封禁','OpenAiErrorCodeMessage','FanyiService','./../user/user.service','gpt-4','./helper',',\x20消耗token:\x20','AutoreplyService','CHAT_TYPE','toISOString','prompt','sendMessageFromBaidu','error:\x20','default','billing','UserBalanceService','statusText','chatGroupService','queryChatPreType','dall-e-3','error','../models/models.service','DESC','REDIS_USER','HttpStatus','appInfo','64KJahCG','appId','globalConfigService','keyPool','delete','setChatPreType','push','draw\x20paompt\x20info\x20<==**==>\x20','typeId','getGroupInfoFromId','1647555GgGzWQ','queryUserBalance','__esModule','ChatPreEntity','filter','getModelProxyUrl','.png','queryChatPre'];_0x4613=function(){return _0x1d6141;};return _0x4613();}ChatgptService=__decorate([(0x0,common_1[_0x2f57d0(0x1e6)])(),__param(0x0,(0x0,typeorm_2[_0x2f57d0(0x1dd)])(gptkeys_entity_1[_0x2f57d0(0xe6)])),__param(0x1,(0x0,typeorm_2[_0x2f57d0(0x1dd)])(config_entity_1[_0x2f57d0(0x107)])),__param(0x2,(0x0,typeorm_2[_0x2f57d0(0x1dd)])(chatBoxType_entity_1[_0x2f57d0(0x1ae)])),__param(0x3,(0x0,typeorm_2[_0x2f57d0(0x1dd)])(chatBox_entity_1[_0x2f57d0(0x16c)])),__param(0x4,(0x0,typeorm_2[_0x2f57d0(0x1dd)])(app_entity_1['AppEntity'])),__param(0x5,(0x0,typeorm_2[_0x2f57d0(0x1dd)])(chatPreType_entity_1[_0x2f57d0(0x1c4)])),__param(0x6,(0x0,typeorm_2[_0x2f57d0(0x1dd)])(chatPre_entity_1[_0x2f57d0(0x161)])),__metadata('design:paramtypes',[typeorm_1[_0x2f57d0(0xf5)],typeorm_1[_0x2f57d0(0xf5)],typeorm_1[_0x2f57d0(0xf5)],typeorm_1[_0x2f57d0(0xf5)],typeorm_1[_0x2f57d0(0xf5)],typeorm_1[_0x2f57d0(0xf5)],typeorm_1[_0x2f57d0(0xf5)],nestjs_config_1[_0x2f57d0(0x17b)],userBalance_service_1[_0x2f57d0(0x149)],chatLog_service_1['ChatLogService'],user_service_1[_0x2f57d0(0x18f)],upload_service_1[_0x2f57d0(0x101)],badwords_service_1[_0x2f57d0(0x173)],autoreply_service_1[_0x2f57d0(0x141)],globalConfig_service_1[_0x2f57d0(0x1be)],fanyi_service_1[_0x2f57d0(0x13c)],chatGroup_service_1[_0x2f57d0(0x11e)],models_service_1[_0x2f57d0(0x166)]])],ChatgptService),exports[_0x2f57d0(0x178)]=ChatgptService;