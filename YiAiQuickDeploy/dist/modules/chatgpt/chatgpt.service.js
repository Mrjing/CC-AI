'use strict';function _0x4759(_0x16d610,_0x2642ed){const _0x11542d=_0x1154();return _0x4759=function(_0x4759bf,_0x395aab){_0x4759bf=_0x4759bf-0x13a;let _0x536f26=_0x11542d[_0x4759bf];return _0x536f26;},_0x4759(_0x16d610,_0x2642ed);}const _0x4674c6=_0x4759;(function(_0x48d71b,_0x51eb58){const _0x273505=_0x4759,_0xc3fc17=_0x48d71b();while(!![]){try{const _0x488445=-parseInt(_0x273505(0x1a8))/0x1+-parseInt(_0x273505(0x1d5))/0x2*(parseInt(_0x273505(0x16c))/0x3)+parseInt(_0x273505(0x190))/0x4*(parseInt(_0x273505(0x224))/0x5)+-parseInt(_0x273505(0x1ad))/0x6*(-parseInt(_0x273505(0x1a1))/0x7)+parseInt(_0x273505(0x162))/0x8+-parseInt(_0x273505(0x1e1))/0x9+parseInt(_0x273505(0x17a))/0xa*(-parseInt(_0x273505(0x169))/0xb);if(_0x488445===_0x51eb58)break;else _0xc3fc17['push'](_0xc3fc17['shift']());}catch(_0x4f1c84){_0xc3fc17['push'](_0xc3fc17['shift']());}}}(_0x1154,0x718c9));var __decorate=this&&this['__decorate']||function(_0x2871f8,_0x5bbcff,_0x11c74c,_0x2ab03f){const _0x4b330a=_0x4759;var _0x24ef80=arguments[_0x4b330a(0x206)],_0x475862=_0x24ef80<0x3?_0x5bbcff:_0x2ab03f===null?_0x2ab03f=Object[_0x4b330a(0x15f)](_0x5bbcff,_0x11c74c):_0x2ab03f,_0x514d2b;if(typeof Reflect===_0x4b330a(0x167)&&typeof Reflect[_0x4b330a(0x14d)]===_0x4b330a(0x1ac))_0x475862=Reflect['decorate'](_0x2871f8,_0x5bbcff,_0x11c74c,_0x2ab03f);else{for(var _0x405142=_0x2871f8[_0x4b330a(0x206)]-0x1;_0x405142>=0x0;_0x405142--)if(_0x514d2b=_0x2871f8[_0x405142])_0x475862=(_0x24ef80<0x3?_0x514d2b(_0x475862):_0x24ef80>0x3?_0x514d2b(_0x5bbcff,_0x11c74c,_0x475862):_0x514d2b(_0x5bbcff,_0x11c74c))||_0x475862;}return _0x24ef80>0x3&&_0x475862&&Object[_0x4b330a(0x20f)](_0x5bbcff,_0x11c74c,_0x475862),_0x475862;},__metadata=this&&this[_0x4674c6(0x174)]||function(_0xe5eef2,_0x3a9d7f){const _0xee9c91=_0x4674c6;if(typeof Reflect===_0xee9c91(0x167)&&typeof Reflect[_0xee9c91(0x150)]==='function')return Reflect[_0xee9c91(0x150)](_0xe5eef2,_0x3a9d7f);},__param=this&&this[_0x4674c6(0x175)]||function(_0x47c46a,_0xc431e4){return function(_0x527520,_0x30a7b2){_0xc431e4(_0x527520,_0x30a7b2,_0x47c46a);};};Object[_0x4674c6(0x20f)](exports,_0x4674c6(0x143),{'value':!![]}),exports[_0x4674c6(0x1b5)]=void 0x0;const upload_service_1=require(_0x4674c6(0x149)),user_service_1=require(_0x4674c6(0x1fd)),nestjs_config_1=require(_0x4674c6(0x1e0)),common_1=require(_0x4674c6(0x1a3)),errorMessage_constant_1=require(_0x4674c6(0x204)),utils_1=require(_0x4674c6(0x173)),axios_1=require(_0x4674c6(0x14b)),userBalance_service_1=require(_0x4674c6(0x181)),balance_constant_1=require(_0x4674c6(0x239)),chatLog_service_1=require('../chatLog/chatLog.service'),uuid=require(_0x4674c6(0x192)),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require(_0x4674c6(0x1f3)),typeorm_2=require('@nestjs/typeorm'),badwords_service_1=require(_0x4674c6(0x208)),autoreply_service_1=require(_0x4674c6(0x22a)),gptkeys_entity_1=require(_0x4674c6(0x229)),globalConfig_service_1=require(_0x4674c6(0x201)),fanyi_service_1=require('../fanyi/fanyi.service'),app_entity_1=require(_0x4674c6(0x1ed)),chatGroup_service_1=require(_0x4674c6(0x22d)),models_service_1=require(_0x4674c6(0x13d)),baidu_1=require('./baidu'),helper_1=require(_0x4674c6(0x1b9)),store_1=require(_0x4674c6(0x1ef)),zhipu_1=require(_0x4674c6(0x1a2)),openai_1=require('./openai'),chatBoxType_entity_1=require('./chatBoxType.entity'),chatBox_entity_1=require(_0x4674c6(0x151)),chatPre_entity_1=require('./chatPre.entity'),chatPreType_entity_1=require(_0x4674c6(0x1c8));let ChatgptService=class ChatgptService{constructor(_0x545d07,_0x31795f,_0x7a0757,_0x54e9f7,_0x1539f4,_0x353e50,_0x34e168,_0x127f9c,_0x41ccaf,_0xff6cb7,_0x2c8a04,_0x49cace,_0x27e4f7,_0x1fb5ed,_0x3d7439,_0x16b548,_0x1c5354,_0x470b86){const _0x50f1de=_0x4674c6;this['gptKeysEntity']=_0x545d07,this[_0x50f1de(0x1fc)]=_0x31795f,this[_0x50f1de(0x191)]=_0x7a0757,this[_0x50f1de(0x146)]=_0x54e9f7,this[_0x50f1de(0x163)]=_0x1539f4,this[_0x50f1de(0x1c0)]=_0x353e50,this['chatPreEntity']=_0x34e168,this['configService']=_0x127f9c,this[_0x50f1de(0x14e)]=_0x41ccaf,this[_0x50f1de(0x148)]=_0xff6cb7,this[_0x50f1de(0x170)]=_0x2c8a04,this[_0x50f1de(0x19c)]=_0x49cace,this['badwordsService']=_0x27e4f7,this[_0x50f1de(0x1ce)]=_0x1fb5ed,this[_0x50f1de(0x196)]=_0x3d7439,this['fanyiService']=_0x16b548,this[_0x50f1de(0x1bd)]=_0x1c5354,this[_0x50f1de(0x19d)]=_0x470b86,this[_0x50f1de(0x1af)]=null,this[_0x50f1de(0x18c)]=[],this[_0x50f1de(0x1dd)]={'list3':[],'list4':[]};}async[_0x4674c6(0x17b)](){const _0x4eca45=_0x4674c6;let _0x4ae795=await(0x0,utils_1[_0x4eca45(0x232)])(_0x4eca45(0x161)),_0x3e32d2=await(0x0,utils_1['importDynamic'])('@keyv/redis'),_0x2d4603=await(0x0,utils_1['importDynamic'])(_0x4eca45(0x1d2));_0x4ae795=(_0x4ae795===null||_0x4ae795===void 0x0?void 0x0:_0x4ae795[_0x4eca45(0x1be)])?_0x4ae795[_0x4eca45(0x1be)]:_0x4ae795,_0x3e32d2=(_0x3e32d2===null||_0x3e32d2===void 0x0?void 0x0:_0x3e32d2[_0x4eca45(0x1be)])?_0x3e32d2[_0x4eca45(0x1be)]:_0x3e32d2,_0x2d4603=(_0x2d4603===null||_0x2d4603===void 0x0?void 0x0:_0x2d4603[_0x4eca45(0x1be)])?_0x2d4603[_0x4eca45(0x1be)]:_0x2d4603;const {ChatGPTAPI:_0x23e45a,ChatGPTError:_0x41c8be,ChatGPTUnofficialProxyAPI:_0x23ab8}=_0x4ae795,_0x5de793=+process[_0x4eca45(0x1ae)]['REDIS_PORT'],_0x2f3542=process['env'][_0x4eca45(0x16d)],_0x1cd065=process['env'][_0x4eca45(0x244)],_0x35a710=process['env'][_0x4eca45(0x1b8)],_0xd0ec3a=_0x4eca45(0x172)+(_0x35a710||'')+':'+(_0x1cd065||'')+'@'+_0x2f3542+':'+_0x5de793,_0x1d5b4b=new _0x3e32d2(_0xd0ec3a),_0x120f46=new _0x2d4603({'store':_0x1d5b4b,'namespace':_0x4eca45(0x1f1)});this[_0x4eca45(0x1af)]=new store_1[(_0x4eca45(0x19f))]({'store':_0x120f46,'namespace':'chat'});}async[_0x4674c6(0x1b1)](_0x1108f2,_0x311acd,_0x3a8c80,_0x3e97bd=null){const _0x302f46=_0x4674c6;var _0x3d1601;!_0x3e97bd&&(_0x3e97bd=(_0x3d1601=await this[_0x302f46(0x19d)][_0x302f46(0x203)]())===null||_0x3d1601===void 0x0?void 0x0:_0x3d1601[_0x302f46(0x211)]);const {timeout:timeout=0x3c}=_0x3a8c80,{topN:_0x461482,model:_0x519774}=_0x3e97bd,{parentMessageId:parentMessageId=0x0}=_0x1108f2,_0x3efe20=await this['globalConfigService'][_0x302f46(0x19e)]([_0x302f46(0x18e)]),_0x7a949f=timeout*0x3e8||_0x3efe20||0x64*0x3e8,_0x4a3874={'parentMessageId':parentMessageId,'timeoutMs':+_0x7a949f,'completionParams':{'model':_0x519774,'temperature':_0x461482}};return _0x311acd&&(_0x4a3874[_0x302f46(0x213)]=_0x311acd),_0x4a3874;}async[_0x4674c6(0x1a7)](_0x555aa5){const _0x33f01=_0x4674c6,_0x1172d5=await this['modelsService'][_0x33f01(0x177)](),_0x355a79=await this[_0x33f01(0x196)]['getConfigs']([_0x33f01(0x1e4)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x266648,model:_0x107a4c}=_0x1172d5,_0x4c27bb=await this['getModelProxyUrl'](_0x1172d5),{context:_0xed90de}=await this[_0x33f01(0x1af)][_0x33f01(0x1f9)](_0x555aa5,{'parentMessageId':'','systemMessage':_0x355a79});try{const _0x34b67b=await(0x0,openai_1['sendMessageFromOpenAi'])(_0xed90de,{'apiKey':(0x0,utils_1[_0x33f01(0x176)])(_0x266648),'model':_0x107a4c,'proxyUrl':_0x4c27bb,'onProgress':null});return _0x34b67b===null||_0x34b67b===void 0x0?void 0x0:_0x34b67b[_0x33f01(0x1d0)];}catch(_0x2eec35){console[_0x33f01(0x209)](_0x33f01(0x23c),_0x2eec35);}}async['chatProcess'](_0x5f2fb7,_0x3f794a,_0x40d056){const _0x34e57e=_0x4674c6;var _0x451356,_0x5a91bb,_0x87be45,_0x25e5f6;const _0x45bfb9=_0x3f794a[_0x34e57e(0x142)],{options:options={},appId:_0x422fab,cusromPrompt:_0x498753,systemMessage:systemMessage=''}=_0x5f2fb7;let _0x117d7d=systemMessage;const {parentMessageId:_0x4b534f}=options,{prompt:_0x185f40,imageUrl:_0x23fbc9,model:_0x207add}=_0x5f2fb7,{groupId:_0x46576f,usingNetwork:_0x359365}=options,_0x1e2f49=await this[_0x34e57e(0x1bd)]['getGroupInfoFromId'](_0x46576f),_0x3fd9ab=(_0x1e2f49===null||_0x1e2f49===void 0x0?void 0x0:_0x1e2f49['config'])?JSON[_0x34e57e(0x188)](_0x1e2f49[_0x34e57e(0x205)]):await this[_0x34e57e(0x19d)][_0x34e57e(0x203)](),{keyType:_0x3bc7ee,model:_0x760207,topN:_0x89e83b,systemMessage:_0x35115e,rounds:_0x1a14e4}=_0x3fd9ab[_0x34e57e(0x211)];let _0x2baabb=null;!_0x498753?_0x2baabb=await this[_0x34e57e(0x19d)][_0x34e57e(0x20b)](_0x760207):_0x2baabb=await this[_0x34e57e(0x19d)]['getRandomDrawKey']();if(!_0x2baabb)throw new common_1[(_0x34e57e(0x1db))](_0x34e57e(0x1d9),common_1[_0x34e57e(0x228)]['BAD_REQUEST']);const {deduct:_0x33ec83,isTokenBased:_0x24a8af,tokenFeeRatio:_0x35afa0,deductType:_0x3c47b6,key:_0x4631b0,secret:_0xc67894,modelName:_0x507f37,id:_0x4414e6,accessToken:_0x27756f}=_0x2baabb;await this['userService']['checkUserStatus'](_0x3f794a['user']),await this[_0x34e57e(0x14e)][_0x34e57e(0x1da)](_0x3f794a,_0x3c47b6===0x1?_0x34e57e(0x222):_0x34e57e(0x158),_0x33ec83),_0x40d056&&_0x40d056['setHeader']('Content-type',_0x34e57e(0x235)),await this['badwordsService'][_0x34e57e(0x153)](_0x185f40,_0x3f794a[_0x34e57e(0x1c1)]['id']);const _0x14bf35=await this[_0x34e57e(0x1ce)][_0x34e57e(0x183)](_0x185f40);if(_0x14bf35&&_0x40d056){const _0x14bcca={'message':_0x14bf35,'code':0x1f4};return _0x40d056[_0x34e57e(0x1dc)](JSON['stringify'](_0x14bcca)),_0x40d056[_0x34e57e(0x1e2)]();}if(_0x422fab){const _0x4e6741=await this[_0x34e57e(0x163)][_0x34e57e(0x1c4)]({'where':{'id':_0x422fab,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x4e6741)throw new common_1[(_0x34e57e(0x1db))](_0x34e57e(0x1a0),common_1['HttpStatus'][_0x34e57e(0x14f)]);_0x4e6741[_0x34e57e(0x17e)]&&(_0x117d7d=_0x4e6741[_0x34e57e(0x17e)]);}else{if(_0x498753)_0x117d7d=systemMessage;else{if(_0x35115e)_0x117d7d=_0x35115e;else{const _0x3742c4=new Date()[_0x34e57e(0x1b2)]()[_0x34e57e(0x187)]('T')[0x0],_0x53b7e9=await this[_0x34e57e(0x196)][_0x34e57e(0x19e)](['systemPreMessage']);_0x117d7d=_0x53b7e9+(_0x34e57e(0x245)+_0x3742c4);}}}let _0x4d8b39='';if(_0x359365){_0x4d8b39=await(0x0,utils_1['compileNetwork'])(_0x185f40);const _0x178e29=new Date()[_0x34e57e(0x1b2)]()[_0x34e57e(0x187)]('T')[0x0],_0x4750f3=await this['globalConfigService'][_0x34e57e(0x19e)]([_0x34e57e(0x1e4)]);_0x117d7d=_0x4750f3+(_0x34e57e(0x245)+_0x178e29);}const _0x29be16=await this[_0x34e57e(0x1b1)](options,_0x117d7d,_0x2baabb,_0x3fd9ab['modelInfo']),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0xd5f063}=_0x2baabb;_0x40d056&&_0x40d056[_0x34e57e(0x23d)](0xc8);let _0x2e3c25=null,_0x57fe1a=null;try{if(_0x40d056){let _0xb3a26e=null,_0x44eaf7=![];_0x40d056['on']('close',async()=>{const _0x2df53a=_0x34e57e;if(_0x44eaf7)return;_0x45bfb9[_0x2df53a(0x1f2)]();const _0x4efc1f=await(0x0,openai_1[_0x2df53a(0x223)])(_0x185f40)||0x0,_0x1610b7=await(0x0,openai_1[_0x2df53a(0x223)])(_0xb3a26e===null||_0xb3a26e===void 0x0?void 0x0:_0xb3a26e[_0x2df53a(0x1d0)])||0x0,_0x58c61f=_0x4efc1f+_0x1610b7,_0x246721=(0x0,utils_1[_0x2df53a(0x1c3)])(_0x3f794a);await this['chatLogService'][_0x2df53a(0x1d7)]({'appId':_0x422fab,'curIp':_0x246721,'userId':_0x3f794a[_0x2df53a(0x1c1)]['id'],'type':balance_constant_1['DeductionKey']['CHAT_TYPE'],'prompt':_0x185f40,'imageUrl':_0x23fbc9,'activeModel':_0x207add,'answer':'','promptTokens':_0x4efc1f,'completionTokens':0x0,'totalTokens':_0x4efc1f,'model':_0x760207,'role':_0x2df53a(0x1c1),'groupId':_0x46576f,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x185f40})}),await this['chatLogService'][_0x2df53a(0x1d7)]({'appId':_0x422fab,'curIp':_0x246721,'userId':_0x3f794a[_0x2df53a(0x1c1)]['id'],'type':balance_constant_1[_0x2df53a(0x195)][_0x2df53a(0x20e)],'prompt':_0x185f40,'answer':_0xb3a26e===null||_0xb3a26e===void 0x0?void 0x0:_0xb3a26e[_0x2df53a(0x1d0)],'promptTokens':_0x4efc1f,'completionTokens':_0x1610b7,'totalTokens':_0x58c61f,'model':_0x760207,'role':_0x2df53a(0x1c5),'groupId':_0x46576f,'requestOptions':JSON[_0x2df53a(0x13c)]({'options':{'model':_0x760207,'temperature':_0x89e83b},'prompt':_0x185f40}),'conversationOptions':JSON[_0x2df53a(0x13c)]({'conversationId':_0xb3a26e===null||_0xb3a26e===void 0x0?void 0x0:_0xb3a26e[_0x2df53a(0x140)],'model':_0x760207,'parentMessageId':_0xb3a26e===null||_0xb3a26e===void 0x0?void 0x0:_0xb3a26e['id'],'temperature':_0x89e83b})});let _0x5b4a00=_0x33ec83;_0x24a8af===!![]&&(_0x5b4a00=Math[_0x2df53a(0x17c)](_0x33ec83*_0x58c61f/_0x35afa0)),await this['userBalanceService'][_0x2df53a(0x242)](_0x3f794a[_0x2df53a(0x1c1)]['id'],_0x2df53a(0x144)+(_0x3c47b6===0x1?0x3:0x4),_0x5b4a00,_0x58c61f);});if(Number(_0x3bc7ee)===0x1){const {key:_0x37f064,maxToken:_0x49539f,maxTokenRes:_0x2dacd3,proxyResUrl:_0x35572f}=await this[_0x34e57e(0x186)](_0x2baabb),{parentMessageId:_0x328234,completionParams:_0x2bfd3f,systemMessage:_0x485b09}=_0x29be16,{model:_0x37a988,temperature:_0x2a8cd0}=_0x2bfd3f,{context:_0x52c64d}=await this[_0x34e57e(0x1af)][_0x34e57e(0x1f9)](_0x359365?_0x4d8b39:_0x185f40,{'parentMessageId':_0x328234,'systemMessage':_0x485b09,'maxModelToken':_0x49539f,'maxResponseTokens':_0x2dacd3,'maxRounds':(0x0,helper_1[_0x34e57e(0x23f)])(_0x1a14e4),'imageUrl':_0x23fbc9,'activeModel':_0x207add});let _0x447d14=!![];_0x2e3c25=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x52c64d,{'maxToken':_0x49539f,'maxTokenRes':_0x2dacd3,'apiKey':_0x4631b0,'model':_0x37a988,'prompt':_0x185f40,'activeModel':_0x207add,'imageUrl':_0x23fbc9,'temperature':_0x2a8cd0,'proxyUrl':_0x35572f,'onProgress':_0xef8005=>{const _0x412bc3=_0x34e57e;_0x40d056[_0x412bc3(0x1dc)](_0x447d14?JSON['stringify'](_0xef8005):'\x0a'+JSON[_0x412bc3(0x13c)](_0xef8005)),_0xb3a26e=_0xef8005,_0x447d14=![];}},this[_0x34e57e(0x19c)]),_0x44eaf7=!![];}if(Number(_0x3bc7ee)===0x2){let _0x58aa4f=!![];const {context:_0x5f080a}=await this['nineStore'][_0x34e57e(0x1f9)](_0x359365?_0x4d8b39:_0x185f40,{'parentMessageId':_0x4b534f,'maxRounds':(0x0,helper_1[_0x34e57e(0x23f)])(_0x1a14e4)});_0x2e3c25=await(0x0,baidu_1[_0x34e57e(0x165)])(_0x359365?_0x4d8b39:_0x5f080a,{'temperature':_0x89e83b,'accessToken':_0x27756f,'model':_0x760207,'onProgress':_0x1391fb=>{const _0x179be6=_0x34e57e;_0x40d056['write'](_0x58aa4f?JSON['stringify'](_0x1391fb):'\x0a'+JSON[_0x179be6(0x13c)](_0x1391fb)),_0x58aa4f=![],_0xb3a26e=_0x1391fb;}}),_0x44eaf7=!![];}if(Number(_0x3bc7ee)===0x3){let _0x1bffe4=!![];const {context:_0x395cff}=await this[_0x34e57e(0x1af)][_0x34e57e(0x1f9)](_0x359365?_0x4d8b39:_0x185f40,{'parentMessageId':_0x4b534f,'maxRounds':(0x0,helper_1[_0x34e57e(0x23f)])(_0x1a14e4)});_0x2e3c25=await(0x0,zhipu_1['sendMessageFromZhipu'])(_0x359365?_0x4d8b39:_0x395cff,{'temperature':_0x89e83b,'key':_0xd5f063,'model':_0x760207,'onProgress':_0x107d3c=>{const _0x6272f3=_0x34e57e;_0x40d056[_0x6272f3(0x1dc)](_0x1bffe4?JSON[_0x6272f3(0x13c)](_0x107d3c):'\x0a'+JSON['stringify'](_0x107d3c)),_0x1bffe4=![],_0xb3a26e=_0x107d3c;}}),_0x44eaf7=!![];}const _0x2976c9={'id':this[_0x34e57e(0x1af)][_0x34e57e(0x1ca)](),'text':_0x185f40,'role':_0x34e57e(0x1c1),'name':undefined,'usage':null,'imageUrl':_0x23fbc9,'activeModel':_0x207add,'parentMessageId':_0x4b534f,'conversationId':_0x2e3c25===null||_0x2e3c25===void 0x0?void 0x0:_0x2e3c25[_0x34e57e(0x140)]};_0x57fe1a={'model':_0x760207,'parentMessageId':_0x4b534f},await this['nineStore']['setData'](_0x2976c9);const _0x58c65a={'id':_0x2e3c25['id'],'text':_0x2e3c25['text'],'role':_0x34e57e(0x1c5),'name':undefined,'usage':_0x2e3c25===null||_0x2e3c25===void 0x0?void 0x0:_0x2e3c25[_0x34e57e(0x1f7)],'imageUrl':_0x23fbc9,'parentMessageId':_0x2976c9['id'],'conversationId':_0x2e3c25===null||_0x2e3c25===void 0x0?void 0x0:_0x2e3c25[_0x34e57e(0x140)]};await this[_0x34e57e(0x1af)][_0x34e57e(0x1b0)](_0x58c65a),_0x57fe1a={'model':_0x760207,'parentMessageId':_0x2976c9['id']};}else{const {key:_0x4d7b83,maxToken:_0x437480,maxTokenRes:_0x3c16dd,proxyResUrl:_0x42a64d}=await this['formatModelToken'](_0x2baabb),{parentMessageId:_0x2bf4ac,completionParams:_0x397bd5,systemMessage:_0x1dee24}=_0x29be16,{model:_0x2233d3,temperature:_0x3c4261}=_0x397bd5,{context:_0x56910d}=await this['nineStore'][_0x34e57e(0x1f9)](_0x359365?_0x4d8b39:_0x185f40,{'parentMessageId':_0x2bf4ac,'systemMessage':_0x1dee24,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x1a14e4)});_0x2e3c25=await(0x0,openai_1[_0x34e57e(0x21d)])(_0x56910d,{'apiKey':_0x4631b0,'model':_0x2233d3,'temperature':_0x3c4261,'proxyUrl':_0x42a64d,'onProgress':null,'prompt':_0x185f40});}let _0x4466bf=null,_0x5ea2ed=null;_0x760207[_0x34e57e(0x18b)](_0x34e57e(0x1c9))?_0x4466bf=((_0x451356=_0x2e3c25['detail'])===null||_0x451356===void 0x0?void 0x0:_0x451356[_0x34e57e(0x1f7)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x5ea2ed=await(0x0,helper_1[_0x34e57e(0x154)])(_0x3bc7ee,_0x2e3c25,_0x57fe1a);const {prompt_tokens:_0x1cea4c,completion_tokens:_0x211e2b,total_tokens:_0x58a0e0}=_0x760207[_0x34e57e(0x18b)](_0x34e57e(0x1c9))?_0x4466bf:_0x5ea2ed[_0x34e57e(0x1f7)];let _0x335c28=_0x33ec83;_0x24a8af===!![]&&(_0x335c28=Math[_0x34e57e(0x17c)](_0x33ec83*_0x58a0e0/_0x35afa0));await this[_0x34e57e(0x14e)][_0x34e57e(0x242)](_0x3f794a[_0x34e57e(0x1c1)]['id'],_0x34e57e(0x144)+(_0x3c47b6===0x1?0x3:0x4),_0x335c28,_0x58a0e0),await this['modelsService']['saveUseLog'](_0x4414e6,_0x58a0e0);const _0x17c82e=(0x0,utils_1['getClientIp'])(_0x3f794a);await this[_0x34e57e(0x148)][_0x34e57e(0x1d7)]({'appId':_0x422fab,'curIp':_0x17c82e,'userId':_0x3f794a[_0x34e57e(0x1c1)]['id'],'type':balance_constant_1['DeductionKey'][_0x34e57e(0x20e)],'prompt':_0x185f40,'imageUrl':_0x23fbc9,'activeModel':_0x207add,'answer':'','promptTokens':_0x1cea4c,'completionTokens':0x0,'totalTokens':_0x58a0e0,'model':_0x760207,'role':_0x34e57e(0x1c1),'groupId':_0x46576f,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x185f40})}),await this[_0x34e57e(0x148)]['saveChatLog']({'appId':_0x422fab,'curIp':_0x17c82e,'userId':_0x3f794a['user']['id'],'type':balance_constant_1['DeductionKey']['CHAT_TYPE'],'prompt':_0x185f40,'imageUrl':_0x2e3c25===null||_0x2e3c25===void 0x0?void 0x0:_0x2e3c25['imageUrl'],'answer':_0x2e3c25[_0x34e57e(0x1d0)],'promptTokens':_0x1cea4c,'completionTokens':_0x211e2b,'totalTokens':_0x58a0e0,'model':_0x760207,'role':_0x34e57e(0x1c5),'groupId':_0x46576f,'requestOptions':JSON[_0x34e57e(0x13c)]({'options':{'model':_0x760207,'temperature':_0x89e83b},'prompt':_0x185f40}),'conversationOptions':JSON[_0x34e57e(0x13c)]({'conversationId':_0x2e3c25[_0x34e57e(0x140)],'model':_0x760207,'parentMessageId':_0x2e3c25['id'],'temperature':_0x89e83b})}),common_1[_0x34e57e(0x15b)][_0x34e57e(0x1e5)]('用户ID:\x20'+_0x3f794a['user']['id']+_0x34e57e(0x141)+_0x507f37+'-'+_0x207add+_0x34e57e(0x218)+_0x58a0e0+_0x34e57e(0x14a)+_0x335c28,_0x34e57e(0x1b5));const _0x16c764=await this[_0x34e57e(0x14e)][_0x34e57e(0x1ee)](_0x3f794a[_0x34e57e(0x1c1)]['id']);return _0x2e3c25['userBanance']=Object[_0x34e57e(0x217)]({},_0x16c764),_0x2e3c25[_0x34e57e(0x237)]&&(_0x2e3c25[_0x34e57e(0x237)]=''),_0x2e3c25[_0x34e57e(0x220)]=!![],_0x40d056?_0x40d056[_0x34e57e(0x1dc)]('\x0a'+JSON[_0x34e57e(0x13c)](_0x2e3c25)):_0x2e3c25[_0x34e57e(0x1d0)];}catch(_0x596935){console[_0x34e57e(0x209)](_0x34e57e(0x1b7),_0x4631b0,_0x596935);const _0x2d16a6=(_0x596935===null||_0x596935===void 0x0?void 0x0:_0x596935[_0x34e57e(0x164)])||0x190,_0x4e5c40=((_0x5a91bb=_0x596935===null||_0x596935===void 0x0?void 0x0:_0x596935[_0x34e57e(0x215)])===null||_0x5a91bb===void 0x0?void 0x0:_0x5a91bb['status'])||(_0x596935===null||_0x596935===void 0x0?void 0x0:_0x596935[_0x34e57e(0x164)])||0x190;console['log'](_0x34e57e(0x20d),_0x34e57e(0x1c2),_0x2d16a6,'message',_0x596935===null||_0x596935===void 0x0?void 0x0:_0x596935['message'],_0x34e57e(0x199),(_0x87be45=_0x596935===null||_0x596935===void 0x0?void 0x0:_0x596935[_0x34e57e(0x215)])===null||_0x87be45===void 0x0?void 0x0:_0x87be45['statusText'],_0x34e57e(0x23d),(_0x25e5f6=_0x596935===null||_0x596935===void 0x0?void 0x0:_0x596935[_0x34e57e(0x215)])===null||_0x25e5f6===void 0x0?void 0x0:_0x25e5f6[_0x34e57e(0x23d)]);if(_0x596935[_0x34e57e(0x23d)]&&_0x596935[_0x34e57e(0x23d)]===0x192){const _0x2cbe2c={'message':'Catch\x20Error\x20'+_0x596935[_0x34e57e(0x243)],'code':0x192};if(_0x40d056)return _0x40d056[_0x34e57e(0x1dc)](JSON['stringify'](_0x2cbe2c));else throw new common_1[(_0x34e57e(0x1db))](_0x596935[_0x34e57e(0x243)],common_1[_0x34e57e(0x228)][_0x34e57e(0x21c)]);}if(!_0x4e5c40){if(_0x40d056)return _0x40d056[_0x34e57e(0x1dc)](JSON['stringify']({'message':_0x596935['message'],'code':0x1f4}));else throw new common_1[(_0x34e57e(0x1db))](_0x596935[_0x34e57e(0x243)],common_1[_0x34e57e(0x228)][_0x34e57e(0x14f)]);}let _0x204130=errorMessage_constant_1[_0x34e57e(0x1f6)][_0x4e5c40]?errorMessage_constant_1[_0x34e57e(0x1f6)][_0x4e5c40]:_0x34e57e(0x159);(_0x596935===null||_0x596935===void 0x0?void 0x0:_0x596935['message'][_0x34e57e(0x18b)](_0x34e57e(0x19b)))&&Number(_0x3bc7ee)===0x1&&(await this['modelsService']['lockKey'](_0x4414e6,_0x34e57e(0x189),-0x1),_0x204130=_0x34e57e(0x157));(_0x596935===null||_0x596935===void 0x0?void 0x0:_0x596935['statusCode'])===0x1ad&&_0x596935[_0x34e57e(0x243)][_0x34e57e(0x18b)](_0x34e57e(0x152))&&Number(_0x3bc7ee)===0x1&&(await this[_0x34e57e(0x19d)][_0x34e57e(0x21e)](_0x4414e6,_0x34e57e(0x233),-0x3),_0x204130=_0x34e57e(0x1cc));(_0x596935===null||_0x596935===void 0x0?void 0x0:_0x596935[_0x34e57e(0x164)])===0x1ad&&(_0x596935===null||_0x596935===void 0x0?void 0x0:_0x596935['statusText'])===_0x34e57e(0x1ea)&&(_0x204130=_0x34e57e(0x231));(_0x596935===null||_0x596935===void 0x0?void 0x0:_0x596935['statusCode'])===0x191&&_0x596935[_0x34e57e(0x243)]['includes'](_0x34e57e(0x171))&&Number(_0x3bc7ee)===0x1&&(await this[_0x34e57e(0x19d)]['lockKey'](_0x4414e6,'提供了错误的模型秘钥',-0x2),_0x204130=_0x34e57e(0x16e));(_0x596935===null||_0x596935===void 0x0?void 0x0:_0x596935[_0x34e57e(0x164)])===0x194&&_0x596935['message']['includes'](_0x34e57e(0x23e))&&Number(_0x3bc7ee)===0x1&&(await this[_0x34e57e(0x19d)][_0x34e57e(0x21e)](_0x4414e6,_0x34e57e(0x166),-0x4),_0x204130=_0x34e57e(0x1d8));_0x2d16a6===0x190&&console[_0x34e57e(0x209)](_0x34e57e(0x18a),_0x596935,_0x596935[_0x34e57e(0x243)]);const _0x2a9867={'message':_0x204130||'Please\x20check\x20the\x20back-end\x20console','code':_0x2d16a6===0x191?0x190:_0x2d16a6||0x1f4};if(_0x40d056)return _0x40d056[_0x34e57e(0x1dc)](JSON[_0x34e57e(0x13c)](_0x2a9867));else throw new common_1[(_0x34e57e(0x1db))](_0x2a9867['message'],common_1[_0x34e57e(0x228)][_0x34e57e(0x14f)]);}finally{_0x40d056&&_0x40d056[_0x34e57e(0x1e2)]();}}async[_0x4674c6(0x1fb)](_0x9977d6,_0x2219fd){const _0x4d0898=_0x4674c6;var _0x412099,_0x4153b4,_0x31d666,_0x5671d8;await this[_0x4d0898(0x1eb)]['checkBadWords'](_0x9977d6[_0x4d0898(0x236)],_0x2219fd[_0x4d0898(0x1c1)]['id']),await this[_0x4d0898(0x170)][_0x4d0898(0x1d3)](_0x2219fd[_0x4d0898(0x1c1)]);const _0x1eeff3=(_0x9977d6===null||_0x9977d6===void 0x0?void 0x0:_0x9977d6[_0x4d0898(0x241)])==='hd'?0x4:0x2;await this['userBalanceService'][_0x4d0898(0x1da)](_0x2219fd,_0x4d0898(0x1cd),_0x1eeff3);let _0x2a3d36=[];const _0x1a08e3=await this[_0x4d0898(0x19d)][_0x4d0898(0x20b)]('dall-e-3'),_0x2c8486=_0x1a08e3===null||_0x1a08e3===void 0x0?void 0x0:_0x1a08e3['id'],{key:_0x580749,proxyResUrl:_0x35c5fb}=await this['formatModelToken'](_0x1a08e3);common_1[_0x4d0898(0x15b)]['log'](_0x4d0898(0x145)+_0x9977d6[_0x4d0898(0x236)]+_0x4d0898(0x238)+_0x580749,_0x4d0898(0x1bb));try{const _0x3d2854=_0x35c5fb+'/v1/images/generations',_0x3e707f=Object[_0x4d0898(0x217)](Object[_0x4d0898(0x217)]({},_0x9977d6),{'model':_0x4d0898(0x1a5)});console[_0x4d0898(0x209)](_0x4d0898(0x197),_0x3e707f);const _0x3e5aed=await axios_1[_0x4d0898(0x1be)][_0x4d0898(0x23b)](_0x3d2854,Object[_0x4d0898(0x217)](Object['assign']({},_0x3e707f),{'response_format':_0x4d0898(0x155)}),{'headers':{'Authorization':'Bearer\x20'+_0x580749}});_0x2a3d36=_0x3e5aed['data'][_0x4d0898(0x198)];const _0x213751=[];for(const _0x84cec5 of _0x2a3d36){const _0x4e9117=uuid['v4']()[_0x4d0898(0x1e8)](0x0,0xa)+_0x4d0898(0x17f),_0x53b961=Buffer[_0x4d0898(0x185)](_0x84cec5[_0x4d0898(0x155)],_0x4d0898(0x234));_0x213751[_0x4d0898(0x1ff)](this[_0x4d0898(0x19c)]['uploadFile']({'filename':_0x4e9117,'buffer':_0x53b961}));}const _0x5b2950=await Promise[_0x4d0898(0x1bc)](_0x213751);await this[_0x4d0898(0x14e)]['deductFromBalance'](_0x2219fd[_0x4d0898(0x1c1)]['id'],_0x4d0898(0x1cd),(_0x3e707f===null||_0x3e707f===void 0x0?void 0x0:_0x3e707f['quality'])==='standard'?0x2:0x4,_0x1eeff3);const _0x1199d5=(0x0,utils_1[_0x4d0898(0x1c3)])(_0x2219fd),_0x5e61fc=[],_0x508d39=await this[_0x4d0898(0x19c)][_0x4d0898(0x13a)](),[_0xd2eb78,_0x3213f7]=_0x9977d6[_0x4d0898(0x1f8)]['split']('x');return _0x5b2950[_0x4d0898(0x19a)](_0x22a0ca=>{const _0x6c4477=_0x4d0898;_0x5e61fc[_0x6c4477(0x1ff)](this['chatLogService']['saveChatLog']({'curIp':_0x1199d5,'userId':_0x2219fd['user']['id'],'type':balance_constant_1[_0x6c4477(0x195)]['PAINT_TYPE'],'prompt':_0x9977d6['prompt'],'answer':_0x22a0ca,'fileInfo':JSON[_0x6c4477(0x13c)]({'cosType':_0x508d39,'width':_0xd2eb78,'height':_0x3213f7,'cosUrl':_0x22a0ca}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x6c4477(0x1a5)}));}),await Promise['all'](_0x5e61fc),_0x5b2950;}catch(_0x459f65){const _0x4f85b9=((_0x412099=_0x459f65===null||_0x459f65===void 0x0?void 0x0:_0x459f65[_0x4d0898(0x215)])===null||_0x412099===void 0x0?void 0x0:_0x412099['status'])||0x1f4;console[_0x4d0898(0x209)]('openai-draw\x20error:\x20',JSON[_0x4d0898(0x13c)](_0x459f65),_0x580749,_0x4f85b9);const _0xd29b4c=(_0x5671d8=(_0x31d666=(_0x4153b4=_0x459f65===null||_0x459f65===void 0x0?void 0x0:_0x459f65[_0x4d0898(0x215)])===null||_0x4153b4===void 0x0?void 0x0:_0x4153b4[_0x4d0898(0x198)])===null||_0x31d666===void 0x0?void 0x0:_0x31d666[_0x4d0898(0x22c)])===null||_0x5671d8===void 0x0?void 0x0:_0x5671d8[_0x4d0898(0x243)];if(_0x4f85b9===0x1ad)throw new common_1[(_0x4d0898(0x1db))](_0x4d0898(0x1b4),common_1[_0x4d0898(0x228)][_0x4d0898(0x14f)]);if(_0x4f85b9===0x190&&_0xd29b4c[_0x4d0898(0x18b)](_0x4d0898(0x1e3)))throw new common_1[(_0x4d0898(0x1db))](_0x4d0898(0x1cf),common_1[_0x4d0898(0x228)][_0x4d0898(0x14f)]);if(_0x4f85b9===0x190&&_0xd29b4c[_0x4d0898(0x18b)](_0x4d0898(0x16f))){await this[_0x4d0898(0x19d)][_0x4d0898(0x21e)](_0x2c8486,_0x4d0898(0x189),-0x1);throw new common_1[(_0x4d0898(0x1db))](_0x4d0898(0x160),common_1[_0x4d0898(0x228)][_0x4d0898(0x14f)]);}if(_0x4f85b9===0x1f4)throw new common_1[(_0x4d0898(0x1db))]('绘制图片失败，请检查你的提示词是否有非法描述！',common_1[_0x4d0898(0x228)][_0x4d0898(0x14f)]);if(_0x4f85b9===0x191)throw new common_1[(_0x4d0898(0x1db))](_0x4d0898(0x1f4),common_1[_0x4d0898(0x228)][_0x4d0898(0x14f)]);throw new common_1[(_0x4d0898(0x1db))](_0x4d0898(0x1f0),common_1[_0x4d0898(0x228)][_0x4d0898(0x14f)]);}}async['getAllKeyList'](){const _0x4b2674=_0x4674c6,_0x1e56d4=await this['gptKeysEntity'][_0x4b2674(0x1ba)]({'where':{'status':0x1},'select':['id',_0x4b2674(0x22e),_0x4b2674(0x200),_0x4b2674(0x144),_0x4b2674(0x230),_0x4b2674(0x246),_0x4b2674(0x17d),'openaiTimeoutMs']}),_0x5bd2e8=_0x1e56d4['filter'](_0x1947af=>_0x1947af[_0x4b2674(0x144)][_0x4b2674(0x18b)](_0x4b2674(0x1aa))),_0x3191b7=_0x1e56d4[_0x4b2674(0x210)](_0x3b5df2=>_0x3b5df2[_0x4b2674(0x144)][_0x4b2674(0x18b)](_0x4b2674(0x1bf)));this[_0x4b2674(0x1dd)]={'list3':_0x5bd2e8,'list4':_0x3191b7};}async['getModelProxyUrl'](_0x47a2d1){const _0x16a5ba=_0x4674c6,_0x23a760=await this[_0x16a5ba(0x196)]['getConfigs'](['openaiBaseUrl']);return(_0x47a2d1===null||_0x47a2d1===void 0x0?void 0x0:_0x47a2d1[_0x16a5ba(0x14c)])||_0x23a760||_0x16a5ba(0x16b);}async['formatModelToken'](_0x5fb1f8){const _0x3d27a=_0x4674c6,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x3d27a(0x196)][_0x3d27a(0x19e)]([_0x3d27a(0x178),_0x3d27a(0x1a4),_0x3d27a(0x184),_0x3d27a(0x1b6),_0x3d27a(0x219),'openaiModel4MaxTokensRes','openaiModel4MaxTokens32k',_0x3d27a(0x23a),_0x3d27a(0x1ec)]);let _0x3cd974=null,_0x49be70=null,_0x37750e=null,{model:_0x2ddc56,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x5b852d}=_0x5fb1f8;return _0x2ddc56['toLowerCase']()[_0x3d27a(0x18b)](_0x3d27a(0x1bf))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x49be70>=0x1000&&(maxModelTokens=0x1000),_0x3cd974=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x49be70=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x2ddc56[_0x3d27a(0x226)]()['includes'](_0x3d27a(0x207))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x49be70>=0x4000&&(maxModelTokens=0x4000),_0x3cd974=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x49be70=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x2ddc56[_0x3d27a(0x226)]()[_0x3d27a(0x18b)]('1106')&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x49be70>=0x1000&&(maxModelTokens=0x1000),_0x3cd974=maxModelTokens||0x3ffc,_0x49be70=maxResponseTokens||0x1000)),_0x2ddc56[_0x3d27a(0x226)]()[_0x3d27a(0x18b)](_0x3d27a(0x1aa))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x49be70>=0x7d0&&(maxModelTokens=0x7d0),_0x3cd974=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x49be70=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x2ddc56[_0x3d27a(0x226)]()['includes'](_0x3d27a(0x1df))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x49be70>=0x2000&&(maxModelTokens=0x2000),_0x3cd974=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x49be70=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x2ddc56[_0x3d27a(0x226)]()[_0x3d27a(0x18b)](_0x3d27a(0x1fa))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x49be70>=0x1000&&(maxModelTokens=0x1000),_0x3cd974=maxModelTokens||0x4000,_0x49be70=maxResponseTokens||0x1000)),_0x37750e=proxyUrl||openaiBaseUrl||'https://api.openai.com',_0x49be70>=_0x3cd974&&(_0x49be70=Math[_0x3d27a(0x193)](_0x3cd974/0x2)),{'key':_0x5b852d,'maxToken':_0x3cd974,'maxTokenRes':_0x49be70,'proxyResUrl':_0x37750e};}async[_0x4674c6(0x194)](_0x502264,_0x38caee){const _0x91c045=_0x4674c6;try{const {name:_0x30c369,icon:_0x3d055f,order:_0x2e1d03,id:_0xfe18,status:_0x2526d6}=_0x38caee;return _0xfe18?await this[_0x91c045(0x191)][_0x91c045(0x179)]({'id':_0xfe18},{'name':_0x30c369,'icon':_0x3d055f,'order':_0x2e1d03,'status':_0x2526d6}):await this['chatBoxTypeEntity'][_0x91c045(0x1d6)]({'name':_0x30c369,'icon':_0x3d055f,'order':_0x2e1d03,'status':_0x2526d6});}catch(_0x298f2a){console[_0x91c045(0x209)]('error:\x20',_0x298f2a);}}async['delChatBoxType'](_0x37a545,_0x2ddc0b){const _0x30b9b8=_0x4674c6,{id:_0x3dad3a}=_0x2ddc0b;if(!_0x3dad3a)throw new common_1[(_0x30b9b8(0x1db))](_0x30b9b8(0x1b3),common_1[_0x30b9b8(0x228)][_0x30b9b8(0x14f)]);const _0x5c0fcd=await this[_0x30b9b8(0x146)]['count']({'where':{'typeId':_0x3dad3a}});if(_0x5c0fcd)throw new common_1[(_0x30b9b8(0x1db))](_0x30b9b8(0x240),common_1[_0x30b9b8(0x228)]['BAD_REQUEST']);return await this['chatBoxTypeEntity'][_0x30b9b8(0x22b)]({'id':_0x3dad3a});}async[_0x4674c6(0x13e)](){const _0x5c6fc4=_0x4674c6;return await this[_0x5c6fc4(0x191)]['find']({'order':{'order':_0x5c6fc4(0x202)}});}async[_0x4674c6(0x1de)](_0x1995fc,_0x125e10){const _0x43171d=_0x4674c6,{title:_0x322d92,prompt:_0x1f2182,appId:_0x42817b,order:_0x339503,status:_0x34f57f,typeId:_0xa2a3a4,id:_0x21f100,url:_0x40ee1e}=_0x125e10;if(!_0xa2a3a4)throw new common_1[(_0x43171d(0x1db))]('缺失必要参数！',common_1['HttpStatus']['BAD_REQUEST']);try{const _0x870ea5={'title':_0x322d92,'order':_0x339503,'status':_0x34f57f,'typeId':_0xa2a3a4,'url':_0x40ee1e};return _0x870ea5[_0x43171d(0x1e6)]=_0x42817b||0x0,_0x870ea5[_0x43171d(0x236)]=_0x1f2182||'',_0x21f100?await this[_0x43171d(0x146)][_0x43171d(0x179)]({'id':_0x21f100},_0x870ea5):await this[_0x43171d(0x146)][_0x43171d(0x1d6)](_0x870ea5);}catch(_0x69e7f8){console[_0x43171d(0x209)](_0x43171d(0x23c),_0x69e7f8);}}async[_0x4674c6(0x1e7)](_0x1018f0,_0x2ccd66){const _0x2f7c0a=_0x4674c6,{id:_0x3023c5}=_0x2ccd66;if(!_0x3023c5)throw new common_1[(_0x2f7c0a(0x1db))]('非法操作！',common_1[_0x2f7c0a(0x228)][_0x2f7c0a(0x14f)]);return await this[_0x2f7c0a(0x146)]['delete']({'id':_0x3023c5});}async[_0x4674c6(0x227)](){const _0x111994=_0x4674c6,_0x5a99b8=await this[_0x111994(0x146)]['find']({'order':{'order':_0x111994(0x202)}}),_0x3df228=[...new Set(_0x5a99b8['map'](_0x27a7f3=>_0x27a7f3[_0x111994(0x1a6)]))],_0x21096d=[...new Set(_0x5a99b8['map'](_0x555ccc=>_0x555ccc[_0x111994(0x1e6)]))],_0x15a0cc=await this[_0x111994(0x191)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x3df228)}}),_0x394071=await this[_0x111994(0x163)][_0x111994(0x1ba)]({'where':{'id':(0x0,typeorm_1['In'])(_0x21096d)}});return _0x5a99b8[_0x111994(0x216)](_0x18600a=>{const _0x3d9ab8=_0x111994,{typeId:_0x18fd93,appId:_0x163031}=_0x18600a;return _0x18600a[_0x3d9ab8(0x225)]=_0x15a0cc['find'](_0x4020b7=>_0x4020b7['id']===_0x18fd93),_0x18600a[_0x3d9ab8(0x15a)]=_0x394071['find'](_0x4596da=>_0x4596da['id']===_0x163031),_0x18600a;});}async[_0x4674c6(0x1e9)](){const _0x636e71=_0x4674c6,_0x19c357=await this[_0x636e71(0x191)][_0x636e71(0x1ba)]({'order':{'order':'DESC'},'where':{'status':!![]}}),_0x453607=await this[_0x636e71(0x146)][_0x636e71(0x1ba)]({'where':{'status':!![]}}),_0x411c74=[...new Set(_0x453607[_0x636e71(0x216)](_0x292241=>_0x292241[_0x636e71(0x1e6)]))],_0x3903ef=await this[_0x636e71(0x163)][_0x636e71(0x1ba)]({'where':{'id':(0x0,typeorm_1['In'])(_0x411c74)}});return _0x453607[_0x636e71(0x19a)](_0x398553=>{const _0x3c31b0=_0x636e71,_0x185d13=_0x3903ef[_0x3c31b0(0x1ba)](_0x164cdc=>_0x164cdc['id']===_0x398553[_0x3c31b0(0x1e6)]);return _0x398553['coverImg']=_0x185d13===null||_0x185d13===void 0x0?void 0x0:_0x185d13['coverImg'],_0x398553;}),_0x19c357['map'](_0x458723=>{const _0x2438d9=_0x636e71;return _0x458723[_0x2438d9(0x18d)]=_0x453607[_0x2438d9(0x210)](_0x43905f=>_0x43905f['typeId']===_0x458723['id']&&_0x43905f[_0x2438d9(0x23d)]),_0x458723;});}async[_0x4674c6(0x180)](_0x2e3bb8,_0x357925){const _0x7e6331=_0x4674c6;try{const {name:_0x133b42,icon:_0x2116d7,order:_0x33acd3,id:_0x4889cb,status:_0x253c42}=_0x357925;return _0x4889cb?await this[_0x7e6331(0x1c0)]['update']({'id':_0x4889cb},{'name':_0x133b42,'icon':_0x2116d7,'order':_0x33acd3,'status':_0x253c42}):await this[_0x7e6331(0x1c0)]['save']({'name':_0x133b42,'icon':_0x2116d7,'order':_0x33acd3,'status':_0x253c42});}catch(_0x47a8f8){console[_0x7e6331(0x209)]('error:\x20',_0x47a8f8);}}async[_0x4674c6(0x1ab)](_0x34147e,_0x4b1b4a){const _0xfd096b=_0x4674c6,{id:_0x183c49}=_0x4b1b4a;if(!_0x183c49)throw new common_1[(_0xfd096b(0x1db))](_0xfd096b(0x1b3),common_1[_0xfd096b(0x228)][_0xfd096b(0x14f)]);const _0x16cdf7=await this[_0xfd096b(0x146)][_0xfd096b(0x182)]({'where':{'typeId':_0x183c49}});if(_0x16cdf7)throw new common_1[(_0xfd096b(0x1db))](_0xfd096b(0x240),common_1[_0xfd096b(0x228)][_0xfd096b(0x14f)]);return await this[_0xfd096b(0x1c0)][_0xfd096b(0x22b)]({'id':_0x183c49});}async['queryChatPreType'](){const _0x5c290e=_0x4674c6;return await this[_0x5c290e(0x1c0)]['find']({'order':{'order':'DESC'}});}async[_0x4674c6(0x168)](_0x31f45d,_0x331729){const _0xd4e7d3=_0x4674c6,{title:_0x5658b3,prompt:_0x3f1298,appId:_0x1612f0,order:_0x555d02,status:_0x15905d,typeId:_0x1486fc,id:_0x2ba608,url:_0x11fac0}=_0x331729;if(!_0x1486fc)throw new common_1['HttpException'](_0xd4e7d3(0x15c),common_1[_0xd4e7d3(0x228)][_0xd4e7d3(0x14f)]);try{const _0x6ccebb={'title':_0x5658b3,'prompt':_0x3f1298,'order':_0x555d02,'status':_0x15905d,'typeId':_0x1486fc,'url':_0x11fac0};return _0x2ba608?await this[_0xd4e7d3(0x1f5)][_0xd4e7d3(0x179)]({'id':_0x2ba608},_0x6ccebb):await this['chatPreEntity'][_0xd4e7d3(0x1d6)](_0x6ccebb);}catch(_0x1fc205){console[_0xd4e7d3(0x209)](_0xd4e7d3(0x23c),_0x1fc205);}}async[_0x4674c6(0x15d)](_0x18282f,_0x5ee98b){const _0x2c89fa=_0x4674c6,{id:_0x3d1c8c}=_0x5ee98b;if(!_0x3d1c8c)throw new common_1[(_0x2c89fa(0x1db))](_0x2c89fa(0x1b3),common_1[_0x2c89fa(0x228)][_0x2c89fa(0x14f)]);return await this[_0x2c89fa(0x1f5)][_0x2c89fa(0x22b)]({'id':_0x3d1c8c});}async[_0x4674c6(0x1c6)](){const _0x588ead=_0x4674c6,_0x5be36a=await this[_0x588ead(0x1f5)][_0x588ead(0x1ba)]({'order':{'order':_0x588ead(0x202)}}),_0x739e1b=[...new Set(_0x5be36a[_0x588ead(0x216)](_0x47f13e=>_0x47f13e[_0x588ead(0x1a6)]))],_0x14513a=await this['chatPreTypeEntity'][_0x588ead(0x1ba)]({'where':{'id':(0x0,typeorm_1['In'])(_0x739e1b)}});return _0x5be36a[_0x588ead(0x216)](_0x52fb34=>{const _0x4a541b=_0x588ead,{typeId:_0x3d23d9,appId:_0x80f29e}=_0x52fb34;return _0x52fb34[_0x4a541b(0x225)]=_0x14513a[_0x4a541b(0x1ba)](_0x47ba14=>_0x47ba14['id']===_0x3d23d9),_0x52fb34;});}async[_0x4674c6(0x156)](){const _0x23b9c3=_0x4674c6,_0x1ff3bb=await this[_0x23b9c3(0x1c0)][_0x23b9c3(0x1ba)]({'order':{'order':_0x23b9c3(0x202)},'where':{'status':!![]}}),_0x46b768=await this['chatPreEntity']['find']({'where':{'status':!![]}});return _0x1ff3bb[_0x23b9c3(0x216)](_0x466d87=>{const _0x282586=_0x23b9c3;return _0x466d87[_0x282586(0x18d)]=_0x46b768[_0x282586(0x210)](_0xfd2f4b=>_0xfd2f4b['typeId']===_0x466d87['id']&&_0xfd2f4b['status']),_0x466d87;});}async[_0x4674c6(0x1fe)](_0x5dc68a,_0x3e4d81,_0xc92d0){const _0x45b454=_0x4674c6;let _0x44db5a=0x1000,_0x4c14d5=0x800;return _0x5dc68a[_0x45b454(0x226)]()['includes'](_0x45b454(0x1bf))&&(_0x44db5a=_0x3e4d81>=0x2004?0x2004:_0x3e4d81,_0x4c14d5=_0xc92d0>=0x1000?0x1000:_0xc92d0,_0x5dc68a[_0x45b454(0x226)]()['includes'](_0x45b454(0x207))&&(_0x44db5a=_0x3e4d81>=0x8000?0x8000:_0x3e4d81,_0x4c14d5=_0xc92d0>=0x3e80?0x3e80:_0xc92d0),(_0x5dc68a[_0x45b454(0x226)]()[_0x45b454(0x18b)](_0x45b454(0x16a))||_0x5dc68a['toLowerCase']()[_0x45b454(0x18b)](_0x45b454(0x15e)))&&(_0x44db5a=_0x3e4d81>=0x1f400?0x1f400:_0x3e4d81,_0x4c14d5=_0xc92d0>=0x1000?0x1000:_0xc92d0)),_0x5dc68a[_0x45b454(0x226)]()[_0x45b454(0x18b)](_0x45b454(0x1aa))&&(_0x44db5a=_0x3e4d81>=0x1000?0x1000:_0x3e4d81,_0x4c14d5=_0xc92d0>=0x800?0x800:_0xc92d0,_0x5dc68a['toLowerCase']()[_0x45b454(0x18b)](_0x45b454(0x1df))&&(_0x44db5a=_0x3e4d81>=0x4000?0x4000:_0x3e4d81,_0x4c14d5=_0xc92d0>=0x1f40?0x1f40:_0xc92d0),_0x5dc68a[_0x45b454(0x226)]()[_0x45b454(0x18b)](_0x45b454(0x1fa))&&(_0x44db5a=_0x3e4d81>=0x4000?0x4000:_0x3e4d81,_0x4c14d5=_0xc92d0>=0x1f40?0x1f40:_0xc92d0)),{'maxToken':_0x44db5a,'maxRes':_0x4c14d5};}};function _0x1154(){const _0x28cc86=['chatgpt-ai-web','5376912ujBmkh','appEntity','statusCode','sendMessageFromBaidu','当前模型不是聊天模型','object','setChatPre','11SClKcy','gpt-4-1106','https://api.openai.com','3OMZpAo','REDIS_HOST','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','Billing\x20hard\x20limit\x20has\x20been\x20reached','userService','Incorrect\x20API\x20key\x20provided','redis://','../../common/utils','__metadata','__param','removeSpecialCharacters','getRandomDrawKey','openaiModel3MaxTokens','update','4403330qwYLCs','onModuleInit','ceil','openaiProxyUrl','preset','.png','setChatPreType','../userBalance/userBalance.service','count','checkAutoReply','openaiModel3MaxTokens16k','from','formatModelToken','split','parse','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','400\x20error','includes','whiteListUser','childList','openaiTimeoutMs','GlobalConfigService','3524QZQnvF','chatBoxTypeEntity','uuid','floor','setChatBoxType','DeductionKey','globalConfigService','dall-e\x20draw\x20params:\x20','data','statusText:','forEach','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','uploadService','modelsService','getConfigs','NineStore','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','161VapWWp','./zhipu','@nestjs/common','openaiModel3MaxTokensRes','dall-e-3','typeId','chatSyncFree','411663mJjIML','Injectable','gpt-3','delChatPreType','function','169116zTfTDX','env','nineStore','setData','getRequestParams','toISOString','非法操作！','当前请求已过载、请稍等会儿再试试吧！','ChatgptService','openaiModel3MaxTokens16kRes','chat-error\x20<----------------------------------------->','REDIS_USER','./helper','find','DrawService','all','chatGroupService','default','gpt-4','chatPreTypeEntity','user','code:\x20','getClientIp','findOne','assistant','queryChatPre','ConfigService','./chatPreType.entity','dall','getUuid','ChatPreEntity','当前模型key余额已耗尽','mjDraw','autoreplyService','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','text','UploadService','keyv','checkUserStatus','GptKeysEntity','875694MpcFaM','save','saveChatLog','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','validateBalance','HttpException','write','keyPool','setChatBox','16k','nestjs-config','2995227iifOES','end','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','systemPreMessage','debug','appId','delChatBox','slice','queryChatBoxFrontend','Too\x20Many\x20Requests','badwordsService','openaiBaseUrl','../app/app.entity','queryUserBalance','./store','绘制图片失败，请稍后试试吧！','nineai-chatlog','abort','typeorm','绘制图片失败，此次绘画被拒绝了！','chatPreEntity','OpenAiErrorCodeMessage','usage','size','buildMessageFromParentMessageId','1106','draw','configEntity','./../user/user.service','getMaxTokenFromModelWithOpenAi','push','weight','../globalConfig/globalConfig.service','DESC','getBaseConfig','../../common/constants/errorMessage.constant','config','length','32k','../badwords/badwords.service','log','InjectRepository','getCurrentModelKeyInfo','ChatGroupService','chat-error-detail\x20\x20<----------------------------------------->','CHAT_TYPE','defineProperty','filter','modelInfo','ModelsService','systemMessage','UserService','response','map','assign',',\x20消耗token:\x20','openaiModel4MaxTokens','AppEntity','ChatPreTypeEntity','PAYMENT_REQUIRED','sendMessageFromOpenAi','lockKey','BadwordsService','is_end','ConfigEntity','model3','getTokenCount','4355GQKhgP','typeInfo','toLowerCase','queryChatBox','HttpStatus','./gptkeys.entity','../autoreply/autoreply.service','delete','error','../chatGroup/chatGroup.service','key','AutoreplyService','maxModelTokens','当前模型调用过于频繁、请重新试试吧！','importDynamic','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','base64','application/octet-stream;\x20charset=utf-8','prompt','result',',\x20key\x20===>\x20','../../common/constants/balance.constant','openaiModel4MaxTokens32kRes','post','error:\x20','status','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','addOneIfOdd','当前分类下有未处理数据不可移除！','quality','deductFromBalance','message','REDIS_PASSWORD','\x0a\x20Current\x20date:\x20','maxResponseTokens','getUploadType','Repository','stringify','../models/models.service','queryChatBoxType','ChatLogService','conversationId','\x20模型名称:\x20','abortController','__esModule','model','draw\x20paompt\x20info\x20<==**==>\x20','chatBoxEntity','ChatBoxTypeEntity','chatLogService','./../upload/upload.service',',\x20消耗积分：\x20','axios','proxyUrl','decorate','userBalanceService','BAD_REQUEST','metadata','./chatBox.entity','billing','checkBadWords','unifiedFormattingResponse','b64_json','queryChatPreList','当前模型key已被封禁','model4','服务异常、请重新试试吧！！！','appInfo','Logger','缺失必要参数！','delChatPre','gpt-4-vision-preview','getOwnPropertyDescriptor','当前Key余额已不足、请重新再试一次吧！'];_0x1154=function(){return _0x28cc86;};return _0x1154();}ChatgptService=__decorate([(0x0,common_1[_0x4674c6(0x1a9)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(gptkeys_entity_1[_0x4674c6(0x1d4)])),__param(0x1,(0x0,typeorm_2[_0x4674c6(0x20a)])(config_entity_1[_0x4674c6(0x221)])),__param(0x2,(0x0,typeorm_2[_0x4674c6(0x20a)])(chatBoxType_entity_1[_0x4674c6(0x147)])),__param(0x3,(0x0,typeorm_2[_0x4674c6(0x20a)])(chatBox_entity_1['ChatBoxEntity'])),__param(0x4,(0x0,typeorm_2[_0x4674c6(0x20a)])(app_entity_1[_0x4674c6(0x21a)])),__param(0x5,(0x0,typeorm_2[_0x4674c6(0x20a)])(chatPreType_entity_1[_0x4674c6(0x21b)])),__param(0x6,(0x0,typeorm_2[_0x4674c6(0x20a)])(chatPre_entity_1[_0x4674c6(0x1cb)])),__metadata('design:paramtypes',[typeorm_1[_0x4674c6(0x13b)],typeorm_1[_0x4674c6(0x13b)],typeorm_1[_0x4674c6(0x13b)],typeorm_1[_0x4674c6(0x13b)],typeorm_1[_0x4674c6(0x13b)],typeorm_1[_0x4674c6(0x13b)],typeorm_1[_0x4674c6(0x13b)],nestjs_config_1[_0x4674c6(0x1c7)],userBalance_service_1['UserBalanceService'],chatLog_service_1[_0x4674c6(0x13f)],user_service_1[_0x4674c6(0x214)],upload_service_1[_0x4674c6(0x1d1)],badwords_service_1[_0x4674c6(0x21f)],autoreply_service_1[_0x4674c6(0x22f)],globalConfig_service_1[_0x4674c6(0x18f)],fanyi_service_1['FanyiService'],chatGroup_service_1[_0x4674c6(0x20c)],models_service_1[_0x4674c6(0x212)]])],ChatgptService),exports['ChatgptService']=ChatgptService;