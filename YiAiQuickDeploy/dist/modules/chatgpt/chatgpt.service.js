'use strict';const _0x51574e=_0x4f28;(function(_0x22746d,_0x595215){const _0x1b2eff=_0x4f28,_0x912ce7=_0x22746d();while(!![]){try{const _0x297f84=parseInt(_0x1b2eff(0x1f1))/0x1+parseInt(_0x1b2eff(0x2a2))/0x2*(-parseInt(_0x1b2eff(0x1f2))/0x3)+parseInt(_0x1b2eff(0x290))/0x4*(parseInt(_0x1b2eff(0x258))/0x5)+-parseInt(_0x1b2eff(0x259))/0x6+parseInt(_0x1b2eff(0x2a4))/0x7+-parseInt(_0x1b2eff(0x266))/0x8*(parseInt(_0x1b2eff(0x22c))/0x9)+parseInt(_0x1b2eff(0x296))/0xa*(parseInt(_0x1b2eff(0x245))/0xb);if(_0x297f84===_0x595215)break;else _0x912ce7['push'](_0x912ce7['shift']());}catch(_0x1ed302){_0x912ce7['push'](_0x912ce7['shift']());}}}(_0x5ac7,0x32e5e));var __decorate=this&&this[_0x51574e(0x214)]||function(_0x410cc7,_0x3875ec,_0x608941,_0x8db219){const _0x6d7734=_0x51574e;var _0x4a06bf=arguments[_0x6d7734(0x24f)],_0x4f5ceb=_0x4a06bf<0x3?_0x3875ec:_0x8db219===null?_0x8db219=Object['getOwnPropertyDescriptor'](_0x3875ec,_0x608941):_0x8db219,_0x2255bb;if(typeof Reflect===_0x6d7734(0x1df)&&typeof Reflect[_0x6d7734(0x22a)]===_0x6d7734(0x278))_0x4f5ceb=Reflect[_0x6d7734(0x22a)](_0x410cc7,_0x3875ec,_0x608941,_0x8db219);else{for(var _0x5411bc=_0x410cc7[_0x6d7734(0x24f)]-0x1;_0x5411bc>=0x0;_0x5411bc--)if(_0x2255bb=_0x410cc7[_0x5411bc])_0x4f5ceb=(_0x4a06bf<0x3?_0x2255bb(_0x4f5ceb):_0x4a06bf>0x3?_0x2255bb(_0x3875ec,_0x608941,_0x4f5ceb):_0x2255bb(_0x3875ec,_0x608941))||_0x4f5ceb;}return _0x4a06bf>0x3&&_0x4f5ceb&&Object[_0x6d7734(0x229)](_0x3875ec,_0x608941,_0x4f5ceb),_0x4f5ceb;},__metadata=this&&this[_0x51574e(0x27f)]||function(_0x5a1f1f,_0x3da2d5){const _0x1d9a37=_0x51574e;if(typeof Reflect==='object'&&typeof Reflect[_0x1d9a37(0x2c3)]===_0x1d9a37(0x278))return Reflect[_0x1d9a37(0x2c3)](_0x5a1f1f,_0x3da2d5);},__param=this&&this[_0x51574e(0x29f)]||function(_0x3dc2f0,_0x1eab0d){return function(_0x26f7d4,_0x30316f){_0x1eab0d(_0x26f7d4,_0x30316f,_0x3dc2f0);};};Object[_0x51574e(0x229)](exports,_0x51574e(0x237),{'value':!![]}),exports[_0x51574e(0x239)]=void 0x0;function _0x5ac7(){const _0x5bcd7e=['263755lZiSyp','1795332oJQpNn','toLowerCase','importDynamic','close','getTokenCount','绘制图片失败，此次绘画被拒绝了！','statusText','Logger','gpt-4-vision-preview','openaiModel3MaxTokensRes','getAllKeyList','openaiModel3MaxTokens16kRes','config','1022576uiPzzx','AppEntity','onModuleInit','response','getRequestParams','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','status','setChatPreType','checkUserStatus','message','uploadService','当前模型key余额已耗尽','childList','delChatPre','coverImg','filter','服务异常、请重新试试吧！！！','function','statusText:','../fanyi/fanyi.service','detail','Repository','quality','default','__metadata','count','assign','../../common/constants/errorMessage.constant','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','findOne','unifiedFormattingResponse','chatPreTypeEntity','../chatLog/chatLog.service','userBalanceService','当前Key余额已不足、请重新再试一次吧！','chatPreEntity','modelInfo','abort','getModelProxyUrl','appId','openaiModel3MaxTokens16k','8aAnUTI','\x0a\x20Current\x20date:\x20','userService','openaiTimeoutMs','PAYMENT_REQUIRED','DESC','2460IPUEjB','绘制图片失败，请稍后试试吧！','model4','chatBoxTypeEntity','16k','../globalConfig/config.entity','appInfo','AutoreplyService','draw','__param','OpenAiErrorCodeMessage','dall-e-3','2CrUVmH','delete','1722518ibtZAN','当前模型key已被封禁','uuid','all','当前分类下有未处理数据不可移除！','../app/app.entity','setChatPre','systemPreMessage','buildMessageFromParentMessageId','delChatPreType','imageUrl','queryChatBoxType','find','1106','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','redis://','text','./chatPreType.entity','write','modelsService','keyPool','GptKeysEntity','DrawService','sendMessageFromBaidu','/v1/images/generations','getRandomDrawKey','map','getClientIp','base64','REDIS_USER','openaiProxyUrl','metadata','preset','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','gptKeysEntity','ModelsService','standard','nineStore','appEntity','ceil','Incorrect\x20API\x20key\x20provided','is_end','typeInfo','REDIS_HOST','slice','formatModelToken','./helper','gpt-3','data','ConfigEntity','systemMessage','gpt-4-1106',',\x20key\x20===>\x20','env','400\x20error','openaiModel4MaxTokens32k',',\x20消耗积分：\x20','chatProcess','key','Billing\x20hard\x20limit\x20has\x20been\x20reached','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','当前请求已过载、请稍等会儿再试试吧！','@keyv/redis','Catch\x20Error\x20','checkAutoReply','32k','openai-draw\x20error:\x20','result','CHAT_TYPE','proxyUrl','update','chatLogService','getBaseConfig','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','maxModelTokens','object','toISOString','getUuid','Please\x20check\x20the\x20back-end\x20console','ChatBoxEntity','getUploadType','billing','queryUserBalance','assistant','removeSpecialCharacters','sendMessageFromZhipu','./chatPre.entity','UploadService','绘制图片失败，请检查你的提示词是否有非法描述！','end','ChatPreTypeEntity','draw\x20paompt\x20info\x20<==**==>\x20','../userBalance/userBalance.service','248732LPyFeb','1175082IcJwGk','HttpException','mjDraw','saveChatLog','log','setData','BAD_REQUEST','openaiBaseUrl','UserService','statusCode','dall','../badwords/badwords.service','chatSyncFree','error:\x20','./zhipu','REDIS_PASSWORD','openaiModel4MaxTokensRes','chat','ChatBoxTypeEntity','deductFromBalance','queryChatPreList','checkBadWords','configEntity','当前模型调用过于频繁、请重新试试吧！','getMaxTokenFromModelWithOpenAi','sendMessageFromOpenAi','chatBoxEntity','./../upload/upload.service','usage','queryChatBoxFrontend','Content-type','model','application/octet-stream;\x20charset=utf-8','Injectable','__decorate','typeorm','../globalConfig/globalConfig.service','ChatLogService','setHeader','prompt','queryChatBox','HttpStatus','user','@nestjs/common','includes','abortController','../chatGroup/chatGroup.service','NineStore','./gptkeys.entity','getCurrentModelKeyInfo','badwordsService','Too\x20Many\x20Requests','setChatBox','stringify','getGroupInfoFromId','defineProperty','decorate','REDIS_PORT','18ItmMdN','conversationId','缺失必要参数！','getConfigs','push','uploadFile','nestjs-config','chat-error\x20<----------------------------------------->','BadwordsService','lockKey','code:\x20','__esModule','InjectRepository','ChatgptService','openaiModel4MaxTokens32kRes','save','b64_json','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','chat-error-detail\x20\x20<----------------------------------------->','openaiModel3MaxTokens','validateBalance','GlobalConfigService','ConfigService','DeductionKey','https://api.openai.com','24805FiOncT','delChatBoxType','forEach','非法操作！','typeId','../autoreply/autoreply.service','提供了错误的模型秘钥','addOneIfOdd','model3','globalConfigService','length','./store','chatGroupService','autoreplyService','parse','setChatBoxType','split','design:paramtypes','compileNetwork'];_0x5ac7=function(){return _0x5bcd7e;};return _0x5ac7();}function _0x4f28(_0x1a9263,_0x2d5832){const _0x5ac7a7=_0x5ac7();return _0x4f28=function(_0x4f2854,_0x5931ca){_0x4f2854=_0x4f2854-0x1de;let _0x5989f7=_0x5ac7a7[_0x4f2854];return _0x5989f7;},_0x4f28(_0x1a9263,_0x2d5832);}const upload_service_1=require(_0x51574e(0x20d)),user_service_1=require('./../user/user.service'),nestjs_config_1=require(_0x51574e(0x232)),common_1=require(_0x51574e(0x21d)),errorMessage_constant_1=require(_0x51574e(0x282)),utils_1=require('../../common/utils'),axios_1=require('axios'),userBalance_service_1=require(_0x51574e(0x1f0)),balance_constant_1=require('../../common/constants/balance.constant'),chatLog_service_1=require(_0x51574e(0x287)),uuid=require(_0x51574e(0x2a6)),config_entity_1=require(_0x51574e(0x29b)),typeorm_1=require(_0x51574e(0x215)),typeorm_2=require('@nestjs/typeorm'),badwords_service_1=require(_0x51574e(0x1fd)),autoreply_service_1=require(_0x51574e(0x24a)),gptkeys_entity_1=require(_0x51574e(0x222)),globalConfig_service_1=require(_0x51574e(0x216)),fanyi_service_1=require(_0x51574e(0x27a)),app_entity_1=require(_0x51574e(0x2a9)),chatGroup_service_1=require(_0x51574e(0x220)),models_service_1=require('../models/models.service'),baidu_1=require('./baidu'),helper_1=require(_0x51574e(0x2d2)),store_1=require(_0x51574e(0x250)),zhipu_1=require(_0x51574e(0x200)),openai_1=require('./openai'),chatBoxType_entity_1=require('./chatBoxType.entity'),chatBox_entity_1=require('./chatBox.entity'),chatPre_entity_1=require(_0x51574e(0x1ea)),chatPreType_entity_1=require(_0x51574e(0x2b5));let ChatgptService=class ChatgptService{constructor(_0x1d7591,_0x5ea18b,_0x1b1206,_0xff68c8,_0x20e66f,_0x575f34,_0x584898,_0x59b53f,_0x588825,_0x5a879c,_0x4a4f34,_0x4b921d,_0x464e67,_0x200e7c,_0x3b56fc,_0x20aa88,_0x282bf3,_0x470c75){const _0x4f431e=_0x51574e;this[_0x4f431e(0x2c6)]=_0x1d7591,this[_0x4f431e(0x208)]=_0x5ea18b,this[_0x4f431e(0x299)]=_0x1b1206,this[_0x4f431e(0x20c)]=_0xff68c8,this[_0x4f431e(0x2ca)]=_0x20e66f,this[_0x4f431e(0x286)]=_0x575f34,this[_0x4f431e(0x28a)]=_0x584898,this['configService']=_0x59b53f,this[_0x4f431e(0x288)]=_0x588825,this[_0x4f431e(0x2eb)]=_0x5a879c,this[_0x4f431e(0x292)]=_0x4a4f34,this[_0x4f431e(0x271)]=_0x4b921d,this[_0x4f431e(0x224)]=_0x464e67,this[_0x4f431e(0x252)]=_0x200e7c,this[_0x4f431e(0x24e)]=_0x3b56fc,this['fanyiService']=_0x20aa88,this[_0x4f431e(0x251)]=_0x282bf3,this[_0x4f431e(0x2b7)]=_0x470c75,this[_0x4f431e(0x2c9)]=null,this['whiteListUser']=[],this[_0x4f431e(0x2b8)]={'list3':[],'list4':[]};}async[_0x51574e(0x268)](){const _0x2824a2=_0x51574e;let _0x426b26=await(0x0,utils_1['importDynamic'])('chatgpt-ai-web'),_0x28735b=await(0x0,utils_1['importDynamic'])(_0x2824a2(0x2e2)),_0x4b5344=await(0x0,utils_1[_0x2824a2(0x25b)])('keyv');_0x426b26=(_0x426b26===null||_0x426b26===void 0x0?void 0x0:_0x426b26[_0x2824a2(0x27e)])?_0x426b26[_0x2824a2(0x27e)]:_0x426b26,_0x28735b=(_0x28735b===null||_0x28735b===void 0x0?void 0x0:_0x28735b[_0x2824a2(0x27e)])?_0x28735b['default']:_0x28735b,_0x4b5344=(_0x4b5344===null||_0x4b5344===void 0x0?void 0x0:_0x4b5344[_0x2824a2(0x27e)])?_0x4b5344[_0x2824a2(0x27e)]:_0x4b5344;const {ChatGPTAPI:_0x4393ea,ChatGPTError:_0x13b0a3,ChatGPTUnofficialProxyAPI:_0x2a0569}=_0x426b26,_0x301f43=+process['env'][_0x2824a2(0x22b)],_0xa5631d=process['env'][_0x2824a2(0x2cf)],_0x2e80ac=process['env'][_0x2824a2(0x201)],_0x42f054=process[_0x2824a2(0x2d9)][_0x2824a2(0x2c1)],_0x350551=_0x2824a2(0x2b3)+(_0x42f054||'')+':'+(_0x2e80ac||'')+'@'+_0xa5631d+':'+_0x301f43,_0x11d8c7=new _0x28735b(_0x350551),_0xd0eb81=new _0x4b5344({'store':_0x11d8c7,'namespace':'nineai-chatlog'});this[_0x2824a2(0x2c9)]=new store_1[(_0x2824a2(0x221))]({'store':_0xd0eb81,'namespace':_0x2824a2(0x203)});}async[_0x51574e(0x26a)](_0x465c29,_0x52c959,_0x232f71,_0x42f70d=null){const _0x58f4d2=_0x51574e;var _0x21d3ed;!_0x42f70d&&(_0x42f70d=(_0x21d3ed=await this[_0x58f4d2(0x2b7)]['getBaseConfig']())===null||_0x21d3ed===void 0x0?void 0x0:_0x21d3ed[_0x58f4d2(0x28b)]);const {timeout:timeout=0x3c}=_0x232f71,{topN:_0x50d62f,model:_0x1f41fc}=_0x42f70d,{parentMessageId:parentMessageId=0x0}=_0x465c29,_0x53ba04=await this['globalConfigService'][_0x58f4d2(0x22f)](['openaiTimeoutMs']),_0x177ee0=timeout*0x3e8||_0x53ba04||0x64*0x3e8,_0x130e3a={'parentMessageId':parentMessageId,'timeoutMs':+_0x177ee0,'completionParams':{'model':_0x1f41fc,'temperature':_0x50d62f}};return _0x52c959&&(_0x130e3a[_0x58f4d2(0x2d6)]=_0x52c959),_0x130e3a;}async[_0x51574e(0x1fe)](_0x42786b){const _0x259088=_0x51574e,_0x312e29=await this[_0x259088(0x2b7)][_0x259088(0x2bd)](),_0x3ca52b=await this[_0x259088(0x24e)]['getConfigs'](['systemPreMessage']),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x32d4a6,model:_0xbced94}=_0x312e29,_0x5a1f95=await this[_0x259088(0x28d)](_0x312e29),{context:_0x10f973}=await this[_0x259088(0x2c9)]['buildMessageFromParentMessageId'](_0x42786b,{'parentMessageId':'','systemMessage':_0x3ca52b});try{const _0x2987c7=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x10f973,{'apiKey':(0x0,utils_1[_0x259088(0x1e8)])(_0x32d4a6),'model':_0xbced94,'proxyUrl':_0x5a1f95,'onProgress':null});return _0x2987c7===null||_0x2987c7===void 0x0?void 0x0:_0x2987c7[_0x259088(0x2b4)];}catch(_0x550b34){console[_0x259088(0x1f6)](_0x259088(0x1ff),_0x550b34);}}async[_0x51574e(0x2dd)](_0x1c04d4,_0x40992f,_0x185db3){const _0x2d951c=_0x51574e;var _0x415da1,_0x6be66a,_0x41d5d7,_0x5c2ff3;const _0x5e5b75=_0x40992f[_0x2d951c(0x21f)],{options:options={},appId:_0x3e77c1,cusromPrompt:_0x2b01fc,systemMessage:systemMessage=''}=_0x1c04d4;let _0xcb7dcf=systemMessage;const {parentMessageId:_0x102a07}=options,{prompt:_0x1e051f,imageUrl:_0x27e00c,model:_0x2437b3}=_0x1c04d4,{groupId:_0x188edd,usingNetwork:_0x5716c5}=options,_0x107cf5=await this[_0x2d951c(0x251)][_0x2d951c(0x228)](_0x188edd),_0x38d225=(_0x107cf5===null||_0x107cf5===void 0x0?void 0x0:_0x107cf5[_0x2d951c(0x265)])?JSON[_0x2d951c(0x253)](_0x107cf5[_0x2d951c(0x265)]):await this[_0x2d951c(0x2b7)][_0x2d951c(0x2ec)](),{keyType:_0x1ebd9e,model:_0x235e17,topN:_0x1eac35,systemMessage:_0x20e0c0,rounds:_0x2a46aa}=_0x38d225['modelInfo'];let _0x22e2b0=null;!_0x2b01fc?_0x22e2b0=await this['modelsService'][_0x2d951c(0x223)](_0x235e17):_0x22e2b0=await this['modelsService'][_0x2d951c(0x2bd)]();if(!_0x22e2b0)throw new common_1[(_0x2d951c(0x1f3))](_0x2d951c(0x2c5),common_1[_0x2d951c(0x21b)][_0x2d951c(0x1f8)]);const {deduct:_0xc75389,isTokenBased:_0x538129,tokenFeeRatio:_0x56006f,deductType:_0x15b02f,key:_0x326a15,secret:_0x120b64,modelName:_0x43a8ef,id:_0x28ac44,accessToken:_0x3294fb}=_0x22e2b0;await this['userService'][_0x2d951c(0x26f)](_0x40992f[_0x2d951c(0x21c)]),await this[_0x2d951c(0x288)]['validateBalance'](_0x40992f,_0x15b02f===0x1?_0x2d951c(0x24d):_0x2d951c(0x298),_0xc75389),_0x185db3&&_0x185db3[_0x2d951c(0x218)](_0x2d951c(0x210),_0x2d951c(0x212)),await this[_0x2d951c(0x224)][_0x2d951c(0x207)](_0x1e051f,_0x40992f['user']['id']);const _0x702d7b=await this[_0x2d951c(0x252)][_0x2d951c(0x2e4)](_0x1e051f);if(_0x702d7b&&_0x185db3){const _0x5e23b2={'message':_0x702d7b,'code':0x1f4};return _0x185db3[_0x2d951c(0x2b6)](JSON['stringify'](_0x5e23b2)),_0x185db3['end']();}if(_0x3e77c1){const _0x5f3bd9=await this[_0x2d951c(0x2ca)][_0x2d951c(0x284)]({'where':{'id':_0x3e77c1,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x5f3bd9)throw new common_1[(_0x2d951c(0x1f3))](_0x2d951c(0x26b),common_1['HttpStatus'][_0x2d951c(0x1f8)]);_0x5f3bd9[_0x2d951c(0x2c4)]&&(_0xcb7dcf=_0x5f3bd9[_0x2d951c(0x2c4)]);}else{if(_0x2b01fc)_0xcb7dcf=systemMessage;else{if(_0x20e0c0)_0xcb7dcf=_0x20e0c0;else{const _0x58f255=new Date()[_0x2d951c(0x1e0)]()[_0x2d951c(0x255)]('T')[0x0],_0x493806=await this[_0x2d951c(0x24e)][_0x2d951c(0x22f)]([_0x2d951c(0x2ab)]);_0xcb7dcf=_0x493806+('\x0a\x20Current\x20date:\x20'+_0x58f255);}}}let _0x2e7c4e='';if(_0x5716c5){_0x2e7c4e=await(0x0,utils_1[_0x2d951c(0x257)])(_0x1e051f);const _0x3bfc42=new Date()[_0x2d951c(0x1e0)]()[_0x2d951c(0x255)]('T')[0x0],_0x4d273d=await this[_0x2d951c(0x24e)]['getConfigs']([_0x2d951c(0x2ab)]);_0xcb7dcf=_0x4d273d+(_0x2d951c(0x291)+_0x3bfc42);}const _0x590282=await this[_0x2d951c(0x26a)](options,_0xcb7dcf,_0x22e2b0,_0x38d225['modelInfo']),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x27be62}=_0x22e2b0;_0x185db3&&_0x185db3[_0x2d951c(0x26d)](0xc8);let _0x7ed77d=null,_0x294436=null;try{if(_0x185db3){let _0x518cc8=null,_0xcb1748=![];_0x185db3['on'](_0x2d951c(0x25c),async()=>{const _0x34eaa1=_0x2d951c;if(_0xcb1748)return;_0x5e5b75[_0x34eaa1(0x28c)]();const _0x1a01a5=await(0x0,openai_1[_0x34eaa1(0x25d)])(_0x1e051f)||0x0,_0x354f76=await(0x0,openai_1[_0x34eaa1(0x25d)])(_0x518cc8===null||_0x518cc8===void 0x0?void 0x0:_0x518cc8[_0x34eaa1(0x2b4)])||0x0,_0x2befea=_0x1a01a5+_0x354f76,_0x63a30f=(0x0,utils_1[_0x34eaa1(0x2bf)])(_0x40992f);await this[_0x34eaa1(0x2eb)][_0x34eaa1(0x1f5)]({'appId':_0x3e77c1,'curIp':_0x63a30f,'userId':_0x40992f[_0x34eaa1(0x21c)]['id'],'type':balance_constant_1[_0x34eaa1(0x243)][_0x34eaa1(0x2e8)],'prompt':_0x1e051f,'imageUrl':_0x27e00c,'activeModel':_0x2437b3,'answer':'','promptTokens':_0x1a01a5,'completionTokens':0x0,'totalTokens':_0x1a01a5,'model':_0x235e17,'role':'user','groupId':_0x188edd,'requestOptions':JSON[_0x34eaa1(0x227)]({'options':null,'prompt':_0x1e051f})}),await this[_0x34eaa1(0x2eb)][_0x34eaa1(0x1f5)]({'appId':_0x3e77c1,'curIp':_0x63a30f,'userId':_0x40992f['user']['id'],'type':balance_constant_1[_0x34eaa1(0x243)][_0x34eaa1(0x2e8)],'prompt':_0x1e051f,'answer':_0x518cc8===null||_0x518cc8===void 0x0?void 0x0:_0x518cc8[_0x34eaa1(0x2b4)],'promptTokens':_0x1a01a5,'completionTokens':_0x354f76,'totalTokens':_0x2befea,'model':_0x235e17,'role':'assistant','groupId':_0x188edd,'requestOptions':JSON[_0x34eaa1(0x227)]({'options':{'model':_0x235e17,'temperature':_0x1eac35},'prompt':_0x1e051f}),'conversationOptions':JSON[_0x34eaa1(0x227)]({'conversationId':_0x518cc8===null||_0x518cc8===void 0x0?void 0x0:_0x518cc8[_0x34eaa1(0x22d)],'model':_0x235e17,'parentMessageId':_0x518cc8===null||_0x518cc8===void 0x0?void 0x0:_0x518cc8['id'],'temperature':_0x1eac35})});let _0x5decc0=_0xc75389;_0x538129===!![]&&(_0x5decc0=Math[_0x34eaa1(0x2cb)](_0xc75389*_0x2befea/_0x56006f)),await this[_0x34eaa1(0x288)]['deductFromBalance'](_0x40992f[_0x34eaa1(0x21c)]['id'],_0x34eaa1(0x211)+(_0x15b02f===0x1?0x3:0x4),_0x5decc0,_0x2befea);});if(Number(_0x1ebd9e)===0x1){const {key:_0x399f6a,maxToken:_0x36d18b,maxTokenRes:_0x7c1342,proxyResUrl:_0x5136e6}=await this[_0x2d951c(0x2d1)](_0x22e2b0),{parentMessageId:_0x438b9e,completionParams:_0x33a63f,systemMessage:_0x296f04}=_0x590282,{model:_0x20830f,temperature:_0x1bc235}=_0x33a63f,{context:_0x174fac}=await this[_0x2d951c(0x2c9)][_0x2d951c(0x2ac)](_0x5716c5?_0x2e7c4e:_0x1e051f,{'parentMessageId':_0x438b9e,'systemMessage':_0x296f04,'maxModelToken':_0x36d18b,'maxResponseTokens':_0x7c1342,'maxRounds':(0x0,helper_1[_0x2d951c(0x24c)])(_0x2a46aa),'imageUrl':_0x27e00c,'activeModel':_0x2437b3});let _0x1cee98=!![];_0x7ed77d=await(0x0,openai_1[_0x2d951c(0x20b)])(_0x174fac,{'maxToken':_0x36d18b,'maxTokenRes':_0x7c1342,'apiKey':_0x326a15,'model':_0x20830f,'prompt':_0x1e051f,'activeModel':_0x2437b3,'imageUrl':_0x27e00c,'temperature':_0x1bc235,'proxyUrl':_0x5136e6,'onProgress':_0x19d365=>{const _0x145654=_0x2d951c;_0x185db3['write'](_0x1cee98?JSON[_0x145654(0x227)](_0x19d365):'\x0a'+JSON[_0x145654(0x227)](_0x19d365)),_0x518cc8=_0x19d365,_0x1cee98=![];}},this[_0x2d951c(0x271)]),_0xcb1748=!![];}if(Number(_0x1ebd9e)===0x2){let _0x20520b=!![];const {context:_0x112c71}=await this['nineStore'][_0x2d951c(0x2ac)](_0x5716c5?_0x2e7c4e:_0x1e051f,{'parentMessageId':_0x102a07,'maxRounds':(0x0,helper_1[_0x2d951c(0x24c)])(_0x2a46aa)});_0x7ed77d=await(0x0,baidu_1[_0x2d951c(0x2bb)])(_0x5716c5?_0x2e7c4e:_0x112c71,{'temperature':_0x1eac35,'accessToken':_0x3294fb,'model':_0x235e17,'onProgress':_0x3e944d=>{const _0x4d7545=_0x2d951c;_0x185db3[_0x4d7545(0x2b6)](_0x20520b?JSON[_0x4d7545(0x227)](_0x3e944d):'\x0a'+JSON[_0x4d7545(0x227)](_0x3e944d)),_0x20520b=![],_0x518cc8=_0x3e944d;}}),_0xcb1748=!![];}if(Number(_0x1ebd9e)===0x3){let _0x502e7c=!![];const {context:_0x3d2d2e}=await this[_0x2d951c(0x2c9)]['buildMessageFromParentMessageId'](_0x5716c5?_0x2e7c4e:_0x1e051f,{'parentMessageId':_0x102a07,'maxRounds':(0x0,helper_1[_0x2d951c(0x24c)])(_0x2a46aa)});_0x7ed77d=await(0x0,zhipu_1[_0x2d951c(0x1e9)])(_0x5716c5?_0x2e7c4e:_0x3d2d2e,{'temperature':_0x1eac35,'key':_0x27be62,'model':_0x235e17,'onProgress':_0x12cb31=>{const _0x4a35aa=_0x2d951c;_0x185db3[_0x4a35aa(0x2b6)](_0x502e7c?JSON['stringify'](_0x12cb31):'\x0a'+JSON[_0x4a35aa(0x227)](_0x12cb31)),_0x502e7c=![],_0x518cc8=_0x12cb31;}}),_0xcb1748=!![];}const _0x53dd0e={'id':this['nineStore'][_0x2d951c(0x1e1)](),'text':_0x1e051f,'role':'user','name':undefined,'usage':null,'imageUrl':_0x27e00c,'activeModel':_0x2437b3,'parentMessageId':_0x102a07,'conversationId':_0x7ed77d===null||_0x7ed77d===void 0x0?void 0x0:_0x7ed77d[_0x2d951c(0x22d)]};_0x294436={'model':_0x235e17,'parentMessageId':_0x102a07},await this[_0x2d951c(0x2c9)][_0x2d951c(0x1f7)](_0x53dd0e);const _0x4316f4={'id':_0x7ed77d['id'],'text':_0x7ed77d[_0x2d951c(0x2b4)],'role':'assistant','name':undefined,'usage':_0x7ed77d===null||_0x7ed77d===void 0x0?void 0x0:_0x7ed77d[_0x2d951c(0x20e)],'imageUrl':_0x27e00c,'parentMessageId':_0x53dd0e['id'],'conversationId':_0x7ed77d===null||_0x7ed77d===void 0x0?void 0x0:_0x7ed77d[_0x2d951c(0x22d)]};await this[_0x2d951c(0x2c9)]['setData'](_0x4316f4),_0x294436={'model':_0x235e17,'parentMessageId':_0x53dd0e['id']};}else{const {key:_0x4003c6,maxToken:_0x29cf0a,maxTokenRes:_0x52d265,proxyResUrl:_0x1cff3c}=await this[_0x2d951c(0x2d1)](_0x22e2b0),{parentMessageId:_0x15dd93,completionParams:_0x5716a7,systemMessage:_0x44d542}=_0x590282,{model:_0x50e826,temperature:_0x235d09}=_0x5716a7,{context:_0x3e9f51}=await this[_0x2d951c(0x2c9)][_0x2d951c(0x2ac)](_0x5716c5?_0x2e7c4e:_0x1e051f,{'parentMessageId':_0x15dd93,'systemMessage':_0x44d542,'maxRounds':(0x0,helper_1[_0x2d951c(0x24c)])(_0x2a46aa)});_0x7ed77d=await(0x0,openai_1[_0x2d951c(0x20b)])(_0x3e9f51,{'apiKey':_0x326a15,'model':_0x50e826,'temperature':_0x235d09,'proxyUrl':_0x1cff3c,'onProgress':null,'prompt':_0x1e051f});}let _0x4a67be=null,_0x117b5d=null;_0x235e17[_0x2d951c(0x21e)](_0x2d951c(0x1fc))?_0x4a67be=((_0x415da1=_0x7ed77d[_0x2d951c(0x27b)])===null||_0x415da1===void 0x0?void 0x0:_0x415da1[_0x2d951c(0x20e)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x117b5d=await(0x0,helper_1[_0x2d951c(0x285)])(_0x1ebd9e,_0x7ed77d,_0x294436);const {prompt_tokens:_0x6d15f7,completion_tokens:_0x22f805,total_tokens:_0x2766e2}=_0x235e17[_0x2d951c(0x21e)](_0x2d951c(0x1fc))?_0x4a67be:_0x117b5d[_0x2d951c(0x20e)];let _0x153643=_0xc75389;_0x538129===!![]&&(_0x153643=Math[_0x2d951c(0x2cb)](_0xc75389*_0x2766e2/_0x56006f));await this[_0x2d951c(0x288)][_0x2d951c(0x205)](_0x40992f[_0x2d951c(0x21c)]['id'],_0x2d951c(0x211)+(_0x15b02f===0x1?0x3:0x4),_0x153643,_0x2766e2),await this[_0x2d951c(0x2b7)]['saveUseLog'](_0x28ac44,_0x2766e2);const _0x5f4cd3=(0x0,utils_1[_0x2d951c(0x2bf)])(_0x40992f);await this[_0x2d951c(0x2eb)]['saveChatLog']({'appId':_0x3e77c1,'curIp':_0x5f4cd3,'userId':_0x40992f[_0x2d951c(0x21c)]['id'],'type':balance_constant_1[_0x2d951c(0x243)]['CHAT_TYPE'],'prompt':_0x1e051f,'imageUrl':_0x27e00c,'activeModel':_0x2437b3,'answer':'','promptTokens':_0x6d15f7,'completionTokens':0x0,'totalTokens':_0x2766e2,'model':_0x235e17,'role':'user','groupId':_0x188edd,'requestOptions':JSON[_0x2d951c(0x227)]({'options':null,'prompt':_0x1e051f})}),await this[_0x2d951c(0x2eb)][_0x2d951c(0x1f5)]({'appId':_0x3e77c1,'curIp':_0x5f4cd3,'userId':_0x40992f[_0x2d951c(0x21c)]['id'],'type':balance_constant_1[_0x2d951c(0x243)]['CHAT_TYPE'],'prompt':_0x1e051f,'imageUrl':_0x7ed77d===null||_0x7ed77d===void 0x0?void 0x0:_0x7ed77d[_0x2d951c(0x2ae)],'answer':_0x7ed77d['text'],'promptTokens':_0x6d15f7,'completionTokens':_0x22f805,'totalTokens':_0x2766e2,'model':_0x235e17,'role':_0x2d951c(0x1e7),'groupId':_0x188edd,'requestOptions':JSON[_0x2d951c(0x227)]({'options':{'model':_0x235e17,'temperature':_0x1eac35},'prompt':_0x1e051f}),'conversationOptions':JSON[_0x2d951c(0x227)]({'conversationId':_0x7ed77d['conversationId'],'model':_0x235e17,'parentMessageId':_0x7ed77d['id'],'temperature':_0x1eac35})}),common_1[_0x2d951c(0x260)]['debug']('用户ID:\x20'+_0x40992f[_0x2d951c(0x21c)]['id']+'\x20模型名称:\x20'+_0x43a8ef+'-'+_0x2437b3+',\x20消耗token:\x20'+_0x2766e2+_0x2d951c(0x2dc)+_0x153643,_0x2d951c(0x239));const _0x25ad98=await this[_0x2d951c(0x288)][_0x2d951c(0x1e6)](_0x40992f[_0x2d951c(0x21c)]['id']);return _0x7ed77d['userBanance']=Object[_0x2d951c(0x281)]({},_0x25ad98),_0x7ed77d[_0x2d951c(0x2e7)]&&(_0x7ed77d[_0x2d951c(0x2e7)]=''),_0x7ed77d[_0x2d951c(0x2cd)]=!![],_0x185db3?_0x185db3['write']('\x0a'+JSON[_0x2d951c(0x227)](_0x7ed77d)):_0x7ed77d['text'];}catch(_0x4f4894){console[_0x2d951c(0x1f6)](_0x2d951c(0x233),_0x326a15,_0x4f4894);const _0x203c66=(_0x4f4894===null||_0x4f4894===void 0x0?void 0x0:_0x4f4894[_0x2d951c(0x1fb)])||0x190,_0x217155=((_0x6be66a=_0x4f4894===null||_0x4f4894===void 0x0?void 0x0:_0x4f4894['response'])===null||_0x6be66a===void 0x0?void 0x0:_0x6be66a[_0x2d951c(0x26d)])||(_0x4f4894===null||_0x4f4894===void 0x0?void 0x0:_0x4f4894[_0x2d951c(0x1fb)])||0x190;console[_0x2d951c(0x1f6)](_0x2d951c(0x23e),_0x2d951c(0x236),_0x203c66,'message',_0x4f4894===null||_0x4f4894===void 0x0?void 0x0:_0x4f4894[_0x2d951c(0x270)],_0x2d951c(0x279),(_0x41d5d7=_0x4f4894===null||_0x4f4894===void 0x0?void 0x0:_0x4f4894[_0x2d951c(0x269)])===null||_0x41d5d7===void 0x0?void 0x0:_0x41d5d7[_0x2d951c(0x25f)],_0x2d951c(0x26d),(_0x5c2ff3=_0x4f4894===null||_0x4f4894===void 0x0?void 0x0:_0x4f4894['response'])===null||_0x5c2ff3===void 0x0?void 0x0:_0x5c2ff3[_0x2d951c(0x26d)]);if(_0x4f4894[_0x2d951c(0x26d)]&&_0x4f4894['status']===0x192){const _0x5e93c7={'message':_0x2d951c(0x2e3)+_0x4f4894['message'],'code':0x192};if(_0x185db3)return _0x185db3['write'](JSON[_0x2d951c(0x227)](_0x5e93c7));else throw new common_1[(_0x2d951c(0x1f3))](_0x4f4894[_0x2d951c(0x270)],common_1[_0x2d951c(0x21b)][_0x2d951c(0x294)]);}if(!_0x217155){if(_0x185db3)return _0x185db3[_0x2d951c(0x2b6)](JSON['stringify']({'message':_0x4f4894[_0x2d951c(0x270)],'code':0x1f4}));else throw new common_1[(_0x2d951c(0x1f3))](_0x4f4894[_0x2d951c(0x270)],common_1[_0x2d951c(0x21b)][_0x2d951c(0x1f8)]);}let _0x5e8525=errorMessage_constant_1[_0x2d951c(0x2a0)][_0x217155]?errorMessage_constant_1[_0x2d951c(0x2a0)][_0x217155]:_0x2d951c(0x277);(_0x4f4894===null||_0x4f4894===void 0x0?void 0x0:_0x4f4894[_0x2d951c(0x270)][_0x2d951c(0x21e)](_0x2d951c(0x283)))&&Number(_0x1ebd9e)===0x1&&(await this[_0x2d951c(0x2b7)][_0x2d951c(0x235)](_0x28ac44,_0x2d951c(0x26c),-0x1),_0x5e8525=_0x2d951c(0x2a5));(_0x4f4894===null||_0x4f4894===void 0x0?void 0x0:_0x4f4894[_0x2d951c(0x1fb)])===0x1ad&&_0x4f4894[_0x2d951c(0x270)]['includes'](_0x2d951c(0x1e5))&&Number(_0x1ebd9e)===0x1&&(await this['modelsService']['lockKey'](_0x28ac44,'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x5e8525=_0x2d951c(0x272));(_0x4f4894===null||_0x4f4894===void 0x0?void 0x0:_0x4f4894[_0x2d951c(0x1fb)])===0x1ad&&(_0x4f4894===null||_0x4f4894===void 0x0?void 0x0:_0x4f4894[_0x2d951c(0x25f)])===_0x2d951c(0x225)&&(_0x5e8525=_0x2d951c(0x209));(_0x4f4894===null||_0x4f4894===void 0x0?void 0x0:_0x4f4894['statusCode'])===0x191&&_0x4f4894['message'][_0x2d951c(0x21e)](_0x2d951c(0x2cc))&&Number(_0x1ebd9e)===0x1&&(await this['modelsService'][_0x2d951c(0x235)](_0x28ac44,_0x2d951c(0x24b),-0x2),_0x5e8525=_0x2d951c(0x2e0));(_0x4f4894===null||_0x4f4894===void 0x0?void 0x0:_0x4f4894[_0x2d951c(0x1fb)])===0x194&&_0x4f4894['message']['includes']('This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported')&&Number(_0x1ebd9e)===0x1&&(await this['modelsService'][_0x2d951c(0x235)](_0x28ac44,'当前模型不是聊天模型',-0x4),_0x5e8525=_0x2d951c(0x23d));_0x203c66===0x190&&console[_0x2d951c(0x1f6)](_0x2d951c(0x2da),_0x4f4894,_0x4f4894[_0x2d951c(0x270)]);const _0x47d06d={'message':_0x5e8525||_0x2d951c(0x1e2),'code':_0x203c66===0x191?0x190:_0x203c66||0x1f4};if(_0x185db3)return _0x185db3[_0x2d951c(0x2b6)](JSON['stringify'](_0x47d06d));else throw new common_1[(_0x2d951c(0x1f3))](_0x47d06d[_0x2d951c(0x270)],common_1[_0x2d951c(0x21b)]['BAD_REQUEST']);}finally{_0x185db3&&_0x185db3[_0x2d951c(0x1ed)]();}}async[_0x51574e(0x29e)](_0x3948b7,_0x1d0ebf){const _0x43eaee=_0x51574e;var _0x3db84b,_0x5a1099,_0x9506b1,_0x28b6dd;await this[_0x43eaee(0x224)][_0x43eaee(0x207)](_0x3948b7[_0x43eaee(0x219)],_0x1d0ebf[_0x43eaee(0x21c)]['id']),await this['userService']['checkUserStatus'](_0x1d0ebf[_0x43eaee(0x21c)]);const _0x1100eb=(_0x3948b7===null||_0x3948b7===void 0x0?void 0x0:_0x3948b7[_0x43eaee(0x27d)])==='hd'?0x4:0x2;await this['userBalanceService'][_0x43eaee(0x240)](_0x1d0ebf,_0x43eaee(0x1f4),_0x1100eb);let _0xc07bf9=[];const _0x1c68a9=await this[_0x43eaee(0x2b7)]['getCurrentModelKeyInfo'](_0x43eaee(0x2a1)),_0x9b65b4=_0x1c68a9===null||_0x1c68a9===void 0x0?void 0x0:_0x1c68a9['id'],{key:_0x1f40a4,proxyResUrl:_0x590df8}=await this['formatModelToken'](_0x1c68a9);common_1['Logger'][_0x43eaee(0x1f6)](_0x43eaee(0x1ef)+_0x3948b7[_0x43eaee(0x219)]+_0x43eaee(0x2d8)+_0x1f40a4,_0x43eaee(0x2ba));try{const _0x2a76e2=_0x590df8+_0x43eaee(0x2bc),_0x267f2f=Object[_0x43eaee(0x281)](Object['assign']({},_0x3948b7),{'model':_0x43eaee(0x2a1)});console[_0x43eaee(0x1f6)]('dall-e\x20draw\x20params:\x20',_0x267f2f);const _0x20548f=await axios_1[_0x43eaee(0x27e)]['post'](_0x2a76e2,Object[_0x43eaee(0x281)](Object[_0x43eaee(0x281)]({},_0x267f2f),{'response_format':_0x43eaee(0x23c)}),{'headers':{'Authorization':'Bearer\x20'+_0x1f40a4}});_0xc07bf9=_0x20548f[_0x43eaee(0x2d4)]['data'];const _0x19a841=[];for(const _0x37ef5a of _0xc07bf9){const _0x5db5d9=uuid['v4']()[_0x43eaee(0x2d0)](0x0,0xa)+'.png',_0x21e665=Buffer['from'](_0x37ef5a[_0x43eaee(0x23c)],_0x43eaee(0x2c0));_0x19a841[_0x43eaee(0x230)](this[_0x43eaee(0x271)][_0x43eaee(0x231)]({'filename':_0x5db5d9,'buffer':_0x21e665}));}const _0x2f61d3=await Promise[_0x43eaee(0x2a7)](_0x19a841);await this['userBalanceService'][_0x43eaee(0x205)](_0x1d0ebf[_0x43eaee(0x21c)]['id'],_0x43eaee(0x1f4),(_0x267f2f===null||_0x267f2f===void 0x0?void 0x0:_0x267f2f[_0x43eaee(0x27d)])===_0x43eaee(0x2c8)?0x2:0x4,_0x1100eb);const _0x349f2e=(0x0,utils_1[_0x43eaee(0x2bf)])(_0x1d0ebf),_0xa94062=[],_0x3fd679=await this[_0x43eaee(0x271)][_0x43eaee(0x1e4)](),[_0x53626e,_0x2a6442]=_0x3948b7['size'][_0x43eaee(0x255)]('x');return _0x2f61d3[_0x43eaee(0x247)](_0x55d120=>{const _0xe4ae55=_0x43eaee;_0xa94062[_0xe4ae55(0x230)](this['chatLogService'][_0xe4ae55(0x1f5)]({'curIp':_0x349f2e,'userId':_0x1d0ebf[_0xe4ae55(0x21c)]['id'],'type':balance_constant_1['DeductionKey']['PAINT_TYPE'],'prompt':_0x3948b7[_0xe4ae55(0x219)],'answer':_0x55d120,'fileInfo':JSON['stringify']({'cosType':_0x3fd679,'width':_0x53626e,'height':_0x2a6442,'cosUrl':_0x55d120}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':'dall-e-3'}));}),await Promise[_0x43eaee(0x2a7)](_0xa94062),_0x2f61d3;}catch(_0x30ac45){const _0x287fb0=((_0x3db84b=_0x30ac45===null||_0x30ac45===void 0x0?void 0x0:_0x30ac45[_0x43eaee(0x269)])===null||_0x3db84b===void 0x0?void 0x0:_0x3db84b[_0x43eaee(0x26d)])||0x1f4;console[_0x43eaee(0x1f6)](_0x43eaee(0x2e6),JSON[_0x43eaee(0x227)](_0x30ac45),_0x1f40a4,_0x287fb0);const _0x44d816=(_0x28b6dd=(_0x9506b1=(_0x5a1099=_0x30ac45===null||_0x30ac45===void 0x0?void 0x0:_0x30ac45[_0x43eaee(0x269)])===null||_0x5a1099===void 0x0?void 0x0:_0x5a1099[_0x43eaee(0x2d4)])===null||_0x9506b1===void 0x0?void 0x0:_0x9506b1['error'])===null||_0x28b6dd===void 0x0?void 0x0:_0x28b6dd[_0x43eaee(0x270)];if(_0x287fb0===0x1ad)throw new common_1[(_0x43eaee(0x1f3))](_0x43eaee(0x2e1),common_1[_0x43eaee(0x21b)]['BAD_REQUEST']);if(_0x287fb0===0x190&&_0x44d816[_0x43eaee(0x21e)](_0x43eaee(0x2ed)))throw new common_1[(_0x43eaee(0x1f3))](_0x43eaee(0x2b2),common_1[_0x43eaee(0x21b)]['BAD_REQUEST']);if(_0x287fb0===0x190&&_0x44d816[_0x43eaee(0x21e)](_0x43eaee(0x2df))){await this[_0x43eaee(0x2b7)][_0x43eaee(0x235)](_0x9b65b4,_0x43eaee(0x26c),-0x1);throw new common_1[(_0x43eaee(0x1f3))](_0x43eaee(0x289),common_1[_0x43eaee(0x21b)][_0x43eaee(0x1f8)]);}if(_0x287fb0===0x1f4)throw new common_1['HttpException'](_0x43eaee(0x1ec),common_1['HttpStatus'][_0x43eaee(0x1f8)]);if(_0x287fb0===0x191)throw new common_1[(_0x43eaee(0x1f3))](_0x43eaee(0x25e),common_1[_0x43eaee(0x21b)]['BAD_REQUEST']);throw new common_1[(_0x43eaee(0x1f3))](_0x43eaee(0x297),common_1[_0x43eaee(0x21b)][_0x43eaee(0x1f8)]);}}async[_0x51574e(0x263)](){const _0x5849d3=_0x51574e,_0x5cefc0=await this[_0x5849d3(0x2c6)][_0x5849d3(0x2b0)]({'where':{'status':0x1},'select':['id',_0x5849d3(0x2de),'weight',_0x5849d3(0x211),_0x5849d3(0x1de),'maxResponseTokens',_0x5849d3(0x2c2),_0x5849d3(0x293)]}),_0x483b01=_0x5cefc0[_0x5849d3(0x276)](_0xc5f0f6=>_0xc5f0f6[_0x5849d3(0x211)]['includes'](_0x5849d3(0x2d3))),_0x47cec8=_0x5cefc0[_0x5849d3(0x276)](_0x294287=>_0x294287[_0x5849d3(0x211)]['includes']('gpt-4'));this[_0x5849d3(0x2b8)]={'list3':_0x483b01,'list4':_0x47cec8};}async[_0x51574e(0x28d)](_0x549f48){const _0x11c1e4=_0x51574e,_0x505f7f=await this[_0x11c1e4(0x24e)]['getConfigs']([_0x11c1e4(0x1f9)]);return(_0x549f48===null||_0x549f48===void 0x0?void 0x0:_0x549f48[_0x11c1e4(0x2e9)])||_0x505f7f||_0x11c1e4(0x244);}async['formatModelToken'](_0xa51c4b){const _0x59c36f=_0x51574e,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x59c36f(0x24e)][_0x59c36f(0x22f)]([_0x59c36f(0x23f),_0x59c36f(0x262),_0x59c36f(0x28f),_0x59c36f(0x264),'openaiModel4MaxTokens',_0x59c36f(0x202),_0x59c36f(0x2db),_0x59c36f(0x23a),_0x59c36f(0x1f9)]);let _0x343405=null,_0x4dd3db=null,_0x5d6e04=null,{model:_0x4806cf,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x445813}=_0xa51c4b;return _0x4806cf[_0x59c36f(0x25a)]()[_0x59c36f(0x21e)]('gpt-4')&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x4dd3db>=0x1000&&(maxModelTokens=0x1000),_0x343405=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x4dd3db=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x4806cf[_0x59c36f(0x25a)]()[_0x59c36f(0x21e)](_0x59c36f(0x2e5))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x4dd3db>=0x4000&&(maxModelTokens=0x4000),_0x343405=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x4dd3db=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x4806cf[_0x59c36f(0x25a)]()['includes']('1106')&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x4dd3db>=0x1000&&(maxModelTokens=0x1000),_0x343405=maxModelTokens||0x3ffc,_0x4dd3db=maxResponseTokens||0x1000)),_0x4806cf[_0x59c36f(0x25a)]()[_0x59c36f(0x21e)](_0x59c36f(0x2d3))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x4dd3db>=0x7d0&&(maxModelTokens=0x7d0),_0x343405=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x4dd3db=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x4806cf['toLowerCase']()['includes'](_0x59c36f(0x29a))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x4dd3db>=0x2000&&(maxModelTokens=0x2000),_0x343405=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x4dd3db=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x4806cf[_0x59c36f(0x25a)]()[_0x59c36f(0x21e)](_0x59c36f(0x2b1))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x4dd3db>=0x1000&&(maxModelTokens=0x1000),_0x343405=maxModelTokens||0x4000,_0x4dd3db=maxResponseTokens||0x1000)),_0x5d6e04=proxyUrl||openaiBaseUrl||_0x59c36f(0x244),_0x4dd3db>=_0x343405&&(_0x4dd3db=Math['floor'](_0x343405/0x2)),{'key':_0x445813,'maxToken':_0x343405,'maxTokenRes':_0x4dd3db,'proxyResUrl':_0x5d6e04};}async[_0x51574e(0x254)](_0x12ddc3,_0x4f2b51){const _0xab0d31=_0x51574e;try{const {name:_0x11ce39,icon:_0x106fe1,order:_0x5d1f7f,id:_0x143836,status:_0x4b8cd6}=_0x4f2b51;return _0x143836?await this[_0xab0d31(0x299)]['update']({'id':_0x143836},{'name':_0x11ce39,'icon':_0x106fe1,'order':_0x5d1f7f,'status':_0x4b8cd6}):await this[_0xab0d31(0x299)][_0xab0d31(0x23b)]({'name':_0x11ce39,'icon':_0x106fe1,'order':_0x5d1f7f,'status':_0x4b8cd6});}catch(_0x38432f){console[_0xab0d31(0x1f6)](_0xab0d31(0x1ff),_0x38432f);}}async[_0x51574e(0x246)](_0x111c5a,_0x153265){const _0x4eacfa=_0x51574e,{id:_0x47498b}=_0x153265;if(!_0x47498b)throw new common_1[(_0x4eacfa(0x1f3))](_0x4eacfa(0x248),common_1[_0x4eacfa(0x21b)][_0x4eacfa(0x1f8)]);const _0x3981d7=await this[_0x4eacfa(0x20c)][_0x4eacfa(0x280)]({'where':{'typeId':_0x47498b}});if(_0x3981d7)throw new common_1[(_0x4eacfa(0x1f3))](_0x4eacfa(0x2a8),common_1[_0x4eacfa(0x21b)]['BAD_REQUEST']);return await this[_0x4eacfa(0x299)][_0x4eacfa(0x2a3)]({'id':_0x47498b});}async[_0x51574e(0x2af)](){const _0x5aaeba=_0x51574e;return await this[_0x5aaeba(0x299)][_0x5aaeba(0x2b0)]({'order':{'order':_0x5aaeba(0x295)}});}async[_0x51574e(0x226)](_0x46b0bf,_0x5c7901){const _0x1d11f9=_0x51574e,{title:_0x1b11e9,prompt:_0x36d3e8,appId:_0x19101f,order:_0x3bae1d,status:_0x4134bd,typeId:_0x3e0845,id:_0x166c8b,url:_0x465a98}=_0x5c7901;if(!_0x3e0845)throw new common_1['HttpException']('缺失必要参数！',common_1[_0x1d11f9(0x21b)][_0x1d11f9(0x1f8)]);try{const _0x15869d={'title':_0x1b11e9,'order':_0x3bae1d,'status':_0x4134bd,'typeId':_0x3e0845,'url':_0x465a98};return _0x15869d[_0x1d11f9(0x28e)]=_0x19101f||0x0,_0x15869d[_0x1d11f9(0x219)]=_0x36d3e8||'',_0x166c8b?await this[_0x1d11f9(0x20c)][_0x1d11f9(0x2ea)]({'id':_0x166c8b},_0x15869d):await this['chatBoxEntity']['save'](_0x15869d);}catch(_0x462956){console['log'](_0x1d11f9(0x1ff),_0x462956);}}async['delChatBox'](_0x509aa4,_0x1c9d04){const _0xb2e33b=_0x51574e,{id:_0x110a92}=_0x1c9d04;if(!_0x110a92)throw new common_1[(_0xb2e33b(0x1f3))](_0xb2e33b(0x248),common_1[_0xb2e33b(0x21b)][_0xb2e33b(0x1f8)]);return await this[_0xb2e33b(0x20c)][_0xb2e33b(0x2a3)]({'id':_0x110a92});}async[_0x51574e(0x21a)](){const _0x902317=_0x51574e,_0x37207f=await this[_0x902317(0x20c)][_0x902317(0x2b0)]({'order':{'order':_0x902317(0x295)}}),_0x3596ef=[...new Set(_0x37207f[_0x902317(0x2be)](_0x333a59=>_0x333a59[_0x902317(0x249)]))],_0x419038=[...new Set(_0x37207f[_0x902317(0x2be)](_0xde40dc=>_0xde40dc[_0x902317(0x28e)]))],_0x21bb40=await this['chatBoxTypeEntity'][_0x902317(0x2b0)]({'where':{'id':(0x0,typeorm_1['In'])(_0x3596ef)}}),_0x3910f8=await this[_0x902317(0x2ca)][_0x902317(0x2b0)]({'where':{'id':(0x0,typeorm_1['In'])(_0x419038)}});return _0x37207f[_0x902317(0x2be)](_0x401350=>{const _0x4b82be=_0x902317,{typeId:_0x23ffc7,appId:_0x1cadc0}=_0x401350;return _0x401350[_0x4b82be(0x2ce)]=_0x21bb40['find'](_0x592fa7=>_0x592fa7['id']===_0x23ffc7),_0x401350[_0x4b82be(0x29c)]=_0x3910f8[_0x4b82be(0x2b0)](_0x3a6df0=>_0x3a6df0['id']===_0x1cadc0),_0x401350;});}async[_0x51574e(0x20f)](){const _0x25c9c4=_0x51574e,_0x35ca29=await this[_0x25c9c4(0x299)][_0x25c9c4(0x2b0)]({'order':{'order':'DESC'},'where':{'status':!![]}}),_0x39939e=await this[_0x25c9c4(0x20c)][_0x25c9c4(0x2b0)]({'where':{'status':!![]}}),_0x47e3f1=[...new Set(_0x39939e[_0x25c9c4(0x2be)](_0x418f21=>_0x418f21[_0x25c9c4(0x28e)]))],_0x4919f3=await this[_0x25c9c4(0x2ca)][_0x25c9c4(0x2b0)]({'where':{'id':(0x0,typeorm_1['In'])(_0x47e3f1)}});return _0x39939e['forEach'](_0x36446a=>{const _0x31ccaa=_0x25c9c4,_0x3852e9=_0x4919f3[_0x31ccaa(0x2b0)](_0x4f2a8f=>_0x4f2a8f['id']===_0x36446a[_0x31ccaa(0x28e)]);return _0x36446a[_0x31ccaa(0x275)]=_0x3852e9===null||_0x3852e9===void 0x0?void 0x0:_0x3852e9[_0x31ccaa(0x275)],_0x36446a;}),_0x35ca29[_0x25c9c4(0x2be)](_0x554564=>{const _0x214dba=_0x25c9c4;return _0x554564[_0x214dba(0x273)]=_0x39939e[_0x214dba(0x276)](_0x33702f=>_0x33702f[_0x214dba(0x249)]===_0x554564['id']&&_0x33702f[_0x214dba(0x26d)]),_0x554564;});}async[_0x51574e(0x26e)](_0xa85f6d,_0x9a97d1){const _0x2b8094=_0x51574e;try{const {name:_0x4b006b,icon:_0x1ce19e,order:_0x590a38,id:_0x4b8a0b,status:_0x15285b}=_0x9a97d1;return _0x4b8a0b?await this['chatPreTypeEntity'][_0x2b8094(0x2ea)]({'id':_0x4b8a0b},{'name':_0x4b006b,'icon':_0x1ce19e,'order':_0x590a38,'status':_0x15285b}):await this[_0x2b8094(0x286)][_0x2b8094(0x23b)]({'name':_0x4b006b,'icon':_0x1ce19e,'order':_0x590a38,'status':_0x15285b});}catch(_0x186736){console[_0x2b8094(0x1f6)](_0x2b8094(0x1ff),_0x186736);}}async[_0x51574e(0x2ad)](_0x3c2c76,_0x271d1b){const _0x1202a5=_0x51574e,{id:_0x4129b2}=_0x271d1b;if(!_0x4129b2)throw new common_1[(_0x1202a5(0x1f3))]('非法操作！',common_1[_0x1202a5(0x21b)][_0x1202a5(0x1f8)]);const _0x241e6f=await this['chatBoxEntity'][_0x1202a5(0x280)]({'where':{'typeId':_0x4129b2}});if(_0x241e6f)throw new common_1[(_0x1202a5(0x1f3))](_0x1202a5(0x2a8),common_1[_0x1202a5(0x21b)]['BAD_REQUEST']);return await this['chatPreTypeEntity'][_0x1202a5(0x2a3)]({'id':_0x4129b2});}async['queryChatPreType'](){const _0x2d20ff=_0x51574e;return await this['chatPreTypeEntity'][_0x2d20ff(0x2b0)]({'order':{'order':_0x2d20ff(0x295)}});}async[_0x51574e(0x2aa)](_0x1d9453,_0x1f2762){const _0x6e4156=_0x51574e,{title:_0x1eb287,prompt:_0x3f39fd,appId:_0x537d95,order:_0x59b184,status:_0x38d332,typeId:_0x923eeb,id:_0x323d02,url:_0x4fe4c8}=_0x1f2762;if(!_0x923eeb)throw new common_1['HttpException'](_0x6e4156(0x22e),common_1[_0x6e4156(0x21b)][_0x6e4156(0x1f8)]);try{const _0x1109f9={'title':_0x1eb287,'prompt':_0x3f39fd,'order':_0x59b184,'status':_0x38d332,'typeId':_0x923eeb,'url':_0x4fe4c8};return _0x323d02?await this[_0x6e4156(0x28a)][_0x6e4156(0x2ea)]({'id':_0x323d02},_0x1109f9):await this[_0x6e4156(0x28a)][_0x6e4156(0x23b)](_0x1109f9);}catch(_0x5e065b){console['log']('error:\x20',_0x5e065b);}}async[_0x51574e(0x274)](_0x586b3f,_0xdf3d16){const _0x430ceb=_0x51574e,{id:_0xa3c51e}=_0xdf3d16;if(!_0xa3c51e)throw new common_1['HttpException'](_0x430ceb(0x248),common_1[_0x430ceb(0x21b)][_0x430ceb(0x1f8)]);return await this[_0x430ceb(0x28a)][_0x430ceb(0x2a3)]({'id':_0xa3c51e});}async['queryChatPre'](){const _0x57e3e3=_0x51574e,_0xbef337=await this[_0x57e3e3(0x28a)][_0x57e3e3(0x2b0)]({'order':{'order':_0x57e3e3(0x295)}}),_0x1d5d07=[...new Set(_0xbef337['map'](_0x3255c4=>_0x3255c4[_0x57e3e3(0x249)]))],_0x1faaa9=await this[_0x57e3e3(0x286)][_0x57e3e3(0x2b0)]({'where':{'id':(0x0,typeorm_1['In'])(_0x1d5d07)}});return _0xbef337[_0x57e3e3(0x2be)](_0x10ab14=>{const _0x1e2bd3=_0x57e3e3,{typeId:_0x2e4198,appId:_0x357ae3}=_0x10ab14;return _0x10ab14[_0x1e2bd3(0x2ce)]=_0x1faaa9['find'](_0x634d0=>_0x634d0['id']===_0x2e4198),_0x10ab14;});}async[_0x51574e(0x206)](){const _0x8d50f2=_0x51574e,_0x3f6d41=await this[_0x8d50f2(0x286)][_0x8d50f2(0x2b0)]({'order':{'order':_0x8d50f2(0x295)},'where':{'status':!![]}}),_0x16f619=await this['chatPreEntity'][_0x8d50f2(0x2b0)]({'where':{'status':!![]}});return _0x3f6d41[_0x8d50f2(0x2be)](_0x460e98=>{const _0x46ef75=_0x8d50f2;return _0x460e98[_0x46ef75(0x273)]=_0x16f619[_0x46ef75(0x276)](_0x24a95b=>_0x24a95b['typeId']===_0x460e98['id']&&_0x24a95b['status']),_0x460e98;});}async[_0x51574e(0x20a)](_0x243965,_0x176ffc,_0x334f76){const _0x1bcd99=_0x51574e;let _0x2434a2=0x1000,_0x281739=0x800;return _0x243965[_0x1bcd99(0x25a)]()[_0x1bcd99(0x21e)]('gpt-4')&&(_0x2434a2=_0x176ffc>=0x2004?0x2004:_0x176ffc,_0x281739=_0x334f76>=0x1000?0x1000:_0x334f76,_0x243965[_0x1bcd99(0x25a)]()[_0x1bcd99(0x21e)]('32k')&&(_0x2434a2=_0x176ffc>=0x8000?0x8000:_0x176ffc,_0x281739=_0x334f76>=0x3e80?0x3e80:_0x334f76),(_0x243965[_0x1bcd99(0x25a)]()['includes'](_0x1bcd99(0x2d7))||_0x243965[_0x1bcd99(0x25a)]()[_0x1bcd99(0x21e)](_0x1bcd99(0x261)))&&(_0x2434a2=_0x176ffc>=0x1f400?0x1f400:_0x176ffc,_0x281739=_0x334f76>=0x1000?0x1000:_0x334f76)),_0x243965[_0x1bcd99(0x25a)]()[_0x1bcd99(0x21e)](_0x1bcd99(0x2d3))&&(_0x2434a2=_0x176ffc>=0x1000?0x1000:_0x176ffc,_0x281739=_0x334f76>=0x800?0x800:_0x334f76,_0x243965['toLowerCase']()[_0x1bcd99(0x21e)](_0x1bcd99(0x29a))&&(_0x2434a2=_0x176ffc>=0x4000?0x4000:_0x176ffc,_0x281739=_0x334f76>=0x1f40?0x1f40:_0x334f76),_0x243965[_0x1bcd99(0x25a)]()[_0x1bcd99(0x21e)](_0x1bcd99(0x2b1))&&(_0x2434a2=_0x176ffc>=0x4000?0x4000:_0x176ffc,_0x281739=_0x334f76>=0x1f40?0x1f40:_0x334f76)),{'maxToken':_0x2434a2,'maxRes':_0x281739};}};ChatgptService=__decorate([(0x0,common_1[_0x51574e(0x213)])(),__param(0x0,(0x0,typeorm_2[_0x51574e(0x238)])(gptkeys_entity_1[_0x51574e(0x2b9)])),__param(0x1,(0x0,typeorm_2[_0x51574e(0x238)])(config_entity_1[_0x51574e(0x2d5)])),__param(0x2,(0x0,typeorm_2[_0x51574e(0x238)])(chatBoxType_entity_1[_0x51574e(0x204)])),__param(0x3,(0x0,typeorm_2[_0x51574e(0x238)])(chatBox_entity_1[_0x51574e(0x1e3)])),__param(0x4,(0x0,typeorm_2[_0x51574e(0x238)])(app_entity_1[_0x51574e(0x267)])),__param(0x5,(0x0,typeorm_2[_0x51574e(0x238)])(chatPreType_entity_1[_0x51574e(0x1ee)])),__param(0x6,(0x0,typeorm_2[_0x51574e(0x238)])(chatPre_entity_1['ChatPreEntity'])),__metadata(_0x51574e(0x256),[typeorm_1[_0x51574e(0x27c)],typeorm_1['Repository'],typeorm_1[_0x51574e(0x27c)],typeorm_1[_0x51574e(0x27c)],typeorm_1[_0x51574e(0x27c)],typeorm_1[_0x51574e(0x27c)],typeorm_1[_0x51574e(0x27c)],nestjs_config_1[_0x51574e(0x242)],userBalance_service_1['UserBalanceService'],chatLog_service_1[_0x51574e(0x217)],user_service_1[_0x51574e(0x1fa)],upload_service_1[_0x51574e(0x1eb)],badwords_service_1[_0x51574e(0x234)],autoreply_service_1[_0x51574e(0x29d)],globalConfig_service_1[_0x51574e(0x241)],fanyi_service_1['FanyiService'],chatGroup_service_1['ChatGroupService'],models_service_1[_0x51574e(0x2c7)]])],ChatgptService),exports[_0x51574e(0x239)]=ChatgptService;