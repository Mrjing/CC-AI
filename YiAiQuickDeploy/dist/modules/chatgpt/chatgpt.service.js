'use strict';const _0x552da4=_0x556d;(function(_0x10c4b5,_0x21f87a){const _0x2c76ce=_0x556d,_0xae67c9=_0x10c4b5();while(!![]){try{const _0x1d46d2=parseInt(_0x2c76ce(0x17e))/0x1*(parseInt(_0x2c76ce(0x125))/0x2)+parseInt(_0x2c76ce(0x1a4))/0x3+-parseInt(_0x2c76ce(0xb7))/0x4+parseInt(_0x2c76ce(0xd5))/0x5+parseInt(_0x2c76ce(0xd2))/0x6*(parseInt(_0x2c76ce(0xc6))/0x7)+parseInt(_0x2c76ce(0x193))/0x8*(-parseInt(_0x2c76ce(0x149))/0x9)+parseInt(_0x2c76ce(0x10b))/0xa;if(_0x1d46d2===_0x21f87a)break;else _0xae67c9['push'](_0xae67c9['shift']());}catch(_0x5159a7){_0xae67c9['push'](_0xae67c9['shift']());}}}(_0x254d,0xd8f8a));var __decorate=this&&this[_0x552da4(0x139)]||function(_0xd8255b,_0x5136f5,_0x5aee7b,_0x2611a1){const _0x540b54=_0x552da4;var _0x196e8a=arguments[_0x540b54(0xeb)],_0x45cdc7=_0x196e8a<0x3?_0x5136f5:_0x2611a1===null?_0x2611a1=Object[_0x540b54(0xcd)](_0x5136f5,_0x5aee7b):_0x2611a1,_0x422743;if(typeof Reflect==='object'&&typeof Reflect[_0x540b54(0xb5)]===_0x540b54(0x12d))_0x45cdc7=Reflect[_0x540b54(0xb5)](_0xd8255b,_0x5136f5,_0x5aee7b,_0x2611a1);else{for(var _0x45d0dd=_0xd8255b[_0x540b54(0xeb)]-0x1;_0x45d0dd>=0x0;_0x45d0dd--)if(_0x422743=_0xd8255b[_0x45d0dd])_0x45cdc7=(_0x196e8a<0x3?_0x422743(_0x45cdc7):_0x196e8a>0x3?_0x422743(_0x5136f5,_0x5aee7b,_0x45cdc7):_0x422743(_0x5136f5,_0x5aee7b))||_0x45cdc7;}return _0x196e8a>0x3&&_0x45cdc7&&Object[_0x540b54(0x1aa)](_0x5136f5,_0x5aee7b,_0x45cdc7),_0x45cdc7;},__metadata=this&&this['__metadata']||function(_0x2d6f4a,_0x10345b){const _0x8d3611=_0x552da4;if(typeof Reflect==='object'&&typeof Reflect[_0x8d3611(0xfa)]==='function')return Reflect[_0x8d3611(0xfa)](_0x2d6f4a,_0x10345b);},__param=this&&this[_0x552da4(0xee)]||function(_0x490275,_0x2c4b13){return function(_0x287da4,_0x22a99f){_0x2c4b13(_0x287da4,_0x22a99f,_0x490275);};};Object[_0x552da4(0x1aa)](exports,'__esModule',{'value':!![]}),exports['ChatgptService']=void 0x0;function _0x254d(){const _0x43dfa9=['@nestjs/common','error:\x20','delChatBoxType','ChatPreEntity','configService','find','update','../../common/utils','map','https://api.openai.com','queryUserBalance',',\x20消耗积分：\x20','statusText','3961573wCHTRM','modelInfo','dall-e-3','\x20模型名称:\x20','standard','./../user/user.service','chatBoxTypeEntity','getOwnPropertyDescriptor','quality','\x0a\x20Current\x20date:\x20','getClientIp','chat-error\x20<----------------------------------------->','6CZSrAw','filter','BAD_REQUEST','590050zyqwEK','getUploadType','./chatPre.entity','uploadService','conversationId','addOneIfOdd','weight','model4','@nestjs/typeorm','Repository','getGroupInfoFromId','keyPool','getConfigs','UserService','当前请求已过载、请稍等会儿再试试吧！','GlobalConfigService','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','gpt-3','当前Key余额已不足、请重新再试一次吧！','b64_json','split','length','appInfo','preset','__param','UploadService','formatModelToken','maxModelTokens','uuid','getBaseConfig','systemMessage','env','chatLogService','getCurrentModelKeyInfo','CHAT_TYPE','chatBoxEntity','metadata','setChatPreType','uploadFile','queryChatPre','save','setChatBoxType','queryChatBox','16k','getUuid','badwordsService','ChatBoxEntity','ChatPreTypeEntity','../models/models.service','nineai-chatlog','chatProcess','assistant','toLowerCase','17097050xGqfiz','unifiedFormattingResponse','openaiModel3MaxTokens','ModelsService','ceil','draw','prompt','importDynamic','Please\x20check\x20the\x20back-end\x20console','GptKeysEntity','error','toISOString','config','usage','PAYMENT_REQUIRED','ConfigEntity','sendMessageFromOpenAi','getModelProxyUrl','chatgpt-ai-web','coverImg','gpt-4-1106','chat','keyv','typeorm','deductFromBalance','message','6qDamYv','REDIS_PORT','gpt-4','../fanyi/fanyi.service','stringify','chatPreTypeEntity','includes','openaiModel4MaxTokens32k','function','mjDraw','ChatBoxTypeEntity','400\x20error','./../upload/upload.service','./gptkeys.entity','lockKey','debug','gptKeysEntity','Too\x20Many\x20Requests','typeId','openaiModel4MaxTokens32kRes','__decorate','./zhipu','findOne','all','当前分类下有未处理数据不可移除！','axios','setChatBox','setData','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','data','1106','user','openaiBaseUrl','key','statusText:','./baidu','64197GmXqpB','model3','../chatGroup/chatGroup.service','checkUserStatus','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','getTokenCount','userService','NineStore','typeInfo','appId','openai-draw\x20error:\x20','绘制图片失败，此次绘画被拒绝了！','push','ChatgptService','modelsService','UserBalanceService','.png','saveUseLog','Incorrect\x20API\x20key\x20provided','dall','configEntity','../autoreply/autoreply.service','用户ID:\x20','REDIS_HOST','../chatLog/chatLog.service','DeductionKey','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','chatGroupService','status','checkBadWords','AppEntity','appEntity','../globalConfig/config.entity','forEach','response','openaiModel3MaxTokens16kRes','write','delete','delChatBox','Content-type','DrawService','Logger','detail','delChatPre','size','getRequestParams','text','../globalConfig/globalConfig.service','chatPreEntity','./store','checkAutoReply','validateBalance','model','45447DycWrg','当前模型调用过于频繁、请重新试试吧！','draw\x20paompt\x20info\x20<==**==>\x20','dall-e\x20draw\x20params:\x20','提供了错误的模型秘钥','abort','queryChatPreType','32k','ChatGroupService','HttpStatus','./chatBoxType.entity','setChatPre','imageUrl','BadwordsService','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','queryChatPreList','./chatBox.entity','abortController','Billing\x20hard\x20limit\x20has\x20been\x20reached','../badwords/badwords.service','maxResponseTokens','1544uYBnKY','whiteListUser','end','assign','buildMessageFromParentMessageId','../app/app.entity','PAINT_TYPE','缺失必要参数！','openaiTimeoutMs','chatSyncFree','DESC','chat-error-detail\x20\x20<----------------------------------------->','onModuleInit','getAllKeyList','statusCode','FanyiService','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','1405728LBVLzc','../../common/constants/errorMessage.constant','default','childList','log','globalConfigService','defineProperty','Catch\x20Error\x20','result','InjectRepository','delChatPreType','post','queryChatBoxType','REDIS_USER','ChatLogService','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','非法操作！','userBanance','openaiModel3MaxTokens16k','count','slice','@keyv/redis','code:\x20','nineStore','saveChatLog','openaiProxyUrl','./openai','userBalanceService','compileNetwork','服务异常、请重新试试吧！！！','HttpException','decorate','systemPreMessage','2932752AdPIDM','proxyUrl'];_0x254d=function(){return _0x43dfa9;};return _0x254d();}const upload_service_1=require(_0x552da4(0x131)),user_service_1=require(_0x552da4(0xcb)),nestjs_config_1=require('nestjs-config'),common_1=require(_0x552da4(0xb9)),errorMessage_constant_1=require(_0x552da4(0x1a5)),utils_1=require(_0x552da4(0xc0)),axios_1=require(_0x552da4(0x13e)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require('../../common/constants/balance.constant'),chatLog_service_1=require(_0x552da4(0x161)),uuid=require(_0x552da4(0xf2)),config_entity_1=require(_0x552da4(0x169)),typeorm_1=require(_0x552da4(0x122)),typeorm_2=require(_0x552da4(0xdd)),badwords_service_1=require(_0x552da4(0x191)),autoreply_service_1=require(_0x552da4(0x15e)),gptkeys_entity_1=require(_0x552da4(0x132)),globalConfig_service_1=require(_0x552da4(0x178)),fanyi_service_1=require(_0x552da4(0x128)),app_entity_1=require(_0x552da4(0x198)),chatGroup_service_1=require(_0x552da4(0x14b)),models_service_1=require(_0x552da4(0x106)),baidu_1=require(_0x552da4(0x148)),helper_1=require('./helper'),store_1=require(_0x552da4(0x17a)),zhipu_1=require(_0x552da4(0x13a)),openai_1=require(_0x552da4(0xb0)),chatBoxType_entity_1=require(_0x552da4(0x188)),chatBox_entity_1=require(_0x552da4(0x18e)),chatPre_entity_1=require(_0x552da4(0xd7)),chatPreType_entity_1=require('./chatPreType.entity');function _0x556d(_0x466f56,_0x53fcb4){const _0x254d2a=_0x254d();return _0x556d=function(_0x556d9c,_0x26b589){_0x556d9c=_0x556d9c-0xa3;let _0x1c6c79=_0x254d2a[_0x556d9c];return _0x1c6c79;},_0x556d(_0x466f56,_0x53fcb4);}let ChatgptService=class ChatgptService{constructor(_0x1a6a77,_0x271f06,_0x45584e,_0x430f59,_0x6ebd1e,_0x11e7cf,_0x28152a,_0x59a950,_0x177fd2,_0x2016e5,_0x48169a,_0xb03c2a,_0x50aa03,_0x59ec05,_0x24a2ce,_0x955338,_0x508810,_0x5f0dc){const _0x7c81d9=_0x552da4;this[_0x7c81d9(0x135)]=_0x1a6a77,this[_0x7c81d9(0x15d)]=_0x271f06,this[_0x7c81d9(0xcc)]=_0x45584e,this[_0x7c81d9(0xf9)]=_0x430f59,this[_0x7c81d9(0x168)]=_0x6ebd1e,this[_0x7c81d9(0x12a)]=_0x11e7cf,this['chatPreEntity']=_0x28152a,this[_0x7c81d9(0xbd)]=_0x59a950,this['userBalanceService']=_0x177fd2,this[_0x7c81d9(0xf6)]=_0x2016e5,this[_0x7c81d9(0x14f)]=_0x48169a,this['uploadService']=_0xb03c2a,this[_0x7c81d9(0x103)]=_0x50aa03,this['autoreplyService']=_0x59ec05,this['globalConfigService']=_0x24a2ce,this['fanyiService']=_0x955338,this[_0x7c81d9(0x164)]=_0x508810,this['modelsService']=_0x5f0dc,this[_0x7c81d9(0xad)]=null,this[_0x7c81d9(0x194)]=[],this[_0x7c81d9(0xe0)]={'list3':[],'list4':[]};}async[_0x552da4(0x19f)](){const _0x2ce321=_0x552da4;let _0x53dfe5=await(0x0,utils_1[_0x2ce321(0x112)])(_0x2ce321(0x11d)),_0x55fbe5=await(0x0,utils_1[_0x2ce321(0x112)])(_0x2ce321(0xab)),_0x5b89a2=await(0x0,utils_1[_0x2ce321(0x112)])(_0x2ce321(0x121));_0x53dfe5=(_0x53dfe5===null||_0x53dfe5===void 0x0?void 0x0:_0x53dfe5[_0x2ce321(0x1a6)])?_0x53dfe5['default']:_0x53dfe5,_0x55fbe5=(_0x55fbe5===null||_0x55fbe5===void 0x0?void 0x0:_0x55fbe5[_0x2ce321(0x1a6)])?_0x55fbe5[_0x2ce321(0x1a6)]:_0x55fbe5,_0x5b89a2=(_0x5b89a2===null||_0x5b89a2===void 0x0?void 0x0:_0x5b89a2[_0x2ce321(0x1a6)])?_0x5b89a2['default']:_0x5b89a2;const {ChatGPTAPI:_0x1326b5,ChatGPTError:_0x306c75,ChatGPTUnofficialProxyAPI:_0x14fc33}=_0x53dfe5,_0x14447e=+process['env'][_0x2ce321(0x126)],_0x14dae1=process[_0x2ce321(0xf5)][_0x2ce321(0x160)],_0x5eb69f=process[_0x2ce321(0xf5)]['REDIS_PASSWORD'],_0x207a33=process[_0x2ce321(0xf5)][_0x2ce321(0xa3)],_0x23dd76='redis://'+(_0x207a33||'')+':'+(_0x5eb69f||'')+'@'+_0x14dae1+':'+_0x14447e,_0x1a7ea6=new _0x55fbe5(_0x23dd76),_0x2ad16e=new _0x5b89a2({'store':_0x1a7ea6,'namespace':_0x2ce321(0x107)});this[_0x2ce321(0xad)]=new store_1[(_0x2ce321(0x150))]({'store':_0x2ad16e,'namespace':_0x2ce321(0x120)});}async[_0x552da4(0x176)](_0xe171ca,_0x3484ac,_0x2c0ab5,_0x6929b7=null){const _0x1286a8=_0x552da4;var _0x26a30c;!_0x6929b7&&(_0x6929b7=(_0x26a30c=await this[_0x1286a8(0x157)][_0x1286a8(0xf3)]())===null||_0x26a30c===void 0x0?void 0x0:_0x26a30c['modelInfo']);const {timeout:timeout=0x3c}=_0x2c0ab5,{topN:_0xfb093c,model:_0x5c6e49}=_0x6929b7,{parentMessageId:parentMessageId=0x0}=_0xe171ca,_0x3a11a2=await this[_0x1286a8(0x1a9)][_0x1286a8(0xe1)]([_0x1286a8(0x19b)]),_0x29b45d=timeout*0x3e8||_0x3a11a2||0x64*0x3e8,_0x4a7e72={'parentMessageId':parentMessageId,'timeoutMs':+_0x29b45d,'completionParams':{'model':_0x5c6e49,'temperature':_0xfb093c}};return _0x3484ac&&(_0x4a7e72[_0x1286a8(0xf4)]=_0x3484ac),_0x4a7e72;}async[_0x552da4(0x19c)](_0x285b5c){const _0x2ae57e=_0x552da4,_0x3b5da0=await this[_0x2ae57e(0x157)]['getRandomDrawKey'](),_0x5a11c1=await this[_0x2ae57e(0x1a9)][_0x2ae57e(0xe1)]([_0x2ae57e(0xb6)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x565e43,model:_0x3a00e2}=_0x3b5da0,_0x1f8d8a=await this[_0x2ae57e(0x11c)](_0x3b5da0),{context:_0x48f69a}=await this[_0x2ae57e(0xad)][_0x2ae57e(0x197)](_0x285b5c,{'parentMessageId':'','systemMessage':_0x5a11c1});try{const _0x44814a=await(0x0,openai_1[_0x2ae57e(0x11b)])(_0x48f69a,{'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0x565e43),'model':_0x3a00e2,'proxyUrl':_0x1f8d8a,'onProgress':null});return _0x44814a===null||_0x44814a===void 0x0?void 0x0:_0x44814a[_0x2ae57e(0x177)];}catch(_0xab63cc){console[_0x2ae57e(0x1a8)](_0x2ae57e(0xba),_0xab63cc);}}async[_0x552da4(0x108)](_0xc0e6e2,_0x206291,_0x39985c){const _0x28986e=_0x552da4;var _0x2b2fd5,_0x853441,_0x846589,_0x488ca0;const _0x42e090=_0x206291[_0x28986e(0x18f)],{options:options={},appId:_0x7a24c9,cusromPrompt:_0x131e17,systemMessage:systemMessage=''}=_0xc0e6e2;let _0x5e0987=systemMessage;const {parentMessageId:_0x747a6d}=options,{prompt:_0x2f414b,imageUrl:_0x41e225,model:_0x47e44f}=_0xc0e6e2,{groupId:_0x13e7ed,usingNetwork:_0x2d6b14}=options,_0x5211ff=await this[_0x28986e(0x164)][_0x28986e(0xdf)](_0x13e7ed),_0x11f8d6=(_0x5211ff===null||_0x5211ff===void 0x0?void 0x0:_0x5211ff[_0x28986e(0x117)])?JSON['parse'](_0x5211ff['config']):await this[_0x28986e(0x157)][_0x28986e(0xf3)](),{keyType:_0x400d78,model:_0x4ff4b8,topN:_0x2be939,systemMessage:_0x16845f,rounds:_0x5625fe}=_0x11f8d6[_0x28986e(0xc7)];let _0x4cc578=null;!_0x131e17?_0x4cc578=await this['modelsService']['getCurrentModelKeyInfo'](_0x4ff4b8):_0x4cc578=await this[_0x28986e(0x157)]['getRandomDrawKey']();if(!_0x4cc578)throw new common_1['HttpException']('当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！',common_1[_0x28986e(0x187)][_0x28986e(0xd4)]);const {deduct:_0x1f14de,isTokenBased:_0x98706e,tokenFeeRatio:_0x4caf30,deductType:_0x3fc092,key:_0x11eb0b,secret:_0x2a7a0c,modelName:_0x5cbffc,id:_0x430f98,accessToken:_0x21e087}=_0x4cc578;await this['userService'][_0x28986e(0x14c)](_0x206291[_0x28986e(0x144)]),await this['userBalanceService'][_0x28986e(0x17c)](_0x206291,_0x3fc092===0x1?_0x28986e(0x14a):_0x28986e(0xdc),_0x1f14de),_0x39985c&&_0x39985c['setHeader'](_0x28986e(0x170),'application/octet-stream;\x20charset=utf-8'),await this[_0x28986e(0x103)][_0x28986e(0x166)](_0x2f414b,_0x206291[_0x28986e(0x144)]['id']);const _0x2f7504=await this['autoreplyService'][_0x28986e(0x17b)](_0x2f414b);if(_0x2f7504&&_0x39985c){const _0x4a2ee9={'message':_0x2f7504,'code':0x1f4};return _0x39985c[_0x28986e(0x16d)](JSON[_0x28986e(0x129)](_0x4a2ee9)),_0x39985c[_0x28986e(0x195)]();}if(_0x7a24c9){const _0x460243=await this[_0x28986e(0x168)][_0x28986e(0x13b)]({'where':{'id':_0x7a24c9,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x460243)throw new common_1[(_0x28986e(0xb4))](_0x28986e(0x1a3),common_1[_0x28986e(0x187)][_0x28986e(0xd4)]);_0x460243[_0x28986e(0xed)]&&(_0x5e0987=_0x460243[_0x28986e(0xed)]);}else{if(_0x131e17)_0x5e0987=systemMessage;else{if(_0x16845f)_0x5e0987=_0x16845f;else{const _0x3851d7=new Date()[_0x28986e(0x116)]()[_0x28986e(0xea)]('T')[0x0],_0x36d293=await this[_0x28986e(0x1a9)][_0x28986e(0xe1)]([_0x28986e(0xb6)]);_0x5e0987=_0x36d293+(_0x28986e(0xcf)+_0x3851d7);}}}let _0x55a20a='';if(_0x2d6b14){_0x55a20a=await(0x0,utils_1[_0x28986e(0xb2)])(_0x2f414b);const _0x5b6dd3=new Date()['toISOString']()[_0x28986e(0xea)]('T')[0x0],_0x2d6a27=await this[_0x28986e(0x1a9)]['getConfigs'](['systemPreMessage']);_0x5e0987=_0x2d6a27+('\x0a\x20Current\x20date:\x20'+_0x5b6dd3);}const _0x46f1ce=await this['getRequestParams'](options,_0x5e0987,_0x4cc578,_0x11f8d6[_0x28986e(0xc7)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x242c78}=_0x4cc578;_0x39985c&&_0x39985c[_0x28986e(0x165)](0xc8);let _0x123363=null,_0x239dbc=null;try{if(_0x39985c){let _0x58c806=null,_0x5941a6=![];_0x39985c['on']('close',async()=>{const _0x5878a9=_0x28986e;if(_0x5941a6)return;_0x42e090[_0x5878a9(0x183)]();const _0x404ed9=await(0x0,openai_1[_0x5878a9(0x14e)])(_0x2f414b)||0x0,_0x3605d2=await(0x0,openai_1['getTokenCount'])(_0x58c806===null||_0x58c806===void 0x0?void 0x0:_0x58c806[_0x5878a9(0x177)])||0x0,_0x23757a=_0x404ed9+_0x3605d2,_0xcafb8=(0x0,utils_1[_0x5878a9(0xd0)])(_0x206291);await this['chatLogService'][_0x5878a9(0xae)]({'appId':_0x7a24c9,'curIp':_0xcafb8,'userId':_0x206291[_0x5878a9(0x144)]['id'],'type':balance_constant_1[_0x5878a9(0x162)][_0x5878a9(0xf8)],'prompt':_0x2f414b,'imageUrl':_0x41e225,'activeModel':_0x47e44f,'answer':'','promptTokens':_0x404ed9,'completionTokens':0x0,'totalTokens':_0x404ed9,'model':_0x4ff4b8,'role':_0x5878a9(0x144),'groupId':_0x13e7ed,'requestOptions':JSON[_0x5878a9(0x129)]({'options':null,'prompt':_0x2f414b})}),await this['chatLogService'][_0x5878a9(0xae)]({'appId':_0x7a24c9,'curIp':_0xcafb8,'userId':_0x206291['user']['id'],'type':balance_constant_1[_0x5878a9(0x162)][_0x5878a9(0xf8)],'prompt':_0x2f414b,'answer':_0x58c806===null||_0x58c806===void 0x0?void 0x0:_0x58c806['text'],'promptTokens':_0x404ed9,'completionTokens':_0x3605d2,'totalTokens':_0x23757a,'model':_0x4ff4b8,'role':_0x5878a9(0x109),'groupId':_0x13e7ed,'requestOptions':JSON[_0x5878a9(0x129)]({'options':{'model':_0x4ff4b8,'temperature':_0x2be939},'prompt':_0x2f414b}),'conversationOptions':JSON[_0x5878a9(0x129)]({'conversationId':_0x58c806===null||_0x58c806===void 0x0?void 0x0:_0x58c806['conversationId'],'model':_0x4ff4b8,'parentMessageId':_0x58c806===null||_0x58c806===void 0x0?void 0x0:_0x58c806['id'],'temperature':_0x2be939})});let _0x3e6663=_0x1f14de;_0x98706e===!![]&&(_0x3e6663=Math[_0x5878a9(0x10f)](_0x1f14de*_0x23757a/_0x4caf30)),await this[_0x5878a9(0xb1)]['deductFromBalance'](_0x206291['user']['id'],_0x5878a9(0x17d)+(_0x3fc092===0x1?0x3:0x4),_0x3e6663,_0x23757a);});if(Number(_0x400d78)===0x1){const {key:_0xfdda03,maxToken:_0x1e9078,maxTokenRes:_0x5af25f,proxyResUrl:_0x495e3a}=await this[_0x28986e(0xf0)](_0x4cc578),{parentMessageId:_0x58a143,completionParams:_0xfc1d15,systemMessage:_0x3246b0}=_0x46f1ce,{model:_0x2f7ab2,temperature:_0x420e7d}=_0xfc1d15,{context:_0x57cb3b}=await this['nineStore']['buildMessageFromParentMessageId'](_0x2d6b14?_0x55a20a:_0x2f414b,{'parentMessageId':_0x58a143,'systemMessage':_0x3246b0,'maxModelToken':_0x1e9078,'maxResponseTokens':_0x5af25f,'maxRounds':(0x0,helper_1[_0x28986e(0xda)])(_0x5625fe),'imageUrl':_0x41e225,'activeModel':_0x47e44f});let _0x6b8b3a=!![];_0x123363=await(0x0,openai_1[_0x28986e(0x11b)])(_0x57cb3b,{'maxToken':_0x1e9078,'maxTokenRes':_0x5af25f,'apiKey':_0x11eb0b,'model':_0x2f7ab2,'prompt':_0x2f414b,'activeModel':_0x47e44f,'imageUrl':_0x41e225,'temperature':_0x420e7d,'proxyUrl':_0x495e3a,'onProgress':_0x426699=>{const _0x2ceada=_0x28986e;_0x39985c[_0x2ceada(0x16d)](_0x6b8b3a?JSON['stringify'](_0x426699):'\x0a'+JSON[_0x2ceada(0x129)](_0x426699)),_0x58c806=_0x426699,_0x6b8b3a=![];}},this[_0x28986e(0xd8)]),_0x5941a6=!![];}if(Number(_0x400d78)===0x2){let _0x4542fe=!![];const {context:_0x5c7a1d}=await this[_0x28986e(0xad)]['buildMessageFromParentMessageId'](_0x2d6b14?_0x55a20a:_0x2f414b,{'parentMessageId':_0x747a6d,'maxRounds':(0x0,helper_1[_0x28986e(0xda)])(_0x5625fe)});_0x123363=await(0x0,baidu_1['sendMessageFromBaidu'])(_0x2d6b14?_0x55a20a:_0x5c7a1d,{'temperature':_0x2be939,'accessToken':_0x21e087,'model':_0x4ff4b8,'onProgress':_0x512406=>{const _0x540ec3=_0x28986e;_0x39985c[_0x540ec3(0x16d)](_0x4542fe?JSON['stringify'](_0x512406):'\x0a'+JSON[_0x540ec3(0x129)](_0x512406)),_0x4542fe=![],_0x58c806=_0x512406;}}),_0x5941a6=!![];}if(Number(_0x400d78)===0x3){let _0x5dccbf=!![];const {context:_0x5dac38}=await this[_0x28986e(0xad)][_0x28986e(0x197)](_0x2d6b14?_0x55a20a:_0x2f414b,{'parentMessageId':_0x747a6d,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x5625fe)});_0x123363=await(0x0,zhipu_1['sendMessageFromZhipu'])(_0x2d6b14?_0x55a20a:_0x5dac38,{'temperature':_0x2be939,'key':_0x242c78,'model':_0x4ff4b8,'onProgress':_0x4136e2=>{const _0x57a043=_0x28986e;_0x39985c[_0x57a043(0x16d)](_0x5dccbf?JSON[_0x57a043(0x129)](_0x4136e2):'\x0a'+JSON[_0x57a043(0x129)](_0x4136e2)),_0x5dccbf=![],_0x58c806=_0x4136e2;}}),_0x5941a6=!![];}const _0x231242={'id':this[_0x28986e(0xad)][_0x28986e(0x102)](),'text':_0x2f414b,'role':_0x28986e(0x144),'name':undefined,'usage':null,'imageUrl':_0x41e225,'activeModel':_0x47e44f,'parentMessageId':_0x747a6d,'conversationId':_0x123363===null||_0x123363===void 0x0?void 0x0:_0x123363[_0x28986e(0xd9)]};_0x239dbc={'model':_0x4ff4b8,'parentMessageId':_0x747a6d},await this[_0x28986e(0xad)][_0x28986e(0x140)](_0x231242);const _0x4ea805={'id':_0x123363['id'],'text':_0x123363[_0x28986e(0x177)],'role':_0x28986e(0x109),'name':undefined,'usage':_0x123363===null||_0x123363===void 0x0?void 0x0:_0x123363[_0x28986e(0x118)],'imageUrl':_0x41e225,'parentMessageId':_0x231242['id'],'conversationId':_0x123363===null||_0x123363===void 0x0?void 0x0:_0x123363['conversationId']};await this[_0x28986e(0xad)][_0x28986e(0x140)](_0x4ea805),_0x239dbc={'model':_0x4ff4b8,'parentMessageId':_0x231242['id']};}else{const {key:_0x298479,maxToken:_0x275139,maxTokenRes:_0x28be57,proxyResUrl:_0x14498a}=await this[_0x28986e(0xf0)](_0x4cc578),{parentMessageId:_0xdccaef,completionParams:_0xdb4c75,systemMessage:_0x342684}=_0x46f1ce,{model:_0x215138,temperature:_0x45ed4d}=_0xdb4c75,{context:_0x382ade}=await this[_0x28986e(0xad)]['buildMessageFromParentMessageId'](_0x2d6b14?_0x55a20a:_0x2f414b,{'parentMessageId':_0xdccaef,'systemMessage':_0x342684,'maxRounds':(0x0,helper_1[_0x28986e(0xda)])(_0x5625fe)});_0x123363=await(0x0,openai_1[_0x28986e(0x11b)])(_0x382ade,{'apiKey':_0x11eb0b,'model':_0x215138,'temperature':_0x45ed4d,'proxyUrl':_0x14498a,'onProgress':null,'prompt':_0x2f414b});}let _0x58302d=null,_0x241856=null;_0x4ff4b8[_0x28986e(0x12b)](_0x28986e(0x15c))?_0x58302d=((_0x2b2fd5=_0x123363[_0x28986e(0x173)])===null||_0x2b2fd5===void 0x0?void 0x0:_0x2b2fd5[_0x28986e(0x118)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x241856=await(0x0,helper_1[_0x28986e(0x10c)])(_0x400d78,_0x123363,_0x239dbc);const {prompt_tokens:_0x4d24f1,completion_tokens:_0x1736f4,total_tokens:_0x2e2406}=_0x4ff4b8[_0x28986e(0x12b)](_0x28986e(0x15c))?_0x58302d:_0x241856[_0x28986e(0x118)];let _0x2427b8=_0x1f14de;_0x98706e===!![]&&(_0x2427b8=Math['ceil'](_0x1f14de*_0x2e2406/_0x4caf30));await this['userBalanceService'][_0x28986e(0x123)](_0x206291[_0x28986e(0x144)]['id'],_0x28986e(0x17d)+(_0x3fc092===0x1?0x3:0x4),_0x2427b8,_0x2e2406),await this[_0x28986e(0x157)][_0x28986e(0x15a)](_0x430f98,_0x2e2406);const _0x4ea220=(0x0,utils_1[_0x28986e(0xd0)])(_0x206291);await this['chatLogService'][_0x28986e(0xae)]({'appId':_0x7a24c9,'curIp':_0x4ea220,'userId':_0x206291[_0x28986e(0x144)]['id'],'type':balance_constant_1[_0x28986e(0x162)][_0x28986e(0xf8)],'prompt':_0x2f414b,'imageUrl':_0x41e225,'activeModel':_0x47e44f,'answer':'','promptTokens':_0x4d24f1,'completionTokens':0x0,'totalTokens':_0x2e2406,'model':_0x4ff4b8,'role':'user','groupId':_0x13e7ed,'requestOptions':JSON[_0x28986e(0x129)]({'options':null,'prompt':_0x2f414b})}),await this[_0x28986e(0xf6)]['saveChatLog']({'appId':_0x7a24c9,'curIp':_0x4ea220,'userId':_0x206291['user']['id'],'type':balance_constant_1[_0x28986e(0x162)][_0x28986e(0xf8)],'prompt':_0x2f414b,'imageUrl':_0x123363===null||_0x123363===void 0x0?void 0x0:_0x123363[_0x28986e(0x18a)],'answer':_0x123363[_0x28986e(0x177)],'promptTokens':_0x4d24f1,'completionTokens':_0x1736f4,'totalTokens':_0x2e2406,'model':_0x4ff4b8,'role':_0x28986e(0x109),'groupId':_0x13e7ed,'requestOptions':JSON['stringify']({'options':{'model':_0x4ff4b8,'temperature':_0x2be939},'prompt':_0x2f414b}),'conversationOptions':JSON[_0x28986e(0x129)]({'conversationId':_0x123363['conversationId'],'model':_0x4ff4b8,'parentMessageId':_0x123363['id'],'temperature':_0x2be939})}),common_1[_0x28986e(0x172)][_0x28986e(0x134)](_0x28986e(0x15f)+_0x206291[_0x28986e(0x144)]['id']+_0x28986e(0xc9)+_0x5cbffc+'-'+_0x47e44f+',\x20消耗token:\x20'+_0x2e2406+_0x28986e(0xc4)+_0x2427b8,_0x28986e(0x156));const _0x2b8e8f=await this['userBalanceService'][_0x28986e(0xc3)](_0x206291[_0x28986e(0x144)]['id']);return _0x123363[_0x28986e(0xa7)]=Object[_0x28986e(0x196)]({},_0x2b8e8f),_0x123363[_0x28986e(0x1ac)]&&(_0x123363['result']=''),_0x123363['is_end']=!![],_0x39985c?_0x39985c['write']('\x0a'+JSON[_0x28986e(0x129)](_0x123363)):_0x123363['text'];}catch(_0x161eda){console[_0x28986e(0x1a8)](_0x28986e(0xd1),_0x11eb0b,_0x161eda);const _0x59f343=(_0x161eda===null||_0x161eda===void 0x0?void 0x0:_0x161eda[_0x28986e(0x1a1)])||0x190,_0x2c4c70=((_0x853441=_0x161eda===null||_0x161eda===void 0x0?void 0x0:_0x161eda['response'])===null||_0x853441===void 0x0?void 0x0:_0x853441['status'])||(_0x161eda===null||_0x161eda===void 0x0?void 0x0:_0x161eda[_0x28986e(0x1a1)])||0x190;console['log'](_0x28986e(0x19e),_0x28986e(0xac),_0x59f343,_0x28986e(0x124),_0x161eda===null||_0x161eda===void 0x0?void 0x0:_0x161eda[_0x28986e(0x124)],_0x28986e(0x147),(_0x846589=_0x161eda===null||_0x161eda===void 0x0?void 0x0:_0x161eda['response'])===null||_0x846589===void 0x0?void 0x0:_0x846589[_0x28986e(0xc5)],_0x28986e(0x165),(_0x488ca0=_0x161eda===null||_0x161eda===void 0x0?void 0x0:_0x161eda[_0x28986e(0x16b)])===null||_0x488ca0===void 0x0?void 0x0:_0x488ca0[_0x28986e(0x165)]);if(_0x161eda[_0x28986e(0x165)]&&_0x161eda['status']===0x192){const _0x21af56={'message':_0x28986e(0x1ab)+_0x161eda[_0x28986e(0x124)],'code':0x192};if(_0x39985c)return _0x39985c[_0x28986e(0x16d)](JSON[_0x28986e(0x129)](_0x21af56));else throw new common_1[(_0x28986e(0xb4))](_0x161eda[_0x28986e(0x124)],common_1[_0x28986e(0x187)][_0x28986e(0x119)]);}if(!_0x2c4c70){if(_0x39985c)return _0x39985c[_0x28986e(0x16d)](JSON[_0x28986e(0x129)]({'message':_0x161eda[_0x28986e(0x124)],'code':0x1f4}));else throw new common_1['HttpException'](_0x161eda[_0x28986e(0x124)],common_1['HttpStatus'][_0x28986e(0xd4)]);}let _0xccce6a=errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x2c4c70]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x2c4c70]:_0x28986e(0xb3);(_0x161eda===null||_0x161eda===void 0x0?void 0x0:_0x161eda[_0x28986e(0x124)]['includes'](_0x28986e(0x141)))&&Number(_0x400d78)===0x1&&(await this[_0x28986e(0x157)][_0x28986e(0x133)](_0x430f98,_0x28986e(0x163),-0x1),_0xccce6a='当前模型key已被封禁');(_0x161eda===null||_0x161eda===void 0x0?void 0x0:_0x161eda[_0x28986e(0x1a1)])===0x1ad&&_0x161eda[_0x28986e(0x124)][_0x28986e(0x12b)]('billing')&&Number(_0x400d78)===0x1&&(await this[_0x28986e(0x157)][_0x28986e(0x133)](_0x430f98,_0x28986e(0xe6),-0x3),_0xccce6a='当前模型key余额已耗尽');(_0x161eda===null||_0x161eda===void 0x0?void 0x0:_0x161eda['statusCode'])===0x1ad&&(_0x161eda===null||_0x161eda===void 0x0?void 0x0:_0x161eda['statusText'])===_0x28986e(0x136)&&(_0xccce6a=_0x28986e(0x17f));(_0x161eda===null||_0x161eda===void 0x0?void 0x0:_0x161eda['statusCode'])===0x191&&_0x161eda[_0x28986e(0x124)][_0x28986e(0x12b)](_0x28986e(0x15b))&&Number(_0x400d78)===0x1&&(await this['modelsService'][_0x28986e(0x133)](_0x430f98,_0x28986e(0x182),-0x2),_0xccce6a=_0x28986e(0xa5));(_0x161eda===null||_0x161eda===void 0x0?void 0x0:_0x161eda['statusCode'])===0x194&&_0x161eda[_0x28986e(0x124)][_0x28986e(0x12b)]('This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported')&&Number(_0x400d78)===0x1&&(await this['modelsService'][_0x28986e(0x133)](_0x430f98,'当前模型不是聊天模型',-0x4),_0xccce6a=_0x28986e(0xe5));_0x59f343===0x190&&console[_0x28986e(0x1a8)](_0x28986e(0x130),_0x161eda,_0x161eda[_0x28986e(0x124)]);const _0x4b75a0={'message':_0xccce6a||_0x28986e(0x113),'code':_0x59f343===0x191?0x190:_0x59f343||0x1f4};if(_0x39985c)return _0x39985c[_0x28986e(0x16d)](JSON[_0x28986e(0x129)](_0x4b75a0));else throw new common_1[(_0x28986e(0xb4))](_0x4b75a0[_0x28986e(0x124)],common_1[_0x28986e(0x187)][_0x28986e(0xd4)]);}finally{_0x39985c&&_0x39985c[_0x28986e(0x195)]();}}async[_0x552da4(0x110)](_0xf70c1e,_0x38ac5b){const _0x159a00=_0x552da4;var _0x3548a6,_0x51bdbe,_0x1f1b73,_0x10e21d;await this['badwordsService'][_0x159a00(0x166)](_0xf70c1e[_0x159a00(0x111)],_0x38ac5b[_0x159a00(0x144)]['id']),await this[_0x159a00(0x14f)][_0x159a00(0x14c)](_0x38ac5b[_0x159a00(0x144)]);const _0xa92dd0=(_0xf70c1e===null||_0xf70c1e===void 0x0?void 0x0:_0xf70c1e[_0x159a00(0xce)])==='hd'?0x4:0x2;await this[_0x159a00(0xb1)][_0x159a00(0x17c)](_0x38ac5b,_0x159a00(0x12e),_0xa92dd0);let _0x258184=[];const _0x3538be=await this[_0x159a00(0x157)][_0x159a00(0xf7)](_0x159a00(0xc8)),_0x46f548=_0x3538be===null||_0x3538be===void 0x0?void 0x0:_0x3538be['id'],{key:_0x2255eb,proxyResUrl:_0x495a72}=await this[_0x159a00(0xf0)](_0x3538be);common_1[_0x159a00(0x172)]['log'](_0x159a00(0x180)+_0xf70c1e[_0x159a00(0x111)]+',\x20key\x20===>\x20'+_0x2255eb,_0x159a00(0x171));try{const _0x32d6ca=_0x495a72+'/v1/images/generations',_0x3a9e55=Object[_0x159a00(0x196)](Object['assign']({},_0xf70c1e),{'model':_0x159a00(0xc8)});console[_0x159a00(0x1a8)](_0x159a00(0x181),_0x3a9e55);const _0x40769f=await axios_1[_0x159a00(0x1a6)][_0x159a00(0x1af)](_0x32d6ca,Object[_0x159a00(0x196)](Object[_0x159a00(0x196)]({},_0x3a9e55),{'response_format':'b64_json'}),{'headers':{'Authorization':'Bearer\x20'+_0x2255eb}});_0x258184=_0x40769f[_0x159a00(0x142)][_0x159a00(0x142)];const _0x318975=[];for(const _0x16bdc5 of _0x258184){const _0x1e1b59=uuid['v4']()[_0x159a00(0xaa)](0x0,0xa)+_0x159a00(0x159),_0x4643a1=Buffer['from'](_0x16bdc5[_0x159a00(0xe9)],'base64');_0x318975[_0x159a00(0x155)](this[_0x159a00(0xd8)][_0x159a00(0xfc)]({'filename':_0x1e1b59,'buffer':_0x4643a1}));}const _0x28a1a1=await Promise[_0x159a00(0x13c)](_0x318975);await this['userBalanceService'][_0x159a00(0x123)](_0x38ac5b[_0x159a00(0x144)]['id'],_0x159a00(0x12e),(_0x3a9e55===null||_0x3a9e55===void 0x0?void 0x0:_0x3a9e55[_0x159a00(0xce)])===_0x159a00(0xca)?0x2:0x4,_0xa92dd0);const _0x1b3485=(0x0,utils_1['getClientIp'])(_0x38ac5b),_0x2df291=[],_0x2751b3=await this[_0x159a00(0xd8)][_0x159a00(0xd6)](),[_0x5d27ec,_0x233d85]=_0xf70c1e[_0x159a00(0x175)][_0x159a00(0xea)]('x');return _0x28a1a1[_0x159a00(0x16a)](_0x3e81fe=>{const _0x3f005c=_0x159a00;_0x2df291['push'](this[_0x3f005c(0xf6)][_0x3f005c(0xae)]({'curIp':_0x1b3485,'userId':_0x38ac5b['user']['id'],'type':balance_constant_1['DeductionKey'][_0x3f005c(0x199)],'prompt':_0xf70c1e['prompt'],'answer':_0x3e81fe,'fileInfo':JSON[_0x3f005c(0x129)]({'cosType':_0x2751b3,'width':_0x5d27ec,'height':_0x233d85,'cosUrl':_0x3e81fe}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x3f005c(0xc8)}));}),await Promise[_0x159a00(0x13c)](_0x2df291),_0x28a1a1;}catch(_0x184a94){const _0x377c17=((_0x3548a6=_0x184a94===null||_0x184a94===void 0x0?void 0x0:_0x184a94[_0x159a00(0x16b)])===null||_0x3548a6===void 0x0?void 0x0:_0x3548a6[_0x159a00(0x165)])||0x1f4;console[_0x159a00(0x1a8)](_0x159a00(0x153),JSON[_0x159a00(0x129)](_0x184a94),_0x2255eb,_0x377c17);const _0x83dd44=(_0x10e21d=(_0x1f1b73=(_0x51bdbe=_0x184a94===null||_0x184a94===void 0x0?void 0x0:_0x184a94[_0x159a00(0x16b)])===null||_0x51bdbe===void 0x0?void 0x0:_0x51bdbe[_0x159a00(0x142)])===null||_0x1f1b73===void 0x0?void 0x0:_0x1f1b73[_0x159a00(0x115)])===null||_0x10e21d===void 0x0?void 0x0:_0x10e21d['message'];if(_0x377c17===0x1ad)throw new common_1['HttpException'](_0x159a00(0xe3),common_1[_0x159a00(0x187)][_0x159a00(0xd4)]);if(_0x377c17===0x190&&_0x83dd44[_0x159a00(0x12b)](_0x159a00(0x14d)))throw new common_1[(_0x159a00(0xb4))](_0x159a00(0x18c),common_1['HttpStatus'][_0x159a00(0xd4)]);if(_0x377c17===0x190&&_0x83dd44[_0x159a00(0x12b)](_0x159a00(0x190))){await this['modelsService'][_0x159a00(0x133)](_0x46f548,_0x159a00(0x163),-0x1);throw new common_1[(_0x159a00(0xb4))](_0x159a00(0xe8),common_1['HttpStatus']['BAD_REQUEST']);}if(_0x377c17===0x1f4)throw new common_1[(_0x159a00(0xb4))]('绘制图片失败，请检查你的提示词是否有非法描述！',common_1[_0x159a00(0x187)][_0x159a00(0xd4)]);if(_0x377c17===0x191)throw new common_1[(_0x159a00(0xb4))](_0x159a00(0x154),common_1[_0x159a00(0x187)][_0x159a00(0xd4)]);throw new common_1[(_0x159a00(0xb4))]('绘制图片失败，请稍后试试吧！',common_1[_0x159a00(0x187)]['BAD_REQUEST']);}}async[_0x552da4(0x1a0)](){const _0x402234=_0x552da4,_0x2f893d=await this[_0x402234(0x135)][_0x402234(0xbe)]({'where':{'status':0x1},'select':['id',_0x402234(0x146),_0x402234(0xdb),_0x402234(0x17d),_0x402234(0xf1),_0x402234(0x192),_0x402234(0xaf),_0x402234(0x19b)]}),_0x165706=_0x2f893d[_0x402234(0xd3)](_0x4b63fb=>_0x4b63fb[_0x402234(0x17d)][_0x402234(0x12b)](_0x402234(0xe7))),_0x23b800=_0x2f893d['filter'](_0x4e4608=>_0x4e4608[_0x402234(0x17d)][_0x402234(0x12b)](_0x402234(0x127)));this[_0x402234(0xe0)]={'list3':_0x165706,'list4':_0x23b800};}async[_0x552da4(0x11c)](_0x52ab64){const _0x58a5c9=_0x552da4,_0x34c230=await this[_0x58a5c9(0x1a9)]['getConfigs']([_0x58a5c9(0x145)]);return(_0x52ab64===null||_0x52ab64===void 0x0?void 0x0:_0x52ab64[_0x58a5c9(0xb8)])||_0x34c230||'https://api.openai.com';}async['formatModelToken'](_0x4206ad){const _0x414116=_0x552da4,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x414116(0x1a9)][_0x414116(0xe1)]([_0x414116(0x10d),'openaiModel3MaxTokensRes',_0x414116(0xa8),_0x414116(0x16c),'openaiModel4MaxTokens','openaiModel4MaxTokensRes',_0x414116(0x12c),_0x414116(0x138),'openaiBaseUrl']);let _0x268338=null,_0x4b40a0=null,_0x211cac=null,{model:_0x1e17b2,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x4b43cc}=_0x4206ad;return _0x1e17b2[_0x414116(0x10a)]()[_0x414116(0x12b)]('gpt-4')&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x4b40a0>=0x1000&&(maxModelTokens=0x1000),_0x268338=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x4b40a0=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x1e17b2[_0x414116(0x10a)]()['includes'](_0x414116(0x185))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x4b40a0>=0x4000&&(maxModelTokens=0x4000),_0x268338=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x4b40a0=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x1e17b2[_0x414116(0x10a)]()[_0x414116(0x12b)]('1106')&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x4b40a0>=0x1000&&(maxModelTokens=0x1000),_0x268338=maxModelTokens||0x3ffc,_0x4b40a0=maxResponseTokens||0x1000)),_0x1e17b2[_0x414116(0x10a)]()[_0x414116(0x12b)](_0x414116(0xe7))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x4b40a0>=0x7d0&&(maxModelTokens=0x7d0),_0x268338=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x4b40a0=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x1e17b2[_0x414116(0x10a)]()[_0x414116(0x12b)]('16k')&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x4b40a0>=0x2000&&(maxModelTokens=0x2000),_0x268338=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x4b40a0=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x1e17b2[_0x414116(0x10a)]()[_0x414116(0x12b)](_0x414116(0x143))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x4b40a0>=0x1000&&(maxModelTokens=0x1000),_0x268338=maxModelTokens||0x4000,_0x4b40a0=maxResponseTokens||0x1000)),_0x211cac=proxyUrl||openaiBaseUrl||_0x414116(0xc2),_0x4b40a0>=_0x268338&&(_0x4b40a0=Math['floor'](_0x268338/0x2)),{'key':_0x4b43cc,'maxToken':_0x268338,'maxTokenRes':_0x4b40a0,'proxyResUrl':_0x211cac};}async[_0x552da4(0xff)](_0x44a49a,_0xc6e06a){const _0x1dabec=_0x552da4;try{const {name:_0x343a16,icon:_0x71cff7,order:_0x1d34f2,id:_0x3d61e8,status:_0x9e3ad}=_0xc6e06a;return _0x3d61e8?await this[_0x1dabec(0xcc)][_0x1dabec(0xbf)]({'id':_0x3d61e8},{'name':_0x343a16,'icon':_0x71cff7,'order':_0x1d34f2,'status':_0x9e3ad}):await this[_0x1dabec(0xcc)][_0x1dabec(0xfe)]({'name':_0x343a16,'icon':_0x71cff7,'order':_0x1d34f2,'status':_0x9e3ad});}catch(_0x47a114){console['log'](_0x1dabec(0xba),_0x47a114);}}async[_0x552da4(0xbb)](_0x55aed6,_0x3afa97){const _0x4c22f6=_0x552da4,{id:_0x384f7d}=_0x3afa97;if(!_0x384f7d)throw new common_1[(_0x4c22f6(0xb4))](_0x4c22f6(0xa6),common_1['HttpStatus'][_0x4c22f6(0xd4)]);const _0x2b581d=await this['chatBoxEntity'][_0x4c22f6(0xa9)]({'where':{'typeId':_0x384f7d}});if(_0x2b581d)throw new common_1[(_0x4c22f6(0xb4))](_0x4c22f6(0x13d),common_1['HttpStatus'][_0x4c22f6(0xd4)]);return await this[_0x4c22f6(0xcc)][_0x4c22f6(0x16e)]({'id':_0x384f7d});}async[_0x552da4(0x1b0)](){const _0x2644aa=_0x552da4;return await this[_0x2644aa(0xcc)][_0x2644aa(0xbe)]({'order':{'order':_0x2644aa(0x19d)}});}async[_0x552da4(0x13f)](_0x44f087,_0x584949){const _0x136118=_0x552da4,{title:_0x3b569a,prompt:_0x32f4df,appId:_0x2996b8,order:_0x4b6b41,status:_0x13b6a1,typeId:_0x434f3f,id:_0x83b31a,url:_0x221190}=_0x584949;if(!_0x434f3f)throw new common_1['HttpException'](_0x136118(0x19a),common_1['HttpStatus']['BAD_REQUEST']);try{const _0x14dede={'title':_0x3b569a,'order':_0x4b6b41,'status':_0x13b6a1,'typeId':_0x434f3f,'url':_0x221190};return _0x14dede[_0x136118(0x152)]=_0x2996b8||0x0,_0x14dede['prompt']=_0x32f4df||'',_0x83b31a?await this[_0x136118(0xf9)][_0x136118(0xbf)]({'id':_0x83b31a},_0x14dede):await this[_0x136118(0xf9)]['save'](_0x14dede);}catch(_0xf81a29){console[_0x136118(0x1a8)]('error:\x20',_0xf81a29);}}async[_0x552da4(0x16f)](_0x1fa799,_0x155576){const _0x4865c4=_0x552da4,{id:_0x23c4c7}=_0x155576;if(!_0x23c4c7)throw new common_1[(_0x4865c4(0xb4))]('非法操作！',common_1[_0x4865c4(0x187)][_0x4865c4(0xd4)]);return await this['chatBoxEntity'][_0x4865c4(0x16e)]({'id':_0x23c4c7});}async[_0x552da4(0x100)](){const _0x2ac5f8=_0x552da4,_0x5bb4e0=await this[_0x2ac5f8(0xf9)][_0x2ac5f8(0xbe)]({'order':{'order':_0x2ac5f8(0x19d)}}),_0x147f4a=[...new Set(_0x5bb4e0[_0x2ac5f8(0xc1)](_0x4344ef=>_0x4344ef[_0x2ac5f8(0x137)]))],_0x3a86f3=[...new Set(_0x5bb4e0[_0x2ac5f8(0xc1)](_0x284265=>_0x284265[_0x2ac5f8(0x152)]))],_0x2ff9b7=await this['chatBoxTypeEntity'][_0x2ac5f8(0xbe)]({'where':{'id':(0x0,typeorm_1['In'])(_0x147f4a)}}),_0x2d9d80=await this[_0x2ac5f8(0x168)][_0x2ac5f8(0xbe)]({'where':{'id':(0x0,typeorm_1['In'])(_0x3a86f3)}});return _0x5bb4e0[_0x2ac5f8(0xc1)](_0x1fa8f3=>{const _0x2be6af=_0x2ac5f8,{typeId:_0x22a635,appId:_0x28e1ad}=_0x1fa8f3;return _0x1fa8f3['typeInfo']=_0x2ff9b7[_0x2be6af(0xbe)](_0x3f55f2=>_0x3f55f2['id']===_0x22a635),_0x1fa8f3[_0x2be6af(0xec)]=_0x2d9d80[_0x2be6af(0xbe)](_0x568fa7=>_0x568fa7['id']===_0x28e1ad),_0x1fa8f3;});}async['queryChatBoxFrontend'](){const _0x37e15e=_0x552da4,_0x31bcfc=await this[_0x37e15e(0xcc)][_0x37e15e(0xbe)]({'order':{'order':_0x37e15e(0x19d)},'where':{'status':!![]}}),_0x1e0312=await this[_0x37e15e(0xf9)][_0x37e15e(0xbe)]({'where':{'status':!![]}}),_0x5254df=[...new Set(_0x1e0312[_0x37e15e(0xc1)](_0x3c7afa=>_0x3c7afa[_0x37e15e(0x152)]))],_0x53a760=await this['appEntity'][_0x37e15e(0xbe)]({'where':{'id':(0x0,typeorm_1['In'])(_0x5254df)}});return _0x1e0312[_0x37e15e(0x16a)](_0x5289e8=>{const _0x13ed4a=_0x37e15e,_0xfbec9b=_0x53a760['find'](_0x1ae449=>_0x1ae449['id']===_0x5289e8[_0x13ed4a(0x152)]);return _0x5289e8['coverImg']=_0xfbec9b===null||_0xfbec9b===void 0x0?void 0x0:_0xfbec9b[_0x13ed4a(0x11e)],_0x5289e8;}),_0x31bcfc[_0x37e15e(0xc1)](_0x1fe4ae=>{const _0x34065e=_0x37e15e;return _0x1fe4ae[_0x34065e(0x1a7)]=_0x1e0312['filter'](_0x411aba=>_0x411aba['typeId']===_0x1fe4ae['id']&&_0x411aba[_0x34065e(0x165)]),_0x1fe4ae;});}async[_0x552da4(0xfb)](_0x1b1fda,_0x530d6d){const _0x5a17a5=_0x552da4;try{const {name:_0x498562,icon:_0x551b37,order:_0x1b71bb,id:_0x4f56c9,status:_0x1a3791}=_0x530d6d;return _0x4f56c9?await this[_0x5a17a5(0x12a)][_0x5a17a5(0xbf)]({'id':_0x4f56c9},{'name':_0x498562,'icon':_0x551b37,'order':_0x1b71bb,'status':_0x1a3791}):await this['chatPreTypeEntity'][_0x5a17a5(0xfe)]({'name':_0x498562,'icon':_0x551b37,'order':_0x1b71bb,'status':_0x1a3791});}catch(_0xe088f0){console[_0x5a17a5(0x1a8)](_0x5a17a5(0xba),_0xe088f0);}}async[_0x552da4(0x1ae)](_0x160803,_0x4c0632){const _0x4f8fa8=_0x552da4,{id:_0x5d6ca4}=_0x4c0632;if(!_0x5d6ca4)throw new common_1[(_0x4f8fa8(0xb4))]('非法操作！',common_1[_0x4f8fa8(0x187)][_0x4f8fa8(0xd4)]);const _0x578d74=await this[_0x4f8fa8(0xf9)][_0x4f8fa8(0xa9)]({'where':{'typeId':_0x5d6ca4}});if(_0x578d74)throw new common_1[(_0x4f8fa8(0xb4))](_0x4f8fa8(0x13d),common_1[_0x4f8fa8(0x187)][_0x4f8fa8(0xd4)]);return await this['chatPreTypeEntity'][_0x4f8fa8(0x16e)]({'id':_0x5d6ca4});}async[_0x552da4(0x184)](){const _0x97fc33=_0x552da4;return await this[_0x97fc33(0x12a)][_0x97fc33(0xbe)]({'order':{'order':_0x97fc33(0x19d)}});}async[_0x552da4(0x189)](_0x12ae09,_0x5f4ac4){const _0x3f24c8=_0x552da4,{title:_0x497571,prompt:_0x56bc90,appId:_0x2d452a,order:_0x24c678,status:_0x33a3ac,typeId:_0x2bf643,id:_0x476a00,url:_0x37d10}=_0x5f4ac4;if(!_0x2bf643)throw new common_1[(_0x3f24c8(0xb4))]('缺失必要参数！',common_1[_0x3f24c8(0x187)][_0x3f24c8(0xd4)]);try{const _0x5ddfbf={'title':_0x497571,'prompt':_0x56bc90,'order':_0x24c678,'status':_0x33a3ac,'typeId':_0x2bf643,'url':_0x37d10};return _0x476a00?await this[_0x3f24c8(0x179)]['update']({'id':_0x476a00},_0x5ddfbf):await this['chatPreEntity'][_0x3f24c8(0xfe)](_0x5ddfbf);}catch(_0x4e431b){console[_0x3f24c8(0x1a8)](_0x3f24c8(0xba),_0x4e431b);}}async[_0x552da4(0x174)](_0x33cdb2,_0x260021){const _0x5e1461=_0x552da4,{id:_0x29e206}=_0x260021;if(!_0x29e206)throw new common_1['HttpException'](_0x5e1461(0xa6),common_1['HttpStatus']['BAD_REQUEST']);return await this[_0x5e1461(0x179)][_0x5e1461(0x16e)]({'id':_0x29e206});}async[_0x552da4(0xfd)](){const _0xf34c4d=_0x552da4,_0x48c7a4=await this[_0xf34c4d(0x179)]['find']({'order':{'order':_0xf34c4d(0x19d)}}),_0x474a69=[...new Set(_0x48c7a4[_0xf34c4d(0xc1)](_0x14079b=>_0x14079b[_0xf34c4d(0x137)]))],_0x537d31=await this[_0xf34c4d(0x12a)][_0xf34c4d(0xbe)]({'where':{'id':(0x0,typeorm_1['In'])(_0x474a69)}});return _0x48c7a4['map'](_0x3ccb07=>{const _0x199e20=_0xf34c4d,{typeId:_0x1bcb78,appId:_0x9656f4}=_0x3ccb07;return _0x3ccb07[_0x199e20(0x151)]=_0x537d31[_0x199e20(0xbe)](_0x1a2c7c=>_0x1a2c7c['id']===_0x1bcb78),_0x3ccb07;});}async[_0x552da4(0x18d)](){const _0x57674f=_0x552da4,_0x2ca741=await this[_0x57674f(0x12a)][_0x57674f(0xbe)]({'order':{'order':_0x57674f(0x19d)},'where':{'status':!![]}}),_0x56a031=await this[_0x57674f(0x179)][_0x57674f(0xbe)]({'where':{'status':!![]}});return _0x2ca741[_0x57674f(0xc1)](_0x26193c=>{const _0x506907=_0x57674f;return _0x26193c[_0x506907(0x1a7)]=_0x56a031[_0x506907(0xd3)](_0x2f9298=>_0x2f9298['typeId']===_0x26193c['id']&&_0x2f9298[_0x506907(0x165)]),_0x26193c;});}async['getMaxTokenFromModelWithOpenAi'](_0x5aa9e3,_0x1ab3b7,_0xb5249){const _0xf0b78f=_0x552da4;let _0x15a433=0x1000,_0x45ec7f=0x800;return _0x5aa9e3[_0xf0b78f(0x10a)]()[_0xf0b78f(0x12b)](_0xf0b78f(0x127))&&(_0x15a433=_0x1ab3b7>=0x2004?0x2004:_0x1ab3b7,_0x45ec7f=_0xb5249>=0x1000?0x1000:_0xb5249,_0x5aa9e3['toLowerCase']()[_0xf0b78f(0x12b)](_0xf0b78f(0x185))&&(_0x15a433=_0x1ab3b7>=0x8000?0x8000:_0x1ab3b7,_0x45ec7f=_0xb5249>=0x3e80?0x3e80:_0xb5249),(_0x5aa9e3[_0xf0b78f(0x10a)]()[_0xf0b78f(0x12b)](_0xf0b78f(0x11f))||_0x5aa9e3[_0xf0b78f(0x10a)]()[_0xf0b78f(0x12b)]('gpt-4-vision-preview'))&&(_0x15a433=_0x1ab3b7>=0x1f400?0x1f400:_0x1ab3b7,_0x45ec7f=_0xb5249>=0x1000?0x1000:_0xb5249)),_0x5aa9e3[_0xf0b78f(0x10a)]()[_0xf0b78f(0x12b)](_0xf0b78f(0xe7))&&(_0x15a433=_0x1ab3b7>=0x1000?0x1000:_0x1ab3b7,_0x45ec7f=_0xb5249>=0x800?0x800:_0xb5249,_0x5aa9e3[_0xf0b78f(0x10a)]()[_0xf0b78f(0x12b)](_0xf0b78f(0x101))&&(_0x15a433=_0x1ab3b7>=0x4000?0x4000:_0x1ab3b7,_0x45ec7f=_0xb5249>=0x1f40?0x1f40:_0xb5249),_0x5aa9e3['toLowerCase']()[_0xf0b78f(0x12b)]('1106')&&(_0x15a433=_0x1ab3b7>=0x4000?0x4000:_0x1ab3b7,_0x45ec7f=_0xb5249>=0x1f40?0x1f40:_0xb5249)),{'maxToken':_0x15a433,'maxRes':_0x45ec7f};}};ChatgptService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x552da4(0x1ad)])(gptkeys_entity_1[_0x552da4(0x114)])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(config_entity_1[_0x552da4(0x11a)])),__param(0x2,(0x0,typeorm_2[_0x552da4(0x1ad)])(chatBoxType_entity_1[_0x552da4(0x12f)])),__param(0x3,(0x0,typeorm_2[_0x552da4(0x1ad)])(chatBox_entity_1[_0x552da4(0x104)])),__param(0x4,(0x0,typeorm_2['InjectRepository'])(app_entity_1[_0x552da4(0x167)])),__param(0x5,(0x0,typeorm_2[_0x552da4(0x1ad)])(chatPreType_entity_1[_0x552da4(0x105)])),__param(0x6,(0x0,typeorm_2[_0x552da4(0x1ad)])(chatPre_entity_1[_0x552da4(0xbc)])),__metadata('design:paramtypes',[typeorm_1[_0x552da4(0xde)],typeorm_1['Repository'],typeorm_1[_0x552da4(0xde)],typeorm_1[_0x552da4(0xde)],typeorm_1[_0x552da4(0xde)],typeorm_1[_0x552da4(0xde)],typeorm_1[_0x552da4(0xde)],nestjs_config_1['ConfigService'],userBalance_service_1[_0x552da4(0x158)],chatLog_service_1[_0x552da4(0xa4)],user_service_1[_0x552da4(0xe2)],upload_service_1[_0x552da4(0xef)],badwords_service_1[_0x552da4(0x18b)],autoreply_service_1['AutoreplyService'],globalConfig_service_1[_0x552da4(0xe4)],fanyi_service_1[_0x552da4(0x1a2)],chatGroup_service_1[_0x552da4(0x186)],models_service_1[_0x552da4(0x10e)]])],ChatgptService),exports['ChatgptService']=ChatgptService;