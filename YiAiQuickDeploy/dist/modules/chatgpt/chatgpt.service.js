'use strict';const _0x4b4875=_0x16d6;(function(_0x3dab86,_0x388c3d){const _0x256601=_0x16d6,_0x2f5b55=_0x3dab86();while(!![]){try{const _0x594ce0=parseInt(_0x256601(0x268))/0x1+-parseInt(_0x256601(0x1b6))/0x2+-parseInt(_0x256601(0x287))/0x3+-parseInt(_0x256601(0x26c))/0x4+-parseInt(_0x256601(0x277))/0x5+-parseInt(_0x256601(0x289))/0x6+parseInt(_0x256601(0x196))/0x7*(parseInt(_0x256601(0x281))/0x8);if(_0x594ce0===_0x388c3d)break;else _0x2f5b55['push'](_0x2f5b55['shift']());}catch(_0x566844){_0x2f5b55['push'](_0x2f5b55['shift']());}}}(_0x4b00,0xb79f5));function _0x16d6(_0x443434,_0x4ab2da){const _0x4b0077=_0x4b00();return _0x16d6=function(_0x16d618,_0x614bc3){_0x16d618=_0x16d618-0x193;let _0x462982=_0x4b0077[_0x16d618];return _0x462982;},_0x16d6(_0x443434,_0x4ab2da);}var __decorate=this&&this[_0x4b4875(0x1f2)]||function(_0xd21c0f,_0x301517,_0x1fb33c,_0x3aa94f){const _0x373e8d=_0x4b4875;var _0xfc595d=arguments[_0x373e8d(0x20f)],_0x2d2c7b=_0xfc595d<0x3?_0x301517:_0x3aa94f===null?_0x3aa94f=Object[_0x373e8d(0x235)](_0x301517,_0x1fb33c):_0x3aa94f,_0x14d52e;if(typeof Reflect===_0x373e8d(0x255)&&typeof Reflect[_0x373e8d(0x1a9)]===_0x373e8d(0x215))_0x2d2c7b=Reflect[_0x373e8d(0x1a9)](_0xd21c0f,_0x301517,_0x1fb33c,_0x3aa94f);else{for(var _0x4b793d=_0xd21c0f[_0x373e8d(0x20f)]-0x1;_0x4b793d>=0x0;_0x4b793d--)if(_0x14d52e=_0xd21c0f[_0x4b793d])_0x2d2c7b=(_0xfc595d<0x3?_0x14d52e(_0x2d2c7b):_0xfc595d>0x3?_0x14d52e(_0x301517,_0x1fb33c,_0x2d2c7b):_0x14d52e(_0x301517,_0x1fb33c))||_0x2d2c7b;}return _0xfc595d>0x3&&_0x2d2c7b&&Object[_0x373e8d(0x1ad)](_0x301517,_0x1fb33c,_0x2d2c7b),_0x2d2c7b;},__metadata=this&&this[_0x4b4875(0x1c1)]||function(_0x40587c,_0x5f11d4){const _0x5ea93e=_0x4b4875;if(typeof Reflect===_0x5ea93e(0x255)&&typeof Reflect[_0x5ea93e(0x24f)]==='function')return Reflect['metadata'](_0x40587c,_0x5f11d4);},__param=this&&this[_0x4b4875(0x234)]||function(_0x1d5048,_0x14d969){return function(_0x4108de,_0x170238){_0x14d969(_0x4108de,_0x170238,_0x1d5048);};};Object['defineProperty'](exports,_0x4b4875(0x1a0),{'value':!![]}),exports['ChatgptService']=void 0x0;function _0x4b00(){const _0x7cf39e=['ChatLogService','UploadService','modelInfo','write','lockKey','queryChatPreType','delChatBox','37972192bjghDg','./../user/user.service','close','imageUrl','addOneIfOdd','userService','2710122YRytBX','response','7250010cqvVMg','./chatPre.entity','delChatPre','typeInfo','detail','7DpmwTa','.png','formatModelToken',',\x20消耗积分：\x20','HttpException','saveChatLog','model','env','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','includes','__esModule','default','32k','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','chatProcess','当前请求已过载、请稍等会儿再试试吧！','gpt-4-vision-preview','model4','log','decorate','queryChatBoxType','save','ChatgptService','defineProperty','queryChatBox','sendMessageFromOpenAi','usage','setChatBox','Logger','key','redis://','delChatBoxType','2874920QTcBFV','当前模型调用过于频繁、请重新试试吧！','REDIS_HOST','chatPreTypeEntity','code:\x20','ChatGroupService','setChatPre','keyv','当前模型key已被封禁','NineStore','autoreplyService','__metadata','split','ceil','slice','buildMessageFromParentMessageId','findOne','当前模型key余额已耗尽','GlobalConfigService','sendMessageFromZhipu','@keyv/redis','openaiBaseUrl','OpenAiErrorCodeMessage','ChatPreTypeEntity','checkBadWords','keyPool','chatgpt-ai-web','getModelProxyUrl','compileNetwork','openaiTimeoutMs','\x0a\x20Current\x20date:\x20','delChatPreType','data','16k','error:\x20','uploadService','systemPreMessage','weight','dall-e-3','openaiModel3MaxTokens16kRes','quality','config','gpt-3','chatLogService','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','400\x20error','design:paramtypes','unifiedFormattingResponse','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','PAINT_TYPE','preset',',\x20key\x20===>\x20','userBalanceService','validateBalance','非法操作！','importDynamic','conversationId','modelsService','用户ID:\x20','globalConfigService','__decorate','result','HttpStatus','BadwordsService','badwordsService','stringify','size','fanyiService','coverImg','getRandomDrawKey','find','axios','当前模型不是聊天模型','1106','user','../../common/constants/errorMessage.constant','openaiModel4MaxTokensRes','getConfigs','BAD_REQUEST','removeSpecialCharacters','UserBalanceService','getBaseConfig','https://api.openai.com','dall','openaiModel3MaxTokens','post','Bearer\x20','ConfigEntity','AutoreplyService','length','checkUserStatus','getRequestParams','./../upload/upload.service','filter','text','function','debug','./gptkeys.entity','chat','openaiModel4MaxTokens','maxResponseTokens','@nestjs/typeorm','status','maxModelTokens','chatGroupService','all','proxyUrl','FanyiService','childList','uploadFile','queryUserBalance','mjDraw','delete','../globalConfig/config.entity','getUploadType','assign','typeId','getAllKeyList','appEntity','Content-type','当前分类下有未处理数据不可移除！','chatBoxTypeEntity','userBanance','standard','绘制图片失败，请检查你的提示词是否有非法描述！','gptKeysEntity','__param','getOwnPropertyDescriptor','configService','message','Too\x20Many\x20Requests','parse','systemMessage','getMaxTokenFromModelWithOpenAi','chat-error\x20<----------------------------------------->','DESC','绘制图片失败，请稍后试试吧！','./store','AppEntity','InjectRepository','./zhipu','Injectable','../models/models.service','Repository','application/octet-stream;\x20charset=utf-8','getClientIp','deductFromBalance','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','assistant','end','./helper','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','setData','metadata','@nestjs/common','push','toISOString','b64_json','update','object','../autoreply/autoreply.service','getTokenCount','CHAT_TYPE','is_end','缺失必要参数！','gpt-4-1106','getCurrentModelKeyInfo','from','DeductionKey','statusText','../../common/constants/balance.constant','ModelsService','base64','./chatBox.entity','当前Key余额已不足、请重新再试一次吧！','prompt','map','count','244266cAwjGv','draw\x20paompt\x20info\x20<==**==>\x20','appId','statusCode','2043036fhrpHg','./chatBoxType.entity','draw','forEach','ConfigService','chatBoxEntity','/v1/images/generations','saveUseLog','./openai','toLowerCase','nineStore','893725ydFPoA','chat-error-detail\x20\x20<----------------------------------------->','chatPreEntity'];_0x4b00=function(){return _0x7cf39e;};return _0x4b00();}const upload_service_1=require(_0x4b4875(0x212)),user_service_1=require(_0x4b4875(0x282)),nestjs_config_1=require('nestjs-config'),common_1=require(_0x4b4875(0x250)),errorMessage_constant_1=require(_0x4b4875(0x201)),utils_1=require('../../common/utils'),axios_1=require(_0x4b4875(0x1fd)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require(_0x4b4875(0x260)),chatLog_service_1=require('../chatLog/chatLog.service'),uuid=require('uuid'),config_entity_1=require(_0x4b4875(0x227)),typeorm_1=require('typeorm'),typeorm_2=require(_0x4b4875(0x21b)),badwords_service_1=require('../badwords/badwords.service'),autoreply_service_1=require(_0x4b4875(0x256)),gptkeys_entity_1=require(_0x4b4875(0x217)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),fanyi_service_1=require('../fanyi/fanyi.service'),app_entity_1=require('../app/app.entity'),chatGroup_service_1=require('../chatGroup/chatGroup.service'),models_service_1=require(_0x4b4875(0x244)),baidu_1=require('./baidu'),helper_1=require(_0x4b4875(0x24c)),store_1=require(_0x4b4875(0x23f)),zhipu_1=require(_0x4b4875(0x242)),openai_1=require(_0x4b4875(0x274)),chatBoxType_entity_1=require(_0x4b4875(0x26d)),chatBox_entity_1=require(_0x4b4875(0x263)),chatPre_entity_1=require(_0x4b4875(0x28a)),chatPreType_entity_1=require('./chatPreType.entity');let ChatgptService=class ChatgptService{constructor(_0x1dd95d,_0x1558c4,_0x431856,_0x257fdc,_0x28bfba,_0x4c6387,_0x2883b1,_0xef4c72,_0x9a479e,_0x353621,_0x10c75d,_0xa0f81e,_0x52e157,_0x156471,_0x2e3872,_0x25e135,_0x3c7858,_0x217475){const _0xf9cbaa=_0x4b4875;this['gptKeysEntity']=_0x1dd95d,this['configEntity']=_0x1558c4,this['chatBoxTypeEntity']=_0x431856,this[_0xf9cbaa(0x271)]=_0x257fdc,this[_0xf9cbaa(0x22c)]=_0x28bfba,this[_0xf9cbaa(0x1b9)]=_0x4c6387,this[_0xf9cbaa(0x279)]=_0x2883b1,this[_0xf9cbaa(0x236)]=_0xef4c72,this['userBalanceService']=_0x9a479e,this[_0xf9cbaa(0x1e1)]=_0x353621,this[_0xf9cbaa(0x286)]=_0x10c75d,this[_0xf9cbaa(0x1d9)]=_0xa0f81e,this[_0xf9cbaa(0x1f6)]=_0x52e157,this[_0xf9cbaa(0x1c0)]=_0x156471,this['globalConfigService']=_0x2e3872,this[_0xf9cbaa(0x1f9)]=_0x25e135,this[_0xf9cbaa(0x21e)]=_0x3c7858,this[_0xf9cbaa(0x1ef)]=_0x217475,this[_0xf9cbaa(0x276)]=null,this['whiteListUser']=[],this['keyPool']={'list3':[],'list4':[]};}async['onModuleInit'](){const _0x53141d=_0x4b4875;let _0x4ba074=await(0x0,utils_1[_0x53141d(0x1ed)])(_0x53141d(0x1d0)),_0x3515fc=await(0x0,utils_1[_0x53141d(0x1ed)])(_0x53141d(0x1ca)),_0x454d9f=await(0x0,utils_1['importDynamic'])(_0x53141d(0x1bd));_0x4ba074=(_0x4ba074===null||_0x4ba074===void 0x0?void 0x0:_0x4ba074[_0x53141d(0x1a1)])?_0x4ba074['default']:_0x4ba074,_0x3515fc=(_0x3515fc===null||_0x3515fc===void 0x0?void 0x0:_0x3515fc[_0x53141d(0x1a1)])?_0x3515fc['default']:_0x3515fc,_0x454d9f=(_0x454d9f===null||_0x454d9f===void 0x0?void 0x0:_0x454d9f[_0x53141d(0x1a1)])?_0x454d9f[_0x53141d(0x1a1)]:_0x454d9f;const {ChatGPTAPI:_0x34301d,ChatGPTError:_0x588228,ChatGPTUnofficialProxyAPI:_0x5913bb}=_0x4ba074,_0x2e2f12=+process[_0x53141d(0x19d)]['REDIS_PORT'],_0x3799b3=process[_0x53141d(0x19d)][_0x53141d(0x1b8)],_0x5a3367=process[_0x53141d(0x19d)]['REDIS_PASSWORD'],_0x3bbcc2=process[_0x53141d(0x19d)]['REDIS_USER'],_0x33d3a9=_0x53141d(0x1b4)+(_0x3bbcc2||'')+':'+(_0x5a3367||'')+'@'+_0x3799b3+':'+_0x2e2f12,_0x5b52b1=new _0x3515fc(_0x33d3a9),_0x580d17=new _0x454d9f({'store':_0x5b52b1,'namespace':'nineai-chatlog'});this[_0x53141d(0x276)]=new store_1[(_0x53141d(0x1bf))]({'store':_0x580d17,'namespace':_0x53141d(0x218)});}async['getRequestParams'](_0x481e30,_0x38f8af,_0x2239ad,_0x40065f=null){const _0x1ff541=_0x4b4875;var _0x3ad5fc;!_0x40065f&&(_0x40065f=(_0x3ad5fc=await this[_0x1ff541(0x1ef)][_0x1ff541(0x207)]())===null||_0x3ad5fc===void 0x0?void 0x0:_0x3ad5fc[_0x1ff541(0x27c)]);const {timeout:timeout=0x3c}=_0x2239ad,{topN:_0x2c7cec,model:_0x1bfe18}=_0x40065f,{parentMessageId:parentMessageId=0x0}=_0x481e30,_0xefd809=await this[_0x1ff541(0x1f1)]['getConfigs'](['openaiTimeoutMs']),_0x1f236a=timeout*0x3e8||_0xefd809||0x64*0x3e8,_0x1fc1d4={'parentMessageId':parentMessageId,'timeoutMs':+_0x1f236a,'completionParams':{'model':_0x1bfe18,'temperature':_0x2c7cec}};return _0x38f8af&&(_0x1fc1d4[_0x1ff541(0x23a)]=_0x38f8af),_0x1fc1d4;}async['chatSyncFree'](_0x326508){const _0x4289e1=_0x4b4875,_0x32db86=await this[_0x4289e1(0x1ef)]['getRandomDrawKey'](),_0x21f693=await this[_0x4289e1(0x1f1)][_0x4289e1(0x203)]([_0x4289e1(0x1da)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x4121c0,model:_0x1b6a6e}=_0x32db86,_0x3fb9a2=await this[_0x4289e1(0x1d1)](_0x32db86),{context:_0x2f3178}=await this['nineStore'][_0x4289e1(0x1c5)](_0x326508,{'parentMessageId':'','systemMessage':_0x21f693});try{const _0x3bd755=await(0x0,openai_1[_0x4289e1(0x1af)])(_0x2f3178,{'apiKey':(0x0,utils_1[_0x4289e1(0x205)])(_0x4121c0),'model':_0x1b6a6e,'proxyUrl':_0x3fb9a2,'onProgress':null});return _0x3bd755===null||_0x3bd755===void 0x0?void 0x0:_0x3bd755['text'];}catch(_0x23b8a2){console[_0x4289e1(0x1a8)](_0x4289e1(0x1d8),_0x23b8a2);}}async[_0x4b4875(0x1a4)](_0x2dcf00,_0x2aeff3,_0x56276b){const _0x122450=_0x4b4875;var _0x1b1d7b,_0x45412d,_0xb5673b,_0x496b70;const _0x206187=_0x2aeff3['abortController'],{options:options={},appId:_0x31ab27,cusromPrompt:_0x58a862,systemMessage:systemMessage=''}=_0x2dcf00;let _0x51dbd8=systemMessage;const {parentMessageId:_0x220245}=options,{prompt:_0x403aa7,imageUrl:_0x521c61,model:_0x32e7d5}=_0x2dcf00,{groupId:_0x2d9ac9,usingNetwork:_0x31b786}=options,_0x4a921f=await this['chatGroupService']['getGroupInfoFromId'](_0x2d9ac9),_0x396dfb=(_0x4a921f===null||_0x4a921f===void 0x0?void 0x0:_0x4a921f[_0x122450(0x1df)])?JSON[_0x122450(0x239)](_0x4a921f[_0x122450(0x1df)]):await this[_0x122450(0x1ef)][_0x122450(0x207)](),{keyType:_0x1e01d5,model:_0x43d574,topN:_0x1a8ea4,systemMessage:_0x3696ff,rounds:_0x214c78}=_0x396dfb[_0x122450(0x27c)];let _0x103bbd=null;!_0x58a862?_0x103bbd=await this[_0x122450(0x1ef)][_0x122450(0x25c)](_0x43d574):_0x103bbd=await this[_0x122450(0x1ef)][_0x122450(0x1fb)]();if(!_0x103bbd)throw new common_1[(_0x122450(0x19a))]('当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！',common_1[_0x122450(0x1f4)]['BAD_REQUEST']);const {deduct:_0x1df905,isTokenBased:_0xee102,tokenFeeRatio:_0x2024d1,deductType:_0x148e03,key:_0x3acef5,secret:_0x40eeed,modelName:_0x3669e5,id:_0x4dd179,accessToken:_0x46e1f5}=_0x103bbd;await this['userService'][_0x122450(0x210)](_0x2aeff3[_0x122450(0x200)]),await this[_0x122450(0x1ea)][_0x122450(0x1eb)](_0x2aeff3,_0x148e03===0x1?'model3':_0x122450(0x1a7),_0x1df905),_0x56276b&&_0x56276b['setHeader'](_0x122450(0x22d),_0x122450(0x246)),await this[_0x122450(0x1f6)][_0x122450(0x1ce)](_0x403aa7,_0x2aeff3[_0x122450(0x200)]['id']);const _0x352916=await this[_0x122450(0x1c0)]['checkAutoReply'](_0x403aa7);if(_0x352916&&_0x56276b){const _0x2c3a42={'message':_0x352916,'code':0x1f4};return _0x56276b['write'](JSON[_0x122450(0x1f7)](_0x2c3a42)),_0x56276b[_0x122450(0x24b)]();}if(_0x31ab27){const _0x1d5275=await this[_0x122450(0x22c)][_0x122450(0x1c6)]({'where':{'id':_0x31ab27,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x1d5275)throw new common_1[(_0x122450(0x19a))](_0x122450(0x24d),common_1[_0x122450(0x1f4)][_0x122450(0x204)]);_0x1d5275[_0x122450(0x1e8)]&&(_0x51dbd8=_0x1d5275[_0x122450(0x1e8)]);}else{if(_0x58a862)_0x51dbd8=systemMessage;else{if(_0x3696ff)_0x51dbd8=_0x3696ff;else{const _0x377b22=new Date()[_0x122450(0x252)]()[_0x122450(0x1c2)]('T')[0x0],_0x399f15=await this[_0x122450(0x1f1)]['getConfigs'](['systemPreMessage']);_0x51dbd8=_0x399f15+(_0x122450(0x1d4)+_0x377b22);}}}let _0x295e30='';if(_0x31b786){_0x295e30=await(0x0,utils_1[_0x122450(0x1d2)])(_0x403aa7);const _0xa4ffa3=new Date()[_0x122450(0x252)]()[_0x122450(0x1c2)]('T')[0x0],_0x5731bc=await this[_0x122450(0x1f1)][_0x122450(0x203)]([_0x122450(0x1da)]);_0x51dbd8=_0x5731bc+(_0x122450(0x1d4)+_0xa4ffa3);}const _0x41cdc3=await this[_0x122450(0x211)](options,_0x51dbd8,_0x103bbd,_0x396dfb[_0x122450(0x27c)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x49f5d6}=_0x103bbd;_0x56276b&&_0x56276b[_0x122450(0x21c)](0xc8);let _0x52a00e=null,_0x4bee39=null;try{if(_0x56276b){let _0x1a64e2=null,_0x194844=![];_0x56276b['on'](_0x122450(0x283),async()=>{const _0x4f5e69=_0x122450;if(_0x194844)return;_0x206187['abort']();const _0x31dfca=await(0x0,openai_1[_0x4f5e69(0x257)])(_0x403aa7)||0x0,_0x1586a7=await(0x0,openai_1['getTokenCount'])(_0x1a64e2===null||_0x1a64e2===void 0x0?void 0x0:_0x1a64e2[_0x4f5e69(0x214)])||0x0,_0x2a1feb=_0x31dfca+_0x1586a7,_0x5a89ef=(0x0,utils_1[_0x4f5e69(0x247)])(_0x2aeff3);await this['chatLogService'][_0x4f5e69(0x19b)]({'appId':_0x31ab27,'curIp':_0x5a89ef,'userId':_0x2aeff3[_0x4f5e69(0x200)]['id'],'type':balance_constant_1[_0x4f5e69(0x25e)][_0x4f5e69(0x258)],'prompt':_0x403aa7,'imageUrl':_0x521c61,'activeModel':_0x32e7d5,'answer':'','promptTokens':_0x31dfca,'completionTokens':0x0,'totalTokens':_0x31dfca,'model':_0x43d574,'role':_0x4f5e69(0x200),'groupId':_0x2d9ac9,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x403aa7})}),await this[_0x4f5e69(0x1e1)][_0x4f5e69(0x19b)]({'appId':_0x31ab27,'curIp':_0x5a89ef,'userId':_0x2aeff3[_0x4f5e69(0x200)]['id'],'type':balance_constant_1[_0x4f5e69(0x25e)]['CHAT_TYPE'],'prompt':_0x403aa7,'answer':_0x1a64e2===null||_0x1a64e2===void 0x0?void 0x0:_0x1a64e2['text'],'promptTokens':_0x31dfca,'completionTokens':_0x1586a7,'totalTokens':_0x2a1feb,'model':_0x43d574,'role':_0x4f5e69(0x24a),'groupId':_0x2d9ac9,'requestOptions':JSON[_0x4f5e69(0x1f7)]({'options':{'model':_0x43d574,'temperature':_0x1a8ea4},'prompt':_0x403aa7}),'conversationOptions':JSON[_0x4f5e69(0x1f7)]({'conversationId':_0x1a64e2===null||_0x1a64e2===void 0x0?void 0x0:_0x1a64e2[_0x4f5e69(0x1ee)],'model':_0x43d574,'parentMessageId':_0x1a64e2===null||_0x1a64e2===void 0x0?void 0x0:_0x1a64e2['id'],'temperature':_0x1a8ea4})});let _0x5daf8f=_0x1df905;_0xee102===!![]&&(_0x5daf8f=Math[_0x4f5e69(0x1c3)](_0x1df905*_0x2a1feb/_0x2024d1)),await this[_0x4f5e69(0x1ea)]['deductFromBalance'](_0x2aeff3['user']['id'],_0x4f5e69(0x19c)+(_0x148e03===0x1?0x3:0x4),_0x5daf8f,_0x2a1feb);});if(Number(_0x1e01d5)===0x1){const {key:_0x4f33be,maxToken:_0x3e28db,maxTokenRes:_0x543698,proxyResUrl:_0x50a155}=await this[_0x122450(0x198)](_0x103bbd),{parentMessageId:_0x4356a1,completionParams:_0x4e579e,systemMessage:_0xf7e21}=_0x41cdc3,{model:_0x54f6d7,temperature:_0x181110}=_0x4e579e,{context:_0xab0c88}=await this[_0x122450(0x276)][_0x122450(0x1c5)](_0x31b786?_0x295e30:_0x403aa7,{'parentMessageId':_0x4356a1,'systemMessage':_0xf7e21,'maxModelToken':_0x3e28db,'maxResponseTokens':_0x543698,'maxRounds':(0x0,helper_1[_0x122450(0x285)])(_0x214c78),'imageUrl':_0x521c61,'activeModel':_0x32e7d5});let _0x3c0125=!![];_0x52a00e=await(0x0,openai_1[_0x122450(0x1af)])(_0xab0c88,{'maxToken':_0x3e28db,'maxTokenRes':_0x543698,'apiKey':_0x3acef5,'model':_0x54f6d7,'prompt':_0x403aa7,'activeModel':_0x32e7d5,'imageUrl':_0x521c61,'temperature':_0x181110,'proxyUrl':_0x50a155,'onProgress':_0x2866c8=>{const _0x22895b=_0x122450;_0x56276b[_0x22895b(0x27d)](_0x3c0125?JSON[_0x22895b(0x1f7)](_0x2866c8):'\x0a'+JSON[_0x22895b(0x1f7)](_0x2866c8)),_0x1a64e2=_0x2866c8,_0x3c0125=![];}},this[_0x122450(0x1d9)]),_0x194844=!![];}if(Number(_0x1e01d5)===0x2){let _0x35baf1=!![];const {context:_0x4a60ad}=await this[_0x122450(0x276)][_0x122450(0x1c5)](_0x31b786?_0x295e30:_0x403aa7,{'parentMessageId':_0x220245,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x214c78)});_0x52a00e=await(0x0,baidu_1['sendMessageFromBaidu'])(_0x31b786?_0x295e30:_0x4a60ad,{'temperature':_0x1a8ea4,'accessToken':_0x46e1f5,'model':_0x43d574,'onProgress':_0x3613b5=>{const _0x15d429=_0x122450;_0x56276b[_0x15d429(0x27d)](_0x35baf1?JSON[_0x15d429(0x1f7)](_0x3613b5):'\x0a'+JSON[_0x15d429(0x1f7)](_0x3613b5)),_0x35baf1=![],_0x1a64e2=_0x3613b5;}}),_0x194844=!![];}if(Number(_0x1e01d5)===0x3){let _0x8825c2=!![];const {context:_0x56fa53}=await this['nineStore'][_0x122450(0x1c5)](_0x31b786?_0x295e30:_0x403aa7,{'parentMessageId':_0x220245,'maxRounds':(0x0,helper_1[_0x122450(0x285)])(_0x214c78)});_0x52a00e=await(0x0,zhipu_1[_0x122450(0x1c9)])(_0x31b786?_0x295e30:_0x56fa53,{'temperature':_0x1a8ea4,'key':_0x49f5d6,'model':_0x43d574,'onProgress':_0x1d6a13=>{const _0x281084=_0x122450;_0x56276b[_0x281084(0x27d)](_0x8825c2?JSON[_0x281084(0x1f7)](_0x1d6a13):'\x0a'+JSON[_0x281084(0x1f7)](_0x1d6a13)),_0x8825c2=![],_0x1a64e2=_0x1d6a13;}}),_0x194844=!![];}const _0x45d0cb={'id':this[_0x122450(0x276)]['getUuid'](),'text':_0x403aa7,'role':_0x122450(0x200),'name':undefined,'usage':null,'imageUrl':_0x521c61,'activeModel':_0x32e7d5,'parentMessageId':_0x220245,'conversationId':_0x52a00e===null||_0x52a00e===void 0x0?void 0x0:_0x52a00e[_0x122450(0x1ee)]};_0x4bee39={'model':_0x43d574,'parentMessageId':_0x220245},await this[_0x122450(0x276)][_0x122450(0x24e)](_0x45d0cb);const _0x4d3914={'id':_0x52a00e['id'],'text':_0x52a00e[_0x122450(0x214)],'role':_0x122450(0x24a),'name':undefined,'usage':_0x52a00e===null||_0x52a00e===void 0x0?void 0x0:_0x52a00e[_0x122450(0x1b0)],'imageUrl':_0x521c61,'parentMessageId':_0x45d0cb['id'],'conversationId':_0x52a00e===null||_0x52a00e===void 0x0?void 0x0:_0x52a00e['conversationId']};await this[_0x122450(0x276)][_0x122450(0x24e)](_0x4d3914),_0x4bee39={'model':_0x43d574,'parentMessageId':_0x45d0cb['id']};}else{const {key:_0x336447,maxToken:_0x153410,maxTokenRes:_0x427abd,proxyResUrl:_0x294758}=await this['formatModelToken'](_0x103bbd),{parentMessageId:_0x5e1421,completionParams:_0x508684,systemMessage:_0x46526d}=_0x41cdc3,{model:_0x46f95e,temperature:_0x24b9a9}=_0x508684,{context:_0x4ee86f}=await this['nineStore'][_0x122450(0x1c5)](_0x31b786?_0x295e30:_0x403aa7,{'parentMessageId':_0x5e1421,'systemMessage':_0x46526d,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x214c78)});_0x52a00e=await(0x0,openai_1[_0x122450(0x1af)])(_0x4ee86f,{'apiKey':_0x3acef5,'model':_0x46f95e,'temperature':_0x24b9a9,'proxyUrl':_0x294758,'onProgress':null,'prompt':_0x403aa7});}let _0x10f8a7=null,_0x2c53cb=null;_0x43d574[_0x122450(0x19f)](_0x122450(0x209))?_0x10f8a7=((_0x1b1d7b=_0x52a00e[_0x122450(0x195)])===null||_0x1b1d7b===void 0x0?void 0x0:_0x1b1d7b[_0x122450(0x1b0)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x2c53cb=await(0x0,helper_1[_0x122450(0x1e5)])(_0x1e01d5,_0x52a00e,_0x4bee39);const {prompt_tokens:_0x1d9cf1,completion_tokens:_0x5b9a91,total_tokens:_0x47dd65}=_0x43d574['includes'](_0x122450(0x209))?_0x10f8a7:_0x2c53cb[_0x122450(0x1b0)];let _0x4ff500=_0x1df905;_0xee102===!![]&&(_0x4ff500=Math[_0x122450(0x1c3)](_0x1df905*_0x47dd65/_0x2024d1));await this['userBalanceService'][_0x122450(0x248)](_0x2aeff3['user']['id'],'model'+(_0x148e03===0x1?0x3:0x4),_0x4ff500,_0x47dd65),await this['modelsService'][_0x122450(0x273)](_0x4dd179,_0x47dd65);const _0x150602=(0x0,utils_1['getClientIp'])(_0x2aeff3);await this[_0x122450(0x1e1)]['saveChatLog']({'appId':_0x31ab27,'curIp':_0x150602,'userId':_0x2aeff3[_0x122450(0x200)]['id'],'type':balance_constant_1[_0x122450(0x25e)][_0x122450(0x258)],'prompt':_0x403aa7,'imageUrl':_0x521c61,'activeModel':_0x32e7d5,'answer':'','promptTokens':_0x1d9cf1,'completionTokens':0x0,'totalTokens':_0x47dd65,'model':_0x43d574,'role':'user','groupId':_0x2d9ac9,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x403aa7})}),await this['chatLogService'][_0x122450(0x19b)]({'appId':_0x31ab27,'curIp':_0x150602,'userId':_0x2aeff3[_0x122450(0x200)]['id'],'type':balance_constant_1[_0x122450(0x25e)][_0x122450(0x258)],'prompt':_0x403aa7,'imageUrl':_0x52a00e===null||_0x52a00e===void 0x0?void 0x0:_0x52a00e[_0x122450(0x284)],'answer':_0x52a00e[_0x122450(0x214)],'promptTokens':_0x1d9cf1,'completionTokens':_0x5b9a91,'totalTokens':_0x47dd65,'model':_0x43d574,'role':_0x122450(0x24a),'groupId':_0x2d9ac9,'requestOptions':JSON[_0x122450(0x1f7)]({'options':{'model':_0x43d574,'temperature':_0x1a8ea4},'prompt':_0x403aa7}),'conversationOptions':JSON[_0x122450(0x1f7)]({'conversationId':_0x52a00e['conversationId'],'model':_0x43d574,'parentMessageId':_0x52a00e['id'],'temperature':_0x1a8ea4})}),common_1[_0x122450(0x1b2)][_0x122450(0x216)](_0x122450(0x1f0)+_0x2aeff3[_0x122450(0x200)]['id']+'\x20模型名称:\x20'+_0x3669e5+'-'+_0x32e7d5+',\x20消耗token:\x20'+_0x47dd65+_0x122450(0x199)+_0x4ff500,'ChatgptService');const _0x2d166b=await this[_0x122450(0x1ea)][_0x122450(0x224)](_0x2aeff3[_0x122450(0x200)]['id']);return _0x52a00e[_0x122450(0x230)]=Object[_0x122450(0x229)]({},_0x2d166b),_0x52a00e[_0x122450(0x1f3)]&&(_0x52a00e[_0x122450(0x1f3)]=''),_0x52a00e[_0x122450(0x259)]=!![],_0x56276b?_0x56276b['write']('\x0a'+JSON['stringify'](_0x52a00e)):_0x52a00e['text'];}catch(_0x47fb4c){console['log'](_0x122450(0x23c),_0x3acef5,_0x47fb4c);const _0x33b550=(_0x47fb4c===null||_0x47fb4c===void 0x0?void 0x0:_0x47fb4c[_0x122450(0x26b)])||0x190,_0x1584a0=((_0x45412d=_0x47fb4c===null||_0x47fb4c===void 0x0?void 0x0:_0x47fb4c[_0x122450(0x288)])===null||_0x45412d===void 0x0?void 0x0:_0x45412d[_0x122450(0x21c)])||(_0x47fb4c===null||_0x47fb4c===void 0x0?void 0x0:_0x47fb4c[_0x122450(0x26b)])||0x190;console[_0x122450(0x1a8)](_0x122450(0x278),_0x122450(0x1ba),_0x33b550,_0x122450(0x237),_0x47fb4c===null||_0x47fb4c===void 0x0?void 0x0:_0x47fb4c[_0x122450(0x237)],'statusText:',(_0xb5673b=_0x47fb4c===null||_0x47fb4c===void 0x0?void 0x0:_0x47fb4c[_0x122450(0x288)])===null||_0xb5673b===void 0x0?void 0x0:_0xb5673b['statusText'],_0x122450(0x21c),(_0x496b70=_0x47fb4c===null||_0x47fb4c===void 0x0?void 0x0:_0x47fb4c['response'])===null||_0x496b70===void 0x0?void 0x0:_0x496b70[_0x122450(0x21c)]);if(_0x47fb4c['status']&&_0x47fb4c[_0x122450(0x21c)]===0x192){const _0x3ad4cf={'message':'Catch\x20Error\x20'+_0x47fb4c['message'],'code':0x192};if(_0x56276b)return _0x56276b[_0x122450(0x27d)](JSON[_0x122450(0x1f7)](_0x3ad4cf));else throw new common_1[(_0x122450(0x19a))](_0x47fb4c[_0x122450(0x237)],common_1[_0x122450(0x1f4)]['PAYMENT_REQUIRED']);}if(!_0x1584a0){if(_0x56276b)return _0x56276b[_0x122450(0x27d)](JSON[_0x122450(0x1f7)]({'message':_0x47fb4c['message'],'code':0x1f4}));else throw new common_1['HttpException'](_0x47fb4c[_0x122450(0x237)],common_1[_0x122450(0x1f4)][_0x122450(0x204)]);}let _0x4eed0f=errorMessage_constant_1[_0x122450(0x1cc)][_0x1584a0]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x1584a0]:'服务异常、请重新试试吧！！！';(_0x47fb4c===null||_0x47fb4c===void 0x0?void 0x0:_0x47fb4c['message'][_0x122450(0x19f)](_0x122450(0x1e2)))&&Number(_0x1e01d5)===0x1&&(await this['modelsService']['lockKey'](_0x4dd179,_0x122450(0x249),-0x1),_0x4eed0f=_0x122450(0x1be));(_0x47fb4c===null||_0x47fb4c===void 0x0?void 0x0:_0x47fb4c['statusCode'])===0x1ad&&_0x47fb4c[_0x122450(0x237)][_0x122450(0x19f)]('billing')&&Number(_0x1e01d5)===0x1&&(await this['modelsService']['lockKey'](_0x4dd179,_0x122450(0x19e),-0x3),_0x4eed0f=_0x122450(0x1c7));(_0x47fb4c===null||_0x47fb4c===void 0x0?void 0x0:_0x47fb4c[_0x122450(0x26b)])===0x1ad&&(_0x47fb4c===null||_0x47fb4c===void 0x0?void 0x0:_0x47fb4c[_0x122450(0x25f)])===_0x122450(0x238)&&(_0x4eed0f=_0x122450(0x1b7));(_0x47fb4c===null||_0x47fb4c===void 0x0?void 0x0:_0x47fb4c[_0x122450(0x26b)])===0x191&&_0x47fb4c['message'][_0x122450(0x19f)]('Incorrect\x20API\x20key\x20provided')&&Number(_0x1e01d5)===0x1&&(await this[_0x122450(0x1ef)]['lockKey'](_0x4dd179,'提供了错误的模型秘钥',-0x2),_0x4eed0f=_0x122450(0x1a3));(_0x47fb4c===null||_0x47fb4c===void 0x0?void 0x0:_0x47fb4c['statusCode'])===0x194&&_0x47fb4c[_0x122450(0x237)]['includes']('This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported')&&Number(_0x1e01d5)===0x1&&(await this[_0x122450(0x1ef)][_0x122450(0x27e)](_0x4dd179,_0x122450(0x1fe),-0x4),_0x4eed0f='当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！');_0x33b550===0x190&&console[_0x122450(0x1a8)](_0x122450(0x1e3),_0x47fb4c,_0x47fb4c[_0x122450(0x237)]);const _0x1c421a={'message':_0x4eed0f||'Please\x20check\x20the\x20back-end\x20console','code':_0x33b550===0x191?0x190:_0x33b550||0x1f4};if(_0x56276b)return _0x56276b[_0x122450(0x27d)](JSON[_0x122450(0x1f7)](_0x1c421a));else throw new common_1[(_0x122450(0x19a))](_0x1c421a['message'],common_1[_0x122450(0x1f4)][_0x122450(0x204)]);}finally{_0x56276b&&_0x56276b[_0x122450(0x24b)]();}}async[_0x4b4875(0x26e)](_0x5a164d,_0x3fc5f8){const _0x5f89e2=_0x4b4875;var _0x16d915,_0x1f78fa,_0x454315,_0x26ed43;await this['badwordsService'][_0x5f89e2(0x1ce)](_0x5a164d[_0x5f89e2(0x265)],_0x3fc5f8[_0x5f89e2(0x200)]['id']),await this['userService']['checkUserStatus'](_0x3fc5f8[_0x5f89e2(0x200)]);const _0x1e800c=(_0x5a164d===null||_0x5a164d===void 0x0?void 0x0:_0x5a164d[_0x5f89e2(0x1de)])==='hd'?0x4:0x2;await this[_0x5f89e2(0x1ea)][_0x5f89e2(0x1eb)](_0x3fc5f8,'mjDraw',_0x1e800c);let _0x5e3875=[];const _0x815fc7=await this[_0x5f89e2(0x1ef)][_0x5f89e2(0x25c)](_0x5f89e2(0x1dc)),_0x4c8732=_0x815fc7===null||_0x815fc7===void 0x0?void 0x0:_0x815fc7['id'],{key:_0x554125,proxyResUrl:_0x371bdd}=await this[_0x5f89e2(0x198)](_0x815fc7);common_1[_0x5f89e2(0x1b2)][_0x5f89e2(0x1a8)](_0x5f89e2(0x269)+_0x5a164d[_0x5f89e2(0x265)]+_0x5f89e2(0x1e9)+_0x554125,'DrawService');try{const _0x37b5a3=_0x371bdd+_0x5f89e2(0x272),_0x5147db=Object['assign'](Object[_0x5f89e2(0x229)]({},_0x5a164d),{'model':_0x5f89e2(0x1dc)});console[_0x5f89e2(0x1a8)]('dall-e\x20draw\x20params:\x20',_0x5147db);const _0x48c74b=await axios_1[_0x5f89e2(0x1a1)][_0x5f89e2(0x20b)](_0x37b5a3,Object[_0x5f89e2(0x229)](Object[_0x5f89e2(0x229)]({},_0x5147db),{'response_format':_0x5f89e2(0x253)}),{'headers':{'Authorization':_0x5f89e2(0x20c)+_0x554125}});_0x5e3875=_0x48c74b['data']['data'];const _0x3754d6=[];for(const _0x484e07 of _0x5e3875){const _0x1be2ba=uuid['v4']()[_0x5f89e2(0x1c4)](0x0,0xa)+_0x5f89e2(0x197),_0x3f156c=Buffer[_0x5f89e2(0x25d)](_0x484e07['b64_json'],_0x5f89e2(0x262));_0x3754d6[_0x5f89e2(0x251)](this[_0x5f89e2(0x1d9)][_0x5f89e2(0x223)]({'filename':_0x1be2ba,'buffer':_0x3f156c}));}const _0x6493e8=await Promise['all'](_0x3754d6);await this[_0x5f89e2(0x1ea)][_0x5f89e2(0x248)](_0x3fc5f8[_0x5f89e2(0x200)]['id'],_0x5f89e2(0x225),(_0x5147db===null||_0x5147db===void 0x0?void 0x0:_0x5147db[_0x5f89e2(0x1de)])===_0x5f89e2(0x231)?0x2:0x4,_0x1e800c);const _0x45121d=(0x0,utils_1[_0x5f89e2(0x247)])(_0x3fc5f8),_0x2452a8=[],_0x2ba45e=await this[_0x5f89e2(0x1d9)][_0x5f89e2(0x228)](),[_0x50010d,_0x19ccb8]=_0x5a164d[_0x5f89e2(0x1f8)][_0x5f89e2(0x1c2)]('x');return _0x6493e8['forEach'](_0x51c1cf=>{const _0x5f0aa6=_0x5f89e2;_0x2452a8['push'](this[_0x5f0aa6(0x1e1)][_0x5f0aa6(0x19b)]({'curIp':_0x45121d,'userId':_0x3fc5f8[_0x5f0aa6(0x200)]['id'],'type':balance_constant_1[_0x5f0aa6(0x25e)][_0x5f0aa6(0x1e7)],'prompt':_0x5a164d[_0x5f0aa6(0x265)],'answer':_0x51c1cf,'fileInfo':JSON[_0x5f0aa6(0x1f7)]({'cosType':_0x2ba45e,'width':_0x50010d,'height':_0x19ccb8,'cosUrl':_0x51c1cf}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x5f0aa6(0x1dc)}));}),await Promise[_0x5f89e2(0x21f)](_0x2452a8),_0x6493e8;}catch(_0x1f0eea){const _0xd9d2c4=((_0x16d915=_0x1f0eea===null||_0x1f0eea===void 0x0?void 0x0:_0x1f0eea[_0x5f89e2(0x288)])===null||_0x16d915===void 0x0?void 0x0:_0x16d915[_0x5f89e2(0x21c)])||0x1f4;console['log']('openai-draw\x20error:\x20',JSON[_0x5f89e2(0x1f7)](_0x1f0eea),_0x554125,_0xd9d2c4);const _0x4fbb07=(_0x26ed43=(_0x454315=(_0x1f78fa=_0x1f0eea===null||_0x1f0eea===void 0x0?void 0x0:_0x1f0eea['response'])===null||_0x1f78fa===void 0x0?void 0x0:_0x1f78fa[_0x5f89e2(0x1d6)])===null||_0x454315===void 0x0?void 0x0:_0x454315['error'])===null||_0x26ed43===void 0x0?void 0x0:_0x26ed43[_0x5f89e2(0x237)];if(_0xd9d2c4===0x1ad)throw new common_1[(_0x5f89e2(0x19a))](_0x5f89e2(0x1a5),common_1['HttpStatus'][_0x5f89e2(0x204)]);if(_0xd9d2c4===0x190&&_0x4fbb07[_0x5f89e2(0x19f)]('This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters'))throw new common_1[(_0x5f89e2(0x19a))](_0x5f89e2(0x1e6),common_1[_0x5f89e2(0x1f4)][_0x5f89e2(0x204)]);if(_0xd9d2c4===0x190&&_0x4fbb07[_0x5f89e2(0x19f)]('Billing\x20hard\x20limit\x20has\x20been\x20reached')){await this[_0x5f89e2(0x1ef)][_0x5f89e2(0x27e)](_0x4c8732,_0x5f89e2(0x249),-0x1);throw new common_1['HttpException'](_0x5f89e2(0x264),common_1[_0x5f89e2(0x1f4)][_0x5f89e2(0x204)]);}if(_0xd9d2c4===0x1f4)throw new common_1[(_0x5f89e2(0x19a))](_0x5f89e2(0x232),common_1[_0x5f89e2(0x1f4)]['BAD_REQUEST']);if(_0xd9d2c4===0x191)throw new common_1['HttpException']('绘制图片失败，此次绘画被拒绝了！',common_1[_0x5f89e2(0x1f4)][_0x5f89e2(0x204)]);throw new common_1[(_0x5f89e2(0x19a))](_0x5f89e2(0x23e),common_1['HttpStatus'][_0x5f89e2(0x204)]);}}async[_0x4b4875(0x22b)](){const _0x3b7b2e=_0x4b4875,_0x54058c=await this[_0x3b7b2e(0x233)]['find']({'where':{'status':0x1},'select':['id',_0x3b7b2e(0x1b3),_0x3b7b2e(0x1db),'model',_0x3b7b2e(0x21d),_0x3b7b2e(0x21a),'openaiProxyUrl',_0x3b7b2e(0x1d3)]}),_0x8454d6=_0x54058c['filter'](_0x514875=>_0x514875[_0x3b7b2e(0x19c)]['includes'](_0x3b7b2e(0x1e0))),_0x4a4e10=_0x54058c[_0x3b7b2e(0x213)](_0xf596fa=>_0xf596fa[_0x3b7b2e(0x19c)][_0x3b7b2e(0x19f)]('gpt-4'));this[_0x3b7b2e(0x1cf)]={'list3':_0x8454d6,'list4':_0x4a4e10};}async['getModelProxyUrl'](_0xac8a77){const _0x15d6e8=_0x4b4875,_0x5a303f=await this[_0x15d6e8(0x1f1)][_0x15d6e8(0x203)]([_0x15d6e8(0x1cb)]);return(_0xac8a77===null||_0xac8a77===void 0x0?void 0x0:_0xac8a77[_0x15d6e8(0x220)])||_0x5a303f||_0x15d6e8(0x208);}async[_0x4b4875(0x198)](_0x559c82){const _0x5e68cf=_0x4b4875,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this['globalConfigService'][_0x5e68cf(0x203)]([_0x5e68cf(0x20a),'openaiModel3MaxTokensRes','openaiModel3MaxTokens16k',_0x5e68cf(0x1dd),_0x5e68cf(0x219),_0x5e68cf(0x202),'openaiModel4MaxTokens32k','openaiModel4MaxTokens32kRes','openaiBaseUrl']);let _0x3b6369=null,_0x2381fe=null,_0x216cfd=null,{model:_0x34231a,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x339e03}=_0x559c82;return _0x34231a[_0x5e68cf(0x275)]()[_0x5e68cf(0x19f)]('gpt-4')&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x2381fe>=0x1000&&(maxModelTokens=0x1000),_0x3b6369=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x2381fe=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x34231a[_0x5e68cf(0x275)]()[_0x5e68cf(0x19f)](_0x5e68cf(0x1a2))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x2381fe>=0x4000&&(maxModelTokens=0x4000),_0x3b6369=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x2381fe=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x34231a[_0x5e68cf(0x275)]()[_0x5e68cf(0x19f)]('1106')&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x2381fe>=0x1000&&(maxModelTokens=0x1000),_0x3b6369=maxModelTokens||0x3ffc,_0x2381fe=maxResponseTokens||0x1000)),_0x34231a[_0x5e68cf(0x275)]()[_0x5e68cf(0x19f)](_0x5e68cf(0x1e0))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x2381fe>=0x7d0&&(maxModelTokens=0x7d0),_0x3b6369=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x2381fe=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x34231a[_0x5e68cf(0x275)]()['includes'](_0x5e68cf(0x1d7))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x2381fe>=0x2000&&(maxModelTokens=0x2000),_0x3b6369=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x2381fe=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x34231a[_0x5e68cf(0x275)]()['includes']('1106')&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x2381fe>=0x1000&&(maxModelTokens=0x1000),_0x3b6369=maxModelTokens||0x4000,_0x2381fe=maxResponseTokens||0x1000)),_0x216cfd=proxyUrl||openaiBaseUrl||_0x5e68cf(0x208),_0x2381fe>=_0x3b6369&&(_0x2381fe=Math['floor'](_0x3b6369/0x2)),{'key':_0x339e03,'maxToken':_0x3b6369,'maxTokenRes':_0x2381fe,'proxyResUrl':_0x216cfd};}async['setChatBoxType'](_0x4f9248,_0x56eb1e){const _0x5cd734=_0x4b4875;try{const {name:_0x274dd2,icon:_0xfffcff,order:_0x5d2640,id:_0x461ea8,status:_0x2259e4}=_0x56eb1e;return _0x461ea8?await this[_0x5cd734(0x22f)][_0x5cd734(0x254)]({'id':_0x461ea8},{'name':_0x274dd2,'icon':_0xfffcff,'order':_0x5d2640,'status':_0x2259e4}):await this[_0x5cd734(0x22f)][_0x5cd734(0x1ab)]({'name':_0x274dd2,'icon':_0xfffcff,'order':_0x5d2640,'status':_0x2259e4});}catch(_0x31ec30){console[_0x5cd734(0x1a8)]('error:\x20',_0x31ec30);}}async[_0x4b4875(0x1b5)](_0x21889e,_0x3dc6f5){const _0x350530=_0x4b4875,{id:_0x577972}=_0x3dc6f5;if(!_0x577972)throw new common_1[(_0x350530(0x19a))](_0x350530(0x1ec),common_1['HttpStatus'][_0x350530(0x204)]);const _0xb659ee=await this[_0x350530(0x271)]['count']({'where':{'typeId':_0x577972}});if(_0xb659ee)throw new common_1[(_0x350530(0x19a))](_0x350530(0x22e),common_1[_0x350530(0x1f4)][_0x350530(0x204)]);return await this['chatBoxTypeEntity']['delete']({'id':_0x577972});}async[_0x4b4875(0x1aa)](){const _0x1be5bc=_0x4b4875;return await this[_0x1be5bc(0x22f)]['find']({'order':{'order':'DESC'}});}async[_0x4b4875(0x1b1)](_0x2d81c9,_0x5c54ae){const _0x266c9b=_0x4b4875,{title:_0x447a6c,prompt:_0x5a1a89,appId:_0xdc59d2,order:_0x2297d1,status:_0x4b026e,typeId:_0x21fbd6,id:_0x12db7c,url:_0x3ec96d}=_0x5c54ae;if(!_0x21fbd6)throw new common_1[(_0x266c9b(0x19a))]('缺失必要参数！',common_1['HttpStatus'][_0x266c9b(0x204)]);try{const _0x336034={'title':_0x447a6c,'order':_0x2297d1,'status':_0x4b026e,'typeId':_0x21fbd6,'url':_0x3ec96d};return _0x336034[_0x266c9b(0x26a)]=_0xdc59d2||0x0,_0x336034[_0x266c9b(0x265)]=_0x5a1a89||'',_0x12db7c?await this[_0x266c9b(0x271)][_0x266c9b(0x254)]({'id':_0x12db7c},_0x336034):await this[_0x266c9b(0x271)][_0x266c9b(0x1ab)](_0x336034);}catch(_0x45fe2b){console[_0x266c9b(0x1a8)](_0x266c9b(0x1d8),_0x45fe2b);}}async[_0x4b4875(0x280)](_0x48e655,_0x53757f){const _0x4990a0=_0x4b4875,{id:_0x16592f}=_0x53757f;if(!_0x16592f)throw new common_1[(_0x4990a0(0x19a))]('非法操作！',common_1[_0x4990a0(0x1f4)][_0x4990a0(0x204)]);return await this[_0x4990a0(0x271)]['delete']({'id':_0x16592f});}async[_0x4b4875(0x1ae)](){const _0x18b9d4=_0x4b4875,_0x5842ae=await this[_0x18b9d4(0x271)][_0x18b9d4(0x1fc)]({'order':{'order':_0x18b9d4(0x23d)}}),_0x21aa5f=[...new Set(_0x5842ae['map'](_0x4d528e=>_0x4d528e['typeId']))],_0x13e6ad=[...new Set(_0x5842ae[_0x18b9d4(0x266)](_0x2e1a47=>_0x2e1a47[_0x18b9d4(0x26a)]))],_0x5242ce=await this['chatBoxTypeEntity'][_0x18b9d4(0x1fc)]({'where':{'id':(0x0,typeorm_1['In'])(_0x21aa5f)}}),_0x368e95=await this[_0x18b9d4(0x22c)][_0x18b9d4(0x1fc)]({'where':{'id':(0x0,typeorm_1['In'])(_0x13e6ad)}});return _0x5842ae['map'](_0x5a09df=>{const _0x54dca9=_0x18b9d4,{typeId:_0x8544d3,appId:_0x564b6a}=_0x5a09df;return _0x5a09df[_0x54dca9(0x194)]=_0x5242ce[_0x54dca9(0x1fc)](_0xe830ea=>_0xe830ea['id']===_0x8544d3),_0x5a09df['appInfo']=_0x368e95[_0x54dca9(0x1fc)](_0x459415=>_0x459415['id']===_0x564b6a),_0x5a09df;});}async['queryChatBoxFrontend'](){const _0x524f36=_0x4b4875,_0x3b4ba0=await this['chatBoxTypeEntity'][_0x524f36(0x1fc)]({'order':{'order':_0x524f36(0x23d)},'where':{'status':!![]}}),_0x10588c=await this[_0x524f36(0x271)][_0x524f36(0x1fc)]({'where':{'status':!![]}}),_0x153037=[...new Set(_0x10588c[_0x524f36(0x266)](_0x54683c=>_0x54683c['appId']))],_0xc38100=await this['appEntity'][_0x524f36(0x1fc)]({'where':{'id':(0x0,typeorm_1['In'])(_0x153037)}});return _0x10588c[_0x524f36(0x26f)](_0x286cde=>{const _0x277332=_0x524f36,_0x39add4=_0xc38100[_0x277332(0x1fc)](_0x47e15d=>_0x47e15d['id']===_0x286cde[_0x277332(0x26a)]);return _0x286cde['coverImg']=_0x39add4===null||_0x39add4===void 0x0?void 0x0:_0x39add4[_0x277332(0x1fa)],_0x286cde;}),_0x3b4ba0[_0x524f36(0x266)](_0x102183=>{const _0x51837f=_0x524f36;return _0x102183[_0x51837f(0x222)]=_0x10588c[_0x51837f(0x213)](_0x25a5ef=>_0x25a5ef[_0x51837f(0x22a)]===_0x102183['id']&&_0x25a5ef[_0x51837f(0x21c)]),_0x102183;});}async['setChatPreType'](_0x536096,_0x2b87dc){const _0x1e3d32=_0x4b4875;try{const {name:_0x45ab46,icon:_0x142a66,order:_0x365e65,id:_0x458b96,status:_0xc17700}=_0x2b87dc;return _0x458b96?await this[_0x1e3d32(0x1b9)][_0x1e3d32(0x254)]({'id':_0x458b96},{'name':_0x45ab46,'icon':_0x142a66,'order':_0x365e65,'status':_0xc17700}):await this[_0x1e3d32(0x1b9)][_0x1e3d32(0x1ab)]({'name':_0x45ab46,'icon':_0x142a66,'order':_0x365e65,'status':_0xc17700});}catch(_0x2d2f54){console[_0x1e3d32(0x1a8)](_0x1e3d32(0x1d8),_0x2d2f54);}}async[_0x4b4875(0x1d5)](_0x3c2099,_0x415cfc){const _0x3d2f85=_0x4b4875,{id:_0x4db7d3}=_0x415cfc;if(!_0x4db7d3)throw new common_1[(_0x3d2f85(0x19a))](_0x3d2f85(0x1ec),common_1['HttpStatus'][_0x3d2f85(0x204)]);const _0x4b508e=await this[_0x3d2f85(0x271)][_0x3d2f85(0x267)]({'where':{'typeId':_0x4db7d3}});if(_0x4b508e)throw new common_1[(_0x3d2f85(0x19a))](_0x3d2f85(0x22e),common_1[_0x3d2f85(0x1f4)][_0x3d2f85(0x204)]);return await this[_0x3d2f85(0x1b9)][_0x3d2f85(0x226)]({'id':_0x4db7d3});}async[_0x4b4875(0x27f)](){const _0x34d947=_0x4b4875;return await this[_0x34d947(0x1b9)][_0x34d947(0x1fc)]({'order':{'order':'DESC'}});}async[_0x4b4875(0x1bc)](_0x1d16ac,_0x4dd5c8){const _0x4dbb0b=_0x4b4875,{title:_0x8237d2,prompt:_0xc89058,appId:_0x16faa6,order:_0x5f5aa1,status:_0xc9a757,typeId:_0x36c730,id:_0x1be05b,url:_0x4e6bf7}=_0x4dd5c8;if(!_0x36c730)throw new common_1[(_0x4dbb0b(0x19a))](_0x4dbb0b(0x25a),common_1[_0x4dbb0b(0x1f4)]['BAD_REQUEST']);try{const _0x420870={'title':_0x8237d2,'prompt':_0xc89058,'order':_0x5f5aa1,'status':_0xc9a757,'typeId':_0x36c730,'url':_0x4e6bf7};return _0x1be05b?await this[_0x4dbb0b(0x279)][_0x4dbb0b(0x254)]({'id':_0x1be05b},_0x420870):await this[_0x4dbb0b(0x279)][_0x4dbb0b(0x1ab)](_0x420870);}catch(_0x620e5f){console[_0x4dbb0b(0x1a8)](_0x4dbb0b(0x1d8),_0x620e5f);}}async[_0x4b4875(0x193)](_0x16ee43,_0x118916){const _0x27578a=_0x4b4875,{id:_0x460584}=_0x118916;if(!_0x460584)throw new common_1['HttpException'](_0x27578a(0x1ec),common_1[_0x27578a(0x1f4)][_0x27578a(0x204)]);return await this[_0x27578a(0x279)][_0x27578a(0x226)]({'id':_0x460584});}async['queryChatPre'](){const _0x1f91a0=_0x4b4875,_0x1276ce=await this[_0x1f91a0(0x279)][_0x1f91a0(0x1fc)]({'order':{'order':'DESC'}}),_0x5a633f=[...new Set(_0x1276ce['map'](_0x120fa2=>_0x120fa2[_0x1f91a0(0x22a)]))],_0x57d60d=await this[_0x1f91a0(0x1b9)][_0x1f91a0(0x1fc)]({'where':{'id':(0x0,typeorm_1['In'])(_0x5a633f)}});return _0x1276ce['map'](_0x47f6de=>{const _0x380583=_0x1f91a0,{typeId:_0x5783d2,appId:_0x7f61c5}=_0x47f6de;return _0x47f6de[_0x380583(0x194)]=_0x57d60d[_0x380583(0x1fc)](_0x5b9256=>_0x5b9256['id']===_0x5783d2),_0x47f6de;});}async['queryChatPreList'](){const _0x28425d=_0x4b4875,_0x4dc166=await this[_0x28425d(0x1b9)][_0x28425d(0x1fc)]({'order':{'order':'DESC'},'where':{'status':!![]}}),_0x4c2300=await this[_0x28425d(0x279)][_0x28425d(0x1fc)]({'where':{'status':!![]}});return _0x4dc166[_0x28425d(0x266)](_0x2023b4=>{const _0x252078=_0x28425d;return _0x2023b4[_0x252078(0x222)]=_0x4c2300[_0x252078(0x213)](_0x104405=>_0x104405[_0x252078(0x22a)]===_0x2023b4['id']&&_0x104405[_0x252078(0x21c)]),_0x2023b4;});}async[_0x4b4875(0x23b)](_0xa956a5,_0x2decd1,_0xa4afd7){const _0x563061=_0x4b4875;let _0x316157=0x1000,_0x2add60=0x800;return _0xa956a5[_0x563061(0x275)]()[_0x563061(0x19f)]('gpt-4')&&(_0x316157=_0x2decd1>=0x2004?0x2004:_0x2decd1,_0x2add60=_0xa4afd7>=0x1000?0x1000:_0xa4afd7,_0xa956a5['toLowerCase']()[_0x563061(0x19f)](_0x563061(0x1a2))&&(_0x316157=_0x2decd1>=0x8000?0x8000:_0x2decd1,_0x2add60=_0xa4afd7>=0x3e80?0x3e80:_0xa4afd7),(_0xa956a5[_0x563061(0x275)]()['includes'](_0x563061(0x25b))||_0xa956a5[_0x563061(0x275)]()[_0x563061(0x19f)](_0x563061(0x1a6)))&&(_0x316157=_0x2decd1>=0x1f400?0x1f400:_0x2decd1,_0x2add60=_0xa4afd7>=0x1000?0x1000:_0xa4afd7)),_0xa956a5[_0x563061(0x275)]()['includes']('gpt-3')&&(_0x316157=_0x2decd1>=0x1000?0x1000:_0x2decd1,_0x2add60=_0xa4afd7>=0x800?0x800:_0xa4afd7,_0xa956a5[_0x563061(0x275)]()[_0x563061(0x19f)](_0x563061(0x1d7))&&(_0x316157=_0x2decd1>=0x4000?0x4000:_0x2decd1,_0x2add60=_0xa4afd7>=0x1f40?0x1f40:_0xa4afd7),_0xa956a5[_0x563061(0x275)]()['includes'](_0x563061(0x1ff))&&(_0x316157=_0x2decd1>=0x4000?0x4000:_0x2decd1,_0x2add60=_0xa4afd7>=0x1f40?0x1f40:_0xa4afd7)),{'maxToken':_0x316157,'maxRes':_0x2add60};}};ChatgptService=__decorate([(0x0,common_1[_0x4b4875(0x243)])(),__param(0x0,(0x0,typeorm_2[_0x4b4875(0x241)])(gptkeys_entity_1['GptKeysEntity'])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(config_entity_1[_0x4b4875(0x20d)])),__param(0x2,(0x0,typeorm_2['InjectRepository'])(chatBoxType_entity_1['ChatBoxTypeEntity'])),__param(0x3,(0x0,typeorm_2[_0x4b4875(0x241)])(chatBox_entity_1['ChatBoxEntity'])),__param(0x4,(0x0,typeorm_2[_0x4b4875(0x241)])(app_entity_1[_0x4b4875(0x240)])),__param(0x5,(0x0,typeorm_2[_0x4b4875(0x241)])(chatPreType_entity_1[_0x4b4875(0x1cd)])),__param(0x6,(0x0,typeorm_2[_0x4b4875(0x241)])(chatPre_entity_1['ChatPreEntity'])),__metadata(_0x4b4875(0x1e4),[typeorm_1[_0x4b4875(0x245)],typeorm_1[_0x4b4875(0x245)],typeorm_1[_0x4b4875(0x245)],typeorm_1[_0x4b4875(0x245)],typeorm_1[_0x4b4875(0x245)],typeorm_1[_0x4b4875(0x245)],typeorm_1['Repository'],nestjs_config_1[_0x4b4875(0x270)],userBalance_service_1[_0x4b4875(0x206)],chatLog_service_1[_0x4b4875(0x27a)],user_service_1['UserService'],upload_service_1[_0x4b4875(0x27b)],badwords_service_1[_0x4b4875(0x1f5)],autoreply_service_1[_0x4b4875(0x20e)],globalConfig_service_1[_0x4b4875(0x1c8)],fanyi_service_1[_0x4b4875(0x221)],chatGroup_service_1[_0x4b4875(0x1bb)],models_service_1[_0x4b4875(0x261)]])],ChatgptService),exports[_0x4b4875(0x1ac)]=ChatgptService;