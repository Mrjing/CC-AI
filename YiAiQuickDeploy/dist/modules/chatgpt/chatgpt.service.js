'use strict';const _0x179a9e=_0x4bd7;(function(_0x2b320d,_0x1e97ca){const _0x13a13a=_0x4bd7,_0xa2a0f5=_0x2b320d();while(!![]){try{const _0x37a86b=-parseInt(_0x13a13a(0x268))/0x1+parseInt(_0x13a13a(0x280))/0x2*(parseInt(_0x13a13a(0x21e))/0x3)+-parseInt(_0x13a13a(0x25b))/0x4+-parseInt(_0x13a13a(0x22f))/0x5+-parseInt(_0x13a13a(0x29a))/0x6*(-parseInt(_0x13a13a(0x246))/0x7)+-parseInt(_0x13a13a(0x264))/0x8*(-parseInt(_0x13a13a(0x1e7))/0x9)+-parseInt(_0x13a13a(0x1ea))/0xa*(-parseInt(_0x13a13a(0x215))/0xb);if(_0x37a86b===_0x1e97ca)break;else _0xa2a0f5['push'](_0xa2a0f5['shift']());}catch(_0x57915a){_0xa2a0f5['push'](_0xa2a0f5['shift']());}}}(_0x1890,0xbb0ef));function _0x4bd7(_0x6b2c7a,_0xb15641){const _0x18903b=_0x1890();return _0x4bd7=function(_0x4bd7f1,_0x48790b){_0x4bd7f1=_0x4bd7f1-0x1b5;let _0x394f7e=_0x18903b[_0x4bd7f1];return _0x394f7e;},_0x4bd7(_0x6b2c7a,_0xb15641);}var __decorate=this&&this['__decorate']||function(_0x5ce9a2,_0x1c1730,_0x24799c,_0x10a6f9){const _0x3e1582=_0x4bd7;var _0x2132ed=arguments[_0x3e1582(0x231)],_0x29e67c=_0x2132ed<0x3?_0x1c1730:_0x10a6f9===null?_0x10a6f9=Object[_0x3e1582(0x2aa)](_0x1c1730,_0x24799c):_0x10a6f9,_0x27ee64;if(typeof Reflect===_0x3e1582(0x290)&&typeof Reflect[_0x3e1582(0x1f6)]===_0x3e1582(0x2a3))_0x29e67c=Reflect[_0x3e1582(0x1f6)](_0x5ce9a2,_0x1c1730,_0x24799c,_0x10a6f9);else{for(var _0xd6b4cd=_0x5ce9a2[_0x3e1582(0x231)]-0x1;_0xd6b4cd>=0x0;_0xd6b4cd--)if(_0x27ee64=_0x5ce9a2[_0xd6b4cd])_0x29e67c=(_0x2132ed<0x3?_0x27ee64(_0x29e67c):_0x2132ed>0x3?_0x27ee64(_0x1c1730,_0x24799c,_0x29e67c):_0x27ee64(_0x1c1730,_0x24799c))||_0x29e67c;}return _0x2132ed>0x3&&_0x29e67c&&Object[_0x3e1582(0x2ad)](_0x1c1730,_0x24799c,_0x29e67c),_0x29e67c;},__metadata=this&&this[_0x179a9e(0x1cc)]||function(_0x33de94,_0x1b0128){const _0x658a82=_0x179a9e;if(typeof Reflect===_0x658a82(0x290)&&typeof Reflect[_0x658a82(0x294)]===_0x658a82(0x2a3))return Reflect['metadata'](_0x33de94,_0x1b0128);},__param=this&&this['__param']||function(_0x303323,_0x52953c){return function(_0xbc468a,_0x10aa33){_0x52953c(_0xbc468a,_0x10aa33,_0x303323);};};Object[_0x179a9e(0x2ad)](exports,'__esModule',{'value':!![]}),exports[_0x179a9e(0x20e)]=void 0x0;const upload_service_1=require(_0x179a9e(0x23e)),user_service_1=require('./../user/user.service'),nestjs_config_1=require(_0x179a9e(0x1b8)),common_1=require(_0x179a9e(0x1d4)),errorMessage_constant_1=require(_0x179a9e(0x227)),utils_1=require('../../common/utils'),axios_1=require(_0x179a9e(0x1dd)),userBalance_service_1=require(_0x179a9e(0x1e0)),balance_constant_1=require('../../common/constants/balance.constant'),chatLog_service_1=require(_0x179a9e(0x1cb)),uuid=require('uuid'),config_entity_1=require(_0x179a9e(0x27f)),typeorm_1=require(_0x179a9e(0x2b5)),typeorm_2=require('@nestjs/typeorm'),badwords_service_1=require(_0x179a9e(0x1e4)),autoreply_service_1=require(_0x179a9e(0x2a8)),gptkeys_entity_1=require('./gptkeys.entity'),globalConfig_service_1=require(_0x179a9e(0x298)),fanyi_service_1=require(_0x179a9e(0x236)),app_entity_1=require(_0x179a9e(0x26a)),chatGroup_service_1=require(_0x179a9e(0x23a)),models_service_1=require(_0x179a9e(0x29d)),baidu_1=require(_0x179a9e(0x258)),helper_1=require(_0x179a9e(0x1ba)),store_1=require(_0x179a9e(0x240)),zhipu_1=require(_0x179a9e(0x1c3)),openai_1=require('./openai'),chatBoxType_entity_1=require(_0x179a9e(0x2a0)),chatBox_entity_1=require('./chatBox.entity'),chatPre_entity_1=require(_0x179a9e(0x252)),chatPreType_entity_1=require(_0x179a9e(0x261));function _0x1890(){const _0x43d388=['186vfXuHx','getClientIp','formatModelToken','AppEntity','ceil','user','openai-draw\x20error:\x20','queryChatPre','importDynamic','../../common/constants/errorMessage.constant','default','BAD_REQUEST','log','error','ConfigService','gpt-3','chatBoxTypeEntity','5868410BCNweZ','ChatBoxEntity','length','split','DrawService','checkUserStatus','onModuleInit','../fanyi/fanyi.service','saveChatLog','当前模型key已被封禁','InjectRepository','../chatGroup/chatGroup.service','setData','chatLogService','openaiProxyUrl','./../upload/upload.service','CHAT_TYPE','./store','https://api.openai.com','proxyUrl','toLowerCase','setChatBox','globalConfigService','182rXNErt','toISOString','filter','fanyiService','assistant','openaiModel3MaxTokens16k','ChatLogService','status','当前模型不是聊天模型','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','queryChatBoxFrontend','delChatPreType','./chatPre.entity','当前请求已过载、请稍等会儿再试试吧！','openaiModel3MaxTokens','HttpException','缺失必要参数！','update','./baidu','keyv','dall-e\x20draw\x20params:\x20','3658020ioItll','ChatPreEntity','ChatPreTypeEntity','16k','model4','Injectable','./chatPreType.entity','getGroupInfoFromId','push','38928xsQIvS','getCurrentModelKeyInfo','提供了错误的模型秘钥','modelsService','1099231xcTWTH','stringify','../app/app.entity','queryChatBox','DESC','delete','sendMessageFromBaidu','openaiModel4MaxTokens','application/octet-stream;\x20charset=utf-8','preset','Too\x20Many\x20Requests','quality','dall-e-3','debug','autoreplyService','lockKey','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','setChatBoxType','find','@keyv/redis','FanyiService','REDIS_PORT','setChatPre','../globalConfig/config.entity','20082qFczQx','response','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','chat-error-detail\x20\x20<----------------------------------------->','.png','sendMessageFromZhipu','chatPreEntity','getModelProxyUrl','chatgpt-ai-web','size','configService','gpt-4','model',',\x20消耗积分：\x20','\x20模型名称:\x20','imageUrl','object','save','uploadFile','unifiedFormattingResponse','metadata','compileNetwork','forEach','appEntity','../globalConfig/globalConfig.service','coverImg','49218qNDmJe','userBalanceService','key','../models/models.service','from','text','./chatBoxType.entity','detail','getUploadType','function','当前Key余额已不足、请重新再试一次吧！','服务异常、请重新试试吧！！！','getBaseConfig','delChatPre','../autoreply/autoreply.service','AutoreplyService','getOwnPropertyDescriptor','getUuid','\x0a\x20Current\x20date:\x20','defineProperty','getRequestParams','statusText:','maxModelTokens','queryChatPreType','removeSpecialCharacters','typeId','当前分类下有未处理数据不可移除！','typeorm','32k','REDIS_PASSWORD','badwordsService','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','PAINT_TYPE','buildMessageFromParentMessageId','ModelsService','nestjs-config','UploadService','./helper','checkBadWords','keyPool','statusCode','dall','chat-error\x20<----------------------------------------->','count','systemPreMessage','GlobalConfigService','./zhipu','findOne','sendMessageFromOpenAi','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','assign','getTokenCount','conversationId','BadwordsService','../chatLog/chatLog.service','__metadata','typeInfo','chatProcess','modelInfo','config','chatPreTypeEntity','Billing\x20hard\x20limit\x20has\x20been\x20reached','all','@nestjs/common','setHeader','validateBalance','gptKeysEntity','queryUserBalance',',\x20key\x20===>\x20','ConfigEntity','maxResponseTokens','prompt','axios','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','abort','../userBalance/userBalance.service','mjDraw','用户ID:\x20','usage','../badwords/badwords.service','openaiModel3MaxTokens16kRes','1106','405yxZlkD','appInfo','statusText','630jTheYj','message','addOneIfOdd','REDIS_USER','HttpStatus','绘制图片失败，请检查你的提示词是否有非法描述！','chatSyncFree','chatBoxEntity','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','gpt-4-vision-preview','Please\x20check\x20the\x20back-end\x20console','Catch\x20Error\x20','decorate','b64_json','map','env','openaiBaseUrl','childList','Repository','nineai-chatlog','chatGroupService','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','getMaxTokenFromModelWithOpenAi','data','result','configEntity','includes','GptKeysEntity','userService','write','当前模型key余额已耗尽','gpt-4-1106','getConfigs','deductFromBalance','end','appId','ChatgptService','post','DeductionKey','非法操作！','error:\x20','uploadService','checkAutoReply','506143LLQpZu','openaiTimeoutMs','OpenAiErrorCodeMessage','/v1/images/generations','saveUseLog',',\x20消耗token:\x20','getRandomDrawKey','design:paramtypes','nineStore'];_0x1890=function(){return _0x43d388;};return _0x1890();}let ChatgptService=class ChatgptService{constructor(_0xd80fdb,_0x1f49b8,_0x6cab92,_0x99bee1,_0x37c661,_0x5e8cb6,_0x1684b0,_0x8d6078,_0x171ecf,_0x49aff5,_0x79e4e7,_0x25fc12,_0x3c6ace,_0x5aa3ad,_0x3e38ec,_0x4d3132,_0x7244dd,_0x394870){const _0x55026c=_0x179a9e;this[_0x55026c(0x1d7)]=_0xd80fdb,this[_0x55026c(0x203)]=_0x1f49b8,this[_0x55026c(0x22e)]=_0x6cab92,this['chatBoxEntity']=_0x99bee1,this[_0x55026c(0x297)]=_0x37c661,this[_0x55026c(0x1d1)]=_0x5e8cb6,this[_0x55026c(0x286)]=_0x1684b0,this[_0x55026c(0x28a)]=_0x8d6078,this[_0x55026c(0x29b)]=_0x171ecf,this[_0x55026c(0x23c)]=_0x49aff5,this[_0x55026c(0x206)]=_0x79e4e7,this['uploadService']=_0x25fc12,this[_0x55026c(0x2b8)]=_0x3c6ace,this[_0x55026c(0x276)]=_0x5aa3ad,this['globalConfigService']=_0x3e38ec,this[_0x55026c(0x249)]=_0x4d3132,this[_0x55026c(0x1fe)]=_0x7244dd,this[_0x55026c(0x267)]=_0x394870,this['nineStore']=null,this['whiteListUser']=[],this[_0x55026c(0x1bc)]={'list3':[],'list4':[]};}async[_0x179a9e(0x235)](){const _0x560e95=_0x179a9e;let _0x4ceba7=await(0x0,utils_1['importDynamic'])(_0x560e95(0x288)),_0x1c2f1b=await(0x0,utils_1[_0x560e95(0x226)])(_0x560e95(0x27b)),_0x3faab4=await(0x0,utils_1[_0x560e95(0x226)])(_0x560e95(0x259));_0x4ceba7=(_0x4ceba7===null||_0x4ceba7===void 0x0?void 0x0:_0x4ceba7[_0x560e95(0x228)])?_0x4ceba7[_0x560e95(0x228)]:_0x4ceba7,_0x1c2f1b=(_0x1c2f1b===null||_0x1c2f1b===void 0x0?void 0x0:_0x1c2f1b[_0x560e95(0x228)])?_0x1c2f1b[_0x560e95(0x228)]:_0x1c2f1b,_0x3faab4=(_0x3faab4===null||_0x3faab4===void 0x0?void 0x0:_0x3faab4[_0x560e95(0x228)])?_0x3faab4[_0x560e95(0x228)]:_0x3faab4;const {ChatGPTAPI:_0x3d799e,ChatGPTError:_0x32b34c,ChatGPTUnofficialProxyAPI:_0x3877bf}=_0x4ceba7,_0x4cf992=+process[_0x560e95(0x1f9)][_0x560e95(0x27d)],_0x4c76c2=process[_0x560e95(0x1f9)]['REDIS_HOST'],_0x270ba3=process[_0x560e95(0x1f9)][_0x560e95(0x2b7)],_0x5c379c=process[_0x560e95(0x1f9)][_0x560e95(0x1ed)],_0x461d09='redis://'+(_0x5c379c||'')+':'+(_0x270ba3||'')+'@'+_0x4c76c2+':'+_0x4cf992,_0x15348e=new _0x1c2f1b(_0x461d09),_0x15f230=new _0x3faab4({'store':_0x15348e,'namespace':_0x560e95(0x1fd)});this[_0x560e95(0x21d)]=new store_1['NineStore']({'store':_0x15f230,'namespace':'chat'});}async[_0x179a9e(0x2ae)](_0x96f036,_0x5de0be,_0x495629,_0x3aabd9=null){const _0x300188=_0x179a9e;var _0xd93cbd;!_0x3aabd9&&(_0x3aabd9=(_0xd93cbd=await this['modelsService']['getBaseConfig']())===null||_0xd93cbd===void 0x0?void 0x0:_0xd93cbd[_0x300188(0x1cf)]);const {timeout:timeout=0x3c}=_0x495629,{topN:_0x5cf0e5,model:_0x311663}=_0x3aabd9,{parentMessageId:parentMessageId=0x0}=_0x96f036,_0x21166f=await this[_0x300188(0x245)][_0x300188(0x20a)]([_0x300188(0x216)]),_0x1b636=timeout*0x3e8||_0x21166f||0x64*0x3e8,_0x365f2a={'parentMessageId':parentMessageId,'timeoutMs':+_0x1b636,'completionParams':{'model':_0x311663,'temperature':_0x5cf0e5}};return _0x5de0be&&(_0x365f2a['systemMessage']=_0x5de0be),_0x365f2a;}async[_0x179a9e(0x1f0)](_0x29ddf6){const _0x3f51b3=_0x179a9e,_0x4de5a9=await this['modelsService'][_0x3f51b3(0x21b)](),_0x56444a=await this[_0x3f51b3(0x245)][_0x3f51b3(0x20a)]([_0x3f51b3(0x1c1)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x1046eb,model:_0x2a8339}=_0x4de5a9,_0x1fb243=await this['getModelProxyUrl'](_0x4de5a9),{context:_0x162d6a}=await this['nineStore'][_0x3f51b3(0x1b6)](_0x29ddf6,{'parentMessageId':'','systemMessage':_0x56444a});try{const _0x4da10d=await(0x0,openai_1[_0x3f51b3(0x1c5)])(_0x162d6a,{'apiKey':(0x0,utils_1[_0x3f51b3(0x2b2)])(_0x1046eb),'model':_0x2a8339,'proxyUrl':_0x1fb243,'onProgress':null});return _0x4da10d===null||_0x4da10d===void 0x0?void 0x0:_0x4da10d[_0x3f51b3(0x29f)];}catch(_0x190768){console[_0x3f51b3(0x22a)](_0x3f51b3(0x212),_0x190768);}}async[_0x179a9e(0x1ce)](_0x56c689,_0x319a4b,_0x12758b){const _0xfa3d27=_0x179a9e;var _0x3b1da1,_0x12bf99,_0x8f545e,_0x1dbcb2;const _0x14ecdc=_0x319a4b['abortController'],{options:options={},appId:_0x5584ff,cusromPrompt:_0x557ff6,systemMessage:systemMessage=''}=_0x56c689;let _0x1bccd2=systemMessage;const {parentMessageId:_0x2441d5}=options,{prompt:_0x55f0fd,imageUrl:_0x12429b,model:_0x3231e7}=_0x56c689,{groupId:_0xed247d,usingNetwork:_0xed283b}=options,_0x4fb4ac=await this[_0xfa3d27(0x1fe)][_0xfa3d27(0x262)](_0xed247d),_0x579677=(_0x4fb4ac===null||_0x4fb4ac===void 0x0?void 0x0:_0x4fb4ac['config'])?JSON['parse'](_0x4fb4ac[_0xfa3d27(0x1d0)]):await this[_0xfa3d27(0x267)][_0xfa3d27(0x2a6)](),{keyType:_0x49daba,model:_0x18ab25,topN:_0x3e9fdf,systemMessage:_0x54c83a,rounds:_0x978845}=_0x579677[_0xfa3d27(0x1cf)];let _0x5ce669=null;!_0x557ff6?_0x5ce669=await this[_0xfa3d27(0x267)][_0xfa3d27(0x265)](_0x18ab25):_0x5ce669=await this[_0xfa3d27(0x267)][_0xfa3d27(0x21b)]();if(!_0x5ce669)throw new common_1[(_0xfa3d27(0x255))](_0xfa3d27(0x282),common_1[_0xfa3d27(0x1ee)]['BAD_REQUEST']);const {deduct:_0x5d7e4d,isTokenBased:_0x3c730f,tokenFeeRatio:_0x5558a0,deductType:_0x1fbfe3,key:_0x519086,secret:_0x53054b,modelName:_0x498f9e,id:_0x5a2164,accessToken:_0x417252}=_0x5ce669;await this[_0xfa3d27(0x206)][_0xfa3d27(0x234)](_0x319a4b['user']),await this[_0xfa3d27(0x29b)]['validateBalance'](_0x319a4b,_0x1fbfe3===0x1?'model3':_0xfa3d27(0x25f),_0x5d7e4d),_0x12758b&&_0x12758b[_0xfa3d27(0x1d5)]('Content-type',_0xfa3d27(0x270)),await this[_0xfa3d27(0x2b8)][_0xfa3d27(0x1bb)](_0x55f0fd,_0x319a4b[_0xfa3d27(0x223)]['id']);const _0x419729=await this[_0xfa3d27(0x276)][_0xfa3d27(0x214)](_0x55f0fd);if(_0x419729&&_0x12758b){const _0x5d5d84={'message':_0x419729,'code':0x1f4};return _0x12758b['write'](JSON[_0xfa3d27(0x269)](_0x5d5d84)),_0x12758b[_0xfa3d27(0x20c)]();}if(_0x5584ff){const _0x5b2cb1=await this[_0xfa3d27(0x297)][_0xfa3d27(0x1c4)]({'where':{'id':_0x5584ff,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x5b2cb1)throw new common_1[(_0xfa3d27(0x255))]('你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',common_1[_0xfa3d27(0x1ee)]['BAD_REQUEST']);_0x5b2cb1[_0xfa3d27(0x271)]&&(_0x1bccd2=_0x5b2cb1[_0xfa3d27(0x271)]);}else{if(_0x557ff6)_0x1bccd2=systemMessage;else{if(_0x54c83a)_0x1bccd2=_0x54c83a;else{const _0x463216=new Date()['toISOString']()['split']('T')[0x0],_0x1fc927=await this[_0xfa3d27(0x245)][_0xfa3d27(0x20a)]([_0xfa3d27(0x1c1)]);_0x1bccd2=_0x1fc927+(_0xfa3d27(0x2ac)+_0x463216);}}}let _0x3bdb5c='';if(_0xed283b){_0x3bdb5c=await(0x0,utils_1[_0xfa3d27(0x295)])(_0x55f0fd);const _0x584280=new Date()[_0xfa3d27(0x247)]()[_0xfa3d27(0x232)]('T')[0x0],_0x19c432=await this[_0xfa3d27(0x245)][_0xfa3d27(0x20a)]([_0xfa3d27(0x1c1)]);_0x1bccd2=_0x19c432+(_0xfa3d27(0x2ac)+_0x584280);}const _0x453a94=await this[_0xfa3d27(0x2ae)](options,_0x1bccd2,_0x5ce669,_0x579677[_0xfa3d27(0x1cf)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x3b978d}=_0x5ce669;_0x12758b&&_0x12758b[_0xfa3d27(0x24d)](0xc8);let _0x302305=null,_0x404a7e=null;try{if(_0x12758b){let _0x7b8ccf=null,_0x13ec48=![];_0x12758b['on']('close',async()=>{const _0x5c011d=_0xfa3d27;if(_0x13ec48)return;_0x14ecdc[_0x5c011d(0x1df)]();const _0x2d0268=await(0x0,openai_1[_0x5c011d(0x1c8)])(_0x55f0fd)||0x0,_0xfc6c94=await(0x0,openai_1['getTokenCount'])(_0x7b8ccf===null||_0x7b8ccf===void 0x0?void 0x0:_0x7b8ccf[_0x5c011d(0x29f)])||0x0,_0x202b44=_0x2d0268+_0xfc6c94,_0xa94456=(0x0,utils_1[_0x5c011d(0x21f)])(_0x319a4b);await this['chatLogService'][_0x5c011d(0x237)]({'appId':_0x5584ff,'curIp':_0xa94456,'userId':_0x319a4b[_0x5c011d(0x223)]['id'],'type':balance_constant_1[_0x5c011d(0x210)]['CHAT_TYPE'],'prompt':_0x55f0fd,'imageUrl':_0x12429b,'activeModel':_0x3231e7,'answer':'','promptTokens':_0x2d0268,'completionTokens':0x0,'totalTokens':_0x2d0268,'model':_0x18ab25,'role':_0x5c011d(0x223),'groupId':_0xed247d,'requestOptions':JSON[_0x5c011d(0x269)]({'options':null,'prompt':_0x55f0fd})}),await this[_0x5c011d(0x23c)]['saveChatLog']({'appId':_0x5584ff,'curIp':_0xa94456,'userId':_0x319a4b[_0x5c011d(0x223)]['id'],'type':balance_constant_1[_0x5c011d(0x210)][_0x5c011d(0x23f)],'prompt':_0x55f0fd,'answer':_0x7b8ccf===null||_0x7b8ccf===void 0x0?void 0x0:_0x7b8ccf[_0x5c011d(0x29f)],'promptTokens':_0x2d0268,'completionTokens':_0xfc6c94,'totalTokens':_0x202b44,'model':_0x18ab25,'role':'assistant','groupId':_0xed247d,'requestOptions':JSON[_0x5c011d(0x269)]({'options':{'model':_0x18ab25,'temperature':_0x3e9fdf},'prompt':_0x55f0fd}),'conversationOptions':JSON[_0x5c011d(0x269)]({'conversationId':_0x7b8ccf===null||_0x7b8ccf===void 0x0?void 0x0:_0x7b8ccf[_0x5c011d(0x1c9)],'model':_0x18ab25,'parentMessageId':_0x7b8ccf===null||_0x7b8ccf===void 0x0?void 0x0:_0x7b8ccf['id'],'temperature':_0x3e9fdf})});let _0x418f30=_0x5d7e4d;_0x3c730f===!![]&&(_0x418f30=Math[_0x5c011d(0x222)](_0x5d7e4d*_0x202b44/_0x5558a0)),await this[_0x5c011d(0x29b)][_0x5c011d(0x20b)](_0x319a4b['user']['id'],_0x5c011d(0x28c)+(_0x1fbfe3===0x1?0x3:0x4),_0x418f30,_0x202b44);});if(Number(_0x49daba)===0x1){const {key:_0x3bd11d,maxToken:_0x166cf1,maxTokenRes:_0x928790,proxyResUrl:_0x510c01}=await this['formatModelToken'](_0x5ce669),{parentMessageId:_0x3023fc,completionParams:_0x2a6816,systemMessage:_0x5db62f}=_0x453a94,{model:_0x3fc7e4,temperature:_0x415996}=_0x2a6816,{context:_0x4f3788}=await this[_0xfa3d27(0x21d)][_0xfa3d27(0x1b6)](_0xed283b?_0x3bdb5c:_0x55f0fd,{'parentMessageId':_0x3023fc,'systemMessage':_0x5db62f,'maxModelToken':_0x166cf1,'maxResponseTokens':_0x928790,'maxRounds':(0x0,helper_1[_0xfa3d27(0x1ec)])(_0x978845),'imageUrl':_0x12429b,'activeModel':_0x3231e7});let _0x1b3233=!![];_0x302305=await(0x0,openai_1[_0xfa3d27(0x1c5)])(_0x4f3788,{'maxToken':_0x166cf1,'maxTokenRes':_0x928790,'apiKey':_0x519086,'model':_0x3fc7e4,'prompt':_0x55f0fd,'activeModel':_0x3231e7,'imageUrl':_0x12429b,'temperature':_0x415996,'proxyUrl':_0x510c01,'onProgress':_0x2205d6=>{const _0xcab6bd=_0xfa3d27;_0x12758b[_0xcab6bd(0x207)](_0x1b3233?JSON[_0xcab6bd(0x269)](_0x2205d6):'\x0a'+JSON[_0xcab6bd(0x269)](_0x2205d6)),_0x7b8ccf=_0x2205d6,_0x1b3233=![];}},this[_0xfa3d27(0x213)]),_0x13ec48=!![];}if(Number(_0x49daba)===0x2){let _0x18830c=!![];const {context:_0x1d703f}=await this[_0xfa3d27(0x21d)][_0xfa3d27(0x1b6)](_0xed283b?_0x3bdb5c:_0x55f0fd,{'parentMessageId':_0x2441d5,'maxRounds':(0x0,helper_1[_0xfa3d27(0x1ec)])(_0x978845)});_0x302305=await(0x0,baidu_1[_0xfa3d27(0x26e)])(_0xed283b?_0x3bdb5c:_0x1d703f,{'temperature':_0x3e9fdf,'accessToken':_0x417252,'model':_0x18ab25,'onProgress':_0x4269b6=>{const _0x434de6=_0xfa3d27;_0x12758b[_0x434de6(0x207)](_0x18830c?JSON[_0x434de6(0x269)](_0x4269b6):'\x0a'+JSON['stringify'](_0x4269b6)),_0x18830c=![],_0x7b8ccf=_0x4269b6;}}),_0x13ec48=!![];}if(Number(_0x49daba)===0x3){let _0x4cdecd=!![];const {context:_0x383201}=await this[_0xfa3d27(0x21d)]['buildMessageFromParentMessageId'](_0xed283b?_0x3bdb5c:_0x55f0fd,{'parentMessageId':_0x2441d5,'maxRounds':(0x0,helper_1[_0xfa3d27(0x1ec)])(_0x978845)});_0x302305=await(0x0,zhipu_1[_0xfa3d27(0x285)])(_0xed283b?_0x3bdb5c:_0x383201,{'temperature':_0x3e9fdf,'key':_0x3b978d,'model':_0x18ab25,'onProgress':_0x13a235=>{const _0x4eedc8=_0xfa3d27;_0x12758b['write'](_0x4cdecd?JSON[_0x4eedc8(0x269)](_0x13a235):'\x0a'+JSON[_0x4eedc8(0x269)](_0x13a235)),_0x4cdecd=![],_0x7b8ccf=_0x13a235;}}),_0x13ec48=!![];}const _0x275004={'id':this['nineStore'][_0xfa3d27(0x2ab)](),'text':_0x55f0fd,'role':_0xfa3d27(0x223),'name':undefined,'usage':null,'imageUrl':_0x12429b,'activeModel':_0x3231e7,'parentMessageId':_0x2441d5,'conversationId':_0x302305===null||_0x302305===void 0x0?void 0x0:_0x302305[_0xfa3d27(0x1c9)]};_0x404a7e={'model':_0x18ab25,'parentMessageId':_0x2441d5},await this[_0xfa3d27(0x21d)]['setData'](_0x275004);const _0x2331d7={'id':_0x302305['id'],'text':_0x302305['text'],'role':_0xfa3d27(0x24a),'name':undefined,'usage':_0x302305===null||_0x302305===void 0x0?void 0x0:_0x302305['usage'],'imageUrl':_0x12429b,'parentMessageId':_0x275004['id'],'conversationId':_0x302305===null||_0x302305===void 0x0?void 0x0:_0x302305['conversationId']};await this[_0xfa3d27(0x21d)][_0xfa3d27(0x23b)](_0x2331d7),_0x404a7e={'model':_0x18ab25,'parentMessageId':_0x275004['id']};}else{const {key:_0x490cad,maxToken:_0x95c9f,maxTokenRes:_0x24fbe3,proxyResUrl:_0x3705ac}=await this['formatModelToken'](_0x5ce669),{parentMessageId:_0x9b6215,completionParams:_0x516998,systemMessage:_0x4e784a}=_0x453a94,{model:_0x4f0ca1,temperature:_0x48d65a}=_0x516998,{context:_0x5b4f71}=await this[_0xfa3d27(0x21d)]['buildMessageFromParentMessageId'](_0xed283b?_0x3bdb5c:_0x55f0fd,{'parentMessageId':_0x9b6215,'systemMessage':_0x4e784a,'maxRounds':(0x0,helper_1[_0xfa3d27(0x1ec)])(_0x978845)});_0x302305=await(0x0,openai_1[_0xfa3d27(0x1c5)])(_0x5b4f71,{'apiKey':_0x519086,'model':_0x4f0ca1,'temperature':_0x48d65a,'proxyUrl':_0x3705ac,'onProgress':null,'prompt':_0x55f0fd});}let _0x5271b4=null,_0x14f56d=null;_0x18ab25['includes'](_0xfa3d27(0x1be))?_0x5271b4=((_0x3b1da1=_0x302305[_0xfa3d27(0x2a1)])===null||_0x3b1da1===void 0x0?void 0x0:_0x3b1da1[_0xfa3d27(0x1e3)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x14f56d=await(0x0,helper_1[_0xfa3d27(0x293)])(_0x49daba,_0x302305,_0x404a7e);const {prompt_tokens:_0x323b5c,completion_tokens:_0x44bacd,total_tokens:_0x38e56e}=_0x18ab25['includes'](_0xfa3d27(0x1be))?_0x5271b4:_0x14f56d[_0xfa3d27(0x1e3)];let _0x541d68=_0x5d7e4d;_0x3c730f===!![]&&(_0x541d68=Math[_0xfa3d27(0x222)](_0x5d7e4d*_0x38e56e/_0x5558a0));await this[_0xfa3d27(0x29b)][_0xfa3d27(0x20b)](_0x319a4b[_0xfa3d27(0x223)]['id'],_0xfa3d27(0x28c)+(_0x1fbfe3===0x1?0x3:0x4),_0x541d68,_0x38e56e),await this[_0xfa3d27(0x267)][_0xfa3d27(0x219)](_0x5a2164,_0x38e56e);const _0x4423fb=(0x0,utils_1[_0xfa3d27(0x21f)])(_0x319a4b);await this['chatLogService'][_0xfa3d27(0x237)]({'appId':_0x5584ff,'curIp':_0x4423fb,'userId':_0x319a4b[_0xfa3d27(0x223)]['id'],'type':balance_constant_1[_0xfa3d27(0x210)]['CHAT_TYPE'],'prompt':_0x55f0fd,'imageUrl':_0x12429b,'activeModel':_0x3231e7,'answer':'','promptTokens':_0x323b5c,'completionTokens':0x0,'totalTokens':_0x38e56e,'model':_0x18ab25,'role':'user','groupId':_0xed247d,'requestOptions':JSON[_0xfa3d27(0x269)]({'options':null,'prompt':_0x55f0fd})}),await this['chatLogService'][_0xfa3d27(0x237)]({'appId':_0x5584ff,'curIp':_0x4423fb,'userId':_0x319a4b[_0xfa3d27(0x223)]['id'],'type':balance_constant_1[_0xfa3d27(0x210)][_0xfa3d27(0x23f)],'prompt':_0x55f0fd,'imageUrl':_0x302305===null||_0x302305===void 0x0?void 0x0:_0x302305[_0xfa3d27(0x28f)],'answer':_0x302305[_0xfa3d27(0x29f)],'promptTokens':_0x323b5c,'completionTokens':_0x44bacd,'totalTokens':_0x38e56e,'model':_0x18ab25,'role':'assistant','groupId':_0xed247d,'requestOptions':JSON['stringify']({'options':{'model':_0x18ab25,'temperature':_0x3e9fdf},'prompt':_0x55f0fd}),'conversationOptions':JSON[_0xfa3d27(0x269)]({'conversationId':_0x302305[_0xfa3d27(0x1c9)],'model':_0x18ab25,'parentMessageId':_0x302305['id'],'temperature':_0x3e9fdf})}),common_1['Logger'][_0xfa3d27(0x275)](_0xfa3d27(0x1e2)+_0x319a4b['user']['id']+_0xfa3d27(0x28e)+_0x498f9e+'-'+_0x3231e7+_0xfa3d27(0x21a)+_0x38e56e+_0xfa3d27(0x28d)+_0x541d68,'ChatgptService');const _0x3a472b=await this[_0xfa3d27(0x29b)][_0xfa3d27(0x1d8)](_0x319a4b[_0xfa3d27(0x223)]['id']);return _0x302305['userBanance']=Object['assign']({},_0x3a472b),_0x302305[_0xfa3d27(0x202)]&&(_0x302305[_0xfa3d27(0x202)]=''),_0x302305['is_end']=!![],_0x12758b?_0x12758b[_0xfa3d27(0x207)]('\x0a'+JSON[_0xfa3d27(0x269)](_0x302305)):_0x302305[_0xfa3d27(0x29f)];}catch(_0x7b6214){console[_0xfa3d27(0x22a)](_0xfa3d27(0x1bf),_0x519086,_0x7b6214);const _0x2898d4=(_0x7b6214===null||_0x7b6214===void 0x0?void 0x0:_0x7b6214[_0xfa3d27(0x1bd)])||0x190,_0x1259d4=((_0x12bf99=_0x7b6214===null||_0x7b6214===void 0x0?void 0x0:_0x7b6214[_0xfa3d27(0x281)])===null||_0x12bf99===void 0x0?void 0x0:_0x12bf99['status'])||(_0x7b6214===null||_0x7b6214===void 0x0?void 0x0:_0x7b6214[_0xfa3d27(0x1bd)])||0x190;console[_0xfa3d27(0x22a)](_0xfa3d27(0x283),'code:\x20',_0x2898d4,_0xfa3d27(0x1eb),_0x7b6214===null||_0x7b6214===void 0x0?void 0x0:_0x7b6214[_0xfa3d27(0x1eb)],_0xfa3d27(0x2af),(_0x8f545e=_0x7b6214===null||_0x7b6214===void 0x0?void 0x0:_0x7b6214['response'])===null||_0x8f545e===void 0x0?void 0x0:_0x8f545e[_0xfa3d27(0x1e9)],_0xfa3d27(0x24d),(_0x1dbcb2=_0x7b6214===null||_0x7b6214===void 0x0?void 0x0:_0x7b6214[_0xfa3d27(0x281)])===null||_0x1dbcb2===void 0x0?void 0x0:_0x1dbcb2[_0xfa3d27(0x24d)]);if(_0x7b6214['status']&&_0x7b6214[_0xfa3d27(0x24d)]===0x192){const _0x542fc4={'message':_0xfa3d27(0x1f5)+_0x7b6214[_0xfa3d27(0x1eb)],'code':0x192};if(_0x12758b)return _0x12758b[_0xfa3d27(0x207)](JSON['stringify'](_0x542fc4));else throw new common_1[(_0xfa3d27(0x255))](_0x7b6214[_0xfa3d27(0x1eb)],common_1[_0xfa3d27(0x1ee)]['PAYMENT_REQUIRED']);}if(!_0x1259d4){if(_0x12758b)return _0x12758b[_0xfa3d27(0x207)](JSON[_0xfa3d27(0x269)]({'message':_0x7b6214[_0xfa3d27(0x1eb)],'code':0x1f4}));else throw new common_1['HttpException'](_0x7b6214['message'],common_1[_0xfa3d27(0x1ee)][_0xfa3d27(0x229)]);}let _0x3f64fc=errorMessage_constant_1[_0xfa3d27(0x217)][_0x1259d4]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x1259d4]:_0xfa3d27(0x2a5);(_0x7b6214===null||_0x7b6214===void 0x0?void 0x0:_0x7b6214[_0xfa3d27(0x1eb)][_0xfa3d27(0x204)](_0xfa3d27(0x1de)))&&Number(_0x49daba)===0x1&&(await this[_0xfa3d27(0x267)][_0xfa3d27(0x277)](_0x5a2164,_0xfa3d27(0x1f2),-0x1),_0x3f64fc=_0xfa3d27(0x238));(_0x7b6214===null||_0x7b6214===void 0x0?void 0x0:_0x7b6214[_0xfa3d27(0x1bd)])===0x1ad&&_0x7b6214[_0xfa3d27(0x1eb)][_0xfa3d27(0x204)]('billing')&&Number(_0x49daba)===0x1&&(await this[_0xfa3d27(0x267)][_0xfa3d27(0x277)](_0x5a2164,_0xfa3d27(0x278),-0x3),_0x3f64fc=_0xfa3d27(0x208));(_0x7b6214===null||_0x7b6214===void 0x0?void 0x0:_0x7b6214['statusCode'])===0x1ad&&(_0x7b6214===null||_0x7b6214===void 0x0?void 0x0:_0x7b6214[_0xfa3d27(0x1e9)])===_0xfa3d27(0x272)&&(_0x3f64fc='当前模型调用过于频繁、请重新试试吧！');(_0x7b6214===null||_0x7b6214===void 0x0?void 0x0:_0x7b6214[_0xfa3d27(0x1bd)])===0x191&&_0x7b6214['message']['includes']('Incorrect\x20API\x20key\x20provided')&&Number(_0x49daba)===0x1&&(await this[_0xfa3d27(0x267)]['lockKey'](_0x5a2164,_0xfa3d27(0x266),-0x2),_0x3f64fc='提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！');(_0x7b6214===null||_0x7b6214===void 0x0?void 0x0:_0x7b6214[_0xfa3d27(0x1bd)])===0x194&&_0x7b6214[_0xfa3d27(0x1eb)][_0xfa3d27(0x204)](_0xfa3d27(0x2b9))&&Number(_0x49daba)===0x1&&(await this[_0xfa3d27(0x267)][_0xfa3d27(0x277)](_0x5a2164,_0xfa3d27(0x24e),-0x4),_0x3f64fc=_0xfa3d27(0x1ff));_0x2898d4===0x190&&console[_0xfa3d27(0x22a)]('400\x20error',_0x7b6214,_0x7b6214[_0xfa3d27(0x1eb)]);const _0x4e4714={'message':_0x3f64fc||_0xfa3d27(0x1f4),'code':_0x2898d4===0x191?0x190:_0x2898d4||0x1f4};if(_0x12758b)return _0x12758b['write'](JSON['stringify'](_0x4e4714));else throw new common_1[(_0xfa3d27(0x255))](_0x4e4714['message'],common_1[_0xfa3d27(0x1ee)][_0xfa3d27(0x229)]);}finally{_0x12758b&&_0x12758b['end']();}}async['draw'](_0xd20c5e,_0x62a0ff){const _0x588f04=_0x179a9e;var _0xf0e2e9,_0x52f700,_0x26b225,_0xda30d4;await this[_0x588f04(0x2b8)][_0x588f04(0x1bb)](_0xd20c5e[_0x588f04(0x1dc)],_0x62a0ff[_0x588f04(0x223)]['id']),await this[_0x588f04(0x206)]['checkUserStatus'](_0x62a0ff[_0x588f04(0x223)]);const _0x1c39d1=(_0xd20c5e===null||_0xd20c5e===void 0x0?void 0x0:_0xd20c5e[_0x588f04(0x273)])==='hd'?0x4:0x2;await this['userBalanceService'][_0x588f04(0x1d6)](_0x62a0ff,_0x588f04(0x1e1),_0x1c39d1);let _0x4248af=[];const _0x50959a=await this[_0x588f04(0x267)]['getCurrentModelKeyInfo'](_0x588f04(0x274)),_0x413905=_0x50959a===null||_0x50959a===void 0x0?void 0x0:_0x50959a['id'],{key:_0x331cfc,proxyResUrl:_0x1e8a8c}=await this[_0x588f04(0x220)](_0x50959a);common_1['Logger'][_0x588f04(0x22a)]('draw\x20paompt\x20info\x20<==**==>\x20'+_0xd20c5e[_0x588f04(0x1dc)]+_0x588f04(0x1d9)+_0x331cfc,_0x588f04(0x233));try{const _0x152173=_0x1e8a8c+_0x588f04(0x218),_0x14a5ca=Object[_0x588f04(0x1c7)](Object[_0x588f04(0x1c7)]({},_0xd20c5e),{'model':_0x588f04(0x274)});console[_0x588f04(0x22a)](_0x588f04(0x25a),_0x14a5ca);const _0x23781e=await axios_1[_0x588f04(0x228)][_0x588f04(0x20f)](_0x152173,Object[_0x588f04(0x1c7)](Object[_0x588f04(0x1c7)]({},_0x14a5ca),{'response_format':_0x588f04(0x1f7)}),{'headers':{'Authorization':'Bearer\x20'+_0x331cfc}});_0x4248af=_0x23781e['data'][_0x588f04(0x201)];const _0x3dd483=[];for(const _0x330c65 of _0x4248af){const _0x3d4bc3=uuid['v4']()['slice'](0x0,0xa)+_0x588f04(0x284),_0x160439=Buffer[_0x588f04(0x29e)](_0x330c65[_0x588f04(0x1f7)],'base64');_0x3dd483[_0x588f04(0x263)](this[_0x588f04(0x213)][_0x588f04(0x292)]({'filename':_0x3d4bc3,'buffer':_0x160439}));}const _0x22bfd5=await Promise[_0x588f04(0x1d3)](_0x3dd483);await this['userBalanceService']['deductFromBalance'](_0x62a0ff[_0x588f04(0x223)]['id'],_0x588f04(0x1e1),(_0x14a5ca===null||_0x14a5ca===void 0x0?void 0x0:_0x14a5ca[_0x588f04(0x273)])==='standard'?0x2:0x4,_0x1c39d1);const _0x5ef3c9=(0x0,utils_1[_0x588f04(0x21f)])(_0x62a0ff),_0x40e907=[],_0x56bf8e=await this[_0x588f04(0x213)][_0x588f04(0x2a2)](),[_0x2ab868,_0x7905ca]=_0xd20c5e[_0x588f04(0x289)]['split']('x');return _0x22bfd5[_0x588f04(0x296)](_0x3b98f1=>{const _0x335b5f=_0x588f04;_0x40e907[_0x335b5f(0x263)](this['chatLogService']['saveChatLog']({'curIp':_0x5ef3c9,'userId':_0x62a0ff[_0x335b5f(0x223)]['id'],'type':balance_constant_1[_0x335b5f(0x210)][_0x335b5f(0x1b5)],'prompt':_0xd20c5e['prompt'],'answer':_0x3b98f1,'fileInfo':JSON[_0x335b5f(0x269)]({'cosType':_0x56bf8e,'width':_0x2ab868,'height':_0x7905ca,'cosUrl':_0x3b98f1}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x335b5f(0x274)}));}),await Promise[_0x588f04(0x1d3)](_0x40e907),_0x22bfd5;}catch(_0x243a96){const _0x494611=((_0xf0e2e9=_0x243a96===null||_0x243a96===void 0x0?void 0x0:_0x243a96[_0x588f04(0x281)])===null||_0xf0e2e9===void 0x0?void 0x0:_0xf0e2e9[_0x588f04(0x24d)])||0x1f4;console['log'](_0x588f04(0x224),JSON[_0x588f04(0x269)](_0x243a96),_0x331cfc,_0x494611);const _0x3ede2a=(_0xda30d4=(_0x26b225=(_0x52f700=_0x243a96===null||_0x243a96===void 0x0?void 0x0:_0x243a96[_0x588f04(0x281)])===null||_0x52f700===void 0x0?void 0x0:_0x52f700['data'])===null||_0x26b225===void 0x0?void 0x0:_0x26b225[_0x588f04(0x22b)])===null||_0xda30d4===void 0x0?void 0x0:_0xda30d4[_0x588f04(0x1eb)];if(_0x494611===0x1ad)throw new common_1[(_0x588f04(0x255))](_0x588f04(0x253),common_1[_0x588f04(0x1ee)][_0x588f04(0x229)]);if(_0x494611===0x190&&_0x3ede2a[_0x588f04(0x204)](_0x588f04(0x1c6)))throw new common_1['HttpException'](_0x588f04(0x24f),common_1['HttpStatus'][_0x588f04(0x229)]);if(_0x494611===0x190&&_0x3ede2a[_0x588f04(0x204)](_0x588f04(0x1d2))){await this['modelsService'][_0x588f04(0x277)](_0x413905,_0x588f04(0x1f2),-0x1);throw new common_1[(_0x588f04(0x255))](_0x588f04(0x2a4),common_1[_0x588f04(0x1ee)][_0x588f04(0x229)]);}if(_0x494611===0x1f4)throw new common_1[(_0x588f04(0x255))](_0x588f04(0x1ef),common_1[_0x588f04(0x1ee)][_0x588f04(0x229)]);if(_0x494611===0x191)throw new common_1[(_0x588f04(0x255))]('绘制图片失败，此次绘画被拒绝了！',common_1[_0x588f04(0x1ee)][_0x588f04(0x229)]);throw new common_1[(_0x588f04(0x255))]('绘制图片失败，请稍后试试吧！',common_1['HttpStatus'][_0x588f04(0x229)]);}}async['getAllKeyList'](){const _0x159568=_0x179a9e,_0x57c108=await this[_0x159568(0x1d7)]['find']({'where':{'status':0x1},'select':['id',_0x159568(0x29c),'weight',_0x159568(0x28c),_0x159568(0x2b0),_0x159568(0x1db),_0x159568(0x23d),_0x159568(0x216)]}),_0x203b51=_0x57c108[_0x159568(0x248)](_0x102284=>_0x102284[_0x159568(0x28c)][_0x159568(0x204)](_0x159568(0x22d))),_0x2ee876=_0x57c108['filter'](_0x537f23=>_0x537f23['model'][_0x159568(0x204)](_0x159568(0x28b)));this[_0x159568(0x1bc)]={'list3':_0x203b51,'list4':_0x2ee876};}async[_0x179a9e(0x287)](_0x27c474){const _0x35cf8e=_0x179a9e,_0x43382e=await this[_0x35cf8e(0x245)]['getConfigs']([_0x35cf8e(0x1fa)]);return(_0x27c474===null||_0x27c474===void 0x0?void 0x0:_0x27c474[_0x35cf8e(0x242)])||_0x43382e||_0x35cf8e(0x241);}async['formatModelToken'](_0x370b83){const _0x494edc=_0x179a9e,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x494edc(0x245)]['getConfigs']([_0x494edc(0x254),'openaiModel3MaxTokensRes',_0x494edc(0x24b),_0x494edc(0x1e5),_0x494edc(0x26f),'openaiModel4MaxTokensRes','openaiModel4MaxTokens32k','openaiModel4MaxTokens32kRes',_0x494edc(0x1fa)]);let _0x53288d=null,_0xe281ec=null,_0x248b09=null,{model:_0x569608,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0xc3f7e7}=_0x370b83;return _0x569608[_0x494edc(0x243)]()['includes'](_0x494edc(0x28b))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0xe281ec>=0x1000&&(maxModelTokens=0x1000),_0x53288d=maxModelTokens||openaiModel4MaxTokens||0x2000,_0xe281ec=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x569608['toLowerCase']()[_0x494edc(0x204)]('32k')&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0xe281ec>=0x4000&&(maxModelTokens=0x4000),_0x53288d=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0xe281ec=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x569608[_0x494edc(0x243)]()[_0x494edc(0x204)](_0x494edc(0x1e6))&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0xe281ec>=0x1000&&(maxModelTokens=0x1000),_0x53288d=maxModelTokens||0x3ffc,_0xe281ec=maxResponseTokens||0x1000)),_0x569608[_0x494edc(0x243)]()['includes']('gpt-3')&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0xe281ec>=0x7d0&&(maxModelTokens=0x7d0),_0x53288d=maxModelTokens||openaiModel3MaxTokens||0x1000,_0xe281ec=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x569608[_0x494edc(0x243)]()[_0x494edc(0x204)](_0x494edc(0x25e))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0xe281ec>=0x2000&&(maxModelTokens=0x2000),_0x53288d=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0xe281ec=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x569608[_0x494edc(0x243)]()['includes'](_0x494edc(0x1e6))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0xe281ec>=0x1000&&(maxModelTokens=0x1000),_0x53288d=maxModelTokens||0x4000,_0xe281ec=maxResponseTokens||0x1000)),_0x248b09=proxyUrl||openaiBaseUrl||_0x494edc(0x241),_0xe281ec>=_0x53288d&&(_0xe281ec=Math['floor'](_0x53288d/0x2)),{'key':_0xc3f7e7,'maxToken':_0x53288d,'maxTokenRes':_0xe281ec,'proxyResUrl':_0x248b09};}async[_0x179a9e(0x279)](_0x2c4a50,_0x5f230b){const _0x164412=_0x179a9e;try{const {name:_0x4e0dc9,icon:_0x4f1cb0,order:_0x2471bc,id:_0xf73607,status:_0x5921d5}=_0x5f230b;return _0xf73607?await this[_0x164412(0x22e)]['update']({'id':_0xf73607},{'name':_0x4e0dc9,'icon':_0x4f1cb0,'order':_0x2471bc,'status':_0x5921d5}):await this[_0x164412(0x22e)][_0x164412(0x291)]({'name':_0x4e0dc9,'icon':_0x4f1cb0,'order':_0x2471bc,'status':_0x5921d5});}catch(_0x1120d9){console[_0x164412(0x22a)](_0x164412(0x212),_0x1120d9);}}async['delChatBoxType'](_0xb1a51d,_0x27fffd){const _0x3ae59b=_0x179a9e,{id:_0x103d36}=_0x27fffd;if(!_0x103d36)throw new common_1[(_0x3ae59b(0x255))]('非法操作！',common_1['HttpStatus']['BAD_REQUEST']);const _0x4431e8=await this[_0x3ae59b(0x1f1)][_0x3ae59b(0x1c0)]({'where':{'typeId':_0x103d36}});if(_0x4431e8)throw new common_1[(_0x3ae59b(0x255))](_0x3ae59b(0x2b4),common_1[_0x3ae59b(0x1ee)][_0x3ae59b(0x229)]);return await this['chatBoxTypeEntity']['delete']({'id':_0x103d36});}async['queryChatBoxType'](){const _0x4465c3=_0x179a9e;return await this['chatBoxTypeEntity'][_0x4465c3(0x27a)]({'order':{'order':_0x4465c3(0x26c)}});}async[_0x179a9e(0x244)](_0x1fd781,_0x440a4d){const _0x5aa01c=_0x179a9e,{title:_0x39e1e0,prompt:_0x5485f2,appId:_0x458c31,order:_0x16fb50,status:_0x23543d,typeId:_0xe3130a,id:_0x35a30a,url:_0x475669}=_0x440a4d;if(!_0xe3130a)throw new common_1[(_0x5aa01c(0x255))](_0x5aa01c(0x256),common_1[_0x5aa01c(0x1ee)][_0x5aa01c(0x229)]);try{const _0x9e5663={'title':_0x39e1e0,'order':_0x16fb50,'status':_0x23543d,'typeId':_0xe3130a,'url':_0x475669};return _0x9e5663[_0x5aa01c(0x20d)]=_0x458c31||0x0,_0x9e5663[_0x5aa01c(0x1dc)]=_0x5485f2||'',_0x35a30a?await this['chatBoxEntity'][_0x5aa01c(0x257)]({'id':_0x35a30a},_0x9e5663):await this[_0x5aa01c(0x1f1)][_0x5aa01c(0x291)](_0x9e5663);}catch(_0x315de0){console[_0x5aa01c(0x22a)](_0x5aa01c(0x212),_0x315de0);}}async['delChatBox'](_0x41c94b,_0x567444){const _0x417876=_0x179a9e,{id:_0x3e5ab8}=_0x567444;if(!_0x3e5ab8)throw new common_1['HttpException'](_0x417876(0x211),common_1[_0x417876(0x1ee)]['BAD_REQUEST']);return await this['chatBoxEntity'][_0x417876(0x26d)]({'id':_0x3e5ab8});}async[_0x179a9e(0x26b)](){const _0x35ce9c=_0x179a9e,_0x4235a1=await this[_0x35ce9c(0x1f1)]['find']({'order':{'order':'DESC'}}),_0x149ac8=[...new Set(_0x4235a1[_0x35ce9c(0x1f8)](_0x2ceb28=>_0x2ceb28['typeId']))],_0x4a6264=[...new Set(_0x4235a1[_0x35ce9c(0x1f8)](_0x544288=>_0x544288[_0x35ce9c(0x20d)]))],_0x513e69=await this[_0x35ce9c(0x22e)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x149ac8)}}),_0x49d538=await this[_0x35ce9c(0x297)][_0x35ce9c(0x27a)]({'where':{'id':(0x0,typeorm_1['In'])(_0x4a6264)}});return _0x4235a1['map'](_0x3bf7ef=>{const _0x2a095a=_0x35ce9c,{typeId:_0x32deed,appId:_0x513844}=_0x3bf7ef;return _0x3bf7ef[_0x2a095a(0x1cd)]=_0x513e69[_0x2a095a(0x27a)](_0x24b383=>_0x24b383['id']===_0x32deed),_0x3bf7ef[_0x2a095a(0x1e8)]=_0x49d538[_0x2a095a(0x27a)](_0x20c42b=>_0x20c42b['id']===_0x513844),_0x3bf7ef;});}async[_0x179a9e(0x250)](){const _0x1d47ae=_0x179a9e,_0x2ded8c=await this[_0x1d47ae(0x22e)][_0x1d47ae(0x27a)]({'order':{'order':_0x1d47ae(0x26c)},'where':{'status':!![]}}),_0x2db746=await this[_0x1d47ae(0x1f1)][_0x1d47ae(0x27a)]({'where':{'status':!![]}}),_0x4f77e5=[...new Set(_0x2db746[_0x1d47ae(0x1f8)](_0x4ea48c=>_0x4ea48c[_0x1d47ae(0x20d)]))],_0x1f9543=await this['appEntity'][_0x1d47ae(0x27a)]({'where':{'id':(0x0,typeorm_1['In'])(_0x4f77e5)}});return _0x2db746[_0x1d47ae(0x296)](_0xafc4f0=>{const _0x119250=_0x1d47ae,_0x9d7009=_0x1f9543['find'](_0x2f9565=>_0x2f9565['id']===_0xafc4f0['appId']);return _0xafc4f0[_0x119250(0x299)]=_0x9d7009===null||_0x9d7009===void 0x0?void 0x0:_0x9d7009[_0x119250(0x299)],_0xafc4f0;}),_0x2ded8c[_0x1d47ae(0x1f8)](_0x58cbd9=>{const _0xb34569=_0x1d47ae;return _0x58cbd9[_0xb34569(0x1fb)]=_0x2db746[_0xb34569(0x248)](_0x1b2b82=>_0x1b2b82[_0xb34569(0x2b3)]===_0x58cbd9['id']&&_0x1b2b82[_0xb34569(0x24d)]),_0x58cbd9;});}async['setChatPreType'](_0x37ebe7,_0x3d266e){const _0x29202f=_0x179a9e;try{const {name:_0x1fd15b,icon:_0x37fcf8,order:_0x16bdc9,id:_0x25cf2c,status:_0x1eb186}=_0x3d266e;return _0x25cf2c?await this[_0x29202f(0x1d1)][_0x29202f(0x257)]({'id':_0x25cf2c},{'name':_0x1fd15b,'icon':_0x37fcf8,'order':_0x16bdc9,'status':_0x1eb186}):await this[_0x29202f(0x1d1)]['save']({'name':_0x1fd15b,'icon':_0x37fcf8,'order':_0x16bdc9,'status':_0x1eb186});}catch(_0x57331f){console['log'](_0x29202f(0x212),_0x57331f);}}async[_0x179a9e(0x251)](_0x385a63,_0x121c5f){const _0x5c09b6=_0x179a9e,{id:_0x102e8c}=_0x121c5f;if(!_0x102e8c)throw new common_1['HttpException']('非法操作！',common_1[_0x5c09b6(0x1ee)]['BAD_REQUEST']);const _0x59ba97=await this['chatBoxEntity'][_0x5c09b6(0x1c0)]({'where':{'typeId':_0x102e8c}});if(_0x59ba97)throw new common_1[(_0x5c09b6(0x255))](_0x5c09b6(0x2b4),common_1['HttpStatus'][_0x5c09b6(0x229)]);return await this[_0x5c09b6(0x1d1)][_0x5c09b6(0x26d)]({'id':_0x102e8c});}async[_0x179a9e(0x2b1)](){const _0x1d4a03=_0x179a9e;return await this[_0x1d4a03(0x1d1)]['find']({'order':{'order':'DESC'}});}async[_0x179a9e(0x27e)](_0x567017,_0x2fe4c6){const _0x2be38d=_0x179a9e,{title:_0x1b194e,prompt:_0x2f6f24,appId:_0x3452e7,order:_0x25b25c,status:_0x32eea3,typeId:_0x215c80,id:_0x326289,url:_0x577ee0}=_0x2fe4c6;if(!_0x215c80)throw new common_1[(_0x2be38d(0x255))](_0x2be38d(0x256),common_1[_0x2be38d(0x1ee)]['BAD_REQUEST']);try{const _0x194c1b={'title':_0x1b194e,'prompt':_0x2f6f24,'order':_0x25b25c,'status':_0x32eea3,'typeId':_0x215c80,'url':_0x577ee0};return _0x326289?await this[_0x2be38d(0x286)][_0x2be38d(0x257)]({'id':_0x326289},_0x194c1b):await this[_0x2be38d(0x286)][_0x2be38d(0x291)](_0x194c1b);}catch(_0x591a17){console[_0x2be38d(0x22a)](_0x2be38d(0x212),_0x591a17);}}async[_0x179a9e(0x2a7)](_0x39aa24,_0x270a7a){const _0x14ce55=_0x179a9e,{id:_0x3c2c5c}=_0x270a7a;if(!_0x3c2c5c)throw new common_1[(_0x14ce55(0x255))](_0x14ce55(0x211),common_1[_0x14ce55(0x1ee)][_0x14ce55(0x229)]);return await this[_0x14ce55(0x286)][_0x14ce55(0x26d)]({'id':_0x3c2c5c});}async[_0x179a9e(0x225)](){const _0xb84a39=_0x179a9e,_0xc5ad3f=await this[_0xb84a39(0x286)][_0xb84a39(0x27a)]({'order':{'order':'DESC'}}),_0x3a21b0=[...new Set(_0xc5ad3f[_0xb84a39(0x1f8)](_0x40fab1=>_0x40fab1[_0xb84a39(0x2b3)]))],_0x273c2e=await this[_0xb84a39(0x1d1)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x3a21b0)}});return _0xc5ad3f[_0xb84a39(0x1f8)](_0x10b362=>{const _0x1f4a71=_0xb84a39,{typeId:_0x42361c,appId:_0x31f1ea}=_0x10b362;return _0x10b362[_0x1f4a71(0x1cd)]=_0x273c2e[_0x1f4a71(0x27a)](_0x4686e5=>_0x4686e5['id']===_0x42361c),_0x10b362;});}async['queryChatPreList'](){const _0x563c52=_0x179a9e,_0x3302b0=await this[_0x563c52(0x1d1)][_0x563c52(0x27a)]({'order':{'order':_0x563c52(0x26c)},'where':{'status':!![]}}),_0x2bc643=await this[_0x563c52(0x286)][_0x563c52(0x27a)]({'where':{'status':!![]}});return _0x3302b0[_0x563c52(0x1f8)](_0xe61cc0=>{const _0x5048e4=_0x563c52;return _0xe61cc0['childList']=_0x2bc643[_0x5048e4(0x248)](_0x47628a=>_0x47628a[_0x5048e4(0x2b3)]===_0xe61cc0['id']&&_0x47628a['status']),_0xe61cc0;});}async[_0x179a9e(0x200)](_0x68b887,_0x58614a,_0x30398e){const _0x21e955=_0x179a9e;let _0x3183a1=0x1000,_0x341c70=0x800;return _0x68b887['toLowerCase']()[_0x21e955(0x204)](_0x21e955(0x28b))&&(_0x3183a1=_0x58614a>=0x2004?0x2004:_0x58614a,_0x341c70=_0x30398e>=0x1000?0x1000:_0x30398e,_0x68b887[_0x21e955(0x243)]()['includes'](_0x21e955(0x2b6))&&(_0x3183a1=_0x58614a>=0x8000?0x8000:_0x58614a,_0x341c70=_0x30398e>=0x3e80?0x3e80:_0x30398e),(_0x68b887[_0x21e955(0x243)]()['includes'](_0x21e955(0x209))||_0x68b887['toLowerCase']()[_0x21e955(0x204)](_0x21e955(0x1f3)))&&(_0x3183a1=_0x58614a>=0x1f400?0x1f400:_0x58614a,_0x341c70=_0x30398e>=0x1000?0x1000:_0x30398e)),_0x68b887[_0x21e955(0x243)]()['includes'](_0x21e955(0x22d))&&(_0x3183a1=_0x58614a>=0x1000?0x1000:_0x58614a,_0x341c70=_0x30398e>=0x800?0x800:_0x30398e,_0x68b887['toLowerCase']()[_0x21e955(0x204)](_0x21e955(0x25e))&&(_0x3183a1=_0x58614a>=0x4000?0x4000:_0x58614a,_0x341c70=_0x30398e>=0x1f40?0x1f40:_0x30398e),_0x68b887[_0x21e955(0x243)]()[_0x21e955(0x204)](_0x21e955(0x1e6))&&(_0x3183a1=_0x58614a>=0x4000?0x4000:_0x58614a,_0x341c70=_0x30398e>=0x1f40?0x1f40:_0x30398e)),{'maxToken':_0x3183a1,'maxRes':_0x341c70};}};ChatgptService=__decorate([(0x0,common_1[_0x179a9e(0x260)])(),__param(0x0,(0x0,typeorm_2[_0x179a9e(0x239)])(gptkeys_entity_1[_0x179a9e(0x205)])),__param(0x1,(0x0,typeorm_2[_0x179a9e(0x239)])(config_entity_1[_0x179a9e(0x1da)])),__param(0x2,(0x0,typeorm_2['InjectRepository'])(chatBoxType_entity_1['ChatBoxTypeEntity'])),__param(0x3,(0x0,typeorm_2['InjectRepository'])(chatBox_entity_1[_0x179a9e(0x230)])),__param(0x4,(0x0,typeorm_2[_0x179a9e(0x239)])(app_entity_1[_0x179a9e(0x221)])),__param(0x5,(0x0,typeorm_2['InjectRepository'])(chatPreType_entity_1[_0x179a9e(0x25d)])),__param(0x6,(0x0,typeorm_2['InjectRepository'])(chatPre_entity_1[_0x179a9e(0x25c)])),__metadata(_0x179a9e(0x21c),[typeorm_1[_0x179a9e(0x1fc)],typeorm_1[_0x179a9e(0x1fc)],typeorm_1[_0x179a9e(0x1fc)],typeorm_1['Repository'],typeorm_1['Repository'],typeorm_1['Repository'],typeorm_1['Repository'],nestjs_config_1[_0x179a9e(0x22c)],userBalance_service_1['UserBalanceService'],chatLog_service_1[_0x179a9e(0x24c)],user_service_1['UserService'],upload_service_1[_0x179a9e(0x1b9)],badwords_service_1[_0x179a9e(0x1ca)],autoreply_service_1[_0x179a9e(0x2a9)],globalConfig_service_1[_0x179a9e(0x1c2)],fanyi_service_1[_0x179a9e(0x27c)],chatGroup_service_1['ChatGroupService'],models_service_1[_0x179a9e(0x1b7)]])],ChatgptService),exports['ChatgptService']=ChatgptService;