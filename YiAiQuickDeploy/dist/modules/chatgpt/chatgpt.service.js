'use strict';const _0x4734d8=_0x1142;function _0x1142(_0x2962b9,_0x3a940f){const _0x2c3d84=_0x2c3d();return _0x1142=function(_0x114214,_0x2db7a8){_0x114214=_0x114214-0x1b8;let _0x134f37=_0x2c3d84[_0x114214];return _0x134f37;},_0x1142(_0x2962b9,_0x3a940f);}(function(_0x427c64,_0x3e0186){const _0x4d11e8=_0x1142,_0x255d4c=_0x427c64();while(!![]){try{const _0x1679a1=-parseInt(_0x4d11e8(0x281))/0x1+parseInt(_0x4d11e8(0x298))/0x2+parseInt(_0x4d11e8(0x261))/0x3*(-parseInt(_0x4d11e8(0x2af))/0x4)+parseInt(_0x4d11e8(0x1fa))/0x5*(parseInt(_0x4d11e8(0x247))/0x6)+-parseInt(_0x4d11e8(0x21b))/0x7+parseInt(_0x4d11e8(0x2bd))/0x8+-parseInt(_0x4d11e8(0x20c))/0x9*(-parseInt(_0x4d11e8(0x2c3))/0xa);if(_0x1679a1===_0x3e0186)break;else _0x255d4c['push'](_0x255d4c['shift']());}catch(_0x38bc0f){_0x255d4c['push'](_0x255d4c['shift']());}}}(_0x2c3d,0xe0bd4));var __decorate=this&&this[_0x4734d8(0x294)]||function(_0x59822e,_0x54b91d,_0x1ac5b9,_0x4c37b7){const _0x446640=_0x4734d8;var _0x274981=arguments[_0x446640(0x239)],_0x13063c=_0x274981<0x3?_0x54b91d:_0x4c37b7===null?_0x4c37b7=Object[_0x446640(0x233)](_0x54b91d,_0x1ac5b9):_0x4c37b7,_0x69b62c;if(typeof Reflect===_0x446640(0x1ba)&&typeof Reflect[_0x446640(0x2b0)]===_0x446640(0x29d))_0x13063c=Reflect[_0x446640(0x2b0)](_0x59822e,_0x54b91d,_0x1ac5b9,_0x4c37b7);else{for(var _0x215344=_0x59822e[_0x446640(0x239)]-0x1;_0x215344>=0x0;_0x215344--)if(_0x69b62c=_0x59822e[_0x215344])_0x13063c=(_0x274981<0x3?_0x69b62c(_0x13063c):_0x274981>0x3?_0x69b62c(_0x54b91d,_0x1ac5b9,_0x13063c):_0x69b62c(_0x54b91d,_0x1ac5b9))||_0x13063c;}return _0x274981>0x3&&_0x13063c&&Object[_0x446640(0x1ed)](_0x54b91d,_0x1ac5b9,_0x13063c),_0x13063c;},__metadata=this&&this['__metadata']||function(_0x5bf7a3,_0x3af9d4){const _0x5a478=_0x4734d8;if(typeof Reflect===_0x5a478(0x1ba)&&typeof Reflect[_0x5a478(0x2b9)]==='function')return Reflect[_0x5a478(0x2b9)](_0x5bf7a3,_0x3af9d4);},__param=this&&this[_0x4734d8(0x295)]||function(_0x32e9f4,_0x57d1fc){return function(_0x343c6c,_0x4bb373){_0x57d1fc(_0x343c6c,_0x4bb373,_0x32e9f4);};};Object[_0x4734d8(0x1ed)](exports,_0x4734d8(0x1b8),{'value':!![]}),exports[_0x4734d8(0x292)]=void 0x0;const upload_service_1=require(_0x4734d8(0x27a)),user_service_1=require('./../user/user.service'),nestjs_config_1=require(_0x4734d8(0x2a9)),common_1=require(_0x4734d8(0x284)),errorMessage_constant_1=require(_0x4734d8(0x207)),utils_1=require(_0x4734d8(0x2bc)),axios_1=require(_0x4734d8(0x1cf)),userBalance_service_1=require(_0x4734d8(0x26e)),balance_constant_1=require(_0x4734d8(0x1e3)),chatLog_service_1=require(_0x4734d8(0x2ac)),uuid=require(_0x4734d8(0x1bd)),config_entity_1=require(_0x4734d8(0x21d)),typeorm_1=require(_0x4734d8(0x202)),typeorm_2=require(_0x4734d8(0x27f)),badwords_service_1=require(_0x4734d8(0x208)),autoreply_service_1=require(_0x4734d8(0x23e)),gptkeys_entity_1=require(_0x4734d8(0x254)),globalConfig_service_1=require(_0x4734d8(0x1e2)),fanyi_service_1=require(_0x4734d8(0x262)),app_entity_1=require('../app/app.entity'),chatGroup_service_1=require(_0x4734d8(0x1fb)),models_service_1=require(_0x4734d8(0x2a8)),baidu_1=require(_0x4734d8(0x24e)),helper_1=require(_0x4734d8(0x244)),store_1=require(_0x4734d8(0x1dc)),zhipu_1=require(_0x4734d8(0x24f)),openai_1=require(_0x4734d8(0x288)),chatBoxType_entity_1=require(_0x4734d8(0x26f)),chatBox_entity_1=require(_0x4734d8(0x265)),chatPre_entity_1=require(_0x4734d8(0x23c)),chatPreType_entity_1=require('./chatPreType.entity');function _0x2c3d(){const _0x251916=['onModuleInit','object','log','delChatPre','uuid','提供了错误的模型秘钥','coverImg','Too\x20Many\x20Requests','UserService','end','chatBoxTypeEntity','dall-e-3','当前Key余额已不足、请重新再试一次吧！','result','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','application/octet-stream;\x20charset=utf-8','map','sendMessageFromOpenAi','NineStore','queryChatBoxFrontend','getModelProxyUrl','用户ID:\x20','axios','is_end','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','getRequestParams','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','userService','getRandomDrawKey','Catch\x20Error\x20','绘制图片失败，此次绘画被拒绝了！','openaiBaseUrl','openaiProxyUrl','modelInfo','queryChatBox','./store','forEach','UploadService','saveChatLog','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','REDIS_USER','../globalConfig/globalConfig.service','../../common/constants/balance.constant','post','text','redis://','unifiedFormattingResponse','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','openaiModel4MaxTokens','openaiTimeoutMs','filter','queryChatPre','defineProperty','parse','gpt-4-vision-preview','buildMessageFromParentMessageId','DeductionKey','queryChatPreType','chatgpt-ai-web','debug','400\x20error','chatPreTypeEntity','\x20模型名称:\x20','assign','delChatBox','13355ZvUqoU','../chatGroup/chatGroup.service','Incorrect\x20API\x20key\x20provided','openaiModel3MaxTokensRes','ceil','ChatBoxEntity','uploadService','服务异常、请重新试试吧！！！','typeorm',',\x20key\x20===>\x20','https://api.openai.com','response','data','../../common/constants/errorMessage.constant','../badwords/badwords.service','size','queryChatPreList','OpenAiErrorCodeMessage','1928385xzFpYA','sendMessageFromBaidu','appId','ChatBoxTypeEntity','childList','AutoreplyService','statusText','toISOString','BadwordsService','openaiModel3MaxTokens','Repository','Please\x20check\x20the\x20back-end\x20console','prompt','badwordsService','config','11187484DscaNn','chatBoxEntity','../globalConfig/config.entity','chatPreEntity','REDIS_HOST','当前模型不是聊天模型',',\x20消耗token:\x20','sendMessageFromZhipu','REDIS_PORT','dall','CHAT_TYPE','preset','getClientIp','ConfigEntity','appEntity','model','validateBalance','env','statusCode','fanyiService','findOne','getTokenCount','weight','16k','getOwnPropertyDescriptor','nineai-chatlog','HttpException','toLowerCase','importDynamic','uploadFile','length','typeId','.png','./chatPre.entity','userBalanceService','../autoreply/autoreply.service','gpt-4-1106','checkBadWords','ModelsService','find','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','./helper','openaiModel3MaxTokens16k','autoreplyService','3606cHMuvN','save','typeInfo','write','from','当前模型key余额已耗尽','非法操作！','./baidu','./zhipu','getCurrentModelKeyInfo','all','slice','proxyUrl','./gptkeys.entity','dall-e\x20draw\x20params:\x20','queryChatBoxType','openaiModel3MaxTokens16kRes','quality','appInfo','gpt-3','openaiModel4MaxTokens32k','PAYMENT_REQUIRED','formatModelToken','conversationId','HttpStatus','stringify','2074539qoqlrY','../fanyi/fanyi.service','getAllKeyList','chatLogService','./chatBox.entity','当前模型调用过于频繁、请重新试试吧！','addOneIfOdd','当前分类下有未处理数据不可移除！','standard','DrawService','deductFromBalance','1106','compileNetwork','../userBalance/userBalance.service','./chatBoxType.entity','imageUrl','getMaxTokenFromModelWithOpenAi','code:\x20','chat-error\x20<----------------------------------------->','DESC','checkAutoReply','getGroupInfoFromId','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','abortController','getConfigs','./../upload/upload.service','queryUserBalance','split','close','configService','@nestjs/typeorm','status','1211802jarcwe','@keyv/redis','globalConfigService','@nestjs/common','maxResponseTokens','systemPreMessage','b64_json','./openai','ChatPreTypeEntity','绘制图片失败，请稍后试试吧！','BAD_REQUEST','user','chat','usage','\x0a\x20Current\x20date:\x20','InjectRepository','includes','ChatgptService','key','__decorate','__param','delChatBoxType','statusText:','1060422CmvTsH','lockKey','modelsService','setChatPreType','Bearer\x20','function','push','缺失必要参数！','checkUserStatus','openai-draw\x20error:\x20','nineStore','GptKeysEntity','draw\x20paompt\x20info\x20<==**==>\x20','UserBalanceService','error:\x20','maxModelTokens','../models/models.service','nestjs-config','gpt-4','default','../chatLog/chatLog.service','message','gptKeysEntity','8xZFios','decorate','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','当前请求已过载、请稍等会儿再试试吧！','setData','delChatPreType','chatSyncFree','ChatLogService','当前模型key已被封禁','assistant','metadata','count','32k','../../common/utils','1541160sBXNCa','saveUseLog','getBaseConfig','detail','update','delete','130sWAWsH','__esModule'];_0x2c3d=function(){return _0x251916;};return _0x2c3d();}let ChatgptService=class ChatgptService{constructor(_0x2163d1,_0x58681e,_0x4716ce,_0x114011,_0x33af08,_0x4e6496,_0x1b0ec3,_0xa877ec,_0x35fa7e,_0x555847,_0x14c7cb,_0x402335,_0x54acd1,_0x10ec18,_0x339f2e,_0x2b99d1,_0x37b351,_0x205d92){const _0x3c1cf9=_0x4734d8;this[_0x3c1cf9(0x2ae)]=_0x2163d1,this['configEntity']=_0x58681e,this['chatBoxTypeEntity']=_0x4716ce,this[_0x3c1cf9(0x21c)]=_0x114011,this[_0x3c1cf9(0x229)]=_0x33af08,this[_0x3c1cf9(0x1f6)]=_0x4e6496,this['chatPreEntity']=_0x1b0ec3,this[_0x3c1cf9(0x27e)]=_0xa877ec,this[_0x3c1cf9(0x23d)]=_0x35fa7e,this[_0x3c1cf9(0x264)]=_0x555847,this[_0x3c1cf9(0x1d4)]=_0x14c7cb,this[_0x3c1cf9(0x200)]=_0x402335,this['badwordsService']=_0x54acd1,this[_0x3c1cf9(0x246)]=_0x10ec18,this[_0x3c1cf9(0x283)]=_0x339f2e,this[_0x3c1cf9(0x22e)]=_0x2b99d1,this['chatGroupService']=_0x37b351,this['modelsService']=_0x205d92,this['nineStore']=null,this['whiteListUser']=[],this['keyPool']={'list3':[],'list4':[]};}async[_0x4734d8(0x1b9)](){const _0x1a88c2=_0x4734d8;let _0x72322=await(0x0,utils_1[_0x1a88c2(0x237)])(_0x1a88c2(0x1f3)),_0x309b64=await(0x0,utils_1['importDynamic'])(_0x1a88c2(0x282)),_0x3f4d22=await(0x0,utils_1[_0x1a88c2(0x237)])('keyv');_0x72322=(_0x72322===null||_0x72322===void 0x0?void 0x0:_0x72322[_0x1a88c2(0x2ab)])?_0x72322[_0x1a88c2(0x2ab)]:_0x72322,_0x309b64=(_0x309b64===null||_0x309b64===void 0x0?void 0x0:_0x309b64['default'])?_0x309b64[_0x1a88c2(0x2ab)]:_0x309b64,_0x3f4d22=(_0x3f4d22===null||_0x3f4d22===void 0x0?void 0x0:_0x3f4d22[_0x1a88c2(0x2ab)])?_0x3f4d22[_0x1a88c2(0x2ab)]:_0x3f4d22;const {ChatGPTAPI:_0x214ff7,ChatGPTError:_0x242c60,ChatGPTUnofficialProxyAPI:_0x4447ce}=_0x72322,_0x19644a=+process['env'][_0x1a88c2(0x223)],_0x472472=process[_0x1a88c2(0x22c)][_0x1a88c2(0x21f)],_0x3df8ff=process[_0x1a88c2(0x22c)]['REDIS_PASSWORD'],_0x1ab8ed=process[_0x1a88c2(0x22c)][_0x1a88c2(0x1e1)],_0x35d584=_0x1a88c2(0x1e6)+(_0x1ab8ed||'')+':'+(_0x3df8ff||'')+'@'+_0x472472+':'+_0x19644a,_0x1f67da=new _0x309b64(_0x35d584),_0x2f473c=new _0x3f4d22({'store':_0x1f67da,'namespace':_0x1a88c2(0x234)});this[_0x1a88c2(0x2a2)]=new store_1[(_0x1a88c2(0x1cb))]({'store':_0x2f473c,'namespace':_0x1a88c2(0x28d)});}async[_0x4734d8(0x1d2)](_0x143575,_0xdc18ac,_0x140f92,_0x4f7fd8=null){const _0x581430=_0x4734d8;var _0x877aef;!_0x4f7fd8&&(_0x4f7fd8=(_0x877aef=await this['modelsService'][_0x581430(0x2bf)]())===null||_0x877aef===void 0x0?void 0x0:_0x877aef[_0x581430(0x1da)]);const {timeout:timeout=0x3c}=_0x140f92,{topN:_0x21ff49,model:_0x459d54}=_0x4f7fd8,{parentMessageId:parentMessageId=0x0}=_0x143575,_0x9330ec=await this[_0x581430(0x283)][_0x581430(0x279)]([_0x581430(0x1ea)]),_0x5536aa=timeout*0x3e8||_0x9330ec||0x64*0x3e8,_0x43fff0={'parentMessageId':parentMessageId,'timeoutMs':+_0x5536aa,'completionParams':{'model':_0x459d54,'temperature':_0x21ff49}};return _0xdc18ac&&(_0x43fff0['systemMessage']=_0xdc18ac),_0x43fff0;}async[_0x4734d8(0x2b5)](_0xe4c183){const _0x370feb=_0x4734d8,_0x549618=await this['modelsService']['getRandomDrawKey'](),_0x1e6e7d=await this[_0x370feb(0x283)]['getConfigs']([_0x370feb(0x286)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x330b91,model:_0x15ab1b}=_0x549618,_0xa2d864=await this[_0x370feb(0x1cd)](_0x549618),{context:_0x3743b6}=await this[_0x370feb(0x2a2)][_0x370feb(0x1f0)](_0xe4c183,{'parentMessageId':'','systemMessage':_0x1e6e7d});try{const _0x289fec=await(0x0,openai_1[_0x370feb(0x1ca)])(_0x3743b6,{'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0x330b91),'model':_0x15ab1b,'proxyUrl':_0xa2d864,'onProgress':null});return _0x289fec===null||_0x289fec===void 0x0?void 0x0:_0x289fec[_0x370feb(0x1e5)];}catch(_0x1b7c31){console[_0x370feb(0x1bb)](_0x370feb(0x2a6),_0x1b7c31);}}async['chatProcess'](_0x4d283d,_0x9128b7,_0x3f2644){const _0x2f7fba=_0x4734d8;var _0x3e3755,_0x5aef1e,_0x1cf3be,_0x3b767c;const _0x56b24c=_0x9128b7[_0x2f7fba(0x278)],{options:options={},appId:_0x28da20,cusromPrompt:_0x2a497d,systemMessage:systemMessage=''}=_0x4d283d;let _0x579a57=systemMessage;const {parentMessageId:_0x2212ce}=options,{prompt:_0x131f47,imageUrl:_0x183330,model:_0x4c3d01}=_0x4d283d,{groupId:_0x2cb97b,usingNetwork:_0x4c79b8}=options,_0x5c730f=await this['chatGroupService'][_0x2f7fba(0x276)](_0x2cb97b),_0x32b2f9=(_0x5c730f===null||_0x5c730f===void 0x0?void 0x0:_0x5c730f[_0x2f7fba(0x21a)])?JSON[_0x2f7fba(0x1ee)](_0x5c730f['config']):await this[_0x2f7fba(0x29a)][_0x2f7fba(0x2bf)](),{keyType:_0x664bbe,model:_0x2109c0,topN:_0x343142,systemMessage:_0x23c537,rounds:_0x52fc27}=_0x32b2f9['modelInfo'];let _0x1cbfef=null;!_0x2a497d?_0x1cbfef=await this[_0x2f7fba(0x29a)]['getCurrentModelKeyInfo'](_0x2109c0):_0x1cbfef=await this[_0x2f7fba(0x29a)][_0x2f7fba(0x1d5)]();if(!_0x1cbfef)throw new common_1[(_0x2f7fba(0x235))](_0x2f7fba(0x1c7),common_1['HttpStatus'][_0x2f7fba(0x28b)]);const {deduct:_0x1a7909,isTokenBased:_0x5f4ea6,tokenFeeRatio:_0x3c2e72,deductType:_0x2077de,key:_0x5a6c0a,secret:_0xad09c8,modelName:_0x48b949,id:_0x481f40,accessToken:_0x57cdd5}=_0x1cbfef;await this[_0x2f7fba(0x1d4)][_0x2f7fba(0x2a0)](_0x9128b7['user']),await this[_0x2f7fba(0x23d)][_0x2f7fba(0x22b)](_0x9128b7,_0x2077de===0x1?'model3':'model4',_0x1a7909),_0x3f2644&&_0x3f2644['setHeader']('Content-type',_0x2f7fba(0x1c8)),await this[_0x2f7fba(0x219)][_0x2f7fba(0x240)](_0x131f47,_0x9128b7[_0x2f7fba(0x28c)]['id']);const _0x40eab7=await this[_0x2f7fba(0x246)][_0x2f7fba(0x275)](_0x131f47);if(_0x40eab7&&_0x3f2644){const _0x596ae3={'message':_0x40eab7,'code':0x1f4};return _0x3f2644['write'](JSON['stringify'](_0x596ae3)),_0x3f2644[_0x2f7fba(0x1c2)]();}if(_0x28da20){const _0x4ada9f=await this[_0x2f7fba(0x229)][_0x2f7fba(0x22f)]({'where':{'id':_0x28da20,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x4ada9f)throw new common_1[(_0x2f7fba(0x235))]('你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',common_1[_0x2f7fba(0x25f)][_0x2f7fba(0x28b)]);_0x4ada9f['preset']&&(_0x579a57=_0x4ada9f[_0x2f7fba(0x226)]);}else{if(_0x2a497d)_0x579a57=systemMessage;else{if(_0x23c537)_0x579a57=_0x23c537;else{const _0x5bacac=new Date()['toISOString']()[_0x2f7fba(0x27c)]('T')[0x0],_0x49c46f=await this[_0x2f7fba(0x283)][_0x2f7fba(0x279)]([_0x2f7fba(0x286)]);_0x579a57=_0x49c46f+(_0x2f7fba(0x28f)+_0x5bacac);}}}let _0x5b1528='';if(_0x4c79b8){_0x5b1528=await(0x0,utils_1[_0x2f7fba(0x26d)])(_0x131f47);const _0x4dbc7e=new Date()[_0x2f7fba(0x213)]()['split']('T')[0x0],_0x1800a8=await this['globalConfigService'][_0x2f7fba(0x279)]([_0x2f7fba(0x286)]);_0x579a57=_0x1800a8+(_0x2f7fba(0x28f)+_0x4dbc7e);}const _0x1a9c32=await this[_0x2f7fba(0x1d2)](options,_0x579a57,_0x1cbfef,_0x32b2f9[_0x2f7fba(0x1da)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x195cd7}=_0x1cbfef;_0x3f2644&&_0x3f2644[_0x2f7fba(0x280)](0xc8);let _0x5625e0=null,_0xd33216=null;try{if(_0x3f2644){let _0x24ca0a=null,_0x289140=![];_0x3f2644['on'](_0x2f7fba(0x27d),async()=>{const _0x313a83=_0x2f7fba;if(_0x289140)return;_0x56b24c['abort']();const _0x4c126b=await(0x0,openai_1[_0x313a83(0x230)])(_0x131f47)||0x0,_0x4e3ca1=await(0x0,openai_1[_0x313a83(0x230)])(_0x24ca0a===null||_0x24ca0a===void 0x0?void 0x0:_0x24ca0a[_0x313a83(0x1e5)])||0x0,_0x456228=_0x4c126b+_0x4e3ca1,_0x216046=(0x0,utils_1[_0x313a83(0x227)])(_0x9128b7);await this[_0x313a83(0x264)][_0x313a83(0x1df)]({'appId':_0x28da20,'curIp':_0x216046,'userId':_0x9128b7[_0x313a83(0x28c)]['id'],'type':balance_constant_1[_0x313a83(0x1f1)][_0x313a83(0x225)],'prompt':_0x131f47,'imageUrl':_0x183330,'activeModel':_0x4c3d01,'answer':'','promptTokens':_0x4c126b,'completionTokens':0x0,'totalTokens':_0x4c126b,'model':_0x2109c0,'role':_0x313a83(0x28c),'groupId':_0x2cb97b,'requestOptions':JSON[_0x313a83(0x260)]({'options':null,'prompt':_0x131f47})}),await this['chatLogService'][_0x313a83(0x1df)]({'appId':_0x28da20,'curIp':_0x216046,'userId':_0x9128b7[_0x313a83(0x28c)]['id'],'type':balance_constant_1[_0x313a83(0x1f1)][_0x313a83(0x225)],'prompt':_0x131f47,'answer':_0x24ca0a===null||_0x24ca0a===void 0x0?void 0x0:_0x24ca0a[_0x313a83(0x1e5)],'promptTokens':_0x4c126b,'completionTokens':_0x4e3ca1,'totalTokens':_0x456228,'model':_0x2109c0,'role':'assistant','groupId':_0x2cb97b,'requestOptions':JSON[_0x313a83(0x260)]({'options':{'model':_0x2109c0,'temperature':_0x343142},'prompt':_0x131f47}),'conversationOptions':JSON[_0x313a83(0x260)]({'conversationId':_0x24ca0a===null||_0x24ca0a===void 0x0?void 0x0:_0x24ca0a[_0x313a83(0x25e)],'model':_0x2109c0,'parentMessageId':_0x24ca0a===null||_0x24ca0a===void 0x0?void 0x0:_0x24ca0a['id'],'temperature':_0x343142})});let _0x5b0d46=_0x1a7909;_0x5f4ea6===!![]&&(_0x5b0d46=Math[_0x313a83(0x1fe)](_0x1a7909*_0x456228/_0x3c2e72)),await this['userBalanceService'][_0x313a83(0x26b)](_0x9128b7['user']['id'],'model'+(_0x2077de===0x1?0x3:0x4),_0x5b0d46,_0x456228);});if(Number(_0x664bbe)===0x1){const {key:_0x1a9613,maxToken:_0x54bb21,maxTokenRes:_0x2820ef,proxyResUrl:_0x5907f5}=await this[_0x2f7fba(0x25d)](_0x1cbfef),{parentMessageId:_0x3d8696,completionParams:_0x407f1f,systemMessage:_0x1c841a}=_0x1a9c32,{model:_0x44fa91,temperature:_0x5c4108}=_0x407f1f,{context:_0x26b515}=await this[_0x2f7fba(0x2a2)][_0x2f7fba(0x1f0)](_0x4c79b8?_0x5b1528:_0x131f47,{'parentMessageId':_0x3d8696,'systemMessage':_0x1c841a,'maxModelToken':_0x54bb21,'maxResponseTokens':_0x2820ef,'maxRounds':(0x0,helper_1[_0x2f7fba(0x267)])(_0x52fc27),'imageUrl':_0x183330,'activeModel':_0x4c3d01});let _0x3ecac9=!![];_0x5625e0=await(0x0,openai_1[_0x2f7fba(0x1ca)])(_0x26b515,{'maxToken':_0x54bb21,'maxTokenRes':_0x2820ef,'apiKey':_0x5a6c0a,'model':_0x44fa91,'prompt':_0x131f47,'activeModel':_0x4c3d01,'imageUrl':_0x183330,'temperature':_0x5c4108,'proxyUrl':_0x5907f5,'onProgress':_0x3aba72=>{const _0xe78e25=_0x2f7fba;_0x3f2644[_0xe78e25(0x24a)](_0x3ecac9?JSON[_0xe78e25(0x260)](_0x3aba72):'\x0a'+JSON[_0xe78e25(0x260)](_0x3aba72)),_0x24ca0a=_0x3aba72,_0x3ecac9=![];}},this[_0x2f7fba(0x200)]),_0x289140=!![];}if(Number(_0x664bbe)===0x2){let _0x292fc0=!![];const {context:_0x2a3a52}=await this['nineStore']['buildMessageFromParentMessageId'](_0x4c79b8?_0x5b1528:_0x131f47,{'parentMessageId':_0x2212ce,'maxRounds':(0x0,helper_1[_0x2f7fba(0x267)])(_0x52fc27)});_0x5625e0=await(0x0,baidu_1[_0x2f7fba(0x20d)])(_0x4c79b8?_0x5b1528:_0x2a3a52,{'temperature':_0x343142,'accessToken':_0x57cdd5,'model':_0x2109c0,'onProgress':_0xbcb91=>{const _0x2438df=_0x2f7fba;_0x3f2644[_0x2438df(0x24a)](_0x292fc0?JSON[_0x2438df(0x260)](_0xbcb91):'\x0a'+JSON[_0x2438df(0x260)](_0xbcb91)),_0x292fc0=![],_0x24ca0a=_0xbcb91;}}),_0x289140=!![];}if(Number(_0x664bbe)===0x3){let _0x5899d5=!![];const {context:_0x43dce5}=await this[_0x2f7fba(0x2a2)][_0x2f7fba(0x1f0)](_0x4c79b8?_0x5b1528:_0x131f47,{'parentMessageId':_0x2212ce,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x52fc27)});_0x5625e0=await(0x0,zhipu_1[_0x2f7fba(0x222)])(_0x4c79b8?_0x5b1528:_0x43dce5,{'temperature':_0x343142,'key':_0x195cd7,'model':_0x2109c0,'onProgress':_0x6c692=>{const _0x5aea04=_0x2f7fba;_0x3f2644[_0x5aea04(0x24a)](_0x5899d5?JSON['stringify'](_0x6c692):'\x0a'+JSON[_0x5aea04(0x260)](_0x6c692)),_0x5899d5=![],_0x24ca0a=_0x6c692;}}),_0x289140=!![];}const _0x5df853={'id':this[_0x2f7fba(0x2a2)]['getUuid'](),'text':_0x131f47,'role':_0x2f7fba(0x28c),'name':undefined,'usage':null,'imageUrl':_0x183330,'activeModel':_0x4c3d01,'parentMessageId':_0x2212ce,'conversationId':_0x5625e0===null||_0x5625e0===void 0x0?void 0x0:_0x5625e0[_0x2f7fba(0x25e)]};_0xd33216={'model':_0x2109c0,'parentMessageId':_0x2212ce},await this['nineStore'][_0x2f7fba(0x2b3)](_0x5df853);const _0x1cdf1e={'id':_0x5625e0['id'],'text':_0x5625e0[_0x2f7fba(0x1e5)],'role':_0x2f7fba(0x2b8),'name':undefined,'usage':_0x5625e0===null||_0x5625e0===void 0x0?void 0x0:_0x5625e0['usage'],'imageUrl':_0x183330,'parentMessageId':_0x5df853['id'],'conversationId':_0x5625e0===null||_0x5625e0===void 0x0?void 0x0:_0x5625e0[_0x2f7fba(0x25e)]};await this[_0x2f7fba(0x2a2)][_0x2f7fba(0x2b3)](_0x1cdf1e),_0xd33216={'model':_0x2109c0,'parentMessageId':_0x5df853['id']};}else{const {key:_0x5013e9,maxToken:_0x216a54,maxTokenRes:_0x40bc39,proxyResUrl:_0x25cad8}=await this[_0x2f7fba(0x25d)](_0x1cbfef),{parentMessageId:_0x5a164c,completionParams:_0x2baf55,systemMessage:_0xace321}=_0x1a9c32,{model:_0x10be9a,temperature:_0x59b0ae}=_0x2baf55,{context:_0x3f2f47}=await this[_0x2f7fba(0x2a2)]['buildMessageFromParentMessageId'](_0x4c79b8?_0x5b1528:_0x131f47,{'parentMessageId':_0x5a164c,'systemMessage':_0xace321,'maxRounds':(0x0,helper_1[_0x2f7fba(0x267)])(_0x52fc27)});_0x5625e0=await(0x0,openai_1[_0x2f7fba(0x1ca)])(_0x3f2f47,{'apiKey':_0x5a6c0a,'model':_0x10be9a,'temperature':_0x59b0ae,'proxyUrl':_0x25cad8,'onProgress':null,'prompt':_0x131f47});}let _0x1f9931=null,_0x7e78e=null;_0x2109c0[_0x2f7fba(0x291)](_0x2f7fba(0x224))?_0x1f9931=((_0x3e3755=_0x5625e0[_0x2f7fba(0x2c0)])===null||_0x3e3755===void 0x0?void 0x0:_0x3e3755[_0x2f7fba(0x28e)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x7e78e=await(0x0,helper_1[_0x2f7fba(0x1e7)])(_0x664bbe,_0x5625e0,_0xd33216);const {prompt_tokens:_0x202dcc,completion_tokens:_0x2e94fa,total_tokens:_0x12265b}=_0x2109c0[_0x2f7fba(0x291)](_0x2f7fba(0x224))?_0x1f9931:_0x7e78e[_0x2f7fba(0x28e)];let _0x102a9e=_0x1a7909;_0x5f4ea6===!![]&&(_0x102a9e=Math[_0x2f7fba(0x1fe)](_0x1a7909*_0x12265b/_0x3c2e72));await this[_0x2f7fba(0x23d)][_0x2f7fba(0x26b)](_0x9128b7['user']['id'],_0x2f7fba(0x22a)+(_0x2077de===0x1?0x3:0x4),_0x102a9e,_0x12265b),await this[_0x2f7fba(0x29a)][_0x2f7fba(0x2be)](_0x481f40,_0x12265b);const _0x8da9d=(0x0,utils_1[_0x2f7fba(0x227)])(_0x9128b7);await this[_0x2f7fba(0x264)][_0x2f7fba(0x1df)]({'appId':_0x28da20,'curIp':_0x8da9d,'userId':_0x9128b7[_0x2f7fba(0x28c)]['id'],'type':balance_constant_1[_0x2f7fba(0x1f1)]['CHAT_TYPE'],'prompt':_0x131f47,'imageUrl':_0x183330,'activeModel':_0x4c3d01,'answer':'','promptTokens':_0x202dcc,'completionTokens':0x0,'totalTokens':_0x12265b,'model':_0x2109c0,'role':'user','groupId':_0x2cb97b,'requestOptions':JSON[_0x2f7fba(0x260)]({'options':null,'prompt':_0x131f47})}),await this[_0x2f7fba(0x264)][_0x2f7fba(0x1df)]({'appId':_0x28da20,'curIp':_0x8da9d,'userId':_0x9128b7[_0x2f7fba(0x28c)]['id'],'type':balance_constant_1[_0x2f7fba(0x1f1)][_0x2f7fba(0x225)],'prompt':_0x131f47,'imageUrl':_0x5625e0===null||_0x5625e0===void 0x0?void 0x0:_0x5625e0[_0x2f7fba(0x270)],'answer':_0x5625e0[_0x2f7fba(0x1e5)],'promptTokens':_0x202dcc,'completionTokens':_0x2e94fa,'totalTokens':_0x12265b,'model':_0x2109c0,'role':_0x2f7fba(0x2b8),'groupId':_0x2cb97b,'requestOptions':JSON[_0x2f7fba(0x260)]({'options':{'model':_0x2109c0,'temperature':_0x343142},'prompt':_0x131f47}),'conversationOptions':JSON[_0x2f7fba(0x260)]({'conversationId':_0x5625e0[_0x2f7fba(0x25e)],'model':_0x2109c0,'parentMessageId':_0x5625e0['id'],'temperature':_0x343142})}),common_1['Logger'][_0x2f7fba(0x1f4)](_0x2f7fba(0x1ce)+_0x9128b7[_0x2f7fba(0x28c)]['id']+_0x2f7fba(0x1f7)+_0x48b949+'-'+_0x4c3d01+_0x2f7fba(0x221)+_0x12265b+',\x20消耗积分：\x20'+_0x102a9e,_0x2f7fba(0x292));const _0x2936ee=await this['userBalanceService'][_0x2f7fba(0x27b)](_0x9128b7['user']['id']);return _0x5625e0['userBanance']=Object['assign']({},_0x2936ee),_0x5625e0[_0x2f7fba(0x1c6)]&&(_0x5625e0[_0x2f7fba(0x1c6)]=''),_0x5625e0[_0x2f7fba(0x1d0)]=!![],_0x3f2644?_0x3f2644['write']('\x0a'+JSON[_0x2f7fba(0x260)](_0x5625e0)):_0x5625e0[_0x2f7fba(0x1e5)];}catch(_0x459162){console[_0x2f7fba(0x1bb)](_0x2f7fba(0x273),_0x5a6c0a,_0x459162);const _0x2177a5=(_0x459162===null||_0x459162===void 0x0?void 0x0:_0x459162['statusCode'])||0x190,_0x356a28=((_0x5aef1e=_0x459162===null||_0x459162===void 0x0?void 0x0:_0x459162['response'])===null||_0x5aef1e===void 0x0?void 0x0:_0x5aef1e[_0x2f7fba(0x280)])||(_0x459162===null||_0x459162===void 0x0?void 0x0:_0x459162[_0x2f7fba(0x22d)])||0x190;console['log']('chat-error-detail\x20\x20<----------------------------------------->',_0x2f7fba(0x272),_0x2177a5,_0x2f7fba(0x2ad),_0x459162===null||_0x459162===void 0x0?void 0x0:_0x459162['message'],_0x2f7fba(0x297),(_0x1cf3be=_0x459162===null||_0x459162===void 0x0?void 0x0:_0x459162[_0x2f7fba(0x205)])===null||_0x1cf3be===void 0x0?void 0x0:_0x1cf3be[_0x2f7fba(0x212)],_0x2f7fba(0x280),(_0x3b767c=_0x459162===null||_0x459162===void 0x0?void 0x0:_0x459162[_0x2f7fba(0x205)])===null||_0x3b767c===void 0x0?void 0x0:_0x3b767c[_0x2f7fba(0x280)]);if(_0x459162['status']&&_0x459162[_0x2f7fba(0x280)]===0x192){const _0x20e0d0={'message':_0x2f7fba(0x1d6)+_0x459162[_0x2f7fba(0x2ad)],'code':0x192};if(_0x3f2644)return _0x3f2644['write'](JSON[_0x2f7fba(0x260)](_0x20e0d0));else throw new common_1[(_0x2f7fba(0x235))](_0x459162[_0x2f7fba(0x2ad)],common_1[_0x2f7fba(0x25f)][_0x2f7fba(0x25c)]);}if(!_0x356a28){if(_0x3f2644)return _0x3f2644[_0x2f7fba(0x24a)](JSON[_0x2f7fba(0x260)]({'message':_0x459162[_0x2f7fba(0x2ad)],'code':0x1f4}));else throw new common_1['HttpException'](_0x459162[_0x2f7fba(0x2ad)],common_1[_0x2f7fba(0x25f)]['BAD_REQUEST']);}let _0x351f4f=errorMessage_constant_1[_0x2f7fba(0x20b)][_0x356a28]?errorMessage_constant_1[_0x2f7fba(0x20b)][_0x356a28]:_0x2f7fba(0x201);(_0x459162===null||_0x459162===void 0x0?void 0x0:_0x459162[_0x2f7fba(0x2ad)]['includes'](_0x2f7fba(0x277)))&&Number(_0x664bbe)===0x1&&(await this['modelsService'][_0x2f7fba(0x299)](_0x481f40,_0x2f7fba(0x2b1),-0x1),_0x351f4f=_0x2f7fba(0x2b7));(_0x459162===null||_0x459162===void 0x0?void 0x0:_0x459162['statusCode'])===0x1ad&&_0x459162[_0x2f7fba(0x2ad)][_0x2f7fba(0x291)]('billing')&&Number(_0x664bbe)===0x1&&(await this[_0x2f7fba(0x29a)][_0x2f7fba(0x299)](_0x481f40,'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x351f4f=_0x2f7fba(0x24c));(_0x459162===null||_0x459162===void 0x0?void 0x0:_0x459162[_0x2f7fba(0x22d)])===0x1ad&&(_0x459162===null||_0x459162===void 0x0?void 0x0:_0x459162[_0x2f7fba(0x212)])===_0x2f7fba(0x1c0)&&(_0x351f4f=_0x2f7fba(0x266));(_0x459162===null||_0x459162===void 0x0?void 0x0:_0x459162[_0x2f7fba(0x22d)])===0x191&&_0x459162[_0x2f7fba(0x2ad)]['includes'](_0x2f7fba(0x1fc))&&Number(_0x664bbe)===0x1&&(await this[_0x2f7fba(0x29a)][_0x2f7fba(0x299)](_0x481f40,_0x2f7fba(0x1be),-0x2),_0x351f4f=_0x2f7fba(0x243));(_0x459162===null||_0x459162===void 0x0?void 0x0:_0x459162[_0x2f7fba(0x22d)])===0x194&&_0x459162['message'][_0x2f7fba(0x291)](_0x2f7fba(0x1d3))&&Number(_0x664bbe)===0x1&&(await this['modelsService'][_0x2f7fba(0x299)](_0x481f40,_0x2f7fba(0x220),-0x4),_0x351f4f=_0x2f7fba(0x1d1));_0x2177a5===0x190&&console['log'](_0x2f7fba(0x1f5),_0x459162,_0x459162['message']);const _0x3d612c={'message':_0x351f4f||_0x2f7fba(0x217),'code':_0x2177a5===0x191?0x190:_0x2177a5||0x1f4};if(_0x3f2644)return _0x3f2644['write'](JSON[_0x2f7fba(0x260)](_0x3d612c));else throw new common_1[(_0x2f7fba(0x235))](_0x3d612c['message'],common_1['HttpStatus']['BAD_REQUEST']);}finally{_0x3f2644&&_0x3f2644[_0x2f7fba(0x1c2)]();}}async['draw'](_0x2b1ed5,_0xb9a9f6){const _0x62b440=_0x4734d8;var _0x4b19bf,_0x4aa100,_0x1642e2,_0xab4597;await this[_0x62b440(0x219)][_0x62b440(0x240)](_0x2b1ed5[_0x62b440(0x218)],_0xb9a9f6[_0x62b440(0x28c)]['id']),await this[_0x62b440(0x1d4)][_0x62b440(0x2a0)](_0xb9a9f6[_0x62b440(0x28c)]);const _0x55b712=(_0x2b1ed5===null||_0x2b1ed5===void 0x0?void 0x0:_0x2b1ed5[_0x62b440(0x258)])==='hd'?0x4:0x2;await this['userBalanceService']['validateBalance'](_0xb9a9f6,'mjDraw',_0x55b712);let _0x58c586=[];const _0x3d2d77=await this[_0x62b440(0x29a)][_0x62b440(0x250)](_0x62b440(0x1c4)),_0x3f7198=_0x3d2d77===null||_0x3d2d77===void 0x0?void 0x0:_0x3d2d77['id'],{key:_0x436183,proxyResUrl:_0x1984ae}=await this['formatModelToken'](_0x3d2d77);common_1['Logger']['log'](_0x62b440(0x2a4)+_0x2b1ed5['prompt']+_0x62b440(0x203)+_0x436183,_0x62b440(0x26a));try{const _0x46543c=_0x1984ae+'/v1/images/generations',_0x1a0c02=Object[_0x62b440(0x1f8)](Object['assign']({},_0x2b1ed5),{'model':_0x62b440(0x1c4)});console[_0x62b440(0x1bb)](_0x62b440(0x255),_0x1a0c02);const _0x2e4aae=await axios_1[_0x62b440(0x2ab)][_0x62b440(0x1e4)](_0x46543c,Object[_0x62b440(0x1f8)](Object[_0x62b440(0x1f8)]({},_0x1a0c02),{'response_format':_0x62b440(0x287)}),{'headers':{'Authorization':_0x62b440(0x29c)+_0x436183}});_0x58c586=_0x2e4aae[_0x62b440(0x206)][_0x62b440(0x206)];const _0x1580a4=[];for(const _0x121fb5 of _0x58c586){const _0x302c62=uuid['v4']()[_0x62b440(0x252)](0x0,0xa)+_0x62b440(0x23b),_0x2758a1=Buffer[_0x62b440(0x24b)](_0x121fb5[_0x62b440(0x287)],'base64');_0x1580a4['push'](this[_0x62b440(0x200)][_0x62b440(0x238)]({'filename':_0x302c62,'buffer':_0x2758a1}));}const _0x4166af=await Promise[_0x62b440(0x251)](_0x1580a4);await this['userBalanceService'][_0x62b440(0x26b)](_0xb9a9f6[_0x62b440(0x28c)]['id'],'mjDraw',(_0x1a0c02===null||_0x1a0c02===void 0x0?void 0x0:_0x1a0c02[_0x62b440(0x258)])===_0x62b440(0x269)?0x2:0x4,_0x55b712);const _0x15303f=(0x0,utils_1[_0x62b440(0x227)])(_0xb9a9f6),_0x55066d=[],_0x5abdd2=await this[_0x62b440(0x200)]['getUploadType'](),[_0x5bf0f6,_0x186e03]=_0x2b1ed5[_0x62b440(0x209)]['split']('x');return _0x4166af['forEach'](_0x2648d3=>{const _0x3c4de0=_0x62b440;_0x55066d[_0x3c4de0(0x29e)](this['chatLogService'][_0x3c4de0(0x1df)]({'curIp':_0x15303f,'userId':_0xb9a9f6[_0x3c4de0(0x28c)]['id'],'type':balance_constant_1['DeductionKey']['PAINT_TYPE'],'prompt':_0x2b1ed5[_0x3c4de0(0x218)],'answer':_0x2648d3,'fileInfo':JSON['stringify']({'cosType':_0x5abdd2,'width':_0x5bf0f6,'height':_0x186e03,'cosUrl':_0x2648d3}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x3c4de0(0x1c4)}));}),await Promise['all'](_0x55066d),_0x4166af;}catch(_0x429d63){const _0x531e56=((_0x4b19bf=_0x429d63===null||_0x429d63===void 0x0?void 0x0:_0x429d63['response'])===null||_0x4b19bf===void 0x0?void 0x0:_0x4b19bf['status'])||0x1f4;console[_0x62b440(0x1bb)](_0x62b440(0x2a1),JSON[_0x62b440(0x260)](_0x429d63),_0x436183,_0x531e56);const _0xb80d0a=(_0xab4597=(_0x1642e2=(_0x4aa100=_0x429d63===null||_0x429d63===void 0x0?void 0x0:_0x429d63[_0x62b440(0x205)])===null||_0x4aa100===void 0x0?void 0x0:_0x4aa100[_0x62b440(0x206)])===null||_0x1642e2===void 0x0?void 0x0:_0x1642e2['error'])===null||_0xab4597===void 0x0?void 0x0:_0xab4597[_0x62b440(0x2ad)];if(_0x531e56===0x1ad)throw new common_1[(_0x62b440(0x235))](_0x62b440(0x2b2),common_1[_0x62b440(0x25f)][_0x62b440(0x28b)]);if(_0x531e56===0x190&&_0xb80d0a[_0x62b440(0x291)](_0x62b440(0x1e0)))throw new common_1[(_0x62b440(0x235))](_0x62b440(0x1e8),common_1[_0x62b440(0x25f)][_0x62b440(0x28b)]);if(_0x531e56===0x190&&_0xb80d0a['includes']('Billing\x20hard\x20limit\x20has\x20been\x20reached')){await this[_0x62b440(0x29a)]['lockKey'](_0x3f7198,_0x62b440(0x2b1),-0x1);throw new common_1[(_0x62b440(0x235))](_0x62b440(0x1c5),common_1['HttpStatus'][_0x62b440(0x28b)]);}if(_0x531e56===0x1f4)throw new common_1[(_0x62b440(0x235))]('绘制图片失败，请检查你的提示词是否有非法描述！',common_1['HttpStatus'][_0x62b440(0x28b)]);if(_0x531e56===0x191)throw new common_1[(_0x62b440(0x235))](_0x62b440(0x1d7),common_1[_0x62b440(0x25f)][_0x62b440(0x28b)]);throw new common_1[(_0x62b440(0x235))](_0x62b440(0x28a),common_1[_0x62b440(0x25f)][_0x62b440(0x28b)]);}}async[_0x4734d8(0x263)](){const _0x135b29=_0x4734d8,_0x40bf33=await this[_0x135b29(0x2ae)]['find']({'where':{'status':0x1},'select':['id',_0x135b29(0x293),_0x135b29(0x231),_0x135b29(0x22a),_0x135b29(0x2a7),_0x135b29(0x285),_0x135b29(0x1d9),_0x135b29(0x1ea)]}),_0x5de6a7=_0x40bf33[_0x135b29(0x1eb)](_0x5a12fc=>_0x5a12fc[_0x135b29(0x22a)][_0x135b29(0x291)](_0x135b29(0x25a))),_0x74fbc9=_0x40bf33[_0x135b29(0x1eb)](_0x1e2bfe=>_0x1e2bfe[_0x135b29(0x22a)]['includes'](_0x135b29(0x2aa)));this['keyPool']={'list3':_0x5de6a7,'list4':_0x74fbc9};}async[_0x4734d8(0x1cd)](_0x5ac3d7){const _0x1a6b30=_0x4734d8,_0x515e07=await this[_0x1a6b30(0x283)]['getConfigs']([_0x1a6b30(0x1d8)]);return(_0x5ac3d7===null||_0x5ac3d7===void 0x0?void 0x0:_0x5ac3d7[_0x1a6b30(0x253)])||_0x515e07||_0x1a6b30(0x204);}async[_0x4734d8(0x25d)](_0x4774c0){const _0x211341=_0x4734d8,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this['globalConfigService'][_0x211341(0x279)]([_0x211341(0x215),_0x211341(0x1fd),_0x211341(0x245),_0x211341(0x257),_0x211341(0x1e9),'openaiModel4MaxTokensRes',_0x211341(0x25b),'openaiModel4MaxTokens32kRes',_0x211341(0x1d8)]);let _0x5e4642=null,_0x5b8976=null,_0x5743db=null,{model:_0x3a2660,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x9d125d}=_0x4774c0;return _0x3a2660['toLowerCase']()[_0x211341(0x291)](_0x211341(0x2aa))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x5b8976>=0x1000&&(maxModelTokens=0x1000),_0x5e4642=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x5b8976=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x3a2660[_0x211341(0x236)]()[_0x211341(0x291)](_0x211341(0x2bb))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x5b8976>=0x4000&&(maxModelTokens=0x4000),_0x5e4642=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x5b8976=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x3a2660['toLowerCase']()['includes']('1106')&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x5b8976>=0x1000&&(maxModelTokens=0x1000),_0x5e4642=maxModelTokens||0x3ffc,_0x5b8976=maxResponseTokens||0x1000)),_0x3a2660[_0x211341(0x236)]()[_0x211341(0x291)](_0x211341(0x25a))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x5b8976>=0x7d0&&(maxModelTokens=0x7d0),_0x5e4642=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x5b8976=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x3a2660[_0x211341(0x236)]()[_0x211341(0x291)](_0x211341(0x232))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x5b8976>=0x2000&&(maxModelTokens=0x2000),_0x5e4642=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x5b8976=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x3a2660[_0x211341(0x236)]()[_0x211341(0x291)](_0x211341(0x26c))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x5b8976>=0x1000&&(maxModelTokens=0x1000),_0x5e4642=maxModelTokens||0x4000,_0x5b8976=maxResponseTokens||0x1000)),_0x5743db=proxyUrl||openaiBaseUrl||_0x211341(0x204),_0x5b8976>=_0x5e4642&&(_0x5b8976=Math['floor'](_0x5e4642/0x2)),{'key':_0x9d125d,'maxToken':_0x5e4642,'maxTokenRes':_0x5b8976,'proxyResUrl':_0x5743db};}async['setChatBoxType'](_0x4e93a9,_0x143a46){const _0x26755c=_0x4734d8;try{const {name:_0xf18e3b,icon:_0x1cdeab,order:_0x46da65,id:_0x4d8b5d,status:_0x3ba385}=_0x143a46;return _0x4d8b5d?await this[_0x26755c(0x1c3)][_0x26755c(0x2c1)]({'id':_0x4d8b5d},{'name':_0xf18e3b,'icon':_0x1cdeab,'order':_0x46da65,'status':_0x3ba385}):await this['chatBoxTypeEntity'][_0x26755c(0x248)]({'name':_0xf18e3b,'icon':_0x1cdeab,'order':_0x46da65,'status':_0x3ba385});}catch(_0x15c8d6){console[_0x26755c(0x1bb)](_0x26755c(0x2a6),_0x15c8d6);}}async[_0x4734d8(0x296)](_0x4dd8d3,_0x1e748f){const _0x215b2e=_0x4734d8,{id:_0x55df80}=_0x1e748f;if(!_0x55df80)throw new common_1[(_0x215b2e(0x235))](_0x215b2e(0x24d),common_1[_0x215b2e(0x25f)][_0x215b2e(0x28b)]);const _0x3262a3=await this[_0x215b2e(0x21c)][_0x215b2e(0x2ba)]({'where':{'typeId':_0x55df80}});if(_0x3262a3)throw new common_1['HttpException'](_0x215b2e(0x268),common_1['HttpStatus'][_0x215b2e(0x28b)]);return await this[_0x215b2e(0x1c3)]['delete']({'id':_0x55df80});}async[_0x4734d8(0x256)](){const _0x3191f2=_0x4734d8;return await this['chatBoxTypeEntity'][_0x3191f2(0x242)]({'order':{'order':_0x3191f2(0x274)}});}async['setChatBox'](_0xf1690e,_0xe53eab){const _0x4face3=_0x4734d8,{title:_0x209ae7,prompt:_0x2a2e86,appId:_0x26f27c,order:_0x2aee2b,status:_0x3022a5,typeId:_0x62a564,id:_0x398dbf,url:_0x43cbee}=_0xe53eab;if(!_0x62a564)throw new common_1[(_0x4face3(0x235))](_0x4face3(0x29f),common_1[_0x4face3(0x25f)][_0x4face3(0x28b)]);try{const _0x487503={'title':_0x209ae7,'order':_0x2aee2b,'status':_0x3022a5,'typeId':_0x62a564,'url':_0x43cbee};return _0x487503[_0x4face3(0x20e)]=_0x26f27c||0x0,_0x487503[_0x4face3(0x218)]=_0x2a2e86||'',_0x398dbf?await this[_0x4face3(0x21c)][_0x4face3(0x2c1)]({'id':_0x398dbf},_0x487503):await this[_0x4face3(0x21c)][_0x4face3(0x248)](_0x487503);}catch(_0x233cf9){console['log'](_0x4face3(0x2a6),_0x233cf9);}}async[_0x4734d8(0x1f9)](_0x506cb1,_0x80f9bd){const _0x3b6369=_0x4734d8,{id:_0x26c207}=_0x80f9bd;if(!_0x26c207)throw new common_1[(_0x3b6369(0x235))](_0x3b6369(0x24d),common_1[_0x3b6369(0x25f)][_0x3b6369(0x28b)]);return await this['chatBoxEntity'][_0x3b6369(0x2c2)]({'id':_0x26c207});}async[_0x4734d8(0x1db)](){const _0x4955d5=_0x4734d8,_0xc16e29=await this[_0x4955d5(0x21c)]['find']({'order':{'order':_0x4955d5(0x274)}}),_0x5c0a0f=[...new Set(_0xc16e29[_0x4955d5(0x1c9)](_0x5428e6=>_0x5428e6[_0x4955d5(0x23a)]))],_0x4429ff=[...new Set(_0xc16e29[_0x4955d5(0x1c9)](_0x106c17=>_0x106c17[_0x4955d5(0x20e)]))],_0x5c4505=await this[_0x4955d5(0x1c3)][_0x4955d5(0x242)]({'where':{'id':(0x0,typeorm_1['In'])(_0x5c0a0f)}}),_0x46d499=await this['appEntity'][_0x4955d5(0x242)]({'where':{'id':(0x0,typeorm_1['In'])(_0x4429ff)}});return _0xc16e29[_0x4955d5(0x1c9)](_0x3987e3=>{const _0x47948e=_0x4955d5,{typeId:_0x5b6900,appId:_0x5abe94}=_0x3987e3;return _0x3987e3[_0x47948e(0x249)]=_0x5c4505['find'](_0x1696a1=>_0x1696a1['id']===_0x5b6900),_0x3987e3[_0x47948e(0x259)]=_0x46d499[_0x47948e(0x242)](_0xfed818=>_0xfed818['id']===_0x5abe94),_0x3987e3;});}async[_0x4734d8(0x1cc)](){const _0x363f23=_0x4734d8,_0x2034fa=await this[_0x363f23(0x1c3)][_0x363f23(0x242)]({'order':{'order':_0x363f23(0x274)},'where':{'status':!![]}}),_0x1b3283=await this[_0x363f23(0x21c)][_0x363f23(0x242)]({'where':{'status':!![]}}),_0x2bf9e8=[...new Set(_0x1b3283['map'](_0x583904=>_0x583904[_0x363f23(0x20e)]))],_0x11f5e8=await this[_0x363f23(0x229)][_0x363f23(0x242)]({'where':{'id':(0x0,typeorm_1['In'])(_0x2bf9e8)}});return _0x1b3283[_0x363f23(0x1dd)](_0x3dd133=>{const _0x4715ed=_0x363f23,_0x1ee762=_0x11f5e8['find'](_0x5cb376=>_0x5cb376['id']===_0x3dd133[_0x4715ed(0x20e)]);return _0x3dd133['coverImg']=_0x1ee762===null||_0x1ee762===void 0x0?void 0x0:_0x1ee762[_0x4715ed(0x1bf)],_0x3dd133;}),_0x2034fa[_0x363f23(0x1c9)](_0x232e7c=>{const _0x22036d=_0x363f23;return _0x232e7c[_0x22036d(0x210)]=_0x1b3283[_0x22036d(0x1eb)](_0x268501=>_0x268501[_0x22036d(0x23a)]===_0x232e7c['id']&&_0x268501[_0x22036d(0x280)]),_0x232e7c;});}async[_0x4734d8(0x29b)](_0x73a3e,_0x425569){const _0x28b2b8=_0x4734d8;try{const {name:_0x48341c,icon:_0x2fa75d,order:_0x45ede0,id:_0x4dc4a6,status:_0x3b28bd}=_0x425569;return _0x4dc4a6?await this[_0x28b2b8(0x1f6)]['update']({'id':_0x4dc4a6},{'name':_0x48341c,'icon':_0x2fa75d,'order':_0x45ede0,'status':_0x3b28bd}):await this['chatPreTypeEntity'][_0x28b2b8(0x248)]({'name':_0x48341c,'icon':_0x2fa75d,'order':_0x45ede0,'status':_0x3b28bd});}catch(_0x4af2d5){console['log'](_0x28b2b8(0x2a6),_0x4af2d5);}}async[_0x4734d8(0x2b4)](_0x311eb2,_0x5929f7){const _0xef7693=_0x4734d8,{id:_0x36935b}=_0x5929f7;if(!_0x36935b)throw new common_1[(_0xef7693(0x235))]('非法操作！',common_1[_0xef7693(0x25f)][_0xef7693(0x28b)]);const _0x151ff0=await this[_0xef7693(0x21c)][_0xef7693(0x2ba)]({'where':{'typeId':_0x36935b}});if(_0x151ff0)throw new common_1[(_0xef7693(0x235))](_0xef7693(0x268),common_1[_0xef7693(0x25f)][_0xef7693(0x28b)]);return await this[_0xef7693(0x1f6)][_0xef7693(0x2c2)]({'id':_0x36935b});}async[_0x4734d8(0x1f2)](){const _0x3eb17c=_0x4734d8;return await this[_0x3eb17c(0x1f6)][_0x3eb17c(0x242)]({'order':{'order':_0x3eb17c(0x274)}});}async['setChatPre'](_0x2af393,_0x3bf350){const _0xb0e023=_0x4734d8,{title:_0x18d432,prompt:_0x4e2705,appId:_0x4009cb,order:_0x498a98,status:_0x251798,typeId:_0x58dee7,id:_0x24d54d,url:_0x5c5274}=_0x3bf350;if(!_0x58dee7)throw new common_1[(_0xb0e023(0x235))](_0xb0e023(0x29f),common_1[_0xb0e023(0x25f)][_0xb0e023(0x28b)]);try{const _0x4dbac9={'title':_0x18d432,'prompt':_0x4e2705,'order':_0x498a98,'status':_0x251798,'typeId':_0x58dee7,'url':_0x5c5274};return _0x24d54d?await this[_0xb0e023(0x21e)][_0xb0e023(0x2c1)]({'id':_0x24d54d},_0x4dbac9):await this[_0xb0e023(0x21e)]['save'](_0x4dbac9);}catch(_0x348086){console[_0xb0e023(0x1bb)]('error:\x20',_0x348086);}}async[_0x4734d8(0x1bc)](_0x5e0aa4,_0xcb5b19){const _0x3a9631=_0x4734d8,{id:_0x1703bf}=_0xcb5b19;if(!_0x1703bf)throw new common_1['HttpException'](_0x3a9631(0x24d),common_1[_0x3a9631(0x25f)][_0x3a9631(0x28b)]);return await this[_0x3a9631(0x21e)][_0x3a9631(0x2c2)]({'id':_0x1703bf});}async[_0x4734d8(0x1ec)](){const _0x2bf693=_0x4734d8,_0x2f3eea=await this[_0x2bf693(0x21e)][_0x2bf693(0x242)]({'order':{'order':_0x2bf693(0x274)}}),_0x3fdb22=[...new Set(_0x2f3eea['map'](_0x542be8=>_0x542be8[_0x2bf693(0x23a)]))],_0x5a59fb=await this[_0x2bf693(0x1f6)][_0x2bf693(0x242)]({'where':{'id':(0x0,typeorm_1['In'])(_0x3fdb22)}});return _0x2f3eea[_0x2bf693(0x1c9)](_0x1c0b47=>{const _0x1a3c48=_0x2bf693,{typeId:_0x281577,appId:_0x4e166a}=_0x1c0b47;return _0x1c0b47[_0x1a3c48(0x249)]=_0x5a59fb['find'](_0x95e1d7=>_0x95e1d7['id']===_0x281577),_0x1c0b47;});}async[_0x4734d8(0x20a)](){const _0x4f6a7c=_0x4734d8,_0x2bed38=await this[_0x4f6a7c(0x1f6)][_0x4f6a7c(0x242)]({'order':{'order':_0x4f6a7c(0x274)},'where':{'status':!![]}}),_0x374313=await this['chatPreEntity'][_0x4f6a7c(0x242)]({'where':{'status':!![]}});return _0x2bed38[_0x4f6a7c(0x1c9)](_0x6120d7=>{const _0x17ce84=_0x4f6a7c;return _0x6120d7[_0x17ce84(0x210)]=_0x374313[_0x17ce84(0x1eb)](_0x498cbc=>_0x498cbc['typeId']===_0x6120d7['id']&&_0x498cbc[_0x17ce84(0x280)]),_0x6120d7;});}async[_0x4734d8(0x271)](_0x493fba,_0x39f62c,_0xffa96a){const _0x5a49cb=_0x4734d8;let _0x43c786=0x1000,_0x5d3a1a=0x800;return _0x493fba[_0x5a49cb(0x236)]()[_0x5a49cb(0x291)](_0x5a49cb(0x2aa))&&(_0x43c786=_0x39f62c>=0x2004?0x2004:_0x39f62c,_0x5d3a1a=_0xffa96a>=0x1000?0x1000:_0xffa96a,_0x493fba['toLowerCase']()[_0x5a49cb(0x291)](_0x5a49cb(0x2bb))&&(_0x43c786=_0x39f62c>=0x8000?0x8000:_0x39f62c,_0x5d3a1a=_0xffa96a>=0x3e80?0x3e80:_0xffa96a),(_0x493fba[_0x5a49cb(0x236)]()['includes'](_0x5a49cb(0x23f))||_0x493fba[_0x5a49cb(0x236)]()['includes'](_0x5a49cb(0x1ef)))&&(_0x43c786=_0x39f62c>=0x1f400?0x1f400:_0x39f62c,_0x5d3a1a=_0xffa96a>=0x1000?0x1000:_0xffa96a)),_0x493fba['toLowerCase']()[_0x5a49cb(0x291)](_0x5a49cb(0x25a))&&(_0x43c786=_0x39f62c>=0x1000?0x1000:_0x39f62c,_0x5d3a1a=_0xffa96a>=0x800?0x800:_0xffa96a,_0x493fba[_0x5a49cb(0x236)]()[_0x5a49cb(0x291)](_0x5a49cb(0x232))&&(_0x43c786=_0x39f62c>=0x4000?0x4000:_0x39f62c,_0x5d3a1a=_0xffa96a>=0x1f40?0x1f40:_0xffa96a),_0x493fba[_0x5a49cb(0x236)]()['includes']('1106')&&(_0x43c786=_0x39f62c>=0x4000?0x4000:_0x39f62c,_0x5d3a1a=_0xffa96a>=0x1f40?0x1f40:_0xffa96a)),{'maxToken':_0x43c786,'maxRes':_0x5d3a1a};}};ChatgptService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x4734d8(0x290)])(gptkeys_entity_1[_0x4734d8(0x2a3)])),__param(0x1,(0x0,typeorm_2[_0x4734d8(0x290)])(config_entity_1[_0x4734d8(0x228)])),__param(0x2,(0x0,typeorm_2[_0x4734d8(0x290)])(chatBoxType_entity_1[_0x4734d8(0x20f)])),__param(0x3,(0x0,typeorm_2[_0x4734d8(0x290)])(chatBox_entity_1[_0x4734d8(0x1ff)])),__param(0x4,(0x0,typeorm_2[_0x4734d8(0x290)])(app_entity_1['AppEntity'])),__param(0x5,(0x0,typeorm_2[_0x4734d8(0x290)])(chatPreType_entity_1[_0x4734d8(0x289)])),__param(0x6,(0x0,typeorm_2['InjectRepository'])(chatPre_entity_1['ChatPreEntity'])),__metadata('design:paramtypes',[typeorm_1[_0x4734d8(0x216)],typeorm_1['Repository'],typeorm_1['Repository'],typeorm_1['Repository'],typeorm_1[_0x4734d8(0x216)],typeorm_1['Repository'],typeorm_1['Repository'],nestjs_config_1['ConfigService'],userBalance_service_1[_0x4734d8(0x2a5)],chatLog_service_1[_0x4734d8(0x2b6)],user_service_1[_0x4734d8(0x1c1)],upload_service_1[_0x4734d8(0x1de)],badwords_service_1[_0x4734d8(0x214)],autoreply_service_1[_0x4734d8(0x211)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1['FanyiService'],chatGroup_service_1['ChatGroupService'],models_service_1[_0x4734d8(0x241)]])],ChatgptService),exports[_0x4734d8(0x292)]=ChatgptService;