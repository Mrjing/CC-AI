'use strict';const _0x1d7b60=_0x2bba;(function(_0x3428fb,_0x3de100){const _0x229785=_0x2bba,_0x127f42=_0x3428fb();while(!![]){try{const _0x4ddcac=parseInt(_0x229785(0x9e))/0x1*(-parseInt(_0x229785(0xbc))/0x2)+-parseInt(_0x229785(0xb5))/0x3*(parseInt(_0x229785(0xdf))/0x4)+parseInt(_0x229785(0x93))/0x5+-parseInt(_0x229785(0xe7))/0x6+-parseInt(_0x229785(0xa5))/0x7+parseInt(_0x229785(0xc1))/0x8*(-parseInt(_0x229785(0x94))/0x9)+parseInt(_0x229785(0xad))/0xa*(parseInt(_0x229785(0xa6))/0xb);if(_0x4ddcac===_0x3de100)break;else _0x127f42['push'](_0x127f42['shift']());}catch(_0x4ac260){_0x127f42['push'](_0x127f42['shift']());}}}(_0x3723,0x7e211));function _0x2bba(_0x2caf4d,_0x318432){const _0x372373=_0x3723();return _0x2bba=function(_0x2bbac3,_0x5ac35b){_0x2bbac3=_0x2bbac3-0x91;let _0x3c3765=_0x372373[_0x2bbac3];return _0x3c3765;},_0x2bba(_0x2caf4d,_0x318432);}function _0x3723(){const _0x5812ba=['where','design:paramtypes','message','goodsId','userInfo','globalConfigService','pay','function','payPlatform','InjectRepository','GlobalConfigService','queryAllOrder','PayService','DESC','query','buy','length','user','Injectable','findAndCount','订单不存在!','delete','createOrderId','HttpStatus','defineProperty','@nestjs/common','SUM(order.price)','8iswVqe','请先注册账号后购买商品！','../../common/utils','price','userEntity','findOne','orderId','queryByOrderId','2161692RTiQZe','log','套餐不存在!','1026360HxpFkU','1599993myySfc','getOwnPropertyDescriptor','createQueryBuilder','HttpException','goodsInfo','metadata','OrderEntity','userId','object','OrderService','3rduPUY','__param','../crami/cramiPackage.entity','__esModule','decorate','cramiPackageEntity','email','2250745QqaccU','1934482cijIGC','find','@nestjs/typeorm','UserEntity','BAD_REQUEST','orderEntity','status','150dXpGCt','count','map','deleteOrder','select','order.status\x20=\x20:status','create','../pay/pay.service','1191561OVdbPh','total','assign','../user/user.entity','购买失败!','name','../globalConfig/globalConfig.service','211370jSxuYd','username','payService','Repository','coverImg','24qBXnOT','UNAUTHORIZED','des'];_0x3723=function(){return _0x5812ba;};return _0x3723();}var __decorate=this&&this['__decorate']||function(_0x4e72b7,_0x4cfb85,_0x380d91,_0x133323){const _0x2a60e9=_0x2bba;var _0xa1141=arguments[_0x2a60e9(0xd4)],_0xf30d8e=_0xa1141<0x3?_0x4cfb85:_0x133323===null?_0x133323=Object[_0x2a60e9(0x95)](_0x4cfb85,_0x380d91):_0x133323,_0x4986a6;if(typeof Reflect===_0x2a60e9(0x9c)&&typeof Reflect[_0x2a60e9(0xa2)]===_0x2a60e9(0xcb))_0xf30d8e=Reflect['decorate'](_0x4e72b7,_0x4cfb85,_0x380d91,_0x133323);else{for(var _0x310c9b=_0x4e72b7['length']-0x1;_0x310c9b>=0x0;_0x310c9b--)if(_0x4986a6=_0x4e72b7[_0x310c9b])_0xf30d8e=(_0xa1141<0x3?_0x4986a6(_0xf30d8e):_0xa1141>0x3?_0x4986a6(_0x4cfb85,_0x380d91,_0xf30d8e):_0x4986a6(_0x4cfb85,_0x380d91))||_0xf30d8e;}return _0xa1141>0x3&&_0xf30d8e&&Object[_0x2a60e9(0xdc)](_0x4cfb85,_0x380d91,_0xf30d8e),_0xf30d8e;},__metadata=this&&this['__metadata']||function(_0x4f88b1,_0x4c7500){const _0x4931a8=_0x2bba;if(typeof Reflect===_0x4931a8(0x9c)&&typeof Reflect[_0x4931a8(0x99)]===_0x4931a8(0xcb))return Reflect[_0x4931a8(0x99)](_0x4f88b1,_0x4c7500);},__param=this&&this[_0x1d7b60(0x9f)]||function(_0x48258b,_0x438b0a){return function(_0x30106d,_0x594209){_0x438b0a(_0x30106d,_0x594209,_0x48258b);};};Object[_0x1d7b60(0xdc)](exports,_0x1d7b60(0xa1),{'value':!![]}),exports[_0x1d7b60(0x9d)]=void 0x0;const user_entity_1=require(_0x1d7b60(0xb8)),typeorm_1=require(_0x1d7b60(0xa8)),common_1=require(_0x1d7b60(0xdd)),typeorm_2=require('typeorm'),order_entity_1=require('./order.entity'),cramiPackage_entity_1=require(_0x1d7b60(0xa0)),utils_1=require(_0x1d7b60(0xe1)),pay_service_1=require(_0x1d7b60(0xb4)),globalConfig_service_1=require(_0x1d7b60(0xbb));let OrderService=class OrderService{constructor(_0x35d591,_0x5cb267,_0x444de6,_0x42caf3,_0x2252cd){const _0x355ecc=_0x1d7b60;this['orderEntity']=_0x35d591,this[_0x355ecc(0xa3)]=_0x5cb267,this[_0x355ecc(0xe3)]=_0x444de6,this[_0x355ecc(0xbe)]=_0x42caf3,this['globalConfigService']=_0x2252cd;}async[_0x1d7b60(0xd3)](_0xf28931,_0x1b8752){const _0x45a74e=_0x1d7b60;try{const {goodsId:_0x535ee2,count:count=0x1,payType:_0x4a4ab0}=_0xf28931,{id:_0x2a7521}=_0x1b8752[_0x45a74e(0xd5)];if(_0x2a7521>0xf4240)throw new common_1['HttpException'](_0x45a74e(0xe0),common_1['HttpStatus'][_0x45a74e(0xc2)]);const _0x4ba14e=await this[_0x45a74e(0xb3)](_0x2a7521,_0x535ee2,count,_0x4a4ab0),_0x2810c1=await this[_0x45a74e(0xbe)][_0x45a74e(0xca)](_0x2a7521,_0x4ba14e[_0x45a74e(0xe5)],_0x4a4ab0);return Object[_0x45a74e(0xb7)](Object[_0x45a74e(0xb7)]({},_0x2810c1),{'orderId':_0x4ba14e['orderId'],'platform':_0x4ba14e[_0x45a74e(0xcc)],'total':_0x4ba14e['total']});}catch(_0x140641){if(_0x140641[_0x45a74e(0xac)]===0x191)throw new common_1['HttpException'](_0x140641[_0x45a74e(0xc6)],common_1['HttpStatus']['UNAUTHORIZED']);throw new common_1['HttpException'](_0x140641[_0x45a74e(0xc6)]||_0x45a74e(0xb9),common_1[_0x45a74e(0xdb)][_0x45a74e(0xaa)]);}}async[_0x1d7b60(0xe6)](_0x3a3eab,_0x4e3756){const _0x561293=_0x1d7b60,{id:_0x1bdfe5}=_0x3a3eab[_0x561293(0xd5)],{orderId:_0xabdc87}=_0x4e3756,_0x39bcf8=await this[_0x561293(0xab)][_0x561293(0xe4)]({'where':{'userId':_0x1bdfe5,'orderId':_0xabdc87}});if(!_0x39bcf8)throw new common_1['HttpException']('订单不存在!',common_1[_0x561293(0xdb)][_0x561293(0xaa)]);return _0x39bcf8;}async[_0x1d7b60(0xb3)](_0x2de1bc,_0x28ff16,_0x3e76e5,_0x12097a){const _0x4b6736=_0x1d7b60,_0x314f49=await this[_0x4b6736(0xc9)]['queryPayType'](),_0x12ebc0=await this[_0x4b6736(0xa3)][_0x4b6736(0xe4)]({'where':{'id':_0x28ff16}});if(!_0x12ebc0)throw new common_1['HttpException'](_0x4b6736(0x92),common_1['HttpStatus'][_0x4b6736(0xaa)]);const _0x2bd0ce={};_0x2bd0ce[_0x4b6736(0xe5)]=(0x0,utils_1[_0x4b6736(0xda)])(),_0x2bd0ce['userId']=_0x2de1bc,_0x2bd0ce[_0x4b6736(0xc7)]=_0x28ff16,_0x2bd0ce[_0x4b6736(0xe2)]=Number(_0x12ebc0[_0x4b6736(0xe2)]),_0x2bd0ce[_0x4b6736(0xae)]=_0x3e76e5,_0x2bd0ce[_0x4b6736(0xb6)]=Number(_0x12ebc0[_0x4b6736(0xe2)])*_0x3e76e5,_0x2bd0ce['payPlatform']=_0x314f49,_0x2bd0ce['channel']=_0x12097a;const _0x45344d=await this['orderEntity']['save'](_0x2bd0ce);return console[_0x4b6736(0x91)]('order:\x20',_0x45344d),_0x45344d;}async[_0x1d7b60(0xd2)](_0x4a4ff5,_0x520a56,_0x62d42b){const _0x470aa3=_0x1d7b60;return await this[_0x470aa3(0xab)][_0x470aa3(0xd7)]({'where':{'userId':_0x4a4ff5},'order':{'id':_0x470aa3(0xd1)},'skip':(_0x520a56-0x1)*_0x62d42b,'take':_0x62d42b});}async[_0x1d7b60(0xcf)](_0x17fd6c){const _0x38e5a5=_0x1d7b60,{page:_0x1277fd,size:_0x3998d7,userId:_0x41f320,platform:_0x27c46,status:_0x5296c2}=_0x17fd6c,_0x468b0d={};if(_0x41f320)_0x468b0d['userId']=_0x41f320;if(_0x27c46)_0x468b0d[_0x38e5a5(0xcc)]=_0x27c46;if(_0x5296c2)_0x468b0d['status']=_0x5296c2;const [_0x370f69,_0x4f51f7]=await this[_0x38e5a5(0xab)][_0x38e5a5(0xd7)]({'order':{'id':_0x38e5a5(0xd1)},'where':_0x468b0d,'skip':(_0x1277fd-0x1)*_0x3998d7,'take':_0x3998d7}),_0x4fe64f=_0x370f69['map'](_0x535b21=>_0x535b21[_0x38e5a5(0x9b)]),_0x9a975b=_0x370f69[_0x38e5a5(0xaf)](_0x48dd24=>_0x48dd24[_0x38e5a5(0xc7)]),_0x154aaa=await this[_0x38e5a5(0xe3)][_0x38e5a5(0xa7)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4fe64f)},'select':['id',_0x38e5a5(0xbd),_0x38e5a5(0xa4)]}),_0x1729b2=await this[_0x38e5a5(0xa3)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x9a975b)},'select':['id',_0x38e5a5(0xba),_0x38e5a5(0xc0),_0x38e5a5(0xc3)]});_0x370f69['forEach'](_0x30855d=>{const _0x34173f=_0x38e5a5;_0x30855d[_0x34173f(0xc8)]=_0x154aaa[_0x34173f(0xa7)](_0x2edbc3=>_0x2edbc3['id']===_0x30855d[_0x34173f(0x9b)]),_0x30855d[_0x34173f(0x98)]=_0x1729b2['find'](_0x3b677b=>_0x3b677b['id']===_0x30855d[_0x34173f(0xc7)]);});const _0x43e677=await this['orderEntity'][_0x38e5a5(0x96)]('order')[_0x38e5a5(0xc4)](_0x38e5a5(0xb2),{'status':0x1})[_0x38e5a5(0xb1)](_0x38e5a5(0xde),'total_price')['getRawOne']();return Object[_0x38e5a5(0xb7)]({'rows':_0x370f69,'count':_0x4f51f7},_0x43e677);}async[_0x1d7b60(0xb0)](_0x3af9c1){const _0x3e4b13=_0x1d7b60,{orderId:_0x4342f1}=_0x3af9c1,_0x456c25=await this['orderEntity'][_0x3e4b13(0xe4)]({'where':{'orderId':_0x4342f1}});if(!_0x456c25)throw new common_1[(_0x3e4b13(0x97))](_0x3e4b13(0xd8),common_1[_0x3e4b13(0xdb)]['BAD_REQUEST']);return await this[_0x3e4b13(0xab)]['delete']({'orderId':_0x4342f1});}async['deleteNotPay'](){const _0x35257d=_0x1d7b60;return await this['orderEntity'][_0x35257d(0xd9)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x1d7b60(0xd6)])(),__param(0x0,(0x0,typeorm_1[_0x1d7b60(0xcd)])(order_entity_1[_0x1d7b60(0x9a)])),__param(0x1,(0x0,typeorm_1[_0x1d7b60(0xcd)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1[_0x1d7b60(0xcd)])(user_entity_1[_0x1d7b60(0xa9)])),__metadata(_0x1d7b60(0xc5),[typeorm_2['Repository'],typeorm_2[_0x1d7b60(0xbf)],typeorm_2[_0x1d7b60(0xbf)],pay_service_1[_0x1d7b60(0xd0)],globalConfig_service_1[_0x1d7b60(0xce)]])],OrderService),exports[_0x1d7b60(0x9d)]=OrderService;