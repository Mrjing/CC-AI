'use strict';const _0x14660b=_0x1117;(function(_0x1f69ee,_0x49c94e){const _0x10dc2e=_0x1117,_0x5d1675=_0x1f69ee();while(!![]){try{const _0x53b6a0=parseInt(_0x10dc2e(0x10d))/0x1+parseInt(_0x10dc2e(0xd6))/0x2*(parseInt(_0x10dc2e(0xd7))/0x3)+-parseInt(_0x10dc2e(0xe9))/0x4+parseInt(_0x10dc2e(0xf3))/0x5*(-parseInt(_0x10dc2e(0xf2))/0x6)+-parseInt(_0x10dc2e(0xcf))/0x7+parseInt(_0x10dc2e(0xe1))/0x8*(-parseInt(_0x10dc2e(0x119))/0x9)+parseInt(_0x10dc2e(0xcd))/0xa;if(_0x53b6a0===_0x49c94e)break;else _0x5d1675['push'](_0x5d1675['shift']());}catch(_0x1ab842){_0x5d1675['push'](_0x5d1675['shift']());}}}(_0x4fa5,0xc4b6e));var __decorate=this&&this[_0x14660b(0xcb)]||function(_0x567052,_0x4913d5,_0x4682d0,_0x4bf84d){const _0x2d4dae=_0x14660b;var _0x1a3f62=arguments[_0x2d4dae(0xef)],_0x3a12ab=_0x1a3f62<0x3?_0x4913d5:_0x4bf84d===null?_0x4bf84d=Object[_0x2d4dae(0xcc)](_0x4913d5,_0x4682d0):_0x4bf84d,_0x4decb8;if(typeof Reflect==='object'&&typeof Reflect[_0x2d4dae(0x116)]===_0x2d4dae(0xeb))_0x3a12ab=Reflect[_0x2d4dae(0x116)](_0x567052,_0x4913d5,_0x4682d0,_0x4bf84d);else{for(var _0x5456a0=_0x567052[_0x2d4dae(0xef)]-0x1;_0x5456a0>=0x0;_0x5456a0--)if(_0x4decb8=_0x567052[_0x5456a0])_0x3a12ab=(_0x1a3f62<0x3?_0x4decb8(_0x3a12ab):_0x1a3f62>0x3?_0x4decb8(_0x4913d5,_0x4682d0,_0x3a12ab):_0x4decb8(_0x4913d5,_0x4682d0))||_0x3a12ab;}return _0x1a3f62>0x3&&_0x3a12ab&&Object[_0x2d4dae(0xd0)](_0x4913d5,_0x4682d0,_0x3a12ab),_0x3a12ab;},__metadata=this&&this[_0x14660b(0xf9)]||function(_0x2ebee9,_0x326abe){const _0x1b9cba=_0x14660b;if(typeof Reflect===_0x1b9cba(0xed)&&typeof Reflect[_0x1b9cba(0x110)]===_0x1b9cba(0xeb))return Reflect['metadata'](_0x2ebee9,_0x326abe);},__param=this&&this[_0x14660b(0x114)]||function(_0x52ddec,_0x4ab19c){return function(_0x5bc35b,_0x315128){_0x4ab19c(_0x5bc35b,_0x315128,_0x52ddec);};};Object[_0x14660b(0xd0)](exports,_0x14660b(0xfc),{'value':!![]}),exports[_0x14660b(0xca)]=void 0x0;const user_entity_1=require(_0x14660b(0xc7)),typeorm_1=require(_0x14660b(0xdc)),common_1=require(_0x14660b(0x10c)),typeorm_2=require(_0x14660b(0xda)),order_entity_1=require(_0x14660b(0x10a)),cramiPackage_entity_1=require(_0x14660b(0xec)),utils_1=require('../../common/utils'),pay_service_1=require(_0x14660b(0x10b)),globalConfig_service_1=require(_0x14660b(0x11e));function _0x1117(_0x39fb4a,_0x438fcd){const _0x4fa5a4=_0x4fa5();return _0x1117=function(_0x111786,_0xf56a8b){_0x111786=_0x111786-0xc7;let _0x3acc9c=_0x4fa5a4[_0x111786];return _0x3acc9c;},_0x1117(_0x39fb4a,_0x438fcd);}function _0x4fa5(){const _0x15ab85=['function','../crami/cramiPackage.entity','object','count','length','Repository','orderId','6MJaSOT','5591305aYXOKy','createQueryBuilder','findOne','username','total','order:\x20','__metadata','套餐不存在!','购买失败!','__esModule','payPlatform','orderEntity','create','BAD_REQUEST','name','userInfo','UserEntity','status','delete','deleteNotPay','userEntity','save','price','./order.entity','../pay/pay.service','@nestjs/common','32539EWbVaX','forEach','coverImg','metadata','email','HttpStatus','goodsId','__param','InjectRepository','decorate','log','OrderEntity','18kJqFwD','channel','des','order.status\x20=\x20:status','find','../globalConfig/globalConfig.service','HttpException','../user/user.entity','请先注册账号后购买商品！','payService','OrderService','__decorate','getOwnPropertyDescriptor','45474120sVFKrW','Injectable','8666182OgaVMq','defineProperty','where','globalConfigService','goodsInfo','findAndCount','订单不存在!','24114BMZcvT','219swdoHD','getRawOne','select','typeorm','cramiPackageEntity','@nestjs/typeorm','userId','GlobalConfigService','pay','map','3545368UzwVbO','assign','message','DESC','UNAUTHORIZED','queryByOrderId','PayService','buy','5646964zWUGLA','SUM(order.price)'];_0x4fa5=function(){return _0x15ab85;};return _0x4fa5();}let OrderService=class OrderService{constructor(_0x2c593a,_0x10b9c2,_0x3f3c12,_0x418079,_0x52fe47){const _0xe43895=_0x14660b;this['orderEntity']=_0x2c593a,this[_0xe43895(0xdb)]=_0x10b9c2,this[_0xe43895(0x107)]=_0x3f3c12,this[_0xe43895(0xc9)]=_0x418079,this[_0xe43895(0xd2)]=_0x52fe47;}async[_0x14660b(0xe8)](_0x11e880,_0x582a5c){const _0x14b184=_0x14660b;try{const {goodsId:_0x5738ab,count:count=0x1,payType:_0x305956}=_0x11e880,{id:_0x414e59}=_0x582a5c['user'];if(_0x414e59>0xf4240)throw new common_1[(_0x14b184(0x11f))](_0x14b184(0xc8),common_1[_0x14b184(0x112)][_0x14b184(0xe5)]);const _0x1f24b8=await this['create'](_0x414e59,_0x5738ab,count,_0x305956),_0x20bbb1=await this['payService'][_0x14b184(0xdf)](_0x414e59,_0x1f24b8[_0x14b184(0xf1)],_0x305956);return Object['assign'](Object['assign']({},_0x20bbb1),{'orderId':_0x1f24b8[_0x14b184(0xf1)],'platform':_0x1f24b8[_0x14b184(0xfd)],'total':_0x1f24b8[_0x14b184(0xf7)]});}catch(_0x312804){if(_0x312804[_0x14b184(0x104)]===0x191)throw new common_1[(_0x14b184(0x11f))](_0x312804[_0x14b184(0xe3)],common_1['HttpStatus'][_0x14b184(0xe5)]);throw new common_1[(_0x14b184(0x11f))](_0x312804[_0x14b184(0xe3)]||_0x14b184(0xfb),common_1[_0x14b184(0x112)]['BAD_REQUEST']);}}async[_0x14660b(0xe6)](_0x38b293,_0x4e3409){const _0x4ce1de=_0x14660b,{id:_0x22fdcf}=_0x38b293['user'],{orderId:_0x2ca9a8}=_0x4e3409,_0x287d7f=await this[_0x4ce1de(0xfe)][_0x4ce1de(0xf5)]({'where':{'userId':_0x22fdcf,'orderId':_0x2ca9a8}});if(!_0x287d7f)throw new common_1['HttpException']('订单不存在!',common_1['HttpStatus'][_0x4ce1de(0x100)]);return _0x287d7f;}async[_0x14660b(0xff)](_0x31618c,_0x1fb353,_0x3208f4,_0x37b613){const _0x428eab=_0x14660b,_0xb130e7=await this['globalConfigService']['queryPayType'](),_0x5cee36=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x1fb353}});if(!_0x5cee36)throw new common_1[(_0x428eab(0x11f))](_0x428eab(0xfa),common_1['HttpStatus'][_0x428eab(0x100)]);const _0x25b404={};_0x25b404[_0x428eab(0xf1)]=(0x0,utils_1['createOrderId'])(),_0x25b404[_0x428eab(0xdd)]=_0x31618c,_0x25b404[_0x428eab(0x113)]=_0x1fb353,_0x25b404['price']=Number(_0x5cee36[_0x428eab(0x109)]),_0x25b404[_0x428eab(0xee)]=_0x3208f4,_0x25b404['total']=Number(_0x5cee36['price'])*_0x3208f4,_0x25b404[_0x428eab(0xfd)]=_0xb130e7,_0x25b404[_0x428eab(0x11a)]=_0x37b613;const _0x749144=await this[_0x428eab(0xfe)][_0x428eab(0x108)](_0x25b404);return console[_0x428eab(0x117)](_0x428eab(0xf8),_0x749144),_0x749144;}async['query'](_0x634900,_0x4e6930,_0x20c482){const _0x4974be=_0x14660b;return await this['orderEntity'][_0x4974be(0xd4)]({'where':{'userId':_0x634900},'order':{'id':_0x4974be(0xe4)},'skip':(_0x4e6930-0x1)*_0x20c482,'take':_0x20c482});}async['queryAllOrder'](_0x3ac0e6){const _0x4dfe45=_0x14660b,{page:_0x53a99f,size:_0x278515,userId:_0x580b9d,platform:_0x686a04,status:_0x3f1751}=_0x3ac0e6,_0xa24585={};if(_0x580b9d)_0xa24585[_0x4dfe45(0xdd)]=_0x580b9d;if(_0x686a04)_0xa24585[_0x4dfe45(0xfd)]=_0x686a04;if(_0x3f1751)_0xa24585[_0x4dfe45(0x104)]=_0x3f1751;const [_0x1a200a,_0xb3a03a]=await this[_0x4dfe45(0xfe)][_0x4dfe45(0xd4)]({'order':{'id':_0x4dfe45(0xe4)},'where':_0xa24585,'skip':(_0x53a99f-0x1)*_0x278515,'take':_0x278515}),_0x54f402=_0x1a200a[_0x4dfe45(0xe0)](_0x698ead=>_0x698ead[_0x4dfe45(0xdd)]),_0x209d08=_0x1a200a[_0x4dfe45(0xe0)](_0x24e382=>_0x24e382[_0x4dfe45(0x113)]),_0x4785c9=await this['userEntity'][_0x4dfe45(0x11d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x54f402)},'select':['id',_0x4dfe45(0xf6),_0x4dfe45(0x111)]}),_0x3e3dc1=await this[_0x4dfe45(0xdb)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x209d08)},'select':['id',_0x4dfe45(0x101),_0x4dfe45(0x10f),_0x4dfe45(0x11b)]});_0x1a200a[_0x4dfe45(0x10e)](_0x22b980=>{const _0x3d31aa=_0x4dfe45;_0x22b980[_0x3d31aa(0x102)]=_0x4785c9[_0x3d31aa(0x11d)](_0x650a01=>_0x650a01['id']===_0x22b980[_0x3d31aa(0xdd)]),_0x22b980[_0x3d31aa(0xd3)]=_0x3e3dc1[_0x3d31aa(0x11d)](_0x335b65=>_0x335b65['id']===_0x22b980[_0x3d31aa(0x113)]);});const _0x5924d3=await this[_0x4dfe45(0xfe)][_0x4dfe45(0xf4)]('order')[_0x4dfe45(0xd1)](_0x4dfe45(0x11c),{'status':0x1})[_0x4dfe45(0xd9)](_0x4dfe45(0xea),'total_price')[_0x4dfe45(0xd8)]();return Object[_0x4dfe45(0xe2)]({'rows':_0x1a200a,'count':_0xb3a03a},_0x5924d3);}async['deleteOrder'](_0x4dd6ee){const _0xaa3477=_0x14660b,{orderId:_0xe04c94}=_0x4dd6ee,_0x3324c2=await this[_0xaa3477(0xfe)][_0xaa3477(0xf5)]({'where':{'orderId':_0xe04c94}});if(!_0x3324c2)throw new common_1[(_0xaa3477(0x11f))](_0xaa3477(0xd5),common_1[_0xaa3477(0x112)]['BAD_REQUEST']);return await this[_0xaa3477(0xfe)][_0xaa3477(0x105)]({'orderId':_0xe04c94});}async[_0x14660b(0x106)](){const _0x3198ca=_0x14660b;return await this[_0x3198ca(0xfe)][_0x3198ca(0x105)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x14660b(0xce)])(),__param(0x0,(0x0,typeorm_1[_0x14660b(0x115)])(order_entity_1[_0x14660b(0x118)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1[_0x14660b(0x115)])(user_entity_1[_0x14660b(0x103)])),__metadata('design:paramtypes',[typeorm_2[_0x14660b(0xf0)],typeorm_2[_0x14660b(0xf0)],typeorm_2['Repository'],pay_service_1[_0x14660b(0xe7)],globalConfig_service_1[_0x14660b(0xde)]])],OrderService),exports['OrderService']=OrderService;