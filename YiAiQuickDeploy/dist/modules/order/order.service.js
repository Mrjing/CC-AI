'use strict';const _0x1c5472=_0x4688;(function(_0x45f69c,_0x189ad2){const _0x3d86e0=_0x4688,_0x8beca7=_0x45f69c();while(!![]){try{const _0x701592=parseInt(_0x3d86e0(0x1af))/0x1*(parseInt(_0x3d86e0(0x1a5))/0x2)+-parseInt(_0x3d86e0(0x1c5))/0x3*(-parseInt(_0x3d86e0(0x19a))/0x4)+-parseInt(_0x3d86e0(0x190))/0x5+parseInt(_0x3d86e0(0x1dc))/0x6*(parseInt(_0x3d86e0(0x19f))/0x7)+-parseInt(_0x3d86e0(0x1e0))/0x8*(parseInt(_0x3d86e0(0x1be))/0x9)+parseInt(_0x3d86e0(0x1ca))/0xa*(-parseInt(_0x3d86e0(0x19b))/0xb)+-parseInt(_0x3d86e0(0x196))/0xc*(-parseInt(_0x3d86e0(0x1a9))/0xd);if(_0x701592===_0x189ad2)break;else _0x8beca7['push'](_0x8beca7['shift']());}catch(_0x444ed0){_0x8beca7['push'](_0x8beca7['shift']());}}}(_0x12b8,0x2e872));var __decorate=this&&this[_0x1c5472(0x1bc)]||function(_0xafb73c,_0x4e3471,_0x33ac84,_0x4f3ead){const _0x2261dd=_0x1c5472;var _0x3a3334=arguments['length'],_0x439b1a=_0x3a3334<0x3?_0x4e3471:_0x4f3ead===null?_0x4f3ead=Object['getOwnPropertyDescriptor'](_0x4e3471,_0x33ac84):_0x4f3ead,_0x57d211;if(typeof Reflect===_0x2261dd(0x1cc)&&typeof Reflect[_0x2261dd(0x1aa)]===_0x2261dd(0x1e3))_0x439b1a=Reflect[_0x2261dd(0x1aa)](_0xafb73c,_0x4e3471,_0x33ac84,_0x4f3ead);else{for(var _0x2bf110=_0xafb73c[_0x2261dd(0x1cb)]-0x1;_0x2bf110>=0x0;_0x2bf110--)if(_0x57d211=_0xafb73c[_0x2bf110])_0x439b1a=(_0x3a3334<0x3?_0x57d211(_0x439b1a):_0x3a3334>0x3?_0x57d211(_0x4e3471,_0x33ac84,_0x439b1a):_0x57d211(_0x4e3471,_0x33ac84))||_0x439b1a;}return _0x3a3334>0x3&&_0x439b1a&&Object[_0x2261dd(0x1d5)](_0x4e3471,_0x33ac84,_0x439b1a),_0x439b1a;},__metadata=this&&this[_0x1c5472(0x1e1)]||function(_0x6a1da5,_0x140c0a){const _0x53fc38=_0x1c5472;if(typeof Reflect===_0x53fc38(0x1cc)&&typeof Reflect[_0x53fc38(0x193)]===_0x53fc38(0x1e3))return Reflect[_0x53fc38(0x193)](_0x6a1da5,_0x140c0a);},__param=this&&this[_0x1c5472(0x1a8)]||function(_0x171df9,_0xdf6d1d){return function(_0xf97f9d,_0x49e3b5){_0xdf6d1d(_0xf97f9d,_0x49e3b5,_0x171df9);};};Object[_0x1c5472(0x1d5)](exports,_0x1c5472(0x1bd),{'value':!![]}),exports[_0x1c5472(0x1b4)]=void 0x0;const user_entity_1=require(_0x1c5472(0x1e2)),typeorm_1=require(_0x1c5472(0x1a0)),common_1=require('@nestjs/common'),typeorm_2=require('typeorm'),order_entity_1=require(_0x1c5472(0x1e4)),cramiPackage_entity_1=require(_0x1c5472(0x1db)),utils_1=require(_0x1c5472(0x1da)),pay_service_1=require(_0x1c5472(0x1de)),globalConfig_service_1=require(_0x1c5472(0x1c1));let OrderService=class OrderService{constructor(_0x19363b,_0x3464f3,_0x30ab17,_0x14ed9b,_0x48e992){const _0x20d4b8=_0x1c5472;this[_0x20d4b8(0x199)]=_0x19363b,this['cramiPackageEntity']=_0x3464f3,this[_0x20d4b8(0x1a3)]=_0x30ab17,this[_0x20d4b8(0x194)]=_0x14ed9b,this[_0x20d4b8(0x1bb)]=_0x48e992;}async[_0x1c5472(0x1c9)](_0x1c1928,_0xd1031){const _0x18ebbe=_0x1c5472;try{const {goodsId:_0x3ad205,count:count=0x1,payType:_0x4b428a}=_0x1c1928,{id:_0x231226}=_0xd1031[_0x18ebbe(0x1ce)];if(_0x231226>0xf4240)throw new common_1[(_0x18ebbe(0x1a4))]('请先注册账号后购买商品！',common_1['HttpStatus']['UNAUTHORIZED']);const _0x1b73c2=await this[_0x18ebbe(0x1c8)](_0x231226,_0x3ad205,count,_0x4b428a),_0x3e712b=await this[_0x18ebbe(0x194)][_0x18ebbe(0x1c4)](_0x231226,_0x1b73c2['orderId'],_0x4b428a);return Object[_0x18ebbe(0x1df)](Object[_0x18ebbe(0x1df)]({},_0x3e712b),{'orderId':_0x1b73c2['orderId'],'platform':_0x1b73c2[_0x18ebbe(0x18f)],'total':_0x1b73c2[_0x18ebbe(0x1d3)]});}catch(_0x597165){if(_0x597165['status']===0x191)throw new common_1['HttpException'](_0x597165[_0x18ebbe(0x1a2)],common_1[_0x18ebbe(0x1c3)]['UNAUTHORIZED']);throw new common_1[(_0x18ebbe(0x1a4))](_0x597165['message']||_0x18ebbe(0x1d2),common_1[_0x18ebbe(0x1c3)]['BAD_REQUEST']);}}async[_0x1c5472(0x1c7)](_0x433a2f,_0x17e850){const _0x3a1d65=_0x1c5472,{id:_0x1de1e4}=_0x433a2f[_0x3a1d65(0x1ce)],{orderId:_0xd520ed}=_0x17e850,_0x2b694d=await this[_0x3a1d65(0x199)][_0x3a1d65(0x1b5)]({'where':{'userId':_0x1de1e4,'orderId':_0xd520ed}});if(!_0x2b694d)throw new common_1['HttpException'](_0x3a1d65(0x18e),common_1['HttpStatus'][_0x3a1d65(0x1b2)]);return _0x2b694d;}async[_0x1c5472(0x1c8)](_0x51c91d,_0x29fac2,_0xc31f3f,_0x3935f2){const _0x32054c=_0x1c5472,_0x380735=await this[_0x32054c(0x1bb)]['queryPayType'](),_0x34c127=await this[_0x32054c(0x19d)]['findOne']({'where':{'id':_0x29fac2}});if(!_0x34c127)throw new common_1[(_0x32054c(0x1a4))](_0x32054c(0x1d8),common_1['HttpStatus']['BAD_REQUEST']);const _0x4a795c={};_0x4a795c[_0x32054c(0x1d9)]=(0x0,utils_1[_0x32054c(0x1a6)])(),_0x4a795c['userId']=_0x51c91d,_0x4a795c[_0x32054c(0x195)]=_0x29fac2,_0x4a795c['price']=Number(_0x34c127[_0x32054c(0x19c)]),_0x4a795c[_0x32054c(0x19e)]=_0xc31f3f,_0x4a795c[_0x32054c(0x1d3)]=Number(_0x34c127[_0x32054c(0x19c)])*_0xc31f3f,_0x4a795c[_0x32054c(0x18f)]=_0x380735,_0x4a795c[_0x32054c(0x1c2)]=_0x3935f2;const _0x54c41e=await this['orderEntity'][_0x32054c(0x1b7)](_0x4a795c);return console[_0x32054c(0x1a7)](_0x32054c(0x191),_0x54c41e),_0x54c41e;}async[_0x1c5472(0x1b3)](_0x1b5388,_0x403a58,_0x223d89){const _0x3ee0a6=_0x1c5472;return await this[_0x3ee0a6(0x199)][_0x3ee0a6(0x1bf)]({'where':{'userId':_0x1b5388},'order':{'id':_0x3ee0a6(0x198)},'skip':(_0x403a58-0x1)*_0x223d89,'take':_0x223d89});}async[_0x1c5472(0x1e5)](_0x92b9e3){const _0x4b2158=_0x1c5472,{page:_0x2a47e5,size:_0x57a322,userId:_0x3e43a3,platform:_0x15cd29,status:_0x38e1eb}=_0x92b9e3,_0x5ed612={};if(_0x3e43a3)_0x5ed612[_0x4b2158(0x1cd)]=_0x3e43a3;if(_0x15cd29)_0x5ed612[_0x4b2158(0x18f)]=_0x15cd29;if(_0x38e1eb)_0x5ed612[_0x4b2158(0x1b1)]=_0x38e1eb;const [_0x12b020,_0xc4c6a7]=await this[_0x4b2158(0x199)]['findAndCount']({'order':{'id':_0x4b2158(0x198)},'where':_0x5ed612,'skip':(_0x2a47e5-0x1)*_0x57a322,'take':_0x57a322}),_0x3e3ece=_0x12b020['map'](_0x531cf7=>_0x531cf7[_0x4b2158(0x1cd)]),_0x45a32c=_0x12b020['map'](_0x311fbe=>_0x311fbe['goodsId']),_0x54f7b3=await this[_0x4b2158(0x1a3)][_0x4b2158(0x197)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3e3ece)},'select':['id','username',_0x4b2158(0x1b8)]}),_0x90d383=await this[_0x4b2158(0x19d)][_0x4b2158(0x197)]({'where':{'id':(0x0,typeorm_2['In'])(_0x45a32c)},'select':['id','name',_0x4b2158(0x1d4),_0x4b2158(0x1d0)]});_0x12b020['forEach'](_0x3c1bae=>{const _0x15af03=_0x4b2158;_0x3c1bae[_0x15af03(0x1d1)]=_0x54f7b3[_0x15af03(0x197)](_0x6ef02a=>_0x6ef02a['id']===_0x3c1bae['userId']),_0x3c1bae[_0x15af03(0x1ae)]=_0x90d383[_0x15af03(0x197)](_0x1f4c4b=>_0x1f4c4b['id']===_0x3c1bae[_0x15af03(0x195)]);});const _0x387f2e=await this['orderEntity'][_0x4b2158(0x1d7)](_0x4b2158(0x1c6))[_0x4b2158(0x18d)](_0x4b2158(0x1b0),{'status':0x1})[_0x4b2158(0x1b6)]('SUM(order.price)','total_price')[_0x4b2158(0x1c0)]();return Object['assign']({'rows':_0x12b020,'count':_0xc4c6a7},_0x387f2e);}async['deleteOrder'](_0x2f242a){const _0xb8eb9=_0x1c5472,{orderId:_0x4b7b0c}=_0x2f242a,_0x246b48=await this[_0xb8eb9(0x199)][_0xb8eb9(0x1b5)]({'where':{'orderId':_0x4b7b0c}});if(!_0x246b48)throw new common_1[(_0xb8eb9(0x1a4))](_0xb8eb9(0x18e),common_1[_0xb8eb9(0x1c3)][_0xb8eb9(0x1b2)]);return await this[_0xb8eb9(0x199)][_0xb8eb9(0x1ba)]({'orderId':_0x4b7b0c});}async['deleteNotPay'](){const _0x1db143=_0x1c5472;return await this[_0x1db143(0x199)][_0x1db143(0x1ba)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x1c5472(0x1b9)])(),__param(0x0,(0x0,typeorm_1[_0x1c5472(0x1a1)])(order_entity_1[_0x1c5472(0x1ad)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x1c5472(0x1ac)])),__param(0x2,(0x0,typeorm_1[_0x1c5472(0x1a1)])(user_entity_1[_0x1c5472(0x192)])),__metadata(_0x1c5472(0x1dd),[typeorm_2['Repository'],typeorm_2[_0x1c5472(0x1ab)],typeorm_2[_0x1c5472(0x1ab)],pay_service_1[_0x1c5472(0x1cf)],globalConfig_service_1[_0x1c5472(0x1d6)]])],OrderService),exports['OrderService']=OrderService;function _0x4688(_0x2a6a11,_0x40de88){const _0x12b8b9=_0x12b8();return _0x4688=function(_0x4688b5,_0x3eff13){_0x4688b5=_0x4688b5-0x18d;let _0x451ecf=_0x12b8b9[_0x4688b5];return _0x451ecf;},_0x4688(_0x2a6a11,_0x40de88);}function _0x12b8(){const _0x53b4c1=['function','./order.entity','queryAllOrder','where','订单不存在!','payPlatform','1527305TkqjWj','order:\x20','UserEntity','metadata','payService','goodsId','1980eMLaZJ','find','DESC','orderEntity','4HkiRjd','385dsPCrD','price','cramiPackageEntity','count','763bhQDpj','@nestjs/typeorm','InjectRepository','message','userEntity','HttpException','48694klwfhg','createOrderId','log','__param','52689gdAUdB','decorate','Repository','CramiPackageEntity','OrderEntity','goodsInfo','5WnphFC','order.status\x20=\x20:status','status','BAD_REQUEST','query','OrderService','findOne','select','save','email','Injectable','delete','globalConfigService','__decorate','__esModule','163368NfwEyy','findAndCount','getRawOne','../globalConfig/globalConfig.service','channel','HttpStatus','pay','301107BefYJj','order','queryByOrderId','create','buy','36190YVeIAM','length','object','userId','user','PayService','des','userInfo','购买失败!','total','coverImg','defineProperty','GlobalConfigService','createQueryBuilder','套餐不存在!','orderId','../../common/utils','../crami/cramiPackage.entity','2226UJBbPd','design:paramtypes','../pay/pay.service','assign','136wmFdUI','__metadata','../user/user.entity'];_0x12b8=function(){return _0x53b4c1;};return _0x12b8();}