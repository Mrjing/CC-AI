'use strict';const _0x14aa77=_0x39ed;(function(_0x1d1c7d,_0x347e6b){const _0x11aafd=_0x39ed,_0x43f511=_0x1d1c7d();while(!![]){try{const _0xbd5060=parseInt(_0x11aafd(0x1aa))/0x1+parseInt(_0x11aafd(0x180))/0x2*(parseInt(_0x11aafd(0x17c))/0x3)+parseInt(_0x11aafd(0x16b))/0x4+-parseInt(_0x11aafd(0x1a6))/0x5*(parseInt(_0x11aafd(0x17e))/0x6)+-parseInt(_0x11aafd(0x166))/0x7+parseInt(_0x11aafd(0x18c))/0x8*(parseInt(_0x11aafd(0x165))/0x9)+-parseInt(_0x11aafd(0x19c))/0xa;if(_0xbd5060===_0x347e6b)break;else _0x43f511['push'](_0x43f511['shift']());}catch(_0x5ca10b){_0x43f511['push'](_0x43f511['shift']());}}}(_0x5aa2,0xae23d));var __decorate=this&&this['__decorate']||function(_0x5604fa,_0xf1c29c,_0x1c6077,_0xbd9d6f){const _0x3ddf7e=_0x39ed;var _0x1dded5=arguments['length'],_0x1e07a2=_0x1dded5<0x3?_0xf1c29c:_0xbd9d6f===null?_0xbd9d6f=Object[_0x3ddf7e(0x1a4)](_0xf1c29c,_0x1c6077):_0xbd9d6f,_0x319e87;if(typeof Reflect==='object'&&typeof Reflect[_0x3ddf7e(0x1a7)]==='function')_0x1e07a2=Reflect[_0x3ddf7e(0x1a7)](_0x5604fa,_0xf1c29c,_0x1c6077,_0xbd9d6f);else{for(var _0xdd6841=_0x5604fa[_0x3ddf7e(0x19a)]-0x1;_0xdd6841>=0x0;_0xdd6841--)if(_0x319e87=_0x5604fa[_0xdd6841])_0x1e07a2=(_0x1dded5<0x3?_0x319e87(_0x1e07a2):_0x1dded5>0x3?_0x319e87(_0xf1c29c,_0x1c6077,_0x1e07a2):_0x319e87(_0xf1c29c,_0x1c6077))||_0x1e07a2;}return _0x1dded5>0x3&&_0x1e07a2&&Object[_0x3ddf7e(0x18d)](_0xf1c29c,_0x1c6077,_0x1e07a2),_0x1e07a2;},__metadata=this&&this['__metadata']||function(_0x56d466,_0x550713){const _0x2b87c3=_0x39ed;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x2b87c3(0x16d))return Reflect[_0x2b87c3(0x159)](_0x56d466,_0x550713);},__param=this&&this['__param']||function(_0x3acdda,_0x7b9f2f){return function(_0x3e4d0d,_0x2e6cef){_0x7b9f2f(_0x3e4d0d,_0x2e6cef,_0x3acdda);};};Object[_0x14aa77(0x18d)](exports,'__esModule',{'value':!![]}),exports[_0x14aa77(0x164)]=void 0x0;const user_entity_1=require(_0x14aa77(0x185)),typeorm_1=require(_0x14aa77(0x1ab)),common_1=require(_0x14aa77(0x17d)),typeorm_2=require(_0x14aa77(0x17f)),order_entity_1=require(_0x14aa77(0x199)),cramiPackage_entity_1=require(_0x14aa77(0x173)),utils_1=require(_0x14aa77(0x181)),pay_service_1=require(_0x14aa77(0x186)),globalConfig_service_1=require(_0x14aa77(0x19e));let OrderService=class OrderService{constructor(_0x38b094,_0x4dc377,_0x168d5a,_0x2b646a,_0x43320c){const _0x3a5479=_0x14aa77;this[_0x3a5479(0x18b)]=_0x38b094,this[_0x3a5479(0x1af)]=_0x4dc377,this[_0x3a5479(0x172)]=_0x168d5a,this[_0x3a5479(0x176)]=_0x2b646a,this['globalConfigService']=_0x43320c;}async[_0x14aa77(0x1a1)](_0xfa5ced,_0x1bf8e0){const _0x3753c2=_0x14aa77;try{const {goodsId:_0x35493d,count:count=0x1,payType:_0x550f05}=_0xfa5ced,{id:_0x16ae3a}=_0x1bf8e0[_0x3753c2(0x15e)];if(_0x16ae3a>0xf4240)throw new common_1[(_0x3753c2(0x184))]('请先注册账号后购买商品！',common_1[_0x3753c2(0x170)][_0x3753c2(0x194)]);const _0x51b540=await this[_0x3753c2(0x162)](_0x16ae3a,_0x35493d,count,_0x550f05),_0x53d473=await this[_0x3753c2(0x176)][_0x3753c2(0x1ac)](_0x16ae3a,_0x51b540[_0x3753c2(0x192)],_0x550f05);return Object[_0x3753c2(0x1a0)](Object[_0x3753c2(0x1a0)]({},_0x53d473),{'orderId':_0x51b540['orderId'],'platform':_0x51b540['payPlatform'],'total':_0x51b540['total']});}catch(_0x32dd10){if(_0x32dd10[_0x3753c2(0x1a5)]===0x191)throw new common_1[(_0x3753c2(0x184))](_0x32dd10[_0x3753c2(0x15b)],common_1[_0x3753c2(0x170)][_0x3753c2(0x194)]);throw new common_1[(_0x3753c2(0x184))](_0x32dd10['message']||_0x3753c2(0x18e),common_1[_0x3753c2(0x170)][_0x3753c2(0x161)]);}}async[_0x14aa77(0x16f)](_0x356433,_0x79b603){const _0x2b655d=_0x14aa77,{id:_0x221cbc}=_0x356433['user'],{orderId:_0x5c73f9}=_0x79b603,_0x5e2280=await this[_0x2b655d(0x18b)][_0x2b655d(0x183)]({'where':{'userId':_0x221cbc,'orderId':_0x5c73f9}});if(!_0x5e2280)throw new common_1[(_0x2b655d(0x184))](_0x2b655d(0x19f),common_1[_0x2b655d(0x170)][_0x2b655d(0x161)]);return _0x5e2280;}async[_0x14aa77(0x162)](_0x2b48e8,_0x1ae746,_0x418140,_0x201f64){const _0x596658=_0x14aa77,_0x5325bf=await this['globalConfigService'][_0x596658(0x160)](),_0x5b2312=await this[_0x596658(0x1af)][_0x596658(0x183)]({'where':{'id':_0x1ae746}});if(!_0x5b2312)throw new common_1[(_0x596658(0x184))]('套餐不存在!',common_1['HttpStatus'][_0x596658(0x161)]);const _0x42de7d={};_0x42de7d['orderId']=(0x0,utils_1[_0x596658(0x193)])(),_0x42de7d[_0x596658(0x174)]=_0x2b48e8,_0x42de7d[_0x596658(0x1ae)]=_0x1ae746,_0x42de7d[_0x596658(0x1a9)]=Number(_0x5b2312[_0x596658(0x1a9)]),_0x42de7d[_0x596658(0x158)]=_0x418140,_0x42de7d[_0x596658(0x1a3)]=Number(_0x5b2312[_0x596658(0x1a9)])*_0x418140,_0x42de7d[_0x596658(0x1a2)]=_0x5325bf,_0x42de7d[_0x596658(0x167)]=_0x201f64;const _0x3072f2=await this[_0x596658(0x18b)][_0x596658(0x171)](_0x42de7d);return console[_0x596658(0x18f)](_0x596658(0x196),_0x3072f2),_0x3072f2;}async[_0x14aa77(0x197)](_0x20abe3,_0x762d0f,_0x12e7f4){const _0x4b133b=_0x14aa77;return await this[_0x4b133b(0x18b)]['findAndCount']({'where':{'userId':_0x20abe3},'order':{'id':_0x4b133b(0x16c)},'skip':(_0x762d0f-0x1)*_0x12e7f4,'take':_0x12e7f4});}async[_0x14aa77(0x17a)](_0x89d8b6){const _0x2250bf=_0x14aa77,{page:_0xea7536,size:_0x1d7d8a,userId:_0x5dc336,platform:_0x3ae883,status:_0x32e79a}=_0x89d8b6,_0x5b4d6e={};if(_0x5dc336)_0x5b4d6e[_0x2250bf(0x174)]=_0x5dc336;if(_0x3ae883)_0x5b4d6e[_0x2250bf(0x1a2)]=_0x3ae883;if(_0x32e79a)_0x5b4d6e[_0x2250bf(0x1a5)]=_0x32e79a;const [_0x22e89f,_0x1f405f]=await this[_0x2250bf(0x18b)][_0x2250bf(0x190)]({'order':{'id':_0x2250bf(0x16c)},'where':_0x5b4d6e,'skip':(_0xea7536-0x1)*_0x1d7d8a,'take':_0x1d7d8a}),_0x38929b=_0x22e89f[_0x2250bf(0x168)](_0x34bfc4=>_0x34bfc4[_0x2250bf(0x174)]),_0x14ee15=_0x22e89f[_0x2250bf(0x168)](_0x5ebd5a=>_0x5ebd5a['goodsId']),_0x589746=await this['userEntity'][_0x2250bf(0x15a)]({'where':{'id':(0x0,typeorm_2['In'])(_0x38929b)},'select':['id','username',_0x2250bf(0x179)]}),_0x362c00=await this[_0x2250bf(0x1af)][_0x2250bf(0x15a)]({'where':{'id':(0x0,typeorm_2['In'])(_0x14ee15)},'select':['id',_0x2250bf(0x163),_0x2250bf(0x188),_0x2250bf(0x19b)]});_0x22e89f[_0x2250bf(0x15f)](_0x5d43cc=>{const _0x13134f=_0x2250bf;_0x5d43cc[_0x13134f(0x177)]=_0x589746[_0x13134f(0x15a)](_0x5835b2=>_0x5835b2['id']===_0x5d43cc[_0x13134f(0x174)]),_0x5d43cc[_0x13134f(0x182)]=_0x362c00[_0x13134f(0x15a)](_0x193f3a=>_0x193f3a['id']===_0x5d43cc['goodsId']);});const _0xb1d90d=await this[_0x2250bf(0x18b)][_0x2250bf(0x15d)](_0x2250bf(0x195))['where'](_0x2250bf(0x169),{'status':0x1})[_0x2250bf(0x18a)](_0x2250bf(0x15c),_0x2250bf(0x175))[_0x2250bf(0x1ad)]();return Object[_0x2250bf(0x1a0)]({'rows':_0x22e89f,'count':_0x1f405f},_0xb1d90d);}async['deleteOrder'](_0x15da4a){const _0x26b36e=_0x14aa77,{orderId:_0x18fa83}=_0x15da4a,_0x225b5d=await this['orderEntity'][_0x26b36e(0x183)]({'where':{'orderId':_0x18fa83}});if(!_0x225b5d)throw new common_1[(_0x26b36e(0x184))]('订单不存在!',common_1[_0x26b36e(0x170)][_0x26b36e(0x161)]);return await this['orderEntity'][_0x26b36e(0x189)]({'orderId':_0x18fa83});}async[_0x14aa77(0x16e)](){const _0x1cbcbb=_0x14aa77;return await this[_0x1cbcbb(0x18b)][_0x1cbcbb(0x189)]({'status':0x0});}};function _0x39ed(_0x2cf95a,_0x111e83){const _0x5aa2a1=_0x5aa2();return _0x39ed=function(_0x39ed1c,_0x5a98f7){_0x39ed1c=_0x39ed1c-0x158;let _0x46f524=_0x5aa2a1[_0x39ed1c];return _0x46f524;},_0x39ed(_0x2cf95a,_0x111e83);}function _0x5aa2(){const _0x40c3ff=['Injectable','../globalConfig/globalConfig.service','订单不存在!','assign','buy','payPlatform','total','getOwnPropertyDescriptor','status','135HnRpXz','decorate','UserEntity','price','427320MZHvqt','@nestjs/typeorm','pay','getRawOne','goodsId','cramiPackageEntity','design:paramtypes','count','metadata','find','message','SUM(order.price)','createQueryBuilder','user','forEach','queryPayType','BAD_REQUEST','create','name','OrderService','5600007IHxVlD','3422258EGtYcw','channel','map','order.status\x20=\x20:status','InjectRepository','5689664yIHxoF','DESC','function','deleteNotPay','queryByOrderId','HttpStatus','save','userEntity','../crami/cramiPackage.entity','userId','total_price','payService','userInfo','GlobalConfigService','email','queryAllOrder','CramiPackageEntity','3ZeivKr','@nestjs/common','150942uBwsiR','typeorm','642700NWClMn','../../common/utils','goodsInfo','findOne','HttpException','../user/user.entity','../pay/pay.service','Repository','coverImg','delete','select','orderEntity','8vmGHky','defineProperty','购买失败!','log','findAndCount','OrderEntity','orderId','createOrderId','UNAUTHORIZED','order','order:\x20','query','PayService','./order.entity','length','des','9118990upLGun'];_0x5aa2=function(){return _0x40c3ff;};return _0x5aa2();}OrderService=__decorate([(0x0,common_1[_0x14aa77(0x19d)])(),__param(0x0,(0x0,typeorm_1[_0x14aa77(0x16a)])(order_entity_1[_0x14aa77(0x191)])),__param(0x1,(0x0,typeorm_1[_0x14aa77(0x16a)])(cramiPackage_entity_1[_0x14aa77(0x17b)])),__param(0x2,(0x0,typeorm_1[_0x14aa77(0x16a)])(user_entity_1[_0x14aa77(0x1a8)])),__metadata(_0x14aa77(0x1b0),[typeorm_2[_0x14aa77(0x187)],typeorm_2[_0x14aa77(0x187)],typeorm_2[_0x14aa77(0x187)],pay_service_1[_0x14aa77(0x198)],globalConfig_service_1[_0x14aa77(0x178)]])],OrderService),exports[_0x14aa77(0x164)]=OrderService;