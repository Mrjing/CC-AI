'use strict';const _0x5b5a28=_0x3b4e;(function(_0x5aac58,_0x2709c2){const _0x5d6ff8=_0x3b4e,_0x2a6b75=_0x5aac58();while(!![]){try{const _0x2287dd=-parseInt(_0x5d6ff8(0xfd))/0x1+-parseInt(_0x5d6ff8(0x101))/0x2+-parseInt(_0x5d6ff8(0xdc))/0x3+-parseInt(_0x5d6ff8(0xca))/0x4+-parseInt(_0x5d6ff8(0xe6))/0x5*(-parseInt(_0x5d6ff8(0xf4))/0x6)+-parseInt(_0x5d6ff8(0xbf))/0x7*(parseInt(_0x5d6ff8(0xd1))/0x8)+parseInt(_0x5d6ff8(0xe8))/0x9*(parseInt(_0x5d6ff8(0xf6))/0xa);if(_0x2287dd===_0x2709c2)break;else _0x2a6b75['push'](_0x2a6b75['shift']());}catch(_0x756f5){_0x2a6b75['push'](_0x2a6b75['shift']());}}}(_0x3b9d,0xa598a));var __decorate=this&&this[_0x5b5a28(0xfa)]||function(_0x58c005,_0x30bcdc,_0x3d3ab6,_0x1742bd){const _0x381d24=_0x5b5a28;var _0x2a2522=arguments[_0x381d24(0x104)],_0x144958=_0x2a2522<0x3?_0x30bcdc:_0x1742bd===null?_0x1742bd=Object[_0x381d24(0xd0)](_0x30bcdc,_0x3d3ab6):_0x1742bd,_0x2d41fc;if(typeof Reflect==='object'&&typeof Reflect[_0x381d24(0x103)]===_0x381d24(0xd3))_0x144958=Reflect[_0x381d24(0x103)](_0x58c005,_0x30bcdc,_0x3d3ab6,_0x1742bd);else{for(var _0x5b2819=_0x58c005[_0x381d24(0x104)]-0x1;_0x5b2819>=0x0;_0x5b2819--)if(_0x2d41fc=_0x58c005[_0x5b2819])_0x144958=(_0x2a2522<0x3?_0x2d41fc(_0x144958):_0x2a2522>0x3?_0x2d41fc(_0x30bcdc,_0x3d3ab6,_0x144958):_0x2d41fc(_0x30bcdc,_0x3d3ab6))||_0x144958;}return _0x2a2522>0x3&&_0x144958&&Object[_0x381d24(0xcd)](_0x30bcdc,_0x3d3ab6,_0x144958),_0x144958;},__metadata=this&&this['__metadata']||function(_0x53cf8d,_0x5d4fbf){const _0x3584cf=_0x5b5a28;if(typeof Reflect===_0x3584cf(0xb5)&&typeof Reflect[_0x3584cf(0x109)]===_0x3584cf(0xd3))return Reflect[_0x3584cf(0x109)](_0x53cf8d,_0x5d4fbf);},__param=this&&this[_0x5b5a28(0xf7)]||function(_0xb45561,_0x42131e){return function(_0x583178,_0x435ca6){_0x42131e(_0x583178,_0x435ca6,_0xb45561);};};function _0x3b4e(_0x11bf80,_0x22f5c2){const _0x3b9d51=_0x3b9d();return _0x3b4e=function(_0x3b4e4f,_0x3993fa){_0x3b4e4f=_0x3b4e4f-0xb5;let _0x132767=_0x3b9d51[_0x3b4e4f];return _0x132767;},_0x3b4e(_0x11bf80,_0x22f5c2);}Object[_0x5b5a28(0xcd)](exports,_0x5b5a28(0xbb),{'value':!![]}),exports[_0x5b5a28(0xde)]=void 0x0;const user_entity_1=require('../user/user.entity'),typeorm_1=require('@nestjs/typeorm'),common_1=require(_0x5b5a28(0xef)),typeorm_2=require(_0x5b5a28(0xf5)),order_entity_1=require(_0x5b5a28(0x106)),cramiPackage_entity_1=require(_0x5b5a28(0xda)),utils_1=require('../../common/utils'),pay_service_1=require(_0x5b5a28(0xe4)),globalConfig_service_1=require(_0x5b5a28(0xf3));let OrderService=class OrderService{constructor(_0x2c242f,_0x4c2cd9,_0x24f256,_0x320511,_0x2e0fe5){const _0x38fa2f=_0x5b5a28;this['orderEntity']=_0x2c242f,this[_0x38fa2f(0xff)]=_0x4c2cd9,this[_0x38fa2f(0xed)]=_0x24f256,this[_0x38fa2f(0xdb)]=_0x320511,this[_0x38fa2f(0xd2)]=_0x2e0fe5;}async['buy'](_0x5b3b70,_0x380b28){const _0x206e9c=_0x5b5a28;try{const {goodsId:_0x437d6b,count:count=0x1,payType:_0x41e1a8}=_0x5b3b70,{id:_0x431cdf}=_0x380b28[_0x206e9c(0xc5)];if(_0x431cdf>0xf4240)throw new common_1['HttpException']('请先注册账号后购买商品！',common_1['HttpStatus'][_0x206e9c(0xe2)]);const _0x17f8ae=await this[_0x206e9c(0xba)](_0x431cdf,_0x437d6b,count,_0x41e1a8),_0x97c4ce=await this['payService'][_0x206e9c(0xdd)](_0x431cdf,_0x17f8ae['orderId'],_0x41e1a8);return Object['assign'](Object[_0x206e9c(0xbe)]({},_0x97c4ce),{'orderId':_0x17f8ae[_0x206e9c(0x102)],'platform':_0x17f8ae['payPlatform'],'total':_0x17f8ae[_0x206e9c(0xc3)]});}catch(_0x5eec32){if(_0x5eec32[_0x206e9c(0xc9)]===0x191)throw new common_1[(_0x206e9c(0xf8))](_0x5eec32[_0x206e9c(0xee)],common_1['HttpStatus'][_0x206e9c(0xe2)]);throw new common_1[(_0x206e9c(0xf8))](_0x5eec32[_0x206e9c(0xee)]||_0x206e9c(0xd5),common_1['HttpStatus'][_0x206e9c(0xb7)]);}}async[_0x5b5a28(0x108)](_0x2440c4,_0x2e8a19){const _0x42a74d=_0x5b5a28,{id:_0x5d61f7}=_0x2440c4[_0x42a74d(0xc5)],{orderId:_0x42e7da}=_0x2e8a19,_0x4e4b97=await this[_0x42a74d(0xbd)]['findOne']({'where':{'userId':_0x5d61f7,'orderId':_0x42e7da}});if(!_0x4e4b97)throw new common_1[(_0x42a74d(0xf8))](_0x42a74d(0xce),common_1['HttpStatus'][_0x42a74d(0xb7)]);return _0x4e4b97;}async[_0x5b5a28(0xba)](_0x5871e3,_0x60198,_0x2e8d92,_0x226d7f){const _0x1e496d=_0x5b5a28,_0x2f9646=await this['globalConfigService']['queryPayType'](),_0x562206=await this[_0x1e496d(0xff)][_0x1e496d(0xc2)]({'where':{'id':_0x60198}});if(!_0x562206)throw new common_1['HttpException']('套餐不存在!',common_1[_0x1e496d(0xcc)][_0x1e496d(0xb7)]);const _0x46aec4={};_0x46aec4['orderId']=(0x0,utils_1[_0x1e496d(0xfb)])(),_0x46aec4[_0x1e496d(0xc0)]=_0x5871e3,_0x46aec4['goodsId']=_0x60198,_0x46aec4[_0x1e496d(0xc7)]=Number(_0x562206['price']),_0x46aec4[_0x1e496d(0xea)]=_0x2e8d92,_0x46aec4[_0x1e496d(0xc3)]=Number(_0x562206[_0x1e496d(0xc7)])*_0x2e8d92,_0x46aec4[_0x1e496d(0xc1)]=_0x2f9646,_0x46aec4[_0x1e496d(0xdf)]=_0x226d7f;const _0x404240=await this[_0x1e496d(0xbd)][_0x1e496d(0xe3)](_0x46aec4);return console[_0x1e496d(0xc6)](_0x1e496d(0x105),_0x404240),_0x404240;}async[_0x5b5a28(0xf1)](_0x153efb,_0x518d2f,_0x62ce8){const _0x1a7ac5=_0x5b5a28;return await this[_0x1a7ac5(0xbd)][_0x1a7ac5(0xe0)]({'where':{'userId':_0x153efb},'order':{'id':_0x1a7ac5(0xf9)},'skip':(_0x518d2f-0x1)*_0x62ce8,'take':_0x62ce8});}async[_0x5b5a28(0xcb)](_0x1fcfb1){const _0x38962e=_0x5b5a28,{page:_0x28c5b0,size:_0x281287,userId:_0x3fbea8,platform:_0x43cd1f,status:_0xacc32a}=_0x1fcfb1,_0x11c0d2={};if(_0x3fbea8)_0x11c0d2[_0x38962e(0xc0)]=_0x3fbea8;if(_0x43cd1f)_0x11c0d2[_0x38962e(0xc1)]=_0x43cd1f;if(_0xacc32a)_0x11c0d2[_0x38962e(0xc9)]=_0xacc32a;const [_0xb40887,_0x4e609c]=await this[_0x38962e(0xbd)][_0x38962e(0xe0)]({'order':{'id':'DESC'},'where':_0x11c0d2,'skip':(_0x28c5b0-0x1)*_0x281287,'take':_0x281287}),_0x5b13d8=_0xb40887[_0x38962e(0xe1)](_0x533547=>_0x533547[_0x38962e(0xc0)]),_0x5ce5ef=_0xb40887[_0x38962e(0xe1)](_0x50423b=>_0x50423b['goodsId']),_0x4d60bb=await this[_0x38962e(0xed)][_0x38962e(0xd9)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5b13d8)},'select':['id','username','email']}),_0xba9168=await this[_0x38962e(0xff)][_0x38962e(0xd9)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5ce5ef)},'select':['id',_0x38962e(0xfc),'coverImg',_0x38962e(0xf0)]});_0xb40887['forEach'](_0x26bb92=>{const _0x3a932f=_0x38962e;_0x26bb92[_0x3a932f(0x100)]=_0x4d60bb[_0x3a932f(0xd9)](_0x2cd7bf=>_0x2cd7bf['id']===_0x26bb92[_0x3a932f(0xc0)]),_0x26bb92[_0x3a932f(0xe7)]=_0xba9168[_0x3a932f(0xd9)](_0x1dd51a=>_0x1dd51a['id']===_0x26bb92[_0x3a932f(0xd8)]);});const _0x4ba8c3=await this[_0x38962e(0xbd)][_0x38962e(0xc4)]('order')[_0x38962e(0xeb)](_0x38962e(0xb6),{'status':0x1})[_0x38962e(0xb9)](_0x38962e(0xfe),_0x38962e(0xec))[_0x38962e(0xc8)]();return Object[_0x38962e(0xbe)]({'rows':_0xb40887,'count':_0x4e609c},_0x4ba8c3);}async[_0x5b5a28(0xb8)](_0x10eec4){const _0x2f0b3a=_0x5b5a28,{orderId:_0x31822}=_0x10eec4,_0x407f95=await this[_0x2f0b3a(0xbd)]['findOne']({'where':{'orderId':_0x31822}});if(!_0x407f95)throw new common_1['HttpException'](_0x2f0b3a(0xce),common_1[_0x2f0b3a(0xcc)][_0x2f0b3a(0xb7)]);return await this[_0x2f0b3a(0xbd)][_0x2f0b3a(0xd7)]({'orderId':_0x31822});}async[_0x5b5a28(0xd4)](){const _0x28b0b2=_0x5b5a28;return await this[_0x28b0b2(0xbd)][_0x28b0b2(0xd7)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x5b5a28(0x107)])(order_entity_1[_0x5b5a28(0xe9)])),__param(0x1,(0x0,typeorm_1[_0x5b5a28(0x107)])(cramiPackage_entity_1[_0x5b5a28(0xcf)])),__param(0x2,(0x0,typeorm_1[_0x5b5a28(0x107)])(user_entity_1[_0x5b5a28(0xe5)])),__metadata('design:paramtypes',[typeorm_2[_0x5b5a28(0xf2)],typeorm_2[_0x5b5a28(0xf2)],typeorm_2['Repository'],pay_service_1[_0x5b5a28(0xd6)],globalConfig_service_1[_0x5b5a28(0xbc)]])],OrderService),exports['OrderService']=OrderService;function _0x3b9d(){const _0x170e26=['PayService','delete','goodsId','find','../crami/cramiPackage.entity','payService','3975639YXuNgg','pay','OrderService','channel','findAndCount','map','UNAUTHORIZED','save','../pay/pay.service','UserEntity','3196790KoCjfD','goodsInfo','601731qqvazR','OrderEntity','count','where','total_price','userEntity','message','@nestjs/common','des','query','Repository','../globalConfig/globalConfig.service','6uPfCNR','typeorm','490vdCAga','__param','HttpException','DESC','__decorate','createOrderId','name','106488uGUYcw','SUM(order.price)','cramiPackageEntity','userInfo','1365970ennRdJ','orderId','decorate','length','order:\x20','./order.entity','InjectRepository','queryByOrderId','metadata','object','order.status\x20=\x20:status','BAD_REQUEST','deleteOrder','select','create','__esModule','GlobalConfigService','orderEntity','assign','1939QpzMAl','userId','payPlatform','findOne','total','createQueryBuilder','user','log','price','getRawOne','status','8064aXEsOD','queryAllOrder','HttpStatus','defineProperty','订单不存在!','CramiPackageEntity','getOwnPropertyDescriptor','32360ObrnCo','globalConfigService','function','deleteNotPay','购买失败!'];_0x3b9d=function(){return _0x170e26;};return _0x3b9d();}