'use strict';const _0x4688b8=_0x30f4;(function(_0x3a5361,_0x3a387c){const _0x4a02da=_0x30f4,_0x592ac4=_0x3a5361();while(!![]){try{const _0x49212c=-parseInt(_0x4a02da(0x1ae))/0x1+-parseInt(_0x4a02da(0x19e))/0x2+parseInt(_0x4a02da(0x1a2))/0x3+parseInt(_0x4a02da(0x168))/0x4+-parseInt(_0x4a02da(0x15f))/0x5*(parseInt(_0x4a02da(0x189))/0x6)+parseInt(_0x4a02da(0x164))/0x7+parseInt(_0x4a02da(0x195))/0x8*(parseInt(_0x4a02da(0x1a1))/0x9);if(_0x49212c===_0x3a387c)break;else _0x592ac4['push'](_0x592ac4['shift']());}catch(_0x52559e){_0x592ac4['push'](_0x592ac4['shift']());}}}(_0x52c4,0x23a25));function _0x30f4(_0x33f3af,_0x3738f9){const _0x52c46e=_0x52c4();return _0x30f4=function(_0x30f446,_0x132c73){_0x30f446=_0x30f446-0x159;let _0x555deb=_0x52c46e[_0x30f446];return _0x555deb;},_0x30f4(_0x33f3af,_0x3738f9);}function _0x52c4(){const _0xbee64d=['__param','query','decorate','map','assign','where','message','GlobalConfigService','des','InjectRepository','queryByOrderId','defineProperty','total','__metadata','createQueryBuilder','typeorm','email','@nestjs/typeorm','username','UNAUTHORIZED','36CWQZIC','userId','price','DESC','forEach','order:\x20','total_price','goodsId','select','UserEntity','queryPayType','create','8uANHBo','deleteOrder','goodsInfo','user','Repository','channel','function','delete','getRawOne','370814zlPRzf','design:paramtypes','OrderService','670041lUpcjy','496602ejZNBe','find','findOne','status','userInfo','payPlatform','name','order','../crami/cramiPackage.entity','orderEntity','findAndCount','购买失败!','118472FAlVjc','cramiPackageEntity','orderId','globalConfigService','../user/user.entity','CramiPackageEntity','请先注册账号后购买商品！','createOrderId','metadata','43045qFoPZN','coverImg','payService','getOwnPropertyDescriptor','订单不存在!','1795675wCXgTQ','length','userEntity','__esModule','19928GQqGfC','HttpException','BAD_REQUEST','PayService','deleteNotPay','../globalConfig/globalConfig.service','object','save','__decorate','HttpStatus','SUM(order.price)','pay','order.status\x20=\x20:status'];_0x52c4=function(){return _0xbee64d;};return _0x52c4();}var __decorate=this&&this[_0x4688b8(0x170)]||function(_0x2b6235,_0xb224a4,_0x3a1673,_0x33120c){const _0x2f6993=_0x4688b8;var _0x1c2608=arguments[_0x2f6993(0x165)],_0x12e9d4=_0x1c2608<0x3?_0xb224a4:_0x33120c===null?_0x33120c=Object[_0x2f6993(0x162)](_0xb224a4,_0x3a1673):_0x33120c,_0x1d0b6f;if(typeof Reflect===_0x2f6993(0x16e)&&typeof Reflect[_0x2f6993(0x177)]===_0x2f6993(0x19b))_0x12e9d4=Reflect['decorate'](_0x2b6235,_0xb224a4,_0x3a1673,_0x33120c);else{for(var _0x4b6c1a=_0x2b6235[_0x2f6993(0x165)]-0x1;_0x4b6c1a>=0x0;_0x4b6c1a--)if(_0x1d0b6f=_0x2b6235[_0x4b6c1a])_0x12e9d4=(_0x1c2608<0x3?_0x1d0b6f(_0x12e9d4):_0x1c2608>0x3?_0x1d0b6f(_0xb224a4,_0x3a1673,_0x12e9d4):_0x1d0b6f(_0xb224a4,_0x3a1673))||_0x12e9d4;}return _0x1c2608>0x3&&_0x12e9d4&&Object[_0x2f6993(0x180)](_0xb224a4,_0x3a1673,_0x12e9d4),_0x12e9d4;},__metadata=this&&this[_0x4688b8(0x182)]||function(_0x564ee4,_0x3415ea){const _0x19c772=_0x4688b8;if(typeof Reflect===_0x19c772(0x16e)&&typeof Reflect['metadata']===_0x19c772(0x19b))return Reflect[_0x19c772(0x15e)](_0x564ee4,_0x3415ea);},__param=this&&this[_0x4688b8(0x175)]||function(_0x210ea9,_0x3a8eef){return function(_0x3cb090,_0x2aa752){_0x3a8eef(_0x3cb090,_0x2aa752,_0x210ea9);};};Object['defineProperty'](exports,_0x4688b8(0x167),{'value':!![]}),exports[_0x4688b8(0x1a0)]=void 0x0;const user_entity_1=require(_0x4688b8(0x15a)),typeorm_1=require(_0x4688b8(0x186)),common_1=require('@nestjs/common'),typeorm_2=require(_0x4688b8(0x184)),order_entity_1=require('./order.entity'),cramiPackage_entity_1=require(_0x4688b8(0x1aa)),utils_1=require('../../common/utils'),pay_service_1=require('../pay/pay.service'),globalConfig_service_1=require(_0x4688b8(0x16d));let OrderService=class OrderService{constructor(_0x17868b,_0x45e356,_0x59d2ca,_0x76c27b,_0x2554ab){const _0x44ad8d=_0x4688b8;this[_0x44ad8d(0x1ab)]=_0x17868b,this[_0x44ad8d(0x1af)]=_0x45e356,this[_0x44ad8d(0x166)]=_0x59d2ca,this[_0x44ad8d(0x161)]=_0x76c27b,this[_0x44ad8d(0x159)]=_0x2554ab;}async['buy'](_0x326b67,_0x3a3d20){const _0x188999=_0x4688b8;try{const {goodsId:_0x20e1cb,count:count=0x1,payType:_0x18c33}=_0x326b67,{id:_0x56a8f6}=_0x3a3d20['user'];if(_0x56a8f6>0xf4240)throw new common_1[(_0x188999(0x169))](_0x188999(0x15c),common_1[_0x188999(0x171)][_0x188999(0x188)]);const _0x519d7b=await this['create'](_0x56a8f6,_0x20e1cb,count,_0x18c33),_0x239817=await this[_0x188999(0x161)][_0x188999(0x173)](_0x56a8f6,_0x519d7b[_0x188999(0x1b0)],_0x18c33);return Object[_0x188999(0x179)](Object[_0x188999(0x179)]({},_0x239817),{'orderId':_0x519d7b[_0x188999(0x1b0)],'platform':_0x519d7b[_0x188999(0x1a7)],'total':_0x519d7b[_0x188999(0x181)]});}catch(_0x1e48bc){if(_0x1e48bc[_0x188999(0x1a5)]===0x191)throw new common_1['HttpException'](_0x1e48bc[_0x188999(0x17b)],common_1[_0x188999(0x171)][_0x188999(0x188)]);throw new common_1[(_0x188999(0x169))](_0x1e48bc['message']||_0x188999(0x1ad),common_1['HttpStatus'][_0x188999(0x16a)]);}}async[_0x4688b8(0x17f)](_0x2c0dba,_0x3b30bc){const _0x3bafea=_0x4688b8,{id:_0x20b8dc}=_0x2c0dba[_0x3bafea(0x198)],{orderId:_0x185855}=_0x3b30bc,_0x1957a4=await this['orderEntity']['findOne']({'where':{'userId':_0x20b8dc,'orderId':_0x185855}});if(!_0x1957a4)throw new common_1['HttpException'](_0x3bafea(0x163),common_1[_0x3bafea(0x171)][_0x3bafea(0x16a)]);return _0x1957a4;}async[_0x4688b8(0x194)](_0x2117ff,_0x12cf4c,_0x40e9e2,_0x52e5b0){const _0x2e19fa=_0x4688b8,_0x2f040c=await this[_0x2e19fa(0x159)][_0x2e19fa(0x193)](),_0x84058b=await this['cramiPackageEntity'][_0x2e19fa(0x1a4)]({'where':{'id':_0x12cf4c}});if(!_0x84058b)throw new common_1[(_0x2e19fa(0x169))]('套餐不存在!',common_1[_0x2e19fa(0x171)][_0x2e19fa(0x16a)]);const _0x3b49e2={};_0x3b49e2[_0x2e19fa(0x1b0)]=(0x0,utils_1[_0x2e19fa(0x15d)])(),_0x3b49e2['userId']=_0x2117ff,_0x3b49e2['goodsId']=_0x12cf4c,_0x3b49e2[_0x2e19fa(0x18b)]=Number(_0x84058b[_0x2e19fa(0x18b)]),_0x3b49e2['count']=_0x40e9e2,_0x3b49e2['total']=Number(_0x84058b[_0x2e19fa(0x18b)])*_0x40e9e2,_0x3b49e2[_0x2e19fa(0x1a7)]=_0x2f040c,_0x3b49e2[_0x2e19fa(0x19a)]=_0x52e5b0;const _0x5bdffd=await this[_0x2e19fa(0x1ab)][_0x2e19fa(0x16f)](_0x3b49e2);return console['log'](_0x2e19fa(0x18e),_0x5bdffd),_0x5bdffd;}async[_0x4688b8(0x176)](_0x34424d,_0x55c93c,_0x78d9da){const _0x29218d=_0x4688b8;return await this['orderEntity'][_0x29218d(0x1ac)]({'where':{'userId':_0x34424d},'order':{'id':_0x29218d(0x18c)},'skip':(_0x55c93c-0x1)*_0x78d9da,'take':_0x78d9da});}async['queryAllOrder'](_0x5069e7){const _0x18930e=_0x4688b8,{page:_0x3cb3a7,size:_0x394e4d,userId:_0x2fcdf5,platform:_0x5fc209,status:_0x297031}=_0x5069e7,_0x3180eb={};if(_0x2fcdf5)_0x3180eb[_0x18930e(0x18a)]=_0x2fcdf5;if(_0x5fc209)_0x3180eb[_0x18930e(0x1a7)]=_0x5fc209;if(_0x297031)_0x3180eb[_0x18930e(0x1a5)]=_0x297031;const [_0x581c42,_0x38c900]=await this[_0x18930e(0x1ab)]['findAndCount']({'order':{'id':_0x18930e(0x18c)},'where':_0x3180eb,'skip':(_0x3cb3a7-0x1)*_0x394e4d,'take':_0x394e4d}),_0x2777e8=_0x581c42[_0x18930e(0x178)](_0x53b696=>_0x53b696[_0x18930e(0x18a)]),_0x4151ec=_0x581c42['map'](_0x4c2d6c=>_0x4c2d6c[_0x18930e(0x190)]),_0x338132=await this[_0x18930e(0x166)][_0x18930e(0x1a3)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2777e8)},'select':['id',_0x18930e(0x187),_0x18930e(0x185)]}),_0x3d0930=await this[_0x18930e(0x1af)][_0x18930e(0x1a3)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4151ec)},'select':['id',_0x18930e(0x1a8),_0x18930e(0x160),_0x18930e(0x17d)]});_0x581c42[_0x18930e(0x18d)](_0x3440b6=>{const _0x3ac63c=_0x18930e;_0x3440b6[_0x3ac63c(0x1a6)]=_0x338132[_0x3ac63c(0x1a3)](_0x1b7b06=>_0x1b7b06['id']===_0x3440b6[_0x3ac63c(0x18a)]),_0x3440b6[_0x3ac63c(0x197)]=_0x3d0930[_0x3ac63c(0x1a3)](_0x16b8f3=>_0x16b8f3['id']===_0x3440b6[_0x3ac63c(0x190)]);});const _0xca5a05=await this[_0x18930e(0x1ab)][_0x18930e(0x183)](_0x18930e(0x1a9))[_0x18930e(0x17a)](_0x18930e(0x174),{'status':0x1})[_0x18930e(0x191)](_0x18930e(0x172),_0x18930e(0x18f))[_0x18930e(0x19d)]();return Object[_0x18930e(0x179)]({'rows':_0x581c42,'count':_0x38c900},_0xca5a05);}async[_0x4688b8(0x196)](_0x1bbea6){const _0x4c1615=_0x4688b8,{orderId:_0x3f16be}=_0x1bbea6,_0x5c2917=await this[_0x4c1615(0x1ab)][_0x4c1615(0x1a4)]({'where':{'orderId':_0x3f16be}});if(!_0x5c2917)throw new common_1[(_0x4c1615(0x169))]('订单不存在!',common_1[_0x4c1615(0x171)]['BAD_REQUEST']);return await this['orderEntity'][_0x4c1615(0x19c)]({'orderId':_0x3f16be});}async[_0x4688b8(0x16c)](){const _0xf4d340=_0x4688b8;return await this[_0xf4d340(0x1ab)]['delete']({'status':0x0});}};OrderService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x4688b8(0x17e)])(order_entity_1['OrderEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x4688b8(0x15b)])),__param(0x2,(0x0,typeorm_1[_0x4688b8(0x17e)])(user_entity_1[_0x4688b8(0x192)])),__metadata(_0x4688b8(0x19f),[typeorm_2[_0x4688b8(0x199)],typeorm_2[_0x4688b8(0x199)],typeorm_2[_0x4688b8(0x199)],pay_service_1[_0x4688b8(0x16b)],globalConfig_service_1[_0x4688b8(0x17c)]])],OrderService),exports['OrderService']=OrderService;