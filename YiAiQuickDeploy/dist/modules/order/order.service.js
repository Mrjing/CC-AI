'use strict';const _0x49421b=_0x4eb5;(function(_0x165fa1,_0x111fd5){const _0x21a96f=_0x4eb5,_0x1b77d2=_0x165fa1();while(!![]){try{const _0x388c93=parseInt(_0x21a96f(0x1c7))/0x1*(parseInt(_0x21a96f(0x1cb))/0x2)+parseInt(_0x21a96f(0x211))/0x3*(-parseInt(_0x21a96f(0x1e9))/0x4)+-parseInt(_0x21a96f(0x1f0))/0x5+-parseInt(_0x21a96f(0x20b))/0x6*(-parseInt(_0x21a96f(0x1e7))/0x7)+-parseInt(_0x21a96f(0x212))/0x8*(-parseInt(_0x21a96f(0x1fe))/0x9)+-parseInt(_0x21a96f(0x1ca))/0xa*(parseInt(_0x21a96f(0x1d6))/0xb)+parseInt(_0x21a96f(0x1cc))/0xc;if(_0x388c93===_0x111fd5)break;else _0x1b77d2['push'](_0x1b77d2['shift']());}catch(_0x1bee92){_0x1b77d2['push'](_0x1b77d2['shift']());}}}(_0x8442,0xd16fc));function _0x8442(){const _0x55b9f0=['delete','username','orderEntity','userInfo','defineProperty','message','357500sPCehb','DESC','__param','InjectRepository','HttpException','../globalConfig/globalConfig.service','queryPayType','select','buy','orderId','Repository','des','assign','PayService','coverImg','object','channel','8151031xnuHXF','where','1914448eeaPJH','../crami/cramiPackage.entity','queryAllOrder','@nestjs/common','__decorate','name','deleteNotPay','6322245PAlRKD','goodsId','query','decorate','./order.entity','find','findAndCount','userId','create','payService','BAD_REQUEST','user','__metadata','OrderService','9IceOcY','length','total','请先注册账号后购买商品！','function','save','total_price','goodsInfo','payPlatform','UNAUTHORIZED','购买失败!','createQueryBuilder','status','6CPApSk','price','套餐不存在!','../pay/pay.service','queryByOrderId','design:paramtypes','3QybTQK','4975240ZazquG','deleteOrder','cramiPackageEntity','findOne','map','HttpStatus','675781OHcoqm','getRawOne','createOrderId','130gmiZAe','2uoGqeo','6735528XVpSGI','order.status\x20=\x20:status','metadata','订单不存在!'];_0x8442=function(){return _0x55b9f0;};return _0x8442();}var __decorate=this&&this[_0x49421b(0x1ed)]||function(_0x4506c7,_0x49fbd0,_0x3f292,_0x4e785e){const _0x58a024=_0x49421b;var _0x4effc0=arguments[_0x58a024(0x1ff)],_0x481951=_0x4effc0<0x3?_0x49fbd0:_0x4e785e===null?_0x4e785e=Object['getOwnPropertyDescriptor'](_0x49fbd0,_0x3f292):_0x4e785e,_0x3f3d4a;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x58a024(0x202))_0x481951=Reflect[_0x58a024(0x1f3)](_0x4506c7,_0x49fbd0,_0x3f292,_0x4e785e);else{for(var _0x2a4798=_0x4506c7[_0x58a024(0x1ff)]-0x1;_0x2a4798>=0x0;_0x2a4798--)if(_0x3f3d4a=_0x4506c7[_0x2a4798])_0x481951=(_0x4effc0<0x3?_0x3f3d4a(_0x481951):_0x4effc0>0x3?_0x3f3d4a(_0x49fbd0,_0x3f292,_0x481951):_0x3f3d4a(_0x49fbd0,_0x3f292))||_0x481951;}return _0x4effc0>0x3&&_0x481951&&Object['defineProperty'](_0x49fbd0,_0x3f292,_0x481951),_0x481951;},__metadata=this&&this[_0x49421b(0x1fc)]||function(_0x51b698,_0x1ccaf9){const _0x85ca=_0x49421b;if(typeof Reflect===_0x85ca(0x1e5)&&typeof Reflect[_0x85ca(0x1ce)]===_0x85ca(0x202))return Reflect[_0x85ca(0x1ce)](_0x51b698,_0x1ccaf9);},__param=this&&this[_0x49421b(0x1d8)]||function(_0x37e7a3,_0x597a65){return function(_0x4b7f23,_0x4a460f){_0x597a65(_0x4b7f23,_0x4a460f,_0x37e7a3);};};Object[_0x49421b(0x1d4)](exports,'__esModule',{'value':!![]}),exports[_0x49421b(0x1fd)]=void 0x0;const user_entity_1=require('../user/user.entity'),typeorm_1=require('@nestjs/typeorm'),common_1=require(_0x49421b(0x1ec)),typeorm_2=require('typeorm'),order_entity_1=require(_0x49421b(0x1f4)),cramiPackage_entity_1=require(_0x49421b(0x1ea)),utils_1=require('../../common/utils'),pay_service_1=require(_0x49421b(0x20e)),globalConfig_service_1=require(_0x49421b(0x1db));function _0x4eb5(_0x27c6fd,_0x5b9acf){const _0x8442d2=_0x8442();return _0x4eb5=function(_0x4eb5f3,_0x45626d){_0x4eb5f3=_0x4eb5f3-0x1c3;let _0x129626=_0x8442d2[_0x4eb5f3];return _0x129626;},_0x4eb5(_0x27c6fd,_0x5b9acf);}let OrderService=class OrderService{constructor(_0x1b1d23,_0x50cf4e,_0xd4fe31,_0x40b90e,_0x3c7b4b){const _0x5c57a8=_0x49421b;this[_0x5c57a8(0x1d2)]=_0x1b1d23,this[_0x5c57a8(0x1c3)]=_0x50cf4e,this['userEntity']=_0xd4fe31,this[_0x5c57a8(0x1f9)]=_0x40b90e,this['globalConfigService']=_0x3c7b4b;}async[_0x49421b(0x1de)](_0x4dd86a,_0x159075){const _0x49b81=_0x49421b;try{const {goodsId:_0x51475e,count:count=0x1,payType:_0x47d7be}=_0x4dd86a,{id:_0x5b146c}=_0x159075[_0x49b81(0x1fb)];if(_0x5b146c>0xf4240)throw new common_1[(_0x49b81(0x1da))](_0x49b81(0x201),common_1['HttpStatus'][_0x49b81(0x207)]);const _0x21aa79=await this[_0x49b81(0x1f8)](_0x5b146c,_0x51475e,count,_0x47d7be),_0x2f81a1=await this[_0x49b81(0x1f9)]['pay'](_0x5b146c,_0x21aa79[_0x49b81(0x1df)],_0x47d7be);return Object[_0x49b81(0x1e2)](Object[_0x49b81(0x1e2)]({},_0x2f81a1),{'orderId':_0x21aa79[_0x49b81(0x1df)],'platform':_0x21aa79[_0x49b81(0x206)],'total':_0x21aa79[_0x49b81(0x200)]});}catch(_0x4bf05c){if(_0x4bf05c['status']===0x191)throw new common_1['HttpException'](_0x4bf05c[_0x49b81(0x1d5)],common_1[_0x49b81(0x1c6)][_0x49b81(0x207)]);throw new common_1[(_0x49b81(0x1da))](_0x4bf05c[_0x49b81(0x1d5)]||_0x49b81(0x208),common_1[_0x49b81(0x1c6)][_0x49b81(0x1fa)]);}}async[_0x49421b(0x20f)](_0x26b3f5,_0x4198c1){const _0x2c3b30=_0x49421b,{id:_0x319294}=_0x26b3f5[_0x2c3b30(0x1fb)],{orderId:_0x36ed3}=_0x4198c1,_0x2a50da=await this[_0x2c3b30(0x1d2)]['findOne']({'where':{'userId':_0x319294,'orderId':_0x36ed3}});if(!_0x2a50da)throw new common_1[(_0x2c3b30(0x1da))](_0x2c3b30(0x1cf),common_1[_0x2c3b30(0x1c6)]['BAD_REQUEST']);return _0x2a50da;}async[_0x49421b(0x1f8)](_0xc89892,_0x18f178,_0x26cfed,_0xa14c26){const _0x1e3ebc=_0x49421b,_0x26282e=await this['globalConfigService'][_0x1e3ebc(0x1dc)](),_0x4256eb=await this[_0x1e3ebc(0x1c3)][_0x1e3ebc(0x1c4)]({'where':{'id':_0x18f178}});if(!_0x4256eb)throw new common_1[(_0x1e3ebc(0x1da))](_0x1e3ebc(0x20d),common_1[_0x1e3ebc(0x1c6)][_0x1e3ebc(0x1fa)]);const _0x1561d8={};_0x1561d8[_0x1e3ebc(0x1df)]=(0x0,utils_1[_0x1e3ebc(0x1c9)])(),_0x1561d8[_0x1e3ebc(0x1f7)]=_0xc89892,_0x1561d8['goodsId']=_0x18f178,_0x1561d8[_0x1e3ebc(0x20c)]=Number(_0x4256eb[_0x1e3ebc(0x20c)]),_0x1561d8['count']=_0x26cfed,_0x1561d8[_0x1e3ebc(0x200)]=Number(_0x4256eb['price'])*_0x26cfed,_0x1561d8[_0x1e3ebc(0x206)]=_0x26282e,_0x1561d8[_0x1e3ebc(0x1e6)]=_0xa14c26;const _0x15ea26=await this[_0x1e3ebc(0x1d2)][_0x1e3ebc(0x203)](_0x1561d8);return console['log']('order:\x20',_0x15ea26),_0x15ea26;}async[_0x49421b(0x1f2)](_0x1538b9,_0x5a3872,_0x48a98b){const _0x568926=_0x49421b;return await this['orderEntity'][_0x568926(0x1f6)]({'where':{'userId':_0x1538b9},'order':{'id':_0x568926(0x1d7)},'skip':(_0x5a3872-0x1)*_0x48a98b,'take':_0x48a98b});}async[_0x49421b(0x1eb)](_0x570f28){const _0x20bc49=_0x49421b,{page:_0x1e6107,size:_0x59c35f,userId:_0x298956,platform:_0x625bb,status:_0x34cd3a}=_0x570f28,_0x191528={};if(_0x298956)_0x191528[_0x20bc49(0x1f7)]=_0x298956;if(_0x625bb)_0x191528['payPlatform']=_0x625bb;if(_0x34cd3a)_0x191528[_0x20bc49(0x20a)]=_0x34cd3a;const [_0x3f6fc7,_0x1cc2b9]=await this[_0x20bc49(0x1d2)][_0x20bc49(0x1f6)]({'order':{'id':_0x20bc49(0x1d7)},'where':_0x191528,'skip':(_0x1e6107-0x1)*_0x59c35f,'take':_0x59c35f}),_0x3f9e1e=_0x3f6fc7[_0x20bc49(0x1c5)](_0x590f29=>_0x590f29[_0x20bc49(0x1f7)]),_0x4e534c=_0x3f6fc7[_0x20bc49(0x1c5)](_0x3f85a9=>_0x3f85a9[_0x20bc49(0x1f1)]),_0x3d0350=await this['userEntity'][_0x20bc49(0x1f5)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3f9e1e)},'select':['id',_0x20bc49(0x1d1),'email']}),_0x4a1b40=await this['cramiPackageEntity'][_0x20bc49(0x1f5)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4e534c)},'select':['id',_0x20bc49(0x1ee),_0x20bc49(0x1e4),_0x20bc49(0x1e1)]});_0x3f6fc7['forEach'](_0x38453f=>{const _0x2bd4af=_0x20bc49;_0x38453f[_0x2bd4af(0x1d3)]=_0x3d0350[_0x2bd4af(0x1f5)](_0x26d60d=>_0x26d60d['id']===_0x38453f['userId']),_0x38453f[_0x2bd4af(0x205)]=_0x4a1b40[_0x2bd4af(0x1f5)](_0xecedb8=>_0xecedb8['id']===_0x38453f[_0x2bd4af(0x1f1)]);});const _0x58277f=await this[_0x20bc49(0x1d2)][_0x20bc49(0x209)]('order')[_0x20bc49(0x1e8)](_0x20bc49(0x1cd),{'status':0x1})[_0x20bc49(0x1dd)]('SUM(order.price)',_0x20bc49(0x204))[_0x20bc49(0x1c8)]();return Object[_0x20bc49(0x1e2)]({'rows':_0x3f6fc7,'count':_0x1cc2b9},_0x58277f);}async[_0x49421b(0x213)](_0x3840d1){const _0x57186d=_0x49421b,{orderId:_0x6dca9f}=_0x3840d1,_0x8ef6c9=await this[_0x57186d(0x1d2)][_0x57186d(0x1c4)]({'where':{'orderId':_0x6dca9f}});if(!_0x8ef6c9)throw new common_1['HttpException'](_0x57186d(0x1cf),common_1[_0x57186d(0x1c6)][_0x57186d(0x1fa)]);return await this[_0x57186d(0x1d2)]['delete']({'orderId':_0x6dca9f});}async[_0x49421b(0x1ef)](){const _0x28c6e2=_0x49421b;return await this[_0x28c6e2(0x1d2)][_0x28c6e2(0x1d0)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(order_entity_1['OrderEntity'])),__param(0x1,(0x0,typeorm_1[_0x49421b(0x1d9)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__metadata(_0x49421b(0x210),[typeorm_2['Repository'],typeorm_2[_0x49421b(0x1e0)],typeorm_2['Repository'],pay_service_1[_0x49421b(0x1e3)],globalConfig_service_1['GlobalConfigService']])],OrderService),exports[_0x49421b(0x1fd)]=OrderService;