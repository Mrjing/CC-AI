'use strict';function _0x53ea(_0x2969b0,_0x256f24){const _0x3505d6=_0x3505();return _0x53ea=function(_0x53ead1,_0x26ff8e){_0x53ead1=_0x53ead1-0x95;let _0x191605=_0x3505d6[_0x53ead1];return _0x191605;},_0x53ea(_0x2969b0,_0x256f24);}const _0x283730=_0x53ea;(function(_0x42e521,_0x33d77d){const _0x264072=_0x53ea,_0x3915c2=_0x42e521();while(!![]){try{const _0x5c0a91=-parseInt(_0x264072(0xeb))/0x1+parseInt(_0x264072(0xc9))/0x2*(parseInt(_0x264072(0xb0))/0x3)+-parseInt(_0x264072(0x9a))/0x4+parseInt(_0x264072(0xdb))/0x5*(-parseInt(_0x264072(0xaa))/0x6)+-parseInt(_0x264072(0xc7))/0x7*(parseInt(_0x264072(0xdf))/0x8)+-parseInt(_0x264072(0x9b))/0x9+parseInt(_0x264072(0xb3))/0xa;if(_0x5c0a91===_0x33d77d)break;else _0x3915c2['push'](_0x3915c2['shift']());}catch(_0xd298ed){_0x3915c2['push'](_0x3915c2['shift']());}}}(_0x3505,0xb49b9));var __decorate=this&&this[_0x283730(0xd1)]||function(_0x1f0ed9,_0x487608,_0x54f520,_0x163893){const _0x268a9e=_0x283730;var _0x2e7e9c=arguments[_0x268a9e(0xd3)],_0x1c9636=_0x2e7e9c<0x3?_0x487608:_0x163893===null?_0x163893=Object['getOwnPropertyDescriptor'](_0x487608,_0x54f520):_0x163893,_0x171304;if(typeof Reflect===_0x268a9e(0xc1)&&typeof Reflect['decorate']===_0x268a9e(0xd5))_0x1c9636=Reflect['decorate'](_0x1f0ed9,_0x487608,_0x54f520,_0x163893);else{for(var _0xc6c2ac=_0x1f0ed9[_0x268a9e(0xd3)]-0x1;_0xc6c2ac>=0x0;_0xc6c2ac--)if(_0x171304=_0x1f0ed9[_0xc6c2ac])_0x1c9636=(_0x2e7e9c<0x3?_0x171304(_0x1c9636):_0x2e7e9c>0x3?_0x171304(_0x487608,_0x54f520,_0x1c9636):_0x171304(_0x487608,_0x54f520))||_0x1c9636;}return _0x2e7e9c>0x3&&_0x1c9636&&Object[_0x268a9e(0xbe)](_0x487608,_0x54f520,_0x1c9636),_0x1c9636;},__metadata=this&&this[_0x283730(0xad)]||function(_0x1aeb52,_0x50ce49){const _0x153d07=_0x283730;if(typeof Reflect===_0x153d07(0xc1)&&typeof Reflect[_0x153d07(0xd8)]===_0x153d07(0xd5))return Reflect['metadata'](_0x1aeb52,_0x50ce49);},__param=this&&this[_0x283730(0xac)]||function(_0x6324b,_0x5d034b){return function(_0x2dbc83,_0xda4f46){_0x5d034b(_0x2dbc83,_0xda4f46,_0x6324b);};};Object[_0x283730(0xbe)](exports,_0x283730(0xe5),{'value':!![]}),exports[_0x283730(0xb2)]=void 0x0;function _0x3505(){const _0x54b1f2=['7EkFCUY','total','2JOgTcr','queryPayType','queryByOrderId','cramiPackageEntity','message','delete','PayService','findOne','__decorate','UserEntity','length','map','function','where','createQueryBuilder','metadata','userId','email','33955XyOepQ','../globalConfig/globalConfig.service','../pay/pay.service','save','562736gxmhrB','HttpStatus','queryAllOrder','Injectable','order:\x20','userEntity','__esModule','DESC','name','count','getRawOne','userInfo','351955GxCZHz','HttpException','Repository','UNAUTHORIZED','des','../../common/utils','1015660qjpqEq','133164oFeVUB','username','orderId','goodsId','typeorm','@nestjs/common','BAD_REQUEST','assign','购买失败!','find','payPlatform','user','log','findAndCount','buy','1002xXTyFE','order','__param','__metadata','请先注册账号后购买商品！','query','3792372DQYiDK','goodsInfo','OrderService','13007500XZEAwP','../user/user.entity','deleteNotPay','select','total_price','InjectRepository','channel','globalConfigService','order.status\x20=\x20:status','payService','订单不存在!','defineProperty','status','create','object','price','design:paramtypes','../crami/cramiPackage.entity','orderEntity','OrderEntity'];_0x3505=function(){return _0x54b1f2;};return _0x3505();}const user_entity_1=require(_0x283730(0xb4)),typeorm_1=require('@nestjs/typeorm'),common_1=require(_0x283730(0xa0)),typeorm_2=require(_0x283730(0x9f)),order_entity_1=require('./order.entity'),cramiPackage_entity_1=require(_0x283730(0xc4)),utils_1=require(_0x283730(0x99)),pay_service_1=require(_0x283730(0xdd)),globalConfig_service_1=require(_0x283730(0xdc));let OrderService=class OrderService{constructor(_0x3cf184,_0x3c54be,_0x1c6a67,_0xe2b19f,_0xd2a59f){const _0x4d8710=_0x283730;this[_0x4d8710(0xc5)]=_0x3cf184,this['cramiPackageEntity']=_0x3c54be,this[_0x4d8710(0xe4)]=_0x1c6a67,this[_0x4d8710(0xbc)]=_0xe2b19f,this[_0x4d8710(0xba)]=_0xd2a59f;}async[_0x283730(0xa9)](_0x4701b8,_0x2f4d78){const _0x314fd8=_0x283730;try{const {goodsId:_0x59a139,count:count=0x1,payType:_0x23c40c}=_0x4701b8,{id:_0x5382a9}=_0x2f4d78[_0x314fd8(0xa6)];if(_0x5382a9>0xf4240)throw new common_1[(_0x314fd8(0x95))](_0x314fd8(0xae),common_1['HttpStatus'][_0x314fd8(0x97)]);const _0x3be92e=await this[_0x314fd8(0xc0)](_0x5382a9,_0x59a139,count,_0x23c40c),_0x12f639=await this[_0x314fd8(0xbc)]['pay'](_0x5382a9,_0x3be92e[_0x314fd8(0x9d)],_0x23c40c);return Object[_0x314fd8(0xa2)](Object[_0x314fd8(0xa2)]({},_0x12f639),{'orderId':_0x3be92e[_0x314fd8(0x9d)],'platform':_0x3be92e['payPlatform'],'total':_0x3be92e[_0x314fd8(0xc8)]});}catch(_0x13f178){if(_0x13f178[_0x314fd8(0xbf)]===0x191)throw new common_1[(_0x314fd8(0x95))](_0x13f178[_0x314fd8(0xcd)],common_1['HttpStatus'][_0x314fd8(0x97)]);throw new common_1[(_0x314fd8(0x95))](_0x13f178[_0x314fd8(0xcd)]||_0x314fd8(0xa3),common_1[_0x314fd8(0xe0)][_0x314fd8(0xa1)]);}}async[_0x283730(0xcb)](_0x54aceb,_0x3c00d5){const _0xd6fd12=_0x283730,{id:_0x5260e0}=_0x54aceb['user'],{orderId:_0x510388}=_0x3c00d5,_0x322c86=await this[_0xd6fd12(0xc5)]['findOne']({'where':{'userId':_0x5260e0,'orderId':_0x510388}});if(!_0x322c86)throw new common_1['HttpException'](_0xd6fd12(0xbd),common_1['HttpStatus'][_0xd6fd12(0xa1)]);return _0x322c86;}async[_0x283730(0xc0)](_0x2d7326,_0x2724ec,_0x4346fa,_0xc5269c){const _0x415ef9=_0x283730,_0x32abde=await this[_0x415ef9(0xba)][_0x415ef9(0xca)](),_0x363617=await this[_0x415ef9(0xcc)][_0x415ef9(0xd0)]({'where':{'id':_0x2724ec}});if(!_0x363617)throw new common_1['HttpException']('套餐不存在!',common_1['HttpStatus']['BAD_REQUEST']);const _0x1a7eea={};_0x1a7eea[_0x415ef9(0x9d)]=(0x0,utils_1['createOrderId'])(),_0x1a7eea[_0x415ef9(0xd9)]=_0x2d7326,_0x1a7eea['goodsId']=_0x2724ec,_0x1a7eea['price']=Number(_0x363617[_0x415ef9(0xc2)]),_0x1a7eea[_0x415ef9(0xe8)]=_0x4346fa,_0x1a7eea[_0x415ef9(0xc8)]=Number(_0x363617['price'])*_0x4346fa,_0x1a7eea[_0x415ef9(0xa5)]=_0x32abde,_0x1a7eea[_0x415ef9(0xb9)]=_0xc5269c;const _0x2f446e=await this['orderEntity'][_0x415ef9(0xde)](_0x1a7eea);return console[_0x415ef9(0xa7)](_0x415ef9(0xe3),_0x2f446e),_0x2f446e;}async[_0x283730(0xaf)](_0xf4a43e,_0x10e1ff,_0x57b3b8){const _0x26f582=_0x283730;return await this[_0x26f582(0xc5)][_0x26f582(0xa8)]({'where':{'userId':_0xf4a43e},'order':{'id':_0x26f582(0xe6)},'skip':(_0x10e1ff-0x1)*_0x57b3b8,'take':_0x57b3b8});}async[_0x283730(0xe1)](_0xca8197){const _0x5537e0=_0x283730,{page:_0x10f3fe,size:_0x4533d8,userId:_0x4f92df,platform:_0x5bd068,status:_0x54234f}=_0xca8197,_0x1dcebf={};if(_0x4f92df)_0x1dcebf[_0x5537e0(0xd9)]=_0x4f92df;if(_0x5bd068)_0x1dcebf[_0x5537e0(0xa5)]=_0x5bd068;if(_0x54234f)_0x1dcebf[_0x5537e0(0xbf)]=_0x54234f;const [_0xaf170d,_0x55b2dc]=await this[_0x5537e0(0xc5)]['findAndCount']({'order':{'id':_0x5537e0(0xe6)},'where':_0x1dcebf,'skip':(_0x10f3fe-0x1)*_0x4533d8,'take':_0x4533d8}),_0xb7d0ce=_0xaf170d[_0x5537e0(0xd4)](_0x494d97=>_0x494d97[_0x5537e0(0xd9)]),_0x658698=_0xaf170d[_0x5537e0(0xd4)](_0x142892=>_0x142892[_0x5537e0(0x9e)]),_0x1ab20c=await this[_0x5537e0(0xe4)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0xb7d0ce)},'select':['id',_0x5537e0(0x9c),_0x5537e0(0xda)]}),_0x5beed3=await this[_0x5537e0(0xcc)][_0x5537e0(0xa4)]({'where':{'id':(0x0,typeorm_2['In'])(_0x658698)},'select':['id',_0x5537e0(0xe7),'coverImg',_0x5537e0(0x98)]});_0xaf170d['forEach'](_0x1c1f52=>{const _0x414745=_0x5537e0;_0x1c1f52[_0x414745(0xea)]=_0x1ab20c[_0x414745(0xa4)](_0x2649d3=>_0x2649d3['id']===_0x1c1f52[_0x414745(0xd9)]),_0x1c1f52[_0x414745(0xb1)]=_0x5beed3[_0x414745(0xa4)](_0x33afe5=>_0x33afe5['id']===_0x1c1f52['goodsId']);});const _0x1f5ffe=await this['orderEntity'][_0x5537e0(0xd7)](_0x5537e0(0xab))[_0x5537e0(0xd6)](_0x5537e0(0xbb),{'status':0x1})[_0x5537e0(0xb6)]('SUM(order.price)',_0x5537e0(0xb7))[_0x5537e0(0xe9)]();return Object['assign']({'rows':_0xaf170d,'count':_0x55b2dc},_0x1f5ffe);}async['deleteOrder'](_0x32b558){const _0xfa8466=_0x283730,{orderId:_0x23b4a4}=_0x32b558,_0x587b31=await this['orderEntity']['findOne']({'where':{'orderId':_0x23b4a4}});if(!_0x587b31)throw new common_1[(_0xfa8466(0x95))](_0xfa8466(0xbd),common_1[_0xfa8466(0xe0)][_0xfa8466(0xa1)]);return await this[_0xfa8466(0xc5)][_0xfa8466(0xce)]({'orderId':_0x23b4a4});}async[_0x283730(0xb5)](){const _0xb17316=_0x283730;return await this['orderEntity'][_0xb17316(0xce)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x283730(0xe2)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x283730(0xc6)])),__param(0x1,(0x0,typeorm_1[_0x283730(0xb8)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1[_0x283730(0xb8)])(user_entity_1[_0x283730(0xd2)])),__metadata(_0x283730(0xc3),[typeorm_2['Repository'],typeorm_2[_0x283730(0x96)],typeorm_2['Repository'],pay_service_1[_0x283730(0xcf)],globalConfig_service_1['GlobalConfigService']])],OrderService),exports[_0x283730(0xb2)]=OrderService;