'use strict';const _0xfeaffd=_0x5dc9;function _0x657d(){const _0x15e9eb=['map','select','globalConfigService','findOne','findAndCount','CramiPackageEntity','deleteOrder','length','154889DiBONp','OrderService','请先注册账号后购买商品！','1012iLlIxz','queryAllOrder','Repository','queryByOrderId','price','userEntity','getOwnPropertyDescriptor','./order.entity','HttpException','套餐不存在!','user','../globalConfig/globalConfig.service','goodsId','queryPayType','total_price','des','decorate','orderId','orderEntity','name','status','DESC','171RMvIYZ','object','UNAUTHORIZED','OrderEntity','message','__decorate','订单不存在!','metadata','26cGlMbW','30358slTjne','total','1957800IbuMXd','order:\x20','SUM(order.price)','function','defineProperty','deleteNotPay','userId','where','2314587qMUsLA','username','10YzDFqB','../crami/cramiPackage.entity','InjectRepository','Injectable','create','../pay/pay.service','购买失败!','log','__esModule','delete','135SBiRkr','userInfo','createQueryBuilder','query','cramiPackageEntity','typeorm','forEach','payPlatform','HttpStatus','goodsInfo','design:paramtypes','UserEntity','55130QSsYlR','order','payService','40MBqtfj','@nestjs/common','find','BAD_REQUEST','assign','count','save','1036554AdXdPe'];_0x657d=function(){return _0x15e9eb;};return _0x657d();}(function(_0x11694f,_0x3ecbee){const _0x5588e8=_0x5dc9,_0x1881f8=_0x11694f();while(!![]){try{const _0xf31b6d=parseInt(_0x5588e8(0x1b0))/0x1*(-parseInt(_0x5588e8(0x1af))/0x2)+-parseInt(_0x5588e8(0x1c6))/0x3*(parseInt(_0x5588e8(0x1e8))/0x4)+parseInt(_0x5588e8(0x1bc))/0x5*(parseInt(_0x5588e8(0x1dc))/0x6)+parseInt(_0x5588e8(0x1e5))/0x7*(parseInt(_0x5588e8(0x1d5))/0x8)+parseInt(_0x5588e8(0x1a7))/0x9*(parseInt(_0x5588e8(0x1d2))/0xa)+parseInt(_0x5588e8(0x1ba))/0xb+-parseInt(_0x5588e8(0x1b2))/0xc;if(_0xf31b6d===_0x3ecbee)break;else _0x1881f8['push'](_0x1881f8['shift']());}catch(_0xa6b7ca){_0x1881f8['push'](_0x1881f8['shift']());}}}(_0x657d,0x31590));var __decorate=this&&this[_0xfeaffd(0x1ac)]||function(_0x244ad1,_0x1277ff,_0x5c7459,_0x5cb280){const _0xf66888=_0xfeaffd;var _0x18bc39=arguments['length'],_0x4fb6b2=_0x18bc39<0x3?_0x1277ff:_0x5cb280===null?_0x5cb280=Object[_0xf66888(0x197)](_0x1277ff,_0x5c7459):_0x5cb280,_0x5bb246;if(typeof Reflect==='object'&&typeof Reflect[_0xf66888(0x1a1)]===_0xf66888(0x1b5))_0x4fb6b2=Reflect[_0xf66888(0x1a1)](_0x244ad1,_0x1277ff,_0x5c7459,_0x5cb280);else{for(var _0x9f9054=_0x244ad1[_0xf66888(0x1e4)]-0x1;_0x9f9054>=0x0;_0x9f9054--)if(_0x5bb246=_0x244ad1[_0x9f9054])_0x4fb6b2=(_0x18bc39<0x3?_0x5bb246(_0x4fb6b2):_0x18bc39>0x3?_0x5bb246(_0x1277ff,_0x5c7459,_0x4fb6b2):_0x5bb246(_0x1277ff,_0x5c7459))||_0x4fb6b2;}return _0x18bc39>0x3&&_0x4fb6b2&&Object[_0xf66888(0x1b6)](_0x1277ff,_0x5c7459,_0x4fb6b2),_0x4fb6b2;},__metadata=this&&this['__metadata']||function(_0x3c2bb4,_0x50c16e){const _0x8c6767=_0xfeaffd;if(typeof Reflect===_0x8c6767(0x1a8)&&typeof Reflect[_0x8c6767(0x1ae)]==='function')return Reflect[_0x8c6767(0x1ae)](_0x3c2bb4,_0x50c16e);},__param=this&&this['__param']||function(_0x42ef5a,_0x25de78){return function(_0x3ffea1,_0x1547c5){_0x25de78(_0x3ffea1,_0x1547c5,_0x42ef5a);};};Object['defineProperty'](exports,_0xfeaffd(0x1c4),{'value':!![]}),exports['OrderService']=void 0x0;const user_entity_1=require('../user/user.entity'),typeorm_1=require('@nestjs/typeorm'),common_1=require(_0xfeaffd(0x1d6)),typeorm_2=require(_0xfeaffd(0x1cb)),order_entity_1=require(_0xfeaffd(0x198)),cramiPackage_entity_1=require(_0xfeaffd(0x1bd)),utils_1=require('../../common/utils'),pay_service_1=require(_0xfeaffd(0x1c1)),globalConfig_service_1=require(_0xfeaffd(0x19c));function _0x5dc9(_0x3f7b2d,_0x5b8414){const _0x657d3f=_0x657d();return _0x5dc9=function(_0x5dc93c,_0x2cc03b){_0x5dc93c=_0x5dc93c-0x197;let _0x36fa36=_0x657d3f[_0x5dc93c];return _0x36fa36;},_0x5dc9(_0x3f7b2d,_0x5b8414);}let OrderService=class OrderService{constructor(_0x4f25d6,_0x580bf6,_0x2e5d68,_0x2aff95,_0x4c59a0){const _0x39fb20=_0xfeaffd;this[_0x39fb20(0x1a3)]=_0x4f25d6,this[_0x39fb20(0x1ca)]=_0x580bf6,this[_0x39fb20(0x1ed)]=_0x2e5d68,this['payService']=_0x2aff95,this['globalConfigService']=_0x4c59a0;}async['buy'](_0x40f79f,_0x4e5bf4){const _0x47237a=_0xfeaffd;try{const {goodsId:_0x1d092f,count:count=0x1,payType:_0x158999}=_0x40f79f,{id:_0x267862}=_0x4e5bf4[_0x47237a(0x19b)];if(_0x267862>0xf4240)throw new common_1[(_0x47237a(0x199))](_0x47237a(0x1e7),common_1[_0x47237a(0x1ce)][_0x47237a(0x1a9)]);const _0x263523=await this[_0x47237a(0x1c0)](_0x267862,_0x1d092f,count,_0x158999),_0x50530b=await this[_0x47237a(0x1d4)]['pay'](_0x267862,_0x263523[_0x47237a(0x1a2)],_0x158999);return Object[_0x47237a(0x1d9)](Object[_0x47237a(0x1d9)]({},_0x50530b),{'orderId':_0x263523[_0x47237a(0x1a2)],'platform':_0x263523[_0x47237a(0x1cd)],'total':_0x263523[_0x47237a(0x1b1)]});}catch(_0x49be10){if(_0x49be10[_0x47237a(0x1a5)]===0x191)throw new common_1[(_0x47237a(0x199))](_0x49be10[_0x47237a(0x1ab)],common_1[_0x47237a(0x1ce)][_0x47237a(0x1a9)]);throw new common_1[(_0x47237a(0x199))](_0x49be10[_0x47237a(0x1ab)]||_0x47237a(0x1c2),common_1['HttpStatus'][_0x47237a(0x1d8)]);}}async[_0xfeaffd(0x1eb)](_0x51d0ac,_0x58c54e){const _0x597d71=_0xfeaffd,{id:_0x3ddc6f}=_0x51d0ac[_0x597d71(0x19b)],{orderId:_0x362cdc}=_0x58c54e,_0x35a4db=await this[_0x597d71(0x1a3)][_0x597d71(0x1e0)]({'where':{'userId':_0x3ddc6f,'orderId':_0x362cdc}});if(!_0x35a4db)throw new common_1[(_0x597d71(0x199))](_0x597d71(0x1ad),common_1[_0x597d71(0x1ce)][_0x597d71(0x1d8)]);return _0x35a4db;}async[_0xfeaffd(0x1c0)](_0x4aaf2f,_0x5c6f33,_0x3a9cc9,_0x4fbd06){const _0x40ed62=_0xfeaffd,_0x2fb464=await this[_0x40ed62(0x1df)][_0x40ed62(0x19e)](),_0x325589=await this['cramiPackageEntity'][_0x40ed62(0x1e0)]({'where':{'id':_0x5c6f33}});if(!_0x325589)throw new common_1[(_0x40ed62(0x199))](_0x40ed62(0x19a),common_1[_0x40ed62(0x1ce)][_0x40ed62(0x1d8)]);const _0xaa238a={};_0xaa238a['orderId']=(0x0,utils_1['createOrderId'])(),_0xaa238a[_0x40ed62(0x1b8)]=_0x4aaf2f,_0xaa238a['goodsId']=_0x5c6f33,_0xaa238a[_0x40ed62(0x1ec)]=Number(_0x325589[_0x40ed62(0x1ec)]),_0xaa238a[_0x40ed62(0x1da)]=_0x3a9cc9,_0xaa238a[_0x40ed62(0x1b1)]=Number(_0x325589[_0x40ed62(0x1ec)])*_0x3a9cc9,_0xaa238a[_0x40ed62(0x1cd)]=_0x2fb464,_0xaa238a['channel']=_0x4fbd06;const _0x1d038c=await this['orderEntity'][_0x40ed62(0x1db)](_0xaa238a);return console[_0x40ed62(0x1c3)](_0x40ed62(0x1b3),_0x1d038c),_0x1d038c;}async[_0xfeaffd(0x1c9)](_0x1166c4,_0x94d8b,_0x4f5ab2){const _0x15af49=_0xfeaffd;return await this[_0x15af49(0x1a3)][_0x15af49(0x1e1)]({'where':{'userId':_0x1166c4},'order':{'id':_0x15af49(0x1a6)},'skip':(_0x94d8b-0x1)*_0x4f5ab2,'take':_0x4f5ab2});}async[_0xfeaffd(0x1e9)](_0x2dfbc1){const _0x254642=_0xfeaffd,{page:_0x1c8b59,size:_0x324012,userId:_0x50bcdd,platform:_0x57266a,status:_0x89d364}=_0x2dfbc1,_0x1e90c2={};if(_0x50bcdd)_0x1e90c2[_0x254642(0x1b8)]=_0x50bcdd;if(_0x57266a)_0x1e90c2[_0x254642(0x1cd)]=_0x57266a;if(_0x89d364)_0x1e90c2[_0x254642(0x1a5)]=_0x89d364;const [_0x2f9740,_0x4164aa]=await this[_0x254642(0x1a3)][_0x254642(0x1e1)]({'order':{'id':'DESC'},'where':_0x1e90c2,'skip':(_0x1c8b59-0x1)*_0x324012,'take':_0x324012}),_0x2d12b6=_0x2f9740['map'](_0x284f18=>_0x284f18[_0x254642(0x1b8)]),_0x3c4d53=_0x2f9740[_0x254642(0x1dd)](_0x51d2d5=>_0x51d2d5[_0x254642(0x19d)]),_0x5c9aea=await this[_0x254642(0x1ed)][_0x254642(0x1d7)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2d12b6)},'select':['id',_0x254642(0x1bb),'email']}),_0xa9f018=await this['cramiPackageEntity'][_0x254642(0x1d7)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3c4d53)},'select':['id',_0x254642(0x1a4),'coverImg',_0x254642(0x1a0)]});_0x2f9740[_0x254642(0x1cc)](_0x30e3c0=>{const _0x216e88=_0x254642;_0x30e3c0[_0x216e88(0x1c7)]=_0x5c9aea[_0x216e88(0x1d7)](_0x1c3ebb=>_0x1c3ebb['id']===_0x30e3c0[_0x216e88(0x1b8)]),_0x30e3c0[_0x216e88(0x1cf)]=_0xa9f018[_0x216e88(0x1d7)](_0x391055=>_0x391055['id']===_0x30e3c0[_0x216e88(0x19d)]);});const _0x267b65=await this[_0x254642(0x1a3)][_0x254642(0x1c8)](_0x254642(0x1d3))[_0x254642(0x1b9)]('order.status\x20=\x20:status',{'status':0x1})[_0x254642(0x1de)](_0x254642(0x1b4),_0x254642(0x19f))['getRawOne']();return Object[_0x254642(0x1d9)]({'rows':_0x2f9740,'count':_0x4164aa},_0x267b65);}async[_0xfeaffd(0x1e3)](_0x1ab63e){const _0x471e2b=_0xfeaffd,{orderId:_0x31c5bc}=_0x1ab63e,_0x533273=await this[_0x471e2b(0x1a3)]['findOne']({'where':{'orderId':_0x31c5bc}});if(!_0x533273)throw new common_1[(_0x471e2b(0x199))](_0x471e2b(0x1ad),common_1[_0x471e2b(0x1ce)][_0x471e2b(0x1d8)]);return await this[_0x471e2b(0x1a3)][_0x471e2b(0x1c5)]({'orderId':_0x31c5bc});}async[_0xfeaffd(0x1b7)](){const _0x47689a=_0xfeaffd;return await this[_0x47689a(0x1a3)][_0x47689a(0x1c5)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0xfeaffd(0x1bf)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0xfeaffd(0x1aa)])),__param(0x1,(0x0,typeorm_1[_0xfeaffd(0x1be)])(cramiPackage_entity_1[_0xfeaffd(0x1e2)])),__param(0x2,(0x0,typeorm_1[_0xfeaffd(0x1be)])(user_entity_1[_0xfeaffd(0x1d1)])),__metadata(_0xfeaffd(0x1d0),[typeorm_2[_0xfeaffd(0x1ea)],typeorm_2[_0xfeaffd(0x1ea)],typeorm_2[_0xfeaffd(0x1ea)],pay_service_1['PayService'],globalConfig_service_1['GlobalConfigService']])],OrderService),exports[_0xfeaffd(0x1e6)]=OrderService;