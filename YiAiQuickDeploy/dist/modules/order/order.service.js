'use strict';const _0x2588a4=_0x4c94;(function(_0x4d44f1,_0x457315){const _0x274fa4=_0x4c94,_0x585664=_0x4d44f1();while(!![]){try{const _0x405ec4=-parseInt(_0x274fa4(0xd4))/0x1+-parseInt(_0x274fa4(0x100))/0x2*(-parseInt(_0x274fa4(0xea))/0x3)+parseInt(_0x274fa4(0xf0))/0x4*(-parseInt(_0x274fa4(0x105))/0x5)+parseInt(_0x274fa4(0xe6))/0x6*(parseInt(_0x274fa4(0xce))/0x7)+parseInt(_0x274fa4(0xb8))/0x8*(parseInt(_0x274fa4(0xb6))/0x9)+-parseInt(_0x274fa4(0x10a))/0xa+parseInt(_0x274fa4(0xdf))/0xb;if(_0x405ec4===_0x457315)break;else _0x585664['push'](_0x585664['shift']());}catch(_0x40f99a){_0x585664['push'](_0x585664['shift']());}}}(_0x1500,0xa8361));var __decorate=this&&this[_0x2588a4(0xe4)]||function(_0x4f78c2,_0x2f2fd6,_0x33e385,_0x267b22){const _0x23d71f=_0x2588a4;var _0x2f0fd4=arguments[_0x23d71f(0x102)],_0xbc8b82=_0x2f0fd4<0x3?_0x2f2fd6:_0x267b22===null?_0x267b22=Object[_0x23d71f(0x101)](_0x2f2fd6,_0x33e385):_0x267b22,_0x302992;if(typeof Reflect===_0x23d71f(0xcb)&&typeof Reflect[_0x23d71f(0xfb)]==='function')_0xbc8b82=Reflect['decorate'](_0x4f78c2,_0x2f2fd6,_0x33e385,_0x267b22);else{for(var _0x3494e0=_0x4f78c2[_0x23d71f(0x102)]-0x1;_0x3494e0>=0x0;_0x3494e0--)if(_0x302992=_0x4f78c2[_0x3494e0])_0xbc8b82=(_0x2f0fd4<0x3?_0x302992(_0xbc8b82):_0x2f0fd4>0x3?_0x302992(_0x2f2fd6,_0x33e385,_0xbc8b82):_0x302992(_0x2f2fd6,_0x33e385))||_0xbc8b82;}return _0x2f0fd4>0x3&&_0xbc8b82&&Object['defineProperty'](_0x2f2fd6,_0x33e385,_0xbc8b82),_0xbc8b82;},__metadata=this&&this[_0x2588a4(0xb9)]||function(_0x15cced,_0x307ef7){const _0x434746=_0x2588a4;if(typeof Reflect==='object'&&typeof Reflect[_0x434746(0xd3)]==='function')return Reflect[_0x434746(0xd3)](_0x15cced,_0x307ef7);},__param=this&&this['__param']||function(_0x1008b9,_0x37bc31){return function(_0x156d3b,_0x4b4ea2){_0x37bc31(_0x156d3b,_0x4b4ea2,_0x1008b9);};};Object[_0x2588a4(0xc5)](exports,_0x2588a4(0x106),{'value':!![]}),exports[_0x2588a4(0xc7)]=void 0x0;const user_entity_1=require('../user/user.entity'),typeorm_1=require(_0x2588a4(0xbd)),common_1=require(_0x2588a4(0xba)),typeorm_2=require(_0x2588a4(0xee)),order_entity_1=require(_0x2588a4(0xef)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),utils_1=require(_0x2588a4(0xb7)),pay_service_1=require(_0x2588a4(0xf6)),globalConfig_service_1=require(_0x2588a4(0xbc));function _0x4c94(_0x5449aa,_0x3abfb8){const _0x150041=_0x1500();return _0x4c94=function(_0x4c94b2,_0x3ad562){_0x4c94b2=_0x4c94b2-0xb5;let _0x592b8e=_0x150041[_0x4c94b2];return _0x592b8e;},_0x4c94(_0x5449aa,_0x3abfb8);}function _0x1500(){const _0x6d5dd6=['购买失败!','design:paramtypes','Injectable','object','find','CramiPackageEntity','7aFscPJ','GlobalConfigService','userId','status','HttpStatus','metadata','659779KsZFPp','deleteNotPay','price','email','total','payPlatform','UNAUTHORIZED','select','log','channel','assign','16550347XibJFq','OrderEntity','HttpException','queryAllOrder','username','__decorate','delete','676542KXgKWe','order:\x20','orderEntity','findOne','6HvfLbM','order.status\x20=\x20:status','DESC','create','typeorm','./order.entity','6044XcIkMW','message','queryByOrderId','user','userInfo','order','../pay/pay.service','UserEntity','buy','map','name','decorate','total_price','goodsId','cramiPackageEntity','save','1111704feOkmN','getOwnPropertyDescriptor','length','goodsInfo','InjectRepository','3535MzsbCU','__esModule','订单不存在!','queryPayType','globalConfigService','7497700bsQmiY','query','userEntity','17991SdvzGR','../../common/utils','1752oDIuKd','__metadata','@nestjs/common','orderId','../globalConfig/globalConfig.service','@nestjs/typeorm','coverImg','count','findAndCount','BAD_REQUEST','PayService','createOrderId','deleteOrder','defineProperty','Repository','OrderService'];_0x1500=function(){return _0x6d5dd6;};return _0x1500();}let OrderService=class OrderService{constructor(_0x5c0281,_0x155750,_0x28751b,_0x5bbf2b,_0x22536d){const _0x3cfbab=_0x2588a4;this[_0x3cfbab(0xe8)]=_0x5c0281,this[_0x3cfbab(0xfe)]=_0x155750,this['userEntity']=_0x28751b,this['payService']=_0x5bbf2b,this['globalConfigService']=_0x22536d;}async[_0x2588a4(0xf8)](_0x4c118a,_0x34e29a){const _0x371bae=_0x2588a4;try{const {goodsId:_0x2acc27,count:count=0x1,payType:_0x31b103}=_0x4c118a,{id:_0x17b2f2}=_0x34e29a[_0x371bae(0xf3)];if(_0x17b2f2>0xf4240)throw new common_1[(_0x371bae(0xe1))]('请先注册账号后购买商品！',common_1[_0x371bae(0xd2)][_0x371bae(0xda)]);const _0x4d5028=await this[_0x371bae(0xed)](_0x17b2f2,_0x2acc27,count,_0x31b103),_0xda81c8=await this['payService']['pay'](_0x17b2f2,_0x4d5028[_0x371bae(0xbb)],_0x31b103);return Object['assign'](Object['assign']({},_0xda81c8),{'orderId':_0x4d5028[_0x371bae(0xbb)],'platform':_0x4d5028[_0x371bae(0xd9)],'total':_0x4d5028[_0x371bae(0xd8)]});}catch(_0x434160){if(_0x434160[_0x371bae(0xd1)]===0x191)throw new common_1[(_0x371bae(0xe1))](_0x434160[_0x371bae(0xf1)],common_1[_0x371bae(0xd2)][_0x371bae(0xda)]);throw new common_1[(_0x371bae(0xe1))](_0x434160[_0x371bae(0xf1)]||_0x371bae(0xc8),common_1[_0x371bae(0xd2)]['BAD_REQUEST']);}}async[_0x2588a4(0xf2)](_0x5eebcf,_0x2646dc){const _0x35ec08=_0x2588a4,{id:_0x80fa5b}=_0x5eebcf[_0x35ec08(0xf3)],{orderId:_0xa26df6}=_0x2646dc,_0x158405=await this[_0x35ec08(0xe8)][_0x35ec08(0xe9)]({'where':{'userId':_0x80fa5b,'orderId':_0xa26df6}});if(!_0x158405)throw new common_1[(_0x35ec08(0xe1))](_0x35ec08(0x107),common_1['HttpStatus'][_0x35ec08(0xc1)]);return _0x158405;}async[_0x2588a4(0xed)](_0x4f24b5,_0x5d6f0d,_0x18b278,_0x108b3a){const _0x5aec13=_0x2588a4,_0x3d3dfd=await this[_0x5aec13(0x109)][_0x5aec13(0x108)](),_0x1c8543=await this[_0x5aec13(0xfe)][_0x5aec13(0xe9)]({'where':{'id':_0x5d6f0d}});if(!_0x1c8543)throw new common_1['HttpException']('套餐不存在!',common_1['HttpStatus'][_0x5aec13(0xc1)]);const _0x407bdb={};_0x407bdb['orderId']=(0x0,utils_1[_0x5aec13(0xc3)])(),_0x407bdb[_0x5aec13(0xd0)]=_0x4f24b5,_0x407bdb[_0x5aec13(0xfd)]=_0x5d6f0d,_0x407bdb[_0x5aec13(0xd6)]=Number(_0x1c8543[_0x5aec13(0xd6)]),_0x407bdb[_0x5aec13(0xbf)]=_0x18b278,_0x407bdb[_0x5aec13(0xd8)]=Number(_0x1c8543[_0x5aec13(0xd6)])*_0x18b278,_0x407bdb[_0x5aec13(0xd9)]=_0x3d3dfd,_0x407bdb[_0x5aec13(0xdd)]=_0x108b3a;const _0x152a76=await this[_0x5aec13(0xe8)][_0x5aec13(0xff)](_0x407bdb);return console[_0x5aec13(0xdc)](_0x5aec13(0xe7),_0x152a76),_0x152a76;}async[_0x2588a4(0x10b)](_0x161415,_0x32bb26,_0x427e39){const _0xe9f3dd=_0x2588a4;return await this[_0xe9f3dd(0xe8)][_0xe9f3dd(0xc0)]({'where':{'userId':_0x161415},'order':{'id':_0xe9f3dd(0xec)},'skip':(_0x32bb26-0x1)*_0x427e39,'take':_0x427e39});}async[_0x2588a4(0xe2)](_0x3b57fb){const _0x1e2984=_0x2588a4,{page:_0x350545,size:_0x418bee,userId:_0x479b46,platform:_0x5c4c29,status:_0xcfa953}=_0x3b57fb,_0x2a4bbd={};if(_0x479b46)_0x2a4bbd[_0x1e2984(0xd0)]=_0x479b46;if(_0x5c4c29)_0x2a4bbd[_0x1e2984(0xd9)]=_0x5c4c29;if(_0xcfa953)_0x2a4bbd[_0x1e2984(0xd1)]=_0xcfa953;const [_0x199c7e,_0x13fd40]=await this['orderEntity'][_0x1e2984(0xc0)]({'order':{'id':'DESC'},'where':_0x2a4bbd,'skip':(_0x350545-0x1)*_0x418bee,'take':_0x418bee}),_0x124e0f=_0x199c7e[_0x1e2984(0xf9)](_0x4229dc=>_0x4229dc[_0x1e2984(0xd0)]),_0x361f4a=_0x199c7e[_0x1e2984(0xf9)](_0x18b06e=>_0x18b06e[_0x1e2984(0xfd)]),_0x692c18=await this[_0x1e2984(0xb5)][_0x1e2984(0xcc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x124e0f)},'select':['id',_0x1e2984(0xe3),_0x1e2984(0xd7)]}),_0x2342de=await this[_0x1e2984(0xfe)][_0x1e2984(0xcc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x361f4a)},'select':['id',_0x1e2984(0xfa),_0x1e2984(0xbe),'des']});_0x199c7e['forEach'](_0x5496d3=>{const _0x2df493=_0x1e2984;_0x5496d3[_0x2df493(0xf4)]=_0x692c18[_0x2df493(0xcc)](_0x4a10b5=>_0x4a10b5['id']===_0x5496d3['userId']),_0x5496d3[_0x2df493(0x103)]=_0x2342de[_0x2df493(0xcc)](_0x1a2567=>_0x1a2567['id']===_0x5496d3[_0x2df493(0xfd)]);});const _0x54d0d9=await this[_0x1e2984(0xe8)]['createQueryBuilder'](_0x1e2984(0xf5))['where'](_0x1e2984(0xeb),{'status':0x1})[_0x1e2984(0xdb)]('SUM(order.price)',_0x1e2984(0xfc))['getRawOne']();return Object[_0x1e2984(0xde)]({'rows':_0x199c7e,'count':_0x13fd40},_0x54d0d9);}async[_0x2588a4(0xc4)](_0x3df3d4){const _0x74bf1b=_0x2588a4,{orderId:_0x2e9b1d}=_0x3df3d4,_0x536841=await this[_0x74bf1b(0xe8)][_0x74bf1b(0xe9)]({'where':{'orderId':_0x2e9b1d}});if(!_0x536841)throw new common_1['HttpException']('订单不存在!',common_1[_0x74bf1b(0xd2)]['BAD_REQUEST']);return await this[_0x74bf1b(0xe8)][_0x74bf1b(0xe5)]({'orderId':_0x2e9b1d});}async[_0x2588a4(0xd5)](){const _0x3c43d0=_0x2588a4;return await this[_0x3c43d0(0xe8)][_0x3c43d0(0xe5)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x2588a4(0xca)])(),__param(0x0,(0x0,typeorm_1[_0x2588a4(0x104)])(order_entity_1[_0x2588a4(0xe0)])),__param(0x1,(0x0,typeorm_1[_0x2588a4(0x104)])(cramiPackage_entity_1[_0x2588a4(0xcd)])),__param(0x2,(0x0,typeorm_1[_0x2588a4(0x104)])(user_entity_1[_0x2588a4(0xf7)])),__metadata(_0x2588a4(0xc9),[typeorm_2['Repository'],typeorm_2[_0x2588a4(0xc6)],typeorm_2[_0x2588a4(0xc6)],pay_service_1[_0x2588a4(0xc2)],globalConfig_service_1[_0x2588a4(0xcf)]])],OrderService),exports[_0x2588a4(0xc7)]=OrderService;