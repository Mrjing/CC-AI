'use strict';function _0x53b0(){const _0x2ff101=['HttpException','orderEntity','UNAUTHORIZED','897003Nmpqsv','DESC','des','10wgHUZQ','5dlCgxl','72SKJbPG','queryByOrderId','getRawOne','cramiPackageEntity','OrderEntity','OrderService','createQueryBuilder','userInfo','@nestjs/typeorm','订单不存在!','50701884jAkeJl','BAD_REQUEST','queryAllOrder','SUM(order.price)','globalConfigService','../globalConfig/globalConfig.service','user','userId','orderId','total_price','购买失败!','createOrderId','design:paramtypes','Repository','goodsId','2165398BgkxUc','count','order:\x20','coverImg','./order.entity','50834SMicMC','InjectRepository','object','status','findAndCount','typeorm','3417168JtLlXu','payPlatform','11426525qukcGF','__param','price','HttpStatus','../../common/utils','Injectable','payService','message','order','userEntity','decorate','3ZZoXjo','defineProperty','function','210JFCstf','log','assign','save','name','find','buy','total','findOne','username','__esModule','CramiPackageEntity','length','UserEntity','create','map','deleteNotPay','delete','goodsInfo','pay','../user/user.entity','1245054NyZIpn','GlobalConfigService','../pay/pay.service','13wlqhjj','套餐不存在!'];_0x53b0=function(){return _0x2ff101;};return _0x53b0();}const _0xa326b3=_0x525c;(function(_0x490438,_0xb8120f){const _0x22b101=_0x525c,_0x350fea=_0x490438();while(!![]){try{const _0x5662ee=-parseInt(_0x22b101(0x135))/0x1+-parseInt(_0x22b101(0x15b))/0x2*(parseInt(_0x22b101(0x11d))/0x3)+-parseInt(_0x22b101(0x166))/0x4*(parseInt(_0x22b101(0x141))/0x5)+-parseInt(_0x22b101(0x120))/0x6*(parseInt(_0x22b101(0x160))/0x7)+-parseInt(_0x22b101(0x142))/0x8*(parseInt(_0x22b101(0x13d))/0x9)+-parseInt(_0x22b101(0x140))/0xa*(-parseInt(_0x22b101(0x168))/0xb)+-parseInt(_0x22b101(0x14c))/0xc*(-parseInt(_0x22b101(0x138))/0xd);if(_0x5662ee===_0xb8120f)break;else _0x350fea['push'](_0x350fea['shift']());}catch(_0x4ea000){_0x350fea['push'](_0x350fea['shift']());}}}(_0x53b0,0xe339a));var __decorate=this&&this['__decorate']||function(_0x73b34f,_0x4583d5,_0x45d5f1,_0x152a67){const _0x365946=_0x525c;var _0x4feecf=arguments['length'],_0x4da29c=_0x4feecf<0x3?_0x4583d5:_0x152a67===null?_0x152a67=Object['getOwnPropertyDescriptor'](_0x4583d5,_0x45d5f1):_0x152a67,_0x3438ba;if(typeof Reflect===_0x365946(0x162)&&typeof Reflect[_0x365946(0x11c)]===_0x365946(0x11f))_0x4da29c=Reflect[_0x365946(0x11c)](_0x73b34f,_0x4583d5,_0x45d5f1,_0x152a67);else{for(var _0x37adea=_0x73b34f[_0x365946(0x12c)]-0x1;_0x37adea>=0x0;_0x37adea--)if(_0x3438ba=_0x73b34f[_0x37adea])_0x4da29c=(_0x4feecf<0x3?_0x3438ba(_0x4da29c):_0x4feecf>0x3?_0x3438ba(_0x4583d5,_0x45d5f1,_0x4da29c):_0x3438ba(_0x4583d5,_0x45d5f1))||_0x4da29c;}return _0x4feecf>0x3&&_0x4da29c&&Object[_0x365946(0x11e)](_0x4583d5,_0x45d5f1,_0x4da29c),_0x4da29c;},__metadata=this&&this['__metadata']||function(_0x44feac,_0x465ca2){const _0x2f2c09=_0x525c;if(typeof Reflect===_0x2f2c09(0x162)&&typeof Reflect['metadata']===_0x2f2c09(0x11f))return Reflect['metadata'](_0x44feac,_0x465ca2);},__param=this&&this[_0xa326b3(0x169)]||function(_0x3c1c08,_0x2312c4){return function(_0x226c60,_0x5b778f){_0x2312c4(_0x226c60,_0x5b778f,_0x3c1c08);};};Object['defineProperty'](exports,_0xa326b3(0x12a),{'value':!![]}),exports[_0xa326b3(0x147)]=void 0x0;const user_entity_1=require(_0xa326b3(0x134)),typeorm_1=require(_0xa326b3(0x14a)),common_1=require('@nestjs/common'),typeorm_2=require(_0xa326b3(0x165)),order_entity_1=require(_0xa326b3(0x15f)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),utils_1=require(_0xa326b3(0x116)),pay_service_1=require(_0xa326b3(0x137)),globalConfig_service_1=require(_0xa326b3(0x151));let OrderService=class OrderService{constructor(_0x598b57,_0x1becd9,_0x21baf5,_0x4e64ed,_0x4689ec){const _0x36cb03=_0xa326b3;this['orderEntity']=_0x598b57,this[_0x36cb03(0x145)]=_0x1becd9,this[_0x36cb03(0x11b)]=_0x21baf5,this[_0x36cb03(0x118)]=_0x4e64ed,this[_0x36cb03(0x150)]=_0x4689ec;}async[_0xa326b3(0x126)](_0x44bb06,_0x4022c0){const _0x44919d=_0xa326b3;try{const {goodsId:_0x36662d,count:count=0x1,payType:_0xb8b4e9}=_0x44bb06,{id:_0xaf901}=_0x4022c0[_0x44919d(0x152)];if(_0xaf901>0xf4240)throw new common_1[(_0x44919d(0x13a))]('请先注册账号后购买商品！',common_1[_0x44919d(0x115)][_0x44919d(0x13c)]);const _0x3a0452=await this['create'](_0xaf901,_0x36662d,count,_0xb8b4e9),_0x389e49=await this['payService'][_0x44919d(0x133)](_0xaf901,_0x3a0452[_0x44919d(0x154)],_0xb8b4e9);return Object['assign'](Object[_0x44919d(0x122)]({},_0x389e49),{'orderId':_0x3a0452[_0x44919d(0x154)],'platform':_0x3a0452[_0x44919d(0x167)],'total':_0x3a0452[_0x44919d(0x127)]});}catch(_0x146525){if(_0x146525['status']===0x191)throw new common_1[(_0x44919d(0x13a))](_0x146525[_0x44919d(0x119)],common_1[_0x44919d(0x115)][_0x44919d(0x13c)]);throw new common_1['HttpException'](_0x146525[_0x44919d(0x119)]||_0x44919d(0x156),common_1[_0x44919d(0x115)][_0x44919d(0x14d)]);}}async[_0xa326b3(0x143)](_0x33f583,_0x455aa5){const _0x33a7a7=_0xa326b3,{id:_0x36a896}=_0x33f583[_0x33a7a7(0x152)],{orderId:_0x36b9f5}=_0x455aa5,_0x4e3896=await this[_0x33a7a7(0x13b)][_0x33a7a7(0x128)]({'where':{'userId':_0x36a896,'orderId':_0x36b9f5}});if(!_0x4e3896)throw new common_1[(_0x33a7a7(0x13a))](_0x33a7a7(0x14b),common_1[_0x33a7a7(0x115)]['BAD_REQUEST']);return _0x4e3896;}async[_0xa326b3(0x12e)](_0x5f4c18,_0x8778e1,_0x222698,_0x428bbe){const _0x5b0d3f=_0xa326b3,_0x189cbf=await this[_0x5b0d3f(0x150)]['queryPayType'](),_0x332aed=await this[_0x5b0d3f(0x145)]['findOne']({'where':{'id':_0x8778e1}});if(!_0x332aed)throw new common_1[(_0x5b0d3f(0x13a))](_0x5b0d3f(0x139),common_1[_0x5b0d3f(0x115)]['BAD_REQUEST']);const _0x2fb232={};_0x2fb232[_0x5b0d3f(0x154)]=(0x0,utils_1[_0x5b0d3f(0x157)])(),_0x2fb232[_0x5b0d3f(0x153)]=_0x5f4c18,_0x2fb232[_0x5b0d3f(0x15a)]=_0x8778e1,_0x2fb232[_0x5b0d3f(0x16a)]=Number(_0x332aed['price']),_0x2fb232[_0x5b0d3f(0x15c)]=_0x222698,_0x2fb232[_0x5b0d3f(0x127)]=Number(_0x332aed['price'])*_0x222698,_0x2fb232[_0x5b0d3f(0x167)]=_0x189cbf,_0x2fb232['channel']=_0x428bbe;const _0x45c544=await this['orderEntity'][_0x5b0d3f(0x123)](_0x2fb232);return console[_0x5b0d3f(0x121)](_0x5b0d3f(0x15d),_0x45c544),_0x45c544;}async['query'](_0x47d9c2,_0x223ce4,_0x550649){const _0x3b7d7d=_0xa326b3;return await this['orderEntity'][_0x3b7d7d(0x164)]({'where':{'userId':_0x47d9c2},'order':{'id':_0x3b7d7d(0x13e)},'skip':(_0x223ce4-0x1)*_0x550649,'take':_0x550649});}async[_0xa326b3(0x14e)](_0x3f1bbd){const _0x4c8d3e=_0xa326b3,{page:_0x9e093a,size:_0x52fd7b,userId:_0x160fb1,platform:_0x170c1b,status:_0x2cde39}=_0x3f1bbd,_0x5cb9ac={};if(_0x160fb1)_0x5cb9ac[_0x4c8d3e(0x153)]=_0x160fb1;if(_0x170c1b)_0x5cb9ac[_0x4c8d3e(0x167)]=_0x170c1b;if(_0x2cde39)_0x5cb9ac[_0x4c8d3e(0x163)]=_0x2cde39;const [_0x45ae6f,_0x103ca5]=await this[_0x4c8d3e(0x13b)][_0x4c8d3e(0x164)]({'order':{'id':_0x4c8d3e(0x13e)},'where':_0x5cb9ac,'skip':(_0x9e093a-0x1)*_0x52fd7b,'take':_0x52fd7b}),_0x531efa=_0x45ae6f['map'](_0x34a7ee=>_0x34a7ee[_0x4c8d3e(0x153)]),_0xd9be6=_0x45ae6f[_0x4c8d3e(0x12f)](_0x3083d8=>_0x3083d8[_0x4c8d3e(0x15a)]),_0x53b7f1=await this['userEntity'][_0x4c8d3e(0x125)]({'where':{'id':(0x0,typeorm_2['In'])(_0x531efa)},'select':['id',_0x4c8d3e(0x129),'email']}),_0x4e66b9=await this['cramiPackageEntity'][_0x4c8d3e(0x125)]({'where':{'id':(0x0,typeorm_2['In'])(_0xd9be6)},'select':['id',_0x4c8d3e(0x124),_0x4c8d3e(0x15e),_0x4c8d3e(0x13f)]});_0x45ae6f['forEach'](_0x33d5d9=>{const _0x39dab2=_0x4c8d3e;_0x33d5d9[_0x39dab2(0x149)]=_0x53b7f1[_0x39dab2(0x125)](_0x38d9f3=>_0x38d9f3['id']===_0x33d5d9['userId']),_0x33d5d9[_0x39dab2(0x132)]=_0x4e66b9[_0x39dab2(0x125)](_0x55fc68=>_0x55fc68['id']===_0x33d5d9['goodsId']);});const _0x31aacf=await this[_0x4c8d3e(0x13b)][_0x4c8d3e(0x148)](_0x4c8d3e(0x11a))['where']('order.status\x20=\x20:status',{'status':0x1})['select'](_0x4c8d3e(0x14f),_0x4c8d3e(0x155))[_0x4c8d3e(0x144)]();return Object[_0x4c8d3e(0x122)]({'rows':_0x45ae6f,'count':_0x103ca5},_0x31aacf);}async['deleteOrder'](_0x3ef51a){const _0x34833a=_0xa326b3,{orderId:_0x429006}=_0x3ef51a,_0x48da0a=await this[_0x34833a(0x13b)]['findOne']({'where':{'orderId':_0x429006}});if(!_0x48da0a)throw new common_1['HttpException'](_0x34833a(0x14b),common_1[_0x34833a(0x115)][_0x34833a(0x14d)]);return await this['orderEntity'][_0x34833a(0x131)]({'orderId':_0x429006});}async[_0xa326b3(0x130)](){const _0x38fad3=_0xa326b3;return await this[_0x38fad3(0x13b)]['delete']({'status':0x0});}};function _0x525c(_0x4a150e,_0x5cc49f){const _0x53b0ef=_0x53b0();return _0x525c=function(_0x525cfa,_0x1d9ee7){_0x525cfa=_0x525cfa-0x115;let _0x2caa14=_0x53b0ef[_0x525cfa];return _0x2caa14;},_0x525c(_0x4a150e,_0x5cc49f);}OrderService=__decorate([(0x0,common_1[_0xa326b3(0x117)])(),__param(0x0,(0x0,typeorm_1[_0xa326b3(0x161)])(order_entity_1[_0xa326b3(0x146)])),__param(0x1,(0x0,typeorm_1[_0xa326b3(0x161)])(cramiPackage_entity_1[_0xa326b3(0x12b)])),__param(0x2,(0x0,typeorm_1[_0xa326b3(0x161)])(user_entity_1[_0xa326b3(0x12d)])),__metadata(_0xa326b3(0x158),[typeorm_2[_0xa326b3(0x159)],typeorm_2[_0xa326b3(0x159)],typeorm_2[_0xa326b3(0x159)],pay_service_1['PayService'],globalConfig_service_1[_0xa326b3(0x136)]])],OrderService),exports[_0xa326b3(0x147)]=OrderService;