'use strict';const _0x5ab259=_0x5ce1;(function(_0x5e25d8,_0x3d3b16){const _0x24d529=_0x5ce1,_0x3ec640=_0x5e25d8();while(!![]){try{const _0x265cb7=-parseInt(_0x24d529(0x14a))/0x1+parseInt(_0x24d529(0x10f))/0x2+-parseInt(_0x24d529(0x118))/0x3+parseInt(_0x24d529(0x127))/0x4+parseInt(_0x24d529(0x147))/0x5*(parseInt(_0x24d529(0x15b))/0x6)+parseInt(_0x24d529(0x14b))/0x7*(parseInt(_0x24d529(0x13e))/0x8)+-parseInt(_0x24d529(0x153))/0x9;if(_0x265cb7===_0x3d3b16)break;else _0x3ec640['push'](_0x3ec640['shift']());}catch(_0x613c2a){_0x3ec640['push'](_0x3ec640['shift']());}}}(_0x4546,0x9ea15));function _0x4546(){const _0x1b27ca=['buy','count','metadata','createQueryBuilder','queryByOrderId','./order.entity','../../common/utils','InjectRepository','1435096dvNdDV','__metadata','createOrderId','where','globalConfigService','assign','function','total_price','../user/user.entity','785FZYfkX','order.status\x20=\x20:status','../globalConfig/globalConfig.service','647240pqQpep','35tXaTXU','payPlatform','HttpStatus','price','__decorate','UNAUTHORIZED','delete','DESC','3963024QBYPiJ','deleteNotPay','pay','PayService','name','create','findOne','请先注册账号后购买商品！','12336evsscw','des','object','SUM(order.price)','OrderEntity','select','getRawOne','decorate','status','CramiPackageEntity','userInfo','1724652mtBreU','HttpException','save','cramiPackageEntity','find','query','GlobalConfigService','userId','map','1501257UkQIWz','total','defineProperty','../pay/pay.service','queryAllOrder','length','channel','UserEntity','OrderService','typeorm','message','goodsInfo','design:paramtypes','BAD_REQUEST','Repository','622764YluuOy','coverImg','订单不存在!','goodsId','@nestjs/typeorm','orderId','user','orderEntity','userEntity','forEach','@nestjs/common','username','findAndCount','套餐不存在!','log'];_0x4546=function(){return _0x1b27ca;};return _0x4546();}var __decorate=this&&this[_0x5ab259(0x14f)]||function(_0x57875f,_0xb8762f,_0x153da6,_0x294f77){const _0x2fb7e0=_0x5ab259;var _0x4c6b20=arguments[_0x2fb7e0(0x11d)],_0x17b290=_0x4c6b20<0x3?_0xb8762f:_0x294f77===null?_0x294f77=Object['getOwnPropertyDescriptor'](_0xb8762f,_0x153da6):_0x294f77,_0x4371bc;if(typeof Reflect==='object'&&typeof Reflect[_0x2fb7e0(0x162)]===_0x2fb7e0(0x144))_0x17b290=Reflect['decorate'](_0x57875f,_0xb8762f,_0x153da6,_0x294f77);else{for(var _0x119b39=_0x57875f[_0x2fb7e0(0x11d)]-0x1;_0x119b39>=0x0;_0x119b39--)if(_0x4371bc=_0x57875f[_0x119b39])_0x17b290=(_0x4c6b20<0x3?_0x4371bc(_0x17b290):_0x4c6b20>0x3?_0x4371bc(_0xb8762f,_0x153da6,_0x17b290):_0x4371bc(_0xb8762f,_0x153da6))||_0x17b290;}return _0x4c6b20>0x3&&_0x17b290&&Object['defineProperty'](_0xb8762f,_0x153da6,_0x17b290),_0x17b290;},__metadata=this&&this[_0x5ab259(0x13f)]||function(_0x3c2a58,_0x4103cb){const _0x32f114=_0x5ab259;if(typeof Reflect===_0x32f114(0x15d)&&typeof Reflect['metadata']===_0x32f114(0x144))return Reflect[_0x32f114(0x138)](_0x3c2a58,_0x4103cb);},__param=this&&this['__param']||function(_0x4b91a2,_0x2ab1c6){return function(_0x3143d1,_0x15b596){_0x2ab1c6(_0x3143d1,_0x15b596,_0x4b91a2);};};Object[_0x5ab259(0x11a)](exports,'__esModule',{'value':!![]}),exports[_0x5ab259(0x120)]=void 0x0;const user_entity_1=require(_0x5ab259(0x146)),typeorm_1=require(_0x5ab259(0x12b)),common_1=require(_0x5ab259(0x131)),typeorm_2=require(_0x5ab259(0x121)),order_entity_1=require(_0x5ab259(0x13b)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),utils_1=require(_0x5ab259(0x13c)),pay_service_1=require(_0x5ab259(0x11b)),globalConfig_service_1=require(_0x5ab259(0x149));function _0x5ce1(_0x25d798,_0x3866b9){const _0x4546b8=_0x4546();return _0x5ce1=function(_0x5ce1bd,_0x18ac7a){_0x5ce1bd=_0x5ce1bd-0x10e;let _0x2266e0=_0x4546b8[_0x5ce1bd];return _0x2266e0;},_0x5ce1(_0x25d798,_0x3866b9);}let OrderService=class OrderService{constructor(_0x50b13b,_0x3b38a6,_0x3cad61,_0x31f64c,_0x5b3ff2){const _0x3ffb06=_0x5ab259;this[_0x3ffb06(0x12e)]=_0x50b13b,this[_0x3ffb06(0x112)]=_0x3b38a6,this['userEntity']=_0x3cad61,this['payService']=_0x31f64c,this[_0x3ffb06(0x142)]=_0x5b3ff2;}async[_0x5ab259(0x136)](_0x496408,_0x3d70bc){const _0x5c1fa0=_0x5ab259;try{const {goodsId:_0xf44285,count:count=0x1,payType:_0x347469}=_0x496408,{id:_0x1ef8d6}=_0x3d70bc['user'];if(_0x1ef8d6>0xf4240)throw new common_1[(_0x5c1fa0(0x110))](_0x5c1fa0(0x15a),common_1[_0x5c1fa0(0x14d)][_0x5c1fa0(0x150)]);const _0x3e165a=await this[_0x5c1fa0(0x158)](_0x1ef8d6,_0xf44285,count,_0x347469),_0x2796f9=await this['payService'][_0x5c1fa0(0x155)](_0x1ef8d6,_0x3e165a['orderId'],_0x347469);return Object[_0x5c1fa0(0x143)](Object['assign']({},_0x2796f9),{'orderId':_0x3e165a[_0x5c1fa0(0x12c)],'platform':_0x3e165a[_0x5c1fa0(0x14c)],'total':_0x3e165a[_0x5c1fa0(0x119)]});}catch(_0x40fcab){if(_0x40fcab[_0x5c1fa0(0x163)]===0x191)throw new common_1[(_0x5c1fa0(0x110))](_0x40fcab[_0x5c1fa0(0x122)],common_1[_0x5c1fa0(0x14d)][_0x5c1fa0(0x150)]);throw new common_1['HttpException'](_0x40fcab[_0x5c1fa0(0x122)]||'购买失败!',common_1[_0x5c1fa0(0x14d)][_0x5c1fa0(0x125)]);}}async[_0x5ab259(0x13a)](_0x1f6f5a,_0xd216ec){const _0xdf6e8f=_0x5ab259,{id:_0x10d44f}=_0x1f6f5a[_0xdf6e8f(0x12d)],{orderId:_0x4fba96}=_0xd216ec,_0x566fe0=await this['orderEntity'][_0xdf6e8f(0x159)]({'where':{'userId':_0x10d44f,'orderId':_0x4fba96}});if(!_0x566fe0)throw new common_1[(_0xdf6e8f(0x110))](_0xdf6e8f(0x129),common_1[_0xdf6e8f(0x14d)]['BAD_REQUEST']);return _0x566fe0;}async[_0x5ab259(0x158)](_0x47c8b0,_0x1bb266,_0x675261,_0x347ad4){const _0x4396d1=_0x5ab259,_0x376df1=await this['globalConfigService']['queryPayType'](),_0x57ac6c=await this[_0x4396d1(0x112)][_0x4396d1(0x159)]({'where':{'id':_0x1bb266}});if(!_0x57ac6c)throw new common_1[(_0x4396d1(0x110))](_0x4396d1(0x134),common_1[_0x4396d1(0x14d)][_0x4396d1(0x125)]);const _0xa82b11={};_0xa82b11['orderId']=(0x0,utils_1[_0x4396d1(0x140)])(),_0xa82b11[_0x4396d1(0x116)]=_0x47c8b0,_0xa82b11[_0x4396d1(0x12a)]=_0x1bb266,_0xa82b11[_0x4396d1(0x14e)]=Number(_0x57ac6c[_0x4396d1(0x14e)]),_0xa82b11[_0x4396d1(0x137)]=_0x675261,_0xa82b11[_0x4396d1(0x119)]=Number(_0x57ac6c[_0x4396d1(0x14e)])*_0x675261,_0xa82b11[_0x4396d1(0x14c)]=_0x376df1,_0xa82b11[_0x4396d1(0x11e)]=_0x347ad4;const _0x5e527d=await this[_0x4396d1(0x12e)][_0x4396d1(0x111)](_0xa82b11);return console[_0x4396d1(0x135)]('order:\x20',_0x5e527d),_0x5e527d;}async[_0x5ab259(0x114)](_0x133825,_0x260e22,_0x5cf7cc){const _0x3fbbc8=_0x5ab259;return await this[_0x3fbbc8(0x12e)]['findAndCount']({'where':{'userId':_0x133825},'order':{'id':_0x3fbbc8(0x152)},'skip':(_0x260e22-0x1)*_0x5cf7cc,'take':_0x5cf7cc});}async[_0x5ab259(0x11c)](_0x2b1e9d){const _0x26780b=_0x5ab259,{page:_0x313aa6,size:_0x1391bd,userId:_0xefcfc5,platform:_0xc8f35,status:_0x376742}=_0x2b1e9d,_0x542b3d={};if(_0xefcfc5)_0x542b3d[_0x26780b(0x116)]=_0xefcfc5;if(_0xc8f35)_0x542b3d[_0x26780b(0x14c)]=_0xc8f35;if(_0x376742)_0x542b3d[_0x26780b(0x163)]=_0x376742;const [_0x425c0d,_0x2605b3]=await this[_0x26780b(0x12e)][_0x26780b(0x133)]({'order':{'id':_0x26780b(0x152)},'where':_0x542b3d,'skip':(_0x313aa6-0x1)*_0x1391bd,'take':_0x1391bd}),_0x1f9fb=_0x425c0d[_0x26780b(0x117)](_0x558b07=>_0x558b07[_0x26780b(0x116)]),_0x57d380=_0x425c0d['map'](_0x37620c=>_0x37620c['goodsId']),_0x25cd19=await this[_0x26780b(0x12f)][_0x26780b(0x113)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1f9fb)},'select':['id',_0x26780b(0x132),'email']}),_0x518231=await this[_0x26780b(0x112)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x57d380)},'select':['id',_0x26780b(0x157),_0x26780b(0x128),_0x26780b(0x15c)]});_0x425c0d[_0x26780b(0x130)](_0x4fc207=>{const _0x1f35ae=_0x26780b;_0x4fc207[_0x1f35ae(0x10e)]=_0x25cd19[_0x1f35ae(0x113)](_0x13f446=>_0x13f446['id']===_0x4fc207['userId']),_0x4fc207[_0x1f35ae(0x123)]=_0x518231[_0x1f35ae(0x113)](_0x4fa686=>_0x4fa686['id']===_0x4fc207[_0x1f35ae(0x12a)]);});const _0x10fb99=await this[_0x26780b(0x12e)][_0x26780b(0x139)]('order')[_0x26780b(0x141)](_0x26780b(0x148),{'status':0x1})[_0x26780b(0x160)](_0x26780b(0x15e),_0x26780b(0x145))[_0x26780b(0x161)]();return Object[_0x26780b(0x143)]({'rows':_0x425c0d,'count':_0x2605b3},_0x10fb99);}async['deleteOrder'](_0x325b7a){const _0x2a9f1d=_0x5ab259,{orderId:_0x2e9577}=_0x325b7a,_0x41e130=await this['orderEntity']['findOne']({'where':{'orderId':_0x2e9577}});if(!_0x41e130)throw new common_1[(_0x2a9f1d(0x110))](_0x2a9f1d(0x129),common_1[_0x2a9f1d(0x14d)][_0x2a9f1d(0x125)]);return await this[_0x2a9f1d(0x12e)]['delete']({'orderId':_0x2e9577});}async[_0x5ab259(0x154)](){const _0x466d11=_0x5ab259;return await this['orderEntity'][_0x466d11(0x151)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x5ab259(0x13d)])(order_entity_1[_0x5ab259(0x15f)])),__param(0x1,(0x0,typeorm_1[_0x5ab259(0x13d)])(cramiPackage_entity_1[_0x5ab259(0x164)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x5ab259(0x11f)])),__metadata(_0x5ab259(0x124),[typeorm_2[_0x5ab259(0x126)],typeorm_2[_0x5ab259(0x126)],typeorm_2[_0x5ab259(0x126)],pay_service_1[_0x5ab259(0x156)],globalConfig_service_1[_0x5ab259(0x115)]])],OrderService),exports[_0x5ab259(0x120)]=OrderService;