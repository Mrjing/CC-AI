'use strict';const _0x314ba4=_0x41e4;(function(_0x2139c2,_0x29de1e){const _0x2dd50f=_0x41e4,_0xdda92e=_0x2139c2();while(!![]){try{const _0x5e1baa=-parseInt(_0x2dd50f(0x1e7))/0x1+parseInt(_0x2dd50f(0x1de))/0x2*(-parseInt(_0x2dd50f(0x1da))/0x3)+parseInt(_0x2dd50f(0x1b8))/0x4+-parseInt(_0x2dd50f(0x1a6))/0x5+-parseInt(_0x2dd50f(0x1be))/0x6+-parseInt(_0x2dd50f(0x1d6))/0x7+parseInt(_0x2dd50f(0x1c0))/0x8;if(_0x5e1baa===_0x29de1e)break;else _0xdda92e['push'](_0xdda92e['shift']());}catch(_0xdc05df){_0xdda92e['push'](_0xdda92e['shift']());}}}(_0xd815,0x2e17e));function _0xd815(){const _0x53a33e=['161441tqPjnw','total','save','@nestjs/typeorm','请先注册账号后购买商品！','deleteOrder','name','../crami/cramiPackage.entity','create','payService','select','function','coverImg','orderId','OrderEntity','HttpException','HttpStatus','1481680qUujVw','goodsInfo','InjectRepository','status','payPlatform','userInfo','des','username','price','goodsId','orderEntity','__param','order','购买失败!','queryPayType','findAndCount','queryAllOrder','BAD_REQUEST','432408JAJfWQ','../pay/pay.service','user','./order.entity','email','assign','1646016ejtnmS','createQueryBuilder','7593504QSEuHX','订单不存在!','query','total_price','length','metadata','channel','queryByOrderId','../globalConfig/globalConfig.service','../../common/utils','forEach','where','globalConfigService','log','Repository','defineProperty','userEntity','decorate','SUM(order.price)','design:paramtypes','OrderService','userId','412979wNiGug','UNAUTHORIZED','findOne','message','162YyiRGT','GlobalConfigService','getRawOne','find','2866XxWntb','DESC','typeorm','UserEntity','buy','count','cramiPackageEntity','object','map'];_0xd815=function(){return _0x53a33e;};return _0xd815();}function _0x41e4(_0x54a313,_0x56a539){const _0xd815a2=_0xd815();return _0x41e4=function(_0x41e4d2,_0x852ffd){_0x41e4d2=_0x41e4d2-0x1a2;let _0x51202c=_0xd815a2[_0x41e4d2];return _0x51202c;},_0x41e4(_0x54a313,_0x56a539);}var __decorate=this&&this['__decorate']||function(_0x1e2249,_0xfe25de,_0x2744b0,_0x1f9736){const _0x2902c7=_0x41e4;var _0x1e6fac=arguments['length'],_0x43fc99=_0x1e6fac<0x3?_0xfe25de:_0x1f9736===null?_0x1f9736=Object['getOwnPropertyDescriptor'](_0xfe25de,_0x2744b0):_0x1f9736,_0x887177;if(typeof Reflect===_0x2902c7(0x1e5)&&typeof Reflect[_0x2902c7(0x1d1)]===_0x2902c7(0x1f2))_0x43fc99=Reflect[_0x2902c7(0x1d1)](_0x1e2249,_0xfe25de,_0x2744b0,_0x1f9736);else{for(var _0x273612=_0x1e2249[_0x2902c7(0x1c4)]-0x1;_0x273612>=0x0;_0x273612--)if(_0x887177=_0x1e2249[_0x273612])_0x43fc99=(_0x1e6fac<0x3?_0x887177(_0x43fc99):_0x1e6fac>0x3?_0x887177(_0xfe25de,_0x2744b0,_0x43fc99):_0x887177(_0xfe25de,_0x2744b0))||_0x43fc99;}return _0x1e6fac>0x3&&_0x43fc99&&Object[_0x2902c7(0x1cf)](_0xfe25de,_0x2744b0,_0x43fc99),_0x43fc99;},__metadata=this&&this['__metadata']||function(_0x649fcd,_0x1b6cc6){const _0x23f636=_0x41e4;if(typeof Reflect===_0x23f636(0x1e5)&&typeof Reflect[_0x23f636(0x1c5)]===_0x23f636(0x1f2))return Reflect[_0x23f636(0x1c5)](_0x649fcd,_0x1b6cc6);},__param=this&&this[_0x314ba4(0x1b1)]||function(_0x4a16af,_0x2ae8a8){return function(_0x2003b9,_0x24a9ba){_0x2ae8a8(_0x2003b9,_0x24a9ba,_0x4a16af);};};Object[_0x314ba4(0x1cf)](exports,'__esModule',{'value':!![]}),exports[_0x314ba4(0x1d4)]=void 0x0;const user_entity_1=require('../user/user.entity'),typeorm_1=require(_0x314ba4(0x1ea)),common_1=require('@nestjs/common'),typeorm_2=require(_0x314ba4(0x1e0)),order_entity_1=require(_0x314ba4(0x1bb)),cramiPackage_entity_1=require(_0x314ba4(0x1ee)),utils_1=require(_0x314ba4(0x1c9)),pay_service_1=require(_0x314ba4(0x1b9)),globalConfig_service_1=require(_0x314ba4(0x1c8));let OrderService=class OrderService{constructor(_0xfd5029,_0x181625,_0x34197c,_0x12dff8,_0x945243){const _0x4a608a=_0x314ba4;this[_0x4a608a(0x1b0)]=_0xfd5029,this[_0x4a608a(0x1e4)]=_0x181625,this[_0x4a608a(0x1d0)]=_0x34197c,this[_0x4a608a(0x1f0)]=_0x12dff8,this[_0x4a608a(0x1cc)]=_0x945243;}async[_0x314ba4(0x1e2)](_0x41796c,_0x5c3e67){const _0x15eaa0=_0x314ba4;try{const {goodsId:_0x48ad44,count:count=0x1,payType:_0xa2a7f7}=_0x41796c,{id:_0x265ddf}=_0x5c3e67[_0x15eaa0(0x1ba)];if(_0x265ddf>0xf4240)throw new common_1['HttpException'](_0x15eaa0(0x1eb),common_1[_0x15eaa0(0x1a5)]['UNAUTHORIZED']);const _0x14fb6b=await this['create'](_0x265ddf,_0x48ad44,count,_0xa2a7f7),_0x1114de=await this['payService']['pay'](_0x265ddf,_0x14fb6b[_0x15eaa0(0x1a2)],_0xa2a7f7);return Object[_0x15eaa0(0x1bd)](Object[_0x15eaa0(0x1bd)]({},_0x1114de),{'orderId':_0x14fb6b[_0x15eaa0(0x1a2)],'platform':_0x14fb6b[_0x15eaa0(0x1aa)],'total':_0x14fb6b[_0x15eaa0(0x1e8)]});}catch(_0x605f73){if(_0x605f73['status']===0x191)throw new common_1[(_0x15eaa0(0x1a4))](_0x605f73[_0x15eaa0(0x1d9)],common_1[_0x15eaa0(0x1a5)][_0x15eaa0(0x1d7)]);throw new common_1[(_0x15eaa0(0x1a4))](_0x605f73['message']||_0x15eaa0(0x1b3),common_1[_0x15eaa0(0x1a5)][_0x15eaa0(0x1b7)]);}}async[_0x314ba4(0x1c7)](_0x292b24,_0x5a1176){const _0x504e3e=_0x314ba4,{id:_0x233215}=_0x292b24[_0x504e3e(0x1ba)],{orderId:_0x521308}=_0x5a1176,_0x5830ce=await this['orderEntity'][_0x504e3e(0x1d8)]({'where':{'userId':_0x233215,'orderId':_0x521308}});if(!_0x5830ce)throw new common_1[(_0x504e3e(0x1a4))]('订单不存在!',common_1[_0x504e3e(0x1a5)]['BAD_REQUEST']);return _0x5830ce;}async[_0x314ba4(0x1ef)](_0x4e1376,_0x4f666c,_0x3bd391,_0x203dec){const _0x2f647c=_0x314ba4,_0x5d8ed3=await this[_0x2f647c(0x1cc)][_0x2f647c(0x1b4)](),_0x54460f=await this[_0x2f647c(0x1e4)][_0x2f647c(0x1d8)]({'where':{'id':_0x4f666c}});if(!_0x54460f)throw new common_1['HttpException']('套餐不存在!',common_1[_0x2f647c(0x1a5)]['BAD_REQUEST']);const _0x301aa4={};_0x301aa4[_0x2f647c(0x1a2)]=(0x0,utils_1['createOrderId'])(),_0x301aa4[_0x2f647c(0x1d5)]=_0x4e1376,_0x301aa4[_0x2f647c(0x1af)]=_0x4f666c,_0x301aa4['price']=Number(_0x54460f[_0x2f647c(0x1ae)]),_0x301aa4[_0x2f647c(0x1e3)]=_0x3bd391,_0x301aa4[_0x2f647c(0x1e8)]=Number(_0x54460f['price'])*_0x3bd391,_0x301aa4[_0x2f647c(0x1aa)]=_0x5d8ed3,_0x301aa4[_0x2f647c(0x1c6)]=_0x203dec;const _0x310c1a=await this[_0x2f647c(0x1b0)][_0x2f647c(0x1e9)](_0x301aa4);return console[_0x2f647c(0x1cd)]('order:\x20',_0x310c1a),_0x310c1a;}async[_0x314ba4(0x1c2)](_0x1f3f80,_0x1c3aed,_0x2982f6){const _0x3f4fd6=_0x314ba4;return await this[_0x3f4fd6(0x1b0)][_0x3f4fd6(0x1b5)]({'where':{'userId':_0x1f3f80},'order':{'id':_0x3f4fd6(0x1df)},'skip':(_0x1c3aed-0x1)*_0x2982f6,'take':_0x2982f6});}async[_0x314ba4(0x1b6)](_0x241d69){const _0x36c60d=_0x314ba4,{page:_0x2a2371,size:_0x3ede2e,userId:_0x15c5db,platform:_0x44a823,status:_0xd0e410}=_0x241d69,_0x1bee6c={};if(_0x15c5db)_0x1bee6c['userId']=_0x15c5db;if(_0x44a823)_0x1bee6c[_0x36c60d(0x1aa)]=_0x44a823;if(_0xd0e410)_0x1bee6c[_0x36c60d(0x1a9)]=_0xd0e410;const [_0x862fe9,_0x209024]=await this[_0x36c60d(0x1b0)][_0x36c60d(0x1b5)]({'order':{'id':_0x36c60d(0x1df)},'where':_0x1bee6c,'skip':(_0x2a2371-0x1)*_0x3ede2e,'take':_0x3ede2e}),_0x46f17d=_0x862fe9[_0x36c60d(0x1e6)](_0x4ed741=>_0x4ed741['userId']),_0x2587b9=_0x862fe9['map'](_0x1e1ac5=>_0x1e1ac5['goodsId']),_0x26fc6d=await this[_0x36c60d(0x1d0)][_0x36c60d(0x1dd)]({'where':{'id':(0x0,typeorm_2['In'])(_0x46f17d)},'select':['id',_0x36c60d(0x1ad),_0x36c60d(0x1bc)]}),_0x3f6da0=await this['cramiPackageEntity'][_0x36c60d(0x1dd)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2587b9)},'select':['id',_0x36c60d(0x1ed),_0x36c60d(0x1f3),_0x36c60d(0x1ac)]});_0x862fe9[_0x36c60d(0x1ca)](_0x112454=>{const _0xb1ba12=_0x36c60d;_0x112454[_0xb1ba12(0x1ab)]=_0x26fc6d[_0xb1ba12(0x1dd)](_0x32a6cc=>_0x32a6cc['id']===_0x112454[_0xb1ba12(0x1d5)]),_0x112454[_0xb1ba12(0x1a7)]=_0x3f6da0[_0xb1ba12(0x1dd)](_0x20b9ef=>_0x20b9ef['id']===_0x112454[_0xb1ba12(0x1af)]);});const _0x115f1b=await this[_0x36c60d(0x1b0)][_0x36c60d(0x1bf)](_0x36c60d(0x1b2))[_0x36c60d(0x1cb)]('order.status\x20=\x20:status',{'status':0x1})[_0x36c60d(0x1f1)](_0x36c60d(0x1d2),_0x36c60d(0x1c3))[_0x36c60d(0x1dc)]();return Object[_0x36c60d(0x1bd)]({'rows':_0x862fe9,'count':_0x209024},_0x115f1b);}async[_0x314ba4(0x1ec)](_0x5738c2){const _0x1cb5a4=_0x314ba4,{orderId:_0x138129}=_0x5738c2,_0x56fdf8=await this['orderEntity'][_0x1cb5a4(0x1d8)]({'where':{'orderId':_0x138129}});if(!_0x56fdf8)throw new common_1[(_0x1cb5a4(0x1a4))](_0x1cb5a4(0x1c1),common_1[_0x1cb5a4(0x1a5)][_0x1cb5a4(0x1b7)]);return await this[_0x1cb5a4(0x1b0)]['delete']({'orderId':_0x138129});}async['deleteNotPay'](){const _0x55512c=_0x314ba4;return await this[_0x55512c(0x1b0)]['delete']({'status':0x0});}};OrderService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x314ba4(0x1a3)])),__param(0x1,(0x0,typeorm_1[_0x314ba4(0x1a8)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x314ba4(0x1e1)])),__metadata(_0x314ba4(0x1d3),[typeorm_2[_0x314ba4(0x1ce)],typeorm_2['Repository'],typeorm_2['Repository'],pay_service_1['PayService'],globalConfig_service_1[_0x314ba4(0x1db)]])],OrderService),exports[_0x314ba4(0x1d4)]=OrderService;