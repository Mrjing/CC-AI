'use strict';function _0x5e37(_0x486afd,_0x1a258e){const _0x189025=_0x1890();return _0x5e37=function(_0x5e375f,_0x4dafc2){_0x5e375f=_0x5e375f-0x88;let _0x287faa=_0x189025[_0x5e375f];return _0x287faa;},_0x5e37(_0x486afd,_0x1a258e);}const _0x4e71a3=_0x5e37;(function(_0x340e6a,_0x2c7179){const _0x25a663=_0x5e37,_0x44c910=_0x340e6a();while(!![]){try{const _0x3e26db=parseInt(_0x25a663(0x93))/0x1*(-parseInt(_0x25a663(0xde))/0x2)+-parseInt(_0x25a663(0xb8))/0x3*(parseInt(_0x25a663(0xd1))/0x4)+-parseInt(_0x25a663(0x9d))/0x5+-parseInt(_0x25a663(0xd7))/0x6+parseInt(_0x25a663(0xee))/0x7*(-parseInt(_0x25a663(0xa5))/0x8)+parseInt(_0x25a663(0xbc))/0x9*(-parseInt(_0x25a663(0xd2))/0xa)+parseInt(_0x25a663(0xec))/0xb;if(_0x3e26db===_0x2c7179)break;else _0x44c910['push'](_0x44c910['shift']());}catch(_0x344ba4){_0x44c910['push'](_0x44c910['shift']());}}}(_0x1890,0xdc782));var __decorate=this&&this[_0x4e71a3(0x95)]||function(_0x46b3ec,_0x172a58,_0x4b2ef4,_0xf52dd7){const _0x5c0519=_0x4e71a3;var _0x5ea1ef=arguments[_0x5c0519(0xbd)],_0x4ba046=_0x5ea1ef<0x3?_0x172a58:_0xf52dd7===null?_0xf52dd7=Object[_0x5c0519(0xf6)](_0x172a58,_0x4b2ef4):_0xf52dd7,_0x5c11ed;if(typeof Reflect===_0x5c0519(0xe8)&&typeof Reflect['decorate']===_0x5c0519(0xac))_0x4ba046=Reflect['decorate'](_0x46b3ec,_0x172a58,_0x4b2ef4,_0xf52dd7);else{for(var _0xc07ab4=_0x46b3ec['length']-0x1;_0xc07ab4>=0x0;_0xc07ab4--)if(_0x5c11ed=_0x46b3ec[_0xc07ab4])_0x4ba046=(_0x5ea1ef<0x3?_0x5c11ed(_0x4ba046):_0x5ea1ef>0x3?_0x5c11ed(_0x172a58,_0x4b2ef4,_0x4ba046):_0x5c11ed(_0x172a58,_0x4b2ef4))||_0x4ba046;}return _0x5ea1ef>0x3&&_0x4ba046&&Object['defineProperty'](_0x172a58,_0x4b2ef4,_0x4ba046),_0x4ba046;},__metadata=this&&this['__metadata']||function(_0x4cf907,_0x24a1cf){const _0x16baef=_0x4e71a3;if(typeof Reflect===_0x16baef(0xe8)&&typeof Reflect[_0x16baef(0xa2)]===_0x16baef(0xac))return Reflect[_0x16baef(0xa2)](_0x4cf907,_0x24a1cf);},__param=this&&this['__param']||function(_0x4b796f,_0x12f539){return function(_0x148200,_0x1cc1f3){_0x12f539(_0x148200,_0x1cc1f3,_0x4b796f);};};Object[_0x4e71a3(0xa8)](exports,_0x4e71a3(0xa0),{'value':!![]}),exports[_0x4e71a3(0xcf)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x4e71a3(0xa4)),chatLog_entity_1=require(_0x4e71a3(0xc3)),typeorm_2=require(_0x4e71a3(0x94)),balance_constant_1=require('../../common/constants/balance.constant'),user_entity_1=require(_0x4e71a3(0xf8)),utils_1=require(_0x4e71a3(0xd4)),exceljs_1=require(_0x4e71a3(0xa1)),chatGroup_entity_1=require(_0x4e71a3(0xdd));let ChatLogService=class ChatLogService{constructor(_0x165989,_0x30ac26,_0x292f83){const _0xaf5584=_0x4e71a3;this[_0xaf5584(0x8a)]=_0x165989,this[_0xaf5584(0xc8)]=_0x30ac26,this[_0xaf5584(0xe5)]=_0x292f83;}async['saveChatLog'](_0x32008e){const _0x18d4a8=_0x4e71a3;return await this[_0x18d4a8(0x8a)][_0x18d4a8(0xd5)](_0x32008e);}async[_0x4e71a3(0x89)](_0x52035a,_0x29aff3){const _0x233ac3=_0x4e71a3,{id:_0x5b630d}=_0x52035a[_0x233ac3(0xae)],{model:_0x505b8d}=_0x29aff3,_0x177f87={'userId':_0x5b630d,'type':balance_constant_1[_0x233ac3(0xc6)][_0x233ac3(0xcd)]};_0x505b8d&&(_0x177f87[_0x233ac3(0xda)]=_0x505b8d,_0x505b8d===_0x233ac3(0xba)&&(_0x177f87['model']=(0x0,typeorm_2['In'])([_0x233ac3(0xba),'dall-e-3'])));const _0x16777d=await this[_0x233ac3(0x8a)][_0x233ac3(0xa7)]({'where':_0x177f87,'order':{'id':'DESC'},'select':['id',_0x233ac3(0xf5),'prompt','message_id',_0x233ac3(0xf7),_0x233ac3(0xda),_0x233ac3(0xb7),'type',_0x233ac3(0x9a)]});return _0x16777d['forEach'](_0x30ebb4=>{const _0x5560d0=_0x233ac3;if(_0x30ebb4[_0x5560d0(0xa9)]==='paintCount'){const _0x147ab5=_0x30ebb4[_0x5560d0(0xda)]==='mj'?0x136:0xa0,_0x1a7259=_0x30ebb4[_0x5560d0(0xf5)][_0x5560d0(0xb1)](_0x5560d0(0xf2))?_0x5560d0(0xb5):_0x5560d0(0xaf),_0x319dae=_0x1a7259==='tencent'?'?imageView2/1/w/'+_0x147ab5+'/q/55':_0x5560d0(0xb6)+_0x147ab5;_0x30ebb4[_0x5560d0(0xcb)]=_0x30ebb4['answer']+_0x319dae;try{_0x30ebb4[_0x5560d0(0x9a)]=_0x30ebb4[_0x5560d0(0x9a)]?JSON[_0x5560d0(0xbe)](_0x30ebb4[_0x5560d0(0x9a)]):null;}catch(_0x3bb23a){_0x30ebb4[_0x5560d0(0x9a)]={};}}}),_0x16777d;}async['querAllDrawLog'](_0x4cc310){const _0x23b70d=_0x4e71a3,{page:page=0x1,size:size=0x14,rec:_0x48b8ea,userId:_0x263b91,model:_0x241d77}=_0x4cc310,_0x16d197={'type':balance_constant_1['DeductionKey'][_0x23b70d(0xcd)],'prompt':(0x0,typeorm_2['Not'])(''),'answer':(0x0,typeorm_2[_0x23b70d(0xb9)])('')};_0x48b8ea&&Object['assign'](_0x16d197,{'rec':_0x48b8ea}),_0x263b91&&Object['assign'](_0x16d197,{'userId':_0x263b91});_0x241d77&&(_0x16d197[_0x23b70d(0xda)]=_0x241d77,_0x241d77===_0x23b70d(0xba)&&(_0x16d197[_0x23b70d(0xda)]=(0x0,typeorm_2['In'])([_0x23b70d(0xba),'dall-e-3'])));const [_0x2231b1,_0x122635]=await this[_0x23b70d(0x8a)][_0x23b70d(0xe3)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x16d197});return _0x2231b1[_0x23b70d(0xea)](_0x23c8f5=>{const _0x3862a4=_0x23b70d;var _0x10011d;if(_0x23c8f5[_0x3862a4(0xa9)]==='paintCount'){const _0x2c14e0=_0x23c8f5[_0x3862a4(0xda)]==='mj'?0x136:0xa0,_0x5356d7=_0x23c8f5['answer'][_0x3862a4(0xb1)](_0x3862a4(0xf2))?_0x3862a4(0xb5):_0x3862a4(0xaf),_0x4a268f=_0x5356d7==='tencent'?_0x3862a4(0x90)+_0x2c14e0+_0x3862a4(0xf1):_0x3862a4(0xb6)+_0x2c14e0;_0x23c8f5[_0x3862a4(0xcb)]=_0x23c8f5[_0x3862a4(0xf5)]+_0x4a268f;try{const _0x5a5da6=_0x23c8f5[_0x3862a4(0xb7)]?JSON['parse'](_0x23c8f5[_0x3862a4(0xb7)]):null;_0x5a5da6&&(_0x5a5da6?_0x23c8f5['isGroup']=((_0x10011d=_0x5a5da6===null||_0x5a5da6===void 0x0?void 0x0:_0x5a5da6[_0x3862a4(0xdb)][0x0])===null||_0x10011d===void 0x0?void 0x0:_0x10011d[_0x3862a4(0xdb)]['length'])===0x5:_0x23c8f5[_0x3862a4(0xb2)]=![]);}catch(_0x2675d6){console[_0x3862a4(0x9f)](_0x3862a4(0xfa),_0x2675d6);}}}),{'rows':_0x2231b1,'count':_0x122635};}async[_0x4e71a3(0xca)](_0x92044d){const _0x1f068c=_0x4e71a3,{id:_0x5256c2}=_0x92044d,_0x5447cd=await this[_0x1f068c(0x8a)]['findOne']({'where':{'id':_0x5256c2,'type':balance_constant_1[_0x1f068c(0xc6)]['PAINT_TYPE']}});if(!_0x5447cd)throw new common_1[(_0x1f068c(0xe2))](_0x1f068c(0xa3),common_1[_0x1f068c(0xab)][_0x1f068c(0x96)]);const _0x5e75fb=_0x5447cd[_0x1f068c(0xb3)]===0x1?0x0:0x1,_0x5f1a5d=await this['chatLogEntity']['update']({'id':_0x5256c2},{'rec':_0x5e75fb});if(_0x5f1a5d['affected']>0x0)return(_0x5e75fb?'推荐':_0x1f068c(0xd9))+_0x1f068c(0xdc);throw new common_1[(_0x1f068c(0xe2))](_0x1f068c(0xf9),common_1[_0x1f068c(0xab)][_0x1f068c(0x96)]);}async[_0x4e71a3(0xf3)](_0x20e9b8,_0x2918bd){const _0x38acac=_0x4e71a3,_0x3fe037={'type':balance_constant_1[_0x38acac(0xc6)]['CHAT_TYPE']},{page:page=0x1,size:size=0x1e,prompt:_0x26ae57,email:_0x211a03}=_0x20e9b8;_0x26ae57&&Object[_0x38acac(0x97)](_0x3fe037,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x26ae57+'%')});if(_0x211a03){const _0x5c1b09=await this['userEntity'][_0x38acac(0xc9)]({'where':{'email':_0x211a03}});(_0x5c1b09===null||_0x5c1b09===void 0x0?void 0x0:_0x5c1b09['id'])&&Object['assign'](_0x3fe037,{'userId':_0x5c1b09['id']});}const [_0x43df68,_0x3270d4]=await this['chatLogEntity'][_0x38acac(0xe3)]({'order':{'id':_0x38acac(0x88)},'skip':(page-0x1)*size,'take':size,'where':_0x3fe037}),_0x48f4ac=_0x43df68[_0x38acac(0x91)](_0x3602a6=>_0x3602a6['userId']),_0x2b117e=await this[_0x38acac(0xc8)][_0x38acac(0xa7)]({'where':{'id':(0x0,typeorm_2['In'])(_0x48f4ac)}}),_0x3e6fad=_0x43df68[_0x38acac(0x91)](_0x26d3f2=>{const _0x61f57=_0x38acac,_0x23157d=_0x2b117e[_0x61f57(0xa7)](_0x196e75=>_0x196e75['id']===_0x26d3f2['userId']);return{'username':_0x23157d?_0x23157d[_0x61f57(0xa6)]:'','email':_0x23157d?_0x23157d[_0x61f57(0xad)]:'','prompt':_0x26d3f2[_0x61f57(0xc1)],'answer':_0x26d3f2['answer'],'createdAt':(0x0,utils_1[_0x61f57(0x9b)])(_0x26d3f2[_0x61f57(0xf4)])};}),_0x55854d=new exceljs_1[(_0x38acac(0xe6))][(_0x38acac(0xbb))](),_0x35c39a=_0x55854d[_0x38acac(0x8b)](_0x38acac(0x92));_0x35c39a[_0x38acac(0xe9)]=[{'header':_0x38acac(0x9c),'key':_0x38acac(0xa6),'width':0x14},{'header':'用户邮箱','key':_0x38acac(0xad),'width':0x14},{'header':_0x38acac(0xc5),'key':'createdAt','width':0x14},{'header':_0x38acac(0xed),'key':'prompt','width':0x50},{'header':_0x38acac(0x8e),'key':_0x38acac(0xf5),'width':0x96}],_0x3e6fad['forEach'](_0x593928=>_0x35c39a[_0x38acac(0xe4)](_0x593928)),_0x2918bd[_0x38acac(0xd3)](_0x38acac(0xbf),_0x38acac(0xd8)),_0x2918bd['setHeader'](_0x38acac(0x9e),_0x38acac(0xd6)+_0x38acac(0xe1)),await _0x55854d['xlsx'][_0x38acac(0xe0)](_0x2918bd),_0x2918bd[_0x38acac(0xdf)]();}async[_0x4e71a3(0xf0)](_0x2ab6ca,_0x386152){const _0x4c19c4=_0x4e71a3,{page:page=0x1,size:size=0x14,userId:_0x106ce5,prompt:_0x186f6c}=_0x2ab6ca,_0x136aee={'type':balance_constant_1[_0x4c19c4(0xc6)][_0x4c19c4(0xc2)],'prompt':(0x0,typeorm_2[_0x4c19c4(0xb9)])('')};_0x106ce5&&Object[_0x4c19c4(0x97)](_0x136aee,{'userId':_0x106ce5}),_0x186f6c&&Object[_0x4c19c4(0x97)](_0x136aee,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x186f6c+'%')});const [_0x4e256e,_0x48638f]=await this[_0x4c19c4(0x8a)][_0x4c19c4(0xe3)]({'order':{'id':_0x4c19c4(0x88)},'skip':(page-0x1)*size,'take':size,'where':_0x136aee}),_0x37fc92=_0x4e256e[_0x4c19c4(0x91)](_0x470dec=>_0x470dec[_0x4c19c4(0x8f)]),_0x275b57=await this[_0x4c19c4(0xc8)][_0x4c19c4(0xa7)]({'where':{'id':(0x0,typeorm_2['In'])(_0x37fc92)},'select':['id',_0x4c19c4(0xa6),_0x4c19c4(0xad)]});return _0x4e256e[_0x4c19c4(0xea)](_0x2d4110=>{const _0x446fbf=_0x4c19c4,{username:_0x49a763,email:_0x3accd8}=_0x275b57[_0x446fbf(0xa7)](_0x3a0726=>_0x3a0726['id']===_0x2d4110['userId'])||{};_0x2d4110['username']=_0x49a763,_0x2d4110[_0x446fbf(0xad)]=_0x3accd8;}),_0x386152[_0x4c19c4(0xae)][_0x4c19c4(0xe7)]!==_0x4c19c4(0xc4)&&_0x4e256e['forEach'](_0x23e97f=>_0x23e97f[_0x4c19c4(0xad)]=(0x0,utils_1['maskEmail'])(_0x23e97f[_0x4c19c4(0xad)])),_0x4e256e[_0x4c19c4(0xea)](_0x143bd7=>{const _0x26073d=_0x4c19c4;!_0x143bd7[_0x26073d(0xad)]&&(_0x143bd7[_0x26073d(0xad)]=(_0x143bd7===null||_0x143bd7===void 0x0?void 0x0:_0x143bd7[_0x26073d(0x8f)])+_0x26073d(0xc0)),!_0x143bd7[_0x26073d(0xa6)]&&(_0x143bd7[_0x26073d(0xa6)]='游客'+(_0x143bd7===null||_0x143bd7===void 0x0?void 0x0:_0x143bd7[_0x26073d(0x8f)]));}),{'rows':_0x4e256e,'count':_0x48638f};}async[_0x4e71a3(0xce)](_0x55d95d,_0x614361){const _0x298407=_0x4e71a3,{id:_0x30a75c}=_0x55d95d[_0x298407(0xae)],{groupId:_0x28cad3}=_0x614361,_0x348ab7={'userId':_0x30a75c,'isDelete':![]};_0x28cad3&&Object[_0x298407(0x97)](_0x348ab7,{'groupId':_0x28cad3});if(_0x28cad3){const _0x30cd3e=await this['chatGroupEntity'][_0x298407(0xcc)]({'where':{'isDelete':![]}});if(_0x30cd3e===0x0)return[];}const _0x5a328b=await this[_0x298407(0x8a)][_0x298407(0xa7)]({'where':_0x348ab7});return _0x5a328b['map'](_0xceae22=>{const _0x54d787=_0x298407,{prompt:_0x1bf6b0,role:_0x4f2dd5,answer:_0x4a0d0d,createdAt:_0x33659b,model:_0x3ae5cf,conversationOptions:_0xbc417c,requestOptions:_0x222077,id:_0x48df51,imageUrl:_0x5e5e06}=_0xceae22;let _0x4f0132=null,_0x29b4f8=null;try{_0x4f0132=JSON[_0x54d787(0xbe)](_0xbc417c),_0x29b4f8=JSON[_0x54d787(0xbe)](_0x222077);}catch(_0x14c6a1){}return{'chatId':_0x48df51,'dateTime':(0x0,utils_1[_0x54d787(0x9b)])(_0x33659b),'text':_0x4f2dd5===_0x54d787(0xae)?_0x1bf6b0:_0x4a0d0d,'inversion':_0x4f2dd5===_0x54d787(0xae),'error':![],'conversationOptions':_0x4f0132,'requestOptions':_0x29b4f8,'imageUrl':_0x5e5e06,'model':_0x3ae5cf};});}async[_0x4e71a3(0xb0)](_0x1b2176,_0x59650d){const _0x5542a2=_0x4e71a3,{id:_0x528cc7}=_0x1b2176[_0x5542a2(0xae)],{id:_0x1cdd52}=_0x59650d,_0x4f82b4=await this[_0x5542a2(0x8a)][_0x5542a2(0xc9)]({'where':{'id':_0x1cdd52,'userId':_0x528cc7}});if(!_0x4f82b4)throw new common_1['HttpException'](_0x5542a2(0x8c),common_1[_0x5542a2(0xab)][_0x5542a2(0x96)]);const _0x550d36=await this[_0x5542a2(0x8a)][_0x5542a2(0xeb)]({'id':_0x1cdd52},{'isDelete':!![]});if(_0x550d36['affected']>0x0)return _0x5542a2(0x99);else throw new common_1['HttpException']('你删除的对话记录不存在、请检查！',common_1[_0x5542a2(0xab)][_0x5542a2(0x96)]);}async[_0x4e71a3(0xd0)](_0x43f463,_0x5543e3){const _0x2c5352=_0x4e71a3,{groupId:_0xe85a3c}=_0x5543e3,{id:_0xb78fbb}=_0x43f463[_0x2c5352(0xae)],_0x1a4817=await this[_0x2c5352(0xe5)][_0x2c5352(0xc9)]({'where':{'id':_0xe85a3c,'userId':_0xb78fbb}});if(!_0x1a4817)throw new common_1[(_0x2c5352(0xe2))](_0x2c5352(0x8c),common_1[_0x2c5352(0xab)][_0x2c5352(0x96)]);const _0x14800a=await this[_0x2c5352(0x8a)]['update']({'groupId':_0xe85a3c},{'isDelete':!![]});if(_0x14800a[_0x2c5352(0x8d)]>0x0)return'删除对话记录成功！';if(_0x14800a[_0x2c5352(0x8d)]===0x0)throw new common_1[(_0x2c5352(0xe2))]('当前页面已经没有东西可以删除了！',common_1[_0x2c5352(0xab)][_0x2c5352(0x96)]);}async['byAppId'](_0x38060d,_0x1f6668){const _0x2d9856=_0x4e71a3,{id:_0x4bfc14}=_0x38060d[_0x2d9856(0xae)],{appId:_0x1c404e,page:page=0x1,size:size=0xa}=_0x1f6668,[_0x166b5c,_0x42bf4b]=await this[_0x2d9856(0x8a)][_0x2d9856(0xe3)]({'where':{'userId':_0x4bfc14,'appId':_0x1c404e,'role':_0x2d9856(0xb4)},'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size});return{'rows':_0x166b5c,'count':_0x42bf4b};}};function _0x1890(){const _0x49a481=['ali','deleteChatLog','includes','isGroup','rec','assistant','tencent','?x-oss-process=image/resize,w_','extend','15NIKbci','Not','DALL-E2','Workbook','3536424PxiCUc','length','parse','Content-Type','@nine.com','prompt','CHAT_TYPE','./chatLog.entity','super','提问时间','DeductionKey','UserEntity','userEntity','findOne','recDrawImg','thumbImg','count','PAINT_TYPE','chatList','ChatLogService','delByGroupId','1370000GHmeUx','30oXaJPb','setHeader','../../common/utils','save','attachment;\x20filename=','3211848BBViZs','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','取消推荐','model','components','图片成功！','../chatGroup/chatGroup.entity','8166LkTiPv','end','write','chat.xlsx','HttpException','findAndCount','addRow','chatGroupEntity','default','role','object','columns','forEach','update','68920918uPSwWS','提问问题','1344ChwUxM','ChatLogEntity','querAllChatLog','/q/55','cos','exportExcel','createdAt','answer','getOwnPropertyDescriptor','group','../user/user.entity','你操作的图片不存在、请检查！','querAllDrawLog\x20Json\x20parse\x20error','DESC','querDrawLog','chatLogEntity','addWorksheet','你删除的对话记录不存在、请检查！','affected','回答答案','userId','?imageView2/1/w/','map','chatlog','30CHIYED','typeorm','__decorate','BAD_REQUEST','assign','InjectRepository','删除对话记录成功！','fileInfo','formatDate','用户名','1645190kjECWP','Content-Disposition','log','__esModule','exceljs','metadata','你推荐的图片不存在、请检查！','@nestjs/typeorm','61848zhssFG','username','find','defineProperty','type','Repository','HttpStatus','function','email','user'];_0x1890=function(){return _0x49a481;};return _0x1890();}ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x4e71a3(0x98)])(chatLog_entity_1[_0x4e71a3(0xef)])),__param(0x1,(0x0,typeorm_1[_0x4e71a3(0x98)])(user_entity_1[_0x4e71a3(0xc7)])),__param(0x2,(0x0,typeorm_1[_0x4e71a3(0x98)])(chatGroup_entity_1['ChatGroupEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x4e71a3(0xaa)],typeorm_2[_0x4e71a3(0xaa)],typeorm_2[_0x4e71a3(0xaa)]])],ChatLogService),exports[_0x4e71a3(0xcf)]=ChatLogService;