'use strict';const _0x371989=_0x3391;(function(_0x53225f,_0x32dbb8){const _0x129695=_0x3391,_0x47f95d=_0x53225f();while(!![]){try{const _0x432e07=-parseInt(_0x129695(0x1bb))/0x1*(-parseInt(_0x129695(0x16d))/0x2)+-parseInt(_0x129695(0x16f))/0x3*(-parseInt(_0x129695(0x1c4))/0x4)+parseInt(_0x129695(0x191))/0x5*(parseInt(_0x129695(0x186))/0x6)+parseInt(_0x129695(0x1a6))/0x7+-parseInt(_0x129695(0x17d))/0x8*(parseInt(_0x129695(0x18f))/0x9)+parseInt(_0x129695(0x1e0))/0xa*(-parseInt(_0x129695(0x17b))/0xb)+parseInt(_0x129695(0x1a7))/0xc;if(_0x432e07===_0x32dbb8)break;else _0x47f95d['push'](_0x47f95d['shift']());}catch(_0xf085ed){_0x47f95d['push'](_0x47f95d['shift']());}}}(_0x5b58,0xe01ab));function _0x3391(_0x1b0310,_0x27fb9f){const _0x5b58fd=_0x5b58();return _0x3391=function(_0x339150,_0x238aba){_0x339150=_0x339150-0x16d;let _0x20a20b=_0x5b58fd[_0x339150];return _0x20a20b;},_0x3391(_0x1b0310,_0x27fb9f);}var __decorate=this&&this[_0x371989(0x18b)]||function(_0x25cd3b,_0x2c64f7,_0x1cde47,_0x53c47e){const _0x46eb03=_0x371989;var _0x20773c=arguments[_0x46eb03(0x1cd)],_0x13f6b2=_0x20773c<0x3?_0x2c64f7:_0x53c47e===null?_0x53c47e=Object[_0x46eb03(0x1de)](_0x2c64f7,_0x1cde47):_0x53c47e,_0x3d58ec;if(typeof Reflect==='object'&&typeof Reflect[_0x46eb03(0x1d7)]===_0x46eb03(0x1b7))_0x13f6b2=Reflect[_0x46eb03(0x1d7)](_0x25cd3b,_0x2c64f7,_0x1cde47,_0x53c47e);else{for(var _0x5b5267=_0x25cd3b[_0x46eb03(0x1cd)]-0x1;_0x5b5267>=0x0;_0x5b5267--)if(_0x3d58ec=_0x25cd3b[_0x5b5267])_0x13f6b2=(_0x20773c<0x3?_0x3d58ec(_0x13f6b2):_0x20773c>0x3?_0x3d58ec(_0x2c64f7,_0x1cde47,_0x13f6b2):_0x3d58ec(_0x2c64f7,_0x1cde47))||_0x13f6b2;}return _0x20773c>0x3&&_0x13f6b2&&Object[_0x46eb03(0x183)](_0x2c64f7,_0x1cde47,_0x13f6b2),_0x13f6b2;},__metadata=this&&this[_0x371989(0x16e)]||function(_0x6440,_0x4f6bbd){const _0x24b625=_0x371989;if(typeof Reflect===_0x24b625(0x1a2)&&typeof Reflect[_0x24b625(0x1a9)]===_0x24b625(0x1b7))return Reflect['metadata'](_0x6440,_0x4f6bbd);},__param=this&&this[_0x371989(0x18e)]||function(_0xb112d3,_0x3ec131){return function(_0x2b8e1a,_0x4979ca){_0x3ec131(_0x2b8e1a,_0x4979ca,_0xb112d3);};};function _0x5b58(){const _0x1423aa=['deleteChatLog','回答答案','ChatLogEntity','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','4441613LSjsgI','PAINT_TYPE','344JRwCDe','includes','user','图片成功！','DALL-E2','write','defineProperty','createdAt','userId','6cyYhET','querAllDrawLog','exceljs','ali','super','__decorate','?x-oss-process=image/resize,w_','HttpStatus','__param','373914sWoCTc','prompt','3009115nsazXL','paintCount','setHeader','Repository','find','Content-Disposition','map','message_id','count','parse','byAppId','cos','chatLogEntity','isGroup','rec','affected','findAndCount','object','update','chatList','@nestjs/common','7659155RkutLf','2332140pbToVL','group','metadata','./chatLog.entity','dall-e-3','querDrawLog','email','HttpException','?imageView2/1/w/','model','chatlog','DeductionKey','你操作的图片不存在、请检查！','thumbImg','提问问题','log','function','components','assign','BAD_REQUEST','98237AtDHaE','提问时间','你删除的对话记录不存在、请检查！','querAllDrawLog\x20Json\x20parse\x20error','Workbook','ChatLogService','forEach','answer','fileInfo','20jHLzEW','@nine.com','InjectRepository','/q/55','design:paramtypes','Like','saveChatLog','addRow','role','length','xlsx','你推荐的图片不存在、请检查！','chatGroupEntity','DESC','__esModule','attachment;\x20filename=','end','querAllChatLog','用户名','decorate','default','type','userEntity','UserEntity','columns','recDrawImg','getOwnPropertyDescriptor','findOne','20GzlpPt','username','../user/user.entity','取消推荐','ChatGroupEntity','tencent','maskEmail','Content-Type','extend','2ipPHIq','__metadata','914043vlPnkx','Not','addWorksheet','chat.xlsx','../../common/constants/balance.constant','../chatGroup/chatGroup.entity','@nestjs/typeorm','删除对话记录成功！'];_0x5b58=function(){return _0x1423aa;};return _0x5b58();}Object[_0x371989(0x183)](exports,_0x371989(0x1d2),{'value':!![]}),exports[_0x371989(0x1c0)]=void 0x0;const common_1=require(_0x371989(0x1a5)),typeorm_1=require(_0x371989(0x175)),chatLog_entity_1=require(_0x371989(0x1aa)),typeorm_2=require('typeorm'),balance_constant_1=require(_0x371989(0x173)),user_entity_1=require(_0x371989(0x1e2)),utils_1=require('../../common/utils'),exceljs_1=require(_0x371989(0x188)),chatGroup_entity_1=require(_0x371989(0x174));let ChatLogService=class ChatLogService{constructor(_0x5c9c9f,_0x5e38e9,_0x1691bc){const _0x4db908=_0x371989;this['chatLogEntity']=_0x5c9c9f,this[_0x4db908(0x1da)]=_0x5e38e9,this[_0x4db908(0x1d0)]=_0x1691bc;}async[_0x371989(0x1ca)](_0x236127){const _0xa27bee=_0x371989;return await this[_0xa27bee(0x19d)]['save'](_0x236127);}async[_0x371989(0x1ac)](_0x3a3a23,_0x24e8c1){const _0x33806d=_0x371989,{id:_0x18ca09}=_0x3a3a23[_0x33806d(0x17f)],{model:_0x57d088}=_0x24e8c1,_0x22a437={'userId':_0x18ca09,'type':balance_constant_1['DeductionKey'][_0x33806d(0x17c)]};_0x57d088&&(_0x22a437[_0x33806d(0x1b0)]=_0x57d088,_0x57d088===_0x33806d(0x181)&&(_0x22a437[_0x33806d(0x1b0)]=(0x0,typeorm_2['In'])(['DALL-E2',_0x33806d(0x1ab)])));const _0x2c6b7b=await this['chatLogEntity'][_0x33806d(0x195)]({'where':_0x22a437,'order':{'id':_0x33806d(0x1d1)},'select':['id',_0x33806d(0x1c2),'prompt',_0x33806d(0x198),_0x33806d(0x1a8),_0x33806d(0x1b0),_0x33806d(0x1e8),_0x33806d(0x1d9),_0x33806d(0x1c3)]});return _0x2c6b7b[_0x33806d(0x1c1)](_0x3c00d9=>{const _0xb9c45a=_0x33806d;if(_0x3c00d9['type']===_0xb9c45a(0x192)){const _0x2987e9=_0x3c00d9['model']==='mj'?0x136:0xa0,_0x1a5341=_0x3c00d9[_0xb9c45a(0x1c2)]['includes'](_0xb9c45a(0x19c))?_0xb9c45a(0x1e5):_0xb9c45a(0x189),_0x3f7efd=_0x1a5341===_0xb9c45a(0x1e5)?'?imageView2/1/w/'+_0x2987e9+_0xb9c45a(0x1c7):_0xb9c45a(0x18c)+_0x2987e9;_0x3c00d9[_0xb9c45a(0x1b4)]=_0x3c00d9[_0xb9c45a(0x1c2)]+_0x3f7efd;try{_0x3c00d9['fileInfo']=_0x3c00d9['fileInfo']?JSON[_0xb9c45a(0x19a)](_0x3c00d9[_0xb9c45a(0x1c3)]):null;}catch(_0x3274bd){_0x3c00d9[_0xb9c45a(0x1c3)]={};}}}),_0x2c6b7b;}async[_0x371989(0x187)](_0x103aea){const _0x2aa9a4=_0x371989,{page:page=0x1,size:size=0x14,rec:_0x21dc2d,userId:_0x18def4,model:_0x2cc22f}=_0x103aea,_0xc133a2={'type':balance_constant_1[_0x2aa9a4(0x1b2)][_0x2aa9a4(0x17c)],'prompt':(0x0,typeorm_2[_0x2aa9a4(0x170)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x21dc2d&&Object['assign'](_0xc133a2,{'rec':_0x21dc2d}),_0x18def4&&Object[_0x2aa9a4(0x1b9)](_0xc133a2,{'userId':_0x18def4});_0x2cc22f&&(_0xc133a2['model']=_0x2cc22f,_0x2cc22f===_0x2aa9a4(0x181)&&(_0xc133a2[_0x2aa9a4(0x1b0)]=(0x0,typeorm_2['In'])([_0x2aa9a4(0x181),_0x2aa9a4(0x1ab)])));const [_0x1bd657,_0x29dcc2]=await this[_0x2aa9a4(0x19d)][_0x2aa9a4(0x1a1)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0xc133a2});return _0x1bd657['forEach'](_0x3d4a57=>{const _0x3c0af4=_0x2aa9a4;var _0x452507;if(_0x3d4a57[_0x3c0af4(0x1d9)]===_0x3c0af4(0x192)){const _0x155ede=_0x3d4a57[_0x3c0af4(0x1b0)]==='mj'?0x136:0xa0,_0x1ca20a=_0x3d4a57[_0x3c0af4(0x1c2)][_0x3c0af4(0x17e)](_0x3c0af4(0x19c))?_0x3c0af4(0x1e5):_0x3c0af4(0x189),_0x2c9404=_0x1ca20a==='tencent'?_0x3c0af4(0x1af)+_0x155ede+_0x3c0af4(0x1c7):_0x3c0af4(0x18c)+_0x155ede;_0x3d4a57[_0x3c0af4(0x1b4)]=_0x3d4a57[_0x3c0af4(0x1c2)]+_0x2c9404;try{const _0x245211=_0x3d4a57[_0x3c0af4(0x1e8)]?JSON[_0x3c0af4(0x19a)](_0x3d4a57[_0x3c0af4(0x1e8)]):null;_0x245211&&(_0x245211?_0x3d4a57[_0x3c0af4(0x19e)]=((_0x452507=_0x245211===null||_0x245211===void 0x0?void 0x0:_0x245211[_0x3c0af4(0x1b8)][0x0])===null||_0x452507===void 0x0?void 0x0:_0x452507[_0x3c0af4(0x1b8)][_0x3c0af4(0x1cd)])===0x5:_0x3d4a57[_0x3c0af4(0x19e)]=![]);}catch(_0x1e2635){console[_0x3c0af4(0x1b6)](_0x3c0af4(0x1be),_0x1e2635);}}}),{'rows':_0x1bd657,'count':_0x29dcc2};}async[_0x371989(0x1dd)](_0x44803e){const _0x317109=_0x371989,{id:_0x1ab0b4}=_0x44803e,_0x5b32db=await this[_0x317109(0x19d)][_0x317109(0x1df)]({'where':{'id':_0x1ab0b4,'type':balance_constant_1['DeductionKey']['PAINT_TYPE']}});if(!_0x5b32db)throw new common_1[(_0x317109(0x1ae))](_0x317109(0x1cf),common_1['HttpStatus'][_0x317109(0x1ba)]);const _0x4c05bf=_0x5b32db[_0x317109(0x19f)]===0x1?0x0:0x1,_0x223e11=await this[_0x317109(0x19d)][_0x317109(0x1a3)]({'id':_0x1ab0b4},{'rec':_0x4c05bf});if(_0x223e11[_0x317109(0x1a0)]>0x0)return(_0x4c05bf?'推荐':_0x317109(0x1e3))+_0x317109(0x180);throw new common_1['HttpException'](_0x317109(0x1b3),common_1[_0x317109(0x18d)]['BAD_REQUEST']);}async['exportExcel'](_0x43eac0,_0x187cd0){const _0x34aa70=_0x371989,_0x4d19f4={'type':balance_constant_1[_0x34aa70(0x1b2)]['CHAT_TYPE']},{page:page=0x1,size:size=0x1e,prompt:_0x1668bd,email:_0x3abc14}=_0x43eac0;_0x1668bd&&Object[_0x34aa70(0x1b9)](_0x4d19f4,{'prompt':(0x0,typeorm_2[_0x34aa70(0x1c9)])('%'+_0x1668bd+'%')});if(_0x3abc14){const _0x443c79=await this['userEntity']['findOne']({'where':{'email':_0x3abc14}});(_0x443c79===null||_0x443c79===void 0x0?void 0x0:_0x443c79['id'])&&Object[_0x34aa70(0x1b9)](_0x4d19f4,{'userId':_0x443c79['id']});}const [_0x36f84c,_0x385183]=await this[_0x34aa70(0x19d)]['findAndCount']({'order':{'id':_0x34aa70(0x1d1)},'skip':(page-0x1)*size,'take':size,'where':_0x4d19f4}),_0x521960=_0x36f84c['map'](_0x2c1aa1=>_0x2c1aa1['userId']),_0xee840e=await this[_0x34aa70(0x1da)][_0x34aa70(0x195)]({'where':{'id':(0x0,typeorm_2['In'])(_0x521960)}}),_0x13442d=_0x36f84c[_0x34aa70(0x197)](_0x408446=>{const _0x4def07=_0x34aa70,_0x1bc0d4=_0xee840e[_0x4def07(0x195)](_0x598b37=>_0x598b37['id']===_0x408446[_0x4def07(0x185)]);return{'username':_0x1bc0d4?_0x1bc0d4['username']:'','email':_0x1bc0d4?_0x1bc0d4[_0x4def07(0x1ad)]:'','prompt':_0x408446[_0x4def07(0x190)],'answer':_0x408446['answer'],'createdAt':(0x0,utils_1['formatDate'])(_0x408446[_0x4def07(0x184)])};}),_0x569c0a=new exceljs_1[(_0x34aa70(0x1d8))][(_0x34aa70(0x1bf))](),_0x429bff=_0x569c0a[_0x34aa70(0x171)](_0x34aa70(0x1b1));_0x429bff[_0x34aa70(0x1dc)]=[{'header':_0x34aa70(0x1d6),'key':'username','width':0x14},{'header':'用户邮箱','key':'email','width':0x14},{'header':_0x34aa70(0x1bc),'key':_0x34aa70(0x184),'width':0x14},{'header':_0x34aa70(0x1b5),'key':'prompt','width':0x50},{'header':_0x34aa70(0x178),'key':'answer','width':0x96}],_0x13442d[_0x34aa70(0x1c1)](_0x1890d8=>_0x429bff[_0x34aa70(0x1cb)](_0x1890d8)),_0x187cd0[_0x34aa70(0x193)](_0x34aa70(0x1e7),_0x34aa70(0x17a)),_0x187cd0[_0x34aa70(0x193)](_0x34aa70(0x196),_0x34aa70(0x1d3)+_0x34aa70(0x172)),await _0x569c0a[_0x34aa70(0x1ce)][_0x34aa70(0x182)](_0x187cd0),_0x187cd0[_0x34aa70(0x1d4)]();}async[_0x371989(0x1d5)](_0x7b7d4a,_0x48be44){const _0x31a889=_0x371989,{page:page=0x1,size:size=0x14,userId:_0x625acb,prompt:_0x263b05}=_0x7b7d4a,_0x2258c6={'type':balance_constant_1[_0x31a889(0x1b2)]['CHAT_TYPE'],'prompt':(0x0,typeorm_2[_0x31a889(0x170)])('')};_0x625acb&&Object['assign'](_0x2258c6,{'userId':_0x625acb}),_0x263b05&&Object[_0x31a889(0x1b9)](_0x2258c6,{'prompt':(0x0,typeorm_2[_0x31a889(0x1c9)])('%'+_0x263b05+'%')});const [_0x37fb47,_0xf52221]=await this[_0x31a889(0x19d)]['findAndCount']({'order':{'id':_0x31a889(0x1d1)},'skip':(page-0x1)*size,'take':size,'where':_0x2258c6}),_0x11fde8=_0x37fb47[_0x31a889(0x197)](_0x53fcab=>_0x53fcab['userId']),_0x53c0a0=await this[_0x31a889(0x1da)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x11fde8)},'select':['id','username',_0x31a889(0x1ad)]});return _0x37fb47[_0x31a889(0x1c1)](_0x4a588b=>{const _0x19e29d=_0x31a889,{username:_0x437844,email:_0x5ca4ec}=_0x53c0a0[_0x19e29d(0x195)](_0x1eb71c=>_0x1eb71c['id']===_0x4a588b[_0x19e29d(0x185)])||{};_0x4a588b[_0x19e29d(0x1e1)]=_0x437844,_0x4a588b[_0x19e29d(0x1ad)]=_0x5ca4ec;}),_0x48be44[_0x31a889(0x17f)][_0x31a889(0x1cc)]!==_0x31a889(0x18a)&&_0x37fb47[_0x31a889(0x1c1)](_0x2f8817=>_0x2f8817['email']=(0x0,utils_1[_0x31a889(0x1e6)])(_0x2f8817[_0x31a889(0x1ad)])),_0x37fb47[_0x31a889(0x1c1)](_0x1fa14a=>{const _0x425fb3=_0x31a889;!_0x1fa14a[_0x425fb3(0x1ad)]&&(_0x1fa14a[_0x425fb3(0x1ad)]=(_0x1fa14a===null||_0x1fa14a===void 0x0?void 0x0:_0x1fa14a[_0x425fb3(0x185)])+_0x425fb3(0x1c5)),!_0x1fa14a[_0x425fb3(0x1e1)]&&(_0x1fa14a[_0x425fb3(0x1e1)]='游客'+(_0x1fa14a===null||_0x1fa14a===void 0x0?void 0x0:_0x1fa14a['userId']));}),{'rows':_0x37fb47,'count':_0xf52221};}async[_0x371989(0x1a4)](_0x4e18e4,_0x2a35a5){const _0x31cf26=_0x371989,{id:_0x371d1a}=_0x4e18e4[_0x31cf26(0x17f)],{groupId:_0x5c5acb}=_0x2a35a5,_0x16a92d={'userId':_0x371d1a,'isDelete':![]};_0x5c5acb&&Object[_0x31cf26(0x1b9)](_0x16a92d,{'groupId':_0x5c5acb});if(_0x5c5acb){const _0x1fbc46=await this[_0x31cf26(0x1d0)][_0x31cf26(0x199)]({'where':{'isDelete':![]}});if(_0x1fbc46===0x0)return[];}const _0x590a7a=await this[_0x31cf26(0x19d)]['find']({'where':_0x16a92d});return _0x590a7a[_0x31cf26(0x197)](_0x1399c3=>{const _0x1da8d9=_0x31cf26,{prompt:_0x1bbdba,role:_0x67027,answer:_0xed9e8a,createdAt:_0x344fe2,model:_0x4ce7e8,conversationOptions:_0x548e5f,requestOptions:_0x570b0f,id:_0x545e8a,imageUrl:_0x1c0028}=_0x1399c3;let _0x42d96e=null,_0x3a4a4e=null;try{_0x42d96e=JSON['parse'](_0x548e5f),_0x3a4a4e=JSON[_0x1da8d9(0x19a)](_0x570b0f);}catch(_0x4dfaef){}return{'chatId':_0x545e8a,'dateTime':(0x0,utils_1['formatDate'])(_0x344fe2),'text':_0x67027===_0x1da8d9(0x17f)?_0x1bbdba:_0xed9e8a,'inversion':_0x67027===_0x1da8d9(0x17f),'error':![],'conversationOptions':_0x42d96e,'requestOptions':_0x3a4a4e,'imageUrl':_0x1c0028,'model':_0x4ce7e8};});}async[_0x371989(0x177)](_0x3d330f,_0x4f0dbd){const _0x522f3b=_0x371989,{id:_0x8b598b}=_0x3d330f[_0x522f3b(0x17f)],{id:_0x5e2b2c}=_0x4f0dbd,_0x22716d=await this[_0x522f3b(0x19d)][_0x522f3b(0x1df)]({'where':{'id':_0x5e2b2c,'userId':_0x8b598b}});if(!_0x22716d)throw new common_1[(_0x522f3b(0x1ae))](_0x522f3b(0x1bd),common_1[_0x522f3b(0x18d)][_0x522f3b(0x1ba)]);const _0x4a39a9=await this[_0x522f3b(0x19d)][_0x522f3b(0x1a3)]({'id':_0x5e2b2c},{'isDelete':!![]});if(_0x4a39a9[_0x522f3b(0x1a0)]>0x0)return'删除对话记录成功！';else throw new common_1['HttpException']('你删除的对话记录不存在、请检查！',common_1[_0x522f3b(0x18d)]['BAD_REQUEST']);}async['delByGroupId'](_0x4899a9,_0xd500ea){const _0x406bb2=_0x371989,{groupId:_0xabcc79}=_0xd500ea,{id:_0x289038}=_0x4899a9[_0x406bb2(0x17f)],_0x48a43d=await this[_0x406bb2(0x1d0)][_0x406bb2(0x1df)]({'where':{'id':_0xabcc79,'userId':_0x289038}});if(!_0x48a43d)throw new common_1[(_0x406bb2(0x1ae))]('你删除的对话记录不存在、请检查！',common_1[_0x406bb2(0x18d)][_0x406bb2(0x1ba)]);const _0x42eb4a=await this[_0x406bb2(0x19d)][_0x406bb2(0x1a3)]({'groupId':_0xabcc79},{'isDelete':!![]});if(_0x42eb4a['affected']>0x0)return _0x406bb2(0x176);if(_0x42eb4a[_0x406bb2(0x1a0)]===0x0)throw new common_1['HttpException']('当前页面已经没有东西可以删除了！',common_1[_0x406bb2(0x18d)][_0x406bb2(0x1ba)]);}async[_0x371989(0x19b)](_0x124800,_0x2b84d3){const _0x4a7eb4=_0x371989,{id:_0x46f231}=_0x124800[_0x4a7eb4(0x17f)],{appId:_0x12d539,page:page=0x1,size:size=0xa}=_0x2b84d3,[_0x4b870e,_0x24685b]=await this[_0x4a7eb4(0x19d)][_0x4a7eb4(0x1a1)]({'where':{'userId':_0x46f231,'appId':_0x12d539,'role':'assistant'},'order':{'id':_0x4a7eb4(0x1d1)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x4b870e,'count':_0x24685b};}};ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x371989(0x179)])),__param(0x1,(0x0,typeorm_1[_0x371989(0x1c6)])(user_entity_1[_0x371989(0x1db)])),__param(0x2,(0x0,typeorm_1[_0x371989(0x1c6)])(chatGroup_entity_1[_0x371989(0x1e4)])),__metadata(_0x371989(0x1c8),[typeorm_2['Repository'],typeorm_2[_0x371989(0x194)],typeorm_2[_0x371989(0x194)]])],ChatLogService),exports['ChatLogService']=ChatLogService;