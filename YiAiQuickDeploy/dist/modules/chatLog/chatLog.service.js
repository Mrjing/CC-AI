'use strict';const _0x36d3a0=_0x9d93;(function(_0x3b86d8,_0xbadc37){const _0x2e9057=_0x9d93,_0x2ccd33=_0x3b86d8();while(!![]){try{const _0x4da1a8=parseInt(_0x2e9057(0x1da))/0x1+-parseInt(_0x2e9057(0x1d6))/0x2*(parseInt(_0x2e9057(0x224))/0x3)+-parseInt(_0x2e9057(0x1d4))/0x4+parseInt(_0x2e9057(0x1dc))/0x5*(parseInt(_0x2e9057(0x1d7))/0x6)+-parseInt(_0x2e9057(0x1cb))/0x7+parseInt(_0x2e9057(0x216))/0x8*(-parseInt(_0x2e9057(0x20e))/0x9)+parseInt(_0x2e9057(0x1d3))/0xa;if(_0x4da1a8===_0xbadc37)break;else _0x2ccd33['push'](_0x2ccd33['shift']());}catch(_0xf2b40d){_0x2ccd33['push'](_0x2ccd33['shift']());}}}(_0x320f,0x8380f));var __decorate=this&&this['__decorate']||function(_0x2b443a,_0x16e866,_0x419b56,_0x153758){const _0x59b83d=_0x9d93;var _0x20f7dd=arguments[_0x59b83d(0x1f9)],_0x4afa9d=_0x20f7dd<0x3?_0x16e866:_0x153758===null?_0x153758=Object[_0x59b83d(0x22c)](_0x16e866,_0x419b56):_0x153758,_0x55eaf7;if(typeof Reflect===_0x59b83d(0x22b)&&typeof Reflect[_0x59b83d(0x218)]===_0x59b83d(0x1e3))_0x4afa9d=Reflect[_0x59b83d(0x218)](_0x2b443a,_0x16e866,_0x419b56,_0x153758);else{for(var _0x13eb7f=_0x2b443a[_0x59b83d(0x1f9)]-0x1;_0x13eb7f>=0x0;_0x13eb7f--)if(_0x55eaf7=_0x2b443a[_0x13eb7f])_0x4afa9d=(_0x20f7dd<0x3?_0x55eaf7(_0x4afa9d):_0x20f7dd>0x3?_0x55eaf7(_0x16e866,_0x419b56,_0x4afa9d):_0x55eaf7(_0x16e866,_0x419b56))||_0x4afa9d;}return _0x20f7dd>0x3&&_0x4afa9d&&Object[_0x59b83d(0x1ea)](_0x16e866,_0x419b56,_0x4afa9d),_0x4afa9d;},__metadata=this&&this[_0x36d3a0(0x211)]||function(_0x1d3f05,_0x13bbbe){const _0x50cdb5=_0x36d3a0;if(typeof Reflect===_0x50cdb5(0x22b)&&typeof Reflect[_0x50cdb5(0x1e5)]==='function')return Reflect[_0x50cdb5(0x1e5)](_0x1d3f05,_0x13bbbe);},__param=this&&this[_0x36d3a0(0x1fe)]||function(_0x2e236c,_0x518e0d){return function(_0xfc5f85,_0x539548){_0x518e0d(_0xfc5f85,_0x539548,_0x2e236c);};};function _0x320f(){const _0x15f89f=['/q/55','__param','exportExcel','CHAT_TYPE','用户名','isGroup','取消推荐','message_id','chat.xlsx','delByGroupId','extend','ali','当前页面已经没有东西可以删除了！','ChatGroupEntity','chatlog','parse','assign','2027061KCxyHk','InjectRepository','你删除的对话记录不存在、请检查！','__metadata','save','userEntity','count','删除对话记录成功！','16aJezLb','saveChatLog','decorate','update','querAllDrawLog\x20Json\x20parse\x20error','createdAt','./chatLog.entity','maskEmail','username','findAndCount','formatDate','thumbImg','type','typeorm','9fZRAlc','group','includes','model','Workbook','UserEntity','Like','object','getOwnPropertyDescriptor','prompt','你推荐的图片不存在、请检查！','用户邮箱','PAINT_TYPE','userId','user','@nine.com','attachment;\x20filename=','DeductionKey','Injectable','email','map','addRow','DESC','DALL-E2','ChatLogService','BAD_REQUEST','exceljs','6029282OrpWlz','?x-oss-process=image/resize,w_','answer','tencent','dall-e-3','recDrawImg','forEach','byAppId','22276620gYvNwh','3426252oinPgJ','../user/user.entity','143598cPDcUD','3025158tevfeJ','Content-Type','addWorksheet','190528qFKrcs','super','5DEBlpv','querAllChatLog','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','findOne','Repository','../../common/constants/balance.constant','__esModule','function','find','metadata','HttpStatus','../../common/utils','HttpException','Not','defineProperty','paintCount','fileInfo','rec','deleteChatLog','querDrawLog','图片成功！','role','affected','components','write','default','end','chatLogEntity','setHeader','length','chatGroupEntity','@nestjs/common','提问问题'];_0x320f=function(){return _0x15f89f;};return _0x320f();}Object['defineProperty'](exports,_0x36d3a0(0x1e2),{'value':!![]}),exports[_0x36d3a0(0x1c8)]=void 0x0;function _0x9d93(_0x33ddcc,_0x4298c6){const _0x320f8b=_0x320f();return _0x9d93=function(_0x9d93c8,_0x1be3a1){_0x9d93c8=_0x9d93c8-0x1c7;let _0xef8c21=_0x320f8b[_0x9d93c8];return _0xef8c21;},_0x9d93(_0x33ddcc,_0x4298c6);}const common_1=require(_0x36d3a0(0x1fb)),typeorm_1=require('@nestjs/typeorm'),chatLog_entity_1=require(_0x36d3a0(0x21c)),typeorm_2=require(_0x36d3a0(0x223)),balance_constant_1=require(_0x36d3a0(0x1e1)),user_entity_1=require(_0x36d3a0(0x1d5)),utils_1=require(_0x36d3a0(0x1e7)),exceljs_1=require(_0x36d3a0(0x1ca)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity');let ChatLogService=class ChatLogService{constructor(_0x1a1532,_0x23e009,_0x69ab5){const _0x33d4f6=_0x36d3a0;this[_0x33d4f6(0x1f7)]=_0x1a1532,this[_0x33d4f6(0x213)]=_0x23e009,this[_0x33d4f6(0x1fa)]=_0x69ab5;}async[_0x36d3a0(0x217)](_0x3deb1d){const _0x1821a4=_0x36d3a0;return await this[_0x1821a4(0x1f7)][_0x1821a4(0x212)](_0x3deb1d);}async[_0x36d3a0(0x1ef)](_0x1aefdd,_0x4ce11a){const _0x341777=_0x36d3a0,{id:_0x474138}=_0x1aefdd['user'],{model:_0x4afffa}=_0x4ce11a,_0x237934={'userId':_0x474138,'type':balance_constant_1['DeductionKey'][_0x341777(0x230)]};_0x4afffa&&(_0x237934['model']=_0x4afffa,_0x4afffa===_0x341777(0x1c7)&&(_0x237934['model']=(0x0,typeorm_2['In'])([_0x341777(0x1c7),_0x341777(0x1cf)])));const _0x37205e=await this['chatLogEntity'][_0x341777(0x1e4)]({'where':_0x237934,'order':{'id':_0x341777(0x23a)},'select':['id','answer',_0x341777(0x22d),_0x341777(0x204),_0x341777(0x225),_0x341777(0x227),_0x341777(0x207),'type',_0x341777(0x1ec)]});return _0x37205e[_0x341777(0x1d1)](_0x39c766=>{const _0x5cc380=_0x341777;if(_0x39c766['type']==='paintCount'){const _0x2530bd=_0x39c766['model']==='mj'?0x136:0xa0,_0x4cbe3c=_0x39c766[_0x5cc380(0x1cd)][_0x5cc380(0x226)]('cos')?_0x5cc380(0x1ce):_0x5cc380(0x208),_0x1fc559=_0x4cbe3c===_0x5cc380(0x1ce)?'?imageView2/1/w/'+_0x2530bd+'/q/55':'?x-oss-process=image/resize,w_'+_0x2530bd;_0x39c766[_0x5cc380(0x221)]=_0x39c766['answer']+_0x1fc559;try{_0x39c766[_0x5cc380(0x1ec)]=_0x39c766[_0x5cc380(0x1ec)]?JSON[_0x5cc380(0x20c)](_0x39c766[_0x5cc380(0x1ec)]):null;}catch(_0xb0e95){_0x39c766[_0x5cc380(0x1ec)]={};}}}),_0x37205e;}async['querAllDrawLog'](_0x35842d){const _0x2dcaea=_0x36d3a0,{page:page=0x1,size:size=0x14,rec:_0x5ccf6b,userId:_0xde9f10,model:_0x17adb2}=_0x35842d,_0x3854c1={'type':balance_constant_1[_0x2dcaea(0x235)][_0x2dcaea(0x230)],'prompt':(0x0,typeorm_2[_0x2dcaea(0x1e9)])(''),'answer':(0x0,typeorm_2[_0x2dcaea(0x1e9)])('')};_0x5ccf6b&&Object['assign'](_0x3854c1,{'rec':_0x5ccf6b}),_0xde9f10&&Object[_0x2dcaea(0x20d)](_0x3854c1,{'userId':_0xde9f10});_0x17adb2&&(_0x3854c1[_0x2dcaea(0x227)]=_0x17adb2,_0x17adb2===_0x2dcaea(0x1c7)&&(_0x3854c1[_0x2dcaea(0x227)]=(0x0,typeorm_2['In'])([_0x2dcaea(0x1c7),_0x2dcaea(0x1cf)])));const [_0x452980,_0x2856d7]=await this[_0x2dcaea(0x1f7)]['findAndCount']({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x3854c1});return _0x452980['forEach'](_0x153f86=>{const _0x3572dc=_0x2dcaea;var _0x33426d;if(_0x153f86[_0x3572dc(0x222)]===_0x3572dc(0x1eb)){const _0x14acae=_0x153f86[_0x3572dc(0x227)]==='mj'?0x136:0xa0,_0x4ba1ee=_0x153f86[_0x3572dc(0x1cd)][_0x3572dc(0x226)]('cos')?_0x3572dc(0x1ce):_0x3572dc(0x208),_0xcaced5=_0x4ba1ee==='tencent'?'?imageView2/1/w/'+_0x14acae+_0x3572dc(0x1fd):_0x3572dc(0x1cc)+_0x14acae;_0x153f86['thumbImg']=_0x153f86[_0x3572dc(0x1cd)]+_0xcaced5;try{const _0x55662d=_0x153f86[_0x3572dc(0x207)]?JSON[_0x3572dc(0x20c)](_0x153f86[_0x3572dc(0x207)]):null;_0x55662d&&(_0x55662d?_0x153f86[_0x3572dc(0x202)]=((_0x33426d=_0x55662d===null||_0x55662d===void 0x0?void 0x0:_0x55662d[_0x3572dc(0x1f3)][0x0])===null||_0x33426d===void 0x0?void 0x0:_0x33426d[_0x3572dc(0x1f3)]['length'])===0x5:_0x153f86[_0x3572dc(0x202)]=![]);}catch(_0x590246){console['log'](_0x3572dc(0x21a),_0x590246);}}}),{'rows':_0x452980,'count':_0x2856d7};}async[_0x36d3a0(0x1d0)](_0x1da3a2){const _0x512394=_0x36d3a0,{id:_0x57bd3a}=_0x1da3a2,_0x15b44a=await this['chatLogEntity'][_0x512394(0x1df)]({'where':{'id':_0x57bd3a,'type':balance_constant_1[_0x512394(0x235)]['PAINT_TYPE']}});if(!_0x15b44a)throw new common_1[(_0x512394(0x1e8))](_0x512394(0x22e),common_1[_0x512394(0x1e6)][_0x512394(0x1c9)]);const _0x4e92b5=_0x15b44a[_0x512394(0x1ed)]===0x1?0x0:0x1,_0x5dd650=await this[_0x512394(0x1f7)][_0x512394(0x219)]({'id':_0x57bd3a},{'rec':_0x4e92b5});if(_0x5dd650['affected']>0x0)return(_0x4e92b5?'推荐':_0x512394(0x203))+_0x512394(0x1f0);throw new common_1['HttpException']('你操作的图片不存在、请检查！',common_1[_0x512394(0x1e6)]['BAD_REQUEST']);}async[_0x36d3a0(0x1ff)](_0x4b7297,_0x591703){const _0x5bd56f=_0x36d3a0,_0x467169={'type':balance_constant_1[_0x5bd56f(0x235)][_0x5bd56f(0x200)]},{page:page=0x1,size:size=0x1e,prompt:_0x286e0f,email:_0x6927a1}=_0x4b7297;_0x286e0f&&Object[_0x5bd56f(0x20d)](_0x467169,{'prompt':(0x0,typeorm_2[_0x5bd56f(0x22a)])('%'+_0x286e0f+'%')});if(_0x6927a1){const _0x1f7a21=await this[_0x5bd56f(0x213)][_0x5bd56f(0x1df)]({'where':{'email':_0x6927a1}});(_0x1f7a21===null||_0x1f7a21===void 0x0?void 0x0:_0x1f7a21['id'])&&Object[_0x5bd56f(0x20d)](_0x467169,{'userId':_0x1f7a21['id']});}const [_0x16173a,_0x3675b4]=await this['chatLogEntity'][_0x5bd56f(0x21f)]({'order':{'id':_0x5bd56f(0x23a)},'skip':(page-0x1)*size,'take':size,'where':_0x467169}),_0x3c5f4e=_0x16173a[_0x5bd56f(0x238)](_0x2f5a0b=>_0x2f5a0b[_0x5bd56f(0x231)]),_0x5982f4=await this[_0x5bd56f(0x213)][_0x5bd56f(0x1e4)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3c5f4e)}}),_0x1746b3=_0x16173a[_0x5bd56f(0x238)](_0x2bdff1=>{const _0x2e43e4=_0x5bd56f,_0x1a0fcf=_0x5982f4[_0x2e43e4(0x1e4)](_0x5bc77d=>_0x5bc77d['id']===_0x2bdff1[_0x2e43e4(0x231)]);return{'username':_0x1a0fcf?_0x1a0fcf[_0x2e43e4(0x21e)]:'','email':_0x1a0fcf?_0x1a0fcf[_0x2e43e4(0x237)]:'','prompt':_0x2bdff1[_0x2e43e4(0x22d)],'answer':_0x2bdff1[_0x2e43e4(0x1cd)],'createdAt':(0x0,utils_1['formatDate'])(_0x2bdff1[_0x2e43e4(0x21b)])};}),_0xe5c61d=new exceljs_1[(_0x5bd56f(0x1f5))][(_0x5bd56f(0x228))](),_0x3cf9b3=_0xe5c61d[_0x5bd56f(0x1d9)](_0x5bd56f(0x20b));_0x3cf9b3['columns']=[{'header':_0x5bd56f(0x201),'key':_0x5bd56f(0x21e),'width':0x14},{'header':_0x5bd56f(0x22f),'key':_0x5bd56f(0x237),'width':0x14},{'header':'提问时间','key':_0x5bd56f(0x21b),'width':0x14},{'header':_0x5bd56f(0x1fc),'key':_0x5bd56f(0x22d),'width':0x50},{'header':'回答答案','key':_0x5bd56f(0x1cd),'width':0x96}],_0x1746b3[_0x5bd56f(0x1d1)](_0x4e17d5=>_0x3cf9b3[_0x5bd56f(0x239)](_0x4e17d5)),_0x591703[_0x5bd56f(0x1f8)](_0x5bd56f(0x1d8),_0x5bd56f(0x1de)),_0x591703[_0x5bd56f(0x1f8)]('Content-Disposition',_0x5bd56f(0x234)+_0x5bd56f(0x205)),await _0xe5c61d['xlsx'][_0x5bd56f(0x1f4)](_0x591703),_0x591703[_0x5bd56f(0x1f6)]();}async[_0x36d3a0(0x1dd)](_0x4d58e5,_0x5db25f){const _0x49d6e1=_0x36d3a0,{page:page=0x1,size:size=0x14,userId:_0x1e8701,prompt:_0x485ff9}=_0x4d58e5,_0x2ec229={'type':balance_constant_1[_0x49d6e1(0x235)][_0x49d6e1(0x200)],'prompt':(0x0,typeorm_2[_0x49d6e1(0x1e9)])('')};_0x1e8701&&Object[_0x49d6e1(0x20d)](_0x2ec229,{'userId':_0x1e8701}),_0x485ff9&&Object[_0x49d6e1(0x20d)](_0x2ec229,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x485ff9+'%')});const [_0x24e999,_0x3d44c2]=await this[_0x49d6e1(0x1f7)][_0x49d6e1(0x21f)]({'order':{'id':_0x49d6e1(0x23a)},'skip':(page-0x1)*size,'take':size,'where':_0x2ec229}),_0x214e93=_0x24e999[_0x49d6e1(0x238)](_0x1e0341=>_0x1e0341['userId']),_0x3abee9=await this['userEntity'][_0x49d6e1(0x1e4)]({'where':{'id':(0x0,typeorm_2['In'])(_0x214e93)},'select':['id',_0x49d6e1(0x21e),_0x49d6e1(0x237)]});return _0x24e999[_0x49d6e1(0x1d1)](_0x5b6be1=>{const _0x4208f2=_0x49d6e1,{username:_0x2d64cc,email:_0x32562e}=_0x3abee9[_0x4208f2(0x1e4)](_0x505cab=>_0x505cab['id']===_0x5b6be1[_0x4208f2(0x231)])||{};_0x5b6be1[_0x4208f2(0x21e)]=_0x2d64cc,_0x5b6be1[_0x4208f2(0x237)]=_0x32562e;}),_0x5db25f['user'][_0x49d6e1(0x1f1)]!==_0x49d6e1(0x1db)&&_0x24e999[_0x49d6e1(0x1d1)](_0x1e09ff=>_0x1e09ff[_0x49d6e1(0x237)]=(0x0,utils_1[_0x49d6e1(0x21d)])(_0x1e09ff[_0x49d6e1(0x237)])),_0x24e999[_0x49d6e1(0x1d1)](_0x17983a=>{const _0x14492a=_0x49d6e1;!_0x17983a[_0x14492a(0x237)]&&(_0x17983a[_0x14492a(0x237)]=(_0x17983a===null||_0x17983a===void 0x0?void 0x0:_0x17983a[_0x14492a(0x231)])+_0x14492a(0x233)),!_0x17983a[_0x14492a(0x21e)]&&(_0x17983a[_0x14492a(0x21e)]='游客'+(_0x17983a===null||_0x17983a===void 0x0?void 0x0:_0x17983a[_0x14492a(0x231)]));}),{'rows':_0x24e999,'count':_0x3d44c2};}async['chatList'](_0x1d5ad6,_0x3f270b){const _0x44dc0a=_0x36d3a0,{id:_0x2af7e6}=_0x1d5ad6[_0x44dc0a(0x232)],{groupId:_0x4fda09}=_0x3f270b,_0x113736={'userId':_0x2af7e6,'isDelete':![]};_0x4fda09&&Object['assign'](_0x113736,{'groupId':_0x4fda09});if(_0x4fda09){const _0x5578dd=await this['chatGroupEntity'][_0x44dc0a(0x214)]({'where':{'isDelete':![]}});if(_0x5578dd===0x0)return[];}const _0x537ef3=await this[_0x44dc0a(0x1f7)][_0x44dc0a(0x1e4)]({'where':_0x113736});return _0x537ef3[_0x44dc0a(0x238)](_0x3a6dd6=>{const _0x18837e=_0x44dc0a,{prompt:_0x4d740f,role:_0x85e624,answer:_0x145a8d,createdAt:_0xa10e8d,model:_0x7f1b53,conversationOptions:_0x2f5753,requestOptions:_0x1c4ed5,id:_0xb018bc,imageUrl:_0x50158e}=_0x3a6dd6;let _0x2a7bf5=null,_0x181588=null;try{_0x2a7bf5=JSON[_0x18837e(0x20c)](_0x2f5753),_0x181588=JSON[_0x18837e(0x20c)](_0x1c4ed5);}catch(_0x27c619){}return{'chatId':_0xb018bc,'dateTime':(0x0,utils_1[_0x18837e(0x220)])(_0xa10e8d),'text':_0x85e624===_0x18837e(0x232)?_0x4d740f:_0x145a8d,'inversion':_0x85e624===_0x18837e(0x232),'error':![],'conversationOptions':_0x2a7bf5,'requestOptions':_0x181588,'imageUrl':_0x50158e,'model':_0x7f1b53};});}async[_0x36d3a0(0x1ee)](_0x3a8f11,_0x3294bd){const _0x580ee3=_0x36d3a0,{id:_0xdb2d73}=_0x3a8f11[_0x580ee3(0x232)],{id:_0xaf3e9f}=_0x3294bd,_0x1dd24a=await this['chatLogEntity']['findOne']({'where':{'id':_0xaf3e9f,'userId':_0xdb2d73}});if(!_0x1dd24a)throw new common_1[(_0x580ee3(0x1e8))](_0x580ee3(0x210),common_1['HttpStatus']['BAD_REQUEST']);const _0x23dc3c=await this[_0x580ee3(0x1f7)][_0x580ee3(0x219)]({'id':_0xaf3e9f},{'isDelete':!![]});if(_0x23dc3c['affected']>0x0)return'删除对话记录成功！';else throw new common_1[(_0x580ee3(0x1e8))](_0x580ee3(0x210),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x36d3a0(0x206)](_0x17ed81,_0x4fcc7a){const _0x464f3e=_0x36d3a0,{groupId:_0x2fd684}=_0x4fcc7a,{id:_0x17420e}=_0x17ed81[_0x464f3e(0x232)],_0xe7db05=await this[_0x464f3e(0x1fa)]['findOne']({'where':{'id':_0x2fd684,'userId':_0x17420e}});if(!_0xe7db05)throw new common_1[(_0x464f3e(0x1e8))](_0x464f3e(0x210),common_1[_0x464f3e(0x1e6)][_0x464f3e(0x1c9)]);const _0x522800=await this[_0x464f3e(0x1f7)][_0x464f3e(0x219)]({'groupId':_0x2fd684},{'isDelete':!![]});if(_0x522800[_0x464f3e(0x1f2)]>0x0)return _0x464f3e(0x215);if(_0x522800[_0x464f3e(0x1f2)]===0x0)throw new common_1[(_0x464f3e(0x1e8))](_0x464f3e(0x209),common_1[_0x464f3e(0x1e6)][_0x464f3e(0x1c9)]);}async[_0x36d3a0(0x1d2)](_0x7ffdd8,_0x516316){const _0x98c14=_0x36d3a0,{id:_0x1bb088}=_0x7ffdd8[_0x98c14(0x232)],{appId:_0x2d3375,page:page=0x1,size:size=0xa}=_0x516316,[_0x50c145,_0x4b398a]=await this[_0x98c14(0x1f7)]['findAndCount']({'where':{'userId':_0x1bb088,'appId':_0x2d3375,'role':'assistant'},'order':{'id':_0x98c14(0x23a)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x50c145,'count':_0x4b398a};}};ChatLogService=__decorate([(0x0,common_1[_0x36d3a0(0x236)])(),__param(0x0,(0x0,typeorm_1[_0x36d3a0(0x20f)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x36d3a0(0x20f)])(user_entity_1[_0x36d3a0(0x229)])),__param(0x2,(0x0,typeorm_1[_0x36d3a0(0x20f)])(chatGroup_entity_1[_0x36d3a0(0x20a)])),__metadata('design:paramtypes',[typeorm_2[_0x36d3a0(0x1e0)],typeorm_2[_0x36d3a0(0x1e0)],typeorm_2[_0x36d3a0(0x1e0)]])],ChatLogService),exports['ChatLogService']=ChatLogService;