'use strict';const _0x49cb99=_0x4a77;function _0x4a77(_0x4e7424,_0x4f8cdf){const _0x33565c=_0x3356();return _0x4a77=function(_0x4a77c6,_0x1ed600){_0x4a77c6=_0x4a77c6-0x1be;let _0x157610=_0x33565c[_0x4a77c6];return _0x157610;},_0x4a77(_0x4e7424,_0x4f8cdf);}(function(_0xda12a1,_0x33cc22){const _0xb26d66=_0x4a77,_0x4d589d=_0xda12a1();while(!![]){try{const _0xe86c0a=-parseInt(_0xb26d66(0x1fd))/0x1+parseInt(_0xb26d66(0x1de))/0x2*(parseInt(_0xb26d66(0x1c0))/0x3)+-parseInt(_0xb26d66(0x1da))/0x4*(-parseInt(_0xb26d66(0x21d))/0x5)+-parseInt(_0xb26d66(0x210))/0x6*(-parseInt(_0xb26d66(0x1ef))/0x7)+-parseInt(_0xb26d66(0x1c4))/0x8+-parseInt(_0xb26d66(0x1d4))/0x9*(parseInt(_0xb26d66(0x1fe))/0xa)+parseInt(_0xb26d66(0x222))/0xb;if(_0xe86c0a===_0x33cc22)break;else _0x4d589d['push'](_0x4d589d['shift']());}catch(_0x2bb199){_0x4d589d['push'](_0x4d589d['shift']());}}}(_0x3356,0x769ab));var __decorate=this&&this[_0x49cb99(0x223)]||function(_0x28bb2b,_0x2c2879,_0x4df6a5,_0x36be9f){const _0x45a059=_0x49cb99;var _0x9676f6=arguments['length'],_0x2b73ed=_0x9676f6<0x3?_0x2c2879:_0x36be9f===null?_0x36be9f=Object[_0x45a059(0x1e6)](_0x2c2879,_0x4df6a5):_0x36be9f,_0xfcec7f;if(typeof Reflect===_0x45a059(0x205)&&typeof Reflect[_0x45a059(0x1ee)]===_0x45a059(0x1f6))_0x2b73ed=Reflect[_0x45a059(0x1ee)](_0x28bb2b,_0x2c2879,_0x4df6a5,_0x36be9f);else{for(var _0x38a580=_0x28bb2b['length']-0x1;_0x38a580>=0x0;_0x38a580--)if(_0xfcec7f=_0x28bb2b[_0x38a580])_0x2b73ed=(_0x9676f6<0x3?_0xfcec7f(_0x2b73ed):_0x9676f6>0x3?_0xfcec7f(_0x2c2879,_0x4df6a5,_0x2b73ed):_0xfcec7f(_0x2c2879,_0x4df6a5))||_0x2b73ed;}return _0x9676f6>0x3&&_0x2b73ed&&Object['defineProperty'](_0x2c2879,_0x4df6a5,_0x2b73ed),_0x2b73ed;},__metadata=this&&this['__metadata']||function(_0x4c5889,_0x2ed16e){const _0xc8763=_0x49cb99;if(typeof Reflect===_0xc8763(0x205)&&typeof Reflect[_0xc8763(0x1f7)]===_0xc8763(0x1f6))return Reflect[_0xc8763(0x1f7)](_0x4c5889,_0x2ed16e);},__param=this&&this['__param']||function(_0x3a8afb,_0x4ad3dd){return function(_0xb3096f,_0x39d84b){_0x4ad3dd(_0xb3096f,_0x39d84b,_0x3a8afb);};};Object[_0x49cb99(0x1ec)](exports,_0x49cb99(0x1dd),{'value':!![]}),exports[_0x49cb99(0x227)]=void 0x0;const common_1=require(_0x49cb99(0x1d1)),typeorm_1=require(_0x49cb99(0x211)),chatLog_entity_1=require(_0x49cb99(0x213)),typeorm_2=require(_0x49cb99(0x1c2)),balance_constant_1=require(_0x49cb99(0x22a)),user_entity_1=require(_0x49cb99(0x200)),utils_1=require(_0x49cb99(0x1f8)),exceljs_1=require(_0x49cb99(0x218)),chatGroup_entity_1=require(_0x49cb99(0x1d0));function _0x3356(){const _0x3ea4b4=['ali','817434zXxkXb','chatList','saveChatLog','InjectRepository','你推荐的图片不存在、请检查！','?x-oss-process=image/resize,w_','10948zudrxJ','ChatGroupEntity','dall-e-3','__esModule','18IBWNwb','回答答案','map','Repository','update','isGroup','deleteChatLog','ChatLogEntity','getOwnPropertyDescriptor','DESC','columns','Workbook','DALL-E2','username','defineProperty','Content-Disposition','decorate','3269sNgNDi','findOne','PAINT_TYPE','type','fileInfo','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','affected','function','metadata','../../common/utils','extend','byAppId','用户名','find','545900lnkDFS','80LpNYiR','role','../user/user.entity','attachment;\x20filename=','super','chatLogEntity','querDrawLog','object','answer','userId','components','model','thumbImg','取消推荐','提问时间','用户邮箱','write','email','4308kbmqVo','@nestjs/typeorm','CHAT_TYPE','./chatLog.entity','HttpException','BAD_REQUEST','assistant','chat.xlsx','exceljs','@nine.com','findAndCount','tencent','Not','1715NBYrYl','你操作的图片不存在、请检查！','chatlog','paintCount','setHeader','5841847MoBlxw','__decorate','提问问题','user','userEntity','ChatLogService','Like','UserEntity','../../common/constants/balance.constant','你删除的对话记录不存在、请检查！','chatGroupEntity','Injectable','Content-Type','querAllDrawLog\x20Json\x20parse\x20error','删除对话记录成功！','DeductionKey','assign','message_id','137019zGZtfv','addWorksheet','typeorm','recDrawImg','3663360LTePiz','forEach','cos','count','HttpStatus','/q/55','includes','group','parse','prompt','maskEmail','?imageView2/1/w/','../chatGroup/chatGroup.entity','@nestjs/common','delByGroupId'];_0x3356=function(){return _0x3ea4b4;};return _0x3356();}let ChatLogService=class ChatLogService{constructor(_0x2edf32,_0x547a93,_0x122fd6){const _0x2c06f3=_0x49cb99;this[_0x2c06f3(0x203)]=_0x2edf32,this[_0x2c06f3(0x226)]=_0x547a93,this[_0x2c06f3(0x22c)]=_0x122fd6;}async[_0x49cb99(0x1d6)](_0x21e758){return await this['chatLogEntity']['save'](_0x21e758);}async[_0x49cb99(0x204)](_0x34086d,_0x3113f5){const _0x329560=_0x49cb99,{id:_0x454350}=_0x34086d[_0x329560(0x225)],{model:_0x2c8421}=_0x3113f5,_0x44543f={'userId':_0x454350,'type':balance_constant_1[_0x329560(0x231)][_0x329560(0x1f1)]};_0x2c8421&&(_0x44543f[_0x329560(0x209)]=_0x2c8421,_0x2c8421===_0x329560(0x1ea)&&(_0x44543f[_0x329560(0x209)]=(0x0,typeorm_2['In'])([_0x329560(0x1ea),_0x329560(0x1dc)])));const _0x4972d7=await this[_0x329560(0x203)][_0x329560(0x1fc)]({'where':_0x44543f,'order':{'id':_0x329560(0x1e7)},'select':['id',_0x329560(0x206),_0x329560(0x1cd),_0x329560(0x1bf),_0x329560(0x1cb),_0x329560(0x209),_0x329560(0x1f9),_0x329560(0x1f2),'fileInfo']});return _0x4972d7[_0x329560(0x1c5)](_0x62194=>{const _0x3835af=_0x329560;if(_0x62194[_0x3835af(0x1f2)]===_0x3835af(0x220)){const _0x500d65=_0x62194[_0x3835af(0x209)]==='mj'?0x136:0xa0,_0x38cf0c=_0x62194['answer']['includes'](_0x3835af(0x1c6))?_0x3835af(0x21b):_0x3835af(0x1d3),_0x43aa2b=_0x38cf0c===_0x3835af(0x21b)?_0x3835af(0x1cf)+_0x500d65+_0x3835af(0x1c9):'?x-oss-process=image/resize,w_'+_0x500d65;_0x62194[_0x3835af(0x20a)]=_0x62194[_0x3835af(0x206)]+_0x43aa2b;try{_0x62194[_0x3835af(0x1f3)]=_0x62194[_0x3835af(0x1f3)]?JSON[_0x3835af(0x1cc)](_0x62194[_0x3835af(0x1f3)]):null;}catch(_0x4232d9){_0x62194[_0x3835af(0x1f3)]={};}}}),_0x4972d7;}async['querAllDrawLog'](_0x4829f9){const _0x15187a=_0x49cb99,{page:page=0x1,size:size=0x14,rec:_0x22fb84,userId:_0x4ba72a,model:_0x270b77}=_0x4829f9,_0x54819d={'type':balance_constant_1[_0x15187a(0x231)][_0x15187a(0x1f1)],'prompt':(0x0,typeorm_2[_0x15187a(0x21c)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x22fb84&&Object[_0x15187a(0x1be)](_0x54819d,{'rec':_0x22fb84}),_0x4ba72a&&Object[_0x15187a(0x1be)](_0x54819d,{'userId':_0x4ba72a});_0x270b77&&(_0x54819d[_0x15187a(0x209)]=_0x270b77,_0x270b77===_0x15187a(0x1ea)&&(_0x54819d['model']=(0x0,typeorm_2['In'])([_0x15187a(0x1ea),'dall-e-3'])));const [_0x2091d4,_0x50bcfe]=await this[_0x15187a(0x203)][_0x15187a(0x21a)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x54819d});return _0x2091d4[_0x15187a(0x1c5)](_0x4f9706=>{const _0x13b96=_0x15187a;var _0x3ba31e;if(_0x4f9706[_0x13b96(0x1f2)]===_0x13b96(0x220)){const _0x9dc051=_0x4f9706[_0x13b96(0x209)]==='mj'?0x136:0xa0,_0x56caaf=_0x4f9706[_0x13b96(0x206)][_0x13b96(0x1ca)]('cos')?'tencent':_0x13b96(0x1d3),_0x52b608=_0x56caaf==='tencent'?'?imageView2/1/w/'+_0x9dc051+_0x13b96(0x1c9):_0x13b96(0x1d9)+_0x9dc051;_0x4f9706[_0x13b96(0x20a)]=_0x4f9706['answer']+_0x52b608;try{const _0x1d31ba=_0x4f9706[_0x13b96(0x1f9)]?JSON[_0x13b96(0x1cc)](_0x4f9706[_0x13b96(0x1f9)]):null;_0x1d31ba&&(_0x1d31ba?_0x4f9706[_0x13b96(0x1e3)]=((_0x3ba31e=_0x1d31ba===null||_0x1d31ba===void 0x0?void 0x0:_0x1d31ba[_0x13b96(0x208)][0x0])===null||_0x3ba31e===void 0x0?void 0x0:_0x3ba31e['components']['length'])===0x5:_0x4f9706[_0x13b96(0x1e3)]=![]);}catch(_0x17c2ca){console['log'](_0x13b96(0x22f),_0x17c2ca);}}}),{'rows':_0x2091d4,'count':_0x50bcfe};}async[_0x49cb99(0x1c3)](_0x2fe0e1){const _0x3c52b1=_0x49cb99,{id:_0x33d2d6}=_0x2fe0e1,_0x5a7260=await this[_0x3c52b1(0x203)]['findOne']({'where':{'id':_0x33d2d6,'type':balance_constant_1[_0x3c52b1(0x231)]['PAINT_TYPE']}});if(!_0x5a7260)throw new common_1[(_0x3c52b1(0x214))](_0x3c52b1(0x1d8),common_1[_0x3c52b1(0x1c8)][_0x3c52b1(0x215)]);const _0x5a0cc6=_0x5a7260['rec']===0x1?0x0:0x1,_0x4bab09=await this[_0x3c52b1(0x203)][_0x3c52b1(0x1e2)]({'id':_0x33d2d6},{'rec':_0x5a0cc6});if(_0x4bab09[_0x3c52b1(0x1f5)]>0x0)return(_0x5a0cc6?'推荐':_0x3c52b1(0x20b))+'图片成功！';throw new common_1['HttpException'](_0x3c52b1(0x21e),common_1[_0x3c52b1(0x1c8)]['BAD_REQUEST']);}async['exportExcel'](_0x8f8cbb,_0x4c16fe){const _0x14fc12=_0x49cb99,_0x3dbf63={'type':balance_constant_1['DeductionKey'][_0x14fc12(0x212)]},{page:page=0x1,size:size=0x1e,prompt:_0x3adb32,email:_0x49ae6c}=_0x8f8cbb;_0x3adb32&&Object['assign'](_0x3dbf63,{'prompt':(0x0,typeorm_2[_0x14fc12(0x228)])('%'+_0x3adb32+'%')});if(_0x49ae6c){const _0x491d9c=await this[_0x14fc12(0x226)][_0x14fc12(0x1f0)]({'where':{'email':_0x49ae6c}});(_0x491d9c===null||_0x491d9c===void 0x0?void 0x0:_0x491d9c['id'])&&Object[_0x14fc12(0x1be)](_0x3dbf63,{'userId':_0x491d9c['id']});}const [_0x6de2c3,_0x13e913]=await this[_0x14fc12(0x203)][_0x14fc12(0x21a)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x3dbf63}),_0x53b0b2=_0x6de2c3['map'](_0x2d0390=>_0x2d0390[_0x14fc12(0x207)]),_0x179407=await this['userEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x53b0b2)}}),_0x5e7cba=_0x6de2c3[_0x14fc12(0x1e0)](_0x9db8a7=>{const _0x370d51=_0x14fc12,_0x437f2a=_0x179407[_0x370d51(0x1fc)](_0x3d03df=>_0x3d03df['id']===_0x9db8a7[_0x370d51(0x207)]);return{'username':_0x437f2a?_0x437f2a[_0x370d51(0x1eb)]:'','email':_0x437f2a?_0x437f2a['email']:'','prompt':_0x9db8a7[_0x370d51(0x1cd)],'answer':_0x9db8a7[_0x370d51(0x206)],'createdAt':(0x0,utils_1['formatDate'])(_0x9db8a7['createdAt'])};}),_0x258454=new exceljs_1['default'][(_0x14fc12(0x1e9))](),_0x2cdf9a=_0x258454[_0x14fc12(0x1c1)](_0x14fc12(0x21f));_0x2cdf9a[_0x14fc12(0x1e8)]=[{'header':_0x14fc12(0x1fb),'key':_0x14fc12(0x1eb),'width':0x14},{'header':_0x14fc12(0x20d),'key':_0x14fc12(0x20f),'width':0x14},{'header':_0x14fc12(0x20c),'key':'createdAt','width':0x14},{'header':_0x14fc12(0x224),'key':_0x14fc12(0x1cd),'width':0x50},{'header':_0x14fc12(0x1df),'key':_0x14fc12(0x206),'width':0x96}],_0x5e7cba[_0x14fc12(0x1c5)](_0x16eaad=>_0x2cdf9a['addRow'](_0x16eaad)),_0x4c16fe[_0x14fc12(0x221)](_0x14fc12(0x22e),_0x14fc12(0x1f4)),_0x4c16fe[_0x14fc12(0x221)](_0x14fc12(0x1ed),_0x14fc12(0x201)+_0x14fc12(0x217)),await _0x258454['xlsx'][_0x14fc12(0x20e)](_0x4c16fe),_0x4c16fe['end']();}async['querAllChatLog'](_0x35e655,_0x4c7b8c){const _0x42b78a=_0x49cb99,{page:page=0x1,size:size=0x14,userId:_0x919567,prompt:_0x2012f0}=_0x35e655,_0xbbad9d={'type':balance_constant_1[_0x42b78a(0x231)][_0x42b78a(0x212)],'prompt':(0x0,typeorm_2['Not'])('')};_0x919567&&Object[_0x42b78a(0x1be)](_0xbbad9d,{'userId':_0x919567}),_0x2012f0&&Object['assign'](_0xbbad9d,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x2012f0+'%')});const [_0x14d99b,_0x184de7]=await this[_0x42b78a(0x203)][_0x42b78a(0x21a)]({'order':{'id':_0x42b78a(0x1e7)},'skip':(page-0x1)*size,'take':size,'where':_0xbbad9d}),_0x352c57=_0x14d99b[_0x42b78a(0x1e0)](_0xa17eb8=>_0xa17eb8[_0x42b78a(0x207)]),_0xfb3b99=await this['userEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x352c57)},'select':['id','username',_0x42b78a(0x20f)]});return _0x14d99b['forEach'](_0xfe543a=>{const _0x28e2a0=_0x42b78a,{username:_0x5d5e67,email:_0x3265e1}=_0xfb3b99[_0x28e2a0(0x1fc)](_0x515f02=>_0x515f02['id']===_0xfe543a[_0x28e2a0(0x207)])||{};_0xfe543a[_0x28e2a0(0x1eb)]=_0x5d5e67,_0xfe543a['email']=_0x3265e1;}),_0x4c7b8c[_0x42b78a(0x225)][_0x42b78a(0x1ff)]!==_0x42b78a(0x202)&&_0x14d99b['forEach'](_0x444c54=>_0x444c54[_0x42b78a(0x20f)]=(0x0,utils_1[_0x42b78a(0x1ce)])(_0x444c54[_0x42b78a(0x20f)])),_0x14d99b[_0x42b78a(0x1c5)](_0x39e60f=>{const _0x2e4e87=_0x42b78a;!_0x39e60f[_0x2e4e87(0x20f)]&&(_0x39e60f[_0x2e4e87(0x20f)]=(_0x39e60f===null||_0x39e60f===void 0x0?void 0x0:_0x39e60f[_0x2e4e87(0x207)])+_0x2e4e87(0x219)),!_0x39e60f[_0x2e4e87(0x1eb)]&&(_0x39e60f[_0x2e4e87(0x1eb)]='游客'+(_0x39e60f===null||_0x39e60f===void 0x0?void 0x0:_0x39e60f[_0x2e4e87(0x207)]));}),{'rows':_0x14d99b,'count':_0x184de7};}async[_0x49cb99(0x1d5)](_0x14a355,_0x55d537){const _0x526233=_0x49cb99,{id:_0x4ac6a1}=_0x14a355[_0x526233(0x225)],{groupId:_0x4305a3}=_0x55d537,_0x12efcc={'userId':_0x4ac6a1,'isDelete':![]};_0x4305a3&&Object[_0x526233(0x1be)](_0x12efcc,{'groupId':_0x4305a3});if(_0x4305a3){const _0x3805b1=await this[_0x526233(0x22c)][_0x526233(0x1c7)]({'where':{'isDelete':![]}});if(_0x3805b1===0x0)return[];}const _0x3d89b0=await this[_0x526233(0x203)][_0x526233(0x1fc)]({'where':_0x12efcc});return _0x3d89b0[_0x526233(0x1e0)](_0x5ce74a=>{const _0x138abd=_0x526233,{prompt:_0x232055,role:_0x3cff35,answer:_0x32a877,createdAt:_0x50e5fb,model:_0x1f8586,conversationOptions:_0x11040c,requestOptions:_0x18a367,id:_0x174758,imageUrl:_0x22b589}=_0x5ce74a;let _0x452822=null,_0x50baa5=null;try{_0x452822=JSON['parse'](_0x11040c),_0x50baa5=JSON[_0x138abd(0x1cc)](_0x18a367);}catch(_0x11efdb){}return{'chatId':_0x174758,'dateTime':(0x0,utils_1['formatDate'])(_0x50e5fb),'text':_0x3cff35===_0x138abd(0x225)?_0x232055:_0x32a877,'inversion':_0x3cff35===_0x138abd(0x225),'error':![],'conversationOptions':_0x452822,'requestOptions':_0x50baa5,'imageUrl':_0x22b589,'model':_0x1f8586};});}async[_0x49cb99(0x1e4)](_0x584d81,_0x45bafc){const _0x20545d=_0x49cb99,{id:_0x7f0f9e}=_0x584d81[_0x20545d(0x225)],{id:_0x5c69f8}=_0x45bafc,_0x349b4a=await this[_0x20545d(0x203)][_0x20545d(0x1f0)]({'where':{'id':_0x5c69f8,'userId':_0x7f0f9e}});if(!_0x349b4a)throw new common_1['HttpException'](_0x20545d(0x22b),common_1[_0x20545d(0x1c8)][_0x20545d(0x215)]);const _0x693fe4=await this[_0x20545d(0x203)]['update']({'id':_0x5c69f8},{'isDelete':!![]});if(_0x693fe4[_0x20545d(0x1f5)]>0x0)return'删除对话记录成功！';else throw new common_1[(_0x20545d(0x214))]('你删除的对话记录不存在、请检查！',common_1[_0x20545d(0x1c8)]['BAD_REQUEST']);}async[_0x49cb99(0x1d2)](_0x35e14b,_0x3efd93){const _0x52370d=_0x49cb99,{groupId:_0x1452da}=_0x3efd93,{id:_0x172e6e}=_0x35e14b[_0x52370d(0x225)],_0x15551e=await this[_0x52370d(0x22c)]['findOne']({'where':{'id':_0x1452da,'userId':_0x172e6e}});if(!_0x15551e)throw new common_1[(_0x52370d(0x214))](_0x52370d(0x22b),common_1['HttpStatus']['BAD_REQUEST']);const _0x32914d=await this[_0x52370d(0x203)][_0x52370d(0x1e2)]({'groupId':_0x1452da},{'isDelete':!![]});if(_0x32914d[_0x52370d(0x1f5)]>0x0)return _0x52370d(0x230);if(_0x32914d['affected']===0x0)throw new common_1[(_0x52370d(0x214))]('当前页面已经没有东西可以删除了！',common_1[_0x52370d(0x1c8)][_0x52370d(0x215)]);}async[_0x49cb99(0x1fa)](_0x18d2ec,_0xa789d3){const _0x14b2e6=_0x49cb99,{id:_0x1bb113}=_0x18d2ec[_0x14b2e6(0x225)],{appId:_0x525f65,page:page=0x1,size:size=0xa}=_0xa789d3,[_0x33e3da,_0x211c4c]=await this['chatLogEntity'][_0x14b2e6(0x21a)]({'where':{'userId':_0x1bb113,'appId':_0x525f65,'role':_0x14b2e6(0x216)},'order':{'id':_0x14b2e6(0x1e7)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x33e3da,'count':_0x211c4c};}};ChatLogService=__decorate([(0x0,common_1[_0x49cb99(0x22d)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x49cb99(0x1e5)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x49cb99(0x229)])),__param(0x2,(0x0,typeorm_1[_0x49cb99(0x1d7)])(chatGroup_entity_1[_0x49cb99(0x1db)])),__metadata('design:paramtypes',[typeorm_2[_0x49cb99(0x1e1)],typeorm_2[_0x49cb99(0x1e1)],typeorm_2[_0x49cb99(0x1e1)]])],ChatLogService),exports['ChatLogService']=ChatLogService;