'use strict';const _0x572a8c=_0x53bd;(function(_0x582cef,_0x4b2096){const _0x3fb080=_0x53bd,_0x59b1b6=_0x582cef();while(!![]){try{const _0x5677d1=parseInt(_0x3fb080(0x192))/0x1+-parseInt(_0x3fb080(0x1bc))/0x2+-parseInt(_0x3fb080(0x1a5))/0x3+parseInt(_0x3fb080(0x173))/0x4+parseInt(_0x3fb080(0x179))/0x5+parseInt(_0x3fb080(0x17b))/0x6*(-parseInt(_0x3fb080(0x1d0))/0x7)+parseInt(_0x3fb080(0x174))/0x8;if(_0x5677d1===_0x4b2096)break;else _0x59b1b6['push'](_0x59b1b6['shift']());}catch(_0x54fb8f){_0x59b1b6['push'](_0x59b1b6['shift']());}}}(_0x172c,0x53af2));function _0x172c(){const _0x41148c=['cos','__esModule','InjectRepository','xlsx','266xQEOHk','querAllDrawLog\x20Json\x20parse\x20error','Not','userEntity','setHeader','chatList','@nestjs/typeorm','affected','CHAT_TYPE','__metadata','user','paintCount','DESC','ali','addWorksheet','role','/q/55','isGroup','prompt','Content-Type','thumbImg','取消推荐','2097380qeCqSQ','1823736aWPXMQ','map','fileInfo','maskEmail','../chatGroup/chatGroup.entity','2744805JjfCQF','当前页面已经没有东西可以删除了！','29586EBJllz','formatDate','parse','super','?x-oss-process=image/resize,w_','find','count','../../common/utils','message_id','__decorate','PAINT_TYPE','assistant','group','columns','exportExcel','length','DALL-E2','./chatLog.entity','includes','attachment;\x20filename=','findOne','chatlog','metadata','438522SzTsCy','createdAt','assign','chat.xlsx','HttpStatus','answer','../../common/constants/balance.constant','ChatGroupEntity','update','type','extend','recDrawImg','function','findAndCount','forEach','object','tencent','Repository','BAD_REQUEST','1787763UQHmwR','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','dall-e-3','end','delByGroupId','提问时间','图片成功！','ChatLogEntity','回答答案','querDrawLog','Like','username','你删除的对话记录不存在、请检查！','design:paramtypes','提问问题','rec','addRow','?imageView2/1/w/','default','saveChatLog','用户名','删除对话记录成功！','userId','1227452CHnulT','Workbook','ChatLogService','querAllDrawLog','chatGroupEntity','log','email','components','model','chatLogEntity','@nine.com','DeductionKey','HttpException','save','@nestjs/common','defineProperty'];_0x172c=function(){return _0x41148c;};return _0x172c();}var __decorate=this&&this[_0x572a8c(0x184)]||function(_0x5cc0ad,_0x2b1305,_0x2a5b05,_0x25cc66){const _0x4b297a=_0x572a8c;var _0x73af58=arguments[_0x4b297a(0x18a)],_0x58a1a2=_0x73af58<0x3?_0x2b1305:_0x25cc66===null?_0x25cc66=Object['getOwnPropertyDescriptor'](_0x2b1305,_0x2a5b05):_0x25cc66,_0x3f858f;if(typeof Reflect===_0x4b297a(0x1a1)&&typeof Reflect['decorate']==='function')_0x58a1a2=Reflect['decorate'](_0x5cc0ad,_0x2b1305,_0x2a5b05,_0x25cc66);else{for(var _0x44ddf5=_0x5cc0ad['length']-0x1;_0x44ddf5>=0x0;_0x44ddf5--)if(_0x3f858f=_0x5cc0ad[_0x44ddf5])_0x58a1a2=(_0x73af58<0x3?_0x3f858f(_0x58a1a2):_0x73af58>0x3?_0x3f858f(_0x2b1305,_0x2a5b05,_0x58a1a2):_0x3f858f(_0x2b1305,_0x2a5b05))||_0x58a1a2;}return _0x73af58>0x3&&_0x58a1a2&&Object[_0x4b297a(0x1cb)](_0x2b1305,_0x2a5b05,_0x58a1a2),_0x58a1a2;},__metadata=this&&this[_0x572a8c(0x166)]||function(_0x3d30ef,_0x2915f2){const _0x5e2352=_0x572a8c;if(typeof Reflect===_0x5e2352(0x1a1)&&typeof Reflect[_0x5e2352(0x191)]===_0x5e2352(0x19e))return Reflect['metadata'](_0x3d30ef,_0x2915f2);},__param=this&&this['__param']||function(_0x1c7077,_0x5c03f3){return function(_0x5165f8,_0x1dd2b5){_0x5c03f3(_0x5165f8,_0x1dd2b5,_0x1c7077);};};Object['defineProperty'](exports,_0x572a8c(0x1cd),{'value':!![]}),exports[_0x572a8c(0x1be)]=void 0x0;function _0x53bd(_0x1a8936,_0x202f05){const _0x172c00=_0x172c();return _0x53bd=function(_0x53bdbd,_0x1d9e07){_0x53bdbd=_0x53bdbd-0x166;let _0x3677bf=_0x172c00[_0x53bdbd];return _0x3677bf;},_0x53bd(_0x1a8936,_0x202f05);}const common_1=require(_0x572a8c(0x1ca)),typeorm_1=require(_0x572a8c(0x1d6)),chatLog_entity_1=require(_0x572a8c(0x18c)),typeorm_2=require('typeorm'),balance_constant_1=require(_0x572a8c(0x198)),user_entity_1=require('../user/user.entity'),utils_1=require(_0x572a8c(0x182)),exceljs_1=require('exceljs'),chatGroup_entity_1=require(_0x572a8c(0x178));let ChatLogService=class ChatLogService{constructor(_0x458772,_0x33b78a,_0x5b2bbc){const _0x4422b4=_0x572a8c;this[_0x4422b4(0x1c5)]=_0x458772,this[_0x4422b4(0x1d3)]=_0x33b78a,this[_0x4422b4(0x1c0)]=_0x5b2bbc;}async[_0x572a8c(0x1b8)](_0x583968){const _0x1cfedd=_0x572a8c;return await this['chatLogEntity'][_0x1cfedd(0x1c9)](_0x583968);}async[_0x572a8c(0x1ae)](_0x20011f,_0x3f4654){const _0x526896=_0x572a8c,{id:_0x155a09}=_0x20011f[_0x526896(0x167)],{model:_0x5d3221}=_0x3f4654,_0x4f5d66={'userId':_0x155a09,'type':balance_constant_1[_0x526896(0x1c7)][_0x526896(0x185)]};_0x5d3221&&(_0x4f5d66[_0x526896(0x1c4)]=_0x5d3221,_0x5d3221===_0x526896(0x18b)&&(_0x4f5d66['model']=(0x0,typeorm_2['In'])([_0x526896(0x18b),_0x526896(0x1a7)])));const _0x4aee7c=await this[_0x526896(0x1c5)]['find']({'where':_0x4f5d66,'order':{'id':_0x526896(0x169)},'select':['id',_0x526896(0x197),'prompt',_0x526896(0x183),_0x526896(0x187),_0x526896(0x1c4),_0x526896(0x19c),_0x526896(0x19b),_0x526896(0x176)]});return _0x4aee7c['forEach'](_0x203fac=>{const _0x266afb=_0x526896;if(_0x203fac[_0x266afb(0x19b)]===_0x266afb(0x168)){const _0x23f5ca=_0x203fac[_0x266afb(0x1c4)]==='mj'?0x136:0xa0,_0xfe50d0=_0x203fac[_0x266afb(0x197)]['includes'](_0x266afb(0x1cc))?'tencent':_0x266afb(0x16a),_0x3b2ca3=_0xfe50d0==='tencent'?'?imageView2/1/w/'+_0x23f5ca+'/q/55':_0x266afb(0x17f)+_0x23f5ca;_0x203fac[_0x266afb(0x171)]=_0x203fac[_0x266afb(0x197)]+_0x3b2ca3;try{_0x203fac['fileInfo']=_0x203fac['fileInfo']?JSON['parse'](_0x203fac['fileInfo']):null;}catch(_0x176e61){_0x203fac[_0x266afb(0x176)]={};}}}),_0x4aee7c;}async[_0x572a8c(0x1bf)](_0x4dd140){const _0x1aa448=_0x572a8c,{page:page=0x1,size:size=0x14,rec:_0x5751b0,userId:_0xf78f29,model:_0x209f9a}=_0x4dd140,_0x62795b={'type':balance_constant_1[_0x1aa448(0x1c7)][_0x1aa448(0x185)],'prompt':(0x0,typeorm_2[_0x1aa448(0x1d2)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x5751b0&&Object[_0x1aa448(0x194)](_0x62795b,{'rec':_0x5751b0}),_0xf78f29&&Object[_0x1aa448(0x194)](_0x62795b,{'userId':_0xf78f29});_0x209f9a&&(_0x62795b[_0x1aa448(0x1c4)]=_0x209f9a,_0x209f9a===_0x1aa448(0x18b)&&(_0x62795b[_0x1aa448(0x1c4)]=(0x0,typeorm_2['In'])([_0x1aa448(0x18b),_0x1aa448(0x1a7)])));const [_0x3feaa4,_0x393749]=await this[_0x1aa448(0x1c5)][_0x1aa448(0x19f)]({'order':{'id':_0x1aa448(0x169)},'skip':(page-0x1)*size,'take':size,'where':_0x62795b});return _0x3feaa4[_0x1aa448(0x1a0)](_0x3171f3=>{const _0xc27e73=_0x1aa448;var _0x43caa3;if(_0x3171f3[_0xc27e73(0x19b)]==='paintCount'){const _0x3b1067=_0x3171f3[_0xc27e73(0x1c4)]==='mj'?0x136:0xa0,_0x245b18=_0x3171f3['answer'][_0xc27e73(0x18d)]('cos')?_0xc27e73(0x1a2):'ali',_0xb10774=_0x245b18===_0xc27e73(0x1a2)?_0xc27e73(0x1b6)+_0x3b1067+_0xc27e73(0x16d):_0xc27e73(0x17f)+_0x3b1067;_0x3171f3[_0xc27e73(0x171)]=_0x3171f3[_0xc27e73(0x197)]+_0xb10774;try{const _0x206f4f=_0x3171f3['extend']?JSON['parse'](_0x3171f3[_0xc27e73(0x19c)]):null;_0x206f4f&&(_0x206f4f?_0x3171f3['isGroup']=((_0x43caa3=_0x206f4f===null||_0x206f4f===void 0x0?void 0x0:_0x206f4f[_0xc27e73(0x1c3)][0x0])===null||_0x43caa3===void 0x0?void 0x0:_0x43caa3[_0xc27e73(0x1c3)][_0xc27e73(0x18a)])===0x5:_0x3171f3[_0xc27e73(0x16e)]=![]);}catch(_0x6623f){console[_0xc27e73(0x1c1)](_0xc27e73(0x1d1),_0x6623f);}}}),{'rows':_0x3feaa4,'count':_0x393749};}async[_0x572a8c(0x19d)](_0x36ec80){const _0x4856ab=_0x572a8c,{id:_0x3977be}=_0x36ec80,_0x2f0dbc=await this[_0x4856ab(0x1c5)][_0x4856ab(0x18f)]({'where':{'id':_0x3977be,'type':balance_constant_1['DeductionKey'][_0x4856ab(0x185)]}});if(!_0x2f0dbc)throw new common_1['HttpException']('你推荐的图片不存在、请检查！',common_1['HttpStatus'][_0x4856ab(0x1a4)]);const _0x2a064d=_0x2f0dbc[_0x4856ab(0x1b4)]===0x1?0x0:0x1,_0xae2f43=await this[_0x4856ab(0x1c5)][_0x4856ab(0x19a)]({'id':_0x3977be},{'rec':_0x2a064d});if(_0xae2f43[_0x4856ab(0x1d7)]>0x0)return(_0x2a064d?'推荐':_0x4856ab(0x172))+_0x4856ab(0x1ab);throw new common_1[(_0x4856ab(0x1c8))]('你操作的图片不存在、请检查！',common_1[_0x4856ab(0x196)][_0x4856ab(0x1a4)]);}async[_0x572a8c(0x189)](_0x43cb23,_0x193515){const _0x2f433b=_0x572a8c,_0x2dba4e={'type':balance_constant_1[_0x2f433b(0x1c7)][_0x2f433b(0x1d8)]},{page:page=0x1,size:size=0x1e,prompt:_0x2d792b,email:_0x2049d6}=_0x43cb23;_0x2d792b&&Object[_0x2f433b(0x194)](_0x2dba4e,{'prompt':(0x0,typeorm_2[_0x2f433b(0x1af)])('%'+_0x2d792b+'%')});if(_0x2049d6){const _0x38ed71=await this[_0x2f433b(0x1d3)][_0x2f433b(0x18f)]({'where':{'email':_0x2049d6}});(_0x38ed71===null||_0x38ed71===void 0x0?void 0x0:_0x38ed71['id'])&&Object[_0x2f433b(0x194)](_0x2dba4e,{'userId':_0x38ed71['id']});}const [_0x4b9418,_0x19c98f]=await this['chatLogEntity'][_0x2f433b(0x19f)]({'order':{'id':_0x2f433b(0x169)},'skip':(page-0x1)*size,'take':size,'where':_0x2dba4e}),_0x51a701=_0x4b9418['map'](_0x3e8b65=>_0x3e8b65[_0x2f433b(0x1bb)]),_0x3f681e=await this[_0x2f433b(0x1d3)][_0x2f433b(0x180)]({'where':{'id':(0x0,typeorm_2['In'])(_0x51a701)}}),_0x1c8ce0=_0x4b9418[_0x2f433b(0x175)](_0x22cacf=>{const _0x4cbdbf=_0x2f433b,_0x247e79=_0x3f681e[_0x4cbdbf(0x180)](_0x25e9ee=>_0x25e9ee['id']===_0x22cacf[_0x4cbdbf(0x1bb)]);return{'username':_0x247e79?_0x247e79[_0x4cbdbf(0x1b0)]:'','email':_0x247e79?_0x247e79['email']:'','prompt':_0x22cacf[_0x4cbdbf(0x16f)],'answer':_0x22cacf['answer'],'createdAt':(0x0,utils_1[_0x4cbdbf(0x17c)])(_0x22cacf[_0x4cbdbf(0x193)])};}),_0xba84ee=new exceljs_1[(_0x2f433b(0x1b7))][(_0x2f433b(0x1bd))](),_0x49f7b=_0xba84ee[_0x2f433b(0x16b)](_0x2f433b(0x190));_0x49f7b[_0x2f433b(0x188)]=[{'header':_0x2f433b(0x1b9),'key':_0x2f433b(0x1b0),'width':0x14},{'header':'用户邮箱','key':_0x2f433b(0x1c2),'width':0x14},{'header':_0x2f433b(0x1aa),'key':_0x2f433b(0x193),'width':0x14},{'header':_0x2f433b(0x1b3),'key':_0x2f433b(0x16f),'width':0x50},{'header':_0x2f433b(0x1ad),'key':'answer','width':0x96}],_0x1c8ce0[_0x2f433b(0x1a0)](_0x9cc42b=>_0x49f7b[_0x2f433b(0x1b5)](_0x9cc42b)),_0x193515[_0x2f433b(0x1d4)](_0x2f433b(0x170),_0x2f433b(0x1a6)),_0x193515['setHeader']('Content-Disposition',_0x2f433b(0x18e)+_0x2f433b(0x195)),await _0xba84ee[_0x2f433b(0x1cf)]['write'](_0x193515),_0x193515[_0x2f433b(0x1a8)]();}async['querAllChatLog'](_0x39f332,_0xac632b){const _0x240c1b=_0x572a8c,{page:page=0x1,size:size=0x14,userId:_0x4a6d43,prompt:_0x2bc344}=_0x39f332,_0x424da8={'type':balance_constant_1[_0x240c1b(0x1c7)]['CHAT_TYPE'],'prompt':(0x0,typeorm_2[_0x240c1b(0x1d2)])('')};_0x4a6d43&&Object[_0x240c1b(0x194)](_0x424da8,{'userId':_0x4a6d43}),_0x2bc344&&Object[_0x240c1b(0x194)](_0x424da8,{'prompt':(0x0,typeorm_2[_0x240c1b(0x1af)])('%'+_0x2bc344+'%')});const [_0x5a23b5,_0x539669]=await this['chatLogEntity'][_0x240c1b(0x19f)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x424da8}),_0x1e3676=_0x5a23b5[_0x240c1b(0x175)](_0x21eb96=>_0x21eb96[_0x240c1b(0x1bb)]),_0x5f0117=await this['userEntity'][_0x240c1b(0x180)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1e3676)},'select':['id',_0x240c1b(0x1b0),'email']});return _0x5a23b5[_0x240c1b(0x1a0)](_0x4c9723=>{const _0x5a6b3c=_0x240c1b,{username:_0x45a4bd,email:_0x2fe110}=_0x5f0117[_0x5a6b3c(0x180)](_0x526223=>_0x526223['id']===_0x4c9723['userId'])||{};_0x4c9723[_0x5a6b3c(0x1b0)]=_0x45a4bd,_0x4c9723[_0x5a6b3c(0x1c2)]=_0x2fe110;}),_0xac632b[_0x240c1b(0x167)][_0x240c1b(0x16c)]!==_0x240c1b(0x17e)&&_0x5a23b5[_0x240c1b(0x1a0)](_0x589eee=>_0x589eee[_0x240c1b(0x1c2)]=(0x0,utils_1[_0x240c1b(0x177)])(_0x589eee[_0x240c1b(0x1c2)])),_0x5a23b5['forEach'](_0x11adc3=>{const _0x54ba83=_0x240c1b;!_0x11adc3[_0x54ba83(0x1c2)]&&(_0x11adc3[_0x54ba83(0x1c2)]=(_0x11adc3===null||_0x11adc3===void 0x0?void 0x0:_0x11adc3[_0x54ba83(0x1bb)])+_0x54ba83(0x1c6)),!_0x11adc3['username']&&(_0x11adc3[_0x54ba83(0x1b0)]='游客'+(_0x11adc3===null||_0x11adc3===void 0x0?void 0x0:_0x11adc3['userId']));}),{'rows':_0x5a23b5,'count':_0x539669};}async[_0x572a8c(0x1d5)](_0x33aa6d,_0x11966c){const _0x2d2ac2=_0x572a8c,{id:_0x1f2d24}=_0x33aa6d[_0x2d2ac2(0x167)],{groupId:_0xfcc3f}=_0x11966c,_0x3dc09a={'userId':_0x1f2d24,'isDelete':![]};_0xfcc3f&&Object['assign'](_0x3dc09a,{'groupId':_0xfcc3f});if(_0xfcc3f){const _0x464e22=await this[_0x2d2ac2(0x1c0)][_0x2d2ac2(0x181)]({'where':{'isDelete':![]}});if(_0x464e22===0x0)return[];}const _0x3779a8=await this[_0x2d2ac2(0x1c5)]['find']({'where':_0x3dc09a});return _0x3779a8[_0x2d2ac2(0x175)](_0x187a7a=>{const _0x55daf4=_0x2d2ac2,{prompt:_0x5480d3,role:_0x2ce66b,answer:_0x51b364,createdAt:_0x818532,model:_0x4490dd,conversationOptions:_0x597fff,requestOptions:_0x594ea2,id:_0x3979d0,imageUrl:_0x31e0e0}=_0x187a7a;let _0x458f0f=null,_0x100b9c=null;try{_0x458f0f=JSON[_0x55daf4(0x17d)](_0x597fff),_0x100b9c=JSON[_0x55daf4(0x17d)](_0x594ea2);}catch(_0x15ba39){}return{'chatId':_0x3979d0,'dateTime':(0x0,utils_1['formatDate'])(_0x818532),'text':_0x2ce66b===_0x55daf4(0x167)?_0x5480d3:_0x51b364,'inversion':_0x2ce66b===_0x55daf4(0x167),'error':![],'conversationOptions':_0x458f0f,'requestOptions':_0x100b9c,'imageUrl':_0x31e0e0,'model':_0x4490dd};});}async['deleteChatLog'](_0x1f1b26,_0x2c4ff9){const _0x26f182=_0x572a8c,{id:_0x251110}=_0x1f1b26[_0x26f182(0x167)],{id:_0x27be19}=_0x2c4ff9,_0x263903=await this[_0x26f182(0x1c5)][_0x26f182(0x18f)]({'where':{'id':_0x27be19,'userId':_0x251110}});if(!_0x263903)throw new common_1[(_0x26f182(0x1c8))]('你删除的对话记录不存在、请检查！',common_1[_0x26f182(0x196)][_0x26f182(0x1a4)]);const _0x2e63b8=await this[_0x26f182(0x1c5)]['update']({'id':_0x27be19},{'isDelete':!![]});if(_0x2e63b8[_0x26f182(0x1d7)]>0x0)return'删除对话记录成功！';else throw new common_1[(_0x26f182(0x1c8))](_0x26f182(0x1b1),common_1[_0x26f182(0x196)][_0x26f182(0x1a4)]);}async[_0x572a8c(0x1a9)](_0x1001aa,_0x214fe5){const _0x250702=_0x572a8c,{groupId:_0x4e1704}=_0x214fe5,{id:_0x50b75d}=_0x1001aa['user'],_0x190928=await this['chatGroupEntity'][_0x250702(0x18f)]({'where':{'id':_0x4e1704,'userId':_0x50b75d}});if(!_0x190928)throw new common_1[(_0x250702(0x1c8))](_0x250702(0x1b1),common_1[_0x250702(0x196)]['BAD_REQUEST']);const _0x5b44bd=await this['chatLogEntity'][_0x250702(0x19a)]({'groupId':_0x4e1704},{'isDelete':!![]});if(_0x5b44bd[_0x250702(0x1d7)]>0x0)return _0x250702(0x1ba);if(_0x5b44bd[_0x250702(0x1d7)]===0x0)throw new common_1[(_0x250702(0x1c8))](_0x250702(0x17a),common_1[_0x250702(0x196)][_0x250702(0x1a4)]);}async['byAppId'](_0x5a3138,_0x388809){const _0x27a338=_0x572a8c,{id:_0x39d656}=_0x5a3138['user'],{appId:_0x3c099e,page:page=0x1,size:size=0xa}=_0x388809,[_0x346338,_0x9bfa8b]=await this['chatLogEntity'][_0x27a338(0x19f)]({'where':{'userId':_0x39d656,'appId':_0x3c099e,'role':_0x27a338(0x186)},'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size});return{'rows':_0x346338,'count':_0x9bfa8b};}};ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x572a8c(0x1ac)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1[_0x572a8c(0x1ce)])(chatGroup_entity_1[_0x572a8c(0x199)])),__metadata(_0x572a8c(0x1b2),[typeorm_2[_0x572a8c(0x1a3)],typeorm_2['Repository'],typeorm_2[_0x572a8c(0x1a3)]])],ChatLogService),exports[_0x572a8c(0x1be)]=ChatLogService;