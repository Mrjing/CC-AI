'use strict';const _0x2e5f2f=_0x1da6;(function(_0x29910e,_0x4e3c62){const _0x2cf3ff=_0x1da6,_0x255fe4=_0x29910e();while(!![]){try{const _0x51979c=parseInt(_0x2cf3ff(0xf7))/0x1*(parseInt(_0x2cf3ff(0xef))/0x2)+-parseInt(_0x2cf3ff(0xb3))/0x3+-parseInt(_0x2cf3ff(0xad))/0x4*(-parseInt(_0x2cf3ff(0x10c))/0x5)+-parseInt(_0x2cf3ff(0xc3))/0x6*(-parseInt(_0x2cf3ff(0xdc))/0x7)+parseInt(_0x2cf3ff(0xe2))/0x8+parseInt(_0x2cf3ff(0xe6))/0x9*(-parseInt(_0x2cf3ff(0xb0))/0xa)+-parseInt(_0x2cf3ff(0xbf))/0xb;if(_0x51979c===_0x4e3c62)break;else _0x255fe4['push'](_0x255fe4['shift']());}catch(_0x438904){_0x255fe4['push'](_0x255fe4['shift']());}}}(_0x9184,0x9b64a));var __decorate=this&&this['__decorate']||function(_0x3bfd16,_0x388786,_0x3f97dc,_0x35c49f){const _0x11cbcc=_0x1da6;var _0x54322f=arguments[_0x11cbcc(0xc2)],_0x2e50f9=_0x54322f<0x3?_0x388786:_0x35c49f===null?_0x35c49f=Object['getOwnPropertyDescriptor'](_0x388786,_0x3f97dc):_0x35c49f,_0x298672;if(typeof Reflect==='object'&&typeof Reflect[_0x11cbcc(0xe9)]===_0x11cbcc(0xc1))_0x2e50f9=Reflect['decorate'](_0x3bfd16,_0x388786,_0x3f97dc,_0x35c49f);else{for(var _0x18c7cb=_0x3bfd16[_0x11cbcc(0xc2)]-0x1;_0x18c7cb>=0x0;_0x18c7cb--)if(_0x298672=_0x3bfd16[_0x18c7cb])_0x2e50f9=(_0x54322f<0x3?_0x298672(_0x2e50f9):_0x54322f>0x3?_0x298672(_0x388786,_0x3f97dc,_0x2e50f9):_0x298672(_0x388786,_0x3f97dc))||_0x2e50f9;}return _0x54322f>0x3&&_0x2e50f9&&Object['defineProperty'](_0x388786,_0x3f97dc,_0x2e50f9),_0x2e50f9;},__metadata=this&&this[_0x2e5f2f(0xf4)]||function(_0x2249b1,_0x33e0e4){const _0x27f59c=_0x2e5f2f;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x27f59c(0xc1))return Reflect[_0x27f59c(0x9f)](_0x2249b1,_0x33e0e4);},__param=this&&this[_0x2e5f2f(0xb4)]||function(_0x5d559e,_0x4908a3){return function(_0xe0a443,_0x22a6ce){_0x4908a3(_0xe0a443,_0x22a6ce,_0x5d559e);};};Object[_0x2e5f2f(0x114)](exports,_0x2e5f2f(0xc8),{'value':!![]}),exports[_0x2e5f2f(0xa1)]=void 0x0;const common_1=require(_0x2e5f2f(0xf2)),typeorm_1=require(_0x2e5f2f(0xe8)),chatLog_entity_1=require(_0x2e5f2f(0xa4)),typeorm_2=require(_0x2e5f2f(0xde)),balance_constant_1=require(_0x2e5f2f(0xcc)),user_entity_1=require(_0x2e5f2f(0xce)),utils_1=require('../../common/utils'),exceljs_1=require(_0x2e5f2f(0x103)),chatGroup_entity_1=require(_0x2e5f2f(0xd1));function _0x9184(){const _0x4ed57e=['count','answer','defineProperty','UserEntity','?x-oss-process=image/resize,w_','columns','metadata','email','ChatLogService','DALL-E2','DeductionKey','./chatLog.entity','你删除的对话记录不存在、请检查！','ChatLogEntity','InjectRepository','parse','chat.xlsx','取消推荐','tencent','你操作的图片不存在、请检查！','24aQfGCf','default','assistant','10iieNXn','save','HttpException','467808ZwqyMt','__param','byAppId','write','/q/55','Content-Disposition','用户名','recDrawImg','ali','userEntity','@nine.com','type','22829576HvzHpA','maskEmail','function','length','695382QkXFGX','xlsx','isGroup','Like','删除对话记录成功！','__esModule','design:paramtypes','end','thumbImg','../../common/constants/balance.constant','chatlog','../user/user.entity','Injectable','affected','../chatGroup/chatGroup.entity','Content-Type','update','PAINT_TYPE','Repository','chatLogEntity','find','attachment;\x20filename=','includes','saveChatLog','username','49JcOcVR','提问时间','typeorm','当前页面已经没有东西可以删除了！','user','addRow','8025240HynwMj','log','dall-e-3','chatList','3862089eFxAbd','setHeader','@nestjs/typeorm','decorate','BAD_REQUEST','CHAT_TYPE','map','querDrawLog','findAndCount','2463962cSldIv','forEach','querAllDrawLog\x20Json\x20parse\x20error','@nestjs/common','Not','__metadata','paintCount','rec','1ahgyXI','HttpStatus','userId','components','extend','group','querAllDrawLog','cos','DESC','Workbook','assign','formatDate','exceljs','role','prompt','deleteChatLog','super','addWorksheet','fileInfo','model','findOne','208790mMhPqw','querAllChatLog','?imageView2/1/w/','图片成功！','你推荐的图片不存在、请检查！','chatGroupEntity'];_0x9184=function(){return _0x4ed57e;};return _0x9184();}let ChatLogService=class ChatLogService{constructor(_0x150278,_0x372ee5,_0x5a9ae6){const _0x3089e3=_0x2e5f2f;this['chatLogEntity']=_0x150278,this[_0x3089e3(0xbc)]=_0x372ee5,this[_0x3089e3(0x111)]=_0x5a9ae6;}async[_0x2e5f2f(0xda)](_0x5ac4f9){const _0x4ad2f9=_0x2e5f2f;return await this[_0x4ad2f9(0xd6)][_0x4ad2f9(0xb1)](_0x5ac4f9);}async[_0x2e5f2f(0xed)](_0x215cdb,_0x3f0ec7){const _0x382253=_0x2e5f2f,{id:_0x29bdc8}=_0x215cdb[_0x382253(0xe0)],{model:_0x392611}=_0x3f0ec7,_0x63c362={'userId':_0x29bdc8,'type':balance_constant_1[_0x382253(0xa3)][_0x382253(0xd4)]};_0x392611&&(_0x63c362[_0x382253(0x10a)]=_0x392611,_0x392611==='DALL-E2'&&(_0x63c362[_0x382253(0x10a)]=(0x0,typeorm_2['In'])([_0x382253(0xa2),_0x382253(0xe4)])));const _0x157036=await this[_0x382253(0xd6)][_0x382253(0xd7)]({'where':_0x63c362,'order':{'id':_0x382253(0xff)},'select':['id',_0x382253(0x113),_0x382253(0x105),'message_id',_0x382253(0xfc),'model','extend',_0x382253(0xbe),_0x382253(0x109)]});return _0x157036[_0x382253(0xf0)](_0x410068=>{const _0x167a7b=_0x382253;if(_0x410068[_0x167a7b(0xbe)]===_0x167a7b(0xf5)){const _0x5f2055=_0x410068['model']==='mj'?0x136:0xa0,_0xd50027=_0x410068[_0x167a7b(0x113)][_0x167a7b(0xd9)](_0x167a7b(0xfe))?_0x167a7b(0xab):'ali',_0x474132=_0xd50027===_0x167a7b(0xab)?_0x167a7b(0x10e)+_0x5f2055+_0x167a7b(0xb7):_0x167a7b(0x9d)+_0x5f2055;_0x410068[_0x167a7b(0xcb)]=_0x410068[_0x167a7b(0x113)]+_0x474132;try{_0x410068[_0x167a7b(0x109)]=_0x410068[_0x167a7b(0x109)]?JSON[_0x167a7b(0xa8)](_0x410068['fileInfo']):null;}catch(_0xdb4b1){_0x410068[_0x167a7b(0x109)]={};}}}),_0x157036;}async[_0x2e5f2f(0xfd)](_0x40e9f4){const _0x6fedf7=_0x2e5f2f,{page:page=0x1,size:size=0x14,rec:_0x4ba807,userId:_0x3de453,model:_0x4c12e6}=_0x40e9f4,_0x4f6ae0={'type':balance_constant_1[_0x6fedf7(0xa3)][_0x6fedf7(0xd4)],'prompt':(0x0,typeorm_2[_0x6fedf7(0xf3)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x4ba807&&Object[_0x6fedf7(0x101)](_0x4f6ae0,{'rec':_0x4ba807}),_0x3de453&&Object[_0x6fedf7(0x101)](_0x4f6ae0,{'userId':_0x3de453});_0x4c12e6&&(_0x4f6ae0['model']=_0x4c12e6,_0x4c12e6===_0x6fedf7(0xa2)&&(_0x4f6ae0[_0x6fedf7(0x10a)]=(0x0,typeorm_2['In'])(['DALL-E2',_0x6fedf7(0xe4)])));const [_0x5605bc,_0x32dadd]=await this[_0x6fedf7(0xd6)][_0x6fedf7(0xee)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x4f6ae0});return _0x5605bc[_0x6fedf7(0xf0)](_0x822854=>{const _0x570b61=_0x6fedf7;var _0x216a1b;if(_0x822854['type']===_0x570b61(0xf5)){const _0x260531=_0x822854['model']==='mj'?0x136:0xa0,_0x570229=_0x822854[_0x570b61(0x113)][_0x570b61(0xd9)](_0x570b61(0xfe))?_0x570b61(0xab):_0x570b61(0xbb),_0x1dcf9f=_0x570229===_0x570b61(0xab)?_0x570b61(0x10e)+_0x260531+_0x570b61(0xb7):_0x570b61(0x9d)+_0x260531;_0x822854[_0x570b61(0xcb)]=_0x822854[_0x570b61(0x113)]+_0x1dcf9f;try{const _0x298088=_0x822854[_0x570b61(0xfb)]?JSON[_0x570b61(0xa8)](_0x822854['extend']):null;_0x298088&&(_0x298088?_0x822854[_0x570b61(0xc5)]=((_0x216a1b=_0x298088===null||_0x298088===void 0x0?void 0x0:_0x298088[_0x570b61(0xfa)][0x0])===null||_0x216a1b===void 0x0?void 0x0:_0x216a1b[_0x570b61(0xfa)][_0x570b61(0xc2)])===0x5:_0x822854[_0x570b61(0xc5)]=![]);}catch(_0x1f4612){console[_0x570b61(0xe3)](_0x570b61(0xf1),_0x1f4612);}}}),{'rows':_0x5605bc,'count':_0x32dadd};}async[_0x2e5f2f(0xba)](_0x4d8ead){const _0x110522=_0x2e5f2f,{id:_0xebb5d9}=_0x4d8ead,_0x8d786c=await this['chatLogEntity'][_0x110522(0x10b)]({'where':{'id':_0xebb5d9,'type':balance_constant_1[_0x110522(0xa3)][_0x110522(0xd4)]}});if(!_0x8d786c)throw new common_1[(_0x110522(0xb2))](_0x110522(0x110),common_1[_0x110522(0xf8)][_0x110522(0xea)]);const _0x9b97d7=_0x8d786c[_0x110522(0xf6)]===0x1?0x0:0x1,_0x5f3eee=await this[_0x110522(0xd6)][_0x110522(0xd3)]({'id':_0xebb5d9},{'rec':_0x9b97d7});if(_0x5f3eee['affected']>0x0)return(_0x9b97d7?'推荐':_0x110522(0xaa))+_0x110522(0x10f);throw new common_1[(_0x110522(0xb2))](_0x110522(0xac),common_1[_0x110522(0xf8)][_0x110522(0xea)]);}async['exportExcel'](_0x12b652,_0x2d9850){const _0x3ba55d=_0x2e5f2f,_0x108487={'type':balance_constant_1[_0x3ba55d(0xa3)][_0x3ba55d(0xeb)]},{page:page=0x1,size:size=0x1e,prompt:_0x143a1c,email:_0x406ae7}=_0x12b652;_0x143a1c&&Object[_0x3ba55d(0x101)](_0x108487,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x143a1c+'%')});if(_0x406ae7){const _0x501ca9=await this[_0x3ba55d(0xbc)]['findOne']({'where':{'email':_0x406ae7}});(_0x501ca9===null||_0x501ca9===void 0x0?void 0x0:_0x501ca9['id'])&&Object[_0x3ba55d(0x101)](_0x108487,{'userId':_0x501ca9['id']});}const [_0x166144,_0x5b69d0]=await this[_0x3ba55d(0xd6)][_0x3ba55d(0xee)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x108487}),_0x2533f0=_0x166144[_0x3ba55d(0xec)](_0x171cee=>_0x171cee[_0x3ba55d(0xf9)]),_0x44dd90=await this[_0x3ba55d(0xbc)][_0x3ba55d(0xd7)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2533f0)}}),_0x29e2a5=_0x166144[_0x3ba55d(0xec)](_0x488589=>{const _0x391a58=_0x3ba55d,_0x4a0b76=_0x44dd90['find'](_0x49312f=>_0x49312f['id']===_0x488589[_0x391a58(0xf9)]);return{'username':_0x4a0b76?_0x4a0b76[_0x391a58(0xdb)]:'','email':_0x4a0b76?_0x4a0b76[_0x391a58(0xa0)]:'','prompt':_0x488589[_0x391a58(0x105)],'answer':_0x488589[_0x391a58(0x113)],'createdAt':(0x0,utils_1[_0x391a58(0x102)])(_0x488589['createdAt'])};}),_0x4450fb=new exceljs_1[(_0x3ba55d(0xae))][(_0x3ba55d(0x100))](),_0x993955=_0x4450fb[_0x3ba55d(0x108)](_0x3ba55d(0xcd));_0x993955[_0x3ba55d(0x9e)]=[{'header':_0x3ba55d(0xb9),'key':_0x3ba55d(0xdb),'width':0x14},{'header':'用户邮箱','key':_0x3ba55d(0xa0),'width':0x14},{'header':_0x3ba55d(0xdd),'key':'createdAt','width':0x14},{'header':'提问问题','key':_0x3ba55d(0x105),'width':0x50},{'header':'回答答案','key':_0x3ba55d(0x113),'width':0x96}],_0x29e2a5['forEach'](_0x3cea10=>_0x993955[_0x3ba55d(0xe1)](_0x3cea10)),_0x2d9850[_0x3ba55d(0xe7)](_0x3ba55d(0xd2),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x2d9850[_0x3ba55d(0xe7)](_0x3ba55d(0xb8),_0x3ba55d(0xd8)+_0x3ba55d(0xa9)),await _0x4450fb[_0x3ba55d(0xc4)][_0x3ba55d(0xb6)](_0x2d9850),_0x2d9850[_0x3ba55d(0xca)]();}async[_0x2e5f2f(0x10d)](_0x555ffe,_0x3799f5){const _0x3664e3=_0x2e5f2f,{page:page=0x1,size:size=0x14,userId:_0x3630a6,prompt:_0x25d04d}=_0x555ffe,_0x4cd996={'type':balance_constant_1[_0x3664e3(0xa3)][_0x3664e3(0xeb)],'prompt':(0x0,typeorm_2[_0x3664e3(0xf3)])('')};_0x3630a6&&Object['assign'](_0x4cd996,{'userId':_0x3630a6}),_0x25d04d&&Object[_0x3664e3(0x101)](_0x4cd996,{'prompt':(0x0,typeorm_2[_0x3664e3(0xc6)])('%'+_0x25d04d+'%')});const [_0x36c993,_0x70fb]=await this[_0x3664e3(0xd6)]['findAndCount']({'order':{'id':_0x3664e3(0xff)},'skip':(page-0x1)*size,'take':size,'where':_0x4cd996}),_0x19f316=_0x36c993[_0x3664e3(0xec)](_0x571edb=>_0x571edb[_0x3664e3(0xf9)]),_0x1863ee=await this[_0x3664e3(0xbc)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x19f316)},'select':['id',_0x3664e3(0xdb),_0x3664e3(0xa0)]});return _0x36c993[_0x3664e3(0xf0)](_0x21aade=>{const _0x10306=_0x3664e3,{username:_0x1eca81,email:_0x270510}=_0x1863ee[_0x10306(0xd7)](_0x3a8d47=>_0x3a8d47['id']===_0x21aade['userId'])||{};_0x21aade[_0x10306(0xdb)]=_0x1eca81,_0x21aade[_0x10306(0xa0)]=_0x270510;}),_0x3799f5[_0x3664e3(0xe0)][_0x3664e3(0x104)]!==_0x3664e3(0x107)&&_0x36c993[_0x3664e3(0xf0)](_0x4ac3e5=>_0x4ac3e5[_0x3664e3(0xa0)]=(0x0,utils_1[_0x3664e3(0xc0)])(_0x4ac3e5[_0x3664e3(0xa0)])),_0x36c993[_0x3664e3(0xf0)](_0x55b0ad=>{const _0x2aa177=_0x3664e3;!_0x55b0ad[_0x2aa177(0xa0)]&&(_0x55b0ad[_0x2aa177(0xa0)]=(_0x55b0ad===null||_0x55b0ad===void 0x0?void 0x0:_0x55b0ad[_0x2aa177(0xf9)])+_0x2aa177(0xbd)),!_0x55b0ad['username']&&(_0x55b0ad[_0x2aa177(0xdb)]='游客'+(_0x55b0ad===null||_0x55b0ad===void 0x0?void 0x0:_0x55b0ad['userId']));}),{'rows':_0x36c993,'count':_0x70fb};}async[_0x2e5f2f(0xe5)](_0x2ecc89,_0xeb4256){const _0x51c396=_0x2e5f2f,{id:_0x1da988}=_0x2ecc89[_0x51c396(0xe0)],{groupId:_0x2ced3c}=_0xeb4256,_0x49f6b3={'userId':_0x1da988,'isDelete':![]};_0x2ced3c&&Object[_0x51c396(0x101)](_0x49f6b3,{'groupId':_0x2ced3c});if(_0x2ced3c){const _0x2ca824=await this['chatGroupEntity'][_0x51c396(0x112)]({'where':{'isDelete':![]}});if(_0x2ca824===0x0)return[];}const _0x5430f4=await this['chatLogEntity'][_0x51c396(0xd7)]({'where':_0x49f6b3});return _0x5430f4[_0x51c396(0xec)](_0x296250=>{const _0x5591fe=_0x51c396,{prompt:_0x1f84ba,role:_0x140f19,answer:_0x489f87,createdAt:_0x25c929,model:_0x493ffe,conversationOptions:_0x561093,requestOptions:_0x47cbd2,id:_0x57aee2,imageUrl:_0x40c460}=_0x296250;let _0x49b583=null,_0x319e43=null;try{_0x49b583=JSON[_0x5591fe(0xa8)](_0x561093),_0x319e43=JSON['parse'](_0x47cbd2);}catch(_0x12c8dd){}return{'chatId':_0x57aee2,'dateTime':(0x0,utils_1[_0x5591fe(0x102)])(_0x25c929),'text':_0x140f19===_0x5591fe(0xe0)?_0x1f84ba:_0x489f87,'inversion':_0x140f19==='user','error':![],'conversationOptions':_0x49b583,'requestOptions':_0x319e43,'imageUrl':_0x40c460,'model':_0x493ffe};});}async[_0x2e5f2f(0x106)](_0x225f10,_0x267152){const _0x362652=_0x2e5f2f,{id:_0x31b2ac}=_0x225f10[_0x362652(0xe0)],{id:_0x15c7f8}=_0x267152,_0x307d06=await this[_0x362652(0xd6)][_0x362652(0x10b)]({'where':{'id':_0x15c7f8,'userId':_0x31b2ac}});if(!_0x307d06)throw new common_1['HttpException'](_0x362652(0xa5),common_1[_0x362652(0xf8)][_0x362652(0xea)]);const _0x3fc076=await this[_0x362652(0xd6)][_0x362652(0xd3)]({'id':_0x15c7f8},{'isDelete':!![]});if(_0x3fc076[_0x362652(0xd0)]>0x0)return _0x362652(0xc7);else throw new common_1['HttpException'](_0x362652(0xa5),common_1[_0x362652(0xf8)][_0x362652(0xea)]);}async['delByGroupId'](_0x2543fd,_0x4e9d81){const _0x35e59f=_0x2e5f2f,{groupId:_0x138ce8}=_0x4e9d81,{id:_0x367ac7}=_0x2543fd[_0x35e59f(0xe0)],_0x53281b=await this[_0x35e59f(0x111)][_0x35e59f(0x10b)]({'where':{'id':_0x138ce8,'userId':_0x367ac7}});if(!_0x53281b)throw new common_1['HttpException'](_0x35e59f(0xa5),common_1[_0x35e59f(0xf8)][_0x35e59f(0xea)]);const _0x19d040=await this[_0x35e59f(0xd6)][_0x35e59f(0xd3)]({'groupId':_0x138ce8},{'isDelete':!![]});if(_0x19d040['affected']>0x0)return _0x35e59f(0xc7);if(_0x19d040[_0x35e59f(0xd0)]===0x0)throw new common_1[(_0x35e59f(0xb2))](_0x35e59f(0xdf),common_1[_0x35e59f(0xf8)]['BAD_REQUEST']);}async[_0x2e5f2f(0xb5)](_0x5315ce,_0x2f9a83){const _0x391301=_0x2e5f2f,{id:_0x478a17}=_0x5315ce[_0x391301(0xe0)],{appId:_0x3733e1,page:page=0x1,size:size=0xa}=_0x2f9a83,[_0x2a65a3,_0x10f4bd]=await this['chatLogEntity'][_0x391301(0xee)]({'where':{'userId':_0x478a17,'appId':_0x3733e1,'role':_0x391301(0xaf)},'order':{'id':_0x391301(0xff)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x2a65a3,'count':_0x10f4bd};}};function _0x1da6(_0x493a1e,_0x2361f7){const _0x9184a1=_0x9184();return _0x1da6=function(_0x1da6c5,_0x4e1b9c){_0x1da6c5=_0x1da6c5-0x9c;let _0x6e3756=_0x9184a1[_0x1da6c5];return _0x6e3756;},_0x1da6(_0x493a1e,_0x2361f7);}ChatLogService=__decorate([(0x0,common_1[_0x2e5f2f(0xcf)])(),__param(0x0,(0x0,typeorm_1[_0x2e5f2f(0xa7)])(chatLog_entity_1[_0x2e5f2f(0xa6)])),__param(0x1,(0x0,typeorm_1[_0x2e5f2f(0xa7)])(user_entity_1[_0x2e5f2f(0x9c)])),__param(0x2,(0x0,typeorm_1[_0x2e5f2f(0xa7)])(chatGroup_entity_1['ChatGroupEntity'])),__metadata(_0x2e5f2f(0xc9),[typeorm_2[_0x2e5f2f(0xd5)],typeorm_2[_0x2e5f2f(0xd5)],typeorm_2[_0x2e5f2f(0xd5)]])],ChatLogService),exports[_0x2e5f2f(0xa1)]=ChatLogService;