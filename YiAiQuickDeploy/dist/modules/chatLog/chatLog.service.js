'use strict';function _0x153c(_0x5423e7,_0x301a07){const _0x21a443=_0x21a4();return _0x153c=function(_0x153c5d,_0x305cd2){_0x153c5d=_0x153c5d-0x180;let _0x2b4c52=_0x21a443[_0x153c5d];return _0x2b4c52;},_0x153c(_0x5423e7,_0x301a07);}const _0x51d3e2=_0x153c;(function(_0x2113be,_0x204cca){const _0x2a4c64=_0x153c,_0xb8a80b=_0x2113be();while(!![]){try{const _0x54fa06=-parseInt(_0x2a4c64(0x1d3))/0x1*(-parseInt(_0x2a4c64(0x19c))/0x2)+-parseInt(_0x2a4c64(0x1b0))/0x3*(parseInt(_0x2a4c64(0x1e6))/0x4)+-parseInt(_0x2a4c64(0x182))/0x5+parseInt(_0x2a4c64(0x1a7))/0x6*(-parseInt(_0x2a4c64(0x1b7))/0x7)+-parseInt(_0x2a4c64(0x1d9))/0x8*(-parseInt(_0x2a4c64(0x1c0))/0x9)+parseInt(_0x2a4c64(0x19d))/0xa+parseInt(_0x2a4c64(0x1e7))/0xb;if(_0x54fa06===_0x204cca)break;else _0xb8a80b['push'](_0xb8a80b['shift']());}catch(_0x2828bd){_0xb8a80b['push'](_0xb8a80b['shift']());}}}(_0x21a4,0xce789));var __decorate=this&&this[_0x51d3e2(0x1d7)]||function(_0x123b88,_0x46f9af,_0x1bc211,_0x2923bc){const _0xefeb3a=_0x51d3e2;var _0x492572=arguments[_0xefeb3a(0x1c5)],_0x3282cc=_0x492572<0x3?_0x46f9af:_0x2923bc===null?_0x2923bc=Object[_0xefeb3a(0x1ca)](_0x46f9af,_0x1bc211):_0x2923bc,_0x5c0fc8;if(typeof Reflect===_0xefeb3a(0x1c6)&&typeof Reflect[_0xefeb3a(0x18b)]===_0xefeb3a(0x1e9))_0x3282cc=Reflect[_0xefeb3a(0x18b)](_0x123b88,_0x46f9af,_0x1bc211,_0x2923bc);else{for(var _0x5ca9aa=_0x123b88['length']-0x1;_0x5ca9aa>=0x0;_0x5ca9aa--)if(_0x5c0fc8=_0x123b88[_0x5ca9aa])_0x3282cc=(_0x492572<0x3?_0x5c0fc8(_0x3282cc):_0x492572>0x3?_0x5c0fc8(_0x46f9af,_0x1bc211,_0x3282cc):_0x5c0fc8(_0x46f9af,_0x1bc211))||_0x3282cc;}return _0x492572>0x3&&_0x3282cc&&Object['defineProperty'](_0x46f9af,_0x1bc211,_0x3282cc),_0x3282cc;},__metadata=this&&this['__metadata']||function(_0x58eed6,_0x32ac56){const _0x247d82=_0x51d3e2;if(typeof Reflect===_0x247d82(0x1c6)&&typeof Reflect[_0x247d82(0x1be)]===_0x247d82(0x1e9))return Reflect[_0x247d82(0x1be)](_0x58eed6,_0x32ac56);},__param=this&&this['__param']||function(_0x2970dc,_0x352064){return function(_0x33e4b2,_0x3a7393){_0x352064(_0x33e4b2,_0x3a7393,_0x2970dc);};};Object[_0x51d3e2(0x1bc)](exports,'__esModule',{'value':!![]}),exports[_0x51d3e2(0x1f3)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x51d3e2(0x1f1)),chatLog_entity_1=require(_0x51d3e2(0x1e8)),typeorm_2=require(_0x51d3e2(0x1ed)),balance_constant_1=require(_0x51d3e2(0x18e)),user_entity_1=require(_0x51d3e2(0x1eb)),utils_1=require(_0x51d3e2(0x19f)),exceljs_1=require(_0x51d3e2(0x1ee)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity');let ChatLogService=class ChatLogService{constructor(_0x29bd13,_0x15efc8,_0x4d1007){const _0x4a4001=_0x51d3e2;this[_0x4a4001(0x1a8)]=_0x29bd13,this['userEntity']=_0x15efc8,this[_0x4a4001(0x1c7)]=_0x4d1007;}async[_0x51d3e2(0x1e0)](_0xc6527e){const _0x1d7ede=_0x51d3e2;return await this[_0x1d7ede(0x1a8)]['save'](_0xc6527e);}async[_0x51d3e2(0x18d)](_0x45683f,_0xfb962f){const _0x2b32d5=_0x51d3e2,{id:_0x4aa18a}=_0x45683f[_0x2b32d5(0x1a6)],{model:_0xd5f835}=_0xfb962f,_0x2c0d7a={'userId':_0x4aa18a,'type':balance_constant_1[_0x2b32d5(0x195)][_0x2b32d5(0x1cf)]};_0xd5f835&&(_0x2c0d7a[_0x2b32d5(0x1ba)]=_0xd5f835,_0xd5f835===_0x2b32d5(0x1c2)&&(_0x2c0d7a[_0x2b32d5(0x1ba)]=(0x0,typeorm_2['In'])(['DALL-E2',_0x2b32d5(0x1c3)])));const _0x560759=await this['chatLogEntity'][_0x2b32d5(0x1db)]({'where':_0x2c0d7a,'order':{'id':_0x2b32d5(0x1f2)},'select':['id',_0x2b32d5(0x1ab),_0x2b32d5(0x1ad),_0x2b32d5(0x18a),_0x2b32d5(0x1f4),_0x2b32d5(0x1ba),_0x2b32d5(0x1b1),_0x2b32d5(0x191),_0x2b32d5(0x1d6)]});return _0x560759[_0x2b32d5(0x1d4)](_0x187774=>{const _0x19c67=_0x2b32d5;if(_0x187774['type']===_0x19c67(0x1b9)){const _0x145a28=_0x187774[_0x19c67(0x1ba)]==='mj'?0x136:0xa0,_0x23d898=_0x187774[_0x19c67(0x1ab)]['includes'](_0x19c67(0x1dd))?_0x19c67(0x1bf):'ali',_0x3a790b=_0x23d898===_0x19c67(0x1bf)?_0x19c67(0x1a1)+_0x145a28+'/q/55':_0x19c67(0x18c)+_0x145a28;_0x187774['thumbImg']=_0x187774[_0x19c67(0x1ab)]+_0x3a790b;try{_0x187774[_0x19c67(0x1d6)]=_0x187774['fileInfo']?JSON[_0x19c67(0x1c1)](_0x187774['fileInfo']):null;}catch(_0x3217b0){_0x187774[_0x19c67(0x1d6)]={};}}}),_0x560759;}async[_0x51d3e2(0x1b3)](_0x48c6bf){const _0x5e4c6d=_0x51d3e2,{page:page=0x1,size:size=0x14,rec:_0x48eccc,userId:_0x191a0e,model:_0x3264c9}=_0x48c6bf,_0x3ce711={'type':balance_constant_1[_0x5e4c6d(0x195)][_0x5e4c6d(0x1cf)],'prompt':(0x0,typeorm_2[_0x5e4c6d(0x1c9)])(''),'answer':(0x0,typeorm_2[_0x5e4c6d(0x1c9)])('')};_0x48eccc&&Object['assign'](_0x3ce711,{'rec':_0x48eccc}),_0x191a0e&&Object[_0x5e4c6d(0x1df)](_0x3ce711,{'userId':_0x191a0e});_0x3264c9&&(_0x3ce711[_0x5e4c6d(0x1ba)]=_0x3264c9,_0x3264c9===_0x5e4c6d(0x1c2)&&(_0x3ce711[_0x5e4c6d(0x1ba)]=(0x0,typeorm_2['In'])(['DALL-E2',_0x5e4c6d(0x1c3)])));const [_0x3f9411,_0x8da448]=await this[_0x5e4c6d(0x1a8)][_0x5e4c6d(0x1ea)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x3ce711});return _0x3f9411[_0x5e4c6d(0x1d4)](_0x106aa6=>{const _0x1fe416=_0x5e4c6d;var _0x466458;if(_0x106aa6[_0x1fe416(0x191)]===_0x1fe416(0x1b9)){const _0x42ad07=_0x106aa6[_0x1fe416(0x1ba)]==='mj'?0x136:0xa0,_0x250f0e=_0x106aa6[_0x1fe416(0x1ab)][_0x1fe416(0x1da)](_0x1fe416(0x1dd))?_0x1fe416(0x1bf):_0x1fe416(0x1cd),_0xa949b6=_0x250f0e===_0x1fe416(0x1bf)?_0x1fe416(0x1a1)+_0x42ad07+_0x1fe416(0x1e5):_0x1fe416(0x18c)+_0x42ad07;_0x106aa6[_0x1fe416(0x184)]=_0x106aa6[_0x1fe416(0x1ab)]+_0xa949b6;try{const _0x8aede0=_0x106aa6['extend']?JSON[_0x1fe416(0x1c1)](_0x106aa6[_0x1fe416(0x1b1)]):null;_0x8aede0&&(_0x8aede0?_0x106aa6[_0x1fe416(0x193)]=((_0x466458=_0x8aede0===null||_0x8aede0===void 0x0?void 0x0:_0x8aede0[_0x1fe416(0x19a)][0x0])===null||_0x466458===void 0x0?void 0x0:_0x466458[_0x1fe416(0x19a)]['length'])===0x5:_0x106aa6[_0x1fe416(0x193)]=![]);}catch(_0x185020){console[_0x1fe416(0x1d0)]('querAllDrawLog\x20Json\x20parse\x20error',_0x185020);}}}),{'rows':_0x3f9411,'count':_0x8da448};}async['recDrawImg'](_0x4a81d0){const _0x4f50d2=_0x51d3e2,{id:_0x52b765}=_0x4a81d0,_0x568ae8=await this[_0x4f50d2(0x1a8)][_0x4f50d2(0x1a3)]({'where':{'id':_0x52b765,'type':balance_constant_1['DeductionKey'][_0x4f50d2(0x1cf)]}});if(!_0x568ae8)throw new common_1[(_0x4f50d2(0x1a4))](_0x4f50d2(0x1af),common_1['HttpStatus'][_0x4f50d2(0x1e4)]);const _0x16838d=_0x568ae8['rec']===0x1?0x0:0x1,_0xc44333=await this[_0x4f50d2(0x1a8)]['update']({'id':_0x52b765},{'rec':_0x16838d});if(_0xc44333[_0x4f50d2(0x1a9)]>0x0)return(_0x16838d?'推荐':_0x4f50d2(0x1bb))+_0x4f50d2(0x1dc);throw new common_1[(_0x4f50d2(0x1a4))](_0x4f50d2(0x1de),common_1[_0x4f50d2(0x1a2)][_0x4f50d2(0x1e4)]);}async[_0x51d3e2(0x1ac)](_0x3106f7,_0x498cf8){const _0x34c92c=_0x51d3e2,_0x19111c={'type':balance_constant_1[_0x34c92c(0x195)]['CHAT_TYPE']},{page:page=0x1,size:size=0x1e,prompt:_0x49790a,email:_0x364bb2}=_0x3106f7;_0x49790a&&Object[_0x34c92c(0x1df)](_0x19111c,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x49790a+'%')});if(_0x364bb2){const _0x450896=await this[_0x34c92c(0x1c4)]['findOne']({'where':{'email':_0x364bb2}});(_0x450896===null||_0x450896===void 0x0?void 0x0:_0x450896['id'])&&Object['assign'](_0x19111c,{'userId':_0x450896['id']});}const [_0x3d1602,_0x8bba7c]=await this[_0x34c92c(0x1a8)][_0x34c92c(0x1ea)]({'order':{'id':_0x34c92c(0x1f2)},'skip':(page-0x1)*size,'take':size,'where':_0x19111c}),_0x2c6459=_0x3d1602[_0x34c92c(0x1b6)](_0x766210=>_0x766210[_0x34c92c(0x181)]),_0x5646cf=await this[_0x34c92c(0x1c4)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x2c6459)}}),_0x2f1366=_0x3d1602[_0x34c92c(0x1b6)](_0x45e88d=>{const _0x401d63=_0x34c92c,_0x5e7ef7=_0x5646cf['find'](_0x15244a=>_0x15244a['id']===_0x45e88d[_0x401d63(0x181)]);return{'username':_0x5e7ef7?_0x5e7ef7[_0x401d63(0x180)]:'','email':_0x5e7ef7?_0x5e7ef7[_0x401d63(0x1cc)]:'','prompt':_0x45e88d[_0x401d63(0x1ad)],'answer':_0x45e88d[_0x401d63(0x1ab)],'createdAt':(0x0,utils_1[_0x401d63(0x197)])(_0x45e88d[_0x401d63(0x19e)])};}),_0x360534=new exceljs_1[(_0x34c92c(0x187))][(_0x34c92c(0x189))](),_0x3eb1d3=_0x360534[_0x34c92c(0x1ec)](_0x34c92c(0x198));_0x3eb1d3[_0x34c92c(0x1f0)]=[{'header':'用户名','key':'username','width':0x14},{'header':_0x34c92c(0x186),'key':_0x34c92c(0x1cc),'width':0x14},{'header':'提问时间','key':_0x34c92c(0x19e),'width':0x14},{'header':_0x34c92c(0x1d1),'key':'prompt','width':0x50},{'header':_0x34c92c(0x183),'key':_0x34c92c(0x1ab),'width':0x96}],_0x2f1366[_0x34c92c(0x1d4)](_0x352337=>_0x3eb1d3[_0x34c92c(0x192)](_0x352337)),_0x498cf8[_0x34c92c(0x199)]('Content-Type',_0x34c92c(0x185)),_0x498cf8[_0x34c92c(0x199)](_0x34c92c(0x1a0),_0x34c92c(0x1aa)+_0x34c92c(0x1ce)),await _0x360534[_0x34c92c(0x1ef)][_0x34c92c(0x1bd)](_0x498cf8),_0x498cf8[_0x34c92c(0x1b4)]();}async['querAllChatLog'](_0x1b569b,_0x23ae18){const _0x3d27fe=_0x51d3e2,{page:page=0x1,size:size=0x14,userId:_0xfed5b6,prompt:_0x3bde64}=_0x1b569b,_0x190c6a={'type':balance_constant_1[_0x3d27fe(0x195)][_0x3d27fe(0x1ae)],'prompt':(0x0,typeorm_2['Not'])('')};_0xfed5b6&&Object[_0x3d27fe(0x1df)](_0x190c6a,{'userId':_0xfed5b6}),_0x3bde64&&Object[_0x3d27fe(0x1df)](_0x190c6a,{'prompt':(0x0,typeorm_2[_0x3d27fe(0x190)])('%'+_0x3bde64+'%')});const [_0x27bd1d,_0x5aa3de]=await this['chatLogEntity'][_0x3d27fe(0x1ea)]({'order':{'id':_0x3d27fe(0x1f2)},'skip':(page-0x1)*size,'take':size,'where':_0x190c6a}),_0x4bfb02=_0x27bd1d[_0x3d27fe(0x1b6)](_0x377b17=>_0x377b17[_0x3d27fe(0x181)]),_0x265231=await this[_0x3d27fe(0x1c4)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x4bfb02)},'select':['id',_0x3d27fe(0x180),'email']});return _0x27bd1d[_0x3d27fe(0x1d4)](_0x5d9b55=>{const _0x410d99=_0x3d27fe,{username:_0x2c352b,email:_0x34c7f8}=_0x265231[_0x410d99(0x1db)](_0x5b1ba0=>_0x5b1ba0['id']===_0x5d9b55['userId'])||{};_0x5d9b55[_0x410d99(0x180)]=_0x2c352b,_0x5d9b55['email']=_0x34c7f8;}),_0x23ae18[_0x3d27fe(0x1a6)][_0x3d27fe(0x19b)]!==_0x3d27fe(0x1e3)&&_0x27bd1d[_0x3d27fe(0x1d4)](_0x1c62db=>_0x1c62db[_0x3d27fe(0x1cc)]=(0x0,utils_1[_0x3d27fe(0x18f)])(_0x1c62db[_0x3d27fe(0x1cc)])),_0x27bd1d[_0x3d27fe(0x1d4)](_0x46f5f1=>{const _0x59e311=_0x3d27fe;!_0x46f5f1[_0x59e311(0x1cc)]&&(_0x46f5f1['email']=(_0x46f5f1===null||_0x46f5f1===void 0x0?void 0x0:_0x46f5f1[_0x59e311(0x181)])+'@nine.com'),!_0x46f5f1[_0x59e311(0x180)]&&(_0x46f5f1[_0x59e311(0x180)]='游客'+(_0x46f5f1===null||_0x46f5f1===void 0x0?void 0x0:_0x46f5f1['userId']));}),{'rows':_0x27bd1d,'count':_0x5aa3de};}async['chatList'](_0x3057f9,_0xf4b6fd){const _0x4be73d=_0x51d3e2,{id:_0x4113f5}=_0x3057f9[_0x4be73d(0x1a6)],{groupId:_0x51c53c}=_0xf4b6fd,_0x5a758e={'userId':_0x4113f5,'isDelete':![]};_0x51c53c&&Object[_0x4be73d(0x1df)](_0x5a758e,{'groupId':_0x51c53c});if(_0x51c53c){const _0x4f8898=await this[_0x4be73d(0x1c7)][_0x4be73d(0x196)]({'where':{'isDelete':![]}});if(_0x4f8898===0x0)return[];}const _0x4b200e=await this[_0x4be73d(0x1a8)][_0x4be73d(0x1db)]({'where':_0x5a758e});return _0x4b200e[_0x4be73d(0x1b6)](_0x348fa4=>{const _0x4b730a=_0x4be73d,{prompt:_0x1f17e8,role:_0x364537,answer:_0x1d495e,createdAt:_0x375b79,model:_0x2b62fd,conversationOptions:_0x32ef6b,requestOptions:_0x307698,id:_0x52f280,imageUrl:_0x17c15f}=_0x348fa4;let _0xdd964a=null,_0x2c26c3=null;try{_0xdd964a=JSON[_0x4b730a(0x1c1)](_0x32ef6b),_0x2c26c3=JSON[_0x4b730a(0x1c1)](_0x307698);}catch(_0x56cff9){}return{'chatId':_0x52f280,'dateTime':(0x0,utils_1[_0x4b730a(0x197)])(_0x375b79),'text':_0x364537===_0x4b730a(0x1a6)?_0x1f17e8:_0x1d495e,'inversion':_0x364537===_0x4b730a(0x1a6),'error':![],'conversationOptions':_0xdd964a,'requestOptions':_0x2c26c3,'imageUrl':_0x17c15f,'model':_0x2b62fd};});}async[_0x51d3e2(0x1d2)](_0x2ba662,_0x4ee6dc){const _0x5d9214=_0x51d3e2,{id:_0x675405}=_0x2ba662[_0x5d9214(0x1a6)],{id:_0x4e9573}=_0x4ee6dc,_0x535156=await this[_0x5d9214(0x1a8)][_0x5d9214(0x1a3)]({'where':{'id':_0x4e9573,'userId':_0x675405}});if(!_0x535156)throw new common_1['HttpException']('你删除的对话记录不存在、请检查！',common_1[_0x5d9214(0x1a2)][_0x5d9214(0x1e4)]);const _0x3573ff=await this['chatLogEntity']['update']({'id':_0x4e9573},{'isDelete':!![]});if(_0x3573ff[_0x5d9214(0x1a9)]>0x0)return _0x5d9214(0x1b5);else throw new common_1[(_0x5d9214(0x1a4))](_0x5d9214(0x1a5),common_1[_0x5d9214(0x1a2)][_0x5d9214(0x1e4)]);}async[_0x51d3e2(0x194)](_0x3ece46,_0x147ff7){const _0x2404df=_0x51d3e2,{groupId:_0x2a5592}=_0x147ff7,{id:_0x2d5462}=_0x3ece46['user'],_0x161156=await this['chatGroupEntity'][_0x2404df(0x1a3)]({'where':{'id':_0x2a5592,'userId':_0x2d5462}});if(!_0x161156)throw new common_1['HttpException'](_0x2404df(0x1a5),common_1['HttpStatus'][_0x2404df(0x1e4)]);const _0x6a8f85=await this['chatLogEntity'][_0x2404df(0x1b8)]({'groupId':_0x2a5592},{'isDelete':!![]});if(_0x6a8f85[_0x2404df(0x1a9)]>0x0)return _0x2404df(0x1b5);if(_0x6a8f85[_0x2404df(0x1a9)]===0x0)throw new common_1[(_0x2404df(0x1a4))](_0x2404df(0x1e1),common_1[_0x2404df(0x1a2)][_0x2404df(0x1e4)]);}async['byAppId'](_0x81bc33,_0x37c78d){const _0x374d9d=_0x51d3e2,{id:_0x509667}=_0x81bc33['user'],{appId:_0x513b42,page:page=0x1,size:size=0xa}=_0x37c78d,[_0x557b69,_0x3badd6]=await this[_0x374d9d(0x1a8)][_0x374d9d(0x1ea)]({'where':{'userId':_0x509667,'appId':_0x513b42,'role':'assistant'},'order':{'id':_0x374d9d(0x1f2)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x557b69,'count':_0x3badd6};}};ChatLogService=__decorate([(0x0,common_1[_0x51d3e2(0x1d5)])(),__param(0x0,(0x0,typeorm_1[_0x51d3e2(0x1c8)])(chatLog_entity_1[_0x51d3e2(0x1e2)])),__param(0x1,(0x0,typeorm_1[_0x51d3e2(0x1c8)])(user_entity_1[_0x51d3e2(0x1d8)])),__param(0x2,(0x0,typeorm_1[_0x51d3e2(0x1c8)])(chatGroup_entity_1[_0x51d3e2(0x1b2)])),__metadata(_0x51d3e2(0x188),[typeorm_2[_0x51d3e2(0x1cb)],typeorm_2['Repository'],typeorm_2[_0x51d3e2(0x1cb)]])],ChatLogService),exports[_0x51d3e2(0x1f3)]=ChatLogService;function _0x21a4(){const _0x5b5e75=['?x-oss-process=image/resize,w_','querDrawLog','../../common/constants/balance.constant','maskEmail','Like','type','addRow','isGroup','delByGroupId','DeductionKey','count','formatDate','chatlog','setHeader','components','role','10YrvnUL','6430300NrWcoa','createdAt','../../common/utils','Content-Disposition','?imageView2/1/w/','HttpStatus','findOne','HttpException','你删除的对话记录不存在、请检查！','user','126YShCiX','chatLogEntity','affected','attachment;\x20filename=','answer','exportExcel','prompt','CHAT_TYPE','你推荐的图片不存在、请检查！','3GBihlV','extend','ChatGroupEntity','querAllDrawLog','end','删除对话记录成功！','map','130753SIBFep','update','paintCount','model','取消推荐','defineProperty','write','metadata','tencent','72vWhGQZ','parse','DALL-E2','dall-e-3','userEntity','length','object','chatGroupEntity','InjectRepository','Not','getOwnPropertyDescriptor','Repository','email','ali','chat.xlsx','PAINT_TYPE','log','提问问题','deleteChatLog','169536sDeyWZ','forEach','Injectable','fileInfo','__decorate','UserEntity','1583072ntDgDv','includes','find','图片成功！','cos','你操作的图片不存在、请检查！','assign','saveChatLog','当前页面已经没有东西可以删除了！','ChatLogEntity','super','BAD_REQUEST','/q/55','957876eSipGI','349151qZHwpI','./chatLog.entity','function','findAndCount','../user/user.entity','addWorksheet','typeorm','exceljs','xlsx','columns','@nestjs/typeorm','DESC','ChatLogService','group','username','userId','8140450yxdMXE','回答答案','thumbImg','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','用户邮箱','default','design:paramtypes','Workbook','message_id','decorate'];_0x21a4=function(){return _0x5b5e75;};return _0x21a4();}