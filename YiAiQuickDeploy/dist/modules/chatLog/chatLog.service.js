'use strict';const _0x8eff35=_0x9f61;(function(_0x3219c9,_0xc1ac20){const _0x3eb069=_0x9f61,_0x4d03f4=_0x3219c9();while(!![]){try{const _0x9c5efd=-parseInt(_0x3eb069(0x1d5))/0x1+-parseInt(_0x3eb069(0x1f4))/0x2*(parseInt(_0x3eb069(0x201))/0x3)+parseInt(_0x3eb069(0x1e7))/0x4*(parseInt(_0x3eb069(0x1e3))/0x5)+parseInt(_0x3eb069(0x1f3))/0x6*(-parseInt(_0x3eb069(0x203))/0x7)+parseInt(_0x3eb069(0x223))/0x8+parseInt(_0x3eb069(0x1cc))/0x9+-parseInt(_0x3eb069(0x23a))/0xa*(-parseInt(_0x3eb069(0x1e1))/0xb);if(_0x9c5efd===_0xc1ac20)break;else _0x4d03f4['push'](_0x4d03f4['shift']());}catch(_0x199a3c){_0x4d03f4['push'](_0x4d03f4['shift']());}}}(_0x532f,0xed9d5));function _0x9f61(_0x48915a,_0x8acf41){const _0x532fef=_0x532f();return _0x9f61=function(_0x9f618f,_0x4eb379){_0x9f618f=_0x9f618f-0x1cb;let _0x585902=_0x532fef[_0x9f618f];return _0x585902;},_0x9f61(_0x48915a,_0x8acf41);}var __decorate=this&&this[_0x8eff35(0x1e0)]||function(_0x5276f1,_0x587c2d,_0x3cb8af,_0x61f2ec){const _0x247119=_0x8eff35;var _0x14f6c8=arguments['length'],_0x37bc51=_0x14f6c8<0x3?_0x587c2d:_0x61f2ec===null?_0x61f2ec=Object[_0x247119(0x22e)](_0x587c2d,_0x3cb8af):_0x61f2ec,_0x251296;if(typeof Reflect===_0x247119(0x213)&&typeof Reflect[_0x247119(0x1f5)]===_0x247119(0x21a))_0x37bc51=Reflect[_0x247119(0x1f5)](_0x5276f1,_0x587c2d,_0x3cb8af,_0x61f2ec);else{for(var _0x4dc243=_0x5276f1[_0x247119(0x222)]-0x1;_0x4dc243>=0x0;_0x4dc243--)if(_0x251296=_0x5276f1[_0x4dc243])_0x37bc51=(_0x14f6c8<0x3?_0x251296(_0x37bc51):_0x14f6c8>0x3?_0x251296(_0x587c2d,_0x3cb8af,_0x37bc51):_0x251296(_0x587c2d,_0x3cb8af))||_0x37bc51;}return _0x14f6c8>0x3&&_0x37bc51&&Object[_0x247119(0x200)](_0x587c2d,_0x3cb8af,_0x37bc51),_0x37bc51;},__metadata=this&&this[_0x8eff35(0x1dc)]||function(_0xc05ffc,_0xfaca7b){const _0x3fcade=_0x8eff35;if(typeof Reflect===_0x3fcade(0x213)&&typeof Reflect['metadata']==='function')return Reflect[_0x3fcade(0x217)](_0xc05ffc,_0xfaca7b);},__param=this&&this['__param']||function(_0x2a0bcd,_0x47a471){return function(_0x57f5e8,_0x3bc185){_0x47a471(_0x57f5e8,_0x3bc185,_0x2a0bcd);};};Object[_0x8eff35(0x200)](exports,_0x8eff35(0x226),{'value':!![]}),exports[_0x8eff35(0x1f1)]=void 0x0;const common_1=require(_0x8eff35(0x231)),typeorm_1=require(_0x8eff35(0x1f9)),chatLog_entity_1=require(_0x8eff35(0x20e)),typeorm_2=require(_0x8eff35(0x239)),balance_constant_1=require(_0x8eff35(0x1fd)),user_entity_1=require(_0x8eff35(0x1ce)),utils_1=require(_0x8eff35(0x202)),exceljs_1=require('exceljs'),chatGroup_entity_1=require('../chatGroup/chatGroup.entity');let ChatLogService=class ChatLogService{constructor(_0x2a2b5e,_0x5a580e,_0x5b6918){const _0x437fdc=_0x8eff35;this['chatLogEntity']=_0x2a2b5e,this[_0x437fdc(0x219)]=_0x5a580e,this['chatGroupEntity']=_0x5b6918;}async[_0x8eff35(0x1e6)](_0x2e1ce4){const _0x4f38fb=_0x8eff35;return await this[_0x4f38fb(0x225)][_0x4f38fb(0x23e)](_0x2e1ce4);}async[_0x8eff35(0x20a)](_0x44101b,_0x512c3b){const _0x29bb9a=_0x8eff35,{id:_0x4dd7bb}=_0x44101b[_0x29bb9a(0x1fc)],{model:_0x447a9c}=_0x512c3b,_0x19a6e9={'userId':_0x4dd7bb,'type':balance_constant_1[_0x29bb9a(0x1f2)][_0x29bb9a(0x1ea)]};_0x447a9c&&(_0x19a6e9[_0x29bb9a(0x1e5)]=_0x447a9c,_0x447a9c===_0x29bb9a(0x1cb)&&(_0x19a6e9[_0x29bb9a(0x1e5)]=(0x0,typeorm_2['In'])(['DALL-E2',_0x29bb9a(0x1d8)])));const _0x2547b9=await this['chatLogEntity'][_0x29bb9a(0x23c)]({'where':_0x19a6e9,'order':{'id':'DESC'},'select':['id',_0x29bb9a(0x235),'prompt',_0x29bb9a(0x20b),'group',_0x29bb9a(0x1e5),_0x29bb9a(0x21e),'type',_0x29bb9a(0x211)]});return _0x2547b9[_0x29bb9a(0x21d)](_0x4ab2da=>{const _0x3446a6=_0x29bb9a;if(_0x4ab2da['type']===_0x3446a6(0x20c)){const _0x138109=_0x4ab2da['model']==='mj'?0x136:0xa0,_0x3e6d18=_0x4ab2da[_0x3446a6(0x235)][_0x3446a6(0x205)]('cos')?_0x3446a6(0x1d2):_0x3446a6(0x22a),_0x5b93d3=_0x3e6d18===_0x3446a6(0x1d2)?'?imageView2/1/w/'+_0x138109+_0x3446a6(0x1d0):'?x-oss-process=image/resize,w_'+_0x138109;_0x4ab2da[_0x3446a6(0x1ec)]=_0x4ab2da[_0x3446a6(0x235)]+_0x5b93d3;try{_0x4ab2da[_0x3446a6(0x211)]=_0x4ab2da[_0x3446a6(0x211)]?JSON[_0x3446a6(0x210)](_0x4ab2da[_0x3446a6(0x211)]):null;}catch(_0x3b186e){_0x4ab2da[_0x3446a6(0x211)]={};}}}),_0x2547b9;}async[_0x8eff35(0x221)](_0x19412f){const _0x4b0da7=_0x8eff35,{page:page=0x1,size:size=0x14,rec:_0x2f41b4,userId:_0x28c356,model:_0x1f79f6}=_0x19412f,_0x5aa406={'type':balance_constant_1[_0x4b0da7(0x1f2)][_0x4b0da7(0x1ea)],'prompt':(0x0,typeorm_2[_0x4b0da7(0x20f)])(''),'answer':(0x0,typeorm_2[_0x4b0da7(0x20f)])('')};_0x2f41b4&&Object['assign'](_0x5aa406,{'rec':_0x2f41b4}),_0x28c356&&Object[_0x4b0da7(0x233)](_0x5aa406,{'userId':_0x28c356});_0x1f79f6&&(_0x5aa406[_0x4b0da7(0x1e5)]=_0x1f79f6,_0x1f79f6===_0x4b0da7(0x1cb)&&(_0x5aa406['model']=(0x0,typeorm_2['In'])([_0x4b0da7(0x1cb),_0x4b0da7(0x1d8)])));const [_0x10d83d,_0xae9c84]=await this[_0x4b0da7(0x225)][_0x4b0da7(0x224)]({'order':{'id':_0x4b0da7(0x1ee)},'skip':(page-0x1)*size,'take':size,'where':_0x5aa406});return _0x10d83d[_0x4b0da7(0x21d)](_0xb10d06=>{const _0x2f6f03=_0x4b0da7;var _0x121dc4;if(_0xb10d06[_0x2f6f03(0x1f0)]===_0x2f6f03(0x20c)){const _0x261c0e=_0xb10d06[_0x2f6f03(0x1e5)]==='mj'?0x136:0xa0,_0x469611=_0xb10d06[_0x2f6f03(0x235)][_0x2f6f03(0x205)]('cos')?_0x2f6f03(0x1d2):_0x2f6f03(0x22a),_0x56ceab=_0x469611==='tencent'?'?imageView2/1/w/'+_0x261c0e+_0x2f6f03(0x1d0):'?x-oss-process=image/resize,w_'+_0x261c0e;_0xb10d06['thumbImg']=_0xb10d06['answer']+_0x56ceab;try{const _0x3d034f=_0xb10d06[_0x2f6f03(0x21e)]?JSON[_0x2f6f03(0x210)](_0xb10d06[_0x2f6f03(0x21e)]):null;_0x3d034f&&(_0x3d034f?_0xb10d06[_0x2f6f03(0x1eb)]=((_0x121dc4=_0x3d034f===null||_0x3d034f===void 0x0?void 0x0:_0x3d034f['components'][0x0])===null||_0x121dc4===void 0x0?void 0x0:_0x121dc4[_0x2f6f03(0x220)]['length'])===0x5:_0xb10d06[_0x2f6f03(0x1eb)]=![]);}catch(_0x2de5d0){console[_0x2f6f03(0x207)](_0x2f6f03(0x23b),_0x2de5d0);}}}),{'rows':_0x10d83d,'count':_0xae9c84};}async[_0x8eff35(0x212)](_0x3c78b9){const _0x4d7ae5=_0x8eff35,{id:_0x351242}=_0x3c78b9,_0x358e6b=await this[_0x4d7ae5(0x225)][_0x4d7ae5(0x1db)]({'where':{'id':_0x351242,'type':balance_constant_1[_0x4d7ae5(0x1f2)][_0x4d7ae5(0x1ea)]}});if(!_0x358e6b)throw new common_1['HttpException'](_0x4d7ae5(0x21f),common_1[_0x4d7ae5(0x229)][_0x4d7ae5(0x238)]);const _0x212c5f=_0x358e6b[_0x4d7ae5(0x1e8)]===0x1?0x0:0x1,_0x2fc12e=await this[_0x4d7ae5(0x225)][_0x4d7ae5(0x22d)]({'id':_0x351242},{'rec':_0x212c5f});if(_0x2fc12e[_0x4d7ae5(0x228)]>0x0)return(_0x212c5f?'推荐':_0x4d7ae5(0x1e2))+_0x4d7ae5(0x227);throw new common_1[(_0x4d7ae5(0x1fb))](_0x4d7ae5(0x1d7),common_1[_0x4d7ae5(0x229)][_0x4d7ae5(0x238)]);}async[_0x8eff35(0x234)](_0x3c9d9e,_0x3b3061){const _0x3076b4=_0x8eff35,_0x2b5652={'type':balance_constant_1[_0x3076b4(0x1f2)]['CHAT_TYPE']},{page:page=0x1,size:size=0x1e,prompt:_0x593ac0,email:_0x110b13}=_0x3c9d9e;_0x593ac0&&Object['assign'](_0x2b5652,{'prompt':(0x0,typeorm_2[_0x3076b4(0x216)])('%'+_0x593ac0+'%')});if(_0x110b13){const _0x573eb4=await this[_0x3076b4(0x219)][_0x3076b4(0x1db)]({'where':{'email':_0x110b13}});(_0x573eb4===null||_0x573eb4===void 0x0?void 0x0:_0x573eb4['id'])&&Object[_0x3076b4(0x233)](_0x2b5652,{'userId':_0x573eb4['id']});}const [_0x4ef51b,_0xca37e0]=await this['chatLogEntity'][_0x3076b4(0x224)]({'order':{'id':_0x3076b4(0x1ee)},'skip':(page-0x1)*size,'take':size,'where':_0x2b5652}),_0x523bc9=_0x4ef51b['map'](_0x4df759=>_0x4df759[_0x3076b4(0x232)]),_0x3833cf=await this['userEntity'][_0x3076b4(0x23c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x523bc9)}}),_0x1d5c45=_0x4ef51b[_0x3076b4(0x1d1)](_0x569957=>{const _0x289416=_0x3076b4,_0x41f2dc=_0x3833cf[_0x289416(0x23c)](_0x5bd986=>_0x5bd986['id']===_0x569957[_0x289416(0x232)]);return{'username':_0x41f2dc?_0x41f2dc[_0x289416(0x1ed)]:'','email':_0x41f2dc?_0x41f2dc[_0x289416(0x1f8)]:'','prompt':_0x569957[_0x289416(0x236)],'answer':_0x569957['answer'],'createdAt':(0x0,utils_1[_0x289416(0x1d6)])(_0x569957['createdAt'])};}),_0x13586d=new exceljs_1[(_0x3076b4(0x204))]['Workbook'](),_0x2facae=_0x13586d[_0x3076b4(0x1e9)](_0x3076b4(0x21b));_0x2facae['columns']=[{'header':'用户名','key':_0x3076b4(0x1ed),'width':0x14},{'header':_0x3076b4(0x1d4),'key':_0x3076b4(0x1f8),'width':0x14},{'header':_0x3076b4(0x1df),'key':_0x3076b4(0x22c),'width':0x14},{'header':_0x3076b4(0x23d),'key':_0x3076b4(0x236),'width':0x50},{'header':_0x3076b4(0x1d3),'key':'answer','width':0x96}],_0x1d5c45[_0x3076b4(0x21d)](_0xc9fafe=>_0x2facae[_0x3076b4(0x22b)](_0xc9fafe)),_0x3b3061['setHeader'](_0x3076b4(0x20d),_0x3076b4(0x1ff)),_0x3b3061[_0x3076b4(0x1de)]('Content-Disposition',_0x3076b4(0x1cf)+'chat.xlsx'),await _0x13586d[_0x3076b4(0x21c)][_0x3076b4(0x1da)](_0x3b3061),_0x3b3061[_0x3076b4(0x230)]();}async['querAllChatLog'](_0x126b0a,_0x4db7a5){const _0x139b5a=_0x8eff35,{page:page=0x1,size:size=0x14,userId:_0x7cc6d1,prompt:_0x1817c6}=_0x126b0a,_0x5274f4={'type':balance_constant_1[_0x139b5a(0x1f2)][_0x139b5a(0x1f7)],'prompt':(0x0,typeorm_2['Not'])('')};_0x7cc6d1&&Object[_0x139b5a(0x233)](_0x5274f4,{'userId':_0x7cc6d1}),_0x1817c6&&Object['assign'](_0x5274f4,{'prompt':(0x0,typeorm_2[_0x139b5a(0x216)])('%'+_0x1817c6+'%')});const [_0x3ced0c,_0x423442]=await this[_0x139b5a(0x225)][_0x139b5a(0x224)]({'order':{'id':_0x139b5a(0x1ee)},'skip':(page-0x1)*size,'take':size,'where':_0x5274f4}),_0x1da7eb=_0x3ced0c[_0x139b5a(0x1d1)](_0x2e63b7=>_0x2e63b7[_0x139b5a(0x232)]),_0x444423=await this[_0x139b5a(0x219)][_0x139b5a(0x23c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1da7eb)},'select':['id',_0x139b5a(0x1ed),'email']});return _0x3ced0c[_0x139b5a(0x21d)](_0x15dbb6=>{const _0x4cb50f=_0x139b5a,{username:_0x5d173f,email:_0x2e01ff}=_0x444423[_0x4cb50f(0x23c)](_0x43c760=>_0x43c760['id']===_0x15dbb6[_0x4cb50f(0x232)])||{};_0x15dbb6[_0x4cb50f(0x1ed)]=_0x5d173f,_0x15dbb6[_0x4cb50f(0x1f8)]=_0x2e01ff;}),_0x4db7a5[_0x139b5a(0x1fc)][_0x139b5a(0x206)]!==_0x139b5a(0x1ef)&&_0x3ced0c[_0x139b5a(0x21d)](_0x599c54=>_0x599c54[_0x139b5a(0x1f8)]=(0x0,utils_1['maskEmail'])(_0x599c54[_0x139b5a(0x1f8)])),_0x3ced0c[_0x139b5a(0x21d)](_0x13dff7=>{const _0xc960db=_0x139b5a;!_0x13dff7[_0xc960db(0x1f8)]&&(_0x13dff7[_0xc960db(0x1f8)]=(_0x13dff7===null||_0x13dff7===void 0x0?void 0x0:_0x13dff7[_0xc960db(0x232)])+_0xc960db(0x23f)),!_0x13dff7[_0xc960db(0x1ed)]&&(_0x13dff7[_0xc960db(0x1ed)]='游客'+(_0x13dff7===null||_0x13dff7===void 0x0?void 0x0:_0x13dff7['userId']));}),{'rows':_0x3ced0c,'count':_0x423442};}async[_0x8eff35(0x215)](_0x2cbd16,_0x21e2c3){const _0xb38362=_0x8eff35,{id:_0x3b5530}=_0x2cbd16['user'],{groupId:_0x3466de}=_0x21e2c3,_0x498d56={'userId':_0x3b5530,'isDelete':![]};_0x3466de&&Object[_0xb38362(0x233)](_0x498d56,{'groupId':_0x3466de});if(_0x3466de){const _0x522f5d=await this[_0xb38362(0x218)][_0xb38362(0x208)]({'where':{'isDelete':![]}});if(_0x522f5d===0x0)return[];}const _0x491773=await this['chatLogEntity']['find']({'where':_0x498d56});return _0x491773[_0xb38362(0x1d1)](_0x666ba0=>{const _0x36e633=_0xb38362,{prompt:_0x138608,role:_0x5d5a1b,answer:_0x3006c9,createdAt:_0x4f10d2,model:_0x7a5a45,conversationOptions:_0x340afc,requestOptions:_0x1f6ffb,id:_0x140a0a,imageUrl:_0x5a75fa}=_0x666ba0;let _0x54335a=null,_0x5374ba=null;try{_0x54335a=JSON[_0x36e633(0x210)](_0x340afc),_0x5374ba=JSON[_0x36e633(0x210)](_0x1f6ffb);}catch(_0x4e247f){}return{'chatId':_0x140a0a,'dateTime':(0x0,utils_1[_0x36e633(0x1d6)])(_0x4f10d2),'text':_0x5d5a1b===_0x36e633(0x1fc)?_0x138608:_0x3006c9,'inversion':_0x5d5a1b===_0x36e633(0x1fc),'error':![],'conversationOptions':_0x54335a,'requestOptions':_0x5374ba,'imageUrl':_0x5a75fa,'model':_0x7a5a45};});}async[_0x8eff35(0x1dd)](_0x4f3cff,_0x4939a8){const _0x2542cf=_0x8eff35,{id:_0x9d9a1}=_0x4f3cff[_0x2542cf(0x1fc)],{id:_0x1c3c63}=_0x4939a8,_0x48fc56=await this[_0x2542cf(0x225)][_0x2542cf(0x1db)]({'where':{'id':_0x1c3c63,'userId':_0x9d9a1}});if(!_0x48fc56)throw new common_1[(_0x2542cf(0x1fb))](_0x2542cf(0x1d9),common_1[_0x2542cf(0x229)][_0x2542cf(0x238)]);const _0x57c16a=await this[_0x2542cf(0x225)]['update']({'id':_0x1c3c63},{'isDelete':!![]});if(_0x57c16a['affected']>0x0)return _0x2542cf(0x1cd);else throw new common_1[(_0x2542cf(0x1fb))](_0x2542cf(0x1d9),common_1[_0x2542cf(0x229)][_0x2542cf(0x238)]);}async['delByGroupId'](_0xcf01ff,_0x106886){const _0x221851=_0x8eff35,{groupId:_0x5ba844}=_0x106886,{id:_0x4b9c53}=_0xcf01ff['user'],_0x1a7f4a=await this[_0x221851(0x218)][_0x221851(0x1db)]({'where':{'id':_0x5ba844,'userId':_0x4b9c53}});if(!_0x1a7f4a)throw new common_1[(_0x221851(0x1fb))](_0x221851(0x1d9),common_1[_0x221851(0x229)]['BAD_REQUEST']);const _0x487c38=await this[_0x221851(0x225)][_0x221851(0x22d)]({'groupId':_0x5ba844},{'isDelete':!![]});if(_0x487c38['affected']>0x0)return _0x221851(0x1cd);if(_0x487c38[_0x221851(0x228)]===0x0)throw new common_1['HttpException']('当前页面已经没有东西可以删除了！',common_1[_0x221851(0x229)][_0x221851(0x238)]);}async[_0x8eff35(0x22f)](_0x17ac9b,_0x38b1ba){const _0x15b1b3=_0x8eff35,{id:_0x1dbd33}=_0x17ac9b[_0x15b1b3(0x1fc)],{appId:_0x4e0d4d,page:page=0x1,size:size=0xa}=_0x38b1ba,[_0x5f242d,_0x38e135]=await this[_0x15b1b3(0x225)][_0x15b1b3(0x224)]({'where':{'userId':_0x1dbd33,'appId':_0x4e0d4d,'role':_0x15b1b3(0x209)},'order':{'id':_0x15b1b3(0x1ee)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x5f242d,'count':_0x38e135};}};ChatLogService=__decorate([(0x0,common_1[_0x8eff35(0x1f6)])(),__param(0x0,(0x0,typeorm_1[_0x8eff35(0x237)])(chatLog_entity_1[_0x8eff35(0x214)])),__param(0x1,(0x0,typeorm_1[_0x8eff35(0x237)])(user_entity_1[_0x8eff35(0x1fe)])),__param(0x2,(0x0,typeorm_1[_0x8eff35(0x237)])(chatGroup_entity_1['ChatGroupEntity'])),__metadata(_0x8eff35(0x1e4),[typeorm_2['Repository'],typeorm_2[_0x8eff35(0x1fa)],typeorm_2['Repository']])],ChatLogService),exports[_0x8eff35(0x1f1)]=ChatLogService;function _0x532f(){const _0x5122da=['username','DESC','super','type','ChatLogService','DeductionKey','12HfQJCg','2710222Usubqu','decorate','Injectable','CHAT_TYPE','email','@nestjs/typeorm','Repository','HttpException','user','../../common/constants/balance.constant','UserEntity','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','defineProperty','3FKCwqD','../../common/utils','2183762xdLGpo','default','includes','role','log','count','assistant','querDrawLog','message_id','paintCount','Content-Type','./chatLog.entity','Not','parse','fileInfo','recDrawImg','object','ChatLogEntity','chatList','Like','metadata','chatGroupEntity','userEntity','function','chatlog','xlsx','forEach','extend','你推荐的图片不存在、请检查！','components','querAllDrawLog','length','6970320xKAZPG','findAndCount','chatLogEntity','__esModule','图片成功！','affected','HttpStatus','ali','addRow','createdAt','update','getOwnPropertyDescriptor','byAppId','end','@nestjs/common','userId','assign','exportExcel','answer','prompt','InjectRepository','BAD_REQUEST','typeorm','410dUYbJF','querAllDrawLog\x20Json\x20parse\x20error','find','提问问题','save','@nine.com','DALL-E2','787941XdIVSa','删除对话记录成功！','../user/user.entity','attachment;\x20filename=','/q/55','map','tencent','回答答案','用户邮箱','337004nIOPue','formatDate','你操作的图片不存在、请检查！','dall-e-3','你删除的对话记录不存在、请检查！','write','findOne','__metadata','deleteChatLog','setHeader','提问时间','__decorate','574849VoiWyd','取消推荐','10qAwYkx','design:paramtypes','model','saveChatLog','375716NmksYj','rec','addWorksheet','PAINT_TYPE','isGroup','thumbImg'];_0x532f=function(){return _0x5122da;};return _0x532f();}