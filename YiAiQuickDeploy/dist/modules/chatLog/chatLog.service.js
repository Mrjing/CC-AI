'use strict';function _0x2285(_0x3d67a0,_0x803c32){const _0x13dbee=_0x13db();return _0x2285=function(_0x2285e7,_0x43c461){_0x2285e7=_0x2285e7-0x110;let _0x10f3fb=_0x13dbee[_0x2285e7];return _0x10f3fb;},_0x2285(_0x3d67a0,_0x803c32);}const _0x341304=_0x2285;function _0x13db(){const _0x1bae27=['count','InjectRepository','提问时间','getOwnPropertyDescriptor','@nestjs/common','chat.xlsx','typeorm','dall-e-3','__esModule','../../common/constants/balance.constant','setHeader','你推荐的图片不存在、请检查！','__param','rec','recDrawImg','chatLogEntity','7237500aaIDDY','save','model','message_id','user','querAllChatLog','length','map','41522129LgBIkz','chatGroupEntity','Content-Disposition','你操作的图片不存在、请检查！','PAINT_TYPE','图片成功！','?imageView2/1/w/','DESC','Injectable','Not','回答答案','function','saveChatLog','删除对话记录成功！','forEach','Like','DALL-E2','paintCount','HttpStatus','userId','__metadata','/q/55','../../common/utils','parse','write','1169854VuqKzI','querAllDrawLog','6RqcvwB','457623rRKZdw','5640GimlUV','2svHRAc','chatList','tencent','extend','@nestjs/typeorm','提问问题','用户邮箱','deleteChatLog','userEntity','addWorksheet','93063GGDNtD','byAppId','metadata','fileInfo','HttpException','8CqFqYU','Repository','querAllDrawLog\x20Json\x20parse\x20error','DeductionKey','columns','./chatLog.entity','exceljs','thumbImg','affected','formatDate','../user/user.entity','answer','BAD_REQUEST','chatlog','3733775QzfPYn','CHAT_TYPE','prompt','username','ChatLogService','object','createdAt','maskEmail','email','xlsx','find','Content-Type','type','assign','decorate','14103TVcYPw','assistant','design:paramtypes','Workbook','attachment;\x20filename=','__decorate','delByGroupId','用户名','findOne','isGroup','cos','includes','你删除的对话记录不存在、请检查！','update','UserEntity','components','findAndCount','@nine.com','addRow'];_0x13db=function(){return _0x1bae27;};return _0x13db();}(function(_0x55ddc9,_0x47e56e){const _0xe8d5dd=_0x2285,_0x2fa62d=_0x55ddc9();while(!![]){try{const _0x441024=parseInt(_0xe8d5dd(0x16d))/0x1*(-parseInt(_0xe8d5dd(0x16f))/0x2)+parseInt(_0xe8d5dd(0x179))/0x3*(parseInt(_0xe8d5dd(0x17e))/0x4)+-parseInt(_0xe8d5dd(0x117))/0x5*(parseInt(_0xe8d5dd(0x16c))/0x6)+-parseInt(_0xe8d5dd(0x16a))/0x7+-parseInt(_0xe8d5dd(0x16e))/0x8*(parseInt(_0xe8d5dd(0x126))/0x9)+-parseInt(_0xe8d5dd(0x149))/0xa+parseInt(_0xe8d5dd(0x151))/0xb;if(_0x441024===_0x47e56e)break;else _0x2fa62d['push'](_0x2fa62d['shift']());}catch(_0xaec981){_0x2fa62d['push'](_0x2fa62d['shift']());}}}(_0x13db,0x9b77c));var __decorate=this&&this[_0x341304(0x12b)]||function(_0x1c7b6f,_0x4280ed,_0xdb9b95,_0x5b17c8){const _0x2e3006=_0x341304;var _0x1fed33=arguments[_0x2e3006(0x14f)],_0x2feeed=_0x1fed33<0x3?_0x4280ed:_0x5b17c8===null?_0x5b17c8=Object[_0x2e3006(0x13c)](_0x4280ed,_0xdb9b95):_0x5b17c8,_0x31a79e;if(typeof Reflect===_0x2e3006(0x11c)&&typeof Reflect[_0x2e3006(0x125)]==='function')_0x2feeed=Reflect[_0x2e3006(0x125)](_0x1c7b6f,_0x4280ed,_0xdb9b95,_0x5b17c8);else{for(var _0x2b8660=_0x1c7b6f[_0x2e3006(0x14f)]-0x1;_0x2b8660>=0x0;_0x2b8660--)if(_0x31a79e=_0x1c7b6f[_0x2b8660])_0x2feeed=(_0x1fed33<0x3?_0x31a79e(_0x2feeed):_0x1fed33>0x3?_0x31a79e(_0x4280ed,_0xdb9b95,_0x2feeed):_0x31a79e(_0x4280ed,_0xdb9b95))||_0x2feeed;}return _0x1fed33>0x3&&_0x2feeed&&Object['defineProperty'](_0x4280ed,_0xdb9b95,_0x2feeed),_0x2feeed;},__metadata=this&&this[_0x341304(0x165)]||function(_0x176b37,_0x514712){const _0x2d3041=_0x341304;if(typeof Reflect===_0x2d3041(0x11c)&&typeof Reflect['metadata']===_0x2d3041(0x15c))return Reflect[_0x2d3041(0x17b)](_0x176b37,_0x514712);},__param=this&&this[_0x341304(0x145)]||function(_0x4afaa1,_0x39cb45){return function(_0x3b7089,_0x31c671){_0x39cb45(_0x3b7089,_0x31c671,_0x4afaa1);};};Object['defineProperty'](exports,_0x341304(0x141),{'value':!![]}),exports[_0x341304(0x11b)]=void 0x0;const common_1=require(_0x341304(0x13d)),typeorm_1=require(_0x341304(0x173)),chatLog_entity_1=require(_0x341304(0x183)),typeorm_2=require(_0x341304(0x13f)),balance_constant_1=require(_0x341304(0x142)),user_entity_1=require(_0x341304(0x113)),utils_1=require(_0x341304(0x167)),exceljs_1=require(_0x341304(0x184)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity');let ChatLogService=class ChatLogService{constructor(_0x32e596,_0x3db0cc,_0x34b207){const _0x2fe45f=_0x341304;this[_0x2fe45f(0x148)]=_0x32e596,this[_0x2fe45f(0x177)]=_0x3db0cc,this[_0x2fe45f(0x152)]=_0x34b207;}async[_0x341304(0x15d)](_0x353337){const _0x35457b=_0x341304;return await this[_0x35457b(0x148)][_0x35457b(0x14a)](_0x353337);}async['querDrawLog'](_0x9d04e3,_0x5c28b0){const _0x29d44c=_0x341304,{id:_0x31ed8}=_0x9d04e3[_0x29d44c(0x14d)],{model:_0x3d643f}=_0x5c28b0,_0x437997={'userId':_0x31ed8,'type':balance_constant_1[_0x29d44c(0x181)]['PAINT_TYPE']};_0x3d643f&&(_0x437997['model']=_0x3d643f,_0x3d643f===_0x29d44c(0x161)&&(_0x437997[_0x29d44c(0x14b)]=(0x0,typeorm_2['In'])(['DALL-E2',_0x29d44c(0x140)])));const _0x3030d5=await this[_0x29d44c(0x148)][_0x29d44c(0x121)]({'where':_0x437997,'order':{'id':_0x29d44c(0x158)},'select':['id',_0x29d44c(0x114),_0x29d44c(0x119),_0x29d44c(0x14c),'group',_0x29d44c(0x14b),'extend',_0x29d44c(0x123),'fileInfo']});return _0x3030d5[_0x29d44c(0x15f)](_0x2d4a60=>{const _0x4577d1=_0x29d44c;if(_0x2d4a60[_0x4577d1(0x123)]===_0x4577d1(0x162)){const _0x1d7c99=_0x2d4a60['model']==='mj'?0x136:0xa0,_0x1d2bd5=_0x2d4a60['answer'][_0x4577d1(0x131)](_0x4577d1(0x130))?_0x4577d1(0x171):'ali',_0x3d5171=_0x1d2bd5===_0x4577d1(0x171)?_0x4577d1(0x157)+_0x1d7c99+_0x4577d1(0x166):'?x-oss-process=image/resize,w_'+_0x1d7c99;_0x2d4a60['thumbImg']=_0x2d4a60[_0x4577d1(0x114)]+_0x3d5171;try{_0x2d4a60['fileInfo']=_0x2d4a60[_0x4577d1(0x17c)]?JSON['parse'](_0x2d4a60[_0x4577d1(0x17c)]):null;}catch(_0x2de168){_0x2d4a60['fileInfo']={};}}}),_0x3030d5;}async[_0x341304(0x16b)](_0x51a27b){const _0x5e500d=_0x341304,{page:page=0x1,size:size=0x14,rec:_0x5d66d5,userId:_0xdb98ef,model:_0x668d0b}=_0x51a27b,_0x48e4e2={'type':balance_constant_1[_0x5e500d(0x181)]['PAINT_TYPE'],'prompt':(0x0,typeorm_2[_0x5e500d(0x15a)])(''),'answer':(0x0,typeorm_2[_0x5e500d(0x15a)])('')};_0x5d66d5&&Object[_0x5e500d(0x124)](_0x48e4e2,{'rec':_0x5d66d5}),_0xdb98ef&&Object['assign'](_0x48e4e2,{'userId':_0xdb98ef});_0x668d0b&&(_0x48e4e2[_0x5e500d(0x14b)]=_0x668d0b,_0x668d0b===_0x5e500d(0x161)&&(_0x48e4e2['model']=(0x0,typeorm_2['In'])([_0x5e500d(0x161),_0x5e500d(0x140)])));const [_0x487697,_0x237cc0]=await this['chatLogEntity'][_0x5e500d(0x136)]({'order':{'id':_0x5e500d(0x158)},'skip':(page-0x1)*size,'take':size,'where':_0x48e4e2});return _0x487697[_0x5e500d(0x15f)](_0x4fd1d6=>{const _0x1d12cb=_0x5e500d;var _0x5caba8;if(_0x4fd1d6[_0x1d12cb(0x123)]==='paintCount'){const _0x28b8e2=_0x4fd1d6[_0x1d12cb(0x14b)]==='mj'?0x136:0xa0,_0x36e4e6=_0x4fd1d6[_0x1d12cb(0x114)][_0x1d12cb(0x131)](_0x1d12cb(0x130))?_0x1d12cb(0x171):'ali',_0x44241b=_0x36e4e6===_0x1d12cb(0x171)?'?imageView2/1/w/'+_0x28b8e2+_0x1d12cb(0x166):'?x-oss-process=image/resize,w_'+_0x28b8e2;_0x4fd1d6[_0x1d12cb(0x110)]=_0x4fd1d6[_0x1d12cb(0x114)]+_0x44241b;try{const _0x9291e3=_0x4fd1d6['extend']?JSON['parse'](_0x4fd1d6[_0x1d12cb(0x172)]):null;_0x9291e3&&(_0x9291e3?_0x4fd1d6['isGroup']=((_0x5caba8=_0x9291e3===null||_0x9291e3===void 0x0?void 0x0:_0x9291e3[_0x1d12cb(0x135)][0x0])===null||_0x5caba8===void 0x0?void 0x0:_0x5caba8[_0x1d12cb(0x135)][_0x1d12cb(0x14f)])===0x5:_0x4fd1d6[_0x1d12cb(0x12f)]=![]);}catch(_0x1d4f09){console['log'](_0x1d12cb(0x180),_0x1d4f09);}}}),{'rows':_0x487697,'count':_0x237cc0};}async[_0x341304(0x147)](_0x5a497c){const _0x23e051=_0x341304,{id:_0x395b40}=_0x5a497c,_0x2003d6=await this[_0x23e051(0x148)]['findOne']({'where':{'id':_0x395b40,'type':balance_constant_1['DeductionKey'][_0x23e051(0x155)]}});if(!_0x2003d6)throw new common_1['HttpException'](_0x23e051(0x144),common_1[_0x23e051(0x163)][_0x23e051(0x115)]);const _0x389546=_0x2003d6[_0x23e051(0x146)]===0x1?0x0:0x1,_0x89685a=await this[_0x23e051(0x148)]['update']({'id':_0x395b40},{'rec':_0x389546});if(_0x89685a['affected']>0x0)return(_0x389546?'推荐':'取消推荐')+_0x23e051(0x156);throw new common_1[(_0x23e051(0x17d))](_0x23e051(0x154),common_1[_0x23e051(0x163)]['BAD_REQUEST']);}async['exportExcel'](_0x49b5c1,_0x407414){const _0x1bdee2=_0x341304,_0xb77642={'type':balance_constant_1[_0x1bdee2(0x181)][_0x1bdee2(0x118)]},{page:page=0x1,size:size=0x1e,prompt:_0x1d0562,email:_0x50a577}=_0x49b5c1;_0x1d0562&&Object[_0x1bdee2(0x124)](_0xb77642,{'prompt':(0x0,typeorm_2[_0x1bdee2(0x160)])('%'+_0x1d0562+'%')});if(_0x50a577){const _0x3d6b5b=await this[_0x1bdee2(0x177)][_0x1bdee2(0x12e)]({'where':{'email':_0x50a577}});(_0x3d6b5b===null||_0x3d6b5b===void 0x0?void 0x0:_0x3d6b5b['id'])&&Object[_0x1bdee2(0x124)](_0xb77642,{'userId':_0x3d6b5b['id']});}const [_0x54659b,_0x18732e]=await this['chatLogEntity']['findAndCount']({'order':{'id':_0x1bdee2(0x158)},'skip':(page-0x1)*size,'take':size,'where':_0xb77642}),_0x3d2a8e=_0x54659b['map'](_0x35de92=>_0x35de92[_0x1bdee2(0x164)]),_0x570bcd=await this[_0x1bdee2(0x177)][_0x1bdee2(0x121)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3d2a8e)}}),_0x1f2434=_0x54659b[_0x1bdee2(0x150)](_0x1d3293=>{const _0x489494=_0x1bdee2,_0x27f106=_0x570bcd[_0x489494(0x121)](_0x24a8fa=>_0x24a8fa['id']===_0x1d3293['userId']);return{'username':_0x27f106?_0x27f106['username']:'','email':_0x27f106?_0x27f106['email']:'','prompt':_0x1d3293[_0x489494(0x119)],'answer':_0x1d3293[_0x489494(0x114)],'createdAt':(0x0,utils_1['formatDate'])(_0x1d3293[_0x489494(0x11d)])};}),_0x62861d=new exceljs_1['default'][(_0x1bdee2(0x129))](),_0xe60f41=_0x62861d[_0x1bdee2(0x178)](_0x1bdee2(0x116));_0xe60f41[_0x1bdee2(0x182)]=[{'header':_0x1bdee2(0x12d),'key':'username','width':0x14},{'header':_0x1bdee2(0x175),'key':_0x1bdee2(0x11f),'width':0x14},{'header':_0x1bdee2(0x13b),'key':_0x1bdee2(0x11d),'width':0x14},{'header':_0x1bdee2(0x174),'key':_0x1bdee2(0x119),'width':0x50},{'header':_0x1bdee2(0x15b),'key':_0x1bdee2(0x114),'width':0x96}],_0x1f2434['forEach'](_0x2f92d7=>_0xe60f41[_0x1bdee2(0x138)](_0x2f92d7)),_0x407414[_0x1bdee2(0x143)](_0x1bdee2(0x122),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x407414[_0x1bdee2(0x143)](_0x1bdee2(0x153),_0x1bdee2(0x12a)+_0x1bdee2(0x13e)),await _0x62861d[_0x1bdee2(0x120)][_0x1bdee2(0x169)](_0x407414),_0x407414['end']();}async[_0x341304(0x14e)](_0xd4eeee,_0x277127){const _0xa11b1f=_0x341304,{page:page=0x1,size:size=0x14,userId:_0x21ce47,prompt:_0x2526f2}=_0xd4eeee,_0x101bdd={'type':balance_constant_1[_0xa11b1f(0x181)][_0xa11b1f(0x118)],'prompt':(0x0,typeorm_2[_0xa11b1f(0x15a)])('')};_0x21ce47&&Object[_0xa11b1f(0x124)](_0x101bdd,{'userId':_0x21ce47}),_0x2526f2&&Object[_0xa11b1f(0x124)](_0x101bdd,{'prompt':(0x0,typeorm_2[_0xa11b1f(0x160)])('%'+_0x2526f2+'%')});const [_0x61bcfe,_0x3970b6]=await this[_0xa11b1f(0x148)]['findAndCount']({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x101bdd}),_0x4976f1=_0x61bcfe[_0xa11b1f(0x150)](_0x387365=>_0x387365['userId']),_0x246254=await this[_0xa11b1f(0x177)][_0xa11b1f(0x121)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4976f1)},'select':['id',_0xa11b1f(0x11a),_0xa11b1f(0x11f)]});return _0x61bcfe[_0xa11b1f(0x15f)](_0x1f4a94=>{const _0x156396=_0xa11b1f,{username:_0x25a178,email:_0x37e522}=_0x246254[_0x156396(0x121)](_0x5b1d75=>_0x5b1d75['id']===_0x1f4a94[_0x156396(0x164)])||{};_0x1f4a94[_0x156396(0x11a)]=_0x25a178,_0x1f4a94[_0x156396(0x11f)]=_0x37e522;}),_0x277127['user']['role']!=='super'&&_0x61bcfe['forEach'](_0x4c85f8=>_0x4c85f8['email']=(0x0,utils_1[_0xa11b1f(0x11e)])(_0x4c85f8[_0xa11b1f(0x11f)])),_0x61bcfe['forEach'](_0x1945c2=>{const _0x81813e=_0xa11b1f;!_0x1945c2[_0x81813e(0x11f)]&&(_0x1945c2[_0x81813e(0x11f)]=(_0x1945c2===null||_0x1945c2===void 0x0?void 0x0:_0x1945c2[_0x81813e(0x164)])+_0x81813e(0x137)),!_0x1945c2[_0x81813e(0x11a)]&&(_0x1945c2[_0x81813e(0x11a)]='游客'+(_0x1945c2===null||_0x1945c2===void 0x0?void 0x0:_0x1945c2[_0x81813e(0x164)]));}),{'rows':_0x61bcfe,'count':_0x3970b6};}async[_0x341304(0x170)](_0x592c8f,_0x3730a8){const _0x456b8e=_0x341304,{id:_0x2435ca}=_0x592c8f[_0x456b8e(0x14d)],{groupId:_0x18e385}=_0x3730a8,_0x4b6ad8={'userId':_0x2435ca,'isDelete':![]};_0x18e385&&Object[_0x456b8e(0x124)](_0x4b6ad8,{'groupId':_0x18e385});if(_0x18e385){const _0xd953ee=await this[_0x456b8e(0x152)][_0x456b8e(0x139)]({'where':{'isDelete':![]}});if(_0xd953ee===0x0)return[];}const _0x11a038=await this[_0x456b8e(0x148)][_0x456b8e(0x121)]({'where':_0x4b6ad8});return _0x11a038['map'](_0x44e62d=>{const _0x520769=_0x456b8e,{prompt:_0x469067,role:_0x37d1bb,answer:_0x3eede3,createdAt:_0x13e203,model:_0x2274e7,conversationOptions:_0x123397,requestOptions:_0x4be1ab,id:_0x4c1584,imageUrl:_0x52b84a}=_0x44e62d;let _0x5c3a3e=null,_0x3b3145=null;try{_0x5c3a3e=JSON[_0x520769(0x168)](_0x123397),_0x3b3145=JSON[_0x520769(0x168)](_0x4be1ab);}catch(_0x1777cf){}return{'chatId':_0x4c1584,'dateTime':(0x0,utils_1[_0x520769(0x112)])(_0x13e203),'text':_0x37d1bb===_0x520769(0x14d)?_0x469067:_0x3eede3,'inversion':_0x37d1bb===_0x520769(0x14d),'error':![],'conversationOptions':_0x5c3a3e,'requestOptions':_0x3b3145,'imageUrl':_0x52b84a,'model':_0x2274e7};});}async[_0x341304(0x176)](_0x13367c,_0x30f14b){const _0x5585bc=_0x341304,{id:_0x429c3f}=_0x13367c[_0x5585bc(0x14d)],{id:_0x2bd6da}=_0x30f14b,_0x32b22f=await this[_0x5585bc(0x148)]['findOne']({'where':{'id':_0x2bd6da,'userId':_0x429c3f}});if(!_0x32b22f)throw new common_1[(_0x5585bc(0x17d))](_0x5585bc(0x132),common_1[_0x5585bc(0x163)]['BAD_REQUEST']);const _0x5a8dca=await this[_0x5585bc(0x148)][_0x5585bc(0x133)]({'id':_0x2bd6da},{'isDelete':!![]});if(_0x5a8dca[_0x5585bc(0x111)]>0x0)return _0x5585bc(0x15e);else throw new common_1[(_0x5585bc(0x17d))](_0x5585bc(0x132),common_1[_0x5585bc(0x163)][_0x5585bc(0x115)]);}async[_0x341304(0x12c)](_0x5ca3fc,_0x278ae0){const _0x52ba72=_0x341304,{groupId:_0x1dc3ad}=_0x278ae0,{id:_0x2659dd}=_0x5ca3fc[_0x52ba72(0x14d)],_0x1ea91a=await this['chatGroupEntity']['findOne']({'where':{'id':_0x1dc3ad,'userId':_0x2659dd}});if(!_0x1ea91a)throw new common_1['HttpException'](_0x52ba72(0x132),common_1[_0x52ba72(0x163)]['BAD_REQUEST']);const _0x757edf=await this['chatLogEntity'][_0x52ba72(0x133)]({'groupId':_0x1dc3ad},{'isDelete':!![]});if(_0x757edf[_0x52ba72(0x111)]>0x0)return _0x52ba72(0x15e);if(_0x757edf[_0x52ba72(0x111)]===0x0)throw new common_1['HttpException']('当前页面已经没有东西可以删除了！',common_1['HttpStatus']['BAD_REQUEST']);}async[_0x341304(0x17a)](_0x2b02de,_0x474bba){const _0x18a0c3=_0x341304,{id:_0x1f2c61}=_0x2b02de[_0x18a0c3(0x14d)],{appId:_0x532421,page:page=0x1,size:size=0xa}=_0x474bba,[_0x4f964e,_0x72af63]=await this[_0x18a0c3(0x148)]['findAndCount']({'where':{'userId':_0x1f2c61,'appId':_0x532421,'role':_0x18a0c3(0x127)},'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size});return{'rows':_0x4f964e,'count':_0x72af63};}};ChatLogService=__decorate([(0x0,common_1[_0x341304(0x159)])(),__param(0x0,(0x0,typeorm_1[_0x341304(0x13a)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x341304(0x13a)])(user_entity_1[_0x341304(0x134)])),__param(0x2,(0x0,typeorm_1[_0x341304(0x13a)])(chatGroup_entity_1['ChatGroupEntity'])),__metadata(_0x341304(0x128),[typeorm_2[_0x341304(0x17f)],typeorm_2[_0x341304(0x17f)],typeorm_2['Repository']])],ChatLogService),exports[_0x341304(0x11b)]=ChatLogService;