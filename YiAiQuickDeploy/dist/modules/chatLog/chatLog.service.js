'use strict';function _0x2d3e(){const _0x4116b4=['Content-Disposition','addRow','find','38137482cdqWbW','querAllDrawLog','删除对话记录成功！','Like','tencent','Workbook','InjectRepository','parse','map','Injectable','3299385ArhTWs','__metadata','attachment;\x20filename=','formatDate','forEach','dall-e-3','assign','defineProperty','user','length','ChatLogEntity','exportExcel','columns','2778296DfwOJa','5518290UVbGlu','userId','message_id','UserEntity','extend','findAndCount','chatLogEntity','Not','HttpException','save','saveChatLog','CHAT_TYPE','2112432UYEEgH','typeorm','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','querAllChatLog','?imageView2/1/w/','1443128cfCCIR','object','end','DALL-E2','delByGroupId','ChatLogService','recDrawImg','__esModule','?x-oss-process=image/resize,w_','querAllDrawLog\x20Json\x20parse\x20error','findOne','PAINT_TYPE','createdAt','你删除的对话记录不存在、请检查！','提问问题','DeductionKey','HttpStatus','model','paintCount','userEntity','count','exceljs','metadata','@nestjs/common','回答答案','role','用户邮箱','email','answer','你推荐的图片不存在、请检查！','chatlog','ali','DESC','fileInfo','default','826116xaohMQ','prompt','当前页面已经没有东西可以删除了！','xlsx','chatList','function','chat.xlsx','thumbImg','components','Repository','__decorate','@nine.com','type','assistant','__param','addWorksheet','maskEmail','7PrPqjb','getOwnPropertyDescriptor','取消推荐','../../common/utils','../../common/constants/balance.constant','group','cos','BAD_REQUEST','./chatLog.entity','rec','includes','@nestjs/typeorm','3rXMcdX','你操作的图片不存在、请检查！','update','chatGroupEntity','setHeader','decorate','username','affected'];_0x2d3e=function(){return _0x4116b4;};return _0x2d3e();}const _0x1270e2=_0x14cf;(function(_0x17e4c2,_0x1f567f){const _0x5aa276=_0x14cf,_0x470a26=_0x17e4c2();while(!![]){try{const _0x5ea164=-parseInt(_0x5aa276(0x125))/0x1+-parseInt(_0x5aa276(0x102))/0x2+parseInt(_0x5aa276(0x142))/0x3*(-parseInt(_0x5aa276(0xf0))/0x4)+-parseInt(_0x5aa276(0xe3))/0x5+-parseInt(_0x5aa276(0xf1))/0x6*(parseInt(_0x5aa276(0x136))/0x7)+parseInt(_0x5aa276(0xfd))/0x8+parseInt(_0x5aa276(0xd9))/0x9;if(_0x5ea164===_0x1f567f)break;else _0x470a26['push'](_0x470a26['shift']());}catch(_0x2e7bf9){_0x470a26['push'](_0x470a26['shift']());}}}(_0x2d3e,0xa5f1a));var __decorate=this&&this[_0x1270e2(0x12f)]||function(_0x5dffab,_0x1d9222,_0x1452e4,_0x14ad78){const _0xd02e6c=_0x1270e2;var _0x370ce5=arguments['length'],_0x35f34c=_0x370ce5<0x3?_0x1d9222:_0x14ad78===null?_0x14ad78=Object[_0xd02e6c(0x137)](_0x1d9222,_0x1452e4):_0x14ad78,_0x5cacfc;if(typeof Reflect===_0xd02e6c(0x103)&&typeof Reflect[_0xd02e6c(0xd3)]===_0xd02e6c(0x12a))_0x35f34c=Reflect['decorate'](_0x5dffab,_0x1d9222,_0x1452e4,_0x14ad78);else{for(var _0x350831=_0x5dffab[_0xd02e6c(0xec)]-0x1;_0x350831>=0x0;_0x350831--)if(_0x5cacfc=_0x5dffab[_0x350831])_0x35f34c=(_0x370ce5<0x3?_0x5cacfc(_0x35f34c):_0x370ce5>0x3?_0x5cacfc(_0x1d9222,_0x1452e4,_0x35f34c):_0x5cacfc(_0x1d9222,_0x1452e4))||_0x35f34c;}return _0x370ce5>0x3&&_0x35f34c&&Object[_0xd02e6c(0xea)](_0x1d9222,_0x1452e4,_0x35f34c),_0x35f34c;},__metadata=this&&this[_0x1270e2(0xe4)]||function(_0xbf59dc,_0x1f36e1){const _0x12004f=_0x1270e2;if(typeof Reflect===_0x12004f(0x103)&&typeof Reflect[_0x12004f(0x118)]==='function')return Reflect['metadata'](_0xbf59dc,_0x1f36e1);},__param=this&&this[_0x1270e2(0x133)]||function(_0x210a47,_0x338dea){return function(_0x50b899,_0x20c120){_0x338dea(_0x50b899,_0x20c120,_0x210a47);};};Object[_0x1270e2(0xea)](exports,_0x1270e2(0x109),{'value':!![]}),exports[_0x1270e2(0x107)]=void 0x0;const common_1=require(_0x1270e2(0x119)),typeorm_1=require(_0x1270e2(0x141)),chatLog_entity_1=require(_0x1270e2(0x13e)),typeorm_2=require(_0x1270e2(0xfe)),balance_constant_1=require(_0x1270e2(0x13a)),user_entity_1=require('../user/user.entity'),utils_1=require(_0x1270e2(0x139)),exceljs_1=require(_0x1270e2(0x117)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity');function _0x14cf(_0x41bbba,_0x180edb){const _0x2d3e58=_0x2d3e();return _0x14cf=function(_0x14cf83,_0x46bb59){_0x14cf83=_0x14cf83-0xd3;let _0x1419e0=_0x2d3e58[_0x14cf83];return _0x1419e0;},_0x14cf(_0x41bbba,_0x180edb);}let ChatLogService=class ChatLogService{constructor(_0x40fb69,_0x45ee2e,_0x3f822f){const _0x31774d=_0x1270e2;this[_0x31774d(0xf7)]=_0x40fb69,this[_0x31774d(0x115)]=_0x45ee2e,this[_0x31774d(0x145)]=_0x3f822f;}async[_0x1270e2(0xfb)](_0x1ec914){const _0x5d143c=_0x1270e2;return await this[_0x5d143c(0xf7)][_0x5d143c(0xfa)](_0x1ec914);}async['querDrawLog'](_0x463c27,_0x27f4f2){const _0x48d184=_0x1270e2,{id:_0x4a28c2}=_0x463c27[_0x48d184(0xeb)],{model:_0x2182a6}=_0x27f4f2,_0x63f5d8={'userId':_0x4a28c2,'type':balance_constant_1[_0x48d184(0x111)]['PAINT_TYPE']};_0x2182a6&&(_0x63f5d8[_0x48d184(0x113)]=_0x2182a6,_0x2182a6===_0x48d184(0x105)&&(_0x63f5d8[_0x48d184(0x113)]=(0x0,typeorm_2['In'])([_0x48d184(0x105),'dall-e-3'])));const _0x4d4c57=await this[_0x48d184(0xf7)][_0x48d184(0xd8)]({'where':_0x63f5d8,'order':{'id':'DESC'},'select':['id','answer','prompt',_0x48d184(0xf3),_0x48d184(0x13b),_0x48d184(0x113),'extend',_0x48d184(0x131),_0x48d184(0x123)]});return _0x4d4c57[_0x48d184(0xe7)](_0x36a061=>{const _0x31d11b=_0x48d184;if(_0x36a061[_0x31d11b(0x131)]===_0x31d11b(0x114)){const _0x3e9d3b=_0x36a061[_0x31d11b(0x113)]==='mj'?0x136:0xa0,_0x2ab556=_0x36a061[_0x31d11b(0x11e)][_0x31d11b(0x140)](_0x31d11b(0x13c))?_0x31d11b(0xdd):_0x31d11b(0x121),_0x34ac22=_0x2ab556===_0x31d11b(0xdd)?'?imageView2/1/w/'+_0x3e9d3b+'/q/55':_0x31d11b(0x10a)+_0x3e9d3b;_0x36a061['thumbImg']=_0x36a061['answer']+_0x34ac22;try{_0x36a061[_0x31d11b(0x123)]=_0x36a061[_0x31d11b(0x123)]?JSON['parse'](_0x36a061['fileInfo']):null;}catch(_0x157c4d){_0x36a061[_0x31d11b(0x123)]={};}}}),_0x4d4c57;}async[_0x1270e2(0xda)](_0x266016){const _0x4137ea=_0x1270e2,{page:page=0x1,size:size=0x14,rec:_0x166cf2,userId:_0x312f82,model:_0x73aed2}=_0x266016,_0x101fcb={'type':balance_constant_1[_0x4137ea(0x111)][_0x4137ea(0x10d)],'prompt':(0x0,typeorm_2[_0x4137ea(0xf8)])(''),'answer':(0x0,typeorm_2[_0x4137ea(0xf8)])('')};_0x166cf2&&Object[_0x4137ea(0xe9)](_0x101fcb,{'rec':_0x166cf2}),_0x312f82&&Object[_0x4137ea(0xe9)](_0x101fcb,{'userId':_0x312f82});_0x73aed2&&(_0x101fcb[_0x4137ea(0x113)]=_0x73aed2,_0x73aed2===_0x4137ea(0x105)&&(_0x101fcb[_0x4137ea(0x113)]=(0x0,typeorm_2['In'])([_0x4137ea(0x105),_0x4137ea(0xe8)])));const [_0x168d90,_0x4e21d2]=await this[_0x4137ea(0xf7)]['findAndCount']({'order':{'id':_0x4137ea(0x122)},'skip':(page-0x1)*size,'take':size,'where':_0x101fcb});return _0x168d90[_0x4137ea(0xe7)](_0xc02bc0=>{const _0x41aa7c=_0x4137ea;var _0x3b8d3c;if(_0xc02bc0[_0x41aa7c(0x131)]===_0x41aa7c(0x114)){const _0x533963=_0xc02bc0[_0x41aa7c(0x113)]==='mj'?0x136:0xa0,_0x2a747b=_0xc02bc0[_0x41aa7c(0x11e)][_0x41aa7c(0x140)]('cos')?_0x41aa7c(0xdd):'ali',_0x2eace6=_0x2a747b===_0x41aa7c(0xdd)?_0x41aa7c(0x101)+_0x533963+'/q/55':_0x41aa7c(0x10a)+_0x533963;_0xc02bc0[_0x41aa7c(0x12c)]=_0xc02bc0[_0x41aa7c(0x11e)]+_0x2eace6;try{const _0x3a8181=_0xc02bc0[_0x41aa7c(0xf5)]?JSON[_0x41aa7c(0xe0)](_0xc02bc0[_0x41aa7c(0xf5)]):null;_0x3a8181&&(_0x3a8181?_0xc02bc0['isGroup']=((_0x3b8d3c=_0x3a8181===null||_0x3a8181===void 0x0?void 0x0:_0x3a8181[_0x41aa7c(0x12d)][0x0])===null||_0x3b8d3c===void 0x0?void 0x0:_0x3b8d3c[_0x41aa7c(0x12d)][_0x41aa7c(0xec)])===0x5:_0xc02bc0['isGroup']=![]);}catch(_0x28ecfb){console['log'](_0x41aa7c(0x10b),_0x28ecfb);}}}),{'rows':_0x168d90,'count':_0x4e21d2};}async[_0x1270e2(0x108)](_0x1fd64d){const _0x12eb09=_0x1270e2,{id:_0x2aab93}=_0x1fd64d,_0x180e4b=await this[_0x12eb09(0xf7)][_0x12eb09(0x10c)]({'where':{'id':_0x2aab93,'type':balance_constant_1[_0x12eb09(0x111)][_0x12eb09(0x10d)]}});if(!_0x180e4b)throw new common_1[(_0x12eb09(0xf9))](_0x12eb09(0x11f),common_1[_0x12eb09(0x112)]['BAD_REQUEST']);const _0x40e289=_0x180e4b[_0x12eb09(0x13f)]===0x1?0x0:0x1,_0x4304d1=await this['chatLogEntity'][_0x12eb09(0x144)]({'id':_0x2aab93},{'rec':_0x40e289});if(_0x4304d1[_0x12eb09(0xd5)]>0x0)return(_0x40e289?'推荐':_0x12eb09(0x138))+'图片成功！';throw new common_1[(_0x12eb09(0xf9))](_0x12eb09(0x143),common_1[_0x12eb09(0x112)][_0x12eb09(0x13d)]);}async[_0x1270e2(0xee)](_0x256e7a,_0x41ad9e){const _0x33eaba=_0x1270e2,_0x11ed61={'type':balance_constant_1[_0x33eaba(0x111)][_0x33eaba(0xfc)]},{page:page=0x1,size:size=0x1e,prompt:_0x31d121,email:_0x39c0e1}=_0x256e7a;_0x31d121&&Object[_0x33eaba(0xe9)](_0x11ed61,{'prompt':(0x0,typeorm_2[_0x33eaba(0xdc)])('%'+_0x31d121+'%')});if(_0x39c0e1){const _0xf68efa=await this[_0x33eaba(0x115)]['findOne']({'where':{'email':_0x39c0e1}});(_0xf68efa===null||_0xf68efa===void 0x0?void 0x0:_0xf68efa['id'])&&Object['assign'](_0x11ed61,{'userId':_0xf68efa['id']});}const [_0x5cf87d,_0x3c0c88]=await this[_0x33eaba(0xf7)]['findAndCount']({'order':{'id':_0x33eaba(0x122)},'skip':(page-0x1)*size,'take':size,'where':_0x11ed61}),_0x2aa5b2=_0x5cf87d['map'](_0x14d697=>_0x14d697[_0x33eaba(0xf2)]),_0x34f73b=await this['userEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x2aa5b2)}}),_0x3ec1e6=_0x5cf87d[_0x33eaba(0xe1)](_0x22e1b9=>{const _0x4c85ea=_0x33eaba,_0x31e68e=_0x34f73b[_0x4c85ea(0xd8)](_0x45582b=>_0x45582b['id']===_0x22e1b9[_0x4c85ea(0xf2)]);return{'username':_0x31e68e?_0x31e68e[_0x4c85ea(0xd4)]:'','email':_0x31e68e?_0x31e68e[_0x4c85ea(0x11d)]:'','prompt':_0x22e1b9['prompt'],'answer':_0x22e1b9[_0x4c85ea(0x11e)],'createdAt':(0x0,utils_1['formatDate'])(_0x22e1b9[_0x4c85ea(0x10e)])};}),_0x49917e=new exceljs_1[(_0x33eaba(0x124))][(_0x33eaba(0xde))](),_0x123a95=_0x49917e[_0x33eaba(0x134)](_0x33eaba(0x120));_0x123a95[_0x33eaba(0xef)]=[{'header':'用户名','key':_0x33eaba(0xd4),'width':0x14},{'header':_0x33eaba(0x11c),'key':'email','width':0x14},{'header':'提问时间','key':'createdAt','width':0x14},{'header':_0x33eaba(0x110),'key':_0x33eaba(0x126),'width':0x50},{'header':_0x33eaba(0x11a),'key':_0x33eaba(0x11e),'width':0x96}],_0x3ec1e6[_0x33eaba(0xe7)](_0x1b5782=>_0x123a95[_0x33eaba(0xd7)](_0x1b5782)),_0x41ad9e[_0x33eaba(0x146)]('Content-Type',_0x33eaba(0xff)),_0x41ad9e[_0x33eaba(0x146)](_0x33eaba(0xd6),_0x33eaba(0xe5)+_0x33eaba(0x12b)),await _0x49917e[_0x33eaba(0x128)]['write'](_0x41ad9e),_0x41ad9e[_0x33eaba(0x104)]();}async[_0x1270e2(0x100)](_0x2938ab,_0x3dea92){const _0x5860f5=_0x1270e2,{page:page=0x1,size:size=0x14,userId:_0x5b8717,prompt:_0x5aabf2}=_0x2938ab,_0xab607a={'type':balance_constant_1[_0x5860f5(0x111)][_0x5860f5(0xfc)],'prompt':(0x0,typeorm_2[_0x5860f5(0xf8)])('')};_0x5b8717&&Object[_0x5860f5(0xe9)](_0xab607a,{'userId':_0x5b8717}),_0x5aabf2&&Object[_0x5860f5(0xe9)](_0xab607a,{'prompt':(0x0,typeorm_2[_0x5860f5(0xdc)])('%'+_0x5aabf2+'%')});const [_0x1a3440,_0x24a1fc]=await this[_0x5860f5(0xf7)][_0x5860f5(0xf6)]({'order':{'id':_0x5860f5(0x122)},'skip':(page-0x1)*size,'take':size,'where':_0xab607a}),_0x3e4ae4=_0x1a3440[_0x5860f5(0xe1)](_0x13e564=>_0x13e564[_0x5860f5(0xf2)]),_0x18ceea=await this[_0x5860f5(0x115)][_0x5860f5(0xd8)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3e4ae4)},'select':['id',_0x5860f5(0xd4),'email']});return _0x1a3440[_0x5860f5(0xe7)](_0x5b121f=>{const _0x19c02a=_0x5860f5,{username:_0x3d9d9f,email:_0x60341a}=_0x18ceea[_0x19c02a(0xd8)](_0x3aeefe=>_0x3aeefe['id']===_0x5b121f[_0x19c02a(0xf2)])||{};_0x5b121f['username']=_0x3d9d9f,_0x5b121f['email']=_0x60341a;}),_0x3dea92['user'][_0x5860f5(0x11b)]!=='super'&&_0x1a3440[_0x5860f5(0xe7)](_0x3d9a00=>_0x3d9a00['email']=(0x0,utils_1[_0x5860f5(0x135)])(_0x3d9a00[_0x5860f5(0x11d)])),_0x1a3440[_0x5860f5(0xe7)](_0x3fe432=>{const _0x6ded70=_0x5860f5;!_0x3fe432[_0x6ded70(0x11d)]&&(_0x3fe432['email']=(_0x3fe432===null||_0x3fe432===void 0x0?void 0x0:_0x3fe432[_0x6ded70(0xf2)])+_0x6ded70(0x130)),!_0x3fe432[_0x6ded70(0xd4)]&&(_0x3fe432['username']='游客'+(_0x3fe432===null||_0x3fe432===void 0x0?void 0x0:_0x3fe432[_0x6ded70(0xf2)]));}),{'rows':_0x1a3440,'count':_0x24a1fc};}async[_0x1270e2(0x129)](_0x50dab6,_0x43e9fd){const _0x3be758=_0x1270e2,{id:_0x1c00ba}=_0x50dab6['user'],{groupId:_0x331e63}=_0x43e9fd,_0x2bbc3d={'userId':_0x1c00ba,'isDelete':![]};_0x331e63&&Object[_0x3be758(0xe9)](_0x2bbc3d,{'groupId':_0x331e63});if(_0x331e63){const _0xb93c27=await this['chatGroupEntity'][_0x3be758(0x116)]({'where':{'isDelete':![]}});if(_0xb93c27===0x0)return[];}const _0x16dea9=await this[_0x3be758(0xf7)][_0x3be758(0xd8)]({'where':_0x2bbc3d});return _0x16dea9['map'](_0x403aea=>{const _0x320407=_0x3be758,{prompt:_0x1d7d60,role:_0x4e9d9a,answer:_0xa439f,createdAt:_0x2f95b0,model:_0x3401ac,conversationOptions:_0x541c4a,requestOptions:_0x1b87e9,id:_0x490712,imageUrl:_0x54bbe9}=_0x403aea;let _0x549d9d=null,_0x5b4827=null;try{_0x549d9d=JSON[_0x320407(0xe0)](_0x541c4a),_0x5b4827=JSON['parse'](_0x1b87e9);}catch(_0x208d6d){}return{'chatId':_0x490712,'dateTime':(0x0,utils_1[_0x320407(0xe6)])(_0x2f95b0),'text':_0x4e9d9a===_0x320407(0xeb)?_0x1d7d60:_0xa439f,'inversion':_0x4e9d9a===_0x320407(0xeb),'error':![],'conversationOptions':_0x549d9d,'requestOptions':_0x5b4827,'imageUrl':_0x54bbe9,'model':_0x3401ac};});}async['deleteChatLog'](_0x4ace49,_0x4fa2a6){const _0x2eaa5f=_0x1270e2,{id:_0x1af02e}=_0x4ace49[_0x2eaa5f(0xeb)],{id:_0x3ebfd7}=_0x4fa2a6,_0x44715b=await this['chatLogEntity']['findOne']({'where':{'id':_0x3ebfd7,'userId':_0x1af02e}});if(!_0x44715b)throw new common_1[(_0x2eaa5f(0xf9))](_0x2eaa5f(0x10f),common_1[_0x2eaa5f(0x112)][_0x2eaa5f(0x13d)]);const _0x204209=await this[_0x2eaa5f(0xf7)][_0x2eaa5f(0x144)]({'id':_0x3ebfd7},{'isDelete':!![]});if(_0x204209[_0x2eaa5f(0xd5)]>0x0)return _0x2eaa5f(0xdb);else throw new common_1[(_0x2eaa5f(0xf9))]('你删除的对话记录不存在、请检查！',common_1[_0x2eaa5f(0x112)]['BAD_REQUEST']);}async[_0x1270e2(0x106)](_0x2d1c78,_0x144780){const _0x5ba297=_0x1270e2,{groupId:_0x3e2b8a}=_0x144780,{id:_0x24b544}=_0x2d1c78['user'],_0x5cb75b=await this['chatGroupEntity'][_0x5ba297(0x10c)]({'where':{'id':_0x3e2b8a,'userId':_0x24b544}});if(!_0x5cb75b)throw new common_1[(_0x5ba297(0xf9))](_0x5ba297(0x10f),common_1['HttpStatus'][_0x5ba297(0x13d)]);const _0x357586=await this[_0x5ba297(0xf7)][_0x5ba297(0x144)]({'groupId':_0x3e2b8a},{'isDelete':!![]});if(_0x357586['affected']>0x0)return _0x5ba297(0xdb);if(_0x357586[_0x5ba297(0xd5)]===0x0)throw new common_1[(_0x5ba297(0xf9))](_0x5ba297(0x127),common_1['HttpStatus']['BAD_REQUEST']);}async['byAppId'](_0x3f665e,_0x55865b){const _0x4e8cfd=_0x1270e2,{id:_0xf1c544}=_0x3f665e[_0x4e8cfd(0xeb)],{appId:_0x45d72d,page:page=0x1,size:size=0xa}=_0x55865b,[_0x8b7048,_0x3e2e62]=await this['chatLogEntity'][_0x4e8cfd(0xf6)]({'where':{'userId':_0xf1c544,'appId':_0x45d72d,'role':_0x4e8cfd(0x132)},'order':{'id':_0x4e8cfd(0x122)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x8b7048,'count':_0x3e2e62};}};ChatLogService=__decorate([(0x0,common_1[_0x1270e2(0xe2)])(),__param(0x0,(0x0,typeorm_1[_0x1270e2(0xdf)])(chatLog_entity_1[_0x1270e2(0xed)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x1270e2(0xf4)])),__param(0x2,(0x0,typeorm_1[_0x1270e2(0xdf)])(chatGroup_entity_1['ChatGroupEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x1270e2(0x12e)],typeorm_2[_0x1270e2(0x12e)],typeorm_2['Repository']])],ChatLogService),exports[_0x1270e2(0x107)]=ChatLogService;