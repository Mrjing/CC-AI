'use strict';const _0x460e9e=_0x2ad1;(function(_0x307475,_0x7c709d){const _0x5645a9=_0x2ad1,_0x43f2b9=_0x307475();while(!![]){try{const _0x382563=-parseInt(_0x5645a9(0x1f8))/0x1*(parseInt(_0x5645a9(0x1c2))/0x2)+-parseInt(_0x5645a9(0x1eb))/0x3+-parseInt(_0x5645a9(0x1be))/0x4*(-parseInt(_0x5645a9(0x207))/0x5)+-parseInt(_0x5645a9(0x1bb))/0x6+parseInt(_0x5645a9(0x1dc))/0x7+parseInt(_0x5645a9(0x205))/0x8*(parseInt(_0x5645a9(0x1a4))/0x9)+-parseInt(_0x5645a9(0x1db))/0xa;if(_0x382563===_0x7c709d)break;else _0x43f2b9['push'](_0x43f2b9['shift']());}catch(_0x4bd78d){_0x43f2b9['push'](_0x43f2b9['shift']());}}}(_0x5679,0xc2d49));function _0x5679(){const _0x14175d=['paintCount','email','251612tMcfpv','exceljs','Not','__metadata','8332FJTgyI','HttpStatus','你操作的图片不存在、请检查！','当前页面已经没有东西可以删除了！','update','../chatGroup/chatGroup.entity','Content-Type','prompt','model','cos','write','chatlog','affected','../../common/utils','Injectable','querAllDrawLog','answer','../../common/constants/balance.constant','formatDate','fileInfo','ChatGroupEntity','@nestjs/typeorm','用户邮箱','dall-e-3','addWorksheet','569120cmAGSG','6331094GvbNMk','DALL-E2','DESC','DeductionKey','InjectRepository','end','attachment;\x20filename=','findOne','includes','tencent','删除对话记录成功！','图片成功！','recDrawImg','thumbImg','find','1897401rgARQF','ChatLogService','deleteChatLog','message_id','findAndCount','userId','你删除的对话记录不存在、请检查！','parse','@nestjs/common','map','BAD_REQUEST','setHeader','group','127YxBOKc','isGroup','../user/user.entity','role','chatGroupEntity','object','function','/q/55','?x-oss-process=image/resize,w_','PAINT_TYPE','user','default','__param','17848qJmQkN','用户名','95hjAkQE','assign','addRow','username','metadata','取消推荐','UserEntity','__esModule','Repository','?imageView2/1/w/','HttpException','提问问题','Like','ChatLogEntity','315aHblNP','userEntity','querAllChatLog','forEach','__decorate','length','querDrawLog','chat.xlsx','exportExcel','super','chatLogEntity','ali','createdAt','components','type','columns','decorate','CHAT_TYPE','extend','design:paramtypes','byAppId','querAllDrawLog\x20Json\x20parse\x20error','log','967188hiTnmE'];_0x5679=function(){return _0x14175d;};return _0x5679();}var __decorate=this&&this[_0x460e9e(0x1a8)]||function(_0x4d39a1,_0x35d05c,_0x49814f,_0x4ca093){const _0x3ff30d=_0x460e9e;var _0x511372=arguments['length'],_0x295819=_0x511372<0x3?_0x35d05c:_0x4ca093===null?_0x4ca093=Object['getOwnPropertyDescriptor'](_0x35d05c,_0x49814f):_0x4ca093,_0x4fd9ea;if(typeof Reflect===_0x3ff30d(0x1fd)&&typeof Reflect[_0x3ff30d(0x1b4)]===_0x3ff30d(0x1fe))_0x295819=Reflect[_0x3ff30d(0x1b4)](_0x4d39a1,_0x35d05c,_0x49814f,_0x4ca093);else{for(var _0x1d9f96=_0x4d39a1[_0x3ff30d(0x1a9)]-0x1;_0x1d9f96>=0x0;_0x1d9f96--)if(_0x4fd9ea=_0x4d39a1[_0x1d9f96])_0x295819=(_0x511372<0x3?_0x4fd9ea(_0x295819):_0x511372>0x3?_0x4fd9ea(_0x35d05c,_0x49814f,_0x295819):_0x4fd9ea(_0x35d05c,_0x49814f))||_0x295819;}return _0x511372>0x3&&_0x295819&&Object['defineProperty'](_0x35d05c,_0x49814f,_0x295819),_0x295819;},__metadata=this&&this[_0x460e9e(0x1c1)]||function(_0x413ea8,_0x6f9bc7){const _0x15c7ec=_0x460e9e;if(typeof Reflect===_0x15c7ec(0x1fd)&&typeof Reflect[_0x15c7ec(0x20b)]===_0x15c7ec(0x1fe))return Reflect[_0x15c7ec(0x20b)](_0x413ea8,_0x6f9bc7);},__param=this&&this[_0x460e9e(0x204)]||function(_0x58874d,_0x2763a0){return function(_0x1b5cc1,_0x562baa){_0x2763a0(_0x1b5cc1,_0x562baa,_0x58874d);};};Object['defineProperty'](exports,_0x460e9e(0x20e),{'value':!![]}),exports['ChatLogService']=void 0x0;function _0x2ad1(_0x59c8ea,_0x2149a0){const _0x56795e=_0x5679();return _0x2ad1=function(_0x2ad115,_0x1c6dd3){_0x2ad115=_0x2ad115-0x1a2;let _0x59cd99=_0x56795e[_0x2ad115];return _0x59cd99;},_0x2ad1(_0x59c8ea,_0x2149a0);}const common_1=require(_0x460e9e(0x1f3)),typeorm_1=require(_0x460e9e(0x1d7)),chatLog_entity_1=require('./chatLog.entity'),typeorm_2=require('typeorm'),balance_constant_1=require(_0x460e9e(0x1d3)),user_entity_1=require(_0x460e9e(0x1fa)),utils_1=require(_0x460e9e(0x1cf)),exceljs_1=require(_0x460e9e(0x1bf)),chatGroup_entity_1=require(_0x460e9e(0x1c7));let ChatLogService=class ChatLogService{constructor(_0x1be945,_0x46d46f,_0xab2d70){const _0xb8997=_0x460e9e;this[_0xb8997(0x1ae)]=_0x1be945,this[_0xb8997(0x1a5)]=_0x46d46f,this[_0xb8997(0x1fc)]=_0xab2d70;}async['saveChatLog'](_0x3ed1f0){return await this['chatLogEntity']['save'](_0x3ed1f0);}async[_0x460e9e(0x1aa)](_0x30906f,_0x5dd512){const _0x456d24=_0x460e9e,{id:_0x268df0}=_0x30906f[_0x456d24(0x202)],{model:_0x5bccdf}=_0x5dd512,_0x1fa098={'userId':_0x268df0,'type':balance_constant_1[_0x456d24(0x1df)][_0x456d24(0x201)]};_0x5bccdf&&(_0x1fa098[_0x456d24(0x1ca)]=_0x5bccdf,_0x5bccdf===_0x456d24(0x1dd)&&(_0x1fa098['model']=(0x0,typeorm_2['In'])([_0x456d24(0x1dd),_0x456d24(0x1d9)])));const _0x54b197=await this[_0x456d24(0x1ae)][_0x456d24(0x1ea)]({'where':_0x1fa098,'order':{'id':_0x456d24(0x1de)},'select':['id',_0x456d24(0x1d2),_0x456d24(0x1c9),_0x456d24(0x1ee),_0x456d24(0x1f7),_0x456d24(0x1ca),_0x456d24(0x1b6),_0x456d24(0x1b2),'fileInfo']});return _0x54b197['forEach'](_0x131e23=>{const _0x1ac6d8=_0x456d24;if(_0x131e23[_0x1ac6d8(0x1b2)]===_0x1ac6d8(0x1bc)){const _0x7ccced=_0x131e23[_0x1ac6d8(0x1ca)]==='mj'?0x136:0xa0,_0x1bf4d7=_0x131e23[_0x1ac6d8(0x1d2)][_0x1ac6d8(0x1e4)]('cos')?_0x1ac6d8(0x1e5):_0x1ac6d8(0x1af),_0x1163ff=_0x1bf4d7===_0x1ac6d8(0x1e5)?_0x1ac6d8(0x210)+_0x7ccced+_0x1ac6d8(0x1ff):_0x1ac6d8(0x200)+_0x7ccced;_0x131e23[_0x1ac6d8(0x1e9)]=_0x131e23[_0x1ac6d8(0x1d2)]+_0x1163ff;try{_0x131e23['fileInfo']=_0x131e23[_0x1ac6d8(0x1d5)]?JSON[_0x1ac6d8(0x1f2)](_0x131e23[_0x1ac6d8(0x1d5)]):null;}catch(_0x59346e){_0x131e23[_0x1ac6d8(0x1d5)]={};}}}),_0x54b197;}async[_0x460e9e(0x1d1)](_0x394d20){const _0x24a746=_0x460e9e,{page:page=0x1,size:size=0x14,rec:_0x270241,userId:_0x1f565a,model:_0xffefd2}=_0x394d20,_0x244d82={'type':balance_constant_1['DeductionKey'][_0x24a746(0x201)],'prompt':(0x0,typeorm_2[_0x24a746(0x1c0)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x270241&&Object['assign'](_0x244d82,{'rec':_0x270241}),_0x1f565a&&Object[_0x24a746(0x208)](_0x244d82,{'userId':_0x1f565a});_0xffefd2&&(_0x244d82[_0x24a746(0x1ca)]=_0xffefd2,_0xffefd2===_0x24a746(0x1dd)&&(_0x244d82[_0x24a746(0x1ca)]=(0x0,typeorm_2['In'])([_0x24a746(0x1dd),'dall-e-3'])));const [_0xbc2cf9,_0x178564]=await this[_0x24a746(0x1ae)][_0x24a746(0x1ef)]({'order':{'id':_0x24a746(0x1de)},'skip':(page-0x1)*size,'take':size,'where':_0x244d82});return _0xbc2cf9['forEach'](_0x1bccde=>{const _0xacbb3=_0x24a746;var _0x41d9b7;if(_0x1bccde[_0xacbb3(0x1b2)]===_0xacbb3(0x1bc)){const _0x2d6565=_0x1bccde[_0xacbb3(0x1ca)]==='mj'?0x136:0xa0,_0x398981=_0x1bccde[_0xacbb3(0x1d2)]['includes'](_0xacbb3(0x1cb))?'tencent':'ali',_0x65e52d=_0x398981===_0xacbb3(0x1e5)?_0xacbb3(0x210)+_0x2d6565+_0xacbb3(0x1ff):_0xacbb3(0x200)+_0x2d6565;_0x1bccde['thumbImg']=_0x1bccde[_0xacbb3(0x1d2)]+_0x65e52d;try{const _0xd0d242=_0x1bccde['extend']?JSON['parse'](_0x1bccde['extend']):null;_0xd0d242&&(_0xd0d242?_0x1bccde[_0xacbb3(0x1f9)]=((_0x41d9b7=_0xd0d242===null||_0xd0d242===void 0x0?void 0x0:_0xd0d242[_0xacbb3(0x1b1)][0x0])===null||_0x41d9b7===void 0x0?void 0x0:_0x41d9b7['components']['length'])===0x5:_0x1bccde[_0xacbb3(0x1f9)]=![]);}catch(_0x275c3f){console[_0xacbb3(0x1ba)](_0xacbb3(0x1b9),_0x275c3f);}}}),{'rows':_0xbc2cf9,'count':_0x178564};}async[_0x460e9e(0x1e8)](_0x30dfc8){const _0x3a94c7=_0x460e9e,{id:_0x47b220}=_0x30dfc8,_0x44ecdc=await this[_0x3a94c7(0x1ae)][_0x3a94c7(0x1e3)]({'where':{'id':_0x47b220,'type':balance_constant_1[_0x3a94c7(0x1df)][_0x3a94c7(0x201)]}});if(!_0x44ecdc)throw new common_1[(_0x3a94c7(0x211))]('你推荐的图片不存在、请检查！',common_1[_0x3a94c7(0x1c3)][_0x3a94c7(0x1f5)]);const _0x1f4ffa=_0x44ecdc['rec']===0x1?0x0:0x1,_0x46d03d=await this[_0x3a94c7(0x1ae)][_0x3a94c7(0x1c6)]({'id':_0x47b220},{'rec':_0x1f4ffa});if(_0x46d03d[_0x3a94c7(0x1ce)]>0x0)return(_0x1f4ffa?'推荐':_0x3a94c7(0x20c))+_0x3a94c7(0x1e7);throw new common_1['HttpException'](_0x3a94c7(0x1c4),common_1['HttpStatus'][_0x3a94c7(0x1f5)]);}async[_0x460e9e(0x1ac)](_0x1df750,_0x1f83d4){const _0xa8024c=_0x460e9e,_0x1c0513={'type':balance_constant_1[_0xa8024c(0x1df)][_0xa8024c(0x1b5)]},{page:page=0x1,size:size=0x1e,prompt:_0x191c8a,email:_0x5e6864}=_0x1df750;_0x191c8a&&Object[_0xa8024c(0x208)](_0x1c0513,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x191c8a+'%')});if(_0x5e6864){const _0x3dac6f=await this[_0xa8024c(0x1a5)][_0xa8024c(0x1e3)]({'where':{'email':_0x5e6864}});(_0x3dac6f===null||_0x3dac6f===void 0x0?void 0x0:_0x3dac6f['id'])&&Object[_0xa8024c(0x208)](_0x1c0513,{'userId':_0x3dac6f['id']});}const [_0x284229,_0xeaf1b3]=await this[_0xa8024c(0x1ae)]['findAndCount']({'order':{'id':_0xa8024c(0x1de)},'skip':(page-0x1)*size,'take':size,'where':_0x1c0513}),_0x3647c3=_0x284229[_0xa8024c(0x1f4)](_0x4bcc19=>_0x4bcc19['userId']),_0x1ebb6e=await this[_0xa8024c(0x1a5)][_0xa8024c(0x1ea)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3647c3)}}),_0x274785=_0x284229[_0xa8024c(0x1f4)](_0x4c8e7e=>{const _0x5cfd8a=_0xa8024c,_0x5a321f=_0x1ebb6e['find'](_0x102218=>_0x102218['id']===_0x4c8e7e[_0x5cfd8a(0x1f0)]);return{'username':_0x5a321f?_0x5a321f['username']:'','email':_0x5a321f?_0x5a321f[_0x5cfd8a(0x1bd)]:'','prompt':_0x4c8e7e[_0x5cfd8a(0x1c9)],'answer':_0x4c8e7e[_0x5cfd8a(0x1d2)],'createdAt':(0x0,utils_1[_0x5cfd8a(0x1d4)])(_0x4c8e7e[_0x5cfd8a(0x1b0)])};}),_0x5788ab=new exceljs_1[(_0xa8024c(0x203))]['Workbook'](),_0x4e9770=_0x5788ab[_0xa8024c(0x1da)](_0xa8024c(0x1cd));_0x4e9770[_0xa8024c(0x1b3)]=[{'header':_0xa8024c(0x206),'key':_0xa8024c(0x20a),'width':0x14},{'header':_0xa8024c(0x1d8),'key':'email','width':0x14},{'header':'提问时间','key':_0xa8024c(0x1b0),'width':0x14},{'header':_0xa8024c(0x212),'key':_0xa8024c(0x1c9),'width':0x50},{'header':'回答答案','key':'answer','width':0x96}],_0x274785[_0xa8024c(0x1a7)](_0x211d6a=>_0x4e9770[_0xa8024c(0x209)](_0x211d6a)),_0x1f83d4[_0xa8024c(0x1f6)](_0xa8024c(0x1c8),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x1f83d4[_0xa8024c(0x1f6)]('Content-Disposition',_0xa8024c(0x1e2)+_0xa8024c(0x1ab)),await _0x5788ab['xlsx'][_0xa8024c(0x1cc)](_0x1f83d4),_0x1f83d4[_0xa8024c(0x1e1)]();}async[_0x460e9e(0x1a6)](_0x426bcc,_0x5a4bf9){const _0x39419f=_0x460e9e,{page:page=0x1,size:size=0x14,userId:_0x40c762,prompt:_0x5322b4}=_0x426bcc,_0x324945={'type':balance_constant_1[_0x39419f(0x1df)]['CHAT_TYPE'],'prompt':(0x0,typeorm_2[_0x39419f(0x1c0)])('')};_0x40c762&&Object[_0x39419f(0x208)](_0x324945,{'userId':_0x40c762}),_0x5322b4&&Object['assign'](_0x324945,{'prompt':(0x0,typeorm_2[_0x39419f(0x1a2)])('%'+_0x5322b4+'%')});const [_0x3a3ed4,_0x1c25d0]=await this[_0x39419f(0x1ae)]['findAndCount']({'order':{'id':_0x39419f(0x1de)},'skip':(page-0x1)*size,'take':size,'where':_0x324945}),_0x5706fe=_0x3a3ed4[_0x39419f(0x1f4)](_0x41b603=>_0x41b603[_0x39419f(0x1f0)]),_0x127e39=await this[_0x39419f(0x1a5)][_0x39419f(0x1ea)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5706fe)},'select':['id',_0x39419f(0x20a),_0x39419f(0x1bd)]});return _0x3a3ed4[_0x39419f(0x1a7)](_0x366430=>{const _0x34fdd6=_0x39419f,{username:_0x104a5e,email:_0xed142d}=_0x127e39[_0x34fdd6(0x1ea)](_0x264b62=>_0x264b62['id']===_0x366430[_0x34fdd6(0x1f0)])||{};_0x366430[_0x34fdd6(0x20a)]=_0x104a5e,_0x366430['email']=_0xed142d;}),_0x5a4bf9[_0x39419f(0x202)][_0x39419f(0x1fb)]!==_0x39419f(0x1ad)&&_0x3a3ed4[_0x39419f(0x1a7)](_0x2ab3c8=>_0x2ab3c8['email']=(0x0,utils_1['maskEmail'])(_0x2ab3c8['email'])),_0x3a3ed4[_0x39419f(0x1a7)](_0xaea359=>{const _0x5b12d2=_0x39419f;!_0xaea359[_0x5b12d2(0x1bd)]&&(_0xaea359['email']=(_0xaea359===null||_0xaea359===void 0x0?void 0x0:_0xaea359[_0x5b12d2(0x1f0)])+'@nine.com'),!_0xaea359[_0x5b12d2(0x20a)]&&(_0xaea359[_0x5b12d2(0x20a)]='游客'+(_0xaea359===null||_0xaea359===void 0x0?void 0x0:_0xaea359[_0x5b12d2(0x1f0)]));}),{'rows':_0x3a3ed4,'count':_0x1c25d0};}async['chatList'](_0x4c6541,_0x1816a6){const _0x24ccd9=_0x460e9e,{id:_0x5c34df}=_0x4c6541['user'],{groupId:_0x2c96b9}=_0x1816a6,_0x24bb0b={'userId':_0x5c34df,'isDelete':![]};_0x2c96b9&&Object['assign'](_0x24bb0b,{'groupId':_0x2c96b9});if(_0x2c96b9){const _0xf3c23=await this['chatGroupEntity']['count']({'where':{'isDelete':![]}});if(_0xf3c23===0x0)return[];}const _0x276212=await this[_0x24ccd9(0x1ae)][_0x24ccd9(0x1ea)]({'where':_0x24bb0b});return _0x276212[_0x24ccd9(0x1f4)](_0x336f20=>{const _0x324056=_0x24ccd9,{prompt:_0x3a19b1,role:_0x371ea3,answer:_0x2d1b73,createdAt:_0x409218,model:_0x1f7705,conversationOptions:_0x3f1086,requestOptions:_0x58c014,id:_0x3866d8,imageUrl:_0x47da56}=_0x336f20;let _0x6d1ede=null,_0x845b10=null;try{_0x6d1ede=JSON[_0x324056(0x1f2)](_0x3f1086),_0x845b10=JSON[_0x324056(0x1f2)](_0x58c014);}catch(_0x49b4f9){}return{'chatId':_0x3866d8,'dateTime':(0x0,utils_1['formatDate'])(_0x409218),'text':_0x371ea3==='user'?_0x3a19b1:_0x2d1b73,'inversion':_0x371ea3===_0x324056(0x202),'error':![],'conversationOptions':_0x6d1ede,'requestOptions':_0x845b10,'imageUrl':_0x47da56,'model':_0x1f7705};});}async[_0x460e9e(0x1ed)](_0x20c657,_0x3be667){const _0x5ddf51=_0x460e9e,{id:_0x10ca30}=_0x20c657[_0x5ddf51(0x202)],{id:_0xaed672}=_0x3be667,_0x25f050=await this[_0x5ddf51(0x1ae)][_0x5ddf51(0x1e3)]({'where':{'id':_0xaed672,'userId':_0x10ca30}});if(!_0x25f050)throw new common_1[(_0x5ddf51(0x211))](_0x5ddf51(0x1f1),common_1[_0x5ddf51(0x1c3)][_0x5ddf51(0x1f5)]);const _0x58b039=await this[_0x5ddf51(0x1ae)][_0x5ddf51(0x1c6)]({'id':_0xaed672},{'isDelete':!![]});if(_0x58b039[_0x5ddf51(0x1ce)]>0x0)return _0x5ddf51(0x1e6);else throw new common_1[(_0x5ddf51(0x211))](_0x5ddf51(0x1f1),common_1[_0x5ddf51(0x1c3)][_0x5ddf51(0x1f5)]);}async['delByGroupId'](_0xa1fea5,_0x5dbed3){const _0x1abb85=_0x460e9e,{groupId:_0x141a54}=_0x5dbed3,{id:_0x1582e6}=_0xa1fea5['user'],_0x3f22c2=await this[_0x1abb85(0x1fc)][_0x1abb85(0x1e3)]({'where':{'id':_0x141a54,'userId':_0x1582e6}});if(!_0x3f22c2)throw new common_1[(_0x1abb85(0x211))]('你删除的对话记录不存在、请检查！',common_1[_0x1abb85(0x1c3)][_0x1abb85(0x1f5)]);const _0x223ea5=await this[_0x1abb85(0x1ae)][_0x1abb85(0x1c6)]({'groupId':_0x141a54},{'isDelete':!![]});if(_0x223ea5[_0x1abb85(0x1ce)]>0x0)return _0x1abb85(0x1e6);if(_0x223ea5[_0x1abb85(0x1ce)]===0x0)throw new common_1[(_0x1abb85(0x211))](_0x1abb85(0x1c5),common_1[_0x1abb85(0x1c3)][_0x1abb85(0x1f5)]);}async[_0x460e9e(0x1b8)](_0x11887d,_0x1e710a){const _0x2a0d3e=_0x460e9e,{id:_0x44e66c}=_0x11887d['user'],{appId:_0x263b0c,page:page=0x1,size:size=0xa}=_0x1e710a,[_0x42fefc,_0x145565]=await this[_0x2a0d3e(0x1ae)][_0x2a0d3e(0x1ef)]({'where':{'userId':_0x44e66c,'appId':_0x263b0c,'role':'assistant'},'order':{'id':_0x2a0d3e(0x1de)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x42fefc,'count':_0x145565};}};ChatLogService=__decorate([(0x0,common_1[_0x460e9e(0x1d0)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x460e9e(0x1a3)])),__param(0x1,(0x0,typeorm_1[_0x460e9e(0x1e0)])(user_entity_1[_0x460e9e(0x20d)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x460e9e(0x1d6)])),__metadata(_0x460e9e(0x1b7),[typeorm_2['Repository'],typeorm_2[_0x460e9e(0x20f)],typeorm_2[_0x460e9e(0x20f)]])],ChatLogService),exports[_0x460e9e(0x1ec)]=ChatLogService;