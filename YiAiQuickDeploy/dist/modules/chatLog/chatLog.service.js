'use strict';const _0x421e1c=_0x295e;function _0x295e(_0x153ba8,_0x59680a){const _0x2aae1f=_0x2aae();return _0x295e=function(_0x295e04,_0xd5cfa4){_0x295e04=_0x295e04-0x14a;let _0x346bb0=_0x2aae1f[_0x295e04];return _0x346bb0;},_0x295e(_0x153ba8,_0x59680a);}(function(_0x198255,_0x3ceb13){const _0x2186b1=_0x295e,_0x500f75=_0x198255();while(!![]){try{const _0x54f3c6=parseInt(_0x2186b1(0x181))/0x1+parseInt(_0x2186b1(0x1a7))/0x2+parseInt(_0x2186b1(0x158))/0x3+-parseInt(_0x2186b1(0x182))/0x4+parseInt(_0x2186b1(0x171))/0x5+-parseInt(_0x2186b1(0x14d))/0x6*(-parseInt(_0x2186b1(0x14f))/0x7)+-parseInt(_0x2186b1(0x167))/0x8*(parseInt(_0x2186b1(0x17e))/0x9);if(_0x54f3c6===_0x3ceb13)break;else _0x500f75['push'](_0x500f75['shift']());}catch(_0x2f38c1){_0x500f75['push'](_0x500f75['shift']());}}}(_0x2aae,0xe5fb1));var __decorate=this&&this['__decorate']||function(_0x51e801,_0x291cf6,_0x1c90de,_0x22ed7b){const _0x72761d=_0x295e;var _0x472e2c=arguments[_0x72761d(0x170)],_0x3f3e8c=_0x472e2c<0x3?_0x291cf6:_0x22ed7b===null?_0x22ed7b=Object[_0x72761d(0x176)](_0x291cf6,_0x1c90de):_0x22ed7b,_0x1faab3;if(typeof Reflect===_0x72761d(0x19b)&&typeof Reflect['decorate']===_0x72761d(0x14a))_0x3f3e8c=Reflect[_0x72761d(0x16a)](_0x51e801,_0x291cf6,_0x1c90de,_0x22ed7b);else{for(var _0x15fab9=_0x51e801[_0x72761d(0x170)]-0x1;_0x15fab9>=0x0;_0x15fab9--)if(_0x1faab3=_0x51e801[_0x15fab9])_0x3f3e8c=(_0x472e2c<0x3?_0x1faab3(_0x3f3e8c):_0x472e2c>0x3?_0x1faab3(_0x291cf6,_0x1c90de,_0x3f3e8c):_0x1faab3(_0x291cf6,_0x1c90de))||_0x3f3e8c;}return _0x472e2c>0x3&&_0x3f3e8c&&Object['defineProperty'](_0x291cf6,_0x1c90de,_0x3f3e8c),_0x3f3e8c;},__metadata=this&&this['__metadata']||function(_0x29b74a,_0x472e62){const _0x472f62=_0x295e;if(typeof Reflect===_0x472f62(0x19b)&&typeof Reflect[_0x472f62(0x1af)]===_0x472f62(0x14a))return Reflect[_0x472f62(0x1af)](_0x29b74a,_0x472e62);},__param=this&&this[_0x421e1c(0x1ad)]||function(_0x5e8fc9,_0x9ede64){return function(_0x5b1973,_0x1636b1){_0x9ede64(_0x5b1973,_0x1636b1,_0x5e8fc9);};};Object[_0x421e1c(0x19c)](exports,_0x421e1c(0x191),{'value':!![]}),exports['ChatLogService']=void 0x0;const common_1=require(_0x421e1c(0x185)),typeorm_1=require('@nestjs/typeorm'),chatLog_entity_1=require(_0x421e1c(0x1a6)),typeorm_2=require('typeorm'),balance_constant_1=require(_0x421e1c(0x163)),user_entity_1=require(_0x421e1c(0x18c)),utils_1=require(_0x421e1c(0x19a)),exceljs_1=require(_0x421e1c(0x1ab)),chatGroup_entity_1=require(_0x421e1c(0x186));function _0x2aae(){const _0x4bbcd5=['update','提问时间','user','querAllDrawLog','18PuFLox','columns','你删除的对话记录不存在、请检查！','173048GpEfTZ','5986664rnnjkg','userEntity','取消推荐','@nestjs/common','../chatGroup/chatGroup.entity','@nine.com','components','exportExcel','ChatLogService','chatGroupEntity','../user/user.entity','message_id','parse','xlsx','?imageView2/1/w/','__esModule','PAINT_TYPE','forEach','Like','Repository','dall-e-3','extend','thumbImg','chatLogEntity','../../common/utils','object','defineProperty','当前页面已经没有东西可以删除了！','model','findOne','DALL-E2','回答答案','addWorksheet','write','createdAt','addRow','./chatLog.entity','308116VykNAO','Not','isGroup','answer','exceljs','cos','__param','InjectRepository','metadata','你操作的图片不存在、请检查！','BAD_REQUEST','end','attachment;\x20filename=','affected','querAllDrawLog\x20Json\x20parse\x20error','paintCount','ali','setHeader','function','CHAT_TYPE','用户邮箱','2706SzwrWI','/q/55','10171BHcLdP','用户名','删除对话记录成功！','chatList','Injectable','saveChatLog','includes','email','design:paramtypes','874863IEyLfX','type','Content-Disposition','tencent','fileInfo','username','DESC','userId','map','?x-oss-process=image/resize,w_','assistant','../../common/constants/balance.constant','chatlog','count','prompt','2483216tuVshl','assign','group','decorate','findAndCount','find','byAppId','recDrawImg','图片成功！','length','8927205TNrIlU','HttpException','role','HttpStatus','delByGroupId','getOwnPropertyDescriptor','DeductionKey','super','default'];_0x2aae=function(){return _0x4bbcd5;};return _0x2aae();}let ChatLogService=class ChatLogService{constructor(_0x49a984,_0x11dde3,_0x18f2e8){const _0x1263c3=_0x421e1c;this['chatLogEntity']=_0x49a984,this[_0x1263c3(0x183)]=_0x11dde3,this[_0x1263c3(0x18b)]=_0x18f2e8;}async[_0x421e1c(0x154)](_0x51d1f1){const _0xf5a3f0=_0x421e1c;return await this[_0xf5a3f0(0x199)]['save'](_0x51d1f1);}async['querDrawLog'](_0x51d546,_0x3eabf8){const _0x34f551=_0x421e1c,{id:_0x45ffa}=_0x51d546[_0x34f551(0x17c)],{model:_0x3e2e83}=_0x3eabf8,_0x46804f={'userId':_0x45ffa,'type':balance_constant_1[_0x34f551(0x177)][_0x34f551(0x192)]};_0x3e2e83&&(_0x46804f[_0x34f551(0x19e)]=_0x3e2e83,_0x3e2e83===_0x34f551(0x1a0)&&(_0x46804f[_0x34f551(0x19e)]=(0x0,typeorm_2['In'])(['DALL-E2','dall-e-3'])));const _0x4b1487=await this[_0x34f551(0x199)][_0x34f551(0x16c)]({'where':_0x46804f,'order':{'id':_0x34f551(0x15e)},'select':['id',_0x34f551(0x1aa),_0x34f551(0x166),_0x34f551(0x18d),_0x34f551(0x169),'model','extend','type','fileInfo']});return _0x4b1487[_0x34f551(0x193)](_0x34febb=>{const _0xb0c080=_0x34f551;if(_0x34febb[_0xb0c080(0x159)]==='paintCount'){const _0x35bc04=_0x34febb[_0xb0c080(0x19e)]==='mj'?0x136:0xa0,_0x1fa731=_0x34febb[_0xb0c080(0x1aa)][_0xb0c080(0x155)](_0xb0c080(0x1ac))?_0xb0c080(0x15b):_0xb0c080(0x1b7),_0x3ba5cb=_0x1fa731===_0xb0c080(0x15b)?_0xb0c080(0x190)+_0x35bc04+_0xb0c080(0x14e):_0xb0c080(0x161)+_0x35bc04;_0x34febb['thumbImg']=_0x34febb[_0xb0c080(0x1aa)]+_0x3ba5cb;try{_0x34febb['fileInfo']=_0x34febb[_0xb0c080(0x15c)]?JSON[_0xb0c080(0x18e)](_0x34febb[_0xb0c080(0x15c)]):null;}catch(_0x384b28){_0x34febb[_0xb0c080(0x15c)]={};}}}),_0x4b1487;}async[_0x421e1c(0x17d)](_0x3c6884){const _0x4785d3=_0x421e1c,{page:page=0x1,size:size=0x14,rec:_0x50001c,userId:_0x3187d0,model:_0x5a318d}=_0x3c6884,_0x1fd8e6={'type':balance_constant_1[_0x4785d3(0x177)]['PAINT_TYPE'],'prompt':(0x0,typeorm_2[_0x4785d3(0x1a8)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x50001c&&Object[_0x4785d3(0x168)](_0x1fd8e6,{'rec':_0x50001c}),_0x3187d0&&Object['assign'](_0x1fd8e6,{'userId':_0x3187d0});_0x5a318d&&(_0x1fd8e6[_0x4785d3(0x19e)]=_0x5a318d,_0x5a318d===_0x4785d3(0x1a0)&&(_0x1fd8e6['model']=(0x0,typeorm_2['In'])([_0x4785d3(0x1a0),_0x4785d3(0x196)])));const [_0x298a06,_0x36534b]=await this['chatLogEntity'][_0x4785d3(0x16b)]({'order':{'id':_0x4785d3(0x15e)},'skip':(page-0x1)*size,'take':size,'where':_0x1fd8e6});return _0x298a06['forEach'](_0x2ddce4=>{const _0x5eaa75=_0x4785d3;var _0x461bfe;if(_0x2ddce4[_0x5eaa75(0x159)]===_0x5eaa75(0x1b6)){const _0x344bae=_0x2ddce4['model']==='mj'?0x136:0xa0,_0x6180de=_0x2ddce4[_0x5eaa75(0x1aa)]['includes'](_0x5eaa75(0x1ac))?'tencent':_0x5eaa75(0x1b7),_0x80de1a=_0x6180de===_0x5eaa75(0x15b)?_0x5eaa75(0x190)+_0x344bae+_0x5eaa75(0x14e):_0x5eaa75(0x161)+_0x344bae;_0x2ddce4[_0x5eaa75(0x198)]=_0x2ddce4[_0x5eaa75(0x1aa)]+_0x80de1a;try{const _0x3762ad=_0x2ddce4[_0x5eaa75(0x197)]?JSON['parse'](_0x2ddce4[_0x5eaa75(0x197)]):null;_0x3762ad&&(_0x3762ad?_0x2ddce4[_0x5eaa75(0x1a9)]=((_0x461bfe=_0x3762ad===null||_0x3762ad===void 0x0?void 0x0:_0x3762ad[_0x5eaa75(0x188)][0x0])===null||_0x461bfe===void 0x0?void 0x0:_0x461bfe[_0x5eaa75(0x188)][_0x5eaa75(0x170)])===0x5:_0x2ddce4[_0x5eaa75(0x1a9)]=![]);}catch(_0x5f1baa){console['log'](_0x5eaa75(0x1b5),_0x5f1baa);}}}),{'rows':_0x298a06,'count':_0x36534b};}async[_0x421e1c(0x16e)](_0x493935){const _0x5a1e0b=_0x421e1c,{id:_0x105ef7}=_0x493935,_0x4635ae=await this[_0x5a1e0b(0x199)][_0x5a1e0b(0x19f)]({'where':{'id':_0x105ef7,'type':balance_constant_1[_0x5a1e0b(0x177)]['PAINT_TYPE']}});if(!_0x4635ae)throw new common_1[(_0x5a1e0b(0x172))]('你推荐的图片不存在、请检查！',common_1[_0x5a1e0b(0x174)][_0x5a1e0b(0x1b1)]);const _0x18aaa5=_0x4635ae['rec']===0x1?0x0:0x1,_0x29c419=await this[_0x5a1e0b(0x199)]['update']({'id':_0x105ef7},{'rec':_0x18aaa5});if(_0x29c419[_0x5a1e0b(0x1b4)]>0x0)return(_0x18aaa5?'推荐':_0x5a1e0b(0x184))+_0x5a1e0b(0x16f);throw new common_1['HttpException'](_0x5a1e0b(0x1b0),common_1[_0x5a1e0b(0x174)][_0x5a1e0b(0x1b1)]);}async[_0x421e1c(0x189)](_0x20f194,_0x1ae63d){const _0x13f796=_0x421e1c,_0xa7b20c={'type':balance_constant_1[_0x13f796(0x177)][_0x13f796(0x14b)]},{page:page=0x1,size:size=0x1e,prompt:_0x56e223,email:_0x4c1aac}=_0x20f194;_0x56e223&&Object[_0x13f796(0x168)](_0xa7b20c,{'prompt':(0x0,typeorm_2[_0x13f796(0x194)])('%'+_0x56e223+'%')});if(_0x4c1aac){const _0x236e5e=await this[_0x13f796(0x183)][_0x13f796(0x19f)]({'where':{'email':_0x4c1aac}});(_0x236e5e===null||_0x236e5e===void 0x0?void 0x0:_0x236e5e['id'])&&Object['assign'](_0xa7b20c,{'userId':_0x236e5e['id']});}const [_0x2f21ca,_0x276cef]=await this['chatLogEntity'][_0x13f796(0x16b)]({'order':{'id':_0x13f796(0x15e)},'skip':(page-0x1)*size,'take':size,'where':_0xa7b20c}),_0x33ab18=_0x2f21ca[_0x13f796(0x160)](_0x11d6cf=>_0x11d6cf[_0x13f796(0x15f)]),_0x56af82=await this[_0x13f796(0x183)][_0x13f796(0x16c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x33ab18)}}),_0x34c4a7=_0x2f21ca[_0x13f796(0x160)](_0x2adfa5=>{const _0x26f2a7=_0x13f796,_0x40e174=_0x56af82[_0x26f2a7(0x16c)](_0x1828d5=>_0x1828d5['id']===_0x2adfa5['userId']);return{'username':_0x40e174?_0x40e174[_0x26f2a7(0x15d)]:'','email':_0x40e174?_0x40e174['email']:'','prompt':_0x2adfa5[_0x26f2a7(0x166)],'answer':_0x2adfa5['answer'],'createdAt':(0x0,utils_1['formatDate'])(_0x2adfa5['createdAt'])};}),_0x1f16da=new exceljs_1[(_0x13f796(0x179))]['Workbook'](),_0x203036=_0x1f16da[_0x13f796(0x1a2)](_0x13f796(0x164));_0x203036[_0x13f796(0x17f)]=[{'header':_0x13f796(0x150),'key':_0x13f796(0x15d),'width':0x14},{'header':_0x13f796(0x14c),'key':_0x13f796(0x156),'width':0x14},{'header':_0x13f796(0x17b),'key':_0x13f796(0x1a4),'width':0x14},{'header':'提问问题','key':_0x13f796(0x166),'width':0x50},{'header':_0x13f796(0x1a1),'key':_0x13f796(0x1aa),'width':0x96}],_0x34c4a7[_0x13f796(0x193)](_0x5f3a80=>_0x203036[_0x13f796(0x1a5)](_0x5f3a80)),_0x1ae63d[_0x13f796(0x1b8)]('Content-Type','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x1ae63d[_0x13f796(0x1b8)](_0x13f796(0x15a),_0x13f796(0x1b3)+'chat.xlsx'),await _0x1f16da[_0x13f796(0x18f)][_0x13f796(0x1a3)](_0x1ae63d),_0x1ae63d[_0x13f796(0x1b2)]();}async['querAllChatLog'](_0x217cad,_0xa26f1b){const _0x2fd59f=_0x421e1c,{page:page=0x1,size:size=0x14,userId:_0x248da4,prompt:_0x38008c}=_0x217cad,_0x4e8575={'type':balance_constant_1[_0x2fd59f(0x177)][_0x2fd59f(0x14b)],'prompt':(0x0,typeorm_2[_0x2fd59f(0x1a8)])('')};_0x248da4&&Object[_0x2fd59f(0x168)](_0x4e8575,{'userId':_0x248da4}),_0x38008c&&Object[_0x2fd59f(0x168)](_0x4e8575,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x38008c+'%')});const [_0x2f7c6b,_0x5469ee]=await this['chatLogEntity'][_0x2fd59f(0x16b)]({'order':{'id':_0x2fd59f(0x15e)},'skip':(page-0x1)*size,'take':size,'where':_0x4e8575}),_0x3f650b=_0x2f7c6b['map'](_0x39a5c3=>_0x39a5c3[_0x2fd59f(0x15f)]),_0x1edcd=await this[_0x2fd59f(0x183)][_0x2fd59f(0x16c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3f650b)},'select':['id',_0x2fd59f(0x15d),_0x2fd59f(0x156)]});return _0x2f7c6b[_0x2fd59f(0x193)](_0xd32e64=>{const _0xceebaf=_0x2fd59f,{username:_0x27cbe2,email:_0x135543}=_0x1edcd[_0xceebaf(0x16c)](_0x55d1d5=>_0x55d1d5['id']===_0xd32e64[_0xceebaf(0x15f)])||{};_0xd32e64[_0xceebaf(0x15d)]=_0x27cbe2,_0xd32e64[_0xceebaf(0x156)]=_0x135543;}),_0xa26f1b['user'][_0x2fd59f(0x173)]!==_0x2fd59f(0x178)&&_0x2f7c6b[_0x2fd59f(0x193)](_0x446930=>_0x446930[_0x2fd59f(0x156)]=(0x0,utils_1['maskEmail'])(_0x446930[_0x2fd59f(0x156)])),_0x2f7c6b[_0x2fd59f(0x193)](_0x1b61af=>{const _0x5117b9=_0x2fd59f;!_0x1b61af['email']&&(_0x1b61af[_0x5117b9(0x156)]=(_0x1b61af===null||_0x1b61af===void 0x0?void 0x0:_0x1b61af[_0x5117b9(0x15f)])+_0x5117b9(0x187)),!_0x1b61af[_0x5117b9(0x15d)]&&(_0x1b61af[_0x5117b9(0x15d)]='游客'+(_0x1b61af===null||_0x1b61af===void 0x0?void 0x0:_0x1b61af[_0x5117b9(0x15f)]));}),{'rows':_0x2f7c6b,'count':_0x5469ee};}async[_0x421e1c(0x152)](_0x5a5f46,_0x351619){const _0x1a4882=_0x421e1c,{id:_0x3f55cf}=_0x5a5f46[_0x1a4882(0x17c)],{groupId:_0x324383}=_0x351619,_0x5b1af7={'userId':_0x3f55cf,'isDelete':![]};_0x324383&&Object[_0x1a4882(0x168)](_0x5b1af7,{'groupId':_0x324383});if(_0x324383){const _0x4fa7b9=await this[_0x1a4882(0x18b)][_0x1a4882(0x165)]({'where':{'isDelete':![]}});if(_0x4fa7b9===0x0)return[];}const _0x5acf8b=await this[_0x1a4882(0x199)][_0x1a4882(0x16c)]({'where':_0x5b1af7});return _0x5acf8b['map'](_0x1b19dd=>{const _0x5a1808=_0x1a4882,{prompt:_0x57b1f1,role:_0x2cbd96,answer:_0x48f3d6,createdAt:_0x2f4ef3,model:_0x2d1921,conversationOptions:_0x29222c,requestOptions:_0x7d86a9,id:_0x4e51de,imageUrl:_0x4376e5}=_0x1b19dd;let _0x3077e8=null,_0x317b3b=null;try{_0x3077e8=JSON[_0x5a1808(0x18e)](_0x29222c),_0x317b3b=JSON[_0x5a1808(0x18e)](_0x7d86a9);}catch(_0x5aadcd){}return{'chatId':_0x4e51de,'dateTime':(0x0,utils_1['formatDate'])(_0x2f4ef3),'text':_0x2cbd96===_0x5a1808(0x17c)?_0x57b1f1:_0x48f3d6,'inversion':_0x2cbd96===_0x5a1808(0x17c),'error':![],'conversationOptions':_0x3077e8,'requestOptions':_0x317b3b,'imageUrl':_0x4376e5,'model':_0x2d1921};});}async['deleteChatLog'](_0x36f48f,_0x37d9bb){const _0x1ad516=_0x421e1c,{id:_0x470b8a}=_0x36f48f[_0x1ad516(0x17c)],{id:_0x38fd03}=_0x37d9bb,_0x4e9e1c=await this['chatLogEntity'][_0x1ad516(0x19f)]({'where':{'id':_0x38fd03,'userId':_0x470b8a}});if(!_0x4e9e1c)throw new common_1[(_0x1ad516(0x172))](_0x1ad516(0x180),common_1[_0x1ad516(0x174)][_0x1ad516(0x1b1)]);const _0x16b693=await this[_0x1ad516(0x199)][_0x1ad516(0x17a)]({'id':_0x38fd03},{'isDelete':!![]});if(_0x16b693[_0x1ad516(0x1b4)]>0x0)return'删除对话记录成功！';else throw new common_1[(_0x1ad516(0x172))](_0x1ad516(0x180),common_1[_0x1ad516(0x174)]['BAD_REQUEST']);}async[_0x421e1c(0x175)](_0xf4f84a,_0x266973){const _0x49d8b7=_0x421e1c,{groupId:_0x5bfec9}=_0x266973,{id:_0x51f2a6}=_0xf4f84a[_0x49d8b7(0x17c)],_0x2824bc=await this[_0x49d8b7(0x18b)][_0x49d8b7(0x19f)]({'where':{'id':_0x5bfec9,'userId':_0x51f2a6}});if(!_0x2824bc)throw new common_1[(_0x49d8b7(0x172))](_0x49d8b7(0x180),common_1[_0x49d8b7(0x174)][_0x49d8b7(0x1b1)]);const _0x58b089=await this[_0x49d8b7(0x199)][_0x49d8b7(0x17a)]({'groupId':_0x5bfec9},{'isDelete':!![]});if(_0x58b089[_0x49d8b7(0x1b4)]>0x0)return _0x49d8b7(0x151);if(_0x58b089['affected']===0x0)throw new common_1[(_0x49d8b7(0x172))](_0x49d8b7(0x19d),common_1['HttpStatus'][_0x49d8b7(0x1b1)]);}async[_0x421e1c(0x16d)](_0x3ffd77,_0x29f795){const _0x3a0f47=_0x421e1c,{id:_0x29e582}=_0x3ffd77[_0x3a0f47(0x17c)],{appId:_0x596746,page:page=0x1,size:size=0xa}=_0x29f795,[_0x5322c1,_0x36a188]=await this['chatLogEntity']['findAndCount']({'where':{'userId':_0x29e582,'appId':_0x596746,'role':_0x3a0f47(0x162)},'order':{'id':_0x3a0f47(0x15e)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x5322c1,'count':_0x36a188};}};ChatLogService=__decorate([(0x0,common_1[_0x421e1c(0x153)])(),__param(0x0,(0x0,typeorm_1[_0x421e1c(0x1ae)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x421e1c(0x1ae)])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1[_0x421e1c(0x1ae)])(chatGroup_entity_1['ChatGroupEntity'])),__metadata(_0x421e1c(0x157),[typeorm_2[_0x421e1c(0x195)],typeorm_2[_0x421e1c(0x195)],typeorm_2[_0x421e1c(0x195)]])],ChatLogService),exports[_0x421e1c(0x18a)]=ChatLogService;