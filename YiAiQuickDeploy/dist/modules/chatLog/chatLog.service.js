'use strict';const _0x4a604c=_0x1704;(function(_0x1bdefb,_0x37ead6){const _0xed3efd=_0x1704,_0x2c8e7e=_0x1bdefb();while(!![]){try{const _0x127213=-parseInt(_0xed3efd(0x1a3))/0x1+-parseInt(_0xed3efd(0x1ae))/0x2*(parseInt(_0xed3efd(0x1d0))/0x3)+-parseInt(_0xed3efd(0x1d8))/0x4+parseInt(_0xed3efd(0x186))/0x5+parseInt(_0xed3efd(0x1e0))/0x6+parseInt(_0xed3efd(0x1e6))/0x7+-parseInt(_0xed3efd(0x1a4))/0x8;if(_0x127213===_0x37ead6)break;else _0x2c8e7e['push'](_0x2c8e7e['shift']());}catch(_0xe211da){_0x2c8e7e['push'](_0x2c8e7e['shift']());}}}(_0x5c3d,0x35b9e));var __decorate=this&&this[_0x4a604c(0x1ce)]||function(_0xec957,_0x1c3630,_0x36e3ad,_0x30ae93){const _0x4831a1=_0x4a604c;var _0x4e663c=arguments[_0x4831a1(0x1ad)],_0x11f69a=_0x4e663c<0x3?_0x1c3630:_0x30ae93===null?_0x30ae93=Object[_0x4831a1(0x1f1)](_0x1c3630,_0x36e3ad):_0x30ae93,_0x28b2a5;if(typeof Reflect===_0x4831a1(0x196)&&typeof Reflect[_0x4831a1(0x1a7)]===_0x4831a1(0x191))_0x11f69a=Reflect['decorate'](_0xec957,_0x1c3630,_0x36e3ad,_0x30ae93);else{for(var _0xa68e13=_0xec957['length']-0x1;_0xa68e13>=0x0;_0xa68e13--)if(_0x28b2a5=_0xec957[_0xa68e13])_0x11f69a=(_0x4e663c<0x3?_0x28b2a5(_0x11f69a):_0x4e663c>0x3?_0x28b2a5(_0x1c3630,_0x36e3ad,_0x11f69a):_0x28b2a5(_0x1c3630,_0x36e3ad))||_0x11f69a;}return _0x4e663c>0x3&&_0x11f69a&&Object[_0x4831a1(0x1bb)](_0x1c3630,_0x36e3ad,_0x11f69a),_0x11f69a;},__metadata=this&&this['__metadata']||function(_0x4a2ad7,_0x3865e9){const _0x488470=_0x4a604c;if(typeof Reflect===_0x488470(0x196)&&typeof Reflect[_0x488470(0x1df)]===_0x488470(0x191))return Reflect[_0x488470(0x1df)](_0x4a2ad7,_0x3865e9);},__param=this&&this['__param']||function(_0x500923,_0x553df5){return function(_0x450f24,_0x70e9b3){_0x553df5(_0x450f24,_0x70e9b3,_0x500923);};};Object[_0x4a604c(0x1bb)](exports,_0x4a604c(0x18e),{'value':!![]}),exports['ChatLogService']=void 0x0;const common_1=require(_0x4a604c(0x1e5)),typeorm_1=require(_0x4a604c(0x192)),chatLog_entity_1=require(_0x4a604c(0x1d2)),typeorm_2=require(_0x4a604c(0x1f2)),balance_constant_1=require(_0x4a604c(0x188)),user_entity_1=require(_0x4a604c(0x183)),utils_1=require(_0x4a604c(0x1d9)),exceljs_1=require(_0x4a604c(0x1f0)),chatGroup_entity_1=require(_0x4a604c(0x18a));function _0x5c3d(){const _0x1949dc=['chatGroupEntity','assign','email','metadata','742320aiTXgl','你删除的对话记录不存在、请检查！','chatLogEntity','write','HttpStatus','@nestjs/common','1922809hHzfHE','affected','ChatGroupEntity','message_id','addRow','findOne','design:paramtypes','createdAt','querAllDrawLog','Like','exceljs','getOwnPropertyDescriptor','typeorm','find','你推荐的图片不存在、请检查！','extend','querAllChatLog','../user/user.entity','Content-Disposition','HttpException','573525RQGBre','InjectRepository','../../common/constants/balance.constant','提问问题','../chatGroup/chatGroup.entity','formatDate','?x-oss-process=image/resize,w_','Workbook','__esModule','username','count','function','@nestjs/typeorm','PAINT_TYPE','super','isGroup','object','BAD_REQUEST','addWorksheet','assistant','DeductionKey','userEntity','Injectable','tencent','DESC','querAllDrawLog\x20Json\x20parse\x20error','dall-e-3','UserEntity','ChatLogService','184263NCeDFE','293096QAOHnU','columns','user','decorate','forEach','回答答案','log','answer','model','length','10aqAXPq','thumbImg','/q/55','maskEmail','saveChatLog','Content-Type','ali','CHAT_TYPE','取消推荐','fileInfo','chatList','Not','ChatLogEntity','defineProperty','?imageView2/1/w/','chat.xlsx','delByGroupId','Repository','update','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','exportExcel','parse','用户邮箱','cos','prompt','includes','userId','用户名','querDrawLog','components','end','findAndCount','__decorate','type','24474nPudMO','@nine.com','./chatLog.entity','setHeader','chatlog','提问时间','map','xlsx','125440fhvEqq','../../common/utils','DALL-E2','paintCount'];_0x5c3d=function(){return _0x1949dc;};return _0x5c3d();}let ChatLogService=class ChatLogService{constructor(_0x13a6cc,_0x413e5c,_0x2a59b7){const _0x54bf68=_0x4a604c;this['chatLogEntity']=_0x13a6cc,this[_0x54bf68(0x19b)]=_0x413e5c,this[_0x54bf68(0x1dc)]=_0x2a59b7;}async[_0x4a604c(0x1b2)](_0x1f205b){const _0x179b9c=_0x4a604c;return await this[_0x179b9c(0x1e2)]['save'](_0x1f205b);}async[_0x4a604c(0x1ca)](_0x4c7757,_0x408e43){const _0x3981df=_0x4a604c,{id:_0x3cb948}=_0x4c7757[_0x3981df(0x1a6)],{model:_0x41f86c}=_0x408e43,_0x587fb8={'userId':_0x3cb948,'type':balance_constant_1[_0x3981df(0x19a)]['PAINT_TYPE']};_0x41f86c&&(_0x587fb8[_0x3981df(0x1ac)]=_0x41f86c,_0x41f86c===_0x3981df(0x1da)&&(_0x587fb8[_0x3981df(0x1ac)]=(0x0,typeorm_2['In'])([_0x3981df(0x1da),'dall-e-3'])));const _0x26622c=await this[_0x3981df(0x1e2)][_0x3981df(0x17f)]({'where':_0x587fb8,'order':{'id':_0x3981df(0x19e)},'select':['id',_0x3981df(0x1ab),_0x3981df(0x1c6),_0x3981df(0x1e9),'group',_0x3981df(0x1ac),_0x3981df(0x181),'type',_0x3981df(0x1b7)]});return _0x26622c[_0x3981df(0x1a8)](_0x458ac6=>{const _0xeec83=_0x3981df;if(_0x458ac6[_0xeec83(0x1cf)]===_0xeec83(0x1db)){const _0x1bea0b=_0x458ac6['model']==='mj'?0x136:0xa0,_0x3cf81c=_0x458ac6[_0xeec83(0x1ab)][_0xeec83(0x1c7)](_0xeec83(0x1c5))?'tencent':_0xeec83(0x1b4),_0x37367c=_0x3cf81c===_0xeec83(0x19d)?_0xeec83(0x1bc)+_0x1bea0b+_0xeec83(0x1b0):_0xeec83(0x18c)+_0x1bea0b;_0x458ac6[_0xeec83(0x1af)]=_0x458ac6[_0xeec83(0x1ab)]+_0x37367c;try{_0x458ac6['fileInfo']=_0x458ac6['fileInfo']?JSON[_0xeec83(0x1c3)](_0x458ac6[_0xeec83(0x1b7)]):null;}catch(_0x4f7f60){_0x458ac6[_0xeec83(0x1b7)]={};}}}),_0x26622c;}async[_0x4a604c(0x1ee)](_0x1aca99){const _0x354be3=_0x4a604c,{page:page=0x1,size:size=0x14,rec:_0x340ba9,userId:_0x1b6082,model:_0x751d6a}=_0x1aca99,_0x2e767b={'type':balance_constant_1[_0x354be3(0x19a)][_0x354be3(0x193)],'prompt':(0x0,typeorm_2['Not'])(''),'answer':(0x0,typeorm_2[_0x354be3(0x1b9)])('')};_0x340ba9&&Object[_0x354be3(0x1dd)](_0x2e767b,{'rec':_0x340ba9}),_0x1b6082&&Object[_0x354be3(0x1dd)](_0x2e767b,{'userId':_0x1b6082});_0x751d6a&&(_0x2e767b[_0x354be3(0x1ac)]=_0x751d6a,_0x751d6a===_0x354be3(0x1da)&&(_0x2e767b[_0x354be3(0x1ac)]=(0x0,typeorm_2['In'])([_0x354be3(0x1da),_0x354be3(0x1a0)])));const [_0xa242fb,_0x1ffc48]=await this[_0x354be3(0x1e2)]['findAndCount']({'order':{'id':_0x354be3(0x19e)},'skip':(page-0x1)*size,'take':size,'where':_0x2e767b});return _0xa242fb[_0x354be3(0x1a8)](_0x50baf6=>{const _0x2d4266=_0x354be3;var _0x531441;if(_0x50baf6[_0x2d4266(0x1cf)]===_0x2d4266(0x1db)){const _0x241d8b=_0x50baf6[_0x2d4266(0x1ac)]==='mj'?0x136:0xa0,_0x12a30f=_0x50baf6[_0x2d4266(0x1ab)][_0x2d4266(0x1c7)]('cos')?_0x2d4266(0x19d):_0x2d4266(0x1b4),_0x12ebb5=_0x12a30f===_0x2d4266(0x19d)?'?imageView2/1/w/'+_0x241d8b+_0x2d4266(0x1b0):'?x-oss-process=image/resize,w_'+_0x241d8b;_0x50baf6[_0x2d4266(0x1af)]=_0x50baf6[_0x2d4266(0x1ab)]+_0x12ebb5;try{const _0x3333f0=_0x50baf6[_0x2d4266(0x181)]?JSON['parse'](_0x50baf6[_0x2d4266(0x181)]):null;_0x3333f0&&(_0x3333f0?_0x50baf6['isGroup']=((_0x531441=_0x3333f0===null||_0x3333f0===void 0x0?void 0x0:_0x3333f0[_0x2d4266(0x1cb)][0x0])===null||_0x531441===void 0x0?void 0x0:_0x531441[_0x2d4266(0x1cb)][_0x2d4266(0x1ad)])===0x5:_0x50baf6[_0x2d4266(0x195)]=![]);}catch(_0x16ecf4){console[_0x2d4266(0x1aa)](_0x2d4266(0x19f),_0x16ecf4);}}}),{'rows':_0xa242fb,'count':_0x1ffc48};}async['recDrawImg'](_0x3c9f94){const _0x590862=_0x4a604c,{id:_0x4abd81}=_0x3c9f94,_0x29f5e9=await this[_0x590862(0x1e2)][_0x590862(0x1eb)]({'where':{'id':_0x4abd81,'type':balance_constant_1[_0x590862(0x19a)][_0x590862(0x193)]}});if(!_0x29f5e9)throw new common_1[(_0x590862(0x185))](_0x590862(0x180),common_1['HttpStatus'][_0x590862(0x197)]);const _0x5799a4=_0x29f5e9['rec']===0x1?0x0:0x1,_0x9bd451=await this[_0x590862(0x1e2)][_0x590862(0x1c0)]({'id':_0x4abd81},{'rec':_0x5799a4});if(_0x9bd451[_0x590862(0x1e7)]>0x0)return(_0x5799a4?'推荐':_0x590862(0x1b6))+'图片成功！';throw new common_1[(_0x590862(0x185))]('你操作的图片不存在、请检查！',common_1[_0x590862(0x1e4)][_0x590862(0x197)]);}async[_0x4a604c(0x1c2)](_0x557884,_0x448bb8){const _0x1c1844=_0x4a604c,_0x2b91fc={'type':balance_constant_1['DeductionKey'][_0x1c1844(0x1b5)]},{page:page=0x1,size:size=0x1e,prompt:_0x2b7c40,email:_0x524d27}=_0x557884;_0x2b7c40&&Object[_0x1c1844(0x1dd)](_0x2b91fc,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x2b7c40+'%')});if(_0x524d27){const _0xd8a34e=await this[_0x1c1844(0x19b)]['findOne']({'where':{'email':_0x524d27}});(_0xd8a34e===null||_0xd8a34e===void 0x0?void 0x0:_0xd8a34e['id'])&&Object[_0x1c1844(0x1dd)](_0x2b91fc,{'userId':_0xd8a34e['id']});}const [_0x17967e,_0x440478]=await this[_0x1c1844(0x1e2)][_0x1c1844(0x1cd)]({'order':{'id':_0x1c1844(0x19e)},'skip':(page-0x1)*size,'take':size,'where':_0x2b91fc}),_0x286afb=_0x17967e[_0x1c1844(0x1d6)](_0x53b033=>_0x53b033[_0x1c1844(0x1c8)]),_0x97c298=await this['userEntity'][_0x1c1844(0x17f)]({'where':{'id':(0x0,typeorm_2['In'])(_0x286afb)}}),_0x214790=_0x17967e[_0x1c1844(0x1d6)](_0x3e49b1=>{const _0x914acf=_0x1c1844,_0x366c6e=_0x97c298[_0x914acf(0x17f)](_0x3a98c7=>_0x3a98c7['id']===_0x3e49b1['userId']);return{'username':_0x366c6e?_0x366c6e[_0x914acf(0x18f)]:'','email':_0x366c6e?_0x366c6e[_0x914acf(0x1de)]:'','prompt':_0x3e49b1[_0x914acf(0x1c6)],'answer':_0x3e49b1['answer'],'createdAt':(0x0,utils_1[_0x914acf(0x18b)])(_0x3e49b1[_0x914acf(0x1ed)])};}),_0x252b11=new exceljs_1['default'][(_0x1c1844(0x18d))](),_0x1e0d4f=_0x252b11[_0x1c1844(0x198)](_0x1c1844(0x1d4));_0x1e0d4f[_0x1c1844(0x1a5)]=[{'header':_0x1c1844(0x1c9),'key':_0x1c1844(0x18f),'width':0x14},{'header':_0x1c1844(0x1c4),'key':_0x1c1844(0x1de),'width':0x14},{'header':_0x1c1844(0x1d5),'key':_0x1c1844(0x1ed),'width':0x14},{'header':_0x1c1844(0x189),'key':_0x1c1844(0x1c6),'width':0x50},{'header':_0x1c1844(0x1a9),'key':'answer','width':0x96}],_0x214790[_0x1c1844(0x1a8)](_0x19390c=>_0x1e0d4f[_0x1c1844(0x1ea)](_0x19390c)),_0x448bb8[_0x1c1844(0x1d3)](_0x1c1844(0x1b3),_0x1c1844(0x1c1)),_0x448bb8['setHeader'](_0x1c1844(0x184),'attachment;\x20filename='+_0x1c1844(0x1bd)),await _0x252b11[_0x1c1844(0x1d7)][_0x1c1844(0x1e3)](_0x448bb8),_0x448bb8[_0x1c1844(0x1cc)]();}async[_0x4a604c(0x182)](_0x3ba059,_0x4a6148){const _0x797dac=_0x4a604c,{page:page=0x1,size:size=0x14,userId:_0xbf9582,prompt:_0x3b3847}=_0x3ba059,_0x2212fe={'type':balance_constant_1[_0x797dac(0x19a)][_0x797dac(0x1b5)],'prompt':(0x0,typeorm_2[_0x797dac(0x1b9)])('')};_0xbf9582&&Object[_0x797dac(0x1dd)](_0x2212fe,{'userId':_0xbf9582}),_0x3b3847&&Object[_0x797dac(0x1dd)](_0x2212fe,{'prompt':(0x0,typeorm_2[_0x797dac(0x1ef)])('%'+_0x3b3847+'%')});const [_0x52b014,_0x59b6a5]=await this[_0x797dac(0x1e2)][_0x797dac(0x1cd)]({'order':{'id':_0x797dac(0x19e)},'skip':(page-0x1)*size,'take':size,'where':_0x2212fe}),_0x46a2b1=_0x52b014[_0x797dac(0x1d6)](_0x202976=>_0x202976[_0x797dac(0x1c8)]),_0x434a56=await this[_0x797dac(0x19b)][_0x797dac(0x17f)]({'where':{'id':(0x0,typeorm_2['In'])(_0x46a2b1)},'select':['id','username',_0x797dac(0x1de)]});return _0x52b014[_0x797dac(0x1a8)](_0x413415=>{const _0x3c82d9=_0x797dac,{username:_0x334371,email:_0x549b62}=_0x434a56[_0x3c82d9(0x17f)](_0x35f6eb=>_0x35f6eb['id']===_0x413415['userId'])||{};_0x413415[_0x3c82d9(0x18f)]=_0x334371,_0x413415['email']=_0x549b62;}),_0x4a6148['user']['role']!==_0x797dac(0x194)&&_0x52b014[_0x797dac(0x1a8)](_0x1a3236=>_0x1a3236[_0x797dac(0x1de)]=(0x0,utils_1[_0x797dac(0x1b1)])(_0x1a3236[_0x797dac(0x1de)])),_0x52b014[_0x797dac(0x1a8)](_0x44140e=>{const _0x578b78=_0x797dac;!_0x44140e[_0x578b78(0x1de)]&&(_0x44140e[_0x578b78(0x1de)]=(_0x44140e===null||_0x44140e===void 0x0?void 0x0:_0x44140e[_0x578b78(0x1c8)])+_0x578b78(0x1d1)),!_0x44140e['username']&&(_0x44140e[_0x578b78(0x18f)]='游客'+(_0x44140e===null||_0x44140e===void 0x0?void 0x0:_0x44140e[_0x578b78(0x1c8)]));}),{'rows':_0x52b014,'count':_0x59b6a5};}async[_0x4a604c(0x1b8)](_0x8263eb,_0x1a75e8){const _0x21e6b0=_0x4a604c,{id:_0xfca33}=_0x8263eb[_0x21e6b0(0x1a6)],{groupId:_0x19dc00}=_0x1a75e8,_0x3831a0={'userId':_0xfca33,'isDelete':![]};_0x19dc00&&Object[_0x21e6b0(0x1dd)](_0x3831a0,{'groupId':_0x19dc00});if(_0x19dc00){const _0x4e9936=await this['chatGroupEntity'][_0x21e6b0(0x190)]({'where':{'isDelete':![]}});if(_0x4e9936===0x0)return[];}const _0x37ba8a=await this[_0x21e6b0(0x1e2)][_0x21e6b0(0x17f)]({'where':_0x3831a0});return _0x37ba8a['map'](_0x4d3b52=>{const _0xe8474d=_0x21e6b0,{prompt:_0x48d773,role:_0x2fb13a,answer:_0x1a2a92,createdAt:_0x42938d,model:_0x26747a,conversationOptions:_0xc2cf1b,requestOptions:_0xafcf91,id:_0x239173,imageUrl:_0x1c6fa9}=_0x4d3b52;let _0x5499bf=null,_0x5e76d9=null;try{_0x5499bf=JSON[_0xe8474d(0x1c3)](_0xc2cf1b),_0x5e76d9=JSON[_0xe8474d(0x1c3)](_0xafcf91);}catch(_0x121e62){}return{'chatId':_0x239173,'dateTime':(0x0,utils_1[_0xe8474d(0x18b)])(_0x42938d),'text':_0x2fb13a==='user'?_0x48d773:_0x1a2a92,'inversion':_0x2fb13a==='user','error':![],'conversationOptions':_0x5499bf,'requestOptions':_0x5e76d9,'imageUrl':_0x1c6fa9,'model':_0x26747a};});}async['deleteChatLog'](_0xd667dd,_0x11961f){const _0x54e7ea=_0x4a604c,{id:_0x24c5b7}=_0xd667dd['user'],{id:_0x126f8c}=_0x11961f,_0x4f6cbc=await this[_0x54e7ea(0x1e2)][_0x54e7ea(0x1eb)]({'where':{'id':_0x126f8c,'userId':_0x24c5b7}});if(!_0x4f6cbc)throw new common_1['HttpException']('你删除的对话记录不存在、请检查！',common_1[_0x54e7ea(0x1e4)][_0x54e7ea(0x197)]);const _0x1ebf3a=await this[_0x54e7ea(0x1e2)][_0x54e7ea(0x1c0)]({'id':_0x126f8c},{'isDelete':!![]});if(_0x1ebf3a['affected']>0x0)return'删除对话记录成功！';else throw new common_1['HttpException'](_0x54e7ea(0x1e1),common_1['HttpStatus'][_0x54e7ea(0x197)]);}async[_0x4a604c(0x1be)](_0x3a4d3f,_0x2a7e32){const _0x2add33=_0x4a604c,{groupId:_0x378436}=_0x2a7e32,{id:_0x33101b}=_0x3a4d3f[_0x2add33(0x1a6)],_0x3bccf0=await this[_0x2add33(0x1dc)]['findOne']({'where':{'id':_0x378436,'userId':_0x33101b}});if(!_0x3bccf0)throw new common_1['HttpException'](_0x2add33(0x1e1),common_1[_0x2add33(0x1e4)]['BAD_REQUEST']);const _0x34bc0e=await this[_0x2add33(0x1e2)][_0x2add33(0x1c0)]({'groupId':_0x378436},{'isDelete':!![]});if(_0x34bc0e['affected']>0x0)return'删除对话记录成功！';if(_0x34bc0e[_0x2add33(0x1e7)]===0x0)throw new common_1[(_0x2add33(0x185))]('当前页面已经没有东西可以删除了！',common_1['HttpStatus'][_0x2add33(0x197)]);}async['byAppId'](_0x3122b2,_0x17dc1b){const _0x3487a7=_0x4a604c,{id:_0x20e3be}=_0x3122b2[_0x3487a7(0x1a6)],{appId:_0x2a507f,page:page=0x1,size:size=0xa}=_0x17dc1b,[_0x386c6d,_0x4a49aa]=await this[_0x3487a7(0x1e2)][_0x3487a7(0x1cd)]({'where':{'userId':_0x20e3be,'appId':_0x2a507f,'role':_0x3487a7(0x199)},'order':{'id':_0x3487a7(0x19e)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x386c6d,'count':_0x4a49aa};}};function _0x1704(_0x3e5fa6,_0x127fef){const _0x5c3d59=_0x5c3d();return _0x1704=function(_0x17049c,_0x395562){_0x17049c=_0x17049c-0x17f;let _0x1fdfaf=_0x5c3d59[_0x17049c];return _0x1fdfaf;},_0x1704(_0x3e5fa6,_0x127fef);}ChatLogService=__decorate([(0x0,common_1[_0x4a604c(0x19c)])(),__param(0x0,(0x0,typeorm_1[_0x4a604c(0x187)])(chatLog_entity_1[_0x4a604c(0x1ba)])),__param(0x1,(0x0,typeorm_1[_0x4a604c(0x187)])(user_entity_1[_0x4a604c(0x1a1)])),__param(0x2,(0x0,typeorm_1[_0x4a604c(0x187)])(chatGroup_entity_1[_0x4a604c(0x1e8)])),__metadata(_0x4a604c(0x1ec),[typeorm_2['Repository'],typeorm_2[_0x4a604c(0x1bf)],typeorm_2[_0x4a604c(0x1bf)]])],ChatLogService),exports[_0x4a604c(0x1a2)]=ChatLogService;