'use strict';function _0x5218(){const _0x2256e4=['includes','你删除的对话记录不存在、请检查！','querAllDrawLog\x20Json\x20parse\x20error','group','删除对话记录成功！','object','chat.xlsx','__decorate','601512QuvRqE','fileInfo','formatDate','length','@nestjs/typeorm','?x-oss-process=image/resize,w_','querDrawLog','forEach','Like','../user/user.entity','?imageView2/1/w/','BAD_REQUEST','HttpStatus','userId','DALL-E2','chatList','tencent','components','typeorm','rec','addRow','__param','setHeader','email','用户邮箱','delByGroupId','Workbook','Content-Type','5990BsXLku','user','UserEntity','CHAT_TYPE','map','ali','recDrawImg','xlsx','message_id','findOne','1432195hCeUYf','find','Content-Disposition','role','chatLogEntity','model','querAllChatLog','Injectable','isGroup','ChatLogService','userEntity','exceljs','你操作的图片不存在、请检查！','byAppId','72968FuowHY','cos','attachment;\x20filename=','InjectRepository','findAndCount','getOwnPropertyDescriptor','metadata','2fzKucX','thumbImg','DESC','end','parse','DeductionKey','14542ZFDXVW','Not','assign','__esModule','19334xrUNDA','answer','createdAt','affected','1394577NWaccp','exportExcel','回答答案','/q/55','用户名','super','当前页面已经没有东西可以删除了！','提问时间','saveChatLog','../../common/constants/balance.constant','update','defineProperty','username','Repository','extend','你推荐的图片不存在、请检查！','write','querAllDrawLog','162OwuvQL','design:paramtypes','save','@nine.com','ChatGroupEntity','HttpException','type','dall-e-3','806427oegGdW','paintCount','PAINT_TYPE','prompt','4pABQYW','./chatLog.entity','chatGroupEntity','count','addWorksheet','maskEmail'];_0x5218=function(){return _0x2256e4;};return _0x5218();}const _0x2672ff=_0x42b0;(function(_0x52be13,_0x15460d){const _0x23a3a3=_0x42b0,_0xea9777=_0x52be13();while(!![]){try{const _0x49d545=parseInt(_0x23a3a3(0x149))/0x1+-parseInt(_0x23a3a3(0x150))/0x2*(parseInt(_0x23a3a3(0x178))/0x3)+parseInt(_0x23a3a3(0x17c))/0x4*(-parseInt(_0x23a3a3(0x13b))/0x5)+parseInt(_0x23a3a3(0x170))/0x6*(-parseInt(_0x23a3a3(0x15a))/0x7)+parseInt(_0x23a3a3(0x18a))/0x8+-parseInt(_0x23a3a3(0x15e))/0x9+parseInt(_0x23a3a3(0x131))/0xa*(parseInt(_0x23a3a3(0x156))/0xb);if(_0x49d545===_0x15460d)break;else _0xea9777['push'](_0xea9777['shift']());}catch(_0x28ccb7){_0xea9777['push'](_0xea9777['shift']());}}}(_0x5218,0x25e7c));function _0x42b0(_0x540b08,_0x380cd1){const _0x52181e=_0x5218();return _0x42b0=function(_0x42b0ee,_0x2c4676){_0x42b0ee=_0x42b0ee-0x128;let _0xbbe793=_0x52181e[_0x42b0ee];return _0xbbe793;},_0x42b0(_0x540b08,_0x380cd1);}var __decorate=this&&this[_0x2672ff(0x189)]||function(_0x2f4df3,_0x114ea1,_0x94e22d,_0xbdbe45){const _0x22afad=_0x2672ff;var _0x20e08f=arguments[_0x22afad(0x18d)],_0x3c6a6b=_0x20e08f<0x3?_0x114ea1:_0xbdbe45===null?_0xbdbe45=Object[_0x22afad(0x14e)](_0x114ea1,_0x94e22d):_0xbdbe45,_0x333314;if(typeof Reflect===_0x22afad(0x187)&&typeof Reflect['decorate']==='function')_0x3c6a6b=Reflect['decorate'](_0x2f4df3,_0x114ea1,_0x94e22d,_0xbdbe45);else{for(var _0x5996c5=_0x2f4df3['length']-0x1;_0x5996c5>=0x0;_0x5996c5--)if(_0x333314=_0x2f4df3[_0x5996c5])_0x3c6a6b=(_0x20e08f<0x3?_0x333314(_0x3c6a6b):_0x20e08f>0x3?_0x333314(_0x114ea1,_0x94e22d,_0x3c6a6b):_0x333314(_0x114ea1,_0x94e22d))||_0x3c6a6b;}return _0x20e08f>0x3&&_0x3c6a6b&&Object[_0x22afad(0x169)](_0x114ea1,_0x94e22d,_0x3c6a6b),_0x3c6a6b;},__metadata=this&&this['__metadata']||function(_0x392b0c,_0x1c0a31){const _0x34a6ad=_0x2672ff;if(typeof Reflect===_0x34a6ad(0x187)&&typeof Reflect[_0x34a6ad(0x14f)]==='function')return Reflect['metadata'](_0x392b0c,_0x1c0a31);},__param=this&&this[_0x2672ff(0x12a)]||function(_0x2546cb,_0x60e2f){return function(_0x26db9d,_0x3f3718){_0x60e2f(_0x26db9d,_0x3f3718,_0x2546cb);};};Object[_0x2672ff(0x169)](exports,_0x2672ff(0x159),{'value':!![]}),exports[_0x2672ff(0x144)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x2672ff(0x18e)),chatLog_entity_1=require(_0x2672ff(0x17d)),typeorm_2=require(_0x2672ff(0x19c)),balance_constant_1=require(_0x2672ff(0x167)),user_entity_1=require(_0x2672ff(0x193)),utils_1=require('../../common/utils'),exceljs_1=require(_0x2672ff(0x146)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity');let ChatLogService=class ChatLogService{constructor(_0x22f01a,_0x5788cc,_0x50c1ac){const _0x3451f8=_0x2672ff;this[_0x3451f8(0x13f)]=_0x22f01a,this[_0x3451f8(0x145)]=_0x5788cc,this[_0x3451f8(0x17e)]=_0x50c1ac;}async[_0x2672ff(0x166)](_0x37eb13){const _0x1362f7=_0x2672ff;return await this[_0x1362f7(0x13f)][_0x1362f7(0x172)](_0x37eb13);}async[_0x2672ff(0x190)](_0x5ceade,_0x5177b8){const _0x4a77f6=_0x2672ff,{id:_0x4252dd}=_0x5ceade[_0x4a77f6(0x132)],{model:_0x44407d}=_0x5177b8,_0x1bbac8={'userId':_0x4252dd,'type':balance_constant_1['DeductionKey'][_0x4a77f6(0x17a)]};_0x44407d&&(_0x1bbac8[_0x4a77f6(0x140)]=_0x44407d,_0x44407d===_0x4a77f6(0x198)&&(_0x1bbac8[_0x4a77f6(0x140)]=(0x0,typeorm_2['In'])([_0x4a77f6(0x198),_0x4a77f6(0x177)])));const _0xf1f156=await this[_0x4a77f6(0x13f)]['find']({'where':_0x1bbac8,'order':{'id':'DESC'},'select':['id',_0x4a77f6(0x15b),_0x4a77f6(0x17b),_0x4a77f6(0x139),_0x4a77f6(0x185),_0x4a77f6(0x140),_0x4a77f6(0x16c),_0x4a77f6(0x176),_0x4a77f6(0x18b)]});return _0xf1f156['forEach'](_0x1c6850=>{const _0x4c3d70=_0x4a77f6;if(_0x1c6850[_0x4c3d70(0x176)]===_0x4c3d70(0x179)){const _0x4801c1=_0x1c6850[_0x4c3d70(0x140)]==='mj'?0x136:0xa0,_0x5f5492=_0x1c6850[_0x4c3d70(0x15b)][_0x4c3d70(0x182)](_0x4c3d70(0x14a))?'tencent':_0x4c3d70(0x136),_0x4d2258=_0x5f5492==='tencent'?_0x4c3d70(0x194)+_0x4801c1+_0x4c3d70(0x161):_0x4c3d70(0x18f)+_0x4801c1;_0x1c6850[_0x4c3d70(0x151)]=_0x1c6850[_0x4c3d70(0x15b)]+_0x4d2258;try{_0x1c6850[_0x4c3d70(0x18b)]=_0x1c6850['fileInfo']?JSON[_0x4c3d70(0x154)](_0x1c6850[_0x4c3d70(0x18b)]):null;}catch(_0xd8532c){_0x1c6850[_0x4c3d70(0x18b)]={};}}}),_0xf1f156;}async[_0x2672ff(0x16f)](_0x12b5ba){const _0x1fc051=_0x2672ff,{page:page=0x1,size:size=0x14,rec:_0x550661,userId:_0xfc8f22,model:_0x5817c0}=_0x12b5ba,_0x1468e6={'type':balance_constant_1['DeductionKey'][_0x1fc051(0x17a)],'prompt':(0x0,typeorm_2[_0x1fc051(0x157)])(''),'answer':(0x0,typeorm_2[_0x1fc051(0x157)])('')};_0x550661&&Object[_0x1fc051(0x158)](_0x1468e6,{'rec':_0x550661}),_0xfc8f22&&Object[_0x1fc051(0x158)](_0x1468e6,{'userId':_0xfc8f22});_0x5817c0&&(_0x1468e6[_0x1fc051(0x140)]=_0x5817c0,_0x5817c0===_0x1fc051(0x198)&&(_0x1468e6['model']=(0x0,typeorm_2['In'])([_0x1fc051(0x198),_0x1fc051(0x177)])));const [_0xcfea4d,_0x159a8a]=await this[_0x1fc051(0x13f)][_0x1fc051(0x14d)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x1468e6});return _0xcfea4d[_0x1fc051(0x191)](_0x5bde1=>{const _0x4e7230=_0x1fc051;var _0x28392d;if(_0x5bde1[_0x4e7230(0x176)]===_0x4e7230(0x179)){const _0x14da63=_0x5bde1[_0x4e7230(0x140)]==='mj'?0x136:0xa0,_0x1648c3=_0x5bde1[_0x4e7230(0x15b)][_0x4e7230(0x182)](_0x4e7230(0x14a))?'tencent':'ali',_0x45ab99=_0x1648c3===_0x4e7230(0x19a)?_0x4e7230(0x194)+_0x14da63+_0x4e7230(0x161):_0x4e7230(0x18f)+_0x14da63;_0x5bde1[_0x4e7230(0x151)]=_0x5bde1[_0x4e7230(0x15b)]+_0x45ab99;try{const _0xd1b37f=_0x5bde1[_0x4e7230(0x16c)]?JSON['parse'](_0x5bde1['extend']):null;_0xd1b37f&&(_0xd1b37f?_0x5bde1['isGroup']=((_0x28392d=_0xd1b37f===null||_0xd1b37f===void 0x0?void 0x0:_0xd1b37f[_0x4e7230(0x19b)][0x0])===null||_0x28392d===void 0x0?void 0x0:_0x28392d[_0x4e7230(0x19b)][_0x4e7230(0x18d)])===0x5:_0x5bde1[_0x4e7230(0x143)]=![]);}catch(_0x3dd31e){console['log'](_0x4e7230(0x184),_0x3dd31e);}}}),{'rows':_0xcfea4d,'count':_0x159a8a};}async[_0x2672ff(0x137)](_0x4ba5e4){const _0x4f63e8=_0x2672ff,{id:_0xef0529}=_0x4ba5e4,_0x15a11d=await this['chatLogEntity']['findOne']({'where':{'id':_0xef0529,'type':balance_constant_1[_0x4f63e8(0x155)]['PAINT_TYPE']}});if(!_0x15a11d)throw new common_1[(_0x4f63e8(0x175))](_0x4f63e8(0x16d),common_1[_0x4f63e8(0x196)]['BAD_REQUEST']);const _0xf3d46b=_0x15a11d[_0x4f63e8(0x128)]===0x1?0x0:0x1,_0x11ca01=await this[_0x4f63e8(0x13f)][_0x4f63e8(0x168)]({'id':_0xef0529},{'rec':_0xf3d46b});if(_0x11ca01['affected']>0x0)return(_0xf3d46b?'推荐':'取消推荐')+'图片成功！';throw new common_1[(_0x4f63e8(0x175))](_0x4f63e8(0x147),common_1[_0x4f63e8(0x196)]['BAD_REQUEST']);}async[_0x2672ff(0x15f)](_0x2094d6,_0x89a382){const _0x867466=_0x2672ff,_0xa487db={'type':balance_constant_1['DeductionKey'][_0x867466(0x134)]},{page:page=0x1,size:size=0x1e,prompt:_0x196b67,email:_0x49f6f3}=_0x2094d6;_0x196b67&&Object['assign'](_0xa487db,{'prompt':(0x0,typeorm_2[_0x867466(0x192)])('%'+_0x196b67+'%')});if(_0x49f6f3){const _0x2f6b1c=await this[_0x867466(0x145)][_0x867466(0x13a)]({'where':{'email':_0x49f6f3}});(_0x2f6b1c===null||_0x2f6b1c===void 0x0?void 0x0:_0x2f6b1c['id'])&&Object[_0x867466(0x158)](_0xa487db,{'userId':_0x2f6b1c['id']});}const [_0x1df9f9,_0x2ec304]=await this[_0x867466(0x13f)][_0x867466(0x14d)]({'order':{'id':_0x867466(0x152)},'skip':(page-0x1)*size,'take':size,'where':_0xa487db}),_0x1c760b=_0x1df9f9[_0x867466(0x135)](_0x2b495b=>_0x2b495b[_0x867466(0x197)]),_0x11b77b=await this[_0x867466(0x145)][_0x867466(0x13c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1c760b)}}),_0x3b8035=_0x1df9f9[_0x867466(0x135)](_0x1eb819=>{const _0x580e66=_0x867466,_0x1d39bd=_0x11b77b[_0x580e66(0x13c)](_0x1fba9a=>_0x1fba9a['id']===_0x1eb819[_0x580e66(0x197)]);return{'username':_0x1d39bd?_0x1d39bd[_0x580e66(0x16a)]:'','email':_0x1d39bd?_0x1d39bd[_0x580e66(0x12c)]:'','prompt':_0x1eb819['prompt'],'answer':_0x1eb819[_0x580e66(0x15b)],'createdAt':(0x0,utils_1[_0x580e66(0x18c)])(_0x1eb819['createdAt'])};}),_0x23076f=new exceljs_1['default'][(_0x867466(0x12f))](),_0x4977db=_0x23076f[_0x867466(0x180)]('chatlog');_0x4977db['columns']=[{'header':_0x867466(0x162),'key':'username','width':0x14},{'header':_0x867466(0x12d),'key':_0x867466(0x12c),'width':0x14},{'header':_0x867466(0x165),'key':_0x867466(0x15c),'width':0x14},{'header':'提问问题','key':_0x867466(0x17b),'width':0x50},{'header':_0x867466(0x160),'key':_0x867466(0x15b),'width':0x96}],_0x3b8035['forEach'](_0x50df4d=>_0x4977db[_0x867466(0x129)](_0x50df4d)),_0x89a382[_0x867466(0x12b)](_0x867466(0x130),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x89a382[_0x867466(0x12b)](_0x867466(0x13d),_0x867466(0x14b)+_0x867466(0x188)),await _0x23076f[_0x867466(0x138)][_0x867466(0x16e)](_0x89a382),_0x89a382[_0x867466(0x153)]();}async[_0x2672ff(0x141)](_0x196dcc,_0x2c4acb){const _0x2798df=_0x2672ff,{page:page=0x1,size:size=0x14,userId:_0x23384a,prompt:_0x4de822}=_0x196dcc,_0xea2d7e={'type':balance_constant_1[_0x2798df(0x155)][_0x2798df(0x134)],'prompt':(0x0,typeorm_2['Not'])('')};_0x23384a&&Object[_0x2798df(0x158)](_0xea2d7e,{'userId':_0x23384a}),_0x4de822&&Object[_0x2798df(0x158)](_0xea2d7e,{'prompt':(0x0,typeorm_2[_0x2798df(0x192)])('%'+_0x4de822+'%')});const [_0x42eebd,_0x1f6726]=await this['chatLogEntity']['findAndCount']({'order':{'id':_0x2798df(0x152)},'skip':(page-0x1)*size,'take':size,'where':_0xea2d7e}),_0x524d80=_0x42eebd['map'](_0x5f2987=>_0x5f2987[_0x2798df(0x197)]),_0x2ed811=await this[_0x2798df(0x145)][_0x2798df(0x13c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x524d80)},'select':['id',_0x2798df(0x16a),_0x2798df(0x12c)]});return _0x42eebd[_0x2798df(0x191)](_0x1de017=>{const _0x3f51ba=_0x2798df,{username:_0x409dc0,email:_0x9cc1d4}=_0x2ed811[_0x3f51ba(0x13c)](_0x4485b9=>_0x4485b9['id']===_0x1de017[_0x3f51ba(0x197)])||{};_0x1de017[_0x3f51ba(0x16a)]=_0x409dc0,_0x1de017['email']=_0x9cc1d4;}),_0x2c4acb['user'][_0x2798df(0x13e)]!==_0x2798df(0x163)&&_0x42eebd['forEach'](_0x46b14d=>_0x46b14d[_0x2798df(0x12c)]=(0x0,utils_1[_0x2798df(0x181)])(_0x46b14d[_0x2798df(0x12c)])),_0x42eebd[_0x2798df(0x191)](_0x499cee=>{const _0x11bf17=_0x2798df;!_0x499cee[_0x11bf17(0x12c)]&&(_0x499cee['email']=(_0x499cee===null||_0x499cee===void 0x0?void 0x0:_0x499cee[_0x11bf17(0x197)])+_0x11bf17(0x173)),!_0x499cee[_0x11bf17(0x16a)]&&(_0x499cee[_0x11bf17(0x16a)]='游客'+(_0x499cee===null||_0x499cee===void 0x0?void 0x0:_0x499cee[_0x11bf17(0x197)]));}),{'rows':_0x42eebd,'count':_0x1f6726};}async[_0x2672ff(0x199)](_0x42856f,_0x28809a){const _0x560ba5=_0x2672ff,{id:_0x2aa2b9}=_0x42856f[_0x560ba5(0x132)],{groupId:_0x544813}=_0x28809a,_0x208558={'userId':_0x2aa2b9,'isDelete':![]};_0x544813&&Object['assign'](_0x208558,{'groupId':_0x544813});if(_0x544813){const _0x4f6f8b=await this[_0x560ba5(0x17e)][_0x560ba5(0x17f)]({'where':{'isDelete':![]}});if(_0x4f6f8b===0x0)return[];}const _0x10da64=await this['chatLogEntity'][_0x560ba5(0x13c)]({'where':_0x208558});return _0x10da64[_0x560ba5(0x135)](_0x5c0b1b=>{const _0x5636fe=_0x560ba5,{prompt:_0x4aed5d,role:_0x500dc5,answer:_0x35726e,createdAt:_0x51791e,model:_0x1d38b2,conversationOptions:_0x5084bd,requestOptions:_0x1fa116,id:_0x354ccb,imageUrl:_0x1452c9}=_0x5c0b1b;let _0x11ee53=null,_0x40c6c7=null;try{_0x11ee53=JSON[_0x5636fe(0x154)](_0x5084bd),_0x40c6c7=JSON[_0x5636fe(0x154)](_0x1fa116);}catch(_0x4c23ef){}return{'chatId':_0x354ccb,'dateTime':(0x0,utils_1['formatDate'])(_0x51791e),'text':_0x500dc5===_0x5636fe(0x132)?_0x4aed5d:_0x35726e,'inversion':_0x500dc5==='user','error':![],'conversationOptions':_0x11ee53,'requestOptions':_0x40c6c7,'imageUrl':_0x1452c9,'model':_0x1d38b2};});}async['deleteChatLog'](_0x50cb34,_0x57c988){const _0x13c6f2=_0x2672ff,{id:_0x52fca5}=_0x50cb34['user'],{id:_0x1f1bb1}=_0x57c988,_0x35392c=await this['chatLogEntity']['findOne']({'where':{'id':_0x1f1bb1,'userId':_0x52fca5}});if(!_0x35392c)throw new common_1['HttpException']('你删除的对话记录不存在、请检查！',common_1['HttpStatus'][_0x13c6f2(0x195)]);const _0x244b5e=await this[_0x13c6f2(0x13f)][_0x13c6f2(0x168)]({'id':_0x1f1bb1},{'isDelete':!![]});if(_0x244b5e[_0x13c6f2(0x15d)]>0x0)return _0x13c6f2(0x186);else throw new common_1[(_0x13c6f2(0x175))](_0x13c6f2(0x183),common_1[_0x13c6f2(0x196)][_0x13c6f2(0x195)]);}async[_0x2672ff(0x12e)](_0x573594,_0x5075f0){const _0x4a8cb8=_0x2672ff,{groupId:_0x45a427}=_0x5075f0,{id:_0x2c67de}=_0x573594['user'],_0x1713e6=await this['chatGroupEntity'][_0x4a8cb8(0x13a)]({'where':{'id':_0x45a427,'userId':_0x2c67de}});if(!_0x1713e6)throw new common_1[(_0x4a8cb8(0x175))](_0x4a8cb8(0x183),common_1['HttpStatus'][_0x4a8cb8(0x195)]);const _0x42a372=await this['chatLogEntity']['update']({'groupId':_0x45a427},{'isDelete':!![]});if(_0x42a372[_0x4a8cb8(0x15d)]>0x0)return _0x4a8cb8(0x186);if(_0x42a372[_0x4a8cb8(0x15d)]===0x0)throw new common_1[(_0x4a8cb8(0x175))](_0x4a8cb8(0x164),common_1['HttpStatus'][_0x4a8cb8(0x195)]);}async[_0x2672ff(0x148)](_0x47650e,_0x426ff2){const _0x4922a2=_0x2672ff,{id:_0x2b15e8}=_0x47650e['user'],{appId:_0x12971a,page:page=0x1,size:size=0xa}=_0x426ff2,[_0x5e49ca,_0x186c9e]=await this[_0x4922a2(0x13f)][_0x4922a2(0x14d)]({'where':{'userId':_0x2b15e8,'appId':_0x12971a,'role':'assistant'},'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size});return{'rows':_0x5e49ca,'count':_0x186c9e};}};ChatLogService=__decorate([(0x0,common_1[_0x2672ff(0x142)])(),__param(0x0,(0x0,typeorm_1[_0x2672ff(0x14c)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x2672ff(0x133)])),__param(0x2,(0x0,typeorm_1[_0x2672ff(0x14c)])(chatGroup_entity_1[_0x2672ff(0x174)])),__metadata(_0x2672ff(0x171),[typeorm_2[_0x2672ff(0x16b)],typeorm_2[_0x2672ff(0x16b)],typeorm_2[_0x2672ff(0x16b)]])],ChatLogService),exports[_0x2672ff(0x144)]=ChatLogService;