'use strict';function _0x3869(_0x22aade,_0x45a824){const _0x3691ea=_0x3691();return _0x3869=function(_0x3869e8,_0x299c82){_0x3869e8=_0x3869e8-0x1f4;let _0x40ee2=_0x3691ea[_0x3869e8];return _0x40ee2;},_0x3869(_0x22aade,_0x45a824);}const _0x5f0e73=_0x3869;function _0x3691(){const _0xd7e7b0=['find','count','Injectable','dall-e-3','15603540zMyqls','metadata','save','components','DeductionKey','tencent','isGroup','ali','delByGroupId','你推荐的图片不存在、请检查！','cos','fileInfo','chat.xlsx','5035360WALQnk','answer','Content-Disposition','type','136852iewlvA','../chatGroup/chatGroup.entity','HttpException','attachment;\x20filename=','18gUXvvb','../../common/utils','map','503845ZNyZBv','log','__param','Like','username','xlsx','57ESYLuP','affected','ChatLogEntity','querAllDrawLog\x20Json\x20parse\x20error','提问问题','assistant','删除对话记录成功！','Not','thumbImg','52232GpiSGs','getOwnPropertyDescriptor','addRow','回答答案','InjectRepository','design:paramtypes','PAINT_TYPE','role','?x-oss-process=image/resize,w_','chatLogEntity','defineProperty','Workbook','model','exportExcel','querAllChatLog','decorate','group','300598BSenAi','/q/55','findOne','exceljs','你删除的对话记录不存在、请检查！','ChatLogService','forEach','__metadata','length','byAppId','CHAT_TYPE','recDrawImg','91QwijNF','default','prompt','userEntity','DESC','Repository','DALL-E2','@nine.com','typeorm','parse','@nestjs/typeorm','rec','用户名','取消推荐','setHeader','HttpStatus','20bYMCzv','5GuWIux','createdAt','formatDate','ChatGroupEntity','findAndCount','saveChatLog','user','626103GPZLCQ','assign','BAD_REQUEST','super','email','chatList','function','object','update','用户邮箱','querDrawLog','columns','../user/user.entity','extend','chatGroupEntity','userId'];_0x3691=function(){return _0xd7e7b0;};return _0x3691();}(function(_0x10e221,_0x3e183e){const _0x9ede95=_0x3869,_0x316163=_0x10e221();while(!![]){try{const _0x3058c6=parseInt(_0x9ede95(0x24d))/0x1*(-parseInt(_0x9ede95(0x230))/0x2)+-parseInt(_0x9ede95(0x216))/0x3*(parseInt(_0x9ede95(0x209))/0x4)+-parseInt(_0x9ede95(0x210))/0x5*(-parseInt(_0x9ede95(0x20d))/0x6)+parseInt(_0x9ede95(0x23c))/0x7*(-parseInt(_0x9ede95(0x21f))/0x8)+-parseInt(_0x9ede95(0x254))/0x9*(parseInt(_0x9ede95(0x24c))/0xa)+parseInt(_0x9ede95(0x205))/0xb+parseInt(_0x9ede95(0x1f8))/0xc;if(_0x3058c6===_0x3e183e)break;else _0x316163['push'](_0x316163['shift']());}catch(_0x3371d1){_0x316163['push'](_0x316163['shift']());}}}(_0x3691,0x6a279));var __decorate=this&&this['__decorate']||function(_0x4499a0,_0x57d5ba,_0x126a77,_0x52c291){const _0x14d6a6=_0x3869;var _0x3e50e1=arguments['length'],_0x424208=_0x3e50e1<0x3?_0x57d5ba:_0x52c291===null?_0x52c291=Object[_0x14d6a6(0x220)](_0x57d5ba,_0x126a77):_0x52c291,_0x1032d4;if(typeof Reflect===_0x14d6a6(0x25b)&&typeof Reflect['decorate']==='function')_0x424208=Reflect[_0x14d6a6(0x22e)](_0x4499a0,_0x57d5ba,_0x126a77,_0x52c291);else{for(var _0x38959a=_0x4499a0[_0x14d6a6(0x238)]-0x1;_0x38959a>=0x0;_0x38959a--)if(_0x1032d4=_0x4499a0[_0x38959a])_0x424208=(_0x3e50e1<0x3?_0x1032d4(_0x424208):_0x3e50e1>0x3?_0x1032d4(_0x57d5ba,_0x126a77,_0x424208):_0x1032d4(_0x57d5ba,_0x126a77))||_0x424208;}return _0x3e50e1>0x3&&_0x424208&&Object[_0x14d6a6(0x229)](_0x57d5ba,_0x126a77,_0x424208),_0x424208;},__metadata=this&&this[_0x5f0e73(0x237)]||function(_0x4f821b,_0x57194c){const _0x2cf52f=_0x5f0e73;if(typeof Reflect===_0x2cf52f(0x25b)&&typeof Reflect[_0x2cf52f(0x1f9)]===_0x2cf52f(0x25a))return Reflect['metadata'](_0x4f821b,_0x57194c);},__param=this&&this[_0x5f0e73(0x212)]||function(_0x14318e,_0x4fb6fd){return function(_0x442557,_0x523edd){_0x4fb6fd(_0x442557,_0x523edd,_0x14318e);};};Object[_0x5f0e73(0x229)](exports,'__esModule',{'value':!![]}),exports[_0x5f0e73(0x235)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x5f0e73(0x246)),chatLog_entity_1=require('./chatLog.entity'),typeorm_2=require(_0x5f0e73(0x244)),balance_constant_1=require('../../common/constants/balance.constant'),user_entity_1=require(_0x5f0e73(0x260)),utils_1=require(_0x5f0e73(0x20e)),exceljs_1=require(_0x5f0e73(0x233)),chatGroup_entity_1=require(_0x5f0e73(0x20a));let ChatLogService=class ChatLogService{constructor(_0x13dd6b,_0x338f00,_0x484d54){const _0x3948f7=_0x5f0e73;this[_0x3948f7(0x228)]=_0x13dd6b,this[_0x3948f7(0x23f)]=_0x338f00,this[_0x3948f7(0x262)]=_0x484d54;}async[_0x5f0e73(0x252)](_0x160de1){const _0x4bb6c2=_0x5f0e73;return await this[_0x4bb6c2(0x228)][_0x4bb6c2(0x1fa)](_0x160de1);}async[_0x5f0e73(0x25e)](_0x5e4932,_0x19d67e){const _0xc1c90f=_0x5f0e73,{id:_0x176dbd}=_0x5e4932[_0xc1c90f(0x253)],{model:_0x2a2cce}=_0x19d67e,_0x5ddd3f={'userId':_0x176dbd,'type':balance_constant_1['DeductionKey'][_0xc1c90f(0x225)]};_0x2a2cce&&(_0x5ddd3f[_0xc1c90f(0x22b)]=_0x2a2cce,_0x2a2cce===_0xc1c90f(0x242)&&(_0x5ddd3f[_0xc1c90f(0x22b)]=(0x0,typeorm_2['In'])(['DALL-E2',_0xc1c90f(0x1f7)])));const _0x1ee0f2=await this[_0xc1c90f(0x228)][_0xc1c90f(0x1f4)]({'where':_0x5ddd3f,'order':{'id':_0xc1c90f(0x240)},'select':['id',_0xc1c90f(0x206),'prompt','message_id',_0xc1c90f(0x22f),'model','extend',_0xc1c90f(0x208),_0xc1c90f(0x203)]});return _0x1ee0f2[_0xc1c90f(0x236)](_0x4d12a3=>{const _0x52459d=_0xc1c90f;if(_0x4d12a3[_0x52459d(0x208)]==='paintCount'){const _0x1cd061=_0x4d12a3['model']==='mj'?0x136:0xa0,_0x270514=_0x4d12a3[_0x52459d(0x206)]['includes']('cos')?'tencent':_0x52459d(0x1ff),_0x2fea31=_0x270514===_0x52459d(0x1fd)?'?imageView2/1/w/'+_0x1cd061+_0x52459d(0x231):_0x52459d(0x227)+_0x1cd061;_0x4d12a3[_0x52459d(0x21e)]=_0x4d12a3[_0x52459d(0x206)]+_0x2fea31;try{_0x4d12a3[_0x52459d(0x203)]=_0x4d12a3[_0x52459d(0x203)]?JSON[_0x52459d(0x245)](_0x4d12a3['fileInfo']):null;}catch(_0x184367){_0x4d12a3[_0x52459d(0x203)]={};}}}),_0x1ee0f2;}async['querAllDrawLog'](_0x5caa57){const _0x277175=_0x5f0e73,{page:page=0x1,size:size=0x14,rec:_0x5f14cb,userId:_0x1ab16d,model:_0x2b4208}=_0x5caa57,_0x2e774d={'type':balance_constant_1[_0x277175(0x1fc)][_0x277175(0x225)],'prompt':(0x0,typeorm_2[_0x277175(0x21d)])(''),'answer':(0x0,typeorm_2[_0x277175(0x21d)])('')};_0x5f14cb&&Object[_0x277175(0x255)](_0x2e774d,{'rec':_0x5f14cb}),_0x1ab16d&&Object['assign'](_0x2e774d,{'userId':_0x1ab16d});_0x2b4208&&(_0x2e774d[_0x277175(0x22b)]=_0x2b4208,_0x2b4208===_0x277175(0x242)&&(_0x2e774d['model']=(0x0,typeorm_2['In'])(['DALL-E2',_0x277175(0x1f7)])));const [_0x2b81a3,_0x2a60aa]=await this[_0x277175(0x228)][_0x277175(0x251)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x2e774d});return _0x2b81a3[_0x277175(0x236)](_0x18137f=>{const _0x4f4d7e=_0x277175;var _0x3af70c;if(_0x18137f[_0x4f4d7e(0x208)]==='paintCount'){const _0x1505ee=_0x18137f['model']==='mj'?0x136:0xa0,_0x507364=_0x18137f[_0x4f4d7e(0x206)]['includes'](_0x4f4d7e(0x202))?_0x4f4d7e(0x1fd):_0x4f4d7e(0x1ff),_0x3095e5=_0x507364==='tencent'?'?imageView2/1/w/'+_0x1505ee+_0x4f4d7e(0x231):_0x4f4d7e(0x227)+_0x1505ee;_0x18137f[_0x4f4d7e(0x21e)]=_0x18137f[_0x4f4d7e(0x206)]+_0x3095e5;try{const _0x6e5675=_0x18137f[_0x4f4d7e(0x261)]?JSON[_0x4f4d7e(0x245)](_0x18137f[_0x4f4d7e(0x261)]):null;_0x6e5675&&(_0x6e5675?_0x18137f[_0x4f4d7e(0x1fe)]=((_0x3af70c=_0x6e5675===null||_0x6e5675===void 0x0?void 0x0:_0x6e5675[_0x4f4d7e(0x1fb)][0x0])===null||_0x3af70c===void 0x0?void 0x0:_0x3af70c[_0x4f4d7e(0x1fb)][_0x4f4d7e(0x238)])===0x5:_0x18137f['isGroup']=![]);}catch(_0x41638c){console[_0x4f4d7e(0x211)](_0x4f4d7e(0x219),_0x41638c);}}}),{'rows':_0x2b81a3,'count':_0x2a60aa};}async[_0x5f0e73(0x23b)](_0x413833){const _0xa823db=_0x5f0e73,{id:_0x1532a3}=_0x413833,_0xe41450=await this[_0xa823db(0x228)][_0xa823db(0x232)]({'where':{'id':_0x1532a3,'type':balance_constant_1['DeductionKey'][_0xa823db(0x225)]}});if(!_0xe41450)throw new common_1[(_0xa823db(0x20b))](_0xa823db(0x201),common_1[_0xa823db(0x24b)][_0xa823db(0x256)]);const _0x2b5ee7=_0xe41450[_0xa823db(0x247)]===0x1?0x0:0x1,_0x5a8d71=await this[_0xa823db(0x228)][_0xa823db(0x25c)]({'id':_0x1532a3},{'rec':_0x2b5ee7});if(_0x5a8d71[_0xa823db(0x217)]>0x0)return(_0x2b5ee7?'推荐':_0xa823db(0x249))+'图片成功！';throw new common_1['HttpException']('你操作的图片不存在、请检查！',common_1[_0xa823db(0x24b)]['BAD_REQUEST']);}async[_0x5f0e73(0x22c)](_0x19470e,_0x10fa78){const _0x106b8c=_0x5f0e73,_0x2d0c14={'type':balance_constant_1[_0x106b8c(0x1fc)]['CHAT_TYPE']},{page:page=0x1,size:size=0x1e,prompt:_0x3cca0c,email:_0x16a37c}=_0x19470e;_0x3cca0c&&Object[_0x106b8c(0x255)](_0x2d0c14,{'prompt':(0x0,typeorm_2[_0x106b8c(0x213)])('%'+_0x3cca0c+'%')});if(_0x16a37c){const _0x2933c3=await this['userEntity'][_0x106b8c(0x232)]({'where':{'email':_0x16a37c}});(_0x2933c3===null||_0x2933c3===void 0x0?void 0x0:_0x2933c3['id'])&&Object[_0x106b8c(0x255)](_0x2d0c14,{'userId':_0x2933c3['id']});}const [_0x477577,_0x152274]=await this[_0x106b8c(0x228)][_0x106b8c(0x251)]({'order':{'id':_0x106b8c(0x240)},'skip':(page-0x1)*size,'take':size,'where':_0x2d0c14}),_0x502d9b=_0x477577[_0x106b8c(0x20f)](_0x4c60a4=>_0x4c60a4['userId']),_0x1e995a=await this['userEntity'][_0x106b8c(0x1f4)]({'where':{'id':(0x0,typeorm_2['In'])(_0x502d9b)}}),_0x27afbc=_0x477577[_0x106b8c(0x20f)](_0x40ba4f=>{const _0x4ab7f7=_0x106b8c,_0x484b2d=_0x1e995a[_0x4ab7f7(0x1f4)](_0x26f276=>_0x26f276['id']===_0x40ba4f['userId']);return{'username':_0x484b2d?_0x484b2d[_0x4ab7f7(0x214)]:'','email':_0x484b2d?_0x484b2d['email']:'','prompt':_0x40ba4f[_0x4ab7f7(0x23e)],'answer':_0x40ba4f[_0x4ab7f7(0x206)],'createdAt':(0x0,utils_1[_0x4ab7f7(0x24f)])(_0x40ba4f['createdAt'])};}),_0x18f306=new exceljs_1[(_0x106b8c(0x23d))][(_0x106b8c(0x22a))](),_0x5e2504=_0x18f306['addWorksheet']('chatlog');_0x5e2504[_0x106b8c(0x25f)]=[{'header':_0x106b8c(0x248),'key':_0x106b8c(0x214),'width':0x14},{'header':_0x106b8c(0x25d),'key':'email','width':0x14},{'header':'提问时间','key':_0x106b8c(0x24e),'width':0x14},{'header':_0x106b8c(0x21a),'key':_0x106b8c(0x23e),'width':0x50},{'header':_0x106b8c(0x222),'key':_0x106b8c(0x206),'width':0x96}],_0x27afbc['forEach'](_0x5da424=>_0x5e2504[_0x106b8c(0x221)](_0x5da424)),_0x10fa78[_0x106b8c(0x24a)]('Content-Type','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x10fa78[_0x106b8c(0x24a)](_0x106b8c(0x207),_0x106b8c(0x20c)+_0x106b8c(0x204)),await _0x18f306[_0x106b8c(0x215)]['write'](_0x10fa78),_0x10fa78['end']();}async[_0x5f0e73(0x22d)](_0x5f163d,_0x7bff22){const _0x2d58df=_0x5f0e73,{page:page=0x1,size:size=0x14,userId:_0x54f972,prompt:_0x39eb25}=_0x5f163d,_0x1f2b64={'type':balance_constant_1[_0x2d58df(0x1fc)][_0x2d58df(0x23a)],'prompt':(0x0,typeorm_2[_0x2d58df(0x21d)])('')};_0x54f972&&Object[_0x2d58df(0x255)](_0x1f2b64,{'userId':_0x54f972}),_0x39eb25&&Object[_0x2d58df(0x255)](_0x1f2b64,{'prompt':(0x0,typeorm_2[_0x2d58df(0x213)])('%'+_0x39eb25+'%')});const [_0x4d3cec,_0x48a9c1]=await this[_0x2d58df(0x228)][_0x2d58df(0x251)]({'order':{'id':_0x2d58df(0x240)},'skip':(page-0x1)*size,'take':size,'where':_0x1f2b64}),_0x25f150=_0x4d3cec[_0x2d58df(0x20f)](_0x15ed7c=>_0x15ed7c[_0x2d58df(0x263)]),_0x3a8934=await this[_0x2d58df(0x23f)][_0x2d58df(0x1f4)]({'where':{'id':(0x0,typeorm_2['In'])(_0x25f150)},'select':['id',_0x2d58df(0x214),_0x2d58df(0x258)]});return _0x4d3cec['forEach'](_0xd5992d=>{const _0x5a0bf3=_0x2d58df,{username:_0xd0bde3,email:_0x50b9a0}=_0x3a8934[_0x5a0bf3(0x1f4)](_0xf20d5c=>_0xf20d5c['id']===_0xd5992d[_0x5a0bf3(0x263)])||{};_0xd5992d[_0x5a0bf3(0x214)]=_0xd0bde3,_0xd5992d[_0x5a0bf3(0x258)]=_0x50b9a0;}),_0x7bff22[_0x2d58df(0x253)][_0x2d58df(0x226)]!==_0x2d58df(0x257)&&_0x4d3cec[_0x2d58df(0x236)](_0xfc7349=>_0xfc7349['email']=(0x0,utils_1['maskEmail'])(_0xfc7349[_0x2d58df(0x258)])),_0x4d3cec[_0x2d58df(0x236)](_0x28cb7a=>{const _0x23ad8e=_0x2d58df;!_0x28cb7a[_0x23ad8e(0x258)]&&(_0x28cb7a['email']=(_0x28cb7a===null||_0x28cb7a===void 0x0?void 0x0:_0x28cb7a[_0x23ad8e(0x263)])+_0x23ad8e(0x243)),!_0x28cb7a['username']&&(_0x28cb7a[_0x23ad8e(0x214)]='游客'+(_0x28cb7a===null||_0x28cb7a===void 0x0?void 0x0:_0x28cb7a[_0x23ad8e(0x263)]));}),{'rows':_0x4d3cec,'count':_0x48a9c1};}async[_0x5f0e73(0x259)](_0x48208b,_0x4b146b){const _0x304684=_0x5f0e73,{id:_0x34a6ff}=_0x48208b['user'],{groupId:_0xca6b1d}=_0x4b146b,_0x30d492={'userId':_0x34a6ff,'isDelete':![]};_0xca6b1d&&Object[_0x304684(0x255)](_0x30d492,{'groupId':_0xca6b1d});if(_0xca6b1d){const _0x37af5c=await this['chatGroupEntity'][_0x304684(0x1f5)]({'where':{'isDelete':![]}});if(_0x37af5c===0x0)return[];}const _0x16357b=await this[_0x304684(0x228)][_0x304684(0x1f4)]({'where':_0x30d492});return _0x16357b[_0x304684(0x20f)](_0x4bff80=>{const _0x3c1a28=_0x304684,{prompt:_0x49ce07,role:_0x41d9e9,answer:_0x83a8f0,createdAt:_0x36233a,model:_0x3a41e8,conversationOptions:_0x1b82bf,requestOptions:_0x35adfa,id:_0x767921,imageUrl:_0x5ad244}=_0x4bff80;let _0xd85eeb=null,_0x3df41b=null;try{_0xd85eeb=JSON[_0x3c1a28(0x245)](_0x1b82bf),_0x3df41b=JSON[_0x3c1a28(0x245)](_0x35adfa);}catch(_0x43bcb4){}return{'chatId':_0x767921,'dateTime':(0x0,utils_1[_0x3c1a28(0x24f)])(_0x36233a),'text':_0x41d9e9===_0x3c1a28(0x253)?_0x49ce07:_0x83a8f0,'inversion':_0x41d9e9===_0x3c1a28(0x253),'error':![],'conversationOptions':_0xd85eeb,'requestOptions':_0x3df41b,'imageUrl':_0x5ad244,'model':_0x3a41e8};});}async['deleteChatLog'](_0x43a446,_0xa7512c){const _0x49cdbc=_0x5f0e73,{id:_0x3df70b}=_0x43a446[_0x49cdbc(0x253)],{id:_0x49878a}=_0xa7512c,_0x827cff=await this[_0x49cdbc(0x228)][_0x49cdbc(0x232)]({'where':{'id':_0x49878a,'userId':_0x3df70b}});if(!_0x827cff)throw new common_1[(_0x49cdbc(0x20b))](_0x49cdbc(0x234),common_1[_0x49cdbc(0x24b)][_0x49cdbc(0x256)]);const _0x20ab5b=await this[_0x49cdbc(0x228)][_0x49cdbc(0x25c)]({'id':_0x49878a},{'isDelete':!![]});if(_0x20ab5b[_0x49cdbc(0x217)]>0x0)return _0x49cdbc(0x21c);else throw new common_1[(_0x49cdbc(0x20b))]('你删除的对话记录不存在、请检查！',common_1[_0x49cdbc(0x24b)][_0x49cdbc(0x256)]);}async[_0x5f0e73(0x200)](_0x522cb8,_0x18606a){const _0x9ae892=_0x5f0e73,{groupId:_0x22a3d4}=_0x18606a,{id:_0xb176dc}=_0x522cb8[_0x9ae892(0x253)],_0x4b54b6=await this['chatGroupEntity'][_0x9ae892(0x232)]({'where':{'id':_0x22a3d4,'userId':_0xb176dc}});if(!_0x4b54b6)throw new common_1[(_0x9ae892(0x20b))](_0x9ae892(0x234),common_1[_0x9ae892(0x24b)][_0x9ae892(0x256)]);const _0x5cf49e=await this[_0x9ae892(0x228)][_0x9ae892(0x25c)]({'groupId':_0x22a3d4},{'isDelete':!![]});if(_0x5cf49e[_0x9ae892(0x217)]>0x0)return'删除对话记录成功！';if(_0x5cf49e['affected']===0x0)throw new common_1[(_0x9ae892(0x20b))]('当前页面已经没有东西可以删除了！',common_1[_0x9ae892(0x24b)]['BAD_REQUEST']);}async[_0x5f0e73(0x239)](_0x5c23a2,_0x5677db){const _0x139e6f=_0x5f0e73,{id:_0x1aea58}=_0x5c23a2[_0x139e6f(0x253)],{appId:_0x93a48b,page:page=0x1,size:size=0xa}=_0x5677db,[_0x2e8ecf,_0x28871a]=await this[_0x139e6f(0x228)][_0x139e6f(0x251)]({'where':{'userId':_0x1aea58,'appId':_0x93a48b,'role':_0x139e6f(0x21b)},'order':{'id':_0x139e6f(0x240)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x2e8ecf,'count':_0x28871a};}};ChatLogService=__decorate([(0x0,common_1[_0x5f0e73(0x1f6)])(),__param(0x0,(0x0,typeorm_1[_0x5f0e73(0x223)])(chatLog_entity_1[_0x5f0e73(0x218)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1[_0x5f0e73(0x223)])(chatGroup_entity_1[_0x5f0e73(0x250)])),__metadata(_0x5f0e73(0x224),[typeorm_2[_0x5f0e73(0x241)],typeorm_2[_0x5f0e73(0x241)],typeorm_2['Repository']])],ChatLogService),exports[_0x5f0e73(0x235)]=ChatLogService;