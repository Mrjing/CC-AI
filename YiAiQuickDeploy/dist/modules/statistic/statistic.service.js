'use strict';const _0x480483=_0x4c8f;(function(_0x195683,_0x4fe35a){const _0x542dfd=_0x4c8f,_0x3c09ea=_0x195683();while(!![]){try{const _0x122541=-parseInt(_0x542dfd(0x149))/0x1*(parseInt(_0x542dfd(0x135))/0x2)+parseInt(_0x542dfd(0x171))/0x3*(-parseInt(_0x542dfd(0x16e))/0x4)+-parseInt(_0x542dfd(0x15d))/0x5*(parseInt(_0x542dfd(0x133))/0x6)+-parseInt(_0x542dfd(0x146))/0x7*(-parseInt(_0x542dfd(0x166))/0x8)+parseInt(_0x542dfd(0x199))/0x9+-parseInt(_0x542dfd(0x162))/0xa*(parseInt(_0x542dfd(0x16b))/0xb)+parseInt(_0x542dfd(0x14d))/0xc*(parseInt(_0x542dfd(0x132))/0xd);if(_0x122541===_0x4fe35a)break;else _0x3c09ea['push'](_0x3c09ea['shift']());}catch(_0x26de1a){_0x3c09ea['push'](_0x3c09ea['shift']());}}}(_0x3ec5,0x3f8c4));var __decorate=this&&this[_0x480483(0x163)]||function(_0x4d2097,_0x17200f,_0x3cfe68,_0x45acb4){const _0x20e9a8=_0x480483;var _0x2ef359=arguments[_0x20e9a8(0x18b)],_0x49dcb1=_0x2ef359<0x3?_0x17200f:_0x45acb4===null?_0x45acb4=Object[_0x20e9a8(0x17b)](_0x17200f,_0x3cfe68):_0x45acb4,_0x193ccf;if(typeof Reflect===_0x20e9a8(0x136)&&typeof Reflect[_0x20e9a8(0x19c)]===_0x20e9a8(0x17f))_0x49dcb1=Reflect[_0x20e9a8(0x19c)](_0x4d2097,_0x17200f,_0x3cfe68,_0x45acb4);else{for(var _0x1bee88=_0x4d2097[_0x20e9a8(0x18b)]-0x1;_0x1bee88>=0x0;_0x1bee88--)if(_0x193ccf=_0x4d2097[_0x1bee88])_0x49dcb1=(_0x2ef359<0x3?_0x193ccf(_0x49dcb1):_0x2ef359>0x3?_0x193ccf(_0x17200f,_0x3cfe68,_0x49dcb1):_0x193ccf(_0x17200f,_0x3cfe68))||_0x49dcb1;}return _0x2ef359>0x3&&_0x49dcb1&&Object[_0x20e9a8(0x19f)](_0x17200f,_0x3cfe68,_0x49dcb1),_0x49dcb1;},__metadata=this&&this[_0x480483(0x188)]||function(_0x171dff,_0x179eaa){const _0x556893=_0x480483;if(typeof Reflect===_0x556893(0x136)&&typeof Reflect[_0x556893(0x14a)]===_0x556893(0x17f))return Reflect[_0x556893(0x14a)](_0x171dff,_0x179eaa);},__param=this&&this[_0x480483(0x155)]||function(_0x4bf7cd,_0x9c2c8d){return function(_0x2e4b77,_0x306da2){_0x9c2c8d(_0x2e4b77,_0x306da2,_0x4bf7cd);};};Object['defineProperty'](exports,_0x480483(0x150),{'value':!![]}),exports[_0x480483(0x143)]=void 0x0;function _0x3ec5(){const _0x4a47b7=['chatLog.createdAt\x20>=\x20:today','YYYYMMDD','8189VLLqEI','metadata','countChats','push','11172kyreZa','get','getRawMany','__esModule','typeorm','请先配置百度统计accessToken','DeductionKey','getBaseStatistic','__param','groupBy','OrderEntity','setHours','../chatLog/chatLog.entity','MidjourneyStatusEnum','midjourneyEntity','map','35jywZRq','HttpStatus','formatDate','default','&start_date=','140CvISLr','__decorate','orderEntity','BAD_REQUEST','464yhBhkG','midjourney','user','CHAT_TYPE','countUsers','22231HmcWpd','getBaiduStatistics','userEntity','148484PRHBBn','chatlog.type\x20=\x20:type','../../common/utils/date','21GUAvAF','countNewMidhourneysToday','../user/user.entity','setDate','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','getDate','&method=','countNewChatsToday','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','UserEntity','getOwnPropertyDescriptor','chatlog','now','Injectable','function','midjourney.createdAt\x20>=\x20:startDate','value','chatLogEntity','@nestjs/common','../../common/constants/balance.constant','百度授权码过期','Repository','MidjourneyEntity','__metadata','configVal','axios','length','order.createdAt\x20>=\x20:today','ConfigEntity','chatLog','overview/getTimeTrendRpt','date','select','chatlog.createdAt\x20>=\x20:startDate','where','countOrders','@nestjs/typeorm','orderBy','countDraws','midjourney.createdAt\x20<\x20:tomorrow','2308833LnbECZ','getCount','HttpException','decorate','order','getTime','defineProperty','&end_date=','chatLog.type\x20=\x20:type','user.createdAt\x20>=\x20:today','getBaiduVisit','baiduToken','data','configKey','andWhere','configEntity','PAINT_TYPE','baiduSiteId','midjourney.status\x20=\x20:status','countNewOrdersToday','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','5473UxwhmW','105714sbYRkK','../midjourney/midjourney.entity','28dLpcNL','object','countNewDrawsToday','chatLog.createdAt\x20<\x20:tomorrow','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','createQueryBuilder','count','countDrawsByTimeRange','获取百度统计数据失败','countChatsByTimeRange','getChatStatistic','../order/order.entity','countMjDrawsByTimeRange','order.createdAt\x20<\x20:tomorrow','StatisticService','InjectRepository','find','16646adGPUk'];_0x3ec5=function(){return _0x4a47b7;};return _0x3ec5();}const common_1=require(_0x480483(0x183)),typeorm_1=require(_0x480483(0x195)),user_entity_1=require(_0x480483(0x173)),typeorm_2=require(_0x480483(0x151)),chatLog_entity_1=require(_0x480483(0x159)),balance_constant_1=require(_0x480483(0x184)),date_1=require(_0x480483(0x170)),axios_1=require(_0x480483(0x18a)),config_entity_1=require('../globalConfig/config.entity'),order_entity_1=require(_0x480483(0x140)),midjourney_entity_1=require(_0x480483(0x134)),midjourney_constant_1=require('../../common/constants/midjourney.constant');let StatisticService=class StatisticService{constructor(_0x39712e,_0x4feab3,_0x525068,_0xcf3c35,_0x37152a){const _0x24d801=_0x480483;this[_0x24d801(0x16d)]=_0x39712e,this['chatLogEntity']=_0x4feab3,this['configEntity']=_0x525068,this[_0x24d801(0x164)]=_0xcf3c35,this[_0x24d801(0x15b)]=_0x37152a;}async[_0x480483(0x154)](){const _0x4c88ff=_0x480483,_0x1ad016=await this[_0x4c88ff(0x16a)](),_0x2dff4c=await this['countNewUsersToday'](),_0x45e8f4=await this[_0x4c88ff(0x14b)](),_0x34a03e=await this[_0x4c88ff(0x178)](),_0x511f6f=await this[_0x4c88ff(0x197)](),_0x39b180=await this[_0x4c88ff(0x137)](),_0x4e783a=await this['countNewMidhourneysToday'](),_0xadd2e3=await this['countOrders'](),_0x36de03=await this[_0x4c88ff(0x1ac)]();return{'userCount':_0x1ad016,'newUserCount':_0x2dff4c,'chatCount':_0x45e8f4,'newChatCount':_0x34a03e,'drawCount':_0x511f6f,'newDrawCount':_0x4e783a+_0x39b180,'orderCount':_0xadd2e3,'newOrderCount':_0x36de03};}async[_0x480483(0x13f)]({days:days=0x7}){const _0x2be168=_0x480483,_0x42625c=await this['countChatsByTimeRange'](days),_0x1d2783=await this[_0x2be168(0x13c)](days),_0x3bb378=await this[_0x2be168(0x141)](days);return{'date':_0x42625c['map'](_0x55900e=>_0x55900e[_0x2be168(0x190)]),'chat':_0x42625c[_0x2be168(0x15c)](_0x2462e6=>_0x2462e6[_0x2be168(0x181)]),'draw':_0x1d2783[_0x2be168(0x15c)]((_0x4384b0,_0x35030a)=>{const _0x423f09=_0x2be168;return _0x4384b0['value']+_0x3bb378[_0x35030a][_0x423f09(0x181)];})};}async[_0x480483(0x1a3)]({days:days=0x7}){const _0x2b5e64=_0x480483,_0x3dea76=await this[_0x2b5e64(0x16c)](days);return _0x3dea76;}async[_0x480483(0x16a)](){const _0x4758c2=await this['userEntity']['count']();return _0x4758c2;}async['countNewUsersToday'](){const _0x2ca283=_0x480483,_0x195d36=new Date();_0x195d36['setHours'](0x0,0x0,0x0,0x0);const _0x4207de=new Date(_0x195d36[_0x2ca283(0x19e)]()+0x18*0x3c*0x3c*0x3e8),_0x19d084=this[_0x2ca283(0x16d)][_0x2ca283(0x13a)](_0x2ca283(0x168)),_0x3da87d=await _0x19d084['where'](_0x2ca283(0x1a2),{'today':_0x195d36})[_0x2ca283(0x1a7)]('user.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x4207de})[_0x2ca283(0x19a)]();return _0x3da87d;}async['countChats'](){const _0x3fec54=_0x480483,_0x145779=await this['chatLogEntity']['count']({'where':{'type':balance_constant_1['DeductionKey'][_0x3fec54(0x169)]}});return _0x145779;}async[_0x480483(0x178)](){const _0x12ccb1=_0x480483,_0xd7044=new Date();_0xd7044['setHours'](0x0,0x0,0x0,0x0);const _0x56a6a6=new Date(_0xd7044[_0x12ccb1(0x19e)]()+0x18*0x3c*0x3c*0x3e8),_0x180d06=this['chatLogEntity'][_0x12ccb1(0x13a)](_0x12ccb1(0x18e)),_0x53aa4f=await _0x180d06[_0x12ccb1(0x193)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x12ccb1(0x153)]['CHAT_TYPE']})[_0x12ccb1(0x1a7)]('chatLog.createdAt\x20>=\x20:today',{'today':_0xd7044})['andWhere'](_0x12ccb1(0x138),{'tomorrow':_0x56a6a6})['getCount']();return _0x53aa4f;}async[_0x480483(0x197)](){const _0x495f94=_0x480483,_0x1434fb=await this['chatLogEntity'][_0x495f94(0x13b)]({'where':{'type':balance_constant_1[_0x495f94(0x153)][_0x495f94(0x1a9)]}});return _0x1434fb;}async['countNewDrawsToday'](){const _0x179f6a=_0x480483,_0x6bded7=new Date();_0x6bded7[_0x179f6a(0x158)](0x0,0x0,0x0,0x0);const _0x55d772=new Date(_0x6bded7[_0x179f6a(0x19e)]()+0x18*0x3c*0x3c*0x3e8),_0xc5775d=this[_0x179f6a(0x182)][_0x179f6a(0x13a)](_0x179f6a(0x18e)),_0x281f91=await _0xc5775d[_0x179f6a(0x193)](_0x179f6a(0x1a1),{'type':balance_constant_1[_0x179f6a(0x153)][_0x179f6a(0x1a9)]})[_0x179f6a(0x1a7)](_0x179f6a(0x147),{'today':_0x6bded7})[_0x179f6a(0x1a7)](_0x179f6a(0x138),{'tomorrow':_0x55d772})[_0x179f6a(0x19a)]();return _0x281f91;}async[_0x480483(0x172)](){const _0x284645=_0x480483,_0x46a187=new Date();_0x46a187['setHours'](0x0,0x0,0x0,0x0);const _0x180218=new Date(_0x46a187[_0x284645(0x19e)]()+0x18*0x3c*0x3c*0x3e8),_0x3b3f23=this[_0x284645(0x15b)][_0x284645(0x13a)](_0x284645(0x167)),_0x230095=await _0x3b3f23[_0x284645(0x193)]('midjourney.createdAt\x20>=\x20:today',{'today':_0x46a187})[_0x284645(0x1a7)](_0x284645(0x198),{'tomorrow':_0x180218})['getCount']();return _0x230095;}async[_0x480483(0x13e)](_0x5a816b){const _0x3b733e=_0x480483;var _0x9a4f84,_0x4aae5b;const _0x108f2c=new Date();_0x108f2c[_0x3b733e(0x158)](0x0,0x0,0x0,0x0);const _0x114e25=new Date(_0x108f2c[_0x3b733e(0x19e)]()-(_0x5a816b-0x1)*0x18*0x3c*0x3c*0x3e8),_0x1faccc=this['chatLogEntity']['createQueryBuilder'](_0x3b733e(0x17c)),_0x57d9f1=await _0x1faccc[_0x3b733e(0x191)](_0x3b733e(0x175))[_0x3b733e(0x193)](_0x3b733e(0x16f),{'type':balance_constant_1[_0x3b733e(0x153)][_0x3b733e(0x169)]})[_0x3b733e(0x1a7)](_0x3b733e(0x192),{'startDate':_0x114e25})[_0x3b733e(0x156)](_0x3b733e(0x190))[_0x3b733e(0x196)](_0x3b733e(0x190))[_0x3b733e(0x14f)](),_0x374751=[],_0x4b0e05=_0x114e25;for(let _0x49c7e0=0x0;_0x49c7e0<_0x5a816b;_0x49c7e0++){const _0x74075e=(0x0,date_1[_0x3b733e(0x15f)])(new Date(_0x4b0e05),'M.DD'),_0x373382=(_0x4aae5b=(_0x9a4f84=_0x57d9f1[_0x3b733e(0x145)](_0x442390=>(0x0,date_1[_0x3b733e(0x15f)])(new Date(_0x442390[_0x3b733e(0x190)]),'M.DD')===_0x74075e))===null||_0x9a4f84===void 0x0?void 0x0:_0x9a4f84['count'])!==null&&_0x4aae5b!==void 0x0?_0x4aae5b:0x0;_0x373382>0x0?_0x374751[_0x3b733e(0x14c)]({'date':_0x74075e,'value':Number(_0x373382)}):_0x374751[_0x3b733e(0x14c)]({'date':_0x74075e,'value':0x0}),_0x4b0e05[_0x3b733e(0x174)](_0x4b0e05[_0x3b733e(0x176)]()+0x1);}return _0x374751;}async['countDrawsByTimeRange'](_0x1ebb85){const _0x21ae9f=_0x480483;var _0x2a16aa,_0x2e3b0a;const _0x23ec18=new Date();_0x23ec18[_0x21ae9f(0x158)](0x0,0x0,0x0,0x0);const _0x222014=new Date(_0x23ec18['getTime']()-(_0x1ebb85-0x1)*0x18*0x3c*0x3c*0x3e8),_0x5386e3=this['chatLogEntity']['createQueryBuilder'](_0x21ae9f(0x17c)),_0x5d9bab=await _0x5386e3['select'](_0x21ae9f(0x175))[_0x21ae9f(0x193)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1['DeductionKey'][_0x21ae9f(0x1a9)]})['andWhere'](_0x21ae9f(0x192),{'startDate':_0x222014})['groupBy']('date')['orderBy'](_0x21ae9f(0x190))['getRawMany'](),_0x55bfea=[],_0x11c333=_0x222014;for(let _0x1c72f1=0x0;_0x1c72f1<_0x1ebb85;_0x1c72f1++){const _0x3cbc2d=(0x0,date_1[_0x21ae9f(0x15f)])(new Date(_0x11c333),'M.DD'),_0x51606c=(_0x2e3b0a=(_0x2a16aa=_0x5d9bab['find'](_0x107a17=>(0x0,date_1['formatDate'])(new Date(_0x107a17[_0x21ae9f(0x190)]),'M.DD')===_0x3cbc2d))===null||_0x2a16aa===void 0x0?void 0x0:_0x2a16aa['count'])!==null&&_0x2e3b0a!==void 0x0?_0x2e3b0a:0x0;_0x51606c>0x0?_0x55bfea[_0x21ae9f(0x14c)]({'date':_0x3cbc2d,'value':Number(_0x51606c)}):_0x55bfea['push']({'date':_0x3cbc2d,'value':0x0}),_0x11c333[_0x21ae9f(0x174)](_0x11c333['getDate']()+0x1);}return _0x55bfea;}async[_0x480483(0x141)](_0x650b3a){const _0x217097=_0x480483;var _0x3a76cb,_0x1f42cd;const _0x37c265=new Date();_0x37c265[_0x217097(0x158)](0x0,0x0,0x0,0x0);const _0x105419=new Date(_0x37c265[_0x217097(0x19e)]()-(_0x650b3a-0x1)*0x18*0x3c*0x3c*0x3e8),_0x34533f=this[_0x217097(0x15b)][_0x217097(0x13a)](_0x217097(0x167)),_0x4cbc0a=await _0x34533f[_0x217097(0x191)](_0x217097(0x179))[_0x217097(0x193)](_0x217097(0x1ab),{'status':midjourney_constant_1[_0x217097(0x15a)]['DRAWED']})[_0x217097(0x1a7)](_0x217097(0x180),{'startDate':_0x105419})[_0x217097(0x156)](_0x217097(0x190))[_0x217097(0x196)](_0x217097(0x190))[_0x217097(0x14f)](),_0x404694=[],_0x241cb9=_0x105419;for(let _0x4c506f=0x0;_0x4c506f<_0x650b3a;_0x4c506f++){const _0x48234f=(0x0,date_1[_0x217097(0x15f)])(new Date(_0x241cb9),'M.DD'),_0x3edd86=(_0x1f42cd=(_0x3a76cb=_0x4cbc0a[_0x217097(0x145)](_0x2c81cc=>(0x0,date_1[_0x217097(0x15f)])(new Date(_0x2c81cc[_0x217097(0x190)]),'M.DD')===_0x48234f))===null||_0x3a76cb===void 0x0?void 0x0:_0x3a76cb[_0x217097(0x13b)])!==null&&_0x1f42cd!==void 0x0?_0x1f42cd:0x0;_0x3edd86>0x0?_0x404694[_0x217097(0x14c)]({'date':_0x48234f,'value':Number(_0x3edd86)}):_0x404694[_0x217097(0x14c)]({'date':_0x48234f,'value':0x0}),_0x241cb9[_0x217097(0x174)](_0x241cb9[_0x217097(0x176)]()+0x1);}return _0x404694;}async[_0x480483(0x16c)](_0x4838fc){const _0x12f045=_0x480483;var _0x23bd8c,_0x4cd283;const _0x58cd09=(0x0,date_1[_0x12f045(0x15f)])(new Date(),_0x12f045(0x148)),_0x38ec9b=(0x0,date_1[_0x12f045(0x15f)])(new Date(Date[_0x12f045(0x17d)]()-Number(_0x4838fc-0x1)*0x18*0x3c*0x3c*0x3e8),'YYYYMMDD'),_0x32cff8=_0x12f045(0x139),_0x10dc81=_0x12f045(0x18f),_0x13c5b0=await this[_0x12f045(0x1a8)][_0x12f045(0x145)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x12f045(0x1a4),_0x12f045(0x1aa)])}}),_0x145e4b=(_0x23bd8c=_0x13c5b0[_0x12f045(0x145)](_0xc7484d=>_0xc7484d[_0x12f045(0x1a6)]===_0x12f045(0x1aa)))===null||_0x23bd8c===void 0x0?void 0x0:_0x23bd8c[_0x12f045(0x189)],_0x336553=(_0x4cd283=_0x13c5b0[_0x12f045(0x145)](_0x321ddd=>_0x321ddd[_0x12f045(0x1a6)]===_0x12f045(0x1a4)))===null||_0x4cd283===void 0x0?void 0x0:_0x4cd283[_0x12f045(0x189)];if(!_0x145e4b||!_0x336553)return[];if(!_0x145e4b)throw new common_1[(_0x12f045(0x19b))]('请先配置百度统计siteId',common_1[_0x12f045(0x15e)][_0x12f045(0x165)]);if(!_0x336553)throw new common_1[(_0x12f045(0x19b))](_0x12f045(0x152),common_1[_0x12f045(0x15e)][_0x12f045(0x165)]);const _0x20f004=_0x12f045(0x1ad)+_0x336553+'&site_id='+_0x145e4b+_0x12f045(0x177)+_0x10dc81+_0x12f045(0x161)+_0x38ec9b+_0x12f045(0x1a0)+_0x58cd09+'&metrics='+_0x32cff8,_0x321b76=await axios_1[_0x12f045(0x160)][_0x12f045(0x14e)](_0x20f004),{error_code:_0x1bc1c9,message:_0x4abb96}=_0x321b76[_0x12f045(0x1a5)];if(_0x1bc1c9===0x6f)throw new common_1[(_0x12f045(0x19b))](_0x4abb96||_0x12f045(0x185),common_1[_0x12f045(0x15e)][_0x12f045(0x165)]);if(_0x1bc1c9&&_0x1bc1c9!==0xc8)throw new common_1['HttpException'](_0x4abb96||_0x12f045(0x13d),common_1['HttpStatus'][_0x12f045(0x165)]);return _0x321b76[_0x12f045(0x1a5)]['result'];}async[_0x480483(0x194)](){const _0x3ad3e8=_0x480483,_0x55c1a0=await this[_0x3ad3e8(0x164)]['count']();return _0x55c1a0;}async['countNewOrdersToday'](){const _0x12a604=_0x480483,_0x4eab87=new Date();_0x4eab87[_0x12a604(0x158)](0x0,0x0,0x0,0x0);const _0x2fe435=new Date(_0x4eab87[_0x12a604(0x19e)]()+0x18*0x3c*0x3c*0x3e8),_0x3f55c6=this[_0x12a604(0x164)][_0x12a604(0x13a)](_0x12a604(0x19d)),_0xa0137c=await _0x3f55c6[_0x12a604(0x193)](_0x12a604(0x18c),{'today':_0x4eab87})[_0x12a604(0x1a7)](_0x12a604(0x142),{'tomorrow':_0x2fe435})[_0x12a604(0x19a)]();return _0xa0137c;}};function _0x4c8f(_0x5104f2,_0x10a9ce){const _0x3ec541=_0x3ec5();return _0x4c8f=function(_0x4c8f31,_0xc52a59){_0x4c8f31=_0x4c8f31-0x132;let _0x20b232=_0x3ec541[_0x4c8f31];return _0x20b232;},_0x4c8f(_0x5104f2,_0x10a9ce);}StatisticService=__decorate([(0x0,common_1[_0x480483(0x17e)])(),__param(0x0,(0x0,typeorm_1[_0x480483(0x144)])(user_entity_1[_0x480483(0x17a)])),__param(0x1,(0x0,typeorm_1[_0x480483(0x144)])(chatLog_entity_1['ChatLogEntity'])),__param(0x2,(0x0,typeorm_1[_0x480483(0x144)])(config_entity_1[_0x480483(0x18d)])),__param(0x3,(0x0,typeorm_1[_0x480483(0x144)])(order_entity_1[_0x480483(0x157)])),__param(0x4,(0x0,typeorm_1[_0x480483(0x144)])(midjourney_entity_1[_0x480483(0x187)])),__metadata('design:paramtypes',[typeorm_2[_0x480483(0x186)],typeorm_2[_0x480483(0x186)],typeorm_2[_0x480483(0x186)],typeorm_2[_0x480483(0x186)],typeorm_2[_0x480483(0x186)]])],StatisticService),exports[_0x480483(0x143)]=StatisticService;