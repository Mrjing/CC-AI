'use strict';function _0x56d8(){const _0x1be612=['__param','find','order.createdAt\x20<\x20:tomorrow','push','countNewMidhourneysToday','order.createdAt\x20>=\x20:today','configKey','&metrics=','DRAWED','7xoXmIE','select','configVal','configEntity','../order/order.entity','846lGHrLJ','getOwnPropertyDescriptor','date','StatisticService','../midjourney/midjourney.entity','setHours','257711qnOLlz','value','588tdOSPT','countDrawsByTimeRange','orderEntity','chatlog','@nestjs/typeorm','overview/getTimeTrendRpt','countNewUsersToday','getBaseStatistic','metadata','baiduToken','setDate','3347680mMOfuz','M.DD','InjectRepository','获取百度统计数据失败','请先配置百度统计siteId','4116cBgcWq','../../common/constants/balance.constant','2AqvgZN','chatLog','midjourney.status\x20=\x20:status','data','countUsers','getBaiduStatistics','16268824PVsiYg','now','countChatsByTimeRange','length','getCount','midjourneyEntity','DeductionKey','__decorate','Injectable','midjourney','&end_date=','countNewOrdersToday','YYYYMMDD','user.createdAt\x20<\x20:tomorrow','getBaiduVisit','countOrders','createQueryBuilder','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','../../common/utils/date','3855378JgipmJ','formatDate','getRawMany','../../common/constants/midjourney.constant','chatlog.createdAt\x20>=\x20:startDate','userEntity','andWhere','chatLogEntity','baiduSiteId','midjourney.createdAt\x20<\x20:tomorrow','typeorm','countDraws','countNewChatsToday','groupBy','where','countNewDrawsToday','chatLog.createdAt\x20>=\x20:today','orderBy','Repository','getChatStatistic','百度授权码过期','__metadata','order','59608ejPTIi','../globalConfig/config.entity','HttpStatus','user','design:paramtypes','&site_id=','@nestjs/common','defineProperty','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','BAD_REQUEST','CHAT_TYPE','getTime','function','countMjDrawsByTimeRange','decorate','MidjourneyStatusEnum','ConfigEntity','请先配置百度统计accessToken','getDate','chatLog.createdAt\x20<\x20:tomorrow','user.createdAt\x20>=\x20:today','chatLog.type\x20=\x20:type','midjourney.createdAt\x20>=\x20:today','__esModule','ChatLogEntity','axios','chatlog.type\x20=\x20:type','map','count','../chatLog/chatLog.entity','HttpException','3286550UZRiKf','../user/user.entity','PAINT_TYPE','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','object'];_0x56d8=function(){return _0x1be612;};return _0x56d8();}const _0x165a92=_0x359c;(function(_0x54a4bf,_0x1f8230){const _0x128b6c=_0x359c,_0xc9d580=_0x54a4bf();while(!![]){try{const _0x59d8c4=-parseInt(_0x128b6c(0x128))/0x1*(parseInt(_0x128b6c(0x13c))/0x2)+parseInt(_0x128b6c(0x12a))/0x3*(parseInt(_0x128b6c(0x13a))/0x4)+-parseInt(_0x128b6c(0x10f))/0x5+-parseInt(_0x128b6c(0x155))/0x6*(parseInt(_0x128b6c(0x11d))/0x7)+parseInt(_0x128b6c(0x16c))/0x8*(parseInt(_0x128b6c(0x122))/0x9)+-parseInt(_0x128b6c(0x135))/0xa+parseInt(_0x128b6c(0x142))/0xb;if(_0x59d8c4===_0x1f8230)break;else _0xc9d580['push'](_0xc9d580['shift']());}catch(_0x3d6406){_0xc9d580['push'](_0xc9d580['shift']());}}}(_0x56d8,0x77506));var __decorate=this&&this[_0x165a92(0x149)]||function(_0x1a8725,_0x9edc17,_0x37550a,_0xbb3ff4){const _0x3687b8=_0x165a92;var _0x54da3d=arguments['length'],_0x13c840=_0x54da3d<0x3?_0x9edc17:_0xbb3ff4===null?_0xbb3ff4=Object[_0x3687b8(0x123)](_0x9edc17,_0x37550a):_0xbb3ff4,_0x1dcd7c;if(typeof Reflect===_0x3687b8(0x113)&&typeof Reflect['decorate']==='function')_0x13c840=Reflect[_0x3687b8(0xfe)](_0x1a8725,_0x9edc17,_0x37550a,_0xbb3ff4);else{for(var _0x119508=_0x1a8725[_0x3687b8(0x145)]-0x1;_0x119508>=0x0;_0x119508--)if(_0x1dcd7c=_0x1a8725[_0x119508])_0x13c840=(_0x54da3d<0x3?_0x1dcd7c(_0x13c840):_0x54da3d>0x3?_0x1dcd7c(_0x9edc17,_0x37550a,_0x13c840):_0x1dcd7c(_0x9edc17,_0x37550a))||_0x13c840;}return _0x54da3d>0x3&&_0x13c840&&Object[_0x3687b8(0x173)](_0x9edc17,_0x37550a,_0x13c840),_0x13c840;},__metadata=this&&this[_0x165a92(0x16a)]||function(_0x31697c,_0x5f3f76){const _0x2127d5=_0x165a92;if(typeof Reflect===_0x2127d5(0x113)&&typeof Reflect[_0x2127d5(0x132)]===_0x2127d5(0x178))return Reflect['metadata'](_0x31697c,_0x5f3f76);},__param=this&&this[_0x165a92(0x114)]||function(_0x90af08,_0x190da6){return function(_0x11d601,_0x1a152d){_0x190da6(_0x11d601,_0x1a152d,_0x90af08);};};Object['defineProperty'](exports,_0x165a92(0x107),{'value':!![]}),exports[_0x165a92(0x125)]=void 0x0;function _0x359c(_0x2b59d3,_0x53f1e1){const _0x56d8fe=_0x56d8();return _0x359c=function(_0x359cb1,_0x2a904e){_0x359cb1=_0x359cb1-0xfe;let _0x3b6609=_0x56d8fe[_0x359cb1];return _0x3b6609;},_0x359c(_0x2b59d3,_0x53f1e1);}const common_1=require(_0x165a92(0x172)),typeorm_1=require(_0x165a92(0x12e)),user_entity_1=require(_0x165a92(0x110)),typeorm_2=require(_0x165a92(0x15f)),chatLog_entity_1=require(_0x165a92(0x10d)),balance_constant_1=require(_0x165a92(0x13b)),date_1=require(_0x165a92(0x154)),axios_1=require(_0x165a92(0x109)),config_entity_1=require(_0x165a92(0x16d)),order_entity_1=require(_0x165a92(0x121)),midjourney_entity_1=require(_0x165a92(0x126)),midjourney_constant_1=require(_0x165a92(0x158));let StatisticService=class StatisticService{constructor(_0x382474,_0x4f75e6,_0x412de0,_0xf85975,_0x36281d){const _0x171cf9=_0x165a92;this[_0x171cf9(0x15a)]=_0x382474,this[_0x171cf9(0x15c)]=_0x4f75e6,this['configEntity']=_0x412de0,this[_0x171cf9(0x12c)]=_0xf85975,this['midjourneyEntity']=_0x36281d;}async[_0x165a92(0x131)](){const _0x23e068=_0x165a92,_0x44c97b=await this[_0x23e068(0x140)](),_0x164437=await this[_0x23e068(0x130)](),_0x49a21d=await this['countChats'](),_0xccd05a=await this[_0x23e068(0x161)](),_0x3d0309=await this[_0x23e068(0x160)](),_0x45830f=await this[_0x23e068(0x164)](),_0x748093=await this[_0x23e068(0x118)](),_0x25fb5d=await this['countOrders'](),_0x4cb339=await this[_0x23e068(0x14d)]();return{'userCount':_0x44c97b,'newUserCount':_0x164437,'chatCount':_0x49a21d,'newChatCount':_0xccd05a,'drawCount':_0x3d0309,'newDrawCount':_0x748093+_0x45830f,'orderCount':_0x25fb5d,'newOrderCount':_0x4cb339};}async[_0x165a92(0x168)]({days:days=0x7}){const _0x4a0f48=_0x165a92,_0x5ca8c3=await this['countChatsByTimeRange'](days),_0x1cfd35=await this[_0x4a0f48(0x12b)](days),_0x375405=await this['countMjDrawsByTimeRange'](days);return{'date':_0x5ca8c3[_0x4a0f48(0x10b)](_0x5dac32=>_0x5dac32[_0x4a0f48(0x124)]),'chat':_0x5ca8c3['map'](_0x40e8cd=>_0x40e8cd[_0x4a0f48(0x129)]),'draw':_0x1cfd35['map']((_0x52ad42,_0xbd9d35)=>{const _0x54fa46=_0x4a0f48;return _0x52ad42[_0x54fa46(0x129)]+_0x375405[_0xbd9d35][_0x54fa46(0x129)];})};}async[_0x165a92(0x150)]({days:days=0x7}){const _0x4e997e=_0x165a92,_0x32232e=await this[_0x4e997e(0x141)](days);return _0x32232e;}async[_0x165a92(0x140)](){const _0x294a9f=_0x165a92,_0x51f8f5=await this[_0x294a9f(0x15a)][_0x294a9f(0x10c)]();return _0x51f8f5;}async[_0x165a92(0x130)](){const _0x15322f=_0x165a92,_0x248005=new Date();_0x248005[_0x15322f(0x127)](0x0,0x0,0x0,0x0);const _0x51f371=new Date(_0x248005['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x43fd84=this[_0x15322f(0x15a)][_0x15322f(0x152)](_0x15322f(0x16f)),_0x26396b=await _0x43fd84['where'](_0x15322f(0x104),{'today':_0x248005})[_0x15322f(0x15b)](_0x15322f(0x14f),{'tomorrow':_0x51f371})[_0x15322f(0x146)]();return _0x26396b;}async['countChats'](){const _0x5c2459=_0x165a92,_0x18be33=await this[_0x5c2459(0x15c)]['count']({'where':{'type':balance_constant_1[_0x5c2459(0x148)][_0x5c2459(0x176)]}});return _0x18be33;}async[_0x165a92(0x161)](){const _0x2a3578=_0x165a92,_0xe4e537=new Date();_0xe4e537['setHours'](0x0,0x0,0x0,0x0);const _0x1e50e0=new Date(_0xe4e537[_0x2a3578(0x177)]()+0x18*0x3c*0x3c*0x3e8),_0x1d8264=this[_0x2a3578(0x15c)][_0x2a3578(0x152)](_0x2a3578(0x13d)),_0x5e5742=await _0x1d8264[_0x2a3578(0x163)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x2a3578(0x148)][_0x2a3578(0x176)]})['andWhere'](_0x2a3578(0x165),{'today':_0xe4e537})[_0x2a3578(0x15b)](_0x2a3578(0x103),{'tomorrow':_0x1e50e0})[_0x2a3578(0x146)]();return _0x5e5742;}async[_0x165a92(0x160)](){const _0x4d994c=_0x165a92,_0x4e7120=await this['chatLogEntity'][_0x4d994c(0x10c)]({'where':{'type':balance_constant_1['DeductionKey']['PAINT_TYPE']}});return _0x4e7120;}async[_0x165a92(0x164)](){const _0x2ff744=_0x165a92,_0x5c1abf=new Date();_0x5c1abf[_0x2ff744(0x127)](0x0,0x0,0x0,0x0);const _0x44a579=new Date(_0x5c1abf[_0x2ff744(0x177)]()+0x18*0x3c*0x3c*0x3e8),_0x4bc727=this[_0x2ff744(0x15c)][_0x2ff744(0x152)](_0x2ff744(0x13d)),_0x1a1c07=await _0x4bc727[_0x2ff744(0x163)](_0x2ff744(0x105),{'type':balance_constant_1[_0x2ff744(0x148)][_0x2ff744(0x111)]})['andWhere'](_0x2ff744(0x165),{'today':_0x5c1abf})[_0x2ff744(0x15b)](_0x2ff744(0x103),{'tomorrow':_0x44a579})[_0x2ff744(0x146)]();return _0x1a1c07;}async['countNewMidhourneysToday'](){const _0x537c07=_0x165a92,_0x28dd87=new Date();_0x28dd87[_0x537c07(0x127)](0x0,0x0,0x0,0x0);const _0x38a6be=new Date(_0x28dd87['getTime']()+0x18*0x3c*0x3c*0x3e8),_0xc39c6b=this[_0x537c07(0x147)]['createQueryBuilder'](_0x537c07(0x14b)),_0x110d79=await _0xc39c6b[_0x537c07(0x163)](_0x537c07(0x106),{'today':_0x28dd87})[_0x537c07(0x15b)](_0x537c07(0x15e),{'tomorrow':_0x38a6be})['getCount']();return _0x110d79;}async[_0x165a92(0x144)](_0x4f3425){const _0x2339b1=_0x165a92;var _0x1507f7,_0x3c2f30;const _0x5a1d03=new Date();_0x5a1d03[_0x2339b1(0x127)](0x0,0x0,0x0,0x0);const _0x6da3ec=new Date(_0x5a1d03[_0x2339b1(0x177)]()-(_0x4f3425-0x1)*0x18*0x3c*0x3c*0x3e8),_0x28dc52=this[_0x2339b1(0x15c)]['createQueryBuilder'](_0x2339b1(0x12d)),_0x212f68=await _0x28dc52[_0x2339b1(0x11e)](_0x2339b1(0x153))['where'](_0x2339b1(0x10a),{'type':balance_constant_1[_0x2339b1(0x148)]['CHAT_TYPE']})[_0x2339b1(0x15b)](_0x2339b1(0x159),{'startDate':_0x6da3ec})[_0x2339b1(0x162)](_0x2339b1(0x124))[_0x2339b1(0x166)]('date')[_0x2339b1(0x157)](),_0x310c29=[],_0x514196=_0x6da3ec;for(let _0xb553fd=0x0;_0xb553fd<_0x4f3425;_0xb553fd++){const _0x121399=(0x0,date_1[_0x2339b1(0x156)])(new Date(_0x514196),_0x2339b1(0x136)),_0x3de08f=(_0x3c2f30=(_0x1507f7=_0x212f68['find'](_0x3f261b=>(0x0,date_1[_0x2339b1(0x156)])(new Date(_0x3f261b[_0x2339b1(0x124)]),_0x2339b1(0x136))===_0x121399))===null||_0x1507f7===void 0x0?void 0x0:_0x1507f7[_0x2339b1(0x10c)])!==null&&_0x3c2f30!==void 0x0?_0x3c2f30:0x0;_0x3de08f>0x0?_0x310c29[_0x2339b1(0x117)]({'date':_0x121399,'value':Number(_0x3de08f)}):_0x310c29[_0x2339b1(0x117)]({'date':_0x121399,'value':0x0}),_0x514196[_0x2339b1(0x134)](_0x514196[_0x2339b1(0x102)]()+0x1);}return _0x310c29;}async[_0x165a92(0x12b)](_0x1bfcdf){const _0x1febeb=_0x165a92;var _0x3dc562,_0x4714bf;const _0x582ad0=new Date();_0x582ad0[_0x1febeb(0x127)](0x0,0x0,0x0,0x0);const _0x39ec3a=new Date(_0x582ad0[_0x1febeb(0x177)]()-(_0x1bfcdf-0x1)*0x18*0x3c*0x3c*0x3e8),_0xe67873=this[_0x1febeb(0x15c)][_0x1febeb(0x152)](_0x1febeb(0x12d)),_0x4d31e8=await _0xe67873[_0x1febeb(0x11e)](_0x1febeb(0x153))[_0x1febeb(0x163)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x1febeb(0x148)][_0x1febeb(0x111)]})[_0x1febeb(0x15b)]('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x39ec3a})[_0x1febeb(0x162)](_0x1febeb(0x124))[_0x1febeb(0x166)]('date')['getRawMany'](),_0x2d5b9a=[],_0x4ec3e6=_0x39ec3a;for(let _0x15986a=0x0;_0x15986a<_0x1bfcdf;_0x15986a++){const _0x3d449b=(0x0,date_1[_0x1febeb(0x156)])(new Date(_0x4ec3e6),'M.DD'),_0x2ee21e=(_0x4714bf=(_0x3dc562=_0x4d31e8[_0x1febeb(0x115)](_0x1899f=>(0x0,date_1['formatDate'])(new Date(_0x1899f[_0x1febeb(0x124)]),'M.DD')===_0x3d449b))===null||_0x3dc562===void 0x0?void 0x0:_0x3dc562[_0x1febeb(0x10c)])!==null&&_0x4714bf!==void 0x0?_0x4714bf:0x0;_0x2ee21e>0x0?_0x2d5b9a[_0x1febeb(0x117)]({'date':_0x3d449b,'value':Number(_0x2ee21e)}):_0x2d5b9a[_0x1febeb(0x117)]({'date':_0x3d449b,'value':0x0}),_0x4ec3e6[_0x1febeb(0x134)](_0x4ec3e6['getDate']()+0x1);}return _0x2d5b9a;}async[_0x165a92(0x179)](_0x2cb5ef){const _0x441391=_0x165a92;var _0x53588a,_0x33cb0b;const _0x2004dc=new Date();_0x2004dc['setHours'](0x0,0x0,0x0,0x0);const _0x191145=new Date(_0x2004dc[_0x441391(0x177)]()-(_0x2cb5ef-0x1)*0x18*0x3c*0x3c*0x3e8),_0x5cdec4=this[_0x441391(0x147)]['createQueryBuilder']('midjourney'),_0x4a461d=await _0x5cdec4[_0x441391(0x11e)](_0x441391(0x174))['where'](_0x441391(0x13e),{'status':midjourney_constant_1[_0x441391(0xff)][_0x441391(0x11c)]})[_0x441391(0x15b)]('midjourney.createdAt\x20>=\x20:startDate',{'startDate':_0x191145})[_0x441391(0x162)](_0x441391(0x124))[_0x441391(0x166)](_0x441391(0x124))[_0x441391(0x157)](),_0x51baf9=[],_0x134741=_0x191145;for(let _0x372d99=0x0;_0x372d99<_0x2cb5ef;_0x372d99++){const _0x3c3d2c=(0x0,date_1['formatDate'])(new Date(_0x134741),_0x441391(0x136)),_0x1bb85b=(_0x33cb0b=(_0x53588a=_0x4a461d[_0x441391(0x115)](_0x3e861a=>(0x0,date_1['formatDate'])(new Date(_0x3e861a[_0x441391(0x124)]),_0x441391(0x136))===_0x3c3d2c))===null||_0x53588a===void 0x0?void 0x0:_0x53588a[_0x441391(0x10c)])!==null&&_0x33cb0b!==void 0x0?_0x33cb0b:0x0;_0x1bb85b>0x0?_0x51baf9['push']({'date':_0x3c3d2c,'value':Number(_0x1bb85b)}):_0x51baf9[_0x441391(0x117)]({'date':_0x3c3d2c,'value':0x0}),_0x134741[_0x441391(0x134)](_0x134741[_0x441391(0x102)]()+0x1);}return _0x51baf9;}async['getBaiduStatistics'](_0x3492e0){const _0x41a1e3=_0x165a92;var _0x3d6875,_0x40b69f;const _0x2bfe36=(0x0,date_1[_0x41a1e3(0x156)])(new Date(),_0x41a1e3(0x14e)),_0x642deb=(0x0,date_1['formatDate'])(new Date(Date[_0x41a1e3(0x143)]()-Number(_0x3492e0-0x1)*0x18*0x3c*0x3c*0x3e8),_0x41a1e3(0x14e)),_0xf00e0b='pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time',_0x136d7c=_0x41a1e3(0x12f),_0x2df2de=await this[_0x41a1e3(0x120)][_0x41a1e3(0x115)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x41a1e3(0x133),_0x41a1e3(0x15d)])}}),_0x40ee82=(_0x3d6875=_0x2df2de['find'](_0x2e0192=>_0x2e0192[_0x41a1e3(0x11a)]===_0x41a1e3(0x15d)))===null||_0x3d6875===void 0x0?void 0x0:_0x3d6875[_0x41a1e3(0x11f)],_0x195c85=(_0x40b69f=_0x2df2de[_0x41a1e3(0x115)](_0xf7d23c=>_0xf7d23c[_0x41a1e3(0x11a)]===_0x41a1e3(0x133)))===null||_0x40b69f===void 0x0?void 0x0:_0x40b69f[_0x41a1e3(0x11f)];if(!_0x40ee82||!_0x195c85)return[];if(!_0x40ee82)throw new common_1[(_0x41a1e3(0x10e))](_0x41a1e3(0x139),common_1[_0x41a1e3(0x16e)]['BAD_REQUEST']);if(!_0x195c85)throw new common_1[(_0x41a1e3(0x10e))](_0x41a1e3(0x101),common_1[_0x41a1e3(0x16e)][_0x41a1e3(0x175)]);const _0x9045d4=_0x41a1e3(0x112)+_0x195c85+_0x41a1e3(0x171)+_0x40ee82+'&method='+_0x136d7c+'&start_date='+_0x642deb+_0x41a1e3(0x14c)+_0x2bfe36+_0x41a1e3(0x11b)+_0xf00e0b,_0x5c98e0=await axios_1['default']['get'](_0x9045d4),{error_code:_0x3163e5,message:_0x551f8d}=_0x5c98e0[_0x41a1e3(0x13f)];if(_0x3163e5===0x6f)throw new common_1[(_0x41a1e3(0x10e))](_0x551f8d||_0x41a1e3(0x169),common_1[_0x41a1e3(0x16e)]['BAD_REQUEST']);if(_0x3163e5&&_0x3163e5!==0xc8)throw new common_1[(_0x41a1e3(0x10e))](_0x551f8d||_0x41a1e3(0x138),common_1[_0x41a1e3(0x16e)][_0x41a1e3(0x175)]);return _0x5c98e0[_0x41a1e3(0x13f)]['result'];}async[_0x165a92(0x151)](){const _0x366a98=_0x165a92,_0x64ebe4=await this['orderEntity'][_0x366a98(0x10c)]();return _0x64ebe4;}async[_0x165a92(0x14d)](){const _0x5f458b=_0x165a92,_0x5effe6=new Date();_0x5effe6['setHours'](0x0,0x0,0x0,0x0);const _0x529bd8=new Date(_0x5effe6[_0x5f458b(0x177)]()+0x18*0x3c*0x3c*0x3e8),_0x4dfa9b=this[_0x5f458b(0x12c)]['createQueryBuilder'](_0x5f458b(0x16b)),_0x3e5145=await _0x4dfa9b[_0x5f458b(0x163)](_0x5f458b(0x119),{'today':_0x5effe6})[_0x5f458b(0x15b)](_0x5f458b(0x116),{'tomorrow':_0x529bd8})[_0x5f458b(0x146)]();return _0x3e5145;}};StatisticService=__decorate([(0x0,common_1[_0x165a92(0x14a)])(),__param(0x0,(0x0,typeorm_1[_0x165a92(0x137)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x165a92(0x137)])(chatLog_entity_1[_0x165a92(0x108)])),__param(0x2,(0x0,typeorm_1[_0x165a92(0x137)])(config_entity_1[_0x165a92(0x100)])),__param(0x3,(0x0,typeorm_1[_0x165a92(0x137)])(order_entity_1['OrderEntity'])),__param(0x4,(0x0,typeorm_1[_0x165a92(0x137)])(midjourney_entity_1['MidjourneyEntity'])),__metadata(_0x165a92(0x170),[typeorm_2[_0x165a92(0x167)],typeorm_2[_0x165a92(0x167)],typeorm_2[_0x165a92(0x167)],typeorm_2[_0x165a92(0x167)],typeorm_2[_0x165a92(0x167)]])],StatisticService),exports['StatisticService']=StatisticService;