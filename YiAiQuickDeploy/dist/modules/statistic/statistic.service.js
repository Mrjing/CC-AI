'use strict';const _0x38e67a=_0x1a36;(function(_0x117f4f,_0x2f257d){const _0xff1918=_0x1a36,_0x36e3b3=_0x117f4f();while(!![]){try{const _0x411865=parseInt(_0xff1918(0xe4))/0x1+-parseInt(_0xff1918(0xcd))/0x2*(parseInt(_0xff1918(0x90))/0x3)+parseInt(_0xff1918(0xee))/0x4*(-parseInt(_0xff1918(0xc5))/0x5)+-parseInt(_0xff1918(0xe3))/0x6*(-parseInt(_0xff1918(0xbc))/0x7)+-parseInt(_0xff1918(0xa2))/0x8+-parseInt(_0xff1918(0xef))/0x9+parseInt(_0xff1918(0xed))/0xa;if(_0x411865===_0x2f257d)break;else _0x36e3b3['push'](_0x36e3b3['shift']());}catch(_0xf24fbc){_0x36e3b3['push'](_0x36e3b3['shift']());}}}(_0x4fa0,0x1a649));function _0x1a36(_0x3c28ec,_0x3f3178){const _0x4fa098=_0x4fa0();return _0x1a36=function(_0x1a36c0,_0x45a560){_0x1a36c0=_0x1a36c0-0x7d;let _0x26ecca=_0x4fa098[_0x1a36c0];return _0x26ecca;},_0x1a36(_0x3c28ec,_0x3f3178);}var __decorate=this&&this[_0x38e67a(0xc2)]||function(_0x5c147b,_0x2b1f50,_0x10db9c,_0x41f10e){const _0x3ec699=_0x38e67a;var _0x3da2cc=arguments[_0x3ec699(0xa6)],_0x4896f4=_0x3da2cc<0x3?_0x2b1f50:_0x41f10e===null?_0x41f10e=Object[_0x3ec699(0xec)](_0x2b1f50,_0x10db9c):_0x41f10e,_0x4d7bba;if(typeof Reflect===_0x3ec699(0xd9)&&typeof Reflect['decorate']===_0x3ec699(0xe6))_0x4896f4=Reflect['decorate'](_0x5c147b,_0x2b1f50,_0x10db9c,_0x41f10e);else{for(var _0x17a312=_0x5c147b[_0x3ec699(0xa6)]-0x1;_0x17a312>=0x0;_0x17a312--)if(_0x4d7bba=_0x5c147b[_0x17a312])_0x4896f4=(_0x3da2cc<0x3?_0x4d7bba(_0x4896f4):_0x3da2cc>0x3?_0x4d7bba(_0x2b1f50,_0x10db9c,_0x4896f4):_0x4d7bba(_0x2b1f50,_0x10db9c))||_0x4896f4;}return _0x3da2cc>0x3&&_0x4896f4&&Object[_0x3ec699(0xad)](_0x2b1f50,_0x10db9c,_0x4896f4),_0x4896f4;},__metadata=this&&this['__metadata']||function(_0x47d855,_0x10adc0){const _0x39676f=_0x38e67a;if(typeof Reflect===_0x39676f(0xd9)&&typeof Reflect['metadata']===_0x39676f(0xe6))return Reflect['metadata'](_0x47d855,_0x10adc0);},__param=this&&this[_0x38e67a(0x95)]||function(_0x55e880,_0x413acf){return function(_0x55cc22,_0x15089b){_0x413acf(_0x55cc22,_0x15089b,_0x55e880);};};Object[_0x38e67a(0xad)](exports,_0x38e67a(0xe2),{'value':!![]}),exports[_0x38e67a(0x7f)]=void 0x0;const common_1=require(_0x38e67a(0xc3)),typeorm_1=require(_0x38e67a(0x92)),user_entity_1=require(_0x38e67a(0xb8)),typeorm_2=require(_0x38e67a(0xd5)),chatLog_entity_1=require('../chatLog/chatLog.entity'),balance_constant_1=require(_0x38e67a(0xb9)),date_1=require(_0x38e67a(0x81)),axios_1=require(_0x38e67a(0xbb)),config_entity_1=require(_0x38e67a(0x89)),order_entity_1=require(_0x38e67a(0xcc)),midjourney_entity_1=require(_0x38e67a(0x98)),midjourney_constant_1=require(_0x38e67a(0xa3));let StatisticService=class StatisticService{constructor(_0x21abf5,_0x4e8093,_0x49ddc5,_0x35592e,_0x5d6bfc){const _0x224822=_0x38e67a;this[_0x224822(0xe5)]=_0x21abf5,this[_0x224822(0xf0)]=_0x4e8093,this[_0x224822(0xb7)]=_0x49ddc5,this['orderEntity']=_0x35592e,this[_0x224822(0xaf)]=_0x5d6bfc;}async[_0x38e67a(0x85)](){const _0x513478=_0x38e67a,_0x5e4fb8=await this['countUsers'](),_0x1c87ec=await this[_0x513478(0xd1)](),_0x339dd4=await this[_0x513478(0x7d)](),_0x1486a6=await this['countNewChatsToday'](),_0x3b18f3=await this[_0x513478(0xb2)](),_0x18a674=await this[_0x513478(0xdc)](),_0x555e33=await this[_0x513478(0xeb)](),_0x333210=await this[_0x513478(0x9e)](),_0x135518=await this[_0x513478(0x9b)]();return{'userCount':_0x5e4fb8,'newUserCount':_0x1c87ec,'chatCount':_0x339dd4,'newChatCount':_0x1486a6,'drawCount':_0x3b18f3,'newDrawCount':_0x555e33+_0x18a674,'orderCount':_0x333210,'newOrderCount':_0x135518};}async[_0x38e67a(0x9c)]({days:days=0x7}){const _0x18c855=_0x38e67a,_0x39958b=await this[_0x18c855(0xda)](days),_0x2d621b=await this[_0x18c855(0xa7)](days),_0x3c9e0d=await this[_0x18c855(0x7e)](days);return{'date':_0x39958b[_0x18c855(0xb5)](_0x5a6d9c=>_0x5a6d9c[_0x18c855(0xaa)]),'chat':_0x39958b['map'](_0x8e8630=>_0x8e8630[_0x18c855(0xc8)]),'draw':_0x2d621b[_0x18c855(0xb5)]((_0x16ab8a,_0x2d581c)=>{const _0x5d71ef=_0x18c855;return _0x16ab8a[_0x5d71ef(0xc8)]+_0x3c9e0d[_0x2d581c][_0x5d71ef(0xc8)];})};}async[_0x38e67a(0xc6)]({days:days=0x7}){const _0x5b9ecb=_0x38e67a,_0x35a954=await this[_0x5b9ecb(0xce)](days);return _0x35a954;}async[_0x38e67a(0xc9)](){const _0x3e4665=_0x38e67a,_0x45d2eb=await this[_0x3e4665(0xe5)][_0x3e4665(0x91)]();return _0x45d2eb;}async[_0x38e67a(0xd1)](){const _0x25b58b=_0x38e67a,_0x29c840=new Date();_0x29c840[_0x25b58b(0x96)](0x0,0x0,0x0,0x0);const _0x3b6215=new Date(_0x29c840[_0x25b58b(0xf1)]()+0x18*0x3c*0x3c*0x3e8),_0x4eaf97=this[_0x25b58b(0xe5)][_0x25b58b(0x9a)](_0x25b58b(0x83)),_0x10a61b=await _0x4eaf97[_0x25b58b(0xc0)]('user.createdAt\x20>=\x20:today',{'today':_0x29c840})['andWhere'](_0x25b58b(0x88),{'tomorrow':_0x3b6215})['getCount']();return _0x10a61b;}async[_0x38e67a(0x7d)](){const _0x5573f4=_0x38e67a,_0x48203e=await this['chatLogEntity'][_0x5573f4(0x91)]({'where':{'type':balance_constant_1[_0x5573f4(0xcf)][_0x5573f4(0xb3)]}});return _0x48203e;}async[_0x38e67a(0x8e)](){const _0x1b482f=_0x38e67a,_0xc176d=new Date();_0xc176d['setHours'](0x0,0x0,0x0,0x0);const _0x242e05=new Date(_0xc176d[_0x1b482f(0xf1)]()+0x18*0x3c*0x3c*0x3e8),_0x5c1165=this[_0x1b482f(0xf0)][_0x1b482f(0x9a)]('chatLog'),_0x2efb61=await _0x5c1165[_0x1b482f(0xc0)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x1b482f(0xcf)][_0x1b482f(0xb3)]})['andWhere']('chatLog.createdAt\x20>=\x20:today',{'today':_0xc176d})[_0x1b482f(0xd2)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x242e05})['getCount']();return _0x2efb61;}async[_0x38e67a(0xb2)](){const _0x7b0d82=_0x38e67a,_0x4240cc=await this[_0x7b0d82(0xf0)]['count']({'where':{'type':balance_constant_1[_0x7b0d82(0xcf)][_0x7b0d82(0xdf)]}});return _0x4240cc;}async[_0x38e67a(0xdc)](){const _0x1c226e=_0x38e67a,_0x4492d4=new Date();_0x4492d4[_0x1c226e(0x96)](0x0,0x0,0x0,0x0);const _0x15d669=new Date(_0x4492d4[_0x1c226e(0xf1)]()+0x18*0x3c*0x3c*0x3e8),_0x3b7687=this['chatLogEntity']['createQueryBuilder'](_0x1c226e(0x8f)),_0x22aba6=await _0x3b7687[_0x1c226e(0xc0)](_0x1c226e(0x8c),{'type':balance_constant_1['DeductionKey']['PAINT_TYPE']})[_0x1c226e(0xd2)](_0x1c226e(0xac),{'today':_0x4492d4})[_0x1c226e(0xd2)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x15d669})[_0x1c226e(0xae)]();return _0x22aba6;}async['countNewMidhourneysToday'](){const _0x172572=_0x38e67a,_0x261ecc=new Date();_0x261ecc['setHours'](0x0,0x0,0x0,0x0);const _0x283895=new Date(_0x261ecc[_0x172572(0xf1)]()+0x18*0x3c*0x3c*0x3e8),_0x455274=this[_0x172572(0xaf)][_0x172572(0x9a)]('midjourney'),_0x20adb3=await _0x455274[_0x172572(0xc0)](_0x172572(0xd6),{'today':_0x261ecc})['andWhere'](_0x172572(0xf3),{'tomorrow':_0x283895})[_0x172572(0xae)]();return _0x20adb3;}async['countChatsByTimeRange'](_0x352244){const _0x55bafa=_0x38e67a;var _0x2cb71c,_0x8c1dc1;const _0x3159e8=new Date();_0x3159e8[_0x55bafa(0x96)](0x0,0x0,0x0,0x0);const _0x61cf0f=new Date(_0x3159e8[_0x55bafa(0xf1)]()-(_0x352244-0x1)*0x18*0x3c*0x3c*0x3e8),_0x5dcff6=this[_0x55bafa(0xf0)][_0x55bafa(0x9a)](_0x55bafa(0x86)),_0x58bfe5=await _0x5dcff6['select'](_0x55bafa(0xe0))[_0x55bafa(0xc0)](_0x55bafa(0xf5),{'type':balance_constant_1[_0x55bafa(0xcf)][_0x55bafa(0xb3)]})[_0x55bafa(0xd2)](_0x55bafa(0xa0),{'startDate':_0x61cf0f})['groupBy'](_0x55bafa(0xaa))[_0x55bafa(0xdd)](_0x55bafa(0xaa))[_0x55bafa(0xf4)](),_0x45eb74=[],_0x1d552=_0x61cf0f;for(let _0x5d8fb6=0x0;_0x5d8fb6<_0x352244;_0x5d8fb6++){const _0x1224a6=(0x0,date_1[_0x55bafa(0xe9)])(new Date(_0x1d552),_0x55bafa(0xd0)),_0xeed2ce=(_0x8c1dc1=(_0x2cb71c=_0x58bfe5[_0x55bafa(0xa9)](_0x1c4e30=>(0x0,date_1['formatDate'])(new Date(_0x1c4e30['date']),_0x55bafa(0xd0))===_0x1224a6))===null||_0x2cb71c===void 0x0?void 0x0:_0x2cb71c['count'])!==null&&_0x8c1dc1!==void 0x0?_0x8c1dc1:0x0;_0xeed2ce>0x0?_0x45eb74[_0x55bafa(0x84)]({'date':_0x1224a6,'value':Number(_0xeed2ce)}):_0x45eb74[_0x55bafa(0x84)]({'date':_0x1224a6,'value':0x0}),_0x1d552[_0x55bafa(0xbe)](_0x1d552[_0x55bafa(0xe7)]()+0x1);}return _0x45eb74;}async[_0x38e67a(0xa7)](_0x17cc6c){const _0x26096a=_0x38e67a;var _0x239abf,_0x4e3585;const _0x146255=new Date();_0x146255[_0x26096a(0x96)](0x0,0x0,0x0,0x0);const _0x4f8137=new Date(_0x146255['getTime']()-(_0x17cc6c-0x1)*0x18*0x3c*0x3c*0x3e8),_0x426eef=this[_0x26096a(0xf0)][_0x26096a(0x9a)](_0x26096a(0x86)),_0x4c32b0=await _0x426eef[_0x26096a(0xd4)]('DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')['where'](_0x26096a(0xf5),{'type':balance_constant_1[_0x26096a(0xcf)][_0x26096a(0xdf)]})[_0x26096a(0xd2)](_0x26096a(0xa0),{'startDate':_0x4f8137})[_0x26096a(0xa4)]('date')[_0x26096a(0xdd)](_0x26096a(0xaa))['getRawMany'](),_0x19daa6=[],_0x466e4e=_0x4f8137;for(let _0x246cca=0x0;_0x246cca<_0x17cc6c;_0x246cca++){const _0x41f97b=(0x0,date_1[_0x26096a(0xe9)])(new Date(_0x466e4e),_0x26096a(0xd0)),_0x385103=(_0x4e3585=(_0x239abf=_0x4c32b0['find'](_0x10cae5=>(0x0,date_1[_0x26096a(0xe9)])(new Date(_0x10cae5[_0x26096a(0xaa)]),_0x26096a(0xd0))===_0x41f97b))===null||_0x239abf===void 0x0?void 0x0:_0x239abf[_0x26096a(0x91)])!==null&&_0x4e3585!==void 0x0?_0x4e3585:0x0;_0x385103>0x0?_0x19daa6['push']({'date':_0x41f97b,'value':Number(_0x385103)}):_0x19daa6[_0x26096a(0x84)]({'date':_0x41f97b,'value':0x0}),_0x466e4e[_0x26096a(0xbe)](_0x466e4e[_0x26096a(0xe7)]()+0x1);}return _0x19daa6;}async[_0x38e67a(0x7e)](_0x791a41){const _0x391b56=_0x38e67a;var _0x5e8749,_0x22a53c;const _0x5f00f5=new Date();_0x5f00f5[_0x391b56(0x96)](0x0,0x0,0x0,0x0);const _0x5d9c82=new Date(_0x5f00f5[_0x391b56(0xf1)]()-(_0x791a41-0x1)*0x18*0x3c*0x3c*0x3e8),_0x4cbae8=this[_0x391b56(0xaf)][_0x391b56(0x9a)](_0x391b56(0xa8)),_0x58e9a6=await _0x4cbae8['select'](_0x391b56(0xea))[_0x391b56(0xc0)]('midjourney.status\x20=\x20:status',{'status':midjourney_constant_1[_0x391b56(0xd3)][_0x391b56(0xba)]})[_0x391b56(0xd2)](_0x391b56(0xf2),{'startDate':_0x5d9c82})[_0x391b56(0xa4)](_0x391b56(0xaa))[_0x391b56(0xdd)](_0x391b56(0xaa))[_0x391b56(0xf4)](),_0x173aaf=[],_0x4b9523=_0x5d9c82;for(let _0x5c7cc1=0x0;_0x5c7cc1<_0x791a41;_0x5c7cc1++){const _0x565d3b=(0x0,date_1[_0x391b56(0xe9)])(new Date(_0x4b9523),_0x391b56(0xd0)),_0x5e36ac=(_0x22a53c=(_0x5e8749=_0x58e9a6[_0x391b56(0xa9)](_0x5d2108=>(0x0,date_1['formatDate'])(new Date(_0x5d2108[_0x391b56(0xaa)]),_0x391b56(0xd0))===_0x565d3b))===null||_0x5e8749===void 0x0?void 0x0:_0x5e8749[_0x391b56(0x91)])!==null&&_0x22a53c!==void 0x0?_0x22a53c:0x0;_0x5e36ac>0x0?_0x173aaf[_0x391b56(0x84)]({'date':_0x565d3b,'value':Number(_0x5e36ac)}):_0x173aaf[_0x391b56(0x84)]({'date':_0x565d3b,'value':0x0}),_0x4b9523['setDate'](_0x4b9523[_0x391b56(0xe7)]()+0x1);}return _0x173aaf;}async[_0x38e67a(0xce)](_0x24cadb){const _0x53cbdf=_0x38e67a;var _0x1c8ca2,_0x3aaa7c;const _0x114475=(0x0,date_1['formatDate'])(new Date(),'YYYYMMDD'),_0x385744=(0x0,date_1['formatDate'])(new Date(Date['now']()-Number(_0x24cadb-0x1)*0x18*0x3c*0x3c*0x3e8),'YYYYMMDD'),_0x58f3b3=_0x53cbdf(0xb1),_0x5e4158=_0x53cbdf(0xb6),_0x5439da=await this[_0x53cbdf(0xb7)][_0x53cbdf(0xa9)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x53cbdf(0x87),_0x53cbdf(0x9f)])}}),_0x4ffc5a=(_0x1c8ca2=_0x5439da[_0x53cbdf(0xa9)](_0x17b497=>_0x17b497[_0x53cbdf(0x94)]==='baiduSiteId'))===null||_0x1c8ca2===void 0x0?void 0x0:_0x1c8ca2['configVal'],_0x4c686d=(_0x3aaa7c=_0x5439da[_0x53cbdf(0xa9)](_0x1d6e55=>_0x1d6e55['configKey']===_0x53cbdf(0x87)))===null||_0x3aaa7c===void 0x0?void 0x0:_0x3aaa7c[_0x53cbdf(0x97)];if(!_0x4ffc5a||!_0x4c686d)return[];if(!_0x4ffc5a)throw new common_1[(_0x53cbdf(0xa5))](_0x53cbdf(0xcb),common_1[_0x53cbdf(0x82)][_0x53cbdf(0x8b)]);if(!_0x4c686d)throw new common_1['HttpException'](_0x53cbdf(0x93),common_1['HttpStatus'][_0x53cbdf(0x8b)]);const _0x26da0f=_0x53cbdf(0x80)+_0x4c686d+_0x53cbdf(0xde)+_0x4ffc5a+_0x53cbdf(0xca)+_0x5e4158+_0x53cbdf(0xd7)+_0x385744+_0x53cbdf(0xb4)+_0x114475+_0x53cbdf(0xab)+_0x58f3b3,_0x2206d1=await axios_1[_0x53cbdf(0xb0)][_0x53cbdf(0xe8)](_0x26da0f),{error_code:_0x347fd4,message:_0x18b5fb}=_0x2206d1['data'];if(_0x347fd4===0x6f)throw new common_1['HttpException'](_0x18b5fb||_0x53cbdf(0xf6),common_1['HttpStatus']['BAD_REQUEST']);if(_0x347fd4&&_0x347fd4!==0xc8)throw new common_1[(_0x53cbdf(0xa5))](_0x18b5fb||_0x53cbdf(0x8d),common_1[_0x53cbdf(0x82)][_0x53cbdf(0x8b)]);return _0x2206d1['data']['result'];}async[_0x38e67a(0x9e)](){const _0x2a7018=_0x38e67a,_0x22fb9d=await this[_0x2a7018(0xd8)][_0x2a7018(0x91)]();return _0x22fb9d;}async[_0x38e67a(0x9b)](){const _0x21eb04=_0x38e67a,_0x54b8b8=new Date();_0x54b8b8[_0x21eb04(0x96)](0x0,0x0,0x0,0x0);const _0x4b52b9=new Date(_0x54b8b8[_0x21eb04(0xf1)]()+0x18*0x3c*0x3c*0x3e8),_0x74292d=this[_0x21eb04(0xd8)][_0x21eb04(0x9a)](_0x21eb04(0x99)),_0x32eeae=await _0x74292d[_0x21eb04(0xc0)](_0x21eb04(0xc4),{'today':_0x54b8b8})['andWhere'](_0x21eb04(0xa1),{'tomorrow':_0x4b52b9})['getCount']();return _0x32eeae;}};StatisticService=__decorate([(0x0,common_1[_0x38e67a(0x9d)])(),__param(0x0,(0x0,typeorm_1[_0x38e67a(0x8a)])(user_entity_1[_0x38e67a(0xbf)])),__param(0x1,(0x0,typeorm_1[_0x38e67a(0x8a)])(chatLog_entity_1[_0x38e67a(0xbd)])),__param(0x2,(0x0,typeorm_1[_0x38e67a(0x8a)])(config_entity_1[_0x38e67a(0xc7)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(order_entity_1['OrderEntity'])),__param(0x4,(0x0,typeorm_1[_0x38e67a(0x8a)])(midjourney_entity_1[_0x38e67a(0xe1)])),__metadata(_0x38e67a(0xc1),[typeorm_2[_0x38e67a(0xdb)],typeorm_2[_0x38e67a(0xdb)],typeorm_2[_0x38e67a(0xdb)],typeorm_2['Repository'],typeorm_2[_0x38e67a(0xdb)]])],StatisticService),exports[_0x38e67a(0x7f)]=StatisticService;function _0x4fa0(){const _0x5eefac=['countNewChatsToday','chatLog','627ZGXSdd','count','@nestjs/typeorm','请先配置百度统计accessToken','configKey','__param','setHours','configVal','../midjourney/midjourney.entity','order','createQueryBuilder','countNewOrdersToday','getChatStatistic','Injectable','countOrders','baiduSiteId','chatlog.createdAt\x20>=\x20:startDate','order.createdAt\x20<\x20:tomorrow','568744rskfRu','../../common/constants/midjourney.constant','groupBy','HttpException','length','countDrawsByTimeRange','midjourney','find','date','&metrics=','chatLog.createdAt\x20>=\x20:today','defineProperty','getCount','midjourneyEntity','default','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','countDraws','CHAT_TYPE','&end_date=','map','overview/getTimeTrendRpt','configEntity','../user/user.entity','../../common/constants/balance.constant','DRAWED','axios','203nktVbd','ChatLogEntity','setDate','UserEntity','where','design:paramtypes','__decorate','@nestjs/common','order.createdAt\x20>=\x20:today','245MiyfBf','getBaiduVisit','ConfigEntity','value','countUsers','&method=','请先配置百度统计siteId','../order/order.entity','764ffCFEO','getBaiduStatistics','DeductionKey','M.DD','countNewUsersToday','andWhere','MidjourneyStatusEnum','select','typeorm','midjourney.createdAt\x20>=\x20:today','&start_date=','orderEntity','object','countChatsByTimeRange','Repository','countNewDrawsToday','orderBy','&site_id=','PAINT_TYPE','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','MidjourneyEntity','__esModule','42486EOmCuz','27680dgKTQT','userEntity','function','getDate','get','formatDate','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','countNewMidhourneysToday','getOwnPropertyDescriptor','1674220OkpEct','1780aUZpYU','1076490vQabJn','chatLogEntity','getTime','midjourney.createdAt\x20>=\x20:startDate','midjourney.createdAt\x20<\x20:tomorrow','getRawMany','chatlog.type\x20=\x20:type','百度授权码过期','countChats','countMjDrawsByTimeRange','StatisticService','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','../../common/utils/date','HttpStatus','user','push','getBaseStatistic','chatlog','baiduToken','user.createdAt\x20<\x20:tomorrow','../globalConfig/config.entity','InjectRepository','BAD_REQUEST','chatLog.type\x20=\x20:type','获取百度统计数据失败'];_0x4fa0=function(){return _0x5eefac;};return _0x4fa0();}