'use strict';const _0x56684f=_0x5af7;(function(_0x45ccd2,_0x41590a){const _0x4100b2=_0x5af7,_0x38664f=_0x45ccd2();while(!![]){try{const _0x4086f6=-parseInt(_0x4100b2(0x132))/0x1+parseInt(_0x4100b2(0x160))/0x2*(parseInt(_0x4100b2(0x157))/0x3)+parseInt(_0x4100b2(0x127))/0x4+parseInt(_0x4100b2(0x114))/0x5+-parseInt(_0x4100b2(0x153))/0x6+-parseInt(_0x4100b2(0x12e))/0x7+parseInt(_0x4100b2(0x125))/0x8*(parseInt(_0x4100b2(0x143))/0x9);if(_0x4086f6===_0x41590a)break;else _0x38664f['push'](_0x38664f['shift']());}catch(_0x5720c5){_0x38664f['push'](_0x38664f['shift']());}}}(_0x50da,0xbb52d));function _0x50da(){const _0x652378=['chatLog.createdAt\x20<\x20:tomorrow','data','metadata','chatLogEntity','PAINT_TYPE','length','orderBy','StatisticService','getBaiduVisit','countNewChatsToday','../order/order.entity','&metrics=','object','countNewDrawsToday','@nestjs/typeorm','overview/getTimeTrendRpt','midjourneyEntity','3645300ZoTvAE','HttpException','../midjourney/midjourney.entity','../chatLog/chatLog.entity','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','InjectRepository','__metadata','countChats','result','countChatsByTimeRange','order.createdAt\x20<\x20:tomorrow','value','baiduSiteId','chatlog.type\x20=\x20:type','countOrders','configKey','find','720jlJFlK','请先配置百度统计accessToken','1213440vPxShO','midjourney.createdAt\x20>=\x20:startDate','getChatStatistic','userEntity','__esModule','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','groupBy','9627597XHOOAu','function','chatLog.createdAt\x20>=\x20:today','where','367921MvyzqS','getRawMany','请先配置百度统计siteId','order','default','defineProperty','getBaiduStatistics','countNewMidhourneysToday','getOwnPropertyDescriptor','OrderEntity','../../common/utils/date','ConfigEntity','configVal','countDrawsByTimeRange','select','countNewUsersToday','countNewOrdersToday','142587HXZXEW','setDate','chatLog','orderEntity','user.createdAt\x20>=\x20:today','get','configEntity','typeorm','baiduToken','百度授权码过期','__decorate','chatLog.type\x20=\x20:type','formatDate','../../common/constants/balance.constant','getCount','date','260802JShRPh','push','DeductionKey','midjourney.createdAt\x20<\x20:tomorrow','6lZCeIj','midjourney.status\x20=\x20:status','chatlog','../../common/constants/midjourney.constant','setHours','getBaseStatistic','count','BAD_REQUEST','decorate','95746OLvfte','CHAT_TYPE','countMjDrawsByTimeRange','__param','getDate','../user/user.entity','user','createQueryBuilder','getTime','map','ChatLogEntity','获取百度统计数据失败','HttpStatus','andWhere','YYYYMMDD','../globalConfig/config.entity','midjourney','DRAWED','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','M.DD','chatlog.createdAt\x20>=\x20:startDate','midjourney.createdAt\x20>=\x20:today','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','Repository','Injectable'];_0x50da=function(){return _0x652378;};return _0x50da();}var __decorate=this&&this[_0x56684f(0x14d)]||function(_0x1cc886,_0x3a6e86,_0xf03fdc,_0x2c1834){const _0x14e74d=_0x56684f;var _0xc8a920=arguments[_0x14e74d(0x108)],_0x1707b4=_0xc8a920<0x3?_0x3a6e86:_0x2c1834===null?_0x2c1834=Object[_0x14e74d(0x13a)](_0x3a6e86,_0xf03fdc):_0x2c1834,_0x52562a;if(typeof Reflect===_0x14e74d(0x10f)&&typeof Reflect['decorate']===_0x14e74d(0x12f))_0x1707b4=Reflect[_0x14e74d(0x15f)](_0x1cc886,_0x3a6e86,_0xf03fdc,_0x2c1834);else{for(var _0xce6c35=_0x1cc886['length']-0x1;_0xce6c35>=0x0;_0xce6c35--)if(_0x52562a=_0x1cc886[_0xce6c35])_0x1707b4=(_0xc8a920<0x3?_0x52562a(_0x1707b4):_0xc8a920>0x3?_0x52562a(_0x3a6e86,_0xf03fdc,_0x1707b4):_0x52562a(_0x3a6e86,_0xf03fdc))||_0x1707b4;}return _0xc8a920>0x3&&_0x1707b4&&Object['defineProperty'](_0x3a6e86,_0xf03fdc,_0x1707b4),_0x1707b4;},__metadata=this&&this[_0x56684f(0x11a)]||function(_0x40f646,_0x339627){const _0x117fd3=_0x56684f;if(typeof Reflect==='object'&&typeof Reflect[_0x117fd3(0x105)]==='function')return Reflect[_0x117fd3(0x105)](_0x40f646,_0x339627);},__param=this&&this[_0x56684f(0x163)]||function(_0xe9b572,_0x4233cb){return function(_0x47ddc5,_0xbe894a){_0x4233cb(_0x47ddc5,_0xbe894a,_0xe9b572);};};Object[_0x56684f(0x137)](exports,_0x56684f(0x12b),{'value':!![]}),exports[_0x56684f(0x10a)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x56684f(0x111)),user_entity_1=require(_0x56684f(0x165)),typeorm_2=require(_0x56684f(0x14a)),chatLog_entity_1=require(_0x56684f(0x117)),balance_constant_1=require(_0x56684f(0x150)),date_1=require(_0x56684f(0x13c)),axios_1=require('axios'),config_entity_1=require(_0x56684f(0x16f)),order_entity_1=require(_0x56684f(0x10d)),midjourney_entity_1=require(_0x56684f(0x116)),midjourney_constant_1=require(_0x56684f(0x15a));function _0x5af7(_0x81e8ce,_0x1aaec2){const _0x50da61=_0x50da();return _0x5af7=function(_0x5af7d3,_0x49493d){_0x5af7d3=_0x5af7d3-0x100;let _0x3f6202=_0x50da61[_0x5af7d3];return _0x3f6202;},_0x5af7(_0x81e8ce,_0x1aaec2);}let StatisticService=class StatisticService{constructor(_0x2cb1a5,_0x293a97,_0x14885c,_0xd610c1,_0x317284){const _0x137bad=_0x56684f;this['userEntity']=_0x2cb1a5,this[_0x137bad(0x106)]=_0x293a97,this[_0x137bad(0x149)]=_0x14885c,this[_0x137bad(0x146)]=_0xd610c1,this[_0x137bad(0x113)]=_0x317284;}async[_0x56684f(0x15c)](){const _0x42c842=_0x56684f,_0x4bbbfb=await this['countUsers'](),_0x54b5ca=await this['countNewUsersToday'](),_0x503b57=await this[_0x42c842(0x11b)](),_0x293874=await this[_0x42c842(0x10c)](),_0xb32a02=await this['countDraws'](),_0x1e20d9=await this['countNewDrawsToday'](),_0x189870=await this[_0x42c842(0x139)](),_0x41e686=await this[_0x42c842(0x122)](),_0x489cfe=await this['countNewOrdersToday']();return{'userCount':_0x4bbbfb,'newUserCount':_0x54b5ca,'chatCount':_0x503b57,'newChatCount':_0x293874,'drawCount':_0xb32a02,'newDrawCount':_0x189870+_0x1e20d9,'orderCount':_0x41e686,'newOrderCount':_0x489cfe};}async[_0x56684f(0x129)]({days:days=0x7}){const _0x3b6937=_0x56684f,_0x39b580=await this[_0x3b6937(0x11d)](days),_0x21eb2c=await this[_0x3b6937(0x13f)](days),_0x5357d4=await this[_0x3b6937(0x162)](days);return{'date':_0x39b580[_0x3b6937(0x169)](_0x2e2e24=>_0x2e2e24[_0x3b6937(0x152)]),'chat':_0x39b580[_0x3b6937(0x169)](_0x89be6f=>_0x89be6f['value']),'draw':_0x21eb2c[_0x3b6937(0x169)]((_0x1510a3,_0x2736d1)=>{const _0x5618fb=_0x3b6937;return _0x1510a3['value']+_0x5357d4[_0x2736d1][_0x5618fb(0x11f)];})};}async[_0x56684f(0x10b)]({days:days=0x7}){const _0x11579f=await this['getBaiduStatistics'](days);return _0x11579f;}async['countUsers'](){const _0xbb2bd9=_0x56684f,_0x436f33=await this[_0xbb2bd9(0x12a)][_0xbb2bd9(0x15d)]();return _0x436f33;}async[_0x56684f(0x141)](){const _0x4784e2=_0x56684f,_0x5a4af1=new Date();_0x5a4af1[_0x4784e2(0x15b)](0x0,0x0,0x0,0x0);const _0x259525=new Date(_0x5a4af1['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x1053c6=this['userEntity']['createQueryBuilder'](_0x4784e2(0x166)),_0x5801ea=await _0x1053c6['where'](_0x4784e2(0x147),{'today':_0x5a4af1})[_0x4784e2(0x16d)]('user.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x259525})['getCount']();return _0x5801ea;}async[_0x56684f(0x11b)](){const _0x178ee6=_0x56684f,_0x349020=await this[_0x178ee6(0x106)]['count']({'where':{'type':balance_constant_1['DeductionKey'][_0x178ee6(0x161)]}});return _0x349020;}async['countNewChatsToday'](){const _0x250949=_0x56684f,_0x1ae677=new Date();_0x1ae677['setHours'](0x0,0x0,0x0,0x0);const _0x40ebf8=new Date(_0x1ae677[_0x250949(0x168)]()+0x18*0x3c*0x3c*0x3e8),_0x8edcfc=this['chatLogEntity'][_0x250949(0x167)](_0x250949(0x145)),_0x1ac762=await _0x8edcfc[_0x250949(0x131)](_0x250949(0x14e),{'type':balance_constant_1[_0x250949(0x155)][_0x250949(0x161)]})[_0x250949(0x16d)](_0x250949(0x130),{'today':_0x1ae677})[_0x250949(0x16d)](_0x250949(0x103),{'tomorrow':_0x40ebf8})['getCount']();return _0x1ac762;}async['countDraws'](){const _0x5788ca=_0x56684f,_0x3ee02a=await this[_0x5788ca(0x106)][_0x5788ca(0x15d)]({'where':{'type':balance_constant_1[_0x5788ca(0x155)][_0x5788ca(0x107)]}});return _0x3ee02a;}async[_0x56684f(0x110)](){const _0xeecbca=_0x56684f,_0x2b793b=new Date();_0x2b793b[_0xeecbca(0x15b)](0x0,0x0,0x0,0x0);const _0x277ad6=new Date(_0x2b793b[_0xeecbca(0x168)]()+0x18*0x3c*0x3c*0x3e8),_0x5417c4=this[_0xeecbca(0x106)][_0xeecbca(0x167)](_0xeecbca(0x145)),_0xb4499d=await _0x5417c4[_0xeecbca(0x131)](_0xeecbca(0x14e),{'type':balance_constant_1['DeductionKey']['PAINT_TYPE']})['andWhere'](_0xeecbca(0x130),{'today':_0x2b793b})['andWhere'](_0xeecbca(0x103),{'tomorrow':_0x277ad6})['getCount']();return _0xb4499d;}async[_0x56684f(0x139)](){const _0x43e5fc=_0x56684f,_0x1d2516=new Date();_0x1d2516[_0x43e5fc(0x15b)](0x0,0x0,0x0,0x0);const _0xe89e56=new Date(_0x1d2516[_0x43e5fc(0x168)]()+0x18*0x3c*0x3c*0x3e8),_0x196dd8=this[_0x43e5fc(0x113)][_0x43e5fc(0x167)](_0x43e5fc(0x170)),_0x5a3008=await _0x196dd8[_0x43e5fc(0x131)](_0x43e5fc(0x175),{'today':_0x1d2516})['andWhere'](_0x43e5fc(0x156),{'tomorrow':_0xe89e56})[_0x43e5fc(0x151)]();return _0x5a3008;}async[_0x56684f(0x11d)](_0x291442){const _0x3de26c=_0x56684f;var _0x366f8d,_0x789435;const _0x56b28f=new Date();_0x56b28f['setHours'](0x0,0x0,0x0,0x0);const _0x50592e=new Date(_0x56b28f['getTime']()-(_0x291442-0x1)*0x18*0x3c*0x3c*0x3e8),_0x2ea2c3=this['chatLogEntity'][_0x3de26c(0x167)](_0x3de26c(0x159)),_0x3aee27=await _0x2ea2c3[_0x3de26c(0x140)](_0x3de26c(0x118))['where'](_0x3de26c(0x121),{'type':balance_constant_1[_0x3de26c(0x155)][_0x3de26c(0x161)]})[_0x3de26c(0x16d)](_0x3de26c(0x174),{'startDate':_0x50592e})['groupBy'](_0x3de26c(0x152))['orderBy'](_0x3de26c(0x152))['getRawMany'](),_0x447dee=[],_0x1b8130=_0x50592e;for(let _0x556c18=0x0;_0x556c18<_0x291442;_0x556c18++){const _0xc6cb62=(0x0,date_1[_0x3de26c(0x14f)])(new Date(_0x1b8130),_0x3de26c(0x173)),_0xd98232=(_0x789435=(_0x366f8d=_0x3aee27[_0x3de26c(0x124)](_0x28a5ad=>(0x0,date_1['formatDate'])(new Date(_0x28a5ad[_0x3de26c(0x152)]),_0x3de26c(0x173))===_0xc6cb62))===null||_0x366f8d===void 0x0?void 0x0:_0x366f8d[_0x3de26c(0x15d)])!==null&&_0x789435!==void 0x0?_0x789435:0x0;_0xd98232>0x0?_0x447dee['push']({'date':_0xc6cb62,'value':Number(_0xd98232)}):_0x447dee['push']({'date':_0xc6cb62,'value':0x0}),_0x1b8130[_0x3de26c(0x144)](_0x1b8130[_0x3de26c(0x164)]()+0x1);}return _0x447dee;}async[_0x56684f(0x13f)](_0x27d67e){const _0x56c75b=_0x56684f;var _0x479a55,_0x2f2ed2;const _0x437d84=new Date();_0x437d84[_0x56c75b(0x15b)](0x0,0x0,0x0,0x0);const _0x4c04f7=new Date(_0x437d84[_0x56c75b(0x168)]()-(_0x27d67e-0x1)*0x18*0x3c*0x3c*0x3e8),_0x464269=this[_0x56c75b(0x106)][_0x56c75b(0x167)](_0x56c75b(0x159)),_0x3a46d9=await _0x464269[_0x56c75b(0x140)]('DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')[_0x56c75b(0x131)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x56c75b(0x155)][_0x56c75b(0x107)]})['andWhere'](_0x56c75b(0x174),{'startDate':_0x4c04f7})[_0x56c75b(0x12d)](_0x56c75b(0x152))[_0x56c75b(0x109)]('date')[_0x56c75b(0x133)](),_0x5e3392=[],_0x30ca65=_0x4c04f7;for(let _0x59f217=0x0;_0x59f217<_0x27d67e;_0x59f217++){const _0x562ce9=(0x0,date_1['formatDate'])(new Date(_0x30ca65),_0x56c75b(0x173)),_0x263143=(_0x2f2ed2=(_0x479a55=_0x3a46d9[_0x56c75b(0x124)](_0x16ccbf=>(0x0,date_1['formatDate'])(new Date(_0x16ccbf[_0x56c75b(0x152)]),_0x56c75b(0x173))===_0x562ce9))===null||_0x479a55===void 0x0?void 0x0:_0x479a55[_0x56c75b(0x15d)])!==null&&_0x2f2ed2!==void 0x0?_0x2f2ed2:0x0;_0x263143>0x0?_0x5e3392[_0x56c75b(0x154)]({'date':_0x562ce9,'value':Number(_0x263143)}):_0x5e3392['push']({'date':_0x562ce9,'value':0x0}),_0x30ca65[_0x56c75b(0x144)](_0x30ca65[_0x56c75b(0x164)]()+0x1);}return _0x5e3392;}async[_0x56684f(0x162)](_0x1ab0a3){const _0xf36a82=_0x56684f;var _0x13d21a,_0x33290c;const _0x22660b=new Date();_0x22660b[_0xf36a82(0x15b)](0x0,0x0,0x0,0x0);const _0x43893d=new Date(_0x22660b[_0xf36a82(0x168)]()-(_0x1ab0a3-0x1)*0x18*0x3c*0x3c*0x3e8),_0x2d3b57=this[_0xf36a82(0x113)]['createQueryBuilder'](_0xf36a82(0x170)),_0x402661=await _0x2d3b57[_0xf36a82(0x140)](_0xf36a82(0x172))[_0xf36a82(0x131)](_0xf36a82(0x158),{'status':midjourney_constant_1['MidjourneyStatusEnum'][_0xf36a82(0x171)]})[_0xf36a82(0x16d)](_0xf36a82(0x128),{'startDate':_0x43893d})[_0xf36a82(0x12d)](_0xf36a82(0x152))[_0xf36a82(0x109)]('date')['getRawMany'](),_0x1bbed2=[],_0x4d0aaf=_0x43893d;for(let _0x4e3719=0x0;_0x4e3719<_0x1ab0a3;_0x4e3719++){const _0x69e50f=(0x0,date_1[_0xf36a82(0x14f)])(new Date(_0x4d0aaf),'M.DD'),_0x40c021=(_0x33290c=(_0x13d21a=_0x402661[_0xf36a82(0x124)](_0x2846fd=>(0x0,date_1['formatDate'])(new Date(_0x2846fd[_0xf36a82(0x152)]),_0xf36a82(0x173))===_0x69e50f))===null||_0x13d21a===void 0x0?void 0x0:_0x13d21a[_0xf36a82(0x15d)])!==null&&_0x33290c!==void 0x0?_0x33290c:0x0;_0x40c021>0x0?_0x1bbed2[_0xf36a82(0x154)]({'date':_0x69e50f,'value':Number(_0x40c021)}):_0x1bbed2[_0xf36a82(0x154)]({'date':_0x69e50f,'value':0x0}),_0x4d0aaf['setDate'](_0x4d0aaf['getDate']()+0x1);}return _0x1bbed2;}async[_0x56684f(0x138)](_0x32d036){const _0x1b0d78=_0x56684f;var _0x4cb88b,_0x313b11;const _0xba3011=(0x0,date_1[_0x1b0d78(0x14f)])(new Date(),'YYYYMMDD'),_0x15aff4=(0x0,date_1['formatDate'])(new Date(Date['now']()-Number(_0x32d036-0x1)*0x18*0x3c*0x3c*0x3e8),_0x1b0d78(0x16e)),_0x255608=_0x1b0d78(0x100),_0x38b15c=_0x1b0d78(0x112),_0x4a83f9=await this[_0x1b0d78(0x149)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x1b0d78(0x14b),_0x1b0d78(0x120)])}}),_0x5f5115=(_0x4cb88b=_0x4a83f9[_0x1b0d78(0x124)](_0x400b22=>_0x400b22[_0x1b0d78(0x123)]===_0x1b0d78(0x120)))===null||_0x4cb88b===void 0x0?void 0x0:_0x4cb88b['configVal'],_0x8b3691=(_0x313b11=_0x4a83f9[_0x1b0d78(0x124)](_0xbcddda=>_0xbcddda[_0x1b0d78(0x123)]==='baiduToken'))===null||_0x313b11===void 0x0?void 0x0:_0x313b11[_0x1b0d78(0x13e)];if(!_0x5f5115||!_0x8b3691)return[];if(!_0x5f5115)throw new common_1[(_0x1b0d78(0x115))](_0x1b0d78(0x134),common_1['HttpStatus'][_0x1b0d78(0x15e)]);if(!_0x8b3691)throw new common_1[(_0x1b0d78(0x115))](_0x1b0d78(0x126),common_1[_0x1b0d78(0x16c)][_0x1b0d78(0x15e)]);const _0x426aad=_0x1b0d78(0x12c)+_0x8b3691+'&site_id='+_0x5f5115+'&method='+_0x38b15c+'&start_date='+_0x15aff4+'&end_date='+_0xba3011+_0x1b0d78(0x10e)+_0x255608,_0x15eb1a=await axios_1[_0x1b0d78(0x136)][_0x1b0d78(0x148)](_0x426aad),{error_code:_0x4bfe68,message:_0x18fc0f}=_0x15eb1a[_0x1b0d78(0x104)];if(_0x4bfe68===0x6f)throw new common_1[(_0x1b0d78(0x115))](_0x18fc0f||_0x1b0d78(0x14c),common_1[_0x1b0d78(0x16c)][_0x1b0d78(0x15e)]);if(_0x4bfe68&&_0x4bfe68!==0xc8)throw new common_1[(_0x1b0d78(0x115))](_0x18fc0f||_0x1b0d78(0x16b),common_1[_0x1b0d78(0x16c)][_0x1b0d78(0x15e)]);return _0x15eb1a[_0x1b0d78(0x104)][_0x1b0d78(0x11c)];}async['countOrders'](){const _0x38fd58=_0x56684f,_0x1e48ef=await this[_0x38fd58(0x146)]['count']();return _0x1e48ef;}async[_0x56684f(0x142)](){const _0x5e3c25=_0x56684f,_0x4b4e1c=new Date();_0x4b4e1c[_0x5e3c25(0x15b)](0x0,0x0,0x0,0x0);const _0x52a7f1=new Date(_0x4b4e1c[_0x5e3c25(0x168)]()+0x18*0x3c*0x3c*0x3e8),_0x451f87=this['orderEntity']['createQueryBuilder'](_0x5e3c25(0x135)),_0x161291=await _0x451f87[_0x5e3c25(0x131)]('order.createdAt\x20>=\x20:today',{'today':_0x4b4e1c})[_0x5e3c25(0x16d)](_0x5e3c25(0x11e),{'tomorrow':_0x52a7f1})[_0x5e3c25(0x151)]();return _0x161291;}};StatisticService=__decorate([(0x0,common_1[_0x56684f(0x102)])(),__param(0x0,(0x0,typeorm_1[_0x56684f(0x119)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x56684f(0x119)])(chatLog_entity_1[_0x56684f(0x16a)])),__param(0x2,(0x0,typeorm_1[_0x56684f(0x119)])(config_entity_1[_0x56684f(0x13d)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x56684f(0x13b)])),__param(0x4,(0x0,typeorm_1[_0x56684f(0x119)])(midjourney_entity_1['MidjourneyEntity'])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x56684f(0x101)],typeorm_2[_0x56684f(0x101)],typeorm_2['Repository']])],StatisticService),exports[_0x56684f(0x10a)]=StatisticService;