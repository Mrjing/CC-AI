'use strict';function _0x89fa(_0x490737,_0x4d7cb3){const _0x5b392b=_0x5b39();return _0x89fa=function(_0x89faea,_0x2b328c){_0x89faea=_0x89faea-0x144;let _0x43ec44=_0x5b392b[_0x89faea];return _0x43ec44;},_0x89fa(_0x490737,_0x4d7cb3);}const _0x58877b=_0x89fa;function _0x5b39(){const _0x3e9ce7=['chatLogEntity','ConfigEntity','now','get','setHours','groupBy','baiduToken','M.DD','PAINT_TYPE','chatLog.type\x20=\x20:type','push','midjourney.createdAt\x20<\x20:tomorrow','find','&method=','4381230iCaVux','midjourney.createdAt\x20>=\x20:today','orderBy','getBaiduStatistics','decorate','midjourneyEntity','MidjourneyStatusEnum','typeorm','1395556QilORA','configEntity','getBaseStatistic','Injectable','configKey','&start_date=','value','获取百度统计数据失败','midjourney.status\x20=\x20:status','order','Repository','12462111IfDTHa','1550272nLdwyk','YYYYMMDD','select','countChatsByTimeRange','&site_id=','date','chatLog.createdAt\x20<\x20:tomorrow','../globalConfig/config.entity','BAD_REQUEST','andWhere','data','createQueryBuilder','order.createdAt\x20>=\x20:today','DeductionKey','function','getOwnPropertyDescriptor','getChatStatistic','MidjourneyEntity','../chatLog/chatLog.entity','countNewMidhourneysToday','where','OrderEntity','请先配置百度统计accessToken','length','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','HttpException','metadata','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','chatLog.createdAt\x20>=\x20:today','__esModule','design:paramtypes','defineProperty','@nestjs/common','countChats','10238680JhuqCr','chatlog.createdAt\x20>=\x20:startDate','getCount','1889796GLHhWV','&end_date=','../../common/constants/balance.constant','countNewOrdersToday','overview/getTimeTrendRpt','getRawMany','chatlog.type\x20=\x20:type','baiduSiteId','getDate','30PzyQeD','countNewChatsToday','百度授权码过期','../../common/utils/date','ChatLogEntity','StatisticService','user.createdAt\x20<\x20:tomorrow','setDate','HttpStatus','countUsers','orderEntity','configVal','countDrawsByTimeRange','6952729CFdAJi','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','chatlog','countDraws','CHAT_TYPE','formatDate','countNewUsersToday','midjourney','UserEntity','result','InjectRepository','count','getTime','user.createdAt\x20>=\x20:today','chatLog','user','__metadata','countNewDrawsToday','axios','default','5NUeAer','countMjDrawsByTimeRange','object','3ySJTVV','countOrders','map'];_0x5b39=function(){return _0x3e9ce7;};return _0x5b39();}(function(_0x129176,_0x36cd14){const _0x2ac545=_0x89fa,_0x14d30c=_0x129176();while(!![]){try{const _0x16877d=parseInt(_0x2ac545(0x170))/0x1+-parseInt(_0x2ac545(0x195))/0x2*(-parseInt(_0x2ac545(0x14b))/0x3)+parseInt(_0x2ac545(0x164))/0x4*(-parseInt(_0x2ac545(0x148))/0x5)+parseInt(_0x2ac545(0x15c))/0x6+parseInt(_0x2ac545(0x1ab))/0x7+parseInt(_0x2ac545(0x192))/0x8+-parseInt(_0x2ac545(0x16f))/0x9*(parseInt(_0x2ac545(0x19e))/0xa);if(_0x16877d===_0x36cd14)break;else _0x14d30c['push'](_0x14d30c['shift']());}catch(_0x47ec89){_0x14d30c['push'](_0x14d30c['shift']());}}}(_0x5b39,0xf30cb));var __decorate=this&&this['__decorate']||function(_0x1504a9,_0x429662,_0x540277,_0x1c45e3){const _0x4a4591=_0x89fa;var _0x512b5c=arguments['length'],_0xc48c0e=_0x512b5c<0x3?_0x429662:_0x1c45e3===null?_0x1c45e3=Object[_0x4a4591(0x17f)](_0x429662,_0x540277):_0x1c45e3,_0x41a821;if(typeof Reflect===_0x4a4591(0x14a)&&typeof Reflect[_0x4a4591(0x160)]===_0x4a4591(0x17e))_0xc48c0e=Reflect[_0x4a4591(0x160)](_0x1504a9,_0x429662,_0x540277,_0x1c45e3);else{for(var _0x599c81=_0x1504a9[_0x4a4591(0x187)]-0x1;_0x599c81>=0x0;_0x599c81--)if(_0x41a821=_0x1504a9[_0x599c81])_0xc48c0e=(_0x512b5c<0x3?_0x41a821(_0xc48c0e):_0x512b5c>0x3?_0x41a821(_0x429662,_0x540277,_0xc48c0e):_0x41a821(_0x429662,_0x540277))||_0xc48c0e;}return _0x512b5c>0x3&&_0xc48c0e&&Object[_0x4a4591(0x18f)](_0x429662,_0x540277,_0xc48c0e),_0xc48c0e;},__metadata=this&&this[_0x58877b(0x144)]||function(_0x1ac5b1,_0x292451){const _0x3bf522=_0x58877b;if(typeof Reflect==='object'&&typeof Reflect[_0x3bf522(0x18a)]==='function')return Reflect['metadata'](_0x1ac5b1,_0x292451);},__param=this&&this['__param']||function(_0xb236f5,_0x379e45){return function(_0x52e032,_0x35efe2){_0x379e45(_0x52e032,_0x35efe2,_0xb236f5);};};Object[_0x58877b(0x18f)](exports,_0x58877b(0x18d),{'value':!![]}),exports[_0x58877b(0x1a3)]=void 0x0;const common_1=require(_0x58877b(0x190)),typeorm_1=require('@nestjs/typeorm'),user_entity_1=require('../user/user.entity'),typeorm_2=require(_0x58877b(0x163)),chatLog_entity_1=require(_0x58877b(0x182)),balance_constant_1=require(_0x58877b(0x197)),date_1=require(_0x58877b(0x1a1)),axios_1=require(_0x58877b(0x146)),config_entity_1=require(_0x58877b(0x177)),order_entity_1=require('../order/order.entity'),midjourney_entity_1=require('../midjourney/midjourney.entity'),midjourney_constant_1=require('../../common/constants/midjourney.constant');let StatisticService=class StatisticService{constructor(_0x1cab23,_0x313175,_0x3a6466,_0x102ec8,_0x46e0f0){const _0x54b506=_0x58877b;this['userEntity']=_0x1cab23,this[_0x54b506(0x14e)]=_0x313175,this[_0x54b506(0x165)]=_0x3a6466,this[_0x54b506(0x1a8)]=_0x102ec8,this[_0x54b506(0x161)]=_0x46e0f0;}async[_0x58877b(0x166)](){const _0x1c99d7=_0x58877b,_0x1f8b68=await this[_0x1c99d7(0x1a7)](),_0x5d32d8=await this['countNewUsersToday'](),_0x1bbad6=await this[_0x1c99d7(0x191)](),_0x758cd=await this[_0x1c99d7(0x19f)](),_0x28e9be=await this[_0x1c99d7(0x1ae)](),_0x1de9ab=await this[_0x1c99d7(0x145)](),_0x286a7d=await this[_0x1c99d7(0x183)](),_0x412b35=await this[_0x1c99d7(0x14c)](),_0x90850e=await this[_0x1c99d7(0x198)]();return{'userCount':_0x1f8b68,'newUserCount':_0x5d32d8,'chatCount':_0x1bbad6,'newChatCount':_0x758cd,'drawCount':_0x28e9be,'newDrawCount':_0x286a7d+_0x1de9ab,'orderCount':_0x412b35,'newOrderCount':_0x90850e};}async[_0x58877b(0x180)]({days:days=0x7}){const _0x5715ad=_0x58877b,_0x1491a4=await this[_0x5715ad(0x173)](days),_0x51351c=await this[_0x5715ad(0x1aa)](days),_0x16bac1=await this[_0x5715ad(0x149)](days);return{'date':_0x1491a4[_0x5715ad(0x14d)](_0x5c88cf=>_0x5c88cf['date']),'chat':_0x1491a4[_0x5715ad(0x14d)](_0x11947d=>_0x11947d[_0x5715ad(0x16a)]),'draw':_0x51351c[_0x5715ad(0x14d)]((_0x536fa3,_0x5b68ed)=>{const _0x5d22d4=_0x5715ad;return _0x536fa3['value']+_0x16bac1[_0x5b68ed][_0x5d22d4(0x16a)];})};}async['getBaiduVisit']({days:days=0x7}){const _0x3f5115=_0x58877b,_0x527b2b=await this[_0x3f5115(0x15f)](days);return _0x527b2b;}async[_0x58877b(0x1a7)](){const _0x4bd9a9=await this['userEntity']['count']();return _0x4bd9a9;}async[_0x58877b(0x1b1)](){const _0x2c50d7=_0x58877b,_0x4d0ded=new Date();_0x4d0ded[_0x2c50d7(0x152)](0x0,0x0,0x0,0x0);const _0x550f7f=new Date(_0x4d0ded['getTime']()+0x18*0x3c*0x3c*0x3e8),_0xd8abfc=this['userEntity']['createQueryBuilder'](_0x2c50d7(0x1ba)),_0x5d48ce=await _0xd8abfc['where'](_0x2c50d7(0x1b8),{'today':_0x4d0ded})[_0x2c50d7(0x179)](_0x2c50d7(0x1a4),{'tomorrow':_0x550f7f})[_0x2c50d7(0x194)]();return _0x5d48ce;}async[_0x58877b(0x191)](){const _0x3adc13=_0x58877b,_0x4f1d1d=await this[_0x3adc13(0x14e)][_0x3adc13(0x1b6)]({'where':{'type':balance_constant_1[_0x3adc13(0x17d)][_0x3adc13(0x1af)]}});return _0x4f1d1d;}async[_0x58877b(0x19f)](){const _0xa17cdd=_0x58877b,_0x14a4ce=new Date();_0x14a4ce['setHours'](0x0,0x0,0x0,0x0);const _0x4280f7=new Date(_0x14a4ce[_0xa17cdd(0x1b7)]()+0x18*0x3c*0x3c*0x3e8),_0x24dec4=this[_0xa17cdd(0x14e)][_0xa17cdd(0x17b)]('chatLog'),_0x5d471c=await _0x24dec4[_0xa17cdd(0x184)](_0xa17cdd(0x157),{'type':balance_constant_1[_0xa17cdd(0x17d)]['CHAT_TYPE']})[_0xa17cdd(0x179)]('chatLog.createdAt\x20>=\x20:today',{'today':_0x14a4ce})[_0xa17cdd(0x179)](_0xa17cdd(0x176),{'tomorrow':_0x4280f7})['getCount']();return _0x5d471c;}async['countDraws'](){const _0x3d8146=_0x58877b,_0x5d5a15=await this['chatLogEntity'][_0x3d8146(0x1b6)]({'where':{'type':balance_constant_1[_0x3d8146(0x17d)]['PAINT_TYPE']}});return _0x5d5a15;}async[_0x58877b(0x145)](){const _0x3f1ebc=_0x58877b,_0x4eede9=new Date();_0x4eede9['setHours'](0x0,0x0,0x0,0x0);const _0x539be0=new Date(_0x4eede9[_0x3f1ebc(0x1b7)]()+0x18*0x3c*0x3c*0x3e8),_0x5153f6=this['chatLogEntity']['createQueryBuilder'](_0x3f1ebc(0x1b9)),_0x22f0da=await _0x5153f6[_0x3f1ebc(0x184)](_0x3f1ebc(0x157),{'type':balance_constant_1['DeductionKey']['PAINT_TYPE']})[_0x3f1ebc(0x179)](_0x3f1ebc(0x18c),{'today':_0x4eede9})[_0x3f1ebc(0x179)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x539be0})[_0x3f1ebc(0x194)]();return _0x22f0da;}async[_0x58877b(0x183)](){const _0x144786=_0x58877b,_0x4652fa=new Date();_0x4652fa['setHours'](0x0,0x0,0x0,0x0);const _0x51951f=new Date(_0x4652fa['getTime']()+0x18*0x3c*0x3c*0x3e8),_0xb6470f=this['midjourneyEntity']['createQueryBuilder'](_0x144786(0x1b2)),_0xfe3498=await _0xb6470f[_0x144786(0x184)](_0x144786(0x15d),{'today':_0x4652fa})[_0x144786(0x179)](_0x144786(0x159),{'tomorrow':_0x51951f})[_0x144786(0x194)]();return _0xfe3498;}async[_0x58877b(0x173)](_0x37a529){const _0x56c4e2=_0x58877b;var _0xb6c223,_0xfd48bf;const _0x34180c=new Date();_0x34180c['setHours'](0x0,0x0,0x0,0x0);const _0x2b3cc3=new Date(_0x34180c[_0x56c4e2(0x1b7)]()-(_0x37a529-0x1)*0x18*0x3c*0x3c*0x3e8),_0x58df6d=this['chatLogEntity']['createQueryBuilder'](_0x56c4e2(0x1ad)),_0x59a159=await _0x58df6d[_0x56c4e2(0x172)]('DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')[_0x56c4e2(0x184)](_0x56c4e2(0x19b),{'type':balance_constant_1[_0x56c4e2(0x17d)]['CHAT_TYPE']})[_0x56c4e2(0x179)](_0x56c4e2(0x193),{'startDate':_0x2b3cc3})[_0x56c4e2(0x153)](_0x56c4e2(0x175))['orderBy'](_0x56c4e2(0x175))['getRawMany'](),_0x3c7c1f=[],_0x47f674=_0x2b3cc3;for(let _0x1955f1=0x0;_0x1955f1<_0x37a529;_0x1955f1++){const _0x265f01=(0x0,date_1[_0x56c4e2(0x1b0)])(new Date(_0x47f674),_0x56c4e2(0x155)),_0x44e27e=(_0xfd48bf=(_0xb6c223=_0x59a159['find'](_0x1dd753=>(0x0,date_1['formatDate'])(new Date(_0x1dd753['date']),_0x56c4e2(0x155))===_0x265f01))===null||_0xb6c223===void 0x0?void 0x0:_0xb6c223[_0x56c4e2(0x1b6)])!==null&&_0xfd48bf!==void 0x0?_0xfd48bf:0x0;_0x44e27e>0x0?_0x3c7c1f['push']({'date':_0x265f01,'value':Number(_0x44e27e)}):_0x3c7c1f[_0x56c4e2(0x158)]({'date':_0x265f01,'value':0x0}),_0x47f674[_0x56c4e2(0x1a5)](_0x47f674[_0x56c4e2(0x19d)]()+0x1);}return _0x3c7c1f;}async[_0x58877b(0x1aa)](_0x4fa5c1){const _0x31a6ec=_0x58877b;var _0x2a7da4,_0x4f2fd8;const _0x3f6757=new Date();_0x3f6757[_0x31a6ec(0x152)](0x0,0x0,0x0,0x0);const _0x2713bf=new Date(_0x3f6757[_0x31a6ec(0x1b7)]()-(_0x4fa5c1-0x1)*0x18*0x3c*0x3c*0x3e8),_0x368833=this[_0x31a6ec(0x14e)][_0x31a6ec(0x17b)](_0x31a6ec(0x1ad)),_0x1cf11d=await _0x368833['select']('DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')['where'](_0x31a6ec(0x19b),{'type':balance_constant_1['DeductionKey'][_0x31a6ec(0x156)]})['andWhere']('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x2713bf})['groupBy'](_0x31a6ec(0x175))[_0x31a6ec(0x15e)](_0x31a6ec(0x175))[_0x31a6ec(0x19a)](),_0x5002a2=[],_0x486bfb=_0x2713bf;for(let _0x448b5b=0x0;_0x448b5b<_0x4fa5c1;_0x448b5b++){const _0x329850=(0x0,date_1['formatDate'])(new Date(_0x486bfb),_0x31a6ec(0x155)),_0x50d8fa=(_0x4f2fd8=(_0x2a7da4=_0x1cf11d[_0x31a6ec(0x15a)](_0x441e1d=>(0x0,date_1['formatDate'])(new Date(_0x441e1d[_0x31a6ec(0x175)]),_0x31a6ec(0x155))===_0x329850))===null||_0x2a7da4===void 0x0?void 0x0:_0x2a7da4['count'])!==null&&_0x4f2fd8!==void 0x0?_0x4f2fd8:0x0;_0x50d8fa>0x0?_0x5002a2[_0x31a6ec(0x158)]({'date':_0x329850,'value':Number(_0x50d8fa)}):_0x5002a2[_0x31a6ec(0x158)]({'date':_0x329850,'value':0x0}),_0x486bfb[_0x31a6ec(0x1a5)](_0x486bfb[_0x31a6ec(0x19d)]()+0x1);}return _0x5002a2;}async[_0x58877b(0x149)](_0xb6bdf7){const _0xd60741=_0x58877b;var _0x3f2dff,_0x187f65;const _0x3aae67=new Date();_0x3aae67['setHours'](0x0,0x0,0x0,0x0);const _0xa29eb7=new Date(_0x3aae67[_0xd60741(0x1b7)]()-(_0xb6bdf7-0x1)*0x18*0x3c*0x3c*0x3e8),_0x144566=this[_0xd60741(0x161)]['createQueryBuilder']('midjourney'),_0x41eb0b=await _0x144566[_0xd60741(0x172)](_0xd60741(0x18b))[_0xd60741(0x184)](_0xd60741(0x16c),{'status':midjourney_constant_1[_0xd60741(0x162)]['DRAWED']})[_0xd60741(0x179)]('midjourney.createdAt\x20>=\x20:startDate',{'startDate':_0xa29eb7})['groupBy']('date')['orderBy'](_0xd60741(0x175))[_0xd60741(0x19a)](),_0x362dc5=[],_0x21300f=_0xa29eb7;for(let _0x13367c=0x0;_0x13367c<_0xb6bdf7;_0x13367c++){const _0x2bb7dd=(0x0,date_1[_0xd60741(0x1b0)])(new Date(_0x21300f),'M.DD'),_0x126450=(_0x187f65=(_0x3f2dff=_0x41eb0b[_0xd60741(0x15a)](_0x40f0a0=>(0x0,date_1[_0xd60741(0x1b0)])(new Date(_0x40f0a0['date']),'M.DD')===_0x2bb7dd))===null||_0x3f2dff===void 0x0?void 0x0:_0x3f2dff[_0xd60741(0x1b6)])!==null&&_0x187f65!==void 0x0?_0x187f65:0x0;_0x126450>0x0?_0x362dc5[_0xd60741(0x158)]({'date':_0x2bb7dd,'value':Number(_0x126450)}):_0x362dc5[_0xd60741(0x158)]({'date':_0x2bb7dd,'value':0x0}),_0x21300f['setDate'](_0x21300f['getDate']()+0x1);}return _0x362dc5;}async['getBaiduStatistics'](_0x222956){const _0x5e5ad6=_0x58877b;var _0x1fe96c,_0x5b3159;const _0x11fb45=(0x0,date_1[_0x5e5ad6(0x1b0)])(new Date(),_0x5e5ad6(0x171)),_0x6343de=(0x0,date_1[_0x5e5ad6(0x1b0)])(new Date(Date[_0x5e5ad6(0x150)]()-Number(_0x222956-0x1)*0x18*0x3c*0x3c*0x3e8),_0x5e5ad6(0x171)),_0x25d037=_0x5e5ad6(0x188),_0x33d8df=_0x5e5ad6(0x199),_0x4fb7da=await this['configEntity']['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x5e5ad6(0x154),_0x5e5ad6(0x19c)])}}),_0x312f3b=(_0x1fe96c=_0x4fb7da['find'](_0xbb5d0e=>_0xbb5d0e['configKey']===_0x5e5ad6(0x19c)))===null||_0x1fe96c===void 0x0?void 0x0:_0x1fe96c[_0x5e5ad6(0x1a9)],_0x2a1fc3=(_0x5b3159=_0x4fb7da[_0x5e5ad6(0x15a)](_0x5371eb=>_0x5371eb[_0x5e5ad6(0x168)]==='baiduToken'))===null||_0x5b3159===void 0x0?void 0x0:_0x5b3159[_0x5e5ad6(0x1a9)];if(!_0x312f3b||!_0x2a1fc3)return[];if(!_0x312f3b)throw new common_1['HttpException']('请先配置百度统计siteId',common_1[_0x5e5ad6(0x1a6)][_0x5e5ad6(0x178)]);if(!_0x2a1fc3)throw new common_1['HttpException'](_0x5e5ad6(0x186),common_1[_0x5e5ad6(0x1a6)][_0x5e5ad6(0x178)]);const _0x5d182d=_0x5e5ad6(0x1ac)+_0x2a1fc3+_0x5e5ad6(0x174)+_0x312f3b+_0x5e5ad6(0x15b)+_0x33d8df+_0x5e5ad6(0x169)+_0x6343de+_0x5e5ad6(0x196)+_0x11fb45+'&metrics='+_0x25d037,_0x2d71dd=await axios_1[_0x5e5ad6(0x147)][_0x5e5ad6(0x151)](_0x5d182d),{error_code:_0x25819a,message:_0x1431d2}=_0x2d71dd[_0x5e5ad6(0x17a)];if(_0x25819a===0x6f)throw new common_1['HttpException'](_0x1431d2||_0x5e5ad6(0x1a0),common_1[_0x5e5ad6(0x1a6)]['BAD_REQUEST']);if(_0x25819a&&_0x25819a!==0xc8)throw new common_1[(_0x5e5ad6(0x189))](_0x1431d2||_0x5e5ad6(0x16b),common_1['HttpStatus']['BAD_REQUEST']);return _0x2d71dd[_0x5e5ad6(0x17a)][_0x5e5ad6(0x1b4)];}async[_0x58877b(0x14c)](){const _0x51ca9b=_0x58877b,_0x31d22d=await this[_0x51ca9b(0x1a8)][_0x51ca9b(0x1b6)]();return _0x31d22d;}async[_0x58877b(0x198)](){const _0x2b9734=_0x58877b,_0x2c7086=new Date();_0x2c7086[_0x2b9734(0x152)](0x0,0x0,0x0,0x0);const _0x2c658f=new Date(_0x2c7086['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x11b4ca=this[_0x2b9734(0x1a8)][_0x2b9734(0x17b)](_0x2b9734(0x16d)),_0x134651=await _0x11b4ca['where'](_0x2b9734(0x17c),{'today':_0x2c7086})[_0x2b9734(0x179)]('order.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x2c658f})[_0x2b9734(0x194)]();return _0x134651;}};StatisticService=__decorate([(0x0,common_1[_0x58877b(0x167)])(),__param(0x0,(0x0,typeorm_1[_0x58877b(0x1b5)])(user_entity_1[_0x58877b(0x1b3)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x58877b(0x1a2)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x58877b(0x14f)])),__param(0x3,(0x0,typeorm_1[_0x58877b(0x1b5)])(order_entity_1[_0x58877b(0x185)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1[_0x58877b(0x181)])),__metadata(_0x58877b(0x18e),[typeorm_2[_0x58877b(0x16e)],typeorm_2[_0x58877b(0x16e)],typeorm_2['Repository'],typeorm_2[_0x58877b(0x16e)],typeorm_2[_0x58877b(0x16e)]])],StatisticService),exports['StatisticService']=StatisticService;