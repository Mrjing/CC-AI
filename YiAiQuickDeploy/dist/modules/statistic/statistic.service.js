'use strict';const _0x42cac4=_0x7b84;(function(_0x3871c9,_0x5dfc0f){const _0xbc66fb=_0x7b84,_0x4aae47=_0x3871c9();while(!![]){try{const _0x316e80=parseInt(_0xbc66fb(0x100))/0x1+parseInt(_0xbc66fb(0xee))/0x2+parseInt(_0xbc66fb(0xff))/0x3*(parseInt(_0xbc66fb(0x112))/0x4)+parseInt(_0xbc66fb(0x10b))/0x5*(parseInt(_0xbc66fb(0x113))/0x6)+-parseInt(_0xbc66fb(0x116))/0x7+-parseInt(_0xbc66fb(0x117))/0x8+-parseInt(_0xbc66fb(0xe1))/0x9;if(_0x316e80===_0x5dfc0f)break;else _0x4aae47['push'](_0x4aae47['shift']());}catch(_0x1800d0){_0x4aae47['push'](_0x4aae47['shift']());}}}(_0x3b44,0x4968c));var __decorate=this&&this[_0x42cac4(0x10f)]||function(_0x50d76b,_0x585c7c,_0x49b6bf,_0x26ee66){const _0x30c2f8=_0x42cac4;var _0x13d578=arguments[_0x30c2f8(0x102)],_0x555d02=_0x13d578<0x3?_0x585c7c:_0x26ee66===null?_0x26ee66=Object[_0x30c2f8(0xdc)](_0x585c7c,_0x49b6bf):_0x26ee66,_0x3eb25d;if(typeof Reflect===_0x30c2f8(0x144)&&typeof Reflect[_0x30c2f8(0x128)]==='function')_0x555d02=Reflect[_0x30c2f8(0x128)](_0x50d76b,_0x585c7c,_0x49b6bf,_0x26ee66);else{for(var _0x3937ee=_0x50d76b[_0x30c2f8(0x102)]-0x1;_0x3937ee>=0x0;_0x3937ee--)if(_0x3eb25d=_0x50d76b[_0x3937ee])_0x555d02=(_0x13d578<0x3?_0x3eb25d(_0x555d02):_0x13d578>0x3?_0x3eb25d(_0x585c7c,_0x49b6bf,_0x555d02):_0x3eb25d(_0x585c7c,_0x49b6bf))||_0x555d02;}return _0x13d578>0x3&&_0x555d02&&Object['defineProperty'](_0x585c7c,_0x49b6bf,_0x555d02),_0x555d02;},__metadata=this&&this['__metadata']||function(_0x34c67f,_0x345097){const _0x4a6f33=_0x42cac4;if(typeof Reflect===_0x4a6f33(0x144)&&typeof Reflect[_0x4a6f33(0x140)]==='function')return Reflect[_0x4a6f33(0x140)](_0x34c67f,_0x345097);},__param=this&&this[_0x42cac4(0xfc)]||function(_0x1c23c8,_0x46e3f3){return function(_0x51017a,_0xcf8db0){_0x46e3f3(_0x51017a,_0xcf8db0,_0x1c23c8);};};Object[_0x42cac4(0xed)](exports,_0x42cac4(0x146),{'value':!![]}),exports['StatisticService']=void 0x0;function _0x3b44(){const _0xfd2718=['countNewDrawsToday','where','getOwnPropertyDescriptor','midjourney.createdAt\x20>=\x20:startDate','value','orderBy','getChatStatistic','5539905vUoVVx','HttpStatus','countChats','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','setDate','getCount','data','&end_date=','&method=','CHAT_TYPE','@nestjs/common','PAINT_TYPE','defineProperty','782376MFURcf','countNewMidhourneysToday','date','请先配置百度统计siteId','countOrders','createQueryBuilder','Injectable','midjourney.createdAt\x20>=\x20:today','countNewUsersToday','overview/getTimeTrendRpt','HttpException','configEntity','chatlog','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','__param','M.DD','countDraws','1039317zmNdMy','578174lOYnZX','chatlog.type\x20=\x20:type','length','chatLog.createdAt\x20>=\x20:today','countNewOrdersToday','map','../globalConfig/config.entity','chatLog','../order/order.entity','now','count','652045sYjccA','getTime','InjectRepository','chatlog.createdAt\x20>=\x20:startDate','__decorate','../user/user.entity','BAD_REQUEST','4sJtxcn','18uBKaHw','order.createdAt\x20>=\x20:today','default','2797228bumiwy','3129560tiwpZL','../../common/constants/balance.constant','countUsers','formatDate','../midjourney/midjourney.entity','百度授权码过期','groupBy','getDate','userEntity','chatLogEntity','DRAWED','midjourney.createdAt\x20<\x20:tomorrow','configKey','countNewChatsToday','midjourney','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','user.createdAt\x20<\x20:tomorrow','decorate','YYYYMMDD','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','chatLog.type\x20=\x20:type','countChatsByTimeRange','获取百度统计数据失败','UserEntity','order','midjourneyEntity','setHours','chatLog.createdAt\x20<\x20:tomorrow','Repository','find','baiduSiteId','select','countDrawsByTimeRange','MidjourneyEntity','push','order.createdAt\x20<\x20:tomorrow','andWhere','getRawMany','&metrics=','configVal','../../common/constants/midjourney.constant','metadata','user.createdAt\x20>=\x20:today','user','getBaiduStatistics','object','ChatLogEntity','__esModule','baiduToken','&site_id=','orderEntity','axios','design:paramtypes','DeductionKey'];_0x3b44=function(){return _0xfd2718;};return _0x3b44();}const common_1=require(_0x42cac4(0xeb)),typeorm_1=require('@nestjs/typeorm'),user_entity_1=require(_0x42cac4(0x110)),typeorm_2=require('typeorm'),chatLog_entity_1=require('../chatLog/chatLog.entity'),balance_constant_1=require(_0x42cac4(0x118)),date_1=require('../../common/utils/date'),axios_1=require(_0x42cac4(0x14a)),config_entity_1=require(_0x42cac4(0x106)),order_entity_1=require(_0x42cac4(0x108)),midjourney_entity_1=require(_0x42cac4(0x11b)),midjourney_constant_1=require(_0x42cac4(0x13f));function _0x7b84(_0x38213d,_0xaaa7b8){const _0x3b44e4=_0x3b44();return _0x7b84=function(_0x7b84e2,_0x3e9ebc){_0x7b84e2=_0x7b84e2-0xdb;let _0xc12b4=_0x3b44e4[_0x7b84e2];return _0xc12b4;},_0x7b84(_0x38213d,_0xaaa7b8);}let StatisticService=class StatisticService{constructor(_0x299f12,_0x3b8e81,_0x53a62e,_0x36012c,_0x26ea68){const _0x22954f=_0x42cac4;this[_0x22954f(0x11f)]=_0x299f12,this[_0x22954f(0x120)]=_0x3b8e81,this['configEntity']=_0x53a62e,this[_0x22954f(0x149)]=_0x36012c,this[_0x22954f(0x130)]=_0x26ea68;}async['getBaseStatistic'](){const _0x45abaa=_0x42cac4,_0x22f1be=await this['countUsers'](),_0x390265=await this[_0x45abaa(0xf6)](),_0x2beaeb=await this['countChats'](),_0x2880e0=await this[_0x45abaa(0x124)](),_0x580ec4=await this[_0x45abaa(0xfe)](),_0x216ca7=await this[_0x45abaa(0x14d)](),_0x2ef404=await this['countNewMidhourneysToday'](),_0x5cac84=await this['countOrders'](),_0x522829=await this['countNewOrdersToday']();return{'userCount':_0x22f1be,'newUserCount':_0x390265,'chatCount':_0x2beaeb,'newChatCount':_0x2880e0,'drawCount':_0x580ec4,'newDrawCount':_0x2ef404+_0x216ca7,'orderCount':_0x5cac84,'newOrderCount':_0x522829};}async[_0x42cac4(0xe0)]({days:days=0x7}){const _0x7d223a=_0x42cac4,_0x2cddf2=await this[_0x7d223a(0x12c)](days),_0x4f892a=await this[_0x7d223a(0x137)](days),_0x65dbf2=await this['countMjDrawsByTimeRange'](days);return{'date':_0x2cddf2[_0x7d223a(0x105)](_0x267efe=>_0x267efe[_0x7d223a(0xf0)]),'chat':_0x2cddf2[_0x7d223a(0x105)](_0x3d8898=>_0x3d8898['value']),'draw':_0x4f892a[_0x7d223a(0x105)]((_0x5a2297,_0x19975f)=>{const _0x1a78c2=_0x7d223a;return _0x5a2297['value']+_0x65dbf2[_0x19975f][_0x1a78c2(0xde)];})};}async['getBaiduVisit']({days:days=0x7}){const _0x12029c=_0x42cac4,_0x1db928=await this[_0x12029c(0x143)](days);return _0x1db928;}async[_0x42cac4(0x119)](){const _0x3dc917=_0x42cac4,_0xed2e50=await this[_0x3dc917(0x11f)][_0x3dc917(0x10a)]();return _0xed2e50;}async[_0x42cac4(0xf6)](){const _0x2e4afc=_0x42cac4,_0x3dc02a=new Date();_0x3dc02a[_0x2e4afc(0x131)](0x0,0x0,0x0,0x0);const _0x2224d5=new Date(_0x3dc02a[_0x2e4afc(0x10c)]()+0x18*0x3c*0x3c*0x3e8),_0x457e9c=this[_0x2e4afc(0x11f)][_0x2e4afc(0xf3)](_0x2e4afc(0x142)),_0x47d142=await _0x457e9c['where'](_0x2e4afc(0x141),{'today':_0x3dc02a})[_0x2e4afc(0x13b)](_0x2e4afc(0x127),{'tomorrow':_0x2224d5})['getCount']();return _0x47d142;}async[_0x42cac4(0xe3)](){const _0x2f7550=_0x42cac4,_0x1a58f2=await this[_0x2f7550(0x120)][_0x2f7550(0x10a)]({'where':{'type':balance_constant_1[_0x2f7550(0x14c)][_0x2f7550(0xea)]}});return _0x1a58f2;}async['countNewChatsToday'](){const _0x2c9b5a=_0x42cac4,_0x22b78c=new Date();_0x22b78c[_0x2c9b5a(0x131)](0x0,0x0,0x0,0x0);const _0x3ad41d=new Date(_0x22b78c['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x4e15ad=this[_0x2c9b5a(0x120)][_0x2c9b5a(0xf3)](_0x2c9b5a(0x107)),_0x36ff9f=await _0x4e15ad[_0x2c9b5a(0xdb)](_0x2c9b5a(0x12b),{'type':balance_constant_1[_0x2c9b5a(0x14c)]['CHAT_TYPE']})[_0x2c9b5a(0x13b)](_0x2c9b5a(0x103),{'today':_0x22b78c})[_0x2c9b5a(0x13b)](_0x2c9b5a(0x132),{'tomorrow':_0x3ad41d})['getCount']();return _0x36ff9f;}async['countDraws'](){const _0x1dfb08=_0x42cac4,_0x603b76=await this[_0x1dfb08(0x120)]['count']({'where':{'type':balance_constant_1['DeductionKey'][_0x1dfb08(0xec)]}});return _0x603b76;}async[_0x42cac4(0x14d)](){const _0x51e28f=_0x42cac4,_0x28daad=new Date();_0x28daad[_0x51e28f(0x131)](0x0,0x0,0x0,0x0);const _0x5492ca=new Date(_0x28daad[_0x51e28f(0x10c)]()+0x18*0x3c*0x3c*0x3e8),_0x35316b=this['chatLogEntity'][_0x51e28f(0xf3)](_0x51e28f(0x107)),_0x5b9aba=await _0x35316b['where'](_0x51e28f(0x12b),{'type':balance_constant_1['DeductionKey'][_0x51e28f(0xec)]})[_0x51e28f(0x13b)](_0x51e28f(0x103),{'today':_0x28daad})[_0x51e28f(0x13b)](_0x51e28f(0x132),{'tomorrow':_0x5492ca})[_0x51e28f(0xe6)]();return _0x5b9aba;}async[_0x42cac4(0xef)](){const _0x2e09cd=_0x42cac4,_0x1effa8=new Date();_0x1effa8['setHours'](0x0,0x0,0x0,0x0);const _0x12ad9e=new Date(_0x1effa8[_0x2e09cd(0x10c)]()+0x18*0x3c*0x3c*0x3e8),_0x4a27fb=this[_0x2e09cd(0x130)][_0x2e09cd(0xf3)](_0x2e09cd(0x125)),_0x249f57=await _0x4a27fb[_0x2e09cd(0xdb)](_0x2e09cd(0xf5),{'today':_0x1effa8})[_0x2e09cd(0x13b)](_0x2e09cd(0x122),{'tomorrow':_0x12ad9e})[_0x2e09cd(0xe6)]();return _0x249f57;}async['countChatsByTimeRange'](_0x53ac8b){const _0x4665b1=_0x42cac4;var _0xf1738d,_0x4f0490;const _0xd70476=new Date();_0xd70476['setHours'](0x0,0x0,0x0,0x0);const _0x28d62b=new Date(_0xd70476[_0x4665b1(0x10c)]()-(_0x53ac8b-0x1)*0x18*0x3c*0x3c*0x3e8),_0x43be4f=this[_0x4665b1(0x120)][_0x4665b1(0xf3)](_0x4665b1(0xfa)),_0x401bf1=await _0x43be4f['select'](_0x4665b1(0xfb))[_0x4665b1(0xdb)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x4665b1(0x14c)][_0x4665b1(0xea)]})[_0x4665b1(0x13b)](_0x4665b1(0x10e),{'startDate':_0x28d62b})[_0x4665b1(0x11d)](_0x4665b1(0xf0))[_0x4665b1(0xdf)](_0x4665b1(0xf0))[_0x4665b1(0x13c)](),_0x2c0a8a=[],_0x586852=_0x28d62b;for(let _0x55b2fa=0x0;_0x55b2fa<_0x53ac8b;_0x55b2fa++){const _0x45edc4=(0x0,date_1[_0x4665b1(0x11a)])(new Date(_0x586852),_0x4665b1(0xfd)),_0x5430e7=(_0x4f0490=(_0xf1738d=_0x401bf1[_0x4665b1(0x134)](_0x4e6ec2=>(0x0,date_1[_0x4665b1(0x11a)])(new Date(_0x4e6ec2['date']),_0x4665b1(0xfd))===_0x45edc4))===null||_0xf1738d===void 0x0?void 0x0:_0xf1738d[_0x4665b1(0x10a)])!==null&&_0x4f0490!==void 0x0?_0x4f0490:0x0;_0x5430e7>0x0?_0x2c0a8a[_0x4665b1(0x139)]({'date':_0x45edc4,'value':Number(_0x5430e7)}):_0x2c0a8a['push']({'date':_0x45edc4,'value':0x0}),_0x586852[_0x4665b1(0xe5)](_0x586852[_0x4665b1(0x11e)]()+0x1);}return _0x2c0a8a;}async[_0x42cac4(0x137)](_0x3f3fdf){const _0x1b8315=_0x42cac4;var _0x420e6b,_0x36793a;const _0x38086e=new Date();_0x38086e[_0x1b8315(0x131)](0x0,0x0,0x0,0x0);const _0x29c078=new Date(_0x38086e[_0x1b8315(0x10c)]()-(_0x3f3fdf-0x1)*0x18*0x3c*0x3c*0x3e8),_0x2ef3dd=this[_0x1b8315(0x120)][_0x1b8315(0xf3)](_0x1b8315(0xfa)),_0x3ea48f=await _0x2ef3dd[_0x1b8315(0x136)]('DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')[_0x1b8315(0xdb)](_0x1b8315(0x101),{'type':balance_constant_1[_0x1b8315(0x14c)][_0x1b8315(0xec)]})[_0x1b8315(0x13b)](_0x1b8315(0x10e),{'startDate':_0x29c078})[_0x1b8315(0x11d)](_0x1b8315(0xf0))[_0x1b8315(0xdf)](_0x1b8315(0xf0))[_0x1b8315(0x13c)](),_0x1c1008=[],_0x380c21=_0x29c078;for(let _0x2c6b6d=0x0;_0x2c6b6d<_0x3f3fdf;_0x2c6b6d++){const _0x4e9e1c=(0x0,date_1['formatDate'])(new Date(_0x380c21),'M.DD'),_0x1ec106=(_0x36793a=(_0x420e6b=_0x3ea48f[_0x1b8315(0x134)](_0x5e2bf4=>(0x0,date_1[_0x1b8315(0x11a)])(new Date(_0x5e2bf4['date']),_0x1b8315(0xfd))===_0x4e9e1c))===null||_0x420e6b===void 0x0?void 0x0:_0x420e6b['count'])!==null&&_0x36793a!==void 0x0?_0x36793a:0x0;_0x1ec106>0x0?_0x1c1008['push']({'date':_0x4e9e1c,'value':Number(_0x1ec106)}):_0x1c1008[_0x1b8315(0x139)]({'date':_0x4e9e1c,'value':0x0}),_0x380c21[_0x1b8315(0xe5)](_0x380c21['getDate']()+0x1);}return _0x1c1008;}async['countMjDrawsByTimeRange'](_0x3a2398){const _0x2454c3=_0x42cac4;var _0x5bbb43,_0x406891;const _0x5545f4=new Date();_0x5545f4[_0x2454c3(0x131)](0x0,0x0,0x0,0x0);const _0x365857=new Date(_0x5545f4[_0x2454c3(0x10c)]()-(_0x3a2398-0x1)*0x18*0x3c*0x3c*0x3e8),_0x3920d2=this[_0x2454c3(0x130)][_0x2454c3(0xf3)](_0x2454c3(0x125)),_0x171e02=await _0x3920d2[_0x2454c3(0x136)](_0x2454c3(0x12a))['where']('midjourney.status\x20=\x20:status',{'status':midjourney_constant_1['MidjourneyStatusEnum'][_0x2454c3(0x121)]})[_0x2454c3(0x13b)](_0x2454c3(0xdd),{'startDate':_0x365857})['groupBy']('date')['orderBy'](_0x2454c3(0xf0))[_0x2454c3(0x13c)](),_0x446858=[],_0x178998=_0x365857;for(let _0x4f10d5=0x0;_0x4f10d5<_0x3a2398;_0x4f10d5++){const _0x1be5a2=(0x0,date_1[_0x2454c3(0x11a)])(new Date(_0x178998),'M.DD'),_0x4f03de=(_0x406891=(_0x5bbb43=_0x171e02[_0x2454c3(0x134)](_0xee6a41=>(0x0,date_1['formatDate'])(new Date(_0xee6a41[_0x2454c3(0xf0)]),'M.DD')===_0x1be5a2))===null||_0x5bbb43===void 0x0?void 0x0:_0x5bbb43[_0x2454c3(0x10a)])!==null&&_0x406891!==void 0x0?_0x406891:0x0;_0x4f03de>0x0?_0x446858[_0x2454c3(0x139)]({'date':_0x1be5a2,'value':Number(_0x4f03de)}):_0x446858[_0x2454c3(0x139)]({'date':_0x1be5a2,'value':0x0}),_0x178998[_0x2454c3(0xe5)](_0x178998[_0x2454c3(0x11e)]()+0x1);}return _0x446858;}async[_0x42cac4(0x143)](_0x1f8f4a){const _0x3ea1db=_0x42cac4;var _0x185422,_0x3dae95;const _0x39ce7f=(0x0,date_1['formatDate'])(new Date(),_0x3ea1db(0x129)),_0x4a06fd=(0x0,date_1[_0x3ea1db(0x11a)])(new Date(Date[_0x3ea1db(0x109)]()-Number(_0x1f8f4a-0x1)*0x18*0x3c*0x3c*0x3e8),_0x3ea1db(0x129)),_0x3e9e77=_0x3ea1db(0x126),_0x3f791c=_0x3ea1db(0xf7),_0x58231f=await this[_0x3ea1db(0xf9)][_0x3ea1db(0x134)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x3ea1db(0x147),_0x3ea1db(0x135)])}}),_0x4515b8=(_0x185422=_0x58231f[_0x3ea1db(0x134)](_0xe09d40=>_0xe09d40['configKey']==='baiduSiteId'))===null||_0x185422===void 0x0?void 0x0:_0x185422[_0x3ea1db(0x13e)],_0xb49943=(_0x3dae95=_0x58231f[_0x3ea1db(0x134)](_0x59921b=>_0x59921b[_0x3ea1db(0x123)]===_0x3ea1db(0x147)))===null||_0x3dae95===void 0x0?void 0x0:_0x3dae95['configVal'];if(!_0x4515b8||!_0xb49943)return[];if(!_0x4515b8)throw new common_1[(_0x3ea1db(0xf8))](_0x3ea1db(0xf1),common_1[_0x3ea1db(0xe2)]['BAD_REQUEST']);if(!_0xb49943)throw new common_1[(_0x3ea1db(0xf8))]('请先配置百度统计accessToken',common_1[_0x3ea1db(0xe2)]['BAD_REQUEST']);const _0x2a2cda=_0x3ea1db(0xe4)+_0xb49943+_0x3ea1db(0x148)+_0x4515b8+_0x3ea1db(0xe9)+_0x3f791c+'&start_date='+_0x4a06fd+_0x3ea1db(0xe8)+_0x39ce7f+_0x3ea1db(0x13d)+_0x3e9e77,_0x1eef37=await axios_1[_0x3ea1db(0x115)]['get'](_0x2a2cda),{error_code:_0x314e50,message:_0x4bc166}=_0x1eef37['data'];if(_0x314e50===0x6f)throw new common_1[(_0x3ea1db(0xf8))](_0x4bc166||_0x3ea1db(0x11c),common_1[_0x3ea1db(0xe2)][_0x3ea1db(0x111)]);if(_0x314e50&&_0x314e50!==0xc8)throw new common_1[(_0x3ea1db(0xf8))](_0x4bc166||_0x3ea1db(0x12d),common_1[_0x3ea1db(0xe2)][_0x3ea1db(0x111)]);return _0x1eef37[_0x3ea1db(0xe7)]['result'];}async[_0x42cac4(0xf2)](){const _0x42e3b0=_0x42cac4,_0x5175a4=await this[_0x42e3b0(0x149)][_0x42e3b0(0x10a)]();return _0x5175a4;}async[_0x42cac4(0x104)](){const _0x1db3fd=_0x42cac4,_0x31836f=new Date();_0x31836f[_0x1db3fd(0x131)](0x0,0x0,0x0,0x0);const _0x555496=new Date(_0x31836f['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x5b489c=this[_0x1db3fd(0x149)]['createQueryBuilder'](_0x1db3fd(0x12f)),_0x4c8924=await _0x5b489c[_0x1db3fd(0xdb)](_0x1db3fd(0x114),{'today':_0x31836f})[_0x1db3fd(0x13b)](_0x1db3fd(0x13a),{'tomorrow':_0x555496})['getCount']();return _0x4c8924;}};StatisticService=__decorate([(0x0,common_1[_0x42cac4(0xf4)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x42cac4(0x12e)])),__param(0x1,(0x0,typeorm_1[_0x42cac4(0x10d)])(chatLog_entity_1[_0x42cac4(0x145)])),__param(0x2,(0x0,typeorm_1[_0x42cac4(0x10d)])(config_entity_1['ConfigEntity'])),__param(0x3,(0x0,typeorm_1[_0x42cac4(0x10d)])(order_entity_1['OrderEntity'])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1[_0x42cac4(0x138)])),__metadata(_0x42cac4(0x14b),[typeorm_2[_0x42cac4(0x133)],typeorm_2['Repository'],typeorm_2[_0x42cac4(0x133)],typeorm_2[_0x42cac4(0x133)],typeorm_2[_0x42cac4(0x133)]])],StatisticService),exports['StatisticService']=StatisticService;