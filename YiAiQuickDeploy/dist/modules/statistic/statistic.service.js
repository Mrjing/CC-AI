'use strict';const _0x157200=_0x3a88;function _0x3a88(_0x53a87a,_0x58c123){const _0x163ac8=_0x163a();return _0x3a88=function(_0x3a88f9,_0x53b268){_0x3a88f9=_0x3a88f9-0x1b6;let _0x4ff9a1=_0x163ac8[_0x3a88f9];return _0x4ff9a1;},_0x3a88(_0x53a87a,_0x58c123);}(function(_0x5c4944,_0x5ee0f1){const _0x1906c5=_0x3a88,_0x51e0c7=_0x5c4944();while(!![]){try{const _0x277876=parseInt(_0x1906c5(0x1f3))/0x1+parseInt(_0x1906c5(0x21f))/0x2*(-parseInt(_0x1906c5(0x1f0))/0x3)+parseInt(_0x1906c5(0x1d0))/0x4+-parseInt(_0x1906c5(0x1d9))/0x5*(-parseInt(_0x1906c5(0x1ea))/0x6)+-parseInt(_0x1906c5(0x202))/0x7+parseInt(_0x1906c5(0x216))/0x8*(-parseInt(_0x1906c5(0x1f8))/0x9)+-parseInt(_0x1906c5(0x214))/0xa;if(_0x277876===_0x5ee0f1)break;else _0x51e0c7['push'](_0x51e0c7['shift']());}catch(_0x46b8ad){_0x51e0c7['push'](_0x51e0c7['shift']());}}}(_0x163a,0xc62c7));function _0x163a(){const _0x51e8b7=['user.createdAt\x20<\x20:tomorrow','countUsers','user','user.createdAt\x20>=\x20:today','chatlog.type\x20=\x20:type','where','@nestjs/common','function','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','chatLog.createdAt\x20<\x20:tomorrow','decorate','orderEntity','@nestjs/typeorm','axios','OrderEntity','4521276jHhUbz','../../common/utils/date','get','UserEntity','CHAT_TYPE','createQueryBuilder','请先配置百度统计accessToken','formatDate','countChats','7283620mqyroZ','orderBy','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','midjourney','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','andWhere','YYYYMMDD','groupBy','PAINT_TYPE','configKey','countDrawsByTimeRange','find','&site_id=','chatLog','chatlog.createdAt\x20>=\x20:startDate','MidjourneyStatusEnum','&end_date=','6EJmJqe','metadata','百度授权码过期','default','getRawMany','setDate','30EyyTdV','BAD_REQUEST','Repository','136145TQTNXG','../order/order.entity','defineProperty','getBaiduStatistics','count','282447SqZKEf','../user/user.entity','请先配置百度统计siteId','midjourney.createdAt\x20>=\x20:startDate','baiduToken','overview/getTimeTrendRpt','&metrics=','configEntity','chatLogEntity','getChatStatistic','4832954rPTDcd','chatLog.type\x20=\x20:type','countNewUsersToday','getTime','MidjourneyEntity','data','date','setHours','../midjourney/midjourney.entity','midjourney.status\x20=\x20:status','../globalConfig/config.entity','chatLog.createdAt\x20>=\x20:today','baiduSiteId','__decorate','DRAWED','countNewMidhourneysToday','HttpStatus','getBaseStatistic','371040aBWlNp','userEntity','8AZmONh','midjourneyEntity','midjourney.createdAt\x20<\x20:tomorrow','push','StatisticService','getBaiduVisit','../../common/constants/balance.constant','design:paramtypes','value','230512QqYcxX','object','countOrders','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','&method=','select','countNewOrdersToday','DeductionKey','chatlog','countNewDrawsToday','countDraws','midjourney.createdAt\x20>=\x20:today','getCount','countMjDrawsByTimeRange','__param','configVal','getDate','__metadata','InjectRepository','getOwnPropertyDescriptor','HttpException','获取百度统计数据失败','order','length','order.createdAt\x20>=\x20:today','ChatLogEntity','map','countNewChatsToday','&start_date=','../chatLog/chatLog.entity','M.DD'];_0x163a=function(){return _0x51e8b7;};return _0x163a();}var __decorate=this&&this[_0x157200(0x20f)]||function(_0x16f9b5,_0x40a3fd,_0x2c0ce3,_0x206f0e){const _0x25dca4=_0x157200;var _0x134d19=arguments[_0x25dca4(0x1b9)],_0x29ab1b=_0x134d19<0x3?_0x40a3fd:_0x206f0e===null?_0x206f0e=Object[_0x25dca4(0x232)](_0x40a3fd,_0x2c0ce3):_0x206f0e,_0x5cd158;if(typeof Reflect===_0x25dca4(0x220)&&typeof Reflect[_0x25dca4(0x1cb)]==='function')_0x29ab1b=Reflect[_0x25dca4(0x1cb)](_0x16f9b5,_0x40a3fd,_0x2c0ce3,_0x206f0e);else{for(var _0x38d8d1=_0x16f9b5['length']-0x1;_0x38d8d1>=0x0;_0x38d8d1--)if(_0x5cd158=_0x16f9b5[_0x38d8d1])_0x29ab1b=(_0x134d19<0x3?_0x5cd158(_0x29ab1b):_0x134d19>0x3?_0x5cd158(_0x40a3fd,_0x2c0ce3,_0x29ab1b):_0x5cd158(_0x40a3fd,_0x2c0ce3))||_0x29ab1b;}return _0x134d19>0x3&&_0x29ab1b&&Object[_0x25dca4(0x1f5)](_0x40a3fd,_0x2c0ce3,_0x29ab1b),_0x29ab1b;},__metadata=this&&this[_0x157200(0x230)]||function(_0x6f9c58,_0x423d0f){const _0x564c0d=_0x157200;if(typeof Reflect==='object'&&typeof Reflect[_0x564c0d(0x1eb)]===_0x564c0d(0x1c8))return Reflect[_0x564c0d(0x1eb)](_0x6f9c58,_0x423d0f);},__param=this&&this[_0x157200(0x22d)]||function(_0x278d78,_0x53679b){return function(_0x552a09,_0x4045c6){_0x53679b(_0x552a09,_0x4045c6,_0x278d78);};};Object[_0x157200(0x1f5)](exports,'__esModule',{'value':!![]}),exports[_0x157200(0x21a)]=void 0x0;const common_1=require(_0x157200(0x1c7)),typeorm_1=require(_0x157200(0x1cd)),user_entity_1=require(_0x157200(0x1f9)),typeorm_2=require('typeorm'),chatLog_entity_1=require(_0x157200(0x1bf)),balance_constant_1=require(_0x157200(0x21c)),date_1=require(_0x157200(0x1d1)),axios_1=require(_0x157200(0x1ce)),config_entity_1=require(_0x157200(0x20c)),order_entity_1=require(_0x157200(0x1f4)),midjourney_entity_1=require(_0x157200(0x20a)),midjourney_constant_1=require('../../common/constants/midjourney.constant');let StatisticService=class StatisticService{constructor(_0x13958c,_0x4ce1f9,_0x7e5342,_0x1fd07b,_0x369e30){const _0x44ccf1=_0x157200;this[_0x44ccf1(0x215)]=_0x13958c,this['chatLogEntity']=_0x4ce1f9,this[_0x44ccf1(0x1ff)]=_0x7e5342,this[_0x44ccf1(0x1cc)]=_0x1fd07b,this[_0x44ccf1(0x217)]=_0x369e30;}async[_0x157200(0x213)](){const _0x53991e=_0x157200,_0xba2982=await this['countUsers'](),_0x3c0610=await this[_0x53991e(0x204)](),_0x211ddd=await this[_0x53991e(0x1d8)](),_0x763071=await this[_0x53991e(0x1bd)](),_0x124af6=await this[_0x53991e(0x229)](),_0x59824a=await this[_0x53991e(0x228)](),_0x326e91=await this['countNewMidhourneysToday'](),_0x199f0c=await this[_0x53991e(0x221)](),_0x4d2e8f=await this['countNewOrdersToday']();return{'userCount':_0xba2982,'newUserCount':_0x3c0610,'chatCount':_0x211ddd,'newChatCount':_0x763071,'drawCount':_0x124af6,'newDrawCount':_0x326e91+_0x59824a,'orderCount':_0x199f0c,'newOrderCount':_0x4d2e8f};}async[_0x157200(0x201)]({days:days=0x7}){const _0x1748a2=_0x157200,_0x222793=await this['countChatsByTimeRange'](days),_0x1563d4=await this[_0x1748a2(0x1e3)](days),_0x460591=await this[_0x1748a2(0x22c)](days);return{'date':_0x222793[_0x1748a2(0x1bc)](_0x3790c3=>_0x3790c3[_0x1748a2(0x208)]),'chat':_0x222793[_0x1748a2(0x1bc)](_0x5ebfde=>_0x5ebfde[_0x1748a2(0x21e)]),'draw':_0x1563d4['map']((_0x1893d3,_0x2f12cc)=>{return _0x1893d3['value']+_0x460591[_0x2f12cc]['value'];})};}async[_0x157200(0x21b)]({days:days=0x7}){const _0x19ac99=_0x157200,_0x2f570c=await this[_0x19ac99(0x1f6)](days);return _0x2f570c;}async[_0x157200(0x1c2)](){const _0x224992=_0x157200,_0x18251a=await this['userEntity'][_0x224992(0x1f7)]();return _0x18251a;}async[_0x157200(0x204)](){const _0x4aacd2=_0x157200,_0x3abd00=new Date();_0x3abd00[_0x4aacd2(0x209)](0x0,0x0,0x0,0x0);const _0x339ff4=new Date(_0x3abd00['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x5944c3=this[_0x4aacd2(0x215)][_0x4aacd2(0x1d5)](_0x4aacd2(0x1c3)),_0xced177=await _0x5944c3[_0x4aacd2(0x1c6)](_0x4aacd2(0x1c4),{'today':_0x3abd00})[_0x4aacd2(0x1de)](_0x4aacd2(0x1c1),{'tomorrow':_0x339ff4})[_0x4aacd2(0x22b)]();return _0xced177;}async[_0x157200(0x1d8)](){const _0x226efc=_0x157200,_0x38be33=await this[_0x226efc(0x200)]['count']({'where':{'type':balance_constant_1[_0x226efc(0x226)][_0x226efc(0x1d4)]}});return _0x38be33;}async[_0x157200(0x1bd)](){const _0x75a768=_0x157200,_0x2e6b26=new Date();_0x2e6b26[_0x75a768(0x209)](0x0,0x0,0x0,0x0);const _0x2b51e9=new Date(_0x2e6b26[_0x75a768(0x205)]()+0x18*0x3c*0x3c*0x3e8),_0x4fede1=this['chatLogEntity'][_0x75a768(0x1d5)](_0x75a768(0x1e6)),_0x2a1fe6=await _0x4fede1[_0x75a768(0x1c6)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1['DeductionKey']['CHAT_TYPE']})[_0x75a768(0x1de)]('chatLog.createdAt\x20>=\x20:today',{'today':_0x2e6b26})[_0x75a768(0x1de)](_0x75a768(0x1ca),{'tomorrow':_0x2b51e9})[_0x75a768(0x22b)]();return _0x2a1fe6;}async[_0x157200(0x229)](){const _0x1c6b54=_0x157200,_0x4bee5d=await this[_0x1c6b54(0x200)][_0x1c6b54(0x1f7)]({'where':{'type':balance_constant_1['DeductionKey'][_0x1c6b54(0x1e1)]}});return _0x4bee5d;}async[_0x157200(0x228)](){const _0x51c8ef=_0x157200,_0x13f616=new Date();_0x13f616[_0x51c8ef(0x209)](0x0,0x0,0x0,0x0);const _0x52fa9a=new Date(_0x13f616[_0x51c8ef(0x205)]()+0x18*0x3c*0x3c*0x3e8),_0x1469ec=this['chatLogEntity'][_0x51c8ef(0x1d5)](_0x51c8ef(0x1e6)),_0x1a5415=await _0x1469ec[_0x51c8ef(0x1c6)](_0x51c8ef(0x203),{'type':balance_constant_1['DeductionKey']['PAINT_TYPE']})[_0x51c8ef(0x1de)](_0x51c8ef(0x20d),{'today':_0x13f616})[_0x51c8ef(0x1de)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x52fa9a})[_0x51c8ef(0x22b)]();return _0x1a5415;}async[_0x157200(0x211)](){const _0x4df718=_0x157200,_0x2bcfab=new Date();_0x2bcfab[_0x4df718(0x209)](0x0,0x0,0x0,0x0);const _0x3341d0=new Date(_0x2bcfab[_0x4df718(0x205)]()+0x18*0x3c*0x3c*0x3e8),_0x48f1a2=this[_0x4df718(0x217)][_0x4df718(0x1d5)](_0x4df718(0x1dc)),_0x42abe3=await _0x48f1a2['where'](_0x4df718(0x22a),{'today':_0x2bcfab})['andWhere'](_0x4df718(0x218),{'tomorrow':_0x3341d0})[_0x4df718(0x22b)]();return _0x42abe3;}async['countChatsByTimeRange'](_0x15e9cf){const _0x4a601=_0x157200;var _0x871f93,_0x5130ca;const _0x4314c6=new Date();_0x4314c6[_0x4a601(0x209)](0x0,0x0,0x0,0x0);const _0x2073c8=new Date(_0x4314c6['getTime']()-(_0x15e9cf-0x1)*0x18*0x3c*0x3c*0x3e8),_0x3f40a4=this['chatLogEntity'][_0x4a601(0x1d5)](_0x4a601(0x227)),_0x195b5d=await _0x3f40a4[_0x4a601(0x224)](_0x4a601(0x1c9))[_0x4a601(0x1c6)](_0x4a601(0x1c5),{'type':balance_constant_1[_0x4a601(0x226)][_0x4a601(0x1d4)]})[_0x4a601(0x1de)](_0x4a601(0x1e7),{'startDate':_0x2073c8})[_0x4a601(0x1e0)]('date')[_0x4a601(0x1da)](_0x4a601(0x208))[_0x4a601(0x1ee)](),_0x28b5b6=[],_0x1e3774=_0x2073c8;for(let _0x5f567a=0x0;_0x5f567a<_0x15e9cf;_0x5f567a++){const _0x54e1d7=(0x0,date_1[_0x4a601(0x1d7)])(new Date(_0x1e3774),'M.DD'),_0x411d4f=(_0x5130ca=(_0x871f93=_0x195b5d['find'](_0x4f265b=>(0x0,date_1[_0x4a601(0x1d7)])(new Date(_0x4f265b[_0x4a601(0x208)]),_0x4a601(0x1c0))===_0x54e1d7))===null||_0x871f93===void 0x0?void 0x0:_0x871f93['count'])!==null&&_0x5130ca!==void 0x0?_0x5130ca:0x0;_0x411d4f>0x0?_0x28b5b6[_0x4a601(0x219)]({'date':_0x54e1d7,'value':Number(_0x411d4f)}):_0x28b5b6['push']({'date':_0x54e1d7,'value':0x0}),_0x1e3774['setDate'](_0x1e3774[_0x4a601(0x22f)]()+0x1);}return _0x28b5b6;}async[_0x157200(0x1e3)](_0x39349d){const _0x1015be=_0x157200;var _0x33d735,_0x2627a0;const _0x37d546=new Date();_0x37d546[_0x1015be(0x209)](0x0,0x0,0x0,0x0);const _0x446a71=new Date(_0x37d546[_0x1015be(0x205)]()-(_0x39349d-0x1)*0x18*0x3c*0x3c*0x3e8),_0x2fd22a=this[_0x1015be(0x200)][_0x1015be(0x1d5)](_0x1015be(0x227)),_0x2a9ed1=await _0x2fd22a[_0x1015be(0x224)](_0x1015be(0x1c9))[_0x1015be(0x1c6)](_0x1015be(0x1c5),{'type':balance_constant_1[_0x1015be(0x226)][_0x1015be(0x1e1)]})[_0x1015be(0x1de)](_0x1015be(0x1e7),{'startDate':_0x446a71})['groupBy']('date')[_0x1015be(0x1da)](_0x1015be(0x208))[_0x1015be(0x1ee)](),_0x393fc6=[],_0x1d1edd=_0x446a71;for(let _0x1aafe2=0x0;_0x1aafe2<_0x39349d;_0x1aafe2++){const _0x2f525d=(0x0,date_1[_0x1015be(0x1d7)])(new Date(_0x1d1edd),_0x1015be(0x1c0)),_0x481f71=(_0x2627a0=(_0x33d735=_0x2a9ed1[_0x1015be(0x1e4)](_0x1d9c9d=>(0x0,date_1[_0x1015be(0x1d7)])(new Date(_0x1d9c9d[_0x1015be(0x208)]),_0x1015be(0x1c0))===_0x2f525d))===null||_0x33d735===void 0x0?void 0x0:_0x33d735[_0x1015be(0x1f7)])!==null&&_0x2627a0!==void 0x0?_0x2627a0:0x0;_0x481f71>0x0?_0x393fc6[_0x1015be(0x219)]({'date':_0x2f525d,'value':Number(_0x481f71)}):_0x393fc6['push']({'date':_0x2f525d,'value':0x0}),_0x1d1edd[_0x1015be(0x1ef)](_0x1d1edd[_0x1015be(0x22f)]()+0x1);}return _0x393fc6;}async['countMjDrawsByTimeRange'](_0xe114c9){const _0x5585a8=_0x157200;var _0x479eec,_0x1a3ce9;const _0x4e4ef0=new Date();_0x4e4ef0[_0x5585a8(0x209)](0x0,0x0,0x0,0x0);const _0x4cdc14=new Date(_0x4e4ef0[_0x5585a8(0x205)]()-(_0xe114c9-0x1)*0x18*0x3c*0x3c*0x3e8),_0x4ee29b=this[_0x5585a8(0x217)][_0x5585a8(0x1d5)](_0x5585a8(0x1dc)),_0x3b4535=await _0x4ee29b[_0x5585a8(0x224)](_0x5585a8(0x222))[_0x5585a8(0x1c6)](_0x5585a8(0x20b),{'status':midjourney_constant_1[_0x5585a8(0x1e8)][_0x5585a8(0x210)]})[_0x5585a8(0x1de)](_0x5585a8(0x1fb),{'startDate':_0x4cdc14})[_0x5585a8(0x1e0)](_0x5585a8(0x208))[_0x5585a8(0x1da)](_0x5585a8(0x208))[_0x5585a8(0x1ee)](),_0xe7840d=[],_0x5dc9fa=_0x4cdc14;for(let _0x4546dd=0x0;_0x4546dd<_0xe114c9;_0x4546dd++){const _0x37da22=(0x0,date_1[_0x5585a8(0x1d7)])(new Date(_0x5dc9fa),'M.DD'),_0x10a3a4=(_0x1a3ce9=(_0x479eec=_0x3b4535[_0x5585a8(0x1e4)](_0x1e102e=>(0x0,date_1[_0x5585a8(0x1d7)])(new Date(_0x1e102e[_0x5585a8(0x208)]),_0x5585a8(0x1c0))===_0x37da22))===null||_0x479eec===void 0x0?void 0x0:_0x479eec[_0x5585a8(0x1f7)])!==null&&_0x1a3ce9!==void 0x0?_0x1a3ce9:0x0;_0x10a3a4>0x0?_0xe7840d[_0x5585a8(0x219)]({'date':_0x37da22,'value':Number(_0x10a3a4)}):_0xe7840d[_0x5585a8(0x219)]({'date':_0x37da22,'value':0x0}),_0x5dc9fa[_0x5585a8(0x1ef)](_0x5dc9fa[_0x5585a8(0x22f)]()+0x1);}return _0xe7840d;}async[_0x157200(0x1f6)](_0x109eb9){const _0x1dfe63=_0x157200;var _0x1ce489,_0x1c7b39;const _0xf4af7d=(0x0,date_1[_0x1dfe63(0x1d7)])(new Date(),_0x1dfe63(0x1df)),_0x41b4a2=(0x0,date_1[_0x1dfe63(0x1d7)])(new Date(Date['now']()-Number(_0x109eb9-0x1)*0x18*0x3c*0x3c*0x3e8),_0x1dfe63(0x1df)),_0x31b6d2=_0x1dfe63(0x1dd),_0x56087e=_0x1dfe63(0x1fd),_0x4a988a=await this['configEntity'][_0x1dfe63(0x1e4)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x1dfe63(0x1fc),_0x1dfe63(0x20e)])}}),_0x4f7fa8=(_0x1ce489=_0x4a988a['find'](_0x353c73=>_0x353c73['configKey']==='baiduSiteId'))===null||_0x1ce489===void 0x0?void 0x0:_0x1ce489[_0x1dfe63(0x22e)],_0x153898=(_0x1c7b39=_0x4a988a[_0x1dfe63(0x1e4)](_0x5f2aed=>_0x5f2aed[_0x1dfe63(0x1e2)]==='baiduToken'))===null||_0x1c7b39===void 0x0?void 0x0:_0x1c7b39['configVal'];if(!_0x4f7fa8||!_0x153898)return[];if(!_0x4f7fa8)throw new common_1[(_0x1dfe63(0x1b6))](_0x1dfe63(0x1fa),common_1['HttpStatus'][_0x1dfe63(0x1f1)]);if(!_0x153898)throw new common_1[(_0x1dfe63(0x1b6))](_0x1dfe63(0x1d6),common_1[_0x1dfe63(0x212)][_0x1dfe63(0x1f1)]);const _0xbd966=_0x1dfe63(0x1db)+_0x153898+_0x1dfe63(0x1e5)+_0x4f7fa8+_0x1dfe63(0x223)+_0x56087e+_0x1dfe63(0x1be)+_0x41b4a2+_0x1dfe63(0x1e9)+_0xf4af7d+_0x1dfe63(0x1fe)+_0x31b6d2,_0x423664=await axios_1[_0x1dfe63(0x1ed)][_0x1dfe63(0x1d2)](_0xbd966),{error_code:_0xa385bb,message:_0x4c782c}=_0x423664[_0x1dfe63(0x207)];if(_0xa385bb===0x6f)throw new common_1[(_0x1dfe63(0x1b6))](_0x4c782c||_0x1dfe63(0x1ec),common_1[_0x1dfe63(0x212)]['BAD_REQUEST']);if(_0xa385bb&&_0xa385bb!==0xc8)throw new common_1[(_0x1dfe63(0x1b6))](_0x4c782c||_0x1dfe63(0x1b7),common_1[_0x1dfe63(0x212)]['BAD_REQUEST']);return _0x423664['data']['result'];}async[_0x157200(0x221)](){const _0x4661d5=await this['orderEntity']['count']();return _0x4661d5;}async[_0x157200(0x225)](){const _0x468343=_0x157200,_0x47b6f6=new Date();_0x47b6f6[_0x468343(0x209)](0x0,0x0,0x0,0x0);const _0x887230=new Date(_0x47b6f6[_0x468343(0x205)]()+0x18*0x3c*0x3c*0x3e8),_0x58bb67=this[_0x468343(0x1cc)][_0x468343(0x1d5)](_0x468343(0x1b8)),_0x5688d2=await _0x58bb67['where'](_0x468343(0x1ba),{'today':_0x47b6f6})[_0x468343(0x1de)]('order.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x887230})[_0x468343(0x22b)]();return _0x5688d2;}};StatisticService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x157200(0x231)])(user_entity_1[_0x157200(0x1d3)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x157200(0x1bb)])),__param(0x2,(0x0,typeorm_1[_0x157200(0x231)])(config_entity_1['ConfigEntity'])),__param(0x3,(0x0,typeorm_1[_0x157200(0x231)])(order_entity_1[_0x157200(0x1cf)])),__param(0x4,(0x0,typeorm_1[_0x157200(0x231)])(midjourney_entity_1[_0x157200(0x206)])),__metadata(_0x157200(0x21d),[typeorm_2[_0x157200(0x1f2)],typeorm_2[_0x157200(0x1f2)],typeorm_2[_0x157200(0x1f2)],typeorm_2['Repository'],typeorm_2[_0x157200(0x1f2)]])],StatisticService),exports['StatisticService']=StatisticService;