'use strict';const _0x59e7bb=_0x1c27;(function(_0x5877a5,_0x3c68b0){const _0x131368=_0x1c27,_0x4ea1b9=_0x5877a5();while(!![]){try{const _0x46370b=-parseInt(_0x131368(0x13b))/0x1+parseInt(_0x131368(0x141))/0x2*(parseInt(_0x131368(0x110))/0x3)+-parseInt(_0x131368(0x105))/0x4*(-parseInt(_0x131368(0x12a))/0x5)+-parseInt(_0x131368(0x129))/0x6+-parseInt(_0x131368(0x114))/0x7+-parseInt(_0x131368(0x12f))/0x8*(-parseInt(_0x131368(0xf7))/0x9)+parseInt(_0x131368(0xfa))/0xa;if(_0x46370b===_0x3c68b0)break;else _0x4ea1b9['push'](_0x4ea1b9['shift']());}catch(_0x540e00){_0x4ea1b9['push'](_0x4ea1b9['shift']());}}}(_0x2c57,0x541f8));var __decorate=this&&this[_0x59e7bb(0x15b)]||function(_0x178e8a,_0x16d7e1,_0x3a5523,_0x1af759){const _0x4ab100=_0x59e7bb;var _0x4a33e8=arguments[_0x4ab100(0x142)],_0x14c7ba=_0x4a33e8<0x3?_0x16d7e1:_0x1af759===null?_0x1af759=Object[_0x4ab100(0x10d)](_0x16d7e1,_0x3a5523):_0x1af759,_0x4e175b;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0x14c7ba=Reflect['decorate'](_0x178e8a,_0x16d7e1,_0x3a5523,_0x1af759);else{for(var _0x2b93ae=_0x178e8a[_0x4ab100(0x142)]-0x1;_0x2b93ae>=0x0;_0x2b93ae--)if(_0x4e175b=_0x178e8a[_0x2b93ae])_0x14c7ba=(_0x4a33e8<0x3?_0x4e175b(_0x14c7ba):_0x4a33e8>0x3?_0x4e175b(_0x16d7e1,_0x3a5523,_0x14c7ba):_0x4e175b(_0x16d7e1,_0x3a5523))||_0x14c7ba;}return _0x4a33e8>0x3&&_0x14c7ba&&Object[_0x4ab100(0x143)](_0x16d7e1,_0x3a5523,_0x14c7ba),_0x14c7ba;},__metadata=this&&this[_0x59e7bb(0x122)]||function(_0x1b23b0,_0xb2be98){const _0x2bb18b=_0x59e7bb;if(typeof Reflect===_0x2bb18b(0x14d)&&typeof Reflect[_0x2bb18b(0x120)]==='function')return Reflect['metadata'](_0x1b23b0,_0xb2be98);},__param=this&&this[_0x59e7bb(0x119)]||function(_0x203c67,_0x33b680){return function(_0x4d9930,_0x430806){_0x33b680(_0x4d9930,_0x430806,_0x203c67);};};Object[_0x59e7bb(0x143)](exports,_0x59e7bb(0x10e),{'value':!![]}),exports[_0x59e7bb(0x12d)]=void 0x0;function _0x2c57(){const _0x78bf4b=['order.createdAt\x20<\x20:tomorrow','BAD_REQUEST','getCount','../order/order.entity','__decorate','获取百度统计数据失败','data','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','where','MidjourneyStatusEnum','design:paramtypes','getTime','chatLog.createdAt\x20<\x20:tomorrow','PAINT_TYPE','HttpStatus','../../common/constants/midjourney.constant','getRawMany','9BZWwEJ','countNewUsersToday','map','5047610kwVMSx','midjourneyEntity','date','value','ChatLogEntity','formatDate','configEntity','order','chatLog.type\x20=\x20:type','user','midjourney.createdAt\x20>=\x20:today','2175092CZlHTq','countDraws','countNewMidhourneysToday','M.DD','push','countChatsByTimeRange','../midjourney/midjourney.entity','user.createdAt\x20<\x20:tomorrow','getOwnPropertyDescriptor','__esModule','&site_id=','396daQaMm','../../common/constants/balance.constant','default','getDate','2865576XnVDaj','&metrics=','chatLog.createdAt\x20>=\x20:today','../user/user.entity','CHAT_TYPE','__param','configVal','InjectRepository','order.createdAt\x20>=\x20:today','countNewDrawsToday','&method=','getBaiduVisit','metadata','setHours','__metadata','chatLogEntity','andWhere','OrderEntity','chatLog','setDate','countDrawsByTimeRange','2595180seSpGJ','5EskjMk','chatlog.type\x20=\x20:type','countChats','StatisticService','Repository','208016EvdDTy','chatlog.createdAt\x20>=\x20:startDate','find','baiduToken','groupBy','UserEntity','createQueryBuilder','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','请先配置百度统计accessToken','select','countNewOrdersToday','&end_date=','285918dFFEZX','countOrders','countNewChatsToday','getBaseStatistic','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','百度授权码过期','6028qjMbVZ','length','defineProperty','getBaiduStatistics','countMjDrawsByTimeRange','midjourney.createdAt\x20<\x20:tomorrow','YYYYMMDD','orderBy','chatlog','MidjourneyEntity','get','typeorm','object','userEntity','DeductionKey','orderEntity','../globalConfig/config.entity','HttpException','countUsers','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','count','axios'];_0x2c57=function(){return _0x78bf4b;};return _0x2c57();}function _0x1c27(_0x2b83b3,_0x16771e){const _0x2c5731=_0x2c57();return _0x1c27=function(_0x1c277c,_0x3815f6){_0x1c277c=_0x1c277c-0xf5;let _0x238cc6=_0x2c5731[_0x1c277c];return _0x238cc6;},_0x1c27(_0x2b83b3,_0x16771e);}const common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),user_entity_1=require(_0x59e7bb(0x117)),typeorm_2=require(_0x59e7bb(0x14c)),chatLog_entity_1=require('../chatLog/chatLog.entity'),balance_constant_1=require(_0x59e7bb(0x111)),date_1=require('../../common/utils/date'),axios_1=require(_0x59e7bb(0x156)),config_entity_1=require(_0x59e7bb(0x151)),order_entity_1=require(_0x59e7bb(0x15a)),midjourney_entity_1=require(_0x59e7bb(0x10b)),midjourney_constant_1=require(_0x59e7bb(0xf5));let StatisticService=class StatisticService{constructor(_0x4e0603,_0xa6f72d,_0x44f881,_0xfc4033,_0x34bf4a){const _0xf639d6=_0x59e7bb;this['userEntity']=_0x4e0603,this[_0xf639d6(0x123)]=_0xa6f72d,this[_0xf639d6(0x100)]=_0x44f881,this['orderEntity']=_0xfc4033,this[_0xf639d6(0xfb)]=_0x34bf4a;}async[_0x59e7bb(0x13e)](){const _0x2b971b=_0x59e7bb,_0x736661=await this['countUsers'](),_0x55ea1d=await this[_0x2b971b(0xf8)](),_0x56dd8d=await this[_0x2b971b(0x12c)](),_0x4896c3=await this[_0x2b971b(0x13d)](),_0xe88f27=await this[_0x2b971b(0x106)](),_0x4240cb=await this[_0x2b971b(0x11d)](),_0x48b984=await this[_0x2b971b(0x107)](),_0x3e9433=await this[_0x2b971b(0x13c)](),_0x50ec33=await this[_0x2b971b(0x139)]();return{'userCount':_0x736661,'newUserCount':_0x55ea1d,'chatCount':_0x56dd8d,'newChatCount':_0x4896c3,'drawCount':_0xe88f27,'newDrawCount':_0x48b984+_0x4240cb,'orderCount':_0x3e9433,'newOrderCount':_0x50ec33};}async['getChatStatistic']({days:days=0x7}){const _0x4e3967=_0x59e7bb,_0x4988fd=await this[_0x4e3967(0x10a)](days),_0x38a514=await this[_0x4e3967(0x128)](days),_0x2778f0=await this[_0x4e3967(0x145)](days);return{'date':_0x4988fd[_0x4e3967(0xf9)](_0x2eae0f=>_0x2eae0f[_0x4e3967(0xfc)]),'chat':_0x4988fd[_0x4e3967(0xf9)](_0x46d66e=>_0x46d66e['value']),'draw':_0x38a514[_0x4e3967(0xf9)]((_0xa1a730,_0x2698c4)=>{const _0x674830=_0x4e3967;return _0xa1a730[_0x674830(0xfd)]+_0x2778f0[_0x2698c4][_0x674830(0xfd)];})};}async[_0x59e7bb(0x11f)]({days:days=0x7}){const _0x70083b=_0x59e7bb,_0x28f60c=await this[_0x70083b(0x144)](days);return _0x28f60c;}async[_0x59e7bb(0x153)](){const _0x77c959=_0x59e7bb,_0x9371b4=await this[_0x77c959(0x14e)]['count']();return _0x9371b4;}async[_0x59e7bb(0xf8)](){const _0x40d667=_0x59e7bb,_0x1068ab=new Date();_0x1068ab[_0x40d667(0x121)](0x0,0x0,0x0,0x0);const _0x470134=new Date(_0x1068ab[_0x40d667(0x162)]()+0x18*0x3c*0x3c*0x3e8),_0x4f2fab=this['userEntity']['createQueryBuilder'](_0x40d667(0x103)),_0xadd846=await _0x4f2fab[_0x40d667(0x15f)]('user.createdAt\x20>=\x20:today',{'today':_0x1068ab})[_0x40d667(0x124)](_0x40d667(0x10c),{'tomorrow':_0x470134})[_0x40d667(0x159)]();return _0xadd846;}async[_0x59e7bb(0x12c)](){const _0x425f40=_0x59e7bb,_0x438fbf=await this[_0x425f40(0x123)][_0x425f40(0x155)]({'where':{'type':balance_constant_1['DeductionKey']['CHAT_TYPE']}});return _0x438fbf;}async[_0x59e7bb(0x13d)](){const _0x190dd6=_0x59e7bb,_0xc53b5=new Date();_0xc53b5[_0x190dd6(0x121)](0x0,0x0,0x0,0x0);const _0x3a76ea=new Date(_0xc53b5['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x45ef96=this[_0x190dd6(0x123)][_0x190dd6(0x135)]('chatLog'),_0x5158f7=await _0x45ef96[_0x190dd6(0x15f)](_0x190dd6(0x102),{'type':balance_constant_1['DeductionKey']['CHAT_TYPE']})[_0x190dd6(0x124)](_0x190dd6(0x116),{'today':_0xc53b5})[_0x190dd6(0x124)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x3a76ea})[_0x190dd6(0x159)]();return _0x5158f7;}async[_0x59e7bb(0x106)](){const _0x4d8e65=_0x59e7bb,_0x1698af=await this[_0x4d8e65(0x123)][_0x4d8e65(0x155)]({'where':{'type':balance_constant_1[_0x4d8e65(0x14f)][_0x4d8e65(0x164)]}});return _0x1698af;}async[_0x59e7bb(0x11d)](){const _0x4dcfdc=_0x59e7bb,_0x165e23=new Date();_0x165e23[_0x4dcfdc(0x121)](0x0,0x0,0x0,0x0);const _0x3b0444=new Date(_0x165e23[_0x4dcfdc(0x162)]()+0x18*0x3c*0x3c*0x3e8),_0x86493d=this[_0x4dcfdc(0x123)][_0x4dcfdc(0x135)](_0x4dcfdc(0x126)),_0x52b75f=await _0x86493d[_0x4dcfdc(0x15f)](_0x4dcfdc(0x102),{'type':balance_constant_1['DeductionKey']['PAINT_TYPE']})[_0x4dcfdc(0x124)](_0x4dcfdc(0x116),{'today':_0x165e23})['andWhere'](_0x4dcfdc(0x163),{'tomorrow':_0x3b0444})['getCount']();return _0x52b75f;}async[_0x59e7bb(0x107)](){const _0x1bf512=_0x59e7bb,_0x1bd2bc=new Date();_0x1bd2bc[_0x1bf512(0x121)](0x0,0x0,0x0,0x0);const _0x591525=new Date(_0x1bd2bc['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x5f4c69=this[_0x1bf512(0xfb)][_0x1bf512(0x135)]('midjourney'),_0x11366e=await _0x5f4c69[_0x1bf512(0x15f)](_0x1bf512(0x104),{'today':_0x1bd2bc})[_0x1bf512(0x124)](_0x1bf512(0x146),{'tomorrow':_0x591525})[_0x1bf512(0x159)]();return _0x11366e;}async['countChatsByTimeRange'](_0x469fcf){const _0x44348e=_0x59e7bb;var _0x2e826f,_0x925cc6;const _0x58f46f=new Date();_0x58f46f[_0x44348e(0x121)](0x0,0x0,0x0,0x0);const _0x5cfa14=new Date(_0x58f46f[_0x44348e(0x162)]()-(_0x469fcf-0x1)*0x18*0x3c*0x3c*0x3e8),_0x520c3e=this['chatLogEntity'][_0x44348e(0x135)](_0x44348e(0x149)),_0x1af6c0=await _0x520c3e[_0x44348e(0x138)](_0x44348e(0x13f))[_0x44348e(0x15f)](_0x44348e(0x12b),{'type':balance_constant_1['DeductionKey'][_0x44348e(0x118)]})[_0x44348e(0x124)](_0x44348e(0x130),{'startDate':_0x5cfa14})['groupBy'](_0x44348e(0xfc))[_0x44348e(0x148)](_0x44348e(0xfc))[_0x44348e(0xf6)](),_0x1d2ddd=[],_0x36aa3f=_0x5cfa14;for(let _0x1ee645=0x0;_0x1ee645<_0x469fcf;_0x1ee645++){const _0x45719d=(0x0,date_1[_0x44348e(0xff)])(new Date(_0x36aa3f),'M.DD'),_0x281954=(_0x925cc6=(_0x2e826f=_0x1af6c0[_0x44348e(0x131)](_0x233b83=>(0x0,date_1[_0x44348e(0xff)])(new Date(_0x233b83[_0x44348e(0xfc)]),_0x44348e(0x108))===_0x45719d))===null||_0x2e826f===void 0x0?void 0x0:_0x2e826f['count'])!==null&&_0x925cc6!==void 0x0?_0x925cc6:0x0;_0x281954>0x0?_0x1d2ddd[_0x44348e(0x109)]({'date':_0x45719d,'value':Number(_0x281954)}):_0x1d2ddd[_0x44348e(0x109)]({'date':_0x45719d,'value':0x0}),_0x36aa3f[_0x44348e(0x127)](_0x36aa3f['getDate']()+0x1);}return _0x1d2ddd;}async[_0x59e7bb(0x128)](_0x5817e2){const _0x33355c=_0x59e7bb;var _0x1afda6,_0x166001;const _0x2fdd19=new Date();_0x2fdd19[_0x33355c(0x121)](0x0,0x0,0x0,0x0);const _0xec7715=new Date(_0x2fdd19[_0x33355c(0x162)]()-(_0x5817e2-0x1)*0x18*0x3c*0x3c*0x3e8),_0x1d4eb3=this[_0x33355c(0x123)][_0x33355c(0x135)]('chatlog'),_0x2be647=await _0x1d4eb3[_0x33355c(0x138)](_0x33355c(0x13f))['where']('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x33355c(0x14f)][_0x33355c(0x164)]})[_0x33355c(0x124)](_0x33355c(0x130),{'startDate':_0xec7715})[_0x33355c(0x133)]('date')['orderBy']('date')[_0x33355c(0xf6)](),_0x2544ef=[],_0x5eab6b=_0xec7715;for(let _0x47065c=0x0;_0x47065c<_0x5817e2;_0x47065c++){const _0x37695e=(0x0,date_1[_0x33355c(0xff)])(new Date(_0x5eab6b),'M.DD'),_0x516abe=(_0x166001=(_0x1afda6=_0x2be647['find'](_0x3a0155=>(0x0,date_1[_0x33355c(0xff)])(new Date(_0x3a0155[_0x33355c(0xfc)]),'M.DD')===_0x37695e))===null||_0x1afda6===void 0x0?void 0x0:_0x1afda6[_0x33355c(0x155)])!==null&&_0x166001!==void 0x0?_0x166001:0x0;_0x516abe>0x0?_0x2544ef[_0x33355c(0x109)]({'date':_0x37695e,'value':Number(_0x516abe)}):_0x2544ef[_0x33355c(0x109)]({'date':_0x37695e,'value':0x0}),_0x5eab6b[_0x33355c(0x127)](_0x5eab6b[_0x33355c(0x113)]()+0x1);}return _0x2544ef;}async['countMjDrawsByTimeRange'](_0x317ab4){const _0x563838=_0x59e7bb;var _0x343699,_0x42a6db;const _0xc521ec=new Date();_0xc521ec['setHours'](0x0,0x0,0x0,0x0);const _0x56099a=new Date(_0xc521ec[_0x563838(0x162)]()-(_0x317ab4-0x1)*0x18*0x3c*0x3c*0x3e8),_0x48ba82=this[_0x563838(0xfb)]['createQueryBuilder']('midjourney'),_0x5a2915=await _0x48ba82[_0x563838(0x138)](_0x563838(0x15e))[_0x563838(0x15f)]('midjourney.status\x20=\x20:status',{'status':midjourney_constant_1[_0x563838(0x160)]['DRAWED']})['andWhere']('midjourney.createdAt\x20>=\x20:startDate',{'startDate':_0x56099a})[_0x563838(0x133)](_0x563838(0xfc))[_0x563838(0x148)]('date')['getRawMany'](),_0x1b7866=[],_0x144145=_0x56099a;for(let _0xc8cf4c=0x0;_0xc8cf4c<_0x317ab4;_0xc8cf4c++){const _0x33588b=(0x0,date_1[_0x563838(0xff)])(new Date(_0x144145),'M.DD'),_0x107d55=(_0x42a6db=(_0x343699=_0x5a2915[_0x563838(0x131)](_0x470741=>(0x0,date_1[_0x563838(0xff)])(new Date(_0x470741[_0x563838(0xfc)]),_0x563838(0x108))===_0x33588b))===null||_0x343699===void 0x0?void 0x0:_0x343699['count'])!==null&&_0x42a6db!==void 0x0?_0x42a6db:0x0;_0x107d55>0x0?_0x1b7866['push']({'date':_0x33588b,'value':Number(_0x107d55)}):_0x1b7866['push']({'date':_0x33588b,'value':0x0}),_0x144145['setDate'](_0x144145['getDate']()+0x1);}return _0x1b7866;}async[_0x59e7bb(0x144)](_0x28551e){const _0x2cc82c=_0x59e7bb;var _0x14180c,_0x5cbba0;const _0x4e88e5=(0x0,date_1[_0x2cc82c(0xff)])(new Date(),_0x2cc82c(0x147)),_0x3c62e5=(0x0,date_1['formatDate'])(new Date(Date['now']()-Number(_0x28551e-0x1)*0x18*0x3c*0x3c*0x3e8),_0x2cc82c(0x147)),_0x38f9a5=_0x2cc82c(0x154),_0x2752c7='overview/getTimeTrendRpt',_0x358b63=await this[_0x2cc82c(0x100)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x2cc82c(0x132),'baiduSiteId'])}}),_0x285cc9=(_0x14180c=_0x358b63[_0x2cc82c(0x131)](_0x2d3e8d=>_0x2d3e8d['configKey']==='baiduSiteId'))===null||_0x14180c===void 0x0?void 0x0:_0x14180c[_0x2cc82c(0x11a)],_0x27f250=(_0x5cbba0=_0x358b63[_0x2cc82c(0x131)](_0x10acce=>_0x10acce['configKey']===_0x2cc82c(0x132)))===null||_0x5cbba0===void 0x0?void 0x0:_0x5cbba0[_0x2cc82c(0x11a)];if(!_0x285cc9||!_0x27f250)return[];if(!_0x285cc9)throw new common_1[(_0x2cc82c(0x152))]('请先配置百度统计siteId',common_1[_0x2cc82c(0x165)]['BAD_REQUEST']);if(!_0x27f250)throw new common_1[(_0x2cc82c(0x152))](_0x2cc82c(0x137),common_1[_0x2cc82c(0x165)][_0x2cc82c(0x158)]);const _0xd6b2e8=_0x2cc82c(0x136)+_0x27f250+_0x2cc82c(0x10f)+_0x285cc9+_0x2cc82c(0x11e)+_0x2752c7+'&start_date='+_0x3c62e5+_0x2cc82c(0x13a)+_0x4e88e5+_0x2cc82c(0x115)+_0x38f9a5,_0x2ca36f=await axios_1[_0x2cc82c(0x112)][_0x2cc82c(0x14b)](_0xd6b2e8),{error_code:_0x63519c,message:_0xedb788}=_0x2ca36f[_0x2cc82c(0x15d)];if(_0x63519c===0x6f)throw new common_1[(_0x2cc82c(0x152))](_0xedb788||_0x2cc82c(0x140),common_1['HttpStatus'][_0x2cc82c(0x158)]);if(_0x63519c&&_0x63519c!==0xc8)throw new common_1['HttpException'](_0xedb788||_0x2cc82c(0x15c),common_1[_0x2cc82c(0x165)][_0x2cc82c(0x158)]);return _0x2ca36f[_0x2cc82c(0x15d)]['result'];}async[_0x59e7bb(0x13c)](){const _0x4256dd=_0x59e7bb,_0x2d369a=await this[_0x4256dd(0x150)][_0x4256dd(0x155)]();return _0x2d369a;}async['countNewOrdersToday'](){const _0x42b733=_0x59e7bb,_0xa364ee=new Date();_0xa364ee[_0x42b733(0x121)](0x0,0x0,0x0,0x0);const _0x1cd0c8=new Date(_0xa364ee['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x40ec01=this[_0x42b733(0x150)][_0x42b733(0x135)](_0x42b733(0x101)),_0x3cfbaf=await _0x40ec01[_0x42b733(0x15f)](_0x42b733(0x11c),{'today':_0xa364ee})[_0x42b733(0x124)](_0x42b733(0x157),{'tomorrow':_0x1cd0c8})[_0x42b733(0x159)]();return _0x3cfbaf;}};StatisticService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x59e7bb(0x11b)])(user_entity_1[_0x59e7bb(0x134)])),__param(0x1,(0x0,typeorm_1[_0x59e7bb(0x11b)])(chatLog_entity_1[_0x59e7bb(0xfe)])),__param(0x2,(0x0,typeorm_1[_0x59e7bb(0x11b)])(config_entity_1['ConfigEntity'])),__param(0x3,(0x0,typeorm_1[_0x59e7bb(0x11b)])(order_entity_1[_0x59e7bb(0x125)])),__param(0x4,(0x0,typeorm_1[_0x59e7bb(0x11b)])(midjourney_entity_1[_0x59e7bb(0x14a)])),__metadata(_0x59e7bb(0x161),[typeorm_2[_0x59e7bb(0x12e)],typeorm_2[_0x59e7bb(0x12e)],typeorm_2[_0x59e7bb(0x12e)],typeorm_2['Repository'],typeorm_2['Repository']])],StatisticService),exports[_0x59e7bb(0x12d)]=StatisticService;