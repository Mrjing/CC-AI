'use strict';const _0x9a4efe=_0x1fb5;(function(_0x249228,_0x291056){const _0x2b4af2=_0x1fb5,_0x59a12a=_0x249228();while(!![]){try{const _0x56ff8f=parseInt(_0x2b4af2(0x137))/0x1*(-parseInt(_0x2b4af2(0x121))/0x2)+parseInt(_0x2b4af2(0x12a))/0x3*(parseInt(_0x2b4af2(0x117))/0x4)+parseInt(_0x2b4af2(0x112))/0x5*(-parseInt(_0x2b4af2(0x17c))/0x6)+-parseInt(_0x2b4af2(0x177))/0x7+-parseInt(_0x2b4af2(0x12d))/0x8+-parseInt(_0x2b4af2(0x14f))/0x9*(parseInt(_0x2b4af2(0x145))/0xa)+parseInt(_0x2b4af2(0x176))/0xb*(parseInt(_0x2b4af2(0x10f))/0xc);if(_0x56ff8f===_0x291056)break;else _0x59a12a['push'](_0x59a12a['shift']());}catch(_0xc2822c){_0x59a12a['push'](_0x59a12a['shift']());}}}(_0x5cc4,0xec7b1));function _0x5cc4(){const _0x317d7c=['setHours','countMjDrawsByTimeRange','baiduSiteId','midjourney','chatLog.type\x20=\x20:type','typeorm','&site_id=','baiduToken','../../common/utils/date','&end_date=','../../common/constants/balance.constant','countChats','order.createdAt\x20>=\x20:today','countOrders','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','HttpException','chatlog','groupBy','&start_date=','countNewUsersToday','defineProperty','overview/getTimeTrendRpt','get','setDate','getTime','PAINT_TYPE','__esModule','user','chatLog.createdAt\x20<\x20:tomorrow','../midjourney/midjourney.entity','countNewMidhourneysToday','chatlog.createdAt\x20>=\x20:startDate','andWhere','DRAWED','countChatsByTimeRange','@nestjs/common','Repository','where','41432215SdDcTM','686728wWsTTW','default','function','midjourney.createdAt\x20>=\x20:startDate','countDraws','474xcTOpv','__decorate','orderBy','OrderEntity','axios','百度授权码过期','../order/order.entity','orderEntity','design:paramtypes','请先配置百度统计siteId','MidjourneyEntity','createQueryBuilder','now','InjectRepository','configKey','&metrics=','12OxaOAD','countNewChatsToday','midjourneyEntity','66145Nppsyo','getRawMany','countNewOrdersToday','metadata','configVal','4crBkPO','object','getBaiduStatistics','order.createdAt\x20<\x20:tomorrow','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','chatlog.type\x20=\x20:type','DeductionKey','@nestjs/typeorm','UserEntity','__param','3244232DKAcmt','formatDate','date','result','M.DD','StatisticService','value','CHAT_TYPE','BAD_REQUEST','3727707eHTgzf','userEntity','getCount','7058952NmMqEM','countUsers','count','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','countNewDrawsToday','chatLog.createdAt\x20>=\x20:today','Injectable','countDrawsByTimeRange','getDate','../globalConfig/config.entity','1UdAnHM','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','configEntity','ConfigEntity','push','../../common/constants/midjourney.constant','user.createdAt\x20<\x20:tomorrow','map','MidjourneyStatusEnum','../chatLog/chatLog.entity','chatLogEntity','find','HttpStatus','chatLog','3928290BtrsnQ','../user/user.entity','data','midjourney.createdAt\x20>=\x20:today','getChatStatistic','&method=','decorate','select','getOwnPropertyDescriptor','length','9jDDmIo'];_0x5cc4=function(){return _0x317d7c;};return _0x5cc4();}var __decorate=this&&this[_0x9a4efe(0x17d)]||function(_0x20f2d9,_0x212dcc,_0x34dd9d,_0x48fa2d){const _0x2c912f=_0x9a4efe;var _0x3b569f=arguments[_0x2c912f(0x14e)],_0x440012=_0x3b569f<0x3?_0x212dcc:_0x48fa2d===null?_0x48fa2d=Object[_0x2c912f(0x14d)](_0x212dcc,_0x34dd9d):_0x48fa2d,_0xd7ede;if(typeof Reflect===_0x2c912f(0x118)&&typeof Reflect[_0x2c912f(0x14b)]===_0x2c912f(0x179))_0x440012=Reflect[_0x2c912f(0x14b)](_0x20f2d9,_0x212dcc,_0x34dd9d,_0x48fa2d);else{for(var _0x25d189=_0x20f2d9[_0x2c912f(0x14e)]-0x1;_0x25d189>=0x0;_0x25d189--)if(_0xd7ede=_0x20f2d9[_0x25d189])_0x440012=(_0x3b569f<0x3?_0xd7ede(_0x440012):_0x3b569f>0x3?_0xd7ede(_0x212dcc,_0x34dd9d,_0x440012):_0xd7ede(_0x212dcc,_0x34dd9d))||_0x440012;}return _0x3b569f>0x3&&_0x440012&&Object[_0x2c912f(0x164)](_0x212dcc,_0x34dd9d,_0x440012),_0x440012;},__metadata=this&&this['__metadata']||function(_0x3ba99,_0x4ad266){const _0x403575=_0x9a4efe;if(typeof Reflect===_0x403575(0x118)&&typeof Reflect[_0x403575(0x115)]===_0x403575(0x179))return Reflect[_0x403575(0x115)](_0x3ba99,_0x4ad266);},__param=this&&this[_0x9a4efe(0x120)]||function(_0x179e10,_0x325faf){return function(_0x3024f3,_0x2265fc){_0x325faf(_0x3024f3,_0x2265fc,_0x179e10);};};Object[_0x9a4efe(0x164)](exports,_0x9a4efe(0x16a),{'value':!![]}),exports[_0x9a4efe(0x126)]=void 0x0;const common_1=require(_0x9a4efe(0x173)),typeorm_1=require(_0x9a4efe(0x11e)),user_entity_1=require(_0x9a4efe(0x146)),typeorm_2=require(_0x9a4efe(0x155)),chatLog_entity_1=require(_0x9a4efe(0x140)),balance_constant_1=require(_0x9a4efe(0x15a)),date_1=require(_0x9a4efe(0x158)),axios_1=require(_0x9a4efe(0x180)),config_entity_1=require(_0x9a4efe(0x136)),order_entity_1=require(_0x9a4efe(0x182)),midjourney_entity_1=require(_0x9a4efe(0x16d)),midjourney_constant_1=require(_0x9a4efe(0x13c));let StatisticService=class StatisticService{constructor(_0x24322c,_0x38755f,_0x48379b,_0x3ee093,_0x4cda7c){const _0x21257b=_0x9a4efe;this[_0x21257b(0x12b)]=_0x24322c,this['chatLogEntity']=_0x38755f,this[_0x21257b(0x139)]=_0x48379b,this['orderEntity']=_0x3ee093,this[_0x21257b(0x111)]=_0x4cda7c;}async['getBaseStatistic'](){const _0x8ac77c=_0x9a4efe,_0x2984a1=await this[_0x8ac77c(0x12e)](),_0x697dd2=await this[_0x8ac77c(0x163)](),_0xf69027=await this[_0x8ac77c(0x15b)](),_0x2185f9=await this[_0x8ac77c(0x110)](),_0x868053=await this[_0x8ac77c(0x17b)](),_0xead3c8=await this['countNewDrawsToday'](),_0x30237f=await this[_0x8ac77c(0x16e)](),_0x3a1e82=await this[_0x8ac77c(0x15d)](),_0xf19118=await this[_0x8ac77c(0x114)]();return{'userCount':_0x2984a1,'newUserCount':_0x697dd2,'chatCount':_0xf69027,'newChatCount':_0x2185f9,'drawCount':_0x868053,'newDrawCount':_0x30237f+_0xead3c8,'orderCount':_0x3a1e82,'newOrderCount':_0xf19118};}async[_0x9a4efe(0x149)]({days:days=0x7}){const _0x27b48b=_0x9a4efe,_0x46e9c5=await this[_0x27b48b(0x172)](days),_0x486639=await this[_0x27b48b(0x134)](days),_0x11f043=await this[_0x27b48b(0x151)](days);return{'date':_0x46e9c5['map'](_0x3f680a=>_0x3f680a[_0x27b48b(0x123)]),'chat':_0x46e9c5[_0x27b48b(0x13e)](_0x541ad9=>_0x541ad9[_0x27b48b(0x127)]),'draw':_0x486639[_0x27b48b(0x13e)]((_0x749aef,_0x52b846)=>{const _0x2c5deb=_0x27b48b;return _0x749aef['value']+_0x11f043[_0x52b846][_0x2c5deb(0x127)];})};}async['getBaiduVisit']({days:days=0x7}){const _0x58100f=_0x9a4efe,_0x549e79=await this[_0x58100f(0x119)](days);return _0x549e79;}async[_0x9a4efe(0x12e)](){const _0x3cdca2=_0x9a4efe,_0x4fcd5d=await this['userEntity'][_0x3cdca2(0x12f)]();return _0x4fcd5d;}async[_0x9a4efe(0x163)](){const _0x55663f=_0x9a4efe,_0x272a97=new Date();_0x272a97['setHours'](0x0,0x0,0x0,0x0);const _0xeba895=new Date(_0x272a97[_0x55663f(0x168)]()+0x18*0x3c*0x3c*0x3e8),_0x19f843=this[_0x55663f(0x12b)][_0x55663f(0x187)](_0x55663f(0x16b)),_0x48dd5b=await _0x19f843[_0x55663f(0x175)]('user.createdAt\x20>=\x20:today',{'today':_0x272a97})['andWhere'](_0x55663f(0x13d),{'tomorrow':_0xeba895})['getCount']();return _0x48dd5b;}async['countChats'](){const _0x4b57c7=_0x9a4efe,_0x14770f=await this[_0x4b57c7(0x141)][_0x4b57c7(0x12f)]({'where':{'type':balance_constant_1[_0x4b57c7(0x11d)][_0x4b57c7(0x128)]}});return _0x14770f;}async[_0x9a4efe(0x110)](){const _0x4bcb51=_0x9a4efe,_0x429ba5=new Date();_0x429ba5[_0x4bcb51(0x150)](0x0,0x0,0x0,0x0);const _0x60ed5f=new Date(_0x429ba5[_0x4bcb51(0x168)]()+0x18*0x3c*0x3c*0x3e8),_0x26dc5c=this[_0x4bcb51(0x141)]['createQueryBuilder'](_0x4bcb51(0x144)),_0xda2533=await _0x26dc5c[_0x4bcb51(0x175)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x4bcb51(0x11d)][_0x4bcb51(0x128)]})[_0x4bcb51(0x170)](_0x4bcb51(0x132),{'today':_0x429ba5})[_0x4bcb51(0x170)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x60ed5f})[_0x4bcb51(0x12c)]();return _0xda2533;}async['countDraws'](){const _0x2c2c22=_0x9a4efe,_0x25764c=await this[_0x2c2c22(0x141)][_0x2c2c22(0x12f)]({'where':{'type':balance_constant_1[_0x2c2c22(0x11d)][_0x2c2c22(0x169)]}});return _0x25764c;}async[_0x9a4efe(0x131)](){const _0x478635=_0x9a4efe,_0x51e579=new Date();_0x51e579[_0x478635(0x150)](0x0,0x0,0x0,0x0);const _0x412117=new Date(_0x51e579['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x1f5602=this['chatLogEntity'][_0x478635(0x187)](_0x478635(0x144)),_0x1551ea=await _0x1f5602[_0x478635(0x175)](_0x478635(0x154),{'type':balance_constant_1[_0x478635(0x11d)][_0x478635(0x169)]})[_0x478635(0x170)]('chatLog.createdAt\x20>=\x20:today',{'today':_0x51e579})['andWhere'](_0x478635(0x16c),{'tomorrow':_0x412117})[_0x478635(0x12c)]();return _0x1551ea;}async['countNewMidhourneysToday'](){const _0x2e195d=_0x9a4efe,_0x146129=new Date();_0x146129['setHours'](0x0,0x0,0x0,0x0);const _0x15ee92=new Date(_0x146129[_0x2e195d(0x168)]()+0x18*0x3c*0x3c*0x3e8),_0x28a632=this[_0x2e195d(0x111)]['createQueryBuilder'](_0x2e195d(0x153)),_0x59f843=await _0x28a632[_0x2e195d(0x175)](_0x2e195d(0x148),{'today':_0x146129})[_0x2e195d(0x170)]('midjourney.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x15ee92})[_0x2e195d(0x12c)]();return _0x59f843;}async[_0x9a4efe(0x172)](_0x2f70ca){const _0x4d55fe=_0x9a4efe;var _0x1ea8b9,_0x32e0ae;const _0xe668af=new Date();_0xe668af[_0x4d55fe(0x150)](0x0,0x0,0x0,0x0);const _0x5741e9=new Date(_0xe668af[_0x4d55fe(0x168)]()-(_0x2f70ca-0x1)*0x18*0x3c*0x3c*0x3e8),_0x516918=this['chatLogEntity'][_0x4d55fe(0x187)](_0x4d55fe(0x160)),_0x1222be=await _0x516918['select'](_0x4d55fe(0x11b))[_0x4d55fe(0x175)](_0x4d55fe(0x11c),{'type':balance_constant_1['DeductionKey'][_0x4d55fe(0x128)]})['andWhere'](_0x4d55fe(0x16f),{'startDate':_0x5741e9})[_0x4d55fe(0x161)]('date')[_0x4d55fe(0x17e)](_0x4d55fe(0x123))[_0x4d55fe(0x113)](),_0x218266=[],_0x1b5215=_0x5741e9;for(let _0x5de9cf=0x0;_0x5de9cf<_0x2f70ca;_0x5de9cf++){const _0x42084e=(0x0,date_1[_0x4d55fe(0x122)])(new Date(_0x1b5215),_0x4d55fe(0x125)),_0x27a901=(_0x32e0ae=(_0x1ea8b9=_0x1222be[_0x4d55fe(0x142)](_0x1f0e72=>(0x0,date_1[_0x4d55fe(0x122)])(new Date(_0x1f0e72[_0x4d55fe(0x123)]),_0x4d55fe(0x125))===_0x42084e))===null||_0x1ea8b9===void 0x0?void 0x0:_0x1ea8b9[_0x4d55fe(0x12f)])!==null&&_0x32e0ae!==void 0x0?_0x32e0ae:0x0;_0x27a901>0x0?_0x218266['push']({'date':_0x42084e,'value':Number(_0x27a901)}):_0x218266[_0x4d55fe(0x13b)]({'date':_0x42084e,'value':0x0}),_0x1b5215['setDate'](_0x1b5215[_0x4d55fe(0x135)]()+0x1);}return _0x218266;}async['countDrawsByTimeRange'](_0x1edffe){const _0x38b260=_0x9a4efe;var _0x2cc092,_0x4953ad;const _0x288cdb=new Date();_0x288cdb[_0x38b260(0x150)](0x0,0x0,0x0,0x0);const _0x43f709=new Date(_0x288cdb['getTime']()-(_0x1edffe-0x1)*0x18*0x3c*0x3c*0x3e8),_0x1cc795=this[_0x38b260(0x141)]['createQueryBuilder'](_0x38b260(0x160)),_0x446a2d=await _0x1cc795['select'](_0x38b260(0x11b))[_0x38b260(0x175)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x38b260(0x11d)][_0x38b260(0x169)]})[_0x38b260(0x170)](_0x38b260(0x16f),{'startDate':_0x43f709})[_0x38b260(0x161)](_0x38b260(0x123))[_0x38b260(0x17e)]('date')[_0x38b260(0x113)](),_0x1a8228=[],_0x207a78=_0x43f709;for(let _0x33dbe4=0x0;_0x33dbe4<_0x1edffe;_0x33dbe4++){const _0x282bcc=(0x0,date_1[_0x38b260(0x122)])(new Date(_0x207a78),'M.DD'),_0x5cbd1a=(_0x4953ad=(_0x2cc092=_0x446a2d['find'](_0x25cfd0=>(0x0,date_1[_0x38b260(0x122)])(new Date(_0x25cfd0['date']),_0x38b260(0x125))===_0x282bcc))===null||_0x2cc092===void 0x0?void 0x0:_0x2cc092[_0x38b260(0x12f)])!==null&&_0x4953ad!==void 0x0?_0x4953ad:0x0;_0x5cbd1a>0x0?_0x1a8228[_0x38b260(0x13b)]({'date':_0x282bcc,'value':Number(_0x5cbd1a)}):_0x1a8228[_0x38b260(0x13b)]({'date':_0x282bcc,'value':0x0}),_0x207a78[_0x38b260(0x167)](_0x207a78[_0x38b260(0x135)]()+0x1);}return _0x1a8228;}async[_0x9a4efe(0x151)](_0x26bc42){const _0x213b67=_0x9a4efe;var _0x13c6a4,_0x3ed5c3;const _0x3a0525=new Date();_0x3a0525[_0x213b67(0x150)](0x0,0x0,0x0,0x0);const _0x1fe385=new Date(_0x3a0525[_0x213b67(0x168)]()-(_0x26bc42-0x1)*0x18*0x3c*0x3c*0x3e8),_0x4420bc=this[_0x213b67(0x111)][_0x213b67(0x187)](_0x213b67(0x153)),_0x312d81=await _0x4420bc[_0x213b67(0x14c)](_0x213b67(0x138))[_0x213b67(0x175)]('midjourney.status\x20=\x20:status',{'status':midjourney_constant_1[_0x213b67(0x13f)][_0x213b67(0x171)]})[_0x213b67(0x170)](_0x213b67(0x17a),{'startDate':_0x1fe385})[_0x213b67(0x161)](_0x213b67(0x123))[_0x213b67(0x17e)]('date')[_0x213b67(0x113)](),_0x11867b=[],_0x5c8b1d=_0x1fe385;for(let _0x3db432=0x0;_0x3db432<_0x26bc42;_0x3db432++){const _0x57012b=(0x0,date_1['formatDate'])(new Date(_0x5c8b1d),'M.DD'),_0x32673d=(_0x3ed5c3=(_0x13c6a4=_0x312d81[_0x213b67(0x142)](_0x22d0c3=>(0x0,date_1[_0x213b67(0x122)])(new Date(_0x22d0c3[_0x213b67(0x123)]),_0x213b67(0x125))===_0x57012b))===null||_0x13c6a4===void 0x0?void 0x0:_0x13c6a4['count'])!==null&&_0x3ed5c3!==void 0x0?_0x3ed5c3:0x0;_0x32673d>0x0?_0x11867b['push']({'date':_0x57012b,'value':Number(_0x32673d)}):_0x11867b[_0x213b67(0x13b)]({'date':_0x57012b,'value':0x0}),_0x5c8b1d[_0x213b67(0x167)](_0x5c8b1d[_0x213b67(0x135)]()+0x1);}return _0x11867b;}async['getBaiduStatistics'](_0x333644){const _0x398775=_0x9a4efe;var _0x2afdaf,_0x12288e;const _0x902023=(0x0,date_1[_0x398775(0x122)])(new Date(),'YYYYMMDD'),_0x3677a6=(0x0,date_1['formatDate'])(new Date(Date[_0x398775(0x188)]()-Number(_0x333644-0x1)*0x18*0x3c*0x3c*0x3e8),'YYYYMMDD'),_0x1e6ca9=_0x398775(0x15e),_0x2078bf=_0x398775(0x165),_0x5ce45b=await this[_0x398775(0x139)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x398775(0x157),_0x398775(0x152)])}}),_0x10ebe7=(_0x2afdaf=_0x5ce45b[_0x398775(0x142)](_0x3e2096=>_0x3e2096[_0x398775(0x10d)]===_0x398775(0x152)))===null||_0x2afdaf===void 0x0?void 0x0:_0x2afdaf[_0x398775(0x116)],_0x4837c9=(_0x12288e=_0x5ce45b[_0x398775(0x142)](_0x350133=>_0x350133['configKey']===_0x398775(0x157)))===null||_0x12288e===void 0x0?void 0x0:_0x12288e[_0x398775(0x116)];if(!_0x10ebe7||!_0x4837c9)return[];if(!_0x10ebe7)throw new common_1['HttpException'](_0x398775(0x185),common_1[_0x398775(0x143)][_0x398775(0x129)]);if(!_0x4837c9)throw new common_1['HttpException']('请先配置百度统计accessToken',common_1[_0x398775(0x143)][_0x398775(0x129)]);const _0x1fb86c=_0x398775(0x130)+_0x4837c9+_0x398775(0x156)+_0x10ebe7+_0x398775(0x14a)+_0x2078bf+_0x398775(0x162)+_0x3677a6+_0x398775(0x159)+_0x902023+_0x398775(0x10e)+_0x1e6ca9,_0x3a149a=await axios_1[_0x398775(0x178)][_0x398775(0x166)](_0x1fb86c),{error_code:_0x444acd,message:_0x272eef}=_0x3a149a['data'];if(_0x444acd===0x6f)throw new common_1[(_0x398775(0x15f))](_0x272eef||_0x398775(0x181),common_1[_0x398775(0x143)][_0x398775(0x129)]);if(_0x444acd&&_0x444acd!==0xc8)throw new common_1[(_0x398775(0x15f))](_0x272eef||'获取百度统计数据失败',common_1[_0x398775(0x143)][_0x398775(0x129)]);return _0x3a149a[_0x398775(0x147)][_0x398775(0x124)];}async[_0x9a4efe(0x15d)](){const _0x1413fb=_0x9a4efe,_0x4960f3=await this[_0x1413fb(0x183)]['count']();return _0x4960f3;}async[_0x9a4efe(0x114)](){const _0x4775a0=_0x9a4efe,_0x1470c7=new Date();_0x1470c7[_0x4775a0(0x150)](0x0,0x0,0x0,0x0);const _0x29dca0=new Date(_0x1470c7[_0x4775a0(0x168)]()+0x18*0x3c*0x3c*0x3e8),_0x287089=this[_0x4775a0(0x183)][_0x4775a0(0x187)]('order'),_0x5e3446=await _0x287089[_0x4775a0(0x175)](_0x4775a0(0x15c),{'today':_0x1470c7})[_0x4775a0(0x170)](_0x4775a0(0x11a),{'tomorrow':_0x29dca0})[_0x4775a0(0x12c)]();return _0x5e3446;}};function _0x1fb5(_0x19b4c1,_0x23624a){const _0x5cc4c8=_0x5cc4();return _0x1fb5=function(_0x1fb5de,_0x472220){_0x1fb5de=_0x1fb5de-0x10d;let _0x532916=_0x5cc4c8[_0x1fb5de];return _0x532916;},_0x1fb5(_0x19b4c1,_0x23624a);}StatisticService=__decorate([(0x0,common_1[_0x9a4efe(0x133)])(),__param(0x0,(0x0,typeorm_1[_0x9a4efe(0x189)])(user_entity_1[_0x9a4efe(0x11f)])),__param(0x1,(0x0,typeorm_1[_0x9a4efe(0x189)])(chatLog_entity_1['ChatLogEntity'])),__param(0x2,(0x0,typeorm_1[_0x9a4efe(0x189)])(config_entity_1[_0x9a4efe(0x13a)])),__param(0x3,(0x0,typeorm_1[_0x9a4efe(0x189)])(order_entity_1[_0x9a4efe(0x17f)])),__param(0x4,(0x0,typeorm_1[_0x9a4efe(0x189)])(midjourney_entity_1[_0x9a4efe(0x186)])),__metadata(_0x9a4efe(0x184),[typeorm_2['Repository'],typeorm_2[_0x9a4efe(0x174)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2['Repository']])],StatisticService),exports[_0x9a4efe(0x126)]=StatisticService;