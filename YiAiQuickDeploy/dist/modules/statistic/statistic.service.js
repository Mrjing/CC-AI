'use strict';const _0x973641=_0x364d;(function(_0x4fec75,_0x5f2ca1){const _0x405c0b=_0x364d,_0x418695=_0x4fec75();while(!![]){try{const _0x2ea27d=-parseInt(_0x405c0b(0x1ca))/0x1+parseInt(_0x405c0b(0x203))/0x2+-parseInt(_0x405c0b(0x1a1))/0x3+parseInt(_0x405c0b(0x1a2))/0x4+parseInt(_0x405c0b(0x208))/0x5+parseInt(_0x405c0b(0x1b6))/0x6*(-parseInt(_0x405c0b(0x1fe))/0x7)+-parseInt(_0x405c0b(0x1a0))/0x8*(-parseInt(_0x405c0b(0x200))/0x9);if(_0x2ea27d===_0x5f2ca1)break;else _0x418695['push'](_0x418695['shift']());}catch(_0x1912c7){_0x418695['push'](_0x418695['shift']());}}}(_0x306e,0xd326b));var __decorate=this&&this[_0x973641(0x1d3)]||function(_0x23efac,_0x4d9767,_0x2d130a,_0x3e4e33){const _0x45f932=_0x973641;var _0x1fe881=arguments[_0x45f932(0x1b5)],_0x242daa=_0x1fe881<0x3?_0x4d9767:_0x3e4e33===null?_0x3e4e33=Object[_0x45f932(0x1ad)](_0x4d9767,_0x2d130a):_0x3e4e33,_0x5c01e7;if(typeof Reflect===_0x45f932(0x1b3)&&typeof Reflect[_0x45f932(0x1aa)]===_0x45f932(0x205))_0x242daa=Reflect[_0x45f932(0x1aa)](_0x23efac,_0x4d9767,_0x2d130a,_0x3e4e33);else{for(var _0x373d4d=_0x23efac['length']-0x1;_0x373d4d>=0x0;_0x373d4d--)if(_0x5c01e7=_0x23efac[_0x373d4d])_0x242daa=(_0x1fe881<0x3?_0x5c01e7(_0x242daa):_0x1fe881>0x3?_0x5c01e7(_0x4d9767,_0x2d130a,_0x242daa):_0x5c01e7(_0x4d9767,_0x2d130a))||_0x242daa;}return _0x1fe881>0x3&&_0x242daa&&Object['defineProperty'](_0x4d9767,_0x2d130a,_0x242daa),_0x242daa;},__metadata=this&&this[_0x973641(0x202)]||function(_0x3ae862,_0x25b649){const _0x1901ae=_0x973641;if(typeof Reflect===_0x1901ae(0x1b3)&&typeof Reflect['metadata']===_0x1901ae(0x205))return Reflect[_0x1901ae(0x1e1)](_0x3ae862,_0x25b649);},__param=this&&this[_0x973641(0x1bc)]||function(_0x3b0b0f,_0x2f2ab7){return function(_0x5c4304,_0x411f95){_0x2f2ab7(_0x5c4304,_0x411f95,_0x3b0b0f);};};Object[_0x973641(0x207)](exports,_0x973641(0x1b7),{'value':!![]}),exports[_0x973641(0x1a9)]=void 0x0;function _0x306e(){const _0x4249db=['chatLog.type\x20=\x20:type','YYYYMMDD','order','chatLog','object','../../common/constants/balance.constant','length','583836iNeena','__esModule','../order/order.entity','请先配置百度统计siteId','map','getRawMany','__param','@nestjs/typeorm','chatLogEntity','countChats','../../common/utils/date','orderBy','../user/user.entity','setDate','result','countChatsByTimeRange','select','countOrders','countDraws','configKey','301123QAKwMZ','countDrawsByTimeRange','chatlog.createdAt\x20>=\x20:startDate','data','countNewDrawsToday','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','baiduSiteId','ChatLogEntity','getBaiduStatistics','__decorate','ConfigEntity','DeductionKey','value','countMjDrawsByTimeRange','countNewUsersToday','createQueryBuilder','../globalConfig/config.entity','configEntity','groupBy','countNewMidhourneysToday','&start_date=','user.createdAt\x20<\x20:tomorrow','baiduToken','metadata','midjourney.createdAt\x20>=\x20:startDate','@nestjs/common','请先配置百度统计accessToken','overview/getTimeTrendRpt','setHours','getDate','../../common/constants/midjourney.constant','getTime','find','where','UserEntity','push','configVal','百度授权码过期','countNewChatsToday','order.createdAt\x20>=\x20:today','InjectRepository','PAINT_TYPE','design:paramtypes','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','chatLog.createdAt\x20<\x20:tomorrow','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','userEntity','get','midjourneyEntity','HttpStatus','chatLog.createdAt\x20>=\x20:today','chatlog','119vpnmdI','DRAWED','9531CeyGKa','order.createdAt\x20<\x20:tomorrow','__metadata','2655012LvjoXx','Injectable','function','MidjourneyStatusEnum','defineProperty','1110165QTRGaL','CHAT_TYPE','Repository','&metrics=','../midjourney/midjourney.entity','getBaiduVisit','formatDate','midjourney','default','&method=','count','orderEntity','andWhere','10808uabdSQ','4857912zUIwRK','5837024vnKKSY','BAD_REQUEST','HttpException','date','获取百度统计数据失败','chatlog.type\x20=\x20:type','M.DD','StatisticService','decorate','&site_id=','countNewOrdersToday','getOwnPropertyDescriptor','getCount'];_0x306e=function(){return _0x4249db;};return _0x306e();}function _0x364d(_0x34eec5,_0x30e8c0){const _0x306e12=_0x306e();return _0x364d=function(_0x364d55,_0x19104a){_0x364d55=_0x364d55-0x199;let _0x1eb6cc=_0x306e12[_0x364d55];return _0x1eb6cc;},_0x364d(_0x34eec5,_0x30e8c0);}const common_1=require(_0x973641(0x1e3)),typeorm_1=require(_0x973641(0x1bd)),user_entity_1=require(_0x973641(0x1c2)),typeorm_2=require('typeorm'),chatLog_entity_1=require('../chatLog/chatLog.entity'),balance_constant_1=require(_0x973641(0x1b4)),date_1=require(_0x973641(0x1c0)),axios_1=require('axios'),config_entity_1=require(_0x973641(0x1da)),order_entity_1=require(_0x973641(0x1b8)),midjourney_entity_1=require(_0x973641(0x20c)),midjourney_constant_1=require(_0x973641(0x1e8));let StatisticService=class StatisticService{constructor(_0x3183d7,_0x28bfb9,_0x5d5a97,_0x573b58,_0x2a2adb){const _0x5add3b=_0x973641;this[_0x5add3b(0x1f8)]=_0x3183d7,this[_0x5add3b(0x1be)]=_0x28bfb9,this[_0x5add3b(0x1db)]=_0x5d5a97,this[_0x5add3b(0x19e)]=_0x573b58,this[_0x5add3b(0x1fa)]=_0x2a2adb;}async['getBaseStatistic'](){const _0x147e9c=_0x973641,_0x4937c7=await this['countUsers'](),_0x4f5065=await this[_0x147e9c(0x1d8)](),_0x4745bc=await this['countChats'](),_0x3a69db=await this[_0x147e9c(0x1f0)](),_0x14854c=await this[_0x147e9c(0x1c8)](),_0x1d1f11=await this[_0x147e9c(0x1ce)](),_0x3903df=await this[_0x147e9c(0x1dd)](),_0x28b4bd=await this[_0x147e9c(0x1c7)](),_0x1510a3=await this[_0x147e9c(0x1ac)]();return{'userCount':_0x4937c7,'newUserCount':_0x4f5065,'chatCount':_0x4745bc,'newChatCount':_0x3a69db,'drawCount':_0x14854c,'newDrawCount':_0x3903df+_0x1d1f11,'orderCount':_0x28b4bd,'newOrderCount':_0x1510a3};}async['getChatStatistic']({days:days=0x7}){const _0x376088=_0x973641,_0xd6886c=await this[_0x376088(0x1c5)](days),_0xbbd380=await this['countDrawsByTimeRange'](days),_0xdeb6ac=await this[_0x376088(0x1d7)](days);return{'date':_0xd6886c['map'](_0x492221=>_0x492221['date']),'chat':_0xd6886c['map'](_0x216d66=>_0x216d66[_0x376088(0x1d6)]),'draw':_0xbbd380[_0x376088(0x1ba)]((_0x11ba3b,_0x565c90)=>{const _0x20cf68=_0x376088;return _0x11ba3b['value']+_0xdeb6ac[_0x565c90][_0x20cf68(0x1d6)];})};}async[_0x973641(0x20d)]({days:days=0x7}){const _0x5c03e2=await this['getBaiduStatistics'](days);return _0x5c03e2;}async['countUsers'](){const _0x1caec6=_0x973641,_0x3cdd7c=await this[_0x1caec6(0x1f8)][_0x1caec6(0x19d)]();return _0x3cdd7c;}async[_0x973641(0x1d8)](){const _0x113740=_0x973641,_0x496bef=new Date();_0x496bef[_0x113740(0x1e6)](0x0,0x0,0x0,0x0);const _0x16b365=new Date(_0x496bef[_0x113740(0x1e9)]()+0x18*0x3c*0x3c*0x3e8),_0x2cc703=this[_0x113740(0x1f8)]['createQueryBuilder']('user'),_0x516c49=await _0x2cc703[_0x113740(0x1eb)]('user.createdAt\x20>=\x20:today',{'today':_0x496bef})[_0x113740(0x19f)](_0x113740(0x1df),{'tomorrow':_0x16b365})[_0x113740(0x1ae)]();return _0x516c49;}async[_0x973641(0x1bf)](){const _0x32fe0d=_0x973641,_0x16581e=await this[_0x32fe0d(0x1be)][_0x32fe0d(0x19d)]({'where':{'type':balance_constant_1[_0x32fe0d(0x1d5)][_0x32fe0d(0x209)]}});return _0x16581e;}async[_0x973641(0x1f0)](){const _0x276527=_0x973641,_0x27868f=new Date();_0x27868f['setHours'](0x0,0x0,0x0,0x0);const _0x91ee5b=new Date(_0x27868f[_0x276527(0x1e9)]()+0x18*0x3c*0x3c*0x3e8),_0x4f77bd=this[_0x276527(0x1be)]['createQueryBuilder'](_0x276527(0x1b2)),_0x242dbb=await _0x4f77bd['where'](_0x276527(0x1af),{'type':balance_constant_1[_0x276527(0x1d5)][_0x276527(0x209)]})[_0x276527(0x19f)](_0x276527(0x1fc),{'today':_0x27868f})[_0x276527(0x19f)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x91ee5b})[_0x276527(0x1ae)]();return _0x242dbb;}async[_0x973641(0x1c8)](){const _0xc235e0=_0x973641,_0x182669=await this['chatLogEntity']['count']({'where':{'type':balance_constant_1[_0xc235e0(0x1d5)][_0xc235e0(0x1f3)]}});return _0x182669;}async[_0x973641(0x1ce)](){const _0xec59d2=_0x973641,_0x238428=new Date();_0x238428[_0xec59d2(0x1e6)](0x0,0x0,0x0,0x0);const _0x3561d3=new Date(_0x238428[_0xec59d2(0x1e9)]()+0x18*0x3c*0x3c*0x3e8),_0x31f60e=this[_0xec59d2(0x1be)][_0xec59d2(0x1d9)](_0xec59d2(0x1b2)),_0x5f0a57=await _0x31f60e['where'](_0xec59d2(0x1af),{'type':balance_constant_1[_0xec59d2(0x1d5)]['PAINT_TYPE']})[_0xec59d2(0x19f)](_0xec59d2(0x1fc),{'today':_0x238428})[_0xec59d2(0x19f)](_0xec59d2(0x1f6),{'tomorrow':_0x3561d3})[_0xec59d2(0x1ae)]();return _0x5f0a57;}async[_0x973641(0x1dd)](){const _0x63da6c=_0x973641,_0x1eac76=new Date();_0x1eac76['setHours'](0x0,0x0,0x0,0x0);const _0x172f55=new Date(_0x1eac76[_0x63da6c(0x1e9)]()+0x18*0x3c*0x3c*0x3e8),_0x1c51b4=this['midjourneyEntity'][_0x63da6c(0x1d9)](_0x63da6c(0x19a)),_0x530c43=await _0x1c51b4['where']('midjourney.createdAt\x20>=\x20:today',{'today':_0x1eac76})['andWhere']('midjourney.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x172f55})[_0x63da6c(0x1ae)]();return _0x530c43;}async['countChatsByTimeRange'](_0x278fe5){const _0x7ba1f1=_0x973641;var _0x45a464,_0x358338;const _0x428d1f=new Date();_0x428d1f[_0x7ba1f1(0x1e6)](0x0,0x0,0x0,0x0);const _0x1323b0=new Date(_0x428d1f[_0x7ba1f1(0x1e9)]()-(_0x278fe5-0x1)*0x18*0x3c*0x3c*0x3e8),_0xa243cb=this[_0x7ba1f1(0x1be)][_0x7ba1f1(0x1d9)]('chatlog'),_0x173e60=await _0xa243cb[_0x7ba1f1(0x1c6)](_0x7ba1f1(0x1f7))['where'](_0x7ba1f1(0x1a7),{'type':balance_constant_1[_0x7ba1f1(0x1d5)][_0x7ba1f1(0x209)]})[_0x7ba1f1(0x19f)](_0x7ba1f1(0x1cc),{'startDate':_0x1323b0})[_0x7ba1f1(0x1dc)](_0x7ba1f1(0x1a5))[_0x7ba1f1(0x1c1)](_0x7ba1f1(0x1a5))[_0x7ba1f1(0x1bb)](),_0xdd2fdd=[],_0x4daba9=_0x1323b0;for(let _0x33d213=0x0;_0x33d213<_0x278fe5;_0x33d213++){const _0x3b1a9b=(0x0,date_1['formatDate'])(new Date(_0x4daba9),_0x7ba1f1(0x1a8)),_0x4001e1=(_0x358338=(_0x45a464=_0x173e60[_0x7ba1f1(0x1ea)](_0x21090d=>(0x0,date_1[_0x7ba1f1(0x199)])(new Date(_0x21090d[_0x7ba1f1(0x1a5)]),_0x7ba1f1(0x1a8))===_0x3b1a9b))===null||_0x45a464===void 0x0?void 0x0:_0x45a464[_0x7ba1f1(0x19d)])!==null&&_0x358338!==void 0x0?_0x358338:0x0;_0x4001e1>0x0?_0xdd2fdd['push']({'date':_0x3b1a9b,'value':Number(_0x4001e1)}):_0xdd2fdd[_0x7ba1f1(0x1ed)]({'date':_0x3b1a9b,'value':0x0}),_0x4daba9[_0x7ba1f1(0x1c3)](_0x4daba9[_0x7ba1f1(0x1e7)]()+0x1);}return _0xdd2fdd;}async[_0x973641(0x1cb)](_0x5bdd64){const _0x553fc8=_0x973641;var _0x32416e,_0xadf904;const _0x105dd6=new Date();_0x105dd6[_0x553fc8(0x1e6)](0x0,0x0,0x0,0x0);const _0x4d2374=new Date(_0x105dd6[_0x553fc8(0x1e9)]()-(_0x5bdd64-0x1)*0x18*0x3c*0x3c*0x3e8),_0x11e9e3=this[_0x553fc8(0x1be)][_0x553fc8(0x1d9)](_0x553fc8(0x1fd)),_0x35b160=await _0x11e9e3['select']('DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')['where'](_0x553fc8(0x1a7),{'type':balance_constant_1[_0x553fc8(0x1d5)][_0x553fc8(0x1f3)]})[_0x553fc8(0x19f)](_0x553fc8(0x1cc),{'startDate':_0x4d2374})[_0x553fc8(0x1dc)](_0x553fc8(0x1a5))[_0x553fc8(0x1c1)](_0x553fc8(0x1a5))[_0x553fc8(0x1bb)](),_0x46eda1=[],_0x3bcb0f=_0x4d2374;for(let _0x20a760=0x0;_0x20a760<_0x5bdd64;_0x20a760++){const _0x19b1d0=(0x0,date_1[_0x553fc8(0x199)])(new Date(_0x3bcb0f),'M.DD'),_0x9de91a=(_0xadf904=(_0x32416e=_0x35b160['find'](_0x167007=>(0x0,date_1['formatDate'])(new Date(_0x167007[_0x553fc8(0x1a5)]),'M.DD')===_0x19b1d0))===null||_0x32416e===void 0x0?void 0x0:_0x32416e[_0x553fc8(0x19d)])!==null&&_0xadf904!==void 0x0?_0xadf904:0x0;_0x9de91a>0x0?_0x46eda1[_0x553fc8(0x1ed)]({'date':_0x19b1d0,'value':Number(_0x9de91a)}):_0x46eda1[_0x553fc8(0x1ed)]({'date':_0x19b1d0,'value':0x0}),_0x3bcb0f[_0x553fc8(0x1c3)](_0x3bcb0f[_0x553fc8(0x1e7)]()+0x1);}return _0x46eda1;}async['countMjDrawsByTimeRange'](_0x56340e){const _0x20bc71=_0x973641;var _0x5cdaf5,_0x4e1223;const _0x3fcfb4=new Date();_0x3fcfb4[_0x20bc71(0x1e6)](0x0,0x0,0x0,0x0);const _0x3a500d=new Date(_0x3fcfb4['getTime']()-(_0x56340e-0x1)*0x18*0x3c*0x3c*0x3e8),_0x39e229=this[_0x20bc71(0x1fa)][_0x20bc71(0x1d9)](_0x20bc71(0x19a)),_0x450278=await _0x39e229[_0x20bc71(0x1c6)](_0x20bc71(0x1cf))['where']('midjourney.status\x20=\x20:status',{'status':midjourney_constant_1[_0x20bc71(0x206)][_0x20bc71(0x1ff)]})[_0x20bc71(0x19f)](_0x20bc71(0x1e2),{'startDate':_0x3a500d})['groupBy'](_0x20bc71(0x1a5))['orderBy']('date')[_0x20bc71(0x1bb)](),_0x318625=[],_0x15c26d=_0x3a500d;for(let _0x3b0912=0x0;_0x3b0912<_0x56340e;_0x3b0912++){const _0x3a0bc8=(0x0,date_1[_0x20bc71(0x199)])(new Date(_0x15c26d),'M.DD'),_0x5b3275=(_0x4e1223=(_0x5cdaf5=_0x450278[_0x20bc71(0x1ea)](_0x306207=>(0x0,date_1[_0x20bc71(0x199)])(new Date(_0x306207['date']),_0x20bc71(0x1a8))===_0x3a0bc8))===null||_0x5cdaf5===void 0x0?void 0x0:_0x5cdaf5[_0x20bc71(0x19d)])!==null&&_0x4e1223!==void 0x0?_0x4e1223:0x0;_0x5b3275>0x0?_0x318625[_0x20bc71(0x1ed)]({'date':_0x3a0bc8,'value':Number(_0x5b3275)}):_0x318625['push']({'date':_0x3a0bc8,'value':0x0}),_0x15c26d[_0x20bc71(0x1c3)](_0x15c26d[_0x20bc71(0x1e7)]()+0x1);}return _0x318625;}async[_0x973641(0x1d2)](_0x554aaf){const _0x3578f0=_0x973641;var _0x241869,_0x37bc1c;const _0xe82f79=(0x0,date_1[_0x3578f0(0x199)])(new Date(),_0x3578f0(0x1b0)),_0x349c2e=(0x0,date_1[_0x3578f0(0x199)])(new Date(Date['now']()-Number(_0x554aaf-0x1)*0x18*0x3c*0x3c*0x3e8),'YYYYMMDD'),_0x37a0d0='pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time',_0x2b1ce8=_0x3578f0(0x1e5),_0x438588=await this[_0x3578f0(0x1db)][_0x3578f0(0x1ea)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x3578f0(0x1e0),_0x3578f0(0x1d0)])}}),_0x175b6a=(_0x241869=_0x438588[_0x3578f0(0x1ea)](_0x407a09=>_0x407a09[_0x3578f0(0x1c9)]===_0x3578f0(0x1d0)))===null||_0x241869===void 0x0?void 0x0:_0x241869[_0x3578f0(0x1ee)],_0x8d9099=(_0x37bc1c=_0x438588[_0x3578f0(0x1ea)](_0x2e09be=>_0x2e09be[_0x3578f0(0x1c9)]===_0x3578f0(0x1e0)))===null||_0x37bc1c===void 0x0?void 0x0:_0x37bc1c[_0x3578f0(0x1ee)];if(!_0x175b6a||!_0x8d9099)return[];if(!_0x175b6a)throw new common_1[(_0x3578f0(0x1a4))](_0x3578f0(0x1b9),common_1[_0x3578f0(0x1fb)][_0x3578f0(0x1a3)]);if(!_0x8d9099)throw new common_1[(_0x3578f0(0x1a4))](_0x3578f0(0x1e4),common_1[_0x3578f0(0x1fb)][_0x3578f0(0x1a3)]);const _0x433d11=_0x3578f0(0x1f5)+_0x8d9099+_0x3578f0(0x1ab)+_0x175b6a+_0x3578f0(0x19c)+_0x2b1ce8+_0x3578f0(0x1de)+_0x349c2e+'&end_date='+_0xe82f79+_0x3578f0(0x20b)+_0x37a0d0,_0x1a98b7=await axios_1[_0x3578f0(0x19b)][_0x3578f0(0x1f9)](_0x433d11),{error_code:_0x229eae,message:_0x45b047}=_0x1a98b7['data'];if(_0x229eae===0x6f)throw new common_1[(_0x3578f0(0x1a4))](_0x45b047||_0x3578f0(0x1ef),common_1[_0x3578f0(0x1fb)]['BAD_REQUEST']);if(_0x229eae&&_0x229eae!==0xc8)throw new common_1[(_0x3578f0(0x1a4))](_0x45b047||_0x3578f0(0x1a6),common_1[_0x3578f0(0x1fb)][_0x3578f0(0x1a3)]);return _0x1a98b7[_0x3578f0(0x1cd)][_0x3578f0(0x1c4)];}async['countOrders'](){const _0x99bd77=_0x973641,_0x599577=await this[_0x99bd77(0x19e)][_0x99bd77(0x19d)]();return _0x599577;}async[_0x973641(0x1ac)](){const _0x2da6b3=_0x973641,_0x1ad2d7=new Date();_0x1ad2d7['setHours'](0x0,0x0,0x0,0x0);const _0x55b44e=new Date(_0x1ad2d7[_0x2da6b3(0x1e9)]()+0x18*0x3c*0x3c*0x3e8),_0x3e48d6=this[_0x2da6b3(0x19e)][_0x2da6b3(0x1d9)](_0x2da6b3(0x1b1)),_0x3f14ec=await _0x3e48d6['where'](_0x2da6b3(0x1f1),{'today':_0x1ad2d7})[_0x2da6b3(0x19f)](_0x2da6b3(0x201),{'tomorrow':_0x55b44e})[_0x2da6b3(0x1ae)]();return _0x3f14ec;}};StatisticService=__decorate([(0x0,common_1[_0x973641(0x204)])(),__param(0x0,(0x0,typeorm_1[_0x973641(0x1f2)])(user_entity_1[_0x973641(0x1ec)])),__param(0x1,(0x0,typeorm_1[_0x973641(0x1f2)])(chatLog_entity_1[_0x973641(0x1d1)])),__param(0x2,(0x0,typeorm_1[_0x973641(0x1f2)])(config_entity_1[_0x973641(0x1d4)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(order_entity_1['OrderEntity'])),__param(0x4,(0x0,typeorm_1[_0x973641(0x1f2)])(midjourney_entity_1['MidjourneyEntity'])),__metadata(_0x973641(0x1f4),[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x973641(0x20a)],typeorm_2['Repository']])],StatisticService),exports[_0x973641(0x1a9)]=StatisticService;