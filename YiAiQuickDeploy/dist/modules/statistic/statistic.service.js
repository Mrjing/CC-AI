'use strict';const _0x328006=_0x9d50;(function(_0x4da901,_0x5615cc){const _0x357ed1=_0x9d50,_0x19b0bb=_0x4da901();while(!![]){try{const _0x272e61=parseInt(_0x357ed1(0xde))/0x1*(parseInt(_0x357ed1(0xea))/0x2)+parseInt(_0x357ed1(0xbc))/0x3*(-parseInt(_0x357ed1(0x106))/0x4)+parseInt(_0x357ed1(0xe3))/0x5+parseInt(_0x357ed1(0xba))/0x6+-parseInt(_0x357ed1(0xbe))/0x7*(parseInt(_0x357ed1(0x120))/0x8)+-parseInt(_0x357ed1(0xfc))/0x9*(-parseInt(_0x357ed1(0x110))/0xa)+-parseInt(_0x357ed1(0xd7))/0xb*(-parseInt(_0x357ed1(0xe0))/0xc);if(_0x272e61===_0x5615cc)break;else _0x19b0bb['push'](_0x19b0bb['shift']());}catch(_0xb753b3){_0x19b0bb['push'](_0x19b0bb['shift']());}}}(_0xdef1,0xd6356));function _0xdef1(){const _0x1e1926=['order.createdAt\x20>=\x20:today','HttpStatus','getChatStatistic','baiduSiteId','countChatsByTimeRange','countMjDrawsByTimeRange','599848MAMtzJ','setDate','chatlog','getDate','getCount','design:paramtypes','default','chatLog.createdAt\x20<\x20:tomorrow','&end_date=','getRawMany','user.createdAt\x20<\x20:tomorrow','countNewOrdersToday','百度授权码过期','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','862380vDSVKC','count','3460893rraCjD','M.DD','42KMOEOz','countDraws','请先配置百度统计accessToken','BAD_REQUEST','请先配置百度统计siteId','value','userEntity','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','andWhere','DeductionKey','baiduToken','@nestjs/typeorm','find','data','setHours','orderBy','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','../midjourney/midjourney.entity','chatLog','../order/order.entity','order','__metadata','@nestjs/common','&metrics=','midjourney.status\x20=\x20:status','7629391bYEyve','midjourney.createdAt\x20>=\x20:today','../../common/utils/date','groupBy','countUsers','PAINT_TYPE','countNewDrawsToday','111WAlPcn','function','12Yywlhn','Repository','configVal','1251160kGhKWD','chatlog.type\x20=\x20:type','where','push','formatDate','HttpException','typeorm','22622vJBrLU','chatLogEntity','chatlog.createdAt\x20>=\x20:startDate','YYYYMMDD','select','defineProperty','getBaiduStatistics','countChats','getBaiduVisit','&method=','获取百度统计数据失败','../../common/constants/balance.constant','createQueryBuilder','../../common/constants/midjourney.constant','user.createdAt\x20>=\x20:today','configEntity','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','midjourney','3771BOKKUX','chatLog.createdAt\x20>=\x20:today','&start_date=','midjourney.createdAt\x20<\x20:tomorrow','ChatLogEntity','Injectable','OrderEntity','configKey','countNewChatsToday','date','4zBROft','MidjourneyStatusEnum','getOwnPropertyDescriptor','DRAWED','InjectRepository','midjourneyEntity','metadata','CHAT_TYPE','getTime','ConfigEntity','3290wIUcfR','countNewUsersToday','map','countNewMidhourneysToday','object','chatLog.type\x20=\x20:type','../user/user.entity','orderEntity','length','../globalConfig/config.entity'];_0xdef1=function(){return _0x1e1926;};return _0xdef1();}function _0x9d50(_0x383460,_0x37cb18){const _0xdef1a5=_0xdef1();return _0x9d50=function(_0x9d501a,_0x15b9a9){_0x9d501a=_0x9d501a-0xb1;let _0x55bae1=_0xdef1a5[_0x9d501a];return _0x55bae1;},_0x9d50(_0x383460,_0x37cb18);}var __decorate=this&&this['__decorate']||function(_0x5fe3de,_0x84cb5c,_0x4701fe,_0xfb02d){const _0x3516db=_0x9d50;var _0x2948b0=arguments[_0x3516db(0x118)],_0x35a8de=_0x2948b0<0x3?_0x84cb5c:_0xfb02d===null?_0xfb02d=Object[_0x3516db(0x108)](_0x84cb5c,_0x4701fe):_0xfb02d,_0x538718;if(typeof Reflect===_0x3516db(0x114)&&typeof Reflect['decorate']==='function')_0x35a8de=Reflect['decorate'](_0x5fe3de,_0x84cb5c,_0x4701fe,_0xfb02d);else{for(var _0x1af41e=_0x5fe3de['length']-0x1;_0x1af41e>=0x0;_0x1af41e--)if(_0x538718=_0x5fe3de[_0x1af41e])_0x35a8de=(_0x2948b0<0x3?_0x538718(_0x35a8de):_0x2948b0>0x3?_0x538718(_0x84cb5c,_0x4701fe,_0x35a8de):_0x538718(_0x84cb5c,_0x4701fe))||_0x35a8de;}return _0x2948b0>0x3&&_0x35a8de&&Object[_0x3516db(0xef)](_0x84cb5c,_0x4701fe,_0x35a8de),_0x35a8de;},__metadata=this&&this[_0x328006(0xd3)]||function(_0x5da361,_0x247e69){const _0x524f51=_0x328006;if(typeof Reflect===_0x524f51(0x114)&&typeof Reflect[_0x524f51(0x10c)]===_0x524f51(0xdf))return Reflect[_0x524f51(0x10c)](_0x5da361,_0x247e69);},__param=this&&this['__param']||function(_0x3c277c,_0x483d6c){return function(_0x3fdc6a,_0x185688){_0x483d6c(_0x3fdc6a,_0x185688,_0x3c277c);};};Object[_0x328006(0xef)](exports,'__esModule',{'value':!![]}),exports['StatisticService']=void 0x0;const common_1=require(_0x328006(0xd4)),typeorm_1=require(_0x328006(0xc9)),user_entity_1=require(_0x328006(0x116)),typeorm_2=require(_0x328006(0xe9)),chatLog_entity_1=require('../chatLog/chatLog.entity'),balance_constant_1=require(_0x328006(0xf5)),date_1=require(_0x328006(0xd9)),axios_1=require('axios'),config_entity_1=require(_0x328006(0x119)),order_entity_1=require(_0x328006(0xd1)),midjourney_entity_1=require(_0x328006(0xcf)),midjourney_constant_1=require(_0x328006(0xf7));let StatisticService=class StatisticService{constructor(_0x4baf77,_0x284dbb,_0x9cf06a,_0x2096f9,_0x4fb04d){const _0x4902bc=_0x328006;this['userEntity']=_0x4baf77,this[_0x4902bc(0xeb)]=_0x284dbb,this[_0x4902bc(0xf9)]=_0x9cf06a,this[_0x4902bc(0x117)]=_0x2096f9,this[_0x4902bc(0x10b)]=_0x4fb04d;}async['getBaseStatistic'](){const _0x43bfcb=_0x328006,_0x40e842=await this[_0x43bfcb(0xdb)](),_0x290d71=await this[_0x43bfcb(0x111)](),_0x170e0b=await this['countChats'](),_0x93dcf5=await this[_0x43bfcb(0x104)](),_0x321e5f=await this[_0x43bfcb(0xbf)](),_0x39daa5=await this['countNewDrawsToday'](),_0x4cd3ec=await this[_0x43bfcb(0x113)](),_0xd91395=await this['countOrders'](),_0x254212=await this['countNewOrdersToday']();return{'userCount':_0x40e842,'newUserCount':_0x290d71,'chatCount':_0x170e0b,'newChatCount':_0x93dcf5,'drawCount':_0x321e5f,'newDrawCount':_0x4cd3ec+_0x39daa5,'orderCount':_0xd91395,'newOrderCount':_0x254212};}async[_0x328006(0x11c)]({days:days=0x7}){const _0x2ca73f=_0x328006,_0x16eb00=await this[_0x2ca73f(0x11e)](days),_0xb4348c=await this['countDrawsByTimeRange'](days),_0x3fc8f8=await this[_0x2ca73f(0x11f)](days);return{'date':_0x16eb00[_0x2ca73f(0x112)](_0x361bd4=>_0x361bd4[_0x2ca73f(0x105)]),'chat':_0x16eb00['map'](_0x54b77b=>_0x54b77b[_0x2ca73f(0xc3)]),'draw':_0xb4348c[_0x2ca73f(0x112)]((_0x5c87c9,_0x474155)=>{return _0x5c87c9['value']+_0x3fc8f8[_0x474155]['value'];})};}async[_0x328006(0xf2)]({days:days=0x7}){const _0x328aba=_0x328006,_0xca901a=await this[_0x328aba(0xf0)](days);return _0xca901a;}async['countUsers'](){const _0x51d5dd=_0x328006,_0x37b171=await this[_0x51d5dd(0xc4)][_0x51d5dd(0xbb)]();return _0x37b171;}async['countNewUsersToday'](){const _0x170cfe=_0x328006,_0x42d0af=new Date();_0x42d0af[_0x170cfe(0xcc)](0x0,0x0,0x0,0x0);const _0x107893=new Date(_0x42d0af['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x151f51=this[_0x170cfe(0xc4)][_0x170cfe(0xf6)]('user'),_0xf62b8b=await _0x151f51['where'](_0x170cfe(0xf8),{'today':_0x42d0af})[_0x170cfe(0xc6)](_0x170cfe(0xb6),{'tomorrow':_0x107893})[_0x170cfe(0x124)]();return _0xf62b8b;}async[_0x328006(0xf1)](){const _0x220e79=_0x328006,_0x1ba167=await this[_0x220e79(0xeb)][_0x220e79(0xbb)]({'where':{'type':balance_constant_1[_0x220e79(0xc7)][_0x220e79(0x10d)]}});return _0x1ba167;}async[_0x328006(0x104)](){const _0x412e33=_0x328006,_0x2f81ff=new Date();_0x2f81ff['setHours'](0x0,0x0,0x0,0x0);const _0x52568b=new Date(_0x2f81ff['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x9bfd66=this[_0x412e33(0xeb)]['createQueryBuilder'](_0x412e33(0xd0)),_0x42eea0=await _0x9bfd66[_0x412e33(0xe5)](_0x412e33(0x115),{'type':balance_constant_1[_0x412e33(0xc7)]['CHAT_TYPE']})[_0x412e33(0xc6)]('chatLog.createdAt\x20>=\x20:today',{'today':_0x2f81ff})[_0x412e33(0xc6)](_0x412e33(0xb3),{'tomorrow':_0x52568b})[_0x412e33(0x124)]();return _0x42eea0;}async[_0x328006(0xbf)](){const _0x367697=_0x328006,_0xa48606=await this[_0x367697(0xeb)][_0x367697(0xbb)]({'where':{'type':balance_constant_1[_0x367697(0xc7)]['PAINT_TYPE']}});return _0xa48606;}async[_0x328006(0xdd)](){const _0x36ec45=_0x328006,_0x3583ce=new Date();_0x3583ce[_0x36ec45(0xcc)](0x0,0x0,0x0,0x0);const _0x3cdc61=new Date(_0x3583ce[_0x36ec45(0x10e)]()+0x18*0x3c*0x3c*0x3e8),_0x32266a=this[_0x36ec45(0xeb)][_0x36ec45(0xf6)](_0x36ec45(0xd0)),_0x2be093=await _0x32266a[_0x36ec45(0xe5)](_0x36ec45(0x115),{'type':balance_constant_1[_0x36ec45(0xc7)][_0x36ec45(0xdc)]})[_0x36ec45(0xc6)](_0x36ec45(0xfd),{'today':_0x3583ce})[_0x36ec45(0xc6)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x3cdc61})[_0x36ec45(0x124)]();return _0x2be093;}async[_0x328006(0x113)](){const _0x40571e=_0x328006,_0x5afbe2=new Date();_0x5afbe2[_0x40571e(0xcc)](0x0,0x0,0x0,0x0);const _0x2d9af5=new Date(_0x5afbe2[_0x40571e(0x10e)]()+0x18*0x3c*0x3c*0x3e8),_0x4c6fc4=this[_0x40571e(0x10b)][_0x40571e(0xf6)](_0x40571e(0xfb)),_0xdcc107=await _0x4c6fc4['where'](_0x40571e(0xd8),{'today':_0x5afbe2})[_0x40571e(0xc6)](_0x40571e(0xff),{'tomorrow':_0x2d9af5})[_0x40571e(0x124)]();return _0xdcc107;}async[_0x328006(0x11e)](_0x63c7a0){const _0xf97996=_0x328006;var _0x2ea8b9,_0x5d029e;const _0x11d619=new Date();_0x11d619[_0xf97996(0xcc)](0x0,0x0,0x0,0x0);const _0x32bb26=new Date(_0x11d619['getTime']()-(_0x63c7a0-0x1)*0x18*0x3c*0x3c*0x3e8),_0x52ee13=this['chatLogEntity'][_0xf97996(0xf6)](_0xf97996(0x122)),_0x571b8c=await _0x52ee13['select'](_0xf97996(0xb9))[_0xf97996(0xe5)](_0xf97996(0xe4),{'type':balance_constant_1[_0xf97996(0xc7)][_0xf97996(0x10d)]})[_0xf97996(0xc6)](_0xf97996(0xec),{'startDate':_0x32bb26})['groupBy'](_0xf97996(0x105))['orderBy']('date')[_0xf97996(0xb5)](),_0x2caa30=[],_0x3d1fc5=_0x32bb26;for(let _0x21128f=0x0;_0x21128f<_0x63c7a0;_0x21128f++){const _0x53116a=(0x0,date_1['formatDate'])(new Date(_0x3d1fc5),_0xf97996(0xbd)),_0x1d8795=(_0x5d029e=(_0x2ea8b9=_0x571b8c[_0xf97996(0xca)](_0x24a288=>(0x0,date_1[_0xf97996(0xe7)])(new Date(_0x24a288[_0xf97996(0x105)]),'M.DD')===_0x53116a))===null||_0x2ea8b9===void 0x0?void 0x0:_0x2ea8b9[_0xf97996(0xbb)])!==null&&_0x5d029e!==void 0x0?_0x5d029e:0x0;_0x1d8795>0x0?_0x2caa30[_0xf97996(0xe6)]({'date':_0x53116a,'value':Number(_0x1d8795)}):_0x2caa30['push']({'date':_0x53116a,'value':0x0}),_0x3d1fc5[_0xf97996(0x121)](_0x3d1fc5['getDate']()+0x1);}return _0x2caa30;}async['countDrawsByTimeRange'](_0x1e3005){const _0xdc8e8=_0x328006;var _0x2d9442,_0x39c2e6;const _0x160912=new Date();_0x160912[_0xdc8e8(0xcc)](0x0,0x0,0x0,0x0);const _0x25cdcc=new Date(_0x160912['getTime']()-(_0x1e3005-0x1)*0x18*0x3c*0x3c*0x3e8),_0x56b36c=this[_0xdc8e8(0xeb)]['createQueryBuilder']('chatlog'),_0x309af2=await _0x56b36c[_0xdc8e8(0xee)](_0xdc8e8(0xb9))['where']('chatlog.type\x20=\x20:type',{'type':balance_constant_1['DeductionKey'][_0xdc8e8(0xdc)]})[_0xdc8e8(0xc6)](_0xdc8e8(0xec),{'startDate':_0x25cdcc})[_0xdc8e8(0xda)](_0xdc8e8(0x105))[_0xdc8e8(0xcd)]('date')['getRawMany'](),_0x41f60f=[],_0x3fdf24=_0x25cdcc;for(let _0x2e9d1c=0x0;_0x2e9d1c<_0x1e3005;_0x2e9d1c++){const _0x2214cc=(0x0,date_1[_0xdc8e8(0xe7)])(new Date(_0x3fdf24),_0xdc8e8(0xbd)),_0x52d861=(_0x39c2e6=(_0x2d9442=_0x309af2[_0xdc8e8(0xca)](_0x232604=>(0x0,date_1[_0xdc8e8(0xe7)])(new Date(_0x232604['date']),_0xdc8e8(0xbd))===_0x2214cc))===null||_0x2d9442===void 0x0?void 0x0:_0x2d9442[_0xdc8e8(0xbb)])!==null&&_0x39c2e6!==void 0x0?_0x39c2e6:0x0;_0x52d861>0x0?_0x41f60f[_0xdc8e8(0xe6)]({'date':_0x2214cc,'value':Number(_0x52d861)}):_0x41f60f[_0xdc8e8(0xe6)]({'date':_0x2214cc,'value':0x0}),_0x3fdf24[_0xdc8e8(0x121)](_0x3fdf24['getDate']()+0x1);}return _0x41f60f;}async[_0x328006(0x11f)](_0x253e6b){const _0x5488a8=_0x328006;var _0x3a99bf,_0xdc79fb;const _0x304692=new Date();_0x304692['setHours'](0x0,0x0,0x0,0x0);const _0x26979d=new Date(_0x304692[_0x5488a8(0x10e)]()-(_0x253e6b-0x1)*0x18*0x3c*0x3c*0x3e8),_0x2ceb1f=this[_0x5488a8(0x10b)]['createQueryBuilder']('midjourney'),_0x13b239=await _0x2ceb1f[_0x5488a8(0xee)](_0x5488a8(0xce))[_0x5488a8(0xe5)](_0x5488a8(0xd6),{'status':midjourney_constant_1[_0x5488a8(0x107)][_0x5488a8(0x109)]})['andWhere']('midjourney.createdAt\x20>=\x20:startDate',{'startDate':_0x26979d})[_0x5488a8(0xda)]('date')[_0x5488a8(0xcd)]('date')['getRawMany'](),_0x2be950=[],_0x11b649=_0x26979d;for(let _0x978422=0x0;_0x978422<_0x253e6b;_0x978422++){const _0x2fbd28=(0x0,date_1[_0x5488a8(0xe7)])(new Date(_0x11b649),_0x5488a8(0xbd)),_0x2c0802=(_0xdc79fb=(_0x3a99bf=_0x13b239[_0x5488a8(0xca)](_0x5e6fa8=>(0x0,date_1[_0x5488a8(0xe7)])(new Date(_0x5e6fa8['date']),_0x5488a8(0xbd))===_0x2fbd28))===null||_0x3a99bf===void 0x0?void 0x0:_0x3a99bf[_0x5488a8(0xbb)])!==null&&_0xdc79fb!==void 0x0?_0xdc79fb:0x0;_0x2c0802>0x0?_0x2be950[_0x5488a8(0xe6)]({'date':_0x2fbd28,'value':Number(_0x2c0802)}):_0x2be950[_0x5488a8(0xe6)]({'date':_0x2fbd28,'value':0x0}),_0x11b649[_0x5488a8(0x121)](_0x11b649[_0x5488a8(0x123)]()+0x1);}return _0x2be950;}async[_0x328006(0xf0)](_0x19f54d){const _0x35e601=_0x328006;var _0x21e09e,_0x3f3687;const _0x18250f=(0x0,date_1['formatDate'])(new Date(),_0x35e601(0xed)),_0x34345e=(0x0,date_1[_0x35e601(0xe7)])(new Date(Date['now']()-Number(_0x19f54d-0x1)*0x18*0x3c*0x3c*0x3e8),_0x35e601(0xed)),_0x22018d=_0x35e601(0xfa),_0xf2084c='overview/getTimeTrendRpt',_0x223e9e=await this[_0x35e601(0xf9)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x35e601(0xc8),_0x35e601(0x11d)])}}),_0x1eec3e=(_0x21e09e=_0x223e9e['find'](_0x5dd4c8=>_0x5dd4c8[_0x35e601(0x103)]===_0x35e601(0x11d)))===null||_0x21e09e===void 0x0?void 0x0:_0x21e09e[_0x35e601(0xe2)],_0x36dc65=(_0x3f3687=_0x223e9e[_0x35e601(0xca)](_0x91f89b=>_0x91f89b[_0x35e601(0x103)]==='baiduToken'))===null||_0x3f3687===void 0x0?void 0x0:_0x3f3687[_0x35e601(0xe2)];if(!_0x1eec3e||!_0x36dc65)return[];if(!_0x1eec3e)throw new common_1[(_0x35e601(0xe8))](_0x35e601(0xc2),common_1['HttpStatus'][_0x35e601(0xc1)]);if(!_0x36dc65)throw new common_1['HttpException'](_0x35e601(0xc0),common_1[_0x35e601(0x11b)][_0x35e601(0xc1)]);const _0x2fc769=_0x35e601(0xc5)+_0x36dc65+'&site_id='+_0x1eec3e+_0x35e601(0xf3)+_0xf2084c+_0x35e601(0xfe)+_0x34345e+_0x35e601(0xb4)+_0x18250f+_0x35e601(0xd5)+_0x22018d,_0x223181=await axios_1[_0x35e601(0xb2)]['get'](_0x2fc769),{error_code:_0x47cf43,message:_0x3e0ed5}=_0x223181[_0x35e601(0xcb)];if(_0x47cf43===0x6f)throw new common_1[(_0x35e601(0xe8))](_0x3e0ed5||_0x35e601(0xb8),common_1['HttpStatus']['BAD_REQUEST']);if(_0x47cf43&&_0x47cf43!==0xc8)throw new common_1['HttpException'](_0x3e0ed5||_0x35e601(0xf4),common_1[_0x35e601(0x11b)]['BAD_REQUEST']);return _0x223181['data']['result'];}async['countOrders'](){const _0x35ff64=_0x328006,_0x3a32a0=await this[_0x35ff64(0x117)][_0x35ff64(0xbb)]();return _0x3a32a0;}async[_0x328006(0xb7)](){const _0x3a3f0b=_0x328006,_0xa9a255=new Date();_0xa9a255[_0x3a3f0b(0xcc)](0x0,0x0,0x0,0x0);const _0x2276c1=new Date(_0xa9a255['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x4c5ada=this[_0x3a3f0b(0x117)][_0x3a3f0b(0xf6)](_0x3a3f0b(0xd2)),_0x2f0b11=await _0x4c5ada[_0x3a3f0b(0xe5)](_0x3a3f0b(0x11a),{'today':_0xa9a255})[_0x3a3f0b(0xc6)]('order.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x2276c1})[_0x3a3f0b(0x124)]();return _0x2f0b11;}};StatisticService=__decorate([(0x0,common_1[_0x328006(0x101)])(),__param(0x0,(0x0,typeorm_1[_0x328006(0x10a)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x328006(0x10a)])(chatLog_entity_1[_0x328006(0x100)])),__param(0x2,(0x0,typeorm_1[_0x328006(0x10a)])(config_entity_1[_0x328006(0x10f)])),__param(0x3,(0x0,typeorm_1[_0x328006(0x10a)])(order_entity_1[_0x328006(0x102)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1['MidjourneyEntity'])),__metadata(_0x328006(0xb1),[typeorm_2[_0x328006(0xe1)],typeorm_2[_0x328006(0xe1)],typeorm_2[_0x328006(0xe1)],typeorm_2['Repository'],typeorm_2[_0x328006(0xe1)]])],StatisticService),exports['StatisticService']=StatisticService;