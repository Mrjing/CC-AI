'use strict';function _0x2d9c(_0x55d6df,_0x10a031){const _0x71e570=_0x71e5();return _0x2d9c=function(_0x2d9cfb,_0x2bc36d){_0x2d9cfb=_0x2d9cfb-0x11d;let _0x243a92=_0x71e570[_0x2d9cfb];return _0x243a92;},_0x2d9c(_0x55d6df,_0x10a031);}const _0x33f633=_0x2d9c;(function(_0x15702d,_0x3da769){const _0x524443=_0x2d9c,_0x51d298=_0x15702d();while(!![]){try{const _0x26855b=-parseInt(_0x524443(0x15d))/0x1+-parseInt(_0x524443(0x171))/0x2+-parseInt(_0x524443(0x157))/0x3+-parseInt(_0x524443(0x16b))/0x4+parseInt(_0x524443(0x16e))/0x5*(parseInt(_0x524443(0x140))/0x6)+parseInt(_0x524443(0x195))/0x7*(parseInt(_0x524443(0x18f))/0x8)+parseInt(_0x524443(0x133))/0x9*(parseInt(_0x524443(0x192))/0xa);if(_0x26855b===_0x3da769)break;else _0x51d298['push'](_0x51d298['shift']());}catch(_0x354d9c){_0x51d298['push'](_0x51d298['shift']());}}}(_0x71e5,0x48144));var __decorate=this&&this[_0x33f633(0x13c)]||function(_0x22d5ad,_0x19eaa9,_0x506a8a,_0x55a768){const _0x3b857e=_0x33f633;var _0x1206bc=arguments[_0x3b857e(0x11d)],_0x5ee6ad=_0x1206bc<0x3?_0x19eaa9:_0x55a768===null?_0x55a768=Object[_0x3b857e(0x124)](_0x19eaa9,_0x506a8a):_0x55a768,_0x5f2e55;if(typeof Reflect===_0x3b857e(0x149)&&typeof Reflect[_0x3b857e(0x144)]==='function')_0x5ee6ad=Reflect[_0x3b857e(0x144)](_0x22d5ad,_0x19eaa9,_0x506a8a,_0x55a768);else{for(var _0x2cacd2=_0x22d5ad[_0x3b857e(0x11d)]-0x1;_0x2cacd2>=0x0;_0x2cacd2--)if(_0x5f2e55=_0x22d5ad[_0x2cacd2])_0x5ee6ad=(_0x1206bc<0x3?_0x5f2e55(_0x5ee6ad):_0x1206bc>0x3?_0x5f2e55(_0x19eaa9,_0x506a8a,_0x5ee6ad):_0x5f2e55(_0x19eaa9,_0x506a8a))||_0x5ee6ad;}return _0x1206bc>0x3&&_0x5ee6ad&&Object[_0x3b857e(0x17f)](_0x19eaa9,_0x506a8a,_0x5ee6ad),_0x5ee6ad;},__metadata=this&&this[_0x33f633(0x188)]||function(_0x3e1d0b,_0x2ccff4){const _0x51fb0c=_0x33f633;if(typeof Reflect===_0x51fb0c(0x149)&&typeof Reflect[_0x51fb0c(0x177)]==='function')return Reflect[_0x51fb0c(0x177)](_0x3e1d0b,_0x2ccff4);},__param=this&&this[_0x33f633(0x170)]||function(_0x44c912,_0x4de171){return function(_0x411414,_0x4606eb){_0x4de171(_0x411414,_0x4606eb,_0x44c912);};};function _0x71e5(){const _0xdc11db=['countMjDrawsByTimeRange','@nestjs/common','orderBy','请先配置百度统计siteId','midjourneyEntity','../../common/utils/date','countNewChatsToday','order.createdAt\x20>=\x20:today','StatisticService','chatLog.createdAt\x20>=\x20:today','countOrders','countNewMidhourneysToday','700671hgHGXR','groupBy','order','order.createdAt\x20<\x20:tomorrow','countChatsByTimeRange','setHours','454866AuEkIl','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','formatDate','&end_date=','getCount','default','../midjourney/midjourney.entity','getChatStatistic','&metrics=','getDate','value','countNewDrawsToday','&site_id=','setDate','20848UVeYWt','chatlog.type\x20=\x20:type','ChatLogEntity','264005IostGh','typeorm','__param','1141484EEINcc','orderEntity','../order/order.entity','data','getBaseStatistic','date','metadata','DeductionKey','CHAT_TYPE','countNewOrdersToday','countNewUsersToday','where','baiduToken','configVal','defineProperty','Injectable','../../common/constants/midjourney.constant','countDraws','MidjourneyStatusEnum','getBaiduVisit','now','M.DD','ConfigEntity','__metadata','chatLog.createdAt\x20<\x20:tomorrow','@nestjs/typeorm','map','HttpStatus','InjectRepository','UserEntity','16dPZZpU','DRAWED','push','11169980Epovhh','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','OrderEntity','994742ZAARIf','length','&start_date=','PAINT_TYPE','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','../user/user.entity','chatLogEntity','user.createdAt\x20<\x20:tomorrow','getOwnPropertyDescriptor','获取百度统计数据失败','overview/getTimeTrendRpt','chatlog','MidjourneyEntity','&method=','../chatLog/chatLog.entity','midjourney.createdAt\x20<\x20:tomorrow','BAD_REQUEST','Repository','YYYYMMDD','chatLog','baiduSiteId','result','百度授权码过期','9UavrTf','countChats','configEntity','configKey','chatLog.type\x20=\x20:type','andWhere','countDrawsByTimeRange','getTime','select','__decorate','find','userEntity','../globalConfig/config.entity','18zkCYlm','count','HttpException','请先配置百度统计accessToken','decorate','get','createQueryBuilder','user','getRawMany','object','midjourney.createdAt\x20>=\x20:startDate'];_0x71e5=function(){return _0xdc11db;};return _0x71e5();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x33f633(0x153)]=void 0x0;const common_1=require(_0x33f633(0x14c)),typeorm_1=require(_0x33f633(0x18a)),user_entity_1=require(_0x33f633(0x121)),typeorm_2=require(_0x33f633(0x16f)),chatLog_entity_1=require(_0x33f633(0x12a)),balance_constant_1=require('../../common/constants/balance.constant'),date_1=require(_0x33f633(0x150)),axios_1=require('axios'),config_entity_1=require(_0x33f633(0x13f)),order_entity_1=require(_0x33f633(0x173)),midjourney_entity_1=require(_0x33f633(0x163)),midjourney_constant_1=require(_0x33f633(0x181));let StatisticService=class StatisticService{constructor(_0x4dd5a0,_0x30b8bd,_0x59832f,_0x2b04d1,_0x1c7623){const _0x1ef482=_0x33f633;this[_0x1ef482(0x13e)]=_0x4dd5a0,this[_0x1ef482(0x122)]=_0x30b8bd,this[_0x1ef482(0x135)]=_0x59832f,this['orderEntity']=_0x2b04d1,this[_0x1ef482(0x14f)]=_0x1c7623;}async[_0x33f633(0x175)](){const _0x2aee01=_0x33f633,_0x202f05=await this['countUsers'](),_0x35bea7=await this['countNewUsersToday'](),_0x46e51b=await this[_0x2aee01(0x134)](),_0x586a9e=await this[_0x2aee01(0x151)](),_0x4821f6=await this[_0x2aee01(0x182)](),_0x1ee517=await this[_0x2aee01(0x168)](),_0x18bcd4=await this['countNewMidhourneysToday'](),_0x57657d=await this[_0x2aee01(0x155)](),_0x13211d=await this[_0x2aee01(0x17a)]();return{'userCount':_0x202f05,'newUserCount':_0x35bea7,'chatCount':_0x46e51b,'newChatCount':_0x586a9e,'drawCount':_0x4821f6,'newDrawCount':_0x18bcd4+_0x1ee517,'orderCount':_0x57657d,'newOrderCount':_0x13211d};}async[_0x33f633(0x164)]({days:days=0x7}){const _0x1f632a=_0x33f633,_0x1fde93=await this[_0x1f632a(0x15b)](days),_0x9c118b=await this[_0x1f632a(0x139)](days),_0x1da5c7=await this['countMjDrawsByTimeRange'](days);return{'date':_0x1fde93['map'](_0x3165b0=>_0x3165b0[_0x1f632a(0x176)]),'chat':_0x1fde93[_0x1f632a(0x18b)](_0x182f53=>_0x182f53[_0x1f632a(0x167)]),'draw':_0x9c118b[_0x1f632a(0x18b)]((_0xd1b822,_0x24f609)=>{const _0x40a7eb=_0x1f632a;return _0xd1b822[_0x40a7eb(0x167)]+_0x1da5c7[_0x24f609][_0x40a7eb(0x167)];})};}async[_0x33f633(0x184)]({days:days=0x7}){const _0x3b5806=await this['getBaiduStatistics'](days);return _0x3b5806;}async['countUsers'](){const _0x3d50ef=_0x33f633,_0x2ac88e=await this[_0x3d50ef(0x13e)][_0x3d50ef(0x141)]();return _0x2ac88e;}async[_0x33f633(0x17b)](){const _0x1cfeec=_0x33f633,_0x23e561=new Date();_0x23e561[_0x1cfeec(0x15c)](0x0,0x0,0x0,0x0);const _0x20e409=new Date(_0x23e561[_0x1cfeec(0x13a)]()+0x18*0x3c*0x3c*0x3e8),_0x4c298b=this[_0x1cfeec(0x13e)]['createQueryBuilder'](_0x1cfeec(0x147)),_0x16d394=await _0x4c298b[_0x1cfeec(0x17c)]('user.createdAt\x20>=\x20:today',{'today':_0x23e561})[_0x1cfeec(0x138)](_0x1cfeec(0x123),{'tomorrow':_0x20e409})['getCount']();return _0x16d394;}async[_0x33f633(0x134)](){const _0x5cf476=_0x33f633,_0x525813=await this['chatLogEntity'][_0x5cf476(0x141)]({'where':{'type':balance_constant_1['DeductionKey'][_0x5cf476(0x179)]}});return _0x525813;}async[_0x33f633(0x151)](){const _0x12657f=_0x33f633,_0x50eb4a=new Date();_0x50eb4a[_0x12657f(0x15c)](0x0,0x0,0x0,0x0);const _0x4da975=new Date(_0x50eb4a[_0x12657f(0x13a)]()+0x18*0x3c*0x3c*0x3e8),_0x30b00a=this[_0x12657f(0x122)][_0x12657f(0x146)](_0x12657f(0x12f)),_0x5dd7fa=await _0x30b00a[_0x12657f(0x17c)](_0x12657f(0x137),{'type':balance_constant_1[_0x12657f(0x178)][_0x12657f(0x179)]})[_0x12657f(0x138)](_0x12657f(0x154),{'today':_0x50eb4a})[_0x12657f(0x138)](_0x12657f(0x189),{'tomorrow':_0x4da975})[_0x12657f(0x161)]();return _0x5dd7fa;}async[_0x33f633(0x182)](){const _0xd687e0=_0x33f633,_0x445a0c=await this[_0xd687e0(0x122)]['count']({'where':{'type':balance_constant_1[_0xd687e0(0x178)]['PAINT_TYPE']}});return _0x445a0c;}async[_0x33f633(0x168)](){const _0xba6d62=_0x33f633,_0xfce134=new Date();_0xfce134['setHours'](0x0,0x0,0x0,0x0);const _0x453c8c=new Date(_0xfce134[_0xba6d62(0x13a)]()+0x18*0x3c*0x3c*0x3e8),_0xf31bf5=this[_0xba6d62(0x122)]['createQueryBuilder']('chatLog'),_0xe060f8=await _0xf31bf5[_0xba6d62(0x17c)](_0xba6d62(0x137),{'type':balance_constant_1[_0xba6d62(0x178)][_0xba6d62(0x11f)]})[_0xba6d62(0x138)](_0xba6d62(0x154),{'today':_0xfce134})[_0xba6d62(0x138)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x453c8c})[_0xba6d62(0x161)]();return _0xe060f8;}async[_0x33f633(0x156)](){const _0x24f42f=_0x33f633,_0x133cb5=new Date();_0x133cb5[_0x24f42f(0x15c)](0x0,0x0,0x0,0x0);const _0x2a655d=new Date(_0x133cb5[_0x24f42f(0x13a)]()+0x18*0x3c*0x3c*0x3e8),_0xc92442=this[_0x24f42f(0x14f)][_0x24f42f(0x146)]('midjourney'),_0x14f29b=await _0xc92442['where']('midjourney.createdAt\x20>=\x20:today',{'today':_0x133cb5})[_0x24f42f(0x138)](_0x24f42f(0x12b),{'tomorrow':_0x2a655d})['getCount']();return _0x14f29b;}async[_0x33f633(0x15b)](_0x3f9844){const _0x132d9b=_0x33f633;var _0x374573,_0x276416;const _0xba895=new Date();_0xba895[_0x132d9b(0x15c)](0x0,0x0,0x0,0x0);const _0xdd86c3=new Date(_0xba895[_0x132d9b(0x13a)]()-(_0x3f9844-0x1)*0x18*0x3c*0x3c*0x3e8),_0x21bcf8=this[_0x132d9b(0x122)][_0x132d9b(0x146)](_0x132d9b(0x127)),_0x30c7ce=await _0x21bcf8['select'](_0x132d9b(0x15e))[_0x132d9b(0x17c)](_0x132d9b(0x16c),{'type':balance_constant_1[_0x132d9b(0x178)][_0x132d9b(0x179)]})[_0x132d9b(0x138)]('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0xdd86c3})['groupBy']('date')[_0x132d9b(0x14d)]('date')['getRawMany'](),_0x12f688=[],_0xb07951=_0xdd86c3;for(let _0x1c7941=0x0;_0x1c7941<_0x3f9844;_0x1c7941++){const _0x589c9e=(0x0,date_1[_0x132d9b(0x15f)])(new Date(_0xb07951),_0x132d9b(0x186)),_0x557ce7=(_0x276416=(_0x374573=_0x30c7ce['find'](_0x4fb606=>(0x0,date_1[_0x132d9b(0x15f)])(new Date(_0x4fb606['date']),'M.DD')===_0x589c9e))===null||_0x374573===void 0x0?void 0x0:_0x374573[_0x132d9b(0x141)])!==null&&_0x276416!==void 0x0?_0x276416:0x0;_0x557ce7>0x0?_0x12f688[_0x132d9b(0x191)]({'date':_0x589c9e,'value':Number(_0x557ce7)}):_0x12f688['push']({'date':_0x589c9e,'value':0x0}),_0xb07951[_0x132d9b(0x16a)](_0xb07951['getDate']()+0x1);}return _0x12f688;}async['countDrawsByTimeRange'](_0x18f7bf){const _0x226eed=_0x33f633;var _0x2ee85b,_0x4d7543;const _0x3010a4=new Date();_0x3010a4[_0x226eed(0x15c)](0x0,0x0,0x0,0x0);const _0x2af235=new Date(_0x3010a4[_0x226eed(0x13a)]()-(_0x18f7bf-0x1)*0x18*0x3c*0x3c*0x3e8),_0x3f9f55=this[_0x226eed(0x122)][_0x226eed(0x146)](_0x226eed(0x127)),_0x59b720=await _0x3f9f55[_0x226eed(0x13b)](_0x226eed(0x15e))['where'](_0x226eed(0x16c),{'type':balance_constant_1[_0x226eed(0x178)][_0x226eed(0x11f)]})['andWhere']('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x2af235})['groupBy'](_0x226eed(0x176))['orderBy'](_0x226eed(0x176))[_0x226eed(0x148)](),_0x262b41=[],_0x7d8e71=_0x2af235;for(let _0x2e2d43=0x0;_0x2e2d43<_0x18f7bf;_0x2e2d43++){const _0x3f5e01=(0x0,date_1['formatDate'])(new Date(_0x7d8e71),_0x226eed(0x186)),_0x4d594d=(_0x4d7543=(_0x2ee85b=_0x59b720[_0x226eed(0x13d)](_0x216599=>(0x0,date_1[_0x226eed(0x15f)])(new Date(_0x216599[_0x226eed(0x176)]),'M.DD')===_0x3f5e01))===null||_0x2ee85b===void 0x0?void 0x0:_0x2ee85b[_0x226eed(0x141)])!==null&&_0x4d7543!==void 0x0?_0x4d7543:0x0;_0x4d594d>0x0?_0x262b41[_0x226eed(0x191)]({'date':_0x3f5e01,'value':Number(_0x4d594d)}):_0x262b41[_0x226eed(0x191)]({'date':_0x3f5e01,'value':0x0}),_0x7d8e71['setDate'](_0x7d8e71[_0x226eed(0x166)]()+0x1);}return _0x262b41;}async[_0x33f633(0x14b)](_0xb81005){const _0x6642e5=_0x33f633;var _0x2beeb9,_0x5a1504;const _0x428bcb=new Date();_0x428bcb[_0x6642e5(0x15c)](0x0,0x0,0x0,0x0);const _0xb43290=new Date(_0x428bcb[_0x6642e5(0x13a)]()-(_0xb81005-0x1)*0x18*0x3c*0x3c*0x3e8),_0x22d401=this[_0x6642e5(0x14f)][_0x6642e5(0x146)]('midjourney'),_0x4641d7=await _0x22d401[_0x6642e5(0x13b)]('DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')['where']('midjourney.status\x20=\x20:status',{'status':midjourney_constant_1[_0x6642e5(0x183)][_0x6642e5(0x190)]})[_0x6642e5(0x138)](_0x6642e5(0x14a),{'startDate':_0xb43290})[_0x6642e5(0x158)](_0x6642e5(0x176))[_0x6642e5(0x14d)](_0x6642e5(0x176))[_0x6642e5(0x148)](),_0x670855=[],_0x1dea77=_0xb43290;for(let _0x473e7a=0x0;_0x473e7a<_0xb81005;_0x473e7a++){const _0x2f2499=(0x0,date_1[_0x6642e5(0x15f)])(new Date(_0x1dea77),_0x6642e5(0x186)),_0x43deeb=(_0x5a1504=(_0x2beeb9=_0x4641d7[_0x6642e5(0x13d)](_0x49e02f=>(0x0,date_1[_0x6642e5(0x15f)])(new Date(_0x49e02f[_0x6642e5(0x176)]),'M.DD')===_0x2f2499))===null||_0x2beeb9===void 0x0?void 0x0:_0x2beeb9['count'])!==null&&_0x5a1504!==void 0x0?_0x5a1504:0x0;_0x43deeb>0x0?_0x670855[_0x6642e5(0x191)]({'date':_0x2f2499,'value':Number(_0x43deeb)}):_0x670855['push']({'date':_0x2f2499,'value':0x0}),_0x1dea77[_0x6642e5(0x16a)](_0x1dea77['getDate']()+0x1);}return _0x670855;}async['getBaiduStatistics'](_0x579d70){const _0x564a0f=_0x33f633;var _0x187023,_0xc10dc4;const _0x26e786=(0x0,date_1[_0x564a0f(0x15f)])(new Date(),_0x564a0f(0x12e)),_0x184e91=(0x0,date_1[_0x564a0f(0x15f)])(new Date(Date[_0x564a0f(0x185)]()-Number(_0x579d70-0x1)*0x18*0x3c*0x3c*0x3e8),_0x564a0f(0x12e)),_0x5ef3f1=_0x564a0f(0x120),_0x51c004=_0x564a0f(0x126),_0x2bea82=await this[_0x564a0f(0x135)][_0x564a0f(0x13d)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x564a0f(0x17d),_0x564a0f(0x130)])}}),_0xd2e1e6=(_0x187023=_0x2bea82[_0x564a0f(0x13d)](_0x4088e8=>_0x4088e8[_0x564a0f(0x136)]===_0x564a0f(0x130)))===null||_0x187023===void 0x0?void 0x0:_0x187023[_0x564a0f(0x17e)],_0x47a8f9=(_0xc10dc4=_0x2bea82[_0x564a0f(0x13d)](_0x1aed5b=>_0x1aed5b[_0x564a0f(0x136)]===_0x564a0f(0x17d)))===null||_0xc10dc4===void 0x0?void 0x0:_0xc10dc4['configVal'];if(!_0xd2e1e6||!_0x47a8f9)return[];if(!_0xd2e1e6)throw new common_1['HttpException'](_0x564a0f(0x14e),common_1[_0x564a0f(0x18c)][_0x564a0f(0x12c)]);if(!_0x47a8f9)throw new common_1[(_0x564a0f(0x142))](_0x564a0f(0x143),common_1['HttpStatus'][_0x564a0f(0x12c)]);const _0x83fefa=_0x564a0f(0x193)+_0x47a8f9+_0x564a0f(0x169)+_0xd2e1e6+_0x564a0f(0x129)+_0x51c004+_0x564a0f(0x11e)+_0x184e91+_0x564a0f(0x160)+_0x26e786+_0x564a0f(0x165)+_0x5ef3f1,_0x85f899=await axios_1[_0x564a0f(0x162)][_0x564a0f(0x145)](_0x83fefa),{error_code:_0x1d902e,message:_0x29e556}=_0x85f899[_0x564a0f(0x174)];if(_0x1d902e===0x6f)throw new common_1[(_0x564a0f(0x142))](_0x29e556||_0x564a0f(0x132),common_1[_0x564a0f(0x18c)]['BAD_REQUEST']);if(_0x1d902e&&_0x1d902e!==0xc8)throw new common_1[(_0x564a0f(0x142))](_0x29e556||_0x564a0f(0x125),common_1[_0x564a0f(0x18c)][_0x564a0f(0x12c)]);return _0x85f899[_0x564a0f(0x174)][_0x564a0f(0x131)];}async[_0x33f633(0x155)](){const _0x3b0148=_0x33f633,_0x3800db=await this['orderEntity'][_0x3b0148(0x141)]();return _0x3800db;}async[_0x33f633(0x17a)](){const _0xd13dc0=_0x33f633,_0x23df54=new Date();_0x23df54[_0xd13dc0(0x15c)](0x0,0x0,0x0,0x0);const _0x1cc4c4=new Date(_0x23df54['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x6e80b5=this[_0xd13dc0(0x172)][_0xd13dc0(0x146)](_0xd13dc0(0x159)),_0xd4da47=await _0x6e80b5['where'](_0xd13dc0(0x152),{'today':_0x23df54})[_0xd13dc0(0x138)](_0xd13dc0(0x15a),{'tomorrow':_0x1cc4c4})[_0xd13dc0(0x161)]();return _0xd4da47;}};StatisticService=__decorate([(0x0,common_1[_0x33f633(0x180)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x33f633(0x18e)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x33f633(0x16d)])),__param(0x2,(0x0,typeorm_1[_0x33f633(0x18d)])(config_entity_1[_0x33f633(0x187)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x33f633(0x194)])),__param(0x4,(0x0,typeorm_1[_0x33f633(0x18d)])(midjourney_entity_1[_0x33f633(0x128)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x33f633(0x12d)],typeorm_2[_0x33f633(0x12d)],typeorm_2[_0x33f633(0x12d)],typeorm_2[_0x33f633(0x12d)]])],StatisticService),exports['StatisticService']=StatisticService;