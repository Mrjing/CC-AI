'use strict';function _0x3aaf(){const _0x2ed911=['keyType','metadata','update','appLogo','ChatGroupEntity','InjectRepository','删除失败！','21380fNGxyu','../models/models.service','1360801fTxpRB','create','__esModule','title','12CVbJoa','4LxtcXX','请先选择一个对话或者新加一个对话再操作！','非法操作、您在使用一个未启用的应用！','DESC','应用对话名称不能修改哟！','AppEntity','HttpException','findOne','user','2421YwlLIF','defineProperty','affected','2520348PkfZTx','更新对话失败！','assign','146403aLmqoI','design:paramtypes','parse','error:\x20','HttpStatus','query','getOwnPropertyDescriptor','chatGroupEntity','../app/app.entity','35944kSrqDA','ChatGroupService','getGroupInfoFromId','appEntity','log','Repository','typeorm','delAll','appId','BAD_REQUEST','__decorate','modelsService','function','2497gfHBTT','find','coverImg','object','655330zKwTXJ','1929630WzZwDS','28BrddyY','map','删除成功','length','config','save','./chatGroup.entity','1aDmWhZ','当前应用已经开启了一个对话无需新建了！','非法操作、您在删除一个非法资源！','decorate','isSticky','非法操作、您在使用一个不存在的应用！'];_0x3aaf=function(){return _0x2ed911;};return _0x3aaf();}const _0x2b27d1=_0x3eb6;function _0x3eb6(_0x9b3662,_0x3d28f4){const _0x3aafbd=_0x3aaf();return _0x3eb6=function(_0x3eb638,_0x4a54a6){_0x3eb638=_0x3eb638-0x73;let _0x3d3a7a=_0x3aafbd[_0x3eb638];return _0x3d3a7a;},_0x3eb6(_0x9b3662,_0x3d28f4);}(function(_0x39bc96,_0x377b81){const _0x3c1128=_0x3eb6,_0x47b0b8=_0x39bc96();while(!![]){try{const _0x4e592e=-parseInt(_0x3c1128(0x91))/0x1*(-parseInt(_0x3c1128(0x88))/0x2)+-parseInt(_0x3c1128(0xb4))/0x3*(-parseInt(_0x3c1128(0xa5))/0x4)+-parseInt(_0x3c1128(0x89))/0x5+parseInt(_0x3c1128(0xb1))/0x6*(parseInt(_0x3c1128(0x8a))/0x7)+-parseInt(_0x3c1128(0x77))/0x8*(parseInt(_0x3c1128(0xae))/0x9)+-parseInt(_0x3c1128(0x9e))/0xa*(-parseInt(_0x3c1128(0x84))/0xb)+parseInt(_0x3c1128(0xa4))/0xc*(-parseInt(_0x3c1128(0xa0))/0xd);if(_0x4e592e===_0x377b81)break;else _0x47b0b8['push'](_0x47b0b8['shift']());}catch(_0x79a129){_0x47b0b8['push'](_0x47b0b8['shift']());}}}(_0x3aaf,0xcdc34));var __decorate=this&&this[_0x2b27d1(0x81)]||function(_0x1ae793,_0x3451f5,_0x3d2b48,_0x4aabd4){const _0x2b2056=_0x2b27d1;var _0x5d85f2=arguments[_0x2b2056(0x8d)],_0x3379c1=_0x5d85f2<0x3?_0x3451f5:_0x4aabd4===null?_0x4aabd4=Object[_0x2b2056(0x74)](_0x3451f5,_0x3d2b48):_0x4aabd4,_0x3c17f9;if(typeof Reflect===_0x2b2056(0x87)&&typeof Reflect[_0x2b2056(0x94)]===_0x2b2056(0x83))_0x3379c1=Reflect[_0x2b2056(0x94)](_0x1ae793,_0x3451f5,_0x3d2b48,_0x4aabd4);else{for(var _0x29422c=_0x1ae793[_0x2b2056(0x8d)]-0x1;_0x29422c>=0x0;_0x29422c--)if(_0x3c17f9=_0x1ae793[_0x29422c])_0x3379c1=(_0x5d85f2<0x3?_0x3c17f9(_0x3379c1):_0x5d85f2>0x3?_0x3c17f9(_0x3451f5,_0x3d2b48,_0x3379c1):_0x3c17f9(_0x3451f5,_0x3d2b48))||_0x3379c1;}return _0x5d85f2>0x3&&_0x3379c1&&Object[_0x2b2056(0xaf)](_0x3451f5,_0x3d2b48,_0x3379c1),_0x3379c1;},__metadata=this&&this['__metadata']||function(_0x1759e2,_0x26f7a8){const _0x382709=_0x2b27d1;if(typeof Reflect===_0x382709(0x87)&&typeof Reflect[_0x382709(0x98)]==='function')return Reflect[_0x382709(0x98)](_0x1759e2,_0x26f7a8);},__param=this&&this['__param']||function(_0x5a9dba,_0x2e3c2e){return function(_0x295b9a,_0x489009){_0x2e3c2e(_0x295b9a,_0x489009,_0x5a9dba);};};Object[_0x2b27d1(0xaf)](exports,_0x2b27d1(0xa2),{'value':!![]}),exports['ChatGroupService']=void 0x0;const common_1=require('@nestjs/common'),chatGroup_entity_1=require(_0x2b27d1(0x90)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x2b27d1(0x7d)),app_entity_1=require(_0x2b27d1(0x76)),models_service_1=require(_0x2b27d1(0x9f));let ChatGroupService=class ChatGroupService{constructor(_0x133d6c,_0x44f948,_0x4e9508){const _0x94cc8=_0x2b27d1;this[_0x94cc8(0x75)]=_0x133d6c,this[_0x94cc8(0x7a)]=_0x44f948,this[_0x94cc8(0x82)]=_0x4e9508;}async[_0x2b27d1(0xa1)](_0x3ee04e,_0x29711b){const _0x191941=_0x2b27d1,{id:_0x4a3da1}=_0x29711b[_0x191941(0xad)],{appId:_0x186511}=_0x3ee04e,_0x4a1dc9={'title':'新对话','userId':_0x4a3da1};if(_0x186511){const _0x282de1=await this[_0x191941(0x7a)][_0x191941(0xac)]({'where':{'id':_0x186511}});if(!_0x282de1)throw new common_1[(_0x191941(0xab))](_0x191941(0x96),common_1[_0x191941(0xb8)][_0x191941(0x80)]);else{const {status:_0x12788a,name:_0x21284d}=_0x282de1,_0x345424=await this[_0x191941(0x75)]['count']({'where':{'userId':_0x4a3da1,'appId':_0x186511,'isDelete':![]}});if(_0x345424>0x0)throw new common_1[(_0x191941(0xab))](_0x191941(0x92),common_1[_0x191941(0xb8)]['BAD_REQUEST']);if(![0x1,0x3,0x4,0x5]['includes'](_0x12788a))throw new common_1[(_0x191941(0xab))](_0x191941(0xa7),common_1['HttpStatus'][_0x191941(0x80)]);_0x21284d&&(_0x4a1dc9[_0x191941(0xa3)]=_0x21284d),_0x186511&&(_0x4a1dc9[_0x191941(0x7f)]=_0x186511);}}const _0x61daa9=await this[_0x191941(0x82)]['getBaseConfig'](_0x186511);_0x186511&&(_0x61daa9[_0x191941(0x7f)]=_0x186511);if(!_0x61daa9)throw new common_1[(_0x191941(0xab))]('管理员未配置任何AI模型、请先联系管理员开通聊天模型配置！',common_1[_0x191941(0xb8)]['BAD_REQUEST']);return await this[_0x191941(0x75)][_0x191941(0x8f)](Object[_0x191941(0xb3)](Object[_0x191941(0xb3)]({},_0x4a1dc9),{'config':JSON['stringify'](_0x61daa9)}));}async[_0x2b27d1(0x73)](_0x1a67f0){const _0x539c97=_0x2b27d1;try{const {id:_0x1aecfd}=_0x1a67f0['user'],_0x466a9a={'userId':_0x1aecfd,'isDelete':![]},_0x518751=await this['chatGroupEntity'][_0x539c97(0x85)]({'where':_0x466a9a,'order':{'isSticky':_0x539c97(0xa8),'id':_0x539c97(0xa8)}}),_0x8ea74d=_0x518751['filter'](_0x1f8720=>_0x1f8720['appId'])[_0x539c97(0x8b)](_0x400af7=>_0x400af7[_0x539c97(0x7f)]),_0x1b2d5b=await this[_0x539c97(0x7a)][_0x539c97(0x85)]({'where':{'id':(0x0,typeorm_2['In'])(_0x8ea74d)}});return _0x518751['map'](_0x7087ab=>{const _0x29d52b=_0x539c97;var _0x1ffe9d;return _0x7087ab[_0x29d52b(0x9a)]=(_0x1ffe9d=_0x1b2d5b['find'](_0x168283=>_0x168283['id']===_0x7087ab[_0x29d52b(0x7f)]))===null||_0x1ffe9d===void 0x0?void 0x0:_0x1ffe9d[_0x29d52b(0x86)],_0x7087ab;});}catch(_0x345291){console[_0x539c97(0x7b)](_0x539c97(0xb7),_0x345291);}}async[_0x2b27d1(0x99)](_0x4a8d44,_0x3385fd){const _0x3609ac=_0x2b27d1,{title:_0x457c18,isSticky:_0x59ffe3,groupId:_0x4671cc,config:_0x244c19}=_0x4a8d44,{id:_0x415265}=_0x3385fd['user'],_0x330961=await this[_0x3609ac(0x75)][_0x3609ac(0xac)]({'where':{'id':_0x4671cc,'userId':_0x415265}});if(!_0x330961)throw new common_1[(_0x3609ac(0xab))](_0x3609ac(0xa6),common_1['HttpStatus'][_0x3609ac(0x80)]);const {appId:_0x15c935}=_0x330961;if(_0x15c935&&!_0x457c18)try{const _0x25a0a0=JSON[_0x3609ac(0xb6)](_0x244c19);if(Number(_0x25a0a0[_0x3609ac(0x97)])!==0x1)throw new common_1['HttpException'](_0x3609ac(0xa9),common_1[_0x3609ac(0xb8)][_0x3609ac(0x80)]);}catch(_0xb5f4ca){}const _0x13837e={};_0x457c18&&(_0x13837e['title']=_0x457c18),typeof _0x59ffe3!=='undefined'&&(_0x13837e[_0x3609ac(0x95)]=_0x59ffe3),_0x244c19&&(_0x13837e[_0x3609ac(0x8e)]=_0x244c19);const _0x5a79a1=await this['chatGroupEntity']['update']({'id':_0x4671cc},_0x13837e);if(_0x5a79a1[_0x3609ac(0xb0)])return!![];else throw new common_1[(_0x3609ac(0xab))](_0x3609ac(0xb2),common_1[_0x3609ac(0xb8)][_0x3609ac(0x80)]);}async['del'](_0x4012c5,_0x197b13){const _0x694ed4=_0x2b27d1,{groupId:_0x5b1751}=_0x4012c5,{id:_0x29339a}=_0x197b13[_0x694ed4(0xad)],_0x20c9ea=await this[_0x694ed4(0x75)][_0x694ed4(0xac)]({'where':{'id':_0x5b1751,'userId':_0x29339a}});if(!_0x20c9ea)throw new common_1[(_0x694ed4(0xab))](_0x694ed4(0x93),common_1[_0x694ed4(0xb8)][_0x694ed4(0x80)]);const _0x118c80=await this['chatGroupEntity'][_0x694ed4(0x99)]({'id':_0x5b1751},{'isDelete':!![]});if(_0x118c80[_0x694ed4(0xb0)])return _0x694ed4(0x8c);else throw new common_1[(_0x694ed4(0xab))](_0x694ed4(0x9d),common_1['HttpStatus'][_0x694ed4(0x80)]);}async[_0x2b27d1(0x7e)](_0x4db6ce){const _0x1c87d4=_0x2b27d1,{id:_0x1537c0}=_0x4db6ce[_0x1c87d4(0xad)],_0x463307=await this['chatGroupEntity']['update']({'userId':_0x1537c0,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x463307['affected'])return _0x1c87d4(0x8c);else throw new common_1[(_0x1c87d4(0xab))](_0x1c87d4(0x9d),common_1[_0x1c87d4(0xb8)]['BAD_REQUEST']);}async[_0x2b27d1(0x79)](_0x3a364c){const _0x5e0f07=_0x2b27d1;if(!_0x3a364c)return;return await this[_0x5e0f07(0x75)]['findOne']({'where':{'id':_0x3a364c}});}};ChatGroupService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x2b27d1(0x9b)])),__param(0x1,(0x0,typeorm_1[_0x2b27d1(0x9c)])(app_entity_1[_0x2b27d1(0xaa)])),__metadata(_0x2b27d1(0xb5),[typeorm_2[_0x2b27d1(0x7c)],typeorm_2[_0x2b27d1(0x7c)],models_service_1['ModelsService']])],ChatGroupService),exports[_0x2b27d1(0x78)]=ChatGroupService;